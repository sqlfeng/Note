# Prog. Version..: '5.25.02-11.03.23(00000)'     #
#
# Pattern name...: saxmt600.4gl
# Descriptions...: 出貨單維護作業
# Date & Author..: 95/01/05 By Roger
# modify   2.0 版: 95/10/19 By Danny (輸入訂單單號時,判斷不可為合約單號)
# modify   2.0 版: 95/11/07 By Apple (取消確認時 call t600_z1)
# modify   4.0 版: 99/10/13 By Kammy (原menu功能'3.更改倉儲',改以多欄方式輸入)
# Modify.........: No:7829 03/08/18 Carol 單據程式中呼叫單據自動編號時,應要包在
#                                         BEGIN WORK 中(transaction)
#                                         才會達到lock 的功能
# Modify.........: No:7664 03/08/18 Carol
#                    Function t600_s 中， CALL t600_gui() 前之IF判斷應該要增加
#                    1. oay11='Y'  2. oga00 not matches '23'
#                   (需出貨立 AR，且非換貨、出至境外倉之出貨單方可立 AR )
# Modify.........: No:7903 03/08/27 Carol 若ogb17是否多倉儲欄位沒輸入時,
#                                         ogb17會等於NULL
# Modify.........: No.7891 03/09/02 Mandy default 收款條件的功能,若是單據
#                                         已經確認了,不應再自動帶出
# Modify.........: No.7992 03/08/30 Kammy 多角貿易共用本支程式
#                  1.非多角單有 (1)一般 (2)換貨 (3)出至境外 (4)境外出貨 (5)BU
#                  2.多角單只有 (1)一般 (2)換貨
# Modify.........: No.9060 04/01/27 Kammy  錯誤訊息加強
# Modify.........: No.8876 04/01/09 Kammy  訂單再轉出貨通知單時訊息出現為是否由
#                : 訂單轉出貨單(應改為訂單轉"出貨通知單")
# Modify.........: No.8565 03/10/30 Melody 當查詢出兩筆以上資料時(未確認的),
#                :                         按'U'修改單頭,修改完後跳至下一筆要修改單頭時,因oga16不是null,所以
#                                          跳過從新select oea_file的地方,導致此時g_oea.*還是上一筆的資料,
#                                          在AFTER FIELD oga03時會出現axm-138的錯誤訊息
# Modify.........: No.8570 03/10/29 Melody 出至境外倉時,AFTER FIELD 境外倉時可不打,造成庫存過帳錯誤,無法還原
#                :                         genero,在per檔加not required
# Modify.......... No.8641 04/03/02 Melody ogc_file 該段begin與單身重覆,應移除,併到與單身修改同一transaction中
# Modify.........: No.8741 03/11/28 Melody add l_flag判斷for axcp500 (多倉出貨)
# Modify.........: No.9735 04/07/08 Wiky   當出貨單作廢後，出通單仍無法修改 ，出現'axm-228'的錯誤訊息
#                :                         打完出貨單後會回寫出貨單號到出通單， 導致出通單無法修改,作廢時也清空相關table
# Modify.........: No.9736 04/07/08 Wiky   不可用倉的用途該如何運用, 出貨, 發料 都未卡是否合理?
#                                          1.after field 判斷不可用倉不可輸入 2.確認段亦應再判斷一次
# Modify.........: 04/07/19 By Wiky Bugno:MOD-470041 修改INSERT INTO...
# Modify.........: No.MOD-470331 04/07/29 ching 修改倉儲後未refresh單身
# Modify.........: No.MOD-480277 04/08/12 Wiky 在出通單的取消確認,多判斷有invoice就不可還原,package不擋在出通單的取消確認,多判斷有invoice就不可還原,package不擋
# Modify.........: NO.MOD-460094 04/08/23 出至境外倉的例子測試，當要以"出貨通知單"產生單身資料時，又會再詢問一次 "是否以訂單產生單身"
#                                         若打否，又會重詢問一次...(P.S若 user 選擇以出通單產生，就不要再詢問是否以訂單產生了)
# Modify.........: No.MOD-490172 Kammy 單身的 controlp完全部加 display..to..
# Modify.........: No.MOD-480604 04/09/15 By Smapmin增加倉庫CONTROLP之功能
# Modify.........: No.MOD-480401 04/09/20 By Melody 出貨扣帳應check img18(庫存有效日期)
# Modify.........: No:MOD-490371 04/09/23 By Kitty Controlp 未加display
# Modify.........: No:MOD-490365 04/09/24 By Nicola 未確認也要卡單身
# Modify.........: No.MOD-490460 04/09/27 By Kammy chk imd_file時不應chk imd12   
# Modify.........: No:MOD-4A0063 04/10/06 By Mandy q_ime 的參數傳的有誤
# Modify.........: No:MOD-4A0095 04/10/08 By Smapmin將cl_conf改為cl_confirm
# Modify.........: No:FUN-4A0064 04/10/11 By Carol 將construct contolp 寫法修改
# Modify.........: No:MOD-4A0213 04/10/14 By Mandy q_imd 的參數傳的有誤
# Modify.........: No.FUN-4B0038 04/11/16 By pengu ARRAY轉為EXCEL檔
# Modify.........: No:MOD-4B0107 04/11/17 By Mandy 出貨單自動帶出單身時, t600_g_ogb 的sql 除了串ogb31,ogb32 應多加考慮ogb03
# Modify.........: No.MOD-4B0169 04/11/22 By Mandy check imd_file 的程式段...應加上 imdacti 的判斷
# Modify.........: No.FUN-4B0050 04/11/23 By Mandy 匯率加開窗功能
# Modify.........: No:MOD-4B0275 04/11/27 By Danny CALL q_coc2
# Modify.........: No:FUN-4C0006 04/12/03 By Carol 單價/金額欄位放大(20),位數改為dec(20,6)--axmt600p.per
# Modify.........: No:FUN-4C0057 04/12/09 By Carol Q,U,R 加入權限控管處理
# Modify.........: No:FUN-4C0076 04/12/15 By pengu 匯率幣別欄位修改，與aoos010的aza17做判斷，
                                                   #如果二個幣別相同時，匯率強制為 1
# Modify.........: No:MOD-4C0071 04/12/16 By Carol 單頭的訂單也應檢查單別(for多角)
# Modify.........: No:FUN-4B0032 04/12/17 By Mandy 1.輸入時訂單單身開窗加有項次 2.CONSTRUCT 時CALL q_oea的回傳值應為g_qryparam.multiret及加上多角貿的判斷
# Modify.........: No:FUN-4B0232 04/12/17 By Mandy check sma894 是否可負庫存要用img10判斷
# Modify.........: No:MOD-520078 05/02/16 By Melody chk_ima262() 應挪到 t600sub_update()之前避免計算庫存不足時錯誤
# Modify.........: No.MOD-510171 05/03/02 By Carrier 內銷時可以KEY手冊編號
# Modify.........: No.MOD-530054 05/03/09 By ching fix 多倉儲批輸入問題
# Modify.........: No.MOD-530011 05/03/10 By ching default 人員部門
# Modify.........: No.MOD-520034 05/03/14 By ching fix單身delete未call _bu()
# Modify.........: NO:FUN-530031 05/03/22 By Carol 單價/金額欄位所用的變數型態應為 dec(20,6),匯率 dec(20,10)
# Modify.........: NO:MOD-530713 05/03/28 By Mandy img10 不可宣告成 integer
# Modify.........: NO:MOD-530374 05/04/01 By ching fix set_entry err
# Modify.........: No.FUN-540049 05/05/11 By Carrier 雙單位內容修改
# Modify.........: No:FUN-550052 05/05/25 By Will 單據編號放大
# Modify.........: No:FUN-550011 05/05/31 By kim GP2.0功能 庫存單據不同期要check庫存是否為負
# Modify.........: No:MOD-530221 05/06/08 By pengu 執行axmt620時,應有ACTION:客戶相關查詢,訂單相關查詢及備註出現,但卻未出現
# Modify.........: No:FUN-550050 05/06/13 By Echo 新增 TIPTOP 與 EasyFlow 整合
# Modify.........: No:MOD-560007 05/06/13 By Echo 重新定義整合FUN名稱
# Modify.........: No:FUN-560070 05/06/15 By Smapmin 批號判斷錯誤
# Modify.........: No.FUN-560060 05/06/15 By day  單據編號修改
# Modify.........: NO:MOD-530311 05/04/11 By Mandy 1.新增一筆資料在單頭訂單單號欄位開查詢視窗,視窗所顯示的資料應該排除已經完全出貨的訂單
# Modify.........: NO:MOD-530311 05/04/11 By Mandy 2.將原客戶改為其他客戶後,其他資料中的收款客戶並也要跟著變更
# Modify.........: NO:MOD-540131 05/04/19 By Mandy 輸入時若oga32空白，請default慣用收款條件(客戶主檔)
# Modify.........: NO:FUN-560110 05/06/19 By Mandy saxmt600.4gl  FUNCTION t600sub_ins_oea()內有CALL到s_axmauno應改用CALL s_auto_assign_no
# Modify.........: No:FUN-560176 05/06/23 By oga01單號放大16
# Modify.........: No:FUN-560043 05/07/13 By Smapmin OPEN imgg_lock 條件錯誤
# Modify.........: No:MOD-570132 05/07/26 By Nicola 當單頭出通單有輸入時,但若選擇不從出通單轉出時,並不會回寫出通單,容易造成資料上的誤解
# Modify.........: No:MOD-570264 05/07/26 By Nicola 單身的 多倉儲出貨否/倉/儲/批 應該要先放在一起詢問後,再做庫存量的控制才有意義
# Modify.........: No:MOD-570265 05/07/26 By Nicola 1.當occ56='Y'時,設出貨通知單號不可空白,並給提示訊息說明因為客戶主檔有設定occ56='Y'
#                                                   2/3.將其它資料的收款客戶放至單頭,放至送貨客戶的下面,一併修正axmt610
#                                                   4.文件地址要可以修改交運方式
# Modify.........: No:MOD-560183 05/07/26 By Nicola 1.勾選多倉庫後請立刻跳出維護多倉庫的畫面,可參考 top99原本的作法
#                                                   2.在 AFTER FIELD ogb31約行2630 加控管地址碼oga044不可不一樣
#                                                   3.在aimi201建資料時要新增一筆儲位是空白' '的資料就不會有上述的問題,so 不用改
#                                                   4.要更新回oga910,oga911 約程式7576行
# Modify.........: No:MOD-570312 05/07/26 By Nicola t600_g_b1() FUNCTION中抓取出通單及出貨單的數量時, 應將作廢的單據剔除
# Modify.........: No:FUN-570248 05/07/27 By Elva 判斷該單據所屬月份改為該所屬期別
# Modify.........: No:MOD-570362 05/08/03 By Nicola sql語法修改
# Modify.........: No:MOD-570333 05/08/03 By Nicola 將cl_conf改為cl_confirm
# Modify.........: No:MOD-560087 05/07/05 By Yiting 可用倉否應判斷imd11
# Modify.........: NO:MOD-570345 05/07/28 By Yiting 由於在業務人員開窗時可以看到所屬部門,但確定後無帶出部門編號
# Modify.........: No:MOD-560095 05/08/04 By Nicola 錯誤訊息修改
# Modify.........: NO:FUN-4A0081 05/08/09 By saki 指定單據編號、執行功能(g_argv2)
# Modify.........: No:MOD-580083 05/08/11 By Rosayu 右邊的文件地址裡頭的麥頭編號無法正常開窗
# MODIFY ........: No:MOD-580206 05/08/18 By Rosayu IF cl_null(l_ogb.ogb09) THEN LET l_ogb.ogb091= l_ima36 END IF -->應判斷的是ogb091是否為空
# Modify.........: No.FUN-580133 05/08/24 By Carrier 修改多單位"出至境外"
# Modify.........: No:FUN-580113 05/08/24 By Sarah 以EF為backend engine,由TIPTOP處理前端簽核動作
# Modify.........: No:MOD-590122 05/09/12 By Carrier set_origin_field修改
# Modify.........: No.MOD-590003 05/09/05 By DAY 查詢時產品編號改為可多選
# Modify.........: No.MOD-590225 05/09/14 By Nicola 出至境外倉，欄位控管修改
# Modify.......... No.MOD-590206 05/09/14 By Nicola 1.多倉儲出貨時，t6006_w視窗之單身倉庫查詢，應為查詢img_file，非查詢倉庫基本資料。
#                                                   2.多倉儲出貨時，t6006_w視窗應增加出貨單單身該項之數量顯示。
# Modify.........: No.MOD-590210 05/09/14 By Nicola t600sub_y_upd(g_oga_rowid,g_action_choice),t600_s()內的g_flag重新命名
# Modify.........: No.MOD-590233 05/09/15 By Nicola 扣帳時，出現LOCK的錯誤訊息
# Modify.........: No.MOD-590346 05/09/16 By Carrier mark du_default()
# Modify.........: NO:MOD-580146 05/09/19 By Nicola 刪除單身資料時，連出貨序號一併刪除
# Modify.........: No.MOD-590356 05/10/05 By Nicola 修改單頭的稅別,加判斷是否與單身(訂單單號)的稅別相同
# Modify.........: NO.MOD-5A0264 05/10/20 By Claire 一張出貨單對應多張訂單時,單頭不會帶出訂單單號->default 為第一筆出貨資料的訂單號碼
# Modify.......... NO.MOD-5A0174 05/10/21 By Rosayu Insert into ogb_file時,有些資料庫設定not null的欄位因為是空值所以有問題
# Modify.........: NO.MOD-590438 05/10/05 BY yiting 輸入出貨單時,若選擇由出貨知單轉訂單,ogb14,ogb14t也應同步變更
# Modify.......... NO.FUN-5A0164 05/10/31 By Sarah 出貨通知單於單身欄位不應該控管倉/儲/批應存在img_file,因有可能尚未生產完畢
# Modify.........: No.TQC-5B0154 05/11/15 By Rosayu AFTER FIELD ogb091判斷式應該挪至AFTER FIELD ogb092 批號再做判斷
# Modify.........: No.MOD-5B0276 05/11/21 By kim DEFINE 寫死的部分,改成用LIKE
# Modify.........: NO.MOD-5A0440 05/11/22 By Niocla 1.收款客戶的簡稱沒有呈現出來
#                                                   2.若以輸入訂單單號帶出基本資料,收款客戶代號無法帶出
# Modify.........: NO.MOD-5B0116 05/11/22 By Niocla 超限原因沒有顯示
# Modify.........: NO.MOD-5B0113 05/11/29 BY Nicola 單身數量不可為0
# Modify.........: NO.FUN-5B0067 05/11/29 BY Nicola 秀出產生境外倉訂單的單號
# Modify.........: No.MOD-5B0194 05/11/30 By Nicola 出貨單單身自動產生，以出通單+訂單為條件
# Modify.........: No.MOD-5B0193 05/11/30 By Nicola 單身倉儲批帶值及輸入控管修改
# Modify.........: No.MOD-5B0123 05/11/30 By Nicola 隱藏無權限按鈕功能修改
# Modify.........: No.MOD-5B0325 05/12/05 By Nicola 多角貿易打單修改
# Modify.........: No.TQC-5C0014 05/12/08 By Carrier set_required時去除單位換算率
# Modify.........: No.TQC-5C0036 05/12/08 By Nicola 新增時，先輸入訂單單號，再回頭輸入出貨單單別，會出現"查無此單別"的錯誤訊息
# Modify.........: No.FUN-5C0075 05/12/19 By Elva 新增成品替代功能,另加一個“檢驗否”BY wujie
# Modify.........: No.FUN-5B0066 06/01/10 By Sarah 在文件地址增加維護"結關日期"(oga021)
# Modify.........: NO:TQC-630066 06/03/07 By Kevin 流程訊息通知功能修改
# Modify.........: No:FUN-630061 06/03/22 By ice 出貨驗收功能 -- 新增出貨需驗/客戶驗收/客戶驗退功能 oga09=8/9
# Modify.........: NO:TQC-620156 06/03/23 By ice(追單) GP3.0過帳錯誤統整顯示功能新增
# Modify.........: No:MOD-610031 06/03/23 By ice(追單) 2369行IF cl_null(g_oga.oga011 AND cl_null(g_oga.oga16) THEN
#                                                      增加判斷p_cmd是否為'a'
# Modify.........: No:MOD-610020 06/03/23 By ice(追單) 點選右邊"更改倉儲"action後, 帶出之倉儲批位置不對
# Modify.........: No:FUN-610090 06/03/03 By ice(追單) 拆併箱功能修改
# Modify.........: No:MOD-620082 06/02/27 By pengu  如出貨通知單不為空, 則匯率會帶出報關日期的匯率.
                        #                           如果報關日期與今天不同, 則匯率會有錯
# Modify.........: No:TQC-640123 06/04/10 By wujie  按照package調整單頭客戶欄位,將出貨和返利分成不同的單身
# Modify.........: NO.MOD-640442 06/04/14 BY wujie(追單)  若單身有做多倉儲批出貨，當存檔或確認狀態下，查不到多倉儲批內容，應該要可以另外有一個ACTION查的到。
# Modify.........: No:MOD-620019 06/04/14 By wujie(追單)  超交判斷修改
# Modify.........: No.FUN-640074 06/04/13 By Rayven 增加出貨單，出貨通知單檢驗否欄位的判斷，是否從aqci150帶出，可不可輸
# Modify.........: No.TQC-640151 06/04/18 by cl(追單)  1.TQC-610050  出貨通知確認時不需要先做OQC
#                                                      2.FUN-630102  3.0寄銷代送功能--atm出貨單已經有類似修改，先比較再追單
#                                                      3.TQC-630247  母子單位時，單位一數量可為0，，計價單位不可為0
#                                                      4.FUN-640025  使用oea37取代oaz19
#                                                      5.FUN-640028  成品替代: 當為產品群組替代時, 多倉儲料開窗后,敲任一料號都有問題
#                                                      6.FUN-640181  若在「系統參數設定作業(aoos010)」里未設定簽核流程與EasyFlow串聯，請"隱藏"整合單據作業里的「EasyFlow送簽」及簽核狀
#                                                      7.FUN-640029  GP3.0匯率改善功能
#                                                      8.FUN-630006  需做訂單分配時，出貨數量不可大於分配量
# Modify.........: No:MOD-650015 06/05/05 By rainy 取消輸入時的"預設上筆"功能
# Modify.........: No:TQC-650088 06/05/22 By wujie 參考訂單，出貨單增加多屬性功能
# Modify.........: NO.FUN-630015 06/05/24 BY Yiting s_rdate2 改為s_rdatem
# Modify.........: NO.FUN-630118 06/05/26 BY wujie  bug&料件多屬性后續修改
# Modify.........: NO:TQC-660088 06/06/21 By Claire 流程訊息通知功能修改
# Modify.........: NO:FUN-670008 06/06/28 By wujie  axm,atm出貨單合并為一支
# 以下為修改前axm追單至atm
# Modify.........: NO:FUN-630102 06/03/24 By Sarah 3.0寄銷代送功能,1.出貨類別增加"6.調貨訂單,7.寄銷訂單",
#                                                                  2.單頭新增二欄位:調貨客戶,代送商
# Modify.........: No.FUN-640031 06/04/19 By Sarah 1.輸入驗退理由後,按enter會跳到下一空白行,再按'確認'會有error
#                                                  2.旁邊的第4~8 action請隱藏
#                                                  3.若有驗退,貸出的驗退倉庫儲位應可帶出參數預設的空白(blank)非NULL
# Modify.........: No.FUN-640130 06/04/19 By Sarah 1.成品替代出貨方式選擇依"群組替代"，t600b_w的產品編號開窗應該只能開axmi123有的資料，不能全部料件都秀出來
#                                                  2.出貨單單身指定料號後，而且在t600b_w不能選到原本的料號，應該要可以選到原本的料號(axmi123有資料)
#                                                  3.出貨單單身輸入完成多倉儲批選擇替代出貨後，回到單身中，再按右邊"多倉儲批"的action，會抓不到原本已經選定的結果按取消後才會出現
# Modify.........: No.FUN-640129 06/04/20 By Sarah 出貨單過帳時，若無多倉儲批資料則秀出 "axm-172" 的錯誤，應該要指定是單身哪一筆資料才對
# Modify.........: No:MOD-610063 06/04/25 By pengu 抓完出通單default到出貨單時﹛A要加上LET g_oga.oga99=''與LET g_oga.oga905='N'
# Modify.........: No:FUN-640050 06/04/28 By Sarah 1.atmt321增加一個ACTION"單身維護,開出一個跟出貨單單身一樣的畫面來修改單身資料
#                                                  2.atmt321增加"瀏覽","回單頭"Button,以瀏覽第二個單身資料
# Modify.........: No:FUN-650007 06/05/03 By Sarah 將"LET g_prog = ls_tmp","ls_tmp"mark掉
# Modify.........: No:MOD-650042 06/05/10 By Claire 出通單1及三角貿易單5時考慮訂單號碼及項次不可空白
# Modify.........: No:MOD-650039 06/05/11 By Claire g_msg調整長度設定
# Modify.........: No:TQC-650045 06/05/11 By Claire ogb31訂單允許可輸入MISC
# Modify.........: No:MOD-650057 06/05/15 By Sarah 回寫出通單之出貨單號欄位，改成出貨單確認時多再UPDATE oga011=本張出貨號
# Modify.........: No:FUN-630072 06/05/16 By pengu 通知單,出貨單其INV(oga27)欄位要提供查詢視窗(含多角)
# Modify.........: No:TQC-610089 06/05/16 By Pengu Review所有報表程式接收的外部參數是否完整
# Modify.........: No:FUN-570065 06/05/22 By kim 在客戶主檔新增'預設科目別',在輸入出貨作業(axmt620)時,可default 帶入
# Modify.........: No:FUN-640187 06/05/23 By Sarah 當參數設定為'替代群組'時, 先check 該客戶,替代群組是否有資料,若有,則依替代順序抓取順序在此料號前面的料號替代
#                                                  若無,則在check 客戶是'*',且滿足該替代群組的資料, 再依替代順序抓取順序在此料號前面的料號替代
# Modify.........: No:FUN-660015 06/06/08 By Sarah 當ogb17='Y'時,不必call t600_chk_ima262()
# Modify.........: No:FUN-660043 06/06/13 By Sarah 當出貨類別=7.寄銷出貨時,按扣帳,會prompt一窗帶出境外倉庫與儲位,
#                                                  若沒帶出預設倉庫與儲位,請提示需到寄銷客戶對應倉庫維護(axmi226),若有帶出,詢問是否執行此作業
# Modify.........: No:FUN-660087 06/06/14 By Sarah 將ACTION"出貨單維護"拿掉,按下ACTION"單身維護"程式會當掉
# Modify.........: No:MOD-660080 06/06/20 By Pengu 在第6178,6400行行錯誤訊息有誤
# Modify.........: NO.TQC-660095 06/06/21 BY yiting 拋轉產生的axmt820出貨單並無單身
# Modify.........: No:TQC-660096 06/06/22 By saki 流程訊息修正統一格式
# Modify.........: No:MOD-660090 06/06/22 By Rayven 料件多屬性補充修改，check_料號()內應再加傳p_cmd的參數
# Modify.........: No:MOD-640570 06/06/23 By Mandy 跟據訂單匯率(oea18),看匯率是抓訂單匯率或每日匯率
# Modify.........: No:MOD-640542 06/06/26 By pengu 若單頭沒指定訂單號碼，單身才指定訂單號碼，則第二張
                            #                      第二張出貨單default的數量未扣除已開出貨單的數量
# Modify.........: No:FUN-670008 06/07/03 By cl cl_err --> cl_err3
# axm追單至atm結束
# Modify.........: No:FUN-660216 06/07/11 By Rainy CALL cl_cmdrun()中的程式如果是"p"或"t"，則改成CALL cl_cmdrun_wait()
# Modify.........: No:FUN-670063 06/07/21 By kim GP3.5 利潤中心
# Modify.........: NO.FUN-670007 06/07/27 By yiting 1.oaz32->oax01,oaz203->oax04
#                                                   2.庫存扣帳時判斷oax07/pod05如為Y則自動執行多角貿易拋轉動作
#                                                   3.依oaz67來源為出通單/出貨單，來判斷是否自動執行拋轉，為出通單時自動拋不check oax07/pod05參數
#                                                   4.拋轉還原時不再還原出通單，己新增新的axmp911還原程式
#                                                   5.為三角出通單時，單頭訂單訂號不可為空白，單身訂單需與單頭單號相同
# Modify.........: NO.MOD-670123 06/07/27 By wujie  出貨單BUG匯總修改
# Modify.........: NO.MOD-680010 06/08/02 By wujie  修改出貨單身不更新ogb16
# Modify.........: No:TQC-660117 06/08/14 By Pengu 1.單身倉庫^P改成ON ACTION qry_inv_detail CALL 的內容
                                #                  2.mark ON ACTION qry_inv_detail的功能
# Modify.........: No:FUN-680010 06/08/22 by Joe SPC整合專案-自動新增 QC 單據
# Modify.........: NO.FUN-670007 06/08/30 by yiting 配合s_rdatem多傳入一個日期參數
# Modify.........: No:FUN-680022 06/08/30 By Tracy s_rdatem()增加一個參數
# Modify.........: No:FUN-660073 06/08/28 By Nicola 原因碼外顯可維護
# Modify.........: No:FUN-690023 06/09/12 By jamie 判斷occacti
# Modify.........: No:FUN-680137 06/09/15 By bnlent 欄位型態用LIKE定義
# Modify.........: No:TQC-690061 06/09/19 By Sarah 於配送單維護作業atmt321之單身點兩下，無法中斷程式(像當機一樣)
# Modify.........: No:FUN-690024 06/09/21 By jamie 判斷pmcacti
# Modify.........: No:FUN-690025 06/09/21 By jamie 改判斷狀況碼ima1010、occ1004
# Modify.........: No:FUN-690078 06/09/27 By Sarah 當參數oaz23=Y(產品替代),出貨單單身勾選"多倉儲料出貨(ogb17)",
#                                                  開啟產品替代的視窗後,替代群組欄位輸入空白,則代表只做多倉儲料出貨,而非產品替代
# Modify.........: No:FUN-690083 06/09/27 By Sarah 當輸入寄銷訂單後(g_oga.oga00='7'),系統不應判斷此客戶設定是否為'客戶庫存管理'
# Modify.........: No:CHI-690060 06/09/27 By Sarah 出貨單需確認且過帳才可執行轉出貨簽收功能
# Modify.........: No:FUN-690044 06/10/23 By rainy 移除BU間銷售
# Modify.........: No:FUN-6A0007 06/10/27 By kim GP3.5 台虹保稅客製功能回收修改
# Modify.........: No:MOD-6B0002 06/11/01 By Mandy 由出貨通知單轉出貨單的金額(ogb14)應該取計價數量(ogb917)
# Modify.........: No:CHI-6A0004 06/11/06 By Jackho 本幣取位修改
# Modify.........: No:FUN-6A0092 06/11/14 By Jackho 新增動態切換單頭隱藏的功能
# Modify.........: No:TQC-6A0045 06/11/15 By Claire 合約訂單檢驗否default 'N'
# Modify.........: No:MOD-670031 06/11/16 By Claire 無報表可列印要show訊息
# Modify.........: No:FUN-6A0020 06/11/17 By jamie 1.FUNCTION _q() 一開始應清空key值
#                                                  2.新增action"相關文件"
# Modify.........: No:FUN-6B0065 06/11/21 By Ray atmi217并入aooi313(azf09,10,11,12,13取代tqe03,04,05,11,08)
# Modify.........: No.TQC-6B0117 06/11/21 By day 欄位加控管
# Modify.........: No:FUN-650009 06/11/23 By Sarah 增加oga69(輸入日期),記錄單據輸入的日期,至於原oga02(出貨日期),作"庫存扣帳"時會先跳到oga02輸入,以記錄實際出貨扣帳日期
# Modify.........: No:CHI-690060 06/11/24 By Sarah 1.修改FUN-690078的Error
#                                                  2.確認時,有出貨簽收應OPEN axmt6271,簽退時應OPEN axmt6281
# Modify.........: NO.FUN-670007 06/11/28 by Yiting poz05己取消作用
# Modify.........: NO.CHI-690055 06/12/04 by kim 簽收確認和扣帳時,不檢查OQC的量
# Modify.........: NO.FUN-650105 06/12/04 by kim 訂金處理- 出貨時,應確認訂金是否已收款. 若有收款紀錄,才可出貨確認
# Modify.........: NO.FUN-650101 06/12/04 by kim 出至境外倉,寄銷訂單,確認輸入在途倉時 ,必須為'非MRP' , 且需為'成本倉'
# Modify.........: NO.CHI-690076 06/12/05 by rainy 取消確認不需卡關帳問題
# Modify.........: No.TQC-6B0174 06/12/04 By Ray  使用客戶簽收功能時,INSERT img_file時增加寫入批號
# Modify.........: No:MOD-6C0028 06/12/06 By kim 有出通單時,出貨簽收否應帶出通單,而不是帶訂單
# Modify.........: No:MOD-6A0067 06/12/06 By pengu 出貨通知單不應有功能鍵「應收維護」
# Modify.........: No:TQC-680018 06/12/07 By Claire 扣帳時會發生已核准但未確認的異常狀況
# Modify.........: No:MOD-6A0165 06/12/07 By claire 按單身,單身抬頭變成英文
# Modify.........: No:MOD-690094 06/12/07 By Claire oga21異動時,不論值有沒有改變,重新整理 oga24的值
# Modify.........: No:FUN-6A0013 06/12/13 By rainy 單身輸入時，判斷訂金比率及尾款比率大於0的不可合併出貨
# Modify.........: No:MOD-680025 06/08/13 By Mandy 出通單取消確認時, 若該對應之Invoice已作廢, 應可取消確認.
# Modify.........: No:TQC-6A0039 06/12/14 By Mandy 若此張出貨單未做客戶出貨簽收,應不能串至Action "轉出貨簽收"/"查詢出貨簽收單",
#                                                  並show訊息 '此單據未做客戶出貨簽收'
# Modify.........: No:TQC-6B0124 06/12/19 By pengu 參數勾選不使用多單位但使用計價單位時，計價單位與計價數量會異常
# Modify.........: No:TQC-6C0085 06/12/25 By chenl 1.修正ogb19->oeb19的錯誤，改為ogb19->oeb906
#                                                  2.修正預計出貨日期錯誤。oeb15->ogb15改為oeb15->ogb1003
#                                                  3.修正審核功能，當程序代號為axmt628時，不做折扣判斷。
#                                                  4.若程序代碼為:axmt628和axmt629時,隱藏"查詢多倉庫存"
#                                                  5.修正atmt321進入單身后無限循環的bug
# Modify.........: No:TQC-680074 06/12/28 By Smapmin 為因應s_rdatem.4gl程式內對於dbname的處理,故LET g_dbs2=g_dbs,'.'
# Modify.........: No.MOD-6C0160 06/12/27 By rainy 新增出貨單第一次按確認時，不做信用額度控管的客戶仍被寫入超限原
# Modify.........: No.MOD-710019 07/01/10 By claire g_success要重新給值
# Modify.........: No.FUN-710016 07/01/22 By kim GP 3.6行業別架構
# Modify.........: No.CHI-6B0036 07/01/26 By rainy 訂單及出貨單加總數量時要過濾掉作廢的單子
# Modify.........: No.FUN-710040 07/01/19 By rainy 新增action 查詢序號
# Modify.........: No.FUN-6C0050 07/02/07 By rainy 新增入庫單號Just for QBE
# Modify.........: No:TQC-710032 07/01/30 By Smapmin 雙單位畫面調整
# Modify.........: No:FUN-720030 07/02/12 By kim 行業別架構變更
# Modify.........: No:CHI-710039 07/03/01 By rainy 出貨單輸入時，於拉入訂單資料時，要check此訂單是否有訂單變更且未確認未發出的資料
# Modify.........: No:TQC-720016 07/03/01 By Smapmin 已經確認的單據不可執行產生分錄
# Modify.........: No:FUN-720014 07/03/02 By rainy 客戶地址擴充為5欄255
# Modify.........: No:MOD-720094 07/03/02 By pengu 執行action維護單價時，應該從新計算並update訂單單頭的已出貨未稅金額欄位
# Modify.........: No:MOD-720114 07/03/05 By pengu 當倉庫單位(img09)與料件庫存單位(ima25)出貨扣帳會異常
# Modify.........: No:MOD-730004 07/03/05 By chenl當單身要做oqc檢驗時，若在檢驗之前過賬，則提示信息不確定，應該為：出貨量不可大于OQC合格量
# Modify.........: No:FUN-730012 07/03/08 By kim 確認和過帳段的程式,改包到另外一個 sub routine ,供其他程式呼叫使用
# Modify.........: No.TQC-6B0105 07/03/09 By carrier 連續兩次查詢,第二次查不到資料,做修改等操作會將當前筆停在上次查詢到的資料上
# Modify.........: No.FUN-730012 07/03/20 By kim 確認和過帳段移到saxmt600_sub.4gl
# Modify.........: No.TQC-730022 07/03/20 By rainy 流程自動化GP5.0功能
# Modify.........: No:FUN-730018 07/03/28 By kim 行業別架構
# Modify.........: No:MOD-6B0161 07/04/03 By pengu 訂單單別設定不自動編但出貨單單別須自動編號時
#                                                  在key出貨單的單頭訂單資料後會出現"sub-141"錯誤訊息
# Modify.........: No:TQC-730034 07/04/04 By Claire t6005 畫面不該出現 ogb910 的名稱
# Modify.........: No:TQC-740039 07/04/10 By Ray 1.匯出excel有誤(atmt321)
#                                                2.筆數錯誤(atmt321)
# Modify.........: No:CHI-730002 07/04/12 By Smapmin 當類別＝出至境外倉時，單頭[出貨簽收]欄位default='N' 且設為noentry
# Modify.........: NO.TQC-740089 07/04/16 BY yiting 行業別程式拆出t600sub_chkpoz,g_flow不見了，要回傳
# Modify.........: NO.CHI-740014 07/04/17 BY kim 其他資料page應該要可以查詢
# Modify.........: No:FUN-740016 07/04/18 By Nicola 借出管理修改
# Modify.........: No:CHI-740016 07/04/18 By kim axmt610 出貨單號應不可以維護
# Modify.........: No:TQC-740047 07/04/18 By Rayven 出貨簽收單時ogb12可以為0
# Modify.........: No:TQC-740134 07/04/18 By Rayven “單價”按鈕無法點開
# Modify.........: No:TQC-6C0186 07/04/18 By claire 多訂單合併時會取錯價格條件
# Modify.........: NO.TQC-740230 07/04/22 BY yiting 應控管若訂單單號項次沒有改變，數量應維持原預設的出通單數量。
# Modify.........: No:TQC-740203 07/04/23 By elva 取消atmr240,atmr241
# Modify.........: No:TQC-740135 07/04/23 By arman 多倉位出貨時，查詢倉位，替代群組會自動帶出一替代群組號
# Modify.........: No:MOD-740349 07/04/26 By Nicola 簽收日期控管
# Modify.........: No:MOD-740114 07/04/26 By Mandy 料件的正確性控管,不應只限制在走流通配銷的參數內
# Modify.........: No:TQC-740304 07/04/26 By Sarah 串報表axmr550,axmr552少傳參數
# Modify.........: NO.MOD-740479 07/04/26 BY claire 母子單位時，單位一數量可為0，但不可小於0
# Modify.........: No:MOD-740375 07/04/27 BY Nicola 理由碼開窗查詢修改
# Modify.........: NO.MOD-740415 07/04/27 BY yiting 訂單單號之後的檢查，應check舊值<>新值時才處理
# Modify.........: NO.TQC-740349 07/04/28 BY Rayven 刪除一張單據以后，返利單身沒有刷新，仍然顯示原來的資料
#                                                   從出貨通知單帶出資料時，沒有把返利單身的資料帶出
#                                                   進入返利單身，修改“原幣含稅金額”，報錯，且“原幣稅前金額”也計算錯誤
#                                                   出上述操作，重新run axmt620，進入返利單身“原幣含稅金額”以后，“原幣稅前金額”計算錯誤
#                                                   ogb1013未賦初值，導致后續資料錯誤
# Modify.........: No:TQC-750026 07/05/08 By claire 分錄底稿,單價的action在串easy flow時要隱藏
# Modify.........: No:FUN-750036 07/05/09 By rainy 借貨出貨單
# Modify.........: No:MOD-740344 07/05/10 By Nicola 客戶簽收單原因碼不可維護
# Modify.........: No:FUN-740034 07/05/14 By kim 確認過帳不使用rowid,改用單號
# Modify.........: No:MOD-750066 07/05/15 By claire 執行作廢後又按否,會回寫作廢碼
# Modify.........: NO.TQC-740112 07/05/15 BY yiting 參數設定(axms070) 設定 ""確認不自動拋轉""  按過帳/過帳還原時 ,請提示
# Modify.........: No:FUN-750051 07/05/22 By johnray 連續二次查詢key值時,若第二次查詢不到key值時,會顯示錯誤key值
# Modify.........: No:TQC-750151 07/06/04 By rainy 轉應收發票後，馬上按"應收維護"開不起來，需重新QBE出來後，才能開應收維護
# Modify.......... NO.TQC-760054 07/06/06 By xufeng azf_file的index是azf_01(azf01,azf02),但是在抓‘中文說明’內容時，WHERE條件卻只有 azf01 = g_xxx
# Modify.........: NO.FUN-750108 07/06/15 By kim axmt628 加秀 帳單編號,發票號碼 加action 應收維護
# Modify.........: NO.TQC-780001 07/08/01 By wujie  在銷售參數檔axms100/聯機參數/出貨設置中不勾選任何欄位，在axmt620出貨單維護中，該參數未起作用
# Modify.........: No:MOD-770156 07/08/01 By claire 增加對發票號碼(oga27)的錯誤訊息:開窗功能只提供查詢時使用
# Modify.........: No:MOD-770017 07/08/08 By claire 新增時清除單頭的訂單號碼後再修改客戶編號以enter走after field稅別會有錯誤axm-142
# Modify.........: No:MOD-780068 07/08/09 By claire 匯率基準日取結關日,當空白時取單據日
# Modify.........: No:MOD-770013 07/08/09 By claire 以單身新增訂單項次來寫入訂單備註檔
# Modify.........: No:CHI-760021 07/08/20 By Smapmin 出貨簽收單開放文件地址維護功能
# Modify.........: NO.MOD-780221 07/08/21 BY yiting 合併出貨單頭訂單單號可空白，應check如單頭單號空白時，單身不可為空白
# Modify.........: No:MOD-780256 07/08/29 By Claire (1)多倉儲批要寫入料號ogc17
#                                                   (2)按放棄時資不應寫入
#                                                   (3)倉庫要控管可用否
# Modify.........: No:TQC-770040 07/08/29 By claire 合併出貨時,訂單輸入後帶出檢驗否需立即display至畫面
# Modify.........: NO.MOD-780279 07/08/30 BY yiting 出貨單性質屬於借貨出貨單'A','B' 不應該出現在其它性質出貨單選單中
# Modify.........: No:MOD-780284 07/08/31 By claire 單價維護要依幣別取位
# Modify.........: No:TQC-780095 07/09/03 By Melody Primary key
# Modify.........: NO.TQC-790100 07/09/17 BY Joe 修正Primary Key後, 程式判斷錯誤訊息時必須改變做法
# Modify.........: NO.TQC-7A0077 07/10/22 By xufeng 單身中返利不通過單頭訂單單號帶出,而是自行錄入的時候,作業方式b_ogb.ogb1005沒有賦值
# Modify.........: No:CHI-7A0036 07/10/24 By Carol 金額計算的處理同AXR
# Modify.........: No:FUN-7A0038 07/10/24 By Carrier 換貨出貨過帳還原後oga1014/oga1012重新顯示
# Modify.........: No:CHI-7B0023/CHI-7B0039 07/11/14 By kim 移除GP5.0行業別功能的所有程式段
# Modify.........: No:MOD-7B0221 07/11/26 By claire 多倉儲批勾選時,所帶出來資料不應先將倉儲批清空,應先判斷原值有無
# Modify.........: No.TQC-7B0107 07/11/29 By claire 串EasyFlow時,轉出貨簽收要隱藏
# Modify.........: No.MOD-7B0243 07/11/29 By claire 加上括號
# Modify.........: No:TQC-7B0159 07/11/30 By judy 錯誤信息'axm-244'更改為'axm-245'
# Modify.........: No.TQC-7B0166 07/12/04 By lumxa  在不按計價單位，使用多單位參考單位時修改數量總計算金額不對
# Modify.......... No.MOD-7C0012 07/12/04 By Carol 因QBE條件有oga欄位->調整t600_b1_fill()SQL加串oga_file
# Modify.........: No.TQC-7C0030 07/12/06 By Beryl 多角貿易拋轉過來的出貨單及出貨通知單，應不能通過更改送貨客戶按鈕修改送貨客戶，且當多角流程代碼對應的計價方式為1依來源營運中心時，應不能用單價按鈕修改單價
# Modify.........: No.MOD-7C0042 07/12/06 By claire 多倉儲批出貨時,更改出貨數量(ogc12)應及時推算庫存數量(ogc16)
# Modify.........: No.TQC-7C0055 07/12/07 By xufeng 欄位的是否可以輸入的狀態控管不嚴;理由嗎開窗可以開出不是出貨類型的
# Modify.........: No.TQC-7C0102 07/12/08 By chenl 增加"成品替代"功能按鈕
# Modify.........: No.TQC-7C0100 07/12/08 By Unicorn 完善報錯信息,控制單身筆數
# Modify.........: No:TQC-7C0114 07/12/08 By xufeng 1、返利單身的訂單開窗應該只開出訂單中返利資料，而不應該所有都帶出來,而且開窗顯示的字段也要改，改為oeb01,oeb03,oeb1007,oeb14,oeb14t,返回值不變
#                                                   2、出貨通知單應該把返利page拿掉，不要顯示出來
#                                                   3、出貨單若為調貨出貨單時,過賬的時候,系統會檢查調貨客戶是否可以修改單價，若可以修改單價，會有提示信息:atm-255,代送商須為不可更改單價之客戶。這個提示不正確，不能叫做代送商，應該叫做調貨客戶
#                                                   4、調貨銷貨單過賬時,調貨客戶抓不到單價時也能夠過賬過去，這是不對，應該不能過賬并且要有詳細提示信息
#                                                   5、調貨銷退單自動生成的出貨單應該不可隨意過賬還原，如果要過賬還原，也應該加一個確認:"此出貨單為調貨銷退產生的出貨單，如果還原，會造成庫存差異，請慎重!"
#                                                   6、銷退單號字段名稱應改為調貨銷退單號
#                                                   7、客戶所屬方，客戶所屬渠道字段應該設為No entry,并且應不為必須輸入
#                                                   8、寄銷出貨時代送商應設為不是必須輸入
#                                                   9、出貨單若為寄銷出貨單,并且又勾選了客戶出貨驗收,那麼在過賬的時候會在寄銷倉庫和驗收在途倉庫中同時產生調撥入的數量,這是不對的，一般來說寄銷的銷售模式配送時一般不需要客戶驗收，所以應該在訂單,出貨通知,出貨單，若為寄銷時,客戶出貨驗收
# Modify.........: No.CHI-7B0041 07/12/09 By Claire 出貨單/出通單若為中斷點單據不可拋轉還原及拋轉
# Modify.........: No:TQC-7C0131 07/12/11 By Judy  收貨單號，采購單號都綁定屬性群組，單身手動輸入項次時，料號無法帶出加入到cl_set_entry_b()
# Modify.........: No:TQC-7C0146 07/12/18 By claire 中斷點的單據,扣帳時要寫入多角序號,取消扣帳還原多角序號
# Modify.........: No.FUN-7C0017 07/12/26 By bnlent 增加行業別規範化修改 saxmt600.4gl ---> saxmt600.src.4gl
# Modify.........: No.FUN-7B0014 08/01/16 By bnlent 1、新增ICD行業功能2、5.1新功能增加  返利改善
# Modify.........: No:FUN-7C0050 08/01/15 By johnray 串查程序代碼添加共用 ACTION 的引用
# Modify.........: No:MOD-810054 08/01/30 By claire 當有區分保稅及非保稅出貨單時,產生單據的取號有問題
# Modify.........: No:MOD-810177 08/01/30 By claire 出貨單查詢出通單時,開窗無資料
# Modify.........: No:MOD-810239 08/01/30 By claire 多角出貨單及一般出貨單的訊息應區分
# Modify.........: No:MOD-810258 08/01/30 By claire 合併出貨單身訂單的客戶要相同
# Modify.........: No:FUN-7B0018 08/02/01 By hellen 行業比拆分表以后，增加INS/DEL行業別TABLE
# Modify.........: No:FUN-820046 08/02/25 By dongbg axmt610和axmt620兩支作業增加混合包裝訂單出貨功能
# Modify.........: No:FUN-810045 08/03/01 By rainy 項目管理，單身新增專案代號ogb41/WBS代號ogb42/活動代號ogb43
# Modify.........: No:MOD-830036 08/03/18 By claire 修正TQC-7C0055查詢時點單身的理由碼程式會掛
# Modify.........: No:MOD-830005 08/03/18 By claire 出貨簽收單時ogb912可以為0
# Modify.........: No:FUN-810036 08/01/16 By Nicola 序號管理
# Modify.........: No:MOD-820178 08/03/20 By claire 以成品替代出貨時,開出的t600b_w按確定會LOOP

# Modify.........: No:MOD-820014 08/03/20 By claire 通知日期不需check  axm-924 的訊息
# Modify.........: No:TQC-820014 08/03/20 By cliare (1) axmt820,axmt821,axmt850 單價action僅供查詢
#                                                   (2) axmt820,axmt821,axmt850 更改送貨客戶action取消
# Modify.........: No:MOD-820106 08/03/20 By cliare 中斷點後的出貨單,執行扣帳還原時,axmp650執行失敗,不能清除oga99流程序號,oga905拋轉
# Modify.........: No:CHI-820011 08/03/20 By cliare (1)單身的action單價由input改為display
#                                                   (2)單身的action其它資料可修改欄位調整               
# Modify.........: No:FUN-830078 08/03/20 By bnlent ICD行業BUG修改
# Modify.........: No:MOD-830189 08/03/25 By chenl  若為簽單，則客戶出貨簽收否oga65應為'N'，不必依據客戶主檔occ65取值。 
# Modify.........: No:FUN-830134 08/03/27 By bnlent 新增action（料件庫存指定) 
# Modify.........: No:MOD-830220 08/03/27 By Carol 代採逆拋t600_last() 排除 99 站 
# Modify.........: No:MOD-840067 08/04/08 By claire 多角單據過帳還原時,串出axmp650按取消會清空oga99,oga905
# Modify.........: No:MOD-840012 08/04/10 By claire TQC-7B0166 請原修改者取消修改 ,會造成ogb917 = ogb912 (不使用計價單位)
# Modify.........: No:MOD-840078 08/04/10 By claire 由出通單產出貨單身,金額沒有依原幣取位
# Modify.........: No:CHI-840009 08/04/10 By claire oaz71='2'時,批號不需帶入條件
# Modify.........: No:MOD-840086 08/04/10 By claire 銷退數量應只取銷退方式(oha09)為4.折讓,且以原訂單出貨
# Modify.........: No.FUN-840042 08/04/10 by TSD.liquor 自訂欄位功能修改 
# Modify.........: No:MOD-840099 08/04/12 By claire 連續輸入二筆出貨單頭,應清空g_oea.*變數,避免留有上一筆殘值
# Modify.........: No.CHI-830036 08/04/12 By claire 出貨單要印發票資料時,串回ofa_file要先判斷invoice來源為oga01,oga011再給條件
# Modify.........: No:CHI-830035 08/04/12 By claire 同一客戶有可能收款條件不符,需要控卡,增加一訊息axm-143的判斷 
# Modify.........: No:MOD-840118 08/04/15 By claire 透過訂單轉入的出通單,及透過訂單或出通單轉入的出貨單,造成沒有帶到occ67
# Modify.........: No:MOD-840143 08/04/18 By claire 信用額度超限時,取消確認時,仍應即時顯示超限原應oga902(不用重查再show)
# Modify.........: No:MOD-840330 08/04/21 By Mandy 由備品產生單身時,ogb1005沒給值
# Modify.........: No:MOD-840359 08/04/21 By claire 沒有輸入原因碼,不需控卡
# Modify.........: No:MOD-840495 08/04/21 By claire 多角程式不需顯示入庫單號
# Modify.........: No:MOD-840583 08/04/23 By claire 單身訂單單號修改,品名應重新帶出
# Modify.........: NO.MOD-840638 08/04/24 BY claire b_ogb.*應清空初值
# Modify.........: NO.MOD-840653 08/04/25 BY claire ROWID應調整為一個
# Modify.........: NO.CHI-840067 08/04/29 BY claire 出貨單修改出通單號時,確認單身的資料皆存在於出通單單身,否則以axm-224控卡
# Modify.........: NO.MOD-840695 08/04/30 BY claire 以訂單帶出單身時,倉儲批要判斷是否為空值
# Modify.........: NO.MOD-850029 08/05/05 BY claire 以單身直接維護時,應重取oea09的資料
# Modify.......... NO.CHI-840076 08/05/06 BY claire 按放棄不需寫入ogc_file
# Modify.........: No:FUN-850120 08/05/21 By rainy 批序號新增參數oaz81判斷出通是否做批序管理
# Modify.........: No:FUN-850100 08/05/19 By Nicola 批/序號管理第二階段
# Modify.........: No:FUN-850128 08/05/26 By sherry 選擇類別為 ""借貨還價", 
#                                                   在訂單編號 開窗 看不到 "借貨還價訂單資料
# Modify.........: No:MOD-850241 08/05/27 By Smapmin 增加背景傳遞參數
# Modify.........: No:MOD-850249 08/05/27 By Smapmin 修正MOD-680010
# Modify.........: No:MOD-850309 08/05/30 By Smapmin 修改t600_chk_ima262()接收的變數
# Modify.........: NO.MOD-860078 08/06/06 BY Yiting ON IDLE 處理
# Modify.........: NO.FUN-860002 08/06/10 BY xiaofeizhu 在axmt610新增欄位oga49
# Modify.........: NO.CHI-860008 08/06/11 BY yiting 刪除時移除專案條件
# Modify.........: No:FUN-860045 08/06/12 By Nicola 批/序號傳入值修改及開窗詢問使用者是否回寫單身數量
# Modify.........: No:MOD-860145 08/06/13 By claire 作廢還原先確認單身的訂單項次有沒有結案了,有的話不能還原作廢
# Modify.........: No:MOD-860069 08/06/14 By claire 代買多角出貨單,匯率要參考apms010(pod01)
# Modify.........: No:FUN-830160 08/06/19 By xiaofeizhu 出通單之通知日期(oga02)控管改為不可小於會計期間，但可大於會計期間
# Modify.........: No:FUN-850027 08/06/19 By douzh WBS編碼錄入時要求時尾階并且為成本對象的WBS編碼
# Modify.........: No:MOD-860202 08/06/23 By Smapmin axm-148的控管,未考慮訂單本身的超交率
# Modify.........: No:TQC-870003 08/07/02 By Sarah t600_chk_oga16()段抓取oga19的條件錯誤,應改為WHERE oma16=g_oga.oga16 and oma00 = '23'
# Modify.........: No:MOD-840533 08/07/10 By Pengu 出通單多倉儲出貨不應卡img是否存在
# Modify.........: No:MOD-870145 08/07/11 By Smapmin 列印出貨單時,備註沒有印出
# Modify.........: No:MOD-820066 08/07/15 By jan  修改金額計算，將單價*折扣率后的單價進行取位后再與數量相乘得到金額。
# Modify.........: No:MOD-830016 08/07/15 By jan  修正MOD-820066。需判斷折扣率是否為null，若為null則應該賦值為100
# Modify.........: No:CHI-870023 08/07/16 By sherry 輸入出通單後檢查是否出通單OQC確認
# Modify.........: No:MOD-870224 08/07/21 By Smapmin 借貨出貨單確認後不可修改單身資料
# Modify.........: No:CHI-870038 08/07/24 By xiaofeizhu 在"更改倉儲"畫面加處理"多倉儲出貨(ogb17)"，如勾選則開啟多倉儲出貨輸入畫面
# Modify.........: No:MOD-880039 08/08/06 By Smapmin 修改單價後未觸發on row change
# Modify.........: No:MOD-880087 08/08/12 By Pengu 借貨出貨單無法手動在單身輸入對應訂單單號
# Modify.........: No:MOD-880126 08/08/15 By lumx 調整通知單欄位的required 避免先輸a客戶（必制通知單） 后修改成b（不必）時候出錯
# Modify.........: No:MOD-870246 08/09/03 By claire 多角出通/貨單合併出貨時,未帶出代採/銷售的匯率設定
# Modify.........: No:MOD-870278 08/09/03 By claire (1) g_poz.poz011為空值
#                                                   (2)出通單拋轉還原要以參數設定為主,且有lock先後問題
# Modify.........: No:MOD-870299 08/09/03 By claire 出通單確認/取消確認時自動拋轉要考慮oax07設定
# Modify.........: No:MOD-880065 08/09/03 By claire 出通單確認/取消確認時不自動拋轉出通單
# Modify.........: NO:MOD-890049 08/09/03 By claire 給初值,否則造成使用沒有權限的action也沒有顯示錯誤訊息
# Modify.........: NO:MOD-890023 08/09/05 By chenyu ICD功能修改
# Modify.........: NO.MOD-820177 08/09/05 By chenl  若出貨單按出貨通知單多次出貨，金額應重新計算而不應按出貨通知單金額帶出。
# Modify.........: No:FUN-880129 08/09/05 By xiaofeizhu s_del_rvbs的傳入參數(出/入庫，單據編號，單據項次，專案編號)，改為(出/入庫，單據編號，單據項次，檢驗順序)
# Modify.........: NO:MOD-890055 08/09/05 By Smapmin 修改ogb1001 entry/noentry的控管
# Modify.........: No:FUN-870131 08/09/16 By Nicola 多倉儲批出貨批/序號功能
# Modify.........: NO:MOD-890240 08/09/24 By wujie  mark t600_du_default()
# Modify.........: No:MOD-890274 08/10/06 By Smapmin多倉儲出貨時,於單身輸入當下不做庫存是否足夠的控管.改為在輸入多倉儲的畫面再控管
# Modify.........: No:CHI-8A0005 08/10/06 By Nicola 抓取出通單批/序號資料時，加入批/序號項次做為關聯
# Modify.........: No:MOD-890181 08/10/06 By chenyu 使用計價單位的時候，單位相同的數量和計價數量可能會出現不同
# Modify.........: No:MOD-890221 08/10/06 By chenyu 修改單身訂單單號開窗條件
# Modify.........: No:FUN-8A0030 08/10/06 By xiaofeizhu 成品替代，多倉儲批/序號功能
# Modify.........: No:FUN-840012 08/10/13 By kim mBarcode整合
# Modify.........: No:MOD-8A0095 08/10/13 By Smapmin刪除多餘程式段
# Modify.........: No:MOD-8A0100 08/10/13 By Smapmin修改理由碼篩選條件
# Modify.........: No:MOD-8A0137 08/10/16 By chenl  修正無法抓取料計價單位件預設值問題。
# Modify.........: No:MOD-8A0222 08/10/24 By claire 本廠訂單對應的欄位應為oee10,oee11
# Modify.........: No:MOD-8A0098 08/10/14 By wujie  設定單別綁定屬性群組時，修改多屬性料件欄位，開窗返回的還是未修改的老料號
# Modify.........: NO:MOD-890080 08/09/11 By claire 多角出貨單切換DB後, 按扣帳還原應再確認目前DB一次
# Modify.........: No:MOD-8B0003 08/11/05 By Smapmin 修改required的控管方式
# Modify.........: No:FUN-8B0021 08/11/05 By Nicola FUN-8A0030測試問題修改 
# Modify.........: No.MOD-8B0023 08/11/05 By wujie  過賬還原時沒有正確刪除idd_file資料
# Modify.........: No:MOD-8A0098 08/10/14 By wujie  設定單別綁定屬性群組時，修改多屬性料件欄位，開窗返回的還是未修改的老料號
# Modify.........: No:MOD-8B0029 08/11/15 By Pengu 調整CURSOR t600b_c_2的OUTER語法
# Modify.........: No:MOD-8B0042 08/11/15 By Smapmin 修改單身手冊編號後並未更新
# Modify.........: No:MOD-8B0108 08/11/15 By Smapmin 輸入狀態時,訂單開窗需過濾訂單性質是否與出通單性質一致
# Modify.........: No:MOD-8B0212 08/11/24 By chenyu icd版本功能修改
# Modify.........: No:MOD-8A0176 08/11/25 By chenyu 控制單身項次不等于0
# Modify.........: No:MOD-8B0262 08/11/26 By Smapmin 原先由客戶編號控管出通單號required的判斷,於訂單單號輸入時也要做同樣的控管
# Modify.........: No:CHI-8B0048 08/11/28 By claire 扣帳還原段要傳參數辨別為扣帳還原或扣帳後拋轉失敗
# Modify.........: No:MOD-8B0302 08/12/01 By Smapmin 境外倉出貨的訂單做廢了，應該要還是可以取消確認
# Modify.........: No:MOD-8B0301 08/12/01 By Smapmin 多倉出貨時,查詢批序號時只秀出第一筆資料
# Modify.........: No:MOD-8C0003 08/12/02 By Smapmin 客戶編號輸入時,不應限制只能輸入買受人
# Modify.........: No:MOD-8B0275 08/12/09 By Smapmin 輸入完批序號資料後,因為沒有重新顯示數量欄位導致沒有跑on row change段
# Modify.........: No:MOD-8C0095 08/12/15 By Smapmin 訂單結案後,出貨單不可扣帳還原
# Modify.........: No:CHI-8C0013 08/12/15 By Smapmin 欄位的判斷不可寫於BEFORE INPUT,因為會導致append狀態不正常,故移至BEFORE ROW
# Modify.........: No:MOD-8C0110 08/12/15 By Smapmin 由訂單整批產生單身時,未加入合理性控管
# Modify.........: No.TQC-8C0027 08/12/15 By Nicola t600sub_bu1多傳oga_file
# Modify.........: No:MOD-8C0164 08/12/23 By chenl   若oaz104='N'，則在ogb091增加對img的判斷。
# Modify.........: No:MOD-8B0057 08/12/23 By chenl   單價按鈕功能，修正對oga10的判斷。
# Modify.........: No:MOD-910067 09/01/08 By chenyu 單身有數據，單頭稅率改變，單身的金額也應該重算
# Modify.........: No:FUN-8C0127 09/01/08 By Smapmin 將axmt600p畫面中的oga50改為oga50_1
# Modify.........: No:MOD-910186 09/01/16 By Smapmin 文件地址多oap044/oap045二個欄位
# Modify.........: No:MOD-910183 09/01/13 By sherry  還原MOD-4B0107的修改  
# Modify.........: No:MOD-910216 09/01/20 By sherry  單別已設置設限倉庫,但出貨通知單仍可以從此其他倉庫出  
# Modify.........: No:MOD-920019 09/02/02 By claire 多角出貨單axmt820,合併出貨時,未帶出oga32的值
# Modify.........: No:MOD-920025 09/02/03 By Smapmin 自動確認又直接扣帳時,
#                                                    傳入t600sub_y_upd()的第二個參數要寫死為confirm.
# Modify.........: No:CHI-920012 09/02/03 By Smapmin 增加一flag以記錄--新增段,修改單身時按放棄.若於過程中按放棄,則不應該跑自動確認與過帳.
# Modify.........: No:MOD-920048 09/02/04 By Smapmin 維護文件地址,地址碼為空白時oap041~oap045不可修改,且帶出occ241~occ245.
# Modify.........: No:FUN-920072 09/02/12 By Smapmin 增加傳票編號欄位
# Modify.........: No:MOD-920191 09/02/16 By chenyu 出貨通知單不需要檢查單別，還原MOD-910216修改內容
# Modify.........: No.MOD-920220 09/02/17 By Smapmin 由出通單帶出貨單資料時,未insert ogg_file
# Modify.........: No:MOD-920236 09/02/18 By Smapmin 輸入單位一後,未重新計算計價數量
# Modify.........: No:MOD-920270 09/02/19 By Smapmin 取消確認後重讀畫面
# Modify.........: No:MOD-920271 09/02/19 By Smapmin 客戶簡稱應抓oga032
# Modify.........: No:CHI-920081 09/02/23 By ve007 ica20-ica27欄位未使用，故MARK
# Modify.........: No:FUN-910036 09/02/23 By sabrina axmt628、axmt640與EF做整合
# Modify.........: No:MOD-920323 09/02/26 By Smapmin 離開單價畫面cursor未close,造成資料一直lock住
# Modify.........: No:FUN-920207 09/03/05 By jan 新增axmt640_icd的部分處理
# Modify.........: No:FUN-930038 09/03/06 By kim 借貨單的刻號/BIN資料過帳時要拋轉至調撥單，調撥單刪除時要拋轉回借貨單
# Modify.........: No:MOD-930121 09/03/11 By rainy 單身理由碼ogb1001開放可修改，且與訂單理由碼勾稽
# Modify.........: No:MOD-930130 09/03/12 By rainy 非新增狀態進到單身時，CALL t600_g_b2_p()時，g_oea無資料，導致判斷oea37有問題
# Modify.........: No:FUN-930104 09/03/23 By dxfwo   理由碼的分類改善
# Modify.........: No:MOD-940011 09/04/02 By Smapmin 簽收驗退單需在簽收單能有串查的功能
# Modify.........: No:MOD-930313 09/04/02 By Smapmin BEFORE CONSTRUCT位置放錯
# Modify.........: No:MOD-930322 09/04/02 By Smapmin 將axmt600p畫面中的ogb13/ogb14/ogb14t改為ogb13_1/ogb14_1/ogb14t_1
# Modify.........: No.MOD-930197 09/04/03 By Smapmin 出貨單單身指定料號後，而且在t600b_w不能選到原本的料號，應該要可以選到原本的料號(axmi123有資料)
# Modify.........: No:MOD-940053 09/04/07 By Dido 單價 action 中未稅金額合計因出通單輸入後而失真
# Modify.........: No:MOD-940055 09/04/07 By Dido 直接新增簽收單 oga65 須為 'N'
# Modify.........: No:CHI-940010 09/04/08 By hellen 修改SELECT ima或者imaicd欄位卻未JOIN相關表的問題
# Modify.........: No:MOD-940119 09/04/09 By Dido t600_b_ogg_1() 須先抓取再判斷 l_ima906 
# Modify.........: No:MOD-940130 09/04/10 By Dido 從訂單挑選 action 中增加過濾已出貨或出通訂單資料 
# Modify.........: No:MOD-940231 09/04/20 By Dido 若 oma16 = null 則開放 oga32 維護,並檢核是否與單身訂單收款條件相同
# Modify.........: No:MOD-940275 09/04/21 By Dido 合併處理 MOD-860197 問題
# Modify.........: No:MOD-940336 09/04/24 By Smapmin 出通單若已出貨並立帳,僅提供單價查詢
# Modify.........: No:MOD-940316 09/04/27 By Dido 單身修改後,若oga09 ='2' AND oga07 = 'Y',詢問是否重新產生分錄底稿
# Modify.........: No:MOD-940294 09/04/28 By Dido 序號管理應增加多角部分 g_argv0 = '1','5' 或者 g_argv0 = '2','4','6'
# Modify.........: No.MOD-940299 09/05/07 By Dido 科目別改用多角流程設定
# Modify.........: No:TQC-950162 09/05/26 By chenyu 訂單所有單身都已經結案，應該不可以輸入
# Modify.........: NO.MOD-860300 08/06/25 BY wujie q_azf10多了個參數
# Modify.........: No:TQC-950171 09/05/27 By chenyu 點X畫面不會關閉
# Modify.........: No:MOD-950250 09/05/31 By Dido 計價數量不可為空
# Modify.........: No.FUN-960007 09/06/03 By chenmoyan global檔內沒有定義rowid變量
# Modify.......... No.MOD-960004 09/06/04 By Dido oga07 切換時須增加詢問並刪除 npq_file
# Modify.........: No.MOD-960058 09/06/04 By Carrier 訂單帶出的客戶需要檢查
# Modify.........: No.CHI-960017 09/06/04 By mike 出貨單單身 , 選取訂單單號時 , 開窗會顯示單價 , 建議隱藏單價顯示 (因為出貨單有可能倉庫管理人員會看到單價資訊)
# Modify.........: No.TQC-950054 09/06/22 By jan updat行業別檔時，KEY值一并update 
# Modify.........: No:MOD-960139 09/06/23 By lilingyu 新增后先保存,然后修改客戶編號，后續的送貨客戶等值不會自動帶出
# Modify.........: No:MOD-960307 09/06/25 By lilingyu "單價"按鈕在出貨通知單中應隱藏 
# Modify.........: No:MOD-960349 09/07/06 By lilingyu  當單身無資料時,點擊"批/序號查詢"ACTION,程序當出
# Modify.........: No:MOD-950276 09/07/07 By Smapmin 出至境外倉訂單出貨單應顯示已產生的境外倉出貨訂單單號
#                                                    出至境外倉出貨單未過帳之前,oga910/oga911這二個欄位是可以修改的
# Modify.........: No:MOD-960046 09/07/07 By Smapmin 使用多單位但料件為單一單位或參考單位時,輸入單位一後檢核庫存是否足夠時要用庫存單位為基準
# Modify.........: No:MOD-970093 09/07/13 By mike 還原MOD-920191
# Modify.........: No:MOD-970091 09/07/14 By Dido 若已有應收既表示此筆已確認,因此單身時應無從檢核應收帳款
# Modify.........: No:MOD-970012 09/07/16 By Smapmin 維護文件地址離開後,cursor未release
# Modify.........: No:MOD-960347 09/07/16 By Smapmin 修改單頭客戶編號後,收款條件沒有一起更改
# Modify.........: No:MOD-970019 09/07/16 By Smapmin 檢核完庫存資料正確性後,回到倉儲批的那一個欄位,需考慮出貨設定
#                                                    銷售單位�庫存單位未抓取 
# Modify.........: No:MOD-970133 09/07/17 By lilingyu 當系統參數控管需多倉儲批時,應控管單身倉儲批欄位不可輸入
# Modify.........: No:MOD-970014 09/07/21 By Dido 收款條件增加多角檢核 
# Modify.........: No:TQC-970202 09/07/22 By lilingyu 還原MOD-970133修改的部分
# Modify.........: No:MOD-970092 09/07/22 By Dido RETURN 時改為 ogb03
# Modify.........: No:MOD-970149 09/07/24 By Smapmin 使用多單位且多倉庫出貨時,無法過帳還原,因為ogc17沒有給值
# Modify.........: No.FUN-870007 09/07/29 By Zhangyajun 流通零售功能修改
# Modify.........: No:MOD-970252 09/07/29 By mike 列印串包裝單時參數有誤，最后面倒數第三第四個參數應交換                            
# Modify.........: No:MOD-970260 09/07/29 By mike 目前出貨單確認后因有OQC單據而無法取消確認，但已將OQC狀態改為作廢，仍然會卡住無法取
# Modify.........: No:TQC-970352 09/07/30 By destiny _b1()時增加g_prog對axmp220_icd的判斷 
# Modify.........: No:MOD-980038 09/08/12 By Dido 簽收單不可修改與出貨單不同的出貨類別
# Modify.........: No:TQC-980154 09/08/20 By sherry 送貨客戶簡稱沒有帶出來      
# Modify.........: No:TQC-980196 09/08/24 By sherry 匯率輸入負數沒有控管    
# Modify.........: No.FUN-980010 09/08/25 By TSD.Martin GP5.2架構重整，修改 INSERT INTO 語法
# Modify.........: No:MOD-980217 09/08/27 By mike 調整 oga09 預設值    
# Modify.........: No.MOD-980238 09/08/27 By 還原 MOD-910183 修改
# Modify.........: No.FUN-950093 09/08/27 By chenmoyan 增加單身訂單查詢功能
# Modify.........: No:TQC-980197 09/08/28 By lilingyu "幣種"欄位輸入任何值沒有控管
# Modify.........: No:FUN-980030 09/08/31 By Hiko 加上GP5.2的相關設定
# Modify.........: No:MOD-980247 09/09/01 By Smapmin [更改倉儲]倉儲開窗應開跟單身開的一樣
# Modify.........: No:FUN-960130 09/09/04 By Sunyanchun 取價
# Modify.........: No.FUN-980020 09/09/18 By douzh GP5.2架構重整，修改sub相關傳參
# Modify.........: No:MOD-990233 09/09/28 By Dido 銷售正拋過帳還原應可執行 axmp650                      
# Modify.........: No:FUN-970108 09/08/20 By hongmei add oga71申報統編
# Modify.........: No:TQC-980071 09/09/30 By mike 取消收款條件多角條件(oga32)邏輯     
# Modify.........: No:MOD-9A0014 09/10/02 By Dido 若單頭未輸入訂單則訂金比率改抓單身                      
# Modify.........: No:MOD-990096 09/10/08 By Smapmin axmt628將單身刪除功能拿掉
# Modify.........: No:MOD-990097 09/10/09 By lilingyu 如果將出貨通知單和出貨單作廢,則允許更改訂單;這時候再將出貨單、出通單取消作廢,而產生的出貨單單身資料和訂單單身的資料不一致
# Modify.........: No.FUN-960038 09/10/15 By chenmoyan 專案加上'結案'的判斷
# Modify.........: No.CHI-960022 09/10/15 By chenmoyan 預設單位一數量時，加上判斷，單位一數量為空或為1時，才預設
# Modify.........: No:FUN-990074 09/09/24 By mike axmt610文件地址action中,交運方式的中文要顯示在oga43的右手邊.                      
# Modify.........: No:TQC-9A0115 09/10/23 By xiaofeizhu 標準SQL修改
# Modify.........: No:TQC-9A0161 09/10/28 By Carrier SQL STANDARDIZE
# Modify.........: No:CHI-9A0052 09/11/02 By Smapmin 將語法加回去
# Modify.........: No:CHI-970040 09/11/02 By Smapmin axmt628加上批序號維護
# Modify.........: No:MOD-9B0012 09/11/03 By Smapmin 含稅金額計算錯誤
# Modify.........: No:CHI-9B0002 09/11/03 By Smapmin 程式寫法改善
# Modify.........: No:MOD-9A0187 09/11/03 By Smapmin 欄位輸入與否的控管要成對出現
# Modify.........: No:MOD-9A0122 09/11/03 By Smapmin 出貨單轉出貨簽收時,批序號資料未一併產生
# Modify.........: No.FUN-9B0016 09/11/08 By Sunyanchun post no
# Modify.........: No:CHI-980019 09/11/05 By jan 虛擬料件不可做任何單據
# Modify.........: NO.FUN-9B0039 09/11/05 BY liuxqa substr的修改。
# Modify.........: No:MOD-9B0124 09/11/19 By Smapmin 借貨出貨不走簽收流程,故將簽收否欄位隱藏
# Modify.........: No.FUN-9B0106 09/11/19 By kevin 用s_dbstring(l_dbs CLIPPED) 判斷跨資料庫
# Modify.........: No:MOD-9C0016 09/12/02 By mike 原有的零售管控非成本仓拿掉
# Modify.........: No:MOD-9C0055 09/12/04 By Smapmin 變數初始化
# Modify.........: No:CHI-9C0009 09/12/04 By Dido 銷售正拋時若倉儲不存在需新增 img_file
# Modify.........: No:MOD-9C0092 09/12/09 By Dido 多角序號應僅限於多角使用 
# Modify.........: No:MOD-9C0105 09/12/10 By Smapmin 維護文件地址若按放棄,應要把舊值回復
# Modify.........: No:FUN-9C0064 09/12/14 By Cockroach oha87 改为开窗录入
# Modify.........: No:MOD-9C0128 09/12/15 By Smapmin 客戶編號有修改後,才重新預設客戶其他的資料
# Modify.........: No:MOD-9C0141 09/12/16 By Smapmin ogg091/ogg092為空白時,不要再重新抓值
# Modify.........: No:MOD-9C0183 09/12/18 By sabrina 輸入訂單號碼後，不可修改oga032 
# Modify.........: No:FUN-9C0120 09/12/21 By mike 通过价格条件管控未取到价格时单价栏位是否可以人工输入
# Modify.........: No:FUN-990053 09/12/29 By baofei s_chkban前先檢查aza21 = 'Y'
# Modify.........: No:FUN-9C0173 09/12/29 By mike 当oaz65='0'时，取价失败
# Modify.........: No:FUN-A10016 10/01/06 By bnlent 1.单身删除显示不正确 2.单身新增分摊折价没取到 
#                                                   3.无订单出货时，经过订单或订单项次栏位时数量不应重置为0
# Modify.........: No:CHI-A10016 10/01/18 By Dido 調整 s_lotout transcation 架構 
# Modify.........: No.FUN-9C0073 10/01/18 By chenls 程序精簡
# Modify.........: No.TQC-A10153 10/01/25 By lilingyu 1. 單頭無訂單單號和出通單號時,訂單單號ogb31開窗查不到明細,但可以手工錄入
# ...............:                                    2.ogb32增加對應的開窗
# Modify.........: No:FUN-A10110 10/01/26 By Cockroach 出貨單新增【折價明細】按鈕
# Modify.........: No:FUN-A10106 10/02/01 By destiny 出货单新增赠品发放按钮
# Modify.........: No:MOD-A20021 10/02/03 By Dido 單價視窗放棄時,需更新 INT_FLAG 
# Modify.........: No:CHI-960010 10/02/05 By Smapmin 回寫已出貨未稅金額應於過帳段才回寫
# Modify.........: No:FUN-A20022 10/02/05 By Cockroach 會員積分計算
# Modify.........: No:MOD-A20068 10/02/09 By Smapmin 由訂單自動產生出通時,若數量為0則不要產生該項次
# Modify.........: No:MOD-A20069 10/02/09 By Smapmin 修正MOD-990097
# Modify.........: No:MOD-A10163 10/02/22 By Smapmin 產生客戶簽收單時,rvbs022/rvbs13重給default值
#                                                    客戶簽收單不會有多倉儲資料
# Modify.........: No:CHI-A10002 10/02/23 By sabrina 確認時,無倉儲批的錯誤訊息請加上料號,當單身筆數很多時,會查不出是哪一筆的問題
# Modify.........: No:MOD-A10010 10/02/23 By sabrina t600_3()UPDATE段多增加ogb092 
# Modify.........: No:CHI-A20017 10/02/23 By Dido 多角須控管 axm-075 
# Modify.........: No:CHI-9C0024 10/02/23 By Smapmin 多倉儲的畫面,數量移到倉儲批後面
# Modify.........: No:MOD-A20102 10/02/24 By Smapmin oaz71='2'時,批號不需帶入條件
# Modify.........: No.TQC-A20058 10/02/25 By Cockroach lpj05的條件不完全
# Modify.........: NO:CHI-880006 10/02/24 By Smapmin 單身檢驗碼(ogb19)不可維護
# Modify.........: No:MOD-A30051 10/03/10 By Smapmin 還原MOD-960307的修改
# Modify.........: No.TQC-A30041 10/03/16 By Cockroach add oriu/orig 
# Modify.........: No:CHI-9A0022 10/03/20 By chenmoyan給s_lotout加一個參數:歸屬單號
# Modify.........: No.FUN-9C0103 10/03/17 By vealxu 原call s_lotout前，抓取歸屬單號的程式段增加判斷
# Modify.........: No.FUN-A30063 10/03/19 By Cockroach add ogacont
# Modify.........: No.FUN-A20044 10/03/20 By jiachenchao 刪除字段ima26*
# Modify.........: No.FUN-970017 10/04/01 By Lilan (1)EasyFlow 自動執行確認功能
#                                                  (2)axmt628出貨簽收單,應也要能做此Action
# Modify.........: No:MOD-A40051 10/04/13 By Summer 單據編號編碼原則改依輸入日期來編碼
# Modify.........: No:TQC-A40082 10/04/19 By lilingyu t600_cs段FUN-630061修改處導致后續sql錯誤
# Modify.........: No:MOD-A40013 10/04/20 By Smapmin 出通單單頭的"結關日期"改為"預計出貨日期"
# Modify.........: No:TQC-A40113 10/04/22 By lilingyu 訂單分配時,在數量ogb12處過不去
# Modify.........: No.FUN-A50071 10/05/19 By vealxu GP5.2 相關程序增加POS單號字段 并管控如果不為空的情況下 不可取消審核與取消過帳
# Modify.........: No.TQC-A50152 10/05/26 By lilingyu oeb03項次欄位條件錯誤 
# Modify.........: No.TQC-A50162 10/05/28 By houlia oga94 POS銷售否=Y時，不可取消審核
# Modify.........: No.FUN-A50054 10/06/01 By chenmoyan 增加款式明細功能
# Modify.........: No:CHI-A40029 10/06/04 By Summer 針對出貨單之img_file的控管一律移到過帳段
# Modify.........: No:MOD-A50076 10/06/15 By Smapmin 由訂單產生尚可出貨的數量時,要考慮簽收驗退的量
# Modify.........: No.MOD-A60112 10/06/18 By Carrier 订单单号检查时,要check项次已经KEY了,若项次为空,则确定不了订单单身
# Modify.........: No.MOD-A60121 10/06/21 By Carrier SELECT tqa_file时没有给tqa03值
# Modify.........: No.MOD-A60134 10/06/21 By Carrier t600_ogb04()仅在azw04='2'时才需要检查
# Modify.........: No:FUN-A50103 10/06/03 By Nicola 訂單多帳期 
# Modify.........: No:CHI-A50004 10/06/24 By Summer 在確認/取消確認/過帳/取消過帳時,將lock資料的動作往前移至FUNCTION的一開始
# Modify.........: No:FUN-A60035 10/07/05 By chenls 款式明細時維護s_detail
# Modify.........: No.FUN-A60035 10/07/08 By chenmoyan 零售業沒有考慮到服飾行業
# Modify.........: No.TQC-A70061 10/07/16 By houlia oga52、oga53不能為null
# Modify.........: No.TQC-A60132 10/07/21 By chenmoyan 訂單轉出通單時,外連語句不規範
# Modify.........: No:MOD-A70182 10/07/23 By Smapmin 由出通單自動產生單身時,即應篩選訂單未結案item,可防止流程上的重工及困擾
# Modify.........: No:MOD-A70144 10/07/23 By Smapmin 單身預設上筆資料時,訂單項次不要default
# Modify.........: No:MOD-A70140 10/07/23 By Smapmin 修改完單位一後,未重新計算計價數量
#                                                                   金額未重新計算
# Modify.........: No.FUN-A60035 10/07/28 By chenls 服飾版二維功能mark
# Modify.........: No.FUN-A70138 10/07/29 By jan 重過單
# Modify.........: No.FUN-A70123 10/07/29 By bnlent 產品採購策略中取不到經營方式時默認為經銷
# Modify.........: No:MOD-A70067 10/07/29 By Smapmin 由出通單default出貨單,簽核否的欄位要依出貨單的單別來設定
# Modify.........: No:MOD-A70059 10/07/29 By Smapmin 修改檢驗庫存不足的判斷
# Modify.........: No:MOD-A70014 10/07/29 By Smapmin 修正FUN-610064
# Modify.........: No:MOD-A60198 10/07/29 By Smapmin ogc18為NULL
# Modify.........: No:MOD-A60163 10/07/30 By Smapmin oga909為空時,default為N
# Modify.........: No:CHI-A30017 10/08/02 By Summer 調整axm-924的控管，只有是axmt628(出貨簽收)時，才須做此控管，其餘皆不用
# Modify.........: No:FUN-A80081 10/08/09 By xiaofeizhu 出貨和訂單不要一一對應,出貨時直接錄入料號和數量,由系統自動根據訂單進行數量分配生成出貨單
# Modify.........: No:FUN-A70130 10/08/20 By huangtao  修改q_oay參數
# Modify.........: No:FUN-A70132 10/08/20 By lixh1  增加 "實際交易稅別明細"Action,"單身稅別明細" Action
# Modify.........: No.FUN-A60004 10/08/31 By vealxu 功能單
# Modify.........: No.MOD-A90032 10/09/07 by Dido 作廢時應刪除分錄底稿 
# Modify.........: No:MOD-A90150 10/09/23 By Dido 出口報單號碼需檢核是否為 14碼 
# Modify.........: No:MOD-A90158 10/09/28 By Smapmin 多角時詢問是否依送貨客戶重新抓取交易條件
# Modify.........: No:MOD-A90170 10/09/28 By Smapmin 修正TQC-A40082
# Modify.........: No:CHI-A90022 10/09/29 By Summer 寫入azo_file時,程式代號改為g_prog
# Modify.........: No:MOD-AA0060 10/10/12 By sabrina 依據系統設定的單別長度抓取
# Modify.........: No:FUN-A90040 10/10/09 By Shenyang 新增ogb48,ogb49,ogb50欄位
# Modify.........: No:FUN-AA0048 10/10/20 By Carrier GP5.2架构下仓库权限修改
# Modify.........: No:FUN-A40022 10/10/25 By jan 當料件為批號控管,則批號必須輸入
# Modify.........: No:FUN-AA0007 10/10/26 By jan 若輸入的批號之i17='Y',則控卡不能輸入
# Modify.........: No:FUN-AA0089 10/10/28 By suncx 單身選擇料件時可多選，多選后自動生成多筆單身
# Modify.........: No:FUN-AA0059 10/10/29 By chenying 料號開窗控管 
# Modify.........: No:FUN-AA0059 10/10/29 By huangtao 修改料號AFTER FIELD的管控
# Modify.........: No:FUN-AA0057 10/11/02 BY shiwuying INSERT INTOogb_file前ogb50给预设值
# Modify.........: No:MOD-AB0053 10/11/05 By lilingyu 如果是"製造"業態時,出貨單action"單價"也應該顯示出來
# Modify.........: No:FUN-AB0011 10/11/08 By huangtao 從庫存抓取資料前做料號控管
# Modify.........: No:MOD-AB0061 10/11/09 By Smapmin 無單身資料時按查詢序號功能,程式會當掉
# Modify.........: No.MOD-AA0029 10/11/09 By Smapmin 輸入完訂單號碼後,若客戶為MISC,應帶出occm_file相關欄位
# Modify.........: No:MOD-A90122 10/11/09 By Smapmin 從訂單挑選的ACTION要提供重查功能
# Modify.........: No:MOD-A90036 10/11/09 By Smapmin 增加提示訊息
# Modify.........: No:MOD-A80192 10/11/09 By Smapmin ogc18都是1,導致進到替代功能的畫面後按批序號維護資料都是同一筆
# Modify.........: No:MOD-A80056 10/11/09 By Smapmin 產生分錄底稿時,選擇批次產生時,未加上oga07='Y'的條件.
# Modify.........: No:FUN-AB0011 10/11/09 By huangtao 庫存抓取資料前做料號控管
# Modify.........: No:MOD-AA0088 10/11/09 By sabrina 更改倉儲action,已挑選刻號/BIN資料,應不可修改倉儲批
# Modify.........: No:FUN-AB0025 10/11/10 By chenying 修改料號開窗
# Modify.........: No:FUN-AB0059 10/11/16 By huangtao 添加料號相關控卡
# Modify.........: No:FUN-AB0061 10/11/16 By shenyang 添加ogb37欄位
# Modify.........: No:FUN-AB0039 10/11/25 By lixh1    當程式代碼 "axmt620"時,"單身稅別明細"及"實際交易稅別明細"Action才顯示,否則隱藏
# Modify.........: No:MOD-AB0233 10/11/26 By Dido 若訂金比率為 100 則 oga07 應為 'N' 
# Modify.........: No.TQC-AB0251 10/11/29 By shenyang GP5.2 SOP流程修改
# Modify.........: No.TQC-AB0253 10/11/29 By shenyang GP5.2 SOP流程修改
# Modify.........: No:MOD-AB0247 10/11/30 By sabrina 出貨單單身筆數沒有控卡所輸入的筆數資料
# Modify.........: No:MOD-AB0246 10/11/30 By sabrina 當oga09='2' AND oga07='Y'時，單頭修改出貨日期後應重新產生分錄底稿 
# Modify.........: No:CHI-AB0029 10/11/30 By Summer INVOICE,PACKING增加直式列印的選項
# Modify.........: No.TQC-AB0242 10/11/30 By lixh1    點擊右邊"單價"action,更改單價後，最新單價及時顯>
#示在主畫面單身裡
# Modify.........: No:MOD-AC0012 10/12/01 By Smapmin 過帳還原成功後,才處理idd_file還原的動作
# Modify.........: No.TQC-AB0329 10/12/02 By wuxj     查询客户签收更改
# Modify.........: No:FUN-AC0012 10/12/03 By shiwuying 單價按鈕邏輯更改，如果單價有改動寫一筆資料到rxc_file中，更新折價金額
# Modify.........: No:FUN-AA0057 10/12/06 BY shenyang  修改q_lnt06_1 傳入參數  
# Modify.........: No:MOD-AC0070 10/12/09 By Smapmin 出貨單不需打訂單時,ogb05_fac沒有重新計算
# Modify.........: No:TQC-AC0101 10/12/09 By huangtao 服飾業隱藏款式明細
# Modify.........: No:CHI-AC0002 10/12/13 By Summer 增加分錄底稿二ACTION
# Modify.........: No:TQC-AC0177 10/12/14 By chenying 單身欄位"攤位編號"、"商戶編號"、"開票性質"應為流通業時才顯示
# Modify.........: No:FUN-AB0096 10/12/14 By shiwuying 稅別明細按鈕只有azw04=2才顯示
# Modify.........: No:TQC-AC0191 10/12/20 By suncx azw04=2時才顯示可發贈品按鈕     
# Modify.........: No:TQC-AC0140 10/12/20 By suncx 價格策略允許自定價時,單價維護BUG調整  
# Modify.........: No:FUN-A50029 10/12/21 By Lilan 控制EF簽核時,ICD行業別不可執行的ACTION
# Modify.........: No.FUN-AC0055 10/12/21 By wangxin oga57欄位預設值修正
# Modify.........: No:MOD-AB0152 10/12/24 By Summer 簽收流程,簽收單已立帳,出貨單與出通單都不能修改單價
# Modify.........: No:MOD-AC0089 10/12/24 By Summer 刪除出貨單時,相關文件未刪除
# Modify.........: No:MOD-AC0132 10/12/24 By Smapmin 客戶簽收單出貨單號開窗錯誤
# Modify.........: No:FUN-AC0097 10/12/29 By shiwuying 取消對訂單編碼的檢查
# Modify.........: No:MOD-AC0170 10/12/28 By shiwuying 現金折扣項次,料號DEFAULT 'MISC' 數量DEFAULT '1'方式處理
# Modify.........: No:FUN-AC0097 10/12/29 By shenyang 修改bug
# Modify.........: No:MOD-AC0376 11/01/05 By Smapmin 1.多單位的換算率不正確.
#                                                    2.修改單位數量後計價數量沒有重算.
# Modify.........: No:CHI-AC0034 11/01/06 By Summer 產生的簽收單axmt628,若是替代的要多新增ogc_file
# Modify.........: No:MOD-B10020 11/01/07 By Summer 按出貨單明細 action 串至axmt620 時顯示 error 
# Modify.........: No:FUN-B10010 11/01/07 By shenyang 右邊單價按鈕的畫面中顯示基礎單價
# Modify.........: No:FUN-B10014 11/01/07 By shiwuying 零售才写rxc_file
# Modify.........: No:TQC-B10066 11/01/10 By shiwuying 單身一顯示物返資料，單身二只顯示現返資料
# Modify.........: No:TQC-B10088 11/01/10 By shiwuying 物返资料ogb16需要给值,需要更新库存
# Modify.........: No:FUN-B10024 11/01/13 By shiwuying 單身刪除后，在刪除的那一行重新錄資料，不會走after insert
# Modify.........: No:MOD-B10134 11/01/18 By Summer 出貨類別為:A借貨出貨時,oga72為不顯示,AFTER INPUT段不再判斷為必須輸入
# Modify.........: No:MOD-B10154 11/01/20 By shiwuying 会员卡积分计算调整
# Modify.........: No:FUN-A60003 11/01/20 By Lilan EF送簽中不可執行的ACTION
# Modify.........: No:MOD-AC0060 11/01/25 By Smapmin 借貨出貨流程,多倉儲出貨也要能輸入批序號資料
# Modify.........: No:MOD-B10204 11/01/25 By lilingyu "單價"action:單身數據不可更改時,原先是直接關閉“單價”窗口；現改為報錯信息,點擊退出按鈕才退出"單價"窗口
# Modify.........: No:MOD-B20059 11/02/15 By Summer 出貨單依條件整批產生分錄底稿時,會連出通單亦一同產生,導致後續拋轉傳票及報表錯誤
# Modify.........: No:MOD-B20070 11/02/17 By Summer 修正FUN-670007,IF l_last_plant != l_now THEN的條件拿掉
# Modify.........: No:MOD-B20074 11/02/17 By Summer 借貨出貨/借貨償價訂單,因為都不會有簽收流程,故改為-->單頭[出貨簽收]欄位default='N' 且設為noentry
# Modify.........: No:TQC-B20053 11/02/18 By huangtao 增加產品料號的控管
# Modify.........: No:MOD-B20147 11/02/24 By Summer 還原MOD-B20070的修改,用站別去做銷售逆拋流程是否可打出通/出貨的控卡
# Modify.........: No:MOD-B30026 11/03/07 By Summer axmt600b畫面倉儲批entry/noentry的控卡,要同axmt620主畫面倉儲批entry/noentry的控卡
# Modify.........: No:TQC-B30086 11/03/08 By huangtao 新增時，發票性質預設為1、商場發票
# Modify.........: No:TQC-B30107 11/03/10 By zhangll 修正FUN-AB0011问题l_ac->l_ac1
# Modify.........: No:MOD-B30218 11/03/12 By wangxin 修改數量后，不重新取價
# Modify.........: No:MOD-B30467 11/03/14 By baogc 增加判斷為非零售業時，折價明細按鈕隱藏
# Modify.........: No:MOD-B30453 11/03/14 By suncx 款別明細的ACTION無需做權限判斷 
# Modify.........: No:TQC-B30124 11/03/15 By zhangll 快速錄入功能中取消与订单勾稽
# Modify.........: No:MOD-B30485 11/03/17 By chenying 原MOD-B10204的修改mark掉;
#                                                     "單價"action:單身數據不可更改時,按下確認應可直接跳出,現報誤信息-->在display array後面的屬性加上accept=FALSE,cancel=FALSE
# Modify.........: No:FUN-B30012 11/03/18 By huangtao 單身有贈品不可進入單身，單身有訂單贈品不可進入單身不可點擊可發贈品
# Modify.........: No:MOD-B30301 11/03/18 By chenying 修改報錯訊息
# Modify.........: No:MOD-B30464 11/03/22 By Summer 還原CHI-8B0048的修改 
# Modify.........: No:MOD-B30486 11/03/22 By Summer AFTER FIELD ogb17,IF ogb17='Y',ogb倉儲批資料都變為一個空白 
# Modify.........: No:MOD-B30419 11/03/22 By Summer 單頭訂單自動產生單身時,ogb17不應該為NULL 
# Modify.........: No:TQC-B30189 11/03/25 By baogc 修改bug
# Modify.........: No:FUN-B30211 11/04/01 By lixiang  加cl_used(g_prog,g_time,2)
# Modify.........: No:TQC-B40067 11/04/11 By yinhy s_chkban前先檢查aza21 = 'Y'
# Modify.........: No:MOD-B30487 11/04/12 By Smapmin 多倉儲畫面的ogc18數值皆相同,導致無法正確帶出批序號資料
#                                                    還原MOD-B30486,因為單身的倉儲資料會做為多倉儲的預設
# Modify.........: No:FUN-B30170 11/04/11 By suncx 單身增加批序號明細頁簽
# Modify.........: No:TQC-B40101 11/04/13 By lilignyu 單身輸入攤位時,需判斷若單頭發票性質欄位='商戶開票'時,需控管攤位欄位為必填
# Modify.........: No:MOD-B40148 11/04/19 By Summer 轉出貨簽收時ins ogc重複 
# Modify.........: No:MOD-B40171 11/04/20 By Summer 單頭有打訂單編號時,幣別/稅別等欄位會變為noentry,其值是依訂單帶過來的
#                                                   故MOD-A90158這張單子的修改要加上,當單頭訂單單號為空時才成立 
# Modify.........: No:TQC-B40204 11/04/25 By lilingyu EF簽核相關BUG修改
# Modify.........: No:FUN-B40076 11/04/26 By xianghui 開放axmt620_icd的資料庫存指定功能
# Modify.........: No:FUN-B10026 11/04/25 By lixiang 增加axmt629列印功能
# Modify.........: No:CHI-B30093 11/04/26 By lilingyu 出貨簽收批號管理
# Modify.........: No:FUN-B40096 11/04/29 By zhangll 單身刪除異常報錯修正
# Modify.........: No:FUN-9B0132 11/05/05 By suncx 新增超限原因開窗及超限原因說明顯示
# Modify.........: No:FUN-AC0074 11/05/06 By lixh1 如果訂單有備置數量,首先從備置檔出貨
# Modify.........: No:MOD-B40263 11/05/09 By Smapmin 修改預設備註的邏輯
# Modify.........: No:FUN-B50054 11/05/12 By shiwuying 单身增加抽成代号ogb40
# Modify.........: No:FUN-B40056 11/05/12 By lixia 刪除資料時一併刪除tic_file的資料
# Modify.........: No:TQC-B50099 11/05/19 By yinhy 點擊"查詢多倉儲批庫存明細"畫面調不出,加控管,"验退量"只有在oga09='8'時才顯示
# Modify.........: No:TQC-B50117 11/05/30 BY yangxf 輸入單身退出程序,在傳參時,兩個參數位置顛倒
# Modify.........: No:MOD-B60001 11/06/01 By Smapmin 輸入單頭的會員卡號時,要再計算一次oga95
# Modify.........: No:TQC-B50052 11/06/02 By lixh1 UPDATE ogb12的時候同時UPDATE ogb16,ogb18
# Modify.........: No:MOD-B60052 11/06/07 By JoHung 訂單編號及項次不為空時才取訂單單價
 
# Modify.........: No:MOD-B50142 11/06/07 By Summer 還原CHI-690060 mark掉的那行  
# Modify.........: No:CHI-B60054 11/06/09 By yinhy MARK掉CHI-B30093和TQC-B50099單號更改內容
# Modify.........: No:MOD-B50227 11/06/10 By Summer 出貨有設備置量時,出貨數量不可超過備置量
# Modify.........: No:MOD-B60010 11/06/15 By Summer 判斷oga54<>0的地方,改判斷-->出通/出貨單據是否存在未作廢invoice,若存在則不可刪除
#                                                   若不存在則再判斷單據對應的帳款是否有開發票
# Modify.........: No:MOD-B60101 11/06/15 By Summer 流通配銷ogb11可放開
# Modify.........: No:TQC-B60155 11/06/17 By wuxj   CREATE TEMP TABLE ogc_temp少了兩個欄位plant、legal
# Modify.........: No.TQC-B60161 11/06/17 By yangxf t600_bp1()和t600_bp2()最後一個DISPLAY寫反了
# Modify.........: NO.huyx110916 11/09/16 by huyx 单身增加已对账数量（ogbud07）、已验退数量（ogbud08）、未对账数量（ogbud09）3个栏位,其中未对帐数量ogbud09=ogb12-ogbud07-ogbud08,FORMONLY栏位,仅显示,不保存在字段中
# Modify.........: NO.111017     11/10/17 by xiayan 打印增加按钮
# Modify.........: No:MOD-B70090 11/07/11 By suncx  查詢一筆未審核單據點擊單價action修改單價後保存不成功，g_success未負初值
# Modify.........: NO.120912     12/09/12 by xiayan 单身增加包装方式和体积栏位
# Modify.........: No:MOD-C30033 12/03/15 By Vampire 定義另一個變數與l_qoh型態一樣,將p_ogb.ogb12 * p_ogb.ogb05_fac存入該變數後,兩個變數值再做比大小
# Modify.........: No:FUN-C50097 12/06/04 By SunLM 當oaz92=Y(立賬走開票流程)且大陸版時,判斷參數oaz94='Y'(出貨多次簽收)時，增加多次簽收功能
# Modify.........: No:FUN-C50097 12/06/27 By SunLM 因前期分析不足,修改時間過長,為避免影響他人作業,暫時mark掉,待其他同仁完成后,再恢復
# Modify.........: No:FUN-C60033 12/07/12 By minpp 若此出货单已存在于axmt670里面，则报错，不可扣帐还原
# Modify.........: No:TQC-C70206 12/07/26 By SunLM 將FUN-C50097中，非多次多次簽收功能過單到正式區，既與oaz94無關的參數。
# Modify.........: No:FUN-C60036 12/08/01 By xuxz 回覆fun-c60033之前mark的
# Modify.........: No:FUN-C80107 12/11/28 By suncx 新增可按倉庫進行負庫存判斷
# Modify.........: No:MOD-B80048 15/07/13 By pane t600_g_b1判斷若ogb091、ogb092為NULL時給一空白

DATABASE ds

#mod by huyx110916---start---
#GLOBALS "../../config/top.global"
#GLOBALS "../4gl/saxmt600.global"
GLOBALS "../../../tiptop/config/top.global"
GLOBALS "../../../tiptop/axm/4gl/saxmt600.global"
#mod by huyx110916---end---
GLOBALS "../../../topcust/cws/4gl/aws_wms_global.4gl"   #No.FUN-7C0010

DEFINE g_ima918  LIKE ima_file.ima918  #No:FUN-810036
DEFINE g_ima921  LIKE ima_file.ima921  #No:FUN-810036
DEFINE l_r       LIKE type_file.chr1   #No:FUN-860045
DEFINE g_check   LIKE type_file.chr1   #MOD-990097
DEFINE l_tmoga01 LIKE oga_file.oga01   #FUN-9B0039 mod
#DEFINE g_ata00   LIKE ata_file.ata00   #FUN-A50054   #FUN-A60035 ---MARK
#FUN-A80081--Add--Begin
DEFINE g_ogb1 DYNAMIC ARRAY OF RECORD                                                                                            
              ogb04  LIKE ogb_file.ogb04,                                                                                         
              ima02  LIKE ima_file.ima02,
              ima021 LIKE ima_file.ima021,
              ogb09  LIKE ogb_file.ogb09,
              ogb091 LIKE ogb_file.ogb091,
              ogb092 LIKE ogb_file.ogb092,
              img09  LIKE img_file.img09,
              qty    LIKE type_file.num5             
              END RECORD                                                                                                         
DEFINE g_ogb1_t  RECORD                                                                                            
              ogb04  LIKE ogb_file.ogb04,                                                                                         
              ima02  LIKE ima_file.ima02,
              ima021 LIKE ima_file.ima021,
              ogb09  LIKE ogb_file.ogb09,
              ogb091 LIKE ogb_file.ogb091,
              ogb092 LIKE ogb_file.ogb092,
              img09  LIKE img_file.img09,
              qty    LIKE type_file.num5                                                                                        
              END RECORD 
DEFINE l_ac1  LIKE type_file.num5 
#FUN-A80081--Add--End
DEFINE g_multi_ima01  STRING                 #FUN-AA0089  add
#FUN-B30170 add begin--------------------------
DEFINE g_rvbs   DYNAMIC ARRAY OF RECORD        #批序號明細單身變量
                  rvbs02  LIKE rvbs_file.rvbs02,
                  rvbs021 LIKE rvbs_file.rvbs021,
                  ima02a  LIKE ima_file.ima02,
                  ima021a LIKE ima_file.ima021,
                  rvbs022 LIKE rvbs_file.rvbs022,
                  rvbs04  LIKE rvbs_file.rvbs04,
                  rvbs03  LIKE rvbs_file.rvbs03,
                  rvbs05  LIKE rvbs_file.rvbs05,
                  rvbs06  LIKE rvbs_file.rvbs06,
                  rvbs07  LIKE rvbs_file.rvbs07,
                  rvbs08  LIKE rvbs_file.rvbs08,
                  rvbs13  LIKE rvbs_file.rvbs13
                END RECORD
DEFINE g_rec_b3           LIKE type_file.num5,   #單身二筆數 ##FUN-B30170
       l_ac3              LIKE type_file.num5    #目前處理的ARRAY CNT  #FUN-B30170
#FUN-B30170 add -end---------------------------
DEFINE g_flag2              LIKE type_file.chr1     #FUN-C80107  add
DEFINE g_tc_gws           RECORD LIKE tc_gws_file.*
  
FUNCTION t600(p_argv0,p_argv1,p_argv2)
   DEFINE p_argv0    LIKE type_file.chr1     #FUN-680137 VARCHAR(1)   
                                             #1.出貨通知單      2.出貨單
                                             #4.三角貿易出貨單  5.三角貿易通知單
                                             #6.代採買三角貿易
   DEFINE p_argv1    LIKE oga_file.oga16     #FUN-680137 VARCHAR(16) #單號  #FUN-560060
   DEFINE p_argv2    STRING                  #FUN-4A0081 指定執行的功能
   DEFINE l_t1       LIKE oay_file.oayslip   #FUN-970017 add

   WHENEVER ERROR CONTINUE   #CHI-9A0052


#TQC-AC0101 --------STA
   CALL cl_set_act_visible("style_detail",FALSE)
#TQC-AC0101 --------END
   IF p_argv0 = '4' OR p_argv0='5' THEN
      CALL cl_set_comp_visible("oga914",FALSE)
   END IF
#FUN-AB0039 --Begin--
  #IF p_argv0 = '2' THEN                     #FUN-AB0096
   IF p_argv0 = '2' AND g_azw.azw04='2' THEN #FUN-AB0096
      CALL cl_set_act_visible("detail_tax,trans_tax",TRUE)
   ELSE
      CALL cl_set_act_visible("detail_tax,trans_tax",FALSE)
   END IF
#FUN-AB0039 --End----
    #No.FUN-A90040  begin--  
   IF g_azw.azw04 ='2' AND p_argv0 ='2' THEN 
      CALL cl_set_comp_visible("ogb48,ogb49,oga57",TRUE)     #FUN-AA0057 add oga57
   ELSE
      CALL cl_set_comp_visible("ogb48,ogb49,oga57",FALSE)     #FUN-AA0057 add oga57
   END IF
   #No.FUN-A90040  end-- 
   #CALL cl_set_act_visible("kefa",g_azw.azw04 ='2')     #TQC-AB0253  
   #CALL cl_set_act_visible("kefa",p_argv0 <>'1')     #TQC-AB0251
   CALL cl_set_act_visible("kefa",(p_argv0 <>'1' AND g_azw.azw04 ='2'))  #TQC-AC0191
 # CALL cl_set_comp_visible("ogb48,ogb49",p_argv0 ='2')    #FUN-AB0061 #FUN-AA0057 
   CALL cl_set_comp_visible("grhide",g_azw.azw04='2')                            #No.FUN-870007
   CALL cl_set_comp_visible("ogb44,ogb45,ogb46,ogb47",g_azw.azw04='2')           #No.FUN-870007
   CALL cl_set_comp_visible("oga98",g_aza.aza88 = 'Y')                           #No.FUN-A50071 
   CALL cl_set_act_visible("cancel_price1,modify_rate,pay_money,money_detail",g_azw.azw04='2') #No.FUN-870007
  #CALL cl_set_act_visible("discount_detail",g_prog='axmt620') #FUN-A10110 ADD
  #CALL cl_set_act_visible("discount_detail",p_argv0 ='2')     #FUN-AC0012    #MOD-B30467 MARK
   CALL cl_set_act_visible("discount_detail",p_argv0 ='2' AND g_azw.azw04 = '2') #MOD-B30467 ADD
   #TQC-AC0177-------add----str-----------------------
   CALL cl_set_comp_visible("ogb48,ogb49",FALSE)
   IF g_azw.azw04 ='2' AND p_argv0 ='2' THEN
      CALL cl_set_comp_visible("ogb48,ogb49",TRUE) 
   END IF
   #TQC-AC0177-------add----end----------------------- 
   CALL cl_set_comp_visible("ogb40",g_azw.azw04='2' AND p_argv0 ='2') #FUN-B50054
   LET g_forupd_sql = "SELECT * FROM oga_file WHERE oga01 = ? FOR UPDATE" 
   LET g_forupd_sql = cl_forupd_sql(g_forupd_sql)

   DECLARE t600_cl CURSOR FROM g_forupd_sql
   IF g_bgjob='N' OR cl_null(g_bgjob) THEN  #FUN-840012
      CALL t600_init()
   END IF

   LET l_dbsold = g_plant      #MOD-890080  add
   LET g_check  = 'Y'          #MOD-990097 
   
   IF g_prog='atmt321' THEN    #配送單維護作業
      CALL t321_q2()
      CALL t321_menu2()
   ELSE
     #同原t600()功能
      LET g_argv0=p_argv0
      LET g_argv1=p_argv1
      LET g_argv2=p_argv2

      SELECT * INTO g_sma.* FROM sma_file WHERE sma00='0'

      CALL t600_ui_set()

      LET g_flag = 'N'

      IF fgl_getenv('EASYFLOW') = "1" THEN   #判斷是否為簽核模式
         LET g_argv1 = aws_efapp_wsk(1)      #取得單號
      END IF

     #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
     #FUN-A50029 mod str ---
      CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query, locale, void, confirm, undo_confirm, easyflow_approval, unit_price, address, other_data, modify_wh_loc, modify_shipping_customer, gen_entry_sheet, memo, deduct_inventory, undo_deduct, trsf_to_ar_invo, a_r, release_ov_lmt_credit, entry_sheet,,entry_sheet2, gen_on_check_note,qc_reject_q, mix_order_auto_generate, confirm_t321, undo_confirm_t321,unit_price")  #TQC-750026 modify  #TQC-7B0107 modify   #MOD-940011 #CHI-AC0002 add entry_sheet2 
                                                            #TQC-B40204 add unit_price
     #FUN-A50029 mod end ---
           RETURNING g_laststage

      # 先以g_argv2判斷直接執行哪種功能，執行Q時，g_argv1是出貨單號(oga01)
      # 執行I時，g_argv1是訂單單號(oga16)
      IF NOT cl_null(g_argv1) THEN
         CASE g_argv2
            WHEN "query"
               LET g_action_choice = "query"
               IF cl_chk_act_auth() THEN
                  CALL t600_q()
               END IF
            WHEN "insert"
               LET g_action_choice = "insert"
               IF cl_chk_act_auth() THEN
                  CALL t600_a()
               END IF
           #FUN-970017--add---str---
            WHEN "efconfirm"
               LET g_action_choice = "efconfirm"
               CALL t600_q()
               CALL t600sub_y_chk(g_argv1)                     #CALL 原確認的 check 段
               IF g_success = 'Y' THEN
                   CALL t600sub_y_upd(g_argv1,g_action_choice) #CALL 原確認的 update 段
               END IF
               CALL cl_used(g_prog,g_time,2) RETURNING g_time #No.FUN-B30211
               EXIT PROGRAM
           #FUN-970017--add---end---
            OTHERWISE                  #TQC-660088
               CALL t600_q()        #TQC-660088
               IF g_argv2="M" THEN
                  LET g_bgjob = 'Y'
                  CALL t600sub_y_chk(g_oga.oga01)          #CALL 原確認的 check
                  IF g_success = "Y" THEN
                     CALL t600sub_y_upd(g_oga.oga01,NULL)      #CALL
                  END IF
                  IF g_success = "Y" THEN
                     CALL t600sub_s('2',FALSE,g_oga.oga01,FALSE)
                  END IF
                  CALL cl_used(g_prog,g_time,2) RETURNING g_time #No.FUN-B30211
                  EXIT PROGRAM
               END IF
               IF g_argv2="Z" THEN
                  LET g_success = 'Y'
                  LET g_bgjob = 'Y'
                  CALL t600_z()
                  IF g_success = "Y" THEN
                     CALL t600_w()  
                  END IF
                  CALL cl_used(g_prog,g_time,2) RETURNING g_time #No.FUN-B30211
                  EXIT PROGRAM
               END IF
         END CASE
      END IF

      IF g_argv0 MATCHES '[89]' AND NOT cl_null(g_argv2) THEN
         CALL t600_q()
      END IF

      LET g_action_choice = ""

      #建立簽核模式時的 toolbar icon
      CALL aws_efapp_toolbar()

      IF NOT cl_null(g_argv1) THEN
         CALL t600_q()
      END IF

      CALL t600_menu()

   END IF   #FUN-630102 add

END FUNCTION

FUNCTION t600_cs()
   DEFINE lc_qbe_sn       LIKE    gbm_file.gbm01    #No:FUN-580031  HCN
   DEFINE l_type LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)
   DEFINE l_str_buf              base.StringBuffer

   CLEAR FORM                             #清除畫面
   CALL g_ogb.clear()
   CALL cl_set_head_visible("","YES")       #No.FUN-6A0092
   CALL cl_set_comp_visible("ogb40",g_azw.azw04='2' AND g_argv0 ='2') #FUN-B50054

   IF cl_null(g_argv1) AND cl_null(begin_no) AND NOT (NOT cl_null(g_argv2) AND g_argv0 MATCHES '[89]') THEN  #No.FUN-630061
      INITIALIZE g_oga.* TO NULL      #No.FUN-750051
      CONSTRUCT BY NAME g_wc ON oga00,oga08,oga01,oga69,oga02,oga011,oga16,oga03,oga04,oga18,oga907,oga1002,oga1009,oga1015, #FUN-650009 add oga69   #FUN-920072 add oga907
                                ogauser,ogagrup,ogamodu,ogadate,     #CHI-740014 add
                                ogaoriu,ogaorig,                    #TQC-A30047 ADD
                                oga021,oga27,oga1004,oga1016,oga14,oga15,oga902,oga903,oga99,oga70,oga905,ogaconf,ogaspc,oga30,     #FUN-680010   #No:FUN-740016
                                ogapost,ogamksg,oga55,oga25,oga23,oga24,oga21,
                                oga211,oga212,oga213,oga1011,oga1010,
                                oga1014,oga1012 , #oga914,  #FUN-930104 mark oga914 #FUN-6C0050 新增入庫單號
                                oga83,oga84,oga85,oga86,oga87,ogaplant,oga57,oga88,oga89,oga90,oga91,oga92,  #No.FUN-870007 #FUN-AA0057 add oga57                              
                                oga93,oga98,oga94,oga95,oga96,oga97,ogaconu,ogacond,ogacont,           #FUN-A30063 ADD cont          #No.FUN-870007  #FUN-A50071 add oga98
                                oga65,oga72,oga13,oga05,oga10,oga914,  #,ogauser,ogagrup,ogamodu,ogadate    #CHI-740014 解除remark   #FUN-A60004 add oga72
                                ogaud01,ogaud02,ogaud03,ogaud04,ogaud05,
                                ogaud06,ogaud07,ogaud08,ogaud09,ogaud10,
                                ogaud11,ogaud12,ogaud13,ogaud14,ogaud15


        BEFORE CONSTRUCT
           CALL cl_qbe_init()
        ON ACTION controlp
           CASE
              WHEN INFIELD(oga914)   #入庫單號
                   CALL cl_init_qry_var()
                   LET g_qryparam.state = "c"
                   LET g_qryparam.form ="q_rvu2"
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO oga914
                   NEXT FIELD CURRENT
              WHEN INFIELD(oga01) #查詢單据
                   CALL cl_init_qry_var()
                   LET g_qryparam.form ="q_oga7"
                   LET g_qryparam.state = "c"
                   CASE
                      WHEN g_argv0 = '1' LET g_qryparam.arg1 = '1'
                      WHEN g_argv0 = '2' LET g_qryparam.arg1 = '2'
                      WHEN g_argv0 = '4' LET g_qryparam.arg1 = '4'
                      WHEN g_argv0 = '5' LET g_qryparam.arg1 = '5'
                      WHEN g_argv0 = '6' LET g_qryparam.arg1 = '6'
                      WHEN g_argv0 = '8' LET g_qryparam.arg1 = '8'  #No.FUN-630061
                      WHEN g_argv0 = '9' LET g_qryparam.arg1 = '9'  #No.FUN-630061
                      WHEN g_argv0 = 'A' LET g_qryparam.arg1 = 'A'   #No:FUN-740016
                   END CASE
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO oga01
                   NEXT FIELD oga01
              WHEN INFIELD(oga011)
                   CASE
                      WHEN g_argv0 = '1' LET l_type = '2'
                      WHEN g_argv0 = '2' LET l_type = '1'
                      WHEN g_argv0 = '4' LET l_type = '5'
                      WHEN g_argv0 = '5' LET l_type = '4'
                      WHEN g_argv0 = '6' LET l_type = '5'
                      #WHEN g_argv0 = '8' LET l_type = '7'   #No.FUN-630061   #MOD-AC0132
                      #WHEN g_argv0 = '9' LET l_type = '7'   #No.FUN-630061   #MOD-AC0132
                      WHEN g_argv0 = '8' LET l_type = '2'   #No.FUN-630061   #MOD-AC0132
                      WHEN g_argv0 = '9' LET l_type = '2'   #No.FUN-630061   #MOD-AC0132
                      WHEN g_argv0 = 'A' LET l_type = 'A'   #No:FUN-740016
                   END CASE
                   CALL cl_init_qry_var()
                   LET g_qryparam.form ="q_oga"
                   LET g_qryparam.state = "c"   #MOD-AC0132
                   LET g_qryparam.where = "  (oga09='",l_type,"') "
                   LET g_qryparam.default1 = g_oga.oga011
                   CALL cl_create_qry() RETURNING g_oga.oga011
                   DISPLAY BY NAME g_oga.oga011
                   NEXT FIELD oga011
              WHEN INFIELD(oga27)
                   CALL cl_init_qry_var()
                   LET g_qryparam.form ="q_oga4"
                   LET g_qryparam.state = "c"
                   CASE
                      WHEN g_argv0 = '1' LET g_qryparam.arg1 = '1'
                      WHEN g_argv0 = '2' LET g_qryparam.arg1 = '2'
                      WHEN g_argv0 = '4' LET g_qryparam.arg1 = '4'
                      WHEN g_argv0 = '5' LET g_qryparam.arg1 = '5'
                      WHEN g_argv0 = '6' LET g_qryparam.arg1 = '6'
                      WHEN g_argv0 = '8' LET g_qryparam.arg1 = '8'
                      WHEN g_argv0 = '9' LET g_qryparam.arg1 = '9'
                   END CASE
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO oga27
                   NEXT FIELD oga27
                   WHEN INFIELD(oga83)                                                                                              
                         CALL cl_init_qry_var()                                                                                     
                         LET g_qryparam.state = "c"                                                                                 
                         LET g_qryparam.form ="q_oga83"                                                                             
                         CALL cl_create_qry() RETURNING g_qryparam.multiret                                                         
                         DISPLAY g_qryparam.multiret TO oga83                                                                       
                         NEXT FIELD oga83                                                                                           
                   WHEN INFIELD(oga84)                                                                                              
                         CALL cl_init_qry_var()                                                                                     
                         LET g_qryparam.state = "c"                                                                                 
                         LET g_qryparam.form ="q_oga84"                                                                             
                         CALL cl_create_qry() RETURNING g_qryparam.multiret                                                         
                         DISPLAY g_qryparam.multiret TO oga84                                                                       
                         NEXT FIELD oga84                                                                                           
                   WHEN INFIELD(oga86)                                                                                              
                         CALL cl_init_qry_var()                                                                                     
                         LET g_qryparam.state = "c"                                                                                 
                         LET g_qryparam.form ="q_oga86"     
                         CALL cl_create_qry() RETURNING g_qryparam.multiret                                                         
                         DISPLAY g_qryparam.multiret TO oga86                                                                       
                         NEXT FIELD oga86                                                                                           
                   WHEN INFIELD(ogaconu)                                                                                           
                         CALL cl_init_qry_var()                                                                                     
                         LET g_qryparam.state = "c"                                                                                 
                         LET g_qryparam.form ="q_ogaconu"                                                                          
                         CALL cl_create_qry() RETURNING g_qryparam.multiret                                                         
                         DISPLAY g_qryparam.multiret TO ogaconu                                                                    
                         NEXT FIELD ogaconu               
                  WHEN INFIELD(ogaplant)
                         CALL cl_init_qry_var()
                         LET g_qryparam.state = "c"
                         LET g_qryparam.form ="q_azp"
                         CALL cl_create_qry() RETURNING g_qryparam.multiret
                         DISPLAY g_qryparam.multiret TO ogaplant
                         NEXT FIELD ogaplant                                                                         
              WHEN INFIELD(oga16)
                   IF g_argv0 = "A" THEN
                      CALL cl_init_qry_var()
                      LET g_qryparam.state = "c"
                      LET g_qryparam.form ="q_oea16"   #MOD-8B0108   q_oea14-->q_oea16
                      CALL cl_create_qry() RETURNING g_qryparam.multiret
                   ELSE
                      IF g_argv0='4' OR g_argv0='5' OR g_argv0='6' THEN
                         CALL q_oea(TRUE,TRUE,g_oga.oga16,'','2')
                              RETURNING g_qryparam.multiret  #FUN-4B0032
                      ELSE
                         CALL q_oea(TRUE,TRUE,g_oga.oga16,'','1')
                              RETURNING g_qryparam.multiret  #FUN-4B0032
                      END IF
                   END IF   #No:FUN-740016
                   DISPLAY g_qryparam.multiret TO oga16   #FUN-4B0032
                   NEXT FIELD oga16

              WHEN INFIELD(oga18)
                   CALL cl_init_qry_var()
                   LET g_qryparam.state = "c"
                   LET g_qryparam.form ="q_occ6"    #No.TQC-640123
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO oga18
                   NEXT FIELD oga18

              WHEN INFIELD(oga03)     #No.FUN-610064
                   CALL cl_init_qry_var()
                   LET g_qryparam.state = "c"
                   LET g_qryparam.form ="q_occ3"
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO oga03
                   NEXT FIELD oga03
              WHEN INFIELD(oga04)
                   CALL cl_init_qry_var()
                   LET g_qryparam.state = "c"
                  LET g_qryparam.form ="q_occ"
                     LET g_qryparam.form ="q_occ4"
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO oga04
                   NEXT FIELD oga04
              WHEN INFIELD(oga13)
                   CALL cl_init_qry_var()
                   LET g_qryparam.state = "c"
                   LET g_qryparam.form ="q_ool"
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO oga13
                   NEXT FIELD oga13
              WHEN INFIELD(oga14)
                   CALL cl_init_qry_var()
                   LET g_qryparam.state = "c"
                   LET g_qryparam.form ="q_gen"
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO oga14
                   NEXT FIELD oga14
              WHEN INFIELD(oga15)
                   CALL cl_init_qry_var()
                   LET g_qryparam.state = "c"
                   LET g_qryparam.form ="q_gem"
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO oga15
                   NEXT FIELD oga15
              WHEN INFIELD(oga21)
                   CALL cl_init_qry_var()
                   LET g_qryparam.state = "c"
                   LET g_qryparam.form ="q_gec"
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO oga21
                   NEXT FIELD oga21
              WHEN INFIELD(oga23)
                   CALL cl_init_qry_var()
                   LET g_qryparam.state = "c"
                   LET g_qryparam.form ="q_azi"
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO oga23
                   NEXT FIELD oga23
              WHEN INFIELD(oga25)
                   CALL cl_init_qry_var()
                   LET g_qryparam.state = "c"
                   LET g_qryparam.form ="q_oab"
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO oga25
                   NEXT FIELD oga25
              WHEN INFIELD(oga1002)
                   CALL cl_init_qry_var()
                   LET g_qryparam.state = "c"
                   LET g_qryparam.arg1  = "20"
                   LET g_qryparam.form ="q_tqa1"
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO oga1002
                   NEXT FIELD oga1002
              WHEN INFIELD(oga1009)
                   CALL cl_init_qry_var()
                   LET g_qryparam.state = "c"
                   LET g_qryparam.arg1  = "19"
                   LET g_qryparam.form ="q_tqa1"
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO oga1009
                   NEXT FIELD oga1009
              WHEN INFIELD(oga1016)
                   CALL cl_init_qry_var()
                   LET g_qryparam.state = "c"
                   LET g_qryparam.form ="q_pmc8"
                   LET g_qryparam.default1 = g_oga.oga1016
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO oga1016
                   NEXT FIELD oga1016
              WHEN INFIELD(oga1004)
                   CALL cl_init_qry_var()
                   LET g_qryparam.state = "c"
                   LET g_qryparam.form ="q_occ5"
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO oga1004
                   NEXT FIELD oga1004
              WHEN INFIELD(oga1011)
                   CALL cl_init_qry_var()
                   LET g_qryparam.state = "c"
                   LET g_qryparam.form ="q_occ7"    #No.TQC-640123
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO oga1011
                   NEXT FIELD oga1011
              WHEN INFIELD(oga03)    #No.FUN-610064
                   CALL cl_init_qry_var()
                   LET g_qryparam.state = "c"
                   LET g_qryparam.form ="q_occ5"
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO oga03
                   NEXT FIELD oga03
              WHEN INFIELD(oga1010)
                   CALL cl_init_qry_var()
                   LET g_qryparam.state = "c"
                   LET g_qryparam.form ="q_tqb"
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO oga1010
                   NEXT FIELD oga1010
              WHEN INFIELD(oga1003)
                   CALL cl_init_qry_var()
                   LET g_qryparam.state = "c"
                   LET g_qryparam.form ="q_tqb"
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO oga1003
                   NEXT FIELD oga1003
             #FUN-9B0132 add begin-------------------------------
              WHEN INFIELD(oga902)
                   CALL cl_init_qry_var()
                   LET g_qryparam.state = "c"
                   LET g_qryparam.form ="q_oak1"
                   LET g_qryparam.arg1 = '1'
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO oga902
                   NEXT FIELD oga902
             #FUN-9B0132 add -end--------------------------------
            END CASE

          ON IDLE g_idle_seconds
             CALL cl_on_idle()
             CONTINUE CONSTRUCT

          ON ACTION about         #MOD-4C0121
             CALL cl_about()      #MOD-4C0121

          ON ACTION help          #MOD-4C0121
             CALL cl_show_help()  #MOD-4C0121

          ON ACTION controlg      #MOD-4C0121
             CALL cl_cmdask()     #MOD-4C0121

          ON ACTION qbe_select
             CALL cl_qbe_list() RETURNING lc_qbe_sn
             CALL cl_qbe_display_condition(lc_qbe_sn)

       END CONSTRUCT

       IF INT_FLAG THEN RETURN END IF

       CONSTRUCT g_wc2 ON ogb03,ogb31,ogb32,ogb48,ogb49,ogb04,ogb06,ogb11,ogb1001,ogb40,ogb1012,   #No.FUN-610064  #No.FUN-A90040 #FUN-B50054
                          ogb17,ogb09,ogb091,ogb092,ogb1003,ogb19,ogb05,ogb12,  #No:FUN-5C0075 No.FUN-610064
                          ogb913,ogb914,ogb915,ogb910,ogb911,
                          ogb912,ogb916,ogb917,ogb65,  #No.FUN-630061
                          ogb41,ogb42,ogb43,            #FUN-810045 add
                          ogb1004,ogb1002,ogb37,ogb13,ogb1006,ogb14,ogb14t,ogb930,ogb908    #no.A050 add ogb908 No.FUN-610064 #FUN-670063 #FUN-AB0061
                          ,ogbud01,ogbud02,ogbud03,ogbud04,ogbud05
                          ,ogbud06,ogbud07,ogbud08,ogbud09,ogbud10
                          ,ogbud11,ogbud12,ogbud13,ogbud14,ogbud15
                          ,ogb44,ogb45,ogb46,ogb47           #No.FUN-870007
             FROM s_b1[1].ogb03,s_b1[1].ogb31, s_b1[1].ogb32,s_b1[1].ogb48,s_b1[1].ogb49,  #No.FUN-A90040
                  s_b1[1].ogb04, s_b1[1].ogb06,  s_b1[1].ogb11,s_b1[1].ogb1001,s_b1[1].ogb40,s_b1[1].ogb1012,   #No.FUN-610064 #FUN-B50054
                  s_b1[1].ogb17, s_b1[1].ogb09,  s_b1[1].ogb091,s_b1[1].ogb092,s_b1[1].ogb1003,  #No:MOD-570264  No.FUN-610064
                  s_b1[1].ogb19, s_b1[1].ogb05,  s_b1[1].ogb12, #s_b1[1].ogb08,    #No.FUN-5C0075
                  s_b1[1].ogb913,s_b1[1].ogb914, s_b1[1].ogb915,
                  s_b1[1].ogb910,s_b1[1].ogb911, s_b1[1].ogb912,
                  s_b1[1].ogb916,s_b1[1].ogb917, s_b1[1].ogb65, #No.FUN-630061
                  s_b1[1].ogb41, s_b1[1].ogb42,  s_b1[1].ogb43, #FUN-810045 add
                  s_b1[1].ogb1004,s_b1[1].ogb1002,s_b1[1].ogb37, s_b1[1].ogb13,   #FUN-AB0061
                  s_b1[1].ogb1006,s_b1[1].ogb14,s_b1[1].ogb14t,
                  s_b1[1].ogb930,s_b1[1].ogb908   #no.A050  No.FUN-610064 #FUN-670063
                  ,s_b1[1].ogbud01,s_b1[1].ogbud02,s_b1[1].ogbud03,s_b1[1].ogbud04,s_b1[1].ogbud05
                  ,s_b1[1].ogbud06,s_b1[1].ogbud07,s_b1[1].ogbud08,s_b1[1].ogbud09,s_b1[1].ogbud10
                  ,s_b1[1].ogbud11,s_b1[1].ogbud12,s_b1[1].ogbud13,s_b1[1].ogbud14,s_b1[1].ogbud15
                  ,s_b1[1].ogb44,s_b1[1].ogb45,s_b1[1].ogb46,s_b1[1].ogb47   #No.FUN-870007
                   BEFORE CONSTRUCT
                      CALL cl_qbe_display_condition(lc_qbe_sn)
       ON ACTION controlp
            CASE WHEN INFIELD(ogb31)
                      IF g_argv0='4' OR g_argv0='5' OR g_argv0='6' THEN
                          CALL q_oea(TRUE ,TRUE,g_ogb[1].ogb31,g_oga.oga18,'2')   #No.FUN-610064
                                RETURNING g_qryparam.multiret
                      ELSE
                          CALL q_oea(TRUE ,TRUE,g_ogb[1].ogb31,g_oga.oga18,'1')   #No.FUN-610064
                                RETURNING g_qryparam.multiret
                      END IF
                      DISPLAY g_qryparam.multiret TO ogb31
                      NEXT FIELD ogb31
          #No.FUN-A90040  begin--           
                WHEN INFIELD(ogb48)
                      CALL cl_init_qry_var()
                      LET g_qryparam.form ="q_ogb48"
                      LET g_qryparam.state    = "c"
                      CALL cl_create_qry() RETURNING g_qryparam.multiret
                      DISPLAY g_qryparam.multiret TO ogb48
                      NEXT FIELD ogb48
          #No.FUN-A90040    end--        
                 WHEN INFIELD(ogb04)
#FUN-AA0059---------mod------------str-----------------
#                     CALL cl_init_qry_var()
#                     LET g_qryparam.form ="q_ima"
#                     LET g_qryparam.state    = "c"
#                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                      CALL q_sel_ima(TRUE, "q_ima","","","","","","","",'')  RETURNING  g_qryparam.multiret
#FUN-AA0059---------mod------------end------------------
                      DISPLAY g_qryparam.multiret TO ogb04
                      NEXT FIELD ogb04
                 WHEN INFIELD(ogb908)
                      CALL q_coc2(TRUE,TRUE,g_ogb[1].ogb908,'',g_oga.oga02,'0',
                                  '',g_ogb[1].ogb04)
                      RETURNING g_ogb[1].ogb908
                       DISPLAY BY NAME g_ogb[1].ogb908         #No:MOD-490371
                      NEXT FIELD ogb908
                   WHEN INFIELD(ogb09)  #MOD-480604
                       #No.FUN-AA0048  --Begin
                       #CALL cl_init_qry_var()
                       #LET g_qryparam.form     = "q_imd"
                       #LET g_qryparam.state    = "c"
                       #LET g_qryparam.arg1     = 'SW'        #倉庫類別 #MOD-4A0213
                       #CALL cl_create_qry() RETURNING g_qryparam.multiret
                       CALL q_imd_1(TRUE,TRUE,"","","","","") RETURNING g_qryparam.multiret
                       DISPLAY g_qryparam.multiret TO ogb09
                       NEXT FIELD ogb09
                       #No.FUN-AA0048  --End  

              WHEN INFIELD(ogb913)
                 CALL cl_init_qry_var()
                 LET g_qryparam.state = "c"
                 LET g_qryparam.form ="q_gfe"
                 CALL cl_create_qry() RETURNING g_qryparam.multiret
                 DISPLAY g_qryparam.multiret TO ogb913
                 NEXT FIELD ogb913

                WHEN INFIELD(ogb41)  #專案代號
                  CALL cl_init_qry_var()
                  LET g_qryparam.form ="q_pja2"
                  LET g_qryparam.state = "c"   #多選
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO ogb41
                  NEXT FIELD ogb41
                WHEN INFIELD(ogb42)  #WBS
                  CALL cl_init_qry_var()
                  LET g_qryparam.form ="q_pjb4"
                  LET g_qryparam.state = "c"   #多選
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO ogb42
                  NEXT FIELD ogb42
                WHEN INFIELD(ogb43)  #活動
                  CALL cl_init_qry_var()
                  LET g_qryparam.form ="q_pjk3"
                  LET g_qryparam.state = "c"   #多選
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO ogb43
                  NEXT FIELD ogb43
                WHEN INFIELD(ogb1004)
                   CALL cl_init_qry_var()
                   LET g_qryparam.state = "c"
                   LET g_qryparam.form ="q_tqx1"
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO ogb1004
                   NEXT FIELD ogb1004
               #FUN-B50054 Begin---
                WHEN INFIELD(ogb40)
                   CALL cl_init_qry_var()
                   LET g_qryparam.state = "c"
                   LET g_qryparam.form ="q_ogb40"
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO ogb40
                   NEXT FIELD ogb40
               #FUN-B50054 End-----
              WHEN INFIELD(ogb1001)
                 CALL cl_init_qry_var()
                 LET g_qryparam.state = "c"
                 LET g_qryparam.default1 = g_ogb[1].ogb1001     #No.TQC-7C0055     #MOD-830036 
                 IF g_aza.aza50 = 'Y' THEN
                    LET g_qryparam.form ="q_azf03"  
                    LET g_qryparam.arg1 ="2"   
                    LET g_qryparam.arg2 ="1"    
                 ELSE
                    LET g_qryparam.form ="q_azf03"  #No.FUN-930104
                    LET g_qryparam.arg1 ="2"        #No.FUN-930104
                    LET g_qryparam.arg2 ="1"        #No.FUN-930104 
                 END IF
                 CALL cl_create_qry() RETURNING g_qryparam.multiret
                 DISPLAY g_qryparam.multiret TO ogb1001
                 NEXT FIELD ogb1001
              WHEN INFIELD(ogb910)
                 CALL cl_init_qry_var()
                 LET g_qryparam.state = "c"
                 LET g_qryparam.form ="q_gfe"
                 CALL cl_create_qry() RETURNING g_qryparam.multiret
                 DISPLAY g_qryparam.multiret TO ogb910
                 NEXT FIELD ogb910

              WHEN INFIELD(ogb916)
                 CALL cl_init_qry_var()
                 LET g_qryparam.state = "c"
                 LET g_qryparam.form ="q_gfe"
                 CALL cl_create_qry() RETURNING g_qryparam.multiret
                 DISPLAY g_qryparam.multiret TO ogb916
                 NEXT FIELD ogb916

              WHEN INFIELD(ogb65)
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_azf03"  #No.FUN-930104
                 LET g_qryparam.state = "c"
                 LET g_qryparam.arg1 = "2"
                 LET g_qryparam.arg2 = "5"       #No.FUN-930104                 
                 DISPLAY g_qryparam.multiret TO ogb65
                 NEXT FIELD ogb65
              WHEN INFIELD(ogb930)
                 CALL cl_init_qry_var()
                 LET g_qryparam.form  = "q_gem4"
                 LET g_qryparam.state = "c"   #多選
                 CALL cl_create_qry() RETURNING g_qryparam.multiret
                 DISPLAY g_qryparam.multiret TO ogb930
                 NEXT FIELD ogb930
          END CASE

          ON IDLE g_idle_seconds
             CALL cl_on_idle()
             CONTINUE CONSTRUCT

          ON ACTION about         #MOD-4C0121
             CALL cl_about()      #MOD-4C0121

          ON ACTION help          #MOD-4C0121
             CALL cl_show_help()  #MOD-4C0121

          ON ACTION controlg      #MOD-4C0121
             CALL cl_cmdask()     #MOD-4C0121


          ON ACTION qbe_save
             CALL cl_qbe_save()

       END CONSTRUCT
       CONSTRUCT g_wc3 ON b2_03,b2_31,b2_32,b2_1007,b2_1008,b2_1009,b2_1010,b2_1011,b2_1001,
                          b2_14,b2_14t
             FROM s_b2[1].b2_03,s_b2[1].b2_31, s_b2[1].b2_32,
                  s_b2[1].b2_1007,  s_b2[1].b2_1008,s_b2[1].b2_1009,s_b2[1].b2_1010,s_b2[1].b2_1011,s_b2[1].b2_1001,
                  s_b2[1].b2_14,s_b2[1].b2_14t
                BEFORE CONSTRUCT
                   CALL cl_qbe_display_condition(lc_qbe_sn)
        ON ACTION controlp
            CASE WHEN INFIELD(b2_31)
                      IF g_argv0='4' OR g_argv0='5' OR g_argv0='6' THEN
                          CALL q_oea(TRUE ,TRUE,g_b2[1].ogb31,g_oga.oga18,'2')   #No.FUN-610064
                                RETURNING g_qryparam.multiret
                      ELSE
                          CALL q_oea(TRUE ,TRUE,g_b2[1].ogb31,g_oga.oga18,'1')   #No.FUN-610064
                                RETURNING g_qryparam.multiret
                      END IF
                      DISPLAY g_qryparam.multiret TO b2_31
                      NEXT FIELD b2_31
              WHEN INFIELD(b2_1001)
                 CALL cl_init_qry_var()
                 LET g_qryparam.state = "c"
                 LET g_qryparam.default1=g_b2[l_ac].ogb1001 #No.TQC-7C0055
                 LET g_qryparam.form ="q_azf02"   #No.TQC-7C0055
                 LET g_qryparam.arg1 ="2"   #No:MOD-740375
                 LET g_qryparam.arg2 ="3"   #No.TQC-7C0055
                 CALL cl_create_qry() RETURNING g_qryparam.multiret
                 DISPLAY g_qryparam.multiret TO b2_1001
                 NEXT FIELD b2_1001
                WHEN INFIELD(b2_1007)
                   CALL cl_init_qry_var()
                   LET g_qryparam.state = "c"
                   LET g_qryparam.form ="q_tqw"
                   CALL cl_create_qry() RETURNING g_qryparam.multiret
                   DISPLAY g_qryparam.multiret TO b2_1007
                   NEXT FIELD b2_1007
#end

             END CASE

          ON IDLE g_idle_seconds
             CALL cl_on_idle()
             CONTINUE CONSTRUCT

          ON ACTION about         #MOD-4C0121
             CALL cl_about()      #MOD-4C0121

          ON ACTION help          #MOD-4C0121
             CALL cl_show_help()  #MOD-4C0121

          ON ACTION controlg      #MOD-4C0121
             CALL cl_cmdask()     #MOD-4C0121

          ON ACTION qbe_save
             CALL cl_qbe_save()

       END CONSTRUCT

       IF INT_FLAG THEN RETURN END IF
       LET l_str_buf = base.StringBuffer.create()
       CALL l_str_buf.append(g_wc3)
       CALL l_str_buf.replace("b2_","ogb",0)
       LET g_wc3 =l_str_buf.toString()


   ELSE
      IF begin_no IS NULL THEN
         LET g_wc =" oga01 = '",g_argv1,"'"    #No:FUN-4A0081 #TQC-AB0329 mark #MOD-B10020 remark
       #MOD-B10020 mark --start--
       ##TQC-AB0329   ---begin---
       # IF NOT cl_null(g_oga.oga01) THEN
       #    LET g_wc =" oga01 = '",g_oga.oga01,"'"
       # END IF
       ##TQC-AB0329   ---end---
       #MOD-B10020 mark --end--
      ELSE
         LET g_wc =" oga01 BETWEEN '",begin_no,"' AND '",end_no,"'"
      END IF
      #IF g_argv0 MATCHES '[89]' AND NOT cl_null(g_argv2) THEN   #MOD-A90170
      IF g_argv0 MATCHES '[89]' AND NOT cl_null(g_argv2) AND g_argv2 <> 'efconfirm' THEN   #MOD-A90170
         LET g_wc = g_argv2                                     #TQC-A40082    #MOD-A90170 取消mark
         #LET g_wc =g_wc CLIPPED," AND oga09 = '",g_argv0,"'"    #TQC-A40082    #MOD-A90170 mark
      END IF
      LET g_wc2=" 1=1"
      LET g_wc3=" 1=1"     #No.TQC-640123
   END IF

   #資料權限的檢查
   LET g_wc = g_wc CLIPPED,cl_get_extra_cond('ogauser', 'ogagrup')

   IF NOT cl_null(g_argv0) THEN
      LET g_wc = g_wc clipped," AND oga09 = '",g_argv0,"'"
   END IF

   IF g_wc2 = " 1=1" AND g_wc3 = " 1=1" THEN                    # 若單身未輸入條件   FUN-670008
      LET g_sql = "SELECT oga01  FROM oga_file",        #MOD-840653   #No.TQC-9A0161
                  " WHERE ", g_wc CLIPPED,
                  "   AND ogaplant IN ",g_auth CLIPPED         #No:FUN-870007

   ELSE                                 # 若單身有輸入條件
      LET g_sql = "SELECT DISTINCT oga01 ",                #MOD-840653    #No.TQC-9A0161
                  "  FROM oga_file, ogb_file",
                  " WHERE oga01 = ogb01",
                  "   AND ogaplant IN ",g_auth CLIPPED,     #No:FUN-870007  
                  "   AND ogaplant = ogbplant ",            #No:FUN-870007
                  "   AND ", g_wc CLIPPED, " AND ",g_wc2 CLIPPED
   END IF

   IF g_wc3 != " 1=1" THEN                      # 若單身未輸入條件
      LET g_sql = g_sql,"  AND ",g_wc3 CLIPPED
   END IF
   LET g_sql =g_sql,"  ORDER BY oga01"

   PREPARE t600_prepare FROM g_sql
   DECLARE t600_cs                         #SCROLL CURSOR
       SCROLL CURSOR WITH HOLD FOR t600_prepare

   IF g_wc2 = " 1=1" AND g_wc3 = " 1=1" THEN                    # 取合乎條件筆數   No.FUN-670008
       LET g_sql="SELECT COUNT(*) FROM oga_file WHERE ",g_wc CLIPPED,
                 " AND ogaplant IN ",g_auth CLIPPED  #No.FUN-870007
   ELSE
       LET g_sql="SELECT COUNT(DISTINCT oga01) FROM oga_file,ogb_file WHERE ",
                 "ogb01=oga01 AND ",g_wc CLIPPED," AND ",g_wc2 CLIPPED,
                 " AND ogaplant IN ",g_auth CLIPPED,    #No:FUN-870007 
                 " AND ogaplant = ogbplant "            #No:FUN-870007
   END IF
   IF g_wc3 != " 1=1" THEN                      # 取合乎條件筆數
       LET g_sql =g_sql," AND ",g_wc3 CLIPPED
   END IF

   PREPARE t600_precount FROM g_sql
   DECLARE t600_count CURSOR FOR t600_precount

END FUNCTION

#中文的MENU
FUNCTION t600_menu()
   DEFINE l_creator   LIKE type_file.chr1    #No.FUN-680137  VARCHAR(1)    #「不准」時是否退回填表人 #FUN-580113
   DEFINE l_flowuser  LIKE type_file.chr1    #No.FUN-680137  VARCHAR(1)    # 是否有指定加簽人員      #FUN-580113
   DEFINE l_oga01     LIKE oga_file.oga01    #MOD-940011
   DEFINE l_str       STRING                 #MOD-940011
   DEFINE l_cnt       LIKE type_file.num5      #MOD-AB0246  add
DEFINE l_price1 LIKE ogb_file.ogb14t  #No.FUN-870007
   DEFINE l_cmd       STRING
   DEFINE l_status     LIKE type_file.num10  #GPM傳回值
   DEFINE l_tc_log    RECORD LIKE tc_log_file.*
   DEFINE l_len       LIKE type_file.num5
   
   LET l_flowuser = "N"   #FUN-580113

   WHILE TRUE
      LET g_chr='@'
      CASE g_b_flag
         WHEN '1'
          CALL t600_bp1("G")
         WHEN '2'
          CALL t600_bp2("G")
         OTHERWISE
          CALL t600_bp1("G")
      END CASE
      CASE g_action_choice
         WHEN "shipment"
            IF cl_chk_act_auth() THEN
               CALL t600_b1()
            END IF

         WHEN "return"
            IF cl_chk_act_auth() THEN
               CALL t600_b2()
            END IF

         WHEN "insert"
            IF cl_chk_act_auth() THEN
               CALL t600_a()
            END IF

         WHEN "query"
            IF cl_chk_act_auth() THEN
               CALL t600_q()
            END IF

         WHEN "modify"
            IF cl_chk_act_auth() THEN
               CALL t600_u()
            END IF

         WHEN "delete"
            IF cl_chk_act_auth() THEN
                IF t600_r() THEN
                   CALL t600_after_delete()
                END IF
            END IF

         WHEN "detail"
            IF cl_chk_act_auth() THEN
               IF g_b_flag IS NULL OR g_b_flag ='1' THEN
                CALL t600_b1()
               ELSE
                CALL t600_b2()
               END IF

                IF g_oga.oga09 ='2' AND g_oga.oga07 = 'Y' THEN 
                  #CHI-AC0002 mod --start--
                  #CALL s_t600_gl(g_oga.oga01)
                   CALL s_t600_gl(g_oga.oga01,'0')
                   IF g_aza.aza63 = 'Y' THEN
                      CALL s_t600_gl(g_oga.oga01,'1')
                   END IF
                  #CHI-AC0002 mod --end-- 
                END IF
            ELSE
               LET g_action_choice = NULL
            END IF

         WHEN "output"
            IF cl_chk_act_auth() THEN
               CALL t600_out()
            END IF
         #No.FUN-A10106--begin
         WHEN "kefa"
            IF cl_null(g_oga.oga01) THEN
               CALL cl_err('','-400',1)
            ELSE
#FUN-B30012 -------------------STA
#              CALL s_gifts('02',g_oga.oga01,g_oga.ogaplant,g_oga.oga02,g_oga.oga87)
               IF t600_chk_ogb1001_3(g_oga.oga01) THEN
                  CALL s_gifts('02',g_oga.oga01,g_oga.ogaplant,g_oga.oga02,g_oga.oga87)
                  CALL t600_b1_fill(' 1=1')
                  IF g_aza.aza50='Y' THEN
                     CALL t600_oga50_sum()
                  ELSE
                     CALL t600_bu()
                  END IF
               ELSE
                  CALL cl_err('','axm-885',0)
               END IF
#FUN-B30012 -------------------END
            END IF      
         #No.FUN-A10106--end
         WHEN "unit_price"
            IF cl_chk_act_auth() THEN
               CALL t600_d()
               CALL t600_b1_fill(" 1=1")  #TQC-AB0242
            END IF

         WHEN "address"
            IF cl_chk_act_auth() THEN
#TQC-B40204 --begin--            
              IF g_oga.oga55 = 'S' THEN 
                 CALL cl_err('','apm-228',0)
              ELSE  
#TQC-B40204 --end--              	
                 CALL t600_1()
                 CALL t600_show() #MOD-640570 add
              END IF     #TQC-B40204
            END IF

         WHEN "other_data"
            IF cl_chk_act_auth() THEN
#TQC-B40204 --begin--            
              IF g_oga.oga55 = 'S' THEN 
                 CALL cl_err('','apm-228',0)
              ELSE  
#TQC-B40204 --end--             
                 CALL t600_2()
              END IF       #TQC-B40204    
            END IF

         WHEN "modify_wh_loc"
            IF cl_chk_act_auth() THEN
               CALL t600_3()
            END IF

         WHEN "modify_shipping_customer"
            IF cl_chk_act_auth() THEN
               CALL t600_4()
            END IF

         WHEN "discount_detail"                          #FUN-A10110 ADD
            IF cl_chk_act_auth()  THEN
               LET g_msg="artq800 '02' '",g_oga.oga01,"' "
               CALL cl_cmdrun(g_msg)
            END IF

         WHEN "entry_sheet"
           IF cl_chk_act_auth() THEN
#TQC-B40204 --begin--
            IF g_oga.oga55 = 'S' THEN 
               CALL cl_err('','apm-228',0)
            ELSE    
#TQC-B40204 --end--            
              #CALL t600_fsgl()    #CHI-AC0002 mark
               CALL t600_fsgl('0') #CHI-AC0002
            END IF   #TQC-B40204    
           END IF

         #CHI-AC0002 add --start--
         WHEN "entry_sheet2"
            IF cl_chk_act_auth() THEN
#TQC-B40204 --begin--
            IF g_oga.oga55 = 'S' THEN 
               CALL cl_err('','apm-228',0)
            ELSE    
#TQC-B40204 --end--            
               CALL t600_fsgl('1')
            END IF    #TQC-B40204    
            END IF
         #CHI-AC0002 add --end--

         WHEN "gen_entry_sheet"
#TQC-B40204 --begin--
            IF g_oga.oga55 = 'S' THEN 
               CALL cl_err('','apm-228',0)
            ELSE    
#TQC-B40204 --end--         
               CALL t600_v()
            END IF    #TQC-B40204    

         WHEN "query_delivery"
            CALL s_shpqry(g_oga.oga01)

         WHEN "order_query"
            CALL s_ordqry(g_oga.oga16)

         WHEN "query_customer"
            CALL s_cusqry(g_oga.oga03)  #No.FUN-610064 TQC-640123

         WHEN "memo"
            IF cl_chk_act_auth() THEN
#TQC-B40204 --begin--            
              IF g_oga.oga55 = 'S' THEN 
                 CALL cl_err('','apm-228',0)
              ELSE  
#TQC-B40204 --end--             
                 CALL t600_m()
              END IF         #TQC-B40204    
            END IF

         WHEN "confirm"
            IF cl_chk_act_auth() THEN
               CALL t600sub_y_chk(g_oga.oga01)          #CALL 原確認的 check 段 #FUN-740034
               IF g_success = "Y" THEN
                  CALL t600sub_y_upd(g_oga.oga01,g_action_choice)      #CALL 原確認的 update 段 #FUN-740034
                  CALL t600sub_refresh(g_oga.oga01) RETURNING g_oga.*  #FUN-730012 重新讀取g_oga
                 #出货通知单审核成功后抛转给WMS
                  IF g_success = 'Y' AND g_argv0 MATCHES '[15]' THEN 
                     SELECT * INTO g_tc_gws.* FROM tc_gws_file WHERE tc_gws00 = '0'
                     IF g_tc_gws.tc_gws01 = 'Y' THEN 
                        LET l_cmd = "aws_erptrans 'wms' 'axmt610' '"||g_oga.oga01||"' "
                        CALL cl_cmdrun_wait(l_cmd)
                        SELECT tc_log00 ,tc_log051,tc_log052
                          INTO l_tc_log.tc_log00,l_tc_log.tc_log051,l_tc_log.tc_log052
                          FROM tc_log_file 
                         WHERE tc_log01 = 'WMS'
                           AND tc_log031 = g_oga.oga01
                           AND tc_log07 = 'axmt610'
                           AND tc_logdate = g_today
                           ORDER BY tc_log00 DESC 
                        LET l_str = l_tc_log.tc_log052
                        LET l_len = l_str.getIndexOf("<Status code='",1)
                        IF l_len > 0 THEN 
                        	 LET l_status = l_str.getCharAt(l_len+14)
                        END IF 
                        IF l_status != 0 OR l_tc_log.tc_log051 != '0' THEN 
                           CALL cl_err('','cws-007',1)
                           CALL cl_err(l_tc_log.tc_log052,'!',1)                        	 
                        ELSE 
                           CALL cl_err('','cws-006',1)
                        END IF 
                     END IF 
                  END IF 
                 #流程自動化產生下游單據
                  IF g_success = "Y" AND g_prog = 'axmt610' THEN
                    CALL s_auto_gen_doc('axmt610',g_oga.oga01,'')
                  END IF
               END IF
               CALL t600_show()
            END IF

         WHEN "undo_confirm"
            IF cl_chk_act_auth() THEN
               CALL t600_w()
               CALL t600sub_refresh(g_oga.oga01) RETURNING g_oga.*  #MOD-920270
               CALL t600_show()   #MOD-920270
            END IF

         WHEN "cancel_price1"   #取消折价
            IF cl_chk_act_auth() THEN
               CALL t600_cancel_price()
            END IF

         WHEN "modify_rate"
            IF cl_chk_act_auth() THEN  
               CALL t600_m2()
               CALL t600_show()               
            END IF  

         WHEN "deduct_inventory"
            IF cl_chk_act_auth() THEN
               CALL t600sub_s('2',FALSE,g_oga.oga01,TRUE)
               CALL t600sub_refresh(g_oga.oga01) RETURNING g_oga.*  #FUN-730012 重新讀取g_oga
              #MOD-AB0246---add---start---
               IF g_success = 'Y' THEN
                  IF g_oga.oga02 != g_oga_t.oga02 THEN
                     LET l_cnt = 0
                     SELECT COUNT(*) INTO l_cnt FROM npp_file
                      WHERE nppsys = 'AR'
                        AND npp00 = 1
                        AND npp01 = g_oga.oga01
                        AND npp011 = 1
                     IF l_cnt > 0 THEN
                        UPDATE npp_file set npp02=g_oga.oga02
                         WHERE nppsys = 'AR'
                           AND npp00 = 1
                           AND npp01 = g_oga.oga01
                           AND npp011 = 1
                     END IF
                  END IF
               END IF
              #MOD-AB0246---add---end---
               CALL t600_show() #FUN-730012
            END IF

         WHEN "undo_deduct"
            IF cl_chk_act_auth() THEN
               LET l_dbsnew = g_plant
               IF l_dbsnew = l_dbsold THEN
               CALL t600_z()   #CHI-8B0048 modify 'z' #MOD-B30464 取消z 
               CALL t600sub_refresh(g_oga.oga01) RETURNING g_oga.*  #FUN-930038 重新讀取g_oga
               CALL t600_show() #FUN-930038
               ELSE
                  CALL cl_err(l_dbsnew,'mfg9143',1)
               END IF
            END IF

         WHEN "trsf_to_ar_invo"
            IF cl_chk_act_auth() THEN
               CALL t600sub_gui(g_oga.*)
               SELECT oga10 INTO g_oga.oga10 FROM oga_file WHERE oga01=g_oga.oga01
            END IF

        WHEN "qry_serialno"
           IF cl_chk_act_auth() THEN
             #IF NOT cl_null(g_oga.oga01) THEN  #MOD-AB0061
             IF NOT cl_null(g_oga.oga01) AND l_ac > 0 THEN  #MOD-AB0061
               IF (g_ogb[l_ac].ogb04!=' ' OR g_ogb[l_ac].ogb04 IS NOT NULL) THEN
                     CALL t601_5(g_oga.oga01,NULL)
               END IF
             END IF
           END IF

         WHEN "a_r"
            IF NOT cl_null(g_oga.oga10) THEN
               SELECT oma00 INTO l_oma00 FROM oma_file
                WHERE oma01=g_oga.oga10
               IF cl_null(l_oma00) THEN
                  LET l_oma00='12'
               END IF
               LET g_msg="axrt300 '",g_oga.oga10,"' '' '",l_oma00,"'" #No:TQC-630066  

               CALL cl_cmdrun_wait(g_msg)  #FUN-660216 add
               SELECT * INTO g_oga.* FROM oga_file
                WHERE oga01=g_oga.oga01
               DISPLAY BY NAME g_oga.oga10

               SELECT oma10 INTO g_buf FROM oma_file
                WHERE oma01=g_oga.oga10
               DISPLAY g_buf TO oma10 LET g_buf = NULL
            END IF

         WHEN "release_ov_lmt_credit"
            IF cl_chk_act_auth() THEN
               CALL t600_c()
            END IF

         WHEN "void"
            IF cl_chk_act_auth() THEN
               CALL t600_x()
            END IF

         WHEN "gen_on_check_note"
            IF cl_chk_act_auth() THEN
#TQC-B40204 --begin--
               IF g_oga.oga55 = 'S' THEN 
                  CALL cl_err('','apm-228',0)
               ELSE    
#TQC-B40204 --end--            
                  CALL t600_gen_check_note()
               END IF    #TQC-B40204    
            END IF

         WHEN "qry_on_check_note"
            IF cl_chk_act_auth() THEN
               CALL t600_qry_on_check_note()
            END IF

         WHEN "qry_mntn_inv_detail"
            IF cl_chk_act_auth() THEN
                LET l_ac = ARR_CURR()
                IF l_ac != 0 THEN
                    IF g_ogb[l_ac].ogb17 = 'Y' THEN
                        LET g_success = 'Y'              #CHI-A10016
                        BEGIN WORK                       #CHI-A10016
                        IF g_sma.sma115 = 'Y' THEN
                            CALL t600_b_ogg_1()
                        ELSE
                            IF g_oaz.oaz23 = 'Y' THEN
                               CALL t600_b_ogd_1()
                            ELSE
                                CALL t600_b_ogc_1()
                            END IF
                        END IF
                        IF g_success = "Y" THEN
                           COMMIT WORK
                        ELSE
                           ROLLBACK WORK    
                        END IF
                    END IF
                END IF
            END IF
         WHEN "pay_money"                                                                                                           
            IF cl_chk_act_auth() THEN
               CALL pay_chk()
               CALL l_price() RETURNING l_price1                                                                                   
               CALL s_pay('02',g_oga.oga01,g_oga.ogaplant,l_price1,g_oga.ogaconf)
            END IF 
         WHEN "money_detail"                                                                                                        
           #IF cl_chk_act_auth() THEN     #MOD-B30453 mark                                                                                           
                 CALL s_pay_detail('02',g_oga.oga01,g_oga.ogaplant,g_oga.ogaconf)                                                     
           #END IF    #MOD-B30453 mark

         WHEN "help"
            CALL cl_show_help()

         WHEN "exit"
            EXIT WHILE

         WHEN "controlg"
            CALL cl_cmdask()

         WHEN "exporttoexcel"     #FUN-4B0038
            IF cl_chk_act_auth() THEN
              CALL cl_export_to_excel(ui.Interface.getRootNode(),base.TypeInfo.create(g_ogb),'','')
            END IF

         WHEN "mix_order_auto_generate"
            IF cl_chk_act_auth() THEN
               CALL mix_order_b()
               CALL t600_b1_fill(' 1=1')
               CALL t600_b2_fill(' 1=1')
            END IF

         #@WHEN "簽核狀況"
         WHEN "approval_status"
            IF cl_chk_act_auth() THEN        #DISPLAY ONLY
               IF aws_condition2() THEN                #FUN-550050
                  CALL aws_efstat2()                  #MOD-560007
               END IF
            END IF

         WHEN "easyflow_approval"     #FUN-550050
            IF cl_chk_act_auth() THEN
               CALL t600_ef()
            END IF

         #@WHEN "准"
         WHEN "agree"
            IF g_laststage = "Y" AND l_flowuser = "N" THEN  #最後一關並且沒有加簽人員
               CALL t600sub_y_upd(g_oga.oga01,g_action_choice)      #CALL 原確認的 update 段 #FUN-740034
               CALL t600sub_refresh(g_oga.oga01) RETURNING g_oga.*  #FUN-730012 重新讀取g_oga
               CALL t600_show()
            ELSE
               LET g_success = "Y"
               IF NOT aws_efapp_formapproval() THEN
                  LET g_success = "N"
               END IF
            END IF
            IF g_success = 'Y' THEN
               IF cl_confirm('aws-081') THEN
                  IF aws_efapp_getnextforminfo() THEN
                     LET l_flowuser = 'N'
                     LET g_argv1 = aws_efapp_wsk(1)   #參數:key-1
                     IF NOT cl_null(g_argv1) THEN
                        CALL t600_q()
                        #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
                        #FUN-A50029 mod str ---
                        CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query, locale, void, confirm, undo_confirm, easyflow_approval, unit_price, address, other_data, modify_wh_loc, modify_shipping_customer, gen_entry_sheet, memo, deduct_inventory, undo_deduct, trsf_to_ar_invo, a_r, release_ov_lmt_credit, entry_sheet,entry_sheet2, gen_on_check_note,qc_reject_q,unit_price")  #TQC-750026 modify  #TQC-7B0107 modify   #MOD-940011 #CHI-AC0002 add entry_sheet2
                                              #TQC-B40204 add unit_price
                        #FUN-A50029 mod end ---
                             RETURNING g_laststage
                     ELSE
                        EXIT WHILE
                     END IF
                  ELSE
                     EXIT WHILE
                  END IF
               ELSE
                  EXIT WHILE
               END IF
            END IF

         #@WHEN "不准"
         WHEN "deny"
            IF (l_creator := aws_efapp_backflow()) IS NOT NULL THEN
              IF aws_efapp_formapproval() THEN
                 IF l_creator = "Y" THEN
                    LET g_oga.oga55 = 'R'
                    DISPLAY BY NAME g_oga.oga55
                 END IF
                 IF cl_confirm('aws-081') THEN
                    IF aws_efapp_getnextforminfo() THEN
                       LET l_flowuser = 'N'
                       LET g_argv1 = aws_efapp_wsk(1)   #參數:key-1
                       IF NOT cl_null(g_argv1) THEN
                          CALL t600_q()
                          #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
                         #FUN-A50029 mod str ---
                          CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query, locale, void, confirm, undo_confirm, easyflow_approval, unit_price, address, other_data, modify_wh_loc, modify_shipping_customer, gen_entry_sheet, memo, deduct_inventory, undo_deduct, trsf_to_ar_invo, a_r, release_ov_lmt_credit, entry_sheet,entry_sheet2, gen_on_check_note,qc_reject_q,unit_price")  #TQC-750026 modify  #TQC-7B0107 modify   #MOD-940011 #CHI-AC0002 add entry_sheet2
                                            #TQC-B40204 add unit_price
                         #FUN-A50029 mod end ---
                               RETURNING g_laststage

                       ELSE
                          EXIT WHILE
                       END IF
                    ELSE
                       EXIT WHILE
                    END IF
                 ELSE
                    EXIT WHILE
                 END IF
              END IF
            END IF

         #@WHEN "加簽"
         WHEN "modify_flow"
            IF aws_efapp_flowuser() THEN   #選擇欲加簽人員
               LET l_flowuser = 'Y'
            ELSE
               LET l_flowuser = 'N'
            END IF

         #@WHEN "撤簽"
         WHEN "withdraw"
            IF cl_confirm("aws-080") THEN
               IF aws_efapp_formapproval() THEN
                  EXIT WHILE
               END IF
            END IF

         #@WHEN "抽單"
         WHEN "org_withdraw"
            IF cl_confirm("aws-079") THEN
               IF aws_efapp_formapproval() THEN
                  EXIT WHILE
               END IF
            END IF

         #@WHEN "簽核意見"
         WHEN "phrase"
            CALL aws_efapp_phrase()
         WHEN "performance_status"
            IF cl_chk_act_auth() THEN
               CALL t600_perf()
            END IF
# end
         WHEN "trans_spc"
            IF cl_chk_act_auth() THEN
               CALL t600_spc()
            END IF

         WHEN "related_document"  #相關文件
              IF cl_chk_act_auth() THEN
                 IF g_oga.oga01 IS NOT NULL THEN
                 LET g_doc.column1 = "oga01"
                 LET g_doc.value1 = g_oga.oga01
                 CALL cl_doc()
               END IF
         END IF
        WHEN "qry_lot"
          IF l_ac > 0 THEN    #MOD-960349
           LET g_ima918 = ''   #MOD-9C0055
           LET g_ima921 = ''   #MOD-9C0055
           SELECT ima918,ima921 INTO g_ima918,g_ima921 
             FROM ima_file
            WHERE ima01 = g_ogb[l_ac].ogb04
              AND imaacti = "Y"
           
           IF g_ima918 = "Y" OR g_ima921 = "Y" THEN
              #非多倉儲出貨才可查詢批/序號資料
              IF g_ogb[l_ac].ogb17 = "N" THEN   #No:FUN-870131
                 CALL t600_b1_move_back()
                 CALL t600_b_else()
                 LET g_success = 'Y'              #CHI-A10016
                 BEGIN WORK                       #CHI-A10016
                 CALL s_lotout(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,0,
                               g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                               g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                               g_ogb[l_ac].ogb05,b_ogb.ogb15,b_ogb.ogb15_fac,
                               g_ogb[l_ac].ogb12,'','QRY')#CHI-9A0022 add ''
                     RETURNING l_r,g_qty
                 IF g_success = "Y" THEN
                    COMMIT WORK
                 ELSE
                    ROLLBACK WORK    
                 END IF
              #-----MOD-A90036---------
              ELSE
                 CALL cl_err('','axm-428',0)
              #-----END MOD-A90036-----
              END IF   #No:FUN-870131
           END IF
         END IF    #MOD-960349

        WHEN "qc_reject_q"
           IF cl_chk_act_auth() THEN
              #mod by huyx110916---start---会对应多张验退单
#              SELECT oga01 INTO l_oga01 FROM oga_file
#               WHERE oga09 = '9'
#                 AND oga011 = g_oga.oga011
#              IF NOT cl_null(l_oga01) THEN
#                 LET l_str = 'oga01="',l_oga01,'"'   
#                 LET g_msg="axmt629 '' '",l_str CLIPPED,"'" 
#                 CALL cl_cmdrun_wait(g_msg)  
#              END IF
              LET l_str = 'oga011="',g_oga.oga011,'"'    #Modi by zm 100201
              LET g_msg="axmt629 '' '",l_str CLIPPED,"'" 
              CALL cl_cmdrun_wait(g_msg)  
              #mod by huyx110916---end---会对应多张验退单
           END IF
        WHEN "order_query_b"
           IF l_ac > 0 THEN
              IF NOT cl_null(g_ogb[l_ac].ogb31) THEN
                 CALL s_ordqry(g_ogb[l_ac].ogb31)
              END IF
           END IF
#FUN-A70132 --begin--             
        WHEN "detail_tax"          #--單身稅別明細
          IF cl_chk_act_auth() THEN
            CALL t600_detail_tax()
          END IF
#FUN-A70132 --end--

#FUN-A70132 --begin--          
        WHEN "trans_tax"           #--實際交易稅別明細
          IF cl_chk_act_auth() THEN
            CALL t600_trans_tax()
          END IF          
#FUN-A70132 --end--           
           
#FUN-A60035 ---MARK BEGIN
##FUN-A50054 --Begin
#        WHEN "style_detail"
#&ifdef SLK
##          IF s_industry("slk") THEN
#              IF l_ac>0 THEN
#              #   CALL s_detail(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,g_ogb[l_ac].ogb04,'N')   #FUN-A60035 mark
#                 CALL s_detail(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,g_ogb[l_ac].ogb04,'Y')    #FUN-A60035 add
#                     RETURNING g_ogb[l_ac].ogb12
#              END IF
##          END IF
#&endif
##FUN-A50054 --End
#FUN-A60035 ---MARK END

      END CASE
   END WHILE

END FUNCTION

#FUN-A70132 --begin--
FUNCTION t600_trans_tax()
   DEFINE  l_sql     LIKE type_file.chr1000
   DEFINE  g_rec_b   LIKE type_file.num5,
           g_cnt     LIKE type_file.num5 
   DEFINE l_ogh    DYNAMIC ARRAY OF RECORD     #--定義一個動態數組
            ogh02     LIKE ogh_file.ogh02,
            ogh03     LIKE ogh_file.ogh03,
            gec02     LIKE gec_file.gec02,
            ogh04     LIKE ogh_file.ogh04,
            ogh05     LIKE ogh_file.ogh05,
            ogh06     LIKE ogh_file.ogh06,
            ogh07     LIKE ogh_file.ogh07,
            ogh07t    LIKE ogh_file.ogh07t,
            ogh08     LIKE ogh_file.ogh08
            END RECORD
   IF (g_azw.azw04='2') AND (g_oga.oga94 = 'Y') THEN 
      LET l_sql ="SELECT ogh02,ogh03,'',ogh04,ogh05,ogh06,ogh07,",
                 " ogh07t,ogh08 ",
                 "  FROM ogh_file,oga_file ",
                 " WHERE ogh01 = oga01 ",
                 "   AND oga01 = '",g_oga.oga01,"'",
                 " ORDER BY ogh02 "
      PREPARE t620_prepare1 FROM l_sql
         IF SQLCA.sqlcode THEN 
            CALL cl_err('t620_prepare1:',SQLCA.sqlcode,1) 
            RETURN 
         END IF
      DECLARE t620_curs1 CURSOR WITH HOLD FOR t620_prepare1   
      CALL l_ogh.clear()
      LET g_cnt = 1     
      FOREACH t620_curs1 INTO l_ogh[g_cnt].*
         IF SQLCA.sqlcode THEN
            CALL cl_err('foreach:',SQLCA.sqlcode,1)
            EXIT FOREACH
         END IF
         SELECT gec02 INTO l_ogh[g_cnt].gec02 FROM gec_file 
          WHERE gec01 = l_ogh[g_cnt].ogh03 
            AND gec011 = '2'
         LET g_cnt = g_cnt + 1 
      END FOREACH 
      CALL l_ogh.deleteElement(g_cnt)
      LET g_rec_b=g_cnt-1      
      OPEN WINDOW axmt620_a_w WITH FORM "axm/42f/axmt620_a"
         ATTRIBUTE (STYLE = g_win_style CLIPPED)
      CALL cl_ui_locale("axmt620_a")         
      DISPLAY g_rec_b TO FORMONLY.cn2
      DISPLAY ARRAY l_ogh TO s_ogh.*  ATTRIBUTE(COUNT=g_rec_b) 
         ON ACTION controlg                                 
            CALL cl_cmdask() 
      END DISPLAY 
      IF INT_FLAG THEN
         LET INT_FLAG = 0 
         CLOSE WINDOW axmt620_a_w 
      END IF          
   ELSE 
      RETURN 
   END IF
   CLOSE WINDOW axmt620_a_w    
END FUNCTION
#FUN-A70132 --end--

#FUN-A70132 --begin--
FUNCTION t600_detail_tax()
   DEFINE  l_sql     LIKE type_file.chr1000
   DEFINE  g_rec_b   LIKE type_file.num5,
           g_cnt     LIKE type_file.num5
   DEFINE l_ogi    DYNAMIC ARRAY OF RECORD     #--定義一個動態數組
            ogi02     LIKE ogi_file.ogi02,
            ogi03     LIKE ogi_file.ogi03,
            ogi04     LIKE ogi_file.ogi04,
            gec02     LIKE gec_file.gec02,
            ogi05     LIKE ogi_file.ogi05,
            ogi06     LIKE ogi_file.ogi06,
            ogi07     LIKE ogi_file.ogi07,
            ogi08     LIKE ogi_file.ogi08,
            ogi08t    LIKE ogi_file.ogi08t,
            ogi09     LIKE ogi_file.ogi09
            END RECORD           
   IF l_ac = 0  OR cl_null(l_ac)  THEN                                          
      RETURN                                                                    
   END IF  
   IF (g_azw.azw04='2') AND (g_oga.oga94 = 'Y') THEN 
      LET l_sql ="SELECT ogi02,ogi03,ogi04,'',ogi05,ogi06,ogi07,",
                 " ogi08,ogi08t,ogi09 ",
                 "  FROM ogi_file,ogb_file ",
                 " WHERE ogi01 = ogb01 ",
                 "   AND ogi02 = ogb03 ",
                 "   AND ogb01 = '",g_oga.oga01,"'", 
                 "   AND ogi02 = '",g_ogb[l_ac].ogb03,"'", 
                 " ORDER BY ogi02,ogi03 "
      PREPARE t620_prepare2 FROM l_sql
         IF SQLCA.sqlcode THEN 
            CALL cl_err('t620_prepare2:',SQLCA.sqlcode,1) 
            RETURN 
         END IF
      DECLARE t620_curs2 CURSOR WITH HOLD FOR t620_prepare2   
      CALL l_ogi.clear()
      LET g_cnt = 1
      FOREACH t620_curs2 INTO l_ogi[g_cnt].*
         IF SQLCA.sqlcode THEN
            CALL cl_err('foreach:',SQLCA.sqlcode,1)
            EXIT FOREACH
         END IF
         SELECT gec02 INTO l_ogi[g_cnt].gec02 FROM gec_file 
          WHERE gec01 =l_ogi[g_cnt].ogi04 
            AND gec011 = '2'
         LET g_cnt = g_cnt + 1 
      END FOREACH 
      CALL l_ogi.deleteElement(g_cnt)
      LET g_rec_b=g_cnt-1      
      OPEN WINDOW axmt620_b_w WITH FORM "axm/42f/axmt620_b"
         ATTRIBUTE (STYLE = g_win_style CLIPPED)
      CALL cl_ui_locale("axmt620_b")          
      DISPLAY g_rec_b TO FORMONLY.cn2
      DISPLAY ARRAY l_ogi TO s_ogi.*  ATTRIBUTE(COUNT=g_rec_b) 
         ON ACTION controlg                                 
            CALL cl_cmdask() 
      END DISPLAY       
      IF INT_FLAG THEN
         LET INT_FLAG = 0 
         CLOSE WINDOW axmt620_b_w 
      END IF          
   ELSE 
      RETURN 
   END IF 
   CLOSE WINDOW axmt620_b_w   
END FUNCTION
#FUN-A70132 --end--

#取消折价
FUNCTION t600_cancel_price()
DEFINE l_i    LIKE type_file.num5

   IF s_shut(0) THEN RETURN END IF
   IF g_oga.oga01 IS NULL THEN RETURN END IF
   IF g_oga.ogaconf = 'Y' THEN CALL cl_err('',9023,0) RETURN END IF
   IF g_oga.ogaconf = 'X' THEN CALL cl_err('',9024,0) RETURN END IF

   OPEN WINDOW t600_s_w AT p_row,p_col WITH FORM "axm/42f/axmt410_s"
      ATTRIBUTE (STYLE = g_win_style CLIPPED)

   CALL cl_ui_init()
   CALL t600_s_fill()

   INPUT ARRAY g_oeb7 WITHOUT DEFAULTS FROM s_oeb7.*
      ATTRIBUTE(COUNT=g_rec_b,MAXCOUNT=g_max_rec,UNBUFFERED,
                INSERT ROW=FALSE,DELETE ROW=FALSE,
                APPEND ROW=FALSE)
      ON ACTION all
         FOR l_i = 1 TO g_oeb7.getLength()
            LET g_oeb7[l_i].status = 'Y'
         END FOR

      ON ACTION no_all
         FOR l_i = 1 TO g_oeb7.getLength()
            LET g_oeb7[l_i].status = 'N'
         END FOR
   END INPUT

   IF INT_FLAG THEN
      CALL g_oeb7.clear()
      LET INT_FLAG = 0
      CLOSE WINDOW t600_s_w
      RETURN
   END IF

   BEGIN WORK
   FOR l_i = 1 TO g_oeb7.getLength()
       IF g_oeb7[l_i].status = 'Y' THEN
          UPDATE ogb_file SET ogb47 = 0
              WHERE ogb01 = g_oga.oga01 AND ogb03 = g_oeb7[l_i].oeb03
          IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
             ROLLBACK WORK
             CALL cl_err3("upd","ogb_file",g_oga.oga01,"",SQLCA.sqlcode,"","",1)
             EXIT FOR
          END IF
       END IF
   END FOR

   COMMIT WORK
   CLOSE WINDOW t600_s_w
   CALL t600_b1_fill(" 1=1")
END FUNCTION

FUNCTION t600_s_fill()

   LET g_sql = "SELECT 'N',ogb03,ogb04,ogb06,'',ogb05,ogb12,ogb47 ",
               "   FROM ogb_file ",
                "  WHERE ogb01 = ? AND ogb47 IS NOT NULL AND ogb47>0 "
   PREPARE pre_sel_ogb FROM g_sql
   DECLARE cur_ogb CURSOR FOR pre_sel_ogb

   CALL g_oeb7.clear()
   LET g_cnt = 1
   FOREACH cur_ogb USING g_oga.oga01 INTO g_oeb7[g_cnt].*
      IF STATUS THEN
         CALL cl_err('',STATUS,1)
         EXIT FOREACH
      END IF
      SELECT ima021 INTO g_oeb7[g_cnt].ima021 FROM ima_file
         WHERE ima01 = g_oeb7[g_cnt].oeb04
      LET g_cnt = g_cnt + 1
      IF g_cnt > g_max_rec THEN
         CALL cl_err( '', 9035, 0 )
         EXIT FOREACH
      END IF
   END FOREACH
   CALL g_oeb7.deleteElement(g_cnt)
END FUNCTION

FUNCTION t600_a()
   DEFINE li_result    LIKE type_file.num5           #No.MOD-6B0161
   DEFINE l_rtz03      LIKE rtz_file.rtz03           #FUN-B50054

   IF s_shut(0) THEN RETURN END IF
   CALL cl_msg("")

   CLEAR FORM
   CALL g_ogb.clear()
   INITIALIZE g_oga.* TO NULL
   INITIALIZE g_oea.* TO NULL   #MOD-840099 add
   LET g_oga_o.* = g_oga.*
   LET g_oga_t.* = g_oga.*

   CALL cl_opmsg('a')

   WHILE TRUE
      CALL t600_a_default()

      LET g_flag2 = '0'   #CHI-920012
      CALL t600_i("a")                #輸入單頭

      IF INT_FLAG THEN
         INITIALIZE g_oga.* TO NULL
         LET INT_FLAG = 0
         LET g_flag2 = '1'   #CHI-920012
         CALL cl_err('',9001,0)
         ROLLBACK WORK
         EXIT WHILE
      END IF

      IF g_oga.oga01 IS NULL THEN
         CONTINUE WHILE
      END IF

      BEGIN WORK   #No:7829

      #在自動產生單號時，在CALL一次s_check_no()重新抓取oay_fuile資料
      CALL t600_oga01() RETURNING li_result       #check 單別
      IF (NOT li_result) THEN
         ROLLBACK WORK
         CONTINUE WHILE
      END IF

      IF NOT t600_a_inschk() THEN
         ROLLBACK WORK
         CONTINUE WHILE
      END IF

      IF NOT t600_a_ins() THEN
         ROLLBACK WORK   #No:7829
         CONTINUE WHILE
      END IF
     #FUN-B50054 Begin---
      IF g_azw.azw04 = '2' AND g_argv0 = '2' THEN
         SELECT rtz03 INTO l_rtz03 FROM rtz_file WHERE rtz01 = g_oga.oga83
         IF l_rtz03 = '3' THEN
            CALL cl_set_comp_visible("ogb40",TRUE)
         ELSE
            CALL cl_set_comp_visible("ogb40",FALSE)
         END IF
      END IF
     #FUN-B50054 End-----
      CALL g_ogb.clear()
      LET g_rec_b1 = 0     #No.TQC-640123
      LET g_rec_b2 = 0     #No.TQC-640123

      CALL t600_g_b8()            #FUN-A80081 Add  
      CALL t600_b1()                   #輸入單身
      IF g_aza.aza50='Y' THEN
         CALL t600_b2()                   #輸入單身
      END IF

      IF g_oga.oga09 ='2' AND g_oga.oga07 = 'Y' THEN
         IF cl_confirm('anm-229') THEN
            CALL t600_v()
         END IF
      END IF

      # 新增自動確認功能 Modify by WUPN 96-05-06 ----------
      LET g_t1=s_get_doc_no(g_oga.oga01)       #No.FUN-550052
      SELECT * INTO g_oay.* FROM oay_file WHERE oayslip=g_t1
      IF STATUS THEN
         CALL cl_err3("sel","oay_file","g_t1","",SQLCA.sqlcode,"","",1)  #No.FUN-670008
      END IF

     #IF g_oay.oayconf='Y' THEN                         #單據需自動確認   #FUN-970017 mark
      IF g_oay.oayconf='Y' AND g_oay.oayapr <> 'Y'THEN  #單據需自動確認且不需簽核 #FUN-970017 add
        LET g_action_choice = "insert"                  #FUN-970017 add
       #-----當帳款因某些因素無法產生時,此筆出貨單不可確認--#
        CALL t600sub_y_chk(g_oga.oga01)          #CALL 原確認的 check 段
        IF g_success = "Y" AND g_flag2 = '0' THEN   #CHI-920012
           CALL t600sub_y_upd(g_oga.oga01,'confirm')     #CALL 原確認的 update 段   #MOD-920025
           CALL t600sub_refresh(g_oga.oga01) RETURNING g_oga.*  #FUN-730012 重新讀取g_oga
        END IF
        CALL t600_show()

      END IF
      IF g_oay.oayprnt='Y' THEN CALL t600_out() END IF   #單據需立即列印

      EXIT WHILE

   END WHILE
   #CHI-AC0002 add --start--
   CALL cl_set_act_visible("entry_sheet2",TRUE)
   IF g_aza.aza63 = 'N' THEN
      CALL cl_set_act_visible("entry_sheet2",FALSE)
   END IF
   #CHI-AC0002 add --end--
END FUNCTION

FUNCTION t600_u()
   DEFINE l_n          LIKE type_file.num5     #MOD-650057 add  #No.FUN-680137 SMALLINT

   IF s_shut(0) THEN RETURN END IF
   SELECT * INTO g_oga.* FROM oga_file WHERE oga01 = g_oga.oga01                          #TQC-9A0115 Add
   IF g_oga.oga01 IS NULL THEN CALL cl_err('',-400,0) RETURN END IF
   IF g_oga.ogaconf = 'X' THEN CALL cl_err('',9024,0) RETURN END IF
   IF g_oga.ogaconf = 'Y' THEN CALL t600_u2() RETURN END IF
   IF g_oga.oga55 matches '[Ss]' THEN          #FUN-550050
       CALL cl_err('','apm-030',0)
       RETURN
   END IF

  #IF g_oga.oga54 != 0 THEN CALL cl_err('','axm-160',0) RETURN END IF #MOD-B60010 mark
  IF NOT t600_chk_ofa_oma(g_oga.oga01) THEN CALL cl_err('','axm-160',0) RETURN END IF #MOD-B60010 add
   IF g_argv0 ='1' THEN
      SELECT COUNT(*) INTO l_n FROM oga_file
       WHERE oga011 = g_oga.oga01
         AND oga09 IN ('2','4','6')   #No.7992
         AND ogaconf != 'X'
      #此出貨通知單已經出貨! 不可再做任何處理!
      IF l_n > 0 THEN
          CALL cl_err('oga011!='':','axm-228',1)
          RETURN
      END IF
   END IF
   CALL cl_msg("")
   CALL cl_opmsg('u')
   LET g_oga_o.* = g_oga.*

   BEGIN WORK

   OPEN t600_cl USING g_oga.oga01                                                       #TQC-9A0115 Add
   IF STATUS THEN
      CALL cl_err("OPEN t600_cl:", STATUS, 1)
      CLOSE t600_cl
      ROLLBACK WORK
      RETURN
   END IF

   FETCH t600_cl INTO g_oga.*          # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
      CALL cl_err(g_oga.oga01,SQLCA.sqlcode,0)     # 資料被他人LOCK
      CLOSE t600_cl
      ROLLBACK WORK RETURN
   END IF
   CALL t600_show()
   WHILE TRUE
       LET g_oga.ogamodu=g_user
       LET g_oga.ogadate=g_today
       LET g_flag2 = '0'   #CHI-920012
       CALL t600_i("u")                      #欄位更改
       IF INT_FLAG THEN
          LET INT_FLAG = 0
          LET g_flag2 = '1'   #CHI-920012
          LET g_oga.*=g_oga_t.*
          CALL t600_show()
          CALL cl_err('','9001',0)
          EXIT WHILE
       END IF

      #重抓訂單檔的比率
       IF NOT cl_null(g_oga.oga16) THEN
          SELECT oea161,oea162,oea163
            INTO g_oga.oga161,g_oga.oga162,g_oga.oga163 FROM oea_file
           WHERE oea01=g_oga.oga16
       END IF
       LET g_oga.oga55 = '0'    #FUN-550050
       DISPLAY BY NAME g_oga.ogamksg
       DISPLAY BY NAME g_oga.oga55

       CALL t600_bu()    #MOD-940053 add

       UPDATE oga_file SET * = g_oga.* WHERE oga01 = g_oga.oga01                   #TQC-9A0115 Add
       IF STATUS OR SQLCA.SQLCODE THEN
          CALL cl_err3("upd","oga_file","g_oga_t.oga01","",SQLCA.sqlcode,"","",1)  #No.FUN-670008
          CONTINUE WHILE
       END IF
       IF g_oga.oga01 != g_oga_t.oga01 THEN
          IF NOT t600_chkkey() THEN
             CALL t600_show()
             LET g_oga.*=g_oga_t.*
             ROLLBACK WORK
             RETURN
          END IF
       END IF
       CALL t600_ins_oao('u')   #MOD-B40263
       EXIT WHILE
   END WHILE
   DISPLAY BY NAME g_oga.oga55
   CALL t600_chspic()

   CLOSE t600_cl
   COMMIT WORK

   CALL cl_flow_notify(g_oga.oga01,'U')

# 新增自動確認功能 Modify by WUPN 96-05-06 ----------
   LET g_t1=s_get_doc_no(g_oga.oga01)       #No.FUN-550052

   SELECT * INTO g_oay.* FROM oay_file WHERE oayslip=g_t1
   IF STATUS THEN
      CALL cl_err3("sel","oay_file","g_t1","",SQLCA.sqlcode,"","sel oay_file",1)  #No.FUN-670008
      RETURN
   END IF

  #IF (g_oga.ogaconf='Y' OR g_oay.oayconf='N') THEN #單據已確認或單據不需自動確認 #FUN-970017 mark
   IF (g_oga.ogaconf='Y' OR g_oay.oayconf='N' OR g_oay.oayapr = 'Y') THEN         #FUN-970017 add
      RETURN
   ELSE
      CALL t600sub_y_chk(g_oga.oga01)          #CALL 原確認的 check 段
      IF g_success = "Y" AND g_flag2 = '0' THEN   #CHI-920012
         CALL t600sub_y_upd(g_oga.oga01,g_action_choice)       #CALL 原確認的 update 段
         CALL t600sub_refresh(g_oga.oga01) RETURNING g_oga.*  #FUN-730012 重新讀取g_oga
      END IF
      CALL t600_show()
   END IF

   IF g_oay.oayprnt='Y' THEN
      CALL t600_out()
   END IF   #單據需立即列印

END FUNCTION

FUNCTION t600_i(p_cmd)
   DEFINE p_cmd           LIKE type_file.chr1                  #a:輸入 u:更改  #No.FUN-680137 VARCHAR(1)
   DEFINE l_type          LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)
   DEFINE l_cnt           LIKE type_file.num5    #No.FUN-870007
#FUN-A60004 ----------------add start----------------------------------
   DEFINE l_oma11         LIKE oma_file.oma11                                   
   DEFINE l_oma12         LIKE oma_file.oma12                                   
   DEFINE l_oma03         LIKE oma_file.oma03                                   
   DEFINE l_oma32         LIKE oma_file.oma32                                   
   DEFINE l_oma02         LIKE oma_file.oma02                                   
   DEFINE l_oma09         LIKE oma_file.oma09                                   
   DEFINE l_oea02         LIKE oea_file.oea02   
#FUN-A60004 ---------------add end-------------------------------------
   DEFINE l_oaytype       LIKE oay_file.oaytype  #130108jiangxt

    CALL cl_set_head_visible("","YES")       #No.FUN-6A0092

    INPUT BY NAME g_oga.ogaoriu,g_oga.ogaorig,
        g_oga.oga00,g_oga.oga08,g_oga.oga01,g_oga.oga69,g_oga.oga02,g_oga.oga011,   #FUN-650009 add oga69
        g_oga.oga16,g_oga.oga03,g_oga.oga032,g_oga.oga04,
        g_oga.oga18,g_oga.oga1002,g_oga.oga1009,g_oga.oga1015,g_oga.oga1003,g_oga.oga021,g_oga.oga27,
        g_oga.oga1004,g_oga.oga1016,g_oga.oga14,g_oga.oga15,
        g_oga.oga902,g_oga.oga903,g_oga.oga99,g_oga.oga905,
        g_oga.ogaconf,g_oga.ogaspc,g_oga.oga30,g_oga.ogapost,g_oga.ogamksg,g_oga.oga55,    #FUN-680010
        g_oga.oga25,g_oga.oga23,g_oga.oga24,
        g_oga.oga21,g_oga.oga211,g_oga.oga212,g_oga.oga213,
        g_oga.oga1011,g_oga.oga1010,g_oga.oga1014,g_oga.oga1012,g_oga.oga65,
        g_oga.oga83,g_oga.oga84,g_oga.oga85,g_oga.oga86,g_oga.oga87,                  #No:FUN-870008                                          
        g_oga.oga88,g_oga.oga89,g_oga.oga90,g_oga.oga91,g_oga.oga92,                  #No:FUN-870008
        g_oga.oga93,g_oga.oga98,g_oga.oga94,g_oga.oga95,g_oga.oga96,g_oga.oga97,g_oga.ogaplant,   #No:FUN-870008  #FUN-A50071 
        g_oga.oga57,g_oga.oga72,g_oga.oga13,g_oga.oga05 ,g_oga.oga10,        #FUN-AA0057 add oga57     #No.FUN-A60004 add oga72
        g_oga.ogauser,g_oga.ogagrup,g_oga.ogamodu,g_oga.ogadate,
        g_oga.ogaud01,g_oga.ogaud02,g_oga.ogaud03,g_oga.ogaud04,
        g_oga.ogaud05,g_oga.ogaud06,g_oga.ogaud07,g_oga.ogaud08,
        g_oga.ogaud09,g_oga.ogaud10,g_oga.ogaud11,g_oga.ogaud12,
        g_oga.ogaud13,g_oga.ogaud14,g_oga.ogaud15 
           WITHOUT DEFAULTS

        BEFORE INPUT
           LET g_before_input_done = FALSE
        IF g_oga.oga909 = 'Y' THEN
                 LET g_oga.oga08='1' 
        END IF
           
           CALL t600_set_entry(p_cmd)           
           CALL t600_set_no_entry(p_cmd)        
           IF p_cmd='a' THEN
              CALL cl_set_comp_entry("oga08",TRUE)
           ELSE
              CALL cl_set_comp_entry("oga08",FALSE)
           END IF  
           LET g_before_input_done = TRUE
           CALL cl_set_docno_format("oga01")        #No.FUN-550052
 

        BEFORE FIELD oga00
           CALL cl_set_comp_entry("oga1004",TRUE)
           CALL cl_set_comp_required("oga1004",FALSE)
           CALL t600_set_entry(p_cmd)   #CHI-730002

        AFTER FIELD oga00
           IF NOT cl_null(g_oga.oga00) THEN
              IF g_oga.oga00 NOT MATCHES '[123467AB]' THEN NEXT FIELD CURRENT END IF     #FUN-690044   #No:FUN-740016
              #多角貿易
              IF g_oga.oga909 = 'Y' THEN
                 IF g_oga.oga00 NOT MATCHES '[126]' THEN NEXT FIELD CURRENT END IF
              END IF
              IF g_oga.oga00 != '6' THEN
                 LET g_oga.oga1004 =NULL
                 CALL cl_set_comp_entry("oga1004",FALSE)
                 CALL t600_show()
              ELSE
                 CALL cl_set_comp_required("oga1004",TRUE)
              END IF
              IF g_oga.oga00 != '7'  THEN
                 LET g_oga.oga1016 =NULL
                 CALL cl_set_comp_entry("oga1016",FALSE)
                 CALL t600_show()
                 CALL cl_set_comp_entry("oga65",TRUE)   #No.TQC-7C0114
              ELSE
                 CALL cl_set_comp_entry("oga1016",TRUE)  #No.TQC-7C0114
                 CALL cl_set_comp_entry("oga65,oga72",FALSE)   #No.TQC-7C0114    #FUN-A60004 add oga72
              END IF
#end
              CALL t600_set_no_entry(p_cmd)   #CHI-730002
           END IF

        AFTER FIELD oga08
           IF NOT cl_null(g_oga.oga16) THEN   #NO.MOD-780221 add
               IF NOT cl_null(g_oga.oga08) THEN
                  IF g_oea.oea08 != g_oga.oga08 AND NOT cl_null(g_oga.oga16) THEN
                     #國內外不符
                     CALL cl_err('sel oea','axm-125',0) NEXT FIELD CURRENT
                  END IF
                  IF g_oga.oga08 NOT MATCHES '[123]' THEN NEXT FIELD CURRENT END IF
               END IF
           END IF                             #no.MOD-780221 add

        AFTER FIELD oga01
           IF NOT t600_chk_oga01() THEN
              NEXT FIELD CURRENT
           END IF
           #130108jiangxt-start
           IF NOT cl_null(g_oga.oga01) THEN
              SELECT oaytype INTO l_oaytype FROM oay_file WHERE oayslip=g_t1
              IF l_oaytype='30' or l_oaytype='50' or l_oaytype='60' THEN
                 SELECT oay08 INTO g_oga.oga08 FROM oay_file WHERE oayslip=g_t1
                 DISPLAY BY NAME g_oga.oga08
                 CALL cl_set_comp_entry("oga08",FALSE)
              ELSE
                 CALL cl_set_comp_entry("oga08",TRUE)
              END IF
           END IF
           #130108jiangxt-end       
  
        AFTER FIELD oga84                                                                                                          IF NOT cl_null(g_oga.oga84) THEN         
               IF p_cmd='a' OR (p_cmd='u' AND g_oga.oga84<>g_oga_t.oga84) THEN
                  CALL t600_oga84('a')
                  IF NOT cl_null(g_errno) THEN
                     CALL cl_err(g_oga.oga84,g_errno,0)
                     LET g_oga.oga84=g_oga_t.oga84
                     DISPLAY BY NAME g_oga.oga84
                     NEXT FIELD oga84
                  END IF
               END IF 
            END IF   
                                                                                                          
         AFTER FIELD oga86                                                                                                          
               IF NOT cl_null(g_oga.oga86) THEN                                                                                     
                  LET l_cnt=0                                                                                                       
                  SELECT COUNT(*) INTO l_cnt FROM tqa_file                                                                    
                   WHERE tqa01=g_oga.oga86 AND tqa03='23' AND tqaacti='Y'                                                                
                  IF l_cnt=0 THEN                                                                                                   
                     CALL cl_err('','art-251',1)                                                                                    
                     NEXT FIELD oga86                                                                                               
                  END IF                                                                                                            
               END IF                                                                                                               
         AFTER FIELD oga87  
               IF NOT cl_null(g_oga.oga87) THEN
                  LET l_cnt=0
                  SELECT COUNT(*) INTO l_cnt FROM lpj_file
                   WHERE lpj03=g_oga.oga87 AND lpj04<=g_today 
                  #  AND lpj05=g_today     AND lpj09='2'                    #TQC-A20058 MARK 
                     AND (lpj05 IS NULL OR lpj05>=g_today ) AND lpj09='2'   #add 
                  IF l_cnt=0 THEN 
                     CALL cl_err('','art-313',0)
                     NEXT FIELD oga87
                  END IF
                  #-----MOD-B60001---------
                  IF g_oga.oga87 != g_oga_t.oga87 OR cl_null(g_oga_t.oga87) THEN
                     LET g_oga.oga95= t600_oga95_amount()
                     IF cl_null(g_oga.oga95) THEN LET g_oga.oga95=0 END IF
                     DISPLAY BY NAME g_oga.oga95
                  END IF
                  #-----END MOD-B60001-----
               END IF 

        AFTER FIELD oga69
           IF NOT t600_chk_oga69() THEN
              NEXT FIELD CURRENT
           END IF

        AFTER FIELD oga02
           IF NOT t600_chk_oga02() THEN
              NEXT FIELD CURRENT
           END IF

        AFTER FIELD oga021
           IF NOT t600_chk_oga021() THEN
              NEXT FIELD CURRENT
           END IF

        AFTER FIELD oga27
           IF NOT t600_chk_oga27() THEN
              NEXT FIELD CURRENT
           END IF

        BEFORE FIELD oga011
           CALL t600_set_entry(p_cmd)

        #自動帶通知單單身 Modify by WUPN 96-05-15 --
        AFTER FIELD oga011
           IF NOT t600_chk_oga011(p_cmd) THEN
              NEXT FIELD CURRENT
           ELSE
              CALL t600_show()
           END IF

        AFTER FIELD oga13
           IF NOT t600_chk_oga013() THEN
              NEXT FIELD CURRENT
           END IF

        BEFORE FIELD oga16
           CALL t600_set_entry(p_cmd)

        AFTER FIELD oga16
           IF NOT t600_chk_oga16(p_cmd) THEN
              NEXT FIELD CURRENT
           ELSE
              IF p_cmd='a' AND cl_null(g_oga.oga011) #由訂單轉出貨單
                 OR (g_oga.oga16 != g_oga_t.oga16 OR cl_null(g_oga_t.oga16)) THEN
                 CALL t600_show()
              END IF
           END IF

        BEFORE FIELD oga24
           IF g_oga.oga23 = g_aza.aza17 THEN
              LET g_oga.oga24 = 1
           END IF

        AFTER FIELD oga24     #匯率
            IF g_oga.oga23 =g_aza.aza17 THEN
               LET g_oga.oga24 =1
               DISPLAY g_oga.oga24  TO oga24
            END IF
            IF g_oga.oga24 < = 0 THEN                                                                                               
               CALL cl_err(g_oga.oga24,'axm-987',0)                                                                                 
               NEXT FIELD oga24                                                                                                     
            END IF                                                                                                                  


        AFTER FIELD oga18   #No.FUN-610064
           IF NOT t600_chk_oga18() THEN
              NEXT FIELD CURRENT
           END IF

        AFTER FIELD oga04
           IF NOT t600_chk_oga04() THEN
              NEXT FIELD CURRENT
           END IF
           IF cl_null(g_oga.oga16) THEN #MOD-B40171 add 
              #-----MOD-A90158---------
              IF g_oga.oga04 <> g_oga_t.oga04 AND 
                 g_oga.oga09 MATCHES '[45]'THEN
                 IF cl_confirm('axm_116') THEN
                    SELECT occ42,occ43,occ41 
                      INTO g_oga.oga23,g_oga.oga25,g_oga.oga21
                      FROM occ_file WHERE occ01 = g_oga.oga04
                    CALL t600_oea18_get() RETURNING g_oea18_yn                                                                        
                    IF g_oea18_yn = 'N' THEN                                                                                          
                       IF g_oga.oga08='1' THEN                                                                                       
                           LET exT=g_oaz.oaz52                                                                                       
                       ELSE                                                                                                          
                           LET exT=g_oaz.oaz70                                                                                       
                       END IF                                                                                                        
                       IF g_oga.oga909 = 'Y' THEN                                                                                    
                          CALL t600_chk_poz00() RETURNING exT    
                       END IF                                                                                                        
                       IF NOT cl_null(g_oga.oga021) THEN
                          LET g_exdate = g_oga.oga021    #結關日期
                       ELSE
                          LET g_exdate = g_oga.oga02     #出貨日期
                       END IF 
                       CALL s_curr3(g_oga.oga23,g_exdate,exT) RETURNING g_oga.oga24
                    END IF
                    SELECT gec04,gec05,gec07 
                      INTO g_oga.oga211,g_oga.oga212,g_oga.oga213
                      FROM gec_file WHERE gec01=g_oga.oga21
                                      AND gec011='2'  #銷項
                    DISPLAY BY NAME g_oga.oga23,g_oga.oga25,
                                    g_oga.oga21,g_oga.oga24,
                                    g_oga.oga211,g_oga.oga212,g_oga.oga213
                 END IF
                 LET g_oga_t.oga04 = g_oga.oga04
              END IF
              #-----END MOD-A90158-----
           END IF #MOD-B40171 add

        AFTER FIELD oga14
           IF NOT t600_chk_oga14() THEN
              NEXT FIELD CURRENT
           END IF

        BEFORE FIELD oga15
           CALL t600_bef_oga15()

        AFTER FIELD oga15
           IF NOT t600_chk_oga15() THEN
              NEXT FIELD CURRENT
           END IF

        AFTER FIELD oga23
           IF NOT t600_chk_oga23() THEN
              NEXT FIELD CURRENT
           END IF

        AFTER FIELD oga25
           IF NOT t600_chk_oga25() THEN
              NEXT FIELD CURRENT
           END IF

        AFTER FIELD oga21
           IF NOT t600_chk_oga21(p_cmd) THEN  #No:MOD-910067 add
              NEXT FIELD CURRENT
           END IF

        AFTER FIELD oga03 #No.FUN-610064 #No.FUN-610064
           IF NOT t600_chk_oga03(p_cmd) THEN
              NEXT FIELD CURRENT
           END IF
              CALL t600_show()      

        AFTER FIELD oga1002
          IF NOT cl_null(g_oga.oga1002) AND (g_oga.oga1002 != g_oga_t.oga1002
                                           OR g_oga_t.oga1002 IS NULL ) THEN
             CALL t600_oga1002('a')
              IF NOT cl_null(g_errno) THEN
                 CALL cl_err(g_oga.oga1002,g_errno,0)
                 NEXT FIELD CURRENT
              END IF
          END IF
          IF cl_null(g_oga.oga1002) THEN
             DISPLAY ' ' TO FORMONLY.oga1002_tqa02
          END IF

        AFTER FIELD oga1009
          IF NOT cl_null(g_oga.oga1009) AND (g_oga.oga1009 != g_oga_t.oga1009
                                           OR g_oga_t.oga1009 IS NULL ) THEN
             CALL t600_oga1009('a')
              IF NOT cl_null(g_errno) THEN
                 CALL cl_err(g_oga.oga1009,g_errno,0)
                 NEXT FIELD CURRENT
              END IF
          END IF
          IF cl_null(g_oga.oga1009) THEN
             DISPLAY ' ' TO FORMONLY.oga1009_tqa02
          END IF

        AFTER FIELD oga1016
           IF NOT cl_null(g_oga.oga1016) THEN
               CALL t600_oga1016('a')
                 IF NOT cl_null(g_errno) THEN
                    CALL cl_err(g_oga.oga1016,g_errno,0)
                    LET g_oga.oga1016 = g_oga_t.oga1016
                    NEXT FIELD CURRENT
                 END IF
           ELSE
               DISPLAY ' ' TO FORMONLY.oga1016_occ02
           END IF

        AFTER FIELD oga1004
          IF NOT cl_null(g_oga.oga1004) AND (g_oga.oga1004 != g_oga_t.oga1004
                                           OR g_oga_t.oga1004 IS NULL ) THEN
             CALL t600_oga1004('a')
              IF NOT cl_null(g_errno) THEN
                 CALL cl_err(g_oga.oga1004,g_errno,0)
                 NEXT FIELD CURRENT
              END IF
          END IF
          IF cl_null(g_oga.oga1004) THEN
             DISPLAY ' ' TO FORMONLY.oga1004_occ02
          END IF

        AFTER FIELD oga1011
          IF NOT cl_null(g_oga.oga1011) AND (g_oga.oga1011 != g_oga_t.oga1011
                                           OR g_oga_t.oga1011 IS NULL ) THEN
              CALL t600_oga1011('a')
              IF NOT cl_null(g_errno) THEN
                 CALL cl_err(g_oga.oga1011,g_errno,0)
                 NEXT FIELD CURRENT
              END IF
          END IF
          IF cl_null(g_oga.oga1011) THEN
             DISPLAY ' ' TO FORMONLY.oga1011_occ02
          END IF

        BEFORE FIELD oga1015
          IF g_oga.oga1015 IS NULL THEN
             LET g_oga.oga1015 ='0'
          END IF

        AFTER FIELD oga1015
          IF NOT cl_null(g_oga.oga1015) AND (g_oga.oga1015 != g_oga_t.oga1015
                                           OR g_oga_t.oga1015 IS NULL ) THEN
             CALL t600_oga1015('a')
             IF NOT cl_null(g_errno) THEN
                CALL cl_err(g_oga.oga1015,g_errno,0)
                NEXT FIELD CURRENT
             END IF
          END IF
          IF cl_null(g_oga.oga1015) THEN
             DISPLAY ' ' TO FORMONLY.oga1015_occ02
          END IF

        AFTER FIELD oga1010
          IF NOT cl_null(g_oga.oga1010) AND (g_oga.oga1010 != g_oga_t.oga1010
                                           OR g_oga_t.oga1010 IS NULL ) THEN
             CALL t600_oga1010('a')
             IF NOT cl_null(g_errno) THEN
                CALL cl_err(g_oga.oga1010,g_errno,0)
                NEXT FIELD CURRENT
             END IF
          END IF
          IF cl_null(g_oga.oga1010) THEN
             DISPLAY ' ' TO FORMONLY.oga1010_tqb02
          END IF

        AFTER FIELD oga1003
          IF NOT cl_null(g_oga.oga1003) AND (g_oga.oga1003 != g_oga_t.oga1003
                                           OR g_oga_t.oga1003 IS NULL ) THEN
             CALL t600_oga1003('a')
              IF NOT cl_null(g_errno) THEN
                 CALL cl_err(g_oga.oga1003,g_errno,0)
                 NEXT FIELD CURRENT
              END IF
          END IF
          IF cl_null(g_oga.oga1003) THEN
             DISPLAY ' ' TO FORMONLY.oga1003_tqb02
          END IF

#No.FUN-9B0132 add begin------------------------
        AFTER FIELD oga902
          IF NOT cl_null(g_oga.oga902) AND (g_oga.oga902 != g_oga_t.oga902
                                           OR g_oga_t.oga902 IS NULL ) THEN
             CALL t600_oga902('a')
              IF NOT cl_null(g_errno) THEN
                 CALL cl_err(g_oga.oga902,g_errno,0)
                 NEXT FIELD CURRENT
              END IF
          END IF
          IF cl_null(g_oga.oga902) THEN
             DISPLAY ' ' TO FORMONLY.oga902_desc
          END IF
#No.FUN-9B0132 add -end----------------------------

#FUN-A60004 ------------------------------add start--------------------------
        AFTER FIELD oga65                                                       
          IF cl_null(g_oga.oga72) THEN                                          
              IF g_oga.oga65 = 'Y' AND g_argv0 MATCHES '[12]' THEN              
              #单据性质=一般出货单/出通单时才自动推算oga72 ELSE 给NULL          
                 LET l_oma03 = g_oga.oga03                                      
                 IF NOT cl_null(g_oea.oea80) THEN                               
                    LET l_oma32 = g_oea.oea80                                   
                 ELSE                                                           
                    LET l_oma32 = g_oea.oea32                                   
                 END IF                                                         
                 LET l_oma02 = g_oga.oga02                                      
                 LET l_oma09 = g_oga.oga021                                     
                 IF NOT cl_null(g_oga.oga16) THEN                               
                    SELECT oea02 INTO l_oea02 FROM oea_file                     
                     WHERE oea01 = g_oga.oga16                                  
                 ELSE                                                           
                     LET l_oea02 = g_oga.oga02                                  
                 END IF
               # LET g_dbs2 = s_dbstring(g_dbs)                                 
                 CALL s_rdatem(l_oma03,l_oma32,l_oma02,l_oma09,l_oea02,g_plant2)  
                 #呼叫公用程式自动推算签收日                                    
                 RETURNING l_oma11,l_oma12                                      
                 LET g_oga.oga72 = l_oma11  ##预计签收日                        
                 DISPLAY g_oga.oga72 TO oga72                                   
              ELSE                                                              
                 LET g_oga.oga72 = NULL                                         
                 DISPLAY g_oga.oga72 TO oga72                                   
              END IF                                                            
          END IF                                                                
          IF g_oga.oga65 = 'N' THEN LET g_oga.oga72 = NULL END IF               
          DISPLAY BY NAME g_oga.oga72
    
        AFTER FIELD oga72                                                       
           IF g_oga.oga65 = 'Y' THEN                                            
             IF cl_null(g_oga.oga72) THEN                                       
                CALL cl_err('','aim-927',0)                                     
                NEXT FIELD oga72                                                
             END IF                                                             
           END IF
#FUN-A60004 -----------------------------add end---------------------------------

        AFTER FIELD ogaud01
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogaud02
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogaud03
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogaud04
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogaud05
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogaud06
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogaud07
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogaud08
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogaud09
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogaud10
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogaud11
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogaud12
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogaud13
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogaud14
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogaud15
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF

        ON ACTION controlp
           CASE
              WHEN INFIELD(oga01) #查詢單据
                   LET g_t1=s_get_doc_no(g_oga.oga01)       #No.FUN-550052
                   CASE WHEN g_argv0 MATCHES '[15]' AND g_oga.oga00!='7'     #FUN-630102
                             LET g_buf='40'    #No.7992
                        WHEN g_argv0 MATCHES '[246]' AND g_oga.oga00!='7'    #FUN-630102
                             LET g_buf='50'
                        WHEN g_argv0 ='8'            LET g_buf='58'   #No.FUN-630061
                        WHEN g_argv0 ='9'            LET g_buf='59'   #No.FUN-630061
                        WHEN g_argv0 MATCHES '[15]' AND g_oga.oga00='7'
                             LET g_buf='43'
                        WHEN g_argv0 ='2' AND g_oga.oga00='7'
                             LET g_buf='53'
                        WHEN g_argv0 ='A'
                             LET g_buf='51'
                   END CASE
                   IF g_oga.oga00 MATCHES '[37]' THEN LET g_buf[2,2] = '3' END IF   #No.FUN-610064
                   IF g_oga.oga00 = '4' THEN LET g_buf[2,2] = '4' END IF
                #   CALL q_oay(FALSE,FALSE,g_t1,g_buf,g_sys) RETURNING g_t1        #FUN-A70130
                   CALL q_oay(FALSE,FALSE,g_t1,g_buf,'axm') RETURNING g_t1        #FUN-A70130
                   LET g_oga.oga01=g_t1
                   DISPLAY BY NAME g_oga.oga01
                   NEXT FIELD oga01
              WHEN INFIELD(oga011)
                   CASE
                      WHEN g_argv0 = '1' LET l_type = '2'
                      WHEN g_argv0 = '2' LET l_type = '1'
                      WHEN g_argv0 = '4' LET l_type = '5'
                      WHEN g_argv0 = '5' LET l_type = '4'
                      WHEN g_argv0 = '6' LET l_type = '5'
                      #WHEN g_argv0 = '8' LET l_type = '7'   #No.FUN-630061   #MOD-AC0132
                      #WHEN g_argv0 = '9' LET l_type = '7'   #No.FUN-630061   #MOD-AC0132
                      WHEN g_argv0 = '8' LET l_type = '2'   #No.FUN-630061   #MOD-AC0132
                      WHEN g_argv0 = '9' LET l_type = '2'   #No.FUN-630061   #MOD-AC0132
                      WHEN g_argv0 = 'A' LET l_type = 'A'   #No:FUN-740016
                   END CASE
                   CALL cl_init_qry_var()
                   LET g_qryparam.form ="q_oga"
                   LET g_qryparam.where = "  (oga09='",l_type,"') "
                   LET g_qryparam.default1 = g_oga.oga011
                   CALL cl_create_qry() RETURNING g_oga.oga011
                   DISPLAY BY NAME g_oga.oga011
                   NEXT FIELD oga011
              WHEN INFIELD(oga16)
                   IF g_argv0 = "A" THEN
                      CALL cl_init_qry_var()
                      LET g_qryparam.form ="q_oea16"   #MOD-8B0108   q_oea14-->q_oea16
                      IF g_oga.oga00='A' THEN
                         LET g_qryparam.arg1 ='8'
                      ELSE
                         LET g_qryparam.arg1 ='9'
                      END IF
                      LET g_qryparam.arg2 = g_oga.oga08   #MOD-8B0108
                      CALL cl_create_qry() RETURNING g_oga.oga16
                   ELSE
                      IF g_argv0='4' OR g_argv0='5' OR g_argv0='6' THEN
                          CALL q_oea12(FALSE,TRUE,g_oga.oga16,'','2',g_oga.oga08) #MOD-530311   #MOD-8B0108
                              RETURNING g_oga.oga16
                      ELSE
                         CALL q_oea12(FALSE,TRUE,g_oga.oga16,'','1',g_oga.oga08) #MOD-530311   #MOD-8B0108
                              RETURNING g_oga.oga16
                      END IF
                   END IF   #No:FUN-740016
                   DISPLAY BY NAME g_oga.oga16
                   NEXT FIELD oga16
              WHEN INFIELD(oga03)
                   CALL cl_init_qry_var()
                   LET g_qryparam.form ="q_occ5"
                   CALL cl_create_qry() RETURNING g_oga.oga03
                   DISPLAY BY NAME g_oga.oga03
                   NEXT FIELD oga03

              WHEN INFIELD(oga03)    #No.FUN-610064
                   CALL cl_init_qry_var()
                   LET g_qryparam.form ="q_occ3"
                   LET g_qryparam.default1 = g_oga.oga03
                   CALL cl_create_qry() RETURNING g_oga.oga03
                   DISPLAY BY NAME g_oga.oga03
                   NEXT FIELD oga03
              WHEN INFIELD(oga04)
                   CALL cl_init_qry_var()
                  LET g_qryparam.form ="q_occ"  
                   LET g_qryparam.form ="q_occ4"
                   LET g_qryparam.default1 = g_oga.oga04
                   CALL cl_create_qry() RETURNING g_oga.oga04
                   DISPLAY BY NAME g_oga.oga04
                   NEXT FIELD oga04
              WHEN INFIELD(oga13)
                   CALL cl_init_qry_var()
                   LET g_qryparam.form ="q_ool"
                   LET g_qryparam.default1 = g_oga.oga13
                   CALL cl_create_qry() RETURNING g_oga.oga13
                   DISPLAY BY NAME g_oga.oga13
                   NEXT FIELD oga13
              WHEN INFIELD(oga14)
                   CALL cl_init_qry_var()
                    LET g_qryparam.form ="q_gen3"          #MOD-570345
                   LET g_qryparam.default1 = g_oga.oga14
                    LET g_qryparam.default2 = g_oga.oga15  #MOD-570345
                    CALL cl_create_qry() RETURNING g_oga.oga14,g_oga.oga15 #MOD-570345
                   DISPLAY BY NAME g_oga.oga14,g_oga.oga15
                   NEXT FIELD oga14
              WHEN INFIELD(oga15)
                   CALL cl_init_qry_var()
                   LET g_qryparam.form ="q_gem"
                   LET g_qryparam.default1 = g_oga.oga15
                   CALL cl_create_qry() RETURNING g_oga.oga15
                   DISPLAY BY NAME g_oga.oga15
                   NEXT FIELD oga15
              WHEN INFIELD(oga21)
                   CALL cl_init_qry_var()
                   LET g_qryparam.form ="q_gec"
                   LET g_qryparam.default1 = g_oga.oga21
                   LET g_qryparam.arg1 = '2'
                   CALL cl_create_qry() RETURNING g_oga.oga21
                   DISPLAY BY NAME g_oga.oga21
                   NEXT FIELD oga21
              WHEN INFIELD(oga23)
                   CALL cl_init_qry_var()
                   LET g_qryparam.form ="q_azi"
                   LET g_qryparam.default1 = g_oga.oga23
                   CALL cl_create_qry() RETURNING g_oga.oga23
                   DISPLAY BY NAME g_oga.oga23
                   NEXT FIELD oga23
              WHEN INFIELD(oga24)
                   CALL s_rate(g_oga.oga23,g_oga.oga24) RETURNING g_oga.oga24
                   DISPLAY BY NAME g_oga.oga24
                   NEXT FIELD oga24
              WHEN INFIELD(oga25)
                   CALL cl_init_qry_var()
                   LET g_qryparam.form ="q_oab"
                   LET g_qryparam.default1 = g_oga.oga25
                   CALL cl_create_qry() RETURNING g_oga.oga25
                   DISPLAY BY NAME g_oga.oga25
                   NEXT FIELD oga25
              WHEN INFIELD(oga27)
                   CALL cl_err('','axm-549',1)
              WHEN INFIELD(oga1002)
                   CALL cl_init_qry_var()
                   LET g_qryparam.arg1  = "20"
                   LET g_qryparam.form ="q_tqa1"
                   CALL cl_create_qry() RETURNING g_oga.oga1002
                   DISPLAY BY NAME g_oga.oga1002
                   NEXT FIELD oga1002
              WHEN INFIELD(oga1009)
                   CALL cl_init_qry_var()
                   LET g_qryparam.arg1  = "19"
                   LET g_qryparam.form ="q_tqa1"
                   CALL cl_create_qry() RETURNING g_oga.oga1009
                   DISPLAY BY NAME g_oga.oga1009
                   NEXT FIELD oga1009
              WHEN INFIELD(oga1016)
                   CALL cl_init_qry_var()
                   LET g_qryparam.form ="q_pmc8"
                   CALL cl_create_qry() RETURNING g_oga.oga1016
                   DISPLAY BY NAME g_oga.oga1016
                   NEXT FIELD oga1016
              WHEN INFIELD(oga1004)
                   CALL cl_init_qry_var()
                   LET g_qryparam.form ="q_occ5"
                   CALL cl_create_qry() RETURNING g_oga.oga1004
                   DISPLAY BY NAME g_oga.oga1004
                   NEXT FIELD oga1004
              WHEN INFIELD(oga1011)
                   CALL cl_init_qry_var()
                   LET g_qryparam.form ="q_occ7"     #No.TQC-640123
                   CALL cl_create_qry() RETURNING g_oga.oga1011
                   DISPLAY BY NAME g_oga.oga1011
                   NEXT FIELD oga1011
              WHEN INFIELD(oga1010)
                   CALL cl_init_qry_var()
                   LET g_qryparam.form ="q_tqb"
                   CALL cl_create_qry() RETURNING g_oga.oga1010
                   DISPLAY BY NAME g_oga.oga1010
                   NEXT FIELD oga1010
              WHEN INFIELD(oga18) #No.FUN-610064
                   CALL cl_init_qry_var()
                   LET g_qryparam.form ="q_occ6"     #No.TQC-640123
                   CALL cl_create_qry() RETURNING g_oga.oga18
                   DISPLAY BY NAME g_oga.oga18
                   NEXT FIELD oga18
              WHEN INFIELD(oga1003)
                   CALL cl_init_qry_var()
                   LET g_qryparam.form ="q_tqb"
                   CALL cl_create_qry() RETURNING g_oga.oga1003
                   DISPLAY BY NAME g_oga.oga1003
                   NEXT FIELD oga1003
#FUN-9B0132 add begin-----------------------------------
              WHEN INFIELD(oga902)
                   CALL cl_init_qry_var()
                   LET g_qryparam.form ="q_oak1"
                   LET g_qryparam.arg1 ="1"
                   CALL cl_create_qry() RETURNING g_oga.oga902
                   DISPLAY BY NAME g_oga.oga902
                   NEXT FIELD oga902
#FUN-9B0132 add -end------------------------------------
              WHEN INFIELD(oga84)                                                                                                   
                 CALL cl_init_qry_var()                                                                                             
                 LET g_qryparam.form ="q_azp"                                                                                      
                 LET g_qryparam.default1 = g_oga.oga84                                                                              
                 CALL cl_create_qry() RETURNING g_oga.oga84                                                                         
                 DISPLAY BY NAME g_oga.oga84                                                                                        
                 CALL t600_oga84('d')                                                                                               
                 NEXT FIELD oga84                                                                                                   
              WHEN INFIELD(oga86)                                                                                                   
                 CALL cl_init_qry_var()                                                                                             
                 LET g_qryparam.form ="q_tqa"                                                                                       
                 LET g_qryparam.default1 = g_oga.oga86                                                                              
                 LET g_qryparam.arg1='23'                                                                                           
                 CALL cl_create_qry() RETURNING g_oga.oga86    
                 DISPLAY BY NAME g_oga.oga86                                                                                        
                 NEXT FIELD oga86                                                                                                   
                 WHEN INFIELD(oga87)                  
                 CALL cl_init_qry_var()                    
                 LET g_qryparam.form ="q_lpj03_1"                    
                 LET g_qryparam.default1 = g_oga.oga87                  
                 LET g_qryparam.arg1=g_today                        
                 CALL cl_create_qry() RETURNING g_oga.oga87    
                 DISPLAY BY NAME g_oga.oga87                
                 NEXT FIELD oga87   

            END CASE

        ON ACTION CONTROLF                  #欄位說明
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name #Add on 040913
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang) #Add on 040913


        ON ACTION CONTROLZ
           CALL cl_show_req_fields()

        ON ACTION CONTROLG CALL cl_cmdask()

        AFTER INPUT
           IF INT_FLAG THEN
              LET g_success='N'
              RETURN
            END IF
           #MOD-AB0246---add---start---
            IF g_oga.oga09 ='2' AND g_oga.oga07 = 'Y' THEN 
               LET l_cnt = 0
               SELECT COUNT(*) INTO l_cnt FROM npp_file
                WHERE nppsys = 'AR'
                  AND npp00 = 1
                  AND npp01 = g_oga.oga01
                  AND npp011 = 1
               IF l_cnt > 0 THEN
                  UPDATE npp_file set npp02=g_oga.oga02
                   WHERE nppsys = 'AR'
                     AND npp00 = 1
                     AND npp01 = g_oga.oga01
                     AND npp011 = 1
               END IF
            END IF
           #MOD-AB0246---add---end---
          #xiaoyx 2013/1/15
       IF g_plant ='YLD001' THEN
           IF g_oga.oga65='Y' THEN
             CALL cl_err('','cxm-008',0)
             NEXT FIELD oga65
           END IF
       END IF
 #FUN-A60004 -------------------add start-----------------------------
            IF g_argv0 MATCHES '[12]' THEN #MOD-B10134 add
               IF g_oga.oga65 = 'Y' THEN                                            
                  IF cl_null(g_oga.oga72) THEN                                       
                     CALL cl_err('','aim-927',0)                                     
                     NEXT FIELD oga72                                                
                  END IF                                                             
               END IF
            END IF #MOD-B10134 add
 #FUN-A60004 ----------------add end----------------------------------
            CASE t600_i_inpchk()
               WHEN "oga1004" NEXT FIELD oga1004
               WHEN "oga08"   NEXT FIELD oga08
               WHEN "oga23"   NEXT FIELD oga23
               WHEN "oga21"   NEXT FIELD oga21
               WHEN "oga011"  NEXT FIELD oga011
               WHEN "oga00"   NEXT FIELD oga00		#MOD-980038 		
            END CASE

       ON IDLE g_idle_seconds
          CALL cl_on_idle()
          CONTINUE INPUT

      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121

      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
    END INPUT

END FUNCTION

FUNCTION t600_q()

    LET g_row_count = 0
    LET g_curs_index = 0
    CALL cl_navigator_setting( g_curs_index, g_row_count )
    INITIALIZE g_oga.* TO NULL               #No.FUN-6A0020
    CALL cl_msg("")
    CALL cl_opmsg('q')
    IF g_sma.sma120 = 'Y'  THEN
       #初始化界面的樣式(沒有任何默認屬性組)
       LET lg_oay22 = ''
       LET lg_group = ''
       CALL t600_refresh_detail()
    END IF
    DISPLAY '   ' TO FORMONLY.cnt
    CALL t600_cs()
    IF INT_FLAG THEN LET INT_FLAG = 0 INITIALIZE g_oga.* TO NULL RETURN END IF
    CALL cl_msg(" SEARCHING ! ")

    OPEN t600_cs                            # 從DB產生合乎條件TEMP(0-30秒)
    IF SQLCA.sqlcode THEN
       CALL cl_err('',SQLCA.sqlcode,0)      
       INITIALIZE g_oga.* TO NULL
    ELSE
       OPEN t600_count
       FETCH t600_count INTO g_row_count
       DISPLAY g_row_count TO FORMONLY.cnt
       CALL t600_fetch('F')                  # 讀出TEMP第一筆並顯示
    END IF
END FUNCTION

FUNCTION t600_fetch(p_flag)
DEFINE
    p_flag          LIKE type_file.chr1,                  #處理方式  #No.FUN-680137 VARCHAR(1)
    l_slip          LIKE oga_file.oga03  #No.FUN-680137 VARCHAR(10)  #No.TQC-650088

    CASE p_flag
        WHEN 'N' FETCH NEXT     t600_cs INTO g_oga.oga01  #TQC-9A0115  
        WHEN 'P' FETCH PREVIOUS t600_cs INTO g_oga.oga01  #TQC-9A0115
        WHEN 'F' FETCH FIRST    t600_cs INTO g_oga.oga01  #TQC-9A0115
        WHEN 'L' FETCH LAST     t600_cs INTO g_oga.oga01  #TQC-9A0115
        WHEN '/'
            IF (NOT mi_no_ask) THEN
                CALL cl_getmsg('fetch',g_lang) RETURNING g_msg
                LET INT_FLAG = 0  ######add for prompt bug
                PROMPT g_msg CLIPPED,': ' FOR g_jump
                   ON IDLE g_idle_seconds
                      CALL cl_on_idle()

      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121

      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121

      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121


                END PROMPT
                IF INT_FLAG THEN
                    LET INT_FLAG = 0
                    EXIT CASE
                END IF
            END IF
            LET mi_no_ask = FALSE
            FETCH ABSOLUTE g_jump t600_cs INTO g_oga.oga01  #TQC-9A0115
    END CASE

    IF SQLCA.sqlcode THEN
        CALL cl_err('',SQLCA.sqlcode,0)
        INITIALIZE g_oga.* TO NULL   #No.TQC-6B0105
        RETURN
    ELSE
       CASE p_flag
          WHEN 'F' LET g_curs_index = 1
          WHEN 'P' LET g_curs_index = g_curs_index - 1
          WHEN 'N' LET g_curs_index = g_curs_index + 1
          WHEN 'L' LET g_curs_index = g_row_count
          WHEN '/' LET g_curs_index = g_jump
       END CASE

       CALL cl_navigator_setting( g_curs_index, g_row_count )
    END IF
    SELECT * INTO g_oga.* FROM oga_file WHERE oga01 = g_oga.oga01   #TQC-9A0115
    IF SQLCA.sqlcode THEN
       CALL cl_err3("sel","oga_file",g_oga.oga01,"",SQLCA.sqlcode,"","",1)  #No.FUN-670008
       INITIALIZE g_oga.* TO NULL
       RETURN
    END IF
   #在使用Q查詢的情況下得到當前對應的屬性組oay22
   IF g_sma.sma120 = 'Y' AND g_sma.sma907 = 'Y' THEN
      LET l_slip = g_oga.oga01[1,g_doc_len]
      SELECT oay22 INTO lg_oay22 FROM oay_file
         WHERE oayslip = l_slip
   END IF
    LET g_data_owner = g_oga.ogauser      #FUN-4C0057 add
    LET g_data_group = g_oga.ogagrup      #FUN-4C0057 add
    LET g_data_plant = g_oga.ogaplant #FUN-980030
    CALL t600_show()
END FUNCTION

FUNCTION t600_b1()
DEFINE
    l_chk_res       LIKE type_file.num5,
    l_ac_t          LIKE type_file.num5,                #未取消的ARRAY CNT  #No.FUN-680137 SMALLINT
    l_row,l_col     LIKE type_file.num5,    #No.FUN-680137 SMALLINT            #分段輸入之行,列數
    l_lock_sw       LIKE type_file.chr1,                 #單身鎖住否  #No.FUN-680137 VARCHAR(1)
    p_cmd           LIKE type_file.chr1,                 #處理狀態  #No.FUN-680137 VARCHAR(1)
    l_b2            LIKE cob_file.cob08,   #No.FUN-680137 VARCHAR(30)
    l_misc          LIKE type_file.chr4,   #No.FUN-680137 VARCHAR(04)
    l_ima35         LIKE ima_file.ima35,   #MOD-5B0276
    l_ima36         LIKE ima_file.ima36,   #MOD-5B0276
    l_coc04         LIKE coc_file.coc04,   #No:MOD-4B0275
    l_last_plant    LIKE poy_file.poy04,
    l_max           LIKE tqw_file.tqw08,   #No.FUN-610064
    l_exit_sw       LIKE type_file.num5,   #No.FUN-680137 SMALLINT
    l_allow_insert  LIKE type_file.num5,   #可新增否  #No.FUN-680137 SMALLINT
    l_allow_delete  LIKE type_file.num5,   #可刪除否  #No.FUN-680137 SMALLINT
    l_oga55         LIKE oga_file.oga55
   DEFINE   l_imaag      LIKE ima_file.imaag    #No.TQC-650118
   DEFINE l_ogb12a  LIKE ogb_file.ogb12
   DEFINE l_ogb12b  LIKE ogb_file.ogb12
   DEFINE l_oeb25   LIKE oeb_file.oeb25
   DEFINE l_qty     LIKE ogb_file.ogb12
   DEFINE l_fac     LIKE ogb_file.ogb05_fac
   DEFINE l_tqn     RECORD LIKE tqn_file.*
   DEFINE l_ogb931   LIKE ogb_file.ogb931
   DEFINE l_ogb932   LIKE ogb_file.ogb932
   DEFINE l_pjb25    LIKE pjb_file.pjb25  #FUN-810045
   DEFINE g_cnt      LIKE type_file.num5  #FUN-7B0014
   DEFINE g_aza50    LIKE aza_file.aza50  #FUN-7B0014
   DEFINE l_pjb09    LIKE pjb_file.pjb09  #No.FUN-850027 
   DEFINE l_pjb11    LIKE pjb_file.pjb11  #No.FUN-850027
   DEFINE l_occ930 LIKE occ_file.occ930 #No.FUN-870007
   DEFINE lc_type  LIKE type_file.chr1  #No.FUN-870007
   DEFINE li_ret   LIKE type_file.num5  #No.FUN-870007
   DEFINE l_rth03  LIKE rth_file.rth03  #No.FUN-870007
   DEFINE l_rtz04  LIKE rtz_file.rtz04  #No.FUN-870007
   DEFINE l_rtz05  LIKE rtz_file.rtz05  #No.FUN-870007
   DEFINE l_rth04  LIKE rth_file.rth04  #No.FUN-870007
   DEFINE l_rtg05  LIKE rtg_file.rtg05  #No.FUN-870007
   DEFINE l_rtg08  LIKE rtg_file.rtg08  #No.FUN-870007
   DEFINE l_sale_price LIKE ogb_file.ogb13 #No.FUN-870007
   DEFINE l_bno      LIKE rvbs_file.rvbs08#CHI-9A0022
   DEFINE l_oeb49      LIKE oeb_file.oeb49 #FUN-9A0040
   DEFINE l_oeb50      LIKE oeb_file.oeb50 #FUN-9A0040
   DEFINE l_lnt54      LIKE lnt_file.lnt54 #FUN-9A0040
   DEFINE l_oea00    LIKE oea_file.oea00,  #FUN-9C0103
          l_oea11    LIKE oea_file.oea11,  #FUN-9C0103
          l_oea12    LIKE oea_file.oea12,  #FUN-9C0103
          l_oga16    LIKE oga_file.oga16   #FUN-9C0103
#   DEFINE l_ima151   LIKE ima_file.ima151  #FUN-A60035   #FUN-A60035 ---MARK
    DEFINE l_ima25   LIKE ima_file.ima25   #MOD-AC0070
   DEFINE l_ogc12_t  LIKE ogc_file.ogc12   #CHI-AC0034 add
   DEFINE l_del_flg  LIKE type_file.chr1   #FUN-B10024
   DEFINE ls_cnt     LIKE type_file.num5
#NO.120912 add----------------------begin
   DEFINE l_tj,l_tja,l_tjb,l_tjc,l_tjd,l_tje LIKE type_file.num15_3
   DEFINE l_moda,l_modb,l_modc,l_modd  LIKE type_file.num5
   DEFINE l_floora,l_floorb,l_floorc,l_floord LIKE type_file.num5
   DEFINE l_tc_obe RECORD LIKE tc_obe_file.*
   DEFINE l_sql STRING
   DEFINE l_stra,l_strb,l_strc,l_strd  STRING
#NO.120912 add------------------------end

    LET l_del_flg='N' #FUN-B10024
    #LET g_chr1 = 'N' #No.FUN-640074   #CHI-880006
    LET g_chr2 = '0'  #No.FUN-640074
    LET l_oea00 = ''  #No.FUN-9C0103 
    LET l_oea11 = ''  #No.FUN-9C0103
    LET l_oea12 = ''  #No.FUN-9C0103
    LET l_oga16 = ''  #No.FUN-9C0103

    LET g_action_choice = ""

    IF NOT t600_b1_chk() THEN
       RETURN
    ELSE
       LET l_oga55 = g_oga.oga55      #FUN-550050
       LET l_exit_sw = TRUE
    END IF
#FUN-B30012 --------------STA
    IF NOT t600_chk_ogb1001_2(g_oga.oga01) THEN
       CALL cl_err('','axm-667',0)
       RETURN
    END IF
#FUN-B30012 --------------END

    LET g_forupd_sql = "SELECT * FROM ogb_file ",
                       " WHERE ogb01= ? AND ogb03= ?  FOR UPDATE "
    LET g_forupd_sql = cl_forupd_sql(g_forupd_sql)
    DECLARE t600_bcl1 CURSOR FROM g_forupd_sql      # LOCK CURSOR
    IF g_prog = 'axmt610' OR g_prog = 'axmt620' THEN
       CALL t600_g_mix_order_b()
    END IF

    LET l_allow_insert = cl_detail_input_auth("insert")
    LET l_allow_delete = cl_detail_input_auth("delete")

    IF g_prog = 'axmp220' OR g_prog ='axmp220_icd' THEN         #No.TQC-970352
      LET l_allow_insert = FALSE
      LET l_allow_delete = FALSE
    END IF

    IF g_argv0 = '8' THEN
#      CALL cl_set_act_visible("select_order,mntn_serial_no,mntn_inv_detail,qry_inv_detail,qry_product_inventory",FALSE)   #CHI-B30093   #CHI-B60054 去掉CHI-B30093 mark
       CALL cl_set_act_visible("select_order,mntn_serial_no,qry_inv_detail,qry_product_inventory",FALSE)                   #CHI-B30093 #CHI-B60054 mark CHI-B30093更改
       LET l_allow_insert = FALSE
       LET l_allow_delete = FALSE   #MOD-990096
    END IF

  WHILE TRUE
    IF NOT l_exit_sw THEN CALL t600_b1_fill(' 1=1') END IF
    LET l_exit_sw = TRUE
    INPUT ARRAY g_ogb WITHOUT DEFAULTS FROM s_b1.*
          ATTRIBUTE(COUNT=g_rec_b1,MAXCOUNT=g_max_rec,UNBUFFERED,        #No.TQC-640123
                    INSERT ROW=l_allow_insert, DELETE ROW=l_allow_delete,
                    APPEND ROW=l_allow_insert)

        BEFORE INPUT
            IF g_rec_b1 != 0 THEN    #No.TQC-640123
               CALL fgl_set_arr_curr(l_ac)
            END IF
            IF g_argv0='1' THEN
               IF g_oaz.oaz81 = 'Y' THEN
                 CALL cl_set_act_visible("modi_lot", TRUE)
               ELSE
                 CALL cl_set_act_visible("modi_lot", FALSE)
               END IF
            END IF
            LET g_before_input_done = FALSE
            LET g_before_input_done = TRUE
            IF g_prog = 'axmp220' THEN
              CALL t600_set_act()
            END IF

        BEFORE ROW
            LET p_cmd = ''
            LET l_ac = ARR_CURR()
            LET l_lock_sw = 'N'                   #DEFAULT
            LET g_value = NULL
            LET g_ogb04 = NULL
            LET g_chr2  = '0'
            LET g_chr3  = '0'
            LET g_ogb[l_ac].ogb1005 ='1'
            IF g_rec_b1 < l_ac THEN   #新增的時候才賦預設值
               LET g_ogb[l_ac].ogb1012 ='N'
            END IF
            CALL t600_ogb1005_1()

            IF NOT cl_null(g_ogb[l_ac].ogb31) AND NOT cl_null(g_ogb[l_ac].ogb32) THEN
               CALL cl_set_comp_entry("ogb04,ogb05,ogb11,ogb1004,ogb13,ogb14,ogb14t,ogb916,ogb1003,ogb1004,ogb1006,ogb913,ogb910,ogb41,ogb42,ogb43" ,FALSE)  #FUN-810045 add ogb41-43 #MOD-930121 
            ELSE
               CALL cl_set_comp_entry("ogb1001,ogb04,ogb05,ogb11,ogb13,ogb14,ogb14t,ogb1003,ogb1004,ogb1006,ogb913,ogb910,ogb41,ogb42,ogb43" ,TRUE)     #FUN-810045 add ogb41-43   
            END IF
            LET l_ogb931 = NULL
            LET l_ogb932 = NULL
            SELECT ogb931,ogb932 INTO l_ogb931,l_ogb932
              FROM ogb_file
             WHERE ogb01 = g_oga.oga01
               AND ogb03 = g_ogb[l_ac].ogb03
            IF g_sma.sma128 = 'Y' AND g_sma.sma115 !='Y' AND
               NOT cl_null(l_ogb931) AND NOT cl_null(l_ogb932) THEN
                   CALL cl_set_comp_entry("ogb04,ogb05,ogb31,ogb32,ogb12" ,FALSE)
            ELSE
                   CALL cl_set_comp_entry("ogb04,ogb05,ogb31,ogb32,ogb12" ,TRUE)
            END IF

            BEGIN WORK
            CALL t600_b1_chk_2() RETURNING l_chk_res,l_lock_sw
            IF NOT l_chk_res THEN
               ROLLBACK WORK
               RETURN
            END IF
            IF g_rec_b1 >= l_ac THEN      #No.TQC-640123
               LET p_cmd='u'
               #add by huyx110916---start---
               IF g_argv0='1' THEN
                  LET g_ogb[l_ac].ogbud09=g_ogb[l_ac].ogb12-g_ogb[l_ac].ogbud07-g_ogb[l_ac].ogbud08   #Add by zm 100126
               END IF
               IF g_argv0='8' THEN
                  SELECT ogb12-ogbud07-ogbud08 INTO g_ogb[l_ac].ogbud09 FROM ogb_file
                   WHERE ogb01=g_oga.oga011 AND ogb03=g_ogb[l_ac].ogb03  
               END IF
               #add by huyx110916---end---
            END IF
            CALL t600_set_no_required_b1('')   #CHI-8C0013
            CALL t600_set_required_b1('')   #CHI-8C0013
            IF g_azw.azw04="2" THEN                                                                                               
               CALL t600_set_entry_b1(p_cmd)                                                                                       
               CALL t600_set_no_entry_b1(p_cmd)                                                                                
            END IF
#FUN-AA0057--add--begin
        IF g_azw.azw04 = '2' THEN
           IF NOT cl_null(g_ogb[l_ac].ogb31) OR NOT cl_null(g_ogb[l_ac].ogb32) THEN
               CALL cl_set_comp_entry("ogb48",FALSE)
               SELECT oeb49, oeb50 INTO l_oeb49,l_oeb50
               FROM oeb_file WHERE oeb01 = g_ogb[l_ac].ogb31 AND oeb03 = g_ogb[l_ac].ogb32 AND oebplant = g_oga.oga83
               LET  g_ogb[l_ac].ogb48 = l_oeb49
               LET  g_ogb[l_ac].ogb49 = l_oeb50
               IF NOT  cl_null(g_ogb[l_ac].ogb48) AND NOT cl_null(g_ogb[l_ac].ogb49) THEN
                 LET g_cnt = 0        #MOD-AB0247 add
                 SELECT COUNT(*) INTO g_cnt
                 FROM lnt_file WHERE lnt04 = g_ogb[l_ac].ogb49 AND lnt06 = g_ogb[l_ac].ogb48 AND lntplant = g_oga.oga83
                                    AND lnt26 = 'Y' AND (g_oga.oga02 BETWEEN lnt17 AND lnt18)

                  IF g_cnt = 0 THEN
                    CALL cl_err('','axm_609',0)
                    NEXT FIELD ogb31
                 END IF
                  SELECT lnt54  INTO l_lnt54
                  FROM lnt_file
                  WHERE lnt04 = g_ogb[l_ac].ogb49 AND lnt06 = g_ogb[l_ac].ogb48
                  AND lntplant = g_oga.oga83 AND lnt26 = 'Y' AND g_oga.oga02 BETWEEN lnt17 AND lnt18
                  IF  g_oga.oga57 != l_lnt54 THEN
                     CALL cl_err('','axm_611',0)
                  END IF
               END IF
           END IF
         # ELSE
           IF cl_null(g_ogb[l_ac].ogb31) AND cl_null(g_ogb[l_ac].ogb32) THEN
               CALL cl_set_comp_entry("ogb48",TRUE)
                IF NOT  cl_null(g_ogb[l_ac].ogb48) AND NOT cl_null(g_ogb[l_ac].ogb49) THEN
                   LET g_cnt = 0        #MOD-AB0247 add
                   SELECT COUNT(*) INTO g_cnt
                   FROM lnt_file
                   WHERE lnt04 = g_ogb[l_ac].ogb49 AND lnt06 = g_ogb[l_ac].ogb48 AND lntplant = g_oga.oga83
                   AND lnt26 = 'Y' AND g_oga.oga02 BETWEEN lnt17 AND lnt18
                   IF g_cnt = 0 THEN
                      CALL cl_err('','axm_609',0)
                      NEXT FIELD ogb48
                   END IF
                END IF
            END IF
#FUN-AC0097--add--begin 
            IF cl_null(g_ogb[l_ac].ogb48) THEN 
               LET g_ogb[l_ac].ogb49 = ''  
            END IF                                                                                                              
#FUN-AC0097--add--end
         END IF

#FUN-AA0057--add--end
        BEFORE INSERT
            LET p_cmd='a'
            INITIALIZE g_ogb[l_ac].* TO NULL      #900423
            INITIALIZE arr_detail[l_ac].* TO NULL     #No.TQC-650088
            CALL t600_b1_default(p_cmd)
            NEXT FIELD ogb03

        AFTER INSERT
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               LET g_flag2 = '1'   #CHI-920012
               CANCEL INSERT
            END IF
           #MOD-AB0247---add---start---
            LET g_cnt = 0
            SELECT COUNT(*) INTO g_cnt FROM ogb_file WHERE ogb01=g_oga.oga01
            LET g_cnt = g_cnt + 1
            IF (g_oga.oga08='1' AND g_cnt > g_oaz.oaz691) OR
               (g_oga.oga08 MATCHES '[23]' AND g_cnt > g_oaz.oaz692) THEN
               CALL cl_err('','axm-156',1)
               CANCEL INSERT
               NEXT FIELD ogb03
            END IF
           #MOD-AB0247---add---end---

            CASE t600_b1_inschk()
               WHEN "ogb03" 
                  NEXT FIELD ogb03
               WHEN "ogb904"
                  NEXT FIELD ogb904
               WHEN "ogb65"
                  NEXT FIELD ogb65
               OTHERWISE
            END CASE

            #IF 有專案且要做預算控管，check料件， if 沒做批號管理也沒做序號管理，則要寫入rvbs_file
            IF g_prog <> 'axmt628' AND g_prog<>'axmt629' THEN  #axmt628/629不處理rvbs
              LET g_success = 'Y'
              IF s_chk_rvbs(g_ogb[l_ac].ogb41,g_ogb[l_ac].ogb04) THEN
                 CALL t600_rvbs()
              END IF
              IF g_success = 'N' THEN
                 CANCEL INSERT
                 NEXT FIELD ogb03
              END IF
            END IF


            IF NOT t600_b1_ins() THEN
               ROLLBACK WORK
               CANCEL INSERT
            ELSE
               CALL cl_msg('INSERT O.K')
               LET l_oga55 = '0'          #FUN-550050
               CALL t600_mlog('A')
               LET g_rec_b1=g_rec_b1+1         #No.TQC-640123
               DISPLAY g_rec_b1 TO FORMONLY.cn2
               IF g_aza.aza50='Y' THEN
                  CALL t600_oga50_sum()  #No.FUN-610064
               ELSE
                  CALL t600_bu()
               END IF
               COMMIT WORK
            END IF


        BEFORE FIELD ogb03                            #default 序號
            CALL t600_bef_ogb03()

        AFTER FIELD ogb03                        #check 序號是否重複
            IF NOT t600_chk_ogb03() THEN
               NEXT FIELD CURRENT
            END IF
            IF g_ogb[l_ac].ogb03<=0 THEN
               CALL cl_err(g_ogb[l_ac].ogb03,'aim-223',0)
               LET g_ogb[l_ac].ogb03=g_ogb_t.ogb03
               DISPLAY BY NAME g_ogb[l_ac].ogb03
               NEXT FIELD ogb03
            END IF

        BEFORE FIELD ogb31
           IF (g_ogb[l_ac].ogb31!=g_ogb_t.ogb31 OR g_ogb_t.ogb31 IS NULL) THEN   #MOD-9A0187
              CALL t600_set_entry_b1('s')  #TQC-7C0131
           END IF   #MOD-9A0187

        AFTER FIELD ogb31
     
        
           IF (g_ogb[l_ac].ogb31!=g_ogb_t.ogb31 OR g_ogb_t.ogb31 IS NULL) THEN          #NO.MOD-740415
               IF NOT t600_chk_ogb31(p_cmd) THEN
                   NEXT FIELD CURRENT
               END IF
               #No.MOD-A60112  --Begin
               IF NOT t600_chk_oea() THEN
                   NEXT FIELD CURRENT
               END IF
               #No.MOD-A60112  --End  
               IF NOT cl_null(g_ogb[l_ac].ogb32) THEN
               CASE t600_chk_ogb32(p_cmd)
                  WHEN "ogb31" NEXT FIELD ogb31
                  WHEN "ogb32" NEXT FIELD ogb32              
               END CASE
               END IF
           END IF          #no.MOD-740415

        AFTER FIELD ogb32
#FUN-A60035 ---MARK BEGIN
##FUN-A50054 --Begin
#&ifdef SLK
##          IF s_industry("slk") THEN
#             IF p_cmd='a' OR g_ogb[l_ac].ogb31!=g_ogb_t.ogb31
#                          OR g_ogb[l_ac].ogb32!=g_ogb_t.ogb32 THEN
#                DROP TABLE x
#                SELECT * FROM ata_file
#                 WHERE ata00='axmt410_slk'
#                   AND ata01=g_ogb[l_ac].ogb31
#                   AND ata02=g_ogb[l_ac].ogb32
#                INTO TEMP x
#                UPDATE x SET ata00=g_prog,
#                             ata01=g_oga.oga01,
#                             ata02=g_ogb[l_ac].ogb03
#                INSERT INTO ata_file
#                     SELECT * FROM x
#             END IF
##          END IF
#&endif
##FUN-A50054 --End
#FUN-A60035 ---MARK END
           IF cl_null(g_ogb[l_ac].ogb32) THEN
              IF NOT cl_null(g_ogb[l_ac].ogb31) THEN
                 CALL cl_err('','atm-243',0)
                 NEXT FIELD ogb31
              END IF
           END IF
           #No.MOD-A60112  --Begin
           IF NOT t600_chk_oea() THEN
               NEXT FIELD CURRENT
           END IF
           #No.MOD-A60112  --End 
    #No.FUN-A90040  --begin      
      IF g_azw.azw04 = '2' THEN  
           IF NOT cl_null(g_ogb[l_ac].ogb31) OR NOT cl_null(g_ogb[l_ac].ogb32) THEN
               CALL cl_set_comp_entry("ogb48",FALSE) 
               SELECT oeb49, oeb50 INTO l_oeb49,l_oeb50
               FROM oeb_file WHERE oeb01 = g_ogb[l_ac].ogb31 AND oeb03 = g_ogb[l_ac].ogb32 AND oebplant = g_oga.oga83
               LET  g_ogb[l_ac].ogb48 = l_oeb49 
               LET  g_ogb[l_ac].ogb49 = l_oeb50
               IF NOT  cl_null(g_ogb[l_ac].ogb48) AND NOT cl_null(g_ogb[l_ac].ogb49) THEN
                 LET g_cnt = 0        #MOD-AB0247 add
                 SELECT COUNT(*) INTO g_cnt 
                 FROM lnt_file WHERE lnt04 = g_ogb[l_ac].ogb49 AND lnt06 = g_ogb[l_ac].ogb48 AND lntplant = g_oga.oga83
                                    AND lnt26 = 'Y' AND (g_oga.oga02 BETWEEN lnt17 AND lnt18)

                  IF g_cnt = 0 THEN
                    CALL cl_err('','axm_609',0)
                    NEXT FIELD ogb31
                 END IF
                  SELECT lnt54  INTO l_lnt54
                  FROM lnt_file
                  WHERE lnt04 = g_ogb[l_ac].ogb49 AND lnt06 = g_ogb[l_ac].ogb48
                  AND lntplant = g_oga.oga83 AND lnt26 = 'Y' AND g_oga.oga02 BETWEEN lnt17 AND lnt18
                  IF  g_oga.oga57 != l_lnt54 THEN
                     CALL cl_err('','axm_611',0)
                  END IF
               END IF
           END IF
        #  ELSE
           IF cl_null(g_ogb[l_ac].ogb31) AND cl_null(g_ogb[l_ac].ogb32) THEN
               CALL cl_set_comp_entry("ogb48",TRUE) 
                IF NOT  cl_null(g_ogb[l_ac].ogb48) AND NOT cl_null(g_ogb[l_ac].ogb49) THEN
                   LET g_cnt = 0        #MOD-AB0247 add
                   SELECT COUNT(*) INTO g_cnt 
                   FROM lnt_file 
                   WHERE lnt04 = g_ogb[l_ac].ogb49 AND lnt06 = g_ogb[l_ac].ogb48 AND lntplant = g_oga.oga83
                   AND lnt26 = 'Y' AND g_oga.oga02 BETWEEN lnt17 AND lnt18
                   IF g_cnt = 0 THEN
                      CALL cl_err('','axm_609',0)
                      NEXT FIELD ogb48
                   END IF
                END IF
            END IF
     END IF  
   #No.FUN-A90040  --end          
           IF NOT cl_null(g_ogb[l_ac].ogb31) AND NOT cl_null(g_ogb[l_ac].ogb32) THEN
              CALL cl_set_comp_entry("ogb04,ogb05,ogb11,ogb1004,ogb13,ogb14,ogb14t,ogb916,ogb1003,ogb1004,ogb1006,ogb913,ogb910,ogb41,ogb42,ogb43" ,FALSE)  #FUN-810045 ogb41~43 #MOD-930121 
           ELSE
              CALL cl_set_comp_entry("ogb1001,ogb04,ogb05,ogb11,ogb13,ogb14,ogb14t,ogb1001,ogb1003,ogb1004,ogb1006,ogb913,ogb910,ogb41,ogb42,ogb43" ,TRUE)   #No.TQC-640123 #FUN-810045 ogb41~43 
           END IF
           IF (g_ogb[l_ac].ogb32!=g_ogb_t.ogb32 OR g_ogb_t.ogb32 IS NULL) THEN
               CASE t600_chk_ogb32(p_cmd)
                  WHEN "ogb31" NEXT FIELD ogb31
                  WHEN "ogb32" NEXT FIELD ogb32
               END CASE
           END IF
           #5.1新功能增加  返利改善 ..begin
           SELECT aza50 INTO g_aza50 FROM aza_file
           IF g_aza50 = 'Y' THEN
              LET g_cnt = 0        #MOD-AB0247 add
              SELECT COUNT(*) INTO g_cnt FROM oeb_file
               WHERE oeb01 = g_ogb[l_ac].ogb31 and oeb03 = g_ogb[l_ac].ogb32
                 AND (oeb935 IS NOT NULL) AND (oeb936 IS NOT NULL) AND g_ogb[l_ac].ogb1012 = 'Y'
                 IF g_cnt > 0 THEN
                    CALL cl_err('','axm-083',0)
                    NEXT FIELD ogb32
                 END IF
           END IF

           CALL t600_set_no_entry_b1(p_cmd)
#FUN-A60035 ---MARK BEGIN
##FUN-A50054 --Begin
#&ifdef SLK
##          IF s_industry("slk") THEN
#             IF p_cmd='a' OR g_ogb[l_ac].ogb31!=g_ogb_t.ogb31
#                          OR g_ogb[l_ac].ogb32!=g_ogb_t.ogb32 THEN
#                SELECT DISTINCT(ata05) INTO g_ogb[l_ac].ogb04
#                  FROM ata_file
#                 WHERE ata00=g_prog
#                   AND ata01=g_oga.oga01
#                   AND ata02=g_ogb[l_ac].ogb03
#             END IF
#             SELECT ima151 INTO l_ima151 FROM ima_file WHERE ima01= g_ogb[l_ac].ogb04      #NO.FUN-A60035 add 
#             IF NOT cl_null(g_ogb[l_ac].ogb32 AND g_sma.sma120='Y' AND l_ima151='Y') THEN  #NO.FUN-A60035 mod
#                CALL s_detail(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,g_ogb[l_ac].ogb04,'N')
#                       RETURNING g_ogb[l_ac].ogb12
#             END IF
##          END IF
#&endif
##FUN-A50054 --End
#FUN-A60035 ---MARK END
#FUN-AA0057--add--begin
        AFTER FIELD ogb48,ogb49
        IF g_azw.azw04 = '2' THEN 
          IF NOT  cl_null(g_ogb[l_ac].ogb48)  THEN
#FUN-AC0097--add--begin
             SELECT lnt04 INTO g_ogb[l_ac].ogb49 
             FROM lnt_file WHERE  lnt06 = g_ogb[l_ac].ogb48 AND lntplant = g_oga.oga83
                                AND lnt26 = 'Y' AND (g_oga.oga02 BETWEEN lnt17 AND lnt18)            
#FUN-AC0097--add--end 
             LET g_cnt = 0        #MOD-AB0247 add
             SELECT COUNT(*) INTO g_cnt
             FROM lnt_file WHERE lnt04 = g_ogb[l_ac].ogb49 AND lnt06 = g_ogb[l_ac].ogb48 AND lntplant = g_oga.oga83
                           AND lnt26 = 'Y' AND (g_oga.oga02 BETWEEN lnt17 AND lnt18)
             IF g_cnt = 0 THEN
                CALL cl_err('','axm_609',0)
                NEXT FIELD ogb48
             END IF
              SELECT lnt54  INTO l_lnt54
              FROM lnt_file
              WHERE lnt04 = g_ogb[l_ac].ogb49 AND lnt06 = g_ogb[l_ac].ogb48
              AND lntplant = g_oga.oga83 AND lnt26 = 'Y' AND g_oga.oga02 BETWEEN lnt17 AND lnt18
             IF  g_oga.oga57 != l_lnt54 THEN
                CALL cl_err('','axm_611',0)
             END IF
#TQC-B40101 --begin--
          ELSE
             IF g_oga.oga57 = '2' THEN 
                NEXT FIELD ogb48
            END IF 
#TQC-B40101 --end--
          END IF
#FUN-AC0097--add--begin 
          IF cl_null(g_ogb[l_ac].ogb48) THEN 
             LET g_ogb[l_ac].ogb49 = ''  
          END IF                                                                                                              
#FUN-AC0097--add--end
       END IF
#FUN-AA0057--add--end
        BEFORE FIELD ogb04
           #LET g_chr1 = 'N'  #No.FUN-640074   #CHI-880006
            CALL t600_set_entry_b1('') #MOD-530374
           CALL t600_set_no_required_b1('')

        AFTER FIELD ogb1001
           IF NOT t600_chk_ogb1001(p_cmd) THEN
              NEXT FIELD CURRENT
           END IF

        AFTER FIELD ogb65
           IF NOT cl_null(g_ogb[l_ac].ogb65)THEN
              CALL t600_chk_ogb65('a')
              IF NOT cl_null(g_errno) THEN 
                 CALL cl_err('',g_errno,1)
                NEXT FIELD ogb65
              END IF   
           END IF

        BEFORE FIELD ogb1005
           CALL t600_set_entry_b1(p_cmd)
           CALL t600_set_no_required_b1(p_cmd)
           CALL cl_set_comp_entry("ogb1001,ogb04,ogb05,ogb11,ogb13,ogb14,ogb14t,ogb1001,ogb1003,ogb1006,ogb913,ogb910" ,TRUE)   #No.TQC-640123
           IF NOT cl_null(g_oga.oga16) THEN
              LET g_ogb[l_ac].ogb31 = g_oga.oga16
           END IF
           CALL cl_set_comp_required("ogb31,ogb32",FALSE)

        AFTER FIELD ogb1006
           IF NOT cl_null(g_ogb[l_ac].ogb1006) THEN
              IF g_ogb[l_ac].ogb1006 <=0 OR g_ogb[l_ac].ogb1006 >100 THEN
                 CALL cl_err('','atm-384',1)
                 NEXT FIELD CURRENT
              END IF
              IF (g_ogb[l_ac].ogb1006!=g_ogb_t.ogb1006 OR g_ogb_t.ogb1006 IS NULL) THEN   #No.FUN-610064
                 CALL t600_ogb14()
                 IF g_aza.aza50='Y' THEN
                    CALL t600_oga50_sum()
                 END IF
              END IF   #No.FUN-610064
           END IF

        AFTER FIELD ogb04
           #AFTER FIELD 處理邏輯修改為使用下面的函數來進行判斷，請參考相關代碼
#FUN-AA0059 ---------------------start----------------------------
            IF NOT cl_null(g_ogb[l_ac].ogb04) THEN
               IF NOT s_chk_item_no(g_ogb[l_ac].ogb04,"") THEN
                  CALL cl_err('',g_errno,1)
                  LET g_ogb[l_ac].ogb04= g_ogb_t.ogb04
                  NEXT FIELD ogb04
               END IF
            END IF
#FUN-AA0059 ---------------------end-------------------------------
           CALL t600_check_ogb04('ogb04',l_ac,p_cmd) RETURNING         #MOD-660090
                 l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
           IF NOT l_chk_res THEN
              NEXT FIELD CURRENT
           END IF
           IF NOT s_chkima08(g_ogb[l_ac].ogb04) THEN
              NEXT FIELD CURRENT
           END IF
#FUN-A60035 ---MARK BEGIN
##FUN-A50054 --Begin
#&ifdef SLK
##          IF NOT s_industry("slk") THEN
#             SELECT imaag INTO l_imaag FROM ima_file
#              WHERE ima01 =g_ogb[l_ac].ogb04
#             IF NOT CL_null(l_imaag) AND l_imaag <> '@CHILD' THEN
#                CALL cl_err(g_ogb[l_ac].ogb04,'aim1004',0)
#                NEXT FIELD CURRENT
#             END IF
##          END IF
#&endif
##FUN-A50054 --End
#FUN-A60035 ---MARK END
#FUN-A60035 ---MARK BEGIN
##FUN-A50054 --Begin
#&ifdef SLK
##       IF s_industry("slk") THEN
#          IF NOT cl_null(g_ogb[l_ac].ogb04) AND cl_null(g_ogb[l_ac].ogb32) THEN
#             CALL s_detail(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,g_ogb[l_ac].ogb04,'N')
#                 RETURNING g_ogb[l_ac].ogb12
#          END IF
##       END IF
#&endif 
##FUN-A50054 --End
#FUN-A60035 ---MARK END

        #當sma908 <> 'Y'的時候,即不准通過單身來新增子料件,這時
        #對于采用料件多屬性新機制(與單據性質綁定)的分支來說,各個明細屬性欄位都
        #變NOENTRY的, 只能通過在母料件欄位開窗來選擇子料件,并且母料件本身也不允許
        #接受輸入,而只能開窗,所以這里要進行一個特殊的處理,就是一進att00母料件
        #欄位的時候就auto開窗,開完窗之后直接NEXT FIELD以避免用戶亂動
        #其他分支就不需要這么麻煩了
        BEFORE FIELD att00
           CALL t600_bef_att00()
           CALL t600_check_ogb04('imx00',l_ac,p_cmd) RETURNING    #MOD-660090
             l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
           IF NOT l_chk_res THEN NEXT FIELD att00 END IF

        #  以下是為料件多屬性機制新增的20個屬性欄位的AFTER FIELD代碼
        #下面是十個輸入型屬性欄位的判斷語句
        AFTER FIELD att00
            #檢查att00里面輸入的母料件是否是符合對應屬性組的母料件
            LET g_cnt=0
            SELECT COUNT(ima01) INTO g_cnt FROM ima_file
              WHERE ima01 = g_ogb[l_ac].att00 AND imaag = lg_oay22
            IF g_cnt = 0 THEN
               CALL cl_err_msg('','aim-909',lg_oay22,0)
               NEXT FIELD att00
            END IF

            LET g_ogb04 = g_ogb[l_ac].att00  #No.TQC-640171

            CALL t600_check_ogb04('imx00',l_ac,p_cmd) RETURNING    #MOD-660090
              l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
            IF NOT l_chk_res THEN NEXT FIELD att00 END IF

        AFTER FIELD att01
            CALL t600_check_att0x(g_ogb[l_ac].att01,1,l_ac,p_cmd) RETURNING     #MOD-660090
                 l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
            IF NOT l_chk_res THEN NEXT FIELD att01 END IF
        AFTER FIELD att02
            CALL t600_check_att0x(g_ogb[l_ac].att02,1,l_ac,p_cmd) RETURNING     #MOD-660090
                 l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
            IF NOT l_chk_res THEN NEXT FIELD att02 END IF
        AFTER FIELD att03
            CALL t600_check_att0x(g_ogb[l_ac].att03,3,l_ac,p_cmd) RETURNING     #MOD-660090
                 l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
            IF NOT l_chk_res THEN NEXT FIELD att03 END IF
        AFTER FIELD att04
            CALL t600_check_att0x(g_ogb[l_ac].att04,4,l_ac,p_cmd) RETURNING     #MOD-660090
                 l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
            IF NOT l_chk_res THEN NEXT FIELD att04 END IF
        AFTER FIELD att05
            CALL t600_check_att0x(g_ogb[l_ac].att05,5,l_ac,p_cmd) RETURNING     #MOD-660090
                 l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
            IF NOT l_chk_res THEN NEXT FIELD att05 END IF
        AFTER FIELD att06
            CALL t600_check_att0x(g_ogb[l_ac].att06,6,l_ac,p_cmd) RETURNING     #MOD-660090
                 l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
            IF NOT l_chk_res THEN NEXT FIELD att06 END IF
        AFTER FIELD att07
            CALL t600_check_att0x(g_ogb[l_ac].att07,7,l_ac,p_cmd) RETURNING     #MOD-660090
                 l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
            IF NOT l_chk_res THEN NEXT FIELD att07 END IF
        AFTER FIELD att08
            CALL t600_check_att0x(g_ogb[l_ac].att08,8,l_ac,p_cmd) RETURNING     #MOD-660090
                 l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
            IF NOT l_chk_res THEN NEXT FIELD att08 END IF
        AFTER FIELD att09
            CALL t600_check_att0x(g_ogb[l_ac].att09,9,l_ac,p_cmd) RETURNING     #MOD-660090
                 l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
            IF NOT l_chk_res THEN NEXT FIELD att09 END IF
        AFTER FIELD att10
            CALL t600_check_att0x(g_ogb[l_ac].att10,10,l_ac,p_cmd) RETURNING     #MOD-660090
                 l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
            IF NOT l_chk_res THEN NEXT FIELD att10 END IF
        #下面是十個輸入型屬性欄位的判斷語句
        AFTER FIELD att01_c
            CALL t600_check_att0x_c(g_ogb[l_ac].att01_c,1,l_ac,p_cmd) RETURNING     #MOD-660090
                 l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
            IF NOT l_chk_res THEN NEXT FIELD att01_c END IF
        AFTER FIELD att02_c
            CALL t600_check_att0x_c(g_ogb[l_ac].att02_c,1,l_ac,p_cmd) RETURNING     #MOD-660090
                 l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
            IF NOT l_chk_res THEN NEXT FIELD att02_c END IF
        AFTER FIELD att03_c
            CALL t600_check_att0x_c(g_ogb[l_ac].att03_c,1,l_ac,p_cmd) RETURNING     #MOD-660090
                 l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
            IF NOT l_chk_res THEN NEXT FIELD att03_c END IF
        AFTER FIELD att04_c
            CALL t600_check_att0x_c(g_ogb[l_ac].att04_c,4,l_ac,p_cmd) RETURNING     #MOD-660090
                 l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
            IF NOT l_chk_res THEN NEXT FIELD att04_c END IF
        AFTER FIELD att05_c
            CALL t600_check_att0x_c(g_ogb[l_ac].att05_c,5,l_ac,p_cmd) RETURNING     #MOD-660090
                 l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
            IF NOT l_chk_res THEN NEXT FIELD att05_c END IF
        AFTER FIELD att06_c
            CALL t600_check_att0x_c(g_ogb[l_ac].att06_c,6,l_ac,p_cmd) RETURNING     #MOD-660090
                 l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
            IF NOT l_chk_res THEN NEXT FIELD att06_c END IF
        AFTER FIELD att07_c
            CALL t600_check_att0x_c(g_ogb[l_ac].att07_c,7,l_ac,p_cmd) RETURNING     #MOD-660090
                 l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
            IF NOT l_chk_res THEN NEXT FIELD att07_c END IF
        AFTER FIELD att08_c
            CALL t600_check_att0x_c(g_ogb[l_ac].att08_c,8,l_ac,p_cmd) RETURNING     #MOD-660090
                 l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
            IF NOT l_chk_res THEN NEXT FIELD att08_c END IF
        AFTER FIELD att09_c
            CALL t600_check_att0x_c(g_ogb[l_ac].att09_c,9,l_ac,p_cmd) RETURNING     #MOD-660090
                 l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
            IF NOT l_chk_res THEN NEXT FIELD att09_c END IF
        AFTER FIELD att10_c
            CALL t600_check_att0x_c(g_ogb[l_ac].att10_c,10,l_ac,p_cmd) RETURNING     #MOD-660090
                 l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
            IF NOT l_chk_res THEN NEXT FIELD att10_c END IF

        AFTER FIELD ogb092
           IF NOT t600_chk_ogb092() THEN
              NEXT FIELD ogb09
           END IF

        BEFORE FIELD ogb19
           CALL t600_bef_ogb19()

        BEFORE FIELD ogb17
           IF cl_null(g_ogb[l_ac].ogb17) THEN
              LET g_ogb[l_ac].ogb17 = 'N'
           END IF
            CALL t600_set_entry_b1('')   #No:MOD-570264

        AFTER FIELD ogb17
           IF NOT t600_chk_ogb17(p_cmd) THEN
              NEXT FIELD CURRENT
           END IF

        AFTER FIELD ogb09
   #xiaoyx,当无库存时，直接提示是否要新增仓库.
  SELECT COUNT(*) INTO ls_cnt FROM img_file
   WHERE img01=g_ogb[l_ac].ogb04
   AND img02=g_ogb[l_ac].ogb09
 #  AND img03=g_ogb[l_ac].ogb091 
 #  AND img04=g_ogb[l_ac].ogb092
 #储位批号暂不虑，因为会跳出
 IF ls_cnt IS NULL THEN LET ls_cnt=0 END IF
 IF ls_cnt=0 THEN 
 CALL s_add_img(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                 g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                  g_oga.oga01,g_ogb[l_ac].ogb03,g_oga.oga02)
  END IF
 #---xiao end 
           IF NOT t600_chk_ogb09() THEN
              NEXT FIELD CURRENT
           END IF

       AFTER FIELD ogb05
          #IF NOT t600_chk_ogb05() THEN      #FUN-AC0012
           IF NOT t600_chk_ogb05(p_cmd) THEN #FUN-AC0012
              NEXT FIELD CURRENT
           END IF
           #-----MOD-AC0070---------
           SELECT ima25 INTO l_ima25 FROM ima_file
             WHERE ima01 = g_ogb[l_ac].ogb04
           CALL s_umfchk(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb05,l_ima25)
                 RETURNING g_cnt,g_factor
           IF g_cnt = 1 THEN
              LET g_factor = 1
           END IF
           LET b_ogb.ogb05_fac = g_factor
           #-----END MOD-AC0070----- 

       BEFORE FIELD ogb12
           IF NOT cl_null(g_ogb[l_ac].ogb12) THEN
              LET g_ogb_t.ogb12 = g_ogb[l_ac].ogb12
           END IF

       AFTER FIELD ogb12
    #xiaoyx  --begin
    SELECT img10 INTO g_ogb[l_ac].ogbud02
        FROM img_file
        WHERE img01=g_ogb[l_ac].ogb04 AND img02=g_ogb[l_ac].ogb09
           AND img03=g_ogb[l_ac].ogb091 AND img04=g_ogb[l_ac].ogb092
         DISPLAY BY NAME g_ogb[l_ac].ogbud02
     #xiaoyx --end
          #IF NOT t600_chk_ogb12() THEN      #FUN-AC0012
              IF NOT t600_chk_ogb12(p_cmd) THEN #FUN-AC0012
                 NEXT FIELD CURRENT
              END IF
           LET g_ima918 = ''   #MOD-9C0055
           LET g_ima921 = ''   #MOD-9C0055
           SELECT ima918,ima921 INTO g_ima918,g_ima921 
             FROM ima_file
            WHERE ima01 = g_ogb[l_ac].ogb04
              AND imaacti = "Y"
           
           IF (g_ima918 = "Y" OR g_ima921 = "Y") AND 
              (cl_null(g_ogb_t.ogb12) OR (g_ogb[l_ac].ogb12<>g_ogb_t.ogb12 )) THEN
              #非多倉儲出貨才可查詢批/序號資料
              IF g_ogb[l_ac].ogb17 = "N" THEN   #No:FUN-870131
                 IF g_argv0 ='1' OR g_argv0 ='5' THEN  #出通要判斷 oaz81  #MOD-940294 add
                    IF g_oaz.oaz81 = 'Y' THEN
                       CALL t600_b1_move_back()
                       CALL t600_b_else()
#No.CHI-9A0022 --Begin
                       IF cl_null(g_ogb[l_ac].ogb41) THEN
                          #FUN-9C0103 ---start---
                          SELECT oea00,oea11,oea12 INTO l_oea00,l_oea11,l_oea12
                            FROM oea_file
                           WHERE oea01 = g_ogb[l_ac].ogb31
                          IF l_oea00 = '4' AND l_oea11 = '7' THEN
                             SELECT oga16 INTO l_oga16
                               FROM oga_file
                              WHERE oga01 = l_oea12
                             LET l_bno = l_oga16
                          ELSE
                          #FUN-9C0103 ---end---
                             LET l_bno = g_ogb[l_ac].ogb31
                          END IF 
                       ELSE
                          LET l_bno = g_ogb[l_ac].ogb41
                       END IF
#No.CHI-9A0022 --End
                       CALL s_lotout(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,0,
                                     g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                                     g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                                     g_ogb[l_ac].ogb05,b_ogb.ogb15,b_ogb.ogb15_fac,
                                     g_ogb[l_ac].ogb12,l_bno,'MOD')#CHI-9A0022
                           RETURNING l_r,g_qty
                       IF l_r = "Y" THEN
                          LET g_ogb[l_ac].ogb12 = g_qty
                          DISPLAY BY NAME g_ogb[l_ac].ogb12   #MOD-8B0275
                       END IF
                    END IF
                 ELSE
                    #如果出通單需做批/序號管理，且出通單不為空白
                    IF (g_oaz.oaz81 = 'Y' AND NOT cl_null(g_oga.oga011)) OR   #No:FUN-860045
                       g_argv0 = '8' THEN   #CHI-970040
                       CALL t600_b1_move_back()
                       CALL t600_b_else()
#No.FUN-9C0103 ---start---
                       IF cl_null(g_ogb[l_ac].ogb41) THEN
                          SELECT oea00,oea11,oea12 INTO l_oea00,l_oea11,l_oea12
                            FROM oea_file
                           WHERE oea01 = g_ogb[l_ac].ogb31
                          IF l_oea00 = '4' AND l_oea11 = '7' THEN
                             SELECT oga16 INTO l_oga16
                               FROM oga_file
                              WHERE oga01 = l_oea12
                             LET l_bno = l_oga16
                          ELSE
                             LET l_bno = g_ogb[l_ac].ogb31
                          END IF
                       ELSE
                          LET l_bno = g_ogb[l_ac].ogb41
                       END IF
#No.FUN-9C0103 ---end---
                       CALL s_lotout(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,0,
                                     g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                                     g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                                     g_ogb[l_ac].ogb05,b_ogb.ogb15,b_ogb.ogb15_fac,
                                     g_ogb[l_ac].ogb12,'','SEL')#CHI-9A0022 add ''
                           RETURNING l_r,g_qty
                       IF l_r = "Y" THEN
                          LET g_ogb[l_ac].ogb12 = g_qty
                          DISPLAY BY NAME g_ogb[l_ac].ogb12   #MOD-8B0275
                       END IF
                    ELSE
                       CALL t600_b1_move_back()
                       CALL t600_b_else()
#No.CHI-9A0022 --Begin
                       IF cl_null(g_ogb[l_ac].ogb41) THEN
                          #FUN-9C0103  ---start---
                          SELECT oea00,oea11,oea12 INTO l_oea00,l_oea11,l_oea12
                            FROM oea_file
                           WHERE oea01 = g_ogb[l_ac].ogb31
                          IF l_oea00 ='4' AND l_oea11 = '7' THEN
                            SELECT oga16 INTO l_oga16
                              FROM oga_file
                             WHERE oga01 = l_oea12
                             LET l_bno = l_oga16
                          ELSE
                          #FUN-9C0103 ---end---
                             LET l_bno = g_ogb[l_ac].ogb31
                          END IF 
                       ELSE
                          LET l_bno = g_ogb[l_ac].ogb41
                       END IF
#No.CHI-9A0022 --End
                       CALL s_lotout(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,0,
                                     g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                                     g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                                     g_ogb[l_ac].ogb05,b_ogb.ogb15,b_ogb.ogb15_fac,
                                     g_ogb[l_ac].ogb12,l_bno,'MOD')#CHI-9A0022 add l_bno
                           RETURNING l_r,g_qty
                       IF l_r = "Y" THEN
                          LET g_ogb[l_ac].ogb12 = g_qty
                          DISPLAY BY NAME g_ogb[l_ac].ogb12   #MOD-8B0275
                       END IF
                    END IF
                 END IF
              END IF   #No:FUN-870131
           END IF
      IF g_azw.azw04='2' THEN 
         IF g_ogb[l_ac].ogb12 IS NULL OR g_ogb[l_ac].ogb12 !=g_ogb_t.ogb12 THEN                                                     
            IF NOT cl_null(g_ogb[l_ac].ogb13) AND g_ogb[l_ac].ogb13 != 0 THEN 
               SELECT rtz05 INTO l_rtz05 FROM rtz_file WHERE rtz01 = g_plant
               SELECT rtg05,rtg08 INTO l_rtg05,l_rtg08 FROM rtg_file,rtf_file
                WHERE rtg01=rtf01 AND rtfconf='Y'
                  AND rtg01 = l_rtz05
                  AND rtg03=g_ogb[l_ac].ogb04
                  AND rtg04=g_ogb[l_ac].ogb05
               IF l_rtg08='Y' THEN 
                  SELECT rth04 INTO l_rth04 
                    FROM rth_file
                   WHERE rth01=g_ogb[l_ac].ogb04 AND rth02=g_ogb[l_ac].ogb05 
                     AND rthplant=g_plant AND rthacti='Y'
                  LET l_sale_price=l_rth04
               ELSE
                  LET l_sale_price=l_rtg05
               END IF
               IF l_sale_price=g_ogb[l_ac].ogb13 THEN 
                   CALL t600_price_1(l_ac) RETURNING l_fac                                                                 
                   IF l_fac THEN                                                                                              
                      RETURN FALSE                                                                                           
                   END IF  
                ELSE
                   IF g_oga.oga213 = 'N' THEN                                                                                       
                      LET g_ogb[l_ac].ogb14 = g_ogb[l_ac].ogb12* g_ogb[l_ac].ogb13                                                  
                      CALL cl_digcut(g_ogb[l_ac].ogb14,t_azi04)  RETURNING g_ogb[l_ac].ogb14                                        
                      LET g_ogb[l_ac].ogb14t= g_ogb[l_ac].ogb14*(1+ g_oga.oga211/100)                                               
                      CALL cl_digcut(g_ogb[l_ac].ogb14t,t_azi04) RETURNING g_ogb[l_ac].ogb14t   
                   ELSE                                                                                                             
                      LET g_ogb[l_ac].ogb14t= g_ogb[l_ac].ogb12*g_ogb[l_ac].ogb13                                                   
                      CALL cl_digcut(g_ogb[l_ac].ogb14t,t_azi04) RETURNING g_ogb[l_ac].ogb14t                                       
                      LET g_ogb[l_ac].ogb14 = g_ogb[l_ac].ogb14t/(1+ g_oga.oga211/100)                                              
                      CALL cl_digcut(g_ogb[l_ac].ogb14,t_azi04)  RETURNING g_ogb[l_ac].ogb14                                        
                   END IF                                                                                                           
                END IF                                                                                                              
             END IF                                                                                                                 
         END IF                                                                                                                     
      END IF
      CALL t600_set_required_b1(p_cmd) #FUN-9C0173
      CALL t600_set_no_required_b1(p_cmd) #FUN-9C0173
      
       AFTER FIELD ogb13
           IF NOT cl_null(g_ogb[l_ac].ogb13) AND (g_ogb[l_ac].ogb13!=g_ogb_t.ogb13
                                                  OR g_ogb_t.ogb13 IS NULL ) THEN
              CALL t600_ogb14()
           END IF


       AFTER FIELD ogb14
           IF p_cmd='a' OR (p_cmd='u' AND (g_ogb[l_ac].ogb14!=g_ogb_t.ogb14 OR g_ogb_t.ogb14 IS NULL)) THEN
              IF g_oga.oga213 = 'N'  THEN
                LET g_ogb[l_ac].ogb14t=g_ogb[l_ac].ogb14*(1+g_oga.oga211/100)
                CALL cl_digcut(g_ogb[l_ac].ogb14t,t_azi04) RETURNING g_ogb[l_ac].ogb14t  #CHI-7A0036-add
                DISPLAY BY NAME g_ogb[l_ac].ogb14t
              END IF
           END IF

       AFTER FIELD ogb091
          CASE t600_chk_ogb91()
             WHEN "ogb09" NEXT FIELD ogb09
             WHEN "ogb12" NEXT FIELD ogb12
          END CASE

        BEFORE FIELD ogb913
           CALL t600_set_no_required_b1('')

        AFTER FIELD ogb913  #第二單位
           CASE t600_chk_ogb913()
              WHEN "ogb04"  NEXT FIELD ogb04
              WHEN "ogb092" 
                 CASE 
                    WHEN g_oaz.oaz104 = 'Y'
                         NEXT FIELD ogb092
                    WHEN g_oaz.oaz103 = 'Y'
                         NEXT FIELD ogb091
                    WHEN g_oaz.oaz102 = 'Y'
                         NEXT FIELD ogb09
                 END CASE
              WHEN "ogb913" NEXT FIELD ogb913
           END CASE

        BEFORE FIELD ogb914  #第二轉換率
           CASE t600_bef_ogb914()
              WHEN "ogb04"  NEXT FIELD ogb04
              WHEN "ogb092" 
                 CASE 
                    WHEN g_oaz.oaz104 = 'Y'
                         NEXT FIELD ogb092
                    WHEN g_oaz.oaz103 = 'Y'
                         NEXT FIELD ogb091
                    WHEN g_oaz.oaz102 = 'Y'
                         NEXT FIELD ogb09
                 END CASE
           END CASE

        AFTER FIELD ogb914  #第二轉換率
           IF NOT t600_chk_ogb914() THEN
              NEXT FIELD CURRENT
           END IF

        BEFORE FIELD ogb915
           CASE t600_bef_ogb915()
              WHEN "ogb04"  NEXT FIELD ogb04
              WHEN "ogb092" 
                 CASE 
                    WHEN g_oaz.oaz104 = 'Y'
                         NEXT FIELD ogb092
                    WHEN g_oaz.oaz103 = 'Y'
                         NEXT FIELD ogb091
                    WHEN g_oaz.oaz102 = 'Y'
                         NEXT FIELD ogb09
                 END CASE
           END CASE

        AFTER FIELD ogb915  #第二數量
           IF NOT t600_chk_ogb915(p_cmd) THEN
              NEXT FIELD CURRENT
           END IF

           #下列此段copy from AFTER FIELD ogb12
           LET g_ima918 = ''   #MOD-9C0055
           LET g_ima921 = ''   #MOD-9C0055
           SELECT ima918,ima921 INTO g_ima918,g_ima921 
             FROM ima_file
            WHERE ima01 = g_ogb[l_ac].ogb04
              AND imaacti = "Y"
           
           IF (g_ima918 = "Y" OR g_ima921 = "Y") AND 
              (cl_null(g_ogb_t.ogb915) OR (g_ogb[l_ac].ogb915<>g_ogb_t.ogb915 )) THEN
              #非多倉儲出貨才可查詢批/序號資料
              IF g_ogb[l_ac].ogb17 = "N" THEN   #No:FUN-870131
                 IF g_argv0 ='1' OR g_argv0 ='5' THEN  #出通要判斷 oaz81  #MOD-940294 add
                    IF g_oaz.oaz81 = 'Y' THEN
                       CALL t600_b1_move_back()
                       CALL t600_b_else()
#No.CHI-9A0022 --Begin
                       IF cl_null(g_ogb[l_ac].ogb41) THEN
                          #FUN-9C0103 ---start---
                          SELECT oea00,oea11,oea12 INTO l_oea00,l_oea11,l_oea12
                            FROM oea_file
                           WHERE oea01 = g_ogb[l_ac].ogb31
                          IF l_oea00 = '4' AND l_oea11 = '7' THEN
                             SELECT oga16 INTO l_oga16
                               FROM oga_file
                              WHERE oga01 = l_oea12
                             LET l_bno = l_oga16
                          ELSE
                          #FUN-9C0103 ---end---
                             LET l_bno = g_ogb[l_ac].ogb31
                          END IF
                       ELSE
                          LET l_bno = g_ogb[l_ac].ogb41
                       END IF
#No.CHI-9A0022 --End
                       CALL s_lotout(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,0,
                                     g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                                     g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                                     g_ogb[l_ac].ogb05,b_ogb.ogb15,b_ogb.ogb15_fac,
                                     g_ogb[l_ac].ogb12,l_bno,'MOD')#CHI-9A0022 add l_bno
                           RETURNING l_r,g_qty
                       IF l_r = "Y" THEN
                          LET g_ogb[l_ac].ogb12 = g_qty
                          DISPLAY BY NAME g_ogb[l_ac].ogb12   #MOD-8B0275
                       END IF
                    END IF
                 ELSE
                    #如果出通單需做批/序號管理，且出通單不為空白
                    IF (g_oaz.oaz81 = 'Y' AND NOT cl_null(g_oga.oga011)) OR   #No:FUN-860045
                       g_argv0 = '8' THEN   #CHI-970040
                       CALL t600_b1_move_back()
                       CALL t600_b_else()
#No.FUN-9C0103 ---start---
                       IF cl_null(g_ogb[l_ac].ogb41) THEN
                          SELECT oea00,oea11,oea12 INTO l_oea00,l_oea11,l_oea12
                            FROM oea_file
                           WHERE oea01 = g_ogb[l_ac].ogb31
                          IF l_oea00 = '4' AND l_oea11 = '7' THEN
                             SELECT oga16 INTO l_oga16
                               FROM oga_file
                              WHERE oga01 = l_oea12
                             LET l_bno = l_oga16
                          ELSE
                             LET l_bno = g_ogb[l_ac].ogb31
                          END IF
                       ELSE
                          LET l_bno = g_ogb[l_ac].ogb41
                       END IF
#No.FUN-9C0103 ---end---  
                       CALL s_lotout(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,0,
                                     g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                                     g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                                     g_ogb[l_ac].ogb05,b_ogb.ogb15,b_ogb.ogb15_fac,
                                     g_ogb[l_ac].ogb12,'','SEL')#CHI-9A0022 add ''
                           RETURNING l_r,g_qty
                       IF l_r = "Y" THEN
                          LET g_ogb[l_ac].ogb12 = g_qty
                          DISPLAY BY NAME g_ogb[l_ac].ogb12   #MOD-8B0275
                       END IF
                    ELSE
                       CALL t600_b1_move_back()
                       CALL t600_b_else()
#No.CHI-9A0022 --Begin
                       IF cl_null(g_ogb[l_ac].ogb41) THEN
                          #FUN-9C0103  ---start---
                          SELECT oea00,oea11,oea12 INTO l_oea00,l_oea11,l_oea12
                            FROM oea_file
                           WHERE oea01 = g_ogb[l_ac].ogb31
                          IF l_oea00 = '4' AND l_oea11 = '7' THEN
                             SELECT oga16 INTO l_oga16
                               FROM oga_file
                              WHERE oga01 = l_oea12
                             LET l_bno = l_oga16
                          ELSE
                          #FUN-9C0103 ---end---
                             LET l_bno = g_ogb[l_ac].ogb31
                          END IF  
                       ELSE
                          LET l_bno = g_ogb[l_ac].ogb41
                       END IF
#No.CHI-9A0022 --End
                       CALL s_lotout(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,0,
                                     g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                                     g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                                     g_ogb[l_ac].ogb05,b_ogb.ogb15,b_ogb.ogb15_fac,
                                     g_ogb[l_ac].ogb12,l_bno,'MOD')#CHI-9A0022 add l_bno
                           RETURNING l_r,g_qty
                       IF l_r = "Y" THEN
                          LET g_ogb[l_ac].ogb12 = g_qty
                          DISPLAY BY NAME g_ogb[l_ac].ogb12   #MOD-8B0275
                       END IF
                    END IF
                 END IF
              END IF   #No:FUN-870131
           END IF

        BEFORE FIELD ogb910
           CALL t600_set_no_required_b1('')

        AFTER FIELD ogb910  #第一單位
           CASE t600_chk_ogb910()
              WHEN "ogb04"  NEXT FIELD ogb04
              WHEN "ogb092" 
                 CASE 
                    WHEN g_oaz.oaz104 = 'Y'
                         NEXT FIELD ogb092
                    WHEN g_oaz.oaz103 = 'Y'
                         NEXT FIELD ogb091
                    WHEN g_oaz.oaz102 = 'Y'
                         NEXT FIELD ogb09
                 END CASE
              WHEN "ogb910" NEXT FIELD ogb910
           END CASE

        BEFORE FIELD ogb911  #第一轉換率
           CASE t600_bef_ogb911()
              WHEN "ogb04"  NEXT FIELD ogb04
              WHEN "ogb092" 
                 CASE 
                    WHEN g_oaz.oaz104 = 'Y'
                         NEXT FIELD ogb092
                    WHEN g_oaz.oaz103 = 'Y'
                         NEXT FIELD ogb091
                    WHEN g_oaz.oaz102 = 'Y'
                         NEXT FIELD ogb09
                 END CASE
           END CASE

        AFTER FIELD ogb911  #第一轉換率
           IF NOT t600_chk_ogb911() THEN
              NEXT FIELD CURRENT
           END IF

        BEFORE FIELD ogb912
           CASE t600_bef_ogb912()
              WHEN "ogb04"  NEXT FIELD ogb04
              WHEN "ogb092" 
                 CASE 
                    WHEN g_oaz.oaz104 = 'Y'
                         NEXT FIELD ogb092
                    WHEN g_oaz.oaz103 = 'Y'
                         NEXT FIELD ogb091
                    WHEN g_oaz.oaz102 = 'Y'
                         NEXT FIELD ogb09
                 END CASE
           END CASE
           IF NOT cl_null(g_ogb[l_ac].ogb912) THEN
              LET g_ogb_t.ogb912 = g_ogb[l_ac].ogb912
           END IF

        AFTER FIELD ogb912  #第一數量
           CASE t600_chk_ogb912()
              WHEN "ogb912" NEXT FIELD ogb912
              WHEN "ogb915" NEXT FIELD ogb915
           END CASE

        BEFORE FIELD ogb916
           CALL t600_set_no_required_b1('')

        AFTER FIELD ogb916  #計價單位
          #CASE t600_chk_ogb916()      #FUN-AC0012
           CASE t600_chk_ogb916(p_cmd) #FUN-AC0012
              WHEN "ogb04"   NEXT FIELD ogb04
              WHEN "ogb0916" NEXT FIELD CURRENT
              WHEN "ogb092"  NEXT FIELD ogb092
           END CASE

        BEFORE FIELD ogb917
           IF g_change='Y' THEN
              CALL t600_set_ogb917()
           END IF

        AFTER FIELD ogb917  #計價數量
           IF NOT cl_null(g_ogb[l_ac].ogb917) THEN
              IF g_ogb[l_ac].ogb917 < 0 THEN
                 CALL cl_err('','aim-391',0)  #
                 NEXT FIELD CURRENT
              END IF
           ELSE
              CALL cl_err('','mfg3291',0)  #
              NEXT FIELD CURRENT
           END IF
           IF NOT cl_null(g_ogb[l_ac].ogb917) AND (g_ogb[l_ac].ogb917!=g_ogb_t.ogb917
                                                  OR g_ogb_t.ogb917 IS NULL ) THEN
              CALL t600_ogb14()
           END IF

        AFTER FIELD ogb1003
          #CALL t600_price(l_ac) RETURNING l_fac       #FUN-AC0012
          #CALL t600_price(l_ac,p_cmd) RETURNING l_fac #FUN-AC0012  #TQC-B50117 
           IF cl_null(g_ogb[l_ac].ogb31) AND cl_null(g_ogb[l_ac].ogb32) THEN     #MOD-B60052 add
              CALL t600_price(p_cmd,l_ac) RETURNING l_fac #FUN-AC0012 #TQC-B50117
           END IF                                                                #MOD-B60052 add
        AFTER FIELD ogb41
          IF NOT cl_null(g_ogb[l_ac].ogb41) THEN
             LET g_cnt = 0        #MOD-AB0247 add
             SELECT COUNT(*) INTO g_cnt FROM pja_file
              WHERE pja01 = g_ogb[l_ac].ogb41
                AND pjaacti = 'Y'
                AND pjaclose = 'N'           #No.FUN-960038
             IF g_cnt = 0 THEN
                CALL cl_err(g_ogb[l_ac].ogb41,'asf-984',0)
                NEXT FIELD ogb41
             END IF
          ELSE
             NEXT FIELD ogb1004
          END IF

        BEFORE FIELD ogb42
          IF cl_null(g_ogb[l_ac].ogb41) THEN
             NEXT FIELD ogb41
          END IF

        AFTER FIELD ogb42
          IF NOT cl_null(g_ogb[l_ac].ogb42) THEN
             LET g_cnt = 0        #MOD-AB0247 add
             SELECT COUNT(*) INTO g_cnt FROM pjb_file
              WHERE pjb01 = g_ogb[l_ac].ogb41
                AND pjb02 = g_ogb[l_ac].ogb42
                AND pjbacti = 'Y'
             IF g_cnt = 0 THEN
                CALL cl_err(g_ogb[l_ac].ogb42,'apj-051',0)
                LET g_ogb[l_ac].ogb42 = g_ogb_t.ogb42
                NEXT FIELD ogb42
             ELSE
                SELECT pjb09,pjb11 INTO l_pjb09,l_pjb11 
                 FROM pjb_file WHERE pjb01 = g_ogb[l_ac].ogb41
                  AND pjb02 = g_ogb[l_ac].ogb42
                  AND pjbacti = 'Y'            
                IF l_pjb09 != 'Y' OR l_pjb11 != 'Y' THEN
                   CALL cl_err(g_ogb[l_ac].ogb42,'apj-090',0)
                   LET g_ogb[l_ac].ogb42 = g_ogb_t.ogb42
                   NEXT FIELD ogb42
                END IF
             END IF
             SELECT pjb25 INTO l_pjb25 FROM pjb_file
              WHERE pjb02 = g_ogb[l_ac].ogb42
             IF l_pjb25 = 'Y' THEN
                NEXT FIELD ogb43
             ELSE
                LET g_ogb[l_ac].ogb43 = ' '
                DISPLAY BY NAME g_ogb[l_ac].ogb43
                NEXT FIELD ogb43
             END IF
          END IF

        BEFORE FIELD ogb43
          IF cl_null(g_ogb[l_ac].ogb42) THEN
             NEXT FIELD ogb42
          ELSE
             SELECT pjb25 INTO l_pjb25 FROM pjb_file
              WHERE pjb02 = g_ogb[l_ac].ogb42
             IF l_pjb25 = 'N' THEN  #WBS不做活動時，活動帶空白，跳開不輸入
                LET g_ogb[l_ac].ogb43 = ' '
                DISPLAY BY NAME g_ogb[l_ac].ogb43
                NEXT FIELD ogb1004
             END IF
          END IF

        AFTER FIELD ogb43     #活動
          IF NOT cl_null(g_ogb[l_ac].ogb43) THEN
             LET g_cnt = 0        #MOD-AB0247 add
             SELECT COUNT(*) INTO g_cnt FROM pjk_file
              WHERE pjk02 = g_ogb[l_ac].ogb43
                AND pjk11 = g_ogb[l_ac].ogb42
                AND pjkacti = 'Y'
             IF g_cnt = 0 THEN
                CALL cl_err(g_ogb[l_ac].ogb43,'apj-049',0)
                NEXT FIELD ogb43
             END IF
          END IF

        AFTER FIELD ogb1004
          #IF NOT t600_chk_ogb1004() THEN      #FUN-AC0012
           IF NOT t600_chk_ogb1004(p_cmd) THEN #FUN-AC0012
              NEXT FIELD CURRENT
           END IF

        AFTER FIELD ogb908
           IF NOT t600_chk_ogb908() THEN
              NEXT FIELD CURRENT
           END IF

        AFTER FIELD ogbud01
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogbud02
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogbud03
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogbud04
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogbud05
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogbud06
         #NO.120912 modify---------------begin
       #xiaoyx --begin
       #最开始入口，就应赋值清零。
       LET l_tj=0
       LET l_tje=0
       LET l_tjd=0 
       LET l_tjc=0
       LET l_tjb=0
       LET l_tja=0
       #xiaoyx --end
           #IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF 
           IF NOT cl_null(g_ogb[l_ac].ogbud06) THEN
              IF g_ogb[l_ac].ogbud06 NOT MATCHES'[1234]' THEN
                 NEXT FIELD ogbud06              
              END IF
              SELECT * INTO l_tc_obe.* FROM tc_obe_file
               WHERE tc_obe00 = g_ogb[l_ac].ogbud06
                 AND tc_obe01 = g_ogb[l_ac].ogb04
              IF SQLCA.SQLCODE OR g_ogb[l_ac].ogb12 = 0 THEN
                 LET g_ogb[l_ac].ogbud11 = 0
              ELSE   
              	LET l_tj = 0           	
                IF l_tc_obe.tc_obe051 > 0 THEN    #从大到小判断，D最大，先判断D                   
                   LET l_sql = "SELECT MOD(" CLIPPED,g_ogb[l_ac].ogb12 CLIPPED,"," CLIPPED,l_tc_obe.tc_obe051 CLIPPED,") FROM DUAL"
                   PREPARE tc_obe051_cs FROM l_sql
                   EXECUTE tc_obe051_cs INTO l_modd
                   
                   LET l_sql = "SELECT FLOOR(" CLIPPED,g_ogb[l_ac].ogb12 CLIPPED,"/" CLIPPED,l_tc_obe.tc_obe051 CLIPPED,") FROM DUAL"
                   PREPARE tc_obe051_cs1 FROM l_sql
                   EXECUTE tc_obe051_cs1 INTO l_floord
                   
                   LET l_tjd = l_floord * l_tc_obe.tc_obe052
                   IF cL_null(l_tjd) THEN
                      LET l_tjd = 0
                   END IF
                END IF
             #xiaoyx,
              IF l_modd IS NULL OR l_modd=0 THEN LET l_modd=g_ogb[l_ac].ogb12 END IF #xiaoyx
           #xiaoyx     IF l_tc_obe.tc_obe041 > 0 AND l_modd > 0 THEN  #算完D后有余数才继续算C
             IF (l_tc_obe.tc_obe041 > 0 AND l_modd > 0) OR l_tc_obe.tc_obe041 > 0 THEN  #如果D空，则不存在取余。
                   LET l_sql = "SELECT MOD(" CLIPPED,l_modd CLIPPED,"," CLIPPED,l_tc_obe.tc_obe041 CLIPPED,") FROM DUAL"
                   PREPARE tc_obe041_cs FROM l_sql
                   EXECUTE tc_obe041_cs INTO l_modc
                   
                   LET l_sql = "SELECT FLOOR(" CLIPPED,l_modd CLIPPED,"/" CLIPPED,l_tc_obe.tc_obe041 CLIPPED,") FROM DUAL"
                   PREPARE tc_obe041_cs1 FROM l_sql
                   EXECUTE tc_obe041_cs1 INTO l_floorc
                   
                   LET l_tjc = l_floorc * l_tc_obe.tc_obe042
                   IF cl_null(l_tjc) THEN
                      LET l_tjc = 0
                   END IF                 
                END IF
          IF l_modc IS NULL OR l_modc=0 THEN LET l_modc=g_ogb[l_ac].ogb12 END IF #xiaoyx       
         #xiaoyx       IF l_tc_obe.tc_obe031 > 0 AND l_modc > 0 THEN  #B
           IF (l_tc_obe.tc_obe031 > 0 AND l_modc > 0) OR l_tc_obe.tc_obe031 > 0 THEN
                   LET l_sql = "SELECT MOD(" CLIPPED,l_modc CLIPPED,"," CLIPPED,l_tc_obe.tc_obe031 CLIPPED,") FROM DUAL"
                   PREPARE tc_obe031_cs FROM l_sql
                   EXECUTE tc_obe031_cs INTO l_modb
                   
                   LET l_sql = "SELECT FLOOR(" CLIPPED,l_modc CLIPPED,"/" CLIPPED,l_tc_obe.tc_obe031 CLIPPED,") FROM DUAL"
                   PREPARE tc_obe031_cs1 FROM l_sql
                   EXECUTE tc_obe031_cs1 INTO l_floorb
                   
                   LET l_tjb = l_floorb * l_tc_obe.tc_obe032
                   IF cl_null(l_tjb) THEN
                      LET l_tjb = 0
                   END IF                 
                END IF
         IF l_modb IS NULL OR l_modb=0 THEN LET l_modb=g_ogb[l_ac].ogb12 END IF #xiaoyx        
         #xiaoyx       IF l_tc_obe.tc_obe021 > 0 AND l_modb > 0 THEN  #A
        IF (l_tc_obe.tc_obe021 > 0 AND l_modb > 0) OR l_tc_obe.tc_obe021 > 0  THEN
                   LET l_sql = "SELECT MOD(" CLIPPED,l_modb CLIPPED,"," CLIPPED,l_tc_obe.tc_obe021 CLIPPED,") FROM DUAL"
                   PREPARE tc_obe021_cs FROM l_sql
                   EXECUTE tc_obe021_cs INTO l_moda
                   
                   LET l_sql = "SELECT FLOOR(" CLIPPED,l_modb CLIPPED,"/" CLIPPED,l_tc_obe.tc_obe021 CLIPPED,") FROM DUAL"
                   PREPARE tc_obe021_cs1 FROM l_sql
                   EXECUTE tc_obe021_cs1 INTO l_floora
                   
                   LET l_tja = l_floora * l_tc_obe.tc_obe022
                   IF cl_null(l_tja) THEN
                      LET l_tja = 0
                   END IF                 
                END IF
                
                IF l_moda > 0 THEN
                   IF l_tc_obe.tc_obe021 <> 0 THEN
                      LET l_tje = 1 * l_tc_obe.tc_obe022
                      IF cl_null(l_tje) THEN
                         LET l_tje = 0
                      END IF  
                   END IF
                   
                   IF l_tc_obe.tc_obe021 = 0 AND l_tc_obe.tc_obe031 <> 0 THEN
                      LET l_tje = 1 * l_tc_obe.tc_obe032
                      IF cl_null(l_tje) THEN
                         LET l_tje = 0
                      END IF  
                   END IF
                   
                   IF l_tc_obe.tc_obe021 = 0 AND l_tc_obe.tc_obe031 = 0 AND l_tc_obe.tc_obe041 <> 0 THEN
                      LET l_tje = 1 * l_tc_obe.tc_obe042
                      IF cl_null(l_tje) THEN
                         LET l_tje = 0
                      END IF  
                   END IF
                   
                   IF l_tc_obe.tc_obe021 = 0 AND l_tc_obe.tc_obe031 = 0 AND l_tc_obe.tc_obe041 = 0 
                      AND l_tc_obe.tc_obe051 <> 0THEN
                      LET l_tje = 1 * l_tc_obe.tc_obe052
                      IF cl_null(l_tje) THEN
                         LET l_tje = 0
                      END IF  
                   END IF
                   
                END IF  
                LET l_tj = l_tja + l_tjb + l_tjc + l_tjd + l_tje
                LET g_ogb[l_ac].ogbud11 = l_tj
                DISPLAY BY NAME g_ogb[l_ac].ogbud11
              END IF
           END IF
         #NO.120912 modify-----------------end
         
        AFTER FIELD ogbud07
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogbud08
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogbud09
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogbud10
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogbud11
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogbud12
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogbud13
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogbud14
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
        AFTER FIELD ogbud15
           IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF


       BEFORE DELETE                            #是否取消單身
            IF g_ogb_t.ogb03 > 0 AND g_ogb_t.ogb03 IS NOT NULL THEN

                CALL t600_fetch_price('d')    #NO.FUN-960130---add---
                IF NOT t600_b1_delchk() THEN
                   CANCEL DELETE
                END IF

                IF g_sma.sma128 = 'Y' AND g_sma.sma115 !='Y' AND
                   NOT cl_null(l_ogb931) AND NOT cl_null(l_ogb932) THEN
                   IF NOT cl_confirm('axm_107') THEN
                      CANCEL DELETE
                   END IF
                ELSE
                   IF NOT cl_delb(0,0) THEN
                      CANCEL DELETE
                   END IF
                END IF     #FUN-820046 add

                IF l_lock_sw = "Y" THEN
                   CALL cl_err("", -263, 1)
                   CANCEL DELETE
                END IF

                #如果是出通單，要判斷參數是否做批序號管理 
                IF g_argv0 <> '1' OR (g_argv0='1' AND g_oaz.oaz81='Y') THEN  #FUN-850120 add
                  LET g_ima918 = ''   #MOD-9C0055
                  LET g_ima921 = ''   #MOD-9C0055
                  SELECT ima918,ima921 INTO g_ima918,g_ima921 
                    FROM ima_file
                   WHERE ima01 = g_ogb[l_ac].ogb04
                     AND imaacti = "Y"
               
                  IF g_ima918 = "Y" OR g_ima921 = "Y" THEN
                     IF NOT s_lotout_del(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,0,g_ogb[l_ac].ogb04,'DEL') THEN   #No:FUN-860045
                        CALL cl_err3("del","rvbs_file",g_oga.oga01,g_ogb_t.ogb03,
                                      SQLCA.sqlcode,"","",1)
                        ROLLBACK WORK
                        CANCEL DELETE
                     END IF
                  END IF
                END IF  #FUN-850120 add


               IF g_prog <> 'axmt628' AND g_prog<>'axmt629' THEN  #axmt628/629不處理rvbs
                  IF NOT s_del_rvbs("1",g_oga.oga01,g_ogb[l_ac].ogb03,0)  THEN                      #FUN-880129 Mark 
                    ROLLBACK WORK
                    CANCEL DELETE
                  END IF   
               END IF

                IF NOT t600_b1_del() THEN
                   ROLLBACK WORK
                   CANCEL DELETE
                END IF
                COMMIT WORK
                IF g_aza.aza50='Y' THEN
                   CALL t600_oga50_sum()    #No.FUN-610064
                ELSE
                   CALL t600_bu()
                END IF
                LET g_rec_b1=g_rec_b1-1         #No.TQC-640123
                DISPLAY g_rec_b1 TO FORMONLY.cn2
                LET l_oga55 = '0'          #FUN-550050
                LET l_del_flg = 'Y'        #FUN-B10024
            END IF

        ON ROW CHANGE
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               LET g_flag2 = '1'   #CHI-920012
               LET g_ogb[l_ac].* = g_ogb_t.*
               CLOSE t600_bcl1
               ROLLBACK WORK
               EXIT INPUT
            END IF
            IF l_lock_sw = 'Y' THEN
               CALL cl_err(g_ogb[l_ac].ogb03,-263,1)
               LET g_ogb[l_ac].* = g_ogb_t.*
            ELSE
               CASE t600_b1_updchk()
                  WHEN "ogb03"  NEXT FIELD ogb03	#MOD-970092
                  WHEN "ogb904" NEXT FIELD ogb904
                  WHEN "ogb65"  NEXT FIELD ogb65
               END CASE

                #IF 有專案且要做預算控管
                # check料件， if料件沒做批號管理也沒做序號管理，則要寫入rvbs_file
               IF g_prog <> 'axmt628' AND g_prog<>'axmt629' THEN  #axmt628/629不處理rvbs
                LET g_success = 'Y'
                IF s_chk_rvbs(g_ogb[l_ac].ogb41,g_ogb[l_ac].ogb04) THEN
                   CALL t600_rvbs()
                END IF
                IF g_success = 'N' THEN
                   NEXT FIELD ogb03
                END IF
               END IF

               CALL t600_b1_move_back()
                  CALL t600_b_else()

#TQC-B40204 --begin--
              IF g_oga.oga55 MATCHES '[01RW]' THEN 
                 LET l_oga55 = '0'
              END IF 
#TQC-B40204 --end--

               IF NOT t600_b1_upd() THEN
                  LET g_ogb[l_ac].* = g_ogb_t.*
               ELSE
                  CALL cl_msg('UPDATE O.K')
               #MOD-B10154 Begin---
               ##FUN-A20022 ADD----------UPDATE THE POINT---------------------------
               #  IF NOT cl_null(g_oga.oga87) THEN
               #     LET g_oga.oga95= t600_oga95_amount()
               #     UPDATE oga_file SET oga95 = g_oga.oga95
               #                   WHERE oga01 = g_oga.oga01
               #                     AND oga87 = g_oga.oga87
               #     IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
               #        CALL cl_err3("upd","oga_file",g_oga.oga01,"",SQLCA.sqlcode,"","",1)
               #     END IF
               #     DISPLAY BY NAME g_oga.oga95
               #  END IF
               ##FUN-A20022 END----------------------------------------------
               #MOD-B10154 End-----
#                 LET l_oga55 = '0'          #FUN-550050      #TQC-B40204 
                  CALL t600_mlog('U')
                  IF g_aza.aza50='Y' THEN
                     CALL t600_oga50_sum()    #No.FUN-610064
                  ELSE
                     CALL t600_bu()
                  END IF
                  COMMIT WORK
               END IF
            END IF

        AFTER ROW
            LET l_ac = ARR_CURR()
            LET l_ac_t = l_ac
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               LET g_flag2 = '1'   #CHI-920012

               #如果是出通單，要判斷參數是否做批序號管理 
               IF g_argv0 <> '1' OR (g_argv0='1' AND g_oaz.oaz81='Y') THEN  #FUN-850120 add
                 LET g_ima918 = ''   #MOD-9C0055
                 LET g_ima921 = ''   #MOD-9C0055
                 SELECT ima918,ima921 INTO g_ima918,g_ima921 
                   FROM ima_file
                  WHERE ima01 = g_ogb[l_ac].ogb04
                    AND imaacti = "Y"
               
                 IF g_ima918 = "Y" OR g_ima921 = "Y" THEN
                    IF NOT s_lotout_del(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,0,g_ogb[l_ac].ogb04,'DEL') THEN   #No:FUN-860045
                       CALL cl_err3("del","rvbs_file",g_oga.oga01,g_ogb_t.ogb03,
                                     SQLCA.sqlcode,"","",1)
                    END IF
                 END IF
               END IF  #FUN-850120 add
               IF p_cmd = 'u' THEN
                  LET g_ogb[l_ac].* = g_ogb_t.*
               END IF
               CLOSE t600_bcl1
               ROLLBACK WORK
               EXIT INPUT
            END IF
            #CHI-AC0034 add --start--
            IF l_del_flg = 'N' THEN   #FUN-B10024
            IF g_ogb[l_ac].ogb17='Y' AND g_oaz.oaz23 = 'Y' THEN     ##多倉儲出貨
               SELECT SUM(ogc12) INTO l_ogc12_t FROM ogc_file
                WHERE ogc01 = g_oga.oga01 AND ogc03 = g_ogb[l_ac].ogb03
               IF l_ogc12_t != g_ogb[l_ac].ogb12 THEN
                  IF NOT cl_confirm('axm-247') THEN
                     NEXT FIELD ogb12
                  END IF
               END IF
            END IF
            END IF                    #FUN-B10024
            #CHI-AC0034 add --end--
            CLOSE t600_bcl1
            IF g_aza.aza50='Y' THEN
               CALL t600_oga50_sum() #FUN-710037
            ELSE
               CALL t600_bu() #FUN-710037
            END IF
           #IF g_azw.azw04 = '2' THEN                     #FUN-B10024
            IF g_azw.azw04 = '2' AND l_del_flg = 'N' THEN #FUN-B10024
               CALL t600_add_store(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09)  
            END IF
            LET l_del_flg = 'N'       #FUN-B10024
            COMMIT WORK


        ON ACTION controls                             #No.FUN-6A0092
         CALL cl_set_head_visible("","AUTO")           #No.FUN-6A0092


        ON ACTION CONTROLO                        #沿用所有欄位
            IF INFIELD(ogb03) AND l_ac > 1 THEN
                LET g_ogb[l_ac].* = g_ogb[l_ac-1].*
                LET g_ogb[l_ac].ogb03 = NULL
                LET g_ogb[l_ac].ogb32 = NULL   #MOD-A70144
                NEXT FIELD ogb03
            END IF

        ON ACTION select_order
           #CALL q_oeb10(FALSE,FALSE,g_oga.oga03,g_oga.oga01,g_oga.oga213,   #No.TQC-640123   #MOD-940130 add   #MOD-A90122
           CALL q_oeb10(FALSE,TRUE,g_oga.oga03,g_oga.oga01,g_oga.oga213,    #MOD-A90122
       #xiaoyx  CALL q_oeb2011(FALSE,TRUE,g_oga.oga03,g_oga.oga01,g_oga.oga213,   
                      g_oga.oga211,g_oga.oga24,g_oga.oga04,g_oga.oga21,
                      #g_oga.oga23,g_oga.oga25)   #MOD-8C0110
                      g_oga.oga23,g_oga.oga25,g_argv0)   #MOD-8C0110
           CALL t600_bu()
           LET l_exit_sw = FALSE
           EXIT INPUT

        ON ACTION mntn_serial_no
           IF (g_ogb[l_ac].ogb04!=' ' OR g_ogb[l_ac].ogb04 IS NOT NULL) THEN
              CALL t601_5(g_oga.oga01,g_ogb[l_ac].ogb03)
           END IF

        ON ACTION other_data
           CALL t600_b_more()

        ON ACTION mntn_inv_detail
            IF g_ogb[l_ac].ogb17 = 'Y' THEN
               IF g_sma.sma115 = 'Y' THEN
                  CALL t600_b_ogg()
               ELSE
                  IF g_oaz.oaz23 = 'Y' THEN
                     CALL t600_b_ogd()
                  ELSE
                     CALL t600_b_ogc()
                  END IF
               END IF
            END IF

        ON ACTION qry_product_inventory
              LET g_msg='axmq450 ',g_ogb[l_ac].ogb04
              CALL cl_cmdrun(g_msg)

        ON ACTION unit_price
               CALL t600_6007()

        ON ACTION sub
           IF NOT cl_null(g_ogb[l_ac].ogb04) THEN
              LET g_ogb[l_ac].ogb17='Y'
              DISPLAY g_ogb[l_ac].ogb17 TO ogb17
              IF NOT t600_chk_ogb17(p_cmd) THEN
                 NEXT FIELD ogb17
              END IF
           END IF

        ON ACTION controlp
            CASE WHEN INFIELD(ogb31)
                      CALL cl_init_qry_var()
                      IF g_ogb[l_ac].ogb1005 ='1' THEN     #No.FUN-610064
                        IF NOT cl_null(g_oga.oga16) THEN
                           LET g_qryparam.form ="q_oeb9_1" #CHI-960017
                           LET g_qryparam.arg1 = g_oga.oga16
                           LET g_qryparam.arg2 = g_oga.oga08   #MOD-8B0108
                        ELSE
                           LET g_qryparam.form ="q_ogb32_1" #CHI-960017
                           LET g_qryparam.arg1 = g_oga.oga04    #送貨客戶
                           LET g_qryparam.arg2 = g_oga.oga21    #稅別
                           LET g_qryparam.arg3 = g_oga.oga23    #幣別
                           LET g_qryparam.arg4 = g_oga.oga25    #銷售分類
                           LET g_qryparam.arg5 = g_oga.oga03    #客戶編號
                           LET g_qryparam.arg6 = g_oga.oga08    #性質   #MOD-8B0108
                        END IF
                      END IF                            #No.FUN-610064
                      LET g_qryparam.default1 =g_ogb[l_ac].ogb31
                      LET g_qryparam.default2 =g_ogb[l_ac].ogb32
                      CALL cl_create_qry() RETURNING g_ogb[l_ac].ogb31 ,
                                                     g_ogb[l_ac].ogb32

                      DISPLAY BY NAME g_ogb[l_ac].ogb31,g_ogb[l_ac].ogb32
                      NEXT FIELD ogb31

#TQC-A10153 --begin--
              WHEN INFIELD(ogb32)
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_ogb32_2"
                 LET g_qryparam.arg1 = g_ogb[l_ac].ogb31
                 CALL cl_create_qry() RETURNING g_ogb[l_ac].ogb32
                 DISPLAY BY NAME g_ogb[l_ac].ogb32
                 NEXT FIELD ogb32
#TQC-A10153 --end--

              WHEN INFIELD(ogb41) #專案代號
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_pja2"
                 CALL cl_create_qry() RETURNING g_ogb[l_ac].ogb41
                 DISPLAY BY NAME g_ogb[l_ac].ogb41
                 NEXT FIELD ogb41
              WHEN INFIELD(ogb42)  #WBS
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_pjb4"
                 LET g_qryparam.arg1 = g_ogb[l_ac].ogb41
                 CALL cl_create_qry() RETURNING g_ogb[l_ac].ogb42
                 DISPLAY BY NAME g_ogb[l_ac].ogb42
                 NEXT FIELD ogb42
              WHEN INFIELD(ogb43)  #活動
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_pjk3"
                 LET g_qryparam.arg1 = g_ogb[l_ac].ogb42
                 CALL cl_create_qry() RETURNING g_ogb[l_ac].ogb43
                 DISPLAY BY NAME g_ogb[l_ac].ogb43
                 NEXT FIELD ogb43

              WHEN INFIELD(ogb1004)
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_tqx1"
                 LET g_qryparam.default1 = g_ogb[l_ac].ogb1004
                 LET g_qryparam.arg1 = g_oga.oga03
                 LET g_qryparam.where = " (tqz03 ='",g_ogb[l_ac].ogb04,"' OR                                            tqz03 IN (SELECT ima01 FROM ima_file                                                       WHERE ima135='",g_ogb[l_ac].ima135,"'))"
                 CALL cl_create_qry() RETURNING g_ogb[l_ac].ogb1004
                 DISPLAY BY NAME g_ogb[l_ac].ogb1004
                 NEXT FIELD ogb1004

              #Add Start , 新增的母料件開窗
              #這里只需要處理g_sma.sma908='Y'的情況,因為不允許單身新增子料件則在前面
              #BEFORE FIELD att00來做開窗了
              #需注意的是其條件限制是要開多屬性母料件且母料件的屬性組等于當前屬性組
              WHEN INFIELD(att00)
                 #可以新增子料件,開窗是單純的選取母料件
#FUN-AA0059---------mod------------str-----------------
#                CALL cl_init_qry_var()
#                LET g_qryparam.form ="q_ima_p"
#                LET g_qryparam.arg1 = lg_group
#                CALL cl_create_qry() RETURNING g_ogb[l_ac].att00
                 CALL q_sel_ima(TRUE, "q_ima_p","","",lg_group,"","","","",'')
                   RETURNING g_ogb[l_ac].att00
#FUN-AA0059---------mod------------end------------------
                 DISPLAY BY NAME g_ogb[l_ac].att00
                 LET g_ogb[l_ac].ogb04 =g_ogb[l_ac].att00                       
                 LET g_ogb[l_ac].att01 =null                                    
                 LET g_ogb[l_ac].att01_c =null                                  
                 LET g_ogb[l_ac].att02 =null                                    
                 LET g_ogb[l_ac].att02_c =null                                  
                 LET g_ogb[l_ac].att03 =null                                    
                 LET g_ogb[l_ac].att03_c =null                                  
                 LET g_ogb[l_ac].att04 =null                                    
                 LET g_ogb[l_ac].att04_c =null                                  
                 LET g_ogb[l_ac].att05 =null                                    
                 LET g_ogb[l_ac].att05_c =null                                  
                 LET g_ogb[l_ac].att06 =null                                    
                 LET g_ogb[l_ac].att06_c =null                                  
                 LET g_ogb[l_ac].att07 =null                                    
                 LET g_ogb[l_ac].att07_c =null                                  
                 LET g_ogb[l_ac].att08 =null                                    
                 LET g_ogb[l_ac].att08_c =null                                  
                 LET g_ogb[l_ac].att09 =null                                    
                 LET g_ogb[l_ac].att09_c =null                                  
                 LET g_ogb[l_ac].att10 =null                                    
                 LET g_ogb[l_ac].att10_c =null                                  
                 NEXT FIELD att00
              WHEN INFIELD(ogb1001)
                 CALL cl_init_qry_var()
                 LET g_qryparam.default1 = g_ogb[l_ac].ogb1001  #No.TQC-7C0055
                 IF g_aza.aza50 = 'Y' THEN
                    LET g_qryparam.form ="q_azf03"  
                    LET g_qryparam.arg1 ="2"   
                    LET g_qryparam.arg2 ="1"    
                 ELSE
                    LET g_qryparam.form ="q_azf03"  #No.FUN-930104
                    LET g_qryparam.arg1 ="2"        #No.FUN-930104
                    LET g_qryparam.arg2 ="1"        #No.FUN-930104  
                 END IF
                 CALL cl_create_qry() RETURNING g_ogb[l_ac].ogb1001
                 DISPLAY BY NAME g_ogb[l_ac].ogb1001
                 NEXT FIELD ogb1001
       #No.FUN-A90040  begin--           
                WHEN INFIELD(ogb48)
                      CALL cl_init_qry_var()
                      LET g_qryparam.form ="q_lnt06_1"
                      LET g_qryparam.default1 = g_ogb[l_ac].ogb48
                      LET g_qryparam.default2 = g_ogb[l_ac].ogb49
                      LET g_qryparam.arg1 = g_oga.oga83       #FUN-AA0057   
                      LET g_qryparam.arg2 = g_oga.oga02       #FUN-AA0057   
                      CALL cl_create_qry() RETURNING g_ogb[l_ac].ogb48,g_ogb[l_ac].ogb49
                      DISPLAY BY NAME g_ogb[l_ac].ogb48,g_ogb[l_ac].ogb49
                      NEXT FIELD ogb48
          #No.FUN-A90040    end--    

                 
                 WHEN INFIELD(ogb04)
                    #FUN-AA0089--------------------------add start------------------------------
                    IF p_cmd = 'a' AND cl_null(g_oga.oga011) AND cl_null(g_oga.oga16)
                       AND cl_null(g_ogb[l_ac].ogb31) AND cl_null(g_ogb[l_ac].ogb32) THEN
                       CALL q_ima(1,1,g_plant)  RETURNING  g_multi_ima01                   
                       IF NOT cl_null(g_multi_ima01)  THEN 
                          CALL t600_multi_ima01()      
                          IF g_success = 'N' THEN    
                             NEXT FIELD ohb04    
                          END IF                    
                          CALL t600_b1_fill(" 1=1")
                          LET g_flag = TRUE
                          CALL t600_b1()   #FUN-AA0089 101119
                          EXIT INPUT                 
                       END IF
                    ELSE
                    #FUN-AA0089--------------------------add end-------------------------------- 
#FUN-AB0025---------mod------------str-----------------
#                      CALL cl_init_qry_var()                    
#                      IF g_azw.azw04='2' THEN                    
#                         SELECT rtz04 INTO l_rtz04 FROM rtz_file
#                          WHERE rtz01=g_plant
#                         IF NOT cl_null(l_rtz04) THEN
#                            LET g_qryparam.form="q_rte03_3"
#                            LET g_qryparam.arg1= l_rtz04
#                         ELSE
#                            LET g_qryparam.form="q_ima"
#                         END IF
#                      ELSE
#                         LET g_qryparam.form ="q_ima"                                          
#                      END IF  #No.FUN-870007
#                      LET g_qryparam.default1 = g_ogb[l_ac].ogb04                   
#                      CALL cl_create_qry() RETURNING g_ogb[l_ac].ogb04            
                       CALL q_sel_ima(FALSE, "q_ima","",g_ogb[l_ac].ogb04,"","","","","",'' )
                           RETURNING g_ogb[l_ac].ogb04                                        
#FUN-AB0025---------mod------------end-----------------
                       DISPLAY g_ogb[l_ac].ogb04 TO ogb04  #No.MOD-490172            
                       NEXT FIELD ogb04
                    END IF

                WHEN INFIELD(ogb05)
                      CALL cl_init_qry_var()
                      LET g_qryparam.form ="q_gfe"
                      LET g_qryparam.default1 = g_ogb[l_ac].ogb05
                      LET g_qryparam.construct= 'N'
                      CALL cl_create_qry() RETURNING g_ogb[l_ac].ogb05
                      DISPLAY g_ogb[l_ac].ogb05 TO ogb05  #No.MOD-490172
                      NEXT FIELD ogb05
                WHEN INFIELD(ogb09)     #MOD-480604
                    IF g_azw.azw04='2' THEN
                       CALL q_img42(FALSE,TRUE,g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                              g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,'A','1',g_oga.ogaplant)
                        RETURNING g_ogb[l_ac].ogb09,g_ogb[l_ac].ogb091,                                                       
                                  g_ogb[l_ac].ogb092   
                    ELSE
                    CALL q_img4(FALSE,TRUE,g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,'A')
                              RETURNING g_ogb[l_ac].ogb09,g_ogb[l_ac].ogb091,
                                        g_ogb[l_ac].ogb092
                    END IF  #No.FUN-870007
                     IF INT_FLAG THEN
                        LET INT_FLAG = 0
                     END IF

                     DISPLAY BY NAME g_ogb[l_ac].ogb09
                     DISPLAY BY NAME g_ogb[l_ac].ogb091
                     DISPLAY BY NAME g_ogb[l_ac].ogb092
                     NEXT FIELD ogb09

                 WHEN INFIELD(ogb091)
                     IF g_azw.azw04='2' THEN                                                                                        
                        CALL q_img42(FALSE,TRUE,g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,                                               
                              g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,'A','1',g_oga.ogaplant)                                          
                        RETURNING g_ogb[l_ac].ogb09,g_ogb[l_ac].ogb091,                                                             
                                        g_ogb[l_ac].ogb092                                                                          
                     ELSE
                     CALL q_img4(FALSE,TRUE,g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,'A')
                              RETURNING g_ogb[l_ac].ogb09,g_ogb[l_ac].ogb091,
                                        g_ogb[l_ac].ogb092
                     END IF  #No.FUN-870007
                     IF INT_FLAG THEN
                        LET INT_FLAG = 0
                     END IF

                     DISPLAY BY NAME g_ogb[l_ac].ogb09
                     DISPLAY BY NAME g_ogb[l_ac].ogb091
                     DISPLAY BY NAME g_ogb[l_ac].ogb092
                     NEXT FIELD ogb091

                 WHEN INFIELD(ogb908)
                      CALL q_coc2(FALSE,FALSE,g_ogb[l_ac].ogb908,'',g_oga.oga02,
                                  '0','',g_ogb[l_ac].ogb04)
                      RETURNING g_ogb[l_ac].ogb908,l_coc04
                      DISPLAY BY NAME g_ogb[l_ac].ogb908   #MOD-8B0042
                      NEXT FIELD ogb908

                 WHEN INFIELD(ogb910) #單位
                      CALL cl_init_qry_var()
                      LET g_qryparam.form ="q_gfe"
                      LET g_qryparam.default1 = g_ogb[l_ac].ogb910
                      CALL cl_create_qry() RETURNING g_ogb[l_ac].ogb910
                      DISPLAY BY NAME g_ogb[l_ac].ogb910
                      NEXT FIELD ogb910

                 WHEN INFIELD(ogb913) #單位
                      CALL cl_init_qry_var()
                      LET g_qryparam.form ="q_gfe"
                      LET g_qryparam.default1 = g_ogb[l_ac].ogb913
                      CALL cl_create_qry() RETURNING g_ogb[l_ac].ogb913
                      DISPLAY BY NAME g_ogb[l_ac].ogb913
                      NEXT FIELD ogb913

                 WHEN INFIELD(ogb916) #單位
                      CALL cl_init_qry_var()
                      LET g_qryparam.form ="q_gfe"
                      LET g_qryparam.default1 = g_ogb[l_ac].ogb916
                      CALL cl_create_qry() RETURNING g_ogb[l_ac].ogb916
                      DISPLAY BY NAME g_ogb[l_ac].ogb916
                      NEXT FIELD ogb916
                 WHEN INFIELD(ogb65)
                      CALL cl_init_qry_var()
                      LET g_qryparam.form ="q_azf03"  #No.FUN-930104 
                      LET g_qryparam.arg1 = "2"
                      LET g_qryparam.arg2 = "5"       #No.FUN-930104
                      LET g_qryparam.default1 = g_ogb[l_ac].ogb65
                      CALL cl_create_qry() RETURNING g_ogb[l_ac].ogb65
                      DISPLAY BY NAME g_ogb[l_ac].ogb65
                      NEXT FIELD ogb65
                 WHEN INFIELD(ogb930)
                    CALL cl_init_qry_var()
                    LET g_qryparam.form ="q_gem4"
                    CALL cl_create_qry() RETURNING g_ogb[l_ac].ogb930
                    DISPLAY BY NAME g_ogb[l_ac].ogb930
                    NEXT FIELD ogb930
                 OTHERWISE LET g_msg='axmq450 ',g_ogb[l_ac].ogb04
                     CALL cl_cmdrun(g_msg)
            END CASE

        ON ACTION modi_lot
           LET g_ima918 = ''   #MOD-9C0055
           LET g_ima921 = ''   #MOD-9C0055
#FUN-AB0059 ---------------------start---------------------------- 
           IF s_joint_venture( g_ogb[l_ac].ogb04,g_plant) OR NOT s_internal_item( g_ogb[l_ac].ogb04,g_plant ) THEN
           ELSE
#FUN-AB0059 ---------------------end-------------------------------
           SELECT ima918,ima921 INTO g_ima918,g_ima921 
             FROM ima_file
            WHERE ima01 = g_ogb[l_ac].ogb04
              AND imaacti = "Y"
           
           IF g_ima918 = "Y" OR g_ima921 = "Y" THEN
              #非多倉儲出貨才可查詢批/序號資料
              IF g_ogb[l_ac].ogb17 = "N" THEN   #No:FUN-870131
                 #如果是出通單，要判斷參數是否做批序號管理 
                 IF g_argv0 = '1' OR g_argv0 = '5' THEN   #MOD-940294 add
                    IF g_oaz.oaz81='Y' THEN  
                      CALL t600_b1_move_back()
                      CALL t600_b_else()
#No.CHI-9A0022 --Begin
                       IF cl_null(g_ogb[l_ac].ogb41) THEN
                          #FUN-9C0103 ---start----
                          SELECT oea00,oea11,oea12 INTO l_oea00,l_oea11,l_oea12
                            FROM oea_file
                           WHERE oea01 = g_ogb[l_ac].ogb31
                          IF l_oea00 = '4' AND l_oea11 = '7' THEN
                             SELECT oga16 INTO l_oga16
                               FROM oga_file
                              WHERE oga01 = l_oea12
                             LET l_bno = l_oga16
                          ELSE
                          #FUN-9C0103 ---end---
                             LET l_bno = g_ogb[l_ac].ogb31
                          END IF
                       ELSE
                          LET l_bno = g_ogb[l_ac].ogb41
                       END IF
#No.CHI-9A0022 --End
                      CALL s_lotout(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,0,
                                    g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                                    g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                                    g_ogb[l_ac].ogb05,b_ogb.ogb15,b_ogb.ogb15_fac,
                                    g_ogb[l_ac].ogb12,l_bno,'MOD')#CHI-9A0022 add l_bno
                          RETURNING l_r,g_qty
                      IF l_r = "Y" THEN
                         LET g_ogb[l_ac].ogb12 = g_qty
                         DISPLAY BY NAME g_ogb[l_ac].ogb12   #MOD-8B0275
                      END IF
                    END IF
                 ELSE
                    #如果出通單需做批/序號管理，且出通單不為空白
                    IF (g_oaz.oaz81 = 'Y' AND NOT cl_null(g_oga.oga011)) OR   #No:FUN-860045
                       g_argv0 = '8' THEN   #CHI-970040
                      CALL t600_b1_move_back()
                      CALL t600_b_else()
#No.FUN-9C0103 ---start----
                       IF cl_null(g_ogb[l_ac].ogb41) THEN
                          SELECT oea00,oea11,oea12 INTO l_oea00,l_oea11,l_oea12
                            FROM oea_file
                           WHERE oea01 = g_ogb[l_ac].ogb31
                          IF l_oea00 = '4' AND l_oea11 = '7' THEN
                             SELECT oga16 INTO l_oga16
                               FROM oga_file
                              WHERE oga01 = l_oea12
                             LET l_bno = l_oga16
                          ELSE
                             LET l_bno = g_ogb[l_ac].ogb31
                          END IF
                       ELSE
                          LET l_bno = g_ogb[l_ac].ogb41
                       END IF
#No.FUN-9C0103 ---end---
                      CALL s_lotout(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,0,
                                    g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                                    g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                                    g_ogb[l_ac].ogb05,b_ogb.ogb15,b_ogb.ogb15_fac,
                                    g_ogb[l_ac].ogb12,'','SEL')#CHI-9A0022 add ''
                          RETURNING l_r,g_qty
                      IF l_r = "Y" THEN
                         LET g_ogb[l_ac].ogb12 = g_qty
                         DISPLAY BY NAME g_ogb[l_ac].ogb12   #MOD-8B0275
                      END IF
                    ELSE
                      CALL t600_b1_move_back()
                      CALL t600_b_else()
#No.CHI-9A0022 --Begin
                       IF cl_null(g_ogb[l_ac].ogb41) THEN
                          #FUN-9C0103 ---start---
                          SELECT oea00,oea11,oea12 INTO l_oea00,l_oea11,l_oea12
                            FROM oea_file
                           WHERE oea01 = g_ogb[l_ac].ogb31
                          IF l_oea00 = '4' AND l_oea11 = '7' THEN
                             SELECT oga16 INTO l_oga16
                               FROM oga_file
                              WHERE oga01 = l_oea12
                             LET l_bno = l_oga16
                          ELSE
                          #FUN-9C0103 ---end---
                             LET l_bno = g_ogb[l_ac].ogb31
                          END IF
                       ELSE
                          LET l_bno = g_ogb[l_ac].ogb41
                       END IF
#No.CHI-9A0022 --End
                      CALL s_lotout(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,0,
                                    g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                                    g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                                    g_ogb[l_ac].ogb05,b_ogb.ogb15,b_ogb.ogb15_fac,
                                    g_ogb[l_ac].ogb12,l_bno,'MOD')#CHI-9A0022 add l_bno
                          RETURNING l_r,g_qty
                      IF l_r = "Y" THEN
                         LET g_ogb[l_ac].ogb12 = g_qty
                         DISPLAY BY NAME g_ogb[l_ac].ogb12   #MOD-8B0275
                      END IF
                    END IF
                 END IF
              END IF   #No:FUN-870131
           END IF  #FUN-850120 add
         END IF                                        #FUN-AB0059  add   

        ON ACTION CONTROLZ
           CALL cl_show_req_fields()

        ON ACTION CONTROLG
           CALL cl_cmdask()

        ON ACTION CONTROLF
           CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name #Add on 040913
           CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang) #Add on 040913

        AFTER INPUT
           LET g_cnt = 0        #MOD-AB0247 add
           SELECT COUNT(*) INTO g_cnt FROM ogb_file WHERE ogb01=g_oga.oga01
           IF (g_oga.oga08='1' AND g_cnt > g_oaz.oaz691) OR
               #no.A047  增加oga08= '3'
              (g_oga.oga08 MATCHES '[23]' AND g_cnt > g_oaz.oaz692) THEN
               #no.A047(end)
              CALL cl_err('','axm-156',0)
              NEXT FIELD ogb03
           END IF

           IF cl_null(g_oga.oga32) THEN
                   SELECT occ45 INTO g_oga.oga32 FROM occ_file
                    WHERE occ01 = g_oga.oga03
                UPDATE oga_file SET oga32 = g_oga.oga32
                 WHERE oga01 = g_oga.oga01
                  END IF
                display 'sqlca.sqlerrd[3]->',sqlca.sqlerrd[3]
                display 'g_oga.oga32->',g_oga.oga32
 
        ON IDLE g_idle_seconds
           CALL cl_on_idle()
           CONTINUE INPUT

        ON ACTION about         #MOD-4C0121
           CALL cl_about()      #MOD-4C0121

        ON ACTION help          #MOD-4C0121
           CALL cl_show_help()  #MOD-4C0121

      END INPUT

      IF l_exit_sw THEN
         EXIT WHILE
      ELSE
         CONTINUE WHILE
      END IF

    END WHILE

   #MOD-B10154 Begin---
    IF NOT cl_null(g_oga.oga87) THEN
       LET g_oga.oga95= t600_oga95_amount()
       IF cl_null(g_oga.oga95) THEN LET g_oga.oga95=0 END IF
       UPDATE oga_file SET oga95 = g_oga.oga95
                     WHERE oga01 = g_oga.oga01
                       AND oga87 = g_oga.oga87
       IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
          CALL cl_err3("upd","oga_file",g_oga.oga01,"",SQLCA.sqlcode,"","",1)
       END IF
       DISPLAY BY NAME g_oga.oga95
    END IF
   #MOD-B10154 End-----

    UPDATE oga_file SET ogamodu = g_user,ogadate = g_today,oga55=l_oga55
     WHERE oga = g_oga.oga01

    LET g_oga.oga55 = l_oga55

    DISPLAY BY NAME g_oga.oga55
    CALL t600_fetch_price('e')         
    CALL t600_chspic()

    COMMIT WORK

    CLOSE t600_bcl1


    CALL t600_show()   #No:MOD-890181 add

END FUNCTION

FUNCTION t600_add_store(p_item,p_store)
DEFINE p_item    LIKE ima_file.ima01
DEFINE p_store     LIKE ogb_file.ogb09

   IF cl_null(p_item) OR cl_null(p_store) THEN
      RETURN
   END IF
#FUN-AB0011 --------------------STA
#  聯營或非企業料號不新增庫存
    IF s_joint_venture( p_item,g_plant) OR NOT s_internal_item( p_item,g_plant ) THEN
        RETURN
    END IF
#FUN-AB0011 -------------------END
 
  #檢查料倉儲批是否存在，不存在就增加
   LET g_cnt = 0
   SELECT COUNT(*) INTO g_cnt FROM img_file
       WHERE img01 = p_item
         AND img02 = p_store
         AND img03 = ' '
         AND img04 = ' '

   IF g_cnt = 0 OR g_cnt IS NULL THEN
      IF g_sma.sma892[3,3] ='Y' THEN
         IF NOT cl_confirm('mfg1401') THEN RETURN END IF
      END IF
      CALL s_add_img(p_item,p_store,' ',' ',
                     g_oga.oga01,g_ogb[l_ac].ogb03,g_today)
   END IF
END FUNCTION

FUNCTION t600_bp1(p_ud)
   DEFINE   p_ud   LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)

   IF p_ud <> "G" OR g_action_choice = "detail" THEN
      RETURN
   END IF

 #CHI-AC0034 mark --end--
 # IF g_prog = "axmt628" OR g_prog= "axmt629" THEN
 #    CALL cl_set_act_visible("qry_mntn_inv_detail",FALSE)
 # END IF
 #CHI-AC0034 mark --end--

   #-----MOD-A30051---------
   #IF g_prog = "axmt610" THEN
   #   CALL cl_set_act_visible("unit_price",FALSE)
   #END IF
   #-----END MOD-A30051-----

   IF g_prog = "axmt610" THEN
      CALL cl_set_comp_visible("page05",FALSE)
   END IF
   LET g_action_choice = " "

   CALL t600_set_distact()    #No:MOD-530221
   CALL cl_set_act_visible("accept,cancel", FALSE)
   #CHI-AC0002 add --start--
   IF g_aza.aza63 = 'N' THEN
      CALL cl_set_act_visible("entry_sheet2",FALSE)
   END IF
   #CHI-AC0002 add --end--
   IF g_aza.aza23 matches '[ Nn]' THEN
      CALL cl_set_act_visible("easyflow_approval,approval_status",FALSE)
   END IF

   IF (g_prog = "axmt610" OR g_prog = "axmt620")
      AND g_sma.sma115 NOT MATCHES '[Yy]' AND g_sma.sma128 MATCHES '[Yy]' THEN
         CALL cl_set_act_visible("mix_order_auto_generate",TRUE)
   ELSE
         CALL cl_set_act_visible("mix_order_auto_generate",FALSE)
   END IF
#FUN-B30170 add begin-------------------------
   DIALOG ATTRIBUTE(UNBUFFERED) 
      DISPLAY ARRAY g_ogb TO s_b1.* ATTRIBUTE(COUNT=g_rec_b1)    #No.TQC-640123

         BEFORE DISPLAY
            CALL cl_navigator_setting( g_curs_index, g_row_count )
            
         BEFORE ROW
            LET l_ac = ARR_CURR()
            CALL cl_show_fld_cont()                   #No:FUN-550037 hmf
            
         AFTER DISPLAY
            CONTINUE DIALOG   #因為外層是DIALOG
      END DISPLAY 
      
      DISPLAY ARRAY g_rvbs TO s_rvbs.* ATTRIBUTE(COUNT=g_rec_b3)
         BEFORE DISPLAY
            CALL cl_navigator_setting( g_curs_index, g_row_count )

         BEFORE ROW
            LET l_ac3 = ARR_CURR()
            CALL cl_show_fld_cont()

         AFTER DISPLAY
            CONTINUE DIALOG   #因為外層是DIALOG
      END DISPLAY
      
      BEFORE DIALOG
         CALL t600_visible_menu()
         CALL cl_set_act_visible("cancel_price",g_azw.azw04='2') #No.FUN-870007
      
      ON ACTION insert
         LET g_action_choice="insert"
         EXIT DIALOG
      ON ACTION query
         LET g_action_choice="query"
         EXIT DIALOG
      ON ACTION delete
         LET g_action_choice="delete"
         EXIT DIALOG
      ON ACTION modify
         LET g_action_choice="modify"
         EXIT DIALOG
      ON ACTION first
         CALL t600_fetch('F')
         CALL cl_navigator_setting(g_curs_index, g_row_count)   ###add in 040517
         IF g_rec_b1 != 0 THEN        #No.TQC-640123
         CALL fgl_set_arr_curr(1)  ######add in 040505
         END IF
         ACCEPT DIALOG                   #No:FUN-530067 HCN TEST


      ON ACTION previous
         CALL t600_fetch('P')
         CALL cl_navigator_setting(g_curs_index, g_row_count)   ###add in 040517
           IF g_rec_b1 != 0 THEN        #No.TQC-640123
         CALL fgl_set_arr_curr(1)  ######add in 040505
           END IF
          CALL t600_set_distact()   #No:MOD-530221
        ACCEPT DIALOG                   #No:FUN-530067 HCN TEST


      ON ACTION jump
         CALL t600_fetch('/')
         CALL cl_navigator_setting(g_curs_index, g_row_count)   ###add in 040517
           IF g_rec_b1 != 0 THEN        #No.TQC-640123
         CALL fgl_set_arr_curr(1)  ######add in 040505
           END IF
          CALL t600_set_distact()  #No:MOD-530221
        ACCEPT DIALOG                   #No:FUN-530067 HCN TEST


      ON ACTION next
         CALL t600_fetch('N')
         CALL cl_navigator_setting(g_curs_index, g_row_count)   ###add in 040517
           IF g_rec_b1 != 0 THEN        #No.TQC-640123
         CALL fgl_set_arr_curr(1)  ######add in 040505
           END IF
          CALL t600_set_distact()  #No:MOD-530221
        ACCEPT DIALOG                   #No:FUN-530067 HCN TEST


      ON ACTION last
         CALL t600_fetch('L')
         CALL cl_navigator_setting(g_curs_index, g_row_count)   ###add in 040517
           IF g_rec_b1 != 0 THEN        #No.TQC-640123
         CALL fgl_set_arr_curr(1)  ######add in 040505
           END IF
          CALL t600_set_distact()  #No:MOD-530221
        ACCEPT DIALOG                   #No:FUN-530067 HCN TEST

      ON ACTION return
         LET g_b_flag ='2'
         EXIT DIALOG

      ON ACTION detail
         LET g_action_choice="detail"
         LET l_ac = 1
         EXIT DIALOG
      ON ACTION output
         LET g_action_choice="output"
         EXIT DIALOG
      ON ACTION help
         LET g_action_choice="help"
         EXIT DIALOG
      ON ACTION exit
         LET g_action_choice="exit"
         EXIT DIALOG

      ON ACTION controlg
         LET g_action_choice="controlg"
         EXIT DIALOG
      ON ACTION controls                             #No.FUN-6A0092
         CALL cl_set_head_visible("","AUTO")           #No.FUN-6A0092


      ON ACTION unit_price
         LET g_action_choice="unit_price"
         EXIT DIALOG
      #No.FUN-A10106--begin
      ON ACTION kefa  
         LET g_action_choice="kefa"
         EXIT DIALOG
      #No.FUN-A10106--end

#@    ON ACTION 1.文件地址
      ON ACTION address
         LET g_action_choice="address"
         EXIT DIALOG

#@    ON ACTION 2.其它資料
      ON ACTION other_data
         LET g_action_choice="other_data"
         EXIT DIALOG

#@    ON ACTION 3.更改倉儲
      ON ACTION modify_wh_loc
         LET g_action_choice="modify_wh_loc"
         EXIT DIALOG

#@    ON ACTION 4.更改送貨客戶
      ON ACTION modify_shipping_customer
         LET g_action_choice="modify_shipping_customer"
         EXIT DIALOG

#@    ON ACTION I.分錄底稿
      ON ACTION entry_sheet
         LET g_action_choice="entry_sheet"
         EXIT DIALOG

      #CHI-AC0002 add --start--
#@    ON ACTION 分錄底稿二
      ON ACTION entry_sheet2
         LET g_action_choice="entry_sheet2"
         EXIT DIALOG
      #CHI-AC0002 add --end--

#@    ON ACTION V.產生分錄
      ON ACTION gen_entry_sheet
         LET g_action_choice="gen_entry_sheet"
         EXIT DIALOG

#@    ON ACTION 7.出貨相關查詢
      ON ACTION query_delivery
         LET g_action_choice="query_delivery"
         EXIT DIALOG

#@    ON ACTION 8.訂單相關查詢
      ON ACTION order_query
         LET g_action_choice="order_query"
         EXIT DIALOG

#@    ON ACTION 9.客戶相關查詢
      ON ACTION query_customer
         LET g_action_choice="query_customer"
         EXIT DIALOG

      ON ACTION gen_on_check_note
         LET g_action_choice="gen_on_check_note"
         EXIT DIALOG

      ON ACTION qry_on_check_note
         LET g_action_choice="qry_on_check_note"
         EXIT DIALOG

      ON ACTION qry_mntn_inv_detail
         LET g_action_choice="qry_mntn_inv_detail"
         EXIT DIALOG

      ON ACTION mix_order_auto_generate
         LET g_action_choice="mix_order_auto_generate"
         EXIT DIALOG


#@    ON ACTION M.備註
      ON ACTION memo
         LET g_action_choice="memo"
         EXIT DIALOG

    #@ON ACTION easyflow送簽
      ON ACTION easyflow_approval         #FUN-550050
         LET g_action_choice = "easyflow_approval"
         EXIT DIALOG

#@    ON ACTION Y.確認
      ON ACTION confirm
         LET g_action_choice="confirm"
         EXIT DIALOG

#@    ON ACTION W.取消確認
      ON ACTION undo_confirm
         LET g_action_choice="undo_confirm"
         EXIT DIALOG

      ON ACTION cancel_price1  #取消折价
         LET g_action_choice = "cancel_price1"
         EXIT DIALOG
       
#@    ON ACTION 修改扣率
      ON ACTION modify_rate
         LET g_action_choice="modify_rate"
         EXIT DIALOG

#@    ON ACTION   付款                                                                                                   
      ON ACTION pay_money                                                                                                           
         LET g_action_choice = "pay_money"                                                                                          
         EXIT DIALOG

#@    ON ACTION   款別明細 
      ON ACTION money_detail                                                                                                        
         LET g_action_choice = "money_detail"                                                                                       
         EXIT DIALOG

      ON ACTION discount_detail           #FUN-A10110 折價明細
         LET g_action_choice="discount_detail"
         EXIT DIALOG

     #@ON ACTION 簽核狀況
      ON ACTION approval_status
         LET g_action_choice="approval_status"
         EXIT DIALOG
   
#@    ON ACTION S.庫存扣帳
      ON ACTION deduct_inventory
         LET g_action_choice="deduct_inventory"
         EXIT DIALOG

#@    ON ACTION Z.扣帳還原
      ON ACTION undo_deduct
         LET g_action_choice="undo_deduct"
         EXIT DIALOG

#@    ON ACTION G.轉應收發票
      ON ACTION trsf_to_ar_invo
         LET g_action_choice="trsf_to_ar_invo"
         EXIT DIALOG

#@    ON ACTION K.應收維護
      ON ACTION a_r
         LET g_action_choice="a_r"
         EXIT DIALOG

#@    ON ACTION C.信用超限放行
      ON ACTION release_ov_lmt_credit
         LET g_action_choice="release_ov_lmt_credit"
         EXIT DIALOG

#@    ON ACTION X.作廢
      ON ACTION void
         LET g_action_choice="void"
         EXIT DIALOG

#@    ON ACTION 查詢序號
     ON ACTION qry_serialno
        LET g_action_choice = "qry_serialno"
        EXIT DIALOG

      ON ACTION  performance_status
         LET g_action_choice="performance_status"
         EXIT DIALOG

#@    ON ACTION 拋轉至SPC
      ON ACTION trans_spc                      #FUN-680010
         LET g_action_choice="trans_spc"
         EXIT DIALOG

#FUN-A70132 --begin-- 
#@    ON ACTION 實際交易稅別明細       
      ON ACTION trans_tax       #--實際交易稅別明細
         LET g_action_choice="trans_tax"
         EXIT DIALOG      
#FUN-A70132 --end--

#FUN-A70132 --begin-- 
      ON ACTION detail_tax      #--單身稅別明細
         LET g_action_choice="detail_tax"
         EXIT DIALOG 
#FUN-A70132 --end-- 

      ON ACTION accept
         LET g_action_choice="detail"
         LET l_ac = ARR_CURR()
         EXIT DIALOG

      ON ACTION cancel
             LET INT_FLAG=FALSE   #MOD-570244 mars
         LET g_action_choice="exit"
         EXIT DIALOG

      ON ACTION locale
         CALL cl_dynamic_locale()
         CALL cl_show_fld_cont()                   #No:FUN-550037 hmf
         CALL t600_set_perlang() #CHI-710055
         CALL t600_chspic()
         EXIT DIALOG

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE DIALOG

      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
         EXIT DIALOG

      ON ACTION exporttoexcel       #FUN-4B0038
         LET g_action_choice = 'exporttoexcel'
         EXIT DIALOG

     ON ACTION agree
        LET g_action_choice = 'agree'
        EXIT DIALOG

     ON ACTION deny
        LET g_action_choice = 'deny'
        EXIT DIALOG

     ON ACTION modify_flow
        LET g_action_choice = 'modify_flow'
        EXIT DIALOG

     ON ACTION withdraw
        LET g_action_choice = 'withdraw'
        EXIT DIALOG

     ON ACTION org_withdraw
        LET g_action_choice = 'org_withdraw'
        EXIT DIALOG

     ON ACTION phrase
        LET g_action_choice = 'phrase'
        EXIT DIALOG

      ON ACTION related_document                #No:FUN-6A0020  相關文件
         LET g_action_choice="related_document"
         EXIT DIALOG

      ON ACTION style_detail
         LET g_action_choice="style_detail"
         EXIT DIALOG

      &include "qry_string.4gl"

      ON ACTION qry_lot
         LET g_action_choice="qry_lot"
         EXIT DIALOG

      ON ACTION qc_reject_q
         LET g_action_choice="qc_reject_q"          
         EXIT DIALOG

      ON ACTION order_query_b
         LET g_action_choice="order_query_b"
         EXIT DIALOG
   END DIALOG
#FUN-B30170 add -end--------------------------
#FUN-B30170 mark begin--------------------------
#   DISPLAY ARRAY g_ogb TO s_b1.* ATTRIBUTE(COUNT=g_rec_b1,UNBUFFERED)    #No.TQC-640123
#
#      BEFORE DISPLAY
#         CALL t600_visible_menu()
#         CALL cl_navigator_setting( g_curs_index, g_row_count )
#         CALL cl_set_act_visible("cancel_price",g_azw.azw04='2') #No.FUN-870007
#      BEFORE ROW
#         LET l_ac = ARR_CURR()
#         CALL cl_show_fld_cont()                   #No:FUN-550037 hmf
#
#      ON ACTION insert
#         LET g_action_choice="insert"
#         EXIT DISPLAY
#      ON ACTION query
#         LET g_action_choice="query"
#         EXIT DISPLAY
#      ON ACTION delete
#         LET g_action_choice="delete"
#         EXIT DISPLAY
#      ON ACTION modify
#         LET g_action_choice="modify"
#         EXIT DISPLAY
#      ON ACTION first
#         CALL t600_fetch('F')
#         CALL cl_navigator_setting(g_curs_index, g_row_count)   ###add in 040517
#         IF g_rec_b1 != 0 THEN        #No.TQC-640123
#         CALL fgl_set_arr_curr(1)  ######add in 040505
#         END IF
#         ACCEPT DISPLAY                   #No:FUN-530067 HCN TEST
#
#
#      ON ACTION previous
#         CALL t600_fetch('P')
#         CALL cl_navigator_setting(g_curs_index, g_row_count)   ###add in 040517
#           IF g_rec_b1 != 0 THEN        #No.TQC-640123
#         CALL fgl_set_arr_curr(1)  ######add in 040505
#           END IF
#          CALL t600_set_distact()   #No:MOD-530221
#        ACCEPT DISPLAY                   #No:FUN-530067 HCN TEST
#
#
#      ON ACTION jump
#         CALL t600_fetch('/')
#         CALL cl_navigator_setting(g_curs_index, g_row_count)   ###add in 040517
#           IF g_rec_b1 != 0 THEN        #No.TQC-640123
#         CALL fgl_set_arr_curr(1)  ######add in 040505
#           END IF
#          CALL t600_set_distact()  #No:MOD-530221
#        ACCEPT DISPLAY                   #No:FUN-530067 HCN TEST
#
#
#      ON ACTION next
#         CALL t600_fetch('N')
#         CALL cl_navigator_setting(g_curs_index, g_row_count)   ###add in 040517
#           IF g_rec_b1 != 0 THEN        #No.TQC-640123
#         CALL fgl_set_arr_curr(1)  ######add in 040505
#           END IF
#          CALL t600_set_distact()  #No:MOD-530221
#        ACCEPT DISPLAY                   #No:FUN-530067 HCN TEST
#
#
#      ON ACTION last
#         CALL t600_fetch('L')
#         CALL cl_navigator_setting(g_curs_index, g_row_count)   ###add in 040517
#           IF g_rec_b1 != 0 THEN        #No.TQC-640123
#         CALL fgl_set_arr_curr(1)  ######add in 040505
#           END IF
#          CALL t600_set_distact()  #No:MOD-530221
#        ACCEPT DISPLAY                   #No:FUN-530067 HCN TEST
#
#      ON ACTION return
#         LET g_b_flag ='2'
#         EXIT DISPLAY
#
#      ON ACTION detail
#         LET g_action_choice="detail"
#         LET l_ac = 1
#         EXIT DISPLAY
#      ON ACTION output
#         LET g_action_choice="output"
#         EXIT DISPLAY
#      ON ACTION help
#         LET g_action_choice="help"
#         EXIT DISPLAY
#      ON ACTION exit
#         LET g_action_choice="exit"
#         EXIT DISPLAY
#
#      ON ACTION controlg
#         LET g_action_choice="controlg"
#         EXIT DISPLAY
#      ON ACTION controls                             #No.FUN-6A0092
#         CALL cl_set_head_visible("","AUTO")           #No.FUN-6A0092
#
#
#      ON ACTION unit_price
#         LET g_action_choice="unit_price"
#         EXIT DISPLAY
#      #No.FUN-A10106--begin
#      ON ACTION kefa  
#         LET g_action_choice="kefa"
#         EXIT DISPLAY
#      #No.FUN-A10106--end
#
##@    ON ACTION 1.文件地址
#      ON ACTION address
#         LET g_action_choice="address"
#         EXIT DISPLAY
#
##@    ON ACTION 2.其它資料
#      ON ACTION other_data
#         LET g_action_choice="other_data"
#         EXIT DISPLAY
#
##@    ON ACTION 3.更改倉儲
#      ON ACTION modify_wh_loc
#         LET g_action_choice="modify_wh_loc"
#         EXIT DISPLAY
#
##@    ON ACTION 4.更改送貨客戶
#      ON ACTION modify_shipping_customer
#         LET g_action_choice="modify_shipping_customer"
#         EXIT DISPLAY
#
##@    ON ACTION I.分錄底稿
#      ON ACTION entry_sheet
#         LET g_action_choice="entry_sheet"
#         EXIT DISPLAY
#
#      #CHI-AC0002 add --start--
##@    ON ACTION 分錄底稿二
#      ON ACTION entry_sheet2
#         LET g_action_choice="entry_sheet2"
#         EXIT DISPLAY
#      #CHI-AC0002 add --end--
#
##@    ON ACTION V.產生分錄
#      ON ACTION gen_entry_sheet
#         LET g_action_choice="gen_entry_sheet"
#         EXIT DISPLAY
#
##@    ON ACTION 7.出貨相關查詢
#      ON ACTION query_delivery
#         LET g_action_choice="query_delivery"
#         EXIT DISPLAY
#
##@    ON ACTION 8.訂單相關查詢
#      ON ACTION order_query
#         LET g_action_choice="order_query"
#         EXIT DISPLAY
#
##@    ON ACTION 9.客戶相關查詢
#      ON ACTION query_customer
#         LET g_action_choice="query_customer"
#         EXIT DISPLAY
#
#      ON ACTION gen_on_check_note
#         LET g_action_choice="gen_on_check_note"
#         EXIT DISPLAY
#
#      ON ACTION qry_on_check_note
#         LET g_action_choice="qry_on_check_note"
#         EXIT DISPLAY
#
#      ON ACTION qry_mntn_inv_detail
#         LET g_action_choice="qry_mntn_inv_detail"
#         EXIT DISPLAY
#
#&ifdef ICD
#      ON ACTION allott_depot
#         LET g_action_choice="allott_depot"
#         EXIT DISPLAY
#
#      ON ACTION to_delivery
#         LET g_action_choice="to_delivery"
#         EXIT DISPLAY
#
#      ON ACTION aic_s_icdout
#         LET g_action_choice="aic_s_icdout"
#         EXIT DISPLAY
#
#      ON ACTION aic_s_icdqry
#         LET g_action_choice="aic_s_icdqry"
#         EXIT DISPLAY
#&endif
#      ON ACTION mix_order_auto_generate
#         LET g_action_choice="mix_order_auto_generate"
#         EXIT DISPLAY
#
#
##@    ON ACTION M.備註
#      ON ACTION memo
#         LET g_action_choice="memo"
#         EXIT DISPLAY
#
#    #@ON ACTION easyflow送簽
#      ON ACTION easyflow_approval         #FUN-550050
#         LET g_action_choice = "easyflow_approval"
#         EXIT DISPLAY
#
##@    ON ACTION Y.確認
#      ON ACTION confirm
#         LET g_action_choice="confirm"
#         EXIT DISPLAY
#
##@    ON ACTION W.取消確認
#      ON ACTION undo_confirm
#         LET g_action_choice="undo_confirm"
#         EXIT DISPLAY
#
#      ON ACTION cancel_price1  #取消折价
#         LET g_action_choice = "cancel_price1"
#         EXIT DISPLAY
#       
##@    ON ACTION 修改扣率
#      ON ACTION modify_rate
#         LET g_action_choice="modify_rate"
#         EXIT DISPLAY
#
##@    ON ACTION   付款                                                                                                   
#      ON ACTION pay_money                                                                                                           
#         LET g_action_choice = "pay_money"                                                                                          
#         EXIT DISPLAY
#
##@    ON ACTION   款別明細 
#      ON ACTION money_detail                                                                                                        
#         LET g_action_choice = "money_detail"                                                                                       
#         EXIT DISPLAY
#
#      ON ACTION discount_detail           #FUN-A10110 折價明細
#         LET g_action_choice="discount_detail"
#         EXIT DISPLAY
#
#     #@ON ACTION 簽核狀況
#      ON ACTION approval_status
#         LET g_action_choice="approval_status"
#         EXIT DISPLAY
#   
##@    ON ACTION S.庫存扣帳
#      ON ACTION deduct_inventory
#         LET g_action_choice="deduct_inventory"
#         EXIT DISPLAY
#
##@    ON ACTION Z.扣帳還原
#      ON ACTION undo_deduct
#         LET g_action_choice="undo_deduct"
#         EXIT DISPLAY
#
##@    ON ACTION G.轉應收發票
#      ON ACTION trsf_to_ar_invo
#         LET g_action_choice="trsf_to_ar_invo"
#         EXIT DISPLAY
#
##@    ON ACTION K.應收維護
#      ON ACTION a_r
#         LET g_action_choice="a_r"
#         EXIT DISPLAY
#
##@    ON ACTION C.信用超限放行
#      ON ACTION release_ov_lmt_credit
#         LET g_action_choice="release_ov_lmt_credit"
#         EXIT DISPLAY
#
##@    ON ACTION X.作廢
#      ON ACTION void
#         LET g_action_choice="void"
#         EXIT DISPLAY
#
##@    ON ACTION 查詢序號
#     ON ACTION qry_serialno
#        LET g_action_choice = "qry_serialno"
#        EXIT DISPLAY
#
#      ON ACTION  performance_status
#         LET g_action_choice="performance_status"
#         EXIT DISPLAY
#
##@    ON ACTION 拋轉至SPC
#      ON ACTION trans_spc                      #FUN-680010
#         LET g_action_choice="trans_spc"
#         EXIT DISPLAY
#
##FUN-A70132 --begin-- 
##@    ON ACTION 實際交易稅別明細       
#      ON ACTION trans_tax       #--實際交易稅別明細
#         LET g_action_choice="trans_tax"
#         EXIT DISPLAY      
##FUN-A70132 --end--
#
##FUN-A70132 --begin-- 
#      ON ACTION detail_tax      #--單身稅別明細
#         LET g_action_choice="detail_tax"
#         EXIT DISPLAY 
##FUN-A70132 --end-- 
#
#      ON ACTION accept
#         LET g_action_choice="detail"
#         LET l_ac = ARR_CURR()
#         EXIT DISPLAY
#
#      ON ACTION cancel
#             LET INT_FLAG=FALSE   #MOD-570244 mars
#         LET g_action_choice="exit"
#         EXIT DISPLAY
#
#      ON ACTION locale
#         CALL cl_dynamic_locale()
#         CALL cl_show_fld_cont()                   #No:FUN-550037 hmf
#         CALL t600_set_perlang() #CHI-710055
#         CALL t600_chspic()
#         EXIT DISPLAY
#
#      ON IDLE g_idle_seconds
#         CALL cl_on_idle()
#         CONTINUE DISPLAY
#
#      ON ACTION about         #MOD-4C0121
#         CALL cl_about()      #MOD-4C0121
#         EXIT DISPLAY
#
#      ON ACTION exporttoexcel       #FUN-4B0038
#         LET g_action_choice = 'exporttoexcel'
#         EXIT DISPLAY
#
#     ON ACTION agree
#        LET g_action_choice = 'agree'
#        EXIT DISPLAY
#
#     ON ACTION deny
#        LET g_action_choice = 'deny'
#        EXIT DISPLAY
#
#     ON ACTION modify_flow
#        LET g_action_choice = 'modify_flow'
#        EXIT DISPLAY
#
#     ON ACTION withdraw
#        LET g_action_choice = 'withdraw'
#        EXIT DISPLAY
#
#     ON ACTION org_withdraw
#        LET g_action_choice = 'org_withdraw'
#        EXIT DISPLAY
#
#     ON ACTION phrase
#        LET g_action_choice = 'phrase'
#        EXIT DISPLAY
#
#      ON ACTION related_document                #No:FUN-6A0020  相關文件
#         LET g_action_choice="related_document"
#         EXIT DISPLAY
#
#      ON ACTION style_detail
#         LET g_action_choice="style_detail"
#         EXIT DISPLAY
#
#      AFTER DISPLAY
#         CONTINUE DISPLAY
#
#      &include "qry_string.4gl"
#
#      ON ACTION qry_lot
#         LET g_action_choice="qry_lot"
#         EXIT DISPLAY
#
#      ON ACTION qc_reject_q
#         LET g_action_choice="qc_reject_q"          
#         EXIT DISPLAY
#
#      ON ACTION order_query_b
#         LET g_action_choice="order_query_b"
#         EXIT DISPLAY
#
#    END DISPLAY
#FUN-B30170 mark -end---------------------------
    CALL cl_set_act_visible("accept,cancel", TRUE)
#   DISPLAY g_rec_b2 TO FORMONLY.cn2    #No.MOD-670123   #No.TQC-B60161
    DISPLAY g_rec_b1 TO FORMONLY.cn2    #No.TQC-B60161
END FUNCTION

FUNCTION t600_bp2(p_ud)
   DEFINE   p_ud   LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)

   IF p_ud <> "G" OR g_action_choice = "detail" THEN
      RETURN
   END IF

   LET g_action_choice = " "

   CALL t600_set_distact()    #No:MOD-530221
   CALL cl_set_act_visible("accept,cancel", FALSE)
   #CHI-AC0002 add --start--
   IF g_aza.aza63 = 'N' THEN
      CALL cl_set_act_visible("entry_sheet2",FALSE)
   END IF
   #CHI-AC0002 add --end--
   IF g_aza.aza23 matches '[ Nn]' THEN
      CALL cl_set_act_visible("easyflow_approval,approval_status",FALSE)
   END IF
   #FUN-B30170 add begin-------------------------
   DIALOG ATTRIBUTE(UNBUFFERED) 
      DISPLAY ARRAY g_b2 TO s_b2.* ATTRIBUTE(COUNT=g_rec_b2)    #No.TQC-640123

         BEFORE DISPLAY
            CALL cl_navigator_setting( g_curs_index, g_row_count )
            
         BEFORE ROW
            LET l_ac = ARR_CURR()
            CALL cl_show_fld_cont()                   #No:FUN-550037 hmf
            
         AFTER DISPLAY
            CONTINUE DIALOG   #因為外層是DIALOG
      END DISPLAY 
      
      DISPLAY ARRAY g_rvbs TO s_rvbs.* ATTRIBUTE(COUNT=g_rec_b3)
         BEFORE DISPLAY
            CALL cl_navigator_setting( g_curs_index, g_row_count )

         BEFORE ROW
            LET l_ac3 = ARR_CURR()
            CALL cl_show_fld_cont()

         AFTER DISPLAY
            CONTINUE DIALOG   #因為外層是DIALOG
      END DISPLAY
      
      BEFORE DIALOG
         CALL t600_visible_menu()
         
      ON ACTION insert
         LET g_action_choice="insert"
         EXIT DIALOG
      ON ACTION query
         LET g_action_choice="query"
         EXIT DIALOG
      ON ACTION delete
         LET g_action_choice="delete"
         EXIT DIALOG
      ON ACTION modify
         LET g_action_choice="modify"
         EXIT DIALOG
      ON ACTION first
         CALL t600_fetch('F')
         CALL cl_navigator_setting(g_curs_index, g_row_count)   ###add in 040517
         IF g_rec_b2 != 0 THEN      #No.TQC-640123
            CALL fgl_set_arr_curr(1)  ######add in 040505
         END IF
         ACCEPT DIALOG                   #No:FUN-530067 HCN TEST

      ON ACTION previous
         CALL t600_fetch('P')
         CALL cl_navigator_setting(g_curs_index, g_row_count)   ###add in 040517
         IF g_rec_b2 != 0 THEN      #No.TQC-640123
            CALL fgl_set_arr_curr(1)  ######add in 040505
         END IF
         CALL t600_set_distact()   #No:MOD-530221
         ACCEPT DIALOG                   #No:FUN-530067 HCN TEST


      ON ACTION jump
         CALL t600_fetch('/')
         CALL cl_navigator_setting(g_curs_index, g_row_count)   ###add in 040517
         IF g_rec_b2 != 0 THEN      #No.TQC-640123
            CALL fgl_set_arr_curr(1)  ######add in 040505
         END IF
         CALL t600_set_distact()  #No:MOD-530221
         ACCEPT DIALOG                   #No:FUN-530067 HCN TEST


      ON ACTION next
         CALL t600_fetch('N')
         CALL cl_navigator_setting(g_curs_index, g_row_count)   ###add in 040517
         IF g_rec_b2 != 0 THEN      #No.TQC-640123
            CALL fgl_set_arr_curr(1)  ######add in 040505
         END IF
         CALL t600_set_distact()  #No:MOD-530221
         ACCEPT DIALOG                   #No:FUN-530067 HCN TEST

      ON ACTION last
         CALL t600_fetch('L')
         CALL cl_navigator_setting(g_curs_index, g_row_count)   ###add in 040517
         IF g_rec_b2 != 0 THEN      #No.TQC-640123
            CALL fgl_set_arr_curr(1)  ######add in 040505
         END IF
         CALL t600_set_distact()  #No:MOD-530221
         ACCEPT DIALOG                   #No:FUN-530067 HCN TEST

      ON ACTION shipment
         LET g_b_flag ='1'
         EXIT DIALOG

      ON ACTION detail
         LET g_action_choice="detail"
         LET l_ac = 1
         EXIT DIALOG

      ON ACTION output
         LET g_action_choice="output"
         EXIT DIALOG
      #No.FUN-A10106--begin
      ON ACTION kefa  
         LET g_action_choice="kefa"
         EXIT DIALOG
      #No.FUN-A10106--end
      ON ACTION help
         LET g_action_choice="help"
         EXIT DIALOG

      ON ACTION exit
         LET g_action_choice="exit"
         EXIT DIALOG

      ON ACTION controlg
         LET g_action_choice="controlg"
         EXIT DIALOG
      ON ACTION controls                             #No.FUN-6A0092
         CALL cl_set_head_visible("","AUTO")           #No.FUN-6A0092

#@    ON ACTION 1.文件地址
      ON ACTION address
         LET g_action_choice="address"
         EXIT DIALOG

#@    ON ACTION 2.其它資料
      ON ACTION other_data
         LET g_action_choice="other_data"
         EXIT DIALOG

#@    ON ACTION 3.更改倉儲
      ON ACTION modify_wh_loc
         LET g_action_choice="modify_wh_loc"
         EXIT DIALOG

#@    ON ACTION 4.更改送貨客戶
      ON ACTION modify_shipping_customer
         LET g_action_choice="modify_shipping_customer"
         EXIT DIALOG

#@    ON ACTION I.分錄底稿
      ON ACTION entry_sheet
         LET g_action_choice="entry_sheet"
         EXIT DIALOG

      #CHI-AC0002 add --start--
#@    ON ACTION 分錄底稿二
      ON ACTION entry_sheet2
         LET g_action_choice="entry_sheet2"
         EXIT DIALOG
      #CHI-AC0002 add --end--

#@    ON ACTION V.產生分錄
      ON ACTION gen_entry_sheet
         LET g_action_choice="gen_entry_sheet"
         EXIT DIALOG

#@    ON ACTION 7.出貨相關查詢
      ON ACTION query_delivery
         LET g_action_choice="query_delivery"
         EXIT DIALOG

#@    ON ACTION 8.訂單相關查詢
      ON ACTION order_query
         LET g_action_choice="order_query"
         EXIT DIALOG

#@    ON ACTION 9.客戶相關查詢
      ON ACTION query_customer
         LET g_action_choice="query_customer"
         EXIT DIALOG

      ON ACTION gen_on_check_note
         LET g_action_choice="gen_on_check_note"
         EXIT DIALOG

      ON ACTION qry_on_check_note
         LET g_action_choice="qry_on_check_note"
         EXIT DIALOG



#@    ON ACTION M.備註
      ON ACTION memo
         LET g_action_choice="memo"
         EXIT DIALOG

#@    ON ACTION easyflow送簽
      ON ACTION easyflow_approval         #FUN-550050
         LET g_action_choice = "easyflow_approval"
         EXIT DIALOG

#@    ON ACTION Y.確認
      ON ACTION confirm
         LET g_action_choice="confirm"
         EXIT DIALOG

#@    ON ACTION W.取消確認
      ON ACTION undo_confirm
         LET g_action_choice="undo_confirm"
         EXIT DIALOG

     #@ON ACTION 簽核狀況
      ON ACTION approval_status
         LET g_action_choice="approval_status"
         EXIT DIALOG

#@    ON ACTION S.庫存扣帳
      ON ACTION deduct_inventory
         LET g_action_choice="deduct_inventory"
         EXIT DIALOG

#@    ON ACTION Z.扣帳還原
      ON ACTION undo_deduct
         LET g_action_choice="undo_deduct"
         EXIT DIALOG

#@    ON ACTION G.轉應收發票
      ON ACTION trsf_to_ar_invo
         LET g_action_choice="trsf_to_ar_invo"
         EXIT DIALOG

#@    ON ACTION K.應收維護
      ON ACTION a_r
         LET g_action_choice="a_r"
         EXIT DIALOG

#@    ON ACTION C.信用超限放行
      ON ACTION release_ov_lmt_credit
         LET g_action_choice="release_ov_lmt_credit"
         EXIT DIALOG

#@    ON ACTION X.作廢
      ON ACTION void
         LET g_action_choice="void"
         EXIT DIALOG

      ON ACTION  performance_status
         LET g_action_choice="performance_status"
         EXIT DIALOG

#@    ON ACTION 拋轉至SPC
      ON ACTION trans_spc                      #FUN-680010
         LET g_action_choice="trans_spc"
         EXIT DIALOG
         
#FUN-A70132 --begin--
      ON ACTION trans_tax      #--實際交易稅別明細                
         LET g_action_choice="trans_tax"
         EXIT DIALOG
#FUN-A70132 --end--

#FUN-A70132 --begin--
      ON ACTION detail_tax     #--單身稅別明細                      
         LET g_action_choice="detail_tax"
         EXIT DIALOG
#FUN-A70132 --end--

      ON ACTION accept
         LET g_action_choice="detail"
         LET l_ac = ARR_CURR()
         EXIT DIALOG

      ON ACTION cancel
             LET INT_FLAG=FALSE   #MOD-570244 mars
         LET g_action_choice="exit"
         EXIT DIALOG

      ON ACTION locale
         CALL cl_dynamic_locale()
         CALL cl_show_fld_cont()                   #No:FUN-550037 hmf
         CALL t600_set_perlang() #CHI-710055
         CALL t600_chspic()
         EXIT DIALOG

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE DIALOG

      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
         EXIT DIALOG

      ON ACTION exporttoexcel       #FUN-4B0038
         LET g_action_choice = 'exporttoexcel'
         EXIT DIALOG

     ON ACTION agree
        LET g_action_choice = 'agree'
        EXIT DIALOG

     ON ACTION deny
        LET g_action_choice = 'deny'
        EXIT DIALOG

     ON ACTION modify_flow
        LET g_action_choice = 'modify_flow'
        EXIT DIALOG

     ON ACTION withdraw
        LET g_action_choice = 'withdraw'
        EXIT DIALOG

     ON ACTION org_withdraw
        LET g_action_choice = 'org_withdraw'
        EXIT DIALOG

     ON ACTION phrase
        LET g_action_choice = 'phrase'
        EXIT DIALOG

      ON ACTION related_document                #No:FUN-6A0020  相關文件
         LET g_action_choice="related_document"
         EXIT DIALOG

      &include "qry_string.4gl"

      ON ACTION qry_lot
         LET g_action_choice="qry_lot"
         EXIT DIALOG

      ON ACTION qc_reject_q
         LET g_action_choice="qc_reject_q"          
         EXIT DIALOG
   END DIALOG
   #FUN-B30170 add -end---------------------------
#FUN-B30170 mark -begin---------------------------
#   DISPLAY ARRAY g_b2 TO s_b2.* ATTRIBUTE(COUNT=g_rec_b2,UNBUFFERED)       #No.TQC-640123
#
#      BEFORE DISPLAY
#         CALL t600_visible_menu()
#         CALL cl_navigator_setting( g_curs_index, g_row_count )
#
#      BEFORE ROW
#         LET l_ac = ARR_CURR()
#      CALL cl_show_fld_cont()                   #No:FUN-550037 hmf
#
#      ON ACTION insert
#         LET g_action_choice="insert"
#         EXIT DISPLAY
#      ON ACTION query
#         LET g_action_choice="query"
#         EXIT DISPLAY
#      ON ACTION delete
#         LET g_action_choice="delete"
#         EXIT DISPLAY
#      ON ACTION modify
#         LET g_action_choice="modify"
#         EXIT DISPLAY
#      ON ACTION first
#         CALL t600_fetch('F')
#         CALL cl_navigator_setting(g_curs_index, g_row_count)   ###add in 040517
#         IF g_rec_b2 != 0 THEN      #No.TQC-640123
#            CALL fgl_set_arr_curr(1)  ######add in 040505
#         END IF
#         ACCEPT DISPLAY                   #No:FUN-530067 HCN TEST
#
#      ON ACTION previous
#         CALL t600_fetch('P')
#         CALL cl_navigator_setting(g_curs_index, g_row_count)   ###add in 040517
#         IF g_rec_b2 != 0 THEN      #No.TQC-640123
#            CALL fgl_set_arr_curr(1)  ######add in 040505
#         END IF
#         CALL t600_set_distact()   #No:MOD-530221
#         ACCEPT DISPLAY                   #No:FUN-530067 HCN TEST
#
#
#      ON ACTION jump
#         CALL t600_fetch('/')
#         CALL cl_navigator_setting(g_curs_index, g_row_count)   ###add in 040517
#         IF g_rec_b2 != 0 THEN      #No.TQC-640123
#            CALL fgl_set_arr_curr(1)  ######add in 040505
#         END IF
#         CALL t600_set_distact()  #No:MOD-530221
#         ACCEPT DISPLAY                   #No:FUN-530067 HCN TEST
#
#
#      ON ACTION next
#         CALL t600_fetch('N')
#         CALL cl_navigator_setting(g_curs_index, g_row_count)   ###add in 040517
#         IF g_rec_b2 != 0 THEN      #No.TQC-640123
#            CALL fgl_set_arr_curr(1)  ######add in 040505
#         END IF
#         CALL t600_set_distact()  #No:MOD-530221
#         ACCEPT DISPLAY                   #No:FUN-530067 HCN TEST
#
#      ON ACTION last
#         CALL t600_fetch('L')
#         CALL cl_navigator_setting(g_curs_index, g_row_count)   ###add in 040517
#         IF g_rec_b2 != 0 THEN      #No.TQC-640123
#            CALL fgl_set_arr_curr(1)  ######add in 040505
#         END IF
#         CALL t600_set_distact()  #No:MOD-530221
#         ACCEPT DISPLAY                   #No:FUN-530067 HCN TEST
#
#      ON ACTION shipment
#         LET g_b_flag ='1'
#         EXIT DISPLAY
#
#      ON ACTION detail
#         LET g_action_choice="detail"
#         LET l_ac = 1
#         EXIT DISPLAY
#
#      ON ACTION output
#         LET g_action_choice="output"
#         EXIT DISPLAY
#      #No.FUN-A10106--begin
#      ON ACTION kefa  
#         LET g_action_choice="kefa"
#         EXIT DISPLAY
#      #No.FUN-A10106--end
#      ON ACTION help
#         LET g_action_choice="help"
#         EXIT DISPLAY
#
#      ON ACTION exit
#         LET g_action_choice="exit"
#         EXIT DISPLAY
#
#      ON ACTION controlg
#         LET g_action_choice="controlg"
#         EXIT DISPLAY
#      ON ACTION controls                             #No.FUN-6A0092
#         CALL cl_set_head_visible("","AUTO")           #No.FUN-6A0092
#
##@    ON ACTION 1.文件地址
#      ON ACTION address
#         LET g_action_choice="address"
#         EXIT DISPLAY
#
##@    ON ACTION 2.其它資料
#      ON ACTION other_data
#         LET g_action_choice="other_data"
#         EXIT DISPLAY
#
##@    ON ACTION 3.更改倉儲
#      ON ACTION modify_wh_loc
#         LET g_action_choice="modify_wh_loc"
#         EXIT DISPLAY
#
##@    ON ACTION 4.更改送貨客戶
#      ON ACTION modify_shipping_customer
#         LET g_action_choice="modify_shipping_customer"
#         EXIT DISPLAY
#
##@    ON ACTION I.分錄底稿
#      ON ACTION entry_sheet
#         LET g_action_choice="entry_sheet"
#         EXIT DISPLAY
#
#      #CHI-AC0002 add --start--
##@    ON ACTION 分錄底稿二
#      ON ACTION entry_sheet2
#         LET g_action_choice="entry_sheet2"
#         EXIT DISPLAY
#      #CHI-AC0002 add --end--
#
##@    ON ACTION V.產生分錄
#      ON ACTION gen_entry_sheet
#         LET g_action_choice="gen_entry_sheet"
#         EXIT DISPLAY
#
##@    ON ACTION 7.出貨相關查詢
#      ON ACTION query_delivery
#         LET g_action_choice="query_delivery"
#         EXIT DISPLAY
#
##@    ON ACTION 8.訂單相關查詢
#      ON ACTION order_query
#         LET g_action_choice="order_query"
#         EXIT DISPLAY
#
##@    ON ACTION 9.客戶相關查詢
#      ON ACTION query_customer
#         LET g_action_choice="query_customer"
#         EXIT DISPLAY
#
#      ON ACTION gen_on_check_note
#         LET g_action_choice="gen_on_check_note"
#         EXIT DISPLAY
#
#      ON ACTION qry_on_check_note
#         LET g_action_choice="qry_on_check_note"
#         EXIT DISPLAY
#
#
#&ifdef ICD
#      ON ACTION allott_depot
#         LET g_action_choice="allott_depot"
#         EXIT DISPLAY
#
#      ON ACTION to_delivery
#         LET g_action_choice="to_delivery"
#         EXIT DISPLAY
#
#      ON ACTION aic_s_icdout
#         LET g_action_choice="aic_s_icdout"
#         EXIT DISPLAY
#
#      ON ACTION aic_s_icdqry
#         LET g_action_choice="aic_s_icdqry"
#         EXIT DISPLAY
#&endif
#
##@    ON ACTION M.備註
#      ON ACTION memo
#         LET g_action_choice="memo"
#         EXIT DISPLAY
#
##@    ON ACTION easyflow送簽
#      ON ACTION easyflow_approval         #FUN-550050
#         LET g_action_choice = "easyflow_approval"
#         EXIT DISPLAY
#
##@    ON ACTION Y.確認
#      ON ACTION confirm
#         LET g_action_choice="confirm"
#         EXIT DISPLAY
#
##@    ON ACTION W.取消確認
#      ON ACTION undo_confirm
#         LET g_action_choice="undo_confirm"
#         EXIT DISPLAY
#
#     #@ON ACTION 簽核狀況
#      ON ACTION approval_status
#         LET g_action_choice="approval_status"
#         EXIT DISPLAY
#
##@    ON ACTION S.庫存扣帳
#      ON ACTION deduct_inventory
#         LET g_action_choice="deduct_inventory"
#         EXIT DISPLAY
#
##@    ON ACTION Z.扣帳還原
#      ON ACTION undo_deduct
#         LET g_action_choice="undo_deduct"
#         EXIT DISPLAY
#
##@    ON ACTION G.轉應收發票
#      ON ACTION trsf_to_ar_invo
#         LET g_action_choice="trsf_to_ar_invo"
#         EXIT DISPLAY
#
##@    ON ACTION K.應收維護
#      ON ACTION a_r
#         LET g_action_choice="a_r"
#         EXIT DISPLAY
#
##@    ON ACTION C.信用超限放行
#      ON ACTION release_ov_lmt_credit
#         LET g_action_choice="release_ov_lmt_credit"
#         EXIT DISPLAY
#
##@    ON ACTION X.作廢
#      ON ACTION void
#         LET g_action_choice="void"
#         EXIT DISPLAY
#
#      ON ACTION  performance_status
#         LET g_action_choice="performance_status"
#         EXIT DISPLAY
#
##@    ON ACTION 拋轉至SPC
#      ON ACTION trans_spc                      #FUN-680010
#         LET g_action_choice="trans_spc"
#         EXIT DISPLAY
#         
##FUN-A70132 --begin--
#      ON ACTION trans_tax      #--實際交易稅別明細                
#         LET g_action_choice="trans_tax"
#         EXIT DISPLAY
##FUN-A70132 --end--
#
##FUN-A70132 --begin--
#      ON ACTION detail_tax     #--單身稅別明細                      
#         LET g_action_choice="detail_tax"
#         EXIT DISPLAY
##FUN-A70132 --end--
#
#      ON ACTION accept
#         LET g_action_choice="detail"
#         LET l_ac = ARR_CURR()
#         EXIT DISPLAY
#
#      ON ACTION cancel
#             LET INT_FLAG=FALSE   #MOD-570244 mars
#         LET g_action_choice="exit"
#         EXIT DISPLAY
#
#      ON ACTION locale
#         CALL cl_dynamic_locale()
#         CALL cl_show_fld_cont()                   #No:FUN-550037 hmf
#         CALL t600_set_perlang() #CHI-710055
#         CALL t600_chspic()
#         EXIT DISPLAY
#
#      ON IDLE g_idle_seconds
#         CALL cl_on_idle()
#         CONTINUE DISPLAY
#
#      ON ACTION about         #MOD-4C0121
#         CALL cl_about()      #MOD-4C0121
#         EXIT DISPLAY
#
#      ON ACTION exporttoexcel       #FUN-4B0038
#         LET g_action_choice = 'exporttoexcel'
#         EXIT DISPLAY
#
#     ON ACTION agree
#        LET g_action_choice = 'agree'
#        EXIT DISPLAY
#
#     ON ACTION deny
#        LET g_action_choice = 'deny'
#        EXIT DISPLAY
#
#     ON ACTION modify_flow
#        LET g_action_choice = 'modify_flow'
#        EXIT DISPLAY
#
#     ON ACTION withdraw
#        LET g_action_choice = 'withdraw'
#        EXIT DISPLAY
#
#     ON ACTION org_withdraw
#        LET g_action_choice = 'org_withdraw'
#        EXIT DISPLAY
#
#     ON ACTION phrase
#        LET g_action_choice = 'phrase'
#        EXIT DISPLAY
#
#      ON ACTION related_document                #No:FUN-6A0020  相關文件
#         LET g_action_choice="related_document"
#         EXIT DISPLAY
#
#      AFTER DISPLAY
#         CONTINUE DISPLAY
#
#      &include "qry_string.4gl"
#
#      ON ACTION qry_lot
#         LET g_action_choice="qry_lot"
#         EXIT DISPLAY
#
#      ON ACTION qc_reject_q
#         LET g_action_choice="qc_reject_q"          
#         EXIT DISPLAY
#    END DISPLAY
#FUN-B30170 mark --end----------------------------
#   DISPLAY g_rec_b1 TO FORMONLY.cn2    #No.MOD-670123     #No.TQC-B60161
    DISPLAY g_rec_b2 TO FORMONLY.cn2    #No.TQC-B60161
    CALL cl_set_act_visible("accept,cancel", TRUE)
END FUNCTION

FUNCTION t600_after_delete()
   OPEN t600_count
   #FUN-B40096 add
   IF STATUS THEN
      CLOSE t600_count
      RETURN
   END IF
   #FUN-B40096 add--end
   FETCH t600_count INTO g_row_count
   #FUN-B40096 add
   IF STATUS THEN
      CLOSE t600_count
      RETURN
   END IF
   #FUN-B40096 add--end
   DISPLAY g_row_count TO FORMONLY.cnt

   OPEN t600_cs
   IF g_curs_index = g_row_count + 1 THEN
      LET g_jump = g_row_count
      CALL t600_fetch('L')
   ELSE
      LET g_jump = g_curs_index
      LET mi_no_ask = TRUE
      CALL t600_fetch('/')
   END IF
END FUNCTION


FUNCTION t600_b1_chk_2()
   DEFINE l_lock_sw       LIKE type_file.chr1
   DEFINE l_ata02         LIKE ata_file.ata02
   DEFINE l_ata04         LIKE ata_file.ata04

   IF g_prog <> "axmp220" THEN  #TQC-730022
     OPEN t600_cl USING g_oga.oga01   #TQC-9A0115
     IF STATUS THEN
        CALL cl_err("OPEN t600_cl:", STATUS, 1)
        CLOSE t600_cl
        RETURN FALSE,l_lock_sw
     END IF

     FETCH t600_cl INTO g_oga.*  # 鎖住將被更改或取消的資料
     IF SQLCA.sqlcode THEN
        CALL cl_err(g_oga.oga01,SQLCA.sqlcode,0)     # 資料被他人LOCK
        CLOSE t600_cl
        RETURN FALSE,l_lock_sw
     END IF
   END IF   #TQC-730022 add

   IF g_rec_b1 >= l_ac THEN      #No.TQC-640123

      LET g_ogb_t.* = g_ogb[l_ac].*  #BACKUP
      INITIALIZE b_ogb.* TO NULL   #MOD-840638 add
#FUN-A60035 ---MARK BEGIN
##FUN-A50054 --Begin
#&ifdef SLK
##     IF s_industry("slk") THEN
#        DECLARE t600_ata1 SCROLL CURSOR FOR
#         SELECT ata02,ata03,ata04 FROM ata_file
#          WHERE ata00=g_prog
#            AND ata01=g_oga.oga01
#            AND ata02=g_ogb_t.ogb03
#        FOREACH t600_ata1 INTO l_ata02,g_ogb_t.ogb03,l_ata04
#           OPEN t600_bcl1 USING g_oga.oga01,g_ogb_t.ogb03
#           IF STATUS THEN
#              CALL cl_err("OPEN t600_bcl:", STATUS, 1)
#              LET l_lock_sw = "Y"
#           ELSE
#              FETCH t600_bcl1 INTO b_ogb.*
#              IF SQLCA.sqlcode THEN
#                 CALL cl_err('lock ogb',SQLCA.sqlcode,1)
#                 LET l_lock_sw = "Y"
#              END IF
#           END IF
#        END FOREACH
#        LET g_ogb_t.* = g_ogb[l_ac].*
##     ELSE
#&else
##FUN-A50054 --End
#FUN-A60035 ---MARK END
         OPEN t600_bcl1 USING g_oga.oga01,g_ogb_t.ogb03
         IF STATUS THEN
            CALL cl_err("OPEN t600_bcl:", STATUS, 1)
            LET l_lock_sw = "Y"
         ELSE
            FETCH t600_bcl1 INTO b_ogb.*
            IF SQLCA.sqlcode THEN
               CALL cl_err('lock ogb',SQLCA.sqlcode,1)
               LET l_lock_sw = "Y"
            ELSE
               CALL t600_b1_move_to()
               LET g_ogb[l_ac].gem02c=s_costcenter_desc(g_ogb[l_ac].ogb930) #FUN-670063
            END IF
         END IF
#FUN-A60035 ---MARK BEGIN
#&endif
##     END IF
#FUN-A60035 ---MARK END
      LET g_change='N' #No.FUN-540049
      LET g_yes   ='N' #No.FUN-540049
      CALL t600_set_entry_b1('u')
      CALL t600_set_no_entry_b1('u')
      CALL t600_set_no_required_b1('u')
      CALL t600_set_required_b1('u')
      CALL cl_show_fld_cont()     #FUN-550037(smin)
   END IF

   RETURN TRUE,l_lock_sw

END FUNCTION

FUNCTION t321_menu2()

   WHILE TRUE
      IF g_action_choice = "exit" THEN
         EXIT WHILE
      END IF

      CALL t321_bp_t321("G")
      CASE g_action_choice
         WHEN "query"
            IF cl_chk_act_auth() THEN
               CALL t321_q2()
            END IF

         WHEN "confirm_t321"
            IF cl_chk_act_auth() THEN
               CALL t600sub_y_chk(g_oga.oga01)          #CALL 原確認的 check 段
               IF g_success = "Y" THEN
                  CALL t600sub_y_upd(g_oga.oga01,g_action_choice)      #CALL 原確認的 update 段
                  CALL t600sub_refresh(g_oga.oga01) RETURNING g_oga.*  #FUN-730012 重新讀取g_oga
                  CALL t600_chspic() #FUN-730012 add
               END IF
            END IF
            DISPLAY BY NAME g_oga_t321_t.ogaconf
            DISPLAY BY NAME g_oga_t321_t.ogapost
            CALL t321_b1_fill_t321(g_wc3)

         WHEN "undo_confirm_t321"
            IF cl_chk_act_auth() THEN
               CALL t600_w()
            END IF
            DISPLAY BY NAME g_oga_t321_t.ogaconf
            DISPLAY BY NAME g_oga_t321_t.ogapost
            CALL t321_b1_fill_t321(g_wc3)

         WHEN "deduct_inventory_t321"
            IF cl_chk_act_auth() THEN
               CALL t600sub_s('2',FALSE,g_oga.oga01,TRUE)
               CALL t600sub_refresh(g_oga.oga01) RETURNING g_oga.*  #FUN-730012 重新讀取g_oga
               CALL t600_show() #FUN-730012
            END IF
         WHEN "undo_deduct_t321"
            IF cl_chk_act_auth() THEN
               CALL t600_z()   #CHI-8B0048 modify 'z' #MOD-B30464 取消z
            END IF
            DISPLAY BY NAME g_oga_t321_t.ogaconf
            DISPLAY BY NAME g_oga_t321_t.ogapost
            CALL t321_b1_fill_t321(g_wc3)

           WHEN "qry_serialno"
              IF cl_chk_act_auth() THEN
                IF NOT cl_null(g_oga_b[l_ac].oga01_b) THEN
                   CALL t601_5(g_oga_b[l_ac].oga01_b,NULL)
                   LET g_action_choice = "qry_serialno"
                END IF
              END IF


         WHEN "maintain_delivery_date"
            IF cl_chk_act_auth() THEN
               CALL t321_upd_oga02()
            END IF

         WHEN "maintain_detail"
            IF cl_chk_act_auth() THEN
               CALL t600_b_t321()
            END IF
            CALL t321_b1_fill_t321(g_wc3)

         WHEN "view"
            CALL t321_bp3()
        #end FUN-640050 add

         WHEN "help"
# Modify.........: No:FUN-640050 06/04/28 By Sarah 1.atmt321增加一個ACTION"單身維護,開出一個跟出貨單單身一樣的畫面來修改單身資料
#                                                  2.atmt321增加"瀏覽","回單頭"Button,以瀏覽第二個單身資料
            CALL cl_show_help()

         WHEN "exit"
            EXIT WHILE

         WHEN "controlg"
            CALL cl_cmdask()

         WHEN "exporttoexcel"     #FUN-4B0038
            IF cl_chk_act_auth() THEN
              CALL cl_export_to_excel(ui.Interface.getRootNode(),base.TypeInfo.create(g_oga_b),'','')      #No.TQC-740039
            END IF

         WHEN "related_document"           #相關文件
          IF cl_chk_act_auth() THEN
             IF g_oga_t321.oga1016 IS NOT NULL THEN
                LET g_doc.column1 = "oga1016"
                LET g_doc.column2 = "oga02"
                LET g_doc.column3 = "ogaconf"
                LET g_doc.column4 = "ogapost"
                LET g_doc.value1 = g_oga_t321.oga1016
                LET g_doc.value2 = g_oga_t321.oga02
                LET g_doc.value3 = g_oga_t321.ogaconf
                LET g_doc.value4 = g_oga_t321.ogapost
                CALL cl_doc()
             END IF
          END IF
      END CASE
   END WHILE

END FUNCTION

FUNCTION t600_b_t321()
   DEFINE l_wc   STRING
   DEFINE l_flag LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)

   LET p_row = 2 LET p_col = 2

   OPEN WINDOW t321b_w AT p_row,p_col WITH FORM "atm/42f/atmt321b"
   ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN

   CALL cl_ui_locale("atmt321b")

   CALL t600_ui_set()
   CALL cl_set_comp_visible("ogb40",FALSE) #FUN-B50054

   LET l_flag = "Y"

   SELECT * INTO g_oga.* FROM oga_file WHERE oga01 = g_oga.oga01
   IF g_oga.ogaconf = 'X' THEN
      LET l_flag = "N"
      CALL cl_err('',9024,0)
   END IF
   IF g_oga.ogaconf = 'Y' THEN
      LET l_flag = "N"
      CALL cl_err('',9023,0)
   END IF
   IF g_oga.ogapost = 'Y' THEN
      LET l_flag = "N"
      CALL cl_err('','mfg0175',0)
   END IF
   IF g_oga.oga55 matches '[Ss]' THEN       #FUN-550050
      LET l_flag = "N"
      CALL cl_err('','apm-030',0)
   END IF

   IF l_flag = "Y" THEN
      LET l_wc = "oga01 = '",g_oga.oga01,"' AND oga09 = '2'"
      CALL t600_b1_fill(l_wc)         #No.TQC-6C0085

      CALL t600_b1()            #No.TQC-6C0085
   END IF

   CLOSE WINDOW t321b_w
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      RETURN
   END IF

END FUNCTION

####以下為saxmt600 global移過來###

FUNCTION t600_init()
   
   LET g_plant2 = g_plant              #FUN-980020 add
   LET g_dbs2 = s_dbstring(g_dbs CLIPPED)   #FUN-9B0106

   LET g_wc2=' 1=1'
   LET g_wc3=' 1=1'     #No.TQC-640123

    IF cl_null(g_bgjob) THEN
       LET g_bgjob='N'
    END IF
END FUNCTION

FUNCTION t600_ui_set()
DEFINE cb             ui.ComboBox
   CALL cl_set_comp_visible("ogb12b,ogb65,ogb915b,ogb912b",FALSE)
   CALL cl_set_comp_visible("ogb01a,ogb01b",FALSE)
   CALL cl_set_comp_visible("oga01a,oga01b",FALSE) #只有一般出貨單才顯示
   IF g_argv0 MATCHES '[12A465]' THEN
      CALL cl_set_comp_visible("oea01",FALSE)
   END IF
   CALL cl_set_comp_visible("ogb41,ogb42,ogb43",g_aza.aza08='Y')  #FUN-810045 add
  #IF g_aza.aza26 !='2' THEN  #MOD-AC0170
   IF g_aza.aza50 <> 'Y' THEN #MOD-AC0170
      CALL cl_set_comp_visible("page05",FALSE)
   END IF
      CALL cl_set_comp_visible("ogb1005,b2_1005",FALSE)

   CALL cl_set_comp_visible("ogb911,ogb914",FALSE)

   IF (g_aza.aza50='N') OR (g_argv0 ='8') THEN
         CALL cl_set_comp_visible("oga1001,oga1002,oga1003,oga1005,oga1006,oga1007,oga1008,oga1009,oga1010,oga1011,oga1013,oga1015",FALSE)
         CALL cl_set_comp_visible("oga1002_tqa02,oga1009_tqa02,oga1003_tqb02,oga1011_occ02,oga1010_tqb02",FALSE)
      #  CALL cl_set_comp_visible("page05,ogb11,ogb13,ogb14,ogb14t,ogb1002,ogb1003,ogb1004,ogb1005,ogb1006,ogb1012,ima1002,ima135",FALSE)   #No:FUN-660073
        #CALL cl_set_comp_visible("page05,ogb11,ogb37,ogb13,ogb14,ogb14t,ogb1002,ogb1003,ogb1004,ogb1005,ogb1006,ogb1012,ima1002,ima135",FALSE)   #No:FUN-660073 #No:FUN-AB0061 #MOD-B60101 mark
         CALL cl_set_comp_visible("page05,ogb37,ogb13,ogb14,ogb14t,ogb1002,ogb1003,ogb1004,ogb1005,ogb1006,ogb1012,ima1002,ima135",FALSE)   #MOD-B60101
         CALL cl_set_comp_visible("oga50,tot1,tot2,tot3",FALSE)
   END IF
   CALL cl_set_comp_visible("ogb1002",g_azw.azw04='2') #No.FUN-870007
   IF g_prog ='axmt629' THEN
      CALL cl_set_comp_visible("page05",FALSE)
   END IF
   IF g_argv0 MATCHES '[15]' THEN
      CALL cl_set_comp_visible("oga1015,oga1006,oga1013,tot2,tot3,ogb1005,ogb1007,tqw16,tqw08,tqw081,ogb1008,ogb1009,ogb1010,ogb1011",FALSE)
   END IF
   IF g_argv0 MATCHES '[246789]' THEN   #No.FUN-630061
      CALL cl_set_comp_visible("oga1015,oga1008",FALSE)
   END IF
   CALL cl_set_comp_visible("oga1013",FALSE)

   CASE g_argv0
      WHEN "1" #axmt610 出貨通知單
         IF g_oaz.oaz81 = 'Y' THEN
           CALL cl_set_act_visible("qry_lot",TRUE)
         ELSE
           CALL cl_set_act_visible("qry_lot",FALSE)
         END IF
         CALL cl_set_comp_visible("oga65,oga72",TRUE)           #FUN-A60004 add oga72
         CALL cl_set_comp_visible("oga99,oga905",FALSE)
         CALL cl_set_comp_visible("oga1012,oga1014",FALSE)
         CALL cl_set_comp_entry("oga011",FALSE)  #CHI-740016
         CALL cl_set_comp_visible("oga907",FALSE)   #FUN-920072
         LET cb = ui.ComboBox.forName("oga00")
         CALL cb.removeItem('A')
         CALL cb.removeItem('B')
      WHEN "2" #axmt620 一般出貨單
         CALL cl_set_comp_visible("oga65,oga72",TRUE)          #FUN-A60004 add oga72 
         CALL cl_set_comp_visible("oga99,oga905",FALSE)
         CALL cl_set_comp_visible("oga01a,oga01b",TRUE)
         CALL cl_set_comp_visible("oea01",TRUE)   #MOD-950276
         CALL cl_set_comp_visible("oga1012,oga1014",TRUE)
         LET cb = ui.ComboBox.forName("oga00")
         CALL cb.removeItem('A')
         CALL cb.removeItem('B')
      WHEN "3" #沒有
         LET cb = ui.ComboBox.forName("oga00")
         CALL cb.removeItem('A')
         CALL cb.removeItem('B')
      WHEN "4" #axmt820 三角貿易出貨單
         CALL cl_set_comp_visible("oga65,oga72",FALSE)         #FUN-A60004 add oga72
         CALL cl_set_comp_visible("oga1016,a1016_ds",FALSE)
         CALL cl_set_comp_visible("oga1012,oga1014",FALSE)
         CALL cl_set_comp_visible("oga1004,oga1004_occ02,oga1016_occ02",FALSE)
         LET cb = ui.ComboBox.forName("oga00")
         CALL cb.removeItem('A')
         CALL cb.removeItem('B')
      WHEN "5" #axmt850 三角貿易出貨通知單
         CALL cl_set_comp_visible("oga65,oga72",FALSE)        #FUN-A60004 add oga72  
         CALL cl_set_comp_visible("oga1016,a1016_ds",FALSE)
         CALL cl_set_comp_visible("oga69",FALSE)
         CALL cl_set_comp_visible("oga1012,oga1014",FALSE)
         CALL cl_set_comp_visible("oga1004,oga1004_occ02,oga1016_occ02",FALSE)
         CALL cl_set_comp_entry("oga011",FALSE)  #CHI-740016
         CALL cl_set_comp_visible("oga907",FALSE)   #FUN-920072
         LET cb = ui.ComboBox.forName("oga00")
         CALL cb.removeItem('A')
         CALL cb.removeItem('B')
      WHEN "6" #axmt821 代採買三角貿易出貨單
         CALL cl_set_comp_visible("oga65,oga72",FALSE)              #FUN-A60004 add oga72
         CALL cl_set_comp_visible("oga1016,a1016_ds",FALSE)
         CALL cl_set_comp_visible("oga1012,oga1014",FALSE)
         CALL cl_set_comp_visible("oga1004,oga1004_occ02,oga1016_occ02",FALSE)
         LET cb = ui.ComboBox.forName("oga00")
         CALL cb.removeItem('A')
         CALL cb.removeItem('B')
      WHEN "7" #沒有
         LET cb = ui.ComboBox.forName("oga00")
         CALL cb.removeItem('A')
         CALL cb.removeItem('B')
      WHEN "8" #axmt628 客戶驗收單
         CALL cl_set_comp_visible("oga65,oga72",FALSE)    #FUN-A60004 add oga72
         CALL cl_set_comp_visible("oga18_ds",FALSE)
         CALL cl_set_comp_visible("oga65",TRUE)
         CALL cl_set_comp_visible("oga99,oga905",FALSE)
         CALL cl_set_comp_visible("oga1012,oga1014",FALSE)
         CALL cl_set_comp_visible("ogb65",TRUE)
         IF g_sma.sma115='Y' THEN
            CALL cl_set_comp_visible("ogb915b,ogb912b",TRUE)
         ELSE
            CALL cl_set_comp_visible("ogb12b",TRUE)
         END IF
         CALL cl_set_comp_visible("oga907",FALSE)   #FUN-920072
         LET cb = ui.ComboBox.forName("oga00")
         CALL cb.removeItem('A')
         CALL cb.removeItem('B')
      WHEN "9" #axmt629 客戶驗退單
         CALL cl_set_comp_visible("oga65,oga72",FALSE)                 #FUN-A60004 add oga72
         CALL cl_set_comp_visible("oga69",FALSE)
         CALL cl_set_comp_visible("oga99,oga905",FALSE)
         CALL cl_set_comp_visible("oga1012,oga1014",FALSE)
         CALL cl_set_comp_visible("ogb65",TRUE)
         CALL cl_set_comp_visible("oga907",FALSE)   #FUN-920072
         LET cb = ui.ComboBox.forName("oga00")
         CALL cb.removeItem('A')
         CALL cb.removeItem('B')
       WHEN "A"  #axmt640 借貨出貨單
         CALL cl_set_comp_visible("oga65,oga72",FALSE)   #MOD-9B0124  #FUN-A60004 add oga72
         LET cb = ui.ComboBox.forName("oga00")
         CALL cb.removeItem('1')
         CALL cb.removeItem('2')
         CALL cb.removeItem('3')
         CALL cb.removeItem('4')
         CALL cb.removeItem('5')
         CALL cb.removeItem('6')
         CALL cb.removeItem('7')
      OTHERWISE #atmt321

   END CASE

   CALL cl_set_comp_visible("ogb930,gem02c",g_aaz.aaz90='Y') #FUN-670063

   IF g_argv0 NOT MATCHES '[12]' THEN
      CALL cl_set_comp_visible("ogaspc",FALSE)
      CALL cl_set_act_visible("trans_spc",FALSE)
   ELSE
      IF g_aza.aza64 matches '[ Nn]' THEN
         CALL cl_set_comp_visible("ogaspc",FALSE)
         CALL cl_set_act_visible("trans_spc",FALSE)
      END IF
   END IF

   IF g_argv0 MATCHES '[456]' THEN
      LET cb = ui.ComboBox.forName("oga00")
      CALL cb.removeItem('3')
      CALL cb.removeItem('4')
      CALL cb.removeItem('5')
      CALL cb.removeItem('6') #FUN-710016
      CALL cb.removeItem('7')
      CALL cl_set_act_visible("modify_shipping_customer",FALSE)  #TQC-820014
   END IF

   IF g_sma.sma115 ='N' THEN
      CALL cl_set_comp_visible("ogb913,ogb914,ogb915",FALSE)
      CALL cl_set_comp_visible("ogb910,ogb911,ogb912",FALSE)
   ELSE
      CALL cl_set_comp_visible("ogb05,ogb12",FALSE)
   END IF

   IF g_sma.sma116 MATCHES '[01]' THEN    #No:FUN-610076
      CALL cl_set_comp_visible("ogb916,ogb917",FALSE)
   END IF

   CALL t600_set_perlang() #CHI-710055

    #初始化界面的樣式(沒有任何默認屬性組)
    LET lg_oay22 = ''
    LET lg_group = ''
    CALL t600_refresh_detail()
END FUNCTION

FUNCTION t600_set_perlang()
   IF g_sma.sma122 ='1' THEN
      CALL cl_getmsg('asm-302',g_lang) RETURNING g_msg
      CALL cl_set_comp_att_text("ogb913",g_msg CLIPPED)
      CALL cl_getmsg('asm-306',g_lang) RETURNING g_msg
      CALL cl_set_comp_att_text("ogb915",g_msg CLIPPED)
      CALL cl_getmsg('asm-303',g_lang) RETURNING g_msg
      CALL cl_set_comp_att_text("ogb910",g_msg CLIPPED)
      CALL cl_getmsg('asm-307',g_lang) RETURNING g_msg
      CALL cl_set_comp_att_text("ogb912",g_msg CLIPPED)
   END IF

   IF g_sma.sma122 ='2' THEN
      CALL cl_getmsg('asm-304',g_lang) RETURNING g_msg
      CALL cl_set_comp_att_text("ogb913",g_msg CLIPPED)
      CALL cl_getmsg('asm-308',g_lang) RETURNING g_msg
      CALL cl_set_comp_att_text("ogb915",g_msg CLIPPED)
      CALL cl_getmsg('asm-326',g_lang) RETURNING g_msg
      CALL cl_set_comp_att_text("ogb910",g_msg CLIPPED)
      CALL cl_getmsg('asm-327',g_lang) RETURNING g_msg
      CALL cl_set_comp_att_text("ogb912",g_msg CLIPPED)
   END IF

   IF g_argv0 MATCHES '[15]' THEN             #No.FUN-710046
      CALL cl_getmsg('axm-370',g_lang) RETURNING g_msg
      CALL cl_set_comp_att_text("oga01",g_msg CLIPPED)
      CALL cl_getmsg('axm-371',g_lang) RETURNING g_msg
      CALL cl_set_comp_att_text("oga02",g_msg CLIPPED)
      CALL cl_getmsg('axm-372',g_lang) RETURNING g_msg
      CALL cl_set_comp_att_text("oga011",g_msg CLIPPED)
      CALL cl_getmsg('axm-665',g_lang) RETURNING g_msg   #MOD-A40013
      CALL cl_set_comp_att_text("oga021",g_msg CLIPPED)  #MOD-A40013
   END IF
   IF g_argv0 = '8' THEN
      IF g_sma.sma115 = 'Y' THEN
         CALL cl_set_comp_visible("ogb915b,ogb912b,ogb65",TRUE)
         IF g_sma.sma122 ='1' THEN
            CALL cl_getmsg('asm-415',g_lang) RETURNING g_msg
            CALL cl_set_comp_att_text("ogb915b",g_msg CLIPPED)
            CALL cl_getmsg('asm-416',g_lang) RETURNING g_msg
            CALL cl_set_comp_att_text("ogb912b",g_msg CLIPPED)
         END IF
         IF g_sma.sma122 ='2' THEN
            CALL cl_getmsg('asm-417',g_lang) RETURNING g_msg
            CALL cl_set_comp_att_text("ogb915b",g_msg CLIPPED)
            CALL cl_getmsg('asm-418',g_lang) RETURNING g_msg
            CALL cl_set_comp_att_text("ogb912b",g_msg CLIPPED)
         END IF
      END IF
   END IF
   IF g_oaz.oaz23 = 'Y' THEN
      CALL cl_getmsg('axm-042',g_lang) RETURNING g_msg
      CALL cl_set_comp_att_text("ogb17",g_msg CLIPPED)   #No.TQC-640123
   END IF
END FUNCTION

FUNCTION t600_g_b()                  #由出貨通知單/訂單自動產生單身

   SELECT COUNT(*) INTO g_cnt FROM ogb_file WHERE ogb01=g_oga.oga01
   IF g_cnt = 0 THEN
      IF NOT cl_null(g_oga.oga011) THEN
         IF g_argv0= '8' THEN
            CALL t600_g_b3()
         ELSE
            CALL t600_g_b1()
         END IF
      END IF
   END IF

   SELECT COUNT(*) INTO g_cnt FROM ogb_file WHERE ogb01=g_oga.oga01
   IF g_cnt = 0 THEN
      IF NOT cl_null(g_oga.oga16) THEN
         CALL t600_g_b2()
      END IF
      CALL t600_oeo(g_oga.oga16) #BugNo:4541
   END IF

   CALL t600_b1_fill(' 1=1')   #No.TQC-640123
   CALL t600_b2_fill(' 1=1')   #No.TQC-640123

   LET l_ac = 1


END FUNCTION

FUNCTION t600_g_b1()                  #由出貨通知單產生單身
   DEFINE l_ogb12a   LIKE ogb_file.ogb12,
          l_ogb12b   LIKE ogb_file.ogb12
   DEFINE l_ogb      RECORD LIKE ogb_file.*
   DEFINE l_ogb912a  LIKE ogb_file.ogb912,
          l_ogb912b  LIKE ogb_file.ogb912,
          l_ogb915a  LIKE ogb_file.ogb915,
          l_ogb915b  LIKE ogb_file.ogb915,
          l_ogb917a  LIKE ogb_file.ogb917,
          l_ogb917b  LIKE ogb_file.ogb917
#   DEFINE l_ata      RECORD LIKE ata_file.*  #FUN-A50054    #FUN-A60035 ---MARK
   DEFINE l_rvbs     RECORD LIKE rvbs_file.*  #No:FUN-850100
   DEFINE l_rvbs06a  LIKE rvbs_file.rvbs06  #No:FUN-850100
   DEFINE l_rvbs06b  LIKE rvbs_file.rvbs06  #No:FUN-850100
   DEFINE l_ogb05    LIKE ogb_file.ogb05    #NO.FUN-960130
   DEFINE l_oeb70    LIKE oeb_file.oeb70   #MOD-A70182

   LET g_chr2 = '1'  #No.FUN-640074

   IF NOT cl_confirm('axm-130') THEN
      LET g_chr2 = '0'  #No.FUN-640074
      RETURN
   END IF

   DROP TABLE x

   IF NOT cl_null(g_oga.oga011) AND NOT cl_null(g_oga.oga16) THEN
      SELECT * FROM ogb_file
       WHERE ogb01 = g_oga.oga011
         AND ogb31 = g_oga.oga16
        INTO TEMP x
   ELSE
      SELECT * FROM ogb_file
       WHERE ogb01 = g_oga.oga011
        INTO TEMP x
   END IF

   IF STATUS THEN
      CALL cl_err('into x',STATUS,1)
      LET g_success = 'N'
   END IF

   UPDATE x SET ogb01=g_oga.oga01
   IF STATUS THEN
      CALL cl_err3("upd","x","g_oga.oga01","",SQLCA.sqlcode,"","upd x",1)  #No.FUN-670008
      LET g_success = 'N'
   END IF
   #No.B439 010424 by linda add 出貨量要扣除未確認之出貨量

   DECLARE t600_g_ogb CURSOR FOR SELECT * FROM x
                                  WHERE ogb01 = g_oga.oga01

   FOREACH t600_g_ogb INTO l_ogb.*
      #檢查出貨數必須<=通知單應出數(ogb12)-累計出貨數(ogb19)
      #對應到的出貨通知單上的數量
      LET l_ogb12a = 0
      SELECT SUM(ogb12),SUM(ogb912),SUM(ogb915),SUM(ogb917)
        INTO l_ogb12a,l_ogb912a,l_ogb915a,l_ogb917a
        FROM ogb_file,oga_file
       WHERE ogb01 = oga01 AND oga09 IN ('1','5')  #No.7992
         AND oga01 = g_oga.oga011
         AND ogb03 = l_ogb.ogb03 #MOD-4B0107      #MOD-910183	#MOD-980238 remrk
         AND ogb31 = l_ogb.ogb31
         AND ogb32 = l_ogb.ogb32
         AND ogb04 = l_ogb.ogb04 #BugNo:4541
         AND ogaconf != 'X'   #No:MOD-570312

      IF cl_null(l_ogb12a)  THEN LET l_ogb12a = 0 END IF
      IF cl_null(l_ogb912a) THEN LET l_ogb912a= 0 END IF
      IF cl_null(l_ogb915a) THEN LET l_ogb915a= 0 END IF
      IF cl_null(l_ogb917a) THEN LET l_ogb917a= 0 END IF
      # 此出貨通知單已耗用在出貨單的量
      LET l_ogb12b = 0
      SELECT SUM(ogb12),SUM(ogb912),SUM(ogb915),SUM(ogb917)
        INTO l_ogb12b,l_ogb912b,l_ogb915b,l_ogb917b
        FROM ogb_file,oga_file
         WHERE ogb01 = oga01 AND oga09 IN ('2','4','6') #No.7992  #No.FUN-630061
           AND oga011 = g_oga.oga011
           AND ogb03 = l_ogb.ogb03 #MOD-4B0107    #MOD-910183	#MOD-980238 remrk
           AND ogb31 = l_ogb.ogb31
           AND ogb32 = l_ogb.ogb32
           AND ogb04 = l_ogb.ogb04 #BugNo:4541
            AND ogaconf != 'X'   #No:MOD-570312
      IF cl_null(l_ogb12b)  THEN LET l_ogb12b = 0 END IF
      IF cl_null(l_ogb912b) THEN LET l_ogb912b= 0 END IF
      IF cl_null(l_ogb915b) THEN LET l_ogb915b= 0 END IF
      IF cl_null(l_ogb917b) THEN LET l_ogb917b= 0 END IF
      LET l_ogb.ogb12 = l_ogb12a - l_ogb12b
      LET l_ogb.ogb912= l_ogb912a- l_ogb912b
      LET l_ogb.ogb915= l_ogb915a- l_ogb915b
      LET l_ogb.ogb917= l_ogb917a- l_ogb917b
      LET l_ogb.ogb16 = l_ogb.ogb12 * l_ogb.ogb15_fac
      IF g_oga.oga213 = 'N' THEN
          LET l_ogb.ogb14 =l_ogb.ogb12*l_ogb.ogb13
          LET l_ogb.ogb14t=l_ogb.ogb14*(1+g_oga.oga211/100)
      ELSE
          LET l_ogb.ogb14t=l_ogb.ogb12*l_ogb.ogb13
          LET l_ogb.ogb14 =l_ogb.ogb14t/(1+g_oga.oga211/100)
      END IF
      CALL cl_digcut(l_ogb.ogb14,t_azi04) RETURNING l_ogb.ogb14  #MOD-840078 modify g->t
      CALL cl_digcut(l_ogb.ogb14t,t_azi04)RETURNING l_ogb.ogb14t #MOD-840078 modify

      #-----MOD-A70182---------
      LET l_oeb70 = ''
      SELECT oeb70 INTO l_oeb70 FROM oeb_file
         WHERE oeb01 = l_ogb.ogb31
           AND oeb03 = l_ogb.ogb32
      IF l_oeb70 = 'Y' THEN 
         LET l_ogb.ogb12 = 0 
      END IF
      #-----END MOD-A70182-----
      #MOD-B80048 -- begin --
      IF cl_null(l_ogb.ogb091) THEN
         LET l_ogb.ogb091 = ' '
      END IF  
      IF cl_null(l_ogb.ogb092) THEN
         LET l_ogb.ogb092 = ' '
      END IF  
      #MOD-B80048 -- end --

      UPDATE x SET ogb12 = l_ogb.ogb12,
                   #ogb19 = 'N', #CHI-870023   #CHI-880006
                   ogb16 = l_ogb.ogb16,
                   ogb1014 = 'N',       #FUN-6A0007
                   ogb37 = l_ogb.ogb37,  #FUN-AB0061 
                   ogb13 = l_ogb.ogb13, #NO.FUN-960130
                   ogb14 = l_ogb.ogb14,
                   ogb14t = l_ogb.ogb14t,
                   ogb912= l_ogb.ogb912,  #No.FUN-540049
                   ogb915= l_ogb.ogb915,  #No.FUN-540049
                   ogb917= l_ogb.ogb917,  #No.FUN-540049
                   ogb091= l_ogb.ogb091,  #MOD-B80048 add ,
                   ogb092= l_ogb.ogb092    #MOD-B80048
       WHERE ogb01=l_ogb.ogb01
         AND ogb03 = l_ogb.ogb03

      LET g_ima918 = ''   #MOD-9C0055
      LET g_ima921 = ''   #MOD-9C0055
      SELECT ima918,ima921 INTO g_ima918,g_ima921 
        FROM ima_file
       WHERE ima01 = l_ogb.ogb04
         AND imaacti = "Y"
#FUN-A60035 ---MARK BEGIN
##FUN-A50054 --Begin
#&ifdef SLK
##     IF s_industry("slk") THEN
#        SELECT * INTO l_ata.* 
#          FROM ata_file 
#         WHERE ata00='axmt610_slk'
#           AND ata01=g_oga.oga011
#           AND ata03=l_ogb.ogb03
#        LET l_ata.ata00=g_prog
#        LET l_ata.ata01=g_oga.oga01
#        INSERT INTO ata_file VALUES(l_ata.*)
##     END IF
#&endif
##FUN-A50054 --End
#FUN-A60035 ---MARK END
      
      IF g_ima918 = "Y" OR g_ima921 = "Y" THEN
         DECLARE t600_g_rvbs CURSOR FOR SELECT * FROM rvbs_file
                                        WHERE rvbs01 = g_oga.oga011
                                          AND rvbs02 = l_ogb.ogb03
         
         FOREACH t600_g_rvbs INTO l_rvbs.*
            IF STATUS THEN
               CALL cl_err('rvbs',STATUS,1)
            END IF
         
            LET l_rvbs.rvbs00 = g_prog
            LET l_rvbs.rvbs01 = g_oga.oga01
         
            #檢查出貨數必須 =通知單應出數-累計出貨數
            #對應到的出貨通知單上的數量
            LET l_rvbs06a = 0

            SELECT SUM(rvbs06) INTO l_rvbs06a
              FROM rvbs_file
             WHERE rvbs01= g_oga.oga011
               AND rvbs02= l_ogb.ogb03
               AND rvbs13 = l_rvbs.rvbs13   #No:FUN-870131
               AND rvbs09 = -1   #No:FUN-860045
               AND rvbs022 = l_rvbs.rvbs022   #No:CHI-8A0005
            
            IF cl_null(l_rvbs06a) THEN
               LET l_rvbs06a = 0
            END IF

            # 此出貨通知單已耗用在出貨單的量
            LET l_rvbs06b = 0

            SELECT SUM(rvbs06) INTO l_rvbs06b
              FROM ogb_file,oga_file,rvbs_file
             WHERE ogb01 = oga01 AND oga09 IN ('2','4','6') 
               AND oga011 = g_oga.oga011
               AND ogb03 = l_ogb.ogb03
               AND oga01 = rvbs01
               AND ogb03 = rvbs02
               AND rvbs13 = l_rvbs.rvbs13   #No:FUN-870131
               AND rvbs09 = -1   #No:FUN-860045
               AND ogaconf != 'X' 
               AND rvbs022 = l_rvbs.rvbs022   #No:CHI-8A0005

            IF cl_null(l_rvbs06b) THEN
               LET l_rvbs06b = 0
            END IF

            LET l_rvbs.rvbs06 = l_rvbs06a - l_rvbs06b

            LET l_rvbs.rvbsplant = g_plant 
            LET l_rvbs.rvbslegal = g_legal  

            INSERT INTO rvbs_file VALUES(l_rvbs.*)
            IF STATUS OR SQLCA.SQLCODE THEN
               CALL cl_err3("ins","rvbs_file","","",SQLCA.sqlcode,"","ins rvbs",1)  #No.FUN-670008
               LET g_success='N'
            END IF
         
         END FOREACH
      END IF

   END FOREACH

   IF cl_null(l_ogb.ogb05_fac) THEN
     LET l_ogb.ogb05_fac = 1
   END IF

   IF cl_null(l_ogb.ogb12) THEN
     LET l_ogb.ogb12 = 0
   END IF
#FUN-AB0061 -----------add start----------------                          
   IF cl_null(l_ogb.ogb37)  THEN           
      LET l_ogb.ogb37= 0                        
   END IF                                                                             
#FUN-AB0061 -----------add end----------------  
   IF cl_null(l_ogb.ogb13) THEN
     LET l_ogb.ogb13 = 0
   END IF

   IF cl_null(l_ogb.ogb14) THEN
     LET l_ogb.ogb14 = 0
   END IF

   IF cl_null(l_ogb.ogb14t) THEN
     LET l_ogb.ogb14t = 0
   END IF

   IF cl_null(l_ogb.ogb15_fac) THEN
      LET l_ogb.ogb15_fac = 1
   END IF

   IF cl_null(l_ogb.ogb16) THEN
      LET l_ogb.ogb16 = 0
   END IF

   IF cl_null(l_ogb.ogb18) THEN
      LET l_ogb.ogb18 = 0
   END IF

   IF cl_null(l_ogb.ogb60) THEN
      LET l_ogb.ogb60 = 0
   END IF

   IF cl_null(l_ogb.ogb63) THEN
      LET l_ogb.ogb63 = 0
   END IF

   IF cl_null(l_ogb.ogb64) THEN
      LET l_ogb.ogb64 = 0
   END IF

   IF cl_null(l_ogb.ogb1006) THEN
      LET l_ogb.ogb1006 = 100
   END IF
   
   #add by huyx110916---start---
   IF cl_null(l_ogb.ogbud07) THEN LET l_ogb.ogbud07=0 END IF
   IF cl_null(l_ogb.ogbud08) THEN LET l_ogb.ogbud08=0 END IF
   IF cl_null(l_ogb.ogbud09) THEN LET l_ogb.ogbud09=0 END IF
   #add by huyx110916---end---

   INSERT INTO ogb_file SELECT * FROM x WHERE ogb12 > 0
                                           OR ogb03 >=9001  #No.TQC-740349
   IF STATUS OR SQLCA.SQLCODE THEN
      CALL cl_err3("ins","ogb_file","","",SQLCA.sqlcode,"","ins ogb",1)  #No.FUN-670008
      LET g_success='N'
   END IF

   # 多倉儲亦要轉
   DROP TABLE x
   SELECT * FROM ogc_file WHERE ogc01 = g_oga.oga011 INTO TEMP x
   IF STATUS THEN
      CALL cl_err3("ins","x","g_oga.oga011","",SQLCA.sqlcode,"","into x",1)  #No.FUN-670008
      LET g_success='N'
   END IF
   UPDATE x SET ogc01=g_oga.oga01
   IF STATUS THEN
      CALL cl_err3("upd","x","g_oga.oga01","",SQLCA.sqlcode,"","upd x",1)  #No.FUN-670008
      LET g_success='N'
   END IF
   INSERT INTO ogc_file SELECT * FROM x
           WHERE ogc03 IN (SELECT ogb03 FROM ogb_file WHERE ogb01=g_oga.oga01)
   IF STATUS OR SQLCA.SQLCODE THEN
      CALL cl_err3("ins","ogc_file","","",SQLCA.sqlcode,"","ins ogb",1)  #No.FUN-670008
      LET g_success='N'
   END IF
   IF g_sma.sma115 = 'Y' THEN 
      DROP TABLE x
      SELECT * FROM ogg_file WHERE ogg01 = g_oga.oga011 INTO TEMP x
      IF STATUS THEN 
         CALL cl_err3("ins","x","g_oga.oga011","",SQLCA.sqlcode,"","into x",1)  
         LET g_success='N' 
      END IF
      UPDATE x SET ogg01=g_oga.oga01
      IF STATUS THEN 
         CALL cl_err3("upd","x","g_oga.oga01","",SQLCA.sqlcode,"","upd x",1)  
         LET g_success='N' 
      END IF
      INSERT INTO ogg_file SELECT * FROM x 
              WHERE ogg03 IN (SELECT ogb03 FROM ogb_file WHERE ogb01=g_oga.oga01)
      IF STATUS OR SQLCA.SQLCODE THEN
         CALL cl_err3("ins","ogg_file","","",SQLCA.sqlcode,"","ins ogg",1)  
         LET g_success='N'
      END IF
   END IF
   #-----MOD-B40263---------
   DROP TABLE x
   SELECT * FROM oao_file WHERE oao01 = g_oga.oga011 AND oao03 <> 0 INTO TEMP x
   UPDATE x SET oao01 = g_oga.oga01
   DELETE FROM oao_file WHERE oao01 = g_oga.oga01 AND oao03 <> 0
   INSERT INTO oao_file SELECT * FROM x
   #-----END MOD-B40263-----
END FUNCTION

FUNCTION t600_g_b2()                  #由訂單產生單身
#FUN-A60035 ---MARK BEGIN
#   #FUN-A50054 --Begin
#   DEFINE l_ps             LIKE type_file.chr1
#   DEFINE l_str,l_str1     STRING
#   #FUN-A50054 --End
#FUN-A60035 ---MARK END
   DEFINE n1,n2         LIKE type_file.num10   #No.FUN-680137 INTEGER

   SELECT * INTO g_oea.* FROM oea_file WHERE oea01=g_oga.oga16  #MOD-930130
   IF g_oea.oea37 = "Y" THEN
      SELECT COUNT(*) INTO n1 FROM oee_file,oeb_file,ima_file,oea_file #CHI-6B0036 add oea_file
       WHERE oeb01=g_oga.oga16 AND oeb04=ima_file.ima01
         AND oea01 = oeb01 AND oeaconf !='X'  #CHI-6B0036
         AND oee10 = oeb01 AND oee11 = oeb03
         AND (oee083-oeb24+oeb25)>0 AND oeb70='N'

      SELECT COUNT(*) INTO n2 FROM oee_file,oeb_file,ima_file,oea_file #CHI-6B0036 add oea_file
       WHERE oeb01=g_oga.oga16 AND oeb04=ima_file.ima01 AND ima15='Y'
         AND oea01 = oeb01 AND oeaconf !='X'   #CHI-6B0036
         AND oee10 = oeb01 AND oee11 = oeb03
         AND (oee083-oeb24+oeb25)>0 AND oeb70='N'
   ELSE
      SELECT COUNT(*) INTO n1 FROM oeb_file,ima_file,oea_file  #CHI-6B0036 add oea_file
       WHERE oeb01=g_oga.oga16 AND oeb04=ima_file.ima01
         AND oea01=oeb01 AND oeaconf !='X'  #CHI-6B0036
         AND (oeb12-oeb24+oeb25)>0 AND oeb70='N'

      SELECT COUNT(*) INTO n2 FROM oeb_file,ima_file,oea_file  #CHI-6B0036 add oea_file
       WHERE oeb01=g_oga.oga16 AND oeb04=ima_file.ima01 AND ima15='Y'
         AND oea01 = oeb01 AND oeaconf !='X'  #CHI-6B0036
         AND (oeb12-oeb24+oeb25)>0 AND oeb70='N'
   END IF
   # 外銷 或 全為保稅 或 全非保稅 => 轉一張貨單 971029 Roger

   IF g_oga.oga08='2' OR n1=n2 OR n2=0 THEN
#      LET g_ata00 = 'axmt410_slk'              #FUN-A50054      #FUN-A60035 ---MARK
      #No.8876 加判斷訂單轉出貨單、訂單轉出貨通知單 show 不同訊息
      IF g_oga.oga09 MATCHES '[15]' THEN
          IF cl_confirm('axm-363') THEN         #No:MOD-570333
           CALL t600_g_b2_p(g_oga.oga01,'ALL')   
            
         END IF
      ELSE
         IF cl_confirm('axm-132') THEN           #MOD-4A0095
            CALL t600_g_b2_p(g_oga.oga01,'ALL')   
         END IF
      END IF
      CALL t600_ins_oao('o')   #MOD-B40263
      RETURN
   END IF

   # 內銷且訂單含保稅及非保稅時, 須拆成兩張出貨單 971029 Roger
   LET p_row = 2 LET p_col = 20

   OPEN WINDOW t600g_w AT p_row,p_col WITH FORM "axm/42f/axmt600g"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN

   CALL cl_ui_locale("axmt600g")

   LET g_type = '2' #1.整張轉貨單 2.保稅非保稅轉二張貨單 3.僅轉保稅 4.非保稅

   INPUT BY NAME g_type WITHOUT DEFAULTS
        IF INT_FLAG THEN
           LET INT_FLAG=0
           CLOSE WINDOW t600g_w
           RETURN
        END IF

   CLOSE WINDOW t600g_w
   

   CASE WHEN g_type='1' CALL t600_g_b2_p(g_oga.oga01,'ALL')#不分保稅轉同一出貨單
        WHEN g_type='2' CALL t600_g_b2_p(g_oga.oga01,'TAX')#先轉保稅,再another
        WHEN g_type='3' CALL t600_g_b2_p(g_oga.oga01,'TAX')#僅轉保稅品出貨單
        WHEN g_type='4' CALL t600_g_b2_p(g_oga.oga01,'NOT')#僅轉非保稅品出貨單
   END CASE
           

   IF g_type='2' THEN
      CALL t600_g_b2_another_oga()      #再轉非保稅
   END IF
END FUNCTION

FUNCTION t600_g_b2_another_oga()
   DEFINE li_result    LIKE type_file.num5           #No.MOD-810054

   LET g_success='Y'
   LET begin_no=g_oga.oga01
   LET g_t1=s_get_doc_no(g_oga.oga01)
  #CALL s_auto_assign_no("axm",g_t1,g_oga.oga02,"","oga_file","oga01","","","") #MOD-A40051 mark
   CALL s_auto_assign_no("axm",g_t1,g_oga.oga69,"","oga_file","oga01","","","") #MOD-A40051
     RETURNING li_result,g_oga.oga01
   IF (NOT li_result) THEN
      LET g_success = 'N'
      RETURN
   END IF
   IF cl_null(g_oga.oga01) THEN
      LET g_success='N'
      RETURN
   END IF
   IF cl_null(g_oga.oga161) THEN LET g_oga.oga161 = 0 END IF
   IF cl_null(g_oga.oga162) THEN LET g_oga.oga162 =100 END IF
   IF cl_null(g_oga.oga163) THEN LET g_oga.oga163 = 0 END IF
   #FUN-AC0055 add ---------------------begin-----------------------
   IF cl_null(g_oga.oga57) THEN
      LET g_oga.oga57 = '1'  
   END IF
   #FUN-AC0055 add ----------------------end------------------------ 
   LET g_oga.ogaplant = g_plant 
   LET g_oga.ogalegal = g_legal  

   LET g_oga.ogaoriu = g_user      #No.FUN-980030 10/01/04
   LET g_oga.ogaorig = g_grup      #No.FUN-980030 10/01/04
   IF cl_null(g_oga.oga909) THEN LET g_oga.oga909 = 'N' END IF  #MOD-A60163 
   INSERT INTO oga_file VALUES(g_oga.*)
   IF STATUS THEN
      CALL cl_err3("ins","oga_file","g_oga.oga01","",SQLCA.sqlcode,"","ins 2nd oga",1)  #No.FUN-670008
      RETURN
   END IF

   CALL t600_g_b2_p(g_oga.oga01,'NOT') 


   LET end_no=g_oga.oga01

   LET begin_no=NULL
   CALL t600_q()
END FUNCTION

FUNCTION t600_g_b2_p(p_oga01,p_tax)                     #由訂單產生單身

   DEFINE p_oga01       LIKE oga_file.oga01  #No.FUN-540049
   DEFINE p_tax         LIKE type_file.chr3    #No.FUN-680137 VARCHAR(3)

   DEFINE l_ima35 LIKE ima_file.ima35 #MOD-5B0276
   DEFINE l_ima36 LIKE ima_file.ima36 #MOD-5B0276
   DEFINE l_ima25 LIKE ima_file.ima25 #MOD-5B0276
   DEFINE l_ima15 LIKE ima_file.ima15 #MOD-5B0276
   DEFINE l_ship_qty LIKE ogb_file.ogb12
   DEFINE l_retn_qty LIKE ogb_file.ogb12,
          l_retn_qty_2 LIKE ogb_file.ogb12   #MOD-A50076
   DEFINE l_ogb912   LIKE ogb_file.ogb912,
          l_ohb912   LIKE ohb_file.ohb912,
          l_ogb912_2 LIKE ogb_file.ogb912,  #MOD-A50076
          l_ogb915   LIKE ogb_file.ogb915,
          l_ohb915   LIKE ohb_file.ohb915,
          l_ogb915_2 LIKE ogb_file.ogb915,  #MOD-A50076
          l_ogb917   LIKE ogb_file.ogb917,
          l_ohb917   LIKE ohb_file.ohb917,
          l_ogb917_2 LIKE ogb_file.ogb917   #MOD-A50076
   DEFINE l_oee063   LIKE oee_file.oee063   #No:TQC-640151(8)
   DEFINE l_oee073   LIKE oee_file.oee073   #No:TQC-640151(8)
   DEFINE l_oee083   LIKE oee_file.oee083   #No:TQC-640151(8)
   DEFINE l_ohb14    LIKE ohb_file.ohb14    #No:FUN-670008
   DEFINE l_ohb14t   LIKE ohb_file.ohb14t   #No:FUN-670008
   DEFINE l_fac      LIKE img_file.img20,   #MOD-930130
          l_flag2    LIKE type_file.num5,   #MOD-930130
          l_oee081   LIKE oee_file.oee081   #MOD-930130
#   DEFINE l_ata RECORD LIKE ata_file.*      #No.FUN-A50054   #FUN-A60035 ---MARK
#   DEFINE l_msg STRING   #No.FUN-870007     #FUN-AC0074 mark 
   DEFINE l_ogb05    LIKE ogb_file.ogb05        #NO.FUN-960130
#  DEFINE l_rxc      RECORD LIKE rxc_file.*     #NO.FUN-960130  #FUN-AC0074 mark
   DEFINE l_count    LIKE type_file.num5        #TQC-A40113
   DEFINE l_sie11    LIKE sie_file.sie11        #FUN-AC0074
   DEFINE m_ogb12    LIKE ogb_file.ogb12        #FUN-AC0074 
   DEFINE l_sum_ogb12  LIKE ogb_file.ogb12      #FUN-AC0074
   DEFINE l_qry1       LIKE ogb_file.ogb12      #FUN-AC0074
   DEFINE l_issue_qty1 LIKE ogb_file.ogb12      #FUN-AC0074
   DEFINE l_sie        RECORD  LIKE sie_file.*  #FUN-AC0074
   DEFINE l_ogb12      LIKE ogb_file.ogb12      #FUN-AC0074   
   DEFINE l_n          LIKE type_file.num5      #FUN-AC0074 

   LET g_chr2 = '2'  #No.FUN-640074
   LET b_ogb.ogb03 = 0    #FUN-AC0074

   IF g_oea.oea37 = "Y" THEN   #No:FUN-640025
      LET g_sql = "SELECT oee063,oee073,oee083,ima35,ima36,ima25,ima15,oeb_file.*",   #CHI-9B0002
                  "  FROM oee_file,oeb_file,OUTER ima_file",
                  " WHERE oeb01='",g_oga.oga16,"'",
                  "   AND ((oee083-oeb24+oeb25)>0 OR oeb1003 ='2')",
                  "   AND oeb70='N'",
                # "   AND oee10=oeb01 AND oee11 = oeb03",       #TQC-A40113
                  "   AND oee01=oeb01 AND oee02 = oeb03",       #TQC-A40113
#                 "   AND oeb04=ima_file.ima01",                #TQC-A60132
                  "   AND oeb_file.oeb04=ima_file.ima01",      #TQC-A60132
                  " ORDER BY oeb03"        
                  
   ELSE
         LET g_sql = "SELECT 0,0,0,ima35,ima36,ima25,ima15,oeb_file.*",   #CHI-9B0002
                     "  FROM oeb_file,OUTER ima_file",
                     " WHERE oeb01='",g_oga.oga16,"'",
                     "   AND ((oeb12-oeb24+oeb25)>0 OR oeb1003 ='2')",
                     "   AND oeb70='N'",
#                    "   AND oeb04=ima_file.ima01",             #TQC-A60132
                     "   AND oeb_file.oeb04=ima_file.ima01",    #TQC-A60132
                     " ORDER BY oeb03"                       
   END IF
   

   PREPARE t600_g_b_pb FROM g_sql
   DECLARE t600_g_b_c2 CURSOR FOR t600_g_b_pb
   FOREACH t600_g_b_c2 INTO l_oee063,l_oee073,l_oee083,l_ima35,l_ima36,l_ima25,l_ima15,g_oeb.*   #CHI-9B0002
      
      IF STATUS THEN
         EXIT FOREACH
      END IF

      IF g_argv0 MATCHES '[246]' AND g_oeb.oeb1003 ='1' 
         AND (g_oeb.oeb12 - g_oeb.oeb24 + g_oeb.oeb25) <= 0 THEN
         CONTINUE FOREACH
      END IF

      IF p_tax='TAX' AND l_ima15='N' THEN
         CONTINUE FOREACH
      END IF

      IF p_tax='NOT' AND l_ima15='Y' THEN
         CONTINUE FOREACH
      END IF

      INITIALIZE b_ogb.* TO NULL


      SELECT SUM(ogb12),SUM(ogb912),SUM(ogb915),SUM(ogb917)
        INTO l_ship_qty,l_ogb912,l_ogb915,l_ogb917
        FROM ogb_file,oga_file
       WHERE oga01 = ogb01
         AND ogb31 =g_oeb.oeb01
         AND ogb32 =g_oeb.oeb03
         AND oga09 =g_argv0 # 1.出貨通知單 2.出貨單
         AND ogaconf = 'Y'

      IF l_ship_qty IS NULL THEN LET l_ship_qty = 0 END IF
      IF l_ogb912 IS NULL   THEN LET l_ogb912   = 0 END IF
      IF l_ogb915 IS NULL   THEN LET l_ogb915   = 0 END IF
      IF l_ogb917 IS NULL   THEN LET l_ogb917   = 0 END IF

      SELECT SUM(ohb12),SUM(ohb912),SUM(ohb915),SUM(ohb917)
        INTO l_retn_qty,l_ohb912,l_ohb915,l_ohb917
        FROM ohb_file,oha_file
       WHERE oha01 = ohb01
         AND ohb33 =g_oeb.oeb01
         AND ohb34 =g_oeb.oeb03
         AND ohaconf = 'Y'
         AND oha09 ='4'      #MOD-840086 add

      IF l_retn_qty IS NULL THEN LET l_retn_qty = 0 END IF
      IF l_ohb912 IS NULL   THEN LET l_ohb912   = 0 END IF
      IF l_ohb915 IS NULL   THEN LET l_ohb915   = 0 END IF
      IF l_ohb917 IS NULL   THEN LET l_ohb917   = 0 END IF

      #-----MOD-A50076---------
      LET l_retn_qty_2 = 0 
      LET l_ogb912_2 = 0 
      LET l_ogb915_2 = 0 
      LET l_ogb917_2 = 0 
      SELECT SUM(ogb12),SUM(ogb912),SUM(ogb915),SUM(ogb917)
        INTO l_retn_qty_2,l_ogb912_2,l_ogb915_2,l_ogb917_2
        FROM ogb_file,oga_file
       WHERE oga01 = ogb01
         AND ogb31 =g_oeb.oeb01
         AND ogb32 =g_oeb.oeb03
         AND oga09 = '9'
         AND ogaconf = 'Y'
         AND ogapost = 'Y'

      IF cl_null(l_retn_qty_2) THEN LET l_retn_qty_2 = 0 END IF
      IF cl_null(l_ogb912_2)   THEN LET l_ogb912_2 = 0 END IF
      IF cl_null(l_ogb915_2)   THEN LET l_ogb915_2 = 0 END IF
      IF cl_null(l_ogb917_2)   THEN LET l_ogb917_2 = 0 END IF
      #-----END MOD-A50076-----

      IF g_oea.oea37 = "Y" THEN
         LET b_ogb.ogb12 = l_oee083 - l_ship_qty + l_retn_qty + l_retn_qty_2   #MOD-A50076  add l_retn_qty_2
         LET b_ogb.ogb912= l_oee063 - l_ogb912   + l_ohb912 + l_ogb912_2       #MOD-A50076  add l_ogb912_2
         LET b_ogb.ogb915= l_oee073 - l_ogb915   + l_ohb915 + l_ogb915_2       #MOD-A50076  add l_ogb912_2
        #MOD-930130單位轉換
         SELECT oee081 INTO l_oee081 FROM oee_file
          WHERE oee10 = g_oeb.oeb01                                                                              
            AND oee11 = g_oeb.oeb03                                                                              
         CALL s_umfchk(b_ogb.ogb04,l_oee081,g_oeb.oeb916)
               RETURNING l_flag2,l_fac
         IF l_flag2 = 1 THEN
            LET l_fac = 1
         END IF
         LET b_ogb.ogb917= (l_oee083*l_fac) - l_ogb917   + l_ohb917 + l_ogb917_2   #MOD-A50076  add l_ogb917_2
      ELSE
         LET b_ogb.ogb12 = g_oeb.oeb12 - l_ship_qty + l_retn_qty + l_retn_qty_2   #MOD-A50076  add l_retn_qty_2
         LET b_ogb.ogb912= g_oeb.oeb912- l_ogb912   + l_ohb912 + l_ogb912_2       #MOD-A50076  add l_ogb912_2
         LET b_ogb.ogb915= g_oeb.oeb915- l_ogb915   + l_ohb915 + l_ogb915_2       #MOD-A50076  add l_ogb912_2
         LET b_ogb.ogb917= g_oeb.oeb917- l_ogb917   + l_ohb917 + l_ogb917_2       #MOD-A50076  add l_ogb917_2
      END IF
#FUN-AC0074 --------------------------Begin-------------------------------------
      LET l_n = 0
      LET l_issue_qty1 = b_ogb.ogb12
      SELECT COUNT(*) INTO l_n FROM sie_file
       WHERE sie05 = g_oeb.oeb01
         AND sie15 = g_oeb.oeb03
         AND (sie02 IS NOT NULL AND  sie02 <> ' ')
      IF cl_null(l_n) THEN
         LET l_n = 0 
      END IF
      IF l_n > 0 THEN
         SELECT SUM(sie11) INTO l_sie11 FROM sie_file
          WHERE sie05 = g_oeb.oeb01
            AND sie15 = g_oeb.oeb03
            AND (sie02 IS NOT NULL AND sie02 <> ' ')
         IF l_sie11 > = b_ogb.ogb12 THEN
            LET m_ogb12 = b_ogb.ogb12
         ELSE 
            LET m_ogb12 = l_sie11
         END IF

         DECLARE t600_sie_cur CURSOR FOR SELECT * FROM sie_file 
                                           WHERE sie05 = g_oeb.oeb01 
                                             AND sie15 = g_oeb.oeb03 
                                             AND (sie02 IS NOT NULL AND sie02 <> ' ')
         LET l_sum_ogb12 = 0                      
         FOREACH t600_sie_cur INTO l_sie.*
            LET l_qry1 =  l_sum_ogb12 
            LET l_sum_ogb12 = l_sum_ogb12 + l_sie.sie11
            IF l_sum_ogb12 < = m_ogb12 THEN
               LET b_ogb.ogb12 = l_sie.sie11
            ELSE 
                  LET b_ogb.ogb12 =  m_ogb12 - l_qry1
            END IF      
            

            IF g_argv0 MATCHES '[12456]' AND g_oeb.oeb1003='1' THEN  
               IF b_ogb.ogb12 <= 0 THEN CONTINUE FOREACH END IF
            END IF 
            LET b_ogb.ogb01 = p_oga01
#            SELECT MAX(ogb03) INTO b_ogb.ogb03 FROM ogb_file
#             WHERE ogb31 = g_oeb.oeb01
#            IF cl_null(b_ogb.ogb03) THEN
#               LET b_ogb.ogb03 = 0
#            END IF 
#            LET b_ogb.ogb03 = b_ogb.ogb03 + 1
            LET b_ogb.ogb31 = g_oeb.oeb01

            LET b_ogb.ogb32 = g_oeb.oeb03
            LET b_ogb.ogb04 = g_oeb.oeb04
            LET b_ogb.ogb05 = l_sie.sie07

      
            LET b_ogb.ogb09 = l_sie.sie02
            LET b_ogb.ogb091= l_sie.sie03
            LET b_ogb.ogb15 = l_ima25 
            LET b_ogb.ogb092 = l_sie.sie04
            IF cl_null(b_ogb.ogb09) THEN
               IF g_azw.azw04='2' THEN
                  SELECT rtz07 INTO b_ogb.ogb09 FROM rtz_file
                   WHERE rtz01 = g_plant
               ELSE
                  LET b_ogb.ogb09 = l_ima35
               END IF
            END IF
            IF cl_null(b_ogb.ogb091) THEN LET b_ogb.ogb091= l_ima36 END IF
            #add by pane 150714 begin#
            IF cl_null(b_ogb.ogb091) THEN
               LET b_ogb.ogb091 = ' '
            END IF
            IF cl_null(b_ogb.ogb092) THEN
               LET b_ogb.ogb092 = ' '
            END IF
            #add by pane 150714 end#
           

            CALL t600_move_to()
            IF g_success = 'N' THEN
               CONTINUE FOREACH 
            END IF
            LET l_count = 0 
            SELECT COUNT(*) INTO l_count FROM ogb_file
             WHERE ogb01 = b_ogb.ogb01
               AND ogb03 = b_ogb.ogb03 
            IF l_count = 0 THEN
               SELECT COUNT(*) INTO l_count FROM ogb_file
                WHERE ogb01 = b_ogb.ogb01 
                  AND ogb31 = g_oeb.oeb01
                  AND ogb32 = g_oeb.oeb03
                  AND ogb09 = b_ogb.ogb09 
                  AND ogb091 = b_ogb.ogb091
                  AND ogb092 = b_ogb.ogb092
                  AND ogb05 = b_ogb.ogb05   #TQC-B50052 
               IF cl_null(l_count) THEN
                  LET l_count = 0
               END IF
               IF l_count > 0 THEN
                  UPDATE ogb_file SET ogb12 = ogb12 + b_ogb.ogb12
                                     ,ogb16 = ogb16 + b_ogb.ogb16,  #TQC-B50052
                                      ogb18 = ogb18 + b_ogb.ogb18   #TQC-B50052   
                   WHERE ogb01 = b_ogb.ogb01
                     AND ogb31 = g_oeb.oeb01
                     AND ogb32 = g_oeb.oeb03
                     AND ogb09 = b_ogb.ogb09  
                     AND ogb091 = b_ogb.ogb091
                     AND ogb092 = b_ogb.ogb092
                     AND ogb05 = b_ogb.ogb05   #TQC-B50052
                     IF SQLCA.SQLERRD[3]=0 THEN
                     CALL cl_err3("upd","ogb_file","b_ogb.ogb01","",SQLCA.sqlcode,"","upd ogb",0)
                  END IF                   
               ELSE
                  #add by huyx110916---start---
                  LET b_ogb.ogbud07= 0 
                  LET b_ogb.ogbud08= 0 
                  IF cl_null(b_ogb.ogbud07) THEN LET b_ogb.ogbud07=0 END IF
                  IF cl_null(b_ogb.ogbud08) THEN LET b_ogb.ogbud08=0 END IF
                  IF cl_null(b_ogb.ogbud09) THEN LET b_ogb.ogbud09=0 END IF
                  #add by huyx110916---end---
                  INSERT INTO ogb_file VALUES(b_ogb.*)
                  IF STATUS THEN
                     CALL cl_err3("ins","ogb_file","b_ogb.ogb01","",SQLCA.sqlcode,"","ins ogb",1)  
                  END IF
               END IF 
            ELSE
               IF g_oea.oea37 = 'Y' THEN
                  UPDATE ogb_file SET ogb12 = ogb12 + b_ogb.ogb12 
                    WHERE ogb01 = b_ogb.ogb01
                      AND ogb03 = b_ogb.ogb03
                  IF STATUS THEN
                     CALL cl_err3("upd","ogb_file","b_ogb.ogb01","",SQLCA.sqlcode,"","upd ogb",0)  
                  END IF
               END IF 
            END IF
         END FOREACH   #lixh1  #走備置
      END IF           
 
      IF (l_n > 0 AND l_sie11 < l_issue_qty1) OR l_n = 0 THEN
         IF l_n > 0 AND l_sie11 < l_issue_qty1 THEN
            LET l_ogb12 = l_issue_qty1 - l_sie11
            LET b_ogb.ogb12 = l_ogb12      
         END IF
#FUN-AC0074 --------------------------End---------------------------------------
#FUN-AC0074 --------------------------Begin-------------------------------------    
#            LET b_ogb.ogb910= g_oeb.oeb910    
#            LET b_ogb.ogb911= g_oeb.oeb911
#            LET b_ogb.ogb913= g_oeb.oeb913
#            LET b_ogb.ogb914= g_oeb.oeb914
#            LET b_ogb.ogb916= g_oeb.oeb916
#FUN-AC0074 --------------------------End---------------------------------------            
            
            #IF g_argv0 MATCHES '[246]' AND g_oeb.oeb1003='1' THEN   #MOD-A20068
            IF g_argv0 MATCHES '[12456]' AND g_oeb.oeb1003='1' THEN   #MOD-A20068
               IF b_ogb.ogb12 <= 0 THEN CONTINUE FOREACH END IF
            END IF
            LET b_ogb.ogb01 = p_oga01
#           LET b_ogb.ogb03 = g_oeb.oeb03      #FUN-AC0074
#           LET b_ogb.ogb03 = g_oeb.oeb03 +1   #FUN-AC0074 add
            LET b_ogb.ogb31 = g_oeb.oeb01
#FUN-AC0074 ----------Begin---------------
#           LET b_ogb.ogb19 = g_oeb.oeb906          #No.FUN-5C0075
#           IF cl_null(b_ogb.ogb19) THEN
#              LET b_ogb.ogb19 = 'N'
#           END IF
#FUN-AC0074 ----------End-----------------
            LET b_ogb.ogb32 = g_oeb.oeb03
            LET b_ogb.ogb04 = g_oeb.oeb04
            LET b_ogb.ogb05 = g_oeb.oeb05
#FUN-AC0074 ----------Begin---------------
#           LET b_ogb.ogb05_fac= g_oeb.oeb05_fac
#           LET b_ogb.ogb06 = g_oeb.oeb06
#           LET b_ogb.ogb07 = g_oeb.oeb07
#           LET b_ogb.ogb08 = g_oeb.oeb08
           LET b_ogb.ogb15 = l_ima25
#           LET b_ogb.ogb15_fac = g_oeb.oeb05_fac
#           LET b_ogb.ogb17 = 'N' #CHI-AC0034 mark    #MOD-B30419 remark
#          #LET b_ogb.ogb17 = b_ogb.ogb17 #CHI-AC0034 #MOD-B30419 mark
#FUN-AC0074 ----------End-----------------
            LET b_ogb.ogb09 = g_oeb.oeb09
            LET b_ogb.ogb091= g_oeb.oeb091
#FUN-AC0074 -----------------------------Begin----------------------------
            IF cl_null(b_ogb.ogb09) THEN
               IF g_azw.azw04='2' THEN
                  SELECT rtz07 INTO b_ogb.ogb09 FROM rtz_file
                   WHERE rtz01 = g_plant
               ELSE
                  LET b_ogb.ogb09 = l_ima35
               END IF
            END IF
            IF cl_null(b_ogb.ogb091) THEN LET b_ogb.ogb091= l_ima36 END IF
            LET b_ogb.ogb092= g_oeb.oeb092
            #add by pane 150714 begin#
            IF cl_null(b_ogb.ogb091) THEN
               LET b_ogb.ogb091 = ' '
            END IF
            IF cl_null(b_ogb.ogb092) THEN
               LET b_ogb.ogb092 = ' '
            END IF
            #add by pane 150714 end#
#            IF b_ogb.ogb09  IS NULL THEN LET b_ogb.ogb09  = ' ' END IF
#            IF b_ogb.ogb091 IS NULL THEN LET b_ogb.ogb091 = ' ' END IF
#            IF b_ogb.ogb092 IS NULL THEN LET b_ogb.ogb092 = ' ' END IF
#            LET b_ogb.ogb11 = g_oeb.oeb11
#            LET b_ogb.ogb18 = b_ogb.ogb12
#            LET b_ogb.ogb13 = g_oeb.oeb13
#            LET b_ogb.ogb37 = g_oeb.oeb37  #FUN-AB0061
#            LET b_ogb.ogb908= g_oeb.oeb908 #no.A050
#            LET b_ogb.ogb930= g_oeb.oeb930 #FUN-670063
#            LET b_ogb.ogb44 = g_oeb.oeb44
#            LET b_ogb.ogbplant = g_oeb.oebplant
#            LET b_ogb.ogblegal = g_oeb.oeblegal
#            LET b_ogb.ogb45 = g_oeb.oeb45
#            LET b_ogb.ogb46 = g_oeb.oeb46                                                                                              
#            LET b_ogb.ogb47 = g_oeb.oeb47
#               SELECT SUM(ogb14)
#                 INTO b_ogb.ogb14
#                 FROM ogb_file,oga_file
#                WHERE ogb31 =g_oeb.oeb01
#                  AND ogb32 =g_oeb.oeb03
#                  AND ogb1005 =g_oeb.oeb1003
#                  AND ogb01 =oga01
#                  AND ogapost ='Y'
#                  AND ogaconf != 'X'   #CHI-6B0036
#               SELECT SUM(ohb14)
#                 INTO l_ohb14
#                 FROM ohb_file,oha_file
#                WHERE ohb33 =g_oeb.oeb01
#                  AND ohb34 =g_oeb.oeb03
#                  AND ohb01 =oha01
#                  AND ohapost ='Y'
#               IF cl_null(l_ohb14) THEN
#                  LET l_ohb14 = 0
#               END IF
#               IF cl_null(b_ogb.ogb14) THEN
#                  LET b_ogb.ogb14 = 0
#               END IF
#               LET b_ogb.ogb14 =g_oeb.oeb14 - b_ogb.ogb14 + l_ohb14
#
#               SELECT SUM(ogb14t)
#                 INTO b_ogb.ogb14t
#                 FROM ogb_file,oga_file    #No.FUN-670008
#                WHERE ogb31 =g_oeb.oeb01
#                  AND ogb32 =g_oeb.oeb03
#                  AND ogb1005 =g_oeb.oeb1003
#                  AND ogb01 =oga01
#                  AND ogapost ='Y'
#                  AND ogaconf != 'X'  #CHI-6B0036
#               SELECT SUM(ohb14t)
#                 INTO l_ohb14t
#                 FROM ohb_file,oha_file
#                WHERE ohb33 =g_oeb.oeb01
#                  AND ohb34 =g_oeb.oeb03
#                  AND ohb01 =oha01
#                  AND ohapost ='Y'
#               IF cl_null(l_ohb14t) THEN
#                  LET l_ohb14t = 0
#               END IF
#               IF cl_null(b_ogb.ogb14t) THEN
#                  LET b_ogb.ogb14t = 0
#               END IF
#               LET b_ogb.ogb14t =g_oeb.oeb14t - b_ogb.ogb14t + l_ohb14t   #MOD-9B0012
#               LET b_ogb.ogb41 = g_oeb.oeb41
#               LET b_ogb.ogb42 = g_oeb.oeb42
#               LET b_ogb.ogb43 = g_oeb.oeb43
#         
#               LET b_ogb.ogb1001= g_oeb.oeb1001    #No.FUN-610064
#               LET b_ogb.ogb1012= g_oeb.oeb1012    #No.FUN-610064
#               LET b_ogb.ogb1002= g_oeb.oeb1002    #No.FUN-610064
#               LET b_ogb.ogb1003= g_oeb.oeb15      #No.FUN-610064
#               LET b_ogb.ogb1004= g_oeb.oeb1004    #No.FUN-610064
#               LET b_ogb.ogb1005= g_oeb.oeb1003    #No.FUN-610064
#               LET b_ogb.ogb1006= g_oeb.oeb1006    #No.FUN-610064
#               LET b_ogb.ogb1007= g_oeb.oeb1007    #No.FUN-610064
#               LET b_ogb.ogb1008= g_oeb.oeb1008    #No.FUN-610064
#               LET b_ogb.ogb1009= g_oeb.oeb1009    #No.FUN-610064
#               LET b_ogb.ogb1010= g_oeb.oeb1010    #No.FUN-610064
#               LET b_ogb.ogb1014 = 'N'  #FUN-6A0007
#               LET b_ogb.ogb1013 = 0    #No.TQC-740349
#         
#              #No.FUN-AA0057 Begin---
#               LET b_ogb.ogb48 = g_oeb.oeb49
#               LET b_ogb.ogb49 = g_oeb.oeb50
#              #LET b_ogb.ogb50 = '1'
#              #No.FUN-AA0057 End-----
#         
#               CALL t600_b_else()
#         
#               LET g_msg=b_ogb.ogb03,' ',b_ogb.ogb04,' ',b_ogb.ogb12
#               
#               CALL cl_msg(g_msg)
#         
#               #MOD-5A0174 add
#               IF cl_null(b_ogb.ogb05_fac) THEN
#                  LET b_ogb.ogb05_fac = 1
#               END IF
#               IF cl_null(b_ogb.ogb12) THEN
#                  LET b_ogb.ogb12 = 0
#               END IF
##FUN-AB0061 -----------add start----------------                          
#               IF cl_null(b_ogb.ogb37) THEN
#                  LET b_ogb.ogb37 = 0
#               END IF                                                                             
##FUN-AB0061 -----------add end----------------        
#              IF cl_null(b_ogb.ogb13) THEN
#                 LET b_ogb.ogb13 = 0
#              END IF
#              IF cl_null(b_ogb.ogb14) THEN
#                 LET b_ogb.ogb14 = 0
#              END IF
#              IF cl_null(b_ogb.ogb14t) THEN
#                 LET b_ogb.ogb14t = 0
#              END IF
#              IF cl_null(b_ogb.ogb15_fac) THEN
#                 LET b_ogb.ogb15_fac = 1
#              END IF
#              IF cl_null(b_ogb.ogb16) THEN
#                 LET b_ogb.ogb16 = 0
#              END IF
#              IF cl_null(b_ogb.ogb18) THEN
#                 LET b_ogb.ogb18 = 0
#              END IF
#              IF cl_null(b_ogb.ogb60) THEN
#                 LET b_ogb.ogb60 = 0
#              END IF
#              IF cl_null(b_ogb.ogb63) THEN
#                 LET b_ogb.ogb63 = 0
#              END IF
#              IF cl_null(b_ogb.ogb64) THEN
#                 LET b_ogb.ogb64 = 0
#              END IF
#              IF cl_null(b_ogb.ogb1006) THEN
#                 LET b_ogb.ogb1006 = 100
#              END IF
#
#&ifdef ICD
#              SELECT * INTO g_oebi.*
#                FROM oebi_file
#               WHERE oebi01 = g_oeb.oeb01
#                 AND oebi03 = g_oeb.oeb03
#              # 計算spare part量
#              IF g_oebi.oebiicd04 = 'Y' THEN #為樣品時,不需計算Spare Part量
#                 LET b_ogbi.ogbiicd02 = 0
#              ELSE
#                 IF cl_null(g_oebi.oebiicd03) THEN
#                    LET b_ogbi.ogbiicd02 = 0
#                 ELSE
#                    LET b_ogbi.ogbiicd02 = b_ogb.ogb12 * (g_oebi.oebiicd03/100)
#                    CALL cl_digcut(b_ogbi.ogbiicd02,0) RETURNING b_ogbi.ogbiicd02
#                 END IF
#              END IF
#              #不必考慮oebiicd04
#                 LET b_ogbi.ogbiicd03 = '0'
#              LET b_ogbi.ogbiicd04 = NULL
#              LET l_imaicd04 = NULL
#              SELECT imaicd04 INTO l_imaicd04
#                FROM imaicd_file
#               WHERE imaicd00 = b_ogb.ogb04
#              LET l_cnt = 0
#              SELECT COUNT(*) INTO l_cnt
#                FROM jce_file
#               WHERE jce02 = b_ogb.ogb09
#                 AND jceacti = 'Y'
#              IF l_imaicd04 MATCHES '[1234]' AND l_cnt > 0 THEN
#                 LET b_ogbi.ogbiicd01 = 'Y'
#              ELSE
#                 LET b_ogbi.ogbiicd01 = 'N'
#              END IF
#&endif
#              IF g_azw.azw04 = '2' THEN
#                 SELECT rtz07 INTO b_ogb.ogb09 FROM rtz_file WHERE rtz01 = g_oga.ogaplant
#                 IF b_ogb.ogb09 IS NULL THEN
#                    CONTINUE FOREACH  
#                 ELSE
#                   IF s_internal_item( b_ogb.ogb04,g_plant ) AND  (NOT s_joint_venture( b_ogb.ogb04,g_plant)) THEN    #FUN-AB0011
#                     SELECT COUNT(*) INTO g_cnt FROM img_file 
#                      WHERE img01 = b_ogb.ogb04 AND img02 = b_ogb.ogb09
#                     IF g_cnt IS NULL THEN LET g_cnt = 0 END IF
#                     IF g_cnt = 0 THEN
#                        LET l_msg ="(",b_ogb.ogb04 CLIPPED,"-",
#                                       b_ogb.ogb09 CLIPPED,")"
#                        IF g_sma.sma892[3,3] ='Y' THEN
#                           IF NOT cl_confirm('mfg1401') THEN RETURN END IF
#                        END IF
#                        CALL s_add_img(b_ogb.ogb04,b_ogb.ogb09,' ',' ',b_ogb.ogb01,
#                                      b_ogb.ogb03,g_oga.oga02)
#                     END IF
#                   END IF                                                                        #FUN-AB0011
#                 END IF
#              END IF
#        
#              LET b_ogb.ogbplant = g_plant 
#              LET b_ogb.ogblegal = g_legal  
#              LET b_ogb.ogb47 = (b_ogb.ogb917/g_oeb.oeb917)*g_oeb.oeb47
#              LET l_rxc.rxc00 = '02'
#              LET l_rxc.rxc01 = b_ogb.ogb01
#              LET l_rxc.rxc02 = b_ogb.ogb03
#              LET l_rxc.rxcplant = b_ogb.ogbplant
#              LET l_rxc.rxclegal = b_ogb.ogblegal
#              DECLARE cur_rxc01 CURSOR FOR 
#                 SELECT rxc03,rxc04,rxc05,rxc06,rxc07,rxc08,rxc09,rxc10,rxc11,rxc15  #FUN-AB0061
#                  FROM rxc_file WHERE rxc00 = '01' 
#                   AND rxc01 = g_oeb.oeb01 AND rxc02 = g_oeb.oeb03
#              FOREACH cur_rxc01 INTO l_rxc.rxc03,l_rxc.rxc04,l_rxc.rxc05,l_rxc.rxc06,
#                                     l_rxc.rxc07,l_rxc.rxc08,l_rxc.rxc09,l_rxc.rxc10,
#                                     l_rxc.rxc11,l_rxc.rxc15       #FUN-AB0061
#                  LET l_rxc.rxc06 = l_rxc.rxc06*(b_ogb.ogb917/g_oeb.oeb917)
#                  IF l_rxc.rxc06 IS NULL THEN LET l_rxc.rxc06 = 0 END IF
#                  IF l_rxc.rxc09 IS NULL THEN LET l_rxc.rxc09 = 0 END IF
#                  IF l_rxc.rxc11 IS NULL THEN LET l_rxc.rxc11 = 'N' END IF
#                  INSERT INTO rxc_file(rxc00,rxc01,rxc02,rxc03,rxc04,rxc05,rxc06,
#                                        rxc07,rxc08,rxc09,rxc10,rxc11,rxcplant,rxclegal,rxc15)  #FUN-AB0061
#                                 VALUES(l_rxc.rxc00,l_rxc.rxc01,l_rxc.rxc02,l_rxc.rxc03,
#                                        l_rxc.rxc04,l_rxc.rxc05,l_rxc.rxc06,l_rxc.rxc07,
#                                        l_rxc.rxc08,l_rxc.rxc09,l_rxc.rxc10,l_rxc.rxc11,
#                                        l_rxc.rxcplant,l_rxc.rxclegal,l_rxc.rxc15)   #FUN-AB0061
#              END FOREACH
#              SELECT SUM(rxc06) INTO b_ogb.ogb47 FROM rxc_file
#                  WHERE rxc00 = '02' AND rxc01 = b_ogb.ogb01 AND rxc02 = b_ogb.ogb03
#              IF b_ogb.ogb47 IS NULL THEN LET b_ogb.ogb47 = 0 END IF
#FUN-AC0074 -----------------------------End------------------------------------

              CALL t600_move_to()  #FUN-AC0074
#TQC-A40113 --begin--
              LET l_count = 0 
              SELECT COUNT(*) INTO l_count FROM ogb_file
               WHERE ogb01 = b_ogb.ogb01
                 AND ogb03 = b_ogb.ogb03 
              IF l_count = 0 THEN
#TQC-A40113 --end--
#FUN-AC0074 ---------------------------Begin----------------------------
                 SELECT COUNT(*) INTO l_count FROM ogb_file
                  WHERE ogb01 = b_ogb.ogb01
                    AND ogb31 = g_oeb.oeb01
                    AND ogb32 = g_oeb.oeb03
                    AND ogb09 = b_ogb.ogb09
                    AND ogb091 = b_ogb.ogb091
                    AND ogb092 = b_ogb.ogb092
                    AND ogb05 = b_ogb.ogb05     #TQC-B50052
                 IF cl_null(l_count) THEN
                    LET l_count = 0
                 END IF
                 IF l_count > 0 THEN
                    UPDATE ogb_file set ogb12 = ogb12 + b_ogb.ogb12
                                       ,ogb16 = ogb16 + b_ogb.ogb16, #TQC-B50052
                                        ogb18 = ogb18 + b_ogb.ogb18  #TQC-B50052 
                   WHERE ogb01 = b_ogb.ogb01
                     AND ogb31 = g_oeb.oeb01
                     AND ogb32 = g_oeb.oeb03
                     AND ogb09 = b_ogb.ogb09 
                     AND ogb091 = b_ogb.ogb091
                     AND ogb092 = b_ogb.ogb092
                     AND ogb05 = b_ogb.ogb05    #FUN-B50052  
                    IF SQLCA.SQLERRD[3]=0 THEN
                       CALL cl_err3("upd","ogb_file","b_ogb.ogb01","",SQLCA.sqlcode,"","upd ogb",0)
                    END IF                  
                 ELSE
#FUN-AC0074 --------------------------End------------------------------------
                    #add by huyx110916---start---
                    LET b_ogb.ogbud07= 0 
                    LET b_ogb.ogbud08= 0 
                    IF cl_null(b_ogb.ogbud07) THEN LET b_ogb.ogbud07=0 END IF
                    IF cl_null(b_ogb.ogbud08) THEN LET b_ogb.ogbud08=0 END IF
                    IF cl_null(b_ogb.ogbud09) THEN LET b_ogb.ogbud09=0 END IF
                    #add by huyx110916---end---
                    INSERT INTO ogb_file VALUES(b_ogb.*)
                    IF STATUS THEN
                       CALL cl_err3("ins","ogb_file","b_ogb.ogb01","",SQLCA.sqlcode,"","ins ogb",1)  #No.FUN-670008
                    END IF
                 END IF      #FUN-AC0074  
#FUN-A60035 ---MARK BEGIN
##FUN-A50054 --Begin
#&ifdef SLK
##     IF s_industry("slk") THEN
#           SELECT * INTO l_ata.* 
#             FROM ata_file 
#            WHERE ata00=g_ata00
#              AND ata01=g_oeb.oeb01
#              AND ata03=g_oeb.oeb03
#           LET l_ata.ata00=g_prog
#           LET l_ata.ata01=b_ogb.ogb01
#           LET l_ata.ata03=b_ogb.ogb03
#           INSERT INTO ata_file VALUES(l_ata.*)
##     END IF
#&endif
##FUN-A50054 --End
#FUN-A60035 ---MARK END

#TQC-A40113 --begin--
         ELSE
            IF g_oea.oea37 = 'Y' THEN
               UPDATE ogb_file SET ogb12 = ogb12 + b_ogb.ogb12 
                WHERE ogb01 = b_ogb.ogb01
                  AND ogb03 = b_ogb.ogb03
               IF STATUS THEN
                  CALL cl_err3("upd","ogb_file","b_ogb.ogb01","",SQLCA.sqlcode,"","upd ogb",0)  
               END IF
            END IF 
         END IF  
#TQC-A40113  -end--
      END IF

   END FOREACH

   CALL t600_bu()

END FUNCTION

FUNCTION t600_u2()
   IF g_oga.oga909 = 'Y' THEN RETURN END IF #No.7992
   CALL cl_set_head_visible("","YES")       #No.FUN-6B0033
   INPUT BY NAME g_oga.oga10,g_oga.oga25,g_oga.oga05,g_oga.oga13
                 WITHOUT DEFAULTS

      AFTER FIELD oga13
         IF NOT cl_null(g_oga.oga13) THEN
            SELECT * FROM ool_file WHERE ool01=g_oga.oga13
            IF STATUS THEN
               CALL cl_err3("sel","ool_file","g_oga.oga13","",SQLCA.sqlcode,"","",1)  #No.FUN-670008
               NEXT FIELD oga13
            END IF
         END IF

      ON ACTION controlp
         CASE
            WHEN INFIELD(oga25)
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_oab"
                 LET g_qryparam.default1 = g_oga.oga25
                 CALL cl_create_qry() RETURNING g_oga.oga25
                 DISPLAY BY NAME g_oga.oga25
                 NEXT FIELD oga25
            WHEN INFIELD(oga13)
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_ool"
                 LET g_qryparam.default1 = g_oga.oga13
                 CALL cl_create_qry() RETURNING g_oga.oga13
                 DISPLAY BY NAME g_oga.oga13
                 NEXT FIELD oga13
            END CASE

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT

      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121

      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121

      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121

   END INPUT

   IF INT_FLAG THEN LET INT_FLAG = 0 RETURN END IF

   UPDATE oga_file SET oga10=g_oga.oga10,
                       oga25=g_oga.oga25,
                       oga05=g_oga.oga05,
                       oga13=g_oga.oga13,
                       oga902=g_oga.oga902,
                       ogamodu=g_user,
                       ogadate=g_today
    WHERE oga01=g_oga.oga01

    IF STATUS OR SQLCA.SQLCODE THEN
       CALL cl_err3("upd","oga_file","g_oga_t.oga01","",SQLCA.sqlcode,"","upd oga",1)  #No.FUN-670008
    END IF

END FUNCTION

FUNCTION t600_c()
   DEFINE l_n          LIKE type_file.num5     #MOD-650057 add   #No.FUN-680137 SMALLINT

   IF s_shut(0) THEN RETURN END IF

   SELECT * INTO g_oga.* FROM oga_file WHERE oga01 = g_oga.oga01

   #送簽中時,不可執行"信用超限放行"
   IF g_oga.oga55 matches '[Ss]' THEN CALL cl_err('','apm-030',0) RETURN END IF  #FUN-A60003 add

   IF g_oga.oga01 IS NULL THEN CALL cl_err('',-400,0) RETURN END IF
   IF g_oga.ogaconf = 'X' THEN CALL cl_err('',9024,0) RETURN END IF
  #IF g_oga.oga54 != 0 THEN CALL cl_err('','axm-160',0) RETURN END IF #MOD-B60010 mark
   IF NOT t600_chk_ofa_oma(g_oga.oga01) THEN CALL cl_err('','axm-160',0) RETURN END IF #MOD-B60010 add

   IF g_argv0 MATCHES '[15]' THEN
      SELECT COUNT(*) INTO l_n FROM oga_file
       WHERE oga011 = g_oga.oga01
         AND oga09 IN ('2','4','6')   #No.7992
         AND ogaconf != 'X'
      #此出貨通知單已經出貨! 不可再做任何處理!
      IF l_n > 0 THEN
          CALL cl_err('oga011!='':','axm-228',1)
          RETURN
      END IF
   END IF

   IF g_oga.oga00 != "2" AND cl_null(g_oga.oga32) THEN
      CALL cl_err('ReceiveTrem Is Null','axm-317',0)
      RETURN
   END IF

   CALL cl_msg("")

   BEGIN WORK

   OPEN t600_cl USING g_oga.oga01
   IF STATUS THEN
      CALL cl_err("OPEN t600_cl:", STATUS, 1)
      CLOSE t600_cl
      ROLLBACK WORK
      RETURN
   END IF

   FETCH t600_cl INTO g_oga.*          # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
      CALL cl_err(g_oga.oga01,SQLCA.sqlcode,0)     # 資料被他人LOCK
      CLOSE t600_cl
      ROLLBACK WORK
      RETURN
   END IF


   UPDATE oga_file SET oga903='Y' WHERE oga01 = g_oga.oga01

   LET g_oga.oga903='Y'
   CLOSE t600_cl
   COMMIT WORK
   DISPLAY BY NAME g_oga.oga903

END FUNCTION

FUNCTION t600_set_entry(p_cmd)
 DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)

    IF p_cmd='a'  AND ( NOT g_before_input_done ) THEN
       CALL cl_set_comp_entry("oga01",TRUE)
    END IF

    IF INFIELD(oga011) OR INFIELD(oga16) OR ( NOT g_before_input_done ) THEN
       CALL cl_set_comp_entry("oga16,oga23",TRUE)
    END IF

    IF INFIELD(oga03) OR ( NOT g_before_input_done ) THEN
       CALL cl_set_comp_entry("oga032",TRUE)   #No.FUN-610064
    END IF

    IF INFIELD(oga011) OR ( NOT g_before_input_done ) THEN
       #客戶驗收單的單頭資料是從客戶需驗單帶出,不能自行修改
       IF g_argv0 = '8' THEN
          CALL cl_set_comp_entry("oga16,oga03,oga032,oga04,oga18,oga27",TRUE)        #TQC-640151(7)  add
          CALL cl_set_comp_entry("oga15,oga25,oga23,oga24,oga21",TRUE)           #FUN-910036 add               可以做修改
          CALL cl_set_comp_entry("oga13,oga05",TRUE)
       END IF
    END IF
    CALL cl_set_comp_entry("oga24",TRUE) #MOD-640570 add
    IF g_oga.oga65 = 'Y' AND g_argv0 MATCHES '[12]' THEN              #FUN-A60004
       CALL cl_set_comp_entry("oga65,oga72",TRUE)   #CHI-730002  #FUN-A60004 add oga72
    ELSE                                                         #FUN-A60004
       CALL cl_set_comp_entry("oga65",TRUE)                      #FUN-A60004 
    END IF                                                       #FUN-A60004     

    CALL cl_set_comp_entry("oga03,oga18,oga21,oga032",TRUE)  #No.TQC-740349     #MOD-9C0183 add oga032

END FUNCTION

FUNCTION t600_set_no_entry(p_cmd)
  DEFINE p_cmd   LIKE type_file.chr1,    #No.FUN-680137 VARCHAR(1)
         l_n     LIKE type_file.num5    #No.FUN-680137 SMALLINT
  DEFINE l_ogb31 LIKE ogb_file.ogb31   #No:MOD-590356

    IF p_cmd = 'u' AND g_chkey = 'N' AND ( NOT g_before_input_done ) THEN
       CALL cl_set_comp_entry("oga01",FALSE)
    END IF

    IF INFIELD(oga011) OR INFIELD(oga16) OR ( NOT g_before_input_done ) THEN
          SELECT ogb31 INTO l_ogb31 FROM ogb_file
           WHERE ogb01=g_oga.oga01
             AND (ogb31 IS NOT NULL OR ogb31 !=' ')
             AND (ogb32 IS NOT NULL OR ogb32 !=' ')
          IF NOT cl_null(l_ogb31) THEN
             SELECT * INTO g_oea.* FROM oea_file WHERE oea01=l_ogb31
             CALL cl_set_comp_entry("oga16",FALSE)
          END IF

       SELECT COUNT(*) INTO l_n FROM ogb_file
        WHERE ogb01 = g_oga.oga01
       IF l_n > 0 AND NOT cl_null(g_oga.oga23) THEN
          CALL cl_set_comp_entry("oga23",FALSE)
       END IF

       IF NOT cl_null(g_oga.oga16) OR NOT cl_null(g_oga.oga011) THEN
          IF NOT cl_null(g_oga.oga23)  THEN
             CALL cl_set_comp_entry("oga23",FALSE)
          END IF
       END IF
    END IF

    IF INFIELD(oga03) OR ( NOT g_before_input_done ) THEN  #No.FUN-610064
       IF g_oga.oga03[1,4] != 'MISC' THEN           #No.FUN-610064
          CALL cl_set_comp_entry("oga032",FALSE)   #No.FUN-610064
       END IF
    END IF

    IF INFIELD(oga011) OR ( NOT g_before_input_done ) THEN
       #客戶驗收單的單頭資料是從客戶需驗單帶出,不能自行修改
       IF g_argv0 = '8' THEN
          CALL cl_set_comp_entry("oga16,oga03,oga032,oga04,oga18,oga021,oga27",FALSE)
          CALL cl_set_comp_entry("oga15,oga25,oga23,oga24,oga21",FALSE)         #FUN-910036 add               可做修改
          CALL cl_set_comp_entry("oga13,oga05",FALSE)
       END IF
    END IF
    #若應采用訂單匯率立帳時,匯率NOENTRY
    CALL t600_oea18_get() RETURNING g_oea18_yn
    IF g_oea18_yn = 'Y' THEN
        CALL cl_set_comp_entry("oga24",FALSE)
    END IF
   #IF g_oea.oea00 = '3' THEN #MOD-B20074 mark
    IF g_oga.oga00='3' OR g_oga.oga00='A' OR g_oga.oga00='B' THEN #MOD-B20074
       CALL cl_set_comp_entry("oga65,oga72",FALSE)           #FUN-A60004 add oga72
       LET g_oga.oga65='N'
       LET g_oga.oga72 = NULL                                #FUN-A60004
       DISPLAY BY NAME g_oga.oga65
       DISPLAY BY NAME g_oga.oga72                           #FUN-A60004
    END IF
    IF NOT cl_null(g_oga.oga16) THEN
       CALL cl_set_comp_entry("oga03,oga18,oga21,oga032",FALSE)        #MOD-9C0183 add oga032
    END IF

END FUNCTION

FUNCTION t600_show_oao()
   DEFINE i,j LIKE type_file.num5    #No.FUN-680137 SMALLINT
   DEFINE l_oao06  LIKE oao_file.oao06  #No.FUN-680137 VARCHAR(60)

   DECLARE t600_show_c CURSOR FOR SELECT oao03,oao04,oao06 FROM oao_file
                                   WHERE oao01=g_oga.oga01 ORDER BY 1,2

   LET g_msg=''

   FOREACH t600_show_c INTO i,j,l_oao06
      IF STATUS THEN
         EXIT FOREACH
      END IF
      LET g_msg = g_msg CLIPPED,' ',l_oao06
   END FOREACH

   CALL cl_show_fld_cont()                   #No:FUN-550037 hmf

   CALL cl_msg(g_msg)

END FUNCTION

FUNCTION t600_r()
   DEFINE l_chr,l_sure LIKE type_file.chr1,   #No.FUN-680137 VARCHAR(1)
          l_oga01      LIKE oga_file.oga01,   #No.FUN-630061
          l_n,l_i      LIKE type_file.num5    #No.FUN-680137 SMALLINT  #FUN-810045 l_i
   DEFINE l_slip       LIKE smy_file.smyslip
   DEFINE l_tc_smy     RECORD LIKE tc_smy_file.*

   IF s_shut(0) THEN RETURN END IF

   SELECT * INTO g_oga.* FROM oga_file WHERE oga01 = g_oga.oga01

   IF g_oga.oga01 IS NULL THEN CALL cl_err('',-400,0) RETURN FALSE END IF
   IF g_oga.ogaconf = 'Y' THEN CALL cl_err('',9023,0) RETURN FALSE END IF
   IF g_oga.ogaconf = 'X' THEN CALL cl_err('',9024,0) RETURN FALSE END IF
  #IF g_oga.oga54 != 0 THEN CALL cl_err('','axm-160',0) RETURN FALSE END IF #MOD-B60010 mark
   IF NOT t600_chk_ofa_oma(g_oga.oga01) THEN CALL cl_err('','axm-160',0) RETURN END IF #MOD-B60010 add
   IF g_oga.oga55 matches '[Ss1]' THEN          #FUN-550050
      CALL cl_err('','mfg3557',0)
      RETURN FALSE
   END IF

   IF g_argv0 MATCHES '[15]' THEN
      SELECT COUNT(*) INTO l_n FROM oga_file
       WHERE oga011 = g_oga.oga01
         AND oga09 IN ('2','4','6')   #No.7992
         AND ogaconf != 'X'
      #此出貨通知單已經出貨! 不可再做任何處理!
      IF l_n > 0 THEN
          CALL cl_err('oga011!='':','axm-228',1)
          RETURN FALSE
      END IF
   END IF

   IF g_argv0 = '2' AND g_oga.oga65='Y' THEN
      SELECT COUNT(*) INTO l_n FROM oga_file
       WHERE oga011 = g_oga.oga01 AND oga09 IN ('8','9')
      IF l_n > 0 THEN
         CALL cl_err(g_oga.oga01,'axm-703',0)
         RETURN FALSE
      END IF
   END IF

   BEGIN WORK

   OPEN t600_cl USING g_oga.oga01
   IF STATUS THEN
      CALL cl_err("OPEN t600_cl:", STATUS, 1)
      CLOSE t600_cl
      ROLLBACK WORK
      RETURN FALSE
   END IF

   FETCH t600_cl INTO g_oga.*
   IF SQLCA.sqlcode THEN
      CALL cl_err(g_oga.oga01,SQLCA.sqlcode,0)
      CLOSE t600_cl
      ROLLBACK WORK
      RETURN FALSE
   END IF

   #CALL t600_show() #FUN-710016 應該要做完才show

   IF cl_delh(20,16) THEN
      CALL cl_msg("Delete oga,ogb,ogc,oao,oap!")

    IF g_argv0 <> '8' THEN  #FUN-C50097(MOD-C60236并入) 
      IF NOT cl_null(g_oga.oga011) THEN
         UPDATE oga_file SET oga011 = NULL
          WHERE oga01 = g_oga.oga011
         IF SQLCA.SQLERRD[3]=0 THEN
            CALL cl_err3("upd","oga_file",g_oga.oga011,"","SQLCA.SQLCODE","","No oga update",1)
            ROLLBACK WORK
            RETURN FALSE
         END IF
      END IF
    END IF #FUN-C50097(MOD-C60236并入)
      #-----MOD-AC0089---------
      INITIALIZE g_doc.* TO NULL          
      LET g_doc.column1 = "oga01"         
      LET g_doc.value1 = g_oga.oga01      
      CALL cl_del_doc()                   
      #-----END MOD-AC0089-----

      DELETE FROM oga_file WHERE oga01 = g_oga.oga01
      IF SQLCA.SQLERRD[3]=0 THEN
         CALL cl_err3("del","oga_file",g_oga.oga01,"","SQLCA.SQLCODE","","No oga deleted",1)  #No.FUN-670008
         ROLLBACK WORK
         RETURN FALSE
      END IF
      DELETE FROM rxc_file WHERE rxc00 = '02' AND rxc01 = g_oga.oga01   #NO.FUN-960130
      DELETE FROM ogb_file WHERE ogb01 = g_oga.oga01
#FUN-A60035 ---MARK BEGIN
##FUN-A60035 --Begin
#&ifdef SLK
##     IF s_industry("slk") THEN
#      DELETE FROM ata_file WHERE ata00=g_prog AND ata01=g_oga.oga01
##     END IF
#&endif
##FUN-A60035 --End
#FUN-A60035 ---MARK END

   #No:150716  Add  <<--jedi--
      LET l_slip = s_get_doc_no(g_oga.oga01)
      SELECT * INTO l_tc_smy.* FROM tc_smy_file WHERE tc_smyslip = l_slip
      IF l_tc_smy.tc_smy01 = 'Y' AND NOT cl_null(g_oga.ogaud10) THEN 
         UPDATE tc_rec_file SET tc_rec14 = NULL WHERE tc_recid = g_oga.ogaud10
            AND tc_rec14 = g_oga.oga01 
         UPDATE tc_rec_file SET tc_rec15 = NULL WHERE tc_recid = g_oga.ogaud10
            AND tc_rec15 = g_oga.oga01 
      END IF 
   #No:150716  End  <<--jedi--
      DELETE FROM ogc_file WHERE ogc01 = g_oga.oga01
      DELETE FROM rvbs_file WHERE rvbs01=g_oga.oga01
      DELETE FROM ogg_file WHERE ogg01 = g_oga.oga01  #No.FUN-540049
      DELETE FROM ogd_file WHERE ogd01 = g_oga.oga01
      DELETE FROM oao_file WHERE oao01 = g_oga.oga01
      DELETE FROM oap_file WHERE oap01 = g_oga.oga01
      DELETE FROM ogbb_file WHERE ogbb01=g_oga.oga01  #No:8324
      IF g_azw.azw04='2' THEN                                                                                                          
      DELETE FROM rxx_file WHERE rxx00='02' AND rxx01=g_oga.oga01                                                                   
      DELETE FROM rxy_file WHERE rxy00='02' AND rxy01=g_oga.oga01                                                                   
      DELETE FROM rxz_file WHERE rxz00='02' AND rxz01=g_oga.oga01                                                                   
      END IF


      #96/02/13 by danny  刪除分錄底稿單頭、單身檔
      DELETE FROM npp_file
       WHERE nppsys = 'AR'
         AND npp00 = 1
         AND npp01 = g_oga.oga01
         AND npp011 = 1

      DELETE FROM npq_file
       WHERE npqsys = 'AR'
         AND npq00 = 1
         AND npq01 = g_oga.oga01
         AND npq011 = 1

      DELETE FROM tic_file WHERE tic04 = g_oga.oga01 #FUN-B40056

      IF g_argv0 = '8' THEN
         #刪除驗收單時,也要把驗退單刪除,但兩者沒有直接關系,但是一一對應的
         SELECT UNIQUE oga01 INTO l_oga01 FROM oga_file,ogb_file
          WHERE oga01 = ogb01
            AND oga011= g_oga.oga011
            AND oga09 = '9'
            AND ogb03 IN (SELECT ogb03 FROM ogb_file
                           WHERE ogb01= g_oga.oga01)
         IF NOT cl_null(l_oga01) THEN
            DELETE FROM oga_file WHERE oga01=l_oga01
            DELETE FROM ogb_file WHERE ogb01=l_oga01
         END IF
      END IF

      LET g_msg=TIME
      INSERT INTO azo_file(azo01,azo02,azo03,azo04,azo05,azo06,azoplant,azolegal)  #FUN-980010 add plant & legal 
                  #VALUES ('axmt600',g_user,g_today,g_msg,g_oga.oga01,'delete',g_plant,g_legal) #CHI-A90022 mark
                   VALUES (g_prog,g_user,g_today,g_msg,g_oga.oga01,'delete',g_plant,g_legal)    #CHI-A90022
      IF g_prog <> 'axmt628' AND g_prog<>'axmt629' THEN  #axmt628/629不處理rvbs
        FOR l_i = 1 TO g_rec_b1
            IF NOT s_del_rvbs("1",g_oga.oga01,g_ogb[l_i].ogb03,0)  THEN                          #FUN-880129
              ROLLBACK WORK
              RETURN FALSE
            END IF
        END FOR
      END IF

      CLEAR FORM

      CALL g_ogb.clear()
      CALL g_b2.clear()  #No.TQC-740349
      INITIALIZE g_oga.* TO NULL

      CALL cl_msg("")
   END IF

   CLOSE t600_cl
   COMMIT WORK
   CALL cl_flow_notify(g_oga.oga01,'D')
   RETURN TRUE
END FUNCTION

#MOD-B60010 add --start--
FUNCTION t600_chk_ofa_oma(p_oga01)
  DEFINE p_oga01    LIKE oga_file.oga01
  DEFINE l_cnt      LIKE type_file.num5
  DEFINE l_omb01    LIKE omb_file.omb01 

   LET l_cnt = 0
   SELECT COUNT(*) INTO l_cnt FROM ofa_file
   WHERE ofa011=p_oga01
     AND ofaconf <> 'X' 
   IF l_cnt != 0 THEN 
      RETURN FALSE 
   ELSE
      LET l_cnt = 0
      DECLARE t600_omb CURSOR FOR SELECT omb01 FROM omb_file
                                     WHERE omb31 = p_oga01
      FOREACH t600_omb INTO l_omb01
         SELECT COUNT(*) INTO l_cnt FROM ome_file 
          WHERE ome16 = l_omb01 
            AND omevoid<>'Y'
         IF g_cnt != 0 THEN 
            RETURN FALSE 
         END IF
      END FOREACH
   END IF
   RETURN TRUE 
END FUNCTION
#MOD-B60010 add --end--

FUNCTION t600_set_entry_b1(p_cmd)
  DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)

       CALL cl_set_comp_entry("ogb09,ogb091,ogb092,ogb908,ogb1001",TRUE)   #No:MOD-740344
    IF p_cmd = 'u' OR INFIELD(ogb31) THEN
       CALL cl_set_comp_entry("ogb04,ogb05,ogb06" ,TRUE)
       IF g_sma.sma115='Y' THEN
          CALL cl_set_comp_entry("ogb913,ogb910" ,TRUE)
       END IF
    END IF
                                       #MOD-530374
    IF p_cmd = 'u' OR (INFIELD(ogb04) AND g_ogb[l_ac].ogb31[1,4]='MISC') THEN	
       CALL cl_set_comp_entry("ogb06",TRUE)
    END IF

    IF g_sma.sma115 = 'Y' THEN   #No.FUN-630061
       CALL cl_set_comp_entry("ogb913,ogb915,ogb917",TRUE)   #No.TQC-640123
    END IF

    IF INFIELD(ogb17) THEN
       CALL cl_set_comp_entry("ogb09,ogb091,ogb092",TRUE)
    END IF

    #-----CHI-880006---------
    #IF g_argv0 <> '8' THEN
    #   CALL cl_set_comp_entry("ogb19",TRUE)
    #END IF
    #-----END CHI-880006-----

    IF INFIELD(ogb03) AND g_argv0 = '8' THEN
       CALL cl_set_comp_entry("ogb31,ogb32,ogb04,ogb06",TRUE)
       CALL cl_set_comp_entry("ogb17,ogb09,ogb091,ogb092",TRUE)
       #CALL cl_set_comp_entry("ogb19,ogb05,ogb908",TRUE)   #CHI-880006
       CALL cl_set_comp_entry("ogb05,ogb908",TRUE)   #CHI-880006
       IF g_sma.sma115 = 'Y' THEN
          CALL cl_set_comp_entry("ogb913,ogb910",TRUE)
       END IF
       IF g_sma.sma116 MATCHES '[23]' THEN    #No:FUN-610076
       END IF
    END IF
    IF p_cmd ='s' AND g_sma.sma120 ="Y" THEN
       CALL cl_set_comp_entry("att00,att01,att02,att03,att04,att05,att06,att07,att08,att09,att10,att01_c,att02_c,att03_c,att04_c,att05_c,att06_c,att07_c,att08_c,att09_c,att10_c",TRUE)
    END IF
    IF g_azw.azw04="2" THEN                                                                                                         
       IF p_cmd='u' THEN                                                                                                            
          CALL cl_set_comp_entry("ogb13",FALSE)                                                                                     
       ELSE                                                                                                                         
          IF p_cmd='a' THEN                                                                                                         
             CALL cl_set_comp_entry("ogb13",TRUE)                                                                                   
          END IF                                                                                                                    
       END IF                                                                                                                       
    END IF
END FUNCTION

FUNCTION t600_set_no_entry_b1(p_cmd)
  DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)

    SELECT oaz102,oaz103,oaz104
      INTO g_oaz.oaz102,g_oaz.oaz103,g_oaz.oaz104
      FROM oaz_file
       IF g_oaz.oaz102='N' THEN 
          CALL cl_set_comp_entry("ogb09",FALSE)
       END IF
       IF g_oaz.oaz103='N' THEN 
          CALL cl_set_comp_entry("ogb091",FALSE)
       END IF
       IF g_oaz.oaz104='N' THEN 
          CALL cl_set_comp_entry("ogb092",FALSE)
       END IF
       IF g_aza.aza27 != 'Y' THEN
          CALL cl_set_comp_entry("ogb908",FALSE)
       END IF
    IF p_cmd = 'u' OR INFIELD(ogb31) THEN
       IF NOT cl_null(g_ogb[l_ac].ogb31) AND
          g_ogb[l_ac].ogb31[1,4] !='MISC' THEN 		
          CALL cl_set_comp_entry("ogb04,ogb05,ogb06",FALSE)
          IF g_sma.sma115 = 'Y' THEN
             CALL cl_set_comp_entry("ogb910,ogb913",FALSE)
          END IF
       END IF
    END IF
    IF p_cmd = 'u' OR INFIELD(ogb04) THEN
       IF g_ogb[l_ac].ogb04[1,4] !='MISC' THEN
          CALL cl_set_comp_entry("ogb06",FALSE)
       END IF
    END IF
    IF g_sma.sma115 = 'Y' THEN   #No.FUN-630061
       IF g_ima906 = '1' THEN
          CALL cl_set_comp_entry("ogb913,ogb914,ogb915",FALSE)
       END IF
       IF g_ima906 = '2' THEN
          CALL cl_set_comp_entry("ogb911,ogb914",FALSE)
       END IF
       #參考單位，每個料件只有一個，所以不開放讓用戶輸入
       IF g_ima906 = '3' THEN
          CALL cl_set_comp_entry("ogb913",FALSE)
       END IF
    END IF
    IF g_sma.sma116 MATCHES '[01]' THEN    #No:FUN-610076
       CALL cl_set_comp_entry("ogb916,ogb917",FALSE)
    END IF

    IF INFIELD(ogb17) THEN
       IF g_ogb[l_ac].ogb17 = "Y" THEN
          CALL cl_set_comp_entry("ogb09,ogb091,ogb092",FALSE)
       END IF
    END IF

    #-----CHI-880006--------- 
    #IF g_chr1 = 'Y' AND g_argv0 <> '8' THEN
    #   CALL cl_set_comp_entry("ogb19",FALSE)
    #END IF
    #-----END CHI-880006-----

    IF INFIELD(ogb03) AND g_argv0 = '8' THEN
       CALL cl_set_comp_entry("ogb31,ogb32,ogb04,ogb06",FALSE)
       CALL cl_set_comp_entry("ogb17,ogb09,ogb091,ogb092",FALSE)   #CHI-B30093  #CHI-B60054 去掉mark
       #CALL cl_set_comp_entry("ogb09,ogb091,ogb092",FALSE)   #CHI-B30093 #CHI-B60054 mark 
       #CALL cl_set_comp_entry("ogb19,ogb05,ogb908",FALSE)   #CHI-880006
       CALL cl_set_comp_entry("ogb05,ogb908",FALSE)   #CHI-880006
       IF g_sma.sma115 = 'Y' THEN
          CALL cl_set_comp_entry("ogb910,ogb913",FALSE)
       END IF
       IF g_sma.sma116 MATCHES '[23]' THEN    #No:FUN-610076
          CALL cl_set_comp_entry("ogb916",FALSE)
       END IF
    END IF
    IF p_cmd ='s' AND g_sma.sma120 ="Y" AND NOT cl_null(g_ogb[l_ac].ogb31)
       AND NOT cl_null(g_ogb[l_ac].ogb03) THEN
       CALL cl_set_comp_entry("att00,att01,att02,att03,att04,att05,att06,att07,att08,att09,att10,att01_c,att02_c,att03_c,att04_c,att05_c,att06_c,att07_c,att08_c,att09_c,att10_c",FALSE)
    END IF

    IF g_argv0 ="8" THEN
       CALL cl_set_comp_entry("ogb1001",FALSE)
    END IF


END FUNCTION

FUNCTION t600_set_entry_ogc(p_ocm01)
  DEFINE p_ocm01  LIKE ocm_file.ocm01

  IF NOT cl_null(p_ocm01) THEN
     CALL cl_set_comp_entry("ogc17",TRUE)
  END IF
END FUNCTION

FUNCTION t600_set_no_entry_ogc(p_ocm01)
  DEFINE p_ocm01  LIKE ocm_file.ocm01

  IF cl_null(p_ocm01) THEN
     CALL cl_set_comp_entry("ogc17",FALSE)
  END IF
  CALL cl_set_comp_entry("ogb13,ogb14,ogb14t",FALSE) #No:FUN-870007
END FUNCTION

#MOD-B30026 add --start--
FUNCTION t600b_set_no_entry_ogc()
   IF g_oaz.oaz102='N' THEN 
      CALL cl_set_comp_entry("ogc09",FALSE)
   END IF
   IF g_oaz.oaz103='N' THEN 
      CALL cl_set_comp_entry("ogc091",FALSE)
   END IF
   IF g_oaz.oaz104='N' THEN 
      CALL cl_set_comp_entry("ogc092",FALSE)
   END IF
END FUNCTION
#MOD-B30026 add --end--

FUNCTION t600_set_required_b1(p_cmd)
 DEFINE p_cmd LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)

 IF cl_null(g_oga.oga16) THEN
    CALL cl_set_comp_required("ogb31",TRUE)
 END IF

 IF g_argv0='1' OR g_argv0='5'  THEN
    CALL cl_set_comp_required("ogb31",TRUE)
 ELSE
  IF g_argv0<>'8' THEN   #MOD-6A0165 add
    IF g_oaz.oaz65='1' THEN
     CALL cl_set_comp_required("ogb31",TRUE)
    END IF
  END IF   #MOD-6A0165 add
 END IF  #MOD-650042-add
 IF g_argv0<>'8' THEN   #MOD-6A0165 add
 IF p_cmd = 'u' OR INFIELD(ogb31) THEN
    IF NOT cl_null(g_ogb[l_ac].ogb31) AND g_ogb[l_ac].ogb31[1,4] <> 'MISC' THEN
       CALL cl_set_comp_required("ogb32",TRUE)
    END IF
 END IF
 END IF   #MOD-6A0165 add
  #兩組雙單位資料不是一定要全部輸入,但是參考單位的時候要全輸入
  IF g_sma.sma115 = 'Y' THEN #No.FUN-630061
     SELECT ima906 INTO g_ima906 FROM ima_file WHERE ima01=g_ogb[l_ac].ogb04
     IF g_ima906 = '3' THEN
        CALL cl_set_comp_required("ogb913,ogb915,ogb910,ogb912",TRUE)
     END IF
     #單位不同,轉換率,數量必KEY
     IF NOT cl_null(g_ogb[l_ac].ogb910) THEN
        CALL cl_set_comp_required("ogb912",TRUE)
     END IF
     IF NOT cl_null(g_ogb[l_ac].ogb913) AND g_ima906 MATCHES '[23]' THEN
        CALL cl_set_comp_required("ogb915",TRUE)
     END IF
  END IF   #No.FUN-630061
  IF g_sma.sma116 MATCHES '[23]' THEN   #No:FUN-630061  #No:FUN-610076
     IF NOT cl_null(g_ogb[l_ac].ogb916) THEN
        CALL cl_set_comp_required("ogb917",TRUE)
     END IF
   END IF   #No.FUN-630061

END FUNCTION

FUNCTION t600_set_no_required_b1(p_cmd)
 DEFINE p_cmd LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)

 IF  g_oaz.oaz65 != '1' AND g_argv0<>'1' AND g_argv0<>'5' THEN
     CALL cl_set_comp_required("ogb31",FALSE)
  END IF
  IF p_cmd = 'u' OR INFIELD(ogb31) THEN
    CALL cl_set_comp_required("ogb32",FALSE)
  END IF
  IF g_sma.sma115 = 'Y' THEN #No.FUN-630061
    CALL cl_set_comp_required("ogb913,ogb914,ogb915,ogb910,ogb911,ogb912",FALSE)
  END IF
  IF g_sma.sma116 MATCHES '[23]' THEN   #No:FUN-630061  #No:FUN-610076
    CALL cl_set_comp_required("ogb916,ogb917",FALSE)
  END IF

END FUNCTION


FUNCTION t600_b1_move_to()
#FUN-A60035 ---MARK BEGIN
##FUN-A60035 --Begin
#&ifdef SLK
#  SELECT SUM(ogb12),SUM(ogb912),SUM(ogb915),SUM(ogb917),SUM(ogb14),SUM(ogb14t)
#    INTO b_ogb.ogb12,b_ogb.ogb912,b_ogb.ogb915,b_ogb.ogb917,b_ogb.ogb14,b_ogb.ogb14t
#    FROM ogb_file
#   WHERE ogb01 = g_oga.oga01
#     AND ogb03 =
#     (SELECT ata03 FROM ata_file
#       WHERE ata00 = g_prog
#         AND ata01 = g_oga.oga01
#         AND ata02 = g_ogb[l_ac].ogb03)
##endif
##FUN-A60035 --End
#FUN-A60035 ---MARK END
   LET g_ogb[l_ac].ogb03  = b_ogb.ogb03
   LET g_ogb[l_ac].ogb31  = b_ogb.ogb31 LET g_ogb[l_ac].ogb32 = b_ogb.ogb32
   LET g_ogb[l_ac].ogb04  = b_ogb.ogb04
   LET g_ogb[l_ac].ogb06  = b_ogb.ogb06
   LET g_ogb[l_ac].ogb05  = b_ogb.ogb05
   LET g_ogb[l_ac].ogb12  = b_ogb.ogb12
   LET g_ogb[l_ac].ogb09  = b_ogb.ogb09
   LET g_ogb[l_ac].ogb19  = b_ogb.ogb19   #No.FUN-5C0075
   LET g_ogb[l_ac].ogb091 = b_ogb.ogb091 LET g_ogb[l_ac].ogb092= b_ogb.ogb092
   LET g_ogb[l_ac].ogb17  = b_ogb.ogb17
   LET g_ogb[l_ac].ogb908 = b_ogb.ogb908 #no.A050
   LET g_ogb[l_ac].ogb910= b_ogb.ogb910
   LET g_ogb[l_ac].ogb911= b_ogb.ogb911
   LET g_ogb[l_ac].ogb912= b_ogb.ogb912
   LET g_ogb[l_ac].ogb913= b_ogb.ogb913
   LET g_ogb[l_ac].ogb914= b_ogb.ogb914
   LET g_ogb[l_ac].ogb915= b_ogb.ogb915
   LET g_ogb[l_ac].ogb916= b_ogb.ogb916
   LET g_ogb[l_ac].ogb917= b_ogb.ogb917
   LET g_ogb[l_ac].ogb65 = b_ogb.ogb65   #No.FUN-630061
   LET g_ogb[l_ac].ogb41 = b_ogb.ogb41
   LET g_ogb[l_ac].ogb42 = b_ogb.ogb42
   LET g_ogb[l_ac].ogb43 = b_ogb.ogb43
   LET g_ogb[l_ac].ogb1001= b_ogb.ogb1001
   LET g_ogb[l_ac].ogb40= b_ogb.ogb40     #FUN-B50054
   LET g_ogb[l_ac].ogb1012= b_ogb.ogb1012
   LET g_ogb[l_ac].ogb1002= b_ogb.ogb1002
   LET g_ogb[l_ac].ogb1003= b_ogb.ogb1003
   LET g_ogb[l_ac].ogb1004= b_ogb.ogb1004
   LET g_ogb[l_ac].ogb1005= b_ogb.ogb1005
   LET g_ogb[l_ac].ogb1006= b_ogb.ogb1006
   LET g_ogb[l_ac].ogb11  = b_ogb.ogb11
   LET g_ogb[l_ac].ogb13  = b_ogb.ogb13
   LET g_ogb[l_ac].ogb37  = b_ogb.ogb37    #FUN-AB0061   
   LET g_ogb[l_ac].ogb14  = b_ogb.ogb14
   LET g_ogb[l_ac].ogb14t = b_ogb.ogb14t
   LET g_ogb[l_ac].ogb930 = b_ogb.ogb930 #FUN-670063
   LET g_ogb[l_ac].ogbud01 = b_ogb.ogbud01
   LET g_ogb[l_ac].ogbud02 = b_ogb.ogbud02
   LET g_ogb[l_ac].ogbud03 = b_ogb.ogbud03
   LET g_ogb[l_ac].ogbud04 = b_ogb.ogbud04
   LET g_ogb[l_ac].ogbud05 = b_ogb.ogbud05
   LET g_ogb[l_ac].ogbud06 = b_ogb.ogbud06
   LET g_ogb[l_ac].ogbud07 = b_ogb.ogbud07
   LET g_ogb[l_ac].ogbud08 = b_ogb.ogbud08
   LET g_ogb[l_ac].ogbud09 = b_ogb.ogbud09
   LET g_ogb[l_ac].ogbud10 = b_ogb.ogbud10
   LET g_ogb[l_ac].ogbud11 = b_ogb.ogbud11
   LET g_ogb[l_ac].ogbud12 = b_ogb.ogbud12
   LET g_ogb[l_ac].ogbud13 = b_ogb.ogbud13
   LET g_ogb[l_ac].ogbud14 = b_ogb.ogbud14
   LET g_ogb[l_ac].ogbud15 = b_ogb.ogbud15
   IF g_azw.azw04='2' THEN
   LET g_ogb[l_ac].ogb44=b_ogb.ogb44                                                                                             
   LET g_ogb[l_ac].ogb45=b_ogb.ogb45                                                                                             
   LET g_ogb[l_ac].ogb46=b_ogb.ogb46                                                                                             
   LET g_ogb[l_ac].ogb47=b_ogb.ogb47
   LET g_ogb[l_ac].ogb48=b_ogb.ogb48   #No.FUN-A90040   
   LET g_ogb[l_ac].ogb49=b_ogb.ogb49   #No.FUN-A90040 
 # LET g_ogb[l_ac].ogb50=b_ogb.ogb50   #No.FUN-A90040 #FUN-AA0057 
   END IF
END FUNCTION

FUNCTION t600_b1_move_back()
   LET b_ogb.ogb03  = g_ogb[l_ac].ogb03
   LET b_ogb.ogb31  = g_ogb[l_ac].ogb31 LET b_ogb.ogb32 = g_ogb[l_ac].ogb32
   LET b_ogb.ogb04  = g_ogb[l_ac].ogb04
   LET b_ogb.ogb06  = g_ogb[l_ac].ogb06
   LET b_ogb.ogb05  = g_ogb[l_ac].ogb05
   LET b_ogb.ogb12  = g_ogb[l_ac].ogb12
   LET b_ogb.ogb19  = g_ogb[l_ac].ogb19          #No.FUN-5C0075
   LET b_ogb.ogb09  = g_ogb[l_ac].ogb09
   LET b_ogb.ogb091 = g_ogb[l_ac].ogb091 LET b_ogb.ogb092= g_ogb[l_ac].ogb092
   LET b_ogb.ogb17  = g_ogb[l_ac].ogb17
   LET b_ogb.ogb908 = g_ogb[l_ac].ogb908 #no.A050
   LET b_ogb.ogb910= g_ogb[l_ac].ogb910
   LET b_ogb.ogb911= g_ogb[l_ac].ogb911
   LET b_ogb.ogb912= g_ogb[l_ac].ogb912
   LET b_ogb.ogb913= g_ogb[l_ac].ogb913
   LET b_ogb.ogb914= g_ogb[l_ac].ogb914
   LET b_ogb.ogb915= g_ogb[l_ac].ogb915
   LET b_ogb.ogb916= g_ogb[l_ac].ogb916
   LET b_ogb.ogb917= g_ogb[l_ac].ogb917
   LET b_ogb.ogb65 = g_ogb[l_ac].ogb65   #No.FUN-630061
   LET b_ogb.ogb41 = g_ogb[l_ac].ogb41
   LET b_ogb.ogb42 = g_ogb[l_ac].ogb42
   LET b_ogb.ogb43 = g_ogb[l_ac].ogb43
   LET b_ogb.ogb40 = g_ogb[l_ac].ogb40    #FUN-B50054
   LET b_ogb.ogb1001= g_ogb[l_ac].ogb1001
   LET b_ogb.ogb1012= g_ogb[l_ac].ogb1012
   LET b_ogb.ogb1002= g_ogb[l_ac].ogb1002
   LET b_ogb.ogb1003= g_ogb[l_ac].ogb1003
   LET b_ogb.ogb1004= g_ogb[l_ac].ogb1004
   LET b_ogb.ogb1005= g_ogb[l_ac].ogb1005
   LET b_ogb.ogb1006= g_ogb[l_ac].ogb1006
   LET b_ogb.ogb11  = g_ogb[l_ac].ogb11
   LET b_ogb.ogb13  = g_ogb[l_ac].ogb13
   LET b_ogb.ogb37  = g_ogb[l_ac].ogb37   #FUN-AB0061 
   LET b_ogb.ogb14  = g_ogb[l_ac].ogb14
   LET b_ogb.ogb14t = g_ogb[l_ac].ogb14t
#end
   LET b_ogb.ogb930 = g_ogb[l_ac].ogb930  #FUN-670063
   LET b_ogb.ogbud01 = g_ogb[l_ac].ogbud01
   LET b_ogb.ogbud02 = g_ogb[l_ac].ogbud02
   LET b_ogb.ogbud03 = g_ogb[l_ac].ogbud03
   LET b_ogb.ogbud04 = g_ogb[l_ac].ogbud04
   LET b_ogb.ogbud05 = g_ogb[l_ac].ogbud05
   LET b_ogb.ogbud06 = g_ogb[l_ac].ogbud06
   LET b_ogb.ogbud07 = g_ogb[l_ac].ogbud07
   LET b_ogb.ogbud08 = g_ogb[l_ac].ogbud08
   LET b_ogb.ogbud09 = g_ogb[l_ac].ogbud09
   LET b_ogb.ogbud10 = g_ogb[l_ac].ogbud10
   LET b_ogb.ogbud11 = g_ogb[l_ac].ogbud11
   LET b_ogb.ogbud12 = g_ogb[l_ac].ogbud12
   LET b_ogb.ogbud13 = g_ogb[l_ac].ogbud13
   LET b_ogb.ogbud14 = g_ogb[l_ac].ogbud14
   LET b_ogb.ogbud15 = g_ogb[l_ac].ogbud15
   IF g_azw.azw04='2' THEN
      LET b_ogb.ogb44=g_ogb[l_ac].ogb44                                                                                             
      LET b_ogb.ogb45=g_ogb[l_ac].ogb45                                                                                             
      LET b_ogb.ogb46=g_ogb[l_ac].ogb46                                                                                             
      LET b_ogb.ogb47=g_ogb[l_ac].ogb47
      LET b_ogb.ogb48=g_ogb[l_ac].ogb48   #No.FUN-A90040 
      LET b_ogb.ogb49=g_ogb[l_ac].ogb49   #No.FUN-A90040 
  #   LET b_ogb.ogb50=g_ogb[l_ac].ogb50   #No.FUN-A90040#FUN-AA0057 
   ELSE
      LET b_ogb.ogb44='1'
      LET b_ogb.ogb47=0
   END IF
   LET b_ogb.ogbplant=g_plant
   LET b_ogb.ogblegal=g_legal
END FUNCTION

FUNCTION t600_b_else()
   DEFINE l_img21   LIKE img_file.img21,
          l_ogb15   LIKE ogb_file.ogb15
   DEFINE l_azf10   LIKE azf_file.azf10    #No.FUN-6B0065
  #IF b_ogb.ogb1005 ='2' THEN                      #TQC-B10088
   IF b_ogb.ogb1005 ='2' AND b_ogb.ogb03>9000 THEN #TQC-B10088
      RETURN
   END IF
   IF cl_null(b_ogb.ogb916) THEN
      LET b_ogb.ogb916=b_ogb.ogb05
      LET b_ogb.ogb917=b_ogb.ogb12
   END IF
   IF cl_null(b_ogb.ogb1006) THEN
      LET b_ogb.ogb1006=100   #No.FUN-710046
   END IF
   IF g_oga.oga213 = 'N'
      #  用計價數量計算
      THEN
           LET b_ogb.ogb14 =t600_amount(b_ogb.ogb917,b_ogb.ogb13,b_ogb.ogb1006,t_azi03)   #No.MOD-820066
           CALL cl_digcut(b_ogb.ogb14,t_azi04)  RETURNING b_ogb.ogb14   #CHI-7A0036-add
           LET b_ogb.ogb14t=b_ogb.ogb14*(1+g_oga.oga211/100)
           CALL cl_digcut(b_ogb.ogb14t,t_azi04) RETURNING b_ogb.ogb14t  #CHI-7A0036-add
      ELSE
           LET b_ogb.ogb14t=t600_amount(b_ogb.ogb917,b_ogb.ogb13,b_ogb.ogb1006,t_azi03)   #No.MOD-820066
           CALL cl_digcut(b_ogb.ogb14t,t_azi04) RETURNING b_ogb.ogb14t  #CHI-7A0036-add
           LET b_ogb.ogb14 =b_ogb.ogb14t/(1+g_oga.oga211/100)
           CALL cl_digcut(b_ogb.ogb14,t_azi04)  RETURNING b_ogb.ogb14   #CHI-7A0036-add
   END IF
   IF b_ogb.ogb1012='Y' THEN
      LET b_ogb.ogb14 =0
      LET b_ogb.ogb14t=0
   END IF
   IF b_ogb.ogb09  IS NULL THEN LET b_ogb.ogb09  = ' ' END IF
   IF b_ogb.ogb091 IS NULL THEN LET b_ogb.ogb091 = ' ' END IF
   IF b_ogb.ogb092 IS NULL THEN LET b_ogb.ogb092 = ' ' END IF
   SELECT img09,img21 INTO l_ogb15,l_img21 FROM img_file
         WHERE img01 = b_ogb.ogb04 AND img02 = b_ogb.ogb09
           AND img03 = b_ogb.ogb091 AND img04 = b_ogb.ogb092

#ogb15存放的是倉庫的單位(img09)，因此不管目前b_ogb.ogb15
#是否為NULL都必須重新塞值給b_ogb.ogb15

   IF STATUS=0 THEN
      LET b_ogb.ogb15 = l_ogb15
      IF b_ogb.ogb05 = b_ogb.ogb15 THEN
          LET b_ogb.ogb15_fac =1
      ELSE
          #檢查該發料單位與主檔之單位是否可以轉換
          CALL s_umfchk(b_ogb.ogb04,b_ogb.ogb05,b_ogb.ogb15)
                    RETURNING g_cnt,b_ogb.ogb15_fac
          IF g_cnt = 1 THEN
             CALL cl_err('','mfg3075',1)
          END IF
      END IF
   END IF

   IF cl_null(b_ogb.ogb15) THEN LET b_ogb.ogb15  = b_ogb.ogb05 END IF
   IF cl_null(b_ogb.ogb15_fac) THEN LET b_ogb.ogb15_fac = 1 END IF
   LET b_ogb.ogb16 = b_ogb.ogb12 * b_ogb.ogb15_fac
   IF cl_null(b_ogb.ogb60) THEN LET b_ogb.ogb60 = 0 END IF
   IF cl_null(b_ogb.ogb63) THEN LET b_ogb.ogb63 = 0 END IF
   IF cl_null(b_ogb.ogb64) THEN LET b_ogb.ogb64 = 0 END IF
END FUNCTION

FUNCTION t600_b_ogc()                   # 庫存異動明細(ogc_file)輸入
   DEFINE r_ogc   RECORD LIKE ogc_file.*
   DEFINE l_ogc   DYNAMIC ARRAY OF RECORD
                     #ogc12     LIKE ogc_file.ogc12,   #CHI-9C0024
                     ogc09     LIKE ogc_file.ogc09,
                     ogc091    LIKE ogc_file.ogc091,
                     ogc092    LIKE ogc_file.ogc092,
                     ogc12     LIKE ogc_file.ogc12,   #CHI-9C0024
                     #ogc12_1   LIKE ogc_file.ogc12,   #CHI-B30093 #CHI-B60054 mark
                     img10     LIKE img_file.img10, #MOD-530713
                     ogc15     LIKE ogc_file.ogc15,
                     ogc15_fac LIKE ogc_file.ogc15_fac,
                     ogc16     LIKE ogc_file.ogc16,
                     ogc18     LIKE ogc_file.ogc18   #No:FUN-870131
                  END RECORD
   DEFINE l_n          LIKE type_file.num5     #No.FUN-680137 SMALLINT
   DEFINE l_ogc12_t    LIKE ogc_file.ogc12
   DEFINE l_ogc16_t    LIKE ogc_file.ogc16
   DEFINE l_img21      LIKE img_file.img21
   DEFINE i,k,s,l_i    LIKE type_file.num5,    #No.FUN-680137 SMALLINT
          l_allow_insert   LIKE type_file.num5,                #可新增否  #No.FUN-680137 SMALLINT
          l_allow_delete   LIKE type_file.num5                 #可刪除否  #No.FUN-680137 SMALLINT
   DEFINE l_ogc18      LIKE ogc_file.ogc18   #No:FUN-870131
   DEFINE l_bno        LIKE rvbs_file.rvbs08 #No.CHI-9A0022
   DEFINE l_oea00      LIKE oea_file.oea00,  #No.FUN-9C0103
          l_oea11      LIKE oea_file.oea11,  #No.FUN-9C0103
          l_oea12      LIKE oea_file.oea12,  #No.FUN-9C0103
          l_oga16      LIKE oga_file.oga16   #No.FUN-9C0103
   DEFINE g_ogc18      LIKE ogc_file.ogc18   #MOD-B30487
   #DEFINE l_ogc12_1    LIKE ogc_file.ogc12   #CHI-B30093 #CHI-B60054 mark
   #DEFINE l_ogc09_1    LIKE ogc_file.ogc09   #CHI-B30093 #CHI-B60054 mark
   #DEFINE l_ogc091_1   LIKE ogc_file.ogc09   #CHI-B30093 #CHI-B60054 mark
         
   LET l_oea00 = ''    #FUN-9C0103
   LET l_oea11 = ''    #FUN-9C0103
   LET l_oea12 = ''    #FUN-9C0103
   LET l_oga16 = ''    #FUN-9C0103 

   SELECT COUNT(*) INTO i FROM ogc_file
    WHERE ogc01 = g_oga.oga01 AND ogc03 = g_ogb[l_ac].ogb03     #No.TQC-640123

   # oaz71:出貨異動明細自動附于方式:
   IF i = 0 AND g_oaz.oaz71='1' THEN  #與產品項次相同
      LET r_ogc.ogc01 = g_oga.oga01
      LET r_ogc.ogc03 = g_ogb[l_ac].ogb03     #No.TQC-640123
      LET r_ogc.ogc12 = b_ogb.ogb12
      LET r_ogc.ogc09 = g_ogb[l_ac].ogb09     #No.TQC-640123
      LET r_ogc.ogc091 = g_ogb[l_ac].ogb091     #No.TQC-640123
      LET r_ogc.ogc092 = g_ogb[l_ac].ogb092     #No.TQC-640123
      LET r_ogc.ogc15 = b_ogb.ogb15
      LET r_ogc.ogc15_fac = b_ogb.ogb15_fac
      LET r_ogc.ogc16 = b_ogb.ogb16
      LET r_ogc.ogc17 = g_ogb[l_ac].ogb04     #MOD-780256 add
      LET r_ogc.ogc18 = 1   #No:FUN-870131

      IF cl_null(r_ogc.ogc01) THEN LET r_ogc.ogc01=' ' END IF
      IF cl_null(r_ogc.ogc03) THEN LET r_ogc.ogc03=0 END IF
      IF cl_null(r_ogc.ogc09) THEN LET r_ogc.ogc09=' ' END IF
      IF cl_null(r_ogc.ogc091) THEN LET r_ogc.ogc091=' ' END IF
      IF cl_null(r_ogc.ogc092) THEN LET r_ogc.ogc092=' ' END IF
      IF cl_null(r_ogc.ogc17) THEN LET r_ogc.ogc17=' ' END IF

      LET r_ogc.ogcplant = g_plant 
      LET r_ogc.ogclegal = g_legal  

      INSERT INTO ogc_file VALUES (r_ogc.*)
   END IF

   IF i = 0 AND g_oaz.oaz71='2' THEN   #由 img_gile 預設
      DECLARE t6006_c2 CURSOR FOR
       SELECT '','',img02,img03,img04,0,img09,0,0,'','' FROM img_file                             #FUN-8A0030 Add '',''
        WHERE img01 = g_ogb[l_ac].ogb04    #CHI-840009 mark AND img04 = g_ogb[l_ac].ogb092     #No.TQC-640123
          AND img10 > 0
          AND (img18 > g_oga.oga02 OR img18 IS NULL)

      LET l_ogc18 = 0    #No:FUN-870131

      FOREACH t6006_c2 INTO r_ogc.*
         IF STATUS THEN
            EXIT FOREACH
         END IF
         LET r_ogc.ogc01 = g_oga.oga01
         LET r_ogc.ogc03 = g_ogb[l_ac].ogb03     #No.TQC-640123
         LET r_ogc.ogc17 = g_ogb[l_ac].ogb04     #MOD-780256 add
         LET l_ogc18 = l_ogc18 + 1   #No:FUN-870131
         LET r_ogc.ogc18 = l_ogc18    #No:FUN-870131

         IF cl_null(r_ogc.ogc01) THEN LET r_ogc.ogc01=' ' END IF
         IF cl_null(r_ogc.ogc03) THEN LET r_ogc.ogc03=0 END IF
         IF cl_null(r_ogc.ogc09) THEN LET r_ogc.ogc09=' ' END IF
         IF cl_null(r_ogc.ogc091) THEN LET r_ogc.ogc091=' ' END IF
         IF cl_null(r_ogc.ogc092) THEN LET r_ogc.ogc092=' ' END IF
         IF cl_null(r_ogc.ogc17) THEN LET r_ogc.ogc17=' ' END IF

         LET r_ogc.ogcplant = g_plant 
         LET r_ogc.ogclegal = g_legal  

         INSERT INTO ogc_file VALUES (r_ogc.*)
      END FOREACH
   END IF

   LET p_row = 2 LET p_col = 2


   OPEN WINDOW t6006_w AT p_row,p_col WITH FORM "axm/42f/axmt6006"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN

    CALL cl_ui_locale("axmt6006")

#CHI-B60054  --mark Begin #mark CHI-B30093
#CHI-B30093 --begin--
#   IF g_argv0 != '8' THEN 
#      CALL cl_set_comp_visible("ogc12_1",FALSE)
#   ELSE 
#  	  CALL cl_set_comp_visible("ogc12_1",TRUE)
#   END IF 
#CHI-B30093 --end--
#CHI-B60054  --mark End #mark CHI-B30093
   
   DECLARE t6006_c CURSOR FOR
          #SELECT ogc12,ogc09,ogc091,ogc092,img10,ogc15,ogc15_fac,ogc16,ogc18   #No:FUN-870131   #CHI-9C0024 move ogc12
          # SELECT ogc09,ogc091,ogc092,ogc12,'',img10,ogc15,ogc15_fac,ogc16,ogc18   #No:FUN-870131   #CHI-9C0024 move ogc12   #CHI-B30093 add '' #CHI-B60054 mark
           SELECT ogc09,ogc091,ogc092,ogc12,img10,ogc15,ogc15_fac,ogc16,ogc18 #No.CHI-B60054
             FROM ogc_file, OUTER img_file
            WHERE ogc01 = g_oga.oga01 AND ogc03 = g_ogb[l_ac].ogb03     #No.TQC-640123
              AND img01=g_ogb[l_ac].ogb04
              AND img02=ogc09
              AND img03=ogc091
              AND img04=ogc092

   CALL l_ogc.clear()
   LET i = 1
   LET l_i = 1
   FOREACH t6006_c INTO l_ogc[i].*
      IF STATUS THEN
         CALL cl_err('foreach ogc',STATUS,0)
         EXIT FOREACH
      END IF
      #No.CHI-B60054  --mark Begin
      #No.TQC-B50099 --Begin
      #SELECT ogc09,ogc091 INTO l_ogc09_1,l_ogc091_1 FROM ogc_file, OUTER img_file
      #       WHERE ogc01 = g_oga.oga011 
      #         AND ogc03 = g_ogb[l_ac].ogb03     
      #         AND img01=g_ogb[l_ac].ogb04
      #         AND img02=ogc09
      #         AND img03=ogc091
      #         AND img04=ogc092
      #         AND ogc092=l_ogc[i].ogc092
      #SELECT ogc12 INTO l_ogc12_1 FROM ogc_file
      #       WHERE ogc01 = g_oga.oga011
      #         AND ogc03 = g_ogb[l_ac].ogb03
      #         AND ogc09 = l_ogc09_1
      #         AND ogc091= l_ogc091_1
      #         AND ogc092= l_ogc[i].ogc092
      #         AND ogc17 = g_ogb[l_ac].ogb04
      #IF cl_null(l_ogc12_1) THEN LET l_ogc12_1 = 0 END IF    
      #LET l_ogc[i].ogc12_1 = l_ogc12_1 - l_ogc[i].ogc12
      #DISPLAY BY NAME l_ogc[i].ogc12_1
      #No.TQC-B50099 --Begin
      #No.CHI-B60054  --mark End
      LET i = i + 1
   END FOREACH

   CALL l_ogc.deleteElement(i)
   LET l_i=(i-1)

   SELECT SUM(ogc12),SUM(ogc16) INTO l_ogc12_t,l_ogc16_t FROM ogc_file
    WHERE ogc01 = g_oga.oga01 AND ogc03 = g_ogb[l_ac].ogb03     #No.TQC-640123

   DISPLAY l_i TO cn2
   DISPLAY l_ogc12_t TO ogc12t
   DISPLAY l_ogc16_t TO ogc16t
   DISPLAY g_ogb[l_ac].ogb12 TO ogb12t   #NoTQC-640123

   LET l_allow_insert = cl_detail_input_auth("insert")
   LET l_allow_delete = cl_detail_input_auth("delete")

   LET i = 1

   INPUT ARRAY l_ogc WITHOUT DEFAULTS FROM s_ogc.*
         ATTRIBUTE(COUNT=l_i,MAXCOUNT=g_max_rec,UNBUFFERED,
                   INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,
                   APPEND ROW=l_allow_insert)

      BEFORE INPUT
         IF l_i != 0 THEN
            CALL fgl_set_arr_curr(i)
         END IF
         #-----MOD-B30487---------
         LET g_ogc18 = 0
         SELECT MAX(ogc18)+1 INTO g_ogc18 
           FROM ogc_file
          WHERE ogc01 = g_oga.oga01
            AND ogc03 = g_ogb[l_ac].ogb03
         IF cl_null(g_ogc18) OR g_ogc18 = 0 THEN
            LET g_ogc18 = 1
         END IF
         #-----END MOD-B30487-----
      
      BEFORE ROW
        LET i=ARR_CURR()
        CALL cl_show_fld_cont()     #FUN-550037(smin)

      BEFORE INSERT    #MOD-A60198
        IF cl_null(l_ogc[i].ogc18) OR l_ogc[i].ogc18 = 0 THEN
            #-----MOD-B30487---------
            #SELECT MAX(ogc18)+1 INTO l_ogc[i].ogc18
            #  FROM ogc_file 
            # WHERE ogc01 = g_oga.oga01
            #   AND ogc03 = g_ogb[l_ac].ogb03
            LET l_ogc[i].ogc18 = g_ogc18
            #-----END MOD-B30487-----
        END IF

      #-----MOD-B30487---------
      AFTER INSERT
        LET g_ogc18 = g_ogc18 + 1
      #-----END MOD-B30487-----

      AFTER FIELD ogc09
         IF NOT cl_null(l_ogc[i].ogc09) THEN
            SELECT COUNT(*) INTO l_n  FROM imd_file
             WHERE imd01=l_ogc[i].ogc09
               AND imd11='Y'     
               AND imdacti='Y'
            IF l_n=0 THEN
               CALL cl_err(l_ogc[i].ogc09,'axm-993',0)
               NEXT FIELD ogc09
            END IF
            #No.FUN-AA0048  --Begin
            #IF g_azw.azw04='2' THEN
            #   LET l_n =0                                                                                                     
            #   SELECT COUNT(*) INTO l_n FROM imd_file                                                                         
            #    WHERE imd01=l_ogc[i].ogc09                                                                                          
            #      AND imd20=g_plant                                                                                              
            #   IF l_n=0 THEN                                                                                                  
            #      CALL cl_err(l_ogc[i].ogc09,'art-487',0)                                                                           
            #      NEXT FIELD ogc09                                                                                           
            #   END IF                   
            #END IF
            IF NOT s_chk_ware(l_ogc[i].ogc09) THEN
               NEXT FIELD ogc09 
            END IF
            #No.FUN-AA0048  --End  
         END IF
      
      AFTER FIELD ogc12
         LET l_ogc[i].ogc16 = l_ogc[i].ogc12 * l_ogc[i].ogc15_fac
         DISPLAY l_ogc[i].ogc16 TO s_ogc[j].ogc16
#CHI-B60054  --mark Begin #mark CHI-B30093和TQC-B50099
         #IF g_argv0 = '8' THEN  #No.TQC-B50099
#CHI-B30093 --begin--  
#           SELECT ogc09,ogc091 INTO l_ogc09_1,l_ogc091_1 FROM ogc_file, OUTER img_file
#             WHERE ogc01 = g_oga.oga011 
#               AND ogc03 = g_ogb[l_ac].ogb03     
#               AND img01=g_ogb[l_ac].ogb04
#               AND img02=ogc09
#               AND img03=ogc091
#               AND img04=ogc092
#               AND ogc092=l_ogc[i].ogc092
#                            
#            SELECT ogc12 INTO l_ogc12_1 FROM ogc_file
#             WHERE ogc01 = g_oga.oga011
#               AND ogc03 = g_ogb[l_ac].ogb03
#               AND ogc09 = l_ogc09_1
#               AND ogc091= l_ogc091_1
#               AND ogc092= l_ogc[i].ogc092
#               AND ogc17 = g_ogb[l_ac].ogb04
#            IF cl_null(l_ogc12_1) THEN LET l_ogc12_1 = 0 END IF    
#            LET l_ogc[i].ogc12_1 = l_ogc12_1 - l_ogc[i].ogc12
#            IF l_ogc[i].ogc12_1 < 0 THEN 
#               CALL cl_err('','axm-938',0)
#               NEXT FIELD CURRENT 
#            ELSE 
#            	  DISPLAY BY NAME l_ogc[i].ogc12_1
#            END IF 
#CHI-B30093 --end--
         #END IF  #No.TQC-B50099

         LET g_ima918 = ''   #MOD-9C0055
         LET g_ima921 = ''   #MOD-9C0055
         SELECT ima918,ima921 INTO g_ima918,g_ima921
           FROM ima_file
          WHERE ima01 = g_ogb[l_ac].ogb04
            AND imaacti = "Y"

         IF (g_ima918 = "Y" OR g_ima921 = "Y") AND (l_ogc[i].ogc12<>0) THEN
           #IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add #CHI-AC0034 mark
            #IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR g_argv0='8' OR g_argv0='9' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add  #CHI-AC0034 add '8','9'   #MOD-AC0060 
            IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR g_argv0='8' OR g_argv0='9' OR g_argv0='A' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add  #CHI-AC0034 add '8','9'   #MOD-AC0060 add 'A'
               SELECT img09 INTO l_ogc[i].ogc15
                 FROM img_file
                WHERE img01 = g_ogb[l_ac].ogb04
                  AND img02 = l_ogc[i].ogc09
                  AND img03 = l_ogc[i].ogc091
                  AND img04 = l_ogc[i].ogc092
               
               DISPLAY l_ogc[i].ogc15 TO s_ogc[j].ogc15

               IF NOT cl_null(l_ogc[i].ogc15) THEN 
                  CALL s_umfchk(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb05,l_ogc[i].ogc15)
                      RETURNING g_cnt,l_ogc[i].ogc15_fac
                  IF g_cnt=1 THEN
                     CALL cl_err('','mfg3075',1)
                     NEXT FIELD ogc092 
                  END IF
               END IF

               IF cl_null(l_ogc[i].ogc15_fac) THEN
                  LET l_ogc[i].ogc15_fac = 1
               END IF

#No.CHI-9A0022 --Begin
               IF cl_null(g_ogb[l_ac].ogb41) THEN
                  #FUN-9C0103 ---start---
                  SELECT oea00,oea11,oea12 INTO l_oea00,l_oea11,l_oea12
                    FROM oea_file
                   WHERE oea01 = g_ogb[l_ac].ogb31
                  IF l_oea00 ='4' AND l_oea11 = '7' THEN
                     SELECT oga16 INTO l_oga16
                       FROM oga_file
                      WHERE oga01 = l_oea12
                     LET l_bno = l_oga16
                  ELSE
                  #FUN-9C0103 ---end---
                     LET l_bno = g_ogb[l_ac].ogb31
                  END IF
               ELSE
                  LET l_bno = g_ogb[l_ac].ogb41
               END IF
#No.CHI-9A0022 --End
               CALL s_lotout(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,l_ogc[i].ogc18,
                             g_ogb[l_ac].ogb04,l_ogc[i].ogc09,
                             l_ogc[i].ogc091,l_ogc[i].ogc092,
                             g_ogb[l_ac].ogb05,l_ogc[i].ogc15,l_ogc[i].ogc15_fac,
                             l_ogc[i].ogc12,l_bno,'MOD')#CHI-9A0022 add l_bno
                   RETURNING l_r,g_qty
               IF l_r = "Y" THEN
                  LET l_ogc[i].ogc12 = g_qty
               END IF
            END IF
         END IF

      AFTER ROW
         IF INT_FLAG THEN                 #900423
            CALL cl_err('',9001,0)
            EXIT INPUT
         END IF
         IF l_ogc[i].ogc12 IS NOT NULL AND l_ogc[i].ogc12 != 0 THEN
            IF l_ogc[i].ogc09 IS NULL THEN LET l_ogc[i].ogc09 = ' ' END IF
            IF l_ogc[i].ogc091 IS NULL THEN LET l_ogc[i].ogc091 = ' ' END IF
            IF l_ogc[i].ogc092 IS NULL THEN LET l_ogc[i].ogc092 = ' ' END IF
            SELECT img10,img09,img21 INTO l_ogc[i].img10,l_ogc[i].ogc15,l_img21
              FROM img_file
             WHERE img01 = g_ogb[l_ac].ogb04 AND img02 = l_ogc[i].ogc09     #No.TQC-640123
               AND img03 = l_ogc[i].ogc091   AND img04 = l_ogc[i].ogc092
            IF STATUS THEN
               IF g_oga.oga09 MATCHES '[2468]' THEN    #No:MOD-840533  
                  CALL cl_err3("sel","img_file","","",SQLCA.sqlcode,"","sel img",1)  #No.FUN-670008
                  NEXT FIELD ogc09
               END IF                 #No:MOD-840533 add
            END IF
      
            DISPLAY l_ogc[i].img10 TO s_ogc[j].img10
            DISPLAY l_ogc[i].ogc15 TO s_ogc[j].ogc15
            IF NOT cl_null(l_ogc[i].ogc15) THEN            #No:MOD-840533 add
               CALL s_umfchk(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb05,l_ogc[i].ogc15)     #No.TQC-640123
                             RETURNING g_cnt,l_ogc[i].ogc15_fac
               IF g_cnt=1 THEN CALL cl_err('','mfg3075',1) NEXT FIELD ogc092 END IF
            END IF        #No:MOD-840533 add
            IF cl_null(l_ogc[i].ogc15_fac) THEN LET l_ogc[i].ogc15_fac=1 END IF
            LET l_ogc[i].ogc16 = l_ogc[i].ogc12 * l_ogc[i].ogc15_fac
            DISPLAY l_ogc[i].ogc16 TO s_ogc[j].ogc16
         END IF

         
         IF l_ogc[i].ogc12 IS NOT NULL AND l_ogc[i].ogc12 <> 0 THEN
            FOR k = 1 TO l_ogc.getLength()
               IF k=i THEN CONTINUE FOR END IF
               IF l_ogc[k].ogc09 = l_ogc[i].ogc09 AND
                  l_ogc[k].ogc091= l_ogc[i].ogc091 AND
                  l_ogc[k].ogc092= l_ogc[i].ogc092 THEN
                  INITIALIZE l_ogc[i].* TO NULL DISPLAY l_ogc[i].* TO s_ogc[j].*
                  CALL cl_err('',-239,0) EXIT FOR
               END IF
            END FOR
         END IF
         
         LET l_ogc12_t = 0
         LET l_ogc16_t = 0


         FOR k = 1 TO l_ogc.getLength()
            IF l_ogc[k].ogc12 IS NOT NULL AND l_ogc[k].ogc12 <> 0 THEN
               LET l_ogc12_t = l_ogc12_t + l_ogc[k].ogc12
               LET l_ogc16_t = l_ogc16_t + l_ogc[k].ogc16 #/ l_ogc[k].ogc15_fac
            END IF
         END FOR

         DISPLAY l_ogc12_t TO ogc12t
         DISPLAY l_ogc16_t TO ogc16t

      AFTER INPUT
         IF l_ogc12_t != g_ogb[l_ac].ogb12 THEN     #No.TQC-640123
            IF cl_confirm('axm-170') THEN
#No.CHI-B60054  --mark Begin #mark CHI-B30093
#CHI-B30093 --begin--
               LET g_ogb[l_ac].ogb12 = 0 
               FOR k = 1 TO l_ogc.getLength()
                 LET g_ogb[l_ac].ogb12 = g_ogb[l_ac].ogb12 + l_ogc[k].ogc12
               END FOR
                                   
               DISPLAY BY NAME g_ogb[l_ac].ogb12
               UPDATE ogb_file SET ogb12 = g_ogb[l_ac].ogb12
                WHERE ogb01 = g_oga.oga01
                  AND ogb03 = g_ogb[l_ac].ogb03
#CHI-B30093 --end--   
#No.CHI-B60054  --mark End #mark CHI-B30093                  
               EXIT INPUT
            ELSE
               NEXT FIELD ogc09
            END IF
         END IF

      ON ACTION modi_lot
         LET g_ima918 = ''   #MOD-9C0055
         LET g_ima921 = ''   #MOD-9C0055
         SELECT ima918,ima921 INTO g_ima918,g_ima921
           FROM ima_file
          WHERE ima01 = g_ogb[l_ac].ogb04
            AND imaacti = "Y"

         IF g_ima918 = "Y" OR g_ima921 = "Y" THEN
           #IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add #CHI-AC0034 mark
            #IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR g_argv0='8' OR g_argv0='9' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add   #CHI-AC0034 add '8','9'   #MOD-AC0060 
            IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR g_argv0='8' OR g_argv0='9' OR g_argv0='A' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add   #CHI-AC0034 add '8','9'   #MOD-AC0060 add 'A'
               SELECT img09 INTO l_ogc[i].ogc15
                 FROM img_file
                WHERE img01 = g_ogb[l_ac].ogb04
                  AND img02 = l_ogc[i].ogc09
                  AND img03 = l_ogc[i].ogc091
                  AND img04 = l_ogc[i].ogc092
               
               DISPLAY l_ogc[i].ogc15 TO s_ogc[j].ogc15

               IF NOT cl_null(l_ogc[i].ogc15) THEN 
                  CALL s_umfchk(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb05,l_ogc[i].ogc15)
                      RETURNING g_cnt,l_ogc[i].ogc15_fac
                  IF g_cnt=1 THEN
                     CALL cl_err('','mfg3075',1)
                     NEXT FIELD ogc092 
                  END IF
               END IF

               IF cl_null(l_ogc[i].ogc15_fac) THEN
                  LET l_ogc[i].ogc15_fac = 1
               END IF

#No.CHI-9A0022 --Begin
               IF cl_null(g_ogb[l_ac].ogb41) THEN
                  #FUN-9C0103  --start---
                  SELECT oea00,oea11,oea12 INTO l_oea00,l_oea11,l_oea12
                    FROM oea_file
                   WHERE oea01 = g_ogb[l_ac].ogb31
                  IF l_oea00 = '4' AND l_oea11= '7' THEN
                     SELECT oga16 INTO l_oga16
                       FROM oga_file
                      WHERE oga01 = l_oea12
                     LET l_bno = l_oga16
                  ELSE
                  #FUN-9C0103 ---end---
                     LET l_bno = g_ogb[l_ac].ogb31
                  END IF 
               ELSE
                  LET l_bno = g_ogb[l_ac].ogb41
               END IF
#No.CHI-9A0022 --End
               CALL s_lotout(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,l_ogc[i].ogc18,
                             g_ogb[l_ac].ogb04,l_ogc[i].ogc09,
                             l_ogc[i].ogc091,l_ogc[i].ogc092,
                             g_ogb[l_ac].ogb05,l_ogc[i].ogc15,l_ogc[i].ogc15_fac,
                             l_ogc[i].ogc12,l_bno,'MOD')#CHI-9A0022 add l_bno
                   RETURNING l_r,g_qty
               IF l_r = "Y" THEN
                  LET l_ogc[i].ogc12 = g_qty
               END IF
            END IF
         END IF

      ON ACTION controlp
         CASE
            WHEN INFIELD(ogc09)
               IF g_azw.azw04='2' THEN
                  CALL q_img42(FALSE,FALSE,g_ogb[l_ac].ogb04,'','','','A','1',g_oga.ogaplant)                            
                        RETURNING l_ogc[i].ogc09,l_ogc[i].ogc091,l_ogc[i].ogc092
               ELSE
               CALL q_img4(FALSE,FALSE,g_ogb[l_ac].ogb04,' ',' ',' ','A')    #No.TQC-640123
                        RETURNING l_ogc[i].ogc09,l_ogc[i].ogc091,
                                  l_ogc[i].ogc092
               END IF   #No.FUN-870007
                  DISPLAY BY NAME l_ogc[i].ogc09,l_ogc[i].ogc091,l_ogc[i].ogc092         #No:MOD-490371
                 NEXT FIELD ogc09
            WHEN INFIELD(ogc091)
                 #No.FUN-AA0048  --Begin
                 #CALL cl_init_qry_var()
                 #LET g_qryparam.form = "q_ime"
                 #LET g_qryparam.default1 = l_ogc[i].ogc091
                 #LET g_qryparam.arg1     = l_ogc[i].ogc09 #倉庫編號 #MOD-4A0063
                 #LET g_qryparam.arg2     = 'SW'           #倉庫類別 #MOD-4A0063
                 #CALL cl_create_qry() RETURNING l_ogc[i].ogc091
                 CALL q_ime_1(FALSE,TRUE,l_ogc[i].ogc091,l_ogc[i].ogc09,"","","","","") RETURNING l_ogc[i].ogc091
                 #No.FUN-AA0048  --End  
                 DISPLAY BY NAME l_ogc[i].ogc091        #No:MOD-490371
                 NEXT FIELD ogc091
         END CASE

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT

      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121

      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121

      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121

   END INPUT

   IF INT_FLAG THEN
      LET g_success='N' # No:8641
      CALL cl_err('',9001,0)
      LET INT_FLAG = 0
      CLOSE WINDOW t6006_w
      RETURN
   END IF

   CLOSE WINDOW t6006_w


   DELETE FROM ogc_file WHERE ogc01 = g_oga.oga01 AND ogc03 = g_ogb[l_ac].ogb03    #No.TQC-640123

   FOR i = 1 TO l_ogc.getLength()
      IF l_ogc[i].ogc12 IS NULL OR l_ogc[i].ogc12 = 0 THEN 
         IF s_lotout_del(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,l_ogc[i].ogc18,g_ogb[l_ac].ogb04,'DEL') THEN
            CONTINUE FOR
         END IF
      END IF

      INSERT INTO ogc_file(ogc01,ogc03,ogc09,ogc091,ogc092,
                           ogc12,ogc15,ogc15_fac,ogc16,ogc17,ogc18,   #No:FUN-870131  #No.MOD-470041  #MOD-780256 modify
                           ogcplant,ogclegal)  #FUN-980010 add plant & legal
                    VALUES(g_oga.oga01,g_ogb[l_ac].ogb03,    #No.TQC-640123
                           l_ogc[i].ogc09,l_ogc[i].ogc091,l_ogc[i].ogc092,
                           l_ogc[i].ogc12,l_ogc[i].ogc15,l_ogc[i].ogc15_fac,
                           l_ogc[i].ogc16,g_ogb[l_ac].ogb04,l_ogc[i].ogc18,   #No:FUN-870131   #MOD-780256 modify
                           g_plant,g_legal) 
      IF SQLCA.sqlcode THEN
         CALL cl_err3("ins","ogc_file","","",SQLCA.sqlcode,"","INS-ogc",1)  #No.FUN-670008
         LET g_success = 'N'
         EXIT FOR
      END IF
   END FOR


END FUNCTION

FUNCTION t600_b_ogc_1()                 # 庫存異動明細(ogc_file)輸入
  DEFINE r_ogc      RECORD LIKE ogc_file.*
  DEFINE l_ogc      DYNAMIC ARRAY OF RECORD
                        #ogc12     LIKE ogc_file.ogc12,   #CHI-9C0024
                        ogc09     LIKE ogc_file.ogc09,
                        ogc091    LIKE ogc_file.ogc091,
                        ogc092    LIKE ogc_file.ogc092,
                        ogc12     LIKE ogc_file.ogc12,   #CHI-9C0024
                        #ogc12_1   LIKE ogc_file.ogc12,   #No.TQC-B50099
                         img10     LIKE img_file.img10, #MOD-530713
                        ogc15     LIKE ogc_file.ogc15,
                        ogc15_fac LIKE ogc_file.ogc15_fac,
                        ogc16     LIKE ogc_file.ogc16,
                        ogc18     LIKE ogc_file.ogc18   #No:FUN-870131
                      END RECORD
  DEFINE l_n          LIKE type_file.num5    #No.FUN-680137 SMALLINT
  DEFINE l_ogc12_t    LIKE ogc_file.ogc12
  DEFINE l_ogc16_t    LIKE ogc_file.ogc16
  DEFINE l_img21      LIKE img_file.img21
  DEFINE i,k,s,l_i    LIKE type_file.num5,    #No.FUN-680137 SMALLINT
         l_allow_insert   LIKE type_file.num5,                #可新增否  #No.FUN-680137 SMALLINT
         l_allow_delete   LIKE type_file.num5                 #可刪除否  #No.FUN-680137 SMALLINT
#   DEFINE l_ogc12_1    LIKE ogc_file.ogc12   #TQC-B50099  #CHI-B60054 mark
#   DEFINE l_ogc09_1    LIKE ogc_file.ogc09   #TQC-B50099  #CHI-B60054 mark
#   DEFINE l_ogc091_1   LIKE ogc_file.ogc09   #TQC-B50099  #CHI-B60054 mark
   
   LET p_row = 2 LET p_col = 2


   OPEN WINDOW t6006_w AT p_row,p_col WITH FORM "axm/42f/axmt6006"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN

   CALL cl_ui_locale("axmt6006")
   #No.CHI-B60054  --mark Begin
   #No.TQC-B50099  --Begin
   #IF g_argv0 != '8' THEN
   #   CALL cl_set_comp_visible("ogc12_1",FALSE) 
   #ELSE 
   #   CALL cl_set_comp_visible("ogc12_1",TRUE) 
   #END IF
   #No.TQC-B50099  --End
   #No.CHI-B60054  --mark End
   DECLARE t6006_c_1 CURSOR FOR
          #SELECT ogc12,ogc09,ogc091,ogc092,img10,ogc15,ogc15_fac,ogc16,ogc18   #No:FUN-870131   #CHI-9C0024 move ogc12
          #SELECT ogc09,ogc091,ogc092,ogc12,'',img10,ogc15,ogc15_fac,ogc16,ogc18   #No:FUN-870131   #CHI-9C0024 move ogc12 #TQC-B50099 add ogb12_1驗退量 #CHI-B60054 mark
           SELECT ogc09,ogc091,ogc092,ogc12,img10,ogc15,ogc15_fac,ogc16,ogc18   #No.CHI-B60054 
             FROM ogc_file, OUTER img_file            
            WHERE ogc01 = g_oga.oga01 AND ogc03 = g_ogb[l_ac].ogb03
              AND img01=g_ogb[l_ac].ogb04
              AND img02=ogc09
              AND img03=ogc091
              AND img04=ogc092   
   CALL l_ogc.clear()
   LET i = 1
   LET l_i = 1
   FOREACH t6006_c_1 INTO l_ogc[i].*
      IF STATUS THEN CALL cl_err('foreach ogc',STATUS,0) EXIT FOREACH END IF
      #No.CHI-B60054  --mark Begin
      #No.TQC-B50099  --Begin
      #SELECT ogc09,ogc091 INTO l_ogc09_1,l_ogc091_1 FROM ogc_file, OUTER img_file
      #  WHERE ogc01 = g_oga.oga011 
      #    AND ogc03 = g_ogb[l_ac].ogb03     
      #    AND img01=g_ogb[l_ac].ogb04
      #    AND img02=ogc09
      #    AND img03=ogc091
      #    AND img04=ogc092
      #    AND ogc092=l_ogc[i].ogc092
      #                 
      # SELECT ogc12 INTO l_ogc12_1 FROM ogc_file
      #  WHERE ogc01 = g_oga.oga011
      #    AND ogc03 = g_ogb[l_ac].ogb03
      #    AND ogc09 = l_ogc09_1
      #    AND ogc091= l_ogc091_1
      #    AND ogc092= l_ogc[i].ogc092
      #    AND ogc17 = g_ogb[l_ac].ogb04
      # IF cl_null(l_ogc12_1) THEN LET l_ogc12_1 = 0 END IF    
      # LET l_ogc[i].ogc12_1 = l_ogc12_1 - l_ogc[i].ogc12
      # DISPLAY BY NAME l_ogc[i].ogc12_1
      #No.TQC-B50099  --End
      #No.CHI-B60054  --mark End
      LET i = i + 1
   END FOREACH
   CALL l_ogc.deleteElement(i)
   LET l_i=(i-1)

   SELECT SUM(ogc12),SUM(ogc16) INTO l_ogc12_t,l_ogc16_t FROM ogc_file
    WHERE ogc01 = g_oga.oga01 AND ogc03 = g_ogb[l_ac].ogb03

   DISPLAY l_i TO cn2
   DISPLAY l_ogc12_t TO ogc12t
   DISPLAY l_ogc16_t TO ogc16t
   DISPLAY g_ogb[l_ac].ogb12 TO ogb12t   #No:MOD-590206
   
   
                  
   
   CALL cl_set_act_visible("cancel", FALSE)

   IF g_action_choice="qry_mntn_inv_detail" THEN
      DISPLAY ARRAY l_ogc TO s_ogc.* ATTRIBUTE(COUNT=g_rec_b1,UNBUFFERED)    #No.TQC-640123

         BEFORE ROW
           LET i=ARR_CURR()
           CALL cl_show_fld_cont()

         ON ACTION qry_lot
            LET g_ima918 = ''   #MOD-9C0055
            LET g_ima921 = ''   #MOD-9C0055
            SELECT ima918,ima921 INTO g_ima918,g_ima921
              FROM ima_file
             WHERE ima01 = g_ogb[l_ac].ogb04
               AND imaacti = "Y"
         
            IF g_ima918 = "Y" OR g_ima921 = "Y" THEN
              #IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add #CHI-AC0034 mark
               #IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR g_argv0='8' OR g_argv0='9' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add #CHI-AC0034 add '8','9'   #MOD-AC0060 
               IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR g_argv0='8' OR g_argv0='9' OR g_argv0='A' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add #CHI-AC0034 add '8','9'   #MOD-AC0060 add 'A'
                  CALL s_lotout(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,l_ogc[i].ogc18,
                                g_ogb[l_ac].ogb04,l_ogc[i].ogc09,
                                l_ogc[i].ogc091,l_ogc[i].ogc092,
                                g_ogb[l_ac].ogb05,l_ogc[i].ogc15,l_ogc[i].ogc15_fac,
                                l_ogc[i].ogc12,'','QRY')#CHI-9A0022
                      RETURNING l_r,g_qty
                  IF l_r = "Y" THEN
                     LET l_ogc[i].ogc12 = g_qty
                  END IF
               END IF
            END IF
         
         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE DISPLAY
         
         ON ACTION about         
            CALL cl_about()      
         
         ON ACTION help          
            CALL cl_show_help()  
         
         ON ACTION controlg      
            CALL cl_cmdask()     

      END DISPLAY 

   END IF

   CLOSE WINDOW t6006_w 

   IF INT_FLAG THEN
      LET INT_FLAG = 0
      RETURN
   END IF

END FUNCTION

FUNCTION t600_mlog(p_cmd)       # Transaction Modify Log (存入 oem_file)
   DEFINE p_cmd         LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)
   DEFINE l_oem05       LIKE type_file.chr8    #No.FUN-680137 VARCHAR(8)
   DEFINE l_oem         RECORD LIKE oem_file.*
   IF g_oga.oga06 IS NULL THEN RETURN END IF
   INITIALIZE l_oem.* TO NULL
   LET l_oem.oem01=g_oga.oga01
   LET l_oem.oem03=b_ogb.ogb03
   LET l_oem.oem04=g_today
   LET l_oem05 = TIME
   LET l_oem.oem05=l_oem05
   LET l_oem.oem06=g_user
   LET l_oem.oem07=p_cmd
   LET l_oem.oem08=g_oga.oga06
   IF p_cmd='A' THEN
      LET l_oem.oem10o=NULL LET l_oem.oem11o=NULL
      LET l_oem.oem12o=NULL LET l_oem.oem13o=NULL LET l_oem.oem15o=NULL
      LET l_oem.oem12n=b_ogb.ogb12
   END IF
   IF p_cmd='R' THEN
      LET l_oem.oem10o=g_ogb_t.ogb04
      LET l_oem.oem11o=g_ogb_t.ogb092
      LET l_oem.oem12o=g_ogb_t.ogb12
      LET l_oem.oem10n=NULL LET l_oem.oem11n=NULL
      LET l_oem.oem12n=NULL LET l_oem.oem13n=NULL LET l_oem.oem15n=NULL
   END IF
   IF p_cmd='U' THEN
      IF g_ogb_t.ogb04 != b_ogb.ogb04 THEN
         LET l_oem.oem10o=g_ogb_t.ogb04 LET l_oem.oem10n=b_ogb.ogb04
      END IF
      IF g_ogb_t.ogb092 != b_ogb.ogb092 THEN
         LET l_oem.oem11o=g_ogb_t.ogb092 LET l_oem.oem11n=b_ogb.ogb092
      END IF
      IF g_ogb_t.ogb12 != b_ogb.ogb12 THEN
         LET l_oem.oem12o=g_ogb_t.ogb12 LET l_oem.oem12n=b_ogb.ogb12
      END IF
      IF cl_null(l_oem.oem10n) AND cl_null(l_oem.oem11n) AND
         cl_null(l_oem.oem12n) AND cl_null(l_oem.oem13n) AND
         cl_null(l_oem.oem15n) THEN RETURN
      END IF
      IF l_oem.oem12n=0 THEN LET l_oem.oem12n=NULL END IF
      IF l_oem.oem13n=0 THEN LET l_oem.oem13n=NULL END IF
   END IF

   LET l_oem.oemplant = g_plant 
   LET l_oem.oemlegal = g_legal  

   INSERT INTO oem_file VALUES (l_oem.*)
END FUNCTION

FUNCTION t600_bu()
   DEFINE l_oea61   LIKE oea_file.oea61    #No:FUN-A50103
   DEFINE l_oea1008 LIKE oea_file.oea1008  #No:FUN-A50103
   DEFINE l_oea261  LIKE oea_file.oea261   #No:FUN-A50103
   DEFINE l_oea262  LIKE oea_file.oea262   #No:FUN-A50103
   DEFINE l_oea263  LIKE oea_file.oea263   #No:FUN-A50103

   LET g_oga.oga50 = NULL

   SELECT SUM(ogb14) INTO g_oga.oga50 FROM ogb_file WHERE ogb01 = g_oga.oga01

   CALL cl_digcut(g_oga.oga50,t_azi04) RETURNING g_oga.oga50  #CHI-7A0036-add
   IF cl_null(g_oga.oga50) THEN LET g_oga.oga50 = 0 END IF

   #-----No:FUN-A50103-----
   SELECT oea61,oea1008,oea261,oea262,oea263
     INTO l_oea61,l_oea1008,l_oea261,l_oea262,l_oea263
     FROM oea_file
    WHERE oea01 = g_oga.oga16
   IF g_oga.oga213 = 'Y' THEN
      LET g_oga.oga52 = g_oga.oga50 * l_oea261 / l_oea1008
      LET g_oga.oga53 = g_oga.oga50 * (l_oea262+l_oea263) / l_oea1008
   ELSE
      LET g_oga.oga52 = g_oga.oga50 * l_oea261 / l_oea61
      LET g_oga.oga53 = g_oga.oga50 * (l_oea262+l_oea263) / l_oea61
   END IF
  #LET g_oga.oga52 = g_oga.oga50 * g_oga.oga161/100
  #LET g_oga.oga53 = g_oga.oga50 * (g_oga.oga162+g_oga.oga163)/100
   #-----No:FUN-A50103 END-----
   CALL cl_digcut(g_oga.oga52,t_azi04) RETURNING g_oga.oga52  #CHI-7A0036-add
   CALL cl_digcut(g_oga.oga53,t_azi04) RETURNING g_oga.oga53  #CHI-7A0036-add
#TQC-A70061 --add
 IF cl_null(g_oga.oga52) THEN LET g_oga.oga52 = 0 END IF
 IF cl_null(g_oga.oga53) THEN LET g_oga.oga53 = 0 END IF
#TQC-A70061 --end
   UPDATE oga_file SET oga50=g_oga.oga50,
                       oga52=g_oga.oga52,
                       oga53=g_oga.oga53
    WHERE oga01 = g_oga.oga01
   IF STATUS THEN
      CALL cl_err3("upd","oga_file",g_oga.oga01,"",SQLCA.sqlcode,"","_bu():upd oga",1)  #No.FUN-670008
   END IF

END FUNCTION

FUNCTION t600_out()
 DEFINE l_wc LIKE type_file.chr1000            #No:TQC-610089 add    #No.FUN-680137 VARCHAR(100)
 DEFINE l_no LIKE oga_file.oga01 #FUN-560176
 IF g_oga.oga01 IS NULL THEN RETURN END IF

 LET l_no=g_oga.oga01

 #FUN-B10026  add----
 IF g_argv0 MATCHES '9' THEN
    LET l_no = g_oga.oga01
    LET l_wc='oga01="',l_no,'"'
    LET g_msg = "axmr600",
                " '",g_today CLIPPED,"' ''",
                " '",g_lang CLIPPED,"' '",g_bgjob CLIPPED,"'  '' '1'",
                " '",l_wc CLIPPED,"' ",
                " 'N' 'Y' 'N' "
    CALL cl_cmdrun(g_msg)
 ELSE
#FUN-B10026 END-----
    MENU ""
       ON ACTION ship_notice
          IF g_argv0 MATCHES '[15]' THEN   #No.7992
             LET l_no = g_oga.oga01
          END IF
          #報表的處理后續再
          IF g_argv0 MATCHES '[2468]' THEN  #No.7992
             LET l_no = g_oga.oga011
          END IF
          LET l_wc='oga01="',l_no,'"'
             LET g_msg = "axmr500",
                       " '",g_today CLIPPED,"' ''",
                       " '",g_lang CLIPPED,"' '",g_bgjob CLIPPED,"'  '' '1'",  #MOD-670031 'Y'->g_bgjob
                       " '",l_wc CLIPPED,"' '' 'N' "    #MOD-850241                                                                                   
          CALL cl_cmdrun(g_msg)

       ON ACTION delivery_note
          IF g_argv0 MATCHES '[15]' THEN   #No.7992
             LET l_no = g_oga.oga011
          END IF
          ##報表的處理后續再
          IF g_argv0 MATCHES '[2468A]' THEN  #No.7992   #FUN-750036 
             LET l_no = g_oga.oga01
          END IF
              LET l_wc='oga01="',l_no,'"'
         IF g_argv0 <> 'A' THEN   #FUN-750036
              LET g_msg = "axmr600",
                       " '",g_today CLIPPED,"' ''",
                       " '",g_lang CLIPPED,"' '",g_bgjob CLIPPED,"'  '' '1'",  #MOD-670031 'Y'->g_bgjob
                       " '",l_wc CLIPPED,"' ",
                       " 'N' 'Y' 'N' "   #MOD-870145
        ELSE
          LET g_msg = "axmr605",
                   " '",g_today CLIPPED,"' ''",
                   " '",g_lang CLIPPED,"' '",g_bgjob CLIPPED,"'  '' '1'",
                   " '",l_wc CLIPPED,"' "
        END IF
          CALL cl_cmdrun(g_msg)

       ON ACTION invoice_r550 #CHI-AB0029 mod invoice->invoice_r550
          LET l_no = NULL  #CHI-830036
          IF g_argv0 MATCHES '[125]' THEN   #No.7992
              SELECT ofa01 INTO l_no FROM ofa_file
               WHERE ofa011=g_oga.oga01
              IF cl_null(l_no) THEN
                IF g_oaz.oaz67='1' THEN
                   SELECT ofa01 INTO l_no FROM ofa_file
                    WHERE ofa011=g_oga.oga011
                END IF 
              END IF 
          END IF
          ##報表的處理后續再
          IF g_argv0 MATCHES '[468]' THEN  #No.7992
             SELECT ofa01 INTO l_no FROM ofa_file
               WHERE ofa011=g_oga.oga011
          END IF
          LET l_wc='ofa01="',l_no,'"'
          LET g_msg = "axmr550",
                       " '",g_today CLIPPED,"' ''",
                       " '",g_lang CLIPPED,"' '",g_bgjob CLIPPED,"'  '' '1'",  #MOD-670031 'Y'->g_bgjob
                       " '",l_wc CLIPPED,"' "
                      ," '' 'Y' 'Y'"   #TQC-740304 add
          CALL cl_cmdrun(g_msg)

       #CHI-AB0029 add --start--------------------
       ON ACTION invoice_r551
          LET l_no = NULL 
          IF g_argv0 MATCHES '[125]' THEN
              SELECT ofa01 INTO l_no FROM ofa_file
               WHERE ofa011=g_oga.oga01
              IF cl_null(l_no) THEN
                IF g_oaz.oaz67='1' THEN
                   SELECT ofa01 INTO l_no FROM ofa_file
                    WHERE ofa011=g_oga.oga011
                END IF 
              END IF 
          END IF
          ##報表的處理后續再
          IF g_argv0 MATCHES '[468]' THEN 
             SELECT ofa01 INTO l_no FROM ofa_file
               WHERE ofa011=g_oga.oga011
          END IF
          LET l_wc='ofa01="',l_no,'"'
          LET g_msg = "axmr551",
                      " '",g_today CLIPPED,"' ''",
                      " '",g_lang CLIPPED,"' '",g_bgjob CLIPPED,"' '' '1'",
                      " '",l_wc CLIPPED,"' ",
                      " 'Y' 'Y' 'Y' 'N'"
          CALL cl_cmdrun(g_msg)
       #CHI-AB0029 add --end----------------------

       ON ACTION packing_list_r552 #CHI-AB0029 mod packing_list->packing_list_r552
          IF g_argv0 MATCHES '[125]' THEN   #No.7992
              SELECT ofa01 INTO l_no FROM ofa_file
               WHERE ofa011=g_oga.oga01
          END IF
          ##報表的處理后續再
          IF g_argv0 MATCHES '[468]' THEN  #No.7992
             SELECT ofa01 INTO l_no FROM ofa_file
               WHERE ofa011=g_oga.oga011
          END IF
          LET l_wc='ofa01="',l_no,'"'
          LET g_msg = "axmr552",
                       " '",g_today CLIPPED,"' ''",
                       " '",g_lang CLIPPED,"' '",g_bgjob CLIPPED,"'  '' '1'",  #MOD-670031 'Y'->g_bgjob
                       " '",l_wc CLIPPED,"' "
                      ," '' 'N' '1' 'Y' 'Y'"  #MOD-970252                     
          CALL cl_cmdrun(g_msg)

       #CHI-AB0029 add --start--------------------
       ON ACTION packing_list_r553
          IF g_argv0 MATCHES '[125]' THEN 
              SELECT ofa01 INTO l_no FROM ofa_file
               WHERE ofa011=g_oga.oga01
          END IF
          ##報表的處理后續再
          IF g_argv0 MATCHES '[468]' THEN
             SELECT ofa01 INTO l_no FROM ofa_file
               WHERE ofa011=g_oga.oga011
          END IF
          LET l_wc='ofa01="',l_no,'"'
          LET g_msg = "axmr553",
                       " '",g_today CLIPPED,"' ''",
                       " '",g_lang CLIPPED,"' '",g_bgjob CLIPPED,"' '' '1'",
                       " '",l_wc CLIPPED,"' ",
                       " 'N' 'Y' 'Y' 'N'"
          CALL cl_cmdrun(g_msg)
       #CHI-AB0029 add --end----------------------
       #NO.111017 add------------------begin
       ON ACTION tianjia
          LET l_wc='oga01="',g_oga.oga01,'"'
          LET g_msg = "cxmr001",
                      " '",g_today,"' '",g_user,"' '",g_lang,"'",
                      " 'Y' ' ' '1' ", 
                      " '",l_wc,"' '3'"
          CALL cl_cmdrun(g_msg)
       
       ON ACTION geli
          LET l_wc='oga01="',g_oga.oga01,'"'
          LET g_msg = "cxmr002",
                      " '",g_today,"' '",g_user,"' '",g_lang,"'",
                      " 'Y' ' ' '1' ",
                      " '",l_wc,"' '3'"
          CALL cl_cmdrun(g_msg)

       ON ACTION teling
          LET l_wc='oga01="',g_oga.oga01,'"'
          LET g_msg = "cxmr003",
                      " '",g_today,"' '",g_user,"' '",g_lang,"'",
                      " 'Y' ' ' '1' ",
                      " '",l_wc,"' '3'"
          CALL cl_cmdrun(g_msg)
       
       ON ACTION deli_cxmr004
          LET l_wc='oga01="',g_oga.oga01,'"'
          LET g_msg = "cxmr004",
                      " '",g_today,"' '",g_user,"' '",g_lang,"'",
                      " 'Y' ' ' '1' ",
                      " '",l_wc,"' "
          CALL cl_cmdrun(g_msg)
       
       ON ACTION tell_cxmr005
          IF g_argv0 MATCHES '[15]' THEN
             LET l_wc = 'oga01="',g_oga.oga01,'"'
          END IF
          IF g_argv0 MATCHES '[2468]' THEN
             LET l_wc = 'oga01="',g_oga.oga011,'"'
          END IF
          LET g_msg = "cxmr005",
                      " '",g_today,"' '",g_user,"' '",g_lang,"'",
                      " 'Y' ' ' '1' ",
                      " '",l_wc,"' '3' "
          CALL cl_cmdrun(g_msg)
     
     # cxmr014  出货单标签 格式   
       ON ACTION tell_cxmr014
          LET l_wc = 'oga01="',g_oga.oga01,'"'
          LET g_msg = "cxmr014",
                      " '",g_today,"' '",g_user,"' '",g_lang,"'",
                      " 'Y' ' ' '1' ",
                      " '",l_wc,"' "
          CALL cl_cmdrun(g_msg)
       
       ON ACTION sale_cxmr600
          LET l_wc = 'oga01="',g_oga.oga01,'"'
          LET g_msg = "cxmr600",
                      " '",g_today,"' '",g_user,"' '",g_lang,"'",
                      " 'Y' ' ' '1' ",
                      " '",l_wc,"' "
          CALL cl_cmdrun(g_msg)
      {  ON ACTION sale_cxmr601
          LET l_wc = 'oga01="',g_oga.oga01,'"'
          LET g_msg = "cxmr601",
                      " '",g_today,"' '",g_user,"' '",g_lang,"'",
                      " 'Y' ' ' '1' ",
                      " '",l_wc,"' "
          CALL cl_cmdrun(g_msg)
        ON ACTION sale_cxmr602
          LET l_wc = 'oga01="',g_oga.oga01,'"'
          LET g_msg = "cxmr602",
                      " '",g_today,"' '",g_user,"' '",g_lang,"'",
                      " 'Y' ' ' '1' ",
                      " '",l_wc,"' "
          CALL cl_cmdrun(g_msg)
        ON ACTION sale_cxmr603
          LET l_wc = 'oga01="',g_oga.oga01,'"'
          LET g_msg = "cxmr603",
                      " '",g_today,"' '",g_user,"' '",g_lang,"'",
                      " 'Y' ' ' '1' ",
                      " '",l_wc,"' "
          CALL cl_cmdrun(g_msg) } #xiaoyx
     #NO.111017 add--------------------end
       ON ACTION exit
          EXIT MENU

       ON ACTION cancel
          EXIT MENU

       ON IDLE g_idle_seconds
          CALL cl_on_idle()
          CONTINUE MENU

      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121

      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121

      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121

        -- for Windows close event trapped
        ON ACTION close   #COMMAND KEY(INTERRUPT) #FUN-9B0145  
             LET INT_FLAG=FALSE   #MOD-570244 mars
            LET g_action_choice = "exit"
            EXIT MENU
    END MENU
 END IF      #FUN-B10026 ADD
END FUNCTION

FUNCTION t600_set_entry_1()

    IF INFIELD(oga044) OR ( NOT g_before_input_done ) THEN
       CALL cl_set_comp_entry("oap041,oap042,oap043,oap044,oap045",TRUE)   #MOD-910186 增加oap044/oap045
    END IF

    IF cl_null(g_oga.oga16) THEN 
       CALL cl_set_comp_entry("oga32",TRUE) 
    END IF

    CALL cl_set_comp_entry("oga910,oga911",TRUE)    #MOD-950276
END FUNCTION

FUNCTION t600_set_no_entry_1()

    IF INFIELD(oga044) OR ( NOT g_before_input_done ) THEN
       IF g_oga.oga044[1,4] !='MISC' OR cl_null(g_oga.oga044) THEN    #MOD-920048
          CALL cl_set_comp_entry("oap041,oap042,oap043,oap044,oap045",FALSE)   #MOD-910186 增加oap044/oap045
       END IF
    END IF

    IF NOT cl_null(g_oga.oga16) THEN 
       CALL cl_set_comp_entry("oga32",FALSE) 
    END IF

    IF NOT (g_argv0='2' AND g_oga.oga00 MATCHES '[37]') OR g_oga.ogapost = 'Y'  THEN 
       CALL cl_set_comp_entry("oga910,oga911",FALSE)    
    END IF 

END FUNCTION



FUNCTION t600_fsgl(p_npptype) #CHI-AC0002 add p_npptype
    DEFINE p_npptype LIKE npp_file.npptype #CHI-AC0002 add

    IF g_oga.oga01 IS NULL THEN RETURN END IF
    IF g_oga.oga09 MATCHES '[15]' THEN RETURN END IF  #No.7992
    IF g_oga.oga09 MATCHES '[469]' THEN RETURN END IF  #No.7992 多角不產生分錄 #No.FUN-630061
    IF g_oga.oga07='N' OR cl_null(g_oga.oga07) THEN
       CALL cl_err('','axm-166',0)
       RETURN
    END IF

    # 2004/05/24
    LET g_action_choice="modify"
    IF NOT cl_chk_act_auth() THEN
       LET g_chr='D'
    ELSE
       LET g_chr='U'
    END IF

    IF p_npptype = '0' THEN #CHI-AC0002 add
       CALL s_fsgl('AR',1,g_oga.oga01,0,g_oaz.oaz02b,1,g_oga.ogaconf,'0',g_ooz.ooz02p)
    #CHI-AC0002 add --start--
    ELSE
       CALL s_fsgl('AR',1,g_oga.oga01,0,g_oaz.oaz02b,1,g_oga.ogaconf,'1',g_ooz.ooz02p)
    END IF
    #CHI-AC0002 add --end--
END FUNCTION

FUNCTION t600_v()
   DEFINE l_wc    LIKE type_file.chr1000 #No.FUN-680137 VARCHAR(100)
   DEFINE l_oga01 LIKE oga_file.oga01
   DEFINE only_one LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)
   IF g_oga.ogaconf = 'Y' THEN CALL cl_err(g_oga.oga01,'anm-232',0) RETURN END IF   #TQC-720016
   IF g_oga.oga09 MATCHES '[15]' THEN RETURN END IF  #No.7992
   IF g_oga.oga09 MATCHES '[46]' THEN RETURN END IF  #No.7992 多角不產生分錄  #No.FUN-630061
   IF g_oga.oga07='N' OR cl_null(g_oga.oga07) THEN
      CALL cl_err('','axm-259',0) RETURN
   END IF

   LET p_row = 5 LET p_col = 11


   OPEN WINDOW t6009_w AT p_row,p_col WITH FORM "axm/42f/axmt6009"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN

    CALL cl_ui_locale("axmt6009")


   LET only_one = '1'
   INPUT BY NAME only_one WITHOUT DEFAULTS
     AFTER FIELD only_one
      IF only_one IS NULL THEN NEXT FIELD only_one END IF
      IF only_one NOT MATCHES "[12]" THEN NEXT FIELD only_one END IF
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT

      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121

      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121

      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121


   END INPUT
   IF INT_FLAG THEN LET INT_FLAG = 0 CLOSE WINDOW t6009_w RETURN END IF
   IF only_one = '1' THEN
      LET l_wc = " oga01 = '",g_oga.oga01,"' "
   ELSE
   CALL cl_set_head_visible("","YES")       #No.FUN-6A0092
      CONSTRUCT BY NAME l_wc ON oga00,oga08,oga01,oga02,oga14,oga15

      BEFORE CONSTRUCT
         CALL cl_qbe_init()

      ON IDLE g_idle_seconds   #MOD-930313 BEFORE CONSTRUCT位置放錯
         CALL cl_on_idle()
         CONTINUE CONSTRUCT

      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121

      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121

      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121


                 ON ACTION qbe_select
                   CALL cl_qbe_select()
                 ON ACTION qbe_save
                   CALL cl_qbe_save()
      END CONSTRUCT
      IF INT_FLAG THEN
         LET INT_FLAG=0
         CLOSE WINDOW t6009_w
         RETURN
      END IF
   END IF
   CLOSE WINDOW t6009_w

   CALL cl_msg("WORKING !")
   LET g_sql = "SELECT oga01,oga20 FROM oga_file WHERE ",l_wc CLIPPED,
               " AND oga07 = 'Y' ",    #MOD-A80056 #MOD-B20059 add ,
               " AND oga09 = ",g_argv0 #MOD-B20059 add
   PREPARE t600_v_p FROM g_sql
   DECLARE t600_v_c CURSOR WITH HOLD FOR t600_v_p
   FOREACH t600_v_c INTO l_oga01,g_chr
      IF STATUS THEN EXIT FOREACH END IF
      IF g_chr = 'N' THEN CONTINUE FOREACH END IF
     #CHI-AC0002 mod --start--
     #CALL s_t600_gl(l_oga01)
      CALL s_t600_gl(l_oga01,'0')
      IF g_aza.aza63 = 'Y' THEN
         CALL s_t600_gl(l_oga01,'1')
      END IF
     #CHI-AC0002 mod --end-- 
   END FOREACH
END FUNCTION

FUNCTION t600_m()
   IF g_oga.oga01 IS NULL THEN RETURN END IF

   LET g_action_choice="modify"
   IF NOT cl_chk_act_auth() THEN
      LET g_chr='d'
   ELSE
      LET g_chr='u'
   END IF
   CALL s_axm_memo(g_oga.oga01,0,g_chr)
END FUNCTION

FUNCTION t600_w()    # when g_oga.ogaconf='Y' (Turn to 'N')
   DEFINE  l_n    LIKE type_file.num5                #放COUNT筆數  #No.FUN-680137 SMALLINT
   DEFINE  l_oea904  LIKE oea_file.oea904    #NO.FUN-670007
   DEFINE  l_poz00   LIKE poz_file.poz00    #NO.FUN-670007
   DEFINE  l_argv0   LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)    #NO.FUN-670007
   DEFINE  l_cnt     LIKE type_file.num5                  #FUN-680010  #No.FUN-680137 SMALLINT
   DEFINE  l_ogb31   LIKE ogb_file.ogb31    #MOD-870278 add
   DEFINE  l_ogb14t  LIKE ogb_file.ogb14t   #MOD-B10154

  #CHI-A50004 程式搬移 --start--
   BEGIN WORK

   OPEN t600_cl USING g_oga.oga01
   IF STATUS THEN
      CALL cl_err("OPEN t600_cl:", STATUS, 1)
      CLOSE t600_cl
      ROLLBACK WORK
      RETURN
   END IF

   FETCH t600_cl INTO g_oga.*          # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
      CALL cl_err(g_oga.oga01,SQLCA.sqlcode,0)     # 資料被他人LOCK
      CLOSE t600_cl ROLLBACK WORK RETURN
   END IF
  #CHI-A50004 程式搬移 --end--

   SELECT * INTO g_oga.* FROM oga_file WHERE oga01 = g_oga.oga01  #No.TQC-9A0161
   IF g_oga.ogaconf = 'N' THEN ROLLBACK WORK RETURN END IF #CHI-A50004 add ROLLBACK WORK
   IF g_oga.ogaconf = 'X' THEN CALL cl_err('',9024,0) ROLLBACK WORK RETURN END IF #CHI-A50004 add ROLLBACK WORK

   #-->已有QC單則不可取消確認
   SELECT COUNT(*) INTO l_cnt FROM qcs_file
    WHERE qcs01 = g_oga.oga01
      AND qcs14 <> 'X'   #MOD-970260       
   IF l_cnt > 0 THEN
      CALL cl_err(' ','aqc-118',0)
      ROLLBACK WORK #CHI-A50004 add
      RETURN
   END IF
   
#No.FUN-A50071 -------start-----------
   #--> oga94 POS銷售否=Y時，不可取消審核
#  IF g_oga.oga94 != 'Y' THEN       #TQC-A50162 mark
   IF g_oga.oga94 = 'Y' THEN        #TQC-A50162 add
      CALL cl_err('','axm-740',0)
      ROLLBACK WORK #CHI-A50004 add
      RETURN 
   END IF   
#No.FUN-A50071 --------end-----------

   IF g_oga.oga55 = 'S' THEN
      CALL cl_err(g_oga.oga01,'apm-030',1)
      ROLLBACK WORK #CHI-A50004 add
   RETURN
   END IF

   SELECT COUNT(*) INTO g_cnt FROM ofa_file
   WHERE ofa011=g_oga.oga01
     AND ofaconf <> 'X' #作廢的刪除 #MOD-680025 add
   IF g_cnt > 0  THEN CALL  cl_err(g_oga.oga01,'axm-021',1) ROLLBACK WORK RETURN  END IF #CHI-A50004 add ROLLBACK WORK
   IF g_argv0 MATCHES '[15]' THEN #No.7992
       SELECT COUNT(*) INTO l_n FROM oga_file
        WHERE oga011 = g_oga.oga01
          AND oga09 IN ('2','4','6') #No.7992  #No.FUN-630061
          AND ogaconf != 'X'
       #此出貨通知單已經出貨! 不可再做任何處理!
       IF l_n > 0 THEN
           CALL cl_err(g_oga.oga011,'axm-228',0)
           ROLLBACK WORK #CHI-A50004 add
           RETURN
       END IF
   END IF
   # 已有境外倉出貨訂單的資料，則不可取消確認
   IF g_argv0='2' AND g_oga.oga00 MATCHES '[37]' THEN    #No.FUN-610064
      SELECT COUNT(*) INTO g_cnt FROM oea_file
       WHERE oea11='7' AND oea12 = g_oga.oga01
         AND oeaconf != 'X'   #MOD-8B0302
      IF g_cnt > 0 THEN
         CALL cl_err('','axm-805',1) ROLLBACK WORK RETURN #CHI-A50004 add ROLLBACK WORK
      END IF
   END IF
   IF g_argv0 MATCHES '[2468]' OR g_argv0='3' THEN ##出貨單  #No.7992  #No.FUN-630061
      SELECT COUNT(*) INTO l_n FROM oha_file,ohb_file
       WHERE oha01=ohb01 AND ohaconf!='X' AND ohb31 = g_oga.oga01
      IF l_n > 0 THEN
          CALL cl_err(g_oga.oga01,'axm-030',0)
          ROLLBACK WORK #CHI-A50004 add
          RETURN
      END IF
   END IF
   IF g_oga.ogapost='Y' THEN CALL cl_err('ogapost=Y:','axm-208',0) ROLLBACK WORK RETURN END IF #CHI-A50004 add ROLLBACK WORK
   IF NOT (g_argv0 = '1' OR g_argv0 = '5')  THEN   #不是出通單 #CHI-690076
     IF g_oaz.oaz03 = 'Y' AND g_sma.sma53 IS NOT NULL AND
        g_oga.oga02 <= g_sma.sma53 THEN
        CALL cl_err('','mfg9999',0)
        ROLLBACK WORK #CHI-A50004 add
        RETURN
     END IF
   END IF
   IF g_oga.oga909 = 'Y' THEN
      IF g_oga.oga906 <>'Y' THEN   #是否為來源出貨單
         CALL cl_err(g_oga.oga906,'axm-996',0)
         ROLLBACK WORK #CHI-A50004 add
         RETURN
      END IF
   END IF
   IF g_bgjob = 'N' THEN 
      IF NOT cl_confirm('axm-109') THEN ROLLBACK WORK RETURN END IF #CHI-A50004 add ROLLBACK WORK
   END IF 

    IF NOT cl_null(g_oga.oga99) THEN
       CALL cl_err('','tri-013',1)
       ROLLBACK WORK #CHI-A50004 add
       RETURN
    END IF

 
  #CHI-A50004 程式搬移至FUNCTION一開始 mark --start--
  #BEGIN WORK
  #
  #OPEN t600_cl USING g_oga.oga01
  #IF STATUS THEN
  #   CALL cl_err("OPEN t600_cl:", STATUS, 1)
  #   CLOSE t600_cl
  #   ROLLBACK WORK
  #   RETURN
  #END IF
  #
  #FETCH t600_cl INTO g_oga.*          # 鎖住將被更改或取消的資料
  #IF SQLCA.sqlcode THEN
  #   CALL cl_err(g_oga.oga01,SQLCA.sqlcode,0)     # 資料被他人LOCK
  #   CLOSE t600_cl ROLLBACK WORK RETURN
  #END IF
  #CHI-A50004 程式搬移至FUNCTION一開始 mark --end--

   LET g_success = 'Y'
   CALL t600_z1()

  #No.FUN-A20022 ADD--------UPDATE almq618&almq770 ABOUT the oga95_point WHEN "undo_confirm"-----------------
   IF NOT cl_null(g_oga.oga87) THEN
     #MOD-B10154 Begin---
      SELECT SUM(ogb14t) INTO l_ogb14t FROM ogb_file
       WHERE ogb01=g_oga.oga01
         AND ogb1005='1'
      IF cl_null(l_ogb14t) THEN LET l_ogb14t=0  END IF
     #UPDATE lpj_file SET lpj07=lpj07-1,
     #                    lpj12=lpj12-g_oga.oga95
      UPDATE lpj_file SET lpj07=COALESCE(lpj07,0)-1,
                          lpj14=COALESCE(lpj14,0)-g_oga.oga95,
                          lpj15=COALESCE(lpj15,0)-l_ogb14t,
                          lpj12=COALESCE(lpj12,0)-g_oga.oga95
    #MOD-B10154 End-----
       WHERE lpj03=g_oga.oga87
      IF STATUS OR SQLCA.sqlerrd[3] = 0 THEN
         CALL cl_err3("upd","lpj_file",g_oga.oga87,"",SQLCA.sqlcode,"","upd lpj12",1)
         LET g_success = 'N'
         RETURN
      ELSE
         MESSAGE 'UPDATE lpj_file OK'
      END IF

      DELETE FROM lsm_file WHERE lsm01= g_oga.oga87 AND lsm02='7'           #7:Maintain Shipping Order:axmt620
                             AND lsm03= g_oga.oga01
      IF SQLCA.SQLERRD[3]=0 THEN
         CALL cl_err3("del","lsm_file",g_oga.oga87,"",SQLCA.sqlcode,"","no lsm delete",1)
         LET g_success = 'N'
         RETURN
      ELSE
         MESSAGE 'DELETE lsm_file OK'
      END IF
   END IF
  #No.FUN-A20022 END--------------------------------------------------------------------------------------


   CALL t600sub_chstatus('N',g_oga.*) RETURNING g_oga.*  #FUN-540042
   DISPLAY BY NAME g_oga.oga55
   CALL t600_chspic()
IF g_argv0 <> '8' THEN  #FUN-C50097(MOD-C60236并入)
  IF NOT cl_null(g_oga.oga011) THEN  #通知單號沒空白
     UPDATE oga_file SET oga011 = NULL WHERE oga01=g_oga.oga011
     IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] = 0 THEN
        CALL cl_err3("upd","oga_file",g_oga.oga011,"",SQLCA.SQLCODE,"","upd oga011",1)
        LET g_success='N'
     END IF
  END IF
END IF  #FUN-C50097(MOD-C60236并入)
   IF g_success = 'Y'
      THEN LET g_oga.ogaconf='N'
           IF g_oga.oga09 = '1' THEN
              LET g_oga.oga903 = 'N'
           END IF
           COMMIT WORK
           IF g_azw.azw04='2' THEN
              LET g_oga.ogaconu=''
              LET g_oga.ogacond=''
              LET g_oga.ogacont=''   #FUN-A30063 ADD
              DISPLAY BY NAME g_oga.ogaconu,g_oga.ogacond,g_oga.ogacont
           END IF
           DISPLAY BY NAME g_oga.ogaconf
           DISPLAY BY NAME g_oga.oga903
      ELSE LET g_oga.ogaconf='Y' ROLLBACK WORK
   END IF

   SELECT * INTO g_oga.* FROM oga_file WHERE oga01 = g_oga.oga01  #No.TQC-9A0161
   CALL t600_show()

    CALL t600_chspic()

END FUNCTION

FUNCTION t600_z1()

   UPDATE oga_file SET ogaconf = 'N',oga903 = 'N',ogaconu='',ogacond='',ogacont='' WHERE oga01 = g_oga.oga01  #FUN-A30063 #No.FUN-870007
   IF STATUS OR SQLCA.sqlerrd[3]=0 THEN
      CALL cl_err3("upd","oga_file",g_oga.oga01,"",SQLCA.sqlcode,"","upd oga",1)  #No.FUN-670008
      LET g_success = 'N'
   END IF
   IF g_oga.oga09 MATCHES '[15]' THEN
      UPDATE oga_file SET oga903 = 'N' WHERE oga01 = g_oga.oga01
      IF STATUS OR SQLCA.sqlerrd[3]=0 THEN
         CALL cl_err3("upd","oga_file",g_oga.oga01,"",SQLCA.sqlcode,"","upd oga",1)  #No.FUN-670008
         LET g_success = 'N'
      END IF
   END IF
   DECLARE t600_z1_c CURSOR FOR SELECT * FROM ogb_file WHERE ogb01=g_oga.oga01
   FOREACH t600_z1_c INTO b_ogb.*
      CALL t600sub_bu1(g_oga.*,b_ogb.*)   #No:TQC-8C0027
      IF g_success='N' THEN RETURN END IF
   END FOREACH
END FUNCTION

FUNCTION t600_z()  #CHI-8B0048 modify p_cmd #MOD-B30464 取消p_cmd
DEFINE l_ogb04   LIKE ogb_file.ogb04,
       l_ogb12   LIKE ogb_file.ogb12,
       l_ogb14   LIKE ogb_file.ogb14,
       l_ogb14t  LIKE ogb_file.ogb14t,
       l_ogb1004 LIKE ogb_file.ogb1004,
       l_tqz02   LIKE tqz_file.tqz02,
       l_tqy02   LIKE tqy_file.tqy02,
       l_sum005  LIKE tsa_file.tsa05,
       l_sum007  LIKE tsa_file.tsa07,
       l_sum034  LIKE tsa_file.tsa07,
       l_item    LIKE tqy_file.tqy35,
       l_i       LIKE type_file.num5,    #No.FUN-680137 SMALLINT
       l_j       LIKE type_file.num5,   #No.FUN-680137 SMALLINT
       l_cnt     LIKE type_file.num5,    #No.MOD-8B0023
      #p_cmd     LIKE type_file.chr1,   #CHI-8B0048 add #MOD-B30464 mark 
       li_result LIKE type_file.num5, #FUN-730012
       l_oea99   LIKE oea_file.oea99
   DEFINE  l_idd     RECORD LIKE idd_file.*    #No.MOD-8B0023
   DEFINE l_n1      LIKE type_file.num5   #FUN-C60033 #FUN-C60036 remark
   
   #FUN-C60033--add--str  #FUN-C60036 remark--str
   LET l_n1 = 0
   SELECT COUNT(*) INTO l_n1 FROM omf_file WHERE omf11=g_oga.oga01
   IF l_n1>0 THEN
      LET g_success = 'N'
      CALL cl_err('','axm-544',1)
      RETURN
   END IF
   #FUN-C60033--add--end #FUN-C60036 remark--end
   
    IF cl_null(g_oga.oga01) THEN RETURN END IF
    SELECT * INTO g_oga.* FROM oga_file WHERE oga01 = g_oga.oga01
    IF g_oga.ogapost='N' THEN CALL cl_err('','axm-206',0) RETURN END IF
#為代送銷退貨單產生的出貨單
    IF g_oga.oga1014='Y' THEN
       CALL cl_err('','atm-395',1)
       RETURN
    END IF

    LET l_cnt = 0
    SELECT COUNT(*) INTO l_cnt FROM oeb_file 
       WHERE oeb70 = 'Y' 
         AND oeb01||oeb03 IN 
             (SELECT ogb31||ogb32 FROM ogb_file WHERE ogb01 = g_oga.oga01)
    IF l_cnt > 0 THEN
       CALL cl_err('','axm-150',1)
       RETURN
    END IF
   
#No.FUN-A50071 --------start-----------
    #oga94 POS銷售否=Y時，不可過賬還原
#   IF g_oga.oga94 !='Y' THEN   #TQC-A50162  mark
    IF g_oga.oga94 ='Y' THEN    #TQC-A50162  add
       CALL cl_err('','axm-741',0)
       RETURN 
    END IF 
#No.FUN-A50071 ---------end----------

    IF g_oga.oga909 = 'Y' THEN
       CALL t600sub_chkpoz(g_oga.*,g_ogb[1].ogb31) RETURNING li_result,g_poz.*,l_oea99,g_flow  #NO.TQC-740089
       IF NOT li_result THEN RETURN END IF #FUN-730012

# 由參數控制是否執行自動拋轉還原
      CASE
          WHEN g_argv0 = '4'
              IF g_oax.oax07 = 'Y' THEN
                  CALL t600_check_poz19()
                  IF cl_null(g_errno) THEN
                     CALL t600_undo_muticarry()
                  ELSE                            #TQC-7C0146 add
                     CALL t600_oga99_z()          #TQC-7C0146 add
                  END IF
              ELSE
                  CALL cl_err('','axm1001',1)   #NO.TQC-740112
              END IF
          WHEN g_argv0 = '6'
              IF g_pod.pod05 = 'Y' THEN
                  CALL t600_check_poz19()
                  IF cl_null(g_errno) THEN
                     CALL t600_undo_muticarry()
                  ELSE                            #TQC-7C0146 add
                     CALL t600_oga99_z()          #TQC-7C0146 add
                  END IF
              ELSE
                  CALL cl_err('','axm1001',1)   #NO.TQC-740112
              END IF
      END CASE
      LET g_oga_o.oga99 =g_oga.oga99  #MOD-840067 add
      LET g_oga_o.oga905=g_oga.oga905 #MOD-840067 add
       SELECT * INTO g_oga.* FROM oga_file WHERE oga01 = g_oga.oga01
       #若拋轉還原未成功，則不可做扣帳還原
       CALL t600_chspic()

       IF g_oga.oga905='Y' THEN CALL cl_err('','tri-013',1) RETURN END IF
    END IF
    IF cl_null(g_bgjob) THEN LET g_bgjob = 'N' END IF 
   #LET g_msg="axmp650 '",g_oga.oga01,"' ' '  '",p_cmd,"' "  CLIPPED  #CHI-8B0048 modify #MOD-B30464 mark
    LET g_msg="axmp650 '",g_oga.oga01,"' '",g_bgjob,"'  "  CLIPPED  #MOD-B30464 
    CALL cl_cmdrun_wait(g_msg)

#-----MOD-AC0012---------
#移到過帳還原成功後才做
#&ifdef ICD
#   LET g_success ='Y'
#   IF g_argv0 = '2' THEN   #FUN-920207  #FUN-930038 這裡不處理 g_argv0 = 'A' 的刻號/BIN資料還原,因為資料已經拋到調撥單了
#      LET l_cnt = 0
#      SELECT COUNT(*) INTO l_cnt
#        FROM inb_file
#       WHERE inb11 = g_oga.oga01
#      IF l_cnt > 0 THEN
#         # --- 還原出通單的倉庫 ---
#         # --- 還原出通單的idd_file的倉庫 ---
#         CALL t600_ind_icd_upd_ogb09_res()
#         IF g_success = 'N' THEN
#            ROLLBACK WORK
#            RETURN
#         END IF
#      END IF
#
#      #-->還原新倉儲批刻號庫存明細的備置量
#      INITIALIZE l_idd.* TO NULL
#      DECLARE t600_sel_idc21_res2 CURSOR FOR
#         SELECT * FROM idd_file
#            WHERE idd10 = g_oga.oga01
#      FOREACH t600_sel_idc21_res2 INTO l_idd.*
#         LET l_cnt = 0
#         SELECT COUNT(*) INTO l_cnt FROM imaicd_file  #No.CHI-940010
#            WHERE imaicd00 = l_idd.idd01
#              AND imaicd04 IN ('0','1','2','4')
#              AND imaicd08 = 'Y'
#         IF l_cnt = 0 THEN
#            CONTINUE FOREACH
#         END IF
#
#         #更新idc21(已備置量)(扣除出貨數量)
#         UPDATE idc_file
#            SET idc21 = idc21 + l_idd.idd13
#          WHERE idc01 = l_idd.idd01  #料號
#            AND idc02 = l_idd.idd02  #倉庫
#            AND idc03 = l_idd.idd03  #儲位
#            AND idc04 = l_idd.idd04  #批號
#            AND idc05 = l_idd.idd05  #刻號
#            AND idc06 = l_idd.idd06  #BIN
#         IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] = 0 THEN
#            CALL cl_err('t600_upd idc210',SQLCA.SQLCODE,1)
#            LET g_success = 'N'
#            RETURN
#         END IF
#      END FOREACH
#
#      CALL t600sub_ind_icd_post(g_oga.oga01,'2')
#      IF g_success = 'N' THEN
#         ROLLBACK WORK
#         RETURN
#      END IF
#   END IF
#&endif
#-----END MOD-AC0012-----

   #axmp650執行失敗
    SELECT ogapost INTO g_oga.ogapost 
      FROM oga_file WHERE oga01=g_oga.oga01
    IF g_oga.ogapost = 'Y' THEN 
     UPDATE oga_file 
        SET oga99 =g_oga_o.oga99,
            oga905=g_oga_o.oga905
      WHERE oga01=g_oga.oga01
       IF STATUS OR SQLCA.SQLCODE THEN
          CALL cl_err(g_oga.oga01,SQLCA.SQLCODE,0)   
       END IF
       RETURN                                                                
    END IF
   #axmp650執行失敗

   UPDATE oga_file
      SET oga1013='N'  #扣賬還原時將[是否已打印提單]狀態改為N
        WHERE oga01=g_oga.oga01
   IF SQLCA.sqlcode THEN
      LET g_success='N'
      RETURN
   END IF

    SELECT ogapost,oga99,oga905 INTO g_oga.ogapost,g_oga.oga99,g_oga.oga905
      FROM oga_file WHERE oga01=g_oga.oga01
    DISPLAY BY NAME g_oga.ogapost,g_oga.oga99,g_oga.oga905

   SELECT oga1012,oga1014 INTO g_oga.oga1012,g_oga.oga1014
     FROM oga_file
   WHERE oga01=g_oga.oga01
   DISPLAY BY NAME g_oga.oga1012
   DISPLAY BY NAME g_oga.oga1014

    CALL t600_chspic()
    CALL t600_tqw081_update('2')

    IF SQLCA.sqlcode THEN
       LET g_success='N'
       RETURN
    END IF
END FUNCTION

#檢查最終站
FUNCTION t600_last()
   DEFINE l_last        LIKE poy_file.poy02
   DEFINE l_last_plant  LIKE poy_file.poy04
   DEFINE l_poz18       LIKE poz_file.poz18   #No:FUN-670007
   DEFINE l_poz19       LIKE poz_file.poz19   #No:FUN-670007
   DEFINE l_break       LIKE poy_file.poy02   #No:FUN-670007
   DEFINE l_now         LIKE poy_file.poy02   #No:FUN-670007
   DEFINE l_err         LIKE type_file.chr1   #No:FUN-670007

   LET l_err = "0"   #No:FUN-670007

   SELECT MAX(poy02) INTO l_last FROM poy_file
    WHERE poy01 = g_flow
      AND poy02 != 99                #MOD-830220-add
     
   IF STATUS THEN
      CALL cl_err3("sel","poy_file",g_flow,"","axm-318","","",1)  #No.FUN-670008
      RETURN ''
   END IF
   SELECT poy04 INTO l_last_plant FROM poy_file
    WHERE poy01 = g_flow AND poy02 = l_last

   IF cl_null(l_last_plant) THEN
      LET l_err ="1"
      CALL cl_err('','axm-318',1)
   END IF

   SELECT poz18,poz19 INTO l_poz18,l_poz19 FROM poz_file
    WHERE poz01 = g_flow
   IF l_poz19 = "Y" THEN
      SELECT poy02 INTO l_break FROM poy_file
       WHERE poy04 = l_poz18
         AND poy01 = g_flow #MOD-B20147 add

      SELECT poy02 INTO l_now FROM poy_file
       WHERE poy04 = g_plant
         AND poy01 = g_flow #MOD-B20147 add

     #IF l_last_plant != l_now THEN #MOD-B20070 mark
        #IF l_now > l_break THEN #MOD-B20147 mark
         IF l_now > l_break AND l_now < l_last THEN #MOD-B20147 add
            LET l_err ="1"
            CALL cl_err(g_plant,'axm-410',1)
         ELSE
            LET g_oga.oga906 ='Y'
         END IF
     #END IF #MOD-B20070 mark
   ELSE
      IF l_last_plant != g_plant THEN
         LET l_err ="1"
         CALL cl_err(g_plant,'axm-410',1)
      END IF
   END IF

   RETURN l_err

END FUNCTION

FUNCTION t600_undo_muticarry()
      IF g_oga.oga905 = 'N' THEN RETURN END IF
      IF g_poz.poz011='1' THEN   #正拋
         LET g_msg="axmp830 '",g_oga.oga01,"'"
      ELSE                       #逆拋
         LET g_msg="axmp901 '",g_oga.oga01,"' '",g_argv0,"'"
      END IF
      CALL cl_cmdrun_wait(g_msg CLIPPED)
      SELECT ogapost,oga99,oga905 INTO g_oga.ogapost,g_oga.oga99,g_oga.oga905
        FROM oga_file WHERE oga01=g_oga.oga01
      DISPLAY BY NAME g_oga.ogapost,g_oga.oga99,g_oga.oga905
END FUNCTION

#新增加出通單拋轉/拋轉還原----
FUNCTION t600_t_muticarry(p_argv0)
DEFINE p_argv0  LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)
DEFINE  l_oea904  LIKE oea_file.oea904  
DEFINE  l_poz00   LIKE poz_file.poz00   
DEFINE  l_ogb31   LIKE ogb_file.ogb31    #MOD-870278

  IF g_argv0 <> '5' OR g_oax.oax07 <> 'Y' OR g_oga.oga909 <> 'Y' THEN  
     RETURN
  END IF
   IF NOT cl_null(g_oga.oga16) THEN  #MOD-870278 add
      #讀取三角貿易流程代碼資料
        SELECT oea904 INTO l_oea904 
          FROM oea_file
         WHERE oea01 = g_oga.oga16
       ELSE 
        DECLARE t600_g_ogb2 CURSOR FOR SELECT ogb31 FROM ogb_file
                                  WHERE ogb01 = g_oga.oga01

        FOREACH t600_g_ogb2 INTO  l_ogb31
           SELECT oea904 INTO l_oea904 
             FROM oea_file
            WHERE oea01 = l_ogb31
             EXIT FOREACH
        END FOREACH
      END IF
        IF NOT cl_null(l_oea904) THEN
            SELECT poz00 INTO l_poz00    #先得到流程為銷售或代採參數  #MOD-870278 
              FROM poz_file
             WHERE poz01=l_oea904
            IF l_poz00 = '1' THEN 
                LET p_argv0 = '4'   #銷售
            ELSE
                LET p_argv0 = '6'   #代採
            END IF 
            CALL t600_check_poz19()
            IF NOT cl_null(g_errno) THEN
               RETURN
            END IF 
        END IF
      IF g_poz.poz011='1' THEN   #正拋
         LET g_msg="axmp821 '",g_oga.oga01,"'"
      ELSE                       #逆拋
         LET g_msg="axmp910 '",g_oga.oga01,"' '",p_argv0,"'"
      END IF
      CALL cl_cmdrun_wait(g_msg CLIPPED)
      SELECT oga99,oga905 INTO g_oga.oga99,g_oga.oga905  FROM oga_file
       WHERE oga01 = g_oga.oga01
      DISPLAY BY NAME g_oga.oga99
      DISPLAY BY NAME g_oga.oga905
END FUNCTION

FUNCTION t600_t_undo_muticarry(p_argv0)
DEFINE p_argv0 LIKE type_file.chr1    #No.FUN-680137  VARCHAR(1)
      IF g_oga.oga905 = 'N' THEN RETURN END IF
      IF g_poz.poz011='1' THEN   #正拋
         LET g_msg="axmp831 '",g_oga.oga01,"'"
      ELSE                       #逆拋
         LET g_msg="axmp911 '",g_oga.oga01,"' '",p_argv0,"'"
      END IF
      CALL cl_cmdrun_wait(g_msg CLIPPED)
      SELECT oga99,oga905 INTO g_oga.oga99,g_oga.oga905  FROM oga_file
       WHERE oga01 = g_oga.oga01
      DISPLAY BY NAME g_oga.oga99
      DISPLAY BY NAME g_oga.oga905
END FUNCTION

#新增作廢/作廢還原功能 01/08/20 mandy
FUNCTION t600_x()
DEFINE l_ogaconf_o LIKE oga_file.ogaconf

    IF s_shut(0) THEN RETURN END IF
    SELECT * INTO g_oga.* FROM oga_file WHERE oga01=g_oga.oga01
    IF g_oga.oga01 IS NULL THEN CALL cl_err('',-400,0) RETURN END IF
    IF g_oga.ogaconf = 'Y' THEN CALL cl_err('',9023,0) RETURN END IF
    IF g_oga.oga55 MATCHES '[Ss1]' THEN   #FUN-550050
       CALL cl_err('','mfg3557',0)
       RETURN
    END IF

    BEGIN WORK

    OPEN t600_cl USING g_oga.oga01
    IF STATUS THEN
       CALL cl_err("OPEN t600_cl:", STATUS, 1)
       CLOSE t600_cl
       ROLLBACK WORK
       RETURN
    END IF

    FETCH t600_cl INTO g_oga.*          # 鎖住將被更改或取消的資料
    IF SQLCA.sqlcode THEN
        CALL cl_err(g_oga.oga01,SQLCA.sqlcode,0)     # 資料被他人LOCK
        CLOSE t600_cl ROLLBACK WORK RETURN
    END IF

    LET l_ogaconf_o=g_oga.ogaconf

    LET g_success='Y'
    IF cl_void(0,0,g_oga.ogaconf) THEN
       LET g_chr = g_oga.ogaconf
       IF g_oga.ogaconf = 'N' THEN
          LET g_oga.ogaconf = 'X'
           IF NOT cl_null(g_oga.oga011) THEN  #通知單號沒空白
              UPDATE oga_file SET oga011 = NULL WHERE oga01=g_oga.oga011
              IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] = 0 THEN
                  CALL cl_err3("upd","oga_file",g_oga.oga011,"",SQLCA.sqlcode,"","upd oga011:",1)  #No.FUN-670008
                  LET g_success='N'
              END IF
           END IF
       ELSE
          CALL t620_x_check()              
          IF g_check = 'N' THEN 
             LET g_check = 'Y'
             RETURN 
          END IF    	
          IF NOT cl_null(g_oga.oga011) AND g_argv0 MATCHES '[246]' THEN
             SELECT * FROM oga_file
              WHERE oga01=g_oga.oga011
                AND ogaconf='Y'
             IF SQLCA.SQLCODE THEN
               #"出貨通知單"已作廢或未確認,請將"出貨通知單"取消作廢及確認!
                CALL cl_err3("sel","oga_file",g_oga.oga011,"","axm-020","","",1)  #No.FUN-670008
                RETURN
             ELSE
                UPDATE oga_file SET oga011 = g_oga.oga01 WHERE oga01=g_oga.oga011
                IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] = 0 THEN
                    CALL cl_err3("upd","oga_file",g_oga.oga011,"",SQLCA.sqlcode,"","upd oga011:",1)  #No.FUN-670008
                    LET g_success='N'
                END IF
             END IF
          END IF
         #"訂單"已作廢或未確認,請將"訂單"取消作廢及確認!
          IF NOT cl_null(g_oga.oga16) THEN
             SELECT * FROM oea_file
              WHERE oea01   = g_oga.oga16
                AND oeaconf = 'Y'
             IF STATUS THEN
                CALL cl_err3("sel","oea_file",g_oga.oga16,"","axm-018","","",1)  #No.FUN-670008
                RETURN
             END IF
          END IF
            LET g_cnt=0
            SELECT COUNT(*) INTO g_cnt FROM oeb_file,ogb_file
             WHERE ogb01=g_oga.oga01
               AND ogb31=oeb01
               AND ogb32=oeb03
               AND oeb70='Y'
            IF g_cnt > 0 THEN
               CALL cl_err('','axm-960',0)
               RETURN
            END IF
          IF NOT cl_null(g_oga.oga27) THEN
             #資料來源之INVOICE已作廢或未確認,請將"INVOICE"取消作廢及確認!
             SELECT * INTO g_ofa.* FROM ofa_file
              WHERE ofa01 = g_oga.oga27
             IF g_ofa.ofaconf != 'Y' THEN
                CALL cl_err(g_oga.oga27,'axm-014',0)
                RETURN
             END IF
          END IF

          LET g_oga.ogaconf = 'N'
       END IF
      #-MOD-A90032-add-
       DELETE FROM npp_file
        WHERE nppsys = 'AR'
          AND npp00 = 1
          AND npp01 = g_oga.oga01
          AND npp011 = 1

       DELETE FROM npq_file
        WHERE npqsys = 'AR'
          AND npq00 = 1
          AND npq01 = g_oga.oga01
          AND npq011 = 1

      DELETE FROM tic_file WHERE tic04 = g_oga.oga01 #FUN-B40056

      #-MOD-A90032-end-
   ELSE        #MOD-750066 add
      RETURN   #MOD-750066 add
   END IF
   LET g_oga.ogamodu = g_user
   LET g_oga.ogadate = g_today
   UPDATE oga_file SET ogaconf = g_oga.ogaconf,
                       ogamodu = g_user,
                       ogadate = g_today
    WHERE oga01 = g_oga.oga01

   IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] = 0 THEN
      CALL cl_err3("upd","oga_file",g_oga.oga01,"",SQLCA.sqlcode,"","upd ogaconf",1)  #No.FUN-670008
      LET g_oga.ogaconf = g_chr
      LET g_success='N'
   END IF
   IF l_ogaconf_o<>'X' THEN
      CALL t600sub_chstatus('X',g_oga.*) RETURNING g_oga.*  #FUN-540042
   ELSE
      CALL t600sub_chstatus('N',g_oga.*) RETURNING g_oga.*  #FUN-540042
   END IF
   DISPLAY BY NAME g_oga.oga55
   CALL t600_chspic()


   IF g_success='Y' THEN
      COMMIT WORK

      CALL cl_flow_notify(g_oga.oga01,'V')
   ELSE
      ROLLBACK WORK
   END IF

   SELECT ogaconf INTO g_oga.ogaconf
     FROM oga_file
    WHERE oga01 = g_oga.oga01
   DISPLAY BY NAME g_oga.ogaconf,g_oga.ogamodu,g_oga.ogadate

END FUNCTION

FUNCTION t620_x_check()
#-----MOD-A20069---------
#DEFINE l_chr       LIKE type_file.chr1  
#DEFINE l_cnt       LIKE type_file.num5 
#DEFINE l_count     LIKE type_file.num5 
#DEFINE l_oeb01     LIKE oeb_file.oeb01
#DEFINE l_oeb03     LIKE oeb_file.oeb03
#-----END MOD-A20069-----
DEFINE l_oeb04     LIKE oeb_file.oeb04
DEFINE l_oeb05     LIKE oeb_file.oeb05
DEFINE l_oeb12     LIKE oeb_file.oeb12
DEFINE l_ogb31     LIKE ogb_file.ogb31
DEFINE l_ogb32     LIKE ogb_file.ogb32
DEFINE l_ogb04     LIKE ogb_file.ogb04
DEFINE l_ogb05     LIKE ogb_file.ogb05
DEFINE l_ogb12     LIKE ogb_file.ogb12
DEFINE l_ogb12_1   LIKE ogb_file.ogb12
DEFINE l_ogb03     LIKE ogb_file.ogb03   #MOD-A20069
#DEFINE l_sql       STRING   #MOD-A20069
                               
#-----MOD-A20069---------
#  DECLARE check_c1 CURSOR FOR SELECT oeb01,oeb03,oeb04,oeb05 FROM oea_file,oeb_file 
#                               WHERE oeb01 = g_oga.oga16
#                                 AND oea01 = oeb01
#                                 AND oeaconf = 'Y'
#                               ORDER BY oeb03 
#  LET l_sql = "SELECT ogb31,ogb32,ogb04,ogb05 FROM ogb_file",
#              " WHERE ogb01 = '",g_oga.oga01,"'",
#              "   AND ogb31 = '",g_oga.oga16,"'",
#              "   AND ogb32 = ?",
#              "  ORDER BY ogb32"
#  PREPARE check_prepare FROM l_sql
#  DECLARE check_c2 CURSOR FOR check_prepare 
#                
#  LET l_chr = 'Y'  
#  FOREACH check_c1 INTO l_oeb01,l_oeb03,l_oeb04,l_oeb05
#     IF STATUS THEN 
#        LET g_check = 'N'
#        EXIT FOREACH 
#     END IF      
#     FOREACH check_c2 USING l_oeb03 INTO l_ogb31,l_ogb32,l_ogb04,l_ogb05
#        IF STATUS THEN 
#           LET g_check = 'N'
#           EXIT FOREACH 
#        END IF    
#        IF (l_oeb01 != l_ogb31) OR (l_oeb03 != l_ogb32) OR 
#           (l_oeb04 != l_ogb04) OR (l_oeb05 != l_ogb05) THEN 
#           CALL cl_err('','axm-204',1)
#           LET l_chr = 'N'
#           LET g_check = 'N'
#           EXIT FOREACH  
#        ELSE
#        	 CONTINUE FOREACH    
#        END IF  
#     END FOREACH
############################
#    IF g_check = 'Y' THEN 
#       SELECT SUM(oeb12) INTO l_oeb12 FROM oea_file,oeb_file 
#        WHERE oeb01 = g_oga.oga16 
#          AND oea01 = oeb01
#          AND oeb03 = l_oeb03
#          AND oeaconf = 'Y'
#       SELECT SUM(ogb12) INTO l_ogb12 FROM oga_file,ogb_file
#        WHERE oga01 = ogb01 
#          AND ogaconf = 'Y'
#          AND oga01 <> g_oga.oga01 	
#          AND oga09 = g_argv0		
#          AND ogb32 = l_oeb03
#          AND ogb31 = l_oeb01
#       SELECT SUM(ogb12) INTO l_ogb12_1 FROM oga_file,ogb_file
#        WHERE oga01 = ogb01
#          AND oga01 = g_oga.oga01 
#          AND oga09 = g_argv0		
#          AND ogb32 = l_oeb03
#          AND ogb31 = l_oeb01
#       IF cl_null(l_oeb12) THEN LET l_oeb12 = 0 END IF 
#       IF cl_null(l_ogb12) THEN LET l_ogb12 = 0 END IF   
#       IF cl_null(l_ogb12_1) THEN LET l_ogb12_1 = 0 END IF                
#       LET l_ogb12 = l_ogb12 + l_ogb12_1       
#       IF l_oeb12 != l_ogb12 THEN 
#          CALL cl_err('','axm-242',1)
#          LET g_check = 'N'
#       END IF  
#    END IF 
###########################    
#     IF l_chr = 'N' THEN CONTINUE FOREACH END IF 
#     IF g_check = 'N' THEN 
#        EXIT FOREACH 
#     END IF     
#  END FOREACH   

   DECLARE check_c1 CURSOR FOR 
     SELECT ogb03,ogb31,ogb32,ogb04,ogb05 FROM ogb_file WHERE ogb01=g_oga.oga01
   FOREACH check_c1 INTO l_ogb03,l_ogb31,l_ogb32,l_ogb04,l_ogb05
     LET l_oeb04=''
     LET l_oeb05=''
     SELECT oeb04,oeb05 INTO l_oeb04,l_oeb05 FROM oeb_file
       WHERE oeb01 = l_ogb31
         AND oeb03 = l_ogb32
     IF l_oeb04 <> l_ogb04 OR l_oeb05<> l_ogb05 THEN
        CALL cl_err(l_ogb03,'axm-204',1)
        LET g_check = 'N'
        EXIT FOREACH 
     END IF
     SELECT oeb12 INTO l_oeb12 FROM oea_file,oeb_file 
      WHERE oeb01 = l_ogb31 
        AND oeb03 = l_ogb32
        AND oea01 = oeb01
        AND oeaconf = 'Y'
     SELECT SUM(ogb12) INTO l_ogb12 FROM oga_file,ogb_file
      WHERE oga01 = ogb01 
        AND ogaconf = 'Y'
        AND oga09 = g_argv0	
        AND ogb31 = l_ogb31
        AND ogb32 = l_ogb32
     SELECT SUM(ogb12) INTO l_ogb12_1 FROM oga_file,ogb_file
      WHERE oga01 = ogb01
        AND oga01 = g_oga.oga01 
        AND oga09 = g_argv0 
        AND ogb03 = l_ogb03
     IF cl_null(l_oeb12) THEN LET l_oeb12 = 0 END IF 
     IF cl_null(l_ogb12) THEN LET l_ogb12 = 0 END IF   
     IF cl_null(l_ogb12_1) THEN LET l_ogb12_1 = 0 END IF                
     LET l_ogb12 = l_ogb12 + l_ogb12_1       
     IF l_oeb12 < l_ogb12 THEN 
        CALL cl_err(l_ogb03,'axm-294',1)
        LET g_check = 'N'
        EXIT FOREACH
     END IF  
   END FOREACH
#-----END MOD-A20069-----
END FUNCTION 
#MOD-990097 --end--

FUNCTION t600_d()
   DEFINE l_rec_b   LIKE type_file.num5    #No.FUN-680137 SMALLINT
   DEFINE l_sum_ogb14   LIKE ogb_file.ogb14        #No:MOD-720094 add
   DEFINE l_ogb31       LIKE ogb_file.ogb31        #No:MOD-720094 add
   DEFINE d_ogb     DYNAMIC ARRAY OF RECORD
                    ogb03     LIKE ogb_file.ogb03,
                    ogb31     LIKE ogb_file.ogb31,
                    ogb32     LIKE ogb_file.ogb32,
                    ogb04     LIKE ogb_file.ogb04,
                    ogb06     LIKE ogb_file.ogb06,
                    ogb05     LIKE ogb_file.ogb05,
                    ogb12     LIKE ogb_file.ogb12,
                    ogb913    LIKE ogb_file.ogb913,
                    ogb914    LIKE ogb_file.ogb911,
                    ogb915    LIKE ogb_file.ogb915,
                    ogb910    LIKE ogb_file.ogb910,
                    ogb911    LIKE ogb_file.ogb911,
                    ogb912    LIKE ogb_file.ogb912,
                    ogb916    LIKE ogb_file.ogb916,
                    ogb917    LIKE ogb_file.ogb917,
                    ogb37_1   LIKE ogb_file.ogb37,   #FUN-B10010
                    ogb13_1   LIKE ogb_file.ogb13,   #MOD-930322 
                    ogb14_1   LIKE ogb_file.ogb14,   #MOD-930322
                    ogb14t_1  LIKE ogb_file.ogb14t   #MOD-930322
                    END RECORD
   DEFINE d_ogb_t   RECORD
                    ogb03     LIKE ogb_file.ogb03,
                    ogb31     LIKE ogb_file.ogb31,
                    ogb32     LIKE ogb_file.ogb32,
                    ogb04     LIKE ogb_file.ogb04,
                    ogb06     LIKE ogb_file.ogb06,
                    ogb05     LIKE ogb_file.ogb05,
                    ogb12     LIKE ogb_file.ogb12,
                    ogb913    LIKE ogb_file.ogb913,
                    ogb914    LIKE ogb_file.ogb911,
                    ogb915    LIKE ogb_file.ogb915,
                    ogb910    LIKE ogb_file.ogb910,
                    ogb911    LIKE ogb_file.ogb911,
                    ogb912    LIKE ogb_file.ogb912,
                    ogb916    LIKE ogb_file.ogb916,
                    ogb917    LIKE ogb_file.ogb917,
                    ogb37_1   LIKE ogb_file.ogb37,   #FUN-B10010
                    ogb13_1   LIKE ogb_file.ogb13,   #MOD-930322 
                    ogb14_1   LIKE ogb_file.ogb14,   #MOD-930322
                    ogb14t_1  LIKE ogb_file.ogb14t   #MOD-930322
                    END RECORD,
    i               LIKE type_file.num5,    #No.FUN-680137 SMALLINT
    l_n             LIKE type_file.num5,    #TQC-7C0030    SMALLINT
    l_allow_insert  LIKE type_file.num5,                #可新增否  #No.FUN-680137 SMALLINT
    l_allow_delete  LIKE type_file.num5,                #可刪除否  #No.FUN-680137 SMALLINT
    l_cnt           LIKE type_file.num5,  #MOD-940336
    l_cnt2          LIKE type_file.num5   #MOD-AB0152
DEFINE l_occ930 LIKE occ_file.occ930   #No.FUN-870007
DEFINE lc_type LIKE type_file.chr1     #No.FUN-870007
DEFINE l_rtg01 LIKE rtg_file.rtg01     #No.FUN-870007
DEFINE l_rth06 LIKE rth_file.rth06     #No.FUN-870007
DEFINE l_rtg07 LIKE rtg_file.rtg07     #No.FUN-870007
DEFINE l_rtg08 LIKE rtg_file.rtg08     #No.FUN-870007
DEFINE l_rtz05 LIKE rtz_file.rtz05     #No.FUN-870007
DEFINE l_rxc   RECORD LIKE rxc_file.*  #FUN-AC0012

   BEGIN WORK
   LET g_success = 'Y' #对g_success赋初值 FUN-C50097(併入處理MOD-C60032)
   OPEN t600_cl USING g_oga.oga01
   IF STATUS THEN
      CALL cl_err("OPEN t600_cl:", STATUS, 1)
      CLOSE t600_cl
      ROLLBACK WORK
      RETURN
   END IF

   FETCH t600_cl INTO g_oga.*          # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
       CALL cl_err(g_oga.oga01,SQLCA.sqlcode,0)     # 資料被他人LOCK
       CLOSE t600_cl 
       ROLLBACK WORK 
       RETURN
   END IF
   
   
   IF g_oga.oga55 matches '[Ss]' THEN       #送簽中不可更改單價
      CALL cl_err('','apm-030',0)
      CLOSE t600_cl   #MOD-920323
      ROLLBACK WORK   #MOD-920323
      RETURN
   END IF


   LET p_row = 4 LET p_col = 2


   OPEN WINDOW t600p_w AT p_row,p_col WITH FORM "axm/42f/axmt600p"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN

    CALL cl_ui_locale("axmt600p")

    CALL cl_set_comp_visible("ogb911,ogb914",FALSE)  
    IF g_sma.sma115 = 'Y' THEN
       CALL cl_set_comp_visible("ogb05,ogb12",FALSE)
    ELSE
       CALL cl_set_comp_visible("ogb913,ogb914,ogb915",FALSE)
       CALL cl_set_comp_visible("ogb910,ogb911,ogb912",FALSE)
    END IF
    IF g_sma.sma116 MATCHES '[01]' THEN
       CALL cl_set_comp_visible("ogb916,ogb917",FALSE)
    END IF

   DISPLAY g_oga.oga50 TO FORMONLY.oga50_1  #FUN-8C0127
   DECLARE t600_d_c CURSOR FOR
      SELECT ogb03,ogb31,ogb32,ogb04,ogb06||'/'||ima021,ogb05,ogb12,
             ogb913,ogb914,ogb915,ogb910,ogb911,ogb912,ogb916,ogb917,
             ogb37,ogb13,ogb14,ogb14t           #FUN-B10010
        FROM ogb_file,ima_file
       WHERE ogb01=g_oga.oga01
        AND ima01=ogb04 #xiaoyx
         AND ogb1005 ='1'
         AND (ogb1012 ='N' OR ogb1012 IS NULL) #FUN-710016(因為非DIS的,此欄位會是NULL)

   CALL d_ogb.clear()

   LET i=1
   LET l_rec_b = 0
   FOREACH t600_d_c INTO d_ogb[i].*
     LET i=i+1
   END FOREACH
   CALL d_ogb.deleteElement(i)
   LET l_rec_b = i-1
   #出通單若已出貨並立帳,僅提供單價查詢
   IF g_argv0='1' THEN 
      LET l_cnt = 0
      SELECT COUNT(*) INTO l_cnt FROM oga_file,ogb_file
        WHERE oga01 = ogb01 
          AND oga01 = g_oga.oga01
          AND ogb31||ogb32 IN
              (SELECT ogb31||ogb32 FROM oga_file,ogb_file
                WHERE oga01=ogb01 AND oga09='2' 
                  AND (oga10 IS NOT NULL
                       OR oga01 IN (SELECT oga011 FROM oga_file    #MOD-AB0152
                                     WHERE oga09='8' AND oga10 IS NOT NULL)))   #MOD-AB0152
   END IF

   #-----MOD-AB0152---------
   LET l_cnt2 = 0 
   SELECT COUNT(*) INTO l_cnt2 FROM oga_file
     WHERE oga011 = g_oga.oga01
       AND oga09 = '8'
       AND oga10 IS NOT NULL 
   #-----END MOD-AB0152-----

   #多角出貨(通)單僅提供單價查詢
   #IF NOT cl_null(g_oga.oga10) OR g_argv0 MATCHES '[456]' OR   #MOD-AB0152
   IF NOT cl_null(g_oga.oga10) OR l_cnt2 > 0 OR g_argv0 MATCHES '[456]' OR   #MOD-AB0152
      g_oga.ogaconf <> 'N' OR  #No.FUN-870007
      (g_argv0='1' AND l_cnt > 0) THEN    

     #DISPLAY ARRAY d_ogb TO s_ogb.* ATTRIBUTE(COUNT=l_rec_b,UNBUFFERED)                                #MOD-B30485 mark
      DISPLAY ARRAY d_ogb TO s_ogb.* ATTRIBUTE(COUNT=l_rec_b,accept = FALSE,cancel = FALSE,UNBUFFERED)  #MOD-B30485 add
         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE DISPLAY
#MOD-B30485----mark-----str--------------
#MOD-B10204 --begin--
#        ON ACTION accept 
#           CALL cl_err('','axm-561',0)
#           CONTINUE DISPLAY
#MOD-B10204 --end--
#MOD-B30485---mark----end----------------

      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121

      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121

      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121

         ON ACTION exit
            EXIT DISPLAY
      END DISPLAY
      IF INT_FLAG THEN LET INT_FLAG=0 END IF    #MOD-A20021
      CLOSE WINDOW t600p_w
      CLOSE t600_cl   #MOD-920323
      ROLLBACK WORK   #MOD-920323
      RETURN
   END IF

   LET l_ac = 1
   INPUT ARRAY d_ogb WITHOUT DEFAULTS FROM s_ogb.*
         ATTRIBUTE(COUNT=l_rec_b,MAXCOUNT=g_max_rec,UNBUFFERED,
                   INSERT ROW=FALSE,DELETE ROW=FALSE,APPEND ROW=FALSE)

      BEFORE INPUT
          IF l_rec_b != 0 THEN
             CALL fgl_set_arr_curr(l_ac)
          END IF

      BEFORE ROW
         LET l_ac = ARR_CURR()
         LET d_ogb_t.* = d_ogb[l_ac].*  #BACKUP
        CALL cl_show_fld_cont()     #FUN-550037(smin)


      AFTER FIELD ogb13_1   #MOD-930322
         IF NOT cl_null(d_ogb[l_ac].ogb13_1) THEN   #MOD-930322
            IF d_ogb[l_ac].ogb13_1 < 0 THEN   #MOD-930322
               CALL cl_err(d_ogb[l_ac].ogb13_1,'aom-557',0)   #MOD-930322
               NEXT FIELD ogb13_1   #MOD-930322
            END IF
          IF g_azw.azw04='2' THEN
            SELECT rtz05 INTO l_rtg01 FROM rtz_file 
             WHERE rtz01 = g_plant
            IF NOT cl_null(l_rtg01) THEN               #TQC-B20053
               SELECT rtg07,rtg08 INTO l_rtg07,l_rtg08 FROM rtg_file,rtf_file
                WHERE rtg01=rtf01 AND rtfconf='Y'
                  AND rtg01 = l_rtg01
                  AND rtg03=d_ogb[l_ac].ogb04 AND rtg04=d_ogb[l_ac].ogb05
              IF SQLCA.sqlcode=100 THEN  
                 CALL cl_err('','art-273',0) 
                 NEXT FIELD ogb13_1
              END IF
              IF l_rtg08='Y' THEN 
                 SELECT rth06 INTO l_rth06 FROM rth_file
                  WHERE rth01=d_ogb[l_ac].ogb04                                          
                    AND rth02=d_ogb[l_ac].ogb05 
                 #  AND rthplant=g_oea.oeaplant  #TQC-AC0140 mark
                    AND rthplant=g_plant         #TQC-AC0140 add
                IF SQLCA.sqlcode=100 THEN                                                                                    
                   CALL cl_err('','art-273',0) 
                   NEXT FIELD ogb13_1
                END IF                                                                  
                IF d_ogb[l_ac].ogb13_1<l_rth06 THEN              
                   CALL cl_err('','art-300',0)                                                                            
                   NEXT FIELD ogb13_1                                                            
                END IF                                                                 
              ELSE                                                                          
                IF d_ogb[l_ac].ogb13_1<l_rtg07 THEN
                   CALL cl_err('','art-268',0)
                   NEXT FIELD ogb13_1
                END IF
              END IF
            END IF                                     #TQC-B20053
        END IF
            # 用計價數量計算
           IF cl_null(d_ogb[l_ac].ogb916) THEN   
               LET d_ogb[l_ac].ogb916=d_ogb[l_ac].ogb05
               LET d_ogb[l_ac].ogb917=d_ogb[l_ac].ogb12
            END IF
            CALL cl_digcut(d_ogb[l_ac].ogb13_1,t_azi03) RETURNING d_ogb[l_ac].ogb13_1   #MOD-930322
            DISPLAY BY NAME d_ogb[l_ac].ogb13_1   #MOD-930322
            IF g_oga.oga213 = 'N' THEN
               LET d_ogb[l_ac].ogb14_1 =d_ogb[l_ac].ogb917*d_ogb[l_ac].ogb13_1   #MOD-930322
               CALL cl_digcut(d_ogb[l_ac].ogb14_1,t_azi04) RETURNING d_ogb[l_ac].ogb14_1      #CHI-7A0036-add   #MOD-930322
               LET d_ogb[l_ac].ogb14t_1=d_ogb[l_ac].ogb14_1*(1+g_oga.oga211/100)   #MOD-930322
               CALL cl_digcut(d_ogb[l_ac].ogb14t_1,t_azi04)RETURNING d_ogb[l_ac].ogb14t_1     #CHI-7A0036-add   #MOD-930322
            ELSE
               LET d_ogb[l_ac].ogb14t_1=d_ogb[l_ac].ogb917*d_ogb[l_ac].ogb13_1   #MOD-930322
               CALL cl_digcut(d_ogb[l_ac].ogb14t_1,t_azi04)RETURNING d_ogb[l_ac].ogb14t_1     #CHI-7A0036-add   #MOD-930322
               LET d_ogb[l_ac].ogb14_1 =d_ogb[l_ac].ogb14t_1/(1+g_oga.oga211/100)   #MOD-930322
               CALL cl_digcut(d_ogb[l_ac].ogb14_1,t_azi04) RETURNING d_ogb[l_ac].ogb14_1      #CHI-7A0036-add   #MOD-930322
            END IF

            DISPLAY BY NAME  d_ogb[l_ac].ogb14t_1,d_ogb[l_ac].ogb14_1   #MOD-880039   #MOD-930322

         END IF  #No.TQC-6B0117

      ON ROW CHANGE
          IF INT_FLAG THEN
             CALL cl_err('',9001,0)
             LET INT_FLAG = 0
             LET d_ogb[l_ac].* = d_ogb_t.*
             ROLLBACK WORK
             EXIT INPUT
          END IF
          LET g_success = 'Y'    #MOD-B70090 add by suncx
         #FUN-AC0012 Begin---
         IF g_azw.azw04='2' THEN #FUN-B10014
          #LET g_success = 'Y'  #MOD-B70090 mark
          IF d_ogb[l_ac].ogb13_1 != d_ogb_t.ogb13_1 THEN
             INITIALIZE l_rxc.* TO NULL
             LET l_rxc.rxc06 = (d_ogb_t.ogb13_1 - d_ogb[l_ac].ogb13_1)*d_ogb[l_ac].ogb12
             LET g_cnt = 0
             SELECT COUNT(*) INTO g_cnt FROM rxc_file
              WHERE rxc00 = '02'
                AND rxc01 = g_oga.oga01
                AND rxc02 = d_ogb[l_ac].ogb03
                AND rxc03 = '13'
                AND rxc04 = ' '
             IF g_cnt = 0 THEN
                LET l_rxc.rxc00 = '02'
                LET l_rxc.rxc01 = g_oga.oga01
                LET l_rxc.rxc02 = d_ogb[l_ac].ogb03
                LET l_rxc.rxc03 = '13'
                LET l_rxc.rxc04 = ' '
                LET l_rxc.rxc05 = ' '
                LET l_rxc.rxc09 = 0
                IF NOT cl_null(g_oga.oga87) THEN
                   LET g_cnt = 0
                   SELECT COUNT(*) INTO g_cnt FROM lpj_file,lpk_file 
                    WHERE lpj01=lpk01 
                      AND lpj03=g_oga.oga87
                   IF g_cnt > 0 THEN
                      LET l_rxc.rxc11 = 'Y'
                   ELSE
                      LET l_rxc.rxc11 = 'N'
                   END IF
                ELSE
                   LET l_rxc.rxc11 = 'N'
                END IF
                LET l_rxc.rxc15 = d_ogb[l_ac].ogb12
                LET l_rxc.rxcplant = g_oga.ogaplant
                LET l_rxc.rxclegal = g_oga.ogalegal
                INSERT INTO rxc_file VALUES (l_rxc.*)
             ELSE
                UPDATE rxc_file SET rxc06 = rxc06 + l_rxc.rxc06
                 WHERE rxc00 = '02'
                   AND rxc01 = g_oga.oga01
                   AND rxc02 = d_ogb[l_ac].ogb03
                   AND rxc03 = '13'
                   AND rxc04 = ' '
             END IF
             IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
                CALL cl_err3("ins","rxc_file",g_oga.oga01,d_ogb[l_ac].ogb03,SQLCA.sqlcode,"","",1)
                LET g_success = 'N'
             END IF
          END IF
          SELECT SUM(rxc06) INTO l_rxc.rxc06 FROM rxc_file
           WHERE rxc00 = '02'
             AND rxc01 = g_oga.oga01
             AND rxc02 = d_ogb[l_ac].ogb03
         END IF   #FUN-B10014
          IF cl_null(l_rxc.rxc06) THEN LET l_rxc.rxc06 = 0 END IF
         #FUN-AC0012 End-----
          IF g_azw.azw04 ='2' THEN
              IF (d_ogb[l_ac].ogb13_1 != d_ogb_t.ogb13_1) OR cl_null(d_ogb_t.ogb13_1) THEN
                 UPDATE ogb_file SET ogb13=d_ogb[l_ac].ogb13_1,
                                     ogb14=d_ogb[l_ac].ogb14_1,
                                     ogb14t=d_ogb[l_ac].ogb14t_1,
                                   # ogb47=0           #FUN-AC0012
                                     ogb47=l_rxc.rxc06 #FUN-AC0012
                  WHERE ogb01=g_oga.oga01
                    AND ogb03=d_ogb[l_ac].ogb03
              END IF
          ELSE
          UPDATE ogb_file SET ogb13=d_ogb[l_ac].ogb13_1,   #MOD-930322
                              ogb14=d_ogb[l_ac].ogb14_1,   #MOD-930322
                              ogb14t=d_ogb[l_ac].ogb14t_1   #MOD-930322
           WHERE ogb01=g_oga.oga01
             AND ogb03=d_ogb[l_ac].ogb03
          END IF #No.FUN-870007
          IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
             CALL cl_err3("upd","ogb_file",g_oga.oga01,d_ogb[l_ac].ogb03,SQLCA.sqlcode,"","",1)  #No.FUN-670008
             LET g_success = 'N' #FUN-AC0012
          END IF
         #FUN-AC0012 Begin---
         #DELETE FROM rxc_file WHERE rxc00='02' AND rxc01=g_oga.oga01 AND rxc02=d_ogb[l_ac].ogb03
         #IF SQLCA.sqlcode THEN
         #   CALL cl_err3("del","rxc_file",g_oga.oga01,d_ogb[l_ac].ogb03,SQLCA.sqlcode,"","",1) 
         #END IF
         #FUN-AC0012 End-----
       #MOD-B10154 Begin---
       ##FUN-A20022 ADD----------UPDATE THE POINT---------------------------
       #  IF NOT cl_null(g_oga.oga87) THEN
       #     LET g_oga.oga95= t600_oga95_amount()
       #     UPDATE oga_file SET oga95 = g_oga.oga95
       #                   WHERE oga01 = g_oga.oga01
       #                     AND oga87 = g_oga.oga87
       #     IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
       #        CALL cl_err3("upd","oga_file",g_oga.oga01,"",SQLCA.sqlcode,"","",1) 
       #        LET g_success = 'N' #FUN-AC0012
       #     END IF     
       #     DISPLAY BY NAME g_oga.oga95 
       #  END IF
       ##FUN-A20022 END----------------------------------------------
       #MOD-B10154 End-----
          SELECT SUM(ogb14) INTO g_oga.oga50 FROM ogb_file
           WHERE ogb01=g_oga.oga01
          DISPLAY g_oga.oga50 TO FORMONLY.oga50_1  #FUN-8C0127
        #-----CHI-960010---------
        ##UPDATE訂單單頭的已出貨未稅金額
        #SELECT ogb31 INTO l_ogb31 FROM ogb_file
        #                          WHERE ogb01 = g_oga.oga01
        #                            AND ogb03 = d_ogb[l_ac].ogb03

        #SELECT SUM(ogb14) INTO l_sum_ogb14 FROM oga_file,ogb_file
        #                  WHERE ogb31 = l_ogb31
        #                    AND oga01 = ogb01
        #                    AND oga09 = '2'
        #                    AND ogaconf = 'Y'
        #                    AND ogapost = 'Y'

        #IF NOT cl_null(l_sum_ogb14) THEN

        #   UPDATE oea_file SET oea62=l_sum_ogb14
        #    WHERE oea01=l_ogb31

        #   IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
        #      CALL cl_err('',SQLCA.sqlcode,0)
        #   END IF
        #END IF
        #-----END CHI-960010-----
        #FUN-AC0012 Begin---
         IF g_success = 'Y' THEN
            COMMIT WORK
         ELSE
            ROLLBACK WORK
         END IF
        #FUN-AC0012 End-----

      AFTER ROW
          LET l_ac = ARR_CURR()
          IF INT_FLAG THEN
             CALL cl_err('',9001,0)
             LET INT_FLAG = 0
             LET d_ogb[l_ac].* = d_ogb_t.*
             ROLLBACK WORK
             EXIT INPUT
          END IF

       AFTER INPUT
          COMMIT WORK

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT

      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121

      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121

      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121


   END INPUT

   IF INT_FLAG THEN LET INT_FLAG=0 END IF

   BEGIN WORK

  #MOD-B10154 Begin---
   IF NOT cl_null(g_oga.oga87) THEN
      LET g_oga.oga95= t600_oga95_amount()
      IF cl_null(g_oga.oga95) THEN LET g_oga.oga95=0 END IF
      UPDATE oga_file SET oga95 = g_oga.oga95
                    WHERE oga01 = g_oga.oga01
                      AND oga87 = g_oga.oga87
      IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
         CALL cl_err3("upd","oga_file",g_oga.oga01,"",SQLCA.sqlcode,"","",1)
      END IF
      DISPLAY BY NAME g_oga.oga95
   END IF
  #MOD-B10154 End-----

   SELECT SUM(ogb14) INTO g_oga.oga50 FROM ogb_file
    WHERE ogb01=g_oga.oga01
   DISPLAY g_oga.oga50 TO FORMONLY.oga50_1  #FUN-8C0127
   LET g_oga.oga52 = g_oga.oga50 * g_oga.oga161/100
   LET g_oga.oga53 = g_oga.oga50 * (g_oga.oga162+g_oga.oga163)/100
   UPDATE oga_file SET oga50=g_oga.oga50,
                       oga52=g_oga.oga52,
                       oga53=g_oga.oga53
    WHERE oga01=g_oga.oga01
   IF SQLCA.SQLCODE THEN
      CALL cl_err3("upd","oga_file",g_oga.oga01,"",SQLCA.sqlcode,"","update oga",1)  #No.FUN-670008
      ROLLBACK WORK
   ELSE
      COMMIT WORK
   END IF
   CLOSE WINDOW t600p_w

END FUNCTION


FUNCTION t600_oga16()
DEFINE li_result LIKE type_file.num5    #No.FUN-680137 SMALLINT

   CASE g_oga.oga00
        WHEN '1'
              CALL s_check_no("axm",g_oga.oga16,g_oga_t.oga16,"30","","","")
                RETURNING li_result,g_oga.oga16
        WHEN '2'
              CALL s_check_no("axm",g_oga.oga16,g_oga_t.oga16,"32","","","")
                RETURNING li_result,g_oga.oga16
        WHEN '3'
              CALL s_check_no("axm",g_oga.oga16,g_oga_t.oga16,"33","","","")
                RETURNING li_result,g_oga.oga16
        WHEN '4'
              CALL s_check_no("axm",g_oga.oga16,g_oga_t.oga16,"34","","","")
                RETURNING li_result,g_oga.oga16
        WHEN '5'
              CALL s_check_no("axm",g_oga.oga16,g_oga_t.oga16,"35","","","")
                RETURNING li_result,g_oga.oga16
        WHEN '6'
              CALL s_check_no("axm",g_oga.oga16,g_oga_t.oga16,"30","","","")
                RETURNING li_result,g_oga.oga16
        WHEN '7'
              CALL s_check_no("axm",g_oga.oga16,g_oga_t.oga16,"33","","","")
                RETURNING li_result,g_oga.oga16
        WHEN 'A'
              CALL s_check_no("axm",g_oga.oga16,g_oga_t.oga16,"22","","","")
                RETURNING li_result,g_oga.oga16
        WHEN 'B'
              CALL s_check_no("axm",g_oga.oga16,g_oga_t.oga16,"22","","","")
                RETURNING li_result,g_oga.oga16
  END CASE

      DISPLAY BY NAME g_oga.oga16
  RETURN li_result
END FUNCTION

FUNCTION t600_ogb31(p_ogb31,p_ogb_t31)
DEFINE p_ogb31   LIKE ogb_file.ogb31
DEFINE p_ogb_t31 LIKE ogb_file.ogb31
DEFINE li_result LIKE type_file.num5    #No.FUN-680137 SMALLINT

   CASE g_oga.oga00
        WHEN '1'
              CALL s_check_no("axm",p_ogb31,p_ogb_t31,"30","","","")
                RETURNING li_result,p_ogb31
        WHEN '2'
              CALL s_check_no("axm",p_ogb31,p_ogb_t31,"32","","","")
                RETURNING li_result,p_ogb31
        WHEN '3'
              CALL s_check_no("axm",p_ogb31,p_ogb_t31,"33","","","")
                RETURNING li_result,p_ogb31
        WHEN '4'
              CALL s_check_no("axm",p_ogb31,p_ogb_t31,"34","","","")
                RETURNING li_result,p_ogb31
        WHEN '5'
              CALL s_check_no("axm",p_ogb31,p_ogb_t31,"35","ogb_file","ogb31","")
                RETURNING li_result,p_ogb31
        WHEN '6'
              CALL s_check_no("axm",p_ogb31,p_ogb_t31,"30","","","")
                RETURNING li_result,p_ogb31
        WHEN '7'
              CALL s_check_no("axm",p_ogb31,p_ogb_t31,"33","","","")
                RETURNING li_result,p_ogb31
        WHEN 'A'
              CALL s_check_no("axm",p_ogb31,p_ogb_t31,"22","","","")
                RETURNING li_result,p_ogb31
        WHEN 'B'
              CALL s_check_no("axm",p_ogb31,p_ogb_t31,"22","","","")
                RETURNING li_result,p_ogb31
  END CASE
  DISPLAY BY NAME g_ogb[l_ac].ogb31
  RETURN li_result
END FUNCTION

FUNCTION t600_oeo(p_oga16)
DEFINE l_oeo       RECORD LIKE oeo_file.*,
       l_ogb       RECORD LIKE ogb_file.*,
       l_ima35     LIKE ima_file.ima35,
       l_ima36     LIKE ima_file.ima36,
       p_oga16     LIKE oga_file.oga16,
       l_ogb12_sum LIKE ogb_file.ogb12,
       l_n         LIKE type_file.num5     #No.FUN-680137 SMALLINT

    SELECT COUNT(*) INTO l_n FROM oeo_file
     WHERE oeo01 = p_oga16
       AND oeo08 = '2'  #no.7168
    IF l_n <= 0 THEN RETURN END IF
    IF NOT cl_confirm('axm-803') THEN RETURN END IF #no.7168

    DECLARE oeo_cur CURSOR FOR
    SELECT * INTO l_oeo.* FROM oeo_file
     WHERE oeo01 = p_oga16
       AND oeo08 = '2'   #no.7168
     ORDER BY oeo03,oeo04

    FOREACH oeo_cur INTO l_oeo.*
        INITIALIZE l_ogb.* TO NULL

        LET l_ogb.ogb01 = g_oga.oga01

#FUN-A60035 ---MARK BEGIN
##FUN-A50054 --Begin
#&ifdef SLK
##       IF s_industry("slk") THEN
#          SELECT MAX(ata02)+1 INTO l_ogb.ogb03
#            FROM ata_file
#           WHERE ata00=g_prog
#             AND ata01=g_oga.oga01
#             AND ata02=g_ogb[l_ac].ogb03
#       ELSE
#&else
#FUN-A60035 ---MARK END
           SELECT MAX(ogb03)+1 INTO l_ogb.ogb03
             FROM ogb_file
            WHERE ogb01 = g_oga.oga01
#FUN-A60035 ---MARK BEGIN
##       END IF
#&endif
#FUN-A60035 ---MARK END
        IF cl_null(l_ogb.ogb03) THEN
            LET l_ogb.ogb03 = 1
        END IF
        SELECT SUM(ogb12) INTO l_ogb12_sum FROM ogb_file,oga_file
         WHERE oga01   = ogb01
           AND ogb31   = l_oeo.oeo01
           AND ogb32   = l_oeo.oeo03
           AND ogb04   = l_oeo.oeo04
           AND oga09   = g_argv0 # 1.出貨通知單 2.出貨單
           AND ogaconf = 'Y'
        IF cl_null(l_ogb12_sum) THEN
            LET l_ogb12_sum = 0
        END IF
        LET l_ogb.ogb12 = l_oeo.oeo09 - l_ogb12_sum #no.7168

        LET l_ogb.ogb04 = l_oeo.oeo04
        LET l_ogb.ogb05 = l_oeo.oeo05
        SELECT ima02,ima021,ima35,ima36
          INTO l_ogb.ogb06,l_ogb.ogb07,l_ima35,l_ima36
          FROM ima_file  WHERE ima01 = l_ogb.ogb04
        IF cl_null(l_ogb.ogb09) THEN
           IF g_azw.azw04='2' THEN
              SELECT rtz07 INTO l_ogb.ogb09 FROM rtz_file
               WHERE rtz01 = g_plant
           ELSE
              LET l_ogb.ogb09 = l_ima35
           END IF
        END IF
        IF cl_null(l_ogb.ogb091) THEN LET l_ogb.ogb091= l_ima36 END IF  #MOD-580206
        LET l_ogb.ogb31 = l_oeo.oeo01
        LET l_ogb.ogb32 = l_oeo.oeo03

       #LET l_ogb.ogb17 = 'N' #CHI-AC0034 mark
        LET l_ogb.ogb17 = l_ogb.ogb17 #CHI-AC0034
        LET l_ogb.ogb05_fac = 1
        LET l_ogb.ogb37 = 0     #FUN-AB0061
        LET l_ogb.ogb13 = 0
        LET l_ogb.ogb14 = 0
        LET l_ogb.ogb14t= 0
        LET l_ogb.ogb15_fac = 1
        LET l_ogb.ogb16 = l_ogb.ogb12/l_ogb.ogb15_fac
        LET l_ogb.ogb18 = 0
        LET l_ogb.ogb60 = 0
        LET l_ogb.ogb63 = 0
        LET l_ogb.ogb64 = 0
        SELECT oeb930 INTO l_ogb.ogb930 FROM oeb_file
                                       WHERE oeb01=l_ogb.ogb31
                                         AND oeb03=l_ogb.ogb32
        IF SQLCA.sqlcode THEN
           LET l_ogb.ogb930=NULL
        END IF
        SELECT oeb44,oeb45,oeb46,oeb47 
          INTO l_ogb.ogb44,l_ogb.ogb45,l_ogb.ogb46,l_ogb.ogb47
          FROM oeb_file
         WHERE oeb01=l_ogb.ogb31  AND oeb03=l_ogb.ogb32
        IF cl_null(l_ogb.ogb44) THEN
           LET l_ogb.ogb44='1'
        END IF
        IF cl_null(l_ogb.ogb47) THEN
           LET l_ogb.ogb47=0
        END IF
        IF cl_null(l_ogb.ogb05_fac) THEN
           LET l_ogb.ogb05_fac = 1
        END IF
        IF cl_null(l_ogb.ogb12) THEN
           LET l_ogb.ogb12 = 0
        END IF
#FUN-AB0061 -----------add start----------------                             
        IF cl_null(l_ogb.ogb37) THEN
           LET l_ogb.ogb37 = 0
        END IF                                             
#FUN-AB0061 -----------add end----------------          
        IF cl_null(l_ogb.ogb13) THEN
           LET l_ogb.ogb13 = 0
        END IF
        IF cl_null(l_ogb.ogb14) THEN
           LET l_ogb.ogb14 = 0
        END IF
        IF cl_null(l_ogb.ogb14t) THEN
           LET l_ogb.ogb14t = 0
        END IF
        IF cl_null(l_ogb.ogb15_fac) THEN
           LET l_ogb.ogb15_fac = 1
        END IF
        IF cl_null(l_ogb.ogb16) THEN
           LET l_ogb.ogb16 = 0
        END IF
        IF cl_null(l_ogb.ogb18) THEN
           LET l_ogb.ogb18 = 0
        END IF
        IF cl_null(l_ogb.ogb60) THEN
           LET l_ogb.ogb60 = 0
        END IF
        IF cl_null(l_ogb.ogb63) THEN
           LET l_ogb.ogb63 = 0
        END IF
        IF cl_null(l_ogb.ogb64) THEN
           LET l_ogb.ogb64 = 0
        END IF
        LET l_ogb.ogb1014 = 'N'  #FUN-6A0007
        LET l_ogb.ogb1005 = '1'  #MOD-840330
        #add by pane 150714 begin#
        IF cl_null(l_ogb.ogb091) THEN
           LET l_ogb.ogb091=' '
        END IF
        IF cl_null(l_ogb.ogb092) THEN
           LET l_ogb.ogb092=' '
        END IF
        #add by pane 150714 end#

        LET l_ogb.ogbplant = g_plant 
        LET l_ogb.ogblegal = g_legal  
      # IF cl_null(l_ogb.ogb50) THEN LET l_ogb.ogb50 = '1' END IF #FUN-AA0057

        INSERT INTO ogb_file VALUES(l_ogb.*)
    END FOREACH
END FUNCTION

#FUNCTION t600_chk_ima262(p_ogb) #MOD-4A0232   #MOD-850309 #FUN-A20044  
FUNCTION t600_chk_avl_stk(p_ogb) #FUN-A20044  
  DEFINE l_oeb19   LIKE oeb_file.oeb19
#  DEFINE l_ima262  LIKE ima_file.ima262 #FUN-A20044
  DEFINE l_avl_stk,l_avl_stk_mpsmrp,l_unavl_stk  LIKE type_file.num15_3 #FUN-A20044
  DEFINE l_oeb12   LIKE oeb_file.oeb12
  DEFINE l_qoh     LIKE oeb_file.oeb12
  DEFINE l_qoh_2   LIKE oeb_file.oeb12      #MOD-C30033 add
  DEFINE p_ogb     RECORD LIKE ogb_file.*   #MOD-850309將該FUNCTION底下的b_ogb.*改為p_ogb.*

    #--訂單備置為'N',須check(庫存量ima262-sum(備置量oeb12-oeb24))>出貨量
    IF NOT cl_null(p_ogb.ogb31) AND NOT cl_null(p_ogb.ogb32) THEN
       SELECT oeb19
         INTO l_oeb19
         FROM oeb_file
        WHERE oeb01 = p_ogb.ogb31
          AND oeb03 = p_ogb.ogb32
       IF STATUS THEN
          CALL cl_err3("sel","oeb_file",p_ogb.ogb31,p_ogb.ogb32,SQLCA.sqlcode,"","sel oeb:",1)  #No.FUN-670008
          LET g_success='N'
          RETURN
       END IF

      #IF l_oeb19 = 'N' THEN        #MOD-B50227 mark
       IF NOT cl_null(l_oeb19) THEN #MOD-B50227 
#          SELECT ima262
 #           INTO l_ima262
  #          FROM ima_file
   #        WHERE ima01=p_ogb.ogb04
    #      IF l_ima262 IS NULL THEN
    #          LET l_ima262 = 0
    #      END IF                            #FUN-A20044
      CALL s_getstock(p_ogb.ogb04,g_plant)RETURNING l_avl_stk_mpsmrp,l_unavl_stk,l_avl_stk #FUN-A20044  
          IF l_oeb19 = 'N' THEN #MOD-B50227 add
             SELECT SUM(oeb905*oeb05_fac)
               INTO l_oeb12
               FROM oeb_file,oea_file   #no.7182  #CHI-6B0036 add oea
              WHERE oeb04=p_ogb.ogb04
                AND oeb19= 'Y'
                AND oeb70= 'N'  #No.+149 010529 BY ANN CHEN
                AND oea01 = oeb01 AND oeaconf !='X' #CHI-6B0036
          #MOD-B50227 add --start
          ELSE
             SELECT SUM(oeb905*oeb05_fac)
               INTO l_oeb12
               FROM oeb_file,oea_file 
              WHERE oeb04=p_ogb.ogb04
                AND oeb19= 'Y'
                AND oeb70= 'N' 
                AND oea01 = oeb01 AND oeaconf !='X'
                AND oeb01 != p_ogb.ogb31 
          END IF
          #MOD-B50227 add --end--
          IF l_oeb12 IS NULL THEN
              LET l_oeb12 = 0
          END IF
#          LET l_qoh = l_ima262 - l_oeb12 #FUN-A20044
          LET l_qoh = l_avl_stk - l_oeb12 #FUN-A20044

          #IF l_qoh < p_ogb.ogb16 AND g_sma.sma894[2,2]='N' THEN  #量不足時,Fail   #MOD-850309   #MOD-A70059
          LET l_qoh_2 = p_ogb.ogb12 * p_ogb.ogb05_fac #MOD-C30033 add
          LET g_flag2 = NULL    #FUN-C80107 add
          CALL s_inv_shrt_by_warehouse(g_sma.sma894[2,2],p_ogb.ogb09) RETURNING g_flag2   #FUN-C80107 add
     {     #IF l_qoh < l_qoh_2 AND g_sma.sma894[2,2]='N' THEN  #量不足時,Fail #MOD-C30033 add   #FUN-C80107 mark
          IF l_qoh < l_qoh_2 AND g_flag2 = 'N' THEN    #FUN-C80107 add
          #IF l_qoh < p_ogb.ogb12 * p_ogb.ogb05_fac AND g_sma.sma894[2,2]='N' THEN  #量不足時,Fail   #MOD-850309   #MOD-A70059 #MOD-C30033 mark
             LET g_msg = 'Line#',p_ogb.ogb03 USING '<<<',' ',
                          p_ogb.ogb04 CLIPPED,'-> QOH < 0 '
             CALL cl_err(g_msg,'mfg-026',1)
             LET g_success='N' RETURN
          END IF  
     } #xiaoyx NO.130408,此段无意义
       END IF
    END IF
END FUNCTION

#用于default 雙單位/轉換率/數量
FUNCTION t600_du_default(p_cmd)
  DEFINE    l_item   LIKE img_file.img01,     #料號
            l_ware   LIKE img_file.img02,     #倉庫
            l_loc    LIKE img_file.img03,     #儲
            l_lot    LIKE img_file.img04,     #批
            l_ima25  LIKE ima_file.ima25,     #ima單位
            l_ima31  LIKE ima_file.ima31,     #ima單位
            l_ima906 LIKE ima_file.ima906,
            l_ima907 LIKE ima_file.ima907,
            l_ima908 LIKE ima_file.ima908,
            l_img09  LIKE img_file.img09,     #img單位
            l_unit2  LIKE img_file.img09,     #第二單位
            l_fac2   LIKE img_file.img21,     #第二轉換率
            l_qty2   LIKE img_file.img10,     #第二數量
            l_unit1  LIKE img_file.img09,     #第一單位
            l_fac1   LIKE img_file.img21,     #第一轉換率
            l_qty1   LIKE img_file.img10,     #第一數量
            l_unit3  LIKE img_file.img09,     #第一單位
            l_qty3   LIKE img_file.img10,     #第一數量
            p_cmd    LIKE type_file.chr1,    #No.FUN-680137 VARCHAR(1)
            l_factor LIKE ima_file.ima31_fac  #No.FUN-680137 DECIMAL(16,8)

    LET l_item = g_ogb[l_ac].ogb04     #No.TQC-640123
    LET l_ware = g_ogb[l_ac].ogb09     #No.TQC-640123
    LET l_loc  = g_ogb[l_ac].ogb091    #No.TQC-640123
    LET l_lot  = g_ogb[l_ac].ogb092    #No.TQC-640123
    SELECT ima25,ima31,ima906,ima907,ima908 INTO l_ima25,l_ima31,l_ima906,l_ima907,l_ima908
      FROM ima_file WHERE ima01 = l_item

    SELECT img09 INTO l_img09 FROM img_file
     WHERE img01 = l_item
       AND img02 = l_ware
       AND img03 = l_loc
       AND img04 = l_lot

    IF g_sma.sma115 = 'Y' THEN         #No:TQC-6B0124 add
       IF l_ima906 = '1' THEN  #不使用雙單位
          LET l_unit2 = NULL
          LET l_fac2  = NULL
          LET l_qty2  = NULL
       ELSE
          LET l_unit2 = l_ima907
          CALL s_du_umfchk(l_item,'','','',l_ima31,l_ima907,l_ima906)
               RETURNING g_errno,l_factor
          LET l_fac2 = l_factor
          LET l_qty2  = 0
       END IF
       LET l_unit1 = l_ima31
       LET l_fac1  = 1
       LET l_qty1  = 0
    END IF                            #No:TQC-6B0124 add

    IF g_sma.sma116 MATCHES '[01]' THEN
       LET l_unit3 = NULL
       LET l_qty3  = NULL
    ELSE
       LET l_unit3 = l_ima908
       LET l_qty3  = 0
    END IF

    IF p_cmd = 'a' THEN
       LET g_ogb[l_ac].ogb913=l_unit2   #No.TQC-640123
       LET g_ogb[l_ac].ogb914=l_fac2    #No.TQC-640123
       LET g_ogb[l_ac].ogb915=l_qty2    #No.TQC-640123
       LET g_ogb[l_ac].ogb910=l_unit1   #No.TQC-640123
       LET g_ogb[l_ac].ogb911=l_fac1    #No.TQC-640123
       LET g_ogb[l_ac].ogb912=l_qty1    #No.TQC-640123
    END IF
END FUNCTION

#對原來數量/換算率/單位的賦值
FUNCTION t600_set_origin_field()
  DEFINE    l_ima906 LIKE ima_file.ima906,
            l_ima907 LIKE ima_file.ima907,
            l_img09  LIKE img_file.img09,     #img單位
            l_ima25  LIKE ima_file.ima25,
            l_ima31  LIKE ima_file.ima31,
            l_tot    LIKE img_file.img10,
            l_fac2   LIKE ogb_file.ogb914,
            l_qty2   LIKE ogb_file.ogb915,
            l_fac1   LIKE ogb_file.ogb911,
            l_qty1   LIKE ogb_file.ogb912,
            l_factor LIKE ima_file.ima31_fac  #No.FUN-680137 DECIMAL(16,8)

    IF g_sma.sma115='N' THEN RETURN END IF
    SELECT ima25,ima31 INTO l_ima25,l_ima31 FROM ima_file
     WHERE ima01=g_ogb[l_ac].ogb04      #No.TQC-640123
    IF SQLCA.sqlcode = 100 THEN
       IF g_ogb[l_ac].ogb04 MATCHES 'MISC*' THEN           #No.TQC-640123
          SELECT ima25,ima31 INTO l_ima25,l_ima31
            FROM ima_file WHERE ima01='MISC'
       END IF
    END IF
    IF cl_null(l_ima31) THEN LET l_ima31=l_ima25 END IF

    LET l_fac2=g_ogb[l_ac].ogb914  #No.TQC-640123
    LET l_qty2=g_ogb[l_ac].ogb915  #No.TQC-640123
    LET l_fac1=g_ogb[l_ac].ogb911  #No.TQC-640123
    LET l_qty1=g_ogb[l_ac].ogb912  #No.TQC-640123

    IF cl_null(l_fac1) THEN LET l_fac1=1 END IF
    IF cl_null(l_qty1) THEN LET l_qty1=0 END IF
    IF cl_null(l_fac2) THEN LET l_fac2=1 END IF
    IF cl_null(l_qty2) THEN LET l_qty2=0 END IF

    IF g_sma.sma115 = 'Y' THEN
       CASE g_ima906
          WHEN '1' IF cl_null(g_ogb[l_ac].ogb31) THEN
                      LET g_ogb[l_ac].ogb05=g_ogb[l_ac].ogb910
                   END IF
                   LET g_ogb[l_ac].ogb12=l_qty1
          WHEN '2' LET l_tot=l_fac1*l_qty1+l_fac2*l_qty2
                   IF cl_null(g_ogb[l_ac].ogb31) THEN
                      LET g_ogb[l_ac].ogb05=l_ima31
                   END IF
                   LET g_ogb[l_ac].ogb12=l_tot
          WHEN '3'
                   IF cl_null(g_ogb[l_ac].ogb31) THEN
                      LET g_ogb[l_ac].ogb05=g_ogb[l_ac].ogb910
                   END IF
                   LET g_ogb[l_ac].ogb12=l_qty1
                   IF l_qty2 <> 0 THEN
                      LET g_ogb[l_ac].ogb914 = l_qty1 / l_qty2
                   ELSE
                      LET g_ogb[l_ac].ogb914 = 0
                   END IF
       END CASE
    END IF
    LET g_factor = 1
    CALL s_umfchk(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb05,l_ima25)
          RETURNING g_cnt,g_factor
    IF g_cnt = 1 THEN
       LET g_factor = 1
    END IF
    LET b_ogb.ogb05_fac = g_factor

    #-----MOD-A70140---------
    IF g_sma.sma116 ='0' OR g_sma.sma116 ='1' THEN
       LET g_ogb[l_ac].ogb916 = g_ogb[l_ac].ogb05
       LET g_ogb[l_ac].ogb917 = g_ogb[l_ac].ogb12
    END IF
    #-----END MOD-A70140-----

END FUNCTION

#計算庫存總量是否滿足所輸入數量
FUNCTION t600_check_inventory_qty()
  DEFINE l_img09    LIKE img_file.img09
  DEFINE l_img10    LIKE img_file.img10
  DEFINE l_img21    LIKE img_file.img21
  DEFINE l_tot      LIKE img_file.img10
  DEFINE l_fac      LIKE img_file.img21
  DEFINE l_flag     LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)
#FUN-AB0011 -----------------STR
    IF s_joint_venture(g_ogb[l_ac].ogb04,g_plant) OR NOT s_internal_item( g_ogb[l_ac].ogb04,g_plant ) THEN
       RETURN TRUE
    END IF
#FUN-AB0011 -----------------END
    LET l_flag = '1'
    SELECT img09,img10 INTO l_img09,l_img10 FROM img_file
     WHERE img01 = g_ogb[l_ac].ogb04
       AND img02 = g_ogb[l_ac].ogb09
       AND img03 = g_ogb[l_ac].ogb091
       AND img04 = g_ogb[l_ac].ogb092
    IF cl_null(l_img10) THEN LET l_img10 =0 END IF

    CALL t600_tot_by_img09(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb914,g_ogb[l_ac].ogb915,
                           g_ogb[l_ac].ogb911,g_ogb[l_ac].ogb912)
         RETURNING l_tot

    CALL s_umfchk(g_ogb[l_ac].ogb04,l_img09,g_ogb[l_ac].ogb05)   #MOD-A70059 
         RETURNING g_cnt,l_fac   #MOD-A70059 
    IF cl_null(l_fac) THEN LET l_fac = 1 END IF
    IF l_img10*l_fac < l_tot THEN
       LET l_flag = '0'
    END IF
    RETURN l_flag
END FUNCTION

#檢查發料/報廢動作是否可以進行下去
FUNCTION t600_qty_issue()

    IF g_oga.oga09 MATCHES '[246]' THEN
       CALL t600_check_inventory_qty()  RETURNING g_flag
    ELSE
       LET g_flag = '1'
    END IF
    IF g_flag = '0' THEN
       IF g_yes = 'N' THEN
          IF g_ogb[l_ac].ogb17 = 'N' THEN   #MOD-890274
             IF g_sma.sma894[2,2]='N' OR g_sma.sma894[2,2] IS NULL THEN
                CALL cl_err(g_ogb[l_ac].ogb04,'mfg1303',1)
                RETURN 1
             ELSE
                IF NOT cl_confirm('mfg3469') THEN
                   RETURN 1
                END IF
             END IF
          END IF   #MOD-890274
       END IF
    END IF

    RETURN 0

END FUNCTION

#兩組雙單位資料不是一定要全部KEY,如果沒有KEY單位,則把換算率/數量清空
FUNCTION t600_du_data_to_correct()

   IF cl_null(g_ogb[l_ac].ogb913) THEN
      LET g_ogb[l_ac].ogb914 = NULL
      LET g_ogb[l_ac].ogb915 = NULL
   END IF

   IF cl_null(g_ogb[l_ac].ogb910) THEN
      LET g_ogb[l_ac].ogb911 = NULL
      LET g_ogb[l_ac].ogb912 = NULL
   END IF

   DISPLAY BY NAME g_ogb[l_ac].ogb913
   DISPLAY BY NAME g_ogb[l_ac].ogb914
   DISPLAY BY NAME g_ogb[l_ac].ogb915
   DISPLAY BY NAME g_ogb[l_ac].ogb910
   DISPLAY BY NAME g_ogb[l_ac].ogb911
   DISPLAY BY NAME g_ogb[l_ac].ogb912
END FUNCTION

FUNCTION t600_set_ogb917()
  DEFINE    l_item   LIKE img_file.img01,     #料號
            l_ima25  LIKE ima_file.ima25,     #ima單位
            l_ima31  LIKE ima_file.ima31,     #ima單位
            l_ima906 LIKE ima_file.ima906,
            l_fac2   LIKE img_file.img21,     #第二轉換率
            l_qty2   LIKE img_file.img10,     #第二數量
            l_fac1   LIKE img_file.img21,     #第一轉換率
            l_qty1   LIKE img_file.img10,     #第一數量
            l_tot    LIKE img_file.img10,     #計價數量
            l_factor LIKE ima_file.ima31_fac  #No.FUN-680137 DECIMAL(16,8)

    SELECT ima25,ima31,ima906 INTO l_ima25,l_ima31,l_ima906
      FROM ima_file WHERE ima01=g_ogb[l_ac].ogb04
    IF SQLCA.sqlcode = 100 THEN
       IF g_ogb[l_ac].ogb04 MATCHES 'MISC*' THEN
          SELECT ima25,ima31,ima906 INTO l_ima25,l_ima31,l_ima906
            FROM ima_file WHERE ima01='MISC'
       END IF
    END IF
    IF cl_null(l_ima31) THEN LET l_ima31=l_ima25 END IF

    LET l_fac2=g_ogb[l_ac].ogb914
    LET l_qty2=g_ogb[l_ac].ogb915
    IF g_sma.sma115 = 'Y' THEN
       LET l_fac1=g_ogb[l_ac].ogb911
       LET l_qty1=g_ogb[l_ac].ogb912
    ELSE
       LET l_fac1=1
       LET l_qty1=g_ogb[l_ac].ogb12
       CALL s_umfchk(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb05,l_ima31)
             RETURNING g_cnt,l_fac1
       IF g_cnt = 1 THEN
          LET l_fac1 = 1
       END IF
    END IF
    IF cl_null(l_fac1) THEN LET l_fac1=1 END IF
    IF cl_null(l_qty1) THEN LET l_qty1=0 END IF
    IF cl_null(l_fac2) THEN LET l_fac2=1 END IF
    IF cl_null(l_qty2) THEN LET l_qty2=0 END IF

    IF g_sma.sma115 = 'Y' THEN
       CASE l_ima906
          WHEN '1' LET l_tot=l_qty1*l_fac1
          WHEN '2' LET l_tot=l_qty1*l_fac1+l_qty2*l_fac2
          WHEN '3' LET l_tot=l_qty1*l_fac1
       END CASE
    ELSE  #不使用雙單位
       LET l_tot=l_qty1*l_fac1
    END IF
    IF cl_null(l_tot) THEN LET l_tot = 0 END IF
    LET l_factor = 1
    #-----MOD-A70140---------
    #CALL s_umfchk(g_ogb[l_ac].ogb04,l_ima31,g_ogb[l_ac].ogb916)
    #    RETURNING g_cnt,l_factor
    IF g_sma.sma115 = 'Y' THEN 
       CALL s_umfchk(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb05,g_ogb[l_ac].ogb916)
           RETURNING g_cnt,l_factor
    ELSE
       CALL s_umfchk(g_ogb[l_ac].ogb04,l_ima31,g_ogb[l_ac].ogb916)
           RETURNING g_cnt,l_factor
    END IF 
    #-----END MOD-A70140-----
    IF g_cnt = 1 THEN
       LET l_factor = 1
    END IF
    LET l_tot = l_tot * l_factor

    LET g_ogb[l_ac].ogb917 = l_tot

    CALL t600_ogb14()   #MOD-A70140
END FUNCTION

FUNCTION t600_set_distact()   #判別客戶相關查詢,訂單相關查詢及備註等Action是否開啟
   IF cl_null(g_oga.oga01) THEN
      CALL cl_set_act_visible("query_delivery",FALSE)
   ELSE
      CALL cl_set_act_visible("query_delivery",TRUE)
   END IF
   IF cl_null(g_oga.oga16) THEN
      CALL cl_set_act_visible("order_query",FALSE)
   ELSE
      CALL cl_set_act_visible("order_query",TRUE)
   END IF
   IF cl_null(g_oga.oga03) THEN  #No.TQC-640123
      CALL cl_set_act_visible("query_customer",FALSE)
   ELSE
      CALL cl_set_act_visible("query_customer",TRUE)
   END IF
   IF g_argv0 = '9' THEN
      CALL cl_set_act_visible("insert,modify,delete,detail,unit_price",FALSE)
      CALL cl_set_act_visible("address,other_data,modify_wh_loc",FALSE)
      CALL cl_set_act_visible("modify_shipping_customer,entry_sheet,entry_sheet2",FALSE) #CHI-AC0002 add entry_sheet2
      CALL cl_set_act_visible("gen_entry_sheet,query_delivery",FALSE)
      CALL cl_set_act_visible("order_query,order_qrery_b,query_customer,memo",FALSE) #No.FUN-950093 add order_query_b
      CALL cl_set_act_visible("confirm,undo_confirm,deduct_inventory",FALSE)
      CALL cl_set_act_visible("undo_deduct,trsf_to_ar_invo,a_r",FALSE)
      CALL cl_set_act_visible("release_ov_lmt_credit,void",FALSE)
     #CALL cl_set_act_visible("output,exporttoexcel,approval_status",FALSE)  #No.FUN-B10026
      CALL cl_set_act_visible("exporttoexcel,approval_status",FALSE)         #No.FUN-B10026
      CALL cl_set_act_visible("easyflow_approval,agree,deny,modify_flow",FALSE)
      CALL cl_set_act_visible("withdraw,org_withdraw,phrase",FALSE)
   END IF
   IF g_argv0 = '8' THEN
      CALL cl_set_act_visible("unit_price",FALSE)
      CALL cl_set_act_visible("other_data,modify_wh_loc",FALSE)   #CHI-760021
      CALL cl_set_act_visible("modify_shipping_customer,entry_sheet,entry_sheet2",FALSE) #CHI-AC0002 add entry_sheet2
      CALL cl_set_act_visible("gen_entry_sheet,query_delivery",FALSE)
      CALL cl_set_act_visible("order_query,order_query_b,query_customer,memo",FALSE)#No.FUN-950093 add order_query_b
     #CALL cl_set_act_visible("trsf_to_ar_invo",FALSE) #mark a_r #FUN-750108 #FUN-970017 mark axmt628出貨簽收單,應也要能做此Action
      CALL cl_set_act_visible("release_ov_lmt_credit,void",FALSE)
   END IF
END FUNCTION

FUNCTION t600_ef()

    #start FUN-580113
    CALL t600sub_y_chk(g_oga.oga01)          #CALL 原確認的 check 段
    IF g_success = "N" THEN
        RETURN
    END IF
    #end FUN-580113

    CALL aws_condition()      #判斷送簽資料
    IF g_success = 'N' THEN
        RETURN
    END IF
##########
# CALL aws_efcli2()
# 傳入參數: (1)單頭資料, (2-6)單身資料
# 回傳值  : 0 開單失敗; 1 開單成功
##########
 IF aws_efcli2(base.TypeInfo.create(g_oga),base.TypeInfo.create(g_ogb),'','','','')
  THEN
      LET g_success='Y'
      LET g_oga.oga55='S'
      DISPLAY BY NAME g_oga.oga55
  ELSE
      LET g_success='N'
  END IF

END FUNCTION

#變更圖檔
FUNCTION t600_chspic()
DEFINE l_chr,l_chr2,l_chr3 LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)
    IF g_prog='axmp220' THEN RETURN END IF   #TQC-730022 add
    IF g_prog='atmt321' THEN RETURN END IF   #FUN-630102 add
    IF g_oga.ogaconf='X' THEN LET l_chr='Y' ELSE LET l_chr='N' END IF
    IF g_oga.oga55='1' OR
       g_oga.oga55='2' THEN LET l_chr2='Y' ELSE LET l_chr2='N' END IF
    IF g_oga.oga55='6' THEN LET l_chr3='Y' ELSE LET l_chr3='N' END IF
    CALL cl_set_field_pic(g_oga.ogaconf,l_chr2,g_oga.ogapost,l_chr3,l_chr,"")
END FUNCTION

FUNCTION t600_b_ogg_1()   # 庫存異動明細(ogg_file)輸入
  DEFINE ls_tmp           STRING
  DEFINE r_ogg            RECORD LIKE ogg_file.*
  DEFINE r_ogc            RECORD LIKE ogc_file.*
  DEFINE l_ogg            DYNAMIC ARRAY OF RECORD
         ogg20            LIKE ogg_file.ogg20,    #MOD-940275 add
         #ogg12            LIKE ogg_file.ogg12,   #CHI-9C0024
         ogg09            LIKE ogg_file.ogg09,
         ogg091           LIKE ogg_file.ogg091,
         ogg092           LIKE ogg_file.ogg092,
         ogg12            LIKE ogg_file.ogg12,   #CHI-9C0024
         ogg10            LIKE ogg_file.ogg10,
         img10            LIKE type_file.num10,   #No.FUN-680137 INTEGER
         ogg15            LIKE ogg_file.ogg15,
         ogg15_fac        LIKE ogg_file.ogg15_fac,
         ogg16            LIKE ogg_file.ogg16,
         ogg18            LIKE ogg_file.ogg18     #No.FUN-8A0030      #No:FUN-8B0021
                          END RECORD
  DEFINE l_ogg12_t1       LIKE ogg_file.ogg12
  DEFINE l_ogg16_t1       LIKE ogg_file.ogg16
  DEFINE l_ogg12_t2       LIKE ogg_file.ogg12
  DEFINE l_ogg16_t2       LIKE ogg_file.ogg16
  DEFINE l_img21          LIKE img_file.img21
  DEFINE l_ima906         LIKE ima_file.ima906
  DEFINE l_img09          LIKE img_file.img09
  DEFINE i,j,s,l_i,k      LIKE type_file.num5,    #No.FUN-680137 SMALLINT
         l_allow_insert   LIKE type_file.num5,                #可新增否  #No.FUN-680137 SMALLINT
         l_allow_delete   LIKE type_file.num5                 #可刪除否  #No.FUN-680137 SMALLINT
  DEFINE l_ogg17          LIKE ogg_file.ogg17     #FUN-8A0030
  DEFINE l_msg            STRING
  DEFINE l_msg1           STRING
  DEFINE l_msg2           STRING

   IF g_ogb[l_ac].ogb17 IS NULL THEN RETURN END IF
   IF g_ogb[l_ac].ogb17 = 'N' THEN RETURN END IF

   SELECT COUNT(*) INTO i FROM ogg_file
    WHERE ogg01 = g_oga.oga01 AND ogg03 = g_ogb[l_ac].ogb03

   OPEN WINDOW t6006_w AT 04,02 WITH FORM "axm/42f/axmt600e"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN

    CALL cl_ui_locale("axmt600e")

   IF g_sma.sma122 = '1' THEN
      CALL cl_getmsg('asm-303',g_lang) RETURNING l_msg1
      CALL cl_getmsg('asm-302',g_lang) RETURNING l_msg2
      LET l_msg = '1:',l_msg1 CLIPPED,',2:',l_msg2 CLIPPED
      CALL cl_set_combo_items('ogg20','1,2',l_msg)
   END IF

   IF g_sma.sma122 ='2' THEN
      CALL cl_getmsg('asm-326',g_lang) RETURNING l_msg1
      CALL cl_getmsg('asm-304',g_lang) RETURNING l_msg2
      LET l_msg = '1:',l_msg1 CLIPPED,',2:',l_msg2 CLIPPED
      CALL cl_set_combo_items('ogg20','1,2',l_msg)
   END IF

   DECLARE t6006_ogg_c_1 CURSOR FOR
   #SELECT ogg20,ogg12,ogg09,ogg091,ogg092,ogg10,0,ogg15,ogg15_fac,ogg16,ogg18     #FUN-8A0030 Add ''   #No:FUN-8B0021 #MOD-940275 move ogg20   #CHI-9C0024 move ogg12
    SELECT ogg20,ogg09,ogg091,ogg092,ogg12,ogg10,0,ogg15,ogg15_fac,ogg16,ogg18     #FUN-8A0030 Add ''   #No:FUN-8B0021 #MOD-940275 move ogg20   #CHI-9C0024 move ogg12
      FROM ogg_file
     WHERE ogg01 = g_oga.oga01 AND ogg03 = g_ogb[l_ac].ogb03 
     ORDER BY ogg20    #MOD-940275 add

   CALL l_ogg.clear()

   SELECT ima906 INTO l_ima906 FROM ima_file WHERE ima01=g_ogb[l_ac].ogb04 #MOD-940119

   LET i = 1
   FOREACH t6006_ogg_c_1 INTO l_ogg[i].*
      IF STATUS THEN
         CALL cl_err('foreach ogg',STATUS,0)
         EXIT FOREACH
      END IF
      IF l_ima906 = '1' THEN
         SELECT img10 INTO l_ogg[i].img10 FROM img_file
          WHERE img01=g_ogb[l_ac].ogb04 AND img02=l_ogg[i].ogg09
            AND img03=l_ogg[i].ogg091   AND img04=l_ogg[i].ogg092
      END IF
      IF l_ima906 = '2' THEN
         SELECT imgg10 INTO l_ogg[i].img10 FROM imgg_file
          WHERE imgg01=g_ogb[l_ac].ogb04 AND imgg02=l_ogg[i].ogg09
            AND imgg03=l_ogg[i].ogg091   AND imgg04=l_ogg[i].ogg092
            AND imgg09=l_ogg[i].ogg10
      END IF
      IF l_ima906 = '3' THEN
         IF l_ogg[i].ogg20 = '2' THEN
            SELECT imgg10 INTO l_ogg[i].img10 FROM imgg_file
             WHERE imgg01=g_ogb[l_ac].ogb04 AND imgg02=l_ogg[i].ogg09
               AND imgg03=l_ogg[i].ogg091   AND imgg04=l_ogg[i].ogg092
               AND imgg09=l_ogg[i].ogg10
         ELSE
            SELECT img10 INTO l_ogg[i].img10 FROM img_file
             WHERE img01=g_ogb[l_ac].ogb04 AND img02=l_ogg[i].ogg09
               AND img03=l_ogg[i].ogg091   AND img04=l_ogg[i].ogg092
         END IF
      END IF
      IF cl_null(l_ogg[i].img10) THEN LET l_ogg[i].img10 = 0 END IF
      LET i = i + 1
   END FOREACH
   CALL l_ogg.deleteElement(i)
   LET l_i=i-1
   DISPLAY l_i TO cn2

   SELECT SUM(ogg12),SUM(ogg16) INTO l_ogg12_t1,l_ogg16_t1 FROM ogg_file
    WHERE ogg01 = g_oga.oga01 AND ogg03 = g_ogb[l_ac].ogb03
      AND ogg20 = '1'
   SELECT SUM(ogg12),SUM(ogg16) INTO l_ogg12_t2,l_ogg16_t2 FROM ogg_file
    WHERE ogg01 = g_oga.oga01 AND ogg03 = g_ogb[l_ac].ogb03
      AND ogg20 = '2'

   DISPLAY l_ogg12_t1 TO ogg12t_1
   DISPLAY l_ogg16_t1 TO ogg16t_1
   DISPLAY l_ogg12_t2 TO ogg12t_2
   DISPLAY l_ogg16_t2 TO ogg16t_2
   DISPLAY g_ogb[l_ac].ogb912 TO ogb12t_1   #No:MOD-590206
   DISPLAY g_ogb[l_ac].ogb915 TO ogb12t_2   #No:MOD-590206

   CALL cl_set_act_visible("cancel", FALSE)
   LET i=ARR_CURR()                         #No:FUN-8A0030   
   IF g_action_choice="qry_mntn_inv_detail" THEN
      DISPLAY ARRAY l_ogg TO s_ogg.* ATTRIBUTE(COUNT=g_rec_b1,UNBUFFERED)       #No.FUN-640123

      BEFORE ROW 
        LET i=ARR_CURR()
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE DISPLAY

      ON ACTION about         
         CALL cl_about()      

      ON ACTION help          
         CALL cl_show_help()  

      ON ACTION controlg      
         CALL cl_cmdask()
         
      ON ACTION qry_lot
         LET g_ima918 = ''   #MOD-9C0055
         LET g_ima921 = ''   #MOD-9C0055
         SELECT ima918,ima921 INTO g_ima918,g_ima921
           FROM ima_file
          WHERE ima01 = g_ogb[l_ac].ogb04
            AND imaacti = "Y"
         
         IF g_ima918 = "Y" OR g_ima921 = "Y" THEN
           #IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add #CHI-AC0034 mark
            #IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR g_argv0='8' OR g_argv0='9' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add #CHI-AC0034 add '8','9'   #MOD-AC0060
            IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR g_argv0='8' OR g_argv0='9' OR g_argv0='A' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add #CHI-AC0034 add '8','9'   #MOD-AC0060 add 'A'
               CALL s_lotout(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,l_ogg[i].ogg18,   #No:FUN-8B0021
                             g_ogb[l_ac].ogb04,l_ogg[i].ogg09,   #No:FUN-8B0021
                             l_ogg[i].ogg091,l_ogg[i].ogg092,
                             l_ogg[i].ogg10,l_ogg[i].ogg15,l_ogg[i].ogg15_fac,   #No:FUN-8B0021
                             l_ogg[i].ogg12,'','QRY')#CHI-9A0022 add ''
                   RETURNING l_r,g_qty
               IF l_r = "Y" THEN
                  LET l_ogg[i].ogg12 = g_qty
               END IF
            END IF
         END IF
      END DISPLAY 

   END IF
   CLOSE WINDOW t6006_w
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      RETURN
   END IF
END FUNCTION
FUNCTION t600_b_ogg()   # 庫存異動明細(ogg_file)輸入
  DEFINE r_ogg            RECORD LIKE ogg_file.*
  DEFINE r_ogc            RECORD LIKE ogc_file.*
  DEFINE l_ogg            DYNAMIC ARRAY OF RECORD
         ogg20            LIKE ogg_file.ogg20,    #MOD-940275 add
         #ogg12            LIKE ogg_file.ogg12,   #CHI-9C0024
         ogg09            LIKE ogg_file.ogg09,
         ogg091           LIKE ogg_file.ogg091,
         ogg092           LIKE ogg_file.ogg092,
         ogg12            LIKE ogg_file.ogg12,   #CHI-9C0024
         ogg10            LIKE ogg_file.ogg10,
         img10            LIKE type_file.num10,   #No.FUN-680137 INTEGER
         ogg15            LIKE ogg_file.ogg15,
         ogg15_fac        LIKE ogg_file.ogg15_fac,
         ogg16            LIKE ogg_file.ogg16,
         ogg18            LIKE ogg_file.ogg18     #No.FUN-8A0030    #No:FUN-8B0021
                          END RECORD
  DEFINE l_ogg12_t1       LIKE ogg_file.ogg12
  DEFINE l_ogg16_t1       LIKE ogg_file.ogg16
  DEFINE l_ogg12_t2       LIKE ogg_file.ogg12
  DEFINE l_ogg16_t2       LIKE ogg_file.ogg16
  DEFINE l_img21          LIKE img_file.img21
  DEFINE l_ima906         LIKE ima_file.ima906
  DEFINE l_img09          LIKE img_file.img09
  DEFINE i,j,s,l_i,k      LIKE type_file.num5,    #No.FUN-680137 SMALLINT
         l_allow_insert   LIKE type_file.num5,                #可新增否  #No.FUN-680137 SMALLINT
         l_allow_delete   LIKE type_file.num5                 #可刪除否  #No.FUN-680137 SMALLINT
   DEFINE l_ogg18      LIKE ogg_file.ogg18   #No:FUN-870131
  DEFINE l_pmd            LIKE type_file.chr1
  DEFINE l_msg            STRING
  DEFINE l_msg1           STRING
  DEFINE l_msg2           STRING
  DEFINE l_cnt            LIKE type_file.num5     #No:FUN-870007
  DEFINE l_bno            LIKE rvbs_file.rvbs08   #No.CHI-9A0022
  DEFINE l_oea00          LIKE oea_file.oea00,    #No.FUN-9C0103
         l_oea11          LIKE oea_file.oea11,    #No.FUN-9C0103
         l_oea12          LIKE oea_file.oea12,    #No.FUN-9C0103
         l_oga16          LIKE oga_file.oga16     #No.FUN-9C0103

    
   LET l_oea00 = ''   #FUN-9C0103
   LET l_oea11 = ''   #FUN-9C0103
   LET l_oea12 = ''   #FUN-9C0103
   LET l_oga16 = ''   #FUN-9C0103  
   IF g_ogb[l_ac].ogb17 IS NULL THEN RETURN END IF
   IF g_ogb[l_ac].ogb17 = 'N' THEN RETURN END IF

   SELECT COUNT(*) INTO i FROM ogg_file
    WHERE ogg01 = g_oga.oga01 AND ogg03 = g_ogb[l_ac].ogb03

   LET l_ogg18 = 0    #No:FUN-8B0021
   SELECT ima906 INTO l_ima906 FROM ima_file WHERE ima01=g_ogb[l_ac].ogb04
   IF i = 0 AND g_oaz.oaz71='1' THEN
      LET r_ogg.ogg01 = g_oga.oga01
      LET r_ogg.ogg03 = g_ogb[l_ac].ogb03
      LET r_ogg.ogg09 = g_ogb[l_ac].ogb09
      LET r_ogg.ogg091 = g_ogb[l_ac].ogb091
      LET r_ogg.ogg092 = g_ogb[l_ac].ogb092
      IF l_ima906 = '1' THEN
         SELECT img09 INTO r_ogg.ogg15 FROM img_file
          WHERE img01=g_ogb[l_ac].ogb04
            AND img02=g_ogb[l_ac].ogb09
            AND img03=g_ogb[l_ac].ogb091
            AND img04=g_ogb[l_ac].ogb092
         LET r_ogg.ogg10 = g_ogb[l_ac].ogb910
         LET r_ogg.ogg12 = g_ogb[l_ac].ogb912
         CALL s_umfchk(g_ogb[l_ac].ogb04,r_ogg.ogg10,r_ogg.ogg15)
              RETURNING g_cnt,r_ogg.ogg15_fac
         IF g_cnt=1 THEN LET r_ogg.ogg15_fac=1 END IF
         LET r_ogg.ogg16=g_ogb[l_ac].ogb912*r_ogg.ogg15_fac
         LET r_ogg.ogg20=1
         LET l_ogg18 = l_ogg18 + 1    #No:FUN-8B0021
         LET r_ogg.ogg18 = l_ogg18    #No:FUN-8B0021

         LET r_ogg.oggplant = g_plant 
         LET r_ogg.ogglegal = g_legal  

         INSERT INTO ogg_file VALUES (r_ogg.*)
      END IF
      IF l_ima906 ='2' THEN
         IF NOT cl_null(g_ogb[l_ac].ogb910) THEN
            LET r_ogg.ogg10=g_ogb[l_ac].ogb910
            LET r_ogg.ogg12=g_ogb[l_ac].ogb912
            LET r_ogg.ogg15=g_ogb[l_ac].ogb910
            LET r_ogg.ogg15_fac=1
            LET r_ogg.ogg16=g_ogb[l_ac].ogb912
            LET r_ogg.ogg20=1
            LET l_ogg18 = l_ogg18 + 1    #No:FUN-8B0021
            LET r_ogg.ogg18 = l_ogg18    #No:FUN-8B0021

            LET r_ogg.oggplant = g_plant 
            LET r_ogg.ogglegal = g_legal  

            INSERT INTO ogg_file VALUES (r_ogg.*)
         END IF
         IF NOT cl_null(g_ogb[l_ac].ogb913) THEN
            LET r_ogg.ogg10=g_ogb[l_ac].ogb913
            LET r_ogg.ogg12=g_ogb[l_ac].ogb915
            LET r_ogg.ogg15=g_ogb[l_ac].ogb913
            LET r_ogg.ogg15_fac=1
            LET r_ogg.ogg16=g_ogb[l_ac].ogb915
            LET r_ogg.ogg20=2
            LET l_ogg18 = l_ogg18 + 1    #No:FUN-8B0021
            LET r_ogg.ogg18 = l_ogg18    #No:FUN-8B0021

            LET r_ogg.oggplant = g_plant 
            LET r_ogg.ogglegal = g_legal  

            INSERT INTO ogg_file VALUES (r_ogg.*)
         END IF
      END IF
      IF l_ima906 ='3' THEN
         SELECT img09 INTO r_ogg.ogg15 FROM img_file
          WHERE img01=g_ogb[l_ac].ogb04
            AND img02=g_ogb[l_ac].ogb09
            AND img03=g_ogb[l_ac].ogb091
            AND img04=g_ogb[l_ac].ogb092
         LET r_ogg.ogg10 = g_ogb[l_ac].ogb910
         LET r_ogg.ogg12 = g_ogb[l_ac].ogb912
         CALL s_umfchk(g_ogb[l_ac].ogb04,r_ogg.ogg10,r_ogg.ogg15)
              RETURNING g_cnt,r_ogg.ogg15_fac
         IF g_cnt=1 THEN LET r_ogg.ogg15_fac=1 END IF
         LET r_ogg.ogg16=g_ogb[l_ac].ogb912*r_ogg.ogg15_fac
         LET r_ogg.ogg20=1
         LET l_ogg18 = l_ogg18 + 1    #No:FUN-8B0021
         LET r_ogg.ogg18 = l_ogg18    #No:FUN-8B0021

         LET r_ogg.oggplant = g_plant 
         LET r_ogg.ogglegal = g_legal  

         INSERT INTO ogg_file VALUES (r_ogg.*)
         LET r_ogg.ogg10=g_ogb[l_ac].ogb913
         LET r_ogg.ogg12=g_ogb[l_ac].ogb915
         LET r_ogg.ogg15=g_ogb[l_ac].ogb913
         LET r_ogg.ogg15_fac=1
         LET r_ogg.ogg16=g_ogb[l_ac].ogb915
         LET r_ogg.ogg20=2
         LET l_ogg18 = l_ogg18 + 1    #No:FUN-8B0021
         LET r_ogg.ogg18 = l_ogg18    #No:FUN-8B0021

         LET r_ogg.oggplant = g_plant 
         LET r_ogg.ogglegal = g_legal  

         INSERT INTO ogg_file VALUES (r_ogg.*)
      END IF
   END IF

   IF i = 0 AND g_oaz.oaz71='2' THEN
      IF l_ima906 = '1' THEN
         DECLARE t6006_c2_1 CURSOR FOR
          SELECT '','',img02,img03,img04,'',0,img09,0,0 FROM img_file
           WHERE img01 = g_ogb[l_ac].ogb04    #CHI-840009 mark AND img04 = g_ogb[l_ac].ogb092     
             AND img10 > 0 AND (img18 > g_oga.oga02 OR img18 IS NULL)

         FOREACH t6006_c2_1 INTO r_ogg.*
            IF STATUS THEN EXIT FOREACH END IF
            LET r_ogg.ogg01 = g_oga.oga01
            LET r_ogg.ogg03 = g_ogb[l_ac].ogb03
            LET r_ogg.ogg10 = g_ogb[l_ac].ogb910
            LET r_ogg.ogg20 = 1
            LET l_ogg18 = l_ogg18 + 1    #No:FUN-8B0021
            LET r_ogg.ogg18 = l_ogg18    #No:FUN-8B0021
            CALL s_umfchk(g_ogb[l_ac].ogb04,r_ogg.ogg10,r_ogg.ogg15)
                 RETURNING g_cnt,r_ogg.ogg15_fac
            IF g_cnt=1 THEN LET r_ogg.ogg15_fac=1 END IF

            LET r_ogg.oggplant = g_plant 
            LET r_ogg.ogglegal = g_legal  

            INSERT INTO ogg_file VALUES (r_ogg.*)
         END FOREACH
      END IF
      IF l_ima906 = '2' THEN
         DECLARE t6006_c2_2_1 CURSOR FOR
          SELECT '','',imgg02,imgg03,imgg04,imgg09,0,imgg09,0,0 FROM imgg_file
           WHERE imgg01 = g_ogb[l_ac].ogb04 #MOD-A20102 mark AND imgg04 = g_ogb[l_ac].ogb092
             AND imgg09 = g_ogb[l_ac].ogb910
             AND imgg10 > 0 AND (imgg18 > g_oga.oga02 OR imgg18 IS NULL)
         FOREACH t6006_c2_2_1 INTO r_ogg.*
            IF STATUS THEN EXIT FOREACH END IF
            LET r_ogg.ogg01 = g_oga.oga01
            LET r_ogg.ogg03 = g_ogb[l_ac].ogb03
            LET r_ogg.ogg15_fac = 1
            LET r_ogg.ogg20 = 1
            LET l_ogg18 = l_ogg18 + 1    #No:FUN-8B0021
            LET r_ogg.ogg18 = l_ogg18    #No:FUN-8B0021

            LET r_ogg.oggplant = g_plant 
            LET r_ogg.ogglegal = g_legal  

            INSERT INTO ogg_file VALUES (r_ogg.*)
         END FOREACH
         DECLARE t6006_c2_2_2 CURSOR FOR
          SELECT '','',imgg02,imgg03,imgg04,imgg09,0,imgg09,0,0 FROM imgg_file
           WHERE imgg01 = g_ogb[l_ac].ogb04 #MOD-A20102 mark AND imgg04 = g_ogb[l_ac].ogb092
             AND imgg09 = g_ogb[l_ac].ogb913
             AND imgg10 > 0 AND (imgg18 > g_oga.oga02 OR imgg18 IS NULL)
         FOREACH t6006_c2_2_2 INTO r_ogg.*
            IF STATUS THEN EXIT FOREACH END IF
            LET r_ogg.ogg01 = g_oga.oga01
            LET r_ogg.ogg03 = g_ogb[l_ac].ogb03
            LET r_ogg.ogg15_fac = 1
            LET r_ogg.ogg20 = 2
            LET l_ogg18 = l_ogg18 + 1    #No:FUN-8B0021
            LET r_ogg.ogg18 = l_ogg18    #No:FUN-8B0021

            LET r_ogg.oggplant = g_plant 
            LET r_ogg.ogglegal = g_legal  

            INSERT INTO ogg_file VALUES (r_ogg.*)
         END FOREACH
      END IF
      IF l_ima906 = '3' THEN
         DECLARE t6006_c2_3_1 CURSOR FOR
          SELECT '','',img02,img03,img04,'',0,img09,0,0 FROM img_file
           WHERE img01 = g_ogb[l_ac].ogb04 #MOD-A20102 mark AND img04 = g_ogb[l_ac].ogb092
             AND img10 > 0 AND (img18 > g_oga.oga02 OR img18 IS NULL)
         FOREACH t6006_c2_3_1 INTO r_ogg.*
            IF STATUS THEN EXIT FOREACH END IF
            LET r_ogg.ogg01 = g_oga.oga01
            LET r_ogg.ogg03 = g_ogb[l_ac].ogb03
            LET r_ogg.ogg10 = g_ogb[l_ac].ogb910
            CALL s_umfchk(g_ogb[l_ac].ogb04,r_ogg.ogg10,r_ogg.ogg15)
                 RETURNING g_cnt,r_ogg.ogg15_fac
            IF g_cnt=1 THEN LET r_ogg.ogg15_fac=1 END IF
            LET r_ogg.ogg20 = 1
            LET l_ogg18 = l_ogg18 + 1    #No:FUN-8B0021
            LET r_ogg.ogg18 = l_ogg18    #No:FUN-8B0021

            LET r_ogg.oggplant = g_plant 
            LET r_ogg.ogglegal = g_legal  

            INSERT INTO ogg_file VALUES (r_ogg.*)
         END FOREACH
         DECLARE t6006_c2_3_2 CURSOR FOR
          SELECT '','',imgg02,imgg03,imgg04,imgg09,0,imgg09,0,0 FROM imgg_file
           WHERE imgg01 = g_ogb[l_ac].ogb04 #MOD-A20102 mark AND imgg04 = g_ogb[l_ac].ogb092
             AND imgg09 = g_ogb[l_ac].ogb913
             AND imgg10 > 0 AND (imgg18 > g_oga.oga02 OR imgg18 IS NULL)
         FOREACH t6006_c2_3_2 INTO r_ogg.*
            IF STATUS THEN EXIT FOREACH END IF
            LET r_ogg.ogg01 = g_oga.oga01
            LET r_ogg.ogg03 = g_ogb[l_ac].ogb03
            LET r_ogg.ogg15_fac = 1
            LET r_ogg.ogg20 = 2
            LET l_ogg18 = l_ogg18 + 1    #No:FUN-8B0021
            LET r_ogg.ogg18 = l_ogg18    #No:FUN-8B0021

            LET r_ogg.oggplant = g_plant 
            LET r_ogg.ogglegal = g_legal  

            INSERT INTO ogg_file VALUES (r_ogg.*)
         END FOREACH
      END IF
   END IF


   OPEN WINDOW t6006_w AT 04,02 WITH FORM "axm/42f/axmt600e"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN

    CALL cl_ui_locale("axmt600e")

   IF g_sma.sma122 = '1' THEN
      CALL cl_getmsg('asm-303',g_lang) RETURNING l_msg1
      CALL cl_getmsg('asm-302',g_lang) RETURNING l_msg2
      LET l_msg = '1:',l_msg1 CLIPPED,',2:',l_msg2 CLIPPED
      CALL cl_set_combo_items('ogg20','1,2',l_msg)
   END IF

   IF g_sma.sma122 ='2' THEN
      CALL cl_getmsg('asm-326',g_lang) RETURNING l_msg1
      CALL cl_getmsg('asm-304',g_lang) RETURNING l_msg2
      LET l_msg = '1:',l_msg1 CLIPPED,',2:',l_msg2 CLIPPED
      CALL cl_set_combo_items('ogg20','1,2',l_msg)
   END IF

   DECLARE t6006_ogg_c CURSOR FOR
   #SELECT ogg20,ogg12,ogg09,ogg091,ogg092,ogg10,0,ogg15,ogg15_fac,ogg16,ogg18   #No:FUN-8B0021   #FUN-8A0030 Add '' #MOD-940275 move ogg20   #CHI-9C0024 move ogg12
    SELECT ogg20,ogg09,ogg091,ogg092,ogg12,ogg10,0,ogg15,ogg15_fac,ogg16,ogg18   #No:FUN-8B0021   #FUN-8A0030 Add '' #MOD-940275 move ogg20   #CHI-9C0024 move ogg12
      FROM ogg_file
     WHERE ogg01 = g_oga.oga01 AND ogg03 = g_ogb[l_ac].ogb03     
     ORDER BY ogg20      #MOD-940275 add

   CALL l_ogg.clear()

   LET i = 1
   FOREACH t6006_ogg_c INTO l_ogg[i].*
      IF STATUS THEN
         CALL cl_err('foreach ogg',STATUS,0)
         EXIT FOREACH
      END IF
      IF l_ima906 = '1' THEN
         SELECT img10 INTO l_ogg[i].img10 FROM img_file
          WHERE img01=g_ogb[l_ac].ogb04 AND img02=l_ogg[i].ogg09
            AND img03=l_ogg[i].ogg091   AND img04=l_ogg[i].ogg092
      END IF
      IF l_ima906 = '2' THEN
         SELECT imgg10 INTO l_ogg[i].img10 FROM imgg_file
          WHERE imgg01=g_ogb[l_ac].ogb04 AND imgg02=l_ogg[i].ogg09
            AND imgg03=l_ogg[i].ogg091   AND imgg04=l_ogg[i].ogg092
            AND imgg09=l_ogg[i].ogg10
      END IF
      IF l_ima906 = '3' THEN
         IF l_ogg[i].ogg20 = '2' THEN
            SELECT imgg10 INTO l_ogg[i].img10 FROM imgg_file
             WHERE imgg01=g_ogb[l_ac].ogb04 AND imgg02=l_ogg[i].ogg09
               AND imgg03=l_ogg[i].ogg091   AND imgg04=l_ogg[i].ogg092
               AND imgg09=l_ogg[i].ogg10
         ELSE
            SELECT img10 INTO l_ogg[i].img10 FROM img_file
             WHERE img01=g_ogb[l_ac].ogb04 AND img02=l_ogg[i].ogg09
               AND img03=l_ogg[i].ogg091   AND img04=l_ogg[i].ogg092
         END IF
      END IF
      IF cl_null(l_ogg[i].img10) THEN LET l_ogg[i].img10 = 0 END IF
      LET i = i + 1
   END FOREACH
   CALL l_ogg.deleteElement(i)
   LET l_i=i-1
   DISPLAY l_i TO cn2

   SELECT SUM(ogg12),SUM(ogg16) INTO l_ogg12_t1,l_ogg16_t1 FROM ogg_file
    WHERE ogg01 = g_oga.oga01 AND ogg03 = g_ogb[l_ac].ogb03
      AND ogg20 = '1'
   SELECT SUM(ogg12),SUM(ogg16) INTO l_ogg12_t2,l_ogg16_t2 FROM ogg_file
    WHERE ogg01 = g_oga.oga01 AND ogg03 = g_ogb[l_ac].ogb03
      AND ogg20 = '2'

   DISPLAY l_ogg12_t1 TO ogg12t_1
   DISPLAY l_ogg16_t1 TO ogg16t_1
   DISPLAY l_ogg12_t2 TO ogg12t_2
   DISPLAY l_ogg16_t2 TO ogg16t_2
   DISPLAY g_ogb[l_ac].ogb912 TO ogb12t_1   #No:MOD-590206
   DISPLAY g_ogb[l_ac].ogb915 TO ogb12t_2   #No:MOD-590206

   LET l_allow_insert = cl_detail_input_auth("insert")
   LET l_allow_delete = cl_detail_input_auth("delete")

   INPUT ARRAY l_ogg WITHOUT DEFAULTS FROM s_ogg.*
         ATTRIBUTE(COUNT=l_i,MAXCOUNT=g_max_rec,UNBUFFERED,
                   INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)

     BEFORE INPUT

     BEFORE ROW
        LET i=ARR_CURR()
        LET l_pmd = ''
        IF l_i < i THEN       
           LET l_ogg[i].ogg20 = '1'
           LET l_ogg[i].ogg10 = g_ogb[l_ac].ogb910
           LET l_pmd = 'a'
           DISPLAY l_ogg[i].ogg10 TO ogg10
           DISPLAY l_ogg[i].ogg20 TO ogg20
        ELSE
           IF cl_null(l_ogg[i].ogg18) OR l_ogg[i].ogg18 = 0 THEN   #No:FUN-8B0021
              SELECT MAX(ogg18)+1 INTO l_ogg[i].ogg18   #No:FUN-8B0021
                FROM ogg_file 
               WHERE ogg01 = g_oga.oga01
                 AND ogg03 = g_ogb[l_ac].ogb03
           END IF
           IF cl_null(l_ogg[i].ogg09) THEN
              LET l_ogg[i].ogg09 = g_ogb[l_ac].ogb09
           END IF
           IF l_ogg[i].ogg091 IS NULL THEN   #MOD-9C0141
              LET l_ogg[i].ogg091= g_ogb[l_ac].ogb091
           END IF
           IF l_ogg[i].ogg092 IS NULL THEN   #MOD-9C0141
              LET l_ogg[i].ogg092= g_ogb[l_ac].ogb092
           END IF
           NEXT FIELD ogg12
        END IF               #MOD-940275 add 

     AFTER FIELD ogg09
           #No.FUN-AA0048  --Begin
           #LET l_cnt =0                                                                                                            
           #SELECT COUNT(*) INTO l_cnt FROM imd_file                                                                                
           # WHERE imd01=l_ogg[i].ogg09                                                                                          
           #   AND imd20=g_plant                                                                                            
           #IF l_cnt=0 THEN                                                                                                         
           #   CALL cl_err(l_ogg[i].ogg09,'art-487',0)                                                                           
           #   NEXT FIELD ogg09                                                                                                      
           #END IF                 
           IF NOT s_chk_ware(l_ogg[i].ogg09) THEN
              NEXT FIELD ogg09 
           END IF
           #No.FUN-AA0048  --End  

      ON ACTION controlp
         CASE
            WHEN INFIELD(ogg09)
            IF g_azw.azw04='2' THEN 
               CALL q_img42(FALSE,FALSE,g_ogb[l_ac].ogb04,'','','','A','1',g_oga.ogaplant)                                     
                  RETURNING l_ogg[i].ogg09,l_ogg[i].ogg091,l_ogg[i].ogg092
            ELSE
               CALL q_img4(FALSE,FALSE,g_ogb[l_ac].ogb04,' ',' ',' ','A')
                        RETURNING l_ogg[i].ogg09,l_ogg[i].ogg091,
                                  l_ogg[i].ogg092
            END IF   #No.FUN-870007
               DISPLAY BY NAME l_ogg[i].ogg09,l_ogg[i].ogg091,l_ogg[i].ogg092         #No:MOD-490371
                NEXT FIELD ogg09
         END CASE

     AFTER INSERT 
       IF INT_FLAG THEN
          CALL cl_err('',9001,0)
          LET INT_FLAG = 0
          CANCEL INSERT
       END IF
       LET l_i = l_i + 1 

     AFTER FIELD ogg20
        IF l_pmd = 'a' THEN 
           IF l_ogg[i].ogg20 = '2' THEN
              LET l_ogg[i].ogg10 = g_ogb[l_ac].ogb913
           ELSE
              LET l_ogg[i].ogg10 = g_ogb[l_ac].ogb910
           END IF
           DISPLAY l_ogg[i].ogg10 TO ogg10
        END IF
      AFTER FIELD ogg12         
         LET g_ima918 = ''   #MOD-9C0055
         LET g_ima921 = ''   #MOD-9C0055
         SELECT ima918,ima921 INTO g_ima918,g_ima921
           FROM ima_file
          WHERE ima01 = g_ogb[l_ac].ogb04
            AND imaacti = "Y"

         IF (g_ima918 = "Y" OR g_ima921 = "Y") AND (l_ogg[i].ogg12<>0) THEN
           #IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add   #CHI-AC0034 mark
            #IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR g_argv0='8' OR g_argv0='9' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add   #CHI-AC0034 add '8','9'   #MOD-AC0060
            IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR g_argv0='8' OR g_argv0='9' OR g_argv0='A' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add   #CHI-AC0034 add '8','9'   #MOD-AC0060 add 'A'
               SELECT img09 INTO l_ogg[i].ogg15
                 FROM img_file
                WHERE img01 = g_ogb[l_ac].ogb04
                  AND img02 = l_ogg[i].ogg09
                  AND img03 = l_ogg[i].ogg091
                  AND img04 = l_ogg[i].ogg092
               
               DISPLAY l_ogg[i].ogg15 TO s_ogg[j].ogg15

               IF NOT cl_null(l_ogg[i].ogg15) THEN 
                  CALL s_umfchk(g_ogb[l_ac].ogb04,l_ogg[i].ogg10,l_ogg[i].ogg15)   #No:FUN-8B0021
                      RETURNING g_cnt,l_ogg[i].ogg15_fac
                  IF g_cnt=1 THEN
                     CALL cl_err('','mfg3075',1)
                     NEXT FIELD ogg092 
                  END IF
               END IF

               IF cl_null(l_ogg[i].ogg15_fac) THEN
                  LET l_ogg[i].ogg15_fac = 1
               END IF
 

#No.CHI-9A0022 --Begin
               IF cl_null(g_ogb[i].ogb41) THEN
                  #FUN-9C0103 ---start---
                  SELECT oea00,oea11,oea12 INTO l_oea00,l_oea11,l_oea12
                    FROM oea_file
                   WHERE oea01 = g_ogb[l_ac].ogb31
                  IF l_oea00 = '4' AND l_oea11 = '7' THEN
                     SELECT oga16 INTO l_oga16
                       FROM oga_file
                      WHERE oga01 = l_oea12
                     LET l_bno = l_oga16
                  ELSE
                  #FUN-9C0103 ---end---
                     LET l_bno = g_ogb[l_ac].ogb31
                  END IF 
               ELSE
                  LET l_bno = g_ogb[l_ac].ogb41
               END IF
#No.CHI-9A0022 --End
               CALL s_lotout(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,l_ogg[i].ogg18,   #No:FUN-8B0021
                             g_ogb[l_ac].ogb04,l_ogg[i].ogg09,   #No:FUN-8B0021
                             l_ogg[i].ogg091,l_ogg[i].ogg092,
                             l_ogg[i].ogg10,l_ogg[i].ogg15,l_ogg[i].ogg15_fac,   #No:FUN-8B0021
                             l_ogg[i].ogg12,l_bno,'MOD')#CHI-9A0022 add l_bno
                   RETURNING l_r,g_qty
               IF l_r = "Y" THEN
                  LET l_ogg[i].ogg12 = g_qty
               END IF
            END IF
         END IF

     AFTER ROW
        IF INT_FLAG THEN                 #900423
           CALL cl_err('',9001,0)
           LET INT_FLAG = 0
           EXIT INPUT
        END IF
        IF l_ogg[i].ogg12 IS NOT NULL AND l_ogg[i].ogg12 != 0 THEN
           IF l_ogg[i].ogg09 IS NULL THEN LET l_ogg[i].ogg09 = ' ' END IF
           IF l_ogg[i].ogg091 IS NULL THEN LET l_ogg[i].ogg091 = ' ' END IF
           IF l_ogg[i].ogg092 IS NULL THEN LET l_ogg[i].ogg092 = ' ' END IF
           IF l_ima906 = '1' THEN
              SELECT img10,img09,img21
                INTO l_ogg[i].img10,l_ogg[i].ogg15,l_img21
                FROM img_file
               WHERE img01 = g_ogb[l_ac].ogb04 AND img02 = l_ogg[i].ogg09
                 AND img03 = l_ogg[i].ogg091   AND img04 = l_ogg[i].ogg092
              IF STATUS THEN
                 CALL cl_err3("sel","img_file","","",SQLCA.sqlcode,"","sel img",1)  #No.FUN-670008
                 NEXT FIELD ogg09
              END IF
              CALL s_umfchk(g_ogb[l_ac].ogb04,l_ogg[i].ogg10,l_ogg[i].ogg15)
                            RETURNING g_cnt,l_ogg[i].ogg15_fac
              IF g_cnt=1 THEN CALL cl_err('','mfg3075',1) NEXT FIELD ogg092 END IF
              IF cl_null(l_ogg[i].ogg15_fac) THEN LET l_ogg[i].ogg15_fac=1 END IF
           END IF
           IF l_ima906 = '2' THEN
              SELECT imgg10,imgg09,imgg21
                INTO l_ogg[i].img10,l_ogg[i].ogg15,l_img21
                FROM imgg_file
               WHERE imgg01 = g_ogb[l_ac].ogb04 AND imgg02 = l_ogg[i].ogg09
                 AND imgg03 = l_ogg[i].ogg091   AND imgg04 = l_ogg[i].ogg092
                 AND imgg09 = l_ogg[i].ogg10
              IF STATUS THEN
                 CALL cl_err3("sel","imgg_file","","",SQLCA.sqlcode,"","sel imgg",1)  #No.FUN-670008
                 NEXT FIELD ogg09
              END IF
              LET l_ogg[i].ogg15_fac = 1
           END IF
           IF l_ima906 = '3' THEN
              IF l_ogg[i].ogg20 = '1' THEN
                 SELECT img10,img09,img21
                   INTO l_ogg[i].img10,l_ogg[i].ogg15,l_img21
                   FROM img_file
                  WHERE img01 = g_ogb[l_ac].ogb04 AND img02 = l_ogg[i].ogg09
                    AND img03 = l_ogg[i].ogg091   AND img04 = l_ogg[i].ogg092
                 IF STATUS THEN
                    CALL cl_err3("sel","img_file","","",SQLCA.sqlcode,"","sel img",1)  #No.FUN-670008
                    NEXT FIELD ogg09
                 END IF
                 CALL s_umfchk(g_ogb[l_ac].ogb04,l_ogg[i].ogg10,l_ogg[i].ogg15)
                               RETURNING g_cnt,l_ogg[i].ogg15_fac
                 IF g_cnt=1 THEN CALL cl_err('','mfg3075',1) NEXT FIELD ogg092 END IF
                 IF cl_null(l_ogg[i].ogg15_fac) THEN LET l_ogg[i].ogg15_fac=1 END IF
              END IF
              IF l_ogg[i].ogg20 = '2' THEN
                 SELECT imgg10,imgg09,imgg21
                   INTO l_ogg[i].img10,l_ogg[i].ogg15,l_img21
                   FROM imgg_file
                  WHERE imgg01 = g_ogb[l_ac].ogb04 AND imgg02 = l_ogg[i].ogg09
                    AND imgg03 = l_ogg[i].ogg091   AND imgg04 = l_ogg[i].ogg092
                    AND imgg09 = l_ogg[i].ogg10
                 IF STATUS THEN
                    CALL cl_err3("sel","imgg_file","","",SQLCA.sqlcode,"","sel imgg",1)  #No.FUN-670008
                    NEXT FIELD ogg09
                 END IF
                 LET l_ogg[i].ogg15_fac = 1
              END IF
           END IF
           DISPLAY l_ogg[i].img10 TO img10
           DISPLAY l_ogg[i].ogg15 TO ogg15
           LET l_ogg[i].ogg16 = l_ogg[i].ogg12 * l_ogg[i].ogg15_fac
           DISPLAY l_ogg[i].ogg16 TO s_ogg[j].ogg16
        END IF
        IF g_sma.sma117 = 'N' THEN
           #IF l_ogg[i].ogg12 > l_ogg[i].img10 THEN   #MOD-A70059
           IF l_ogg[i].ogg16 > l_ogg[i].img10 THEN   #MOD-A70059
              LET g_flag2 = NULL    #FUN-C80107 add
              CALL s_inv_shrt_by_warehouse(g_sma.sma894[2,2],l_ogg[i].ogg09) RETURNING g_flag2   #FUN-C80107 add
              #IF g_sma.sma894[2,2]='N' OR g_sma.sma894[2,2] IS NULL THEN    #FUN-C80107 mark
              IF g_flag2 = 'N' OR g_flag2 IS NULL THEN           #FUN-C80107 add
                 CALL cl_err(l_ogg[i].ogg12,'axm-280',1)
                 NEXT FIELD ogg12
              ELSE
                 IF NOT cl_confirm('mfg3469') THEN
                    NEXT FIELD ogg12
                 END IF
              END IF
           END IF
        END IF

        IF l_ogg[i].ogg12 IS NOT NULL AND l_ogg[i].ogg12 <> 0 THEN
           FOR k = 1 TO l_ogg.getLength()
              IF k=i THEN CONTINUE FOR END IF
              IF l_ogg[k].ogg09 = l_ogg[i].ogg09  AND
                 l_ogg[k].ogg091= l_ogg[i].ogg091 AND
                 l_ogg[k].ogg092= l_ogg[i].ogg092 AND
                 l_ogg[k].ogg20 = l_ogg[i].ogg20  AND
                 (l_ima906='1' OR l_ima906='3' AND l_ogg[i].ogg20=1) THEN
                 INITIALIZE l_ogg[i].* TO NULL
                 DISPLAY l_ogg[i].* TO s_ogg[j].*
                 CALL cl_err('',-239,0)
                 EXIT FOR
              END IF
              IF l_ogg[k].ogg09 = l_ogg[i].ogg09  AND
                 l_ogg[k].ogg091= l_ogg[i].ogg091 AND
                 l_ogg[k].ogg092= l_ogg[i].ogg092 AND
                 l_ogg[k].ogg10 = l_ogg[i].ogg10  AND
                 (l_ima906='2' OR l_ima906='3' AND l_ogg[i].ogg20=2) THEN
                 INITIALIZE l_ogg[i].* TO NULL
                 DISPLAY l_ogg[i].* TO s_ogg[j].*
                 CALL cl_err('',-239,0)
                 EXIT FOR
              END IF
           END FOR
        END IF

        LET l_ogg12_t1 = 0
        LET l_ogg16_t1 = 0
        LET l_ogg12_t2 = 0
        LET l_ogg16_t2 = 0
        FOR k = 1 TO l_ogg.getLength()
           IF l_ogg[k].ogg12 IS NOT NULL AND l_ogg[k].ogg12 <> 0 THEN
              IF l_ogg[k].ogg20 = '1' THEN
                 LET l_ogg12_t1 = l_ogg12_t1 + l_ogg[k].ogg12
                 LET l_ogg16_t1 = l_ogg16_t1 + l_ogg[k].ogg16
              END IF
              IF l_ogg[k].ogg20 = '2' THEN
                 LET l_ogg12_t2 = l_ogg12_t2 + l_ogg[k].ogg12
                 LET l_ogg16_t2 = l_ogg16_t2 + l_ogg[k].ogg16
              END IF
           END IF
        END FOR
        DISPLAY l_ogg12_t1 TO ogg12t_1
        DISPLAY l_ogg16_t1 TO ogg16t_1
        DISPLAY l_ogg12_t2 TO ogg12t_2
        DISPLAY l_ogg16_t2 TO ogg16t_2

     AFTER INPUT
        IF INT_FLAG THEN LET INT_FLAG = 0 EXIT INPUT END IF
        IF l_ogg12_t1 != g_ogb[l_ac].ogb912 OR l_ogg12_t2 != g_ogb[l_ac].ogb915 THEN
           IF cl_confirm('axm-170') THEN
              EXIT INPUT
           ELSE
              NEXT FIELD ogg09
           END IF
        END IF

      ON ACTION modi_lot        
         LET g_ima918 = ''   #MOD-9C0055
         LET g_ima921 = ''   #MOD-9C0055
         SELECT ima918,ima921 INTO g_ima918,g_ima921
           FROM ima_file
          WHERE ima01 = g_ogb[l_ac].ogb04
            AND imaacti = "Y"

         IF (g_ima918 = "Y" OR g_ima921 = "Y") AND (l_ogg[i].ogg12<>0) THEN
           #IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add   #CHI-AC0034 mark
            #IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR g_argv0='8' OR g_argv0='9' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add   #CHI-AC0034 add '8','9'   #MOD-AC0060
            IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR g_argv0='8' OR g_argv0='9' OR g_argv0='A' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add   #CHI-AC0034 add '8','9'   #MOD-AC0060 add 'A'
               SELECT img09 INTO l_ogg[i].ogg15
                 FROM img_file
                WHERE img01 = g_ogb[l_ac].ogb04
                  AND img02 = l_ogg[i].ogg09
                  AND img03 = l_ogg[i].ogg091
                  AND img04 = l_ogg[i].ogg092
               
               DISPLAY l_ogg[i].ogg15 TO s_ogg[j].ogg15

               IF NOT cl_null(l_ogg[i].ogg15) THEN 
                  CALL s_umfchk(g_ogb[l_ac].ogb04,l_ogg[i].ogg10,l_ogg[i].ogg15) 
                      RETURNING g_cnt,l_ogg[i].ogg15_fac
                  IF g_cnt=1 THEN
                     CALL cl_err('','mfg3075',1)
                     NEXT FIELD ogg092 
                  END IF
               END IF

               IF cl_null(l_ogg[i].ogg15_fac) THEN
                  LET l_ogg[i].ogg15_fac = 1
               END IF
 
#No.CHI-9A0022 --Begin
               IF cl_null(g_ogb[i].ogb41) THEN
                  #FUN-9C0103 ---start---
                  SELECT oea00,oea11,oea12 INTO l_oea00,l_oea11,l_oea12
                    FROM oea_file
                   WHERE oea01 = g_ogb[l_ac].ogb31
                  IF l_oea00 = '4' AND l_oea11 = '7' THEN
                     SELECT oga16 INTO l_oga16
                       FROM oga_file
                      WHERE oga01 = l_oea12
                     LET l_bno = l_oga16
                  ELSE
                  #FUN-9C0103 ---end---
                     LET l_bno = g_ogb[l_ac].ogb31
                  END IF 
               ELSE
                  LET l_bno = g_ogb[l_ac].ogb41
               END IF
#No.CHI-9A0022 --End
               CALL s_lotout(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,l_ogg[i].ogg18,
                             g_ogb[l_ac].ogb04,l_ogg[i].ogg09,
                             l_ogg[i].ogg091,l_ogg[i].ogg092,
                             l_ogg[i].ogg10,l_ogg[i].ogg15,l_ogg[i].ogg15_fac, 
                             l_ogg[i].ogg12,l_bno,'MOD')#CHI-9A0022 add l_bno
                   RETURNING l_r,g_qty
               IF l_r = "Y" THEN
                  LET l_ogg[i].ogg12 = g_qty
               END IF
            END IF
         END IF

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT

      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121

      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121

      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121


   END INPUT

   IF INT_FLAG THEN
      CALL cl_err('',9001,0)
      LET INT_FLAG = 0
      CLOSE WINDOW t6006_w
      RETURN
   END IF

   CLOSE WINDOW t6006_w

   LET g_success ='Y'

   BEGIN WORK

   DELETE FROM ogg_file
    WHERE ogg01 = g_oga.oga01
      AND ogg03 = g_ogb[l_ac].ogb03
   IF SQLCA.sqlcode THEN
      CALL cl_err3("del","ogg_file",g_oga.oga01,g_ogb[l_ac].ogb03,SQLCA.sqlcode,"","del_ogg",1)  #No.FUN-670008
      ROLLBACK WORK RETURN
   END IF
   DELETE FROM ogc_file
    WHERE ogc01 = g_oga.oga01
      AND ogc03 = g_ogb[l_ac].ogb03
   IF SQLCA.sqlcode THEN
      CALL cl_err3("del","ogc_file",g_oga.oga01,g_ogb[l_ac].ogb03,SQLCA.sqlcode,"","del_ogc",1)  #No.FUN-670008
      ROLLBACK WORK RETURN
   END IF
   CALL s_showmsg_init()              #No.FUN-710046
   FOR i = 1 TO l_ogg.getLength()
     IF g_success = "N" THEN
        LET g_totsuccess = "N"
        LET g_success = "Y"
     END IF
       IF l_ogg[i].ogg12 IS NULL OR l_ogg[i].ogg12=0 THEN        
          IF s_lotout_del(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,l_ogg[i].ogg18,g_ogb[l_ac].ogb04,'DEL') THEN   #No:FUN-8A0050 Mark
             CONTINUE FOR
          END IF
       END IF
       INSERT INTO ogg_file(ogg01,ogg03,ogg09,ogg091,ogg092,ogg10,
                            ogg12,ogg15,ogg15_fac,ogg16,ogg20,ogg18,   #No:FUN-8B0021
                            oggplant,ogglegal)  #FUN-980010 add plant & legal 
                     VALUES(g_oga.oga01,g_ogb[l_ac].ogb03,
                            l_ogg[i].ogg09, l_ogg[i].ogg091,
                            l_ogg[i].ogg092,l_ogg[i].ogg10,
                            l_ogg[i].ogg12, l_ogg[i].ogg15,
                            l_ogg[i].ogg15_fac,l_ogg[i].ogg16,
                            l_ogg[i].ogg20,l_ogg[i].ogg18,   #No:FUN-8B0021
                            g_plant,g_legal) 
       IF SQLCA.sqlcode THEN
          CALL s_errmsg("ogg01",g_oga.oga01,"INS ogg_file",SQLCA.sqlcode,1)   #No.FUN-710046
          LET g_success = 'N'
          CONTINUE FOR #No.FUN-710046
       END IF
       INITIALIZE r_ogc.* TO NULL
       LET r_ogc.ogc01 =g_oga.oga01
       LET r_ogc.ogc03 =g_ogb[l_ac].ogb03
       LET r_ogc.ogc09 =l_ogg[i].ogg09
       LET r_ogc.ogc091=l_ogg[i].ogg091
       LET r_ogc.ogc092=l_ogg[i].ogg092
       LET r_ogc.ogc18 =l_ogg[i].ogg18    #No:FUN-8B0021     #FUN-8A0030 Add
       SELECT img09 INTO l_img09 FROM img_file
        WHERE img01=g_ogb[l_ac].ogb04
          AND img02=r_ogc.ogc09
          AND img03=r_ogc.ogc091
          AND img04=r_ogc.ogc092
       IF l_ima906 = '1' THEN
          LET g_factor = 1
          LET r_ogc.ogc12=l_ogg[i].ogg12#*g_factor
          LET r_ogc.ogc15=l_img09
          LET r_ogc.ogc15_fac=l_ogg[i].ogg15_fac
          LET r_ogc.ogc16=r_ogc.ogc12*r_ogc.ogc15_fac
          LET r_ogc.ogc17=g_ogb[l_ac].ogb04   #MOD-970149
           IF cl_null(r_ogc.ogc01) THEN LET r_ogc.ogc01=' ' END IF
           IF cl_null(r_ogc.ogc03) THEN LET r_ogc.ogc03=0 END IF
           IF cl_null(r_ogc.ogc09) THEN LET r_ogc.ogc09=' ' END IF
           IF cl_null(r_ogc.ogc091) THEN LET r_ogc.ogc091=' ' END IF
           IF cl_null(r_ogc.ogc092) THEN LET r_ogc.ogc092=' ' END IF
           IF cl_null(r_ogc.ogc17) THEN LET r_ogc.ogc17=' ' END IF
          LET r_ogc.ogc18 = l_ogg[i].ogg18   #No:FUN-8B0021

          LET r_ogc.ogcplant = g_plant 
          LET r_ogc.ogclegal = g_legal  

          INSERT INTO ogc_file VALUES(r_ogc.*)
          IF SQLCA.sqlcode THEN
             CALL s_errmsg('','',"INS ogc_file",SQLCA.sqlcode,1)                   #No.FUN-710046
             LET g_success = 'N'
             CONTINUE FOR         #No.FUN-710046
          END IF
       END IF
       IF l_ima906 = '2' THEN
          LET g_factor = 1
          CALL s_umfchk(g_ogb[l_ac].ogb04,l_ogg[i].ogg10,g_ogb[l_ac].ogb05)
                        RETURNING g_cnt,g_factor
          IF g_cnt=1 THEN LET g_factor = 1 END IF
          LET r_ogc.ogc12=l_ogg[i].ogg12*g_factor
          LET g_factor = 1
          CALL s_umfchk(g_ogb[l_ac].ogb04,l_ogg[i].ogg10,l_img09)
                        RETURNING g_cnt,g_factor
          IF g_cnt=1 THEN LET g_factor = 1 END IF
          LET r_ogc.ogc15=l_img09
          LET r_ogc.ogc15_fac = 1
          LET r_ogc.ogc16=l_ogg[i].ogg12*g_factor
          LET r_ogc.ogc17=g_ogb[l_ac].ogb04   #MOD-970149
           IF cl_null(r_ogc.ogc01) THEN LET r_ogc.ogc01=' ' END IF
           IF cl_null(r_ogc.ogc03) THEN LET r_ogc.ogc03=0 END IF
           IF cl_null(r_ogc.ogc09) THEN LET r_ogc.ogc09=' ' END IF
           IF cl_null(r_ogc.ogc091) THEN LET r_ogc.ogc091=' ' END IF
           IF cl_null(r_ogc.ogc092) THEN LET r_ogc.ogc092=' ' END IF
           IF cl_null(r_ogc.ogc17) THEN LET r_ogc.ogc17=' ' END IF
          LET r_ogc.ogc18 = l_ogg[i].ogg18   #No:FUN-8B0021

          LET r_ogc.ogcplant = g_plant 
          LET r_ogc.ogclegal = g_legal  

          INSERT INTO ogc_file VALUES(r_ogc.*)
          IF SQLCA.sqlcode THEN
             IF cl_sql_dup_value(SQLCA.SQLCODE) THEN
                UPDATE ogc_file SET ogc12=ogc12+r_ogc.ogc12,
                                    ogc16=ogc16+r_ogc.ogc16
                 WHERE ogc01 =g_oga.oga01
                   AND ogc03 =g_ogb[l_ac].ogb03
                   AND ogc09 =l_ogg[i].ogg09
                   AND ogc091=l_ogg[i].ogg091
                   AND ogc092=l_ogg[i].ogg092
                IF SQLCA.sqlcode THEN
                   LET g_showmsg=g_oga.oga01,"/",g_ogb[l_ac].ogb03,"/",l_ogg[i].ogg09,"/",l_ogg[i].ogg091,"/",l_ogg[i].ogg092 #No.FUN-710046
                   CALL s_errmsg("ogc01,ogc03,ogc09,ogc091,ogc092",g_showmsg,"UPD ogc_file",SQLCA.sqlcode,1)   #No.FUN-710046
                   LET g_success = 'N'
                   CONTINUE FOR  #No.FUN-710046
                END IF
             ELSE
                CALL s_errmsg('','',"INS ogc:",SQLCA.sqlcode,1)  #No.FUN-710046
                LET g_success = 'N'
                CONTINUE FOR            #No.FUN-710046
             END IF
          END IF
       END IF
       IF l_ima906 = '3' THEN
          IF l_ogg[i].ogg20 = '1' THEN
             LET g_factor = 1
             LET r_ogc.ogc12=l_ogg[i].ogg12#*g_factor
             LET r_ogc.ogc15=l_img09
             LET r_ogc.ogc15_fac=l_ogg[i].ogg15_fac
             LET r_ogc.ogc16=r_ogc.ogc12*r_ogc.ogc15_fac
             LET r_ogc.ogc17=g_ogb[l_ac].ogb04   #MOD-970149
           IF cl_null(r_ogc.ogc01) THEN LET r_ogc.ogc01=' ' END IF
           IF cl_null(r_ogc.ogc03) THEN LET r_ogc.ogc03=0 END IF
           IF cl_null(r_ogc.ogc09) THEN LET r_ogc.ogc09=' ' END IF
           IF cl_null(r_ogc.ogc091) THEN LET r_ogc.ogc091=' ' END IF
           IF cl_null(r_ogc.ogc092) THEN LET r_ogc.ogc092=' ' END IF
           IF cl_null(r_ogc.ogc17) THEN LET r_ogc.ogc17=' ' END IF
          LET r_ogc.ogc18 = l_ogg[i].ogg18   #No:FUN-8B0021

             LET r_ogc.ogcplant = g_plant 
             LET r_ogc.ogclegal = g_legal  

             INSERT INTO ogc_file VALUES(r_ogc.*)
             IF SQLCA.sqlcode THEN
                CALL s_errmsg('','',"INS ogc:",SQLCA.sqlcode,1)         #No.FUN-710046
                LET g_success = 'N'
                CONTINUE FOR              #No.FUN-710046
             END IF
          END IF
       END IF
    END FOR

     IF g_totsuccess="N" THEN
        LET g_success="N"
     END IF
     CALL s_showmsg()
    IF g_success='Y' THEN
       COMMIT WORK
    ELSE
       ROLLBACK WORK
    END IF

END FUNCTION

FUNCTION t600_b_ogd_1()   # 庫存異動明細(ogc_file)輸入
   DEFINE l_ogc      DYNAMIC ARRAY OF RECORD
                         ogc17     LIKE ogc_file.ogc17,
                         #ogc12     LIKE ogc_file.ogc12,   #CHI-9C0024
                         ogc09     LIKE ogc_file.ogc09,
                         ogc091    LIKE ogc_file.ogc091,
                         ogc092    LIKE ogc_file.ogc092,
                         ogc12     LIKE ogc_file.ogc12,   #CHI-9C0024
                         img10     LIKE img_file.img10, #MOD-530713
                         ogc15     LIKE ogc_file.ogc15,
                         ogc15_fac LIKE ogc_file.ogc15_fac,
                         ogc16     LIKE ogc_file.ogc16,
                         ogc18     LIKE ogc_file.ogc18   #No:FUN-8A0030 
                       END RECORD
   DEFINE l_n          LIKE type_file.num5    #No.FUN-680137 SMALLINT
   DEFINE l_ogc12_t    LIKE ogc_file.ogc12
   DEFINE l_ogc16_t    LIKE ogc_file.ogc16
   DEFINE l_img21      LIKE img_file.img21
   DEFINE l_date       LIKE type_file.dat     #No.FUN-680137 DATE
   DEFINE l_ogc17_t    LIKE ogc_file.ogc17
   DEFINE i,k,s,l_i    LIKE type_file.num5,    #No.FUN-680137 SMALLINT
          l_allow_insert   LIKE type_file.num5,                #可新增否  #No.FUN-680137 SMALLINT
          l_allow_delete   LIKE type_file.num5                 #可刪除否  #No.FUN-680137 SMALLINT
   DEFINE l_ocl01      LIKE ocl_file.ocl01
   DEFINE l_ocm01      LIKE ocm_file.ocm01

   LET p_row = 2 LET p_col = 2
   OPEN WINDOW t600b_w AT p_row,p_col WITH FORM "axm/42f/axmt600b"
         ATTRIBUTE (STYLE = g_win_style CLIPPED)

   CALL cl_ui_locale("axmt600b")
   IF g_oaz.oaz42 = '2' THEN
      CALL cl_getmsg('axm-041',g_lang) RETURNING g_msg
      CALL cl_set_comp_att_text("a",g_msg CLIPPED)
   END IF

   LET l_date = g_today


   DISPLAY l_date TO FORMONLY.b

   LET l_date = g_today

   DECLARE t600b_c_1 CURSOR FOR
          #SELECT ogc17,ogc12,ogc09,ogc091,ogc092,img10,ogc15,ogc15_fac,ogc16,ogc18   #No:FUN-8A0030 Add ogc18   #CHI-9C0024 move ogc12
           SELECT ogc17,ogc09,ogc091,ogc092,ogc12,img10,ogc15,ogc15_fac,ogc16,ogc18   #No:FUN-8A0030 Add ogc18   #CHI-9C0024 move ogc12
             FROM ogc_file, OUTER img_file
            WHERE ogc01 = g_oga.oga01 AND ogc03 = g_ogb[l_ac].ogb03
              AND img01=ogc17
              AND img02=ogc09
              AND img03=ogc091
              AND img04=ogc092

   CALL l_ogc.clear()

   LET i = 1

   LET l_i = 1

   FOREACH t600b_c_1 INTO l_ogc[i].*
      IF STATUS THEN 
         CALL cl_err('foreach ogc',STATUS,0) 
         EXIT FOREACH 
      END IF

      LET i = i + 1

   END FOREACH

   CALL l_ogc.deleteElement(i)

   LET l_i=(i-1)

   SELECT SUM(ogc12),SUM(ogc16) 
     INTO l_ogc12_t,l_ogc16_t FROM ogc_file
    WHERE ogc01 = g_oga.oga01
      AND ogc03 = g_ogb[l_ac].ogb03

   DISPLAY l_i TO cn2

   DISPLAY l_ogc12_t TO ogc12t

   DISPLAY l_ogc16_t TO ogc16t

   DISPLAY g_ogb[l_ac].ogb12 TO ogb12t   #No:MOD-590206

   CALL cl_set_act_visible("cancel", FALSE)
   
   LET i = ARR_CURR()               #No:FUN-8A0030
 
   IF g_action_choice="qry_mntn_inv_detail" THEN
      DISPLAY ARRAY l_ogc TO s_ogc.* ATTRIBUTE(COUNT=g_rec_b1,UNBUFFERED)     #No.TQC-640123

      BEFORE ROW 
        LET i=ARR_CURR()
 
         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE DISPLAY
        
         ON ACTION about         
            CALL cl_about()      
        
         ON ACTION help          
            CALL cl_show_help()  
        
         ON ACTION controlg      
            CALL cl_cmdask()
           
         ON ACTION qry_lot
            LET g_ima918 = ''   #MOD-9C0055
            LET g_ima921 = ''   #MOD-9C0055
            SELECT ima918,ima921 INTO g_ima918,g_ima921
              FROM ima_file
             WHERE ima01 = l_ogc[i].ogc17   #No:FUN-8B0021
               AND imaacti = "Y"
         
            IF g_ima918 = "Y" OR g_ima921 = "Y" THEN
              #IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add #CHI-AC0034 mark
               #IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR g_argv0='8' OR g_argv0='9' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add #CHI-AC0034 add '8','9'   #MOD-AC0060 
               IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR g_argv0='8' OR g_argv0='9' OR g_argv0='A' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add #CHI-AC0034 add '8','9'   #MOD-AC0060 add 'A'
                  CALL s_lotout(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,l_ogc[i].ogc18,
                                l_ogc[i].ogc17,l_ogc[i].ogc09,
                                l_ogc[i].ogc091,l_ogc[i].ogc092,
                                g_ogb[l_ac].ogb05,l_ogc[i].ogc15,l_ogc[i].ogc15_fac,
                                l_ogc[i].ogc12,'','QRY')#CHI-9A0022 add ''
                      RETURNING l_r,g_qty
                  IF l_r = "Y" THEN
                     LET l_ogc[i].ogc12 = g_qty
                  END IF
               END IF
            END IF

      END DISPLAY 

   END IF

   CLOSE WINDOW t600b_w

   IF INT_FLAG THEN
      LET INT_FLAG = 0
      RETURN
   END IF

END FUNCTION

FUNCTION t600_ogd_ogc()
   DEFINE r_ogc        RECORD LIKE ogc_file.*
   DEFINE i            LIKE type_file.num5
   DEFINE l_ogc18      LIKE ogc_file.ogc18   #No:FUN-8A0030

   SELECT COUNT(*) INTO i FROM ogc_file
    WHERE ogc01 = g_oga.oga01 AND ogc03 = g_ogb[l_ac].ogb03

   IF i = 0 AND g_oaz.oaz71='1' THEN  #與產品項次相同
      LET r_ogc.ogc01 = g_oga.oga01
      LET r_ogc.ogc03 = b_ogb.ogb03         #CHI-690060
      LET r_ogc.ogc12 = b_ogb.ogb12
      LET r_ogc.ogc09 = b_ogb.ogb09
      LET r_ogc.ogc091= b_ogb.ogb091
      LET r_ogc.ogc092= b_ogb.ogb092
      LET r_ogc.ogc15 = b_ogb.ogb15
      LET r_ogc.ogc15_fac = b_ogb.ogb15_fac
      LET r_ogc.ogc16 = b_ogb.ogb16
      LET r_ogc.ogc17 = b_ogb.ogb04         #CHI-690060
      LET r_ogc.ogc18 = 1                   #No:FUN-8A0030
           IF cl_null(r_ogc.ogc01) THEN LET r_ogc.ogc01=' ' END IF
           IF cl_null(r_ogc.ogc03) THEN LET r_ogc.ogc03=0 END IF
           IF cl_null(r_ogc.ogc09) THEN LET r_ogc.ogc09=' ' END IF
           IF cl_null(r_ogc.ogc091) THEN LET r_ogc.ogc091=' ' END IF
           IF cl_null(r_ogc.ogc092) THEN LET r_ogc.ogc092=' ' END IF
           IF cl_null(r_ogc.ogc17) THEN LET r_ogc.ogc17=' ' END IF

      LET r_ogc.ogcplant = g_plant 
      LET r_ogc.ogclegal = g_legal  

      INSERT INTO ogc_file VALUES (r_ogc.*)
   END IF
   IF i = 0 AND g_oaz.oaz71='2' THEN   #由 img_gile 預設
      DECLARE t6006_c3 CURSOR FOR
         SELECT '','',img02,img03,img04,0,img09,0,0,'','' FROM img_file                            #FUN-8A0030 Add '',''
          WHERE img01 = g_ogb[l_ac].ogb04    #CHI-840009 mark AND img04 = g_ogb[l_ac].ogb092     
            AND img10 > 0 AND (img18 > g_oga.oga02 OR img18 IS NULL)
         LET l_ogc18 = 0    #No:FUN-8A0030      
      FOREACH t6006_c3 INTO r_ogc.*
         IF STATUS THEN EXIT FOREACH END IF
         LET r_ogc.ogc01 = g_oga.oga01
         LET r_ogc.ogc03 = g_ogb[l_ac].ogb03
         LET r_ogc.ogc17 = g_ogb[l_ac].ogb04
         LET l_ogc18 = l_ogc18 + 1    #No:FUN-8A0030
         LET r_ogc.ogc18 = l_ogc18    #No:FUN-8A0030

         LET r_ogc.ogcplant = g_plant 
         LET r_ogc.ogclegal = g_legal  

         INSERT INTO ogc_file VALUES (r_ogc.*)
      END FOREACH
   END IF
END FUNCTION

FUNCTION t600_1()
   DEFINE  l_oap   RECORD LIKE oap_file.*
   DEFINE  l_ogb31 LIKE ogb_file.ogb31 #MOD-940231	
   DEFINE  l_oea32 LIKE oea_file.oea32 #MOD-940231	
   DEFINE l_n     LIKE type_file.num5   #MOD-950276
   DEFINE  l_cnt   LIKE type_file.num5 #FUN-970108
   
    BEGIN WORK

    OPEN t600_cl USING g_oga.oga01
    IF STATUS THEN
       CALL cl_err("OPEN t600_cl:", STATUS, 1)
       CLOSE t600_cl
       ROLLBACK WORK
       RETURN
    END IF

    FETCH t600_cl INTO g_oga.*  # 鎖住將被更改或取消的資料
    IF SQLCA.sqlcode THEN
       CALL cl_err(g_oga.oga01,SQLCA.sqlcode,0)     # 資料被他人LOCK
       CLOSE t600_cl
       ROLLBACK WORK
       RETURN
    END IF

    IF g_oga.oga01 IS NULL THEN 
       CLOSE t600_cl   #MOD-970012
       ROLLBACK WORK   #MOD-970012
       RETURN 
    END IF
    LET g_oga_t.* = g_oga.* #MOD-640570 add
    LET g_oga_o.* = g_oga.* #MOD-9C0105 

    LET p_row = 2 LET p_col = 11


    OPEN WINDOW t6001_w AT p_row,p_col WITH FORM "axm/42f/axmt6001"
          ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN

    CALL cl_ui_locale("axmt6001")


    CALL s_addr(g_oga.oga01,g_oga.oga04,g_oga.oga044)
         RETURNING l_oap.oap041,
                   l_oap.oap042,
                   l_oap.oap043,
                   l_oap.oap044,   #FUN-720014 add
                   l_oap.oap045    #FUN-720014 add

    LET g_buf=NULL
    SELECT oac02 INTO g_buf FROM oac_file WHERE oac01=g_oga.oga41
                            DISPLAY g_buf TO oac02 LET g_buf=NULL
    SELECT oac02 INTO g_buf FROM oac_file WHERE oac01=g_oga.oga42
                            DISPLAY g_buf TO oac02_2 LET g_buf=NULL
    SELECT oah02 INTO g_buf FROM oah_file WHERE oah01=g_oga.oga31
                            DISPLAY g_buf TO oah02 LET g_buf=NULL
    SELECT oag02 INTO g_buf FROM oag_file WHERE oag01=g_oga.oga32
                            DISPLAY g_buf TO oag02 LET g_buf=NULL
    SELECT ged02 INTO g_buf FROM ged_file WHERE ged01=g_oga.oga43      #FUN-990074                                                  
                            DISPLAY g_buf TO oga43_desc LET g_buf=NULL #FUN-990074  
    LET g_action_choice="modify"
    IF NOT cl_chk_act_auth() THEN
       DISPLAY BY NAME g_oga.oga044,l_oap.oap041,l_oap.oap042,l_oap.oap043,
                       l_oap.oap044,l_oap.oap045,   #MOD-910186 增加oap044/oap045
                       g_oga.oga41,g_oga.oga42,g_oga.oga43,g_oga.oga44,
                       g_oga.oga31,g_oga.oga32,g_oga.oga33,g_oga.oga47,
                      #g_oga.oga48,g_oga.oga35,g_oga.oga36,g_oga.oga37,                         #FUN-5B0066 mark
                       g_oga.oga48,g_oga.oga49,g_oga.oga021,g_oga.oga35,g_oga.oga36,g_oga.oga37,#FUN-5B0066 #No.FUN-860002 add g_oga.oga49
                       g_oga.oga38,g_oga.oga39,g_oga.oga910,g_oga.oga911,  #No:MOD-560183
                       g_oga.oga71   #FUN-970108
       LET INT_FLAG = 0  ######add for prompt bug
       PROMPT ">" FOR CHAR g_chr
          ON IDLE g_idle_seconds
             CALL cl_on_idle()

          ON ACTION about         #MOD-4C0121
             CALL cl_about()      #MOD-4C0121

          ON ACTION help          #MOD-4C0121
             CALL cl_show_help()  #MOD-4C0121

          ON ACTION controlg      #MOD-4C0121
             CALL cl_cmdask()     #MOD-4C0121

       END PROMPT
       CLOSE WINDOW t6001_w
       CLOSE t600_cl   #MOD-970012
       ROLLBACK WORK   #MOD-970012
       RETURN
    END IF

     DISPLAY BY NAME g_oga.oga910,g_oga.oga911   #No:MOD-560183

    INPUT BY NAME g_oga.oga044,l_oap.oap041,l_oap.oap042,l_oap.oap043,
                  l_oap.oap044,l_oap.oap045,   #MOD-910186 增加oap044/oap045
                  g_oga.oga41,g_oga.oga42,g_oga.oga43,g_oga.oga44,
                  g_oga.oga31,g_oga.oga32,g_oga.oga33,g_oga.oga47,
                  g_oga.oga48,g_oga.oga49,                               #No.FUN-860002 add g_oga.oga49
                  g_oga.oga021,   #FUN-5B0066
                  g_oga.oga35,g_oga.oga36,g_oga.oga37,g_oga.oga38,g_oga.oga39,
                  g_oga.oga71,     #FUN-970108
                  g_oga.oga910,g_oga.oga911   #MOD-950276
          WITHOUT DEFAULTS

      BEFORE INPUT
         LET g_before_input_done = FALSE
         CALL t600_set_no_required()  #FUN-970108 
         CALL t600_set_required()     #FUN-970108
         LET g_before_input_done = TRUE

      BEFORE FIELD oga044
         CALL t600_set_entry_1()

      AFTER FIELD oga044
         IF NOT cl_null(g_oga.oga044) THEN
            IF g_oga.oga044[1,4] !='MISC' THEN
               SELECT ocd221,ocd222,ocd223,ocd230,ocd231   #MOD-910186 增加ocd230/ocd231
                 INTO l_oap.oap041,l_oap.oap042,l_oap.oap043,l_oap.oap044,l_oap.oap045 FROM ocd_file   #MOD-910186 增加oap044/oap045
                WHERE ocd01=g_oga.oga04 AND ocd02=g_oga.oga044
               IF STATUS THEN
                  CALL cl_err3("sel","ocd_file",g_oga.oga04,g_oga.oga044,SQLCA.sqlcode,"","",1)  #No.FUN-670008
                  NEXT FIELD oga044
               END IF
            END IF
         ELSE
            SELECT occ241,occ242,occ243,occ244,occ245    
              INTO l_oap.oap041,l_oap.oap042,l_oap.oap043,l_oap.oap044,l_oap.oap045 FROM occ_file
             WHERE occ01=g_oga.oga04
         END IF
         DISPLAY BY NAME l_oap.oap041,l_oap.oap042,l_oap.oap043,
                         l_oap.oap044,l_oap.oap045   #MOD-910186 增加oap044/oap045
         IF g_oga.oga044[1,4] ='MISC' THEN
            LET g_chr='Y'
         END IF
         CALL t600_set_no_entry_1()

      AFTER FIELD oga43
         IF NOT cl_null(g_oga.oga43) THEN
            SELECT ged02 INTO g_buf FROM ged_file WHERE ged01 = g_oga.oga43 #FUN-990074  
            IF STATUS THEN
               CALL cl_err3("sel","ged_file",g_oga.oga43,"",SQLCA.sqlcode,"","",1)  #No.FUN-670008
               NEXT FIELD oga43
            END IF
            DISPLAY g_buf TO oga43_desc #FUN-990074    
         END IF

      AFTER FIELD oga41
         IF NOT cl_null(g_oga.oga41) THEN
            SELECT oac02 INTO g_buf FROM oac_file WHERE oac01=g_oga.oga41
            IF STATUS THEN
               CALL cl_err3("sel","oac_file",g_oga.oga41,"",SQLCA.sqlcode,"","sel oac:",1)  #No.FUN-670008
               NEXT FIELD oga41
            END IF
            DISPLAY g_buf TO oac02
         END IF

      AFTER FIELD oga42
         IF NOT cl_null(g_oga.oga42) THEN
            SELECT oac02 INTO g_buf FROM oac_file WHERE oac01=g_oga.oga42
            IF STATUS THEN
               CALL cl_err3("sel","oac_file",g_oga.oga42,"",SQLCA.sqlcode,"","sel oac:",1)  #No.FUN-670008
               NEXT FIELD oga42
            END IF
            DISPLAY g_buf TO oac02_2
         END IF

      AFTER FIELD oga44
         IF NOT cl_null(g_oga.oga44) THEN
            SELECT ocf02 INTO g_buf FROM ocf_file
                   WHERE ocf01=g_oga.oga04 AND ocf02=g_oga.oga44
            IF STATUS THEN
               CALL cl_err3("sel","ocf_file",g_oga.oga04,g_oga.oga44,SQLCA.sqlcode,"","sel ocf:",1)  #No.FUN-670008
               NEXT FIELD oga44
            END IF
         END IF

      AFTER FIELD oga31
         IF NOT cl_null(g_oga.oga31) THEN
            SELECT oah02 INTO g_buf FROM oah_file WHERE oah01=g_oga.oga31
            IF STATUS THEN
               CALL cl_err3("sel","oah_file",g_oga.oga31,"",SQLCA.sqlcode,"","sel oah:",1)  #No.FUN-670008
               NEXT FIELD oga31
            END IF
            DISPLAY g_buf TO oah02
         END IF

      AFTER FIELD oga32
         IF NOT cl_null(g_oga.oga32) THEN
            IF g_oea.oea32 != g_oga.oga32 THEN #收款條件不符
               CALL cl_err('sel oea','axm-143',0) RETURN FALSE
            END IF
            SELECT oag02 INTO g_buf FROM oag_file WHERE oag01=g_oga.oga32
            IF STATUS THEN
               CALL cl_err3("sel","oag_file",g_oga.oga32,"",SQLCA.sqlcode,"","sel oag:",1)  #No.FUN-670008
               NEXT FIELD oga32
            END IF
            DISPLAY g_buf TO oag02
            SELECT MIN(ogb31) INTO l_ogb31
              FROM ogb_file
             WHERE ogb01=g_oga.oga01
               AND (ogb31 IS NOT NULL OR ogb31 !=' ') ;
            SELECT oea32 INTO l_oea32
              FROM oea_file
             WHERE oea01 = l_ogb31
            IF l_oea32 != g_oga.oga32 THEN	#收款條件不符
               CALL cl_err('','axm-143',1)
               NEXT FIELD oga32
            END IF
         END IF

      AFTER FIELD oga021
         IF g_oga.oga24=0 OR cl_null(g_oga.oga24) OR
            g_oga.oga021 != g_oga_t.oga021 OR
            cl_null(g_oga_t.oga021) THEN
           #只要曾改變結關日期,即使按確定前改回原始建檔的結關日期,匯率一律重抓,
            LET g_oga_t.oga021 = g_oga.oga021  #MOD-690094 add
             IF NOT cl_null(g_oga.oga23) THEN
                  CALL t600_oea18_get() RETURNING g_oea18_yn
                  IF g_oea18_yn = 'N' THEN
                      IF g_oga.oga08='1' THEN
                          LET exT=g_oaz.oaz52
                      ELSE
                          LET exT=g_oaz.oaz70
                      END IF
                      IF g_oga.oga909 = 'Y' THEN
                         CALL t600_chk_poz00() RETURNING exT   #MOD-860069 
                      END IF
                     IF NOT cl_null(g_oga.oga021) THEN
                        LET g_exdate = g_oga.oga021    #結關日期
                     ELSE
                        LET g_exdate = g_oga.oga02     #出貨日期
                     END IF
                     CALL s_curr3(g_oga.oga23,g_exdate,exT) RETURNING g_oga.oga24
                      DISPLAY BY NAME g_oga.oga24
                  END IF
             END IF
        END IF

         IF NOT cl_null(g_oga.oga021) THEN
            IF g_oga.oga021 <= g_oaz.oaz09 THEN
               CALL cl_err('','axm-164',0)
               NEXT FIELD oga021
            END IF
         END IF

      AFTER FIELD oga35
         IF NOT cl_null(g_oga.oga35) THEN
            IF g_oga.oga35 NOT MATCHES '[12345678]' THEN
               NEXT FIELD oga35
            END IF
         END IF

     #-MOD-A90150-add-
      AFTER FIELD oga39
         IF NOT cl_null(g_oga.oga39) THEN
            LET l_n = 0 
            LET l_n = LENGTH(g_oga.oga39)
            IF l_n != 14 THEN
               CALL cl_err(g_oga.oga39,'amd-017',0)
               NEXT FIELD oga39
            END IF
         END IF
     #-MOD-A90150-add-

      AFTER FIELD oga910
         IF NOT cl_null(g_oga.oga910) THEN  
            SELECT * FROM imd_file
             WHERE imd01 = g_oga.oga910
               AND imdacti = 'Y' 
            IF STATUS <> 0 THEN
               CALL cl_err3("sel","imd_file",g_oga.oga910,"","ams-004","","",1)  
               NEXT FIELD oga910
            END IF

            #No.FUN-AA0048  --Begin
            IF NOT s_chk_ware(g_oga.oga910) THEN
               NEXT FIELD oga910
            END IF
            #No.FUN-AA0048  --End  

            LET l_n = 0 
            SELECT COUNT(*) INTO l_n FROM ogb_file 
             WHERE ogb01 = g_oga.oga01
               AND ogb09 = g_oga.oga910 
            IF l_n > 0 THEN 
               CALL cl_err('','axm-100',0)
               LET g_oga.oga910=' '
               NEXT FIELD oga910
            END IF
         END IF

      AFTER FIELD oga911
         IF cl_null(g_oga.oga911) THEN    
            LET g_oga.oga911 = ' '
         END IF

         LET l_n = 0
         SELECT COUNT(*) INTO l_n FROM ogb_file 
          WHERE ogb01  = g_oga.oga01
            AND ogb09 = g_oga.oga910
            AND ogb091 = g_oga.oga911 
         IF l_n > 0 THEN 
            CALL cl_err('','axm-100',0)
            LET g_oga.oga911=' '
            NEXT FIELD oga910
         END IF
      
      AFTER FIELD oga71
         IF NOT cl_null(g_oga.oga71) THEN   
            SELECT COUNT(*) INTO l_cnt FROM ama_file
             WHERE ama02 = g_oga.oga71
              IF l_cnt = 0 THEN 
                 CALL cl_err("","mfg9329",1) 
              END IF
              #IF g_aza.aza21 = 'Y' OR NOT s_chkban(g_oga.oga71) THEN #FUN-990053 mod #TQC-B40067 mark
              IF g_aza.aza21 = 'Y' AND NOT s_chkban(g_oga.oga71) THEN #TQC-B40067 
                 CALL cl_err("","mfg7015",1)
                 NEXT FIELD oga71
              END IF
         ELSE 
             IF g_aza.aza94 = 'Y' THEN
         	      CALL cl_err('oga71 is null: ','aap-099',0) 
         	      NEXT FIELD oga71
             END IF
         END IF

      ON KEY(F1) NEXT FIELD oga044
      ON KEY(F2) NEXT FIELD oga43

      ON ACTION controlp
          CASE WHEN INFIELD(oga044)
                    CALL cl_init_qry_var()
                    LET g_qryparam.form ="q_ocd"
                    LET g_qryparam.default1 = g_oga.oga044
                    LEt g_qryparam.arg1 = g_oga.oga04
                    CALL cl_create_qry() RETURNING g_oga.oga044
                    DISPLAY BY NAME g_oga.oga044 NEXT FIELD oga044
               WHEN INFIELD(oga41)
                    CALL cl_init_qry_var()
                    LET g_qryparam.form ="q_oac"
                    LET g_qryparam.default1 = g_oga.oga41
                    CALL cl_create_qry() RETURNING g_oga.oga41
                    DISPLAY BY NAME g_oga.oga41 NEXT FIELD oga41
               WHEN INFIELD(oga42)
                    CALL cl_init_qry_var()
                    LET g_qryparam.form ="q_oac"
                    LET g_qryparam.default1 = g_oga.oga42
                    CALL cl_create_qry() RETURNING g_oga.oga42
                    DISPLAY BY NAME g_oga.oga42 NEXT FIELD oga42
               WHEN INFIELD(oga43)
                    CALL cl_init_qry_var()
                    LET g_qryparam.form ="q_ged"
                    LET g_qryparam.default1 = g_oga.oga43
                    CALL cl_create_qry() RETURNING g_oga.oga43
                    DISPLAY BY NAME g_oga.oga43
                    NEXT FIELD oga43
               WHEN INFIELD(oga44)
                    CALL cl_init_qry_var()
                    LET g_qryparam.form ="q_ocf"
                    LET g_qryparam.default1 = g_oga.oga44
                     LET g_qryparam.arg1 = g_oga.oga04  # MOD-580083 Add
                    CALL cl_create_qry() RETURNING g_oga.oga44
                    DISPLAY BY NAME g_oga.oga44
                    NEXT FIELD oga44
               WHEN INFIELD(oga31)
                    CALL cl_init_qry_var()
                    LET g_qryparam.form = "q_oah"
                    LET g_qryparam.default1 = g_oga.oga31
                    CALL cl_create_qry() RETURNING g_oga.oga31
                    DISPLAY BY NAME g_oga.oga31
                    NEXT FIELD oga31
               WHEN INFIELD(oga32)
                    CALL cl_init_qry_var()
                    LET g_qryparam.form = "q_oag"
                    LET g_qryparam.default1 = g_oga.oga32
                    CALL cl_create_qry() RETURNING g_oga.oga32
                    DISPLAY BY NAME g_oga.oga32
                    NEXT FIELD oga32
               WHEN INFIELD(oga71)
                    CALL cl_init_qry_var()
                    LET g_qryparam.form = "q_ama02"
                    LET g_qryparam.default1 = g_oga.oga71
                    CALL cl_create_qry() RETURNING g_oga.oga71
                    DISPLAY BY NAME g_oga.oga71
                    NEXT FIELD oga71
            END CASE

      ON ACTION CONTROLF  # 欄位說明 BugNO:3387 mandy
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name #Add on 040913
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang) #Add on 040913


       ON IDLE g_idle_seconds
          CALL cl_on_idle()
          CONTINUE INPUT

      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121

      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121

      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121


    END INPUT

    IF INT_FLAG THEN
       LET INT_FLAG=0
       LET g_oga.* = g_oga_o.*   #MOD-9C0105
       CLOSE WINDOW t6001_w
       CLOSE t600_cl   #MOD-970012
       ROLLBACK WORK   #MOD-970012
       RETURN
    END IF

    CLOSE WINDOW t6001_w
    CLOSE t600_cl   #MOD-970012

    LET g_msg=l_oap.oap041 CLIPPED,' ',l_oap.oap042 CLIPPED,' ',
              l_oap.oap043 CLIPPED,' ',l_oap.oap044 CLIPPED,' ',   #MOD-910186 增加oap044/oap045
              l_oap.oap045 CLIPPED   #MOD-910186 增加oap044/oap045

    DISPLAY g_msg TO addr

    DELETE FROM oap_file WHERE oap01=g_oga.oga01
    LET l_oap.oap01 = g_oga.oga01
    IF g_oga.oga044[1,4] ='MISC' THEN
       INSERT INTO oap_file VALUES(l_oap.*)
       IF STATUS THEN
          CALL cl_err3("ins","oap_file",l_oap.oap01,"",SQLCA.sqlcode,"","INS-oap",1)  #No.FUN-670008
       END IF
    END IF

    UPDATE oga_file SET * = g_oga.* WHERE oga01 = g_oga.oga01
    IF SQLCA.SQLCODE THEN
       CALL cl_err3("upd","oga_file",g_oga.oga01,"",SQLCA.sqlcode,"","update oga",1)  #No.FUN-670008
       ROLLBACK WORK
    ELSE
       COMMIT WORK
    END IF

    DISPLAY BY NAME g_oga.oga021   #FUN-5B0066
END FUNCTION


FUNCTION t600_2()
    DEFINE l_date1,l_date2 LIKE type_file.dat     #No.FUN-680137 DATE
    DEFINE l_date3         LIKE type_file.dat     #No.FUN-680137 DATE        #No.FUN-680022
    DEFINE l_cnt           LIKE type_file.num5    #MOD-960004  

    BEGIN WORK

    OPEN t600_cl USING g_oga.oga01
    IF STATUS THEN
       CALL cl_err("OPEN t600_cl:", STATUS, 1)
       CLOSE t600_cl
       ROLLBACK WORK
       RETURN
    END IF

    FETCH t600_cl INTO g_oga.*  # 鎖住將被更改或取消的資料
    IF SQLCA.sqlcode THEN
        CALL cl_err(g_oga.oga01,SQLCA.sqlcode,0)     # 資料被他人LOCK
        CLOSE t600_cl ROLLBACK WORK RETURN
    END IF
    IF cl_null(g_oga.oga32) AND g_oga.ogaconf = 'N' THEN #No.7891
           SELECT occ45 INTO g_oga.oga32 FROM occ_file
           WHERE occ01 = g_oga.oga03      #No.TQC-640123
    END IF

    LET p_row = 2 LET p_col = 11


    OPEN WINDOW t6002_w AT p_row,p_col WITH FORM "axm/42f/axmt6002"
          ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN

    CALL cl_ui_locale("axmt6002")

    LET g_action_choice="modify"
    IF NOT cl_chk_act_auth() THEN
       DISPLAY BY NAME g_oga.oga161,g_oga.oga162,g_oga.oga163,
                  g_oga.oga26,g_oga.oga32,g_oga.oga11 ,g_oga.oga12,
                  g_oga.oga19,g_oga.oga46,g_oga.oga13,g_oga.oga07,
                   g_oga.oga20   #,g_oga.oga18   #No:MOD-570265 Mark
            LET INT_FLAG = 0  ######add for prompt bug
       PROMPT ">" FOR CHAR g_chr
          ON IDLE g_idle_seconds
             CALL cl_on_idle()

      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121

      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121

      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121


       END PROMPT
       CLOSE WINDOW t6002_w
       CLOSE t600_cl   #MOD-970012
       ROLLBACK WORK   #MOD-970012
       RETURN
    END IF
    CALL cl_set_head_visible("","YES")       #No.FUN-6A0092

    INPUT BY NAME g_oga.oga161,g_oga.oga162,g_oga.oga163,
                  g_oga.oga26,g_oga.oga32,g_oga.oga11 ,g_oga.oga12,
                  g_oga.oga19,g_oga.oga46,g_oga.oga13,g_oga.oga07,
               #  g_oga.oga20,g_oga.oga18 WITHOUT DEFAULTS
                   g_oga.oga20 WITHOUT DEFAULTS    #No:MOD-570265

    #95/08/29 By Danny
        AFTER FIELD oga13
              IF NOT cl_null(g_oga.oga13) THEN
                 SELECT * FROM ool_file WHERE ool01=g_oga.oga13
                 IF STATUS THEN
                    CALL cl_err3("sel","ool_file",g_oga.oga13,"",SQLCA.sqlcode,"","",1)  #No.FUN-670008
                    NEXT FIELD oga13
                 END IF
              END IF

        AFTER FIELD oga07
         #-MOD-AB0233-add-
          IF g_oga.oga161 = 100 THEN
             LET g_oga.oga07 = 'N' 
             DISPLAY BY NAME g_oga.oga07
          END IF
         #-MOD-AB0233-end-
          IF g_oga.oga07 = 'N' THEN
             SELECT COUNT(*) INTO l_cnt 
               FROM npp_file
              WHERE nppsys = 'AR'
                AND npp00 = 1
                AND npp01 = g_oga.oga01
                AND npp011 = 1
             IF l_cnt > 0 THEN 
                IF NOT cl_confirm('axm-088') THEN NEXT FIELD oga07 END IF
                DELETE FROM npp_file
                 WHERE nppsys = 'AR'
                   AND npp00 = 1
                   AND npp01 = g_oga.oga01
                   AND npp011 = 1
                IF SQLCA.sqlcode THEN
                   CALL cl_err3("del","npp_file",g_oga.oga01,"",SQLCA.sqlcode,"","del_npp",1)  
                   NEXT FIELD oga07
                END IF
               
                DELETE FROM npq_file
                 WHERE npqsys = 'AR'
                   AND npq00 = 1
                   AND npq01 = g_oga.oga01
                   AND npq011 = 1
                IF SQLCA.sqlcode THEN
                   CALL cl_err3("del","npq_file",g_oga.oga01,"",SQLCA.sqlcode,"","del_npq",1)  
                   NEXT FIELD oga07
                END IF

                #FUN-B40056--add--str--
                DELETE FROM tic_file WHERE tic04 = g_oga.oga01
                IF SQLCA.sqlcode THEN
                   CALL cl_err3("del","tic_file",g_oga.oga01,"",SQLCA.sqlcode,"","del_tic",1)
                   NEXT FIELD oga07
                END IF
                #FUN-B40056--add--end--
             END IF
          END IF

        AFTER FIELD oga26   #銷售分類
           IF NOT cl_null(g_oga.oga26) THEN
              SELECT * FROM oab_file WHERE oab01=g_oga.oga26
              IF SQLCA.sqlcode THEN CALL cl_err(g_oga.oga26,SQLCA.sqlcode,0) NEXT FIELD oga26 END IF
           END IF

        AFTER FIELD oga46   #項目編號
           IF NOT cl_null(g_oga.oga46) THEN
              SELECT * FROM pja_file WHERE pja01=g_oga.oga46 AND pjaacti = 'Y'   #FUN-810045
                                       AND pjaclose = 'N'           #No.FUN-960038
              IF SQLCA.sqlcode THEN CALL cl_err(g_oga.oga46,SQLCA.sqlcode,0) NEXT FIELD oga46 END IF
           END IF


        BEFORE FIELD oga11
              IF NOT cl_null(g_oga.oga32) THEN
                 SELECT oag02 INTO g_buf FROM oag_file
                  WHERE oag01=g_oga.oga32
                 IF STATUS THEN
                    CALL cl_err3("sel","oag_file",g_oga.oga32,"",SQLCA.sqlcode,"","select oag",1)  #No.FUN-670008
                    NEXT FIELD oga32
                 END IF
                 IF NOT cl_null(g_oga.oga16) THEN
                    SELECT oea02 INTO l_date3 FROM oea_file
                     WHERE oea01 = g_oga.oga16
                 ELSE
                    LET l_date3 = g_oga.oga02
                 END IF
                 CALL s_rdatem(g_oga.oga03,g_oga.oga32,g_oga.oga02,g_oga.oga02,l_date3,g_plant2)#FUN-980020
                            RETURNING l_date1,l_date2
                 IF cl_null(g_oga.oga11) THEN LET g_oga.oga11=l_date1 END IF
                 IF cl_null(g_oga.oga12) THEN LET g_oga.oga12=l_date2 END IF
                 DISPLAY BY NAME g_oga.oga11,g_oga.oga12
              END IF

       ON ACTION controlp
           CASE
               WHEN INFIELD(oga26)
                    CALL cl_init_qry_var()
                    LET g_qryparam.form ="q_oab"
                    LET g_qryparam.default1 = g_oga.oga26
                    CALL cl_create_qry() RETURNING g_oga.oga26
                    DISPLAY BY NAME g_oga.oga26
                    NEXT FIELD oga26
               WHEN INFIELD(oga32)
                    CALL cl_init_qry_var()
                    LET g_qryparam.form ="q_oag"
                    LET g_qryparam.default1 = g_oga.oga32
                    CALL cl_create_qry() RETURNING g_oga.oga32
                    DISPLAY BY NAME g_oga.oga32
                    NEXT FIELD oga32
               WHEN INFIELD(oga13)
                    CALL cl_init_qry_var()
                    LET g_qryparam.form = "q_ool"
                    LET g_qryparam.default1 = g_oga.oga13
                    CALL cl_create_qry() RETURNING g_oga.oga13
                    DISPLAY BY NAME g_oga.oga13
                    NEXT FIELD oga13
           END CASE

       ON IDLE g_idle_seconds
          CALL cl_on_idle()
          CONTINUE INPUT

       ON ACTION about         #MOD-4C0121
          CALL cl_about()      #MOD-4C0121

       ON ACTION help          #MOD-4C0121
          CALL cl_show_help()  #MOD-4C0121

       ON ACTION controlg      #MOD-4C0121
          CALL cl_cmdask()     #MOD-4C0121


    END INPUT

    IF INT_FLAG THEN
       LET INT_FLAG=0
       CLOSE WINDOW t6002_w
       CLOSE t600_cl   #MOD-970012
       ROLLBACK WORK   #MOD-970012
       RETURN
    END IF

    CLOSE WINDOW t6002_w
    CLOSE t600_cl   #MOD-970012

    UPDATE oga_file SET * = g_oga.* WHERE oga01 = g_oga.oga01
    IF SQLCA.SQLCODE THEN
        CALL cl_err3("upd","oga_file",g_oga.oga01,"",SQLCA.sqlcode,"","update oga",1)  #No.FUN-670008
        ROLLBACK WORK
    ELSE
        COMMIT WORK
    END IF

END FUNCTION


FUNCTION t600_b_more()
  DEFINE l_ima25    LIKE ima_file.ima25 #MOD-5B0276

    LET p_row = 7 LET p_col = 10


    OPEN WINDOW t6005_w AT p_row,p_col WITH FORM "axm/42f/axmt6005"
          ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN

    CALL cl_ui_locale("axmt6005")

    SELECT ima906 INTO g_ima906 FROM ima_file WHERE ima01 = g_ogb[l_ac].ogb04

    LET b_ogb.ogb05 = g_ogb[l_ac].ogb05
    LET b_ogb.ogb12 = g_ogb[l_ac].ogb12
    LET b_ogb.ogb910= g_ogb[l_ac].ogb910
    LET b_ogb.ogb911= g_ogb[l_ac].ogb911
    LET b_ogb.ogb912= g_ogb[l_ac].ogb912
    LET b_ogb.ogb913= g_ogb[l_ac].ogb913
    LET b_ogb.ogb914= g_ogb[l_ac].ogb914
    LET b_ogb.ogb915= g_ogb[l_ac].ogb915

    CALL cl_set_comp_entry("ogb914,ogb911",FALSE)
    IF g_sma.sma115 = 'Y' THEN
       CALL cl_set_comp_entry("ogb15,ogb15_fac,ogb16",FALSE)  #CHI-820011 add
       CALL cl_set_comp_visible("ogb05,ogb12,ogb05_fac",FALSE)
       CALL cl_set_comp_att_text("ogb05",' ')
       CALL cl_set_comp_att_text("ogb05_fac",' ')
       CALL cl_set_comp_att_text("ogb12",' ')
    ELSE
       CALL cl_set_comp_entry("ogb05_fac,ogb15_fac,ogb16",FALSE)  #CHI-820011 add
       CALL cl_set_comp_visible("ogb913,ogb914,ogb915",FALSE)
       CALL cl_set_comp_visible("ogb910,ogb911,ogb912",FALSE)
       CALL cl_set_comp_att_text("ogb913",' ')
       CALL cl_set_comp_att_text("ogb914",' ')
       CALL cl_set_comp_att_text("ogb915",' ')
       CALL cl_set_comp_att_text("ogb911",' ')
       CALL cl_set_comp_att_text("ogb912",' ')
       CALL cl_set_comp_att_text("ogb910",' ')   #TQC-730034 modify
    END IF
    IF g_sma.sma122 ='1' THEN
       CALL cl_getmsg('asm-302',g_lang) RETURNING g_msg
       CALL cl_set_comp_att_text("ogb913",g_msg CLIPPED)
       CALL cl_getmsg('asm-353',g_lang) RETURNING g_msg
       CALL cl_set_comp_att_text("ogb914",g_msg CLIPPED)
       CALL cl_getmsg('asm-306',g_lang) RETURNING g_msg
       CALL cl_set_comp_att_text("ogb915",g_msg CLIPPED)
       CALL cl_getmsg('asm-303',g_lang) RETURNING g_msg
       CALL cl_set_comp_att_text("ogb910",g_msg CLIPPED)
       CALL cl_getmsg('asm-354',g_lang) RETURNING g_msg
       CALL cl_set_comp_att_text("ogb911",g_msg CLIPPED)
       CALL cl_getmsg('asm-307',g_lang) RETURNING g_msg
       CALL cl_set_comp_att_text("ogb912",g_msg CLIPPED)
    END IF
    IF g_sma.sma122 ='2' THEN
       CALL cl_getmsg('asm-304',g_lang) RETURNING g_msg
       CALL cl_set_comp_att_text("ogb913",g_msg CLIPPED)
       CALL cl_getmsg('asm-355',g_lang) RETURNING g_msg
       CALL cl_set_comp_att_text("ogb914",g_msg CLIPPED)
       CALL cl_getmsg('asm-308',g_lang) RETURNING g_msg
       CALL cl_set_comp_att_text("ogb915",g_msg CLIPPED)
       CALL cl_getmsg('asm-326',g_lang) RETURNING g_msg
       CALL cl_set_comp_att_text("ogb910",g_msg CLIPPED)
       CALL cl_getmsg('asm-357',g_lang) RETURNING g_msg
       CALL cl_set_comp_att_text("ogb911",g_msg CLIPPED)
       CALL cl_getmsg('asm-327',g_lang) RETURNING g_msg
       CALL cl_set_comp_att_text("ogb912",g_msg CLIPPED)
    END IF

    SELECT ima25 INTO l_ima25 FROM ima_file WHERE ima01 = g_ogb[l_ac].ogb04
    IF STATUS THEN LET l_ima25=NULL END IF
    INPUT BY NAME b_ogb.ogb18,
                  b_ogb.ogb11,b_ogb.ogb07,b_ogb.ogb05, b_ogb.ogb12, l_ima25,
                  b_ogb.ogb05_fac,
                  b_ogb.ogb913,b_ogb.ogb914,b_ogb.ogb915,
                  b_ogb.ogb910,b_ogb.ogb911,b_ogb.ogb912,
                  b_ogb.ogb15, b_ogb.ogb15_fac, b_ogb.ogb16
                  WITHOUT DEFAULTS

       BEFORE FIELD ogb15_fac
          CALL t600_set_origin_field()

       AFTER FIELD ogb15_fac
          LET b_ogb.ogb16 = b_ogb.ogb12 * b_ogb.ogb15_fac
          DISPLAY BY NAME b_ogb.ogb16

       ON IDLE g_idle_seconds
          CALL cl_on_idle()
          CONTINUE INPUT

       ON ACTION about         #MOD-4C0121
          CALL cl_about()      #MOD-4C0121
       
       ON ACTION help          #MOD-4C0121
          CALL cl_show_help()  #MOD-4C0121
       
       ON ACTION controlg      #MOD-4C0121
          CALL cl_cmdask()     #MOD-4C0121

    END INPUT

    IF INT_FLAG THEN
       LET INT_FLAG=0
       CLOSE WINDOW t6005_w                 #結束畫面
       RETURN
    END IF

    UPDATE ogb_file SET ogb18 =b_ogb.ogb18,
                        ogb11 =b_ogb.ogb11,
                        ogb07 =b_ogb.ogb07
                  WHERE ogb01 =b_ogb.ogb01
                    AND ogb03 =b_ogb.ogb03 
   IF STATUS OR SQLCA.sqlerrd[3]=0 THEN
      CALL cl_err3("upd","ogb_file",b_ogb.ogb03,"",SQLCA.sqlcode,"","upd ogb",1)  #No.FUN-670008
   END IF

    CLOSE WINDOW t6005_w                 #結束畫面
END FUNCTION

FUNCTION t600_6007()


    IF g_ogb[l_ac].ogb1005 ='2' OR g_ogb[l_ac].ogb1012 ='Y' THEN
       CALL cl_err('','atm-516',0)
       RETURN
    END IF

    LET p_row = 4 LET p_col = 23

    OPEN WINDOW t6007_w AT p_row,p_col WITH FORM "axm/42f/axmt6007"
          ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN

    CALL cl_ui_locale("axmt6007")

   MENU ""
      BEFORE MENU
         DISPLAY BY NAME b_ogb.ogb13,b_ogb.ogb14,b_ogb.ogb14t

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE MENU
     ON ACTION about         #MOD-4C0121
        CALL cl_about()      #MOD-4C0121

     ON ACTION help          #MOD-4C0121
        CALL cl_show_help()  #MOD-4C0121

      ON ACTION exit
         EXIT MENU

      ON ACTION close   #COMMAND KEY(INTERRUPT) #FUN-9B0145     #No:TQC-950171 add
         EXIT MENU             #No:TQC-950171 add

   END MENU

    CLOSE WINDOW t6007_w                 #結束畫面

END FUNCTION




FUNCTION t600_3()
   DEFINE d_ogb     DYNAMIC ARRAY OF RECORD
                    ogb03     LIKE ogb_file.ogb03,
                    ogb31     LIKE ogb_file.ogb31,
                    ogb32     LIKE ogb_file.ogb32,
                    ogb04     LIKE ogb_file.ogb04,
                    ogb06     LIKE ogb_file.ogb06,
                    ogb05     LIKE ogb_file.ogb05,
                    ogb12     LIKE ogb_file.ogb12,
                    ogb913    LIKE ogb_file.ogb913,
                    ogb914    LIKE ogb_file.ogb911,
                    ogb915    LIKE ogb_file.ogb915,
                    ogb910    LIKE ogb_file.ogb910,
                    ogb911    LIKE ogb_file.ogb911,
                    ogb912    LIKE ogb_file.ogb912,
                    ogb916    LIKE ogb_file.ogb916,
                    ogb917    LIKE ogb_file.ogb917,
                    ogb17     LIKE ogb_file.ogb17,                #CHI-870038
                    ogb09     LIKE ogb_file.ogb09,
                    ogb091    LIKE ogb_file.ogb091,
                    ogb092    LIKE ogb_file.ogb092
                    END RECORD,
          d_ogb_t   RECORD
                    ogb03     LIKE ogb_file.ogb03,
                    ogb31     LIKE ogb_file.ogb31,
                    ogb32     LIKE ogb_file.ogb32,
                    ogb04     LIKE ogb_file.ogb04,
                    ogb06     LIKE ogb_file.ogb06,
                    ogb05     LIKE ogb_file.ogb05,
                    ogb12     LIKE ogb_file.ogb12,
                    ogb913    LIKE ogb_file.ogb913,
                    ogb914    LIKE ogb_file.ogb911,
                    ogb915    LIKE ogb_file.ogb915,
                    ogb910    LIKE ogb_file.ogb910,
                    ogb911    LIKE ogb_file.ogb911,
                    ogb912    LIKE ogb_file.ogb912,
                    ogb916    LIKE ogb_file.ogb916,
                    ogb917    LIKE ogb_file.ogb917,
                    ogb17     LIKE ogb_file.ogb17,                #CHI-870038
                    ogb09     LIKE ogb_file.ogb09,
                    ogb091    LIKE ogb_file.ogb091,
                    ogb092    LIKE ogb_file.ogb092
                    END RECORD
   DEFINE l_n,i     LIKE type_file.num5    #No.FUN-680137 SMALLINT
   DEFINE l_rec_b   LIKE type_file.num5    #No.FUN-680137 SMALLINT
#   DEFINE l_qty     LIKE ima_file.ima26,  #No.FUN-680137 DECIMAL(15,3)  #BugNo:4160 #FUN-A20044  
   DEFINE l_qty     LIKE type_file.num15_3, #FUN-A20044  
          l_allow_insert   LIKE type_file.num5,                #可新增否  #No.FUN-680137 SMALLINT
          l_allow_delete   LIKE type_file.num5                 #可刪除否  #No.FUN-680137 SMALLINT
   DEFINE l_oea99   LIKE oea_file.oea99    #CHI-9C0009
   DEFINE li_result LIKE type_file.num5    #CHI-9C0009
   DEFINE l_ogb05_fac   LIKE ogb_file.ogb05_fac   #MOD-A70059
   DEFINE l_ogb03   LIKE ogb_file.ogb03           #No:MOD-AA0088 add

   IF g_oga.oga01 IS NULL THEN RETURN END IF
   IF g_oga.ogaconf = 'X' THEN CALL cl_err('',9024,0) RETURN END IF
   IF g_oga.ogapost = 'Y' THEN CALL cl_err('','mfg0175',0) RETURN END IF

   LET p_row = 3 LET p_col = 3

   IF g_oga.oga55 matches '[Ss]' THEN         #送簽中不可更改倉儲
      CALL cl_err('','apm-030',0)
      RETURN
   END IF

   OPEN WINDOW t6003_w AT p_row,p_col WITH FORM "axm/42f/axmt6003"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No:FUN-580092 HCN

    CALL cl_ui_locale("axmt6003")


    CALL cl_set_comp_visible("ogb911,ogb914",FALSE)
    IF g_sma.sma115 = 'Y' THEN
       CALL cl_set_comp_visible("ogb05,ogb12",FALSE)
    ELSE
       CALL cl_set_comp_visible("ogb913,ogb914,ogb915",FALSE)
       CALL cl_set_comp_visible("ogb910,ogb911,ogb912",FALSE)
    END IF
    IF g_sma.sma116 MATCHES '[01]' THEN
       CALL cl_set_comp_visible("ogb916,ogb917",FALSE)
    END IF
   DECLARE t6003_c CURSOR FOR
      SELECT ogb03,ogb31,ogb32,ogb04,ogb06,ogb05,ogb12,
             ogb913,ogb914,ogb915,ogb910,ogb911,ogb912,ogb916,ogb917,   #No:MOD-610020 add ','
             ogb17,ogb09,ogb091,ogb092                                  #No.CHI-870038 Add ogb17
        FROM ogb_file
       WHERE ogb01=g_oga.oga01

   CALL d_ogb.clear()

   LET i=1
   LET l_rec_b=0
   FOREACH t6003_c INTO d_ogb[i].*
     LET i=i+1
   END FOREACH
   CALL d_ogb.deleteElement(i)
   LET l_rec_b =i-1

   IF g_oga.oga10 IS NOT NULL THEN
      CALL cl_set_act_visible("accept,cancel", FALSE)
      DISPLAY ARRAY d_ogb TO s_ogb.* ATTRIBUTE(COUNT=l_rec_b,UNBUFFERED)
         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE DISPLAY

      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121

      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121

      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121


      END DISPLAY
      CLOSE WINDOW t6003_w
      RETURN
   END IF

   INPUT ARRAY d_ogb WITHOUT DEFAULTS FROM s_ogb.*
         ATTRIBUTE(COUNT=l_rec_b,MAXCOUNT=g_max_rec,UNBUFFERED,
                   INSERT ROW=FALSE,DELETE ROW=FALSE,APPEND ROW=FALSE)

      BEFORE INPUT
          IF l_rec_b != 0 THEN
             CALL fgl_set_arr_curr(l_ac)
          END IF

      BEFORE ROW
         LET l_ac = ARR_CURR()
         LET d_ogb_t.* = d_ogb[l_ac].*
         CALL cl_show_fld_cont()     #FUN-550037(smin)
         BEGIN WORK                  #CHI-A10016

      AFTER FIELD ogb17                                                                                                             
         IF NOT cl_null(d_ogb[l_ac].ogb17) THEN                                                                                     
            IF NOT s_chk_checkbox(d_ogb[l_ac].ogb17) THEN                                                                           
               RETURN FALSE                                                                                                         
            END IF                                                                                                                  
            IF d_ogb[l_ac].ogb17 = 'Y' THEN                                                                                         
             #-----MOD-B30487---------
             #MOD-B30486 mod --start--
              IF cl_null(d_ogb[l_ac].ogb09) THEN LET d_ogb[l_ac].ogb09  = ' '  END IF                                               
              IF cl_null(d_ogb[l_ac].ogb091) THEN LET d_ogb[l_ac].ogb091 = ' ' END IF                                               
              IF cl_null(d_ogb[l_ac].ogb092) THEN LET d_ogb[l_ac].ogb092 = ' ' END IF                                               
             #LET d_ogb[l_ac].ogb09  = ' '                                               
             #LET d_ogb[l_ac].ogb091 = ' '                                               
             #LET d_ogb[l_ac].ogb092 = ' '                                               
             #MOD-B30486 mod --end--
             #-----END MOD-B30487-----
                                                                                                                                    
              DELETE FROM rvbs_file
               WHERE rvbs01 = g_oga.oga01                                                                                          
                 AND rvbs02 = d_ogb[l_ac].ogb03                                                                                    
                 AND rvbs13 = 0

              IF g_sma.sma115 = 'Y' THEN                                                                                            
                 CALL t600_b_ogg()                                                                                                  
              ELSE                                                                                                                  
                 IF g_oaz.oaz23 = 'Y' THEN                                                                                          
                    CALL t600_b_ogd()                                                                                               
                 ELSE                                                                                                               
                    CALL t600_b_ogc()                                                                                               
                 END IF                                                                                                             
              END IF                                                                                                                
                CALL cl_set_comp_entry("ogb09,ogb091,ogb092",FALSE)                                                                 
            ELSE                                                                                                                    
                CALL cl_set_comp_entry("ogb09,ogb091,ogb092",TRUE)
                DELETE FROM ogc_file                                                                                                
                 WHERE ogc01 = g_oga.oga01                                                                                          
                   AND ogc03 = d_ogb[l_ac].ogb03                                                                                    
                DELETE FROM rvbs_file
                 WHERE rvbs01 = g_oga.oga01                                                                                          
                   AND rvbs02 = d_ogb[l_ac].ogb03                                                                                    
                   AND rvbs13 <> 0
                DELETE FROM ogg_file                                                                                                
                 WHERE ogg01 = g_oga.oga01                                                                                          
                   AND ogg03 = d_ogb[l_ac].ogb03                                                                                    
            END IF                                                                                                                  
         END IF                                                                                                                     

      AFTER FIELD ogb09
         IF NOT cl_null(d_ogb[l_ac].ogb09) THEN
            SELECT * FROM imd_file WHERE imd01=d_ogb[l_ac].ogb09
                                      AND imdacti = 'Y' #MOD-4B0169
            IF STATUS THEN
               CALL cl_err3("sel","imd_file",d_ogb[l_ac].ogb09,"",SQLCA.sqlcode,"","",1)  #No.FUN-670008
               NEXT FIELD ogb09
            END IF
            #No.FUN-AA0048  --Begin
            #IF g_azw.azw04='2' THEN                                                                                           
            #   LET l_n =0                                                                                                
            #   SELECT COUNT(*) INTO l_n FROM imd_file                                                                     
            #    WHERE imd01=d_ogb[l_ac].ogb09                                                                                  
            #      AND imd20=g_plant                                                                                       
            #   IF l_n=0 THEN                                                                                                  
            #      CALL cl_err(d_ogb[l_ac].ogb09,'art-487',0)                                                                        
            #      NEXT FIELD ogb09                                                                                            
            #   END IF                                                                                                         
            #END IF 
            IF NOT s_chk_ware(d_ogb[l_ac].ogb09) THEN
               NEXT FIELD ogb09
            END IF
            #No.FUN-AA0048  --End  
         END IF

      AFTER FIELD ogb091
         IF d_ogb[l_ac].ogb091 IS NULL THEN LET d_ogb[l_ac].ogb091 =' ' END IF
         #------------------------------------ 檢查料號預設倉儲及單別預設倉儲
         IF g_oga.oga09 MATCHES '[2]' THEN  #No.FUN-630061    #MOD-910216 mark #No:MOD-920191 mark還原
            IF NOT s_chksmz(d_ogb[l_ac].ogb04, g_oga.oga01,
                           d_ogb[l_ac].ogb09, d_ogb[l_ac].ogb091) THEN
               NEXT FIELD ogb09
            END IF
#FUN-AB0011 ------------STR
            IF s_joint_venture( d_ogb[l_ac].ogb04,g_plant) OR 
                NOT s_internal_item( d_ogb[l_ac].ogb04,g_plant ) THEN
            ELSE
#FUN-AB0011 ------------END
               IF d_ogb[l_ac].ogb04[1,4] != 'MISC' THEN
                  LET l_n=0
                  SELECT COUNT(*),SUM(img10*img21) INTO l_n,l_qty FROM img_file
                   WHERE img01=d_ogb[l_ac].ogb04 AND img02=d_ogb[l_ac].ogb09
                     AND img03=d_ogb[l_ac].ogb091 AND img04=d_ogb[l_ac].ogb092
             #CHI-A40029 mark --start--
             # IF l_n=0 THEN
             #  IF g_oga.oga09 MATCHES '[45]' THEN
             #     CALL t600sub_chkpoz(g_oga.*,d_ogb[l_ac].ogb31) RETURNING li_result,g_poz.*,l_oea99,g_flow  #NO.TQC-740089 
             #     IF NOT li_result THEN RETURN END IF #FUN-730012
             #     IF g_argv0 = '4' AND g_poz.poz011 = '1' THEN 
             #        CALL s_add_img(d_ogb[l_ac].ogb04,d_ogb[l_ac].ogb09,
             #                       d_ogb[l_ac].ogb091,d_ogb[l_ac].ogb092,
             #                       g_oga.oga01,d_ogb[l_ac].ogb03,g_oga.oga02)
             #        IF g_errno='N' THEN
             #           NEXT FIELD ogb091
             #        END IF
             #     ELSE
             #        CALL cl_err('part+lot:','axm-245',0) NEXT FIELD ogb091 #TQC-7B0159
             #     END IF 
             #  ELSE
             #  #CALL cl_err('part+lot:','axm-244',0) NEXT FIELD ogb091 #TQC-7B0159     #CHI-A10002 mark
             #   CALL cl_err(d_ogb[l_ac].ogb04,'axm-244',0) NEXT FIELD ogb091           #CHI-A10002 add 
             #  END IF
             # END IF
             #CHI-A40029 mark --end--
                  IF l_qty IS NULL THEN LET l_qty=0 END IF
                  LET g_msg=NULL
                  SELECT ze03 INTO g_msg FROM ze_file
                   WHERE ze01='axm-246' AND ze02=p_lang
                   ERROR g_msg CLIPPED,l_qty
               END IF
               IF g_ogb[l_ac].ogb17 = 'N' THEN   #MOD-890274
              #-----MOD-A70059---------
              #IF g_ogb[l_ac].ogb12 > l_qty THEN
                 SELECT ogb05_fac INTO l_ogb05_fac FROM ogb_file
                  WHERE ogb01 = g_oga.oga01
                    AND ogb03 = g_ogb[l_ac].ogb03
                 IF g_ogb[l_ac].ogb12*l_ogb05_fac > l_qty THEN
              #-----END MOD-A70059-----
                    LET g_flag2 = NULL    #FUN-C80107 add
                    CALL s_inv_shrt_by_warehouse(g_sma.sma894[2,2],d_ogb[l_ac].ogb09) RETURNING g_flag2   #FUN-C80107 add
                    #IF g_sma.sma894[2,2]='N' OR g_sma.sma894[2,2] IS NULL THEN   #FUN-C80107 mark
                    IF g_flag2 = 'N' OR g_flag2 IS NULL THEN           #FUN-C80107 add
                       CALL cl_err(d_ogb[l_ac].ogb12,'axm-280',1)
                       NEXT FIELD ogb12
                    ELSE
                       IF NOT cl_confirm('mfg3469') THEN
                          NEXT FIELD ogb12
                       END IF
                    END IF
                 END IF
               END IF   #MOD-890274
            END IF                                #FUN-AB0011                      
         END IF

      ON ROW CHANGE
          IF INT_FLAG THEN
             CALL cl_err('',9001,0)
             LET INT_FLAG = 0
             LET d_ogb[l_ac].* = d_ogb_t.*
             CLOSE t6003_c
             ROLLBACK WORK
             EXIT INPUT
          END IF

          UPDATE ogb_file SET ogb09=d_ogb[l_ac].ogb09,
                              ogb091=d_ogb[l_ac].ogb091,
                              ogb092=d_ogb[l_ac].ogb092,      #MOD-A10010 add
                              ogb17=d_ogb[l_ac].ogb17                 # CHI-870038 
           WHERE ogb01=g_oga.oga01
             AND ogb03=d_ogb[l_ac].ogb03
          IF SQLCA.sqlcode THEN
             CALL cl_err3("upd","ogb_file",g_oga.oga01,d_ogb[l_ac].ogb03,SQLCA.sqlcode,"","upd ogb",1)  #No.FUN-670008
             LET d_ogb[l_ac].* = d_ogb_t.*
          ELSE
             CALL cl_msg('UPDATE OK.')
          END IF

      AFTER ROW
          LET l_ac = ARR_CURR()
          IF INT_FLAG THEN
             CALL cl_err('',9001,0)
             LET INT_FLAG = 0
             LET d_ogb[l_ac].* = d_ogb_t.*
             CLOSE t6003_c
             ROLLBACK WORK
             EXIT INPUT
          END IF
          LET d_ogb_t.* = d_ogb[l_ac].*
          CLOSE t6003_c
          IF g_azw.azw04='2' THEN
             CALL t600_add_store(d_ogb[l_ac].ogb04,d_ogb[l_ac].ogb09)
          END IF
          COMMIT WORK


      ON ACTION mntn_inv_detail                                                                                                     
         IF d_ogb[l_ac].ogb17 = 'Y' THEN                                                                                            
            IF g_sma.sma115 = 'Y' THEN                                                                                              
               CALL t600_b_ogg()                                                                                                    
            ELSE                                                                                                                    
               IF g_oaz.oaz23 = 'Y' THEN                                                                                            
                  CALL t600_b_ogd()                                                                                                 
               ELSE                                                                                                                 
                  CALL t600_b_ogc()                                                                                                 
               END IF                                                                                                               
            END IF                                                                                                                  
         END IF                                                                                                                     

      ON ACTION controlp
         CASE WHEN INFIELD(ogb09)
                   IF g_azw.azw04='2' THEN
                      CALL q_img42(FALSE,TRUE,d_ogb[l_ac].ogb04,d_ogb[l_ac].ogb09,
                           d_ogb[l_ac].ogb091,d_ogb[l_ac].ogb092,'A','1',g_oga.ogaplant)
                       RETURNING d_ogb[l_ac].ogb09,d_ogb[l_ac].ogb091,                                                       
                                 d_ogb[l_ac].ogb092   
                   ELSE
                      CALL q_img4(FALSE,TRUE,d_ogb[l_ac].ogb04,d_ogb[l_ac].ogb09,d_ogb[l_ac].ogb091,d_ogb[l_ac].ogb092,'A')
                                RETURNING d_ogb[l_ac].ogb09,d_ogb[l_ac].ogb091,
                                          d_ogb[l_ac].ogb092
                   END IF  
                   IF INT_FLAG THEN
                      LET INT_FLAG = 0
                   END IF

                   DISPLAY BY NAME d_ogb[l_ac].ogb09
                   DISPLAY BY NAME d_ogb[l_ac].ogb091
                   DISPLAY BY NAME d_ogb[l_ac].ogb092
                   NEXT FIELD ogb09
              WHEN INFIELD(ogb091)
                   IF g_azw.azw04='2' THEN                                                                                        
                      CALL q_img42(FALSE,TRUE,d_ogb[l_ac].ogb04,d_ogb[l_ac].ogb09,                                               
                            d_ogb[l_ac].ogb091,d_ogb[l_ac].ogb092,'A','1',g_oga.ogaplant)                                          
                      RETURNING d_ogb[l_ac].ogb09,d_ogb[l_ac].ogb091,                                                             
                                      d_ogb[l_ac].ogb092                                                                          
                   ELSE
                      CALL q_img4(FALSE,TRUE,d_ogb[l_ac].ogb04,d_ogb[l_ac].ogb09,d_ogb[l_ac].ogb091,d_ogb[l_ac].ogb092,'A')
                               RETURNING d_ogb[l_ac].ogb09,d_ogb[l_ac].ogb091,
                                         d_ogb[l_ac].ogb092
                   END IF  
                   IF INT_FLAG THEN
                      LET INT_FLAG = 0
                   END IF

                   DISPLAY BY NAME d_ogb[l_ac].ogb09
                   DISPLAY BY NAME d_ogb[l_ac].ogb091
                   DISPLAY BY NAME d_ogb[l_ac].ogb092
                   NEXT FIELD ogb091
         END CASE
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT

      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121

      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121

      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121


   END INPUT

   IF INT_FLAG THEN LET INT_FLAG=0 END IF
   CLOSE WINDOW t6003_w
   CALL t600_b1_fill(' 1=1')    #No.TQC-640123
   LET l_ac=1

END FUNCTION

FUNCTION t600_oga01()
DEFINE li_result LIKE type_file.num5    #No.FUN-680137 SMALLINT
DEFINE loay22_oga      LIKE oay_file.oay22    #No.TQC-650118
DEFINE loay22_oea      LIKE oay_file.oay22    #No.TQC-650118


    IF g_argv0 ='A' THEN
       CALL s_check_no("axm",g_oga.oga01,g_oga_t.oga01,"51","","","")
         RETURNING li_result,g_oga.oga01
       RETURN li_result
    END IF

      IF g_argv0 ='8' THEN
          CALL s_check_no("axm",g_oga.oga01,g_oga_t.oga01,"58","","","")
            RETURNING li_result,g_oga.oga01
          RETURN li_result
      END IF
      IF g_argv0 ='9' THEN
          CALL s_check_no("axm",g_oga.oga01,g_oga_t.oga01,"59","","","")
            RETURNING li_result,g_oga.oga01
          RETURN li_result
      END IF

   IF g_argv0 MATCHES '[15]' THEN           #No.7992
      IF g_oga.oga00 MATCHES '[126]' THEN
          CALL s_check_no("axm",g_oga.oga01,g_oga_t.oga01,"40","","","")
            RETURNING li_result,g_oga.oga01
      END IF
      IF g_oga.oga00 MATCHES '[37]' THEN  #No.FUN-610064
          CALL s_check_no("axm",g_oga.oga01,g_oga_t.oga01,"43","","","")
            RETURNING li_result,g_oga.oga01
      END IF
      IF g_oga.oga00 ='4' THEN
          CALL s_check_no("axm",g_oga.oga01,g_oga_t.oga01,"44","","","")
            RETURNING li_result,g_oga.oga01
      END IF
      IF g_oga.oga00 ='5' THEN
          CALL s_check_no("axm",g_oga.oga01,g_oga_t.oga01,"46","","","")
            RETURNING li_result,g_oga.oga01
      END IF
   ELSE
      IF g_oga.oga00 MATCHES '[126]' THEN   #No.FUN-610064 oga00='6'
          CALL s_check_no("axm",g_oga.oga01,g_oga_t.oga01,"50","","","")
            RETURNING li_result,g_oga.oga01
      END IF
      IF g_oga.oga00 MATCHES '[37]' THEN   #No.FUN-610064
          CALL s_check_no("axm",g_oga.oga01,g_oga_t.oga01,"53","","","")
            RETURNING li_result,g_oga.oga01
      END IF
      IF g_oga.oga00 ='4' THEN
          CALL s_check_no("axm",g_oga.oga01,g_oga_t.oga01,"54","","","")
            RETURNING li_result,g_oga.oga01
      END IF
      IF g_oga.oga00 ='5' THEN
          CALL s_check_no("axm",g_oga.oga01,g_oga_t.oga01,"56","","","")
            RETURNING li_result,g_oga.oga01
      END IF

    END IF
    IF g_sma.sma120 = 'Y' AND g_sma.sma907 = 'Y' AND NOT cl_null(g_oga.oga16) THEN
       LET g_t1 = g_oga.oga16[1,g_doc_len]
       SELECT oay22 INTO l_oay22_oea FROM oay_file WHERE oayslip =g_t1
       LET g_t1 = g_oga.oga01[1,g_doc_len]
       SELECT oay22 INTO l_oay22_oga FROM oay_file WHERE oayslip =g_t1
       IF (cl_null(l_oay22_oga) AND NOT cl_null(l_oay22_oea)) OR (NOT cl_null(l_oay22_oga) AND cl_null(l_oay22_oea)) THEN
          CALL cl_err('','atm-521',0)
          RETURN FALSE,g_oga.oga01
       END IF
       IF l_oay22_oga <>l_oay22_oea THEN
          CALL cl_err('','atm-521',0)
          RETURN FALSE,g_oga.oga01
       END IF
    END IF
    #得到該單別對應的屬性群組
    IF ( g_sma.sma120 = 'Y' )AND( g_sma.sma907 = 'Y' ) THEN
       #讀取oay_file中指定作業對應的默認屬性群組
       LET g_t1 =g_oga.oga01[1,g_doc_len]
       SELECT oay22 INTO lg_oay22 FROM oay_file WHERE oayslip = g_t1
       #刷新界面顯示
       CALL t600_refresh_detail()
    ELSE
       LET lg_oay22 = ''
    END IF
      DISPLAY BY NAME g_oga.oga01
    RETURN li_result
END FUNCTION


FUNCTION t600_4()
  DEFINE l_oea904            LIKE oea_file.oea904   #TQC-7C0030
    BEGIN WORK

    IF g_oga.oga55 matches'[Ss]' THEN      #送簽中不可更改送貨客戶
       CALL cl_err('','apm-030',0)
       RETURN
    END IF
    
    OPEN t600_cl USING g_oga.oga01
    IF STATUS THEN
       CALL cl_err("OPEN t600_cl:", STATUS, 1)
       CLOSE t600_cl
       ROLLBACK WORK
       RETURN
    END IF

    FETCH t600_cl INTO g_oga.*          # 鎖住將被更改或取消的資料
    IF SQLCA.sqlcode THEN
        CALL cl_err(g_oga.oga01,SQLCA.sqlcode,0)     # 資料被他人LOCK
        CLOSE t600_cl ROLLBACK WORK RETURN
    END IF



    INPUT BY NAME g_oga.oga04 WITHOUT DEFAULTS

           AFTER FIELD oga04
               IF cl_null(g_oga.oga04) THEN
                   NEXT FIELD oga04
               END IF
               SELECT occ02 INTO g_buf FROM occ_file
                WHERE occ01=g_oga.oga04
                  AND occacti='Y'
               IF STATUS THEN
                   CALL cl_err3("sel","occ_file",g_oga.oga04,"",SQLCA.sqlcode,"","select occ",1)  #No.FUN-670008
                   NEXT FIELD oga04
               END IF
               DISPLAY g_buf TO occ02

      ON ACTION controlp
            CASE
               WHEN INFIELD(oga04)
                    CALL cl_init_qry_var()
                   LET g_qryparam.form ="q_occ"   
                    LET g_qryparam.default1 = g_oga.oga04
                    CALL cl_create_qry() RETURNING g_oga.oga04
                    DISPLAY BY NAME g_oga.oga04
                    NEXT FIELD oga04
            END CASE

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT

      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121

      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121

      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121


   END INPUT
   IF INT_FLAG THEN LET INT_FLAG = 0 RETURN END IF

   UPDATE oga_file SET oga04 = g_oga.oga04
    WHERE oga01=g_oga.oga01
   IF STATUS OR SQLCA.SQLCODE THEN
       CALL cl_err3("upd","oga_file",g_oga.oga01,"",SQLCA.sqlcode,"","upd oga04:",1)  #No.FUN-670008
   END IF
   CLOSE t600_cl
   COMMIT WORK

END FUNCTION


#以img09單位來計算雙單位所確定的數量
FUNCTION t600_tot_by_img09(p_item,p_fac2,p_qty2,p_fac1,p_qty1)
  DEFINE p_item    LIKE ima_file.ima01
  DEFINE p_fac2    LIKE img_file.img21
  DEFINE p_qty2    LIKE img_file.img10
  DEFINE p_fac1    LIKE img_file.img21
  DEFINE p_qty1    LIKE img_file.img10
  DEFINE l_ima906  LIKE ima_file.ima906
  DEFINE l_ima907  LIKE ima_file.ima907
  DEFINE l_tot     LIKE img_file.img10

    SELECT ima906,ima907 INTO l_ima906,l_ima907
      FROM ima_file WHERE ima01 = p_item

    IF cl_null(p_fac2) THEN LET p_fac2 = 1 END IF
    IF cl_null(p_qty2) THEN LET p_qty2 = 0 END IF
    IF cl_null(p_fac1) THEN LET p_fac1 = 1 END IF
    IF cl_null(p_qty1) THEN LET p_qty1 = 0 END IF
    IF g_sma.sma115 = 'Y' THEN
       CASE l_ima906
          WHEN '1' LET l_tot=p_qty1*p_fac1
          WHEN '2' LET l_tot=p_qty1*p_fac1+p_qty2*p_fac2
          WHEN '3' LET l_tot=p_qty1*p_fac1
       END CASE
    ELSE  #不使用雙單位
       LET l_tot=p_qty1*p_fac1
    END IF
    IF cl_null(l_tot) THEN LET l_tot = 0 END IF
    RETURN l_tot

END FUNCTION

FUNCTION t600_b_ogd()   # 庫存異動明細(ogc_file)輸入
   DEFINE r_ogc      RECORD LIKE ogc_file.*
   DEFINE l_ogc      DYNAMIC ARRAY OF RECORD
                         ogc17     LIKE ogc_file.ogc17,
                         #ogc12     LIKE ogc_file.ogc12,   #CHI-9C0024
                         ogc09     LIKE ogc_file.ogc09,
                         ogc091    LIKE ogc_file.ogc091,
                         ogc092    LIKE ogc_file.ogc092,
                         ogc12     LIKE ogc_file.ogc12,   #CHI-9C0024
                         #ogc12_1   LIKE ogc_file.ogc12,   #CHI-B30093 #CHI-B60054 mark
                         img10     LIKE img_file.img10, #MOD-530713
                         ogc15     LIKE ogc_file.ogc15,
                         ogc15_fac LIKE ogc_file.ogc15_fac,
                         ogc16     LIKE ogc_file.ogc16,
                         ogc18     LIKE ogc_file.ogc18   #No:FUN-8A0030 
                       END RECORD
   DEFINE l_n          LIKE type_file.num5     #No.FUN-680137 SMALLINT
   DEFINE l_ogc12_t    LIKE ogc_file.ogc12
   DEFINE l_ogc16_t    LIKE ogc_file.ogc16
   DEFINE l_img21      LIKE img_file.img21
   DEFINE l_date       LIKE type_file.dat     #No.FUN-680137 DATE
   DEFINE l_ogc17_t    LIKE ogc_file.ogc17
   DEFINE i,k,s,l_i    LIKE type_file.num5,    #No.FUN-680137 SMALLINT
          l_allow_insert   LIKE type_file.num5,                #可新增否  #No.FUN-680137 SMALLINT
          l_allow_delete   LIKE type_file.num5                 #可刪除否  #No.FUN-680137 SMALLINT
   DEFINE l_ocl01      LIKE ocl_file.ocl01
   DEFINE l_ocm01      LIKE ocm_file.ocm01
   DEFINE l_ocl02      LIKE ocl_file.ocl02   #FUN-640130 add
   DEFINE l_ocl03      LIKE ocl_file.ocl03   #FUN-640130 add
   DEFINE l_ocl04      LIKE ocl_file.ocl04   #FUN-640130 add
   DEFINE l_cnt        LIKE type_file.num5   #TQC-7C0100
   DEFINE l_ocm06      LIKE ocm_file.ocm06   #TQC-7C0100
   DEFINE l_bno        LIKE rvbs_file.rvbs08 #CHI-9A0022
   DEFINE l_oea00      LIKE oea_file.oea00,   #FUN-9C0103
          l_oea11      LIKE oea_file.oea11,   #FUN-9C0103
          l_oea12      LIKE oea_file.oea12,   #FUN-9C0103
          l_oga16      LIKE oga_file.oga16    #FUN-9C0103
   DEFINE g_ogc18      LIKE ogc_file.ogc18   #MOD-B30487
   #DEFINE l_ogc12_1    LIKE ogc_file.ogc12   #CHI-B30093 #CHI-B60054 mark
   #DEFINE l_ogc09_1    LIKE ogc_file.ogc09   #CHI-B30093 #CHI-B60054 mark
   #DEFINE l_ogc091_1   LIKE ogc_file.ogc09   #CHI-B30093 #CHI-B60054 mark


   LET p_row = 2 LET p_col = 2

   OPEN WINDOW t600b_w AT p_row,p_col WITH FORM "axm/42f/axmt600b"
         ATTRIBUTE (STYLE = g_win_style CLIPPED)

   CALL cl_ui_locale("axmt600b")

   CALL t600b_set_no_entry_ogc() #MOD-B30026 add

   IF g_oaz.oaz42 = '2' THEN
      CALL cl_getmsg('axm-041',g_lang) RETURNING g_msg
      CALL cl_set_comp_att_text("a",g_msg CLIPPED)
   END IF

   LET l_date = g_today
   LET l_oea00 = ''   #FUN-9C0103
   LET l_oea11 = ''   #FUN-9C0103
   LET l_oea12 = ''   #FUN-9C0103
   LET l_oga16 = ''   #FUN-9C0103

   IF g_oaz.oaz42 = '1' THEN
      DECLARE t600b_c8 CURSOR FOR
        #SELECT ogc17,ogc12,ogc09,ogc091,ogc092,img10,ogc15,ogc15_fac,ogc16,ogc18   #No:FUN-8A0030   #CHI-9C0024 move ogc12
         SELECT ogc17,ogc09,ogc091,ogc092,ogc12,img10,ogc15,ogc15_fac,ogc16,ogc18   #No:FUN-8A0030   #CHI-9C0024 move ogc12
           FROM ogc_file, OUTER img_file
          WHERE ogc01 = g_oga.oga01
            AND ogc03 = g_ogb[l_ac].ogb03
            AND img01=ogc17
            AND img02=ogc09
            AND img03=ogc091
            AND img04=ogc092

      CALL l_ogc.clear()

      LET i = 1

      LET l_i = 1

      FOREACH t600b_c8 INTO l_ogc[i].*
         IF STATUS THEN
            CALL cl_err('foreach ogc',STATUS,0)
            EXIT FOREACH
         END IF

         LET i = i + 1

      END FOREACH

      CALL l_ogc.deleteElement(i)

      LET i = i - 1

      DECLARE t600b_c7 CURSOR FOR
         SELECT ocl01,ocl06,ocl04,ocl02,ocl03  FROM ocl_file
          WHERE (ocl06<=g_oga.oga02 OR ocl07>=g_oga.oga02)
          ORDER BY ocl01

      FOREACH t600b_c7 INTO l_ocl01,l_date,l_ocl04,l_ocl02,l_ocl03
         IF l_ocl04 = g_ogb[l_ac].ogb04[l_ocl02,l_ocl03] THEN
            IF NOT cl_null(l_ocl01) THEN
               EXIT FOREACH
            END IF
         END IF
      END FOREACH

      DISPLAY l_ocl01,l_date TO FORMONLY.a,FORMONLY.b


      IF i = 0 THEN

         INPUT l_ocl01,l_date WITHOUT DEFAULTS FROM a,b
         
            ON ACTION controlp
               CASE
                  WHEN INFIELD(a)
                     CALL cl_init_qry_var()
                     LET g_qryparam.form ="q_ocl"
                     LET g_qryparam.default1 = l_ocl01
                     CALL cl_create_qry() RETURNING l_ocl01
                     DISPLAY l_ocl01 TO FORMONLY.a
                     NEXT FIELD a
               END CASE
            
            ON IDLE g_idle_seconds
               CALL cl_on_idle()
               CONTINUE INPUT
         
            ON ACTION about         #MOD-4C0121
               CALL cl_about()      #MOD-4C0121
         
            ON ACTION help          #MOD-4C0121
               CALL cl_show_help()  #MOD-4C0121
         
            ON ACTION controlg      #MOD-4C0121
               CALL cl_cmdask()     #MOD-4C0121
         
         END INPUT

      END IF   #FUN-640130 add
   END IF

   IF g_oaz.oaz42 = '2' THEN
      DECLARE t600b_c5 CURSOR FOR
        #SELECT ogc17,ogc12,ogc09,ogc091,ogc092,img10,ogc15,ogc15_fac,ogc16,ogc18   #No:FUN-8A0030   #CHI-9C0024 move ogc12
         SELECT ogc17,ogc09,ogc091,ogc092,ogc12,img10,ogc15,ogc15_fac,ogc16,ogc18   #No:FUN-8A0030   #CHI-9C0024 move ogc12
           FROM ogc_file, OUTER img_file
          WHERE ogc01 = g_oga.oga01 AND ogc03 = g_ogb[l_ac].ogb03
            AND img01=ogc17
            AND img02=ogc09
            AND img03=ogc091
            AND img04=ogc092

      CALL l_ogc.clear()

      LET i = 1

      LET l_i = 1

      FOREACH t600b_c5 INTO l_ogc[i].*
         IF STATUS THEN 
            CALL cl_err('foreach ogc',STATUS,0)
            EXIT FOREACH
         END IF

         LET i = i + 1

      END FOREACH

      CALL l_ogc.deleteElement(i)

      LET i = i - 1

      DECLARE t600b_c6 CURSOR FOR
         SELECT ocm01,ocm03 FROM ocm_file
          WHERE ocm02=g_ogb[l_ac].ogb04
            AND (ocm03<=g_oga.oga02 OR ocm04>=g_oga.oga02)
            AND ocm05 = g_oga.oga03   #FUN-640187 add
          ORDER BY ocm01

      FOREACH t600b_c6 INTO l_ocm01,l_date
         IF NOT cl_null(l_ocm01) THEN EXIT FOREACH END IF
      END FOREACH
      #當參數設定為'替代群組'時, 先check 該客戶,替代群組是否有資料,
      #若無,則再check 客戶是'*',且滿足該替代群組的資料
      IF cl_null(l_ocm01) THEN    #表示沒有符合該客戶的替代群組,抓客戶編號是'*'的
         DECLARE t600b_c61 CURSOR FOR
            SELECT ocm01,ocm03 FROM ocm_file
             WHERE ocm02=g_ogb[l_ac].ogb04
               AND (ocm03<=g_oga.oga02 OR ocm04>=g_oga.oga02)
               AND ocm05 = '*'
             ORDER BY ocm01
         FOREACH t600b_c61 INTO l_ocm01,l_date
            IF NOT cl_null(l_ocm01) THEN EXIT FOREACH END IF
         END FOREACH
      END IF
      DISPLAY l_ocm01,l_date TO FORMONLY.a,FORMONLY.b

      IF i = 0 THEN

      INPUT l_ocm01,l_date WITHOUT DEFAULTS FROM a,b
        ON ACTION controlp
        CASE
            WHEN INFIELD(a)
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_ocm"
                 LET g_qryparam.default1 = l_ocm01
                 CALL cl_create_qry() RETURNING l_ocm01
                 DISPLAY l_ocm01 TO FORMONLY.a
                 NEXT FIELD a
            END CASE

        AFTER FIELD a
           IF cl_null(l_ocm01) THEN
              CALL cl_err('','axm-923',1)   #僅做多倉儲料出貨,不做產品替代!
           END IF

        ON IDLE g_idle_seconds
           CALL cl_on_idle()
           CONTINUE INPUT

         ON ACTION about         #MOD-4C0121
            CALL cl_about()      #MOD-4C0121

         ON ACTION help          #MOD-4C0121
            CALL cl_show_help()  #MOD-4C0121

         ON ACTION controlg      #MOD-4C0121
            CALL cl_cmdask()     #MOD-4C0121

      END INPUT
      END IF   #FUN-640130 add
   END IF

  #空白的話表示僅做多倉儲料出貨                            #CHI-690060 mark
   IF (g_oaz.oaz42 = '1' AND cl_null(l_ocl01)) OR                                      #CHI-690060
      (g_oaz.oaz42 = '2' AND cl_null(l_ocm01)) THEN   #空白的話表示僅做多倉儲料出貨    #CHI-690060
      CALL t600_ogd_ogc()

      DECLARE t600b_c_2 CURSOR FOR      #No:MOD-8B0029 modify
             #SELECT ogc17,ogc12,ogc09,ogc091,ogc092,img10,ogc15,ogc15_fac,ogc16,ogc18  #FUN-8A0030 Add   #CHI-9C0024 move ogc12
              SELECT ogc17,ogc09,ogc091,ogc092,ogc12,img10,ogc15,ogc15_fac,ogc16,ogc18  #FUN-8A0030 Add   #CHI-9C0024 move ogc12
                 FROM ogc_file, OUTER img_file
               WHERE ogc01 = g_oga.oga01 AND ogc03 = g_ogb[l_ac].ogb03
                 AND img_file.img01=g_ogb[l_ac].ogb04
                 AND img_file.img02=ogc09
                 AND img_file.img03=ogc091
                 AND img_file.img04=ogc092
      CALL l_ogc.clear()
      LET i = 1
      LET l_i = 1
      FOREACH t600b_c_2 INTO l_ogc[i].*
         IF STATUS THEN CALL cl_err('foreach ogc',STATUS,0) EXIT FOREACH END IF
         LET i = i + 1
      END FOREACH
      CALL l_ogc.deleteElement(i)
      LET l_i=(i-1)
   ELSE                       #產品替代
      IF i = 0 THEN
         IF g_oaz.oaz42 = '1' THEN
            CALL t600_ogd_ocl(l_ocl01,l_date,'1')
         ELSE
            CALL t600_ogd_ocm(l_ocm01,l_date,'1')
         END IF
      END IF

      DECLARE t600b_c CURSOR FOR
             #SELECT ogc17,ogc12,ogc09,ogc091,ogc092,img10,ogc15,ogc15_fac,ogc16,ogc18  #FUN-8A0030 Add   #CHI-9C0024 move ogc12
              SELECT ogc17,ogc09,ogc091,ogc092,ogc12,img10,ogc15,ogc15_fac,ogc16,ogc18  #FUN-8A0030 Add   #CHI-9C0024 move ogc12
                FROM ogc_file, OUTER img_file
               WHERE ogc01 = g_oga.oga01 AND ogc03 = g_ogb[l_ac].ogb03
                 AND img01=ogc17
                 AND img02=ogc09
                 AND img03=ogc091
                 AND img04=ogc092

      CALL l_ogc.clear()
      LET i = 1
      LET l_i = 1
      FOREACH t600b_c INTO l_ogc[i].*
         IF STATUS THEN CALL cl_err('foreach ogc',STATUS,0) EXIT FOREACH END IF
         LET i = i + 1
      END FOREACH
      CALL l_ogc.deleteElement(i)
      LET l_i=(i-1)
   END IF   #FUN-690078 add

   SELECT SUM(ogc12),SUM(ogc16) INTO l_ogc12_t,l_ogc16_t FROM ogc_file
    WHERE ogc01 = g_oga.oga01 AND ogc03 = g_ogb[l_ac].ogb03

   DISPLAY l_i TO cn2
   DISPLAY l_ogc12_t TO ogc12t
   DISPLAY l_ogc16_t TO ogc16t
   DISPLAY g_ogb[l_ac].ogb12 TO ogb12t   #No:MOD-590206

   LET l_allow_insert = cl_detail_input_auth("insert")
   LET l_allow_delete = cl_detail_input_auth("delete")
   LET i = 1
   CREATE TEMP TABLE ogc_temp(
       ogc01     LIKE ogc_file.ogc01,
       ogc03     LIKE ogc_file.ogc03,
       ogc09     LIKE ogc_file.ogc09,
       ogc091    LIKE ogc_file.ogc091,
       ogc092    LIKE ogc_file.ogc092,
       ogc12     LIKE ogc_file.ogc12,
       ogc15     LIKE ogc_file.ogc15,
       ogc15_fac LIKE ogc_file.ogc15_fac,
       ogc16     LIKE ogc_file.ogc16,
       ogc17     LIKE ogc_file.ogc17,                 
       ogc18     LIKE ogc_file.ogc18,      #TQC-B60155 add 
       ogcplant  LIKE ogc_file.ogcplant,   #TQC-B60155 add
       ogclegal  LIKE ogc_file.ogclegal)   #TQC-B60155 add
   INPUT ARRAY l_ogc WITHOUT DEFAULTS FROM s_ogc.*
         ATTRIBUTE(COUNT=l_i,MAXCOUNT=g_max_rec,UNBUFFERED,
                   INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,
                   APPEND ROW=l_allow_insert)

     BEFORE INPUT
         IF l_i != 0 THEN
            CALL fgl_set_arr_curr(i)
         END IF
         #-----MOD-B30487---------
         LET g_ogc18 = 0
         SELECT MAX(ogc18)+1 INTO g_ogc18 
           FROM ogc_file
          WHERE ogc01 = g_oga.oga01
            AND ogc03 = g_ogb[l_ac].ogb03
         IF cl_null(g_ogc18) OR g_ogc18 = 0 THEN
            LET g_ogc18 = 1
         END IF
         #-----END MOD-B30487-----
         CALL t600_set_entry_ogc(l_ocm01)
         CALL t600_set_no_entry_ogc(l_ocm01)

     BEFORE ROW
        LET i=ARR_CURR()
        LET l_ogc17_t = l_ogc[i].ogc17
        #-----MOD-A60198---------
        #IF cl_null(l_ogc[i].ogc18) OR l_ogc[i].ogc18 = 0 THEN
        #   SELECT MAX(ogc18)+1 INTO l_ogc[i].ogc18
        #     FROM ogc_file 
        #    WHERE ogc01 = g_oga.oga01
        #      AND ogc03 = g_ogb[l_ac].ogb03
        #END IF
        #LET l_cnt=i-1
        #WHILE TRUE
        #   IF  cl_null(l_ogc[i].ogc17) AND l_cnt>=1 THEN
        #       LET l_ogc[i].ogc17=l_ogc[l_cnt].ogc17
        #   ELSE
        #       LET l_cnt=l_cnt-1
        #   END IF
        #   IF l_cnt=0 AND cl_null(l_ogc[i].ogc17) THEN
        #      CALL cl_err('','axm-159',0)
        #      EXIT WHILE
        #   END IF
        #   IF l_cnt <= 0 THEN EXIT WHILE END IF  #MOD-820178 add
        #END WHILE
        #-----END MOD-A60198-----

        CALL cl_show_fld_cont()     #FUN-550037(smin)

     #-----MOD-A60198---------
     BEFORE INSERT 
        IF cl_null(l_ogc[i].ogc18) OR l_ogc[i].ogc18 = 0 THEN
            #-----MOD-B30487---------
            #SELECT MAX(ogc18)+1 INTO l_ogc[i].ogc18
            #  FROM ogc_file 
            # WHERE ogc01 = g_oga.oga01
            #   AND ogc03 = g_ogb[l_ac].ogb03
            LET l_ogc[i].ogc18 = g_ogc18
            #-----END MOD-B30487-----
        END IF
     #-----END MOD-A60198-----

     #-----MOD-B30487---------
     AFTER INSERT
       LET g_ogc18 = g_ogc18 + 1
     #-----END MOD-B30487-----

      AFTER FIELD ogc09                                                                                                              
           #No.FUN-AA0048  --End  
           #LET l_cnt =0                                                                                                            
           #SELECT COUNT(*) INTO l_cnt FROM imd_file                                                                                
           # WHERE imd01=l_ogc[i].ogc09                                                                                          
           #   AND imd20=g_plant                                                                                               
           #IF l_cnt=0 THEN                                                                                                         
           #   CALL cl_err(l_ogc[i].ogc09,'art-487',0)                                                                           
           #   NEXT FIELD ogc09                                                                                                      
           #END IF                                                                                                            
           IF NOT s_chk_ware(l_ogc[i].ogc09) THEN
              NEXT FIELD ogc09 
           END IF
           #No.FUN-AA0048  --End  
     AFTER FIELD ogc17
        IF NOT cl_null(l_ogc[i].ogc17) THEN
#FUN-AA0059 ---------------------start----------------------------
            IF NOT s_chk_item_no(l_ogc[i].ogc17,"") THEN
               CALL cl_err('',g_errno,1)
               LET l_ogc[i].ogc17= l_ogc17_t 
               NEXT FIELD ogc17
            END IF
#FUN-AA0059 ---------------------end-------------------------------

           IF cl_null(l_ogc17_t) OR l_ogc[i].ogc17 != l_ogc17_t THEN
              DELETE FROM ogc_temp
              IF g_oaz.oaz42 = '1' THEN
                 CALL t600_ogd_ocl(l_ocl01,l_date,'2')
              ELSE
                 CALL t600_ogd_ocm(l_ocm01,l_date,'2')
              END IF
              IF g_oaz.oaz42 = '1' THEN
                 SELECT * FROM yyy_tmp,ima_file
                  WHERE ima01=item AND ima01=l_ogc[i].ogc17
              ELSE
                 SELECT COUNT(*) INTO g_cnt FROM ogc_temp
                 DISPLAY g_cnt
                 SELECT ogc17 INTO l_ogc[i].ogc17 FROM ogc_temp
                  WHERE ogc17=l_ogc[i].ogc17
              END IF
              IF STATUS = 100 THEN
                 IF g_oaz.oaz42 = '1' THEN
                    CALL cl_err(l_ogc[i].ogc17,'axm-527',0)
                 ELSE
                    LET l_cnt=0
                    SELECT COUNT(*) INTO l_cnt
                      FROM ocm_file
                     WHERE ocm01=l_ocm01
                       AND ocm02=l_ogc[i].ogc17
                       AND ocm03<=l_date
                    IF l_cnt>0 THEN
                       CALL cl_err('','axm-529',0)#TQC-7C0100
                    ELSE
                       CALL cl_err(l_ogc[i].ogc17,'axm-528',0)
                    END IF
                 END IF
                 NEXT FIELD ogc17
              END IF
           END IF
        END IF
      
      AFTER FIELD ogc12         
         LET g_ima918 = ''   #MOD-9C0055
         LET g_ima921 = ''   #MOD-9C0055
         SELECT ima918,ima921 INTO g_ima918,g_ima921
           FROM ima_file
          WHERE ima01 = l_ogc[i].ogc17   #No:FUN-8B0021
            AND imaacti = "Y"

         IF (g_ima918 = "Y" OR g_ima921 = "Y") AND (l_ogc[i].ogc12<>0) THEN
           #IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add #CHI-AC0034 mark
            #IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR g_argv0='8' OR g_argv0='9' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add #CHI-AC0034 add '8','9'   #MOD-AC0060 
            IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR g_argv0='8' OR g_argv0='9' OR g_argv0='A' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add #CHI-AC0034 add '8','9'   #MOD-AC0060 add 'A'
               SELECT img09 INTO l_ogc[i].ogc15
                 FROM img_file
                WHERE img01 = l_ogc[i].ogc17   #No:FUN-8B0021
                  AND img02 = l_ogc[i].ogc09
                  AND img03 = l_ogc[i].ogc091
                  AND img04 = l_ogc[i].ogc092
               
               DISPLAY l_ogc[i].ogc15 TO s_ogc[j].ogc15

               IF NOT cl_null(l_ogc[i].ogc15) THEN 
                  CALL s_umfchk(l_ogc[i].ogc17,g_ogb[l_ac].ogb05,l_ogc[i].ogc15)   #No:FUN-8B0021
                      RETURNING g_cnt,l_ogc[i].ogc15_fac
                  IF g_cnt=1 THEN
                     CALL cl_err('','mfg3075',1)
                     NEXT FIELD ogc092 
                  END IF
               END IF

               IF cl_null(l_ogc[i].ogc15_fac) THEN
                  LET l_ogc[i].ogc15_fac = 1
               END IF
#CHI-B60054  --mark Begin #mark CHI-B30093和TQC-B50099
#               IF g_argv0 = '8' THEN  #No.TQC-B50099
#CHI-B30093 --begin--  
#                  SELECT ogc09,ogc091 INTO l_ogc09_1,l_ogc091_1 FROM ogc_file, OUTER img_file
#                    WHERE ogc01 = g_oga.oga011 
#                      AND ogc03 = g_ogb[l_ac].ogb03     
#                      AND img01=g_ogb[l_ac].ogb04
#                      AND img02=ogc09
#                      AND img03=ogc091
#                      AND img04=ogc092
#                      AND ogc092=l_ogc[i].ogc092
#                                   
#                   SELECT ogc12 INTO l_ogc12_1 FROM ogc_file
#                    WHERE ogc01 = g_oga.oga011
#                      AND ogc03 = g_ogb[l_ac].ogb03
#                      AND ogc09 = l_ogc09_1
#                      AND ogc091= l_ogc091_1
#                      AND ogc092= l_ogc[i].ogc092
#                      AND ogc17 = g_ogb[l_ac].ogb04
#                   IF cl_null(l_ogc12_1) THEN LET l_ogc12_1 = 0 END IF    
#                   LET l_ogc[i].ogc12_1 = l_ogc12_1 - l_ogc[i].ogc12
#                   IF l_ogc[i].ogc12_1 < 0 THEN 
#                      CALL cl_err('','axm-938',0)
#                      NEXT FIELD CURRENT 
#                   ELSE 
#                   	  DISPLAY BY NAME l_ogc[i].ogc12_1
#                   END IF 
#CHI-B30093 --end--  
#                END IF #No.TQC-B50099
#CHI-B60054  --mark End #mark CHI-B30093和TQC-B50099
#No.CHI-9A0022 --Begin
               IF cl_null(g_ogb[l_ac].ogb41) THEN
                  #FUN-9C0103 ---start---
                  SELECT oea00,oea11,oea12 INTO l_oea00,l_oea11,l_oea12
                    FROM oea_file
                   WHERE oea01 = g_ogb[l_ac].ogb31
                  IF l_oea00 = '4' AND l_oea11 = '7' THEN
                     SELECT oga16 INTO l_oga16
                       FROM oga_file
                      WHERE oga01 = l_oea12
                     LET l_bno = l_oga16
                  ELSE
                  #FUN-9C0103  ---end---
                     LET l_bno = g_ogb[l_ac].ogb31
                  END IF
               ELSE
                  LET l_bno = g_ogb[l_ac].ogb41
               END IF
#No.CHI-9A0022 --End
               CALL s_lotout(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,l_ogc[i].ogc18,
                             l_ogc[i].ogc17,l_ogc[i].ogc09,
                             l_ogc[i].ogc091,l_ogc[i].ogc092,
                             g_ogb[l_ac].ogb05,l_ogc[i].ogc15,l_ogc[i].ogc15_fac,
                             l_ogc[i].ogc12,l_bno,'MOD')#CHI-9A0022 add l_bno
                   RETURNING l_r,g_qty
               IF l_r = "Y" THEN
                  LET l_ogc[i].ogc12 = g_qty
               END IF
            END IF
         END IF

     AFTER ROW
        IF INT_FLAG THEN                 #900423
           CALL cl_err('',9001,0)
           #按放棄離開時,應不寫入ogc_file
           EXIT INPUT
        END IF
        IF l_ogc[i].ogc12 IS NOT NULL AND l_ogc[i].ogc12 != 0 THEN
           IF l_ogc[i].ogc09 IS NULL THEN LET l_ogc[i].ogc09 = ' ' END IF
           IF l_ogc[i].ogc091 IS NULL THEN LET l_ogc[i].ogc091 = ' ' END IF
           IF l_ogc[i].ogc092 IS NULL THEN LET l_ogc[i].ogc092 = ' ' END IF
           SELECT img10,img09,img21 INTO l_ogc[i].img10,l_ogc[i].ogc15,l_img21
             FROM img_file
            WHERE img01 = l_ogc[i].ogc17    AND img02 = l_ogc[i].ogc09
              AND img03 = l_ogc[i].ogc091   AND img04 = l_ogc[i].ogc092
           IF STATUS THEN
              CALL cl_err3("sel","img_file","","",SQLCA.sqlcode,"","sel img",1)  #No.FUN-670008
           END IF

           DISPLAY l_ogc[i].img10 TO s_ogc[j].img10
           DISPLAY l_ogc[i].ogc15 TO s_ogc[j].ogc15
           CALL s_umfchk(l_ogc[i].ogc17,g_ogb[l_ac].ogb05,l_ogc[i].ogc15)
                         RETURNING g_cnt,l_ogc[i].ogc15_fac
           IF g_cnt=1 THEN CALL cl_err('','mfg3075',1) NEXT FIELD ogc092 END IF
           IF cl_null(l_ogc[i].ogc15_fac) THEN LET l_ogc[i].ogc15_fac=1 END IF
           LET l_ogc[i].ogc16 = l_ogc[i].ogc12 * l_ogc[i].ogc15_fac
           DISPLAY l_ogc[i].ogc16 TO s_ogc[j].ogc16
        END IF

        IF l_ogc[i].ogc12 IS NOT NULL AND l_ogc[i].ogc12 <> 0 THEN
           FOR k = 1 TO l_ogc.getLength()
               IF k=i THEN CONTINUE FOR END IF
               IF l_ogc[k].ogc09 = l_ogc[i].ogc09 AND
                  l_ogc[k].ogc091= l_ogc[i].ogc091 AND
                  l_ogc[k].ogc092= l_ogc[i].ogc092 AND
                  l_ogc[k].ogc17 = l_ogc[i].ogc17 THEN
                  INITIALIZE l_ogc[i].* TO NULL DISPLAY l_ogc[i].* TO s_ogc[j].*
                  CALL cl_err('',-239,0) EXIT FOR
               END IF
           END FOR
        END IF

        LET l_ogc12_t = 0
        LET l_ogc16_t = 0
        FOR k = 1 TO l_ogc.getLength()
           IF l_ogc[k].ogc12 IS NOT NULL AND l_ogc[k].ogc12 <> 0 THEN
              LET l_ogc12_t = l_ogc12_t + l_ogc[k].ogc12
              LET l_ogc16_t = l_ogc16_t + l_ogc[k].ogc16 #/ l_ogc[k].ogc15_fac
           END IF
        END FOR
        DISPLAY l_ogc12_t TO ogc12t
        DISPLAY l_ogc16_t TO ogc16t

     AFTER INPUT
        IF l_ogc12_t != g_ogb[l_ac].ogb12 THEN
           IF cl_confirm('axm-170') THEN
              EXIT INPUT
           ELSE
              NEXT FIELD ogc09
           END IF
        END IF

      ON ACTION controlp
            CASE
                WHEN INFIELD(ogc17)
                   CALL cl_init_qry_var()
                   LET g_qryparam.form ="q_ocm2"   #TQC-7C0100
                   LET g_qryparam.default1 = l_ogc[i].ogc17
                   LET g_qryparam.arg1 = l_ocm01   #FUN-640130 add
                   SELECT ocm06 INTO l_ocm06
                     FROM ocm_file
                    WHERE ocm01=l_ocm01
                      AND ocm05=l_ogc[i].ogc17
                   LET g_qryparam.arg2 = l_ocm06
                   CALL cl_create_qry() RETURNING l_ogc[i].ogc17
                   DISPLAY l_ogc[i].ogc17 TO ogc17  #No.MOD-490172
                   NEXT FIELD ogc17
                WHEN INFIELD(ogc09)
                   IF g_azw.azw04='2' THEN
                      CALL q_img42(FALSE,FALSE,l_ogc[i].ogc17,'','','','A','1',g_oga.ogaplant)                                  
                      RETURNING l_ogc[i].ogc09,l_ogc[i].ogc091,l_ogc[i].ogc092
                   ELSE
                   CALL q_img4(FALSE,FALSE,l_ogc[i].ogc17,' ',' ',' ','A')
                            RETURNING l_ogc[i].ogc09,l_ogc[i].ogc091,
                                      l_ogc[i].ogc092
                   END IF #No.FUN-870007
                      DISPLAY BY NAME l_ogc[i].ogc09,l_ogc[i].ogc091,l_ogc[i].ogc092         #No:MOD-490371
                     NEXT FIELD ogc09
                WHEN INFIELD(ogc091)
                     #No.FUN-AA0048  --Begin
                     #CALL cl_init_qry_var()
                     #LET g_qryparam.form = "q_ime"
                     #LET g_qryparam.default1 = l_ogc[i].ogc091
                     #LET g_qryparam.arg1     = l_ogc[i].ogc09 #倉庫編號 #MOD-4A0063
                     #LET g_qryparam.arg2     = 'SW'           #倉庫類別 #MOD-4A0063
                     #CALL cl_create_qry() RETURNING l_ogc[i].ogc091
                     CALL q_ime_1(FALSE,TRUE,l_ogc[i].ogc091,l_ogc[i].ogc09,"","","","","") RETURNING l_ogc[i].ogc091
                     #No.FUN-AA0048  --End  
                      DISPLAY BY NAME l_ogc[i].ogc091        #No:MOD-490371
                     NEXT FIELD ogc091
            END CASE

      
      ON ACTION modi_lot
         LET g_ima918 = ''   #MOD-9C0055
         LET g_ima921 = ''   #MOD-9C0055
         SELECT ima918,ima921 INTO g_ima918,g_ima921
           FROM ima_file
          WHERE ima01 = l_ogc[i].ogc17 
            AND imaacti = "Y"

         IF (g_ima918 = "Y" OR g_ima921 = "Y") AND (l_ogc[i].ogc12<>0) THEN
            IF g_argv0='2' OR g_argv0='4' OR g_argv0='6' OR ((g_argv0 ='1' OR g_argv0='5') AND g_oaz.oaz81 = 'Y') THEN   #MOD-940294 add
               SELECT img09 INTO l_ogc[i].ogc15
                 FROM img_file
                WHERE img01 = l_ogc[i].ogc17
                  AND img02 = l_ogc[i].ogc09
                  AND img03 = l_ogc[i].ogc091
                  AND img04 = l_ogc[i].ogc092
               
               DISPLAY l_ogc[i].ogc15 TO s_ogc[j].ogc15

               IF NOT cl_null(l_ogc[i].ogc15) THEN 
                  CALL s_umfchk(l_ogc[i].ogc17,g_ogb[l_ac].ogb05,l_ogc[i].ogc15)
                      RETURNING g_cnt,l_ogc[i].ogc15_fac
                  IF g_cnt=1 THEN
                     CALL cl_err('','mfg3075',1)
                     NEXT FIELD ogc092 
                  END IF
               END IF

               IF cl_null(l_ogc[i].ogc15_fac) THEN
                  LET l_ogc[i].ogc15_fac = 1
               END IF


#No.CHI-9A0022 --Begin
               IF cl_null(g_ogb[l_ac].ogb41) THEN
                  #FUN-9C0103 ---start---
                  SELECT oea00,oea11,oea12 INTO l_oea00,l_oea11,l_oea12
                    FROM oea_file
                   WHERE oea01 = g_ogb[l_ac].ogb31
                  IF l_oea00 = '4' AND l_oea11 = '7' THEN
                     SELECT oga16 INTO l_oga16
                       FROM oga_file
                      WHERE oga01 = l_oea12
                     LET l_bno = l_oga16
                  ELSE
                  #FUN-9C0103 ---end---
                     LET l_bno = g_ogb[l_ac].ogb31
                  END IF 
               ELSE
                  LET l_bno = g_ogb[l_ac].ogb41
               END IF
#No.CHI-9A0022 --End
               CALL s_lotout(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,l_ogc[i].ogc18,
                             l_ogc[i].ogc17,l_ogc[i].ogc09,
                             l_ogc[i].ogc091,l_ogc[i].ogc092,
                             g_ogb[l_ac].ogb05,l_ogc[i].ogc15,l_ogc[i].ogc15_fac,
                             l_ogc[i].ogc12,l_bno,'MOD')#CHI-9A0022 add l_bno
                   RETURNING l_r,g_qty
               IF l_r = "Y" THEN
                  LET l_ogc[i].ogc12 = g_qty
               END IF
            END IF
         END IF

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT

      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121

      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121

      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121


   END INPUT

   IF INT_FLAG THEN
       LET g_success='N' # No:8641
      CALL cl_err('',9001,0)
      LET INT_FLAG = 0
      CLOSE WINDOW t600b_w
      RETURN
   END IF

   CLOSE WINDOW t600b_w
   DELETE FROM ogc_file WHERE ogc01 = g_oga.oga01 AND ogc03 = g_ogb[l_ac].ogb03
   FOR i = 1 TO l_ogc.getLength()
       IF l_ogc[i].ogc12 IS NULL OR l_ogc[i].ogc12=0 THEN
         IF s_lotout_del(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,l_ogc[i].ogc18,l_ogc[i].ogc17,'DEL') THEN   #No:FUN-8B0021
            CONTINUE FOR
         END IF
       END IF 
           IF cl_null(l_ogc[i].ogc09) THEN LET l_ogc[i].ogc09=' ' END IF
           IF cl_null(l_ogc[i].ogc091) THEN LET l_ogc[i].ogc091=' ' END IF
           IF cl_null(l_ogc[i].ogc092) THEN LET l_ogc[i].ogc092=' ' END IF
           IF cl_null(l_ogc[i].ogc17) THEN LET l_ogc[i].ogc17=' ' END IF
       INSERT INTO ogc_file(ogc01,ogc03,ogc09,ogc091,ogc092, 
                             ogc12,ogc15,ogc15_fac,ogc16,ogc17,ogc18,  #No.MOD-470041   #FUN-8A0030 Add ogc18
                            ogcplant,ogclegal)   #FUN-980010 add plant & legal 
              VALUES(g_oga.oga01,g_ogb[l_ac].ogb03,
                     l_ogc[i].ogc09, l_ogc[i].ogc091, l_ogc[i].ogc092,
                     l_ogc[i].ogc12,
                     l_ogc[i].ogc15, l_ogc[i].ogc15_fac, l_ogc[i].ogc16,l_ogc[i].ogc17,l_ogc[i].ogc18,   #FUN-8A0030 Add ogc18
                     g_plant, g_legal ) 
       IF SQLCA.sqlcode THEN
          CALL cl_err3("ins","ogc_file","","",SQLCA.sqlcode,"","INS-ogc",1)  #No.FUN-670008
          LET g_success = 'N' EXIT FOR
       END IF
    END FOR
END FUNCTION

FUNCTION t600_ogd_ocl(p_ocl01,p_date,p_type)
DEFINE  r_ogc   RECORD LIKE ogc_file.*
DEFINE  p_ocl01 LIKE ocl_file.ocl01
DEFINE  p_date  LIKE type_file.dat     #No.FUN-680137 DATE
DEFINE  p_type  LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)
DEFINE  l_ocl02      LIKE ocl_file.ocl02
DEFINE  l_ocl03      LIKE ocl_file.ocl03
DEFINE  l_ocl04      LIKE ocl_file.ocl04
DEFINE  l_ocl05      LIKE ocl_file.ocl05
DEFINE  l_ocl07      LIKE ocl_file.ocl07
#carrier
DEFINE  l_len        LIKE type_file.num5    #No.FUN-680137 SMALLINT
DEFINE  l_ogc18      LIKE ogc_file.ogc18    #No:FUN-8A0030
       DROP TABLE yyy_tmp;
       CREATE TEMP TABLE yyy_tmp(
       item      LIKE ogc_file.ogc17,
       n1        LIKE type_file.num5,
       n2        LIKE type_file.num5);
      DECLARE t600b_car_c1 CURSOR FOR
       SELECT ocl02,ocl03,ocl04,ocl05,ocl07 FROM ocl_file
        WHERE ocl06 <= p_date
          AND ocl01 = p_ocl01
        ORDER BY ocl02,ocl03
      FOREACH t600b_car_c1 INTO l_ocl02,l_ocl03,l_ocl04,l_ocl05,l_ocl07
         LET g_pno=g_ogb[l_ac].ogb04
         IF NOT cl_null(l_ocl07) AND l_ocl07 < p_date THEN
            CONTINUE FOREACH
         END IF
         IF g_pno[l_ocl02,l_ocl03]=l_ocl04 THEN
            LET g_pno[l_ocl02,l_ocl03]=l_ocl05
         ELSE
            CONTINUE FOREACH
         END IF
         INSERT INTO yyy_tmp VALUES(g_pno,l_ocl02,l_ocl03)
      END FOREACH
      LET l_len=length(g_ogb[l_ac].ogb04)
      FOREACH t600b_car_c1 INTO l_ocl02,l_ocl03,l_ocl04,l_ocl05,l_ocl07
         LET g_sql="INSERT INTO yyy_tmp ",
                  #" SELECT item[1,",l_ocl02-1,"]||'",l_ocl05,"'||item[",l_ocl02,",",l_len,"],99,99",    #CHI-690060  #FUN-9B0039 mod #MOD-B50142 mark
                   " SELECT item[1,",l_ocl02-1,"]||'",l_ocl05,"'||item[",l_ocl03+1,",",l_len,"],99,99",    #MOD-B50142
                   "   FROM yyy_tmp "
         PREPARE t600_car_c2 FROM g_sql
         EXECUTE t600_car_c2
      END FOREACH

      DECLARE t600_b_c1 CURSOR FOR
       SELECT UNIQUE item FROM yyy_tmp
        WHERE item <> g_ogb[l_ac].ogb04
      LET l_ogc18 = 0   #MOD-A80192
      FOREACH t600_b_c1 INTO g_pno
         SELECT * FROM ima_file WHERE ima01=g_pno
         IF STATUS = 100 THEN
            CONTINUE FOREACH
         END IF
#end carrier
         IF g_oaz.oaz71='1' THEN   #oaz71: 出貨異動明細自動賦予方式
            LET r_ogc.ogc01 = g_oga.oga01
            LET r_ogc.ogc03 = b_ogb.ogb03         #CHI-690060
            LET r_ogc.ogc12 = b_ogb.ogb12
            LET r_ogc.ogc09 = b_ogb.ogb09
            LET r_ogc.ogc091= b_ogb.ogb091
            LET r_ogc.ogc092= b_ogb.ogb092
            LET r_ogc.ogc15 = b_ogb.ogb15
            LET r_ogc.ogc15_fac = b_ogb.ogb15_fac
            LET r_ogc.ogc16 = b_ogb.ogb16
            LET r_ogc.ogc17 = g_pno
            #LET r_ogc.ogc18 = 1                   #No:FUN-8A0030   #MOD-A80192
            LET l_ogc18 = l_ogc18 + 1   #MOD-A80192
            LET r_ogc.ogc18 = l_ogc18   #MOD-A80192
            IF p_type = '1' THEN

               LET r_ogc.ogcplant = g_plant 
               LET r_ogc.ogclegal = g_legal  

               INSERT INTO ogc_file VALUES (r_ogc.*)
            END IF
         ELSE
            DECLARE t600_b_c3 CURSOR FOR
             SELECT '','',img02,img03,img04,0,img09,0,0,img01,'' FROM img_file       #FUN-8A0030 Add ''
              WHERE img01 = g_pno
                AND img10 > 0 AND (img18 > g_oga.oga02 OR img18 IS NULL)
              #LET l_ogc18 = 0    #No:FUN-8A0030      #MOD-A80192
            FOREACH t600_b_c3 INTO r_ogc.*
              IF STATUS THEN EXIT FOREACH END IF
               LET r_ogc.ogc01 = g_oga.oga01
               LET r_ogc.ogc03 = g_ogb[l_ac].ogb03
               LET l_ogc18 = l_ogc18 + 1    #No:FUN-8A0030
               LET r_ogc.ogc18 = l_ogc18    #No:FUN-8A0030
               IF p_type = '1' THEN

                  LET r_ogc.ogcplant = g_plant 
                  LET r_ogc.ogclegal = g_legal  

                  INSERT INTO ogc_file VALUES (r_ogc.*)
               END IF
            END FOREACH
         END IF
      END FOREACH
END FUNCTION

FUNCTION t600_ogd_ocm(p_ocm01,p_date,p_type)
DEFINE  r_ogc   RECORD LIKE ogc_file.*
DEFINE  p_ocm01 LIKE ocm_file.ocm01
DEFINE  p_date  LIKE type_file.dat     #No.FUN-680137 DATE
DEFINE  p_type  LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)
DEFINE  l_ocm02 LIKE ocm_file.ocm02
DEFINE  l_ocm04 LIKE ocm_file.ocm04
DEFINE  l_n     LIKE type_file.num10                #FUN-640187 add                                                                             #No.FUN-680137 INTEGER
DEFINE  l_ocm05 LIKE ocm_file.ocm05   #FUN-640187 add
DEFINE  l_ogc18 LIKE ogc_file.ogc18   #No:FUN-8A0030

   SELECT COUNT(ocm06) INTO l_n FROM ocm_file
     WHERE ocm01 = p_ocm01
       AND ocm02 = g_ogb[l_ac].ogb04
       AND ocm03 <=p_date
       AND ocm05 = g_oga.oga03
   IF l_n = 0 THEN LET l_ocm05 = '*' ELSE LET l_ocm05 = g_oga.oga03 END IF

     DECLARE t600b_c2 CURSOR FOR
       SELECT ocm02,ocm04 FROM ocm_file
        WHERE ocm03 <= p_date # AND ocm04 >= p_date
          AND ocm01 = p_ocm01
          AND ocm05 = l_ocm05                            #FUN-640187 add
          AND ocm06 <= (SELECT ocm06 FROM ocm_file       #FUN-640187 add
                         WHERE ocm01=p_ocm01             #FUN-640187 add
                           AND ocm02=g_ogb[l_ac].ogb04   #FUN-640187 add
                           AND ocm05=l_ocm05)            #FUN-640187 add
      LET l_ogc18 = 0   #MOD-A80192 
      FOREACH t600b_c2 INTO l_ocm02,l_ocm04
         IF NOT cl_null(l_ocm04) AND l_ocm04 < p_date THEN
            CONTINUE FOREACH
         END IF


         IF g_oaz.oaz71='1' THEN    #oaz71: 出貨異動明細自動賦予方式
            LET r_ogc.ogc01 = g_oga.oga01
            LET r_ogc.ogc03 = g_ogb[l_ac].ogb03
            LET r_ogc.ogc12 = b_ogb.ogb12
            LET r_ogc.ogc09 = g_ogb[l_ac].ogb09
            LET r_ogc.ogc091= g_ogb[l_ac].ogb091
            LET r_ogc.ogc092= g_ogb[l_ac].ogb092
            LET r_ogc.ogc15 = b_ogb.ogb15
            LET r_ogc.ogc15_fac = b_ogb.ogb15_fac
            LET r_ogc.ogc16 = b_ogb.ogb16
            LET r_ogc.ogc17 = l_ocm02
            LET r_ogc.ogc17 = r_ogc.ogc17 CLIPPED   #FUN-630102 add
            #LET r_ogc.ogc18 = 1                     #No:FUN-8A0030   #MOD-A80192
            LET l_ogc18 = l_ogc18 + 1   #MOD-A80192
            LET r_ogc.ogc18 = l_ogc18   #MOD-A80192

            LET r_ogc.ogcplant = g_plant 
            LET r_ogc.ogclegal = g_legal  

            IF p_type = '1' THEN
               INSERT INTO ogc_file VALUES (r_ogc.*)
            ELSE
               INSERT INTO ogc_temp VALUES (r_ogc.*)
            END IF
         ELSE
            DECLARE t600b_c4 CURSOR FOR
             SELECT '','',img02,img03,img04,0,img09,0,0,img01,'' FROM img_file        #FUN-8A0030 add ''
              WHERE img01 = l_ocm02
                AND img10 > 0 AND (img18 > g_oga.oga02 OR img18 IS NULL)
              #LET l_ogc18 = 0    #No:FUN-8A0030     #MOD-A80192
            FOREACH t600b_c4 INTO r_ogc.*
              IF STATUS THEN EXIT FOREACH END IF
               LET r_ogc.ogc01 = g_oga.oga01
               LET r_ogc.ogc03 = g_ogb[l_ac].ogb03
               LET r_ogc.ogc17 = r_ogc.ogc17 CLIPPED   #FUN-630102 add
               LET l_ogc18 = l_ogc18 + 1    #No:FUN-8A0030
               LET r_ogc.ogc18 = l_ogc18    #No:FUN-8A0030

               LET r_ogc.ogcplant = g_plant 
               LET r_ogc.ogclegal = g_legal  

               IF p_type = '1' THEN
                  INSERT INTO ogc_file VALUES (r_ogc.*)
               ELSE
                  INSERT INTO ogc_temp VALUES (r_ogc.*)
               END IF
            END FOREACH
         END IF
      END FOREACH
END FUNCTION

FUNCTION t600_ogb32(p_ogb31,p_ogb32)
DEFINE p_ogb31 LIKE ogb_file.ogb31,
       p_ogb32 LIKE ogb_file.ogb32,
       p_ogb04 LIKE ogb_file.ogb04,
       p_ogb11 LIKE ogb_file.ogb11,
       p_ogb37 LIKE ogb_file.ogb37, #FUN-AB0061
       p_ogb13 LIKE ogb_file.ogb13,
       p_ogb14 LIKE ogb_file.ogb14,
       p_ogb14t LIKE ogb_file.ogb14t,
       p_ogb15 LIKE ogb_file.ogb15,
       p_ogb19 LIKE ogb_file.ogb19,
       p_ogb1001 LIKE ogb_file.ogb1001,
       p_ogb1012 LIKE ogb_file.ogb1012,
       p_ogb1002 LIKE ogb_file.ogb1002,
       p_ogb1003 LIKE ogb_file.ogb1003,
       p_ogb1004 LIKE ogb_file.ogb1004,
       p_ogb1005 LIKE ogb_file.ogb1005,
       p_ogb1006 LIKE ogb_file.ogb1006,
       p_ogb1007 LIKE ogb_file.ogb1007,
       p_tqw14 LIKE tqw_file.tqw14,
       p_tqw16 LIKE tqw_file.tqw16,
       p_tqw08 LIKE tqw_file.tqw08,
       p_tqw081 LIKE tqw_file.tqw081,
       p_ogb1008 LIKE ogb_file.ogb1008,
       p_ogb1009 LIKE ogb_file.ogb1009,
       p_ogb1010 LIKE ogb_file.ogb1010,
       p_ogb1011 LIKE ogb_file.ogb1011,
       p_ogb41 LIKE ogb_file.ogb41,
       p_ogb42 LIKE ogb_file.ogb42,
       p_ogb43 LIKE ogb_file.ogb43,
       p_ogb12  LIKE ogb_file.ogb12,        #No.FUN-670008
       p_ogb912 LIKE ogb_file.ogb912,       #No.FUN-670008
       p_ogb915 LIKE ogb_file.ogb915,       #No.FUN-670008
       p_ogb917 LIKE ogb_file.ogb917,       #No.FUN-670008
       l_azf10 LIKE azf_file.azf10,         #No.FUN-6B0065
       l_ogb14 LIKE ogb_file.ogb14,         #No.FUN-670008
       l_ogb14t LIKE ogb_file.ogb14t,       #No.FUN-670008
       l_ship_qty LIKE ogb_file.ogb12,      #No.FUN-670008
       l_ogb912 LIKE ogb_file.ogb912,       #No.FUN-670008
       l_ogb915 LIKE ogb_file.ogb915,       #No.FUN-670008
       l_ogb917 LIKE ogb_file.ogb917,       #No.FUN-670008
       l_ohb912 LIKE ohb_file.ohb912,       #No.FUN-670008
       l_ohb915 LIKE ohb_file.ohb915,       #No.FUN-670008
       l_ohb917 LIKE ohb_file.ohb917,       #No.FUN-670008
       l_retn_qty  LIKE ohb_file.ohb12,     #No.FUN-670008
       l_retn_amt  LIKE ohb_file.ohb14,     #No.FUN-670008
       #-----MOD-A50076---------
       l_retn_qty_2 LIKE ogb_file.ogb12,  
       l_ogb912_2 LIKE ogb_file.ogb912,     
       l_ogb915_2 LIKE ogb_file.ogb915,     
       l_ogb917_2 LIKE ogb_file.ogb917      
       #-----END MOD-A50076-----
DEFINE p_ogb44 LIKE ogb_file.ogb44,         #No.FUN-870007
       p_ogb45 LIKE ogb_file.ogb45,         #No.FUN-870007
       p_ogb46 LIKE ogb_file.ogb46,         #No.FUN-870007
       p_ogb47 LIKE ogb_file.ogb47          #No.FUN-870007

   IF NOT cl_null(p_ogb31) AND (NOT cl_null(p_ogb32))  THEN
      SELECT oeb1003 INTO p_ogb1005 FROM oeb_file
       WHERE oeb01 = p_ogb31
         AND oeb03 = p_ogb32

      IF p_ogb1005 ='1' THEN
         CALL cl_set_comp_entry("ogb1001,ogb04,ogb05,ogb11,ogb1004,ogb13,ogb14,ogb14t,ogb916,ogb1001,ogb1003,ogb1004,ogb1006,ogb913,ogb910" ,FALSE)
      ELSE
         CALL cl_set_comp_entry("ogb1001" ,FALSE)
      END IF

      SELECT oeb04,oeb1003,oeb11,oeb37,oeb13,oeb1001,oeb1012,oeb1004,oeb1002,oeb15,oeb14,oeb14t,     #No.TQC-640123  #FUN-AB0061
             oeb1006,oeb1007,oeb1008,oeb1009,oeb1010,oeb1011,oeb906,oeb12,oeb912,oeb915,oeb917,  #No.FUN-670008        #No.TQC-6C0085 modify oeb19->oeb906
             oeb41,oeb42,oeb43,
             oeb44,oeb45,oeb46,oeb47  #No.FUN-870007
        INTO p_ogb04,p_ogb1005,p_ogb11,p_ogb37,p_ogb13,p_ogb1001,p_ogb1012,p_ogb1004,p_ogb1002,p_ogb1003,p_ogb14,p_ogb14t,    #No.TQC-640123  #No.TQC-6C0085 modify p_ogb15->p_ogb1003 #FUN-AB0061
             p_ogb1006,p_ogb1007,p_ogb1008,p_ogb1009,p_ogb1010,p_ogb1011,p_ogb19,p_ogb12,p_ogb912,p_ogb915,p_ogb917,   #No.FUN-670008
             p_ogb41,p_ogb42,p_ogb43,
             p_ogb44,p_ogb45,p_ogb46,p_ogb47  #No.FUN-870007
        FROM oeb_file
       WHERE oeb01 = p_ogb31
         AND oeb03 = p_ogb32

      IF p_ogb1010 ='Y' THEN
         LET p_tqw08 = p_ogb14t
         SELECT SUM(ogb14t) INTO p_tqw081 FROM ogb_file,oga_file
          WHERE ogb31 = p_ogb31
            AND ogb32 = p_ogb32
            AND oga01 = ogb01
            AND ogapost = 'Y'
            AND ogaconf !='X' #CHI-6B0036
         SELECT SUM(ohb14t) INTO l_retn_amt FROM ohb_file,oha_file
          WHERE ohb33 =p_ogb31
            AND ohb34 =p_ogb32
            AND oha01 =ohb01
            AND ohapost ='Y'
      ELSE
         LET p_tqw08 = p_ogb14
         SELECT SUM(ogb14) INTO p_tqw081 FROM ogb_file,oga_file
          WHERE ogb31 = p_ogb31
            AND ogb32 = p_ogb32
            AND oga01 = ogb01
            AND ogapost = 'Y'
            AND ogaconf !='X'  #CHI-6B0036
         SELECT SUM(ohb14) INTO l_retn_amt FROM ohb_file,oha_file
          WHERE ohb33 =p_ogb31
            AND ohb34 =p_ogb32
            AND oha01 =ohb01
            AND ohapost ='Y'
      END IF
      IF cl_null(p_tqw081) THEN
         LET p_tqw081 =0
      END IF
      IF cl_null(l_retn_amt) THEN
         LET l_retn_amt =0
      END IF
      LET p_tqw081 =p_tqw081-l_retn_amt

      SELECT SUM(ogb12),SUM(ogb912),SUM(ogb915),SUM(ogb917)
        INTO l_ship_qty,l_ogb912,l_ogb915,l_ogb917
        FROM ogb_file,oga_file
       WHERE oga01 = ogb01
         AND ogb31 =p_ogb31
         AND ogb32 =p_ogb32
         AND oga09 =g_argv0 # 1.出貨通知單 2.出貨單
         AND ogaconf = 'Y'

      IF l_ship_qty IS NULL THEN LET l_ship_qty = 0 END IF
      IF l_ogb912 IS NULL   THEN LET l_ogb912   = 0 END IF
      IF l_ogb915 IS NULL   THEN LET l_ogb915   = 0 END IF
      IF l_ogb917 IS NULL   THEN LET l_ogb917   = 0 END IF

      SELECT SUM(ohb12),SUM(ohb912),SUM(ohb915),SUM(ohb917)
        INTO l_retn_qty,l_ohb912,l_ohb915,l_ohb917
        FROM ohb_file,oha_file
       WHERE oha01 = ohb01
         AND ohb33 =p_ogb31
         AND ohb34 =p_ogb32
         AND ohaconf = 'Y'
         AND oha09 ='4'      #MOD-840086 add

      IF l_retn_qty IS NULL THEN LET l_retn_qty = 0 END IF
      IF l_ohb912 IS NULL   THEN LET l_ohb912   = 0 END IF
      IF l_ohb915 IS NULL   THEN LET l_ohb915   = 0 END IF
      IF l_ohb917 IS NULL   THEN LET l_ohb917   = 0 END IF

      #-----MOD-A50076---------
      LET l_retn_qty_2 = 0 
      LET l_ogb912_2 = 0 
      LET l_ogb915_2 = 0 
      LET l_ogb917_2 = 0 
      SELECT SUM(ogb12),SUM(ogb912),SUM(ogb915),SUM(ogb917)
        INTO l_retn_qty_2,l_ogb912_2,l_ogb915_2,l_ogb917_2
        FROM ogb_file,oga_file
       WHERE oga01 = ogb01
         AND ogb31 = p_ogb31
         AND ogb32 = p_ogb32
         AND oga09 = '9'
         AND ogaconf = 'Y'
         AND ogapost = 'Y'

      IF cl_null(l_retn_qty_2) THEN LET l_retn_qty_2 = 0 END IF
      IF cl_null(l_ogb912_2)   THEN LET l_ogb912_2 = 0 END IF
      IF cl_null(l_ogb915_2)   THEN LET l_ogb915_2 = 0 END IF
      IF cl_null(l_ogb917_2)   THEN LET l_ogb917_2 = 0 END IF
      #-----END MOD-A50076-----

   ELSE
       IF p_ogb1005 = '1' THEN
          CALL cl_set_comp_entry("ogb1001,ogb04,ogb05,ogb11,ogb13,ogb14,ogb14t,ogb1001,ogb1003,ogb1004,ogb1006,ogb913,ogb910" ,TRUE)   #No.TQC-640123
       ELSE
          CALL cl_set_comp_entry("b2_1001" ,TRUE)   #No.TQC-640123
       END IF

   END IF

       SELECT SUM(ogb14),SUM(ogb14t) INTO l_ogb14,l_ogb14t
         FROM ogb_file,oga_file
        WHERE ogb01 =oga01
          AND ogb31 =p_ogb31
          AND ogb32 =p_ogb32
          AND ogaconf ='Y'
       IF cl_null(l_ogb14) THEN
          LET l_ogb14 =0
       END IF
       IF cl_null(l_ogb14t) THEN
          LET l_ogb14t =0
       END IF

   IF  p_ogb1005 ='1' THEN
       LET g_ogb[l_ac].ogb04 = p_ogb04
       LET g_ogb[l_ac].ogb11 = p_ogb11
       LET g_ogb[l_ac].ogb14 = p_ogb14 -l_ogb14+l_retn_amt       #No.FUN-670008
       LET g_ogb[l_ac].ogb14t = p_ogb14t -l_ogb14t+l_retn_amt    #No.FUN-670008
       LET g_ogb[l_ac].ogb12 = p_ogb12 - l_ship_qty + l_retn_qty + l_retn_qty_2   #MOD-A50076 add l_retn_qty_2
       LET g_ogb[l_ac].ogb912= p_ogb912- l_ogb912   + l_ohb912 + l_ogb912_2       #MOD-A50076 add l_ogb912_2
       LET g_ogb[l_ac].ogb915= p_ogb915- l_ogb915   + l_ohb915 + l_ogb915_2       #MOD-A50076 add l_ogb915_2
       LET g_ogb[l_ac].ogb917= p_ogb917- l_ogb917   + l_ohb917 + l_ogb917_2       #MOD-A50076 add l_ogb917_2
       LET g_ogb[l_ac].ogb13 = p_ogb13
       LET g_ogb[l_ac].ogb37 = p_ogb37     #FUN-AB0061
       LET g_ogb[l_ac].ogb19 = p_ogb19
       LET g_ogb[l_ac].ogb1001 = p_ogb1001
       LET g_ogb[l_ac].ogb1012 = p_ogb1012
       LET g_ogb[l_ac].ogb1002 = p_ogb1002
       LET g_ogb[l_ac].ogb1003 = p_ogb1003
       LET g_ogb[l_ac].ogb1004 = p_ogb1004
       LET g_ogb[l_ac].ogb1006 = p_ogb1006
       LET g_ogb[l_ac].ogb41 = p_ogb41
       LET g_ogb[l_ac].ogb42 = p_ogb42
       LET g_ogb[l_ac].ogb43 = p_ogb43
       LET g_ogb[l_ac].ogb44 = p_ogb44   #No.FUN-870007
       LET g_ogb[l_ac].ogb45 = p_ogb45   #No.FUN-870007
       LET g_ogb[l_ac].ogb46 = p_ogb46   #No.FUN-870007
       LET g_ogb[l_ac].ogb47 = p_ogb47   #No.FUN-870007
   ELSE
      #TQC-B10088 Begin---
       LET g_ogb[l_ac].ogb04 = p_ogb04
       LET g_ogb[l_ac].ogb11 = p_ogb11
      #TQC-B10088 End-----
       LET g_b2[l_ac].ogb14 = p_ogb14 -l_ogb14+l_retn_amt       #No.FUN-670008
       LET g_b2[l_ac].ogb14t = p_ogb14t -l_ogb14t+l_retn_amt    #No.FUN-670008
       LET g_b2[l_ac].ogb1001 = p_ogb1001
       LET g_b2[l_ac].ogb1007 = p_ogb1007
       LET g_b2[l_ac].ogb1010 = p_tqw14
       LET g_b2[l_ac].tqw16 = p_tqw16
       LET g_b2[l_ac].tqw08 = p_tqw08
       LET g_b2[l_ac].tqw081= p_tqw081
       LET g_b2[l_ac].ogb1008 = p_ogb1008
       LET g_b2[l_ac].ogb1009 = p_ogb1009
       LET g_b2[l_ac].ogb1010 = p_ogb1010
       LET g_b2[l_ac].ogb1011 = p_ogb1011
   END IF


   CALL t600_ogb14()

END FUNCTION


FUNCTION t600_ogb14()
DEFINE l_qty   LIKE ogb_file.ogb917
#DEFINE l_tqe04 LIKE tqe_file.tqe04      #No.FUN-6B0065
DEFINE l_azf10 LIKE azf_file.azf10     #No.FUN-6B0065
DEFINE p_ogb14   LIKE ogb_file.ogb14
DEFINE p_ogb14t  LIKE ogb_file.ogb14t

   IF g_argv0 MATCHES '[15]' THEN
      LET g_ogb[l_ac].ogb1005 ='1'
   END IF

   IF g_ogb[l_ac].ogb1005 ='1' THEN
    IF g_sma.sma116 MATCHES '[23]' THEN
       LET l_qty =g_ogb[l_ac].ogb917
    ELSE
       LET l_qty =g_ogb[l_ac].ogb12
    END IF

    IF l_qty IS NULL THEN
       LET l_qty = 0
    END IF
    CALL cl_digcut(g_ogb[l_ac].ogb13,t_azi03)  RETURNING g_ogb[l_ac].ogb13
    CALL cl_digcut(g_ogb[l_ac].ogb37,t_azi03)  RETURNING g_ogb[l_ac].ogb37   #FUN-AB0061
    DISPLAY BY NAME g_ogb[l_ac].ogb13
    DISPLAY BY NAME g_ogb[l_ac].ogb37   #FUN-AB0061
    IF g_ogb[l_ac].ogb1012 = 'N' THEN
     IF g_oga.oga213 = 'N'  THEN
       LET g_ogb[l_ac].ogb14=t600_amount(l_qty,g_ogb[l_ac].ogb13,g_ogb[l_ac].ogb1006,t_azi03)   #No.MOD-820066
       CALL cl_digcut(g_ogb[l_ac].ogb14,t_azi04)  RETURNING g_ogb[l_ac].ogb14      #CHI-7A0036-add
       LET g_ogb[l_ac].ogb14t=g_ogb[l_ac].ogb14*(1+g_oga.oga211/100)
       CALL cl_digcut(g_ogb[l_ac].ogb14t,t_azi04) RETURNING g_ogb[l_ac].ogb14t     #CHI-7A0036-add
     ELSE
       LET g_ogb[l_ac].ogb14t=t600_amount(l_qty,g_ogb[l_ac].ogb13,g_ogb[l_ac].ogb1006,t_azi03)   #No.MOD-820066
       CALL cl_digcut(g_ogb[l_ac].ogb14t,t_azi04) RETURNING g_ogb[l_ac].ogb14t     #CHI-7A0036-add
       LET g_ogb[l_ac].ogb14=g_ogb[l_ac].ogb14t/(1+g_oga.oga211/100)
       CALL cl_digcut(g_ogb[l_ac].ogb14,t_azi04)  RETURNING g_ogb[l_ac].ogb14      #CHI-7A0036-add
     END IF
    ELSE
       LET g_ogb[l_ac].ogb14 = 0
       LET g_ogb[l_ac].ogb14t = 0
    END IF
   END IF
   DISPLAY BY NAME g_ogb[l_ac].ogb14,g_ogb[l_ac].ogb14t  #CHI-7A0036-add

END FUNCTION

FUNCTION t600_oga1016(p_cmd)
DEFINE p_cmd     LIKE type_file.chr1,                                                                                                               #No.FUN-680137 VARCHAR(1)
       l_pmc03   LIKE pmc_file.pmc03,
       l_pmcacti LIKE pmc_file.pmcacti

   LET g_errno = ' '

   SELECT pmc03,pmcacti
     INTO l_pmc03,l_pmcacti
     FROM pmc_file
    WHERE pmc01 = g_oga.oga1016
      AND pmc14 = '6'

   CASE WHEN SQLCA.SQLCODE = 100 LET g_errno = 'aap-000'
                                 LET l_pmc03 = ''
        WHEN l_pmcacti = 'N'     LET g_errno = '9028'
        WHEN l_pmcacti MATCHES '[PH]'  LET g_errno = '9038'   #No.FUN-690024
        WHEN SQLCA.SQLCODE != 0  LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE
   IF cl_null(g_errno) OR p_cmd='d' THEN
      DISPLAY l_pmc03 TO FORMONLY.oga1016_occ02
   END IF
END FUNCTION


FUNCTION t600_oga1004(p_cmd)
DEFINE p_cmd      LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)
DEFINE l_occ02    LIKE occ_file.occ02
DEFINE l_occacti  LIKE occ_file.occacti

       LET g_errno = ''
       SELECT occ02,occacti INTO l_occ02,l_occacti
         FROM occ_file
        WHERE occ01 = g_oga.oga1004
          AND occ1004 = '1'      #No.FUN-690025

   CASE WHEN SQLCA.SQLCODE = 100  LET g_errno = 'atm-381'
                                  LET l_occ02 = NULL
        WHEN l_occacti='N' LET g_errno = '9028'
        WHEN l_occacti MATCHES '[PH]'  LET g_errno = '9038'   #No.FUN-690023
        OTHERWISE          LET g_errno = SQLCA.SQLCODE USING '-------'
   END CASE
   IF NOT cl_null(l_occ02) THEN
      DISPLAY  l_occ02 TO FORMONLY.oga1004_occ02
   ELSE
      DISPLAY ' ' TO FORMONLY.oga1004_occ02
   END IF
END FUNCTION


FUNCTION t600_oga18(p_cmd)
DEFINE p_cmd      LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)
DEFINE l_occ02    LIKE occ_file.occ02
DEFINE l_occacti  LIKE occ_file.occacti

       LET g_errno = ''
       SELECT occ02,occacti INTO l_occ02,l_occacti
         FROM occ_file
        WHERE occ01 = g_oga.oga18
#         AND occ1004 = '3'     #No.FUN-690025
          AND occ1004 = '1'     #No.FUN-690025
          AND (occ06 ='1' OR occ06 ='3')

   CASE WHEN SQLCA.SQLCODE = 100  LET g_errno = 'atm-381'
                                  LET l_occ02 = NULL
        WHEN l_occacti='N' LET g_errno = '9028'
        WHEN l_occacti MATCHES '[PH]'  LET g_errno = '9038'  #No.FUN-690023
        OTHERWISE          LET g_errno = SQLCA.SQLCODE USING '-------'
   END CASE
   IF NOT cl_null(l_occ02) THEN
      DISPLAY  l_occ02 TO FORMONLY.oga18_ds
   ELSE
      DISPLAY ' ' TO FORMONLY.oga18_ds
   END IF
END FUNCTION

FUNCTION t600_tqw081_update(p_code)
DEFINE p_code    LIKE type_file.chr1,    #No.FUN-680137 VARCHAR(01)
       t_ogb     RECORD LIKE ogb_file.*

   DECLARE ogb_conf CURSOR FOR
    SELECT * FROM ogb_file
     WHERE  ogb01 = g_oga.oga01
       AND ogb_file.ogb1005='2'
    OPEN ogb_conf
    FOREACH ogb_conf INTO t_ogb.*
      IF STATUS THEN
         CALL cl_err('foreach ogb',STATUS,0)
         RETURN
      END IF
      IF p_code=1 THEN
         IF t_ogb.ogb1010='N' THEN
            UPDATE tqw_file set tqw081=tqw081+t_ogb.ogb14
             WHERE tqw01=t_ogb.ogb1007
         ELSE
            UPDATE tqw_file set tqw081=tqw081+t_ogb.ogb14t
             WHERE tqw01=t_ogb.ogb1007
         END IF
      ELSE
          IF t_ogb.ogb1010='N' THEN
             UPDATE tqw_file set tqw081=tqw081-t_ogb.ogb14
              WHERE tqw01=t_ogb.ogb1007
          ELSE
             UPDATE tqw_file set tqw081=tqw081-t_ogb.ogb14t
              WHERE tqw01=t_ogb.ogb1007
          END IF
      END IF
      IF SQLCA.SQLCODE THEN
         LET g_success='N'
         RETURN
      END IF

    END FOREACH

END FUNCTION

#end
FUNCTION t600_gen_check_note()
DEFINE l_oga     RECORD LIKE oga_file.*,
       l_ogb     RECORD LIKE ogb_file.*,
       li_result LIKE type_file.num5,    #No.FUN-680137 SMALLINT
       l_cnt     LIKE type_file.num5,    #No.FUN-680137 SMALLINT
       tm        RECORD
                 oga01 LIKE oay_file.oayslip,  #No.FUN-680137 VARCHAR(5)
                 oga02 LIKE oea_file.oea02
                 END RECORD,
       l_t1      LIKE type_file.chr5
DEFINE l_rvbs    RECORD LIKE rvbs_file.*  #MOD-9A0122
DEFINE i         LIKE type_file.num5   #MOD-A10163

DEFINE l_ogc     RECORD LIKE ogc_file.*  #CHI-AC0034 add

   IF g_oga.oga65!='Y' THEN
       #此單據未做客戶出貨簽收!
       CALL cl_err(g_oga.oga01,'axm-720',1)
       RETURN
   END IF
   IF g_oga.ogaconf != 'Y' OR g_oga.ogapost != 'Y' THEN
      CALL cl_err(g_oga.oga01,'axm-922',1)   #出貨單需確認且過帳才可執行轉出貨簽
      RETURN
   END IF

   IF NOT cl_confirm('axm-420') THEN
      RETURN
   END IF

   LET g_success = 'Y'

   SELECT COUNT(*) INTO l_cnt FROM ogb_file
    WHERE ogb01 = g_oga.oga01
      AND ogb12 <> 0

   IF l_cnt = 0 THEN
      RETURN
   END IF

   SELECT COUNT(*) INTO l_cnt FROM ogb_file,oga_file
    WHERE oga01 = ogb01
      AND oga01 = g_oga.oga01
      AND ogb03 NOT IN (SELECT ogb03 FROM ogb_file,oga_file
                         WHERE oga01 = ogb01
                           AND oga011 = g_oga.oga01
                           AND oga09 ='8')

   IF l_cnt = 0 THEN
      CALL cl_err(g_oga.oga01,'axm-425',1)
      RETURN
   END IF

   LET tm.oga01= NULL
   LET tm.oga02= g_today

   LET p_row = 2 LET p_col = 39

   OPEN WINDOW t6272_w AT p_row,p_col WITH FORM "axm/42f/axmt6272"
        ATTRIBUTE (STYLE = g_win_style CLIPPED)

   CALL cl_ui_locale("axmt6272")

   INPUT BY NAME tm.oga01,tm.oga02 WITHOUT DEFAULTS

      AFTER FIELD oga01
         IF NOT cl_null(tm.oga01) THEN
            CALL s_check_no("axm",tm.oga01,"","58","oga_file","oga01","")
                 RETURNING li_result,tm.oga01
            IF (NOT li_result) THEN
               NEXT FIELD oga01
            END IF
         END IF

      AFTER INPUT
         IF INT_FLAG THEN
            EXIT INPUT
         END IF

      ON ACTION controlp
         CASE
            WHEN INFIELD(oga01)
                LET l_t1=s_get_doc_no(tm.oga01)       #No.FUN-550052
               # CALL q_oay(FALSE,TRUE,l_t1,'58',g_sys) RETURNING l_t1      #FUN-A70130
                CALL q_oay(FALSE,TRUE,l_t1,'58','axm') RETURNING l_t1      #FUN-A70130
                LET tm.oga01 = l_t1            #No.FUN-550052
                DISPLAY BY NAME tm.oga01
                NEXT FIELD oga01
         END CASE

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT

      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121

      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121

      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121

   END INPUT

   IF INT_FLAG THEN
      LET INT_FLAG=0
      LET g_success = 'N'
      CLOSE WINDOW t6272_w
      RETURN
   END IF

   CLOSE WINDOW t6272_w

   LET l_oga.* = g_oga.*

   BEGIN WORK

   CALL s_auto_assign_no("axm",tm.oga01,tm.oga02,"","oga_file","oga01","","","")
     RETURNING li_result,l_oga.oga01

   IF (NOT li_result) THEN
      LET g_success = 'N'
   END IF

   IF cl_null(l_oga.oga01) THEN
      LET g_success='N'
      RETURN
   END IF

   LET l_oga.oga02  = tm.oga02
   LET l_oga.oga011 = g_oga.oga01
   LET l_oga.oga09  = '8'
   LET l_oga.ogaconf= 'N'
   LET l_oga.ogapost= 'N'
   LET l_oga.ogaprsw= 0
   LET l_oga.oga55  = '0'
   LET l_oga.oga57  = '1'           #FUN-AC0055 add
   LET l_oga.oga65  = 'N'

   LET l_tmoga01 = tm.oga01    #FUN-9B0039 
  #LET l_tmoga01 = l_tmoga01[1,3]   #FUN-9B0039          #MOD-AA0060 mark
   LET l_tmoga01 = l_tmoga01[1,g_doc_len]   #FUN-9B0039  #MOD-AA0060 add 
   SELECT oayapr INTO l_oga.ogamksg FROM oay_file
    WHERE oayslip = l_tmoga01     #FUN-910036 add 抓取單據是否做簽核，因tm.oga01會多"_"所以用substr取前三碼  #FUN-9B0039 mod
   LET l_oga.oga85=' '  #No.FUN-870007
   LET l_oga.oga94='N' #No.FUN-870007

   LET l_oga.ogaplant = g_plant 
   LET l_oga.ogalegal = g_legal  

   LET l_oga.ogaoriu = g_user      #No.FUN-980030 10/01/04
   LET l_oga.ogaorig = g_grup      #No.FUN-980030 10/01/04
   IF cl_null(l_oga.oga909) THEN LET l_oga.oga909 = 'N' END IF  #MOD-A60163 
   INSERT INTO oga_file VALUES (l_oga.*)
   IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3]=0 THEN
      CALL cl_err('ins oga',SQLCA.SQLCODE,1)
      LET g_success='N'
   END IF

   DECLARE t600_ins_ogb_c1 CURSOR FOR
    SELECT * FROM ogb_file
     WHERE ogb01= g_oga.oga01
       AND (ogb12 <> 0 OR ogb1005 ='2')
   CALL s_showmsg_init()                    #No.FUN-710046
   FOREACH t600_ins_ogb_c1 INTO l_ogb.*
       IF STATUS THEN
          CALL s_errmsg('','',"t600_ins_ogb_cl foreach:",SQLCA.sqlcode,1)  #No.FUN-710046
          EXIT FOREACH
       END IF
     IF g_success = "N" THEN
        LET g_totsuccess = "N"
        LET g_success = "Y"
     END IF

       LET l_ogb.ogb01 = l_oga.oga01

       SELECT COUNT(*) INTO l_cnt FROM ogb_file,oga_file
        WHERE oga01 = ogb01
          AND oga09 = '8'
          AND oga011 = g_oga.oga01
          AND ogb03 = l_ogb.ogb03

       IF l_cnt > 0 THEN
          CALL s_errmsg('','',b_ogb.ogb04,"axm-421",1) #No.FUN-710046
          LET g_success = 'N'
       END IF

       LET l_ogb.ogb09 = g_oga.oga66
       LET l_ogb.ogb091= g_oga.oga67
      #LET l_ogb.ogb17 = 'N' #CHI-AC0034 mark
       #MOD-B40148 add --start--
       IF g_oaz.oaz23 = 'N' THEN     #多倉儲出貨
          LET l_ogb.ogb17 = 'N' 
       END IF
       #MOD-B40148 add --end--
       LET l_ogb.ogb44='1' #No.FUN-870007
       LET l_ogb.ogb47=0   #No.FUN-870007

       LET l_ogb.ogbplant = g_plant 
       LET l_ogb.ogblegal = g_legal  
    #  IF cl_null(l_ogb.ogb50) THEN LET l_ogb.ogb50 = '1' END IF #FUN-AA0057

       INSERT INTO ogb_file VALUES(l_ogb.*)
       IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3]=0 THEN
          CALL s_errmsg('','',"ins ogb",SQLCA.sqlcode,1)   #No.FUN-710046
          LET g_success='N'
       END IF
       LET g_ima918 = ''   #MOD-9C0055
       LET g_ima921 = ''   #MOD-9C0055
       SELECT ima918,ima921 INTO g_ima918,g_ima921 
         FROM ima_file
        WHERE ima01 = l_ogb.ogb04
          AND imaacti = "Y"
       
       IF g_ima918 = "Y" OR g_ima921 = "Y" THEN
          DECLARE t600_g_rvbs_1 CURSOR FOR SELECT * FROM rvbs_file
                                         WHERE rvbs01 = l_oga.oga011
                                           AND rvbs02 = l_ogb.ogb03
          LET i = 1   #MOD-A10163 
          FOREACH t600_g_rvbs_1 INTO l_rvbs.*
             IF STATUS THEN
                CALL cl_err('rvbs',STATUS,1)
             END IF
       
             LET l_rvbs.rvbs00 = 'axmt628' 
             LET l_rvbs.rvbs01 = l_oga.oga01
             LET l_rvbs.rvbs022 = i   #MOD-A10163
             LEt l_rvbs.rvbs13 = 0   #MOD-A10163
       
             INSERT INTO rvbs_file VALUES(l_rvbs.*)
             IF STATUS OR SQLCA.SQLCODE THEN
                CALL cl_err3("ins","rvbs_file","","",SQLCA.sqlcode,"","ins rvbs",1)  
             END IF
             LET i = i + 1   #MOD-A10163
          END FOREACH
       END IF
       #CHI-AC0034 add --start--
       IF l_ogb.ogb17='Y' AND g_oaz.oaz23 = 'Y' THEN     ##多倉儲出貨
          DECLARE t600_ins_ogc_c1 CURSOR FOR
           SELECT * FROM ogc_file
            WHERE ogc01= g_oga.oga01
              AND ogc03= l_ogb.ogb03
          FOREACH t600_ins_ogc_c1 INTO l_ogc.*
             IF STATUS THEN
                CALL s_errmsg('','',"t600_ins_ogc_cl foreach:",SQLCA.sqlcode,1) 
                EXIT FOREACH
             END IF
             IF g_success = "N" THEN
                LET g_totsuccess = "N"
                LET g_success = "Y"
             END IF

             LET l_ogc.ogc01 = l_oga.oga01
             LET l_ogc.ogc09 = g_oga.oga66
             LET l_ogc.ogc091= g_oga.oga67

             INSERT INTO ogc_file VALUES(l_ogc.*)
             IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3]=0 THEN
                CALL s_errmsg('','',"ins ogc",SQLCA.sqlcode,1)  
                LET g_success='N'
             END IF

             LET g_ima918 = ''   
             LET g_ima921 = ''  
             SELECT ima918,ima921 INTO g_ima918,g_ima921 
               FROM ima_file
              WHERE ima01 = l_ogc.ogc17
                AND imaacti = "Y"

             IF g_ima918 = "Y" OR g_ima921 = "Y" THEN
                DECLARE t600_g_rvbs_4 CURSOR FOR SELECT * FROM rvbs_file
                                               WHERE rvbs01 = l_oga.oga011
                                                 AND rvbs02 = l_ogb.ogb03
                                                 AND rvbs13 = l_ogc.ogc18
                LET i = 1
                FOREACH t600_g_rvbs_4 INTO l_rvbs.*
                   IF STATUS THEN
                      CALL cl_err('rvbs',STATUS,1)
                   END IF
             
                   LET l_rvbs.rvbs00 = 'axmt628' 
                   LET l_rvbs.rvbs01 = l_oga.oga01
                   LET l_rvbs.rvbs022 = i 
             
                   INSERT INTO rvbs_file VALUES(l_rvbs.*)
                   IF STATUS OR SQLCA.SQLCODE THEN
                      CALL cl_err3("ins","rvbs_file","","",SQLCA.sqlcode,"","ins rvbs",1)  
                   END IF
                   LET i = i + 1 
                END FOREACH
             END IF
          END FOREACH
       END IF
       #CHI-AC0034 add --end--
   END FOREACH
     IF g_totsuccess="N" THEN
        LET g_success="N"
     END IF
     CALL s_showmsg()
   IF g_success = 'Y' THEN
      COMMIT WORK
   ELSE
      ROLLBACK WORK
   END IF

   IF g_success = 'Y' THEN
      CALL t600_qry_on_check_note()
   END IF

END FUNCTION

FUNCTION t600_qry_on_check_note()
   DEFINE l_str   STRING
   DEFINE l_oga01 LIKE oga_file.oga01
   DEFINE l_flag  LIKE type_file.num5    #No.FUN-680137 SMALLINT

   IF g_oga.oga65 <> 'Y' THEN
       #此單據未做客戶出貨簽收!
       CALL cl_err(g_oga.oga01,'axm-720',1)
       RETURN
   END IF

   DECLARE t600_qry_on_check_cur CURSOR FOR
    SELECT oga01 FROM oga_file
     WHERE oga011 = g_oga.oga01
       AND oga09 = '8'
     ORDER BY oga01

   LET l_flag = 0
   LET l_str="oga01 IN ("

   FOREACH t600_qry_on_check_cur INTO l_oga01
      IF STATUS THEN
         EXIT FOREACH
      END IF

      IF l_flag = 0 THEN
         LET l_str=l_str CLIPPED,'"',l_oga01,'"'
      ELSE
         LET l_str=l_str CLIPPED,',"',l_oga01,'"'
      END IF

      LET l_flag = l_flag + 1
   END FOREACH

   IF l_flag = 0 THEN
      LET l_str=" 0=1"
   ELSE
      LET l_str=l_str CLIPPED,")"
   END IF

   LET g_sql="axmt628 '' '",l_str CLIPPED,"'"
   CALL cl_cmdrun_wait(g_sql)

END FUNCTION

FUNCTION t600_g_b3()                  #由出貨通知單產生單身
   DEFINE l_ogb12a   LIKE ogb_file.ogb12,
          l_ogb12b   LIKE ogb_file.ogb12
   DEFINE l_ogb      RECORD LIKE ogb_file.*
   DEFINE l_oga66    LIKE oga_file.oga66
   DEFINE l_oga67    LIKE oga_file.oga67
   DEFINE l_ogb912a  LIKE ogb_file.ogb912,
          l_ogb912b  LIKE ogb_file.ogb912,
          l_ogb915a  LIKE ogb_file.ogb915,
          l_ogb915b  LIKE ogb_file.ogb915,
          l_ogb917a  LIKE ogb_file.ogb917,
          l_ogb917b  LIKE ogb_file.ogb917
   DEFINE l_ogb05    LIKE ogb_file.ogb05     #NO.FUN-960130
   DEFINE l_rvbs     RECORD LIKE rvbs_file.*   #CHI-970040
   DEFINE i          LIKE type_file.num5   #MOD-A10163
   DEFINE l_cnt      LIKE type_file.num5          #FUN-C50097
   DEFINE l_ima906   LIKE ima_file.ima906 #FUN-C50097 
#No.CHI-B60054  --mark Begin
#CHI-B30093 --begin--
#   DEFINE l_sql      STRING
#   DEFINE l_ogc_1    RECORD LIKE ogc_file.*
#CHI-B30093 --end--
#No.CHI-B60054  --mark End
   LET g_chr2 = '1'  #No.FUN-640074

   IF NOT cl_confirm('axm-418') THEN
       LET g_chr2 = '0'  #No.FUN-640074
       RETURN
   END IF

   DROP TABLE x

   IF NOT cl_null(g_oga.oga011) AND NOT cl_null(g_oga.oga16) THEN
      SELECT * FROM ogb_file
       WHERE ogb01 = g_oga.oga011
         AND ogb31 = g_oga.oga16
        INTO TEMP x
   ELSE
      SELECT * FROM ogb_file
       WHERE ogb01 = g_oga.oga011
        INTO TEMP x
   END IF

   IF STATUS THEN
      CALL cl_err('into x',STATUS,1)
      LET g_success = 'N'
   END IF

   UPDATE x SET ogb01=g_oga.oga01
   IF STATUS THEN
      CALL cl_err3("upd","x",g_oga.oga01,"",SQLCA.sqlcode,"","upd x",1)  #No.FUN-670008
      LET g_success = 'N'
   END IF
   #No.B439 010424 by linda add 出貨量要扣除未確認之出貨量

#No.CHI-B60054  --mark Begin
#CHI-B30093 --begin--
#    LET l_sql = "SELECT * FROM ogc_file WHERE ogc01 ='",g_oga.oga011,"'"
#    PREPARE t628_ogc092 FROM l_sql
#    DECLARE t628_ogc092_cs CURSOR FOR t628_ogc092       
#CHI-B30093 --end--   
#No.CHI-B60054  --mark End

   DECLARE t600_g_ogb3 CURSOR FOR SELECT * FROM x
                                  WHERE ogb01 = g_oga.oga01

   FOREACH t600_g_ogb3 INTO l_ogb.*
      #檢查出貨數必須<=通知單應出數(ogb12)-累計出貨數(ogb19)
      #對應到的出貨通知單上的數量
      LET l_ogb12a = 0
      LET l_ogb912a = 0
      LET l_ogb915a = 0
      LET l_ogb917a = 0

      SELECT SUM(ogb12),SUM(ogb912),SUM(ogb915),SUM(ogb917)
        INTO l_ogb12a,l_ogb912a,l_ogb915a,l_ogb917a
        FROM ogb_file,oga_file
       WHERE ogb01 = oga01 AND oga09 = '2'  AND oga65='Y'
         AND oga01 = g_oga.oga011
         AND ogb03 = l_ogb.ogb03 #MOD-4B0107    #MOD-910183	#MOD-980238 remrk
         AND ogb31 = l_ogb.ogb31
         AND ogb32 = l_ogb.ogb32
         AND ogb04 = l_ogb.ogb04 #BugNo:4541
         AND ogaconf = 'Y'
         AND ogapost = 'Y'

      IF cl_null(l_ogb12a)  THEN LET l_ogb12a = 0 END IF
      IF cl_null(l_ogb912a) THEN LET l_ogb912a= 0 END IF
      IF cl_null(l_ogb915a) THEN LET l_ogb915a= 0 END IF
      IF cl_null(l_ogb917a) THEN LET l_ogb917a= 0 END IF
      #FUN-C50097 ADD BEGIN-----
      #大陸版走出貨多次簽收,單身產生的數量修正
      IF g_aza.aza26 = '2'  AND g_oaz.oaz94 = 'Y' THEN 
      ELSE 
#FUN-C50097 ADD END 
      # 此出貨通知單已耗用在出貨單的量
      LET l_ogb12b = 0

      SELECT SUM(ogb12),SUM(ogb912),SUM(ogb915),SUM(ogb917)
        INTO l_ogb12b,l_ogb912b,l_ogb915b,l_ogb917b
        FROM ogb_file,oga_file
       WHERE ogb01 = oga01 AND oga09 IN ('8','9')  #No.7992  #No.FUN-630061
         AND oga011 = g_oga.oga011
         AND ogb03 = l_ogb.ogb03 #MOD-4B0107   #MOD-910183	#MOD-980238 remrk
         AND ogb31 = l_ogb.ogb31
         AND ogb32 = l_ogb.ogb32
         AND ogb04 = l_ogb.ogb04 #BugNo:4541
         AND ogaconf != 'X'   #No:MOD-570312

      IF cl_null(l_ogb12b)  THEN LET l_ogb12b = 0 END IF
      IF cl_null(l_ogb912b) THEN LET l_ogb912b= 0 END IF
      IF cl_null(l_ogb915b) THEN LET l_ogb915b= 0 END IF
      IF cl_null(l_ogb917b) THEN LET l_ogb917b= 0 END IF
      LET l_ogb.ogb12 = l_ogb12a - l_ogb12b
      LET l_ogb.ogb912= l_ogb912a- l_ogb912b
      LET l_ogb.ogb915= l_ogb915a- l_ogb915b
      LET l_ogb.ogb917= l_ogb917a- l_ogb917b
    END IF #FUN-C50097 ADD
      LET l_ogb.ogb16 = l_ogb.ogb12 * l_ogb.ogb15_fac

      IF g_sma.sma116 MATCHES '[23]' AND NOT cl_null(l_ogb.ogb916) THEN
         LET l_ogb05=l_ogb.ogb916
      ELSE
         LET l_ogb05=l_ogb.ogb05
      END IF
      CALL s_fetch_price_new(g_oga.oga03,l_ogb.ogb04,l_ogb05,g_oga.oga69,
                             '2',g_oga.ogaplant,g_oga.oga23,g_oga.oga31,g_oga.oga32,
                             g_oga.oga01,l_ogb.ogb03,l_ogb.ogb917,
                             l_ogb.ogb1004,'a')
         #RETURNING l_ogb.ogb13    #FUN-AB0061
         RETURNING l_ogb.ogb13,l_ogb.ogb37  #FUN-AB0061
      IF cl_null(l_ogb.ogb13) THEN CALL s_unitprice_entry(g_oga.oga03,g_oga.oga31,g_oga.ogaplant) END IF #FUN-9C0120 
      IF g_oga.oga213 = 'N' THEN
         LET l_ogb.ogb14 =l_ogb.ogb917*l_ogb.ogb13  #MOD-6B0002 mod
         CALL cl_digcut(l_ogb.ogb14,t_azi04) RETURNING l_ogb.ogb14   #CHI-7A0036-add
         LET l_ogb.ogb14t=l_ogb.ogb14*(1+g_oga.oga211/100)
         CALL cl_digcut(l_ogb.ogb14t,t_azi04)RETURNING l_ogb.ogb14t  #CHI-7A0036-add
      ELSE
         LET l_ogb.ogb14t=l_ogb.ogb917*l_ogb.ogb13  #MOD-6B0002 mod
         CALL cl_digcut(l_ogb.ogb14t,t_azi04)RETURNING l_ogb.ogb14t  #CHI-7A0036-add
         LET l_ogb.ogb14 =l_ogb.ogb14t/(1+g_oga.oga211/100)
         CALL cl_digcut(l_ogb.ogb14,t_azi04) RETURNING l_ogb.ogb14   #CHI-7A0036-add
      END IF

      SELECT oga66,oga67 INTO l_oga66,l_oga67 FROM oga_file
       WHERE oga01 = g_oga.oga011

      LET l_ogb.ogb09 = l_oga66
      LET l_ogb.ogb091= l_oga67

      UPDATE x SET ogb12 = l_ogb.ogb12,
                   ogb16 = l_ogb.ogb16,
                   ogb1014 = 'N',       #FUN-6A0007
                  #ogb17   = 'N',   #MOD-A10163 #CHI-AC0034 mark
                   ogb17   = l_ogb.ogb17,   #CHI-AC0034
                   ogb14 = l_ogb.ogb14,
                   ogb14t = l_ogb.ogb14t,
                   ogb912= l_ogb.ogb912,  #No.FUN-540049
                   ogb915= l_ogb.ogb915,  #No.FUN-540049
                   ogb917= l_ogb.ogb917,  #No.FUN-540049
                   ogb09 = l_ogb.ogb09,
                   ogb37 = l_ogb.ogb37,  #FUN-AB0061
                   ogb13 = l_ogb.ogb13,   #NO.FUN-960130
                   ogb091= l_ogb.ogb091
       WHERE ogb01=l_ogb.ogb01
         AND ogb03 = l_ogb.ogb03
      LET g_ima918 = ''   #MOD-9C0055
      LET g_ima921 = ''   #MOD-9C0055
      SELECT ima918,ima921 INTO g_ima918,g_ima921 
        FROM ima_file
       WHERE ima01 = l_ogb.ogb04
         AND imaacti = "Y"
      
      IF g_ima918 = "Y" OR g_ima921 = "Y" THEN
         DECLARE t600_g_rvbs_2 CURSOR FOR SELECT * FROM rvbs_file
                                        WHERE rvbs01 = g_oga.oga011
                                          AND rvbs02 = l_ogb.ogb03
         LET i = 1   #MOD-A10163 
         FOREACH t600_g_rvbs_2 INTO l_rvbs.*
            IF STATUS THEN
               CALL cl_err('rvbs',STATUS,1)
            END IF

            LET l_rvbs.rvbs00 = g_prog
            LET l_rvbs.rvbs01 = g_oga.oga01
            LET l_rvbs.rvbs022 = i   #MOD-A10163
            LEt l_rvbs.rvbs13 = 0   #MOD-A10163

            INSERT INTO rvbs_file VALUES(l_rvbs.*)
            IF STATUS OR SQLCA.SQLCODE THEN
               CALL cl_err3("ins","rvbs_file","","",SQLCA.sqlcode,"","ins rvbs",1)  
               LET g_success='N'
            END IF
            LET i = i + 1   #MOD-A10163
         END FOREACH
      END IF
   END FOREACH

   IF cl_null(l_ogb.ogb05_fac) THEN
     LET l_ogb.ogb05_fac = 1
   END IF

   IF cl_null(l_ogb.ogb12) THEN
     LET l_ogb.ogb12 = 0
   END IF
#FUN-AB0061 -----------add start----------------                             
   IF cl_null(l_ogb.ogb37) THEN
     LET l_ogb.ogb37 = 0
   END IF                                             
#FUN-AB0061 -----------add end----------------  
   IF cl_null(l_ogb.ogb13) THEN
     LET l_ogb.ogb13 = 0
   END IF

   IF cl_null(l_ogb.ogb14) THEN
     LET l_ogb.ogb14 = 0
   END IF

   IF cl_null(l_ogb.ogb14t) THEN
     LET l_ogb.ogb14t = 0
   END IF

   IF cl_null(l_ogb.ogb15_fac) THEN
      LET l_ogb.ogb15_fac = 1
   END IF

   IF cl_null(l_ogb.ogb16) THEN
      LET l_ogb.ogb16 = 0
   END IF

   IF cl_null(l_ogb.ogb18) THEN
      LET l_ogb.ogb18 = 0
   END IF

   IF cl_null(l_ogb.ogb60) THEN
      LET l_ogb.ogb60 = 0
   END IF

   IF cl_null(l_ogb.ogb63) THEN
      LET l_ogb.ogb63 = 0
   END IF

   IF cl_null(l_ogb.ogb64) THEN
      LET l_ogb.ogb64 = 0
   END IF

#No.CHI-B60054  --mark Begin
#CHI-B30093 --begin--
#   IF l_ogb.ogb17 = 'Y' THEN 
#      FOREACH t628_ogc092_cs INTO l_ogc_1.*
#         LET l_ogc_1.ogc01 = l_ogb.ogb01
#         LET l_ogc_1.ogc09 = l_ogb.ogb09
#         LET l_ogc_1.ogc091= l_ogb.ogb091
#         
#         INSERT INTO ogc_file VALUES(l_ogc_1.*) 
#         IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN    
#             CALL cl_err3("ins","ogc_file","","",SQLCA.sqlcode,"","ins ogc",1)  
#             LET g_success = 'N'       
#             EXIT FOREACH 
#         END IF                    
#      END FOREACH 
#   END IF 
#CHI-B30093 --end--
#No.CHI-B60054  --mark End

   INSERT INTO ogb_file SELECT * FROM x WHERE ogb12 > 0
                                           OR ogb03 >=9001  #No.TQC-740349
   IF STATUS OR SQLCA.SQLCODE THEN
      CALL cl_err3("ins","ogb_file","","",SQLCA.sqlcode,"","ins ogb",1)  #No.FUN-670008
      LET g_success='N'
   END IF

   #-----MOD-A10163---------
   #客戶簽收單沒有多倉儲
   ##No.B636 010713 by linda add 多倉儲亦要轉
   #DROP TABLE x
   #
   #SELECT * FROM ogc_file WHERE ogc01 = g_oga.oga011 INTO TEMP x
   #IF STATUS THEN
   #   CALL cl_err3("ins","x",g_oga.oga011,"",SQLCA.sqlcode,"","into x",1)  #No.FUN-670008
   #   LET g_success='N'
   #END IF
   #
   #UPDATE x SET ogc01=g_oga.oga01
   #IF STATUS THEN
   #   CALL cl_err3("upd","x",g_oga.oga01,"",SQLCA.sqlcode,"","upd x",1)  #No.FUN-670008
   #   LET g_success='N'
   #END IF
   #
   #INSERT INTO ogc_file SELECT * FROM x
   # WHERE ogc03 IN (SELECT ogb03 FROM ogb_file
   #                  WHERE ogb01 = g_oga.oga01)
   #IF STATUS OR SQLCA.SQLCODE THEN
   #   CALL cl_err('ins ogb',SQLCA.SQLCODE,1)
   #   LET g_success='N'
   #END IF
   #-----END MOD-A10163-----

END FUNCTION

FUNCTION t600_show3()
DEFINE l_oga01a,l_oga01b  LIKE oga_file.oga01

   IF g_argv0 <> '2' AND g_oga.oga65<>'Y'  THEN RETURN END IF

   DECLARE t600_n_cur1 CURSOR FOR
    SELECT oga01 FROM oga_file
     WHERE oga011=g_oga.oga01 AND oga09='8'
     ORDER BY oga01

   OPEN t600_n_cur1
   FETCH t600_n_cur1 INTO l_oga01a
   CLOSE t600_n_cur1

   DECLARE t600_n_cur2 CURSOR FOR
    SELECT oga01 FROM oga_file
     WHERE oga011=g_oga.oga01 AND oga09='9'
     ORDER BY oga01

   OPEN t600_n_cur2
   FETCH t600_n_cur2 INTO l_oga01b
   CLOSE t600_n_cur2

   DISPLAY l_oga01a TO FORMONLY.oga01a
   DISPLAY l_oga01b TO FORMONLY.oga01b

END FUNCTION

FUNCTION t600_set_ogb()
   DEFINE l_ogb      RECORD LIKE ogb_file.*
   DEFINE l_oga66    LIKE oga_file.oga66
   DEFINE l_oga67    LIKE oga_file.oga67
   DEFINE l_ogb912a  LIKE ogb_file.ogb912,
          l_ogb912b  LIKE ogb_file.ogb912,
          l_ogb12a   LIKE ogb_file.ogb915,
          l_ogb12b   LIKE ogb_file.ogb915,
          l_ogb915a  LIKE ogb_file.ogb915,
          l_ogb915b  LIKE ogb_file.ogb915,
          l_ogb917a  LIKE ogb_file.ogb917,
          l_ogb917b  LIKE ogb_file.ogb917
   DEFINE l_rvbs     RECORD LIKE rvbs_file.*   #CHI-970040

   IF g_argv0 <> '8' THEN
      RETURN
   END IF

   SELECT * INTO l_ogb.* FROM ogb_file
    WHERE ogb01 = g_oga.oga011
      AND ogb03 = g_ogb[l_ac].ogb03

   SELECT oga66,oga67 INTO l_oga66,l_oga67 FROM oga_file
    WHERE oga01 = g_oga.oga011
      AND oga09 = '8'

   LET g_ogb[l_ac].ogb31 = l_ogb.ogb31
   LET g_ogb[l_ac].ogb32 = l_ogb.ogb32
   LET g_ogb[l_ac].ogb04 = l_ogb.ogb04
   LET g_ogb[l_ac].ogb06 = l_ogb.ogb06
   SELECT ima021 INTO g_ogb[l_ac].ima021 FROM ima_file WHERE ima01=l_ogb.ogb04
   #LET g_ogb[l_ac].ogb17 = l_ogb.ogb17   #CHI-970040
  #LET g_ogb[l_ac].ogb17 = 'N'   #MOD-A10163 #CHI-AC0034 mark
   LET g_ogb[l_ac].ogb17 = l_ogb.ogb17    #CHI-AC0034
   LET g_ogb[l_ac].ogb09 = l_oga66
   LET g_ogb[l_ac].ogb091= l_oga67
   LET g_ogb[l_ac].ogb092= l_ogb.ogb092
   LET g_ogb[l_ac].ogb19 = l_ogb.ogb19
   LET g_ogb[l_ac].ogb05 = l_ogb.ogb05
   LET g_ogb[l_ac].ogb913= l_ogb.ogb913
   LET g_ogb[l_ac].ogb914= l_ogb.ogb914
   LET g_ogb[l_ac].ogb910= l_ogb.ogb910
   LET g_ogb[l_ac].ogb911= l_ogb.ogb911
   LET g_ogb[l_ac].ogb916= l_ogb.ogb916
   LET g_ogb[l_ac].ogb908= l_ogb.ogb908
   LET g_ogb[l_ac].ogb12b = 0
   LET g_ogb[l_ac].ogb912b= 0
   LET g_ogb[l_ac].ogb915b= 0

   LET l_ogb12a = 0  LET l_ogb912a = 0 LET l_ogb915a = 0 LET l_ogb917a = 0
   SELECT SUM(ogb12),SUM(ogb912),SUM(ogb915),SUM(ogb917)
     INTO l_ogb12a,l_ogb912a,l_ogb915a,l_ogb917a
     FROM ogb_file,oga_file
    WHERE ogb01 = oga01 AND oga09 = '2' AND oga65='Y'
      AND oga01 = g_oga.oga011
      AND ogb03 = g_ogb[l_ac].ogb03
      AND ogaconf = 'Y'
      AND ogapost = 'Y'

   IF cl_null(l_ogb12a)  THEN LET l_ogb12a = 0 END IF
   IF cl_null(l_ogb912a) THEN LET l_ogb912a= 0 END IF
   IF cl_null(l_ogb915a) THEN LET l_ogb915a= 0 END IF
   IF cl_null(l_ogb917a) THEN LET l_ogb917a= 0 END IF

   LET l_ogb12b = 0  LET l_ogb912b = 0 LET l_ogb915b = 0 LET l_ogb917b = 0
   SELECT SUM(ogb12),SUM(ogb912),SUM(ogb915),SUM(ogb917)
     INTO l_ogb12b,l_ogb912b,l_ogb915b,l_ogb917b
     FROM ogb_file,oga_file
    WHERE ogb01 = oga01 AND oga09 = '8'
      AND oga011 = g_oga.oga011
      AND ogb03 = g_ogb[l_ac].ogb03
      AND ogaconf != 'X'
   IF cl_null(l_ogb12b)  THEN LET l_ogb12b = 0 END IF
   IF cl_null(l_ogb912b) THEN LET l_ogb912b= 0 END IF
   IF cl_null(l_ogb915b) THEN LET l_ogb915b= 0 END IF
   IF cl_null(l_ogb917b) THEN LET l_ogb917b= 0 END IF
   LET g_ogb[l_ac].ogb12 = l_ogb12a - l_ogb12b
   LET g_ogb[l_ac].ogb912= l_ogb912a- l_ogb912b
   LET g_ogb[l_ac].ogb915= l_ogb915a- l_ogb915b
   LET g_ogb[l_ac].ogb917= l_ogb917a- l_ogb917b
   DISPLAY BY NAME g_ogb[l_ac].ogb12
   DISPLAY BY NAME g_ogb[l_ac].ogb912
   DISPLAY BY NAME g_ogb[l_ac].ogb915
   DISPLAY BY NAME g_ogb[l_ac].ogb917


   LET g_ima918 = ''   #MOD-9C0055
   LET g_ima921 = ''   #MOD-9C0055
   SELECT ima918,ima921 INTO g_ima918,g_ima921 
     FROM ima_file
    WHERE ima01 = l_ogb.ogb04
      AND imaacti = "Y"
   
   IF g_ima918 = "Y" OR g_ima921 = "Y" THEN
      DECLARE t600_g_rvbs_3 CURSOR FOR SELECT * FROM rvbs_file
                                     WHERE rvbs01 = g_oga.oga011
                                       AND rvbs02 = l_ogb.ogb03
      
      FOREACH t600_g_rvbs_3 INTO l_rvbs.*
         IF STATUS THEN
            CALL cl_err('rvbs',STATUS,1)
         END IF

         LET l_rvbs.rvbs00 = g_prog
         LET l_rvbs.rvbs01 = g_oga.oga01

         INSERT INTO rvbs_file VALUES(l_rvbs.*)
         IF STATUS OR SQLCA.SQLCODE THEN
            CALL cl_err3("ins","rvbs_file","","",SQLCA.sqlcode,"","ins rvbs",1)  
         END IF
      END FOREACH
   END IF
END FUNCTION

FUNCTION t600_else(p_ogb)
   DEFINE p_ogb     RECORD LIKE ogb_file.*
   DEFINE l_img21   LIKE img_file.img21,
          l_ogb15   LIKE ogb_file.ogb15

   IF cl_null(p_ogb.ogb916) THEN
      LET p_ogb.ogb916=p_ogb.ogb05
      LET p_ogb.ogb917=p_ogb.ogb12
   END IF

   IF g_oga.oga213 = 'N' THEN
      LET p_ogb.ogb14 =p_ogb.ogb917*p_ogb.ogb13
      CALL cl_digcut(p_ogb.ogb14,t_azi04) RETURNING p_ogb.ogb14      #CHI-7A0036-add
      LET p_ogb.ogb14t=p_ogb.ogb14*(1+g_oga.oga211/100)
      CALL cl_digcut(p_ogb.ogb14t,t_azi04)RETURNING p_ogb.ogb14t     #CHI-7A0036-add
   ELSE
      LET p_ogb.ogb14t=p_ogb.ogb917*p_ogb.ogb13
      CALL cl_digcut(p_ogb.ogb14t,t_azi04)RETURNING p_ogb.ogb14t     #CHI-7A0036-add
      LET p_ogb.ogb14 =p_ogb.ogb14t/(1+g_oga.oga211/100)
      CALL cl_digcut(p_ogb.ogb14,t_azi04) RETURNING p_ogb.ogb14      #CHI-7A0036-add
   END IF

   CALL cl_digcut(p_ogb.ogb14,t_azi04) RETURNING p_ogb.ogb14      #No.CHI-6A0004 g_azi-->t_azi
   CALL cl_digcut(p_ogb.ogb14t,t_azi04)RETURNING p_ogb.ogb14t     #No.CHI-6A0004 g_azi-->t_azi

   IF p_ogb.ogb09 IS NULL THEN
      LET p_ogb.ogb09 = ' '
   END IF

   IF p_ogb.ogb091 IS NULL THEN
      LET p_ogb.ogb091 = ' '
   END IF

   IF p_ogb.ogb092 IS NULL THEN
      LET p_ogb.ogb092 = ' '
   END IF

   SELECT img09,img21 INTO l_ogb15,l_img21 FROM img_file
    WHERE img01 = p_ogb.ogb04
      AND img02 = p_ogb.ogb09
      AND img03 = p_ogb.ogb091
      AND img04 = p_ogb.ogb092

   IF cl_null(p_ogb.ogb15) OR p_ogb.ogb15_fac=1 THEN
      LET p_ogb.ogb15 = l_ogb15
   END IF

   IF STATUS=0 THEN
      IF p_ogb.ogb05 = p_ogb.ogb15 THEN
         LET p_ogb.ogb15_fac =1
      ELSE
         CALL s_umfchk(p_ogb.ogb04,p_ogb.ogb05,p_ogb.ogb15)
             RETURNING g_cnt,p_ogb.ogb15_fac
         IF g_cnt = 1 THEN
            CALL cl_err('','mfg3075',1)
         END IF
      END IF
   END IF

   IF cl_null(p_ogb.ogb15) THEN
      LET p_ogb.ogb15 = p_ogb.ogb05
   END IF

   IF cl_null(p_ogb.ogb15_fac) THEN
      LET p_ogb.ogb15_fac = 1
   END IF

   LET p_ogb.ogb16 = p_ogb.ogb12 * p_ogb.ogb15_fac

   IF cl_null(p_ogb.ogb60) THEN
      LET p_ogb.ogb60 = 0
   END IF

   IF cl_null(p_ogb.ogb63) THEN
      LET p_ogb.ogb63 = 0
   END IF

   IF cl_null(p_ogb.ogb64) THEN
      LET p_ogb.ogb64 = 0
   END IF

   RETURN p_ogb.*

END FUNCTION

FUNCTION t600_refresh_detail()
  DEFINE l_compare          LIKE oay_file.oay22
  DEFINE li_col_count       LIKE type_file.num5    #No.FUN-680137 SMALLINT
  DEFINE li_i, li_j         LIKE type_file.num5    #No.FUN-680137 SMALLINT
  DEFINE lc_agb03           LIKE agb_file.agb03
  DEFINE lr_agd             RECORD LIKE agd_file.*
  DEFINE lc_index           STRING
  DEFINE ls_combo_vals      STRING
  DEFINE ls_combo_txts      STRING
  DEFINE ls_sql             STRING
  DEFINE ls_show,ls_hide    STRING
  DEFINE l_gae04            LIKE gae_file.gae04

  #判斷是否進行料件多屬性新機制管理以及是否傳入了屬性群組
  IF ( g_sma.sma120 = 'Y' )AND( g_sma.sma907 = 'Y' ) AND (NOT cl_null(lg_oay22)) THEN
     #首先判斷有無單身記錄，如果單身根本沒有東東，則按照默認的lg_oay22來決定
     #顯示什么組別的信息，如果有單身，則進行下面的邏輯判斷
     IF g_ogb.getLength() = 0 THEN
        LET lg_group = lg_oay22
     ELSE
       #讀取當前單身所有的料件資料，如果它們都屬于多屬性子料件，并且擁有一致的
       #屬性群組，則以該屬性群組作為顯示單身明細屬性的依據，如果有不統一的狀況
       #則返回一個NULL，下面將不顯示任明細屬性列
       FOR li_i = 1 TO g_ogb.getLength()
         #如果某一個料件沒有對應的母料件(已經在前面的b_fill中取出來放在imx00中了)
         #則不進行下面判斷直接退出了
         IF  cl_null(g_ogb[li_i].att00) THEN
            LET lg_group = ''
            EXIT FOR
         END IF
         SELECT imaag INTO l_compare FROM ima_file WHERE ima01 = g_ogb[li_i].att00
         #第一次是賦值
         IF cl_null(lg_group) THEN
            LET lg_group = l_compare
         #以后是比較
         ELSE
           #如果在單身料件屬于不同的屬性組則直接退出（不顯示這些東東)
           IF l_compare <> lg_group THEN
              LET lg_group = ''
              EXIT FOR
           END IF
         END IF
         IF lg_group <> lg_oay22 THEN
            LET lg_group = ''
            EXIT FOR
         END IF
       END FOR
     END IF

     #到這里時lg_group中存放的已經是應該顯示的組別了，該變量是一個全局變量
     #在單身INPUT或開窗時都會用到，因為refresh函數被執行的時機較早，所以能保証在需要的時候有值
     SELECT COUNT(*) INTO li_col_count FROM agb_file WHERE agb01 = lg_group

     #走到這個分支說明是采用新機制，那么使用att00父料件編號代替ogb04子料件編號來顯示
     #得到當前語言別下ogb04的欄位標題
     SELECT gae04 INTO l_gae04 FROM gae_file
       WHERE gae01 = g_prog AND gae02 = 'ogb04' AND gae03 = g_lang
     CALL cl_set_comp_att_text("att00",l_gae04)

     #為了提高效率，把需要顯示和隱藏的欄位都放到各自的變量里，然后在結尾的地方一次性顯示或隱藏
     IF NOT cl_null(lg_group) THEN
        LET ls_hide = 'ogb04,ogb06'
        LET ls_show = 'att00'
     ELSE
        LET ls_hide = 'att00'
        LET ls_show = 'ogb04,ogb06'
     END IF

     #顯現該有的欄位,置換欄位格式
     CALL lr_agc.clear()  #因為這個過程可能會被執行多次，作為一個公共變量，每次執行之前必須要初始化
     FOR li_i = 1 TO li_col_count
         SELECT agb03 INTO lc_agb03 FROM agb_file
           WHERE agb01 = lg_group AND agb02 = li_i

         LET lc_agb03 = lc_agb03 CLIPPED
         SELECT * INTO lr_agc[li_i].* FROM agc_file
           WHERE agc01 = lc_agb03

         LET lc_index = li_i USING '&&'

         CASE lr_agc[li_i].agc04
           WHEN '1'
             LET ls_show = ls_show || ",att" || lc_index
             LET ls_hide = ls_hide || ",att" || lc_index || "_c"
             CALL cl_set_comp_att_text("att" || lc_index,lr_agc[li_i].agc02)

                CALL cl_chg_comp_att("formonly.att" || lc_index,"NOT NULL|REQUIRED|SCROLL","1|1|1")
           WHEN '2'
             LET ls_show = ls_show || ",att" || lc_index || "_c"
             LET ls_hide = ls_hide || ",att" || lc_index
             CALL cl_set_comp_att_text("att" || lc_index || "_c",lr_agc[li_i].agc02)
             LET ls_sql = "SELECT * FROM agd_file WHERE agd01 = '",lr_agc[li_i].agc01,"'"
             DECLARE agd_curs CURSOR FROM ls_sql
             LET ls_combo_vals = ""
             LET ls_combo_txts = ""
             FOREACH agd_curs INTO lr_agd.*
                IF SQLCA.sqlcode THEN
                   EXIT FOREACH
                END IF
                IF ls_combo_vals IS NULL THEN
                   LET ls_combo_vals = lr_agd.agd02 CLIPPED
                ELSE
                   LET ls_combo_vals = ls_combo_vals,",",lr_agd.agd02 CLIPPED
                END IF
                IF ls_combo_txts IS NULL THEN
                   LET ls_combo_txts = lr_agd.agd02 CLIPPED,":",lr_agd.agd03 CLIPPED
                ELSE
                   LET ls_combo_txts = ls_combo_txts,",",lr_agd.agd02 CLIPPED,":",lr_agd.agd03 CLIPPED
                END IF
             END FOREACH
             CALL cl_set_combo_items("formonly.att" || lc_index || "_c",ls_combo_vals,ls_combo_txts)
             #這里需要判別g_sma.sma908,如果是允許新增子料件則要把這些屬性設置成為REQUIRED的,否則要設成NOENTRY
                CALL cl_chg_comp_att("formonly.att" || lc_index || "_c","NOT NULL|REQUIRED|SCROLL","1|1|1")
          WHEN '3'
             LET ls_show = ls_show || ",att" || lc_index
             LET ls_hide = ls_hide || ",att" || lc_index || "_c"
             CALL cl_set_comp_att_text("att" || lc_index,lr_agc[li_i].agc02)
             #這里需要判別g_sma.sma908,如果是允許新增子料件則要把這些屬性設置成為REQUIRED的,否則要設成NOENTRY
                CALL cl_chg_comp_att("formonly.att" || lc_index,"NOT NULL|REQUIRED|SCROLL","1|1|1")
       END CASE
     END FOR

  ELSE
    #否則什么也不做(不顯示任何屬性列)
    LET li_i = 1
    #為了提高效率，把需要顯示和隱藏的欄位都放到各自的變量里，然后在結尾的地方一次性顯示或隱藏
    LET ls_hide = 'att00'
    LET ls_show = 'ogb04'
  END IF

  #下面開始隱藏其他明細屬性欄位(從li_i開始)
  FOR li_j = li_i TO 10
      LET lc_index = li_j USING '&&'
      #注意att0x和att0x_c都要隱藏，別忘了_c的
      LET ls_hide = ls_hide || ",att" || lc_index || ",att" || lc_index || "_c"
  END FOR

  #這樣只用調兩次公共函數就可以解決問題了，效率應該會高一些
  CALL cl_set_comp_visible(ls_show, TRUE)
  CALL cl_set_comp_visible(ls_hide, FALSE)

END FUNCTION

#--------------------在修改下面的代碼前請讀一下注釋先，謝了! -----------------------

#下面代碼是從單身INPUT ARRAY語句中的AFTER FIELD段中拷貝來的，因為在多屬性新模式下原來的oea04料件編號
#欄位是要被隱藏起來，并由新增加的imx00（母料件編號）+各個明細屬性欄位來取代，所以原來的AFTER FIELD
#代碼是不會被執行到，需要執行的判斷應該放新增加的几個欄位的AFTER FIELD中來進行，因為要用多次嘛，所以
#單獨用一個FUNCTION來放，順便把ogb04的AFTER FIELD也移過來，免得將來維護的時候遺漏了
#下標g_ogb[l_ac]都被改成g_ogb[p_ac]，請注意

#本函數返回TRUE/FALSE,表示檢核過程是否通過，一般說來，在使用過程中應該是如下方式□
#    AFTER FIELD XXX
#        IF NOT t600_check_ogb04(.....)  THEN NEXT FIELD XXX END IF
FUNCTION t600_check_ogb04(p_field,p_ac,p_cmd)    #MOD-660090
DEFINE
  p_field                     STRING,    #當前是在哪個欄位中觸發了AFTER FIELD事件
  p_ac                        LIKE type_file.num5,    #No.FUN-680137 SMALLINT  #g_ogb數組中的當前記錄下標

  l_ps                        LIKE sma_file.sma46,
  l_str_tok                   base.stringTokenizer,
  l_tmp, ls_sql               STRING,
  l_param_list                STRING,
  l_cnt, li_i                 LIKE type_file.num5,    #No.FUN-680137 SMALLINT
  ls_value                    STRING,
  ls_pid,ls_value_fld         LIKE ima_file.ima01,
  ls_name, ls_spec            STRING,
  lc_agb03                    LIKE agb_file.agb03,
  lc_agd03                    LIKE agd_file.agd03,
  ls_pname                    LIKE ima_file.ima02,
  l_misc                      LIKE type_file.chr4,    #No.FUN-680137 VARCHAR(04)
  l_n                         LIKE type_file.num5,    #No.FUN-680137 SMALLINT
  l_b2                        LIKE ima_file.ima31,
  l_ima130                    LIKE ima_file.ima130,
  l_ima131                    LIKE ima_file.ima131,
  l_ima25                     LIKE ima_file.ima25,
  l_imaacti                   LIKE ima_file.imaacti,
  l_qty                       LIKE type_file.num10,   #No.FUN-680137 INTEGER
  p_cmd                       LIKE type_file.chr1,              #MOD-660090  #No.FUN-680137 VARCHAR(1)
  l_ima135                    LIKE ima_file.ima135,
  l_ima1002                   LIKE ima_file.ima1002,
  l_ima35                     LIKE ima_file.ima35,
  l_ima36                     LIKE ima_file.ima36,
  l_occ1028                   LIKE occ_file.occ1028,
  l_ima1010                   LIKE ima_file.ima1010,
  l_sum1                      LIKE ogb_file.ogb12,
  l_sum2                      LIKE ogb_file.ogb12,
  l_sum3                      LIKE ogb_file.ogb12,
  l_sum4                      LIKE ogb_file.ogb12,
  l_fac                       LIKE ogb_file.ogb05_fac,
  l_max                       LIKE tqw_file.tqw07
DEFINE l_rtz04                LIKE rtz_file.rtz04    #No.FUN-870007   
DEFINE l_rte05                LIKE rte_file.rte05    #No.FUN-870007
DEFINE l_rte07                LIKE rte_file.rte07    #No.FUN-870007
DEFINE l_rtdconf              LIKE rtd_file.rtdconf  #No.FUN-870007

     #如果當前欄位是新增欄位（母料件編號以及十個明細屬性欄位）的時候，如果全部輸了值則合成出一個
     #新的子料件編號并把值填入到已經隱藏起來的ogb04中（如果imxXX能夠顯示，ogb04一定是隱藏的）
     #下面就可以直接沿用ogb04的檢核邏輯了
     #如果不是，則看看是不是ogb04自己觸發了，如果還不是則什么也不做(無聊)，返回一個FALSE
#FUN-A60035 ---MARK BEGIN
##FUN-A50054 --Begin
##    IF NOT s_industry("slk") THEN
#&ifndef SLK
##FUN-A50054 --End
#FUN-A60035 ---MARK END
     IF ( p_field = 'imx00' )OR( p_field = 'imx01' )OR( p_field = 'imx02' )OR
        ( p_field = 'imx03' )OR( p_field = 'imx04' )OR( p_field = 'imx05' )OR
        ( p_field = 'imx06' )OR( p_field = 'imx07' )OR( p_field = 'imx08' )OR
        ( p_field = 'imx09' )OR( p_field = 'imx10' ) THEN

        #首先判斷需要的欄位是否全部完成了輸入（只有母料件編號+被顯示出來的所有明細屬性
        #全部被輸入完成了才進行后續的操作
        LET ls_pid = g_ogb[p_ac].att00   # ls_pid 父料件編號
        LET ls_value = g_ogb[p_ac].att00   # ls_value 子料件編號
        IF cl_null(ls_pid) THEN
           #MOD-640107 Add ,所有要返回TRUE的分支都要加這兩句話,原來下面的會被
           #注釋掉
           CALL t600_set_no_entry_b1(p_cmd)
           CALL t600_set_required_b1(p_cmd)

           RETURN TRUE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
        END IF  #注意這里沒有錯，所以返回TRUE

        #取出當前母料件包含的明細屬性的個數
        SELECT COUNT(*) INTO l_cnt FROM agb_file WHERE agb01 =
           (SELECT imaag FROM ima_file WHERE ima01 = ls_pid)
        IF l_cnt = 0 THEN
           #MOD-640107 Add ,所有要返回TRUE的分支都要加這兩句話,原來下面的會被
           #注釋掉
           CALL t600_set_no_entry_b1(p_cmd)
           CALL t600_set_required_b1(p_cmd)

            RETURN TRUE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
        END IF

        FOR li_i = 1 TO l_cnt
            #如果有任何一個明細屬性應該輸而沒有輸的則退出
            IF cl_null(arr_detail[p_ac].imx[li_i]) THEN
               #MOD-640107 Add ,所有要返回TRUE的分支都要加這兩句話,原來下面的會被
               #注釋掉
               CALL t600_set_no_entry_b1(p_cmd)
               CALL t600_set_required_b1(p_cmd)

               RETURN TRUE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
            END IF
        END FOR

        #得到系統定義的標准分隔符sma46
        SELECT sma46 INTO l_ps FROM sma_file

        #合成子料件的名稱
        SELECT ima02 INTO ls_pname FROM ima_file   # ls_name 父料件名稱
          WHERE ima01 = ls_pid
        LET ls_spec = ls_pname  # ls_spec 子料件名稱
        #方法□循環在agd_file中找有沒有對應記錄，如果有，就用該記錄的名稱來
        #替換初始名稱，如果找不到則就用原來的名稱
        FOR li_i = 1 TO l_cnt
            LET lc_agd03 = ""
            LET ls_value = ls_value.trim(), l_ps, arr_detail[p_ac].imx[li_i]
            SELECT agd03 INTO lc_agd03 FROM agd_file
             WHERE agd01 = lr_agc[li_i].agc01 AND agd02 = arr_detail[p_ac].imx[li_i]
            IF cl_null(lc_agd03) THEN
               LET ls_spec = ls_spec.trim(),l_ps,arr_detail[p_ac].imx[li_i]
            ELSE
               LET ls_spec = ls_spec.trim(),l_ps,lc_agd03
            END IF
        END FOR

        #解析ls_value生成要傳給cl_copy_bom的那個l_param_list
        LET l_str_tok = base.StringTokenizer.create(ls_value,l_ps)
        LET l_tmp = l_str_tok.nextToken()   #先把第一個部分--名稱去掉

        LET ls_sql = "SELECT agb03 FROM agb_file,ima_file WHERE ",
                     "ima01 = '",ls_pid CLIPPED,"' AND agb01 = imaag ",
                     "ORDER BY agb02"
        DECLARE param_curs CURSOR FROM ls_sql
        FOREACH param_curs INTO lc_agb03
          #l_str_tok中的Tokens數量應該和param_curs中的記錄數量完全一致
          IF cl_null(l_param_list) THEN
             LET l_param_list = '#',lc_agb03,'#|',l_str_tok.nextToken()
          ELSE
             LET l_param_list = l_param_list,'|#',lc_agb03,'#|',l_str_tok.nextToken()
          END IF
        END FOREACH

        LET g_value = ls_value
        LET g_chr2  = '1'

        #出貨單不允許新增ima_file里面沒有的子料件，故在此檢查一下
        SELECT count(*) INTO l_n FROM ima_file
         WHERE ima01 =g_value
        IF l_n =0 THEN
           CALL cl_err(ls_value,'atm-523',0)
           RETURN FALSE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
        END IF
        #修改的料件必須存在于訂單內
        IF NOT cl_null(g_ogb[l_ac].ogb31) AND NOT cl_null(g_ogb[l_ac].ogb32) THEN
           SELECT count(*) INTO l_n FROM oeb_file
            WHERE oeb04 =g_value
              AND oeb01 =g_ogb[l_ac].ogb31
              AND oeb03 =g_ogb[l_ac].ogb32
           IF l_n =0 THEN
              CALL cl_err(ls_value,'atm-524',0)
              RETURN FALSE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
           END IF
        END IF

        #調用cl_copy_ima將新生成的子料件插入到數據庫中
        #把生成的子料件賦給ogb04，否則下面的檢查就沒有意義了
        LET g_ogb[p_ac].ogb04 = ls_value
     ELSE
       IF ( p_field <> 'ogb04' )AND( p_field <> 'imx00' ) THEN
          RETURN FALSE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
       END IF
     END IF
#FUN-A60035 ---MARK BEGIN
##FUN-A50054 --Begin
## END IF
#&endif
##FUN-A50054 --End
#FUN-A60035 ---MARK END

  #到這里已經完成了以前在cl_itemno_multi_att()中做的所有准備工作，在系統資料庫
  #中已經有了對應的子料件的名稱，下面可以按照ogb04進行判斷了

  #--------重要 !!!!!!!!!!!-------------------------
  #下面的代碼都是從原INPUT ARRAY中的AFTER FIELD ogb04段拷貝來的，唯一做的修改
  #是將原來的NEXT FIELD 語句都改成了RETURN FALSE, xxx,xxx ... ，因為NEXE FIELD
  #語句要交給調用方來做，這里只需要返回一個FALSE告訴它有錯誤就可以了，同時一起
  #返回的還有一些CHECK過程中要從ima_file中取得的欄位信息，其他的比如判斷邏輯和
  #錯誤提示都沒有改，如果你需要在里面添加代碼請注意上面的那個要點就可以了
          IF NOT cl_null(g_ogb[l_ac].ogb04) THEN
             IF g_ogb_t.ogb04 IS NULL OR g_ogb_t.ogb04 <> g_ogb[l_ac].ogb04 THEN
                LET g_change = 'Y'
             END IF
     #新增一個判斷,如果lg_oay22不為空,表示當前采用的是料件多屬性的新機制,因此這>
     #attxx這樣的明細屬性欄位的AFTER FIELD來調用的,所以不再使用原來的輸入機制,否
#         IF s_industry("slk") THEN    #FUN-A60035 ---MARK
             IF cl_null(lg_oay22) THEN
               IF g_sma.sma120 = 'Y' THEN
                  CALL cl_itemno_multi_att("ogb04",g_ogb[l_ac].ogb04,"","1","6") RETURNING g_chr3,g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb06
                  DISPLAY g_ogb[l_ac].ogb04 TO ogb04
                  DISPLAY g_ogb[l_ac].ogb06 TO ogb06
                  LET g_value = g_ogb[l_ac].ogb04
                  LET g_chr2  = '1'
                  SELECT imx00 INTO g_ogb04
                    FROM imx_file
                   WHERE imx000 = g_ogb[l_ac].ogb04
               END IF
             END IF
#         END IF    #FUN-A50054 add   #FUN-A60035 ---MARK
             LET l_misc=g_ogb[l_ac].ogb04[1,4]
             IF g_ogb[l_ac].ogb04[1,4]!='MISC' THEN
                SELECT * FROM ima_file
                 WHERE ima01=g_ogb[l_ac].ogb04
                IF SQLCA.sqlcode=100 THEN
                   CALL cl_err3("sel","ima_file",g_ogb[l_ac].ogb04,"","ams-003","","",1)  #No.FUN-670008
                   RETURN FALSE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
                END IF

                   SELECT COUNT(*) INTO l_n FROM ima_file
                    WHERE ima01=g_ogb[l_ac].ogb04
                      AND ima1010 = '1'      #No.FUN-690025
                      AND imaacti ='Y'
                   IF l_n=0 THEN
                      CALL cl_err('','atm-380',1)
                      RETURN FALSE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
                   END IF
              IF g_aza.aza50 = 'Y' THEN #MOD-740114 流通配銷的判斷挪至此,因為以上程式段為對料件的正確性控管
                   SELECT COUNT(*) INTO l_n FROM ima_file,tqh_file
                    WHERE ima01=g_ogb[l_ac].ogb04
                     #AND im1006 = tqh02
                      AND ima1006 = tqh02   #Mod No:TQC-B30124
                      AND tqhacti ='Y'
                   IF l_n=0 THEN
                      CALL cl_err('','atm-018',1)
                      RETURN FALSE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
                   END IF

                   SELECT ima1002,ima135 INTO g_ogb[l_ac].ima1002,g_ogb[l_ac].ima135
                     FROM ima_file
                    WHERE ima01 = g_ogb[l_ac].ogb04
              END IF

             END IF
             IF g_ogb[l_ac].ogb04[1,4]='MISC' THEN  #NO:6808
                SELECT COUNT(*) INTO l_n FROM ima_file
                 WHERE ima01=l_misc
                   AND ima01='MISC'
                IF l_n=0 THEN
                   CALL cl_err('','aim-806',0)
                   RETURN FALSE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
                END IF
                LET g_ogb[l_ac].ima1002 = NULL   #No.FUN-610064
                LET g_ogb[l_ac].ima135 = NULL    #No.FUN-610064
             END IF
             IF g_ogb[l_ac].ogb31[1,4] ='MISC' AND
                g_ogb[l_ac].ogb04[1,4]!='MISC' THEN
                CALL cl_err('part=MISC:','axm-232',0)
                   RETURN FALSE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
             END IF

             #SELECT ima02,ima021,ima31,ima35,ima36   #MOD-AC0070
             #  INTO g_buf,g_buf1,l_b2,l_ima35,l_ima36   #MOD-AC0070
             SELECT ima02,ima021,ima31,ima35,ima36,ima25   #MOD-AC0070
               INTO g_buf,g_buf1,l_b2,l_ima35,l_ima36,l_ima25   #MOD-AC0070
               FROM ima_file WHERE ima01=g_ogb[l_ac].ogb04
             IF STATUS AND g_ogb[l_ac].ogb04[1,4]!='MISC' THEN  #NO:6808
                CALL cl_err('sel ima',STATUS,0)
                RETURN FALSE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
             END IF
             IF cl_null(g_ogb[l_ac].ogb05) THEN
                LET g_ogb[l_ac].ogb05=l_b2
                #-----MOD-AC0070---------
                CALL s_umfchk(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb05,l_ima25)
                      RETURNING g_cnt,g_factor
                IF g_cnt = 1 THEN
                   LET g_factor = 1
                END IF
                LET b_ogb.ogb05_fac = g_factor
                #-----END MOD-AC0070-----
             END IF
             

             IF cl_null(g_ogb[l_ac].ogb09) THEN
                IF g_azw.azw04='2' THEN
                   SELECT rtz07 INTO g_ogb[l_ac].ogb09 FROM rtz_file
                    WHERE rtz01 = g_plant
                ELSE
                   LET g_ogb[l_ac].ogb09=l_ima35
                END IF #No.FUN-870007
             END IF
             IF cl_null(g_ogb[l_ac].ogb091) THEN
                LET g_ogb[l_ac].ogb091=l_ima36
             END IF
             IF g_ogb[l_ac].ogb06 IS NULL OR (g_ogb[l_ac].ogb04 <>g_ogb_t.ogb04)
                THEN
                LET g_ogb[l_ac].ogb06 = g_buf
                LET g_ogb[l_ac].ima021= g_buf1
             END IF
             IF g_sma.sma115 = 'Y' THEN
                CALL s_chk_va_setting(g_ogb[l_ac].ogb04)
                     RETURNING g_flag,g_ima906,g_ima907
                IF g_flag=1 THEN
                   RETURN FALSE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
                END IF
                CALL s_chk_va_setting1(g_ogb[l_ac].ogb04)
                     RETURNING g_flag,g_ima908
                IF g_flag=1 THEN
                   RETURN FALSE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
                END IF
                IF g_ima906 = '3' THEN
                   LET g_ogb[l_ac].ogb913=g_ima907
                END IF
             END IF
             IF g_sma.sma116 MATCHES '[23]' THEN
                CALL s_chk_va_setting1(g_ogb[l_ac].ogb04)
                     RETURNING g_flag,g_ima908
                IF g_flag=1 THEN
                   RETURN FALSE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
                END IF
                IF cl_null(g_ogb[l_ac].ogb916) THEN
                   LET g_ogb[l_ac].ogb916=g_ima908
                END IF
             END IF
             SELECT ima25 INTO g_ima25 FROM ima_file WHERE ima01=g_ogb[l_ac].ogb04
             LET g_ima31 = l_b2
             IF g_ogb_t.ogb04 IS NULL OR g_ogb_t.ogb04 <> g_ogb[l_ac].ogb04 THEN
                IF (NOT cl_null(g_ogb[l_ac].ogb1003) AND g_aza.aza50 ='Y') OR g_azw.azw04='2' THEN   #No.FUN-670008 #FUN-9C0173 
                   IF cl_null(g_ogb[l_ac].ogb31) AND cl_null(g_ogb[l_ac].ogb32) THEN                 #MOD-B60052
                  #CALL t600_price(l_ac) RETURNING l_fac       #FUN-AC0012
                     CALL t600_price(p_cmd,l_ac) RETURNING l_fac #FUN-AC0012
                   END IF                                                                            #MOD-B60052
                END IF
             END IF
             IF g_chr2 = '1' AND NOT cl_null(g_oga.oga011) THEN
                #LET g_chr1 = 'Y'   #CHI-880006
                SELECT ogb19 INTO g_ogb[l_ac].ogb19
                  FROM oga_file,ogb_file
                 WHERE oga01 = g_oga.oga011
                   AND oga01 = ogb01
                DISPLAY BY NAME g_ogb[l_ac].ogb19
             END IF
             IF g_chr2 = '0' AND cl_null(g_ogb[l_ac].ogb31) THEN
                SELECT COUNT(*) INTO l_n
                  FROM obk_file
                 WHERE obk01 = g_ogb[l_ac].ogb04
                   AND obk02 = g_oga.oga03
                IF l_n = 1 THEN
                   #LET g_chr1 = 'Y'   #CHI-880006
                   SELECT obk11 INTO g_ogb[l_ac].ogb19
                     FROM obk_file
                    WHERE obk01 = g_ogb[l_ac].ogb04
                      AND obk02 = g_oga.oga03
                ELSE
                   LET g_ogb[l_ac].ogb19 = 'N'
                END IF
             END IF
             SELECT COUNT(*) INTO l_n FROM ima_file WHERE ima01=g_ogb[p_ac].ogb04
             IF l_n=0 THEN
                CALL cl_err(g_value,'ams-003',1)
                RETURN FALSE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
             END IF
          ELSE
              IF ( p_field = 'ogb04' )OR( p_field = 'imx00' ) THEN
                 #MOD-640107 Add ,所有要返回TRUE的分支都要加這兩句話,原來下面的會被
                 #注釋掉
                 CALL t600_set_no_entry_b1(p_cmd)
                 CALL t600_set_required_b1(p_cmd)

                    LET g_value = ls_value
                    SELECT COUNT(*) INTO l_n FROM ima_file WHERE ima01=g_value
                    IF l_n=0 THEN
                       CALL cl_err(g_value,'ams-003',1)
                       RETURN FALSE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
                    END IF
                  RETURN FALSE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
              ELSE
                 #如果不是oeb,則是由attxx來觸發的,則非輸不可
                  RETURN FALSE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
              END IF #如果為空則不允許新增

             DISPLAY ' ' TO FORMONLY.ima1002   #No.FUN-610064
             DISPLAY ' ' TO FORMONLY.ima135    #No.FUN-610064
          END IF

          LET g_buf = NULL
          LET g_buf1 = NULL
          SELECT obk03 INTO g_buf FROM obk_file
           WHERE obk01 = g_ogb[l_ac].ogb04 AND obk02 = g_oga.oga03   #No.TQC-640123
          IF cl_null(b_ogb.ogb11) THEN LET b_ogb.ogb11 = g_buf END IF
          CALL t600_set_no_entry_b1(p_cmd)

          RETURN TRUE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
END FUNCTION

#用于att01~att10這十個輸入型屬性欄位的AFTER FIELD事件的判斷函數
#傳入參數:p_value 要比較的欄位內容,p_index當前欄位的索引號(從1~10表示att01~att10)
#         p_row是當前行索引,傳入INPUT ARRAY中使用的l_ac即可
#與t600_check_ogb04相同,如果檢查過程中如果發現錯誤,則報錯并返回一個FALSE
#而AFTER FIELD的時候檢測到這個返回值則會做NEXT FIELD
FUNCTION t600_check_att0x(p_value,p_index,p_row,p_cmd)    #MOD-660090
DEFINE
  p_value      LIKE imx_file.imx01,
  p_index      LIKE type_file.num5,    #No.FUN-680137 SMALLINT
  p_row        LIKE type_file.num5,    #No.FUN-680137 SMALLINT
  p_cmd        LIKE type_file.chr1,     #MOD-660090  #No.FUN-680137 VARCHAR(1)
  li_min_num   LIKE agc_file.agc05,
  li_max_num   LIKE agc_file.agc06,
  l_index      STRING,

  l_check_res     LIKE type_file.num5,    #No.FUN-680137 SMALLINT
  l_b2            LIKE cob_file.cob08,    #No.FUN-680137 VARCHAR(30)
  l_imaacti       LIKE ima_file.imaacti,
  l_ima35         LIKE ima_file.ima35,  #No.FUN-680137 VARCHAR(10)
  l_ima36         LIKE ima_file.ima35,  #No.FUN-680137 VARCHAR(10)
  l_ima25         LIKE ima_file.ima25

  #這個欄位一旦進入了就不能忽略，因為要保証在輸入其他欄位之前必須要生成ogb04料件編號
  IF cl_null(p_value) THEN
     RETURN FALSE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
  END IF

  #這里使用到了一個用于存放當前屬性組包含的所有屬性信息的全局數組lr_agc
  #該數組會由t600_refresh_detail()函數在較早的時候填充

  #判斷長度與定義的使用位數是否相等
  IF LENGTH(p_value CLIPPED) <> lr_agc[p_index].agc03 THEN
     CALL cl_err_msg("","aim-911",lr_agc[p_index].agc03,1)
     RETURN FALSE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
  END IF
  #比較大小是否在合理范圍之內
  LET li_min_num = lr_agc[p_index].agc05
  LET li_max_num = lr_agc[p_index].agc06
  IF (lr_agc[p_index].agc05 IS NOT NULL) AND
     (p_value < li_min_num) THEN
     CALL cl_err_msg("","lib-232",lr_agc[p_index].agc05 || "|" || lr_agc[p_index].agc06,1)
     RETURN FALSE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
  END IF
  IF (lr_agc[p_index].agc06 IS NOT NULL) AND
     (p_value > li_max_num) THEN
     CALL cl_err_msg("","lib-232",lr_agc[p_index].agc05 || "|" || lr_agc[p_index].agc06,1)
     RETURN FALSE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
  END IF
  #通過了欄位檢查則可以下面的合成子料件代碼以及相應的檢核操作了
  LET arr_detail[p_row].imx[p_index] = p_value
  LET l_index = p_index USING '&&'
  CALL t600_check_ogb04('imx' || l_index ,p_row,p_cmd)    #MOD-660090
    RETURNING l_check_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
    RETURN l_check_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
END FUNCTION

#用于att01_c~att10_c這十個選擇型屬性欄位的AFTER FIELD事件的判斷函數
#傳入參數:p_value 要比較的欄位內容,p_index當前欄位的索引號(從1~10表示att01~att10)
#         p_row是當前行索引,傳入INPUT ARRAY中使用的l_ac即可
#與t600_check_ogb04相同,如果檢查過程中如果發現錯誤,則報錯并返回一個FALSE
#而AFTER FIELD的時候檢測到這個返回值則會做NEXT FIELD
FUNCTION t600_check_att0x_c(p_value,p_index,p_row,p_cmd)    #MOD-660090
DEFINE
  p_value  LIKE imx_file.imx01,
  p_index  LIKE type_file.num5,    #No.FUN-680137 SMALLINT
  p_row    LIKE type_file.num5,    #No.FUN-680137 SMALLINT
  p_cmd    LIKE type_file.chr1,     #MOD-660090  #No.FUN-680137 VARCHAR(1)
  l_index  STRING,
  l_check_res     LIKE type_file.num5,    #No.FUN-680137 SMALLINT
  l_b2            LIKE cob_file.cob08,    #No.FUN-680137 VARCHAR(30)
  l_imaacti       LIKE ima_file.imaacti,
  l_ima35         LIKE ima_file.ima35,  #No.FUN-680137 VARCHAR(10)
  l_ima36         LIKE ima_file.ima35,  #No.FUN-680137 VARCHAR(10)
  l_ima25         LIKE ima_file.ima25


  #這個欄位一旦進入了就不能忽略，因為要保証在輸入其他欄位之前必須要生成ogb04料件編號
  IF cl_null(p_value) THEN
     RETURN FALSE,g_buf,g_buf1,l_b2,l_ima35,l_ima36
  END IF
  #下拉框選擇項相當簡單，不需要進行范圍和長度的判斷，因為肯定是符合要求的了
  LET arr_detail[p_row].imx[p_index] = p_value
  LET l_index = p_index USING '&&'
  CALL t600_check_ogb04('imx'||l_index,p_row,p_cmd)    #MOD-660090
    RETURNING l_check_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
  RETURN l_check_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
END FUNCTION
FUNCTION t600_oea18_get()
   DEFINE l_oea18   LIKE oea_file.oea18
   DEFINE l_n       LIKE type_file.num5                                                                                                            #No.FUN-680137 SMALLINT

     IF cl_null(g_oga.oga01) THEN RETURN 'N' END IF
     IF cl_null(g_oga.oga16) THEN
         SELECT COUNT(*) INTO l_n
           FROM oga_file
          WHERE oga01=g_oga.oga01

         IF l_n >=1 THEN
             DECLARE oea18_get CURSOR FOR
                 SELECT oea18
                   FROM oea_file,ogb_file
                  WHERE oea01=ogb31
                    AND ogb01=g_oga.oga01

              FOREACH oea18_get INTO l_oea18
                  EXIT FOREACH
              END FOREACH
         END IF
     ELSE
         SELECT oea18 INTO l_oea18
           FROM oea_file
          WHERE oea01=g_oga.oga16
     END IF
     IF cl_null(l_oea18) THEN LET l_oea18 = 'N' END IF
     RETURN l_oea18
END FUNCTION

FUNCTION t600_spc()
DEFINE l_gaz03        LIKE gaz_file.gaz03
DEFINE l_cnt          LIKE type_file.num10   #No.FUN-680137 INTEGER
DEFINE l_qc_cnt       LIKE type_file.num10   #No.FUN-680137 INTEGER
DEFINE l_ogb03        LIKE ogb_file.ogb03    ## 項次
DEFINE l_qcs          DYNAMIC ARRAY OF RECORD LIKE qcs_file.*
DEFINE l_qc_prog      LIKE ima_file.ima35  #No.FUN-680137 VARCHAR(10)
DEFINE l_i            LIKE type_file.num10   #No.FUN-680137 INTEGER
DEFINE l_cmd          STRING
DEFINE l_sql          STRING
DEFINE l_err          STRING

   LET g_success = 'Y'

   #檢查資料是否可拋轉至 SPC
   IF g_oga.ogapost matches '[Yy]' THEN          #檢查是否有出貨扣帳
      CALL cl_err('ogapost','axm-407',0)
      LET g_success='N'
      RETURN
   END IF

   #CALL aws_spccli_check('單號','SPC拋轉碼','確認碼','有效碼')
   CALL aws_spccli_check(g_oga.oga01,g_oga.ogaspc,g_oga.ogaconf,'')
   IF g_success = 'N' THEN
      RETURN
   END IF

   LET l_qc_prog = "aqct800"               #設定QC單的程式代號

   #若在 QC 單已有此單號相關資料，則取消拋轉至 SPC
   SELECT COUNT(*) INTO l_cnt FROM qcs_file WHERE qcs01 = g_oga.oga01
   IF l_cnt > 0 THEN
      CALL cl_get_progname(l_qc_prog,g_lang) RETURNING l_gaz03
      CALL cl_err_msg(g_oga.oga01,'aqc-115', l_gaz03 CLIPPED || "|" || l_qc_prog CLIPPED,'1')
      LET g_success='N'
      RETURN
   END IF

   #需要 QC 檢驗的筆數
   SELECT COUNT(*) INTO l_qc_cnt FROM ogb_file
    WHERE ogb01 = g_oga.oga01 AND ogb19 = 'Y'
   IF l_qc_cnt = 0 THEN
      CALL cl_err(g_oga.oga01,l_err,0)
      LET g_success='N'
      RETURN
   END IF

   #需檢驗的資料，自動新增資料至 QC 單 ,功能參數為「SPC」
   LET l_sql  = "SELECT ogb03 FROM ogb_file                  WHERE ogb01 = '",g_oga.oga01,"' AND ogb19='Y'"
   PREPARE t600_ogb_p FROM l_sql
   DECLARE t600_ogb_c CURSOR WITH HOLD FOR t600_ogb_p
   FOREACH t600_ogb_c INTO l_ogb03
       display l_cmd
       IF g_argv0 = '1' THEN
          LET l_cmd = l_qc_prog CLIPPED," '",g_oga.oga01,"' '",l_ogb03,"' '1' 'SPC' '5'"
       ELSE
          LET l_cmd = l_qc_prog CLIPPED," '",g_oga.oga01,"' '",l_ogb03,"' '1' 'SPC' '6'"
       END IF
       CALL cl_cmdrun_wait(l_cmd)
   END FOREACH

   #判斷產生的 QC 單筆數是否正確
   SELECT COUNT(*) INTO l_cnt FROM qcs_file WHERE qcs01 = g_oga.oga01
   IF l_cnt <> l_qc_cnt THEN
      CALL t600_qcs_del()
      LET g_success='N'
      RETURN
   END IF

   LET l_sql  = "SELECT *  FROM qcs_file WHERE qcs01 = '",g_oga.oga01,"'"
   PREPARE t600_qc_p FROM l_sql
   DECLARE t600_qc_c CURSOR WITH HOLD FOR t600_qc_p
   LET l_cnt = 1
   FOREACH t600_qc_c INTO l_qcs[l_cnt].*
       LET l_cnt = l_cnt + 1
   END FOREACH
   CALL l_qcs.deleteElement(l_cnt)

   # CALL aws_spccli()
   #功能: 傳送此單號所有的 QC 單至 SPC 端
   # 傳入參數: (1) QC 程式代號, (2) QC 單頭資料,
   # 回傳值  : 0 傳送失敗; 1 傳送成功
   IF aws_spccli(l_qc_prog,base.TypeInfo.create(l_qcs),"insert") THEN
      LET g_oga.ogaspc = '1'
   ELSE
      LET g_oga.ogaspc = '2'
      CALL t600_qcs_del()
   END IF

   UPDATE oga_file set ogaspc = g_oga.ogaspc WHERE oga01 = g_oga.oga01
   IF STATUS OR SQLCA.sqlerrd[3] = 0 THEN
      CALL cl_err3("upd","oga_file",g_oga.oga01,"",STATUS,"","upd ogaspc",1)
      IF g_oga.ogaspc = '1' THEN
          CALL t600_qcs_del()
      END IF
      LET g_success = 'N'
   END IF
   DISPLAY BY NAME g_oga.ogaspc

END FUNCTION

FUNCTION t600_qcs_del()

      DELETE FROM qcs_file WHERE qcs01 = g_oga.oga01
      IF SQLCA.sqlcode THEN
         CALL cl_err3("del","qcs_file",g_oga.oga01,"",SQLCA.sqlcode,"","DEL qcs_filee err!",0)
      END IF

      DELETE FROM qct_file WHERE qct01 = g_oga.oga01
      IF SQLCA.sqlcode THEN
         CALL cl_err3("del","qct_file",g_oga.oga01,"",SQLCA.sqlcode,"","DEL qct_filee err!",0)
      END IF

      DELETE FROM qcu_file WHERE qcu01 = g_oga.oga01
      IF SQLCA.sqlcode THEN
         CALL cl_err3("del","qcu_file",g_oga.oga01,"",SQLCA.sqlcode,"","DEL qcu_filee err!",0)
      END IF

      DELETE FROM qctt_file WHERE qctt01 = g_oga.oga01
      IF SQLCA.sqlcode THEN
         CALL cl_err3("del","qctt_file",g_oga.oga01,"",SQLCA.sqlcode,"","DEL qcstt_filee err!",0)
      END IF

END FUNCTION

FUNCTION t600_b1_chk()
   DEFINE l_oga55 LIKE oga_file.oga55

   IF g_oga.oga01 IS NULL THEN RETURN FALSE END IF
   SELECT * INTO g_oga.* FROM oga_file WHERE oga01 = g_oga.oga01
   LET l_oga55 = g_oga.oga55      #FUN-550050
   IF g_oga.ogaconf = 'X' THEN CALL cl_err('',9024,0) RETURN FALSE END IF
   IF g_argv0 MATCHES '[15A]' THEN      #No.7992   #MOD-870224
      IF g_oga.ogaconf = 'Y' THEN
         CALL cl_err('',9023,0) RETURN FALSE
      END IF
   END IF
   IF g_argv0 MATCHES '[24689]' THEN     #No.7992  #No.FUN-630061
      IF g_oga.ogaconf = 'Y' THEN
         CALL cl_err('',9023,0) RETURN FALSE
      END IF
      IF g_oga.ogapost = 'Y' THEN
         CALL cl_err('','mfg0175',0) RETURN FALSE
      END IF
   END IF

   IF g_argv0 MATCHES '[15]' THEN
      LET g_cnt=0
      SELECT COUNT(*) INTO g_cnt FROM oga_file
       WHERE oga011 = g_oga.oga01
         AND oga09 IN ('2','4','6')   #No.7992
         AND ogaconf != 'X'
      #此出貨通知單已經出貨! 不可再做任何處理!
      IF g_cnt > 0 THEN
         CALL cl_err('oga011!='':','axm-228',1)
         RETURN FALSE
      END IF
   END IF

   IF g_oga.oga55 matches '[Ss]' THEN       #FUN-550050
       CALL cl_err('','apm-030',0)
       RETURN FALSE
   END IF

   LET g_success='Y'                #MOD-710019 add
   CALL t600_g_b()                 #由訂單自動產生單身
   CALL cl_opmsg('b')
   RETURN TRUE
END FUNCTION

FUNCTION t600_b1_default(p_cmd)
   DEFINE p_cmd LIKE type_file.chr1

   LET b_ogb.ogb01=g_oga.oga01
   LET g_ogb[l_ac].ogb12=0
   LET g_ogb[l_ac].ogb1005 =1      #No.FUN-610064
   LET g_ogb[l_ac].ogb1006 =100    #No.FUN-610064
   LET g_ogb[l_ac].ogb1012 ='N'    #No.FUN-670008
   #add by huyx110916---start---
   LET g_ogb[l_ac].ogbud07 =0
   LET g_ogb[l_ac].ogbud08 =0
   #add by huyx110916---end---
   LET g_ogb[l_ac].ogb41 = g_oga.oga46   #FUN-810045 add
   LET b_ogb.ogb05_fac=1
   LET g_change='Y'
   LET g_yes   ='N'
   LET b_ogb.ogb37=0   #FUN-AB0061
   LET b_ogb.ogb13=0
   LET b_ogb.ogb14=0
   LET b_ogb.ogb14t=0
   LET b_ogb.ogb15_fac=1
   LET b_ogb.ogb16=0
   LET b_ogb.ogb17='N'
   LET b_ogb.ogb19='N'           #No.FUN-5C0075
   LET b_ogb.ogb18=0
   LET b_ogb.ogb60=0
   LET b_ogb.ogb63=0
   LET b_ogb.ogb64=0
   LET b_ogb.ogb65=''  #No.FUN-630061
   LET b_ogb.ogb1014='N'  #FUN-6A0007
   LET g_ogb[l_ac].ogb930=s_costcenter(g_oga.oga15) #FUN-670063
   LET g_ogb[l_ac].gem02c=s_costcenter_desc(g_ogb[l_ac].ogb930) #FUN-670063
   IF g_azw.azw04='2' THEN
   LET g_ogb[l_ac].ogb47=0
   ELSE
   LET g_ogb[l_ac].ogb44='1'
   END IF
   LET g_ogb_t.* = g_ogb[l_ac].*             #新輸入資料
   CALL t600_set_entry_b1(p_cmd)     #No:MOD-570264
   CALL t600_set_no_required_b1(p_cmd) #No:MOD-570264
   CALL cl_show_fld_cont()     #FUN-550037(smin)
END FUNCTION

FUNCTION t600_bef_ogb03()
   IF g_ogb[l_ac].ogb03 IS NULL OR g_ogb[l_ac].ogb03 = 0 THEN
#FUN-A60035 ---MARK BEGIN
##FUN-A60035 ---add begin
#&ifdef SLK
#       SELECT max(ata02)+1 INTO g_ogb[l_ac].ogb03
#         FROM ata_file
#        WHERE ata00 = g_prog
#          AND ata01 = g_oga.oga01
#       IF cl_null(g_ogb[l_ac].ogb03) THEN
#&endif
##FUN-A60035 ---add end
#FUN-A60035 ---MARK END
       SELECT max(ogb03)+1 INTO g_ogb[l_ac].ogb03
          FROM ogb_file WHERE ogb01 = g_oga.oga01
                          AND ogb1005 ='1'
#FUN-A60035 ---MARK BEGIN
##FUN-A60035 ---add begin
#&ifdef SLK
#       END IF
#&endif
##FUN-A60035 ---add end
#FUN-A60035 ---MARK END
       IF g_ogb[l_ac].ogb03 IS NULL THEN
           LET g_ogb[l_ac].ogb03 = 1
       END IF
   END IF
   CALL t600_set_entry_b1('') #No.FUN-630061
END FUNCTION

FUNCTION t600_chk_ogb03()
   IF NOT cl_null(g_ogb[l_ac].ogb03) THEN
      IF g_ogb[l_ac].ogb03 != g_ogb_t.ogb03 AND g_ogb_t.ogb17='Y' THEN
         LET g_ogb[l_ac].ogb03 = g_ogb_t.ogb03
         CALL cl_err('','axm-168',0)
         RETURN FALSE
      END IF
      IF g_ogb[l_ac].ogb03 = 0 THEN
         CALL cl_err('','aec-994',0)  #單身項次不能小于等于0
         RETURN FALSE
      END IF
      IF g_ogb[l_ac].ogb03 != g_ogb_t.ogb03 OR
         g_ogb_t.ogb03 IS NULL THEN
         IF g_argv0 = '8' THEN
             SELECT * FROM ogb_file
              WHERE ogb01=g_oga.oga011 AND ogb03=g_ogb[l_ac].ogb03
             IF SQLCA.sqlcode = 100 THEN
                CALL cl_err3("sel","ogb_file",g_oga.oga011,g_ogb[l_ac].ogb03,"axm-417","","",1)  #No.FUN-670008
                RETURN FALSE
             END IF
             LET g_cnt=0
             SELECT COUNT(*) INTO g_cnt FROM ogb_file,oga_file
              WHERE oga01 = ogb01
                AND oga09 = '8' AND oga011 = g_oga.oga011
                AND ogb03 = g_ogb[l_ac].ogb03
             IF g_cnt > 0 THEN
                CALL cl_err('','axm-421',1)
                RETURN FALSE
             END IF
          END IF
          LET g_cnt=0
#FUN-A60035 ---MARK BEGIN
##FUN-A60035 ---add begin
#          &ifdef SLK
#          SELECT count(*) INTO g_cnt FROM ata_file
#           WHERE ata00 = g_prog AND ata01 = g_oga.oga01
#             AND ata02 = g_ogb[l_ac].ogb03
#          &else
##FUN-A60035 ---add end
#FUN-A60035 ---MARK END
          SELECT count(*) INTO g_cnt FROM ogb_file
              WHERE ogb01 = g_oga.oga01 AND ogb03 = g_ogb[l_ac].ogb03
                AND ogb1005 ='1'
                AND ogb03 <'9001'
#FUN-A60035 ---MARK BEGIN
##FUN-A60035 ---add begin
#           &endif
##FUN-A60035 ---add end
#FUN-A60035 ---MARK END
          IF g_cnt > 0 THEN
              LET g_ogb[l_ac].ogb03 = g_ogb_t.ogb03
              CALL cl_err('',-239,0) RETURN FALSE
          END IF
          CALL t600_set_ogb()
          IF g_argv0 = '2' AND g_oga.oga65='Y' THEN
             SELECT ogb01 INTO g_ogb[l_ac].ogb01a
               FROM ogb_file,oga_file
              WHERE ogb01 =oga01
                AND oga011=g_oga.oga01
                AND oga09 = '8'
                AND ogb03 = g_ogb[l_ac].ogb03
             SELECT ogb01 INTO g_ogb[l_ac].ogb01b
               FROM ogb_file,oga_file
              WHERE ogb01 =oga01
                AND oga011=g_oga.oga01
                AND oga09 = '2' AND oga65='Y'
                AND ogb03 = g_ogb[l_ac].ogb03
          END IF
      END IF
      IF g_ogb[l_ac].ogb03 >'9001' THEN
         LET g_ogb[l_ac].ogb03 =NULL
         RETURN FALSE
      END IF
   END IF
   CALL t600_set_no_entry_b1('') #No.FUN-630061
   CALL t600_set_no_entry_b1('s')  #TQC-7C0131
   RETURN TRUE
END FUNCTION

FUNCTION t600_b1_inschk()
   DEFINE l_tqn RECORD LIKE tqn_file.*
   IF g_ogb[l_ac].ogb1005!='2' THEN    #No.FUN-610064
      IF g_sma.sma115 = 'Y' THEN
         CALL s_chk_va_setting(g_ogb[l_ac].ogb04)
              RETURNING g_flag,g_ima906,g_ima907
         IF g_flag=1 THEN
            RETURN "ogb03"	#MOD-970092
         END IF

         CALL s_chk_va_setting1(g_ogb[l_ac].ogb04)
              RETURNING g_flag,g_ima908
         IF g_flag=1 THEN
            RETURN "ogb03"	#MOD-970092
         END IF
         CALL t600_du_data_to_correct()
         IF g_ogb[l_ac].ogb17 ='N' THEN
            SELECT img09 INTO g_img09 FROM img_file
             WHERE img01=g_ogb[l_ac].ogb04
               AND img02=g_ogb[l_ac].ogb09
               AND img03=g_ogb[l_ac].ogb091
               AND img04=g_ogb[l_ac].ogb092
            #IF cl_null(g_img09) THEN                       #FUN-C80107 mark
            IF SQLCA.sqlcode=100 OR cl_null(g_img09) THEN  #FUN-C80107 add 
               IF g_oga.oga09 MATCHES '[246]' THEN
                 #FUN-C80107 modify begin---------------------------121024
                 #CALL cl_err(g_ogb[l_ac].ogb04,'mfg6069',0)
                 #RETURN "ogb03"        #MOD-970092
                  LET g_flag2 = NULL
                  CALL s_inv_shrt_by_warehouse(g_sma.sma894[2,2],g_ogb[l_ac].ogb09) RETURNING g_flag2
                  IF g_flag2 = 'N' OR g_flag2 IS NULL THEN
                     CALL cl_err(g_ogb[l_ac].ogb04,'mfg6069',0)
                     RETURN "ogb03"
                  ELSE
                     IF g_sma.sma892[3,3] = 'Y' THEN
                        IF g_bgjob='N' OR cl_null(g_bgjob) THEN
                           IF NOT cl_confirm('mfg1401') THEN
                              RETURN "ogb03"
                           END IF
                        END IF
                     END IF
                     CALL s_add_img(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                                    g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                                    g_oga.oga01,g_ogb[l_ac].ogb03,g_oga.oga02)
                     IF g_errno='N' THEN
                        RETURN "ogb03"
                     END IF
                     SELECT img09 INTO g_img09 FROM img_file
                      WHERE img01=g_ogb[l_ac].ogb04
                        AND img02=g_ogb[l_ac].ogb09
                        AND img03=g_ogb[l_ac].ogb091
                        AND img04=g_ogb[l_ac].ogb092
                  END IF
                 #FUN-C80107 modify end ----------------------------
               END IF
            END IF
           #FUN-C80107 add begin--------------------------------------------121024
            IF NOT cl_null(g_ogb[l_ac].ogb913) THEN
               IF g_ogb[l_ac].ogb04 NOT MATCHES 'MISC*' THEN
                  CALL s_chk_imgg(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                                  g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                                  g_ogb[l_ac].ogb913) RETURNING g_flag
                  IF g_flag = 1 THEN
                     IF g_oga.oga09 MATCHES '[246]' THEN
                        LET g_flag2 = NULL
                        CALL s_inv_shrt_by_warehouse(g_sma.sma894[2,2],g_ogb[l_ac].ogb09) RETURNING g_flag2
                        IF g_flag2 = 'N' OR g_flag2 IS NULL THEN
                           CALL cl_err(g_ogb[l_ac].ogb913,'asm-301',0)
                           RETURN "ogb092"
                        ELSE
                           IF g_sma.sma892[3,3] = 'Y' THEN
                              IF g_bgjob='N' OR cl_null(g_bgjob) THEN
                                 IF NOT cl_confirm('aim-995') THEN
                                    RETURN "ogb092"
                                 END IF
                              END IF
                           END IF
                           CALL s_add_imgg(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                                           g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                                           g_ogb[l_ac].ogb913,g_ogb[l_ac].ogb914,
                                           g_oga.oga01,g_ogb[l_ac].ogb03,0)
                                 RETURNING g_flag
                           IF g_flag = 1 THEN
                              RETURN "ogb092"
                           END IF
                        END IF
                     END IF
                  END IF
               END IF
               SELECT imgg10 INTO g_imgg10_2 FROM imgg_file
                WHERE imgg01=g_ogb[l_ac].ogb04
                  AND imgg02=g_ogb[l_ac].ogb09
                  AND imgg03=g_ogb[l_ac].ogb091
                  AND imgg04=g_ogb[l_ac].ogb092
                  AND imgg09=g_ogb[l_ac].ogb913
               IF cl_null(g_imgg10_2) THEN LET g_imgg10_2=0 END IF
            END IF
            IF NOT cl_null(g_ogb[l_ac].ogb910) THEN
               IF g_ogb[l_ac].ogb04 NOT MATCHES 'MISC*' THEN
                  SELECT ima906 INTO g_ima906 FROM ima_file
                   WHERE ima01=g_ogb[l_ac].ogb04
                  IF g_ima906 = '2' THEN
                     CALL s_chk_imgg(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                                     g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                                     g_ogb[l_ac].ogb910) RETURNING g_flag
                     IF g_flag = 1 THEN
                        IF g_oga.oga09 MATCHES '[246]' THEN
                           LET g_flag2 = NULL
                           CALL s_inv_shrt_by_warehouse(g_sma.sma894[2,2],g_ogb[l_ac].ogb09) RETURNING g_flag2
                           IF g_flag2 = 'N' OR g_flag2 IS NULL THEN
                              CALL cl_err(g_ogb[l_ac].ogb910,'asm-301',0)
                              RETURN "ogb092"
                           ELSE
                              IF g_sma.sma892[3,3] = 'Y' THEN
                                 IF g_bgjob='N' OR cl_null(g_bgjob) THEN
                                    IF NOT cl_confirm('aim-995') THEN
                                       RETURN "ogb092"
                                    END IF
                                 END IF
                              END IF
                              CALL s_add_imgg(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                                              g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                                              g_ogb[l_ac].ogb910,g_ogb[l_ac].ogb911,
                                              g_oga.oga01,g_ogb[l_ac].ogb03,0)
                                    RETURNING g_flag
                              IF g_flag = 1 THEN
                                 RETURN "ogb092"
                              END IF
                           END IF
                        END IF
                     END IF
                  END IF
                  IF g_ima906 = '2' THEN
                     SELECT imgg10 INTO g_imgg10_1 FROM imgg_file
                      WHERE imgg01=g_ogb[l_ac].ogb04
                        AND imgg02=g_ogb[l_ac].ogb09
                        AND imgg03=g_ogb[l_ac].ogb091
                        AND imgg04=g_ogb[l_ac].ogb092
                        AND imgg09=g_ogb[l_ac].ogb910
                  ELSE
                     SELECT img10 INTO g_imgg10_1 FROM img_file
                      WHERE img01=g_ogb[l_ac].ogb04
                        AND img02=g_ogb[l_ac].ogb09
                        AND img03=g_ogb[l_ac].ogb091
                        AND img04=g_ogb[l_ac].ogb092
                  END IF
                  IF cl_null(g_imgg10_1) THEN LET g_imgg10_1=0 END IF
               END IF
            END IF
            #FUN-C80107 add end----------------------------------------------
         END IF
         CALL t600_set_origin_field()
      END IF
      IF cl_null(g_ogb[l_ac].ogb916) THEN
         LET g_ogb[l_ac].ogb916 = g_ogb[l_ac].ogb05
         LET g_ogb[l_ac].ogb917 = g_ogb[l_ac].ogb12
      END IF
   END IF    #No.FUN-610064

   #start FUN-640031 add 儲位、批號若沒有輸入,則給於' '
   IF cl_null(g_ogb[l_ac].ogb091) THEN
      LET g_ogb[l_ac].ogb091 = ' '
   END IF
   IF cl_null(g_ogb[l_ac].ogb092) THEN
      LET g_ogb[l_ac].ogb092 = ' '
   END IF

   IF g_argv0 = '8' AND g_aza.aza26 != '2'  THEN   #FUN-C50097 add !=2 
      SELECT ogb12 INTO g_ogb12_sum FROM ogb_file
       WHERE ogb01 = g_oga.oga011
         AND ogb03 = g_ogb[l_ac].ogb03
      IF g_ogb[l_ac].ogb12 <> g_ogb12_sum THEN
         IF cl_null(g_ogb[l_ac].ogb65) THEN
            CALL cl_err(g_ogb[l_ac].ogb04,'axm-416',0)
            RETURN "ogb65"
         END IF
      END IF
   END IF

##FUN-C50097 add beg-----
   IF g_argv0 = '8' AND g_aza.aza26 = '2' THEN 
      IF  g_oaz.oaz94 = 'Y' THEN      
      ELSE 
         SELECT ogb12 INTO g_ogb12_sum FROM ogb_file
          WHERE ogb01 = g_oga.oga011
            AND ogb03 = g_ogb[l_ac].ogb03
         IF g_ogb[l_ac].ogb12 <> g_ogb12_sum THEN
            IF cl_null(g_ogb[l_ac].ogb65) THEN
               CALL cl_err(g_ogb[l_ac].ogb04,'axm-416',0)
               RETURN "ogb65"
            END IF
         END IF
      END IF    
   END IF
##FUN-C50097 add end-----
   CALL t600_b1_move_back()

   CALL t600_b_else()
   IF cl_null(b_ogb.ogb05_fac) THEN
      LET b_ogb.ogb05_fac = 1
   END IF
   IF cl_null(b_ogb.ogb12) THEN
      LET b_ogb.ogb12 = 0
   END IF
#FUN-AB0061 -----------add start----------------                             
   IF cl_null(b_ogb.ogb37) THEN
      LET b_ogb.ogb37 = 0
   END IF                                             
#FUN-AB0061 -----------add end----------------     
   IF cl_null(b_ogb.ogb13) THEN
      LET b_ogb.ogb13 = 0
   END IF
   IF cl_null(b_ogb.ogb14) THEN
      LET b_ogb.ogb14 = 0
   END IF
   IF cl_null(b_ogb.ogb14t) THEN
      LET b_ogb.ogb14t = 0
   END IF
   IF cl_null(b_ogb.ogb15_fac) THEN
      LET b_ogb.ogb15_fac = 1
   END IF
   IF cl_null(b_ogb.ogb16) THEN
      LET b_ogb.ogb16 = 0
   END IF
   IF cl_null(b_ogb.ogb18) THEN
      LET b_ogb.ogb18 = 0
   END IF
   IF cl_null(b_ogb.ogb60) THEN
      LET b_ogb.ogb60 = 0
   END IF
   IF cl_null(b_ogb.ogb63) THEN
      LET b_ogb.ogb63 = 0
   END IF
   IF cl_null(b_ogb.ogb64) THEN
      LET b_ogb.ogb64 = 0
   END IF

   IF cl_null(b_ogb.ogb1014) THEN
      LET b_ogb.ogb1014 = 'N'
   END IF
   RETURN NULL
END FUNCTION

FUNCTION t600_b1_ins()
   DEFINE l_tqn RECORD LIKE tqn_file.*
   DEFINE l_sql        LIKE type_file.chr1000
   IF g_aza.aza50='Y' THEN
      IF g_value IS NOT NULL THEN      #No.FUN-670008
         LET g_cnt=0
         SELECT COUNT(*) INTO g_cnt
           FROM tqm_file,tqn_file
          WHERE tqn01 = tqm01
            AND tqm01 = g_ogb[l_ac].ogb1002
            AND tqn03 = g_value
         IF g_cnt = 0 THEN
            INITIALIZE  l_tqn.* TO NULL
            SELECT tqn_file.* INTO l_tqn.*
              FROM tqm_file,tqn_file
             WHERE tqn01 = tqm01
               AND tqm01 = g_ogb[l_ac].ogb1002
               AND tqn03 = g_ogb04
            SELECT MAX(tqn02) INTO l_tqn.tqn02
              FROM tqm_file,tqn_file
             WHERE tqn01 = tqm01
               AND tqm01 = g_ogb[l_ac].ogb1002
            LET l_tqn.tqn02 = l_tqn.tqn02+1
            LET l_tqn.tqn03 = g_value
            INSERT INTO tqn_file VALUES(l_tqn.*)
            IF SQLCA.sqlcode THEN
               CALL cl_err3("ins","tqn_file",l_tqn.tqn01,"",SQLCA.sqlcode,"","ins tqn",1)
               RETURN FALSE
            END IF
         END IF
      END IF
   END IF
#FUN-A60035 ---MARK BEGIN
##FUN-A50054 --Begin
##IF NOT s_industry("slk") THEN  #No.MOD-A60112
##IF s_industry("slk") THEN  #No.MOD-A60112
#&ifdef SLK
#  LET l_sql = " SELECT ata03,ata04,ata08 FROM ata_file ",
#              "  WHERE ata00 = '",g_prog,"'",
#              "    AND ata01 = '",g_oga.oga01,"'",
#              "    AND ata02 = '",g_ogb[l_ac].ogb03,"'"
#  DECLARE t400_ata_curs SCROLL CURSOR FROM l_sql
#  FOREACH t400_ata_curs INTO b_ogb.ogb03,b_ogb.ogb04,b_ogb.ogb12
#     LET b_ogb.ogb14 = g_ogb[l_ac].ogb14 * b_ogb.ogb12 / g_ogb[l_ac].ogb12
#     LET b_ogb.ogb14t= g_ogb[l_ac].ogb14t* b_ogb.ogb12 / g_ogb[l_ac].ogb12
#     LET b_ogb.ogb917= g_ogb[l_ac].ogb917 * b_ogb.ogb12 / g_ogb[l_ac].ogb12
#     CALL cl_digcut(b_ogb.ogb14,t_azi04)  RETURNING b_ogb.ogb14
#     CALL cl_digcut(b_ogb.ogb14t,t_azi04) RETURNING b_ogb.ogb14t
#     LET b_ogb.ogbplant = g_plant 
#     LET b_ogb.ogblegal = g_legal  

#     INSERT INTO ogb_file VALUES(b_ogb.*)
#     IF SQLCA.sqlcode THEN
#        CALL cl_err3("ins","ogb_file",b_ogb.ogb01,"",SQLCA.sqlcode,"","ins ogb",1)  #No.FUN-670008
#        RETURN FALSE
#     ELSE
#        LET b_ogbi.ogbi01 = b_ogb.ogb01
#        LET b_ogbi.ogbi03 = b_ogb.ogb03
#        #IF NOT s_ins_ogbi(b_ogbi.*,'') THEN
#        IF NOT s_ins_ogbi(b_ogbi.*,b_ogb.ogbplant) THEN   #FUN-A60035
#           RETURN FALSE
#        END IF
#     END IF
#   END FOREACH
##ELSE
#&endif
##FUN-A50054 --End
#FUN-A60035 ---MARK END

      LET b_ogb.ogbplant = g_plant 
      LET b_ogb.ogblegal = g_legal 
     #IF cl_null(b_ogb.ogb50) THEN LET b_ogb.ogb50 = '1' END IF #FUN-AA0057 

      INSERT INTO ogb_file VALUES(b_ogb.*)
      IF SQLCA.sqlcode THEN
         CALL cl_err3("ins","ogb_file",b_ogb.ogb01,"",SQLCA.sqlcode,"","ins ogb",1)  #No.FUN-670008
         RETURN FALSE
      END IF
#FUN-A60035 ---MARK BEGIN
##FUN-A50054 --Begin
##END IF
##FUN-A50054 --End
#FUN-A60035 ---MARK END
   RETURN TRUE
END FUNCTION

FUNCTION t600_chk_ogb31(p_cmd)
   DEFINE p_cmd LIKE type_file.chr1
   DEFINE   li_i         LIKE type_file.num5    #No.FUN-680137 SMALLINT
   DEFINE   l_count      LIKE type_file.num5    #No.FUN-680137 SMALLINT
   DEFINE   l_temp       LIKE ima_file.ima01
   DEFINE   l_check_res  LIKE type_file.num5    #No.FUN-680137 SMALLINT
   DEFINE   l_other      LIKE type_file.num5    #No.FUN-6A0013 add
   DEFINE   l_tqn   RECORD  LIKE tqn_file.*
   DEFINE   l_oea161     LIKE oea_file.oea161   #No.FUN-6A0013 add
   DEFINE   l_oea163     LIKE oea_file.oea163   #No.FUN-6A0013
   DEFINE   li_result    LIKE type_file.num5                 #No.FUN-550052  #No.FUN-680137 SMALLINT
   DEFINE   l_err        LIKE type_file.chr1    #No:FUN-670007
   DEFINE   l_num        LIKE type_file.num5,    #No.FUN-680137 SMALLINT
            l_oea904     LIKE oea_file.oea904
   DEFINE   l_oep09      LIKE oep_file.oep09,   #CHI-710039
            l_oepconf    LIKE oep_file.oepconf  #CHI-710039
   DEFINE   l_oea99      LIKE oea_file.oea99
#TQC-A10153 --begin--
  DEFINE    l_oea03      LIKE oea_file.oea03,
            l_oea04      LIKE oea_file.oea04,
            l_oea21      LIKE oea_file.oea21,
            l_oea23      LIKE oea_file.oea23,
            l_oea25      LIKE oea_file.oea25,
            l_oeb70      LIKE oeb_file.oeb70,
            l_sum        LIKE type_file.num20_6,
            l_oeaconf    LIKE oea_file.oeaconf,
            l_oea08      LIKE oea_file.oea08,
            l_oea00      LIKE oea_file.oea00,
            l_errno      LIKE type_file.chr1000            
##TQC-A10153 --end--

   IF g_ogb[l_ac].ogb31[1,4] ='MISC' THEN
      LET g_ogb[l_ac].ogb04[1,4]='MISC'
   END IF
   SELECT * INTO g_oea.* FROM oea_file WHERE oea01=g_ogb[l_ac].ogb31 #MOD-810258 add
   IF NOT cl_null(g_ogb[l_ac].ogb31) THEN
      #判斷單身的資料中，有任一筆訂金比率或尾款比率>0的就不能合併出貨
     #IF (g_argv0 = '1' OR g_argv0 = '2')  THEN   #出通單/出貨單                                                                               #CHI-A20017 mark 
      IF (g_argv0 = '1' OR g_argv0 = '2' OR g_argv0 = '4' OR g_argv0 = '5' OR g_argv0 = '6')  THEN   #出通單/出貨單/多角銷售/多角出通/多角代採 #CHI-A20017 
        LET l_other = 0  #用來判斷單身是否有和本筆單身資料不同訂單的資料
        FOR li_i = 1 TO g_rec_b1
          LET l_oea161=0
          LET l_oea163 = 0
          IF g_ogb[li_i].ogb31<> g_ogb[l_ac].ogb31 THEN
            SELECT oea161,oea163 INTO l_oea161,l_oea163 FROM oea_file
             WHERE oea01 = g_ogb[li_i].ogb31
            IF l_oea161 > 0 OR l_oea163 > 0 THEN
               CALL cl_err(g_ogb[li_i].ogb31,'axm-075',0)
               LET g_ogb[l_ac].ogb31 = g_ogb_t.ogb31
               RETURN FALSE
            END IF
            LET l_other = 1
          END IF
        END FOR
        IF l_other THEN
          LET l_oea161=0
          LET l_oea163=0
          SELECT oea161,oea163 INTO l_oea161,l_oea163 FROM oea_file
           WHERE oea01 = g_ogb[l_ac].ogb31
          IF l_oea161 > 0 OR l_oea163 > 0 THEN
             CALL cl_err(g_ogb[l_ac].ogb31,'axm-076',0)
             LET g_ogb[l_ac].ogb31 = g_ogb_t.ogb31
             RETURN FALSE
          END IF
        END IF

         LET l_oepconf = 'Y'
         LET l_oep09 = '2'
         SELECT oep09,oepconf INTO l_oep09,l_oepconf
           FROM oep_file
          WHERE oep01 = g_ogb[l_ac].ogb31
         IF l_oepconf = 'N' THEN
           CALL cl_err('','axm-118',1)
           RETURN FALSE
         END IF
         IF l_oepconf = 'Y' AND l_oep09 <> '2' THEN
           CALL cl_err('','axm-119',1)
           RETURN FALSE
         END IF
      END IF
   IF g_sma.sma120 = 'Y' AND g_sma.sma907 = 'Y' THEN
      LET g_t1 = g_ogb[l_ac].ogb31[1,g_doc_len]
      SELECT oay22 INTO l_oay22_oea FROM oay_file WHERE oayslip =g_t1
      LET g_t1 = g_oga.oga01[1,g_doc_len]
      SELECT oay22 INTO l_oay22_oga FROM oay_file WHERE oayslip =g_t1
      IF l_oay22_oga != l_oay22_oea THEN
         CALL cl_err('','atm-521',0)
         RETURN FALSE
      END IF
   END IF
   IF g_ogb[l_ac].ogb31[1,4] !='MISC' THEN
      #若採訂單匯率立帳則幣別匯率相同才可併單
      IF NOT t600sub_oea18_chk(g_ogb_t.ogb03,g_oga.*,g_ogb[l_ac].ogb31,TRUE) THEN
         RETURN FALSE
      ELSE
         SELECT oga24 INTO g_oga.oga24 FROM oga_file WHERE oga01=g_oga.oga01 #FUN-730012 add oga24的值可能被異動,必須重抓
      END IF
      IF NOT cl_null(g_oga.oga16)
             AND g_ogb[l_ac].ogb31!=g_oga.oga16 THEN
         CALL cl_err('','axm-140',0)
         RETURN FALSE
      ELSE
         IF NOT cl_null(g_ogb[l_ac].ogb31) AND
            g_ogb[l_ac].ogb31[1,4] !='MISC' THEN
           #FUN-AC0097 Begin---
           #CALL t600_ogb31(g_ogb[l_ac].ogb31,g_ogb_t.ogb31) RETURNING li_result     #check 單別
           #IF (NOT li_result) THEN
           #     RETURN FALSE
           #END IF
           #FUN-AC0097 End-----
            SELECT oea161,oea162,oea163 INTO g_oga.oga161,g_oga.oga162,g_oga.oga163
              FROM oea_file
             WHERE oea01 = g_ogb[l_ac].ogb31 
            IF cl_null(g_oga.oga161) THEN LET g_oga.oga161 = 0 END IF
            IF cl_null(g_oga.oga162) THEN LET g_oga.oga162 =100 END IF
            IF cl_null(g_oga.oga163) THEN LET g_oga.oga163 = 0 END IF
            UPDATE oga_file SET oga161 = g_oga.oga161,
                                oga162 = g_oga.oga162,
                                oga163 = g_oga.oga163
             WHERE oga01 = g_oga.oga01
            IF STATUS OR SQLCA.SQLCODE THEN
               CALL cl_err('upd oga',SQLCA.sqlcode,0) RETURN FALSE
            END IF
         END IF
      END IF
      IF g_oea.oeaconf != 'Y' THEN      #未確認 01/08/16 mandy
         CALL cl_err('sel oea','axm-184',0) RETURN FALSE
      END IF

      IF NOT cl_null(g_oea.oeahold) THEN
         CALL cl_err('oeahold','axm-151',0) RETURN FALSE
      END IF
          IF g_oea.oea08 != g_oga.oga08 THEN    #國內外不符
             CALL cl_err('sel oea','axm-125',0) RETURN FALSE
          END IF

          IF g_oea.oea03 != g_oga.oga03 THEN    #客戶不符  #No.FUN-610064#No.FUN-610064
             CALL cl_err('sel oea','axm-138',0) RETURN FALSE
          END IF

          IF g_oea.oea21 != g_oga.oga21 THEN    #稅別不符
             CALL cl_err('sel oea','axm-142',0) RETURN FALSE
          END IF

          IF g_oea.oea23 != g_oga.oga23 THEN    #幣別不符
             CALL cl_err('sel oea','axm-144',0) RETURN FALSE
          END IF

          IF g_oea.oea32 != g_oga.oga32 THEN    #收款條件不符
             CALL cl_err('sel oea','axm-143',0) RETURN FALSE
          END IF

      #判斷是否為三角貿易訂單 No.7992
      IF cl_null(g_oga.oga909) OR g_oga.oga909 = 'N' THEN
         IF g_oea.oea901 = 'Y' THEN
            CALL cl_err('','tri-015',1) RETURN FALSE
         END IF
      END IF
      IF g_oga.oga909 = 'Y' THEN
         #是否為三角貿易訂單
         IF cl_null(g_oea.oea901) OR g_oea.oea901='N' THEN
            CALL cl_err('','tri-014',1) RETURN FALSE
         END IF
         #是否三角貿易已拋轉各廠
         IF g_oea.oea905 = 'N'  OR g_oea.oea905 IS NULL THEN
            CALL cl_err('oea906','axm-307',0) RETURN FALSE
         END IF
         #檢查流程代碼
         CALL t600sub_chkpoz(g_oga.*,g_ogb[1].ogb31) RETURNING li_result,g_poz.*,l_oea99,g_flow #FUN-730012
         IF NOT li_result THEN RETURN FALSE END IF #FUN-730012

         IF g_argv0 MATCHES '[456]' THEN #多角出貨    #No:MOD-5B0325
            IF g_poz.poz011 = '1' THEN  #正拋方式
               #檢查是否為起始訂單
               IF g_oea.oea906 = 'N' OR cl_null(g_oea.oea906) THEN
                  CALL cl_err('oea906','axm-409',0)
                  RETURN FALSE
               END IF
            END IF
            IF g_poz.poz011 = '2' THEN  #反拋方式
               CALL t600_last() RETURNING l_err
               IF l_err ="1" THEN
                  RETURN FALSE
               END IF
            END IF
            #判斷銷售段 OR 代採段之訂單
            IF g_argv0 = '4' THEN       #銷售段
               IF g_oea.oea11 ='6' THEN
                  CALL cl_err('','axm-022',1) RETURN FALSE
               END IF
               IF g_poz.poz00 ='2' THEN
                  CALL cl_err(g_flow,'tri-008',1) RETURN FALSE
               END IF
            END IF
            IF g_argv0 = '6' THEN       #代採段
               IF g_oea.oea11 <> '6' THEN
                  CALL cl_err('','axm-023',1) RETURN FALSE
               END IF
               IF g_poz.poz011 <> '2' THEN
                  CALL cl_err('','axm-027',0)
                  RETURN FALSE
               END IF
               IF g_poz.poz00 ='1' THEN
                  CALL cl_err(g_flow,'tri-008',1) RETURN FALSE
               END IF
            END IF
         END IF
         #判斷流程代碼是否相同
         LET l_num =0
         DECLARE t600_chk1 CURSOR FOR
             SELECT oea904 FROM ogb_file,oea_file
               WHERE ogb31 = oea01
                 AND ogb01 = g_oga.oga01
         FOREACH t600_chk1 INTO l_oea904
            IF SQLCA.SQLCODE <> 0 THEN EXIT FOREACH END IF
            LET l_num = l_num+1
            IF NOT cl_null(l_oea904) THEN
               EXIT FOREACH
            END IF
         END FOREACH
         IF l_oea904 <> g_oea.oea904 AND l_num > 0 THEN
            CALL cl_err(g_oea.oea901,'axm-501',0)
            RETURN FALSE
         END IF
      END IF
#No.MOD-A60112  --Begin
##TQC-A10153 --begin--
#IF g_ogb[l_ac].ogb1005 ='1' AND cl_null(g_oga.oga16) THEN 
#   SELECT oea03,oea04,oea21,oea23,oea25,oeb70,oeb12-oeb24+oeb25,
#          oeaconf,oea08,oea00 
#     INTO l_oea03,l_oea04,l_oea21,l_oea23,l_oea25,l_oeb70,l_sum,
#          l_oeaconf,l_oea08,l_oea00
#     FROM oea_file,oeb_file
#    WHERE oea01 = oeb01
#      AND oea01 = g_ogb[l_ac].ogb31
#    # AND oeb03 = g_ogb[l_ac].ogb31   #TQC-A50152   
#      AND oeb03 = g_ogb[l_ac].ogb32   #TQC-A50152     
#    
#    CASE 
#      WHEN l_oea03 != g_oga.oga03   
#           LET l_errno = 'axm-440'
#           LET l_oea03 = NULL
#      WHEN l_oea04 != g_oga.oga04
#           LET l_errno = 'axm-441'
#           LET l_oea04 = NULL
#      WHEN l_oea23 != g_oga.oga23   
#           LET l_errno = 'axm-442'
#           LET l_oea23 = NULL
#      WHEN l_oea25 != g_oga.oga25   
#           LET l_errno = 'axm-443'
#           LET l_oea25 = NULL
#      WHEN l_oeb70 = 'Y' OR l_oeb70 IS NULL    
#           LET l_errno = 'axm-444'
#           LET l_oeb70 = NULL
#      WHEN l_oeaconf = 'N' OR l_oeaconf IS NULL    
#           LET l_errno = 'axm-445'
#           LET l_oeaconf = NULL 
#      WHEN l_oea08 != g_oga.oga08   
#           LET l_errno = 'axm-446'
#           LET l_oea08 = NULL 
#      WHEN l_oea00 != '0'   
#           LET l_errno = 'axm-447'
#           LET l_oea00 = NULL                                                                              
#      WHEN l_sum <= 0 
#           LET l_errno = 'axm-448'
#           LET l_sum = 0      
#    END CASE 
#    IF NOT cl_null(l_errno) THEN RETURN FALSE END IF          
#END IF
##TQC-A10153 -end--
#No.MOD-A60112  --End
      END IF
      CALL t600_ogb32(g_ogb[l_ac].ogb31,g_ogb[l_ac].ogb32)
   #LET g_chr1 = 'N'  #No.FUN-640074   #CHI-880006

   END IF
   CALL t600_set_no_entry_b1(p_cmd)
   CALL t600_set_required_b1(p_cmd)

   IF cl_null(g_ogb[l_ac].ogb31) AND cl_null(g_ogb[l_ac].ogb32) THEN
      CALL t600_set_no_required_b1(p_cmd)
      LET g_cnt = g_ogb[l_ac].ogb03
      IF g_oaz.oaz65 = '1' THEN  #No.FUN-A10016
      LET g_ogb[l_ac].ogb03=g_cnt
      LET g_ogb[l_ac].ogb12=0
      LET g_ogb[l_ac].ogb1005 =1
      LET g_ogb[l_ac].ogb1006 =100
      LET g_ogb[l_ac].ogb1012 ='N'
      END IF                     #No.FUN-A10016
   END IF
   RETURN TRUE
END FUNCTION



#No.MOD-A60112  --Begin
FUNCTION t600_chk_oea()
#TQC-A10153 --begin--
  DEFINE    l_oea03      LIKE oea_file.oea03,
            l_oea04      LIKE oea_file.oea04,
            l_oea21      LIKE oea_file.oea21,
            l_oea23      LIKE oea_file.oea23,
            l_oea25      LIKE oea_file.oea25,
            l_oeb70      LIKE oeb_file.oeb70,
            l_sum        LIKE type_file.num20_6,
            l_oeaconf    LIKE oea_file.oeaconf,
            l_oea08      LIKE oea_file.oea08,
            l_oea00      LIKE oea_file.oea00,
            l_errno      LIKE type_file.chr1000            
##TQC-A10153 --end--
#FUN-A60035 ---MARK BEGIN
#   #FUN-A60035 ----add begin
#   &ifdef SLK
#   DEFINE   l_ogb32_old  LIKE ogb_file.ogb32
#   &endif
#   #FUN-A60035 ---add end
#FUN-A60035 ---MARK END

IF cl_null(g_ogb[l_ac].ogb31) OR cl_null(g_ogb[l_ac].ogb32) THEN
   RETURN TRUE
END IF

#TQC-A10153 --begin--
IF g_ogb[l_ac].ogb1005 ='1' AND cl_null(g_oga.oga16) THEN
#FUN-A60035 ---MARK BEGIN
#  #FUN-A60035 ---add begin
#  &ifdef SLK
#  LET l_ogb32_old = g_ogb[l_ac].ogb32
#  DECLARE t600_chk_oea_cs CURSOR FOR
#    SELECT ata03 FROM ata_file
#     WHERE ata00 = g_prog
#       AND ata01 = g_oga.oga01
#       AND ata02 = g_ogb[l_ac].ogb32
#  FOREACH t600_chk_oea_cs INTO g_ogb[l_ac].ogb32
#  &endif
#  #FUN-A60035 ---add end
#FUN-A60035 ---MARK END
#TQC-A10153 --begin-- 
   SELECT oea03,oea04,oea21,oea23,oea25,oeb70,oeb12-oeb24+oeb25,
          oeaconf,oea08,oea00 
     INTO l_oea03,l_oea04,l_oea21,l_oea23,l_oea25,l_oeb70,l_sum,
          l_oeaconf,l_oea08,l_oea00
     FROM oea_file,oeb_file
    WHERE oea01 = oeb01
      AND oea01 = g_ogb[l_ac].ogb31
    # AND oeb03 = g_ogb[l_ac].ogb31   #TQC-A50152   
      AND oeb03 = g_ogb[l_ac].ogb32   #TQC-A50152     
    
    CASE 
      WHEN l_oea03 != g_oga.oga03   
           LET l_errno = 'axm-440'
           LET l_oea03 = NULL
      WHEN l_oea04 != g_oga.oga04
           LET l_errno = 'axm-441'
           LET l_oea04 = NULL
      WHEN l_oea23 != g_oga.oga23   
           LET l_errno = 'axm-442'
           LET l_oea23 = NULL
      WHEN l_oea25 != g_oga.oga25   
           LET l_errno = 'axm-443'
           LET l_oea25 = NULL
      WHEN l_oeb70 = 'Y' OR l_oeb70 IS NULL    
           LET l_errno = 'axm-444'
           LET l_oeb70 = NULL
      WHEN l_oeaconf = 'N' OR l_oeaconf IS NULL    
           LET l_errno = 'axm-445'
           LET l_oeaconf = NULL 
      WHEN l_oea08 != g_oga.oga08   
           LET l_errno = 'axm-446'
           LET l_oea08 = NULL 
      #No.MOD-A60112  --Begin
#     WHEN l_oea00 != '0'   
#          LET l_errno = 'axm-447'
#          LET l_oea00 = NULL                                                                              
      #No.MOD-A60112  --End  
      WHEN l_sum <= 0 
           LET l_errno = 'axm-448'
           LET l_sum = 0      
    END CASE 
    IF NOT cl_null(l_errno) THEN 
       CALL cl_err(g_ogb[l_ac].ogb31,l_errno,1)
       RETURN FALSE 
    END IF
#FUN-A60035 ---MARK BEGIN
#   #FUN-A60035 ---add begin
#   &ifdef SLK
#   END FOREACH
#    LET g_ogb[l_ac].ogb32 = l_ogb32_old
#   &endif
#   #FUN-A60035 ---add end
#FUN-A60035 ---MARK END
#TQC-A10153 --begin-- 
END IF
RETURN TRUE  #No.MOD-A60134
#TQC-A10153 -end--
END FUNCTION
#No.MOD-A60112  --End

FUNCTION t600_chk_ogb32(p_cmd)
   DEFINE p_cmd LIKE type_file.chr1
   DEFINE
    l_ogb912a       LIKE ogb_file.ogb912,
    l_ogb912b       LIKE ogb_file.ogb912,
    l_ogb915a       LIKE ogb_file.ogb915,
    l_ogb915b       LIKE ogb_file.ogb915,
    l_ogb917a       LIKE ogb_file.ogb917,
    l_ogb917b       LIKE ogb_file.ogb917,
    l_ogb12a        LIKE ogb_file.ogb12,
    l_ogb12b        LIKE ogb_file.ogb12,
    l_ogb12c        LIKE ogb_file.ogb12,
    l_ogb912c       LIKE ogb_file.ogb912,
    l_ogb915c       LIKE ogb_file.ogb915,
    l_ogb917c       LIKE ogb_file.ogb917,
    #-----MOD-A50076---------
    l_ogb12d        LIKE ogb_file.ogb12,
    l_ogb912d       LIKE ogb_file.ogb912,
    l_ogb915d       LIKE ogb_file.ogb915,
    l_ogb917d       LIKE ogb_file.ogb917
    #-----END MOD-A50076-----
   DEFINE l_oea09   LIKE oea_file.oea09   #MOD-860202
   IF NOT cl_null(g_ogb[l_ac].ogb32) THEN
      IF cl_null(g_ogb[l_ac].ogb31) THEN
         RETURN "ogb31"
      END IF
   ELSE
      RETURN NULL
   END IF
   SELECT oeb930 INTO g_ogb[l_ac].ogb930 FROM oeb_file
                                        WHERE oeb01=g_ogb[l_ac].ogb31
                                          AND oeb03=g_ogb[l_ac].ogb32
   IF SQLCA.sqlcode THEN
      LET g_ogb[l_ac].ogb930=NULL
   END IF
   LET g_ogb[l_ac].gem02c=s_costcenter_desc(g_ogb[l_ac].ogb930)
   DISPLAY BY NAME g_ogb[l_ac].ogb930,g_ogb[l_ac].gem02c
   IF g_ogb[l_ac].ogb31[1,4] !='MISC' THEN
      IF g_argv0 MATCHES '[246]' AND NOT cl_null(g_oga.oga011) THEN #No.FUN-630061
         SELECT COUNT(*) INTO g_cnt FROM oga_file,ogb_file
          WHERE oga01=g_oga.oga011
            AND oga01=ogb01 AND oga09 IN ('1','5')  #No.7992
            AND ogb31=g_ogb[l_ac].ogb31 AND ogb32=g_ogb[l_ac].ogb32
         IF g_cnt=0 THEN        #本訂單號不存在出貨通知單內
            CALL cl_err('sel ogb(1):','axm-224',0) RETURN "ogb32"
         END IF
      END IF
      SELECT * INTO g_oeb.* FROM oeb_file
       WHERE oeb01=g_ogb[l_ac].ogb31 AND oeb03=g_ogb[l_ac].ogb32
     #   AND oeb1003 = g_ogb[l_ac].ogb1005   #No.FUN-610064 #TQC-B10066
         AND oeb03 < 9001                                   #TQC-B10066
      IF STATUS THEN
         CALL cl_err3("sel","oeb_file",g_ogb[l_ac].ogb31,g_ogb[l_ac].ogb32,SQLCA.sqlcode,"","sel oeb",1)  #No.FUN-670008
         RETURN "ogb32"
      END IF
      IF g_oeb.oeb1003='2' THEN LET g_ogb[l_ac].ogb1005='2' END IF #TQC-B10066
      #-----MOD-A50076---------
      LET g_ogb[l_ac].ogb04 = g_oeb.oeb04  
      LET l_ogb12d = 0
      LET l_ogb912d = 0
      LET l_ogb915d = 0
      LET l_ogb917d = 0
      SELECT SUM(ogb12),SUM(ogb912),SUM(ogb915),SUM(ogb917)
        INTO l_ogb12d,l_ogb912d,l_ogb915d,l_ogb917d
        FROM ogb_file,oga_file
       WHERE ogb01 = oga01  
         AND ogb31 = g_ogb[l_ac].ogb31
         AND ogb32 = g_ogb[l_ac].ogb32
         AND oga09 = '9'
         AND ogaconf = 'Y'
         AND ogapost = 'Y'
      IF cl_null(l_ogb12d)  THEN LET l_ogb12d = 0 END IF
      IF cl_null(l_ogb912d) THEN LET l_ogb912d = 0 END IF
      IF cl_null(l_ogb915d) THEN LET l_ogb915d = 0 END IF
      IF cl_null(l_ogb917d) THEN LET l_ogb917d = 0 END IF
      #-----END MOD-A50076----- 

      IF g_argv0 MATCHES '[246]' AND g_oeb.oeb1003='1' THEN
         LET l_oea09=''
         SELECT oea09 INTO l_oea09 FROM oea_file 
           WHERE oea01=g_ogb[l_ac].ogb31
         IF ((g_oeb.oeb12*((100+l_oea09)/100))-
             g_oeb.oeb24+g_oeb.oeb25) <= 0 THEN 
            CALL cl_err('sel oeb','axm-148',0) RETURN "ogb32"
         END IF
      END IF
      IF g_oeb.oeb70 = 'Y' THEN
         CALL cl_err('sel oeb','axm-150',0) RETURN "ogb32"
      END IF

      CALL t600_ins_oao('b')   #MOD-B40263
      IF p_cmd='a' OR g_ogb[l_ac].ogb31!=g_ogb_t.ogb31
                   OR g_ogb[l_ac].ogb32!=g_ogb_t.ogb32 THEN
           #-----MOD-B40263---------
           #IF p_cmd='a' THEN
           #   DROP TABLE x
           #   SELECT * FROM oao_file
           #    WHERE oao01=g_ogb[l_ac].ogb31
           #      AND oao03=g_ogb[l_ac].ogb32
           #     INTO TEMP x
           #     UPDATE x SET oao01 = g_oga.oga01,
           #                  oao03 = g_ogb[l_ac].ogb03
           #   INSERT INTO oao_file SELECT * FROM x
           #END IF
           #-----END MOD-B40263-----
         IF g_argv0 MATCHES '[15]' THEN  #No.7992
            SELECT COUNT(*) INTO g_cnt FROM ogb_file
             WHERE ogb01=g_oga.oga01
               AND ogb31=g_ogb[l_ac].ogb31
               AND ogb32=g_ogb[l_ac].ogb32
               AND ogb04=g_ogb[l_ac].ogb04
            IF g_cnt > 0 THEN
               CALL cl_err('','axm-298',0) RETURN "ogb31"
            END IF
         END IF
         #LET g_ogb[l_ac].ogb04 = g_oeb.oeb04   #MOD-A50076
         LET g_ogb[l_ac].ogb05 = g_oeb.oeb05
         LET b_ogb.ogb05_fac   = g_oeb.oeb05_fac
         LET g_ogb[l_ac].ogb06 = g_oeb.oeb06
         LET b_ogb.ogb07       = g_oeb.oeb07
        #LET g_ogb[l_ac].ogb17 = 'N' #CHI-AC0034 mark 
         LET g_ogb[l_ac].ogb17 = b_ogb.ogb17 #CHI-AC0034
         LET g_ogb[l_ac].ogb19 = g_oeb.oeb906   #TQC-770040 add
         IF cl_null(g_oeb.oeb906) THEN LET g_ogb[l_ac].ogb19='N' END IF  #TQC-770040 add
         IF g_ogb[l_ac].ogb17 ="N" THEN
            IF cl_null(g_oeb.oeb09) AND cl_null(g_oeb.oeb091) THEN
               SELECT ima35,ima36 INTO g_oeb.oeb09,g_oeb.oeb091
                 FROM ima_file
                WHERE ima01 = g_oeb.oeb04
               IF g_azw.azw04='2' THEN
                  SELECT rtz07 INTO g_oeb.oeb09 FROM rtz_file
                   WHERE rtz01 = g_plant
               END IF
               LET g_oeb.oeb092 = " "
               DISPLAY BY NAME g_oeb.oeb09,g_oeb.oeb091,g_oeb.oeb092
            END IF
         END IF
         LET g_ogb[l_ac].ogb09 = g_oeb.oeb09
         LET g_ogb[l_ac].ogb091= g_oeb.oeb091
         LET g_ogb[l_ac].ogb092= g_oeb.oeb092
         LET b_ogb.ogb11       = g_oeb.oeb11
         LET g_ogb[l_ac].ogb12 = g_oeb.oeb12-g_oeb.oeb24+
                                 g_oeb.oeb25
         LET g_ogb[l_ac].ogb41   = g_oeb.oeb41
         LET g_ogb[l_ac].ogb42   = g_oeb.oeb42
         LET g_ogb[l_ac].ogb43   = g_oeb.oeb43
         LET g_ogb[l_ac].ogb1001 = g_oeb.oeb1001
         #need modify because the qty is not always correct,if once return,it will fail,need add field to correct
         LET g_ogb[l_ac].ogb913= g_oeb.oeb913
         LET g_ogb[l_ac].ogb914= g_oeb.oeb914
         LET g_ogb[l_ac].ogb915= g_oeb.oeb915
         LET g_ogb[l_ac].ogb910= g_oeb.oeb910
         LET g_ogb[l_ac].ogb911= g_oeb.oeb911
         LET g_ogb[l_ac].ogb912= g_oeb.oeb912
         LET g_ogb[l_ac].ogb916= g_oeb.oeb916
         LET g_ogb[l_ac].ogb917= g_oeb.oeb917
         IF g_argv0 MATCHES '[246]' AND   #No.FUN-630061  #No.7992
            NOT cl_null(g_oga.oga011) THEN  #No.MOD-490172
            # 對應到的出貨通知單上的數量
            LET l_ogb12a = 0
            SELECT SUM(ogb12),SUM(ogb912),SUM(ogb915),SUM(ogb917)
              INTO l_ogb12a,l_ogb912a,l_ogb915a,l_ogb917a
              FROM ogb_file,oga_file
             WHERE ogb01 = oga01 AND oga09 IN ('1','5') #No.7992
               AND oga01 = g_oga.oga011
               AND ogb31 = g_ogb[l_ac].ogb31
               AND ogb32 = g_ogb[l_ac].ogb32
               AND ogb04 = g_ogb[l_ac].ogb04 #BugNo:4541
               AND ogaconf !='X'  #CHI-6B0036
              # AND ogaconf = 'Y'    #No:MOD-490365 Mark
            IF cl_null(l_ogb12a)  THEN LET l_ogb12a = 0 END IF
            IF cl_null(l_ogb912a) THEN LET l_ogb912a= 0 END IF
            IF cl_null(l_ogb915a) THEN LET l_ogb915a= 0 END IF
            IF cl_null(l_ogb917a) THEN LET l_ogb917a= 0 END IF
            # 此出貨通知單已耗用在出貨單的量
            LET l_ogb12b = 0
            SELECT SUM(ogb12),SUM(ogb912),SUM(ogb915),SUM(ogb917)
              INTO l_ogb12b,l_ogb912b,l_ogb915b,l_ogb917b
              FROM ogb_file,oga_file
             WHERE ogb01 = oga01 AND oga09 IN ('2','4','6') #No.7992 #No.FUN-630061
               AND oga011 = g_oga.oga011
               AND ogb31 = g_ogb[l_ac].ogb31
               AND ogb32 = g_ogb[l_ac].ogb32
               AND ogb04 = g_ogb[l_ac].ogb04 #BugNo:4541
               AND ogaconf!='X'
            IF cl_null(l_ogb12b)  THEN LET l_ogb12b = 0 END IF
            IF cl_null(l_ogb912b) THEN LET l_ogb912b= 0 END IF
            IF cl_null(l_ogb915b) THEN LET l_ogb915b= 0 END IF
            IF cl_null(l_ogb917b) THEN LET l_ogb917b= 0 END IF
            LET l_ogb12c = 0
            SELECT SUM(ogb12),SUM(ogb912),SUM(ogb915),SUM(ogb917)
              INTO l_ogb12c,l_ogb912c,l_ogb915c,l_ogb917c
              FROM ogb_file,oga_file
             WHERE ogb01 = oga01 AND oga09 IN ('2','4','6')
               AND (oga011 IS NULL OR oga011= ' ')
               AND ogb31 = g_ogb[l_ac].ogb31
               AND ogb32 = g_ogb[l_ac].ogb32
               AND ogaconf !='X'

            IF cl_null(l_ogb12c)  THEN LET l_ogb12c = 0 END IF
            IF cl_null(l_ogb912c) THEN LET l_ogb912c= 0 END IF
            IF cl_null(l_ogb915c) THEN LET l_ogb915c= 0 END IF
            IF cl_null(l_ogb917c) THEN LET l_ogb917c= 0 END IF

            LET g_ogb[l_ac].ogb12 = l_ogb12a - l_ogb12b  - l_ogb12c
            LET g_ogb[l_ac].ogb912= l_ogb912a- l_ogb912b - l_ogb912c
            LET g_ogb[l_ac].ogb915= l_ogb915a- l_ogb915b - l_ogb915c
            LET g_ogb[l_ac].ogb917= l_ogb917a- l_ogb917b - l_ogb917c
         ELSE
         #檢查出貨通知單量必須<=訂單數量(ogb12)
            LET l_ogb12a = 0
            SELECT oeb12,oeb912,oeb915,oeb917
              INTO l_ogb12a,l_ogb912a,l_ogb915a,l_ogb917a
              FROM oeb_file ,oea_file
             WHERE oeb01 = g_ogb[l_ac].ogb31
               AND oeb03 = g_ogb[l_ac].ogb32
               AND oeaconf = 'Y' AND oea01 = oeb01
            IF cl_null(l_ogb12a)  THEN LET l_ogb12a = 0 END IF
            IF cl_null(l_ogb912a) THEN LET l_ogb912a= 0 END IF
            IF cl_null(l_ogb915a) THEN LET l_ogb915a= 0 END IF
            IF cl_null(l_ogb917a) THEN LET l_ogb917a= 0 END IF

            # 此訂單已耗用在出貨通知單的量
            LET l_ogb12b = 0
            SELECT SUM(ogb12),SUM(ogb912),SUM(ogb915),SUM(ogb917)
              INTO l_ogb12b,l_ogb912b,l_ogb915b,l_ogb917b
              FROM ogb_file,oga_file
             WHERE ogb01 = oga01 AND oga09 IN ('1','5')  #No.7992
               AND ogb31 = g_ogb[l_ac].ogb31
               AND ogb32 = g_ogb[l_ac].ogb32
               AND ogaconf !='X'
            IF cl_null(l_ogb12b)  THEN LET l_ogb12b = 0 END IF
            IF cl_null(l_ogb912b) THEN LET l_ogb912b= 0 END IF
            IF cl_null(l_ogb915b) THEN LET l_ogb915b= 0 END IF
            IF cl_null(l_ogb917b) THEN LET l_ogb917b= 0 END IF
            LET g_ogb[l_ac].ogb12 = l_ogb12a - l_ogb12b + l_ogb12d   #MOD-A50076 add l_ogb12d
            LET g_ogb[l_ac].ogb912= l_ogb912a- l_ogb912b + l_ogb912d #MOD-A50076 add l_ogb912d
            LET g_ogb[l_ac].ogb915= l_ogb915a- l_ogb915b + l_ogb915d #MOD-A50076 add l_ogb915d
            LET g_ogb[l_ac].ogb917= l_ogb917a- l_ogb917b + l_ogb917d #MOD-A50076 add l_ogb917d
         END IF
         LET b_ogb.ogb13       = g_oeb.oeb13
         LET b_ogb.ogb18       = g_ogb[l_ac].ogb12
         SELECT ima021 INTO g_ogb[l_ac].ima021 FROM ima_file
          WHERE ima01 = g_ogb[l_ac].ogb04
      END IF
   END IF
   IF NOT cl_null(g_ogb[l_ac].ogb04) THEN
      SELECT ima25,ima31,ima906,ima907,ima908
        INTO g_ima25,g_ima31,g_ima906,g_ima907,g_ima908
        FROM ima_file
       WHERE ima01=g_ogb[l_ac].ogb04
      CALL t600_du_data_to_correct()
   END IF
   IF g_ogb[l_ac].ogb32 != g_ogb_t.ogb32  OR g_ogb_t.ogb32 IS NULL THEN   #FUN-670007
      CALL t600_ogb32(g_ogb[l_ac].ogb31,g_ogb[l_ac].ogb32)
   END IF                    #FUN-670007

   IF g_chr2 = '2' THEN
      #LET g_chr1 = 'Y'   #CHI-880006
      SELECT oeb906 INTO g_ogb[l_ac].ogb19
        FROM oeb_file
       WHERE oeb01 = g_ogb[l_ac].ogb31
         AND oeb03 = g_ogb[l_ac].ogb32
      DISPLAY BY NAME g_ogb[l_ac].ogb19
   END IF

   IF cl_null(g_ogb[l_ac].ogb31) AND cl_null(g_ogb[l_ac].ogb32) THEN
      CALL t600_set_no_required_b1(p_cmd)
      LET g_cnt = g_ogb[l_ac].ogb03
      IF g_oaz.oaz65 = '1' THEN  #No.FUN-A10016
      LET g_ogb[l_ac].ogb03=g_cnt
      LET g_ogb[l_ac].ogb12=0
      LET g_ogb[l_ac].ogb1005 =1
      LET g_ogb[l_ac].ogb1006 =100
      LET g_ogb[l_ac].ogb1012 ='N'
      END IF                     #No.FUN-A10016
   END IF
   #多角合併出貨時,單頭未輸入訂單及出通/貨單
   #且單身為第一筆新增時, 匯率重取
   IF cl_null(g_oga.oga16) AND cl_null(g_oga.oga011)  THEN
      LET g_cnt = 0
      SELECT COUNT(*) INTO g_cnt FROM ogb_file,oga_file 
       WHERE ogb01 = g_oga.oga01
         AND oga01 = ogb01
         AND oga00 = g_oga.oga00
         AND oga09 = g_oga.oga09
     IF g_cnt = 0 THEN
        LET g_oga_o.oga24 = g_oga.oga24
        IF g_oga.oga08='1' THEN                                                                                       
            LET exT=g_oaz.oaz52                                                                                       
        ELSE                                                                                                          
            LET exT=g_oaz.oaz70                                                                                       
        END IF                                                                                                        
        IF g_oga.oga909 = 'Y' THEN                                                                                    
           CALL t600_chk_poz00() RETURNING exT   #MOD-860069 
        END IF                                                                                                        
        IF NOT cl_null(g_oga.oga021) THEN
           LET g_exdate = g_oga.oga021    #結關日期
        ELSE
           LET g_exdate = g_oga.oga02     #出貨日期
        END IF 
        CALL s_curr3(g_oga.oga23,g_exdate,exT) RETURNING g_oga.oga24
        IF g_oga_o.oga24 <> g_oga.oga24 THEN
           IF NOT cl_confirm('axm-949') THEN
              LET g_oga.oga24 = g_oga_o.oga24 
           ELSE 
              UPDATE oga_file SET oga24 = g_oga.oga24 WHERE oga01=g_oga.oga01 
              IF STATUS OR SQLCA.SQLCODE THEN
                 CALL cl_err3("upd","oga_file","g_oga.oga01","",SQLCA.sqlcode,"","",1) 
                 RETURN "ogb31"
              END IF
           END IF
        END IF 
         DISPLAY BY NAME g_oga.oga24                                                                                   
     END IF
   END IF 
   #MOD-870246-end-add
   RETURN NULL
END FUNCTION

FUNCTION t600_chk_ogb65(p_cmd)                                                                                                          
   DEFINE p_cmd   LIKE type_file.chr1     #CHAR(1)                                                                                  
   DEFINE l_azfacti LIKE azf_file.azfacti                                                                                           
   DEFINE l_azf02   LIKE azf_file.azf02                                                                                             
   DEFINE l_azf09   LIKE azf_file.azf09
    SELECT azfacti,azf02,azf09 INTO l_azfacti,l_azf02,l_azf09 FROM azf_file                                                         
     WHERE azf01 = g_ogb[l_ac].ogb65  AND azf02 = '2'                                                                                      
                                                                                                                                    
   LET g_errno = ' '                                                                                                                
   CASE WHEN SQLCA.SQLCODE = 100 LET g_errno = '100'                                                                                
        WHEN l_azfacti = 'N'     LET g_errno = '9028'                                                                               
        WHEN SQLCA.SQLCODE != 0  LET g_errno = SQLCA.SQLCODE USING '-----'                                                          
        WHEN l_azf09 !='5'       LET g_errno ='aoo-404'                                                                             
   END CASE 
                                                                                                                           
END FUNCTION  

FUNCTION t600_chk_ogb1001(p_cmd)
   DEFINE p_cmd LIKE type_file.chr1
   DEFINE l_azf10 LIKE azf_file.azf10
   DEFINE l_oeb1012_a LIKE oeb_file.oeb1012   #No.TQC-7C0055
   DEFINE l_oeb1012_b LIKE oeb_file.oeb1012   #No.TQC-7C0055
   DEFINE l_azf09     LIKE azf_file.azf09     #No.FUN-930104
   DEFINE l_azf10_a  LIKE azf_file.azf10,   
          l_azf08_a  LIKE azf_file.azf08,   
          l_azf08    LIKE azf_file.azf08,   
          l_oeb1001  LIKE oeb_file.oeb1001   

           IF NOT cl_null(g_ogb[l_ac].ogb1001) THEN
                 LET g_cnt=0
                 IF g_aza.aza50 = 'Y' THEN   #MOD-8A0100
                    SELECT COUNT(*) INTO g_cnt FROM azf_file
                     WHERE azf01 = g_ogb[l_ac].ogb1001
                       AND azf02 = '2'       #No.TQC-760054
                       AND azfacti ='Y'
                       AND azf09 ='1'
                 ELSE
                    SELECT COUNT(*) INTO g_cnt FROM azf_file
                     WHERE azf01 = g_ogb[l_ac].ogb1001
                       AND azf02 = '2'     
                       AND azfacti ='Y'
                       AND azf09 ='1'   #No.FUN-930104
                 END IF
               SELECT azf09 INTO l_azf09 FROM azf_file
                WHERE azf01 = g_ogb[l_ac].ogb1001
                  AND azf02 = '2'  
                  AND azfacti ='Y'
                  IF l_azf09 != '1' THEN 
                    CALL cl_err('','aoo-400',1)
                    RETURN FALSE
                  END IF   
              IF g_cnt = 0 THEN
                 CALL cl_err(g_ogb[l_ac].ogb1001,'atm-379',1)
                 RETURN FALSE
              END IF



           END IF

           IF NOT cl_null(g_ogb[l_ac].ogb31) AND NOT cl_null(g_ogb[l_ac].ogb32) THEN
              SELECT oeb1012,oeb1001 INTO l_oeb1012_a,l_oeb1001  #MOD-930121 add oeb1001
                FROM oeb_file
               WHERE oeb01=g_ogb[l_ac].ogb31
                 AND oeb03=g_ogb[l_ac].ogb32

              IF g_aza.aza50 = 'Y' THEN   #MOD-8A0100
                 SELECT azf10 INTO l_oeb1012_b FROM azf_file
                  WHERE azf01 = g_ogb[l_ac].ogb1001
                    AND azf02 = '2'
                    AND azfacti ='Y'
                    AND azf09 ='1'
              ELSE
                 SELECT azf10 INTO l_oeb1012_b FROM azf_file
                  WHERE azf01 = g_ogb[l_ac].ogb1001
                    AND azf02 = '2' 
                    AND azfacti ='Y'
              END IF
              IF l_oeb1012_b != l_oeb1012_a THEN
                 CALL cl_err('','axm4021',0)
                 RETURN FALSE
              END IF

             #須判斷出貨單理由碼(ogb1001)與訂單理由碼(ogb1001)的是否搭贈(azf10)
             #當使用流通配銷時 aza50 ='Y',出入單理由碼與訂單理由碼的"是否搭贈(azf10)"必須一致
             #不使用流通配銷時 aza50 ='N',出入單理由碼與訂單理由碼的"是否列入銷售費用"，必須一致
              SELECT azf08,azf10 INTO l_azf08,l_azf10 FROM azf_file
               WHERE azf01 = g_ogb[l_ac].ogb1001
                 AND azf02 = '2' 
                 AND azfacti ='Y'
              IF NOT cl_null(l_oeb1001) THEN
                SELECT azf08,azf10 INTO l_azf08_a,l_azf10_a FROM azf_file
                 WHERE azf01 = l_oeb1001
                   AND azf02 = '2' 
                   AND azfacti ='Y'
                IF cl_null(l_azf10) THEN LET l_azf10 = 'N' END IF
                IF cl_null(l_azf08) THEN LET l_azf08 = 'N' END IF
                IF cl_null(l_azf10_a) THEN LET l_azf10_a = 'N' END IF
                IF cl_null(l_azf08_a) THEN LET l_azf08_a = 'N' END IF
                IF g_aza.aza50 = 'Y' THEN  
                   IF l_azf10_a <>  l_azf10  THEN
                      CALl cl_err(g_ogb[l_ac].ogb1001,'axm-381',1)
                      RETURN FALSE
                   END IF 
                ELSE
                   IF l_azf08_a <> l_azf08  THEN
                      CALl cl_err(g_ogb[l_ac].ogb1001,'axm-382',1)
                      RETURN FALSE
                   END IF 
                END IF
              END IF


              IF p_cmd ='a' OR (p_cmd ='u' AND (g_ogb[l_ac].ogb1001 !=g_ogb_t.ogb1001
                 OR g_ogb_t.ogb1001 IS NULL)) THEN
                    IF g_aza.aza50 = 'Y' THEN   #MOD-8A0100
                       SELECT azf10 INTO g_ogb[l_ac].ogb1012 FROM azf_file
                        WHERE azf01 = g_ogb[l_ac].ogb1001
                          AND azf02 = '2'
                          AND azfacti= 'Y'
                          AND azf09 = '1'
                    ELSE
                       SELECT azf10 INTO g_ogb[l_ac].ogb1012 FROM azf_file
                        WHERE azf01 = g_ogb[l_ac].ogb1001
                          AND azf02 = '2'    
                          AND azfacti= 'Y'  
                    END IF
              END IF
           END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_bef_att00()
   #根據子料件找到母料件及各個屬性
   SELECT imx00,imx01,imx02,imx03,imx04,imx05,
          imx06,imx07,imx08,imx09,imx10
   INTO g_ogb[l_ac].att00, g_ogb[l_ac].att01, g_ogb[l_ac].att02,
        g_ogb[l_ac].att03, g_ogb[l_ac].att04, g_ogb[l_ac].att05,
        g_ogb[l_ac].att06, g_ogb[l_ac].att07, g_ogb[l_ac].att08,
        g_ogb[l_ac].att09, g_ogb[l_ac].att10
   FROM imx_file
   WHERE imx000 = g_ogb[l_ac].ogb04

   LET g_ogb04 = g_ogb[l_ac].att00
   LET g_chr2  = '1'

   #賦值所有屬性
   LET g_ogb[l_ac].att01_c = g_ogb[l_ac].att01
   LET g_ogb[l_ac].att02_c = g_ogb[l_ac].att02
   LET g_ogb[l_ac].att03_c = g_ogb[l_ac].att03
   LET g_ogb[l_ac].att04_c = g_ogb[l_ac].att04
   LET g_ogb[l_ac].att05_c = g_ogb[l_ac].att05
   LET g_ogb[l_ac].att06_c = g_ogb[l_ac].att06
   LET g_ogb[l_ac].att07_c = g_ogb[l_ac].att07
   LET g_ogb[l_ac].att08_c = g_ogb[l_ac].att08
   LET g_ogb[l_ac].att09_c = g_ogb[l_ac].att09
   LET g_ogb[l_ac].att10_c = g_ogb[l_ac].att10
   #顯示所有屬性
   DISPLAY BY NAME g_ogb[l_ac].att00
   DISPLAY BY NAME
     g_ogb[l_ac].att01, g_ogb[l_ac].att01_c,
     g_ogb[l_ac].att02, g_ogb[l_ac].att02_c,
     g_ogb[l_ac].att03, g_ogb[l_ac].att03_c,
     g_ogb[l_ac].att04, g_ogb[l_ac].att04_c,
     g_ogb[l_ac].att05, g_ogb[l_ac].att05_c,
     g_ogb[l_ac].att06, g_ogb[l_ac].att06_c,
     g_ogb[l_ac].att07, g_ogb[l_ac].att07_c,
     g_ogb[l_ac].att08, g_ogb[l_ac].att08_c,
     g_ogb[l_ac].att09, g_ogb[l_ac].att09_c,
     g_ogb[l_ac].att10, g_ogb[l_ac].att10_c
   LET g_chr3  = '1'
END FUNCTION

FUNCTION t600_chk_ogb092()
   DEFINE l_oea99   LIKE oea_file.oea99    #CHI-9C0009
   DEFINE li_result LIKE type_file.num5    #CHI-9C0009
   DEFINE l_img18   LIKE img_file.img18    #CHI-A40029 add
#FUN-AB0011 ----------------STA
    IF s_joint_venture( g_ogb[l_ac].ogb04,g_plant) OR NOT s_internal_item( g_ogb[l_ac].ogb04,g_plant ) THEN
        RETURN TRUE
    END IF
#FUN-AB0011 ----------------END

   IF cl_null(g_ogb[l_ac].ogb092) THEN LET  g_ogb[l_ac].ogb092=' ' END IF
   IF NOT cl_null(g_ogb[l_ac].ogb04) AND NOT cl_null(g_ogb[l_ac].ogb09)
      AND g_ogb[l_ac].ogb091 IS NOT NULL
      AND g_ogb[l_ac].ogb092 IS NOT NULL THEN   #No:MOD-5B0193
    #CHI-A40029 mark --start--
    #  IF g_ogb[l_ac].ogb17 = 'N' AND
    #     g_ogb[l_ac].ogb04 NOT MATCHES 'MISC*' THEN
    #     IF g_oga.oga09 MATCHES '[246]' THEN
    #        SELECT img09,img10 INTO g_img09,g_img10 FROM img_file
    #         WHERE img01=g_ogb[l_ac].ogb04  AND img02=g_ogb[l_ac].ogb09
    #           AND img03=g_ogb[l_ac].ogb091 AND img04=g_ogb[l_ac].ogb092   #FUN-560070
    #        IF SQLCA.sqlcode THEN
    #           IF g_oga.oga09 MATCHES '[46]' THEN   #MOD-9C0092
    #              CALL t600sub_chkpoz(g_oga.*,g_ogb[l_ac].ogb31) RETURNING li_result,g_poz.*,l_oea99,g_flow  #NO.TQC-740089 
    #              IF NOT li_result THEN RETURN END IF #FUN-730012
    #              IF g_argv0 = '4' AND g_poz.poz011 = '1' THEN 
    #                 CALL s_add_img(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
    #                                g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
    #                                g_oga.oga01,g_ogb[l_ac].ogb03,g_oga.oga02)
    #                 IF g_errno='N' THEN
    #                    RETURN FALSE
    #                 END IF
    #              END IF 
    #           END IF                                                                                     #MOD-9C0092 
    #           CALL cl_err3("sel","img_file",g_ogb[l_ac].ogb04,"",SQLCA.sqlcode,"","select img",1)        #MOD-9C0092
    #           RETURN FALSE
    #        END IF
    #     END IF
    #  END IF
    #CHI-A40029 mark --end--
      IF g_oga.oga09 MATCHES '[2468]' THEN   #FUN-5A0164  #No.FUN-630061
         SELECT COUNT(*) INTO g_cnt FROM img_file
          WHERE img01 = g_ogb[l_ac].ogb04   #料號
            AND img02 = g_ogb[l_ac].ogb09   #倉庫
            AND img03 = g_ogb[l_ac].ogb091  #儲位
            AND img04 = g_ogb[l_ac].ogb092  #批號
         #  AND img18 < g_oga.oga02  #CHI-A40029 mark
         IF g_cnt > 0 THEN
            #CALL cl_err('','aim-400',0)   #須修改  #CHI-A40029 mark
            #RETURN FALSE                           #CHI-A40029 mark
            #CHI-A40029 add --start--
            SELECT img18 INTO l_img18 FROM img_file
             WHERE img01 = g_ogb[l_ac].ogb04   #料號
               AND img02 = g_ogb[l_ac].ogb09   #倉庫
               AND img03 = g_ogb[l_ac].ogb091  #儲位
               AND img04 = g_ogb[l_ac].ogb092  #批號
            IF l_img18 < g_oga.oga02 THEN
               CALL cl_err('','aim-400',0)   #須修改
               RETURN FALSE
            END IF
            #CHI-A40029 add --end--
         END IF
      END IF   #FUN-5A0164
   END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_bef_ogb19()
   IF NOT cl_null(g_ogb[l_ac].ogb31) AND (g_ogb_t.ogb31 IS NULL OR (g_ogb[l_ac].ogb31 != g_ogb_t.ogb31))
      OR (NOT cl_null(g_ogb[l_ac].ogb32) AND (g_ogb_t.ogb32 IS NULL OR (g_ogb[l_ac].ogb32 != g_ogb_t.ogb32)))THEN
      SELECT oeb906 INTO g_ogb[l_ac].ogb19
        FROM oeb_file
       WHERE oeb01 = g_ogb[l_ac].ogb31
         AND oeb03 = g_ogb[l_ac].ogb32
      DISPLAY BY NAME g_ogb[l_ac].ogb19
   END IF
END FUNCTION

FUNCTION t600_chk_ogb17(p_cmd)
   DEFINE p_cmd LIKE type_file.chr1
   IF NOT cl_null(g_ogb[l_ac].ogb17) THEN
      IF NOT s_chk_checkbox(g_ogb[l_ac].ogb17) THEN
         RETURN FALSE
      END IF
      IF g_ogb[l_ac].ogb17 = 'Y' THEN
        #-----MOD-B30487---------
        #MOD-B30486 mod --start--
         IF cl_null(g_ogb[l_ac].ogb09) THEN LET g_ogb[l_ac].ogb09  = ' '  END IF
         IF cl_null(g_ogb[l_ac].ogb091) THEN LET g_ogb[l_ac].ogb091 = ' ' END IF
         IF cl_null(g_ogb[l_ac].ogb092) THEN LET g_ogb[l_ac].ogb092 = ' ' END IF
        #LET g_ogb[l_ac].ogb09  = ' '
        #LET g_ogb[l_ac].ogb091 = ' '
        #LET g_ogb[l_ac].ogb092 = ' '
        #MOD-B30486 mod --end--
        #-----END MOD-B30487-----
 
         DELETE FROM rvbs_file
          WHERE rvbs01 = g_oga.oga01
            AND rvbs02 = g_ogb[l_ac].ogb03
            AND rvbs13 = 0

            IF g_sma.sma115 = 'Y' THEN
               CALL t600_b_ogg()
            ELSE
               IF g_oaz.oaz23 = 'Y' THEN
                  CALL t600_b_ogd()
               ELSE
                  CALL t600_b_ogc()
               END IF
            END IF
      ELSE
          DELETE FROM ogc_file
           WHERE ogc01 = g_oga.oga01
             AND ogc03 = g_ogb[l_ac].ogb03
          DELETE FROM rvbs_file
           WHERE rvbs01 = g_oga.oga01
             AND rvbs02 = g_ogb[l_ac].ogb03
             AND rvbs13 <> 0
          DELETE FROM ogg_file
           WHERE ogg01 = g_oga.oga01
             AND ogg03 = g_ogb[l_ac].ogb03
      END IF
      CALL t600_set_no_entry_b1(p_cmd)   #No:MOD-570264
   END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_chk_ogb09()
  DEFINE l_slip     LIKE oay_file.oayslip    #MOD-910216 add
  DEFINE l_smyware  LIKE smy_file.smyware    #MOD-910216 add
 
    IF NOT cl_null(g_ogb[l_ac].ogb09) THEN
       LET g_cnt=0
       SELECT count(*) INTO g_cnt  FROM imd_file
        WHERE imd01=g_ogb[l_ac].ogb09
          AND imd11='Y'     
          AND imdacti='Y'
       IF g_cnt=0 THEN
          CALL cl_err(g_ogb[l_ac].ogb09,'axm-993',0)
          RETURN FALSE
       END IF
       #No.FUN-AA0048  --Begin
       #IF g_azw.azw04= '2' THEN
       #    LET g_cnt =0
       #    SELECT COUNT(*) INTO g_cnt FROM imd_file 
       #     WHERE imd01=g_ogb[l_ac].ogb09 
       #       AND imd20=g_plant
       #    IF g_cnt=0 THEN 
       #       CALL cl_err(g_ogb[l_ac].ogb09,'art-487',0)
       #       RETURN FALSE
       #    END IF
       #END IF
       IF NOT s_chk_ware(g_ogb[l_ac].ogb09) THEN
          RETURN FALSE
       END IF
       #No.FUN-AA0048  --End  
    END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_chk_ogb05(p_cmd)        #FUN-AC0012 Add p_cmd
 DEFINE p_cmd LIKE type_file.chr1     #FUN-AC0012
 DEFINE l_fac LIKE oeb_file.oeb05_fac

   IF NOT cl_null(g_ogb[l_ac].ogb05) THEN
      SELECT COUNT(*) INTO g_cnt FROM gfe_file
       WHERE gfe01=g_ogb[l_ac].ogb05
      IF g_cnt = 0 THEN
         CALL cl_err(g_ogb[l_ac].ogb05,'mfg3377',0)
         RETURN FALSE
      END IF
      IF NOT cl_null(g_ogb[l_ac].ogb04) AND g_sma.sma116 MATCHES '[01]' THEN
         IF (g_ogb_t.ogb05 IS NULL OR g_ogb_t.ogb05 <> g_ogb[l_ac].ogb05) AND (g_aza.aza50 ='Y' OR g_azw.azw04='2') THEN 
            IF cl_null(g_ogb[l_ac].ogb31) AND cl_null(g_ogb[l_ac].ogb32) THEN   #MOD-B60052 
           #CALL t600_price(l_ac) RETURNING l_fac       #FUN-AC0012
               CALL t600_price(p_cmd,l_ac) RETURNING l_fac #FUN-AC0012
               IF l_fac THEN
                  RETURN FALSE
               END IF
            END IF                                                              #MOD-B60052
         END IF
      END IF
   END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_chk_ogb12(p_cmd)        #FUN-AC0012 Add p_cmd
 DEFINE p_cmd LIKE type_file.chr1     #FUN-AC0012
 DEFINE
    l_ogb12a        LIKE ogb_file.ogb12,
    l_ogb12b        LIKE ogb_file.ogb12,
    l_ogb12c        LIKE ogb_file.ogb12,   #MOD-A50076
    l_oeb25         LIKE oeb_file.oeb25,
    l_qty           LIKE ogb_file.ogb12
    DEFINE l_fac    LIKE type_file.chr1 #FUN-9C0173

   IF (g_ogb_t.ogb12 IS NULL AND g_ogb[l_ac].ogb12 IS NOT NULL) OR   #MOD-7B0243 modify()
      (g_ogb_t.ogb12 IS NOT NULL AND g_ogb[l_ac].ogb12 IS NULL) OR   #MOD-7B0243 modify()
      (g_ogb_t.ogb12 <> g_ogb[l_ac].ogb12) THEN                      #MOD-7B0243 modify()
      LET g_change='Y'
   END IF
   IF NOT cl_null(g_ogb[l_ac].ogb12) THEN
      IF g_ogb[l_ac].ogb12 < 0 THEN
         CALL cl_err('','amm-110',0)
         RETURN FALSE
      END IF
      IF g_ogb[l_ac].ogb12 = 0 AND g_argv0 <> '8' THEN
         CALL cl_err('','mfg9243',0)   #No:MOD-5B0113
         RETURN FALSE
      END IF
      IF g_argv0 MATCHES '[2468]' AND NOT cl_null(g_oga.oga011) THEN#7992
         IF g_argv0 = '8' THEN
          IF NOT cl_null(g_oga.oga16) THEN   #有訂單出貨單轉簽收 FUN-C50097 ADD cl_null(g_oga.oga16)
            LET l_ogb12a = 0
            SELECT SUM(ogb12) INTO l_ogb12a FROM ogb_file,oga_file
             WHERE ogb01 = oga01 AND oga09 ='2' AND oga65='Y'
               AND oga01 = g_oga.oga011
               AND ogb31 = g_ogb[l_ac].ogb31
               AND ogb32 = g_ogb[l_ac].ogb32
               AND ogb04 = g_ogb[l_ac].ogb04 #BugNo:4541
               AND ogaconf = 'Y' AND ogapost='Y'
            IF cl_null(l_ogb12a) THEN LET l_ogb12a = 0 END IF
            LET l_ogb12b = 0
            SELECT SUM(ogb12) INTO l_ogb12b FROM ogb_file,oga_file
             WHERE ogb01 = oga01 AND oga09 ='8'
               AND oga011 = g_oga.oga011
               AND ogb31 = g_ogb[l_ac].ogb31
               AND ogb32 = g_ogb[l_ac].ogb32
               AND ogb04 = g_ogb[l_ac].ogb04 #no.7168
               AND ogaconf !='X'
            IF cl_null(l_ogb12b) THEN LET l_ogb12b = 0 END IF
            LET l_ogb12b = l_ogb12b - g_ogb_t.ogb12
                         + g_ogb[l_ac].ogb12
            IF l_ogb12b > l_ogb12a THEN
               CALL cl_err('sel ogb(1):','axm-426',0) RETURN FALSE
            END IF
           ELSE #無訂單出貨單轉簽收,單頭和單身均沒有訂單號碼和項次 FUN-C50097 ADD BEG-----
               LET l_ogb12a = 0
               SELECT SUM(ogb12) INTO l_ogb12a FROM ogb_file,oga_file
                WHERE ogb01 = oga01 AND oga09 ='2' AND oga65='Y'
                  AND oga01 = g_oga.oga011
                  #AND ogb31 = g_ogb[l_ac].ogb31
                  #AND ogb32 = g_ogb[l_ac].ogb32
                  AND ogb04 = g_ogb[l_ac].ogb04 #BugNo:4541
                  AND ogaconf = 'Y' AND ogapost='Y'
               IF cl_null(l_ogb12a) THEN LET l_ogb12a = 0 END IF
               LET l_ogb12b = 0
               SELECT SUM(ogb12) INTO l_ogb12b FROM ogb_file,oga_file
               #WHERE ogb01 = oga01 AND oga09 ='8'                  #FUN-C40072 mark
                WHERE ogb01 = oga01 AND (oga09 ='2' OR oga09 = '4') #FUN-C40072 add
                  AND oga011 = g_oga.oga011
                  #AND ogb31 = g_ogb[l_ac].ogb31
                  #AND ogb32 = g_ogb[l_ac].ogb32
                  AND ogb04 = g_ogb[l_ac].ogb04 #no.7168
                  AND ogaconf !='X'
               IF cl_null(l_ogb12b) THEN LET l_ogb12b = 0 END IF
               LET l_ogb12b = l_ogb12b - g_ogb_t.ogb12
                            + g_ogb[l_ac].ogb12
               IF l_ogb12b > l_ogb12a THEN
                  CALL cl_err('sel ogb(1):','axm-426',0)
                  IF g_ima906 MATCHES '[23]' THEN
                     RETURN "ogb915"
                  ELSE
                     RETURN "ogb912"
                  END IF
               END IF               
            END IF 	
            #FUN-C50097 ADD END-----             	      
         ELSE
         #檢查出貨數必須<=通知單應出數(ogb12)-累計出貨數(ogb19)
         #對應到的出貨通知單上的數量
            LET l_ogb12a = 0
            SELECT SUM(ogb12) INTO l_ogb12a FROM ogb_file,oga_file
             WHERE ogb01 = oga01 AND oga09 IN ('1','5')    #No.7992
               AND oga01 = g_oga.oga011
               AND ogb31 = g_ogb[l_ac].ogb31
               AND ogb32 = g_ogb[l_ac].ogb32
               AND ogb04 = g_ogb[l_ac].ogb04 #BugNo:4541
               AND ogaconf != 'X'  #CHI-6B0036
            IF cl_null(l_ogb12a) THEN LET l_ogb12a = 0 END IF

            # 此出貨通知單已耗用在出貨單的量
            LET l_ogb12b = 0
            SELECT SUM(ogb12) INTO l_ogb12b FROM ogb_file,oga_file
             WHERE ogb01 = oga01 AND oga09 IN ('2','4','6')   #No.7992  #No.FUN-630061
               AND oga011 = g_oga.oga011
               AND ogb31 = g_ogb[l_ac].ogb31
               AND ogb32 = g_ogb[l_ac].ogb32
               AND ogb04 = g_ogb[l_ac].ogb04 #no.7168
               AND ogaconf !='X'
            IF cl_null(l_ogb12b) THEN LET l_ogb12b = 0 END IF
            LET l_ogb12b = l_ogb12b - g_ogb_t.ogb12
                         + g_ogb[l_ac].ogb12
            IF l_ogb12b > l_ogb12a THEN
               CALL cl_err('sel ogb(1):','axm-128',0) RETURN FALSE
            END IF
         END IF #No.FUN-630061
      ELSE
         #檢查出貨通知單量必須<=訂單數量(ogb12)
         IF NOT t600sub_chkoeo(g_ogb[l_ac].ogb31,
            g_ogb[l_ac].ogb32,g_ogb[l_ac].ogb04) THEN #no.7168
#FUN-A60035 ---MARK BEGIN
##FUN-A60035 --Begin
#&ifdef SLK
#              SELECT SUM(oeb12),SUM(oeb25) INTO l_ogb12a,l_oeb25
#                FROM oeb_file ,oea_file,ata_file
#               WHERE oeb01 = g_ogb[l_ac].ogb31
#                 AND oeb03 = ata03
#                 AND ata01 = oeb01
#                 AND ata00 = 'axmt410_slk'
#                 AND ata02 = g_ogb[l_ac].ogb32
#                 AND oeaconf = 'Y' AND oea01 = oeb01
#              
#&else
##FUN-A60035 --End
#FUN-A60035 ---MARK END
               SELECT oeb12,oeb25 INTO l_ogb12a,l_oeb25
                 FROM oeb_file ,oea_file
                WHERE oeb01 = g_ogb[l_ac].ogb31
                  AND oeb03 = g_ogb[l_ac].ogb32
                  AND oeaconf = 'Y' AND oea01 = oeb01
#FUN-A60035 ---MARK BEGIN
##FUN-A60035 --Begin
#&endif
##FUN-A60035 --End
#FUN-A60035 ---MARK END
               IF cl_null(l_ogb12a) THEN LET l_ogb12a = 0 END IF
         IF g_oea.oea37 = "Y" THEN
          # SELECT oee083 INTO g_oee083 FROM oee_file           #TQC-A40113
            SELECT SUM(oee083) INTO g_oee083 FROM oee_file      #TQC-A40113
         #   WHERE oee10 = g_ogb[l_ac].ogb31                    #TQC-A40113                                                          
         #     AND oee11 = g_ogb[l_ac].ogb32                    #TQC-A40113                                                           
             WHERE oee01 = g_ogb[l_ac].ogb31                    #TQC-A40113                                                          
               AND oee02 = g_ogb[l_ac].ogb32                    #TQC-A40113                                                           
            IF cl_null(g_oee083) THEN
               LET g_oee083 = 0
            END IF
         END IF
         ELSE
               SELECT oeo09 INTO l_ogb12a FROM oeo_file
                WHERE oeo01 = g_ogb[l_ac].ogb31
                  AND oeo03 = g_ogb[l_ac].ogb32
                  AND oeo04 = g_ogb[l_ac].ogb04
                  AND oeo08 = '2'
               IF cl_null(l_ogb12a) THEN LET l_ogb12a = 0  END IF
               LET l_oeb25 = 0
         END IF
         # 此訂單已耗用在出貨通知單的量
         LET l_ogb12b = 0
#FUN-A60035 ---MARK BEGIN
##FUN-A60035 --Begin
#&ifdef SLK
#        SELECT SUM(ogb12) INTO l_ogb12b FROM ogb_file,oga_file,ata_file
#         WHERE ogb01 = oga01
#           AND oga09 = g_argv0
#           AND ogb31 = g_ogb[l_ac].ogb31
#           AND ogb32 = ata03
#           AND ogb04 = ata04
#           AND ata01 = oga01
#           AND ata00 = g_prog
#           AND ogaconf != 'X'
#           AND ata02 = 
#               (SELECT ata02 FROM ata_file
#                 WHERE ata00 = 'axmt410_slk'
#                   AND ata01 = g_ogb[l_ac].ogb31
#                   AND ata02 = g_ogb[l_ac].ogb32
#               )
#&else
##FUN-A60035 --End
#FUN-A60035 ---MARK END
         SELECT SUM(ogb12) INTO l_ogb12b FROM ogb_file,oga_file
          WHERE ogb01 = oga01
            AND oga09 = g_argv0
            AND ogb31 = g_ogb[l_ac].ogb31     #訂單單號
            AND ogb32 = g_ogb[l_ac].ogb32     #訂單項次
            AND ogb04 = g_ogb[l_ac].ogb04     #no.7168
            AND ogaconf !='X'
            AND oga09<>'1' #xiaoyx
#FUN-A60035 ---MARK BEGIN
##FUN-A60035 --Begin
#&endif
##FUN-A60035 --End
#FUN-A60035 ---MARK END
         IF cl_null(l_ogb12b) THEN LET l_ogb12b = 0 END IF
         LET g_ogb_t.ogb12 = 0
#FUN-A60035 ---MARK BEGIN
##FUN-A60035 --Begin
#&ifdef SLK
#         LET g_ogb_t.ogb12 = g_ogb[l_ac].ogb32
#&else
##FUN-A60035 --End
#FUN-A60035 ---MARK END
         SELECT ogb12 INTO g_ogb_t.ogb12 FROM ogb_file
          WHERE ogb01=g_oga.oga01
            AND ogb31 = g_ogb[l_ac].ogb31
            AND ogb32 = g_ogb[l_ac].ogb32
            AND ogb04 = g_ogb[l_ac].ogb04     #no.7168
            AND g_oga.ogaconf !='X'
            AND ogb03 = g_ogb[l_ac].ogb03   #No:MOD-620019
#FUN-A60035 ---MARK BEGIN
##FUN-A60035 --Begin
#&endif
##FUN-A60035 --End
#FUN-A60035 ---MARK END
         IF cl_null(g_ogb_t.ogb12) THEN LET g_ogb_t.ogb12 = 0 END IF
         LET l_ogb12b = l_ogb12b - g_ogb_t.ogb12
                      + g_ogb[l_ac].ogb12

         IF NOT cl_null(g_ogb[l_ac].ogb31) AND #訂單單號
            g_ogb[l_ac].ogb31[1,4] !='MISC' THEN
            SELECT * INTO g_oea.* FROM oea_file WHERE oea01=g_ogb[l_ac].ogb31  #MOD-850029 add
            IF cl_null(g_oea.oea09) THEN LET g_oea.oea09=0 END IF
            #-----MOD-A50076---------
            LET l_ogb12c = 0
            SELECT SUM(ogb12) INTO l_ogb12c FROM ogb_file,oga_file
             WHERE ogb01 = oga01 
               AND ogb31 = g_ogb[l_ac].ogb31
               AND ogb32 = g_ogb[l_ac].ogb32
               AND oga09 = '9'
               AND ogaconf ='Y'
               AND ogapost = 'Y'
            IF cl_null(l_ogb12c) THEN LET l_ogb12c = 0 END IF
            #-----END MOD-A50076-----
            IF cl_null(l_oeb25) THEN LET l_oeb25=0 END IF
            LET l_ogb12a=l_ogb12a*((100+g_oea.oea09)/100) #可超交
                         +l_oeb25       #已銷退數量(須再換貨出貨)
                         +l_ogb12c      #簽收驗退量   #MOD-A50076
            IF g_oea.oea37 = "Y" THEN   #No:FUN-640025
               IF l_ogb12b > g_oee083 THEN
                  CALL cl_err('','axm-038',0)
                  RETURN FALSE
               END IF
            ELSE
               IF l_ogb12b > l_ogb12a THEN
                  CALL cl_err('','axm-126',0)
                  RETURN FALSE
               END IF
            END IF
         END IF
      END IF

   END IF
   IF cl_null(g_ogb[l_ac].ogb916) THEN
      LET g_ogb[l_ac].ogb916=g_ogb[l_ac].ogb05
      LET g_ogb[l_ac].ogb917=g_ogb[l_ac].ogb12
   END IF
   IF g_change='Y' THEN
      CALL t600_set_ogb917()
   END IF
    IF NOT cl_null(g_ogb[l_ac].ogb12) AND (g_ogb[l_ac].ogb12!=g_ogb_t.ogb12
                                           OR g_ogb_t.ogb12 IS NULL ) THEN
      #CALL t600_price(l_ac) RETURNING l_fac  #FUN-9C0173     #No:FUN-A50103 Mark
      #IF l_fac THEN RETURN FALSE END IF  #FUN-9C0173     #No:FUN-A50103 Mark
#       IF p_cmd = 'a' THEN               #MOD-B30218 add                      #MOD-B60052 mark
        IF cl_null(g_ogb[l_ac].ogb31) AND cl_null(g_ogb[l_ac].ogb32) THEN      #MOD-B60052
          CALL t600_price(p_cmd,l_ac) RETURNING l_fac #FUN-AC0012
          IF l_fac THEN RETURN FALSE END IF           #FUN-AC0012
        END IF  #MOD-B30218 add  #MOD-B60052
       CALL t600_ogb14()
    END IF
   IF g_argv0 = '8' THEN
      SELECT ogb12 INTO g_ogb12_sum FROM ogb_file
       WHERE ogb01 = g_oga.oga011
         AND ogb03 = g_ogb[l_ac].ogb03
      LET g_ogb[l_ac].ogb12b = g_ogb12_sum - g_ogb[l_ac].ogb12
      DISPLAY BY NAME g_ogb[l_ac].ogb12b
   END IF
#FUN-C50097 add begin----
   IF g_argv0 = '8' AND g_aza.aza26 = '2' THEN
      IF  g_oaz.oaz94 = 'Y' THEN 
         #LET g_ogb[l_ac].ogb12b = 0
      ELSE 
      	 SELECT ogb12 INTO g_ogb12_sum FROM ogb_file
          WHERE ogb01 = g_oga.oga011
            AND ogb03 = g_ogb[l_ac].ogb03
         LET g_ogb[l_ac].ogb12b = g_ogb12_sum - g_ogb[l_ac].ogb12       
      END IF 
      DISPLAY BY NAME g_ogb[l_ac].ogb12b
   END IF   
#FUN-C50097 add end-----
   RETURN TRUE
END FUNCTION

FUNCTION t600_chk_ogb91()
   DEFINE l_qty LIKE ogb_file.ogb12
   DEFINE l_cnt LIKE type_file.num5 #No:FUN-870007
   DEFINE l_oea99   LIKE oea_file.oea99    #CHI-9C0009
   DEFINE li_result LIKE type_file.num5    #CHI-9C0009

   IF g_ogb[l_ac].ogb091 IS NULL THEN LET g_ogb[l_ac].ogb091 =' ' END IF
   IF g_oaz.oaz104 = 'N' THEN 
      IF g_ogb[l_ac].ogb092 IS NULL THEN LET g_ogb[l_ac].ogb092 =' ' END IF  
   END IF 
  #IF g_ogb[l_ac].ogb091 IS NOT NULL THEN      #MOD-910216 add  #No:MOD-920191 mark     #MOD-970093 mark還原 #CHI-A40029 mark
   IF g_ogb[l_ac].ogb091 IS NOT NULL AND NOT cl_null(g_ogb[l_ac].ogb09) THEN      #CHI-A40029 add
   #------------------------------------ 檢查料號預設倉儲及單別預設倉儲
      IF g_oga.oga09 MATCHES '[2468]' THEN  #No.FUN-630061  #MOD-910216 mark  #No:MOD-920191 mark還原
         IF NOT s_chksmz(g_ogb[l_ac].ogb04, g_oga.oga01,
                         g_ogb[l_ac].ogb09, g_ogb[l_ac].ogb091) THEN
            RETURN "ogb09"
         END IF
         #No.FUN-AA0048  --Begin
         #IF g_azw.azw04='2' THEN
         #   LET l_cnt =0                                                                                                      
         #   SELECT COUNT(*) INTO l_cnt FROM imd_file                                                                           
         #    WHERE imd01=g_ogb[l_ac].ogb09                                                                                    
         #      AND imd20=g_plant                                                                                   
         #   IF l_cnt=0 THEN                                                                                                    
         #      CALL cl_err(g_ogb[l_ac].ogb09,'art-487',0)                                                                      
         #      RETURN "ogb09"                                                                                                   
         #   END IF       
         #END IF
         IF NOT s_chk_ware(g_ogb[l_ac].ogb09) THEN
            RETURN "ogb09"
         END IF
#FUN-AB0011 ---------------------STA
         IF s_joint_venture( g_ogb[l_ac].ogb04,g_plant) OR NOT s_internal_item( g_ogb[l_ac].ogb04,g_plant ) THEN
            RETURN NULL
         END IF
#FUN-AB0011 -------------------- END
         #No.FUN-AA0048  --End  
         IF g_oaz.oaz104 = 'N' THEN 
            SELECT COUNT(*) INTO g_cnt FROM img_file
             WHERE img01 = g_ogb[l_ac].ogb04  
               AND img02 = g_ogb[l_ac].ogb09  
               AND img03 = g_ogb[l_ac].ogb091 
               AND img04 = g_ogb[l_ac].ogb092  
            IF g_cnt = 0 THEN
               #FUN-C80107 add begin---------------------------121107
               LET g_flag2 = NULL
               CALL s_inv_shrt_by_warehouse(g_sma.sma894[2,2],g_ogb[l_ac].ogb09) RETURNING g_flag2
               IF g_flag2 = 'N' OR g_flag2 IS NULL THEN
               #FUN-C80107 add end ----------------------------
               IF g_oga.oga09 MATCHES '[46]' THEN  #MOD-9C0092
                  CALL t600sub_chkpoz(g_oga.*,g_ogb[l_ac].ogb31) RETURNING li_result,g_poz.*,l_oea99,g_flow  #NO.TQC-740089 
                  IF NOT li_result THEN RETURN END IF #FUN-730012
                  IF g_argv0 = '4' AND g_poz.poz011 = '1' THEN 
                     CALL s_add_img(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                                    g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                                    g_oga.oga01,g_ogb[l_ac].ogb03,g_oga.oga02)
                     IF g_errno='N' THEN
                        RETURN "ogb09"
                     END IF
                  END IF 
               END IF                                #MOD-9C0092 
               #CALL cl_err('','axm-244',0)           #MOD-9C0092   #CHI-A10002 mark
               CALL cl_err(g_ogb[l_ac].ogb04,'axm-244',0)          #CHI-A10002 add
               LET g_ogb[l_ac].ogb091 = ''
               RETURN "ogb09"
               #FUN-C80107 add begin---------------------------121107
               ELSE
                  IF g_sma.sma892[3,3] = 'Y' THEN
                     IF g_bgjob='N' OR cl_null(g_bgjob) THEN
                        IF NOT cl_confirm('mfg1401') THEN
                           RETURN "ogb09"
                        END IF
                     END IF
                  END IF
                  CALL s_add_img(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                                 g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                                 g_oga.oga01,g_ogb[l_ac].ogb03,g_oga.oga02)
                  IF g_errno='N' THEN
                     RETURN "ogb09"
                  END IF
               END IF
               #FUN-C80107 add end-----------------------------121107
            END IF
         END IF
      END IF
   END IF
   RETURN NULL
END FUNCTION

FUNCTION t600_chk_ogb913()
   IF cl_null(g_ogb[l_ac].ogb04) THEN RETURN "ogb04" END IF
   IF g_ogb[l_ac].ogb17 = 'N' THEN
      IF cl_null(g_ogb[l_ac].ogb091) THEN LET g_ogb[l_ac].ogb091 = ' ' END IF
      IF cl_null(g_ogb[l_ac].ogb092) THEN LET g_ogb[l_ac].ogb092 = ' ' END IF
      IF g_oga.oga09 MATCHES '[246]' THEN
         IF g_ogb[l_ac].ogb09 IS NULL OR g_ogb[l_ac].ogb091 IS NULL OR
            g_ogb[l_ac].ogb092 IS NULL THEN
            RETURN "ogb092"
         END IF
      END IF
   END IF
   IF (g_ogb_t.ogb913 IS NULL AND g_ogb[l_ac].ogb913 IS NOT NULL) OR     #MOD-7B0243 modify
      (g_ogb_t.ogb913 IS NOT NULL AND g_ogb[l_ac].ogb913 IS NULL) OR     #MOD-7B0243 modify
      (g_ogb_t.ogb913 <> g_ogb[l_ac].ogb913) THEN                        #MOD-7B0243 modify
      LET g_change='Y'
   END IF
   IF NOT cl_null(g_ogb[l_ac].ogb913) THEN
      SELECT gfe02 INTO g_buf FROM gfe_file
       WHERE gfe01=g_ogb[l_ac].ogb913
         AND gfeacti='Y'
      IF STATUS THEN
         CALL cl_err3("sel","gfe_file",g_ogb[l_ac].ogb913,"",SQLCA.sqlcode,"","gfe:",1)  #No.FUN-670008
         RETURN "ogb913"
      END IF
      IF NOT cl_null(g_ogb[l_ac].ogb04) THEN
         SELECT ima31,ima906 INTO g_ima31,g_ima906 
           FROM ima_file
          WHERE ima01=g_ogb[l_ac].ogb04
      END IF
      CALL s_du_umfchk(g_ogb[l_ac].ogb04,'','','',
                       g_ima31,g_ogb[l_ac].ogb913,g_ima906)
           RETURNING g_errno,g_factor
      IF NOT cl_null(g_errno) THEN
         CALL cl_err(g_ogb[l_ac].ogb913,g_errno,0)
         RETURN "ogb913"
      END IF
      IF cl_null(g_ogb_t.ogb913) OR g_ogb_t.ogb913 <> g_ogb[l_ac].ogb913 THEN
         LET g_ogb[l_ac].ogb914 = g_factor
      END IF
      IF g_ogb[l_ac].ogb17='N' AND
         g_ogb[l_ac].ogb04 NOT MATCHES 'MISC*' THEN
        #FUN-C80107 mark begin------------------------------121024
        #CALL s_chk_imgg(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
        #                g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
        #                g_ogb[l_ac].ogb913) RETURNING g_flag
        #IF g_flag = 1 THEN
        #   IF g_oga.oga09 MATCHES '[246]' THEN
        #      CALL cl_err(g_ogb[l_ac].ogb913,'asm-301',0)
        #      RETURN "ogb092"
        #   END IF
        #END IF
        #FUN-C80107 mark end--------------------------------
         SELECT imgg10 INTO g_imgg10_2 FROM imgg_file
          WHERE imgg01=g_ogb[l_ac].ogb04
            AND imgg02=g_ogb[l_ac].ogb09
            AND imgg03=g_ogb[l_ac].ogb091
            AND imgg04=g_ogb[l_ac].ogb092
            AND imgg09=g_ogb[l_ac].ogb913
         IF cl_null(g_imgg10_2) THEN LET g_imgg10_2=0 END IF
      END IF
   END IF
   IF g_change='Y' THEN
      CALL t600_set_ogb917()
   END IF
   CALL t600_set_required_b1('')
   CALL cl_show_fld_cont()     #FUN-550037(smin)
   RETURN NULL
END FUNCTION

FUNCTION t600_bef_ogb914()
   IF cl_null(g_ogb[l_ac].ogb04) THEN RETURN "ogb04" END IF
   IF g_ogb[l_ac].ogb17 = 'N' THEN
      IF g_oga.oga09 MATCHES '[246]' THEN
         IF g_ogb[l_ac].ogb09 IS NULL OR g_ogb[l_ac].ogb091 IS NULL OR
            g_ogb[l_ac].ogb092 IS NULL THEN
            RETURN "ogb092"
         END IF
      END IF
   END IF
   IF NOT cl_null(g_ogb[l_ac].ogb913) THEN
      IF g_ogb[l_ac].ogb17='N' AND
         g_ogb[l_ac].ogb04 NOT MATCHES 'MISC*' THEN
        #FUN-C80107 mark begin------------------------------
        #CALL s_chk_imgg(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
        #                g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
        #                g_ogb[l_ac].ogb913) RETURNING g_flag
        #IF g_flag = 1 THEN
        #   IF g_oga.oga09 MATCHES '[246]' THEN
        #      CALL cl_err(g_ogb[l_ac].ogb913,'asm-301',0)
        #      RETURN "ogb092"
        #   END IF
        #END IF
        #FUN-C80107 mark end--------------------------------
         SELECT imgg10 INTO g_imgg10_2 FROM imgg_file
          WHERE imgg01=g_ogb[l_ac].ogb04
            AND imgg02=g_ogb[l_ac].ogb09
            AND imgg03=g_ogb[l_ac].ogb091
            AND imgg04=g_ogb[l_ac].ogb092
            AND imgg09=g_ogb[l_ac].ogb913
         IF cl_null(g_imgg10_2) THEN LET g_imgg10_2=0 END IF
      END IF
   END IF
   RETURN NULL
END FUNCTION

FUNCTION t600_chk_ogb914()
   IF (g_ogb_t.ogb914 IS NULL AND g_ogb[l_ac].ogb914 IS NOT NULL) OR  #MOD-7B0243 modify()
      (g_ogb_t.ogb914 IS NOT NULL AND g_ogb[l_ac].ogb914 IS NULL) OR  #MOD-7B0243 modify()
      (g_ogb_t.ogb914 <> g_ogb[l_ac].ogb914) THEN                     #MOD-7B0243 modify()
      LET g_change='Y'
   END IF
   IF NOT cl_null(g_ogb[l_ac].ogb914) THEN
      IF g_ogb[l_ac].ogb914=0 THEN
         RETURN FALSE
      END IF
   END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_bef_ogb915()
   IF cl_null(g_ogb[l_ac].ogb04) THEN RETURN "ogb04" END IF
   IF g_ogb[l_ac].ogb091 IS NULL THEN LET g_ogb[l_ac].ogb091=' ' END IF
   IF g_ogb[l_ac].ogb092 IS NULL THEN LET g_ogb[l_ac].ogb092=' ' END IF
   IF g_ogb[l_ac].ogb17 = 'N' THEN
      IF g_oga.oga09 MATCHES '[246]' THEN
         IF g_ogb[l_ac].ogb09 IS NULL OR g_ogb[l_ac].ogb091 IS NULL OR
            g_ogb[l_ac].ogb092 IS NULL THEN
            RETURN "ogb092"
         END IF
      END IF
   END IF
   IF NOT cl_null(g_ogb[l_ac].ogb913) THEN
      IF g_ogb[l_ac].ogb17='N' AND
         g_ogb[l_ac].ogb04 NOT MATCHES 'MISC*' THEN
        #FUN-C80107 mark begin------------------------------
        #CALL s_chk_imgg(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
        #                g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
        #                g_ogb[l_ac].ogb913) RETURNING g_flag
        #IF g_flag = 1 THEN
        #   IF g_oga.oga09 MATCHES '[246]' THEN
        #      CALL cl_err(g_ogb[l_ac].ogb913,'asm-301',0)
        #      RETURN "ogb092"
        #   END IF
        #END IF
        #FUN-C80107 mark end--------------------------------
         SELECT imgg10 INTO g_imgg10_2 FROM imgg_file
          WHERE imgg01=g_ogb[l_ac].ogb04
            AND imgg02=g_ogb[l_ac].ogb09
            AND imgg03=g_ogb[l_ac].ogb091
            AND imgg04=g_ogb[l_ac].ogb092
            AND imgg09=g_ogb[l_ac].ogb913
         IF cl_null(g_imgg10_2) THEN LET g_imgg10_2=0 END IF
      END IF
   END IF
   RETURN NULL
END FUNCTION

FUNCTION t600_chk_ogb915(p_cmd)
   DEFINE p_cmd LIKE type_file.chr1

   IF (g_ogb_t.ogb915 IS NULL AND g_ogb[l_ac].ogb915 IS NOT NULL) OR   #MOD-7B0243 modofy()
      (g_ogb_t.ogb915 IS NOT NULL AND g_ogb[l_ac].ogb915 IS NULL) OR   #MOD-7B0243 modofy()
      (g_ogb_t.ogb915 <> g_ogb[l_ac].ogb915) THEN                      #MOD-7B0243 modofy()
      LET g_change='Y'
   END IF
   IF NOT cl_null(g_ogb[l_ac].ogb915) THEN
      IF g_ogb[l_ac].ogb915 < 0 THEN
         CALL cl_err('','aim-391',0)  #
         RETURN FALSE
      END IF
      IF p_cmd = 'a' THEN
         IF g_ima906='3' THEN
            LET g_tot=g_ogb[l_ac].ogb915*g_ogb[l_ac].ogb914
            IF cl_null(g_ogb[l_ac].ogb912) OR g_ogb[l_ac].ogb912=0 THEN #CHI-960022
               LET g_ogb[l_ac].ogb912=g_tot*g_ogb[l_ac].ogb911
               DISPLAY BY NAME g_ogb[l_ac].ogb912                       #CHI-960022
            END IF                                                      #CHI-960022
         END IF
      END IF
      IF g_oga.oga09 MATCHES '[2468]' THEN  #No.FUN-630061
         IF g_sma.sma117 = 'N' THEN
            SELECT imgg10 INTO g_imgg10_2 FROM imgg_file
             WHERE imgg01=g_ogb[l_ac].ogb04
               AND imgg02=g_ogb[l_ac].ogb09
               AND imgg03=g_ogb[l_ac].ogb091
               AND imgg04=g_ogb[l_ac].ogb092
               AND imgg09=g_ogb[l_ac].ogb913
            IF cl_null(g_imgg10_2) THEN LET g_imgg10_2=0 END IF
            IF g_ogb[l_ac].ogb17 = 'N' THEN   #MOD-890274
               IF g_ogb[l_ac].ogb915 > g_imgg10_2 THEN
                  IF g_sma.sma894[2,2]='N' OR g_sma.sma894[2,2] IS NULL THEN
                     CALL cl_err(g_ogb[l_ac].ogb915,'mfg1303',1)
                     RETURN FALSE
                  ELSE
                     IF NOT cl_confirm('mfg3469') THEN
                        RETURN FALSE
                     ELSE
                        LET g_yes = 'Y'
                     END IF
                  END IF
               END IF
            END IF   #MOD-890274
         END IF
      END IF
   END IF
   IF g_change='Y' THEN
      CALL t600_set_ogb917()
   END IF
   IF g_argv0 = '8' THEN
      SELECT ogb915 INTO g_ogb915_sum FROM ogb_file
       WHERE ogb01 = g_oga.oga011
         AND ogb03 = g_ogb[l_ac].ogb03
      LET g_ogb[l_ac].ogb915b = g_ogb915_sum - g_ogb[l_ac].ogb915
      DISPLAY BY NAME g_ogb[l_ac].ogb915b
   END IF
   CALL cl_show_fld_cont()     #FUN-550037(smin)
   RETURN TRUE
END FUNCTION

FUNCTION t600_chk_ogb910()
   IF cl_null(g_ogb[l_ac].ogb04) THEN
      RETURN "ogb04"
   END IF
   IF g_ogb[l_ac].ogb17 = 'N' THEN
      IF cl_null(g_ogb[l_ac].ogb091) THEN LET g_ogb[l_ac].ogb091 = ' ' END IF
      IF cl_null(g_ogb[l_ac].ogb092) THEN LET g_ogb[l_ac].ogb092 = ' ' END IF
      IF g_oga.oga09 MATCHES '[246]' THEN
         IF g_ogb[l_ac].ogb09 IS NULL OR g_ogb[l_ac].ogb091 IS NULL OR
            g_ogb[l_ac].ogb092 IS NULL THEN
            RETURN "ogb092"
         END IF
      END IF
   END IF
   IF (g_ogb_t.ogb910 IS NULL AND g_ogb[l_ac].ogb910 IS NOT NULL) OR   #MOD-7B0243 modify()
      (g_ogb_t.ogb910 IS NOT NULL AND g_ogb[l_ac].ogb910 IS NULL) OR   #MOD-7B0243 modify()
      (g_ogb_t.ogb910 <> g_ogb[l_ac].ogb910) THEN                      #MOD-7B0243 modify()
      LET g_change='Y'
   END IF
   IF NOT cl_null(g_ogb[l_ac].ogb910) THEN
      SELECT gfe02 INTO g_buf FROM gfe_file
       WHERE gfe01=g_ogb[l_ac].ogb910
         AND gfeacti='Y'
      IF STATUS THEN
         CALL cl_err3("sel","gfe_file","g_ogb[l_ac].ogb910","",SQLCA.sqlcode,"","",1)  #No.FUN-670008
         RETURN "ogb910"
      END IF
      IF NOT cl_null(g_ogb[l_ac].ogb04) THEN
         SELECT ima31 INTO g_ima31 
           FROM ima_file
          WHERE ima01=g_ogb[l_ac].ogb04
      END IF
      #-----MOD-AC0376---------
      CALL t600_set_origin_field()
      CALL s_du_umfchk(g_ogb[l_ac].ogb04,'','','',
                       g_ogb[l_ac].ogb05,g_ogb[l_ac].ogb910,'1')
           RETURNING g_errno,g_factor
      #CALL s_du_umfchk(g_ogb[l_ac].ogb04,'','','',
      #                 g_ima31,g_ogb[l_ac].ogb910,'1')
      #     RETURNING g_errno,g_factor
      #-----END MOD-AC0376-----
      IF NOT cl_null(g_errno) THEN
         CALL cl_err(g_ogb[l_ac].ogb910,g_errno,0)
         RETURN "ogb910"
      END IF
      IF cl_null(g_ogb_t.ogb910) OR g_ogb_t.ogb910 <> g_ogb[l_ac].ogb910 THEN
         LET g_ogb[l_ac].ogb911 = g_factor
      END IF
      IF g_ogb[l_ac].ogb17='N' AND
         g_ogb[l_ac].ogb04 NOT MATCHES 'MISC*' THEN
         SELECT ima906 INTO g_ima906 FROM ima_file
          WHERE ima01=g_ogb[l_ac].ogb04
         #FUN-C80107 mark begin------------------------------
         #IF g_ima906 = '2' THEN   #No.FUN-540049
         #   CALL s_chk_imgg(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
         #                   g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
         #                   g_ogb[l_ac].ogb910) RETURNING g_flag
         #   IF g_flag = 1 THEN
         #      IF g_oga.oga09 MATCHES '[246]' THEN
         #         CALL cl_err(g_ogb[l_ac].ogb910,'asm-301',0)
         #         RETURN "ogb092"
         #      END IF
         #   END IF
         #END IF
         #FUN-C80107 mark end--------------------------------
         IF g_ima906 = '2' THEN
            SELECT imgg10 INTO g_imgg10_1 FROM imgg_file
             WHERE imgg01=g_ogb[l_ac].ogb04
               AND imgg02=g_ogb[l_ac].ogb09
               AND imgg03=g_ogb[l_ac].ogb091
               AND imgg04=g_ogb[l_ac].ogb092
               AND imgg09=g_ogb[l_ac].ogb910
         ELSE
            SELECT img10 INTO g_imgg10_1 FROM img_file
             WHERE img01=g_ogb[l_ac].ogb04
               AND img02=g_ogb[l_ac].ogb09
               AND img03=g_ogb[l_ac].ogb091
               AND img04=g_ogb[l_ac].ogb092
         END IF
         IF cl_null(g_imgg10_1) THEN LET g_imgg10_1=0 END IF
      END IF
   ELSE
      IF g_oga.oga09 MATCHES '[15]' THEN
         #出貨單位欄位不可空白
         CALL cl_err(g_ogb[l_ac].ogb910,'mfg0037',1)
         RETURN "ogb910"
      END IF
   END IF
   #-----MOD-AC0376---------
   IF g_change='Y' THEN                                                 
      CALL t600_set_ogb917()                                             
   END IF
   #-----END MOD-AC0376-----
   CALL t600_set_required_b1('')
   RETURN NULL
END FUNCTION

FUNCTION t600_bef_ogb911()
   IF cl_null(g_ogb[l_ac].ogb04) THEN RETURN "ogb04" END IF
   IF g_ogb[l_ac].ogb17 = 'N' THEN
      IF g_oga.oga09 MATCHES '[246]' THEN
         IF g_ogb[l_ac].ogb09 IS NULL OR g_ogb[l_ac].ogb091 IS NULL OR
            g_ogb[l_ac].ogb092 IS NULL THEN
            RETURN "ogb092"
         END IF
      END IF
   END IF
   CALL cl_show_fld_cont()     #FUN-550037(smin)
   RETURN NULL
END FUNCTION

FUNCTION t600_chk_ogb911()
   IF (g_ogb_t.ogb911 IS NULL AND g_ogb[l_ac].ogb911 IS NOT NULL) OR #MOD-7B0243 modify()
      (g_ogb_t.ogb911 IS NOT NULL AND g_ogb[l_ac].ogb911 IS NULL) OR #MOD-7B0243 modify()
      (g_ogb_t.ogb911 <> g_ogb[l_ac].ogb911) THEN                    #MOD-7B0243 modify()
      LET g_change='Y'
   END IF
   IF NOT cl_null(g_ogb[l_ac].ogb911) THEN
      IF g_ogb[l_ac].ogb911=0 THEN
         RETURN FALSE
      END IF
   END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_bef_ogb912()
   IF cl_null(g_ogb[l_ac].ogb04) THEN RETURN "ogb04" END IF
   IF g_ogb[l_ac].ogb091 IS NULL THEN LET g_ogb[l_ac].ogb091=' ' END IF
   IF g_ogb[l_ac].ogb092 IS NULL THEN LET g_ogb[l_ac].ogb092=' ' END IF
   IF g_ogb[l_ac].ogb17 = 'N' THEN
      IF g_oga.oga09 MATCHES '[246]' THEN
         IF g_ogb[l_ac].ogb09 IS NULL OR g_ogb[l_ac].ogb091 IS NULL OR
            g_ogb[l_ac].ogb092 IS NULL THEN
            RETURN "ogb092"
         END IF
      END IF
   END IF
   IF NOT cl_null(g_ogb[l_ac].ogb910) THEN
      #FUN-C80107 mark begin------------------------------121024
      #IF g_ogb[l_ac].ogb17='N' AND g_ima906 = '2' AND
      #   g_ogb[l_ac].ogb04 NOT MATCHES 'MISC*' THEN
      #   CALL s_chk_imgg(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
      #                   g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
      #                   g_ogb[l_ac].ogb910) RETURNING g_flag
      #   IF g_flag = 1 THEN
      #      IF g_oga.oga09 MATCHES '[246]' THEN
      #         CALL cl_err(g_ogb[l_ac].ogb910,'asm-301',0)
      #         RETURN "ogb092"
      #      END IF
      #   END IF
      #END IF
      #FUN-C80107 mark end------------------------------
     IF g_ima906 = '2' THEN
        SELECT imgg10 INTO g_imgg10_1 FROM imgg_file
         WHERE imgg01=g_ogb[l_ac].ogb04
           AND imgg02=g_ogb[l_ac].ogb09
           AND imgg03=g_ogb[l_ac].ogb091
           AND imgg04=g_ogb[l_ac].ogb092
           AND imgg09=g_ogb[l_ac].ogb910
     ELSE
        SELECT img10 INTO g_imgg10_1 FROM img_file
         WHERE img01=g_ogb[l_ac].ogb04
           AND img02=g_ogb[l_ac].ogb09
           AND img03=g_ogb[l_ac].ogb091
           AND img04=g_ogb[l_ac].ogb092
     END IF
     IF cl_null(g_imgg10_1) THEN LET g_imgg10_1=0 END IF
     #end
   END IF
   RETURN NULL
END FUNCTION

FUNCTION t600_chk_ogb912()
   DEFINE l_qty LIKE ogb_file.ogb12
   DEFINE l_ogb12a LIKE ogb_file.ogb12
   DEFINE l_ogb12b LIKE ogb_file.ogb12
   DEFINE l_ogb12c LIKE ogb_file.ogb12   #MOD-A50076
   DEFINE l_oeb25  LIKE oeb_file.oeb25

   IF (g_ogb_t.ogb912 IS NULL AND g_ogb[l_ac].ogb912 IS NOT NULL) OR #MOD-7B0243 modify()
      (g_ogb_t.ogb912 IS NOT NULL AND g_ogb[l_ac].ogb912 IS NULL) OR #MOD-7B0243 modify()
      (g_ogb_t.ogb912 <> g_ogb[l_ac].ogb912) THEN                    #MOD-7B0243 modify()
      LET g_change='Y'
   END IF
   CALL t600_set_origin_field()   #MOD-960046
   IF NOT cl_null(g_ogb[l_ac].ogb912) THEN
      IF g_ogb[l_ac].ogb912 <=0 THEN    #No:MOD-5B0113 By No.FUN-610064
         IF g_ima906 != '2' OR       #TQC-640151(3)          #MOD-740479 modify
            (g_ima906='2' AND g_ogb[l_ac].ogb912 < 0 )THEN   #MOD-740479
           IF (g_ogb[l_ac].ogb912 < 0 ) OR 
              (g_ogb[l_ac].ogb912 = 0 AND  g_argv0 <> '8') THEN
              CALL cl_err('','mfg9243',0)   #No:MOD-5B0113
              RETURN "ogb912"
           END IF 
         END IF                        #TQC-640151(3)
      END IF
      IF g_oga.oga09 MATCHES '[2468]' THEN  #No.FUN-630061
         IF g_sma.sma117 = 'N' THEN
            IF g_ogb[l_ac].ogb17 = 'N' THEN   #MOD-890274
               IF g_ima906 = '2' THEN
                  IF g_ogb[l_ac].ogb912 > g_imgg10_1 THEN
                     IF g_sma.sma894[2,2]='N' OR g_sma.sma894[2,2] IS NULL THEN
                        CALL cl_err(g_ogb[l_ac].ogb912,'mfg1303',1)
                        RETURN "ogb912"
                     ELSE
                        IF NOT cl_confirm('mfg3469') THEN
                           RETURN "ogb912"
                        ELSE
                           LET g_yes = 'Y'
                        END IF
                     END IF
                  END IF
               ELSE
                  #IF g_ogb[l_ac].ogb12 * b_ogb.ogb05_fac > g_imgg10_1 THEN   #MOD-A70059
                  IF g_ogb[l_ac].ogb12 * b_ogb.ogb15_fac > g_imgg10_1 THEN   #MOD-A70059
                     IF g_sma.sma894[2,2]='N' OR g_sma.sma894[2,2] IS NULL THEN
                        CALL cl_err(g_ogb[l_ac].ogb912,'mfg1303',1)
                        RETURN "ogb912"
                     ELSE
                        IF NOT cl_confirm('mfg3469') THEN
                           RETURN "ogb912"
                        ELSE
                           LET g_yes = 'Y'
                        END IF
                     END IF
                  END IF
               END IF
            END IF   #MOD-890274
         END IF
      END IF
   ELSE
      IF g_oga.oga09 MATCHES '[15]' THEN
         #出貨數量欄位不可空白
         CALL cl_err(g_ogb[l_ac].ogb912,'mfg0037',1)
         RETURN "ogb912"
      END IF
   END IF
   #check with origin field
   IF NOT cl_null(g_ogb[l_ac].ogb12) THEN
      IF g_ogb[l_ac].ogb12 <= 0 THEN
         IF g_ima906 MATCHES '[23]' THEN
            RETURN "ogb915"
         ELSE
            RETURN "ogb912"
         END IF
      END IF
      IF g_argv0 MATCHES '[2468]' AND NOT cl_null(g_oga.oga011) THEN#7992  #No.FUN-630061
         IF g_argv0 = '8' THEN
           IF NOT cl_null(g_oga.oga16) THEN #有訂單出貨單轉簽收 FUN-C50097 ADD cl_null(g_oga.oga16)
            LET l_ogb12a = 0
            SELECT SUM(ogb12) INTO l_ogb12a FROM ogb_file,oga_file
             WHERE ogb01 = oga01 AND oga09 ='2' AND oga65='Y'
               AND oga01 = g_oga.oga011
               AND ogb31 = g_ogb[l_ac].ogb31
               AND ogb32 = g_ogb[l_ac].ogb32
               AND ogb04 = g_ogb[l_ac].ogb04 #BugNo:4541
               AND ogaconf = 'Y' AND ogapost='Y'
            IF cl_null(l_ogb12a) THEN LET l_ogb12a = 0 END IF
            LET l_ogb12b = 0
            SELECT SUM(ogb12) INTO l_ogb12b FROM ogb_file,oga_file
             WHERE ogb01 = oga01 AND oga09 ='8'
               AND oga011 = g_oga.oga011
               AND ogb31 = g_ogb[l_ac].ogb31
               AND ogb32 = g_ogb[l_ac].ogb32
               AND ogb04 = g_ogb[l_ac].ogb04 #no.7168
               AND ogaconf !='X'
            IF cl_null(l_ogb12b) THEN LET l_ogb12b = 0 END IF
            LET l_ogb12b = l_ogb12b - g_ogb_t.ogb12
                         + g_ogb[l_ac].ogb12
            IF l_ogb12b > l_ogb12a THEN
               CALL cl_err('sel ogb(1):','axm-426',0)
               IF g_ima906 MATCHES '[23]' THEN
                  RETURN "ogb915"
               ELSE
                  RETURN "ogb912"
               END IF
            END IF
          ELSE #無訂單出貨單轉簽收,單頭和單身均沒有訂單號碼和項次 FUN-C50097 ADD BEG-----
               LET l_ogb12a = 0
               SELECT SUM(ogb12) INTO l_ogb12a FROM ogb_file,oga_file
                WHERE ogb01 = oga01 AND oga09 ='2' AND oga65='Y'
                  AND oga01 = g_oga.oga011
                  #AND ogb31 = g_ogb[l_ac].ogb31
                  #AND ogb32 = g_ogb[l_ac].ogb32
                  AND ogb04 = g_ogb[l_ac].ogb04 #BugNo:4541
                  AND ogaconf = 'Y' AND ogapost='Y'
               IF cl_null(l_ogb12a) THEN LET l_ogb12a = 0 END IF
               LET l_ogb12b = 0
               SELECT SUM(ogb12) INTO l_ogb12b FROM ogb_file,oga_file
               #WHERE ogb01 = oga01 AND oga09 ='8'                  #FUN-C40072 mark
                WHERE ogb01 = oga01 AND (oga09 ='2' OR oga09 = '4') #FUN-C40072 add
                  AND oga011 = g_oga.oga011
                  #AND ogb31 = g_ogb[l_ac].ogb31
                  #AND ogb32 = g_ogb[l_ac].ogb32
                  AND ogb04 = g_ogb[l_ac].ogb04 #no.7168
                  AND ogaconf !='X'
               IF cl_null(l_ogb12b) THEN LET l_ogb12b = 0 END IF
               LET l_ogb12b = l_ogb12b - g_ogb_t.ogb12
                            + g_ogb[l_ac].ogb12
               IF l_ogb12b > l_ogb12a THEN
                  CALL cl_err('sel ogb(1):','axm-426',0)
                  IF g_ima906 MATCHES '[23]' THEN
                     RETURN "ogb915"
                  ELSE
                     RETURN "ogb912"
                  END IF
               END IF               
            END IF 	
            #FUN-C50097 ADD END-----  
         ELSE
         #檢查出貨數必須<=通知單應出數(ogb12)-累計出貨數(ogb19)
         #對應到的出貨通知單上的數量
         LET l_ogb12a = 0
#FUN-A60035 ---MARK BEGIN
##FUN-A60035 --Begin
#&ifdef SLK
#        SELECT SUM(ogb12) INTO l_ogb12a FROM ogb_file,oga_file,ata_file
#         WHERE ogb01=oga01 AND oga09 IN ('1','5')
#           AND oga01 = g_oga.oga011
#           AND ogb31 = g_ogb[l_ac].ogb31
#           AND ogb04 = ata04
#           AND ogaconf != 'X'
#           AND ogb32 = ata03
#           AND ata00 = g_prog
#           AND ata01 = oga01
#           AND ata02 = g_ogb[l_ac].ogb32
#           AND ata05 = g_ogb[l_ac].ogb04
#&else
##FUN-A60035 --End
#FUN-A60035 ---MARK END
         SELECT SUM(ogb12) INTO l_ogb12a FROM ogb_file,oga_file
          WHERE ogb01 = oga01 AND oga09 IN ('1','5')    #No.7992
            AND oga01 = g_oga.oga011
            AND ogb31 = g_ogb[l_ac].ogb31
            AND ogb32 = g_ogb[l_ac].ogb32
            AND ogb04 = g_ogb[l_ac].ogb04 #BugNo:4541
            AND ogaconf != 'X'  #CHI-6B0036
#FUN-A60035 ---MARK BEGIN
##FUN-A60035 --Begin
#&endif
##FUN-A60035 --End
#FUN-A60035 ---MARK END
         IF cl_null(l_ogb12a) THEN LET l_ogb12a = 0 END IF

         # 此出貨通知單已耗用在出貨單的量
         LET l_ogb12b = 0
#FUN-A60035 ---MARK BEGIN
##FUN-A60035 --Begin
#&ifdef SLK
#        SELECT SUM(ogb12) INTO l_ogb12b FROM ogb_file,oga_file,ata_file
#         WHERE ogb01 = oga01 AND oga09 IN ('2','4','6')
#           AND oga011 = g_oga.oga011
#           AND ogb31 = g_ogb[l_ac].ogb31
#           AND ogb32 = ata03
#           AND ogb04 = ata04
#           AND ogaconf !='X'
#           AND ata00 = g_prog
#           AND ata01 = g_oga.oga01
#           AND ata02 = g_ogb[l_ac].ogb32
#           AND ata05 = g_ogb[l_ac].ogb04
#&else
##FUN-A60035 --End
#FUN-A60035 ---MARK END
         SELECT SUM(ogb12) INTO l_ogb12b FROM ogb_file,oga_file
          WHERE ogb01 = oga01 AND oga09 IN ('2','4','6')   #No.7992  #No.FUN-630061
            AND oga011 = g_oga.oga011
            AND ogb31 = g_ogb[l_ac].ogb31
            AND ogb32 = g_ogb[l_ac].ogb32
            AND ogb04 = g_ogb[l_ac].ogb04 #no.7168
            AND ogaconf !='X'
#FUN-A60035 ---MARK BEGIN
##FUN-A60035 --Begin
#&endif
##FUN-A60035 --End
#FUN-A60035 ---MARK END
         IF cl_null(l_ogb12b) THEN LET l_ogb12b = 0 END IF
         LET l_ogb12b = l_ogb12b - g_ogb_t.ogb12
                      + g_ogb[l_ac].ogb12
         IF l_ogb12b > l_ogb12a THEN
            CALL cl_err('sel ogb(1):','axm-128',0)
            IF g_ima906 MATCHES '[23]' THEN
               RETURN "ogb915"
            ELSE
               RETURN "ogb912"
            END IF
         END IF
         END IF  #No.FUN-630061
      ELSE
         #檢查出貨通知單量必須<=訂單數量(ogb12)
         IF NOT t600sub_chkoeo(g_ogb[l_ac].ogb31,
            g_ogb[l_ac].ogb32,g_ogb[l_ac].ogb04) THEN #no.7168
            SELECT oeb12,oeb25 INTO l_ogb12a,l_oeb25
              FROM oeb_file ,oea_file
             WHERE oeb01 = g_ogb[l_ac].ogb31
               AND oeb03 = g_ogb[l_ac].ogb32
               AND oeaconf = 'Y' AND oea01 = oeb01
            IF cl_null(l_ogb12a) THEN LET l_ogb12a = 0 END IF
            IF g_oea.oea37 = "Y" THEN   #No:FUN-640025
               SELECT oee083 INTO g_oee083 FROM oee_file
                WHERE oee10 = g_ogb[l_ac].ogb31                                                                              
                  AND oee11 = g_ogb[l_ac].ogb32                                                                              
               IF cl_null(g_oee083) THEN
                  LET g_oee083 = 0
               END IF
            END IF
         ELSE
            SELECT oeo09 INTO l_ogb12a FROM oeo_file
             WHERE oeo01 = g_ogb[l_ac].ogb31
               AND oeo03 = g_ogb[l_ac].ogb32
               AND oeo04 = g_ogb[l_ac].ogb04
               AND oeo08 = '2'
            IF cl_null(l_ogb12a) THEN LET l_ogb12a = 0  END IF
            LET l_oeb25 = 0
         END IF
         # 此訂單已耗用在出貨通知單的量
         LET l_ogb12b = 0
         SELECT SUM(ogb12) INTO l_ogb12b FROM ogb_file,oga_file
          WHERE ogb01 = oga01
            AND oga09 = g_argv0
            AND ogb31 = g_ogb[l_ac].ogb31     #訂單單號
            AND ogb32 = g_ogb[l_ac].ogb32     #訂單項次
            AND ogb04 = g_ogb[l_ac].ogb04     #no.7168
            AND ogaconf !='X'
         IF cl_null(l_ogb12b) THEN LET l_ogb12b = 0 END IF
         LET g_ogb_t.ogb12 = 0
         SELECT ogb12 INTO g_ogb_t.ogb12 FROM ogb_file
          WHERE ogb01=g_oga.oga01
            AND ogb31 = g_ogb[l_ac].ogb31
            AND ogb32 = g_ogb[l_ac].ogb32
            AND ogb04 = g_ogb[l_ac].ogb04     #no.7168
            AND g_oga.ogaconf !='X'
         IF cl_null(g_ogb_t.ogb12) THEN LET g_ogb_t.ogb12 = 0 END IF
         LET l_ogb12b = l_ogb12b - g_ogb_t.ogb12
                      + g_ogb[l_ac].ogb12

         IF NOT cl_null(g_ogb[l_ac].ogb31) AND #訂單單號
            g_ogb[l_ac].ogb31[1,4] !='MISC' THEN
            SELECT * INTO g_oea.* FROM oea_file WHERE oea01=g_ogb[l_ac].ogb31  #MOD-850029 add
            IF cl_null(g_oea.oea09) THEN LET g_oea.oea09=0 END IF
            #-----MOD-A50076---------
            LET l_ogb12c = 0
            SELECT SUM(ogb12) INTO l_ogb12c FROM ogb_file,oga_file
             WHERE ogb01 = oga01     
               AND ogb31 = g_ogb[l_ac].ogb31
               AND ogb32 = g_ogb[l_ac].ogb32
               AND oga09 = '9'
               AND ogaconf = 'Y'
               AND ogapost = 'Y'
            IF cl_null(l_ogb12c) THEN LET l_ogb12c=0 END IF
            #-----END MOD-A50076-----
            IF cl_null(l_oeb25) THEN LET l_oeb25=0 END IF
            LET l_ogb12a=l_ogb12a*((100+g_oea.oea09)/100) #可超交
                         +l_oeb25       #已銷退數量(須再換貨出貨)
                         +l_ogb12c      #簽收驗退量   #MOD-A50076
           IF g_oea.oea37 = "Y" THEN
              IF l_ogb12b > g_oee083 THEN
                 CALL cl_err('','axm-038',0)
                 IF g_ima906 MATCHES '[23]' THEN
                    RETURN "ogb915"
                 ELSE
                    RETURN "ogb912"
                 END IF
              END IF
           ELSE
              IF l_ogb12b > l_ogb12a THEN
                 CALL cl_err('','axm-126',0)
                 IF g_ima906 MATCHES '[23]' THEN
                    RETURN "ogb915"
                 ELSE
                    RETURN "ogb912"
                 END IF
              END IF
           END IF
         END IF
      END IF

   END IF
   IF g_ogb[l_ac].ogb17 = 'N' THEN   #MOD-890274
      IF g_ogb[l_ac].ogb12 > l_qty THEN
         IF g_yes = 'N' THEN
            LET g_flag2 = NULL    #FUN-C80107 add
            CALL s_inv_shrt_by_warehouse(g_sma.sma894[2,2],g_ogb[l_ac].ogb09) RETURNING g_flag2   #FUN-C80107 add
            #IF g_sma.sma894[2,2]='N' OR g_sma.sma894[2,2] IS NULL THEN   #FUN-C80107 mark
            IF g_flag2 = 'N' OR g_flag2 IS NULL THEN           #FUN-C80107 add
               CALL cl_err(g_ogb[l_ac].ogb12,'axm-280',1)
               IF g_ima906 MATCHES '[23]' THEN
                  RETURN "ogb915"
               ELSE
                  RETURN "ogb912"
               END IF
            ELSE
               IF NOT cl_confirm('mfg3469') THEN
                  IF g_ima906 MATCHES '[23]' THEN
                     RETURN "ogb915"
                  ELSE
                     RETURN "ogb912"
                  END IF
               END IF
            END IF
         END IF
      END IF
   END IF   #MOD-890274
   IF g_change='Y' THEN                                                 
      CALL t600_set_ogb917()                                             
   END IF
   IF g_argv0 = '8' THEN
      SELECT ogb912 INTO g_ogb912_sum FROM ogb_file
       WHERE ogb01 = g_oga.oga011
         AND ogb03 = g_ogb[l_ac].ogb03
      LET g_ogb[l_ac].ogb912b = g_ogb912_sum - g_ogb[l_ac].ogb912
      DISPLAY BY NAME g_ogb[l_ac].ogb912b
   END IF
   CALL cl_show_fld_cont()     #FUN-550037(smin)
   RETURN NULL
END FUNCTION

FUNCTION t600_chk_ogb916(p_cmd)        #FUN-AC0012 Add p_cmd
 DEFINE p_cmd LIKE type_file.chr1      #FUN-AC0012
 DEFINE l_fac LIKE ogb_file.ogb15_fac

   IF cl_null(g_ogb[l_ac].ogb04) THEN RETURN "ogb04" END IF
   IF (g_ogb_t.ogb916 IS NULL AND g_ogb[l_ac].ogb916 IS NOT NULL) OR #MOD-7B0243 modify()
      (g_ogb_t.ogb916 IS NOT NULL AND g_ogb[l_ac].ogb916 IS NULL) OR #MOD-7B0243 modify()
      (g_ogb_t.ogb916 <> g_ogb[l_ac].ogb916) THEN                    #MOD-7B0243 modify()
      LET g_change='Y'
   END IF
   IF NOT cl_null(g_ogb[l_ac].ogb916) THEN
      SELECT gfe02 INTO g_buf FROM gfe_file
       WHERE gfe01=g_ogb[l_ac].ogb916
         AND gfeacti='Y'
      IF STATUS THEN
         CALL cl_err3("sel","gfe_file",g_ogb[l_ac].ogb916,"",SQLCA.sqlcode,"","gfe:",1)  #No.FUN-670008
         RETURN "ogb916"
      END IF
      IF NOT cl_null(g_ogb[l_ac].ogb04) THEN
         SELECT ima25 INTO g_ima25 
           FROM ima_file
          WHERE ima01=g_ogb[l_ac].ogb04
      END IF
      CALL s_du_umfchk(g_ogb[l_ac].ogb04,'','','',
                       g_ima25,g_ogb[l_ac].ogb916,'1')
           RETURNING g_errno,g_factor
      IF NOT cl_null(g_errno) THEN
         CALL cl_err(g_ogb[l_ac].ogb916,g_errno,0)
         RETURN "ogb916"
      END IF
      IF NOT cl_null(g_ogb[l_ac].ogb04) THEN
         IF (g_ogb_t.ogb916 IS NULL OR g_ogb_t.ogb916 <> g_ogb[l_ac].ogb916) AND g_aza.aza50 ='Y' THEN    #No.FUN-670008 
            IF g_change='Y' THEN
               CALL t600_set_ogb917()
            END IF
            IF cl_null(g_ogb[l_ac].ogb31) AND cl_null(g_ogb[l_ac].ogb32) THEN    #MOD-B60052
           #CALL t600_price(l_ac) RETURNING l_fac       #FUN-AC0012
               CALL t600_price(p_cmd,l_ac) RETURNING l_fac #FUN-AC0012
            END IF                                                               #MOD-B60052
         END IF
      END IF
   END IF
   CALL t600_set_required_b1('')
   RETURN NULL
END FUNCTION

FUNCTION t600_chk_ogb908()
   DEFINE l_coc10 LIKE coc_file.coc10

   IF NOT cl_null(g_ogb[l_ac].ogb908) THEN
      SELECT coc10 INTO l_coc10 FROM coc_file
       WHERE coc03 = g_ogb[l_ac].ogb908
      IF STATUS THEN
         CALL cl_err3("sel","coc_file",g_ogb[l_ac].ogb908,"","aco-062","","",1)  #No.FUN-670008
         RETURN FALSE
      END IF
      LET g_cnt=0
      SELECT COUNT(*) INTO g_cnt FROM coc_file,cod_file,coa_file
       WHERE coc01 = cod01 AND cod03 = coa03
         AND coa05 = l_coc10
         AND coa01 = g_ogb[l_ac].ogb04
         AND coc03 = g_ogb[l_ac].ogb908
      IF g_cnt = 0 THEN
         CALL cl_err(g_ogb[l_ac].ogb908,'aco-073',0)
         RETURN FALSE
      END IF
   END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_b1_delchk()
   DEFINE l_qty LIKE omb_file.omb12

## 要update 出貨數量應不可小於AR立帳數量(sum(omb12) -------
                SELECT SUM(omb12) INTO l_qty FROM oma_file,omb_file
                 WHERE omb31 = g_oga.oga01
                   AND omb32 = g_ogb[l_ac].ogb03
                   AND omb01 = oma01
                   AND omavoid = 'N'
                IF l_qty>0 THEN #AR立帳數量>0
                   CALL cl_err('','axm-302',0)
                   RETURN FALSE
                END IF
## ---------------------------------------------------------
   RETURN TRUE
END FUNCTION

FUNCTION t600_b1_del()

#FUN-A60035 ---MARK BEGIN
##FUN-A50054 --Begin
#&ifdef SLK
##  IF s_industry("slk") THEN
#     DELETE FROM ogb_file
#      WHERE ogb01 = g_oga.oga01 AND ogb03 IN 
#     (SELECT ata03 FROM ata_file 
#      WHERE ata00 = g_prog
#        AND ata01 = g_oga.oga01
#        AND ata02 = g_ogb[l_ac].ogb03) 
#     IF SQLCA.sqlcode THEN
#        CALL cl_err3("del","ogb_file",g_oga.oga01,g_ogb_t.ogb03,SQLCA.sqlcode,"","",1)
#     ELSE
#        DELETE FROM ogc_file
#         WHERE ogc01 = g_oga.oga01 AND ogc03 IN 
#       (SELECT ata03 FROM ata_file 
#         WHERE ata00 = g_prog
#           AND ata01 = g_oga.oga01
#           AND ata02 = g_ogb[l_ac].ogb03)
#        DELETE FROM rvbs_file
#         WHERE rvbs01 = g_oga.oga01
#           AND rvbs02 IN
#       (SELECT ata03 FROM ata_file
#         WHERE ata00 = g_prog
#           AND ata01 = g_oga.oga01
#           AND ata02 = g_ogb[l_ac].ogb03)
#        DELETE FROM ogg_file
#         WHERE ogg01 = g_oga.oga01
#           AND ogg03 IN
#       (SELECT ata03 FROM ata_file
#         WHERE ata00 = g_prog
#           AND ata01 = g_oga.oga01
#           AND ata02 = g_ogb[l_ac].ogb03)
#        DELETE FROM ogbb_file
#         WHERE ogbb01 = g_oga.oga01
#           AND ogbb012 IN
#       (SELECT ata03 FROM ata_file
#         WHERE ata00 = g_prog
#           AND ata01 = g_oga.oga01
#           AND ata02 = g_ogb[l_ac].ogb03)
#        DELETE FROM oao_file
#         WHERE oao01 = g_oga.oga01
#           AND oao012 IN
#       (SELECT ata03 FROM ata_file
#         WHERE ata00 = g_prog
#           AND ata01 = g_oga.oga01
#           AND ata02 = g_ogb[l_ac].ogb03)
#        DELETE FROM ata_file
#         WHERE ata00 = g_prog
#           AND ata01 = g_oga.oga01
#           AND ata02 = g_ogb[l_ac].ogb03
#     END IF
##  ELSE
#&else
##FUN-A50054 --End
#FUN-A60035 ---MARK END
   DELETE FROM ogb_file
    WHERE ogb01 = g_oga.oga01 AND ogb03 = g_ogb_t.ogb03
   IF SQLCA.sqlcode THEN
      CALL cl_err3("del","ogb_file",g_oga.oga01,g_ogb_t.ogb03,SQLCA.sqlcode,"","",1)  #No.FUN-670008
   END IF
     #FUN-AC0012 Begin---
       DELETE FROM rxc_file
        WHERE rxc00='02'
          AND rxc01=g_oga.oga01
          AND rxc02=g_ogb_t.ogb03
     #FUN-AC0012 End-----
      DELETE FROM ogc_file
       WHERE ogc01 = g_oga.oga01 AND ogc03 = g_ogb_t.ogb03
      DELETE FROM rvbs_file
       WHERE rvbs01 = g_oga.oga01
         AND rvbs02 = g_ogb_t.ogb03
      DELETE FROM ogg_file
       WHERE ogg01 = g_oga.oga01 AND ogg03 = g_ogb_t.ogb03

      DELETE FROM ogbb_file
       WHERE ogbb01 = g_oga.oga01
         AND ogbb012 = g_ogb_t.ogb03

       DELETE FROM oao_file
        WHERE oao01=g_oga.oga01
          AND oao03=g_ogb[l_ac].ogb03
          
#FUN-A60035 ---MARK BEGIN
#&endif
##END IF  #FUN-A50054 add
#FUN-A60035 ---MARK END

      CALL t600_mlog('R')
      CALL t600_bu()   #MOD-520034
      RETURN TRUE

END FUNCTION

FUNCTION t600_b1_updchk()
   IF g_ogb[l_ac].ogb1005!='2' THEN   #No.FUN-610064
      IF g_sma.sma115= 'Y' THEN
         IF NOT cl_null(g_ogb[l_ac].ogb04) THEN
            SELECT ima25,ima31 INTO g_ima25,g_ima31
              FROM ima_file WHERE ima01=g_ogb[l_ac].ogb04
         END IF

         CALL s_chk_va_setting(g_ogb[l_ac].ogb04)
              RETURNING g_flag,g_ima906,g_ima907
         IF g_flag=1 THEN
            RETURN "ogb03"	#MOD-970092
         END IF

         CALL s_chk_va_setting1(g_ogb[l_ac].ogb04)
              RETURNING g_flag,g_ima908
         IF g_flag=1 THEN
            RETURN "ogb03"	#MOD-970092
         END IF

         CALL t600_du_data_to_correct()
         IF g_ogb[l_ac].ogb17='N' THEN
            SELECT img09 INTO g_img09 FROM img_file
             WHERE img01=g_ogb[l_ac].ogb04
               AND img02=g_ogb[l_ac].ogb09
               AND img03=g_ogb[l_ac].ogb091
               AND img04=g_ogb[l_ac].ogb092
            #IF cl_null(g_img09) THEN  #FUN-C80107 mark 121024
            IF SQLCA.sqlcode=100 OR cl_null(g_img09) THEN #FUN-C80107 add 121024
               IF g_oga.oga09 MATCHES '[246]' THEN
                 #FUN-C80107 modify begin----------------------------121024
                 #CALL cl_err(g_ogb[l_ac].ogb04,'mfg6069',0)
                 #RETURN "ogb03"        #MOD-970092
                  LET g_flag2 = NULL
                  CALL s_inv_shrt_by_warehouse(g_sma.sma894[2,2],g_ogb[l_ac].ogb09) RETURNING g_flag2
                  IF g_flag2 = 'N' OR g_flag2 IS NULL THEN
                     CALL cl_err(g_ogb[l_ac].ogb04,'mfg6069',0)
                     RETURN "ogb03"
                  ELSE
                     IF g_sma.sma892[3,3] = 'Y' THEN
                        IF g_bgjob='N' OR cl_null(g_bgjob) THEN
                           IF NOT cl_confirm('mfg1401') THEN
                              RETURN "ogb03"
                           END IF
                        END IF
                     END IF
                     CALL s_add_img(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                                    g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                                    g_oga.oga01,g_ogb[l_ac].ogb03,g_oga.oga02)
                     IF g_errno='N' THEN
                        RETURN "ogb03"
                     END IF
                     SELECT img09 INTO g_img09 FROM img_file
                      WHERE img01=g_ogb[l_ac].ogb04
                        AND img02=g_ogb[l_ac].ogb09
                        AND img03=g_ogb[l_ac].ogb091
                        AND img04=g_ogb[l_ac].ogb092
                  END IF
                 #FUN-C80107 modify end ----------------------------
               END IF
            END IF
            #FUN-C80107 add begin--------------------------------------------121024
            IF NOT cl_null(g_ogb[l_ac].ogb913) THEN
               IF g_ogb[l_ac].ogb04 NOT MATCHES 'MISC*' THEN
                  CALL s_chk_imgg(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                                  g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                                  g_ogb[l_ac].ogb913) RETURNING g_flag
                  IF g_flag = 1 THEN
                     IF g_oga.oga09 MATCHES '[246]' THEN
                        LET g_flag2 = NULL
                        CALL s_inv_shrt_by_warehouse(g_sma.sma894[2,2],g_ogb[l_ac].ogb09) RETURNING g_flag2
                        IF g_flag2 = 'N' OR g_flag2 IS NULL THEN
                           CALL cl_err(g_ogb[l_ac].ogb913,'asm-301',0)
                           RETURN "ogb092"
                        ELSE
                           IF g_sma.sma892[3,3] = 'Y' THEN
                              IF g_bgjob='N' OR cl_null(g_bgjob) THEN
                                 IF NOT cl_confirm('aim-995') THEN
                                    RETURN "ogb092"
                                 END IF
                              END IF
                           END IF
                           CALL s_add_imgg(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                                           g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                                           g_ogb[l_ac].ogb913,g_ogb[l_ac].ogb914,
                                           g_oga.oga01,g_ogb[l_ac].ogb03,0)
                                 RETURNING g_flag
                           IF g_flag = 1 THEN
                              RETURN "ogb092"
                           END IF
                        END IF
                     END IF
                  END IF
               END IF
               SELECT imgg10 INTO g_imgg10_2 FROM imgg_file
                WHERE imgg01=g_ogb[l_ac].ogb04
                  AND imgg02=g_ogb[l_ac].ogb09
                  AND imgg03=g_ogb[l_ac].ogb091
                  AND imgg04=g_ogb[l_ac].ogb092
                  AND imgg09=g_ogb[l_ac].ogb913
               IF cl_null(g_imgg10_2) THEN LET g_imgg10_2=0 END IF
            END IF
            IF NOT cl_null(g_ogb[l_ac].ogb910) THEN
               IF g_ogb[l_ac].ogb04 NOT MATCHES 'MISC*' THEN
                  SELECT ima906 INTO g_ima906 FROM ima_file
                   WHERE ima01=g_ogb[l_ac].ogb04
                  IF g_ima906 = '2' THEN
                     CALL s_chk_imgg(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                                     g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                                     g_ogb[l_ac].ogb910) RETURNING g_flag
                     IF g_flag = 1 THEN
                        IF g_oga.oga09 MATCHES '[246]' THEN
                           LET g_flag2 = NULL
                           CALL s_inv_shrt_by_warehouse(g_sma.sma894[2,2],g_ogb[l_ac].ogb09) RETURNING g_flag2
                           IF g_flag2 = 'N' OR g_flag2 IS NULL THEN
                              CALL cl_err(g_ogb[l_ac].ogb910,'asm-301',0)
                              RETURN "ogb092"
                           ELSE
                              IF g_sma.sma892[3,3] = 'Y' THEN
                                 IF g_bgjob='N' OR cl_null(g_bgjob) THEN
                                    IF NOT cl_confirm('aim-995') THEN
                                       RETURN "ogb092"
                                    END IF
                                 END IF
                              END IF
                              CALL s_add_imgg(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                                              g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                                              g_ogb[l_ac].ogb910,g_ogb[l_ac].ogb911,
                                              g_oga.oga01,g_ogb[l_ac].ogb03,0)
                                    RETURNING g_flag
                              IF g_flag = 1 THEN
                                 RETURN "ogb092"
                              END IF
                           END IF
                        END IF
                     END IF
                  END IF
                  IF g_ima906 = '2' THEN
                     SELECT imgg10 INTO g_imgg10_1 FROM imgg_file
                      WHERE imgg01=g_ogb[l_ac].ogb04
                        AND imgg02=g_ogb[l_ac].ogb09
                        AND imgg03=g_ogb[l_ac].ogb091
                        AND imgg04=g_ogb[l_ac].ogb092
                        AND imgg09=g_ogb[l_ac].ogb910
                  ELSE
                     SELECT img10 INTO g_imgg10_1 FROM img_file
                      WHERE img01=g_ogb[l_ac].ogb04
                        AND img02=g_ogb[l_ac].ogb09
                        AND img03=g_ogb[l_ac].ogb091
                        AND img04=g_ogb[l_ac].ogb092
                  END IF
                  IF cl_null(g_imgg10_1) THEN LET g_imgg10_1=0 END IF
               END IF
            END IF
            #FUN-C80107 add end----------------------------------------------
         END IF
         CALL t600_set_origin_field()
      END IF
      IF cl_null(g_ogb[l_ac].ogb916) THEN
         LET g_ogb[l_ac].ogb916 = g_ogb[l_ac].ogb05
         LET g_ogb[l_ac].ogb917 = g_ogb[l_ac].ogb12
      END IF
   END IF     #No.FUN-610064

  #start FUN-640031 add 儲位、批號若沒有輸入,則給於' '
   IF cl_null(g_ogb[l_ac].ogb091) THEN
      LET g_ogb[l_ac].ogb091 = ' '
   END IF
   IF cl_null(g_ogb[l_ac].ogb092) THEN
      LET g_ogb[l_ac].ogb092 = ' '
   END IF

   IF g_argv0 = '8' AND g_aza.aza26 != '2' THEN #FUN-C50097 add !=2  
      SELECT ogb12 INTO g_ogb12_sum FROM ogb_file
       WHERE ogb01 = g_oga.oga011
         AND ogb03 = g_ogb[l_ac].ogb03
      IF g_ogb[l_ac].ogb12 <> g_ogb12_sum THEN
         IF cl_null(g_ogb[l_ac].ogb65) THEN
            CALL cl_err(g_ogb[l_ac].ogb04,'axm-416',0)
            RETURN "ogb65"
         END IF
      END IF
   END IF
##FUN-C50097 add beg-----
   IF g_argv0 = '8' AND g_aza.aza26 = '2' THEN 
      IF  g_oaz.oaz94 = 'Y' THEN 
#         IF g_ogb[l_ac].ogb52 >0 AND cl_null(g_ogb[l_ac].ogb65) THEN #TQC-C70206
#            CALL cl_err(g_ogb[l_ac].ogb04,'axm-416',0)
#            RETURN "ogb65"
#         END IF         
      ELSE 
         SELECT ogb12 INTO g_ogb12_sum FROM ogb_file
          WHERE ogb01 = g_oga.oga011
            AND ogb03 = g_ogb[l_ac].ogb03
         IF g_ogb[l_ac].ogb12 <> g_ogb12_sum THEN
            IF cl_null(g_ogb[l_ac].ogb65) THEN
               CALL cl_err(g_ogb[l_ac].ogb04,'axm-416',0)
               RETURN "ogb65"
            END IF
         END IF
      END IF    
   END IF
##FUN-C50097 add end-----   
   RETURN NULL
END FUNCTION

FUNCTION t600_b1_upd()
#FUN-A60035 ---MARK BEGIN
#  #FUN-A50054 --Begin
#  DEFINE l_sql        LIKE type_file.chr1000
#  DEFINE l_ata RECORD LIKE ata_file.*
#  DEFINE l_ogb32      LIKE ogb_file.ogb32    #FUN-A60035
#FUN-A60035 ---MARK END

#FUN-A60035 ---MARK BEGIN
#&ifdef SLK
##IF s_industry("slk") THEN
#  LET l_ogb32 = b_ogb.ogb32   #FUN-A60035
#  DELETE FROM ogb_file WHERE ogb01=g_oga.oga01
#     AND ogb03 NOT IN
#  ( SELECT ata03 FROM ata_file
#    WHERE ata00=g_prog
#      AND ata01=g_oga.oga01)
#  DELETE FROM ogb_file WHERE ogb01=g_oga.oga01
#     AND ogb03 IN
#  ( SELECT ata03 FROM ata_file
#    WHERE ata00=g_prog
#      AND ata02=g_ogb[l_ac].ogb03
#      AND ata01=g_oga.oga01)
#  DELETE FROM ogbi_file WHERE ogbi01=g_oga.oga01
#     AND ogbi03 NOT IN
#  ( SELECT ata03 FROM ata_file
#    WHERE ata00=g_prog
#      AND ata01=g_oga.oga01)
#  DELETE FROM ogbi_file 
#   WHERE ogbi01=g_oga.oga01
#     AND ogbi03 IN
#  ( SELECT ata03 FROM ata_file
#    WHERE ata00=g_prog
#      AND ata02=g_ogb[l_ac].ogb03
#      AND ata01=g_oga.oga01)
#   LET l_sql = " SELECT * FROM ata_file ",
#               "  WHERE ata00 = '",g_prog,"'",
#               "    AND ata01 = '",g_oga.oga01,"'",
#               "    AND ata02 = '",g_ogb_t.ogb03,"'"
#   DECLARE t400_ata_curs1 SCROLL CURSOR FROM l_sql
#   FOREACH t400_ata_curs1 INTO l_ata.*
#      LET b_ogb.ogb03 = l_ata.ata03
#      LET b_ogb.ogb32 = l_ata.ata03    #FUN-A60035 ---add
#      LET b_ogb.ogb12 = l_ata.ata08
#      LET b_ogb.ogb04 = l_ata.ata04
#      LET b_ogb.ogb14 = g_ogb[l_ac].ogb14 * b_ogb.ogb12 / g_ogb[l_ac].ogb12
#      LET b_ogb.ogb14t= g_ogb[l_ac].ogb14t* b_ogb.ogb12 / g_ogb[l_ac].ogb12
#      LET b_ogb.ogb917= g_ogb[l_ac].ogb917 * b_ogb.ogb12 / g_ogb[l_ac].ogb12
#      CALL cl_digcut(b_ogb.ogb14,t_azi04)  RETURNING b_ogb.ogb14
#      CALL cl_digcut(b_ogb.ogb14t,t_azi04) RETURNING b_ogb.ogb14t
#      INSERT INTO ogb_file VALUES(b_ogb.*)
#      IF SQLCA.sqlcode THEN
#         CALL cl_err3("ins","ogb_file",g_oga.oga01,g_ogb_t.ogb03,SQLCA.sqlcode,"","upd ogb",1)  #No.FUN-650108
#         RETURN FALSE
#      ELSE
#         LET b_ogbi.ogbi01 = b_ogb.ogb01
#         LET b_ogbi.ogbi03 = b_ogb.ogb03
#         IF NOT s_ins_ogbi(b_ogbi.*,b_ogb.ogbplant) THEN #FUN-A50054
#            RETURN FALSE
#         END IF
#      END IF
#   END FOREACH
#   LET b_ogb.ogb32 = l_ogb32    #FUN-A60035
##ELSE
#&else
##FUN-A50054 --End
#FUN-A60035 ---MARK END
      UPDATE ogb_file SET * = b_ogb.*
       WHERE ogb01=g_oga.oga01 AND ogb03=g_ogb_t.ogb03
      IF SQLCA.sqlcode THEN
         CALL cl_err3("upd","ogb_file",g_oga.oga01,g_ogb_t.ogb03,SQLCA.sqlcode,"","upd ogb",1)  #No.FUN-670008
      END IF

#FUN-A60035 ---MARK BEGIN
#&endif
#
##END IF   #FUN-A50054 add
#FUN-A60035 ---MARK END
   RETURN TRUE
END FUNCTION

FUNCTION t600_chk_oga01()
   DEFINE li_result       LIKE type_file.num5    #No.FUN-680137 SMALLINT

   IF NOT cl_null(g_oga.oga01) THEN
      CALL t600_oga01() RETURNING li_result       #check 單別
      IF (NOT li_result) THEN
         RETURN FALSE
      END IF

      #FUN-970017 add----str---
      IF g_argv0 MATCHES '[246]' THEN
         IF g_argv0 = '2' THEN
             IF g_oga.oga00 MATCHES '[37]' THEN
                 IF g_oay.oayconf = 'Y' AND g_oay.oayapr = 'Y' THEN
                     #出貨類別為"3:出至境外倉"或"7:寄銷出貨"時,選的單別不可同時具有自動確認和簽核的
                     CALL cl_err('','axm-621',1)
                     RETURN FALSE
                 END IF
             END IF
         END IF
         IF g_argv0 MATCHES '[46]' THEN
             IF g_oay.oayconf = 'Y' AND g_oay.oayapr = 'Y' THEN
                 #多角貿易出貨單,選的單別不可同時具有自動確認和簽核的功能,請另選單別!
                 CALL cl_err('','axm-622',1)
                 RETURN FALSE
             END IF
         END IF
      END IF
      #FUN-970017 add----end---

      DISPLAY BY NAME g_oay.oaydesc
      LET g_oga.ogamksg=g_oay.oayapr
      DISPLAY BY NAME g_oga.ogamksg

      IF cl_null(g_oga_t.oga01) OR g_oga.oga01 != g_oga_t.oga01 THEN
         SELECT count(*) INTO g_cnt FROM oga_file
          WHERE oga01 = g_oga.oga01
         IF g_cnt > 0 THEN   #資料重複
            CALL cl_err(g_oga.oga01,-239,0)
            LET g_oga.oga01 = g_oga_t.oga01
            DISPLAY BY NAME g_oga.oga01
            RETURN FALSE
         END IF
      END IF
   END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_chk_oga69()
   DEFINE l_yy,l_mm       LIKE type_file.num5    #No.FUN-680137 SMALLINT
   IF NOT cl_null(g_oga.oga69) THEN
      IF g_oga.oga69 <= g_oaz.oaz09 THEN
         CALL cl_err('','axm-164',0) RETURN FALSE
      END IF
            IF g_oaz.oaz03 = 'Y' AND
               g_sma.sma53 IS NOT NULL AND g_oga.oga69 <= g_sma.sma53 THEN
               CALL cl_err('','mfg9999',0) RETURN FALSE
            END IF
      CALL s_yp(g_oga.oga69) RETURNING l_yy,l_mm
      IF g_argv0='1' OR g_argv0='5' THEN #No.9304
         IF ((l_yy*12+l_mm) - (g_sma.sma51*12+g_sma.sma52) >1) THEN
            CALL cl_err('','mfg6090',0)
            RETURN FALSE
         END IF
      ELSE
         IF ((l_yy*12+l_mm) > (g_sma.sma51*12+g_sma.sma52)) THEN
             CALL cl_err('','mfg6090',0)
             RETURN FALSE
         END IF
      END IF
   END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_chk_oga02()
   DEFINE l_yy,l_mm       LIKE type_file.num5    #No.FUN-680137 SMALLINT
   IF NOT cl_null(g_oga.oga02) THEN
      IF NOT g_argv0='5' AND NOT g_argv0='9' THEN   #MOD-820014 add
         IF g_prog = 'axmt628'  THEN #CHI-A30017 add
            IF g_oga.oga02 < g_oga.oga69 THEN
               CALL cl_err('','axm-924',1)   #出貨日期不可小於輸入日期!!!
               RETURN FALSE
            END IF
         END IF #CHI-A30017 add
      END IF #MOD-820014
      IF g_oga.oga02 <= g_oaz.oaz09 THEN
         CALL cl_err('','axm-164',0) RETURN FALSE
      END IF
            IF g_oaz.oaz03 = 'Y' AND
               g_sma.sma53 IS NOT NULL AND g_oga.oga02 <= g_sma.sma53 THEN
               CALL cl_err('','mfg9999',0) RETURN FALSE
            END IF
      CALL s_yp(g_oga.oga02) RETURNING l_yy,l_mm
 

      IF g_argv0='5' THEN                              
         IF ((l_yy*12+l_mm) - (g_sma.sma51*12+g_sma.sma52) >1) THEN
            CALL cl_err('','mfg6090',0)
            RETURN FALSE
         END IF
      ELSE
         IF g_argv0='1' THEN                                                                                    
            IF ((g_sma.sma51*12+g_sma.sma52) - (l_yy*12+l_mm) >1) THEN                                                                 
               CALL cl_err('','mfg6099',0)                                                                                             
               RETURN FALSE                                                                                                            
            END IF 
         ELSE           
            IF ((l_yy*12+l_mm) > (g_sma.sma51*12+g_sma.sma52)) THEN
               CALL cl_err('','mfg6090',0)
               RETURN FALSE
            END IF
         END IF
       END IF
   END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_chk_oga021()
   IF g_oga.oga24=0 OR cl_null(g_oga.oga24) OR
      g_oga.oga021 != g_oga_t.oga021 OR
      cl_null(g_oga_t.oga021) THEN
      #只要曾改變結關日期,即使按確定前改回原始建檔的結關日期,匯率一律重抓,
       LET g_oga_t.oga021 = g_oga.oga021  #MOD-690094 add
       IF NOT cl_null(g_oga.oga23) THEN
            CALL t600_oea18_get() RETURNING g_oea18_yn
            IF g_oea18_yn = 'N' THEN
                IF g_oga.oga08='1' THEN
                    LET exT=g_oaz.oaz52
                ELSE
                    LET exT=g_oaz.oaz70
                END IF
                IF g_oga.oga909 = 'Y' THEN
                   CALL t600_chk_poz00() RETURNING exT   #MOD-860069 
                END IF
                  IF NOT cl_null(g_oga.oga021) THEN
                     LET g_exdate = g_oga.oga021    #結關日期
                  ELSE
                     LET g_exdate = g_oga.oga02     #出貨日期
                  END IF
                  CALL s_curr3(g_oga.oga23,g_exdate,exT) RETURNING g_oga.oga24
                DISPLAY BY NAME g_oga.oga24
            END IF
       END IF
   END IF

   IF NOT cl_null(g_oga.oga021) THEN
      IF g_oga.oga021 <= g_oaz.oaz09 THEN
         CALL cl_err('','axm-164',0)
         RETURN FALSE
      END IF
   END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_chk_oga27()
   IF NOT cl_null(g_oga.oga27) THEN
      SELECT * INTO g_ofa.* FROM ofa_file
       WHERE ofa01=g_oga.oga27
         AND ofaconf='Y'
      IF STATUS=100 THEN
         #無此INVOICE或此INVOICE未確認!
         CALL cl_err3("sel","ofa_file",g_oga.oga27,"","axm-013","","sel ofa:",1)  #No.FUN-670008
         LET g_oga.oga27 = g_oga_t.oga27
         DISPLAY BY NAME g_oga.oga27
         RETURN FALSE
      END IF
      IF g_argv0 MATCHES '[2468]' THEN  ##No.FUN-630061
         IF NOT cl_null(g_ofa.ofa011) THEN
            LET g_oga.oga011 = g_ofa.ofa011
         END IF
      END IF
      IF NOT cl_null(g_ofa.ofa16) THEN
         LET g_oga.oga16 = g_ofa.ofa16
      END IF
   END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_chk_oga011(p_cmd)
   DEFINE p_cmd LIKE type_file.chr1
   DEFINE l_ogb31 LIKE ogb_file.ogb31,  #CHI-840067
          l_ogb32 LIKE ogb_file.ogb32   #CHI-840067
   DEFINE l_cnt   LIKE type_file.num5

   IF NOT cl_null(g_oga.oga011) THEN
      IF (g_oga.oga011 != g_oga_t.oga011 OR cl_null(g_oga_t.oga011)) THEN
         #default 單頭資料
         LET g_oga_u.* = g_oga.*
         IF g_argv0 = '8' THEN
           IF  g_aza.aza26 != '2' THEN #FUN-C50097 add !=2
            SELECT * INTO g_oga.* FROM oga_file
             WHERE oga01=g_oga.oga011 AND oga09 = '2' AND oga65='Y'
               AND ogaconf='Y' #出貨需驗單
               AND ogapost='Y'
            IF STATUS THEN
               CALL cl_err3("sel","oga_file","g_oga.oga011","",SQLCA.sqlcode,"","sel oga_file",1)  #No.FUN-670008
               LET g_oga.* = g_oga_u.*
               RETURN FALSE
            END IF
           END IF #FUN-C50097
         ELSE
            #-----CHI-880006---------
            #輸入出通單時,不一定要存在出通單的OQC
            #SELECT COUNT(*) INTO g_cnt FROM ogb_file
            # WHERE ogb01=g_oga.oga011
            #   AND ogb19='Y'
            #IF g_cnt>0 THEN
            #   SELECT COUNT(*) INTO g_cnt FROM qcs_file
            #    WHERE qcs01=g_oga.oga011
            #      AND qcs14='Y'
            #   IF g_cnt=0 THEN
            #      IF NOT cl_confirm('mfg3563') THEN RETURN FALSE END IF
            #   END IF
            #END IF
            #-----END CHI-880006-----
            SELECT * INTO g_oga.* FROM oga_file
             WHERE oga01=g_oga.oga011 AND oga09 IN ('1','5')  #No.7992
               AND ogaconf='Y' #通知
            IF STATUS THEN
               CALL cl_err3("sel","oga_file","g_oga.oga011","",SQLCA.sqlcode,"","sel oga_file",1)  #No.FUN-670008
               LET g_oga.* = g_oga_u.*
               RETURN FALSE
            END IF
         END IF
---------#FUN-C50097 add beg ----- 
         IF g_argv0 = '8' AND g_aza.aza26 = '2' THEN
            #IF  g_oaz.oaz94 = 'Y' THEN #TQC-C70206
               #大陸版,此時可以做多次出貨簽收作業
            #ELSE  
               SELECT COUNT(*) INTO l_cnt FROM ogb_file,oga_file
                WHERE oga01 = ogb01 AND oga01 = g_oga.oga011
                  AND ogb03 NOT IN (SELECT ogb03 FROM ogb_file,oga_file
                                     WHERE oga01 = ogb01 AND oga011 = g_oga.oga011
                                       AND oga09 ='8' AND ogaconf<>'X')
   
               IF l_cnt = 0 THEN
                  CALL cl_err(g_oga.oga011,'axm-425',1)
                  RETURN FALSE
               END IF
            #END IF
            SELECT * INTO g_oga.* FROM oga_file
            #WHERE oga01=g_oga.oga011 AND oga09 = '2' AND oga65='Y'
             WHERE oga01=g_oga.oga011 AND (oga09 = '2' OR oga09 = '3') AND oga65='Y'  #FUN-BB0167
               AND ogaconf='Y' #出貨需驗單
               AND ogapost='Y'
            IF STATUS THEN
               CALL cl_err3("sel","oga_file","g_oga.oga011","",SQLCA.sqlcode,"","sel oga_file",1)  #No.FUN-670008
               LET g_oga.* = g_oga_u.*
               RETURN FALSE
            END IF
         END IF        
---------#FUN-C50097 add end -----
         LET g_oga.oga55=''            #No.FUN-710046
          LET g_oga.oga99=''
          LET g_oga.oga905='N'

         IF g_argv0 MATCHES '[46]' THEN
            IF g_oga.oga09 = '1' THEN
               CALL cl_err(g_oga.oga011,'tri-014',1) RETURN FALSE
            END IF
         ELSE
            IF g_oga.oga09 = '5' THEN
               CALL cl_err(g_oga.oga011,'tri-015',1) RETURN FALSE
            END IF
         END IF

        #保留原出貨單初值
         LET g_oga.oga09=g_oga_u.oga09
         LET g_oga.oga01=g_oga_u.oga01
         LET g_oga.oga69=g_oga_u.oga69   #FUN-650009 add
         LET g_oga.oga02=g_oga_u.oga02
         LET g_oga.oga011=g_oga_u.oga011
         LET g_oga_t.oga27 = g_oga.oga27    #No.7992
         LET g_oga.ogaconf='N'
         LET g_oga.ogapost='N'
         LET g_oga.oga903 ='N'
         LET g_oga.ogauser=g_oga_u.ogauser
         LET g_oga.ogagrup=g_oga_u.ogagrup
         LET g_oga.ogamodu=g_oga_u.ogamodu
         LET g_oga.ogadate=g_oga_u.ogadate
         LET g_oga.ogamksg=g_oga_u.ogamksg   #MOD-A70067
         IF g_argv0 = '8' THEN
            LET g_oga.oga65 ='N'    #MOD-940055 add
         END IF

         IF g_oga.oga08='1' THEN
            LET exT=g_oaz.oaz52
         ELSE
            LET exT=g_oaz.oaz70
         END IF

         IF g_oga.oga909 = 'Y' THEN
            CALL t600_chk_poz00() RETURNING exT   #MOD-860069 
         END IF #No.7992

          IF NOT cl_null(g_oga.oga021) THEN
             LET g_exdate = g_oga.oga021    #結關日期
          ELSE
             LET g_exdate = g_oga.oga02     #出貨日期
          END IF
          CALL s_curr3(g_oga.oga23,g_exdate,exT) RETURNING g_oga.oga24
         IF g_argv0 MATCHES '[246]' THEN 
            DECLARE t600_x_ogb CURSOR FOR SELECT ogb31,ogb32 FROM ogb_file
                                  WHERE ogb01 = g_oga.oga01
            FOREACH t600_x_ogb INTO l_ogb31,l_ogb32
            LET g_cnt = 0
            SELECT COUNT(*) INTO g_cnt FROM oga_file,ogb_file
             WHERE oga01=g_oga.oga011 
               AND oga01=ogb01 AND oga09 IN ('1','5') 
               AND ogb31=l_ogb31 AND ogb32=l_ogb32
            #本訂單號不存在出貨通知單內
            IF g_cnt=0 AND l_ogb31[1,4] != 'MISC' THEN 
               LET g_msg=l_ogb31,'/',l_ogb32 CLIPPED
               CALL cl_err(g_msg,'axm-224',1) 
               RETURN FALSE
            END IF
            END FOREACH
         END IF
      END IF
      #帶occ67科目別
      LET g_oga.oga13=NULL
      SELECT occ67 INTO g_oga.oga13 FROM occ_file 
       WHERE occ01=g_oga.oga03     
   END IF
   CALL t600_set_no_entry(p_cmd)
   RETURN TRUE
END FUNCTION

FUNCTION t600_chk_oga013()
   IF NOT cl_null(g_oga.oga13) THEN
      SELECT * FROM ool_file WHERE ool01=g_oga.oga13
      IF STATUS THEN
#        CALL cl_err('',STATUS,0)
         CALL cl_err3("sel","ool_file",g_oga.oga13,"",SQLCA.sqlcode,"","sel oga_file",1)  #No.FUN-670008
         RETURN FALSE
      END IF
   END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_chk_oga16(p_cmd)
   DEFINE li_result       LIKE type_file.num5
   DEFINE l_oga16         LIKE oga_file.oga16
   DEFINE l_err           LIKE type_file.chr1   #No:FUN-670007
   DEFINE p_cmd           LIKE type_file.chr1
   DEFINE l_oga65         LIKE oga_file.oga65   #MOD-6C0028
   DEFINE l_oap           RECORD LIKE oap_file.*
   DEFINE   l_oep09       LIKE oep_file.oep09,   #CHI-710039
            l_oepconf     LIKE oep_file.oepconf  #CHI-710039
   DEFINE l_oea99         LIKE oea_file.oea99
   DEFINE l_occ56         LIKE occ_file.occ56    #MOD-8B0262
#FUN-A60004 ----------------------add start-------------------------
   DEFINE l_oma11         LIKE oma_file.oma11                                   
   DEFINE l_oma12         LIKE oma_file.oma12                                   
   DEFINE l_oma03         LIKE oma_file.oma03                                   
   DEFINE l_oma32         LIKE oma_file.oma32                                   
   DEFINE l_oma02         LIKE oma_file.oma02                                   
   DEFINE l_oma09         LIKE oma_file.oma09                                   
   DEFINE l_oea02         LIKE oea_file.oea02
#FUN-A60004 ---------------------add end---------------------------

   IF NOT cl_null(g_oga.oga16) THEN
      LET g_cnt=0
      IF g_oga.oga00='A' THEN
         SELECT COUNT(*) INTO g_cnt FROM oea_file
          WHERE oea01 =g_oga.oga16
            AND oea00 ='8'
      ELSE
         IF g_oga.oga00='B' THEN
            SELECT COUNT(*) INTO g_cnt FROM oea_file
             WHERE oea01 =g_oga.oga16
               AND oea00 ='9'
         ELSE
            SELECT COUNT(*) INTO g_cnt FROM oea_file
             WHERE oea01 =g_oga.oga16
               AND oea00 =g_oga.oga00
         END IF
      END IF
      IF g_cnt =0 THEN
         CALL cl_err(g_oga.oga16,'axm-124',1)
         RETURN FALSE
      END IF

      #訂單所有單身都已經結案
      LET g_cnt = 0
      SELECT COUNT(*) INTO g_cnt FROM oea_file,oeb_file
       WHERE oea01 = oeb01
         AND oeb70 = 'N'
         AND oea01 = g_oga.oga16
      IF g_cnt = 0 THEN
         CALL cl_err(g_oga.oga16,'axm-169',1)
         RETURN FALSE
      END IF

      IF g_sma.sma120 = 'Y' AND g_sma.sma907 = 'Y' THEN
         LET g_t1 = g_oga.oga16[1,g_doc_len]
         SELECT oay22 INTO l_oay22_oea FROM oay_file WHERE oayslip =g_t1
         LET g_t1 = g_oga.oga01[1,g_doc_len]
         SELECT oay22 INTO l_oay22_oga FROM oay_file WHERE oayslip =g_t1
         IF (cl_null(l_oay22_oga) AND NOT cl_null(l_oay22_oea)) OR (NOT cl_null(l_oay22_oga) AND cl_null(l_oay22_oea)) THEN
            CALL cl_err('','atm-521',0)
            RETURN FALSE
         END IF
         IF l_oay22_oga <>l_oay22_oea THEN
            CALL cl_err('','atm-521',0)
            RETURN FALSE
         END IF
      END IF
      SELECT * INTO g_oea.* FROM oea_file
       WHERE oea01=g_oga.oga16
      #95/10/19 By Danny 判斷不可為合約單號
         AND oea00 !='0'
      IF STATUS THEN
         CALL cl_err3("sel","oea_file","g_oga.oga16","",SQLCA.sqlcode,"","select oea",1)  #No.FUN-670008
         RETURN FALSE
      END IF

     #FUN-AC0097 Begin---
     #CALL t600_oga16()  RETURNING li_result
     #IF (NOT li_result) THEN
     # RETURN FALSE
     #END IF
     #FUN-AC0097 End-----
      IF NOT cl_null(g_oga.oga011) AND g_argv0 MATCHES '[246]' THEN #No.FUN-630061
         SELECT oga16 INTO l_oga16 FROM oga_file
          WHERE oga01=g_oga.oga011 AND oga09 IN ('1','5') #No.7992
         IF g_oga.oga16 != l_oga16 THEN
            CALL cl_err('','axm-224',0) RETURN FALSE
         END IF
      END IF
      IF g_oea.oeaconf != 'Y' THEN      #未確認 01/08/16 mandy
         CALL cl_err('sel oea','axm-184',0) RETURN FALSE
      END IF
      IF NOT cl_null(g_oea.oeahold) THEN
         CALL cl_err('oeahold','axm-151',0) RETURN FALSE
      END IF
      IF g_oea.oea49 != 1 THEN
         CALL cl_err('oea49','axm-175',0) RETURN FALSE
      END IF
      IF g_oea.oea08 != g_oga.oga08 THEN        #國內外不符
         CALL cl_err('sel oea','axm-125',0) RETURN FALSE
      END IF
       LET l_oepconf = 'Y'
       LET l_oep09 = '2'
       SELECT oep09,oepconf INTO l_oep09,l_oepconf
         FROM oep_file
        WHERE oep01 = g_oga.oga16
       IF l_oepconf = 'N' THEN
         CALL cl_err('','axm-118',1)
         RETURN FALSE
       END IF
       IF l_oepconf = 'Y' AND l_oep09 <> '2' THEN
         CALL cl_err('','axm-119',1)
         RETURN FALSE
       END IF
      #判斷是否為三角貿易訂單 No.7992
      IF cl_null(g_oga.oga909) OR g_oga.oga909 = 'N' THEN
         IF g_oea.oea901 = 'Y' THEN
            CALL cl_err('','tri-015',1) RETURN FALSE
         END IF
      END IF

      IF g_oga.oga909 = 'Y' THEN
         #是否為三角貿易訂單
         IF cl_null(g_oea.oea901) OR g_oea.oea901='N' THEN
            CALL cl_err('','tri-014',1) RETURN FALSE
         END IF

         #是否三角貿易已拋轉各廠
         IF g_oea.oea905 = 'N'  OR g_oea.oea905 IS NULL THEN
            CALL cl_err('oea906','axm-307',0) RETURN FALSE
         END IF

         #檢查流程代碼
         #IF NOT t600sub_chkpoz(g_oga.*,g_ogb[1].ogb31) THEN RETURN FALSE END IF #FUN-730012
         CALL t600sub_chkpoz(g_oga.*,g_ogb[1].ogb31) RETURNING li_result,g_poz.*,l_oea99,g_flow #FUN-730012
         IF NOT li_result THEN RETURN FALSE END IF #FUN-730012


         IF g_argv0 MATCHES '[456]' THEN #多角出貨   #No:MOD-5B0325
            IF g_poz.poz011 = '1' THEN  #正拋方式
               #檢查是否為起始訂單
               IF g_oea.oea906 = 'N' OR cl_null(g_oea.oea906) THEN
                  CALL cl_err('oea906','axm-409',0)
                  RETURN FALSE
               END IF
            END IF
            IF g_poz.poz011 = '2' THEN  #反拋方式
               CALL t600_last() RETURNING l_err
               IF l_err ="1" THEN
                  RETURN FALSE
               END IF
            END IF
            #判斷銷售段 OR 代採段之訂單
            IF g_argv0 = '4' THEN       #銷售段
               IF g_oea.oea11 ='6' THEN
                  CALL cl_err('','axm-022',1)
                  RETURN FALSE
               END IF
               IF g_poz.poz00 ='2' THEN
                  CALL cl_err(g_flow,'tri-008',1)
                  RETURN FALSE
               END IF
            END IF

            IF g_argv0 = '6' THEN       #代採段
               IF g_oea.oea11 <> '6' THEN
                  CALL cl_err('','axm-023',1) RETURN FALSE
               END IF
               IF g_poz.poz011 <> '2' THEN
                  CALL cl_err('','axm-027',0)
                  RETURN FALSE
               END IF
               IF g_poz.poz00 ='1' THEN
                  CALL cl_err(g_flow,'tri-008',1) RETURN FALSE
               END IF
            END IF

         END IF
      END IF


      IF p_cmd='a' AND cl_null(g_oga.oga011) #由訂單轉出貨單              #MOD-640570 mod
         OR (g_oga.oga16 != g_oga_t.oga16 OR cl_null(g_oga_t.oga16)) THEN #MOD-640570 add 多此判斷
         LET g_oga.oga08 = g_oea.oea08
         IF g_oga.oga00 !='A' AND g_oga.oga00 !='B' THEN
            LET g_oga.oga00 = g_oea.oea00
         END IF
         LET g_oga.oga03 = g_oea.oea03
         #-----MOD-AA0029---------
         IF g_oea.oea03[1,4] = 'MISC' THEN 
            SELECT occm02 INTO g_oea.oea033 FROM occm_file
             WHERE occm01 = g_oea.oea01
         END IF
         #-----END MOD-AA0029-----
         LET g_oga.oga032= g_oea.oea032
         LET g_oga.oga033= g_oea.oea033
         LET g_oga.oga04 = g_oea.oea04
         LET g_oga.oga044= g_oea.oea044
         LET g_oga.oga05 = g_oea.oea05 #default 發票別
         LET g_oga.oga07 = g_oea.oea07
         LET g_oga.oga14 = g_oea.oea14
         LET g_oga.oga15 = g_oea.oea15
         LET g_oga.oga161= g_oea.oea161
         LET g_oga.oga162= g_oea.oea162
         LET g_oga.oga163= g_oea.oea163
         IF g_oga.oga07 = 'N' THEN
            LET g_oga.oga20 = 'N' 
         END IF
         IF g_azw.azw04='2' THEN
            LET g_oga.oga83 = g_oea.oea83
            LET g_oga.oga84 = g_oea.oea84
            LET g_oga.oga85 = g_oea.oea85
            LET g_oga.oga86 = g_oea.oea86
            LET g_oga.oga87 = g_oea.oea87
            LET g_oga.ogaplant= g_oea.oeaplant
            LET g_oga.ogalegal= g_oea.oealegal
            LET g_oga.oga88 = g_oea.oea88 
            LET g_oga.oga89 = g_oea.oea89
            LET g_oga.oga90 = g_oea.oea90
            LET g_oga.oga91 = g_oea.oea91
            LET g_oga.oga92 = g_oea.oea92
            LET g_oga.oga93 = g_oea.oea93  
         END IF
         LET g_oga.oga21 = g_oea.oea21
         LET g_oga.oga211= g_oea.oea211
         LET g_oga.oga212= g_oea.oea212
         LET g_oga.oga213= g_oea.oea213
         LET g_oga.oga23 = g_oea.oea23
         LET g_oga.oga65 = g_oea.oea65   #No.FUN-630061
         LET g_oga.oga1004 = g_oea.oea1004
         LET g_oga.oga18 = g_oea.oea17  #No.FUN-610064#No.FUN-610064
         LET g_oga.oga1016 = g_oea.oea1015
         LET g_oga.oga1002 = g_oea.oea1002
         LET g_oga.oga1009 = g_oea.oea1009
         LET g_oga.oga1005 = g_oea.oea1005
         LET g_oga.oga1011 = g_oea.oea1011
         LET g_oga.oga1010 = g_oea.oea1010
         LET g_oga.oga1003 = g_oea.oea1003
         #帶occ67科目別
         LET g_oga.oga13=NULL
         IF g_argv0 MATCHES '[456]' THEN #多角出貨   #No:MOD-5B0325
            SELECT poy16 INTO g_oga.oga13
              FROM poy_file            
             WHERE poy01 = g_poz.poz01
               AND poy04 = g_plant 
         ELSE
            SELECT occ67 INTO g_oga.oga13 FROM occ_file 
             WHERE occ01=g_oga.oga03     
         END IF
         ##如果有出通單,出貨簽收否應帶出通單,沒有才帶訂單
         LET l_oga65=NULL
         SELECT oga65 INTO l_oga65
                      FROM oga_file
                     WHERE oga01=g_oga.oga011 AND oga09 IN ('1','5')
                       AND ogaconf='Y'
         IF (SQLCA.sqlcode=0) AND (l_oga65 IS NOT NULL) THEN
            LET g_oga.oga65=l_oga65
         END IF

#FUN-A60004 -------------------------add start----------------------------------
         IF cl_null(g_oga.oga72) THEN                                           
             IF g_oga.oga65 = 'Y' AND g_argv0 MATCHES '[12]' THEN               
             #单据性质=一般出货单/出通单时才自动推算oga72 ELSE 给NULL           
                LET l_oma03 = g_oga.oga03                                       
                IF NOT cl_null(g_oea.oea80) THEN                                
                   LET l_oma32 = g_oea.oea80                                    
                ELSE                                                            
                   LET l_oma32 = g_oea.oea32                                    
                END IF                                                          
                LET l_oma02 = g_oga.oga02                                       
                LET l_oma09 = g_oga.oga021                                      
                IF NOT cl_null(g_oga.oga16) THEN                                
                   SELECT oea02 INTO l_oea02 FROM oea_file                      
                    WHERE oea01 = g_oga.oga16                                   
                ELSE                                                            
                    LET l_oea02 = g_oga.oga02                                   
                END IF                                                          
              # LET g_dbs2 = s_dbstring(g_dbs)                                  
                CALL s_rdatem(l_oma03,l_oma32,l_oma02,l_oma09,l_oea02,g_plant2)   
                #呼叫公用程式自动推算签收日                                     
                RETURNING l_oma11,l_oma12
                LET g_oga.oga72 = l_oma11  ##预计签收日                         
                DISPLAY BY NAME g_oga.oga72                                     
             ELSE                                                               
                LET g_oga.oga72 = NULL                                          
                DISPLAY BY NAME g_oga.oga72                                     
             END IF                                                             
         ELSE                                                                   
             DISPLAY BY NAME g_oga.oga72                                        
         END IF
#FUN-A60004 ----------------------------add end--------------------------------
         IF NOT cl_null(g_oga.oga03) AND NOT cl_null(g_oga.oga04) THEN  #TQC-640123
            SELECT tuo04,tuo05 INTO g_oga.oga910,g_oga.oga911 FROM tuo_file
             WHERE tuo01 =g_oga.oga03   #No.TQC-640123
               AND tuo02 =g_oga.oga04
         END IF
         #end
         IF g_oga.oga08='1' THEN
            LET exT=g_oaz.oaz52
         ELSE
            LET exT=g_oaz.oaz70
         END IF
         IF g_oga.oga909 = 'Y' THEN
            CALL t600_chk_poz00() RETURNING exT   #MOD-860069 
         END IF
          IF NOT cl_null(g_oga.oga021) THEN
             LET g_exdate = g_oga.oga021    #結關日期
          ELSE
             LET g_exdate = g_oga.oga02     #出貨日期
          END IF
          IF NOT cl_null(g_oga.oga57) THEN LET g_oga.oga57 = '1' END IF #FUN-AA0057 add oga57
          CALL s_curr3(g_oga.oga23,g_exdate,exT) RETURNING g_oga.oga24
         LET g_oga.oga25 = g_oea.oea25
         LET g_oga.oga26 = g_oea.oea26
         LET g_oga.oga31 = g_oea.oea31
         LET g_oga.oga32 = g_oea.oea32
         LET g_oga.oga41 = g_oea.oea41
         LET g_oga.oga42 = g_oea.oea42
         LET g_oga.oga43 = g_oea.oea43
         LET g_oga.oga44 = g_oea.oea44
         LET g_oga.oga45 = g_oea.oea45
         LET g_oga.oga46 = g_oea.oea46
        ##-----No:FUN-A50103-----
         LET g_oga.oga19=NULL
        #SELECT oma01 INTO g_oga.oga19 FROM oma_file
        #       WHERE oma16=g_oga.oga16 AND oma00='23'   #TQC-870003
        #IF STATUS THEN LET g_oga.oga19=NULL END IF
        ##-----No:FUN-A50103 END-----
         CALL s_addr(g_oea.oea01,g_oea.oea04,g_oea.oea044)
              RETURNING l_oap.oap041,
                        l_oap.oap042,
                        l_oap.oap043,
                        l_oap.oap044,  #FUN-720014
                        l_oap.oap045   #FUN-720014
         LET g_msg=l_oap.oap041 CLIPPED,' ',l_oap.oap042 CLIPPED,' ',
                   l_oap.oap043 CLIPPED,' ',l_oap.oap044 CLiPPED,' ',   #MOD-910186 增加oap044/oap045
                   l_oap.oap045 CLiPPED   #MOD-910186 增加oap044/oap045
         DISPLAY g_msg TO addr
         LET l_occ56 = ''
         SELECT occ56 INTO l_occ56 FROM occ_file WHERE occ01=g_oga.oga03
         IF (l_occ56 = "Y") AND (g_argv0 MATCHES '[246]') THEN 
           CALL cl_set_comp_required("oga011",TRUE)
         ELSE                                        
           CALL cl_set_comp_required("oga011",FALSE)  
         END IF
         IF NOT cl_null(g_oga.oga04) THEN
            IF NOT t600_chk_oga04() THEN
               RETURN FALSE
            END IF
         END IF
      END IF

      #若是訂單匯率立帳, 則帶該訂單之匯率
      IF  g_oea.oea18='Y' THEN
          LET g_oga.oga24 = g_oea.oea24
          DISPLAY BY NAME g_oga.oga24
      END IF
   END IF
   CALL t600_set_no_entry(p_cmd)
   RETURN TRUE
END FUNCTION

FUNCTION t600_chk_oga18()
   IF NOT cl_null(g_oga.oga18) AND (g_oga.oga18 != g_oga_t.oga18
                                    OR g_oga_t.oga18 IS NULL ) THEN
      CALL t600_oga18('a')
      IF NOT cl_null(g_errno) THEN
         CALL cl_err(g_oga.oga18,g_errno,1)
         RETURN FALSE
      END IF
   END IF
   IF cl_null(g_oga.oga18) THEN
      DISPLAY ' ' TO FORMONLY.oga18_ds
   END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_chk_oga04()
   DEFINE l_occ02      LIKE occ_file.occ02
   DEFINE l_occacti    LIKE occ_file.occacti
   DEFINE l_occ1004    LIKE occ_file.occ1004
   DEFINE l_occ06      LIKE occ_file.occ06
   DEFINE l_errno      STRING

   IF cl_null(g_oga.oga04) THEN RETURN TRUE END IF
   
   SELECT occ02,occacti,occ1004,occ06 INTO l_occ02,l_occacti,l_occ1004,l_occ06
     FROM occ_file
    WHERE occ01 = g_oga.oga04

   LET l_errno = ''
   CASE WHEN SQLCA.SQLCODE = 100 LET l_errno = '100'                                                                                
        WHEN l_occacti = 'N'     LET l_errno = '9028'                                                                               
        WHEN SQLCA.SQLCODE != 0  LET l_errno = SQLCA.SQLCODE USING '-----'                                                          
        WHEN l_occ1004 = '2'     LET l_errno ='atm-080'                                                                             
        WHEN l_occ1004 = '3'     LET l_errno ='atm-079'                                                                             
        WHEN l_occ06 <> '1' AND l_occ06 <> '2'   LET l_errno ='atm-217'                                                                             
   END CASE 
   IF NOT cl_null(l_errno) THEN
      CALL cl_err(g_oga.oga04,l_errno,1)
      RETURN FALSE
   END IF
   #DISPLAY l_errno TO occ02     #TQC-980154 mark                                                                                   
   DISPLAY l_occ02 TO occ02      #TQC-980154 add  
   IF NOT cl_null(g_oga.oga03) AND NOT cl_null(g_oga.oga04) THEN   #No.TQC-640123
      SELECT tuo04,tuo05 INTO g_oga.oga910,g_oga.oga911 FROM tuo_file
       WHERE tuo01 =g_oga.oga03     #No.TQC-640123
         AND tuo02 =g_oga.oga04
   END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_chk_oga14()
   DEFINE l_gen03         LIKE gen_file.gen03   #NO.MOD-570345
   IF NOT cl_null(g_oga.oga14) THEN
      IF g_oga_o.oga14 <> g_oga.oga14 THEN
          SELECT gen03 INTO l_gen03
            FROM gen_file
           WHERE gen01 = g_oga.oga14
             AND genacti='Y'
          IF NOT cl_null(l_gen03) THEN
              LET g_oga.oga15 = l_gen03
              DISPLAY BY NAME g_oga.oga15
          END IF
      END IF
      SELECT gen02 INTO g_buf FROM gen_file WHERE gen01=g_oga.oga14
      IF STATUS THEN
         CALL cl_err3("sel","gen_file",g_oga.oga14,"",SQLCA.sqlcode,"","select gen",1)  #No.FUN-670008
         RETURN FALSE
      END IF
      DISPLAY g_buf TO gen02
   END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_bef_oga15()
   IF cl_null(g_oga.oga15) THEN
      SELECT gen03 INTO g_oga.oga15 FROM gen_file
       WHERE gen01=g_oga.oga14
         AND genacti='Y'
      DISPLAY g_oga.oga15 TO oga15
   END IF
END FUNCTION

FUNCTION t600_chk_oga15()
   IF NOT cl_null(g_oga.oga15) THEN
      SELECT gem02 INTO g_buf FROM gem_file WHERE gem01=g_oga.oga15
         AND gemacti='Y'   #NO:6950
      IF STATUS THEN
         CALL cl_err3("sel","gem_file",g_oga.oga15,"",SQLCA.sqlcode,"","select gem",1)  #No.FUN-670008
         RETURN FALSE
      END IF
      DISPLAY g_buf TO gem02
   END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_chk_oga23()
   IF NOT cl_null(g_oga.oga16) THEN   #no.MOD-780221 add
       IF NOT cl_null(g_oga.oga23) THEN
          IF g_oea.oea23 != g_oga.oga23 AND NOT cl_null(g_oga.oga16) THEN        #幣別不符
             CALL cl_err('sel oea','axm-144',0)
             RETURN FALSE
          END IF
   END IF  #NO.MOD-780221 add
END IF              #TQC-980197 

IF NOT cl_null(g_oga.oga23) THEN   #TQC-980197
      SELECT azi02,azi03,azi04 INTO g_buf,t_azi03,t_azi04 FROM azi_file          #No.CHI-6A0004 g_azi-->t_azi
       WHERE azi01=g_oga.oga23
      IF STATUS THEN
         CALL cl_err3("sel","azi_file",g_oga.oga23,"",SQLCA.sqlcode,"","select azi",1)  #No.FUN-670008
         RETURN FALSE
      END IF
END IF           #TQC-980197

IF NOT cl_null(g_oga.oga16) THEN          #TQC-980197 
      IF g_oga.oga24=0 OR cl_null(g_oga.oga24)
         OR g_oga.oga23 != g_oga_t.oga23
         OR cl_null(g_oga_t.oga23) THEN #BugNo:6449
         IF g_oga.oga08='1' THEN
            LET exT=g_oaz.oaz52
         ELSE
            LET exT=g_oaz.oaz70
         END IF
         IF g_oga.oga909 = 'Y' THEN
            CALL t600_chk_poz00() RETURNING exT   #MOD-860069 
         END IF
         CALL t600_oea18_get() RETURNING g_oea18_yn
         IF g_oea18_yn = 'N' THEN                   #MOD-640570 add if >
              IF NOT cl_null(g_oga.oga021) THEN
                 LET g_exdate = g_oga.oga021    #結關日期
              ELSE
                 LET g_exdate = g_oga.oga02     #出貨日期
              END IF
              CALL s_curr3(g_oga.oga23,g_exdate,exT) RETURNING g_oga.oga24
         END IF
      END IF

      IF cl_null(g_oga.oga24) THEN LET g_oga.oga24=0 END IF
      DISPLAY BY NAME g_oga.oga24
   END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_chk_oga25()
   IF NOT cl_null(g_oga.oga25) THEN
      SELECT oab02 INTO g_buf FROM oab_file
       WHERE oab01=g_oga.oga25
      IF STATUS THEN
         CALL cl_err3("sel","oab_file",g_oga.oga25,"",SQLCA.sqlcode,"","select oab",1)  #No.FUN-670008
         RETURN FALSE
      END IF
      DISPLAY g_buf TO oab02
   END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_chk_oga21(p_cmd)  #No:MOD-910067 add
 DEFINE p_cmd       LIKE type_file.chr1       #No:MOD-910067 add
 DEFINE l_cnt       LIKE type_file.num5       #No.FUN-870007

   IF NOT cl_null(g_oga.oga16) THEN    #NO.MOD-780221
      IF g_oea.oea21 != g_oga.oga21 THEN   #No:MOD-590356
         CALL cl_err('sel oea','axm-142',0)
         RETURN FALSE
      END IF
   ELSE
      IF NOT cl_null(g_oga.oga21) THEN                                                                                              
         SELECT COUNT(*) INTO l_cnt FROM gec_file                                                                                   
          WHERE gec01=g_oga.oga21 AND gecacti='Y' AND gec011='2'                                                                    
         IF l_cnt=0 THEN                                                                                                            
            CALL cl_err("","afa-112",0)                                                                                             
            RETURN FALSE                                                                                                            
         END IF                                                                                                                     
      END IF 
   END IF                              #No:MOD-910067 add
   IF NOT cl_null(g_oga.oga21) THEN    #No:MOD-910067 add
      SELECT gec04,gec05,gec07
        INTO g_oga.oga211,g_oga.oga212,g_oga.oga213 FROM gec_file
       WHERE gec01=g_oga.oga21 AND gec011='2'  #銷項
      IF STATUS THEN
         CALL cl_err3("sel","gec_file",g_oga.oga21,"",SQLCA.sqlcode,"","select gec",1)  #No.FUN-670008
         RETURN FALSE
      END IF
      DISPLAY BY NAME g_oga.oga211, g_oga.oga212, g_oga.oga213
      IF p_cmd = 'u' AND
        ((g_oga.oga213 != g_oga_t.oga213 OR g_oga_t.oga213 IS NULL)
        OR (g_oga.oga211 != g_oga_t.oga211 OR g_oga_t.oga211 IS NULL)) THEN
         IF NOT t600_upd_oga50() THEN
            RETURN FALSE
         END IF
      END IF
   END IF                               #No:MOD-910067 add
   RETURN TRUE
END FUNCTION

FUNCTION t600_upd_oga50()
  DEFINE l_cnt         LIKE type_file.num5
  DEFINE l_ogb03       LIKE ogb_file.ogb03
  DEFINE l_ogb13       LIKE ogb_file.ogb13
  DEFINE l_ogb917      LIKE ogb_file.ogb917
  DEFINE l_ogb14       LIKE ogb_file.ogb14
  DEFINE l_ogb14t      LIKE ogb_file.ogb14t
  DEFINE l_ogb31       LIKE ogb_file.ogb31
  DEFINE l_oea21       LIKE oea_file.oea21

   SELECT COUNT(*) INTO l_cnt from ogb_file 
    WHERE ogb01 = g_oga.oga01
   IF l_cnt > 0 THEN
      #稅別改變，是否跟新單身金額
      IF cl_confirm('axm-936') THEN
         DECLARE oga21_cs CURSOR FOR
          SELECT ogb03,ogb13,ogb917,ogb31 FROM ogb_file
           WHERE ogb01 = g_oga.oga01
         FOREACH oga21_cs INTO l_ogb03,l_ogb13,l_ogb917,l_ogb31
            #先判斷單身的訂單號是否為空，不為空的話，再看改后稅率是否相同
            IF NOT cl_null(l_ogb31) THEN
               SELECT oea21 INTO l_oea21 FROM oea_file
                WHERE oea01 = l_ogb31
               IF g_oga.oga21 != l_oea21 THEN
                  CALL cl_err('sel oea','axm-142',0)
                  RETURN FALSE
               END IF
            END IF
            IF g_oga.oga213 = 'N' THEN
               LET l_ogb14 =l_ogb917*l_ogb13
               LET l_ogb14t=l_ogb14*(1+g_oga.oga211/100)
               CALL cl_digcut(l_ogb14,g_azi04) RETURNING l_ogb14
               CALL cl_digcut(l_ogb14t,g_azi04) RETURNING l_ogb14t
            ELSE
               LET l_ogb14t=l_ogb917*l_ogb13
               LET l_ogb14 =l_ogb14t/(1+g_oga.oga211/100)
               CALL cl_digcut(l_ogb14t,g_azi04) RETURNING l_ogb14t
               CALL cl_digcut(l_ogb14,g_azi04) RETURNING l_ogb14
            END IF
            UPDATE ogb_file SET ogb14 = l_ogb14,
                                ogb14t= l_ogb14t
             WHERE ogb01 = g_oga.oga01 AND ogb03 = l_ogb03
            IF SQLCA.SQLCODE THEN
               CALL cl_err3("upd","ogb_file",g_oga.oga01,l_ogb03,STATUS,"","upd ogb14,ogb14t:",1)
               RETURN FALSE
               EXIT FOREACH
            END IF
         END FOREACH
        #CALL t600_b_fill(' 1=1')  #但是不顯示金額，所以不需要

        #FUN-A20022 ADD----------UPDATE THE POINT---------------------------
          IF NOT cl_null(g_oga.oga87) THEN
             LET g_oga.oga95= t600_oga95_amount()
             IF cl_null(g_oga.oga95) THEN LET g_oga.oga95=0 END IF #MOD-B10154
             UPDATE oga_file SET oga95 = g_oga.oga95
                           WHERE oga01 = g_oga.oga01
                             AND oga87 = g_oga.oga87
             IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
                CALL cl_err3("upd","oga_file",g_oga.oga01,"",SQLCA.sqlcode,"","",1) 
             END IF     
             DISPLAY BY NAME g_oga.oga95 
          END IF 
        #FUN-A20022 END----------------------------------------------
         SELECT SUM(ogb14) INTO g_oga.oga50 FROM ogb_file
          WHERE ogb01 = g_oga.oga01
         CALL cl_digcut(g_oga.oga50,g_azi04) RETURNING g_oga.oga50
         IF cl_null(g_oga.oga50) THEN LET g_oga.oga50 = 0 END IF
      END IF
   END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_chk_oga03(p_cmd)
   DEFINE l_occ           RECORD LIKE occ_file.*
   DEFINE p_cmd           LIKE type_file.chr1
#FUN-A60004 --------------------add start---------------------
   DEFINE l_oma11         LIKE oma_file.oma11                                   
   DEFINE l_oma12         LIKE oma_file.oma12                                   
   DEFINE l_oma03         LIKE oma_file.oma03                                   
   DEFINE l_oma32         LIKE oma_file.oma32                                   
   DEFINE l_oma02         LIKE oma_file.oma02                                   
   DEFINE l_oma09         LIKE oma_file.oma09                                   
   DEFINE l_oea02         LIKE oea_file.oea02
#FUN-A60004 ------------------add end------------------------
   IF NOT cl_null(g_oga.oga03) THEN     #No.FUN-610064
      IF g_aza.aza50 = 'Y' THEN   #MOD-8C0003
         SELECT * INTO l_occ.* FROM occ_file
          WHERE occ01=g_oga.oga03     #No.FUN-610064
             AND occ1004 ='1'      #No.FUN-690025
             AND occ06 ='1'        #No.FUN-610064
            AND occacti='Y'
         IF SQLCA.sqlcode=100 THEN
            CALL cl_err3("sel","occ_file",g_oga.oga03,"","anm-045","","select occ",1)  #No.FUN-670008
            RETURN FALSE   #No.FUN-610064
         ELSE
            IF g_azw.azw04='2' THEN 
               IF l_occ.occ930=g_plant THEN
                  CALL cl_err('','art-444',0)
                  RETURN FALSE
               END IF
            END IF 
            IF l_occ.occ1004!='1' THEN    #No.FUN-690025
               CALL cl_err('select occ','atm-073',0)
               RETURN FALSE
            ELSE
               IF l_occ.occ06!='1' THEN
                  CALL cl_err('select occ','atm-072',0)
                  RETURN FALSE
               END IF
            END IF
         END IF
      ELSE
         SELECT * INTO l_occ.* FROM occ_file 
          WHERE occ01=g_oga.oga03    
             AND occ1004 ='1'      
             AND occacti='Y'
         IF SQLCA.sqlcode=100 THEN 
            CALL cl_err3("sel","occ_file",g_oga.oga03,"","anm-045","","select occ",1)  
            RETURN FALSE   
         END IF
      END IF
       IF (l_occ.occ56 = "Y") AND (g_argv0 MATCHES '[246]') THEN #FUN-710037
         CALL cl_set_comp_required("oga011",TRUE)
       ELSE                                        #MOD-880126
         CALL cl_set_comp_required("oga011",FALSE)  #MOD-880126
      END IF


      IF g_oga.oga03[1,4] != 'MISC' THEN
           DISPLAY l_occ.occ02 TO FORMONLY.oga03_occ02
      END IF

      SELECT occ02 INTO g_buf FROM occ_file
       WHERE occ01 = g_oga.oga03
         AND occacti = 'Y'
      IF STATUS THEN
         LET g_buf =''
      END IF
      LET g_oga.oga032=g_buf
      DISPLAY g_oga.oga032 TO oga032
       IF ((cl_null(g_oga.oga011) AND cl_null(g_oga.oga16) AND p_cmd = 'a') OR
          (cl_null(g_oga.oga011) AND cl_null(g_oga.oga16) AND p_cmd = 'u')) AND   
          (cl_null(g_oga_t.oga03) OR  g_oga_t.oga03 <> g_oga.oga03) THEN   #MOD-9C0128
         LET g_oga.oga18=l_occ.occ07 #TQC-640123
         LET g_oga.oga04=l_occ.occ09
         LET g_oga.oga14=l_occ.occ04
         LET g_oga.oga23=l_occ.occ42
         LET g_oga.oga21=l_occ.occ41
          IF  cl_null(g_oga.oga16) THEN
            LET g_oea.oea21=g_oga.oga21  #MOD-770017 add
          END IF
         IF g_argv0 = '8' THEN
            LET g_oga.oga65='N'
         ELSE
            LET g_oga.oga65=l_occ.occ65  #No.FUN-630061
         END IF
#FUN-A60004 ----------------------add start--------------------------------
         IF g_oga.oga65 = 'Y' AND g_argv0 MATCHES '[12]' THEN                   
         #单据性质=一般出货单/出通单时才自动推算oga72 ELSE 给NULL               
            LET l_oma03 = g_oga.oga03                                           
            IF NOT cl_null(g_oea.oea80) THEN                                    
               LET l_oma32 = g_oea.oea80                                        
            ELSE                                                                
               LET l_oma32 = g_oea.oea32                                        
            END IF                                                              
            LET l_oma02 = g_oga.oga02                                           
            LET l_oma09 = g_oga.oga021                                          
            IF NOT cl_null(g_oga.oga16) THEN                                    
               SELECT oea02 INTO l_oea02 FROM oea_file                          
                WHERE oea01 = g_oga.oga16                                       
            ELSE                                                                
                LET l_oea02 = g_oga.oga02                                       
            END IF                                                              
          # LET g_dbs2 = s_dbstring(g_dbs)                                      
            CALL s_rdatem(l_oma03,l_oma32,l_oma02,l_oma09,l_oea02,g_plant2)       
            #呼叫公用程式自动推算签收日                                         
            RETURNING l_oma11,l_oma12
            LET g_oga.oga72 = l_oma11  ##预计签收日                             
            DISPLAY BY NAME g_oga.oga72                                         
         ELSE                                                                   
            LET g_oga.oga72 = NULL                                              
            DISPLAY BY NAME g_oga.oga72                                         
         END IF
#FUN-A60004 ----------------add end---------------------------------------- 

         DISPLAY BY NAME g_oga.oga18    #MOD-960139
                 
         IF cl_null(g_oga.oga05) OR (p_cmd = 'u' AND g_oga_t.oga05 != g_oga.oga05) THEN  #MOD-960139
             LET g_oga.oga05=l_occ.occ08
         END IF
         LET g_oga.oga25=l_occ.occ43
         SELECT gen03 INTO g_oga.oga15 FROM gen_file
          WHERE gen01=g_oga.oga14
            AND genacti='Y'
         IF g_oga.oga08='1' THEN
             LET exT=g_oaz.oaz52
         ELSE
             LET exT=g_oaz.oaz70
         END IF
         IF g_oga.oga909 = 'Y' THEN
            CALL t600_chk_poz00() RETURNING exT   #MOD-860069 
         END IF
          IF NOT cl_null(g_oga.oga021) THEN
             LET g_exdate = g_oga.oga021    #結關日期
          ELSE
             LET g_exdate = g_oga.oga02     #出貨日期
          END IF
          CALL s_curr3(g_oga.oga23,g_exdate,exT) RETURNING g_oga.oga24
         SELECT gec04,gec05,gec07
           INTO g_oga.oga211,g_oga.oga212,g_oga.oga213
           FROM gec_file WHERE gec01=g_oga.oga21
                           AND gec011='2'  #銷項
      END IF

       IF cl_null(g_oga.oga04) OR (p_cmd = 'u' AND g_oga_t.oga04 != g_oga.oga04) THEN  #MOD-960139
         LET g_oga.oga04 = l_occ.occ09
         DISPLAY BY NAME g_oga.oga04
      END IF
       #IF cl_null(g_oga.oga03) OR (p_cmd = 'u' AND g_oga_t.oga03 != g_oga.oga03) THEN  #MOD-960139      #MOD-A70014
       IF cl_null(g_oga.oga18) OR (p_cmd = 'u' AND g_oga_t.oga03 != g_oga.oga03) THEN   #MOD-A70014
         #LET g_oga.oga03 = l_occ.occ07  #No.FUN-610064   #MOD-A70014
         LET g_oga.oga18 = l_occ.occ07   #MOD-A70014
      END IF
      IF g_oea.oea03 != g_oga.oga03 AND NOT cl_null(g_oga.oga16) THEN        #客戶不符 #No.FUN-610064#No.FUN-610064
         CALL cl_err('sel oea','axm-138',0)
         RETURN FALSE
      END IF
       IF cl_null(g_oga.oga13) OR (p_cmd = 'u' AND g_oga_t.oga13 != g_oga.oga13) THEN  #MOD-960139
         LET g_oga.oga13 = l_occ.occ67
         DISPLAY BY NAME g_oga.oga13
      END IF
      IF NOT cl_null(g_oga.oga03) AND NOT cl_null(g_oga.oga04) THEN
         SELECT tuo04,tuo05 INTO g_oga.oga910,g_oga.oga911 FROM tuo_file
          WHERE tuo01 =g_oga.oga03
            AND tuo02 =g_oga.oga04
      END IF
      IF cl_null(g_oga.oga32) OR g_oga_t.oga03 <> g_oga.oga03 THEN
             SELECT occ45 INTO g_oga.oga32 FROM occ_file
             WHERE occ01 = g_oga.oga03
      END IF
      IF g_azw.azw04='2' THEN
         SELECT occ71 INTO g_oga.oga85 FROM occ_file
          WHERE occ01=g_oga.oga03 
      END IF
      IF cl_null(g_oga.oga16) THEN #MOD-B40171 add 
         #-----MOD-A90158---------
         IF g_oga.oga04 <> g_oga.oga03 AND g_oga.oga09 MATCHES '[45]'THEN
            IF cl_confirm('axm_116') THEN
               SELECT occ42,occ43,occ41 
                 INTO g_oga.oga23,g_oga.oga25,g_oga.oga21
                 FROM occ_file WHERE occ01 = g_oga.oga04
               CALL s_curr3(g_oga.oga23,g_exdate,exT) RETURNING g_oga.oga24
               SELECT gec04,gec05,gec07 
                 INTO g_oga.oga211,g_oga.oga212,g_oga.oga213
                 FROM gec_file WHERE gec01=g_oga.oga21
                                 AND gec011='2'  #銷項
            END IF
         END IF
         #-----END MOD-A90158-----
      END IF #MOD-B40171 add
   END IF
   CALL t600_set_no_entry(p_cmd)
   RETURN TRUE
END FUNCTION

FUNCTION t600_i_inpchk()
   DEFINE l_oga00         LIKE oga_file.oga00    #MOD-980038

   IF g_oga.oga1004 = g_oga.oga03  THEN  #No.FUN-610064  TQC-640123
      CALL cl_err('','atm-252',1)
      RETURN "oga1004"
   END IF
   IF NOT cl_null(g_oga.oga16) THEN     #no.MOD-780221
       SELECT * INTO g_oea.* FROM oea_file
        WHERE oea01=g_oga.oga16
          AND (oea901 = 'N' OR oea901 IS NULL)
       IF g_oea.oea08 != g_oga.oga08 AND NOT cl_null(g_oga.oga16) THEN        #國內外不符
          CALL cl_err('sel oea','axm-125',0)
          RETURN "oga08"
       END IF
       IF g_oea.oea23 != g_oga.oga23 AND NOT cl_null(g_oga.oga16) THEN        #幣別不符
          CALL cl_err('sel oea','axm-144',0)
          RETURN "oga23"
       END IF
       IF g_oea.oea21 != g_oga.oga21 AND NOT cl_null(g_oga.oga16) THEN        #稅別不符
          CALL cl_err('sel oea','axm-142',0)
          RETURN "oga21"
       END IF
       IF g_oea.oea32 != g_oga.oga32 THEN       #收款條件不符
          CALL cl_err('sel oea','axm-143',0) RETURN FALSE
       END IF
   END IF                               #NO.MOD-780221
   IF g_argv0 = '8' AND cl_null(g_oga.oga011) THEN
      RETURN "oga011"
   END IF
   IF g_argv0 = '8' THEN 
      SELECT oga00 INTO l_oga00 
        FROM oga_file
       WHERE oga01 = g_oga.oga011
      IF l_oga00 <> g_oga.oga00 THEN
         CALL cl_err('sel oga','axm-147',0) 
         RETURN "oga00"
      END IF 
   END IF
   RETURN NULL
END FUNCTION

FUNCTION t600_a_default()
DEFINE l_azp02 LIKE azp_file.azp02  #No.FUN-870007

      LET g_oga.oga00  ='1'
      LET g_oga.oga06  = g_oaz.oaz41
      LET g_oga.oga08  ='1'
      LET g_oga.oga09 = g_argv0    #MOD-980217     
      LET g_oga.oga69  =g_today    #FUN-650009 add
      LET g_oga.oga02  =g_today
      LET g_oga.oga14  =g_user
      LET g_oga.oga15  =g_grup
      LET g_oga.oga65  ='N'   #No.FUN-630061
      LET g_oga.oga1014='N'   #No.TQC-650118
      LET g_oga.oga1015='0'  #No.FUN-610064

      IF NOT cl_null(g_argv1) AND (g_argv2 = "insert") THEN
         LET g_oga.oga16 = g_argv1
      END IF

      LET g_oga.oga161 =0
      LET g_oga.oga162 =100
      LET g_oga.oga163 =0
      LET g_oga.oga20  ='Y'
      LET g_oga.oga211 =0
      LET g_oga.oga50  =0
      LET g_oga.oga52  =0
      LET g_oga.oga53  =0
      LET g_oga.oga54  =0
      LET g_oga.oga57  ='1'                         #TQC-B30086 add
      LET g_oga.oga903 ='N'

      IF g_argv0 MATCHES '[456]' THEN
         LET g_oga.oga905 ='N'
         LET g_oga.oga906 ='Y'
         LET g_oga.oga909 ='Y'
         LET g_oga.oga08 = '2'
      END IF

      LET g_oga.ogaconf='N'
      LET g_oga.ogaspc = '0'    #FUN-680010
      LET g_oga.oga30  ='N'
      LET g_oga.ogapost='N'
      LET g_oga.ogaprsw=0
      LET g_oga.ogauser=g_user
      LET g_oga.ogaoriu = g_user #FUN-980030
      LET g_oga.ogaorig = g_grup #FUN-980030
      LET g_data_plant = g_plant #FUN-980030
      LET g_oga.ogagrup=g_grup
      LET g_oga.ogadate=g_today
      LET g_oga.ogaplant = g_plant
      LET g_oga.ogalegal = g_legal
      IF g_azw.azw04='2' THEN      
         LET g_oga.oga94='N'    
         LET g_oga.oga83 =g_plant
         LET g_oga.oga84 =g_plant  
         CALL t600_oga84('d')
         SELECT azp02 INTO l_azp02 FROM azp_file
          WHERE azp01 = g_plant
         DISPLAY l_azp02,l_azp02 TO ogaplant_desc,oga83_desc
         DISPLAY BY NAME g_oga.oga83,g_oga.oga84,
                         g_oga.oga94,g_oga.ogaplant
                        ,g_oga.ogaoriu,g_oga.ogaorig         #TQC-A30041 ADD
      END IF
END FUNCTION

FUNCTION t600_oga84(p_cmd)                                                                                                          
DEFINE p_cmd LIKE type_file.chr1                                                                                                    
DEFINE l_azp02 LIKE azp_file.azp02

   SELECT azp02 INTO l_azp02 FROM azp_file WHERE azp01=g_oga.oga84
   CASE
        WHEN SQLCA.sqlcode=100   LET g_errno = 'art-002'
                                 LET l_azp02 = NULL
        OTHERWISE
        LET g_errno=SQLCA.sqlcode USING '------'
   END CASE
   IF cl_null(g_errno) OR p_cmd='d' THEN
      DISPLAY l_azp02 TO FORMONLY.oga84_desc
   END IF
END FUNCTION                                                                                                                        
                                                                                                                                    
FUNCTION t600_ogb04()                                                                                                          
DEFINE l_rty06 LIKE rty_file.rty06                                                                                                  
DEFINE l_rty05 LIKE rty_file.rty05                                                                                                  
DEFINE l_rtt01 LIKE rtt_file.rtt01                                                                                                  
DEFINE l_rtt11 LIKE rtt_file.rtt11                                                                                                  
DEFINE l_rtv12 LIKE rtv_file.rtv12     
DEFINE l_rtu08 LIKE rtu_file.rtu08                                                                                                  
DEFINE l_rtu01 LIKE rtu_file.rtu01                                                                                                  
DEFINE l_rtv13 LIKE rtv_file.rtv13   
DEFINE l_occ930 LIKE occ_file.occ930                                                                                                
DEFINE lc_type LIKE type_file.chr1
DEFINE li_ret LIKE type_file.num5
DEFINE l_rth04 LIKE rth_file.rth04
DEFINE l_rth05 LIKE rth_file.rth05
DEFINE l_rtg06 LIKE rtg_file.rtg06
DEFINE l_rtg08 LIKE rtg_file.rtg08
DEFINE l_rtg05 LIKE rtg_file.rtg05
DEFINE l_rtz05 LIKE rtz_file.rtz05

   SELECT rty06 INTO l_rty06 FROM rty_file WHERE rty01=g_plant                                                                 
    AND rty02=g_ogb[l_ac].ogb04 AND rtyacti="Y"                                                                                     
   IF SQLCA.sqlcode=100 THEN LET l_rty06=NULL END IF                                                                                
   LET g_ogb[l_ac].ogb44=l_rty06                                                                            
   IF cl_null(g_ogb[l_ac].ogb44) THEN
   #No.FUN-A70123 ..begin
   #   CALL cl_err('','art-510',1)
   #   RETURN 1
       LET g_ogb[l_ac].ogb44 = '1'
   #No.FUN-A70123 ..end
   END IF
   IF g_ogb[l_ac].ogb44='3' OR g_ogb[l_ac].ogb44='4' THEN                                                                           
      SELECT rty05 INTO l_rty05 FROM rty_file WHERE rty01=g_plant                                                              
       AND rty02=g_ogb[l_ac].ogb04 AND rtyacti="Y"                                                                                  
      IF NOT cl_null(l_rty05) THEN                                                                                                  
         SELECT rtt01,rtt11 INTO l_rtt01,l_rtt11 FROM rtt_file,rts_file,rto_file                                                    
          WHERE rts01 = rtt01 AND rttplant = rtsplant                                                                                   
   #       AND rts02 = rtt02 AND rtt04 =g_ogb[l_ac].ogb04 AND rto01 = rts04 AND rtoplant = rts9plant #TQC-B30189 MARK
           AND rts02 = rtt02 AND rtt04 =g_ogb[l_ac].ogb04 AND rto01 = rts04 AND rtoplant = rtsplant  #TQC-B30189 ADD
           AND rto05 = l_rty05  AND rto06 = g_ogb[l_ac].ogb44 AND rto08<=g_oga.oga02                                                
           AND rto09>=g_oga.oga02 AND rtt15="Y"                                                                                     
           AND rtoconf = 'Y' AND rtsconf = 'Y' AND rto03 = rts02 AND rtoplant =  g_plant                                         
         IF NOT cl_null(l_rtt01) THEN                                                                                               
            SELECT rtv12,rtu08,rtu01,rtv13 INTO l_rtv12,l_rtu08,l_rtu01,l_rtv13 FROM rtv_file,rtu_file,rtt_file                     
             WHERE rtt01=rtu04 AND rtt02=rtu02 AND rttplant=rtuplant AND rtuplant=g_plant                                            
              AND rtuconf="Y" AND rtuplant=rtvplant AND rtu01=rtv01 AND rtu02=rtv02                                                     
              AND rtt01=l_rtt01 AND rtu05=l_rty05 AND rtu06=g_ogb[l_ac].ogb44                                                       
              AND rtv04=g_ogb[l_ac].ogb04                                                                                           
            IF NOT cl_null(l_rtu01) THEN       
               LET g_ogb[l_ac].ogb45=l_rtv12                                                                                        
            ELSE                                                                                                                    
               LET g_ogb[l_ac].ogb45=l_rtt11                                                                                        
            END IF                                                                                                                  
         END IF                                                                                                                     
      END IF                                                                                                                        
   ELSE                                                                                                                             
      LET g_ogb[l_ac].ogb45=NULL                                                                                                    
   END IF                                                                                                                           
   LET g_ogb[l_ac].ogb46=g_ogb[l_ac].ogb45                                                                                          
   CALL cl_set_comp_entry("ogb46",false)
   RETURN 0                                                                                            
END FUNCTION  

FUNCTION t600_price_1(p_ac)
DEFINE p_ac LIKE type_file.num5
DEFINE l_flag LIKE type_file.chr1                                                                                                                                    
   IF g_azw.azw04 = '2' THEN  #No.MOD-A60134
      CALL t600_ogb04() RETURNING l_flag
      IF l_flag='1' THEN
         RETURN 1
      END IF
   END IF                     #No.MOD-A60134
   IF cl_null(g_ogb[p_ac].ogb916) THEN                                                                                              
      LET g_ogb[p_ac].ogb917 = g_ogb[p_ac].ogb12                                                                                    
   END IF         
   IF g_oga.oga213 = 'N' THEN
      LET g_ogb[p_ac].ogb14 = g_ogb[p_ac].ogb12* g_ogb[p_ac].ogb13
      CALL cl_digcut(g_ogb[p_ac].ogb14,t_azi04)  RETURNING g_ogb[p_ac].ogb14   
      LET g_ogb[p_ac].ogb14t= g_ogb[p_ac].ogb14*(1+ g_oga.oga211/100)
      CALL cl_digcut(g_ogb[p_ac].ogb14t,t_azi04) RETURNING g_ogb[p_ac].ogb14t     
   ELSE              
      LET g_ogb[p_ac].ogb14t= g_ogb[p_ac].ogb12*g_ogb[p_ac].ogb13
      CALL cl_digcut(g_ogb[p_ac].ogb14t,t_azi04) RETURNING g_ogb[p_ac].ogb14t     
      LET g_ogb[p_ac].ogb14 = g_ogb[p_ac].ogb14t/(1+ g_oga.oga211/100)
      CALL cl_digcut(g_ogb[p_ac].ogb14,t_azi04)  RETURNING g_ogb[p_ac].ogb14   
   END IF
   RETURN 0         
END FUNCTION

FUNCTION t600_ogaconu(p_cmd)                                                                                                        
DEFINE l_gen02 LIKE gen_file.gen02                                                                                                  
DEFINE p_cmd LIKE type_file.chr1                                                                                                    
   SELECT gen02 INTO l_gen02 FROM gen_file WHERE gen01=g_oga.ogaconu AND genacti="Y"                                                
   IF SQLCA.sqlcode=100 THEN                                                                                                        
      LET l_gen02=NULL                                                                                                              
   END IF                                                                                                                           
   IF p_cmd='d' THEN                                                                                                                
      DISPLAY l_gen02 TO FORMONLY.ogaconu_desc                                                                                      
   END IF                                                                                                                           
END FUNCTION  

FUNCTION pay_chk()
DEFINE l_cnt LIKE type_file.num5

   IF g_oga.oga01 IS NULL THEN RETURN END IF                                                                                        
   SELECT * INTO g_oga.* FROM oga_file WHERE oga01 = g_oga.oga01                                                                    
   IF g_oga.ogaconf = 'X' THEN CALL cl_err('',9024,0) RETURN END IF                                                                 
   IF g_argv0 MATCHES '[15]' THEN                                                                                                   
      IF g_oga.ogaconf = 'Y' THEN                                                                                                   
         CALL cl_err('',9023,0) RETURN                                                                                              
      END IF                                                                                                                        
   END IF                                                                                                                           
   IF g_argv0 MATCHES '[24689]' THEN                                                                                                
      IF g_oga.ogaconf = 'Y' THEN                                                                                                   
         CALL cl_err('',9023,0) RETURN                                                                                              
      END IF                                                                                                                        
      IF g_oga.ogapost = 'Y' THEN                                                                                                   
         CALL cl_err('','art-281',0) RETURN                                                                                         
      END IF                                                                                                                        
   END IF                                                                                                                           
                                                                                                                                    
   IF g_argv0 MATCHES '[15]' THEN                                                                                                   
      LET g_cnt=0                                                                                                                   
      SELECT COUNT(*) INTO g_cnt FROM oga_file                                                                                      
       WHERE oga011 = g_oga.oga01  
         AND oga09 IN ('2','4','6')                                                                                                 
         AND ogaconf != 'X'                                                                                                         
      #此出貨通知單已經出貨! 不可再做任何處理!                                                                                      
      IF g_cnt > 0 THEN                                                                                                             
         CALL cl_err('oga011!='':','axm-228',1)                                                                                     
         RETURN                                                                                                                     
      END IF                                                                                                                        
   END IF                                                                                                                           
                                                                                                                                    
   IF g_oga.oga55 matches '[Ss]' THEN                                                                                               
       CALL cl_err('','art-277',0)                                                                                                  
       RETURN                                                                                                                       
   END IF                                         
   LET l_cnt=0                                                                                                                      
   SELECT COUNT(*) INTO l_cnt FROM ogb_file                                                                                         
    WHERE ogb01=g_oga.oga01                                                                                                         
      AND ogb930=g_plant_code                                                                                                       
      AND ogb47<0                                                                                                                   
   IF l_cnt>0 THEN                                                                                                                  
      CALL cl_err('','art-483',0)                                                                                                   
      LET g_success='N'                                                                                                             
      RETURN                                                                                                                        
   END IF            
END FUNCTION 

FUNCTION l_price()
DEFINE l_ogb14t LIKE ogb_file.ogb14t
DEFINE l_price LIKE ogb_file.ogb14t
DEFINE l_ogb47 LIKE ogb_file.ogb47
  
   SELECT SUM(ogb14t) INTO l_ogb14t FROM ogb_file
    WHERE ogb01=g_oga.oga01 
#FUN-AB0061 -----------add start----------------      
#   SELECT SUM(ogb47) INTO l_ogb47 FROM ogb_file
#    WHERE ogb01=g_oga.oga01
#   IF g_oga.oga213='N' THEN
#      LET l_ogb47=l_ogb47*(1+g_oga.oga211/100)
#      CALL cl_digcut(l_ogb47,t_azi04) RETURNING l_ogb47
#   END  IF
#   LET l_price=l_ogb14t-l_ogb47
#FUN-AB0061 -----------add end---------------- 
   LET l_price=l_ogb14t    #FUN-AB0061  
   CALL cl_digcut(l_price,t_azi04) RETURNING l_price
   RETURN l_price 
END FUNCTION                 

FUNCTION t600_a_inschk()
   DEFINE li_result    LIKE type_file.num5             #No.FUN-550052  #No.FUN-680137 SMALLINT
  #CALL s_auto_assign_no("axm",g_oga.oga01,g_oga.oga02,"","oga_file","oga01","","","") #MOD-A40051 mark
   CALL s_auto_assign_no("axm",g_oga.oga01,g_oga.oga69,"","oga_file","oga01","","","") #MOD-A40051
     RETURNING li_result,g_oga.oga01
   IF (NOT li_result) THEN
      RETURN FALSE
   END IF

   DISPLAY BY NAME g_oga.oga01

   LET g_oga.oga09 = g_argv0

   #重抓訂單檔的比率
   IF NOT cl_null(g_oga.oga16) THEN
      SELECT oea161,oea162,oea163
        INTO g_oga.oga161,g_oga.oga162,g_oga.oga163 FROM oea_file
       WHERE oea01=g_oga.oga16
   END IF

   IF cl_null(g_oga.oga32) THEN
            SELECT occ45 INTO g_oga.oga32 FROM occ_file
            WHERE occ01 = g_oga.oga03
   END IF

   IF cl_null(g_oga.oga161) THEN LET g_oga.oga161 = 0 END IF
   IF cl_null(g_oga.oga162) THEN LET g_oga.oga162 =100 END IF
   IF cl_null(g_oga.oga163) THEN LET g_oga.oga163 = 0 END IF
   IF cl_null(g_oga.oga85) THEN LET g_oga.oga85=' ' END IF  #No.FUN-870007
   IF cl_null(g_oga.oga94) THEN LET g_oga.oga94='N' END IF  #No.FUN-870007
   LET g_oga.ogamksg=g_oay.oayapr
   LET g_oga.oga55='0'
   DISPLAY BY NAME g_oga.ogamksg
   DISPLAY BY NAME g_oga.oga55
   RETURN TRUE
END FUNCTION

FUNCTION t600_a_ins()
   DEFINE l_oap RECORD LIKE oap_file.*

   LET g_oga.ogaplant = g_plant 
   LET g_oga.ogalegal = g_legal  
   #FUN-AC0055 add ---------------------begin-----------------------
   IF cl_null(g_oga.oga57) THEN
      LET g_oga.oga57 = '1'  
   END IF
   #FUN-AC0055 add ----------------------end------------------------
   LET g_oga.ogaoriu = g_user      #No.FUN-980030 10/01/04
   LET g_oga.ogaorig = g_grup      #No.FUN-980030 10/01/04
   IF cl_null(g_oga.oga909) THEN LET g_oga.oga909 = 'N' END IF  #MOD-A60163 
   INSERT INTO oga_file VALUES (g_oga.*)
   IF STATUS OR SQLCA.SQLCODE THEN
      CALL cl_err3("ins","oga_file","g_oga.oga01","",SQLCA.sqlcode,"","",1)  #No.FUN-670008
      RETURN FALSE
   END IF
   COMMIT WORK        #No:7829

   CALL cl_flow_notify(g_oga.oga01,'I')

   IF g_oga.oga044[1,4] ='MISC' THEN
      IF g_oga.oga09 MATCHES '[15]' AND g_oga.oga16 IS NOT NULL THEN
         LET g_buf=g_oga.oga16
      END IF
      IF g_oga.oga09 MATCHES '[2468]' THEN  #No.FUN-630061
         IF g_oga.oga011 IS NOT NULL AND g_oga.oga011!=g_oga.oga01
            THEN LET g_buf=g_oga.oga011
            ELSE LET g_buf=g_oga.oga16
         END IF
      END IF
      LET l_oap.oap01 = NULL
      SELECT * INTO l_oap.* FROM oap_file WHERE oap01=g_oga.oga16
      IF l_oap.oap01 IS NOT NULL THEN
         LET l_oap.oap01=g_oga.oga01
         INSERT INTO oap_file VALUES (l_oap.*)
      END IF
   END IF

   #-----MOD-B40263---------
   CALL t600_ins_oao('a')
   #DROP TABLE x
   #
   #IF g_oga.oga09 MATCHES '[2468]' AND g_oga.oga01 != g_oga.oga011 THEN #No.FUN-630061
   #   SELECT * FROM oao_file WHERE oao01=g_oga.oga011 INTO TEMP x   
   #ELSE
   #   SELECT * FROM oao_file WHERE oao01=g_oga.oga16 INTO TEMP x   
   #END IF
   #
   #UPDATE x SET oao01 = g_oga.oga01
   #INSERT INTO oao_file SELECT * FROM x
   #
   #CALL t600_show_oao()
   #-----END MOD-B40263-----

   CALL s_addr(g_oga.oga01,g_oga.oga04,g_oga.oga044)
        RETURNING l_oap.oap041,
                  l_oap.oap042,
                  l_oap.oap043,
                  l_oap.oap044,  #FUN-720014
                  l_oap.oap045   #FUN-720014
   LET g_msg=l_oap.oap041 CLIPPED,' ',l_oap.oap042 CLIPPED,' ',
             l_oap.oap043 CLIPPED,' ',l_oap.oap044 CLiPPED,' ',   #MOD-910186 增加oap044/oap045
             l_oap.oap045 CLiPPED   #MOD-910186 增加oap044/oap045
   DISPLAY g_msg TO addr

   LET g_oga_t.* = g_oga.*
   RETURN TRUE
END FUNCTION

FUNCTION t600_b1_fill(p_wc2)              #BODY FILL UP
DEFINE p_wc2           LIKE type_file.chr1000 #No.FUN-680137 VARCHAR(200)
DEFINE l_sql    STRING
DEFINE l_sql2   STRING
DEFINE l_sql3   STRING
#FUN-A60035 ---MARK BEGIN
##FUN-A60035 ---add begin
#DEFINE l_ogb03  DYNAMIC ARRAY OF RECORD
#       ogb03    LIKE ogb_file.ogb03
#       END RECORD
#DEFINE l_i      LIKE type_file.num5
#DEFINE l_go     LIKE type_file.chr1
##FUN-A60035 ---add end
#FUN-A60035 ---MARK END

    LET l_sql =
        "SELECT ogb03,ogb1005,ogb31,ogb32,ogb48,ogb49,ogb04,'','','','','','','','','',",     #No.FUN-A90040
        "       '','','','','','','','','','','','',ogb06,ima021,ima1002,ima135,ogb11,ogb1001,ogb40,ogb1012,",  #No.FUN-610064 #FUN-B50054
        "       ogb17,ogb09,ogb091,ogb092,ogb1003,ogb19,ogb05,ogb12,ogb913,ogb914,",  #No:FUN-5C0075  No.FUN-610064
        "       ogb915,ogb910,ogb911,ogb912,ogb916,ogb917, ",
        "       0,0,0,ogb65,'','',",  #No.FUN-630061
        "       ogb41,ogb42,ogb43,",  #FUN-810045 add
        "       ogb1004,ogb1002,ogb37,ogb13,ogb1006,ogb14,ogb14t,",   #No.FUN-610064  #FUN-AB0061
        "       ogb930,'',ogb908 , " #no.A050 add ogb908  #FUN-670063
      LET l_sql2 =
        " '','','','', ",
        "       ogbud01,ogbud02,ogbud03,ogbud04,ogbud05,",
        "       ogbud06,ogbud07,ogbud08,ogbud09,ogbud10,",
        "       ogbud11,ogbud12,ogbud13,ogbud14,ogbud15,", 
         "       ogb44,ogb45,ogb46,ogb47 ",               #No.FUN-870007
        " FROM ogb_file,oga_file,OUTER ima_file ",        #MOD-7C0012-modify
        " WHERE ogb01 ='",g_oga.oga01,"'",  #單頭
        " AND ogb01 = oga01 "                             #MOD-7C0012-add
      LET l_sql3 =
        " AND ",p_wc2 CLIPPED,                     #單身
        " AND ogb04=ima_file.ima01 ",
       #" AND ogb1005 ='1'",         #No.TQC-640123 #TQC-B10066
        " AND ogb03 < 9001 ",                       #TQC-B10066
        " ORDER BY ogb03"
    LET l_sql = l_sql,l_sql2,l_sql3

    PREPARE t600_pb1 FROM l_sql
    DECLARE ogbglobal_curs1                       #CURSOR
        CURSOR FOR t600_pb1

    CALL g_ogb.clear()

    LET g_cnt = 1
    LET g_rec_b1 = 0     #No.TQC-640123
    FOREACH ogbglobal_curs1 INTO g_ogb[g_cnt].*   #單身 ARRAY 填充
       IF STATUS THEN CALL cl_err('foreach:',STATUS,1) EXIT FOREACH END IF
 #xiaoyx  --begin
    SELECT img10 INTO g_ogb[g_cnt].ogbud02
        FROM img_file
        WHERE img01=g_ogb[g_cnt].ogb04 AND img02=g_ogb[g_cnt].ogb09
         AND img03=g_ogb[g_cnt].ogb091 AND img04=g_ogb[g_cnt].ogb092
    #    DISPLAY BY NAME g_b2[g_cnt].ogbud02
    #xiaoyx --end

#FUN-A60035 ---MARK BEGIN
##FUN-A50054 --Begin
#&ifdef SLK
##      IF s_industry("slk") THEN
#         IF g_oga.oga09 MATCHES '[15]' THEN
#            SELECT oeaslk02 INTO g_oea.oeaslk02
#              FROM oea_file
#             WHERE oea01=g_oga.oga16
#         ELSE
#            IF NOT cl_null(g_oga.oga16) THEN
#               SELECT oeaslk02 INTO g_oea.oeaslk02
#                 FROM oea_file
#                WHERE oea01=g_oga.oga16
#            ELSE
#               SELECT oeaslk02 INTO g_oea.oeaslk02
#                 FROM oea_file,oga_file
#                WHERE oea01=oga16
#                  AND oga01=g_oga.oga011
#            END IF
#         END IF
#            
##         IF s_industry("slk") THEN
#            SELECT ata02,ata05 INTO g_ogb[g_cnt].ogb03,g_ogb[g_cnt].ogb04
#              FROM ata_file
#             WHERE ata00 = g_prog
#               AND ata01 = g_oga.oga01
#               AND ata03 = g_ogb[g_cnt].ogb03
#            LET l_ogb03[l_ogb03.getLength() + 1] = g_ogb[g_cnt].ogb03   #FUN-A60035 add
#            SELECT ata02 INTO g_ogb[g_cnt].ogb32
#              FROM ata_file
#             WHERE ata00 = g_prog
#               AND ata01 = g_oga.oga01
#               AND ata03=g_ogb[g_cnt].ogb32
#            IF g_cnt > 1 THEN
#               IF NOT cl_null(g_oga.oga16) THEN
#                  #FUN-A60035 ---mark begin
#                  #SELECT ata02 INTO g_ogb[g_cnt].ogb32 
#                  #  FROM ata_file 
#                  # #WHERE ata00=g_ata00       #FUN-A60035 mark
#                  # #  AND ata01=g_oga.oga16   #FUN-A60035 mark
#                  # WHERE ata00 = g_prog
#                  #   AND ata01 = g_oga.oga01
#                  #   AND ata03=g_ogb[g_cnt].ogb32
#                  #FUN-A60035 ---mark end
#               END IF
#            #FUN-A60035 mark begin
#            #   IF g_ogb[g_cnt].ogb03 = g_ogb[g_cnt-1].ogb03 THEN
#            #      CONTINUE FOREACH
#            #   END IF
#            #FUN-A60035 mark end
#            #FUN-A60035 ---add begin
#                LET l_go = 'N'
#                FOR l_i = 1 TO l_ogb03.getLength()-1
#                    IF g_ogb[g_cnt].ogb03 = l_ogb03[l_i].ogb03 THEN
#                       LET l_go = 'Y'
#                       EXIT FOR
#                    END IF
#                END FOR
#                IF l_go = 'Y' THEN
#                   CONTINUE FOREACH
#                END IF
#           #FUN-A60035 ---add end
#            END IF
#
#               SELECT SUM(ata08) INTO g_ogb[g_cnt].ogb12 from ata_file
#                WHERE ata00 = g_prog
#                  AND ata01 = g_oga.oga01
#                   AND ata02 = g_ogb[g_cnt].ogb03
##         END IF
##      ELSE
#&else
##FUN-A50054 --End
#FUN-A60035 ---MARK END
          #如果進行料件多屬性管理并選擇新機制則要對單身顯示的東東進行更改
          IF g_sma.sma120 = 'Y' AND g_sma.sma907 = 'Y' THEN
             #得到該料件對應的父料件和所有屬性
             SELECT imx00,imx01,imx02,imx03,imx04,imx05,imx06,
                    imx07,imx08,imx09,imx10 INTO
                    g_ogb[g_cnt].att00,g_ogb[g_cnt].att01,g_ogb[g_cnt].att02,
                    g_ogb[g_cnt].att03,g_ogb[g_cnt].att04,g_ogb[g_cnt].att05,
                    g_ogb[g_cnt].att06,g_ogb[g_cnt].att07,g_ogb[g_cnt].att08,
                    g_ogb[g_cnt].att09,g_ogb[g_cnt].att10
             FROM imx_file WHERE imx000 = g_ogb[g_cnt].ogb04

             LET g_ogb[g_cnt].att01_c = g_ogb[g_cnt].att01
             LET g_ogb[g_cnt].att02_c = g_ogb[g_cnt].att02
             LET g_ogb[g_cnt].att03_c = g_ogb[g_cnt].att03
             LET g_ogb[g_cnt].att04_c = g_ogb[g_cnt].att04
             LET g_ogb[g_cnt].att05_c = g_ogb[g_cnt].att05
             LET g_ogb[g_cnt].att06_c = g_ogb[g_cnt].att06
             LET g_ogb[g_cnt].att07_c = g_ogb[g_cnt].att07
             LET g_ogb[g_cnt].att08_c = g_ogb[g_cnt].att08
             LET g_ogb[g_cnt].att09_c = g_ogb[g_cnt].att09
             LET g_ogb[g_cnt].att10_c = g_ogb[g_cnt].att10
          END IF
#FUN-A60035 ---MARK BEGIN
##FUN-A50054 --Begin
##       END IF
#&endif
##FUN-A50054 --End
#FUN-A60035 ---MARK END
        IF cl_null(g_ogb[g_cnt].ogb910) THEN
           LET g_ogb[g_cnt].ogb911 = NULL
           LET g_ogb[g_cnt].ogb912 = NULL
        END IF
        IF cl_null(g_ogb[g_cnt].ogb913) THEN
           LET g_ogb[g_cnt].ogb914 = NULL
           LET g_ogb[g_cnt].ogb915 = NULL
        END IF
        IF g_ogb[g_cnt].ogb04[1,4]!='MISC' THEN
           SELECT ima1002,ima135 INTO g_ogb[g_cnt].ima1002,g_ogb[g_cnt].ima135
             FROM ima_file
            WHERE ima01 = g_ogb[g_cnt].ogb04
        END IF
        IF g_argv0 = '8' AND g_aza.aza26 != '2' THEN #FUN-C50097 ADD !=2 
           SELECT ogb12,ogb912,ogb915
             INTO g_ogb12_sum,g_ogb912_sum,g_ogb915_sum
             FROM ogb_file
            WHERE ogb01 = g_oga.oga011
              AND ogb03 = g_ogb[g_cnt].ogb03
           LET g_ogb[g_cnt].ogb12b  = g_ogb12_sum  - g_ogb[g_cnt].ogb12
           LET g_ogb[g_cnt].ogb915b = g_ogb915_sum - g_ogb[g_cnt].ogb915
           LET g_ogb[g_cnt].ogb912b = g_ogb912_sum - g_ogb[g_cnt].ogb912
#           #add by huyx110916---start--- ogbud07/ogbud08/ogbud09 取出货单上的栏位
#           SELECT ogbud07,ogbud08,ogb12-ogbud07-ogbud08,ogb12 INTO g_ogb[g_cnt].ogbud07,g_ogb[g_cnt].ogbud08,g_ogb[g_cnt].ogbud09,s_ogb12
#             FROM ogb_file
#            WHERE ogb01=g_oga.oga011    
#              AND ogb03=g_ogb[g_cnt].ogb03  
#           IF cl_null(g_ogb[g_cnt].ogbud07) THEN LET g_ogb[g_cnt].ogbud07=0 END IF
#           IF cl_null(g_ogb[g_cnt].ogbud08) THEN LET g_ogb[g_cnt].ogbud08=0 END IF
#           IF cl_null(g_ogb[g_cnt].ogbud09) THEN LET g_ogb[g_cnt].ogbud09=s_ogb12 END IF
#           #add by huyx110916---end--- 
        END IF
        #FUN-C50097 add begin------
        IF g_argv0 = '8' AND g_aza.aza26 = '2' THEN 
           IF  g_oaz.oaz94 = 'Y' THEN 
           ELSE 
              SELECT ogb12,ogb912,ogb915
                INTO g_ogb12_sum,g_ogb912_sum,g_ogb915_sum
                FROM ogb_file
               WHERE ogb01 = g_oga.oga011
                 AND ogb03 = g_ogb[g_cnt].ogb03
              LET g_ogb[g_cnt].ogb12b  = g_ogb12_sum  - g_ogb[g_cnt].ogb12
              LET g_ogb[g_cnt].ogb915b = g_ogb915_sum - g_ogb[g_cnt].ogb915
              LET g_ogb[g_cnt].ogb912b = g_ogb912_sum - g_ogb[g_cnt].ogb912
           END IF 
        END IF        
        #FUN-C50097 add end--------
        IF g_argv0 = '2' AND g_oga.oga65='Y' THEN
           SELECT ogb01 INTO g_ogb[g_cnt].ogb01a
             FROM ogb_file,oga_file
            WHERE ogb01 =oga01
              AND oga011=g_oga.oga01
              AND oga09 = '8'
              AND ogb03 = g_ogb[g_cnt].ogb03
           SELECT ogb01 INTO g_ogb[g_cnt].ogb01b
             FROM ogb_file,oga_file
            WHERE ogb01 =oga01
              AND oga011=g_oga.oga01
              AND oga09 = '9'
              AND ogb03 = g_ogb[g_cnt].ogb03
        END IF
        LET g_ogb[g_cnt].gem02c=s_costcenter_desc(g_ogb[g_cnt].ogb930) #FUN-670063
        LET g_cnt = g_cnt + 1
    END FOREACH
    IF g_aza.aza50='Y' THEN
       CALL t600_oga50_sum()    #No.FUN-610064
    END IF
    CALL g_ogb.deleteElement(g_cnt)
    LET g_rec_b1=g_cnt - 1            #No.TQC-640123
    DISPLAY g_rec_b1 TO FORMONLY.cn2
    LET g_cnt = 0
    CALL t600_refresh_detail()  #No.TQC-650088   刷新單身的欄位顯示
    #FUN-B30170 add begin-------------------------
    LET g_sql = " SELECT rvbs02,rvbs021,ima02,ima021,rvbs022,rvbs04,rvbs03,rvbs05,rvbs06,rvbs07,rvbs08,rvbs13",
                "   FROM rvbs_file LEFT JOIN ima_file ON rvbs021 = ima01",
                "  WHERE rvbs00 = '",g_prog,"' AND rvbs01 = '",g_oga.oga01,"'"
    PREPARE sel_rvbs_pre FROM g_sql
    DECLARE rvbs_curs CURSOR FOR sel_rvbs_pre
    
    CALL g_rvbs.clear()
    
    LET g_cnt = 1
    FOREACH rvbs_curs INTO g_rvbs[g_cnt].*   #單身 ARRAY 填充
       IF STATUS THEN CALL cl_err('foreach:',STATUS,1) EXIT FOREACH END IF
       LET g_cnt = g_cnt + 1
       IF g_cnt > g_max_rec THEN
          CALL cl_err( '', 9035, 0 )
          EXIT FOREACH
       END IF
    END FOREACH
    CALL g_rvbs.deleteElement(g_cnt)
    LET g_rec_b3 = g_cnt - 1
    #FUN-B30170 add -end--------------------------
END FUNCTION

FUNCTION t600_show()
   DEFINE l_oap RECORD LIKE oap_file.*
   DEFINE l_oea01 LIKE oea_file.oea01   #MOD-950276
   DEFINE l_azp02 LIKE azp_file.azp02   #No.FUN-870007
   DEFINE l_rtz03 LIKE rtz_file.rtz03   #FUN-B50054
   DEFINE ls_ogb12  LIKE ogb_file.ogb12,
          ls_ogb14t LIKE ogb_file.ogb14t  #xiaoyx
   DEFINE l_tot5  LIKE ogb_file.ogbud11   #NO.120912 add

    #xiaoyx
        SELECT SUM(ogb12),SUM(ogb14t) INTO ls_ogb12,ls_ogb14t
        FROM ogb_file
        WHERE ogb01=g_oga.oga01
        DISPLAY ls_ogb12 TO FORMONLY.ogb12f
        DISPLAY ls_ogb14t TO FORMONLY.ogb14f
   SELECT oga902 INTO g_oga.oga902 FROM oga_file
    WHERE oga01=g_oga.oga01

   LET g_oga_t.* = g_oga.*                #保存單頭舊值
   DISPLAY BY NAME g_oga.oga00  , g_oga.ogaoriu,g_oga.ogaorig,
           g_oga.oga08  ,g_oga.oga01  ,g_oga.oga69  ,g_oga.oga02  ,g_oga.oga021 ,
           g_oga.oga27  ,g_oga.oga011 ,g_oga.oga16  ,g_oga.oga1004,g_oga.oga03  ,
           g_oga.oga032 ,g_oga.oga04  ,g_oga.oga902 ,g_oga.oga14  ,g_oga.oga15  ,
           g_oga.oga23  ,g_oga.oga24  ,g_oga.oga1014, g_oga.oga1012,g_oga.oga21  ,
           g_oga.oga211 ,g_oga.oga212 ,g_oga.oga213 ,g_oga.oga10  ,g_oga.oga18 ,g_oga.oga907  ,   #FUN-920072 add oga907
           g_oga.oga1016,g_oga.oga25  ,g_oga.oga05  ,g_oga.oga13  ,g_oga.oga99,g_oga.oga70,   #No:FUN-740016
           g_oga.oga905 ,g_oga.ogaconf, g_oga.ogaspc ,g_oga.oga30  ,g_oga.ogapost,
           g_oga.ogamksg, g_oga.oga55  ,g_oga.oga65  ,g_oga.oga903 ,g_oga.oga914 ,
           g_oga.oga1002,g_oga.oga1009,g_oga.oga1011,g_oga.oga1010,g_oga.oga1015,
           g_oga.oga1003,g_oga.ogauser, g_oga.ogagrup, g_oga.ogamodu, g_oga.ogadate,
           g_oga.oga83  ,g_oga.oga84  ,g_oga.oga85  ,g_oga.oga86  ,                                                        
           g_oga.oga87  ,g_oga.ogaplant ,g_oga.oga57,g_oga.oga88  ,        #FUN-AA0057 add oga57                                                
           g_oga.oga89  ,g_oga.oga90  ,g_oga.oga91  ,g_oga.oga92  ,                                                        
           g_oga.oga93  ,g_oga.oga98  ,g_oga.oga94  ,g_oga.oga95  ,g_oga.oga96  ,      #FUN-A50071 add oga98
           g_oga.oga97  ,g_oga.ogaconu,g_oga.ogacond,g_oga.ogacont,      #FUN-A30063
           g_oga.ogaud01,g_oga.ogaud02,g_oga.ogaud03,g_oga.ogaud04,
           g_oga.ogaud05,g_oga.ogaud06,g_oga.ogaud07,g_oga.ogaud08,
           g_oga.ogaud09,g_oga.ogaud10,g_oga.ogaud11,g_oga.ogaud12,
           g_oga.ogaud13,g_oga.ogaud14,g_oga.ogaud15,g_oga.oga72                   #FUN-A60004 add oga72 

   CALL t600_chspic()

   IF g_oga.oga08='1' THEN
      LET exT=g_oaz.oaz52
   ELSE
      LET exT=g_oaz.oaz70
   END IF

  #FUN-B50054 Begin---
   IF g_azw.azw04 = '2' AND g_argv0 = '2' THEN
      SELECT rtz03 INTO l_rtz03 FROM rtz_file WHERE rtz01 = g_oga.oga83
      IF l_rtz03 = '3' THEN
         CALL cl_set_comp_visible("ogb40",TRUE)
      ELSE
         CALL cl_set_comp_visible("ogb40",FALSE)
      END IF
   END IF
  #FUN-B50054 End-----

   SELECT azi03,azi04 INTO t_azi03,t_azi04               #No.CHI-6A0004 g_azi-->t_azi
     FROM azi_file
    WHERE azi01=g_oga.oga23

   LET g_buf=s_get_doc_no(g_oga.oga01)       #No.FUN-550052

   SELECT oaydesc INTO g_buf FROM oay_file WHERE oayslip=g_buf
   DISPLAY g_buf TO oaydesc LET g_buf = NULL

   SELECT occ02 INTO g_buf FROM occ_file WHERE occ01=g_oga.oga04
   DISPLAY g_buf TO occ02 LET g_buf = NULL


   SELECT occ02 INTO g_buf FROM occ_file WHERE occ01=g_oga.oga1004
   DISPLAY g_buf TO oga1004_occ02 LET g_buf = NULL

   SELECT pmc02 INTO g_buf FROM pmc_file WHERE pmc01=g_oga.oga1016
   DISPLAY g_buf TO oga1016_occ02 LET g_buf = NULL

   SELECT occ02 INTO g_buf FROM occ_file WHERE occ01=g_oga.oga18
   DISPLAY g_buf TO oga18_ds LET g_buf = NULL

   SELECT gen02 INTO g_buf FROM gen_file WHERE gen01=g_oga.oga14
   DISPLAY g_buf TO gen02 LET g_buf = NULL

   SELECT gem02 INTO g_buf FROM gem_file WHERE gem01=g_oga.oga15
   DISPLAY g_buf TO gem02 LET g_buf = NULL

   SELECT oab02 INTO g_buf FROM oab_file WHERE oab01=g_oga.oga25
   DISPLAY g_buf TO oab02 LET g_buf = NULL

#NO.120912 add--------------------begin
   SELECT SUM(ogbud11) INTO l_tot5 FROM ogb_file
    WHERE ogb01 = g_oga.oga01
   DISPLAY l_tot5 TO FORMONLY.tot5
#NO.120912 ad-----------------------end

   CALL t600_oga902('d')    #FUN-9B0132
   --DIS--
   IF g_aza.aza50='Y' THEN
      SELECT tqa02 INTO g_buf FROM tqa_file WHERE tqa01=g_oga.oga1002
                                              AND tqa03='20'  #No.MOD-A60121
      DISPLAY g_buf TO oga1002_tqa02 LET g_buf = NULL

      SELECT tqa02 INTO g_buf FROM tqa_file WHERE tqa01=g_oga.oga1009
                                              AND tqa03='19'  #No.MOD-A60121
      DISPLAY g_buf TO oga1009_tqa02 LET g_buf = NULL
      SELECT occ02 INTO g_buf FROM occ_file WHERE occ01=g_oga.oga1001
      DISPLAY g_buf TO oga1001_occ02 LET g_buf = NULL

      SELECT occ02 INTO g_buf FROM occ_file WHERE occ01=g_oga.oga1011
      DISPLAY g_buf TO oga1011_occ02 LET g_buf = NULL

      SELECT tqb02 INTO g_buf FROM tqb_file WHERE tqb01=g_oga.oga1010
      DISPLAY g_buf TO oga1010_tqb02 LET g_buf = NULL

      SELECT tqb02 INTO g_buf FROM tqb_file WHERE tqb01=g_oga.oga1003
      DISPLAY g_buf TO oga1003_tqb02 LET g_buf = NULL

      SELECT pmc03 INTO g_buf FROM pmc_file WHERE pmc01=g_oga.oga1015
      DISPLAY g_buf TO oga1015_occ02 LET g_buf = NULL
      CALL t600_oga1002('d')
      CALL t600_oga1009('d')
      CALL t600_oga1011('d')
      CALL t600_oga1010('d')
      CALL t600_oga1015('d')
      CALL t600_oga1003('d')
   END IF
   --DIS--

   CALL cl_show_fld_cont()                   #No:FUN-550037 hmf

   SELECT oma10 INTO g_buf FROM oma_file WHERE oma01=g_oga.oga10
   DISPLAY g_buf TO oma10 LET g_buf = NULL

   IF g_argv0='2' AND g_oga.oga00 MATCHES '[37]' THEN
      DECLARE oea_cs SCROLL CURSOR FOR
       SELECT oea01 FROM oea_file
         WHERE oea11='7' AND oea12 = g_oga.oga01
            AND oeaconf != 'X'
      OPEN oea_cs
      LET l_oea01 = ''
      FETCH FIRST oea_cs INTO l_oea01
      DISPLAY l_oea01 TO oea01
   END IF

   CALL t600_show3()

   CALL s_addr(g_oga.oga01,g_oga.oga04,g_oga.oga044)
        RETURNING l_oap.oap041,l_oap.oap042,l_oap.oap043,l_oap.oap044,l_oap.oap045  #FUN-720014 add 044/045

   LET g_msg=l_oap.oap041 CLIPPED,' ',l_oap.oap042 CLIPPED,' ',
             l_oap.oap043 CLIPPED,' ',l_oap.oap044 CLiPPED,' ',   #MOD-910186 增加oap044/oap045
             l_oap.oap045 CLiPPED   #MOD-910186 增加oap044/oap045
   DISPLAY g_msg TO addr
   CALL t600_oga1004('d')
   CALL t600_oga1016('d')
   CALL t600_oga18('d')  #No.FUN-610064
   IF g_azw.azw04='2' THEN
      CALL t600_oga84('d')                                                                                                         
      CALL t600_ogaconu('d')
      SELECT azp02 INTO l_azp02 FROM azp_file
       WHERE azp01 = g_plant
      DISPLAY l_azp02,l_azp02 TO ogaplant_desc,oga83_desc
  END IF

   CALL t600_show_oao()

   CALL t600_b1_fill(g_wc2)     #No.TQC-640123
   CALL t600_b2_fill(g_wc3)     #No.TQC-640123
   DISPLAY g_rec_b1 TO FORMONLY.cn2    #No.MOD-670123

   CALL cl_show_fld_cont()                   #No:FUN-550037 hmf
   #CHI-AC0002 add --start--
   CALL cl_set_act_visible("entry_sheet2",TRUE)
   IF g_aza.aza63 = 'N' THEN
      CALL cl_set_act_visible("entry_sheet2",FALSE)
   END IF
   #CHI-AC0002 add --end--
END FUNCTION

FUNCTION t600_chkkey()

   UPDATE ogb_file SET ogb01=g_oga.oga01 WHERE ogb01=g_oga_t.oga01
   IF STATUS THEN
      CALL cl_err3("upd","ogb_file","g_oga_t.oga01","",SQLCA.sqlcode,"","upd ogb01",1)  #No.FUN-670008
      RETURN FALSE
   END IF

   UPDATE ogc_file SET ogc01=g_oga.oga01 WHERE ogc01=g_oga_t.oga01
   IF STATUS THEN
      CALL cl_err3("upd","ogc_file","g_oga_t.oga01","",SQLCA.sqlcode,"","upd ogc01",1)  #No.FUN-670008
      RETURN FALSE
   END IF

   UPDATE rvbs_file SET rvbs01=g_oga.oga01 WHERE rvbs01=g_oga_t.oga01
   IF STATUS THEN
      CALL cl_err3("upd","rvbs_file","g_oga_t.oga01","",SQLCA.sqlcode,"","upd rvbs01",1)  
      RETURN FALSE
   END IF


   UPDATE oao_file SET oao01=g_oga.oga01 WHERE oao01=g_oga_t.oga01
   IF STATUS THEN
      CALL cl_err3("upd","oao_file","g_oga_t.oga01","",SQLCA.sqlcode,"","upd oao01",1)  #No.FUN-670008
      RETURN FALSE
   END IF

   UPDATE oap_file SET oap01=g_oga.oga01 WHERE oap01=g_oga_t.oga01
   IF STATUS THEN
      CALL cl_err3("upd","oap_file","g_oga_t.oga01","",SQLCA.sqlcode,"","upd oap01",1)  #No.FUN-670008
      RETURN FALSE
   END IF
   IF g_aza.aza50='Y' THEN
      CALL t600_oga50_sum()    #No.FUN-610064
   END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_oga50_sum()
DEFINE l_sum1     LIKE ogb_file.ogb14
DEFINE l_sum1_t   LIKE ogb_file.ogb14t
DEFINE l_sum      LIKE ogb_file.ogb14
DEFINE l_sum_t    LIKE ogb_file.ogb14t
DEFINE l_tax      LIKE ogb_file.ogb14t
DEFINE l_tax1     LIKE ogb_file.ogb14t
DEFINE l_tot3     LIKE ogb_file.ogb14t

    SELECT azi03,azi04 INTO t_azi03,t_azi04   #No.CHI-6A0004 g_azi-->t_azi
      FROM azi_file
     WHERE azi01=g_oga.oga23

    SELECT SUM(ogb14),SUM(ogb14t) into l_sum1,l_sum1_t
      FROM ogb_file
     WHERE ogb01 = g_oga.oga01
       AND ogb1005 ='1'

    SELECT SUM(ogb14),SUM(ogb14t) into l_sum,l_sum_t
      FROM ogb_file
     WHERE ogb01 = g_oga.oga01
       AND ogb1005 ='2'

    IF cl_null(l_sum1) THEN
       LET l_sum1=0
    ELSE
    CALL cl_numfor(l_sum1,8,t_azi04) RETURNING l_sum1     #No.CHI-6A0004 g_azi-->t_azi
    END IF

    IF cl_null(l_sum) THEN
       LET l_sum=0
    ELSE
    CALL cl_numfor(l_sum,8,t_azi04) RETURNING l_sum        #No.CHI-6A0004 g_azi-->t_azi
    END IF

    IF cl_null(l_sum1_t) THEN
       LET l_sum1_t=0
    ELSE
    CALL cl_numfor(l_sum1_t,8,t_azi04) RETURNING l_sum1_t    #No.CHI-6A0004 g_azi-->t_azi
    END IF

    IF cl_null(l_sum_t) THEN
       LET l_sum_t=0
    ELSE
    CALL cl_numfor(l_sum_t,8,t_azi04) RETURNING l_sum_t     #No.CHI-6A0004 g_azi-->t_azi
    END IF

    UPDATE oga_file SET oga50=l_sum1,oga1008=l_sum1_t
     WHERE oga01 = g_oga.oga01

    UPDATE oga_file SET oga1006=l_sum,oga1007=l_sum_t
     WHERE oga01 = g_oga.oga01

    LET g_oga.oga50 = l_sum1
    LET g_oga.oga1008 = l_sum1_t
    LET g_oga.oga1006 = l_sum
    LET g_oga.oga1007 = l_sum_t
    LET l_tax = l_sum_t - l_sum
    LET l_tax1= l_sum1_t - l_sum1
    LET g_oga.oga53 =g_oga.oga50 -g_oga.oga1006
    UPDATE oga_file SET oga53=g_oga.oga53
     WHERE oga01 = g_oga.oga01
    CALL cl_numfor(l_tax,8,t_azi04) RETURNING l_tax     #No.CHI-6A0004 g_azi-->t_azi
    CALL cl_numfor(l_tax1,8,t_azi04) RETURNING l_tax1   #No.CHI-6A0004 g_azi-->t_azi
    LET l_tot3 = g_oga.oga50 + l_tax1 - g_oga.oga1006 - l_tax
    CALL cl_numfor(l_tot3,8,t_azi04) RETURNING l_tot3   #No.CHI-6A0004 g_azi-->t_azi

    DISPLAY g_oga.oga50 TO oga50
    DISPLAY g_oga.oga1008 TO oga1008
    DISPLAY g_oga.oga1006 TO oga1006
    DISPLAY l_tax1 to FORMONLY.tot1
    DISPLAY l_tax  to FORMONLY.tot2
    DISPLAY l_tot3 to FORMONLY.tot3
END FUNCTION

FUNCTION t600_b2()
DEFINE
    l_ogb12a        LIKE ogb_file.ogb12,
    l_ogb12b        LIKE ogb_file.ogb12,
    l_ogb912a       LIKE ogb_file.ogb912,
    l_ogb912b       LIKE ogb_file.ogb912,
    l_ogb915a       LIKE ogb_file.ogb915,
    l_ogb915b       LIKE ogb_file.ogb915,
    l_ogb917a       LIKE ogb_file.ogb917,
    l_ogb917b       LIKE ogb_file.ogb917,
    l_oeb25         LIKE oeb_file.oeb25,
    l_ac_t          LIKE type_file.num5,                #未取消的ARRAY CNT  #No.FUN-680137 SMALLINT
    l_row,l_col     LIKE type_file.num5,    #No.FUN-680137 SMALLINT        #分段輸入之行,列數
    l_n,l_cnt       LIKE type_file.num5,                #檢查重複用  #No.FUN-680137 SMALLINT
    l_lock_sw       LIKE type_file.chr1,                 #單身鎖住否  #No.FUN-680137 VARCHAR(1)
    p_cmd           LIKE type_file.chr1,                 #處理狀態  #No.FUN-680137 VARCHAR(1)
    l_b2            LIKE cob_file.cob08,  #No.FUN-680137 VARCHAR(30)
    l_misc          LIKE type_file.chr4,    #No.FUN-680137 VARCHAR(04)
    l_ima35         LIKE ima_file.ima35, #MOD-5B0276
    l_ima36         LIKE ima_file.ima36, #MOD-5B0276
    l_coc04         LIKE coc_file.coc04,   #No:MOD-4B0275
    l_coc10         LIKE coc_file.coc10,   #No:MOD-4B0275
    l_qty           LIKE ogb_file.ogb12,
    l_last_plant    LIKE poy_file.poy04,
    l_num           LIKE type_file.num5,    #No.FUN-680137 SMALLINT
    l_max           LIKE tqw_file.tqw08,    #No.FUN-610064
    l_oea904        LIKE oea_file.oea904,
    l_exit_sw       LIKE type_file.num5,    #No.FUN-680137 SMALLINT
    l_allow_insert  LIKE type_file.num5,                #可新增否  #No.FUN-680137 SMALLINT
    l_allow_delete  LIKE type_file.num5,                 #可刪除否  #No.FUN-680137 SMALLINT
    l_oga55         LIKE oga_file.oga55,
    l_azf10         LIKE azf_file.azf10,    #No.FUN-6B0065
    l_fac           LIKE ogb_file.ogb05_fac #No.FUN-610064
DEFINE li_result    LIKE type_file.num5                 #No.FUN-550052  #No.FUN-680137 SMALLINT
DEFINE l_err        LIKE type_file.chr1     #No:FUN-670007
DEFINE l_oea99      LIKE oea_file.oea99
DEFINE l_oea09      LIKE oea_file.oea09     #MOD-860202

    LET g_action_choice = ""
    IF g_prog ='axmt628' THEN
       RETURN
    END IF
    IF g_oga.oga01 IS NULL THEN RETURN END IF
    SELECT * INTO g_oga.* FROM oga_file WHERE oga01 = g_oga.oga01
    LET l_oga55 = g_oga.oga55      #FUN-550050
    IF g_oga.ogaconf = 'X' THEN CALL cl_err('',9024,0) RETURN END IF
    IF g_argv0 MATCHES '[15A]' THEN      #No.7992   #MOD-870224
       IF g_oga.ogaconf = 'Y' THEN
          CALL cl_err('',9023,0) RETURN
       END IF
    END IF
    IF g_argv0 MATCHES '[24689]' THEN     #No.7992  #No.FUN-630061
       IF g_oga.ogaconf = 'Y' THEN
          CALL cl_err('',9023,0) RETURN
       END IF
       IF g_oga.ogapost = 'Y' THEN
          CALL cl_err('','mfg0175',0) RETURN
       END IF
    END IF

    IF g_argv0 MATCHES '[15]' AND g_oga.oga011 IS NOT NULL THEN #No.7992
       CALL cl_err('oga011!='':','axm-228',0) RETURN
    END IF
    IF g_oga.oga55 matches '[Ss]' THEN       #FUN-550050
        CALL cl_err('','apm-030',0)
        RETURN
    END IF

    LET l_exit_sw = TRUE
    CALL cl_opmsg('b')

    LET g_forupd_sql = "SELECT * FROM ogb_file ",
                       " WHERE ogb01= ? AND ogb03= ?  FOR UPDATE "
    LET g_forupd_sql = cl_forupd_sql(g_forupd_sql)
    DECLARE t600_bcl2 CURSOR FROM g_forupd_sql      # LOCK CURSOR

    LET l_allow_insert = cl_detail_input_auth("insert")
    LET l_allow_delete = cl_detail_input_auth("delete")
  WHILE TRUE
    IF NOT l_exit_sw THEN CALL t600_b2_fill(' 1=1') END IF
    LET l_exit_sw = TRUE
    INPUT ARRAY g_b2 WITHOUT DEFAULTS FROM s_b2.*
        ATTRIBUTE(COUNT=g_rec_b2,MAXCOUNT=g_max_rec,UNBUFFERED,      #No.TQC-640123
                  INSERT ROW=l_allow_insert, DELETE ROW=l_allow_delete,
                  APPEND ROW=l_allow_insert)

        BEFORE INPUT
            IF g_rec_b2 != 0 THEN      #No.TQC-640123
               CALL fgl_set_arr_curr(l_ac)
            END IF
            LET g_before_input_done = FALSE
            LET g_before_input_done = TRUE

        BEFORE ROW
            LET p_cmd = ''
            LET l_ac = ARR_CURR()
            LET l_lock_sw = 'N'                   #DEFAULT
            LET g_b2[l_ac].ogb1005 ='2'

            BEGIN WORK

            OPEN t600_cl USING g_oga.oga01
            IF STATUS THEN
               CALL cl_err("OPEN t600_cl:", STATUS, 1)
               CLOSE t600_cl
               ROLLBACK WORK
               RETURN
            END IF

            FETCH t600_cl INTO g_oga.*  # 鎖住將被更改或取消的資料
            IF SQLCA.sqlcode THEN
               CALL cl_err(g_oga.oga01,SQLCA.sqlcode,0)     # 資料被他人LOCK
               CLOSE t600_cl ROLLBACK WORK RETURN
            END IF

            IF g_rec_b2 >= l_ac THEN      #No.TQC-640123

               LET p_cmd='u'
               LET g_b2_t.* = g_b2[l_ac].*  #BACKUP

               OPEN t600_bcl2 USING g_oga.oga01,g_b2_t.ogb03
               IF STATUS THEN
                  CALL cl_err("OPEN t600_bcl2:", STATUS, 1)
                  LET l_lock_sw = "Y"
               ELSE
                  FETCH t600_bcl2 INTO b_ogb.*
                  IF SQLCA.sqlcode THEN
                     CALL cl_err('lock ogb',SQLCA.sqlcode,1)
                     LET l_lock_sw = "Y"
                  ELSE
                     CALL t600_b2_move_to()
                  END IF
                END IF
                LET g_change='N' #No.FUN-540049
                LET g_yes   ='N' #No.FUN-540049
                CALL t600_set_entry_b2('u')
                CALL t600_set_no_entry_b2('u')
                CALL t600_set_no_required_b2('u')
                CALL t600_set_required_b2('u')
                CALL cl_show_fld_cont()     #FUN-550037(smin)
            END IF

        BEFORE INSERT
            LET p_cmd='a'
            INITIALIZE g_b2[l_ac].* TO NULL      #900423
            LET b_ogb.ogb01=g_oga.oga01
            LET g_b2[l_ac].ogb1005 =2      #No.FUN-610064
            LET g_change='Y'
            LET g_yes   ='N'
            LET b_ogb.ogb60=0
            LET b_ogb.ogb63=0
            LET b_ogb.ogb64=0
            LET b_ogb.ogb65=''  #No.FUN-630061
            IF NOT cl_null(g_oga.oga16) THEN
              LET g_b2[l_ac].ogb31 = g_oga.oga16
            END IF
            CALL cl_set_comp_required("b2_31,b2_32",FALSE)
            CALL t600_ogb1005_2()
            LET g_b2_t.* = g_b2[l_ac].*             #新輸入資料
             CALL t600_set_entry_b2(p_cmd)     #No:MOD-570264
             CALL t600_set_no_required_b2(p_cmd) #No:MOD-570264
            CALL cl_show_fld_cont()     #FUN-550037(smin)
            NEXT FIELD b2_03

        AFTER INSERT
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               LET g_flag2 = '1'   #CHI-920012
               CANCEL INSERT
            END IF


            CALL t600_b2_move_back()

            IF cl_null(b_ogb.ogb05_fac) THEN
               LET b_ogb.ogb05_fac = 1
            END IF
            IF cl_null(b_ogb.ogb12) THEN
               LET b_ogb.ogb12 = 0
            END IF
            IF cl_null(b_ogb.ogb13) THEN
               LET b_ogb.ogb13 = 0
            END IF
#FUN-AB0061 -----------add start----------------                             
            IF cl_null(b_ogb.ogb37) OR b_ogb.ogb37=0 THEN
               LET b_ogb.ogb37 = b_ogb.ogb13
            END IF                                             
#FUN-AB0061 -----------add end----------------              
            IF cl_null(b_ogb.ogb14) THEN
               LET b_ogb.ogb14 = 0
            END IF
            IF cl_null(b_ogb.ogb14t) THEN
               LET b_ogb.ogb14t = 0
            END IF
            IF cl_null(b_ogb.ogb15_fac) THEN
               LET b_ogb.ogb15_fac = 1
            END IF
            IF cl_null(b_ogb.ogb16) THEN
               LET b_ogb.ogb16 = 0
            END IF
            IF cl_null(b_ogb.ogb18) THEN
               LET b_ogb.ogb18 = 0
            END IF
            IF cl_null(b_ogb.ogb60) THEN
               LET b_ogb.ogb60 = 0
            END IF
            IF cl_null(b_ogb.ogb63) THEN
               LET b_ogb.ogb63 = 0
            END IF
            IF cl_null(b_ogb.ogb64) THEN
               LET b_ogb.ogb64 = 0
            END IF

            LET b_ogb.ogb04    = 'MISC'  #MOD-AC0170
            LET b_ogb.ogb12    = 1       #MOD-AC0170
            LET b_ogb.ogb917   = 1       #MOD-AC0170
            LET b_ogb.ogbplant = g_plant 
            LET b_ogb.ogblegal = g_legal  
            #add by huyx110916---start---
            IF cl_null(b_ogb.ogbud07) THEN LET b_ogb.ogbud07=0 END IF
            IF cl_null(b_ogb.ogbud08) THEN LET b_ogb.ogbud08=0 END IF
            IF cl_null(b_ogb.ogbud09) THEN LET b_ogb.ogbud09=0 END IF
            #add by huyx110916---end--- 
      #     IF cl_null(b_ogb.ogb50) THEN LET b_ogb.ogb50 = '1' END IF #FUN-AA0057

            INSERT INTO ogb_file VALUES(b_ogb.*)
            IF SQLCA.sqlcode THEN
               CALL cl_err3("ins","ogb_file","","",SQLCA.sqlcode,"","",1)  #No.FUN-670008
               CANCEL INSERT
               IF g_argv0 <> '1' OR (g_argv0='1' AND g_oaz.oaz81='Y') THEN  #FUN-850120 add
               LET g_ima918 = ''   #MOD-9C0055
               LET g_ima921 = ''   #MOD-9C0055
               SELECT ima918,ima921 INTO g_ima918,g_ima921 
                 FROM ima_file
                WHERE ima01 = g_ogb[l_ac].ogb04
                  AND imaacti = "Y"
               
               IF g_ima918 = "Y" OR g_ima921 = "Y" THEN
                  IF NOT s_lotout_del(g_prog,g_oga.oga01,g_ogb[l_ac].ogb03,0,g_ogb[l_ac].ogb04,'DEL') THEN   #No:FUN-860045
                     CALL cl_err3("del","rvbs_file",g_oga.oga01,g_ogb_t.ogb03,
                                   SQLCA.sqlcode,"","",1)
                     ROLLBACK WORK      #CHI-A10016 
                     CANCEL INSERT      #CHI-A10016
                  END IF
               END IF
               END IF #FUN-850120 add
            ELSE
               CALL cl_msg('INSERT O.K')
               LET l_oga55 = '0'          #FUN-550050
               CALL t600_mlog('A')
               LET g_rec_b2=g_rec_b2+1        #No.TQC-640123
               DISPLAY g_rec_b2 TO FORMONLY.cn2
               CALL t600_oga50_sum()    #No.FUN-610064
               COMMIT WORK
            END IF


        BEFORE FIELD b2_03                            #default 序號
            IF g_b2[l_ac].ogb03 IS NULL OR g_b2[l_ac].ogb03 = 0 THEN
                SELECT max(ogb03)+1 INTO g_b2[l_ac].ogb03
                   FROM ogb_file WHERE ogb01 = g_oga.oga01
                                   AND ogb1005 ='2'
                IF g_b2[l_ac].ogb03 IS NULL THEN
                    LET g_b2[l_ac].ogb03 = 9001
                END IF
            END IF
            CALL t600_set_entry_b2('') #No.FUN-630061

        AFTER FIELD b2_03                        #check 序號是否重複
            IF NOT cl_null(g_b2[l_ac].ogb03) THEN
               IF g_b2[l_ac].ogb03 != g_b2_t.ogb03 OR
                  g_b2_t.ogb03 IS NULL THEN
                   LET g_cnt=0
                   SELECT count(*) INTO g_cnt FROM ogb_file
                       WHERE ogb01 = g_oga.oga01 AND ogb03 = g_b2[l_ac].ogb03
                         AND ogb1005 ='2'
                         AND ogb03>='9001'
                   IF g_cnt > 0 THEN
                       LET g_b2[l_ac].ogb03 = g_b2_t.ogb03
                       CALL cl_err('',-239,0) NEXT FIELD b2_03
                   END IF
               END IF
                 IF g_b2[l_ac].ogb03 < 9001 THEN
                    CALL cl_err('','atm-003',0)
                    LET g_b2[l_ac].ogb03 = g_b2_t.ogb03
                    NEXT FIELD b2_03
                 END IF
            END IF
            CALL t600_set_no_entry_b2('') #No.FUN-630061
            IF g_b2[l_ac].ogb03<=0 THEN
               CALL cl_err('','aim-223',0)
               NEXT FIELD b2_03
            END IF
        AFTER FIELD b2_31

           IF NOT cl_null(g_b2[l_ac].ogb31) THEN
              IF NOT cl_null(g_oga.oga16) THEN
                 IF g_oga.oga16!=g_b2[l_ac].ogb31 THEN
                    CALL cl_err(g_b2[l_ac].ogb31,'axm-140',0)
                    NEXT FIELD b2_31
                 END IF
              IF g_b2[l_ac].ogb31[1,4] !='MISC' THEN
                 #若採訂單匯率立帳則幣別匯率相同才可併單
                 IF NOT t600sub_oea18_chk(g_b2_t.ogb03,g_oga.*,g_b2[l_ac].ogb31,TRUE) THEN
                    NEXT FIELD b2_31
                 ELSE
                    SELECT oga24 INTO g_oga.oga24 FROM oga_file WHERE oga01=g_oga.oga01 #FUN-730012 add oga24的值可能被異動,必須重抓
                 END IF
                 IF NOT cl_null(g_oga.oga16)
                        AND g_b2[l_ac].ogb31!=g_oga.oga16 THEN
                    CALL cl_err('','axm-140',0) NEXT FIELD b2_31
                #FUN-AC0097 Begin---
                #ELSE
                #   IF NOT cl_null(g_b2[l_ac].ogb31) AND
                #      g_b2[l_ac].ogb31[1,4] !='MISC' THEN
                #      CALL t600_ogb31(g_ogb[l_ac].ogb31,g_ogb_t.ogb31) RETURNING li_result     #check 單別
                #      IF (NOT li_result) THEN
                #           NEXT FIELD b2_31
                #      END IF
                #   END IF
                #FUN-AC0097 End-----
                 END IF
                SELECT * INTO g_oea.* FROM oea_file WHERE oea01=g_ogb[l_ac].ogb31 #MOD-810258 add
                 IF g_oea.oeaconf != 'Y' THEN   #未確認 01/08/16 mandy
                    CALL cl_err('sel oea','axm-184',0) NEXT FIELD b2_31
                 END IF

                 IF NOT cl_null(g_oea.oeahold) THEN
                    CALL cl_err('oeahold','axm-151',0) NEXT FIELD b2_31
                 END IF

                     IF g_oea.oea08 != g_oga.oga08 THEN #國內外不符
                        CALL cl_err('sel oea','axm-125',0) NEXT FIELD b2_31
                     END IF
                     IF g_oea.oea03 != g_oga.oga03 THEN #客戶不符  #No.FUN-610064#No.FUN-610064
                         CALL cl_err('sel oea','axm-138',0) NEXT FIELD b2_31
                     END IF
                     IF g_oea.oea21 != g_oga.oga21 THEN #稅別不符
                         CALL cl_err('sel oea','axm-142',0) NEXT FIELD b2_31
                     END IF
                     IF g_oea.oea23 != g_oga.oga23 THEN #幣別不符
                        CALL cl_err('sel oea','axm-144',0) NEXT FIELD b2_31
                     END IF

                     IF g_oea.oea32 != g_oga.oga32 THEN #收款條件不符
                        CALL cl_err('sel oea','axm-143',0) RETURN FALSE
                     END IF

                 #判斷是否為三角貿易訂單 No.7992
                 IF cl_null(g_oga.oga909) OR g_oga.oga909 = 'N' THEN
                    IF g_oea.oea901 = 'Y' THEN
                       CALL cl_err('','tri-015',1) NEXT FIELD b2_31
                    END IF
                 END IF
                 IF g_oga.oga909 = 'Y' THEN
                    #是否為三角貿易訂單
                    IF cl_null(g_oea.oea901) OR g_oea.oea901='N' THEN
                       CALL cl_err('','tri-014',1) NEXT FIELD b2_31
                    END IF
                    #是否三角貿易已拋轉各廠
                    IF g_oea.oea905 = 'N'  OR g_oea.oea905 IS NULL THEN
                       CALL cl_err('oea906','axm-307',0) NEXT FIELD b2_31
                    END IF
                    #檢查流程代碼
                    CALL t600sub_chkpoz(g_oga.*,g_b2[l_ac].ogb31) RETURNING li_result,g_poz.*,l_oea99,g_flow #FUN-730012
                    IF NOT li_result THEN NEXT FIELD b2_31 END IF #FUN-730012

                    IF g_argv0 MATCHES '[456]' THEN #多角出貨    #No:MOD-5B0325
                       IF g_poz.poz011 = '1' THEN  #正拋方式
                          #檢查是否為起始訂單
                          IF g_oea.oea906 = 'N' OR cl_null(g_oea.oea906) THEN
                             CALL cl_err('oea906','axm-409',0)
                             NEXT FIELD b2_31
                          END IF
                       END IF
                       IF g_poz.poz011 = '2' THEN  #反拋方式
                          CALL t600_last() RETURNING l_err
                          IF l_err ="1" THEN
                             NEXT FIELD b2_31
                          END IF
                       END IF
                       #判斷銷售段 OR 代採段之訂單
                       IF g_argv0 = '4' THEN       #銷售段
                          IF g_oea.oea11 ='6' THEN
                             CALL cl_err('','axm-022',1) NEXT FIELD b2_31
                          END IF
                          IF g_poz.poz00 ='2' THEN
                             CALL cl_err(g_flow,'tri-008',1) NEXT FIELD b2_31
                          END IF
                       END IF
                       IF g_argv0 = '6' THEN       #代採段
                          IF g_oea.oea11 <> '6' THEN
                             CALL cl_err('','axm-023',1) NEXT FIELD b2_31
                          END IF
                          IF g_poz.poz011 <> '2' THEN
                             CALL cl_err('','axm-027',0)
                             NEXT FIELD b2_31
                          END IF
                          IF g_poz.poz00 ='1' THEN
                             CALL cl_err(g_flow,'tri-008',1) NEXT FIELD b2_31
                          END IF
                       END IF
                    END IF
                    #判斷流程代碼是否相同
                    LET l_num =0
                    DECLARE t600_chk12 CURSOR FOR
                        SELECT oea904 FROM ogb_file,oea_file
                          WHERE ogb31 = oea01
                            AND ogb01 = g_oga.oga01
                    FOREACH t600_chk12 INTO l_oea904
                       IF SQLCA.SQLCODE <> 0 THEN EXIT FOREACH END IF
                       LET l_num = l_num+1
                       IF NOT cl_null(l_oea904) THEN
                          EXIT FOREACH
                       END IF
                    END FOREACH
                    IF l_oea904 <> g_oea.oea904 AND l_num > 0 THEN
                       CALL cl_err(g_oea.oea901,'axm-501',0)
                       NEXT FIELD b2_31
                    END IF
                 END IF
                 END IF
              END IF
              IF g_b2[l_ac].ogb31 != g_b2_t.ogb31 OR g_b2_t.ogb31 IS NULL THEN   #FUN-670007
                 CALL t600_ogb32(g_b2[l_ac].ogb31,g_b2[l_ac].ogb32)
              END IF                    #FUN-670007
#end
           END IF
           CALL t600_set_no_entry_b2(p_cmd)
           CALL t600_set_required_b2(p_cmd)
           IF NOT cl_null(g_b2[l_ac].ogb31) THEN
              NEXT FIELD b2_32
           END IF

        BEFORE FIELD b2_32

        AFTER FIELD b2_32
           IF cl_null(g_b2[l_ac].ogb32) THEN
              IF NOT cl_null(g_b2[l_ac].ogb31) THEN
                 CALL cl_err('','atm-243',0)
                 NEXT FIELD b2_31
              END IF
           END IF
           IF NOT cl_null(g_b2[l_ac].ogb31) AND NOT cl_null(g_b2[l_ac].ogb32) THEN
              CALL cl_set_comp_entry("b2_1001" ,FALSE)
           ELSE
              CALL cl_set_comp_entry("b2_1001" ,TRUE)
           END IF
           IF NOT cl_null(g_b2[l_ac].ogb32) THEN
              IF cl_null(g_b2[l_ac].ogb31) THEN
                 NEXT FIELD b2_31
              END IF
              IF g_b2[l_ac].ogb31[1,4] !='MISC' THEN
                 IF g_argv0 MATCHES '[246]' AND NOT cl_null(g_oga.oga011) THEN #No.FUN-630061
                    SELECT COUNT(*) INTO g_cnt FROM oga_file,ogb_file
                     WHERE oga01=g_oga.oga011
                       AND oga01=ogb01 AND oga09 IN ('1','5')  #No.7992
                       AND ogb31=g_b2[l_ac].ogb31 AND ogb32=g_b2[l_ac].ogb32
                    IF g_cnt=0 THEN     #本訂單號不存在出貨通知單內
                       CALL cl_err('sel ogb(1):','axm-224',0) NEXT FIELD b2_32
                    END IF
                 END IF
                 SELECT * INTO g_oeb.* FROM oeb_file
                  WHERE oeb01=g_b2[l_ac].ogb31 AND oeb03=g_b2[l_ac].ogb32
                    AND oeb1003 = g_b2[l_ac].ogb1005   #No.FUN-610064
                 IF STATUS THEN
                    CALL cl_err3("sel","oeb_file",g_b2[l_ac].ogb31,g_b2[l_ac].ogb32,SQLCA.sqlcode,"","sel oeb",1)  #No.FUN-670008
                    NEXT FIELD b2_32
                 END IF
                 IF g_argv0 MATCHES '[246]' AND g_oeb.oeb1003='1' THEN
                    LET l_oea09=''
                    SELECT oea09 INTO l_oea09 FROM oea_file 
                      WHERE oea01=g_b2[l_ac].ogb31
                    IF ((g_oeb.oeb12*((100+l_oea09)/100))-
                        g_oeb.oeb24+g_oeb.oeb25) <= 0 THEN 
                       CALL cl_err('sel oeb','axm-148',0) NEXT FIELD b2_32
                    END IF
                 END IF
                 IF g_oeb.oeb70 = 'Y' THEN
                    CALL cl_err('sel oeb','axm-150',0) NEXT FIELD b2_32
                 END IF
                 IF p_cmd='a' OR g_b2[l_ac].ogb31!=g_b2_t.ogb31
                              OR g_b2[l_ac].ogb32!=g_b2_t.ogb32 THEN
                    IF g_argv0 MATCHES '[15]' THEN  #No.7992
                       SELECT COUNT(*) INTO g_cnt FROM ogb_file
                        WHERE ogb01=g_oga.oga01
                          AND ogb31=g_b2[l_ac].ogb31
                          AND ogb32=g_b2[l_ac].ogb32
                          AND ogb1007=g_b2[l_ac].ogb1007
                       IF g_cnt > 0 THEN
                          CALL cl_err('','axm-298',0) NEXT FIELD b2_31
                       END IF
                    END IF
                    LET b_ogb.ogb05_fac   = g_oeb.oeb05_fac
                    LET b_ogb.ogb13       = g_oeb.oeb13
                    LET b_ogb.ogb37       = g_oeb.oeb37   #FUN-AB0061
                    LET b_ogb.ogb18       = 0
                 END IF
              END IF

              IF g_b2[l_ac].ogb32 != g_b2_t.ogb32  OR g_b2_t.ogb32 IS NULL THEN   #FUN-670007
                 CALL t600_ogb32(g_b2[l_ac].ogb31,g_b2[l_ac].ogb32)
              END IF                 #FUN-670007
           END IF
           CALL t600_set_no_entry_b2(p_cmd)



        AFTER FIELD b2_1001
           IF NOT cl_null(g_b2[l_ac].ogb1001) THEN

                 LET g_cnt=0
                 SELECT COUNT(*) INTO g_cnt FROM azf_file
                  WHERE azf01 = g_b2[l_ac].ogb1001
                    AND azf02 = '2'       #No.TQC-760054
                    AND azfacti ='Y'
                    AND azf09 = '3'       #No.TQC-7C0055

              IF g_cnt = 0 THEN
                 CALL cl_err(g_b2[l_ac].ogb1001,'atm-569',1)  #No.TQC-7C0055
                 NEXT FIELD b2_1001
              END IF
           END IF


       BEFORE FIELD b2_14
              IF g_b2[l_ac].ogb1010 ='N' THEN
                 CALL cl_set_comp_entry("b2_14",TRUE)
                 CALL cl_set_comp_entry("b2_14t",FALSE)
                 CALL cl_digcut(g_b2[l_ac].ogb14,t_azi04)  RETURNING g_b2[l_ac].ogb14        #CHI-7A0036-add
                 LET g_b2[l_ac].ogb14t=g_b2[l_ac].ogb14*(1+g_b2[l_ac].ogb1009/100)
                 CALL cl_digcut(g_b2[l_ac].ogb14t,t_azi04) RETURNING g_b2[l_ac].ogb14t       #CHI-7A0036-add
              ELSE
                 IF g_b2[l_ac].ogb1010='Y' THEN
                    CALL cl_set_comp_entry("b2_14t",TRUE)
                    CALL cl_set_comp_entry("b2_14",FALSE)
                    CALL cl_digcut(g_b2[l_ac].ogb14t,t_azi04) RETURNING g_b2[l_ac].ogb14t    #CHI-7A0036-add
                    LET g_b2[l_ac].ogb14=g_b2[l_ac].ogb14t/(1+g_b2[l_ac].ogb1009/100)        #No.TQC-740349
                    CALL cl_digcut(g_b2[l_ac].ogb14,t_azi04)  RETURNING g_b2[l_ac].ogb14     #CHI-7A0036-add
                 END IF
              END IF

              DISPLAY BY NAME g_b2[l_ac].ogb14   #No.TQC-740349
              DISPLAY BY NAME g_b2[l_ac].ogb14t  #No.TQC-740349

       AFTER FIELD b2_14
              IF (g_b2[l_ac].ogb14 IS NOT NULL
              AND (g_b2[l_ac].ogb14!=g_b2_t.ogb14 OR g_b2_t.ogb14 IS NULL)) THEN
              SELECT SUM(ogb14) INTO l_max FROM ogb_file,oga_file
               WHERE ogb31 =g_oeb.oeb01
                 AND ogb32 =g_oeb.oeb03
                 AND ogb1005 ='2'
                 AND ogb01 =oga01
                 AND ogapost ='Y'
              IF cl_null(l_max) THEN
                 LET l_max = 0
              END IF
              LET l_max =g_oeb.oeb14 - l_max

              IF l_max>=0 THEN
                 IF g_b2[l_ac].ogb14> l_max OR g_b2[l_ac].ogb14<=0 THEN
                    CALL cl_err('','atm-390',0)
                    NEXT FIELD b2_14
                END IF
              ELSE
                 IF g_b2[l_ac].ogb14>=0 OR g_b2[l_ac].ogb14<l_max THEN
                    CALL cl_err('','atm-390',0)
                    NEXT FIELD b2_14
                 END IF
                 LET g_b2[l_ac].ogb14t=g_b2[l_ac].ogb14*(1+g_b2[l_ac].ogb1009/100)
              END IF
              END IF
           IF p_cmd='a' OR (p_cmd='u' AND (g_b2[l_ac].ogb14!=g_b2_t.ogb14 OR g_b2_t.ogb14 IS NULL)) THEN
              IF g_oga.oga213 = 'N'  THEN
                 CALL cl_digcut(g_b2[l_ac].ogb14,t_azi04)  RETURNING g_b2[l_ac].ogb14        #CHI-7A0036-add
                 LET g_b2[l_ac].ogb14t=g_b2[l_ac].ogb14*(1+g_oga.oga211/100)
                 CALL cl_digcut(g_b2[l_ac].ogb14t,t_azi04) RETURNING g_b2[l_ac].ogb14t       #CHI-7A0036-add
              END IF
           END IF
           DISPLAY BY NAME g_b2[l_ac].ogb14   #No.TQC-740349
           DISPLAY BY NAME g_b2[l_ac].ogb14t  #No.TQC-740349

       BEFORE FIELD b2_14t

              IF g_b2[l_ac].ogb1010 ='N' THEN
                 CALL cl_set_comp_entry("b2_14",TRUE)
                 CALL cl_set_comp_entry("b2_14t",FALSE)
                 CALL cl_digcut(g_b2[l_ac].ogb14,t_azi04)  RETURNING g_b2[l_ac].ogb14        #CHI-7A0036-add
                 LET g_b2[l_ac].ogb14t=g_b2[l_ac].ogb14*(1+g_b2[l_ac].ogb1009/100)
                 CALL cl_digcut(g_b2[l_ac].ogb14t,t_azi04) RETURNING g_b2[l_ac].ogb14t       #CHI-7A0036-add
              ELSE
                 IF g_b2[l_ac].ogb1010='Y' THEN
                    CALL cl_set_comp_entry("b2_14t",TRUE)
                    CALL cl_set_comp_entry("b2_14",FALSE)
                    CALL cl_digcut(g_b2[l_ac].ogb14t,t_azi04) RETURNING g_b2[l_ac].ogb14t       #CHI-7A0036-add
                    LET g_b2[l_ac].ogb14=g_b2[l_ac].ogb14t/(1+g_b2[l_ac].ogb1009/100)  #No.TQC-740349
                    CALL cl_digcut(g_b2[l_ac].ogb14,t_azi04)  RETURNING g_b2[l_ac].ogb14        #CHI-7A0036-add
                 END IF
              END IF
              DISPLAY BY NAME g_b2[l_ac].ogb14   #No.TQC-740349
              DISPLAY BY NAME g_b2[l_ac].ogb14t  #No.TQC-740349

       AFTER FIELD b2_14t
              IF (g_b2[l_ac].ogb14t IS NOT NULL AND (g_b2[l_ac].ogb14t!=g_b2_t.ogb14t OR g_b2_t.ogb14t IS NULL)) THEN
              SELECT SUM(ogb14t) INTO l_max FROM ogb_file,oga_file
               WHERE ogb31 =g_oeb.oeb01
                 AND ogb32 =g_oeb.oeb03
                 AND ogb1005 ='2'
                 AND ogb01 =oga01
                 AND ogapost ='Y'
              IF cl_null(l_max) THEN
                 LET l_max = 0
              END IF
              LET l_max =g_oeb.oeb14t - l_max
              IF l_max>=0 THEN
                 IF g_b2[l_ac].ogb14t> l_max OR g_b2[l_ac].ogb14t<=0 THEN
                    LET g_msg =g_b2[l_ac].ogb32,g_b2[l_ac].ogb14t     #No.FUN-670008
                    CALL cl_err(g_msg,'atm-526',0)                     #No.FUN-670008
                    NEXT FIELD b2_14t
                END IF
              ELSE
                 IF g_b2[l_ac].ogb14t>=0 OR g_b2[l_ac].ogb14t<l_max THEN
                    CALL cl_err('','atm-390',0)
                    NEXT FIELD b2_14t
                 END IF
                 CALL cl_digcut(g_b2[l_ac].ogb14,t_azi04)  RETURNING g_b2[l_ac].ogb14        #CHI-7A0036-add
                 LET g_b2[l_ac].ogb14t=g_b2[l_ac].ogb14*(1+g_b2[l_ac].ogb1009/100)
                 CALL cl_digcut(g_b2[l_ac].ogb14t,t_azi04) RETURNING g_b2[l_ac].ogb14t       #CHI-7A0036-add
              END IF
              CALL cl_digcut(g_b2[l_ac].ogb14t,t_azi04) RETURNING g_b2[l_ac].ogb14t       #CHI-7A0036-add
              LET g_b2[l_ac].ogb14=g_b2[l_ac].ogb14t/(1+g_b2[l_ac].ogb1009/100)     #No.TQC-740349
              CALL cl_digcut(g_b2[l_ac].ogb14,t_azi04)  RETURNING g_b2[l_ac].ogb14        #CHI-7A0036-add

              DISPLAY BY NAME g_b2[l_ac].ogb14   #No.TQC-740349
              DISPLAY BY NAME g_b2[l_ac].ogb14t  #No.TQC-740349
              END IF

       BEFORE DELETE                            #是否取消單身
            IF g_b2_t.ogb03 > 0 AND g_b2_t.ogb03 IS NOT NULL THEN
## 要update 出貨數量應不可小於AR立帳數量(sum(omb12) -------
                SELECT SUM(omb12) INTO l_qty FROM oma_file,omb_file
                 WHERE omb31 = g_oga.oga01
                   AND omb32 = g_b2[l_ac].ogb03
                   AND omb01 = oma01
                   AND omavoid = 'N'
                IF l_qty>0 THEN #AR立帳數量>0
                   CALL cl_err('','axm-302',0)
                   CANCEL DELETE
                END IF
## ---------------------------------------------------------
                IF NOT cl_delb(0,0) THEN
                   CANCEL DELETE
                END IF

                IF l_lock_sw = "Y" THEN
                   CALL cl_err("", -263, 1)
                   CANCEL DELETE
                END IF

                DELETE FROM ogb_file
                 WHERE ogb01 = g_oga.oga01 AND ogb03 = g_b2_t.ogb03
                IF SQLCA.sqlcode THEN
                   CALL cl_err3("del","ogb_file",g_oga.oga01,g_b2_t.ogb03,SQLCA.sqlcode,"","",1)  #No.FUN-670008
                   ROLLBACK WORK
                   CANCEL DELETE
                ELSE
                   CALL t600_oga50_sum()    #No.FUN-610064
                END IF

                DELETE FROM ogc_file
                 WHERE ogc01 = g_oga.oga01 AND ogc03 = g_b2_t.ogb03
                DELETE FROM rvbs_file
                 WHERE rvbs01 = g_oga.oga01 AND rvbs02 = g_b2_t.ogb03
                DELETE FROM ogg_file
                 WHERE ogg01 = g_oga.oga01 AND ogg03 = g_b2_t.ogb03

                DELETE FROM ogbb_file
                 WHERE ogbb01 = g_oga.oga01
                   AND ogbb012 = g_b2_t.ogb03

                CALL t600_mlog('R')
                 CALL t600_bu()   #MOD-520034
                COMMIT WORK
                LET g_rec_b2=g_rec_b2-1        #No.TQC-640123
                DISPLAY g_rec_b2 TO FORMONLY.cn2
                LET l_oga55 = '0'          #FUN-550050
            END IF

        ON ROW CHANGE
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               LET g_flag2 = '1'   #CHI-920012
               LET g_b2[l_ac].* = g_b2_t.*
               CLOSE t600_bcl2
               ROLLBACK WORK
               EXIT INPUT
            END IF
            IF l_lock_sw = 'Y' THEN
               CALL cl_err(g_b2[l_ac].ogb03,-263,1)
               LET g_b2[l_ac].* = g_b2_t.*
            ELSE

               CALL t600_b2_move_back()

#TQC-B40204 --begin--
              IF g_oga.oga55 MATCHES '[01RW]' THEN 
                 LET l_oga55 = '0'
              END IF 
#TQC-B40204 --end--

               UPDATE ogb_file SET * = b_ogb.*
                WHERE ogb01=g_oga.oga01 AND ogb03=g_b2_t.ogb03
               IF SQLCA.sqlcode THEN
                  CALL cl_err3("upd","ogb_file",g_oga.oga01,g_b2_t.ogb03,SQLCA.sqlcode,"","upd ogb",1)  #No.FUN-670008
                  LET g_b2[l_ac].* = g_b2_t.*
               ELSE
                #MOD-B10154 Begin---
                ##FUN-A20022 ADD----------UPDATE THE POINT---------------------------
                #  IF NOT cl_null(g_oga.oga87) THEN
                #     LET g_oga.oga95= t600_oga95_amount()
                #     UPDATE oga_file SET oga95 = g_oga.oga95
                #                   WHERE oga01 = g_oga.oga01
                #                     AND oga87 = g_oga.oga87
                #     IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
                #        CALL cl_err3("upd","oga_file",g_oga.oga01,"",SQLCA.sqlcode,"","",1)
                #     END IF
                #     DISPLAY BY NAME g_oga.oga95
                #  END IF
                ##FUN-A20022 END----------------------------------------------
                #MOD-B10154 End-----
                  CALL cl_msg('UPDATE O.K')
#                 LET l_oga55 = '0'          #FUN-550050       #TQC-B40204
                  CALL t600_mlog('U')
                  CALL t600_oga50_sum()    #No.FUN-610064
                  COMMIT WORK
               END IF
            END IF

        AFTER ROW
            LET l_ac = ARR_CURR()
            LET l_ac_t = l_ac
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               LET g_flag2 = '1'   #CHI-920012
               IF p_cmd = 'u' THEN
                  LET g_b2[l_ac].* = g_b2_t.*
               END IF
               CLOSE t600_bcl2
               ROLLBACK WORK
               EXIT INPUT
            END IF
            CLOSE t600_bcl2
            COMMIT WORK

            LET l_cnt=0
            SELECT COUNT(*) INTO l_cnt
              FROM ogb_file
             WHERE ogb01=g_oga.oga01
            IF cl_null(l_cnt) THEN LET l_cnt=0 END IF

            IF (g_oga.oga08='1' AND l_cnt > g_oaz.oaz691) OR
               (g_oga.oga08 MATCHES '[23]' AND l_cnt > g_oaz.oaz692) THEN
               CALL cl_err('','axm-156',0)
               DELETE FROM ogb_file
                WHERE ogb01=g_oga.oga01 and ogb03=g_b2[l_ac].ogb03
               INITIALIZE g_b2[l_ac].* TO NULL
            END IF
        ON ACTION select_order
           #CALL q_oeb10(FALSE,FALSE,g_oga.oga03,g_oga.oga01,g_oga.oga213,   #No.TQC-640123   #MOD-940130 add   #MOD-A90122
           CALL q_oeb10(FALSE,TRUE,g_oga.oga03,g_oga.oga01,g_oga.oga213,   #MOD-A90122
      #xiaoyx   CALL q_oeb2011(FALSE,TRUE,g_oga.oga03,g_oga.oga01,g_oga.oga213,  
                      g_oga.oga211,g_oga.oga24,g_oga.oga04,g_oga.oga21,
                      #g_oga.oga23,g_oga.oga25)   #MOD-8C0110
                      g_oga.oga23,g_oga.oga25,g_argv0)   #MOD-8C0110
           CALL t600_bu()
           LET l_exit_sw = FALSE
           EXIT INPUT

        ON ACTION controlp
            CASE WHEN INFIELD(b2_31)
                      CALL cl_init_qry_var()
                      IF NOT cl_null(g_oga.oga16) THEN
                         LET g_qryparam.form ="q_oeb6"  #No.FUN-610064
                         LET g_qryparam.arg1 = g_oga.oga16
                      ELSE
                         LET g_qryparam.form ="q_oeb7"  #No.TQC-7C0055
                      END IF
                      LET g_qryparam.default1 =g_b2[l_ac].ogb31
                      LET g_qryparam.default2 =g_b2[l_ac].ogb32
                      CALL cl_create_qry() RETURNING g_b2[l_ac].ogb31 ,
                                                     g_b2[l_ac].ogb32
                      DISPLAY BY NAME g_b2[l_ac].ogb31,g_b2[l_ac].ogb32
                      NEXT FIELD b2_31

              WHEN INFIELD(b2_1001)
                 CALL cl_init_qry_var()
                 LET g_qryparam.default1=g_b2[l_ac].ogb1001 #No.TQC-7C0055
                 LET g_qryparam.form ="q_azf02"   #No.TQC-7C0055
                 LET g_qryparam.arg1 ="2"   #No:MOD-740375
                 LET g_qryparam.arg2 ="3"   #No.TQC-7C0055
                 CALL cl_create_qry() RETURNING g_b2[l_ac].ogb1001
                 DISPLAY BY NAME g_b2[l_ac].ogb1001
                 NEXT FIELD b2_1001

              WHEN INFIELD(b2_1007)
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_tqw"
                 LET g_qryparam.default1 = g_b2[l_ac].ogb1007
                 LET g_qryparam.arg1 = g_oga.oga23
                 LET g_qryparam.arg2 = g_oga.oga03
                 CALL cl_create_qry() RETURNING g_b2[l_ac].ogb1007
                 DISPLAY BY NAME g_b2[l_ac].ogb1007
                 NEXT FIELD b2_1007
#end
            END CASE

        ON ACTION CONTROLZ
           CALL cl_show_req_fields()

        ON ACTION CONTROLG CALL cl_cmdask()


        ON ACTION CONTROLF
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name #Add on 040913
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang) #Add on 040913


         AFTER INPUT
            SELECT COUNT(*) INTO g_cnt FROM ogb_file WHERE ogb01=g_oga.oga01
            IF (g_oga.oga08='1' AND g_cnt > g_oaz.oaz691) OR
                #no.A047  增加oga08= '3'
               (g_oga.oga08 MATCHES '[23]' AND g_cnt > g_oaz.oaz692) THEN
                #no.A047(end)
               CALL cl_err('','axm-156',0) NEXT FIELD b2_03
            END IF

         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE INPUT

      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121

      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121


      END INPUT
      IF l_exit_sw THEN EXIT WHILE ELSE CONTINUE WHILE END IF
    END WHILE

    UPDATE oga_file SET ogamodu = g_user,ogadate = g_today,oga55=l_oga55
     WHERE oga01 = g_oga.oga01

    LET g_oga.oga55 = l_oga55
    DISPLAY BY NAME g_oga.oga55
    CALL t600_chspic()

    COMMIT WORK
    CLOSE t600_bcl2

END FUNCTION

FUNCTION t600_b2_move_to()
   LET g_b2[l_ac].ogb03  = b_ogb.ogb03
   LET g_b2[l_ac].ogb31  = b_ogb.ogb31
   LET g_b2[l_ac].ogb32  = b_ogb.ogb32
   LET g_b2[l_ac].ogb1001= b_ogb.ogb1001
   LET g_b2[l_ac].ogb1007= b_ogb.ogb1007
   LET g_b2[l_ac].ogb1010= b_ogb.ogb1010   #No.FUN-610064
   LET g_b2[l_ac].ogb14  = b_ogb.ogb14
   LET g_b2[l_ac].ogb14t = b_ogb.ogb14t
END FUNCTION

FUNCTION t600_b2_move_back()
   LET b_ogb.ogb03  = g_b2[l_ac].ogb03
   LET b_ogb.ogb31  = g_b2[l_ac].ogb31
   LET b_ogb.ogb32  = g_b2[l_ac].ogb32
   LET b_ogb.ogb1001= g_b2[l_ac].ogb1001
   LET b_ogb.ogb1007= g_b2[l_ac].ogb1007
   LET b_ogb.ogb1010= g_b2[l_ac].ogb1010
   LET b_ogb.ogb14  = g_b2[l_ac].ogb14
   LET b_ogb.ogb14t = g_b2[l_ac].ogb14t
   LET b_ogb.ogb1005 = g_b2[l_ac].ogb1005  #No.TQC-7A0077  add
   LET b_ogb.ogb44 = '1' #No.FUN-870007
   LET b_ogb.ogbplant = g_plant #No.FUN-870007
   LET b_ogb.ogblegal = g_legal #No.FUN-870007
END FUNCTION

FUNCTION t600_b2_fill(p_wc3)              #BODY FILL UP
DEFINE p_wc3           LIKE type_file.chr1000 #No.FUN-680137 VARCHAR(200)
DEFINE l_retn_amt      LIKE ohb_file.ohb14    #No.FUN-670008

    IF g_aza.aza50='N' THEN
       RETURN
    END IF

    LET g_sql =
        "SELECT ogb03,ogb1005,ogb31,ogb32,ogb1007,'','','',ogb1008,ogb1009,ogb1010,ogb1011,ogb1001,",  #No.FUN-610064
        "       ogb14,ogb14t",   #No.FUN-610064
        " FROM ogb_file",
        " WHERE ogb01 ='",g_oga.oga01,"'",  #單頭
        " AND ",p_wc3 CLIPPED,                     #單身
       #" AND ogb1005 ='2'",         #No.TQC-640123 #TQC-B10066
        " AND ogb03 > 9000 ",                       #TQC-B10066
        " ORDER BY ogb03"

    PREPARE t600_pb2 FROM g_sql
    DECLARE ogb_curs2                       #CURSOR
        CURSOR FOR t600_pb2

    CALL g_b2.clear()

    LET g_cnt = 1
    LET g_rec_b2 = 0             #No.TQC-640123
    FOREACH ogb_curs2 INTO g_b2[g_cnt].*   #單身 ARRAY 填充

        IF STATUS THEN CALL cl_err('foreach:',STATUS,1) EXIT FOREACH END IF
        IF NOT cl_null(g_b2[g_cnt].ogb1007) THEN
           IF g_b2[g_cnt].ogb1010 ='Y' THEN
              SELECT oeb14t INTO g_b2[g_cnt].tqw08 FROM oeb_file
               WHERE oeb01 =g_b2[g_cnt].ogb31
                 AND oeb03 =g_b2[g_cnt].ogb32

              SELECT SUM(ogb14t) INTO g_b2[g_cnt].tqw081 FROM ogb_file,oga_file
               WHERE ogb31 = g_b2[g_cnt].ogb31
                 AND ogb32 = g_b2[g_cnt].ogb32
                 AND oga01 = ogb01
                 AND ogaconf = 'Y'

              SELECT SUM(ohb14t) INTO l_retn_amt FROM ohb_file,oha_file
               WHERE ohb33 =g_b2[g_cnt].ogb31
                 AND ohb34 =g_b2[g_cnt].ogb32
                 AND oha01 =ohb01
                 AND ohapost ='Y'

           ELSE
              SELECT oeb14 INTO g_b2[g_cnt].tqw08 FROM oeb_file
               WHERE oeb01 =g_b2[g_cnt].ogb31
                 AND oeb03 =g_b2[g_cnt].ogb32

              SELECT SUM(ogb14) INTO g_b2[g_cnt].tqw081 FROM ogb_file,oga_file
               WHERE ogb31 = g_b2[g_cnt].ogb31
                 AND ogb32 = g_b2[g_cnt].ogb32
                 AND oga01 = ogb01
                 AND ogaconf = 'Y'

              SELECT SUM(ohb14) INTO l_retn_amt FROM ohb_file,oha_file
               WHERE ohb33 =g_b2[g_cnt].ogb31
                 AND ohb34 =g_b2[g_cnt].ogb32
                 AND oha01 =ohb01
                 AND ohapost ='Y'
           END IF

           IF cl_null(g_b2[g_cnt].tqw081) THEN
              LET g_b2[g_cnt].tqw081 =0
           END IF

           IF cl_null(l_retn_amt) THEN
              LET l_retn_amt =0
           END IF

           LET g_b2[g_cnt].tqw081 =g_b2[g_cnt].tqw081 -l_retn_amt

        END IF
        LET g_cnt = g_cnt + 1
    END FOREACH
    CALL t600_oga50_sum()
    CALL g_b2.deleteElement(g_cnt)
    LET g_rec_b2=g_cnt - 1            #No.TQC-640123
    DISPLAY g_rec_b2 TO FORMONLY.cn2
    LET g_cnt = 0
    #FUN-B30170 add begin-------------------------
    LET g_sql = " SELECT rvbs02,rvbs021,ima02,ima021,rvbs022,rvbs04,rvbs03,rvbs05,rvbs06,rvbs07,rvbs08,rvbs13",
                "   FROM rvbs_file LEFT JOIN ima_file ON rvbs021 = ima01",
                "  WHERE rvbs00 = '",g_prog,"' AND rvbs01 = '",g_oga.oga01,"'"
    PREPARE sel_rvbs_pre1 FROM g_sql
    DECLARE rvbs_curs1 CURSOR FOR sel_rvbs_pre1
    
    CALL g_rvbs.clear()
    
    LET g_cnt = 1
    FOREACH rvbs_curs1 INTO g_rvbs[g_cnt].*   #單身 ARRAY 填充
       IF STATUS THEN CALL cl_err('foreach:',STATUS,1) EXIT FOREACH END IF
       LET g_cnt = g_cnt + 1
       IF g_cnt > g_max_rec THEN
          CALL cl_err( '', 9035, 0 )
          EXIT FOREACH
       END IF
    END FOREACH
    CALL g_rvbs.deleteElement(g_cnt)
    LET g_rec_b3 = g_cnt - 1
    #FUN-B30170 add -end--------------------------
END FUNCTION

FUNCTION t600_set_entry_b2(p_cmd)
  DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)

    IF INFIELD(b2_03) AND g_argv0 = '8' THEN
       CALL cl_set_comp_entry("b2_31,b2_32",TRUE)
    END IF
END FUNCTION

FUNCTION t600_set_no_entry_b2(p_cmd)
  DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)

    IF INFIELD(b2_03) AND g_argv0 = '8' THEN
       CALL cl_set_comp_entry("b2_31,b2_32",FALSE)
    END IF
END FUNCTION

FUNCTION t600_set_required_b2(p_cmd)
 DEFINE p_cmd LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)

 IF NOT g_before_input_done AND g_oaz.oaz65='1' THEN
    CALL cl_set_comp_required("ogb31",TRUE)
 END IF
 IF p_cmd = 'u' OR INFIELD(ogb31) THEN
    IF NOT cl_null(g_ogb[l_ac].ogb31) AND g_ogb[l_ac].ogb31[1,4] <> 'MISC' THEN
       CALL cl_set_comp_required("ogb32",TRUE)
    END IF
 END IF
 IF cl_null(g_oga.oga16) THEN
       CALL cl_set_comp_required("ogb31",TRUE)
 END IF

END FUNCTION

FUNCTION t600_set_no_required_b2(p_cmd)
 DEFINE p_cmd LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)

  IF NOT g_before_input_done AND g_oaz.oaz65 != '1' THEN
     CALL cl_set_comp_required("ogb31",FALSE)
  END IF
  IF p_cmd = 'u' OR INFIELD(ogb31) THEN
    CALL cl_set_comp_required("ogb32",FALSE)
  END IF

END FUNCTION

FUNCTION t600_ogb1005_1()
   CALL cl_set_comp_entry("ogb04,ogb05,ogb06,ogb11,ogb1003,ogb913,ogb910",TRUE)
   CALL cl_set_comp_entry("ogb17,ogb09,ogb091,ogb092,ogb1003,ogb908",TRUE)    #No.TQC-640123
   CALL cl_set_comp_entry("ogb12,ogb915,ogb912,ogb917,ogb13,ogb1006,ogb1001",TRUE)
END FUNCTION

FUNCTION t600_ogb1005_2()
   CALL cl_set_comp_entry("ogb04,ogb05,ogb06,ogb11,ogb1003,ogb913,ogb910",FALSE)
   CALL cl_set_comp_entry("ogb916,ogb17,ogb09,ogb091,ogb092,ogb1003,ogb908",FALSE)
   CALL cl_set_comp_entry("ogb12,ogb915,ogb912,ogb917,ogb13,ogb1006,ogb1001",FALSE)
   #CALL cl_set_comp_entry("ogb19",FALSE)   #CHI-880006
   CALL cl_set_comp_required("ogb31,ogb32",TRUE)
END FUNCTION

FUNCTION t600_price(p_cmd,p_ac)                #FUN-AC0012 Add p_cmd
DEFINE p_cmd           LIKE type_file.chr1     #FUN-AC0012
DEFINE l_n             LIKE type_file.num5,    #No.FUN-680137 SMALLINT
       p_ac            LIKE type_file.num5,    #No.FUN-680137 SMALLINT
       l_success       LIKE type_file.chr1,    #No.FUN-680137 VARCHAR(1)
       l_ima135        LIKE ima_file.ima135,
       l_tqz09         LIKE tqz_file.tqz09,
       l_tqx14         LIKE tqx_file.tqx14,
       l_tqx16         LIKE tqx_file.tqx16,
       l_tqz08         LIKE tqz_file.tqz08,
       l_ogb05         LIKE ogb_file.ogb05,
       l_flag          LIKE type_file.chr1,    #No.FUN-680137 VARCHAR(1)
       l_unitrate      LIKE ima_file.ima31_fac,
       l_unit          LIKE ima_file.ima31,
       l_tqz06         LIKE tqz_file.tqz06,
       l_tqz07         LIKE tqz_file.tqz07,
       l_tqy38         LIKE tqy_file.tqy38,
       l_tqx13         LIKE tqx_file.tqx13


   IF g_prog = 'axmp220' THEN RETURN 0  END IF   #TQC-730022
   IF g_azw.azw04 !='2' THEN   #FUN-9C0173 
      IF cl_null(g_ogb[p_ac].ogb1003) THEN
         CALL cl_err('','atm-040',0)
         RETURN 0
      END IF
   END IF #FUN-9C0173
   IF g_azw.azw04 = '2' THEN  #No.MOD-A60134
      CALL t600_ogb04() RETURNING l_flag
      IF l_flag='1' THEN
         RETURN 0  
      END IF
   END IF                     #No.MOD-A60134
   IF g_sma.sma115 = 'Y' AND cl_null(g_ogb[p_ac].ogb05) THEN
      CALL t600_set_origin_field()
   END IF
   IF cl_null(g_ogb[p_ac].ogb916) THEN
      LET g_ogb[p_ac].ogb917 = g_ogb[p_ac].ogb12
   END IF
   IF g_sma.sma116 MATCHES '[23]' AND NOT cl_null(g_ogb[p_ac].ogb916) THEN
      LET l_ogb05=g_ogb[p_ac].ogb916
   ELSE
      LET l_ogb05=g_ogb[p_ac].ogb05
   END IF
   CALL s_fetch_price_new(g_oga.oga03,g_ogb[p_ac].ogb04,l_ogb05,g_oga.oga69,
                          '2',g_oga.ogaplant,g_oga.oga23,g_oga.oga31,g_oga.oga32,
                          g_oga.oga01,g_ogb[p_ac].ogb03,g_ogb[p_ac].ogb917,
                          g_ogb[p_ac].ogb1004,p_cmd) #FUN-AC0012
    #                     g_ogb[p_ac].ogb1004,'a')   #FUN-AC0012
    #  RETURNING g_ogb[p_ac].ogb13  #FUN-AB0061
       RETURNING g_ogb[p_ac].ogb13,g_ogb[p_ac].ogb37   #FUN-AB0061
   IF cl_null(g_ogb[p_ac].ogb13) THEN CALL s_unitprice_entry(g_oga.oga03,g_oga.oga31,g_oga.ogaplant) END IF #FUN-9C0120
   IF g_oga.oga213 = 'N' THEN
      LET g_ogb[p_ac].ogb14 =t600_amount(g_ogb[p_ac].ogb917,g_ogb[p_ac].ogb13,g_ogb[p_ac].ogb1006,t_azi03) 
      CALL cl_digcut(g_ogb[p_ac].ogb14,t_azi04)  RETURNING g_ogb[p_ac].ogb14  
      LET g_ogb[p_ac].ogb14t= g_ogb[p_ac].ogb14*(1+ g_oga.oga211/100)
      CALL cl_digcut(g_ogb[p_ac].ogb14t,t_azi04) RETURNING g_ogb[p_ac].ogb14t
   ELSE
      LET g_ogb[p_ac].ogb14t=t600_amount(g_ogb[p_ac].ogb917,g_ogb[p_ac].ogb13,g_ogb[p_ac].ogb1006,t_azi03)  
      CALL cl_digcut(g_ogb[p_ac].ogb14t,t_azi04) RETURNING g_ogb[p_ac].ogb14t
      LET g_ogb[p_ac].ogb14 = g_ogb[p_ac].ogb14t/(1+ g_oga.oga211/100)
      CALL cl_digcut(g_ogb[p_ac].ogb14,t_azi04)  RETURNING g_ogb[p_ac].ogb14 
   END IF
   IF g_ogb[p_ac].ogb1012 = 'Y'  THEN
      LET g_ogb[p_ac].ogb14=0
      LET g_ogb[p_ac].ogb14t=0
   END IF
  #FUN-B10024 Begin---
   SELECT SUM(rxc06) INTO g_ogb[p_ac].ogb47 FROM rxc_file
     WHERE rxc00 = '02'
       AND rxc01 = g_oga.oga01
       AND rxc02 = g_ogb[p_ac].ogb03
   IF cl_null(g_ogb[p_ac].ogb47) THEN LET g_ogb[p_ac].ogb47=0 END IF
   DISPLAY BY NAME g_ogb[p_ac].ogb47
  #FUN-B10024 End-----
   RETURN 0

END FUNCTION

FUNCTION t600_perf()
 #審核或作廢狀態時不能更改業績
   IF g_oga.ogaconf ='X' THEN         #No.FUN-670008
      CALL cl_err(g_oga.oga01,'9021',0)
      RETURN
   END IF

#更改業績
   IF g_oga.oga1005 = 'Y' THEN
     IF NOT cl_confirm('atm-037') THEN RETURN END IF
     LET g_oga.oga1005 = 'N'
   ELSE
     IF NOT cl_confirm('atm-036') THEN RETURN END IF
     LET g_oga.oga1005 = 'Y'
   END IF

   UPDATE  oga_file
     SET oga1005 = g_oga.oga1005
     WHERE oga01=g_oga.oga01

   IF STATUS OR SQLCA.SQLCODE THEN
       CALL cl_err('update oga:',SQLCA.SQLCODE,0)                                                                                      #No.FUN-670008
       ROLLBACK WORK RETURN
   END IF
   DISPLAY BY NAME g_oga.oga1005

END FUNCTION

FUNCTION t600_oga1002(p_cmd)
DEFINE p_cmd      LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)
DEFINE l_tqa02    LIKE tqa_file.tqa02
DEFINE l_tqaacti  LIKE tqa_file.tqaacti

       LET g_errno = ''
       SELECT tqa02,tqaacti INTO l_tqa02,l_tqaacti
         FROM tqa_file
        WHERE tqa01 = g_oga.oga1002
          AND tqa03 ='20'

   CASE WHEN SQLCA.SQLCODE = 100  LET g_errno = 'atm-374'
                                  LET l_tqa02 = NULL
        WHEN l_tqaacti='N' LET g_errno = '9028'
        OTHERWISE          LET g_errno = SQLCA.SQLCODE USING '-------'
   END CASE
   IF NOT cl_null(l_tqa02) THEN
      DISPLAY  l_tqa02 TO FORMONLY.oga1002_tqa02
   ELSE
      DISPLAY ' ' TO FORMONLY.oga1002_tqa02
   END IF
END FUNCTION

FUNCTION t600_oga1003(p_cmd)
DEFINE p_cmd      LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)
DEFINE l_tqb02    LIKE tqb_file.tqb02
DEFINE l_tqbacti  LIKE tqb_file.tqbacti

       LET g_errno = ''
       SELECT tqb02,tqbacti INTO l_tqb02,l_tqbacti
         FROM tqb_file
        WHERE tqb01 = g_oga.oga1003

   CASE WHEN SQLCA.SQLCODE = 100  LET g_errno = 'atm-320'
                                  LET l_tqb02 = NULL
        WHEN l_tqbacti='N' LET g_errno = '9028'
        OTHERWISE          LET g_errno = SQLCA.SQLCODE USING '-------'
   END CASE
   IF NOT cl_null(l_tqb02) THEN
      DISPLAY  l_tqb02 TO FORMONLY.oga1003_tqb02
   ELSE
      DISPLAY ' ' TO FORMONLY.oga1003_tqb02
   END IF
END FUNCTION

#FUN-9B0132 add begin------------------------
FUNCTION t600_oga902(p_cmd)
DEFINE p_cmd      LIKE type_file.chr1   
DEFINE l_oak02    LIKE oak_file.oak02

   LET g_errno = ''
   SELECT oak02 INTO l_oak02
     FROM oak_file
    WHERE oak01 = g_oga.oga902 AND oak03 = '1'
   IF SQLCA.SQLCODE THEN
      LET g_errno = SQLCA.SQLCODE USING '-------'
   END IF
   IF NOT cl_null(l_oak02) THEN
      DISPLAY  l_oak02 TO FORMONLY.oga902_desc
   ELSE
      DISPLAY ' ' TO FORMONLY.oga902_desc
   END IF
END FUNCTION
#FUN-9B0132 add -end-------------------------

FUNCTION t600_oga1009(p_cmd)
DEFINE p_cmd      LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)
DEFINE l_tqa02    LIKE tqa_file.tqa02
DEFINE l_tqaacti  LIKE tqa_file.tqaacti

       LET g_errno = ''
       SELECT tqa02,tqaacti INTO l_tqa02,l_tqaacti
         FROM tqa_file
        WHERE tqa01 = g_oga.oga1009
          AND tqa03 ='19'

   CASE WHEN SQLCA.SQLCODE = 100  LET g_errno = 'atm-374'
                                  LET l_tqa02 = NULL
        WHEN l_tqaacti='N' LET g_errno = '9028'
        OTHERWISE          LET g_errno = SQLCA.SQLCODE USING '-------'
   END CASE
   IF NOT cl_null(l_tqa02) THEN
      DISPLAY  l_tqa02 TO FORMONLY.oga1009_tqa02
   ELSE
      DISPLAY ' ' TO FORMONLY.oga1009_tqa02
   END IF
END FUNCTION

FUNCTION t600_oga1010(p_cmd)
DEFINE p_cmd      LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)
DEFINE l_tqb02    LIKE tqb_file.tqb02
DEFINE l_tqbacti  LIKE tqb_file.tqbacti

       LET g_errno = ''
       SELECT tqb02,tqbacti INTO l_tqb02,l_tqbacti
         FROM tqb_file
        WHERE tqb01 = g_oga.oga1010

   CASE WHEN SQLCA.SQLCODE = 100  LET g_errno = 'atm-320'
                                  LET l_tqb02 = NULL
        WHEN l_tqbacti='N' LET g_errno = '9028'
        OTHERWISE          LET g_errno = SQLCA.SQLCODE USING '-------'
   END CASE
   IF NOT cl_null(l_tqb02) THEN
      DISPLAY  l_tqb02 TO FORMONLY.oga1010_tqb02
   ELSE
      DISPLAY ' ' TO FORMONLY.oga1010_tqb02
   END IF
END FUNCTION

FUNCTION t600_oga1011(p_cmd)   #No.FUN-610064
DEFINE p_cmd      LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)
DEFINE l_occ02    LIKE occ_file.occ02
DEFINE l_occ06    LIKE occ_file.occ06
DEFINE l_occ1004  LIKE occ_file.occ1004
DEFINE l_occacti  LIKE occ_file.occacti

       LET g_errno = ''
       SELECT occ02,occ06,occ1004,occacti INTO l_occ02,l_occ06,l_occ1004,l_occacti
         FROM occ_file
        WHERE occ01 = g_oga.oga1011

   CASE WHEN SQLCA.SQLCODE = 100  LET g_errno = 'anm-045'
                                  LET l_occ02 = NULL
        WHEN l_occ1004 <>'1'      LET g_errno = 'atm-073'     #No.FUN-690025
        WHEN l_occ06 NOT MATCHES '[14]'      LET g_errno = 'atm-074'

        WHEN l_occacti='N' LET g_errno = '9028'
        WHEN l_occacti MATCHES '[PH]'  LET g_errno = '9038'   #No.FUN-690023
        OTHERWISE          LET g_errno = SQLCA.SQLCODE USING '-------'
   END CASE
   IF NOT cl_null(l_occ02) THEN
      DISPLAY  l_occ02 TO FORMONLY.oga1011_occ02
   ELSE
      DISPLAY ' ' TO FORMONLY.oga1011_occ02
   END IF
END FUNCTION

FUNCTION t600_oga1015(p_cmd)
DEFINE p_cmd      LIKE type_file.chr1    #No.FUN-680137 VARCHAR(1)
DEFINE l_pmc03    LIKE pmc_file.pmc03
DEFINE l_pmcacti  LIKE pmc_file.pmcacti

       LET g_errno = ''
       SELECT pmc03,pmcacti INTO l_pmc03,l_pmcacti
         FROM pmc_file
        WHERE pmc01 = g_oga.oga1015

   CASE WHEN SQLCA.SQLCODE = 100  LET g_errno = 'atm-320'
                                  LET l_pmc03 = NULL
        WHEN l_pmcacti='N' LET g_errno = '9028'
        WHEN l_pmcacti MATCHES '[PH]'  LET g_errno = '9038'   #No.FUN-690024
        OTHERWISE          LET g_errno = SQLCA.SQLCODE USING '-------'
   END CASE
   IF NOT cl_null(l_pmc03) THEN
      DISPLAY  l_pmc03 TO FORMONLY.oga1015_occ02
   ELSE
      DISPLAY ' ' TO FORMONLY.oga1015_occ02
   END IF
END FUNCTION

FUNCTION t600_chk_ogb1004(p_cmd)      #FUN-AC0012 Add p_cmd
 DEFINE p_cmd LIKE type_file.chr1     #FUN-AC0012
 DEFINE l_fac LIKE ogb_file.ogb15_fac

   IF NOT cl_null(g_ogb[l_ac].ogb1004) THEN
      SELECT * FROM tqx_file,tqy_file,tqz_file,tsa_file
       WHERE tqx01=tqy01 AND tqx01=tqz01
         AND tqx01=tsa01 AND tqy02=tsa02
         AND tqz02=tsa03 AND tqy03=g_oga.oga03  #No.TQC-640123
         AND tqy37= 'Y'  AND tqx07= '3'
         AND tqx01=g_ogb[l_ac].ogb1004
         AND (tqz03 =g_ogb[l_ac].ogb04 OR
              tqz03 IN (SELECT ima01 FROM ima_file
                         WHERE ima135=g_ogb[l_ac].ima135))
      IF STATUS = 100 THEN
#        CALL cl_err('','anm-027',0)     #No.FUN-670008
         CALL cl_err3("sel","tqx_file,tqy_file,tqz_file,tsa_file","","","anm-027","","",1)  #No.FUN-670008
         RETURN FALSE
      END IF
   END IF
  #CALL t600_price(l_ac) RETURNING l_fac       #FUN-AC0012
   IF cl_null(g_ogb[l_ac].ogb31) AND cl_null(g_ogb[l_ac].ogb32) THEN   #MOD-B60052
      CALL t600_price(p_cmd,l_ac) RETURNING l_fac #FUN-AC0012
      IF l_fac THEN
         RETURN FALSE
      END IF
   END IF                                                              #MOD-B60052
   #end
   RETURN TRUE
END FUNCTION

FUNCTION t600_visible_menu()
   LET g_action_choice = 'entry_sheet'
   CALL cl_chk_act_auth_nomsg()   #MOD-5B0123
   IF NOT cl_chk_act_auth() THEN
      CALL cl_set_act_visible("entry_sheet",FALSE)
   END IF
   #CHI-AC0002 add --start--
   LET g_action_choice = 'entry_sheet2'
   CALL cl_chk_act_auth_nomsg() 
   IF NOT cl_chk_act_auth() THEN
      CALL cl_set_act_visible("entry_sheet2",FALSE)
   END IF
   #CHI-AC0002 add --end--
   LET g_action_choice = 'gen_entry_sheet'
   CALL cl_chk_act_auth_nomsg()   #MOD-5B0123
   IF NOT cl_chk_act_auth() THEN
      CALL cl_set_act_visible("gen_entry_sheet",FALSE)
   END IF
   LET g_action_choice = 'trsf_to_ar_invo'
   CALL cl_chk_act_auth_nomsg()   #MOD-5B0123
   IF NOT cl_chk_act_auth() THEN
      CALL cl_set_act_visible("trsf_to_ar_invo",FALSE)
   END IF
   IF g_argv0 MATCHES '[15]' THEN
      CALL cl_set_act_visible("deduct_inventory",FALSE)
      CALL cl_set_act_visible("undo_deduct",FALSE)
      CALL cl_set_act_visible("entry_sheet",FALSE)
      CALL cl_set_act_visible("entry_sheet2",FALSE) #CHI-AC0002 add
      CALL cl_set_act_visible("gen_entry_sheet",FALSE)
      CALL cl_set_act_visible("trsf_to_ar_invo",FALSE)
   END IF
   IF g_argv0 <> '2' THEN
      CALL cl_set_act_visible("gen_on_check_note",FALSE)
      CALL cl_set_act_visible("qry_on_check_note",FALSE)
      CALL cl_set_act_visible("qry_return_note",FALSE)
   END IF
   IF g_aza.aza50 ='Y' THEN
      CALL cl_set_act_visible("unit_price",FALSE)
   ELSE
      CALL cl_set_act_visible("performance_status",FALSE)
   END IF
   IF g_prog ='axmt628' OR g_prog ='axmt629' THEN
      CALL cl_set_act_visible("performance_status",FALSE)
   END IF
   IF g_argv0 = '1' THEN
      CALL cl_set_act_visible("a_r", FALSE)
   END IF
   LET g_action_choice = ''
   CALL cl_chk_act_auth_showmsg()   #MOD-890049
   IF g_argv0 = '8' THEN
      CALL cl_set_act_visible("qc_reject_q",TRUE)
   ELSE
      CALL cl_set_act_visible("qc_reject_q",FALSE)
   END IF
   CALL cl_set_act_visible("unit_price",(g_azw.azw04='2') OR (g_aza.aza50='Y') OR (g_azw.azw04='1'))  #FUN-9C0173
                                                                                 #MOD-AB0053 add azw04='1'
END FUNCTION

FUNCTION t600_set_act()
  CALL cl_set_act_visible("CONTROLO,select_order,mntn_serial_no,other_data,mntn_inv_detail,qry_product_inventory,unit_price", FALSE)
END FUNCTION

FUNCTION t600_check_poz19()
DEFINE l_poz18  LIKE poz_file.poz18,
       l_poz19  LIKE poz_file.poz19,
       l_poz01  LIKE poz_file.poz01,
       l_c      LIKE type_file.num5

     LET g_errno = ''
     SELECT poz01,poz18,poz19 INTO l_poz01,l_poz18,l_poz19
       FROM ogb_file,oea_file,poz_file
      WHERE oea904 = poz01
        AND ogb01  = g_oga.oga01
        AND ogb31 = oea01

      LET l_c = 0
     IF l_poz19 = 'Y'  AND g_plant=l_poz18 THEN    #已設立中斷點
         SELECT COUNT(*) INTO l_c   #check poz18設定的中斷營運中心是否存在單身設>
           FROM poy_file
         WHERE poy01 = l_poz01
           AND poy04 = l_poz18
     END IF
     IF l_c > 0 THEN
        LET g_errno='axm-950'
        RETURN
     END IF
END FUNCTION

FUNCTION t600_oga99_z()
     LET g_oga_o.oga99 =g_oga.oga99  #MOD-820106 add
     LET g_oga_o.oga905=g_oga.oga905 #MOD-820106 add
     LET g_oga.oga99=' '
     LET g_oga.oga905='N'
     UPDATE oga_file
        SET oga99 ='',
            oga905='N'
      WHERE oga01=g_oga.oga01
       IF STATUS OR SQLCA.SQLCODE THEN
          CALL cl_err(g_oga.oga01,SQLCA.SQLCODE,0)
       END IF
END FUNCTION

#若sma128 = 'Y' 且 sma115!='Y' 則彈出詢問"是否使用混合包裝"
#若是,則自動產生單身
FUNCTION t600_g_mix_order_b()
DEFINE i   SMALLINT

    IF cl_null(g_oga.oga16) THEN RETURN END IF
    IF g_sma.sma128 NOT MATCHES '[Yy]' THEN RETURN END IF
    IF g_sma.sma115 MATCHES '[Yy]' THEN RETURN END IF
    SELECT COUNT(*) INTO i FROM ogb_file
     WHERE ogb01 = g_oga.oga01
    IF cl_null(i) THEN LET i = 0 END IF
    IF i > 0 THEN RETURN END IF
    IF NOT cl_confirm('axm_103') THEN RETURN END IF

    BEGIN WORK
    CALL mix_order_b()     #產生單身資料
    IF g_success = 'Y' THEN
       COMMIT WORK
    ELSE
       ROLLBACK WORK
    END IF

    CALL t600_b1_fill(' 1=1')
    CALL t600_b2_fill(' 1=1')
    LET l_ac = 1

END FUNCTION
FUNCTION mix_order_b()
DEFINE l_oee063    LIKE oee_file.oee063
DEFINE l_oee073    LIKE oee_file.oee073
DEFINE l_oee083    LIKE oee_file.oee083
DEFINE l_oeb15     LIKE oeb_file.oeb15
DEFINE l_oeb931    LIKE oeb_file.oeb931
DEFINE l_oeb932    LIKE oeb_file.oeb932
DEFINE l_ima25     LIKE ima_file.ima25
DEFINE l_ohb14     LIKE ohb_file.ohb14
DEFINE l_ohb14t    LIKE ohb_file.ohb14t
DEFINE l_ohb912    LIKE ohb_file.ohb912
DEFINE l_ohb915    LIKE ohb_file.ohb915
DEFINE l_ohb917    LIKE ohb_file.ohb917
DEFINE l_ogb912    LIKE ogb_file.ogb912
DEFINE l_ogb915    LIKE ogb_file.ogb915
DEFINE l_ogb917    LIKE ogb_file.ogb917
DEFINE l_oeb       RECORD LIKE oeb_file.*
DEFINE l_ship_qty  LIKE ogb_file.ogb12
DEFINE l_retn_qty  LIKE ogb_file.ogb12
DEFINE l_sql       STRING
DEFINE l_diff      LIKE oeb_file.oeb12
DEFINE i           SMALLINT
DEFINE p_close     VARCHAR(1)
DEFINE l_flag      LIKE type_file.num5,    #MOD-930130
       l_oee081    LIKE oee_file.oee081,   #MOD-930130
       l_fac       LIKE img_file.img20     #MOD-930130
   DEFINE l_oea61   LIKE oea_file.oea61    #No:FUN-A50103
   DEFINE l_oea1008 LIKE oea_file.oea1008  #No:FUN-A50103
   DEFINE l_oea261  LIKE oea_file.oea261   #No:FUN-A50103
   DEFINE l_oea262  LIKE oea_file.oea262   #No:FUN-A50103
   DEFINE l_oea263  LIKE oea_file.oea263   #No:FUN-A50103

    IF g_oga.oga55 <> '0' THEN RETURN END IF
    IF cl_null(g_oga.oga16) THEN RETURN END IF

    IF g_action_choice = 'mix_order_auto_generate' THEN
       SELECT COUNT(*) INTO i FROM ogb_file
        WHERE ogb01 = g_oga.oga01
       IF cl_null(i) THEN LET i= 0END IF
       IF i > 0 THEN
          IF NOT cl_confirm('axm_106') THEN RETURN END IF
       END IF
    END IF
    LET p_row = 2 LET p_col = 2
    LET g_success = 'Y'
    LET p_close = 'N'

    OPEN WINDOW t600f_w AT p_row,p_col WITH FORM "axm/42f/axmt600f"
         ATTRIBUTE (STYLE = g_win_style CLIPPED)
    CALL cl_ui_init()
    INPUT l_oeb15,l_oeb931,l_oeb932 FROM oeb15,oeb931,oeb932

       BEFORE INPUT
         LET l_oeb15 = g_today
         DISPLAY l_oeb15 TO l_oeb15

       AFTER FIELD oeb15
         IF cl_null(l_oeb15) THEN
            CALL cl_err('','aar-011',0)
            NEXT FIELD oeb15
         END IF

       AFTER FIELD oeb931
         IF NOT cl_null(l_oeb931) THEN
            CALL t600_oeb931(l_oeb931)
            IF NOT cl_null(g_errno) THEN
               CALL cl_err(l_oeb931,g_errno,1)
               NEXT FIELD oeb931
            END IF
            SELECT COUNT(*) INTO i FROM oea_file,oeb_file
             WHERE oea01 = oeb01
               AND oea01 = g_oga.oga16
               AND oeb15 = l_oeb15
               AND oeb932> 0
               AND oeb931= l_oeb931
               AND (oeb12 - oeb24 + oeb25 - oeb26 ) > 0
               AND oeaconf = 'Y'
            IF cl_null(i) THEN LET i = 0 END IF
            IF i <= 0 THEN
               CALL cl_err(l_oeb931,'axm_108',0)
               NEXT FIELD oeb931
            END IF
         END IF

       AFTER FIELD oeb932
         IF NOT cl_null(l_oeb932) THEN
            IF l_oeb932 <= 0 THEN
               CALL cl_err(l_oeb932,'axm_104',1)
               NEXT FIELD oeb932
            END IF
         END IF

      ON ACTION controlp
          CASE
            WHEN INFIELD(oeb931)
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_oeb931"
                 LET g_qryparam.default1 = l_oeb931
                 LET g_qryparam.arg1 = l_oeb15
                 LET g_qryparam.arg2 = g_oga.oga16
                 CALL cl_create_qry() RETURNING l_oeb931
                 DISPLAY BY NAME l_oeb931
                 NEXT FIELD oeb931
            OTHERWISE EXIT CASE
          END CASE

          AFTER INPUT
             IF INT_FLAG THEN
                LET INT_FLAG = 0
                LET g_success = 'N'
                LET p_close = 'Y'
             ELSE
                SELECT COUNT(*) INTO i FROM oea_file,oeb_file
                 WHERE oea01 = oeb01
                   AND oea01 = g_oga.oga16
                   AND oeb15 = l_oeb15
                   AND oeb932> 0
                   AND oeb931= l_oeb931
                   AND (oeb12 - oeb24 + oeb25 - oeb26 ) > 0
                   AND oeaconf = 'Y'
                IF cl_null(i) THEN LET i = 0 END IF
                IF i <= 0 THEN
                   CALL cl_err(l_oeb931,'axm_108',0)
                   NEXT FIELD oeb931
                END IF
             END IF

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT

      ON ACTION about         
         CALL cl_about()      

      ON ACTION help          
         CALL cl_show_help()  

      ON ACTION controlg      
         CALL cl_cmdask()     
      END INPUT


      IF p_close = 'Y' THEN CLOSE WINDOW t600f_w LET p_close = 'N' RETURN END IF

      CLOSE WINDOW t600f_w
####首先刪除原有單身資料
      DELETE FROM ogb_file WHERE ogb01 = g_oga.oga01
      IF sqlca.sqlcode THEN
         CALL cl_err3("del","ogb_file",g_oga.oga01,'',SQLCA.sqlcode,"","",1)
         LET g_success = 'N'
         RETURN
      END IF
#End

####抓取符合條件的資料產生單身
      SELECT oea_file.* INTO g_oea.* FROM oea_file
       WHERE oea01 = g_oga.oga16
    IF g_oea.oea37 = 'Y' THEN
      LET l_sql = " SELECT oee063,oee073,oee083,oeb_file.* ",
                  "   FROM oea_file,oeb_file,oee_file ",
                  "  WHERE oea01 = oeb01 ",
                  "    AND oee10 = oeb01 ",
                  "    AND oee11 = oeb03 ",
                  "    AND oeb931 = '",l_oeb931,"'",
                  "    AND oeb15  = '",l_oeb15,"'",
                  "    AND oea01  = '",g_oga.oga16,"'",
                  "    AND oeb932 > 0 ",
                  "    AND (oeb12 - oeb24 + oeb25 - oeb26) > 0 ",
                  "    AND oeaconf = 'Y' ",
                  "  ORDER BY oeb03 "
    ELSE
      LET l_sql = " SELECT 0,0,0,oeb_file.* ",
                  "   FROM oea_file,oeb_file ",
                  "  WHERE oea01 = oeb01 ",
                  "    AND oeb931 = '",l_oeb931,"'",
                  "    AND oeb15  = '",l_oeb15,"'",
                  "    AND oea01  = '",g_oga.oga16,"'",
                  "    AND oeb932 > 0 ",
                  "    AND (oeb12 - oeb24 + oeb25 - oeb26) > 0 ",
                  "    AND oeaconf = 'Y' ",
                  "  ORDER BY oeb03 "
    END IF

      PREPARE t600_mix_b_pb FROM l_sql
      DECLARE t600_mix_b_c2 CURSOR FOR t600_mix_b_pb
      FOREACH t600_mix_b_c2 INTO l_oee063,l_oee073,l_oee083,l_oeb.*
        IF STATUS THEN
           LET g_success = 'N'
           EXIT FOREACH
        END IF

        INITIALIZE b_ogb.* TO NULL
        SELECT SUM(ogb12),SUM(ogb912),SUM(ogb915),SUM(ogb917)
          INTO l_ship_qty,l_ogb912,l_ogb915,l_ogb917
          FROM ogb_file,oga_file
         WHERE oga01 = ogb01
           AND ogb31 =l_oeb.oeb01
           AND ogb32 =l_oeb.oeb03
           AND oga09 =g_argv0 # 1.出貨通知單 2.出貨單
           AND ogaconf = 'Y'

        IF l_ship_qty IS NULL THEN LET l_ship_qty = 0 END IF
        IF l_ogb912 IS NULL   THEN LET l_ogb912   = 0 END IF
        IF l_ogb915 IS NULL   THEN LET l_ogb915   = 0 END IF
        IF l_ogb917 IS NULL   THEN LET l_ogb917   = 0 END IF

        SELECT SUM(ohb12),SUM(ohb912),SUM(ohb915),SUM(ohb917)
          INTO l_retn_qty,l_ohb912,l_ohb915,l_ohb917
          FROM ohb_file,oha_file
         WHERE oha01 = ohb01
           AND ohb33 =l_oeb.oeb01
           AND ohb34 =l_oeb.oeb03
           AND ohaconf = 'Y'
           AND oha09 ='4'      #MOD-840086 add

        IF l_retn_qty IS NULL THEN LET l_retn_qty = 0 END IF
        IF l_ohb912 IS NULL   THEN LET l_ohb912   = 0 END IF
        IF l_ohb915 IS NULL   THEN LET l_ohb915   = 0 END IF
        IF l_ohb917 IS NULL   THEN LET l_ohb917   = 0 END IF

        IF g_oea.oea37 = 'Y' THEN
           LET b_ogb.ogb912= l_oee063 - l_ogb912   + l_ohb912
           LET b_ogb.ogb915= l_oee073 - l_ogb915   + l_ohb915
        #單位轉換
           SELECT oee081 INTO l_oee081 FROM oee_file
            WHERE oee10 = l_oeb.oeb01                                                                              
              AND oee11 = l_oeb.oeb03                                                                              
           CALL s_umfchk(b_ogb.ogb04,l_oee081,l_oeb.oeb916)
                 RETURNING l_flag,l_fac
           IF l_flag = 1 THEN
              LET l_fac = 1
           END IF
           LET b_ogb.ogb917= (l_oee083*l_fac) - l_ogb917  + l_ohb917
        ELSE
           LET b_ogb.ogb912= l_oeb.oeb912- l_ogb912   + l_ohb912
           LET b_ogb.ogb915= l_oeb.oeb915- l_ogb915   + l_ohb915
           LET b_ogb.ogb917= l_oeb.oeb917- l_ogb917   + l_ohb917
        END IF
        LET b_ogb.ogb910= l_oeb.oeb910
        LET b_ogb.ogb911= l_oeb.oeb911
        LET b_ogb.ogb913= l_oeb.oeb913
        LET b_ogb.ogb914= l_oeb.oeb914
        LET b_ogb.ogb916= l_oeb.oeb916

        SELECT ima25 INTO l_ima25 FROM ima_file
         WHERE ima01 = l_oeb.oeb04
        IF cl_null(l_oeb.oeb09) THEN
           IF g_azw.azw04='2' THEN
              SELECT rtz07 INTO l_oeb.oeb09 FROM rtz_file
               WHERE rtz01 = g_plant
           ELSE
           SELECT ima35 INTO l_oeb.oeb09 FROM ima_file
            WHERE ima01 = l_oeb.oeb04
           END IF   #No.FUN-870007
        END IF
        IF cl_null(l_oeb.oeb091) THEN
           SELECT ima36 INTO l_oeb.oeb091 FROM ima_file
            WHERE ima01 = l_oeb.oeb04
        END IF

        LET b_ogb.ogb01 = g_oga.oga01
        LET b_ogb.ogb03 = l_oeb.oeb03
        LET b_ogb.ogb04 = l_oeb.oeb04
        LET b_ogb.ogb05 = l_oeb.oeb05
        LET b_ogb.ogb05_fac= l_oeb.oeb05_fac
        LET b_ogb.ogb06 = l_oeb.oeb06
        LET b_ogb.ogb07 = l_oeb.oeb07
        LET b_ogb.ogb08 = l_oeb.oeb08
        LET b_ogb.ogb09 = l_oeb.oeb09
        LET b_ogb.ogb091= l_oeb.oeb091
        LET b_ogb.ogb092= l_oeb.oeb092
        LET b_ogb.ogb931= l_oeb931
        LET b_ogb.ogb932= l_oeb932
        LET b_ogb.ogb11 = l_oeb.oeb11
        LET b_ogb.ogb12 = (l_oeb.oeb12/l_oeb.oeb932)*l_oeb932
        LET l_diff = l_oeb.oeb12 - l_oeb.oeb24 + l_oeb.oeb25 - l_oeb.oeb26
        IF b_ogb.ogb12 > l_diff THEN
           LET b_ogb.ogb12 = l_diff
           LET b_ogb.ogb932 = b_ogb.ogb12/(l_oeb.oeb12/l_oeb.oeb932)
        END IF

        LET b_ogb.ogb13 = l_oeb.oeb13
        SELECT SUM(ogb14),SUM(ogb14t)
          INTO b_ogb.ogb14,b_ogb.ogb14t
          FROM oga_file,ogb_file
         WHERE ogb31 = l_oeb.oeb01
           AND ogb32 = l_oeb.oeb03
           AND ogb1005 = l_oeb.oeb1003
           AND ogb01 = oea01
           AND ogapost = 'Y'
           AND ogaconf != 'X'
        SELECT SUM(ohb14),SUM(ohb14t)
          INTO l_ohb14,l_ohb14t
          FROM ohb_file,oha_file
         WHERE oha01 = ohb01
           AND ohb33 = l_oeb.oeb01
           AND ohb34 = l_oeb.oeb03
           AND ohapost = 'Y'
        IF cl_null(b_ogb.ogb14) THEN
           LET b_ogb.ogb14 = 0
        END IF
        IF cl_null(b_ogb.ogb14t) THEN
           LET b_ogb.ogb14t = 0
        END IF
        IF cl_null(l_ohb14) THEN
           LET l_ohb14 = 0
        END IF
        IF cl_null(l_ohb14t) THEN
           LET l_ohb14t = 0
        END IF

        LET b_ogb.ogb14 = l_oeb.oeb14 - b_ogb.ogb14 + l_ohb14
        LET b_ogb.ogb14t = l_oeb.oeb14t - b_ogb.ogb14t + l_ohb14t
        LET b_ogb.ogb15 = l_ima25
        LET b_ogb.ogb15_fac = l_oeb.oeb05_fac
        LET b_ogb.ogb31 = l_oeb.oeb01
        LET b_ogb.ogb32 = l_oeb.oeb03
        LET b_ogb.ogb19 = l_oeb.oeb906
        IF cl_null(b_ogb.ogb19) THEN
           LET b_ogb.ogb19 = 'N'
        END IF
       #LET b_ogb.ogb17  = 'N' #CHI-AC0034 mark
        LET b_ogb.ogb17  = b_ogb.ogb17 #CHI-AC0034
        LET b_ogb.ogb18  = b_ogb.ogb12
        LET b_ogb.ogb37  = l_oeb.oeb37  #FUN-AB0061
        LET b_ogb.ogb13  = l_oeb.oeb13
        LET b_ogb.ogb908 = l_oeb.oeb908
        LET b_ogb.ogb930 = l_oeb.oeb930
        LET b_ogb.ogb1001= l_oeb.oeb1001
        LET b_ogb.ogb1012= l_oeb.oeb1012
        LET b_ogb.ogb1002= l_oeb.oeb1002
        LET b_ogb.ogb1003= l_oeb.oeb15
        LET b_ogb.ogb1004= l_oeb.oeb1004
        LET b_ogb.ogb1005= l_oeb.oeb1003
        LET b_ogb.ogb1006= l_oeb.oeb1006
        LET b_ogb.ogb1007= l_oeb.oeb1007
        LET b_ogb.ogb1008= l_oeb.oeb1008
        LET b_ogb.ogb1009= l_oeb.oeb1009
        LET b_ogb.ogb1010= l_oeb.oeb1010
        LET b_ogb.ogb1014 = 'N'
        LET b_ogb.ogb1013 = 0
        LET b_ogb.ogb41 = l_oeb.oeb41
        LET b_ogb.ogb42 = l_oeb.oeb42
        LET b_ogb.ogb43 = l_oeb.oeb43

        LET b_ogb.ogb44 = l_oeb.oeb44
        LET b_ogb.ogbplant = l_oeb.oebplant
        LET b_ogb.ogblegal = l_oeb.oeblegal
        IF g_azw.azw04='2' THEN
           LET b_ogb.ogb45 = l_oeb.oeb45   
           LET b_ogb.ogb46 = l_oeb.oeb46                                                                                            
           LET b_ogb.ogb47 = l_oeb.oeb47
        ELSE
           LET b_ogb.ogb44='1'
           LET b_ogb.ogb47=0
        END IF

        CALL t600_b_else()

        LET g_msg=b_ogb.ogb03,' ',b_ogb.ogb04,' ',b_ogb.ogb12
        CALL cl_msg(g_msg)        

        IF cl_null(b_ogb.ogb05_fac) THEN
           LET b_ogb.ogb05_fac = 1
        END IF
        IF cl_null(b_ogb.ogb12) THEN
           LET b_ogb.ogb12 = 0
        END IF
        IF cl_null(b_ogb.ogb13) THEN
           LET b_ogb.ogb13 = 0
        END IF
#FUN-AB0061 -----------add start----------------                             
        IF cl_null(b_ogb.ogb37) OR b_ogb.ogb37 = 0 THEN
           LET b_ogb.ogb37 = b_ogb.ogb13
        END IF                                             
#FUN-AB0061 -----------add end----------------          
        IF cl_null(b_ogb.ogb14) THEN
           LET b_ogb.ogb14 = 0
        END IF
        IF cl_null(b_ogb.ogb14t) THEN
           LET b_ogb.ogb14t = 0
        END IF
        IF cl_null(b_ogb.ogb15_fac) THEN
           LET b_ogb.ogb15_fac = 1
        END IF
        IF cl_null(b_ogb.ogb16) THEN
           LET b_ogb.ogb16 = 0
        END IF
        IF cl_null(b_ogb.ogb18) THEN
           LET b_ogb.ogb18 = 0
        END IF
        IF cl_null(b_ogb.ogb60) THEN
           LET b_ogb.ogb60 = 0
        END IF
        IF cl_null(b_ogb.ogb63) THEN
           LET b_ogb.ogb63 = 0
        END IF
        IF cl_null(b_ogb.ogb64) THEN
           LET b_ogb.ogb64 = 0
        END IF
        IF cl_null(b_ogb.ogb1006) THEN
           LET b_ogb.ogb1006 = 100
        END IF

        LET b_ogb.ogbplant = g_plant 
        LET b_ogb.ogblegal = g_legal  
        #add by huyx110916---start---
        IF cl_null(b_ogb.ogbud07) THEN LET b_ogb.ogbud07=0 END IF
        IF cl_null(b_ogb.ogbud08) THEN LET b_ogb.ogbud08=0 END IF
        IF cl_null(b_ogb.ogbud09) THEN LET b_ogb.ogbud09=0 END IF
        #add by huyx110916---end---
    #   IF cl_null(b_ogb.ogb50) THEN LET b_ogb.ogb50 = '1' END IF #FUN-AA0057

        INSERT INTO ogb_file VALUES(b_ogb.*)
        IF STATUS THEN
           CALL cl_err3("ins","ogb_file","b_ogb.ogb01","",SQLCA.sqlcode,"","ins ogb",1)
           LET g_success = 'N'
           RETURN
        END IF
    END FOREACH

    LET g_oga.oga50 = NULL

    SELECT SUM(ogb14) INTO g_oga.oga50 FROM ogb_file WHERE ogb01 = g_oga.oga01

    CALL cl_digcut(g_oga.oga50,t_azi04) RETURNING g_oga.oga50  #CHI-7A0036-add
    IF cl_null(g_oga.oga50) THEN LET g_oga.oga50 = 0 END IF

   #-----No:FUN-A50103-----
   SELECT oea61,oea1008,oea261,oea262,oea263
     INTO l_oea61,l_oea1008,l_oea261,l_oea262,l_oea263
     FROM oea_file
    WHERE oea01 = g_oga.oga16
   IF g_oga.oga213 = 'Y' THEN
      LET g_oga.oga52 = g_oga.oga50 * l_oea261 / l_oea1008
      LET g_oga.oga53 = g_oga.oga50 * (l_oea262+l_oea263) / l_oea1008
   ELSE
      LET g_oga.oga52 = g_oga.oga50 * l_oea261 / l_oea61
      LET g_oga.oga53 = g_oga.oga50 * (l_oea262+l_oea263) / l_oea61
   END IF
  #LET g_oga.oga52 = g_oga.oga50 * g_oga.oga161/100
  #LET g_oga.oga53 = g_oga.oga50 * (g_oga.oga162+g_oga.oga163)/100
   #-----No:FUN-A50103 END-----
    CALL cl_digcut(g_oga.oga52,t_azi04) RETURNING g_oga.oga52  #CHI-7A0036-add
    CALL cl_digcut(g_oga.oga53,t_azi04) RETURNING g_oga.oga53  #CHI-7A0036-add

    UPDATE oga_file SET oga50=g_oga.oga50,
                        oga52=g_oga.oga52,
                        oga53=g_oga.oga53
     WHERE oga01 = g_oga.oga01
    IF STATUS THEN
       CALL cl_err3("upd","oga_file",g_oga.oga01,"",SQLCA.sqlcode,"","_bu():upd oga",1)  #No.FUN-670008
       LET g_success = 'N'
       RETURN
    END IF

#End

END FUNCTION
FUNCTION t600_oeb931(l_oeb931)
DEFINE l_obiacti   LIKE obi_file.obiacti
DEFINE l_obi02     LIKE obi_file.obi02
DEFINE l_oeb931    LIKE oeb_file.oeb931

     LET g_errno = ''

     SELECT DISTINCT obiacti,obi02 INTO l_obiacti,l_obi02 FROM obj_file,obi_file
      WHERE obj01 = obi01
        AND obi01 = l_oeb931
     IF cl_null(l_obiacti) THEN LET l_obiacti = 'N' END IF

     CASE WHEN SQLCA.SQLCODE = 100  LET g_errno ='axm-810'
          WHEN l_obiacti NOT MATCHES '[Yy]'     LET g_errno ='axm_105'
          OTHERWISE                 LET g_errno = SQLCA.SQLCODE USING '-------'
     END CASE

     IF NOT cl_null(g_errno) THEN
        LET l_obi02 = NULL
     END IF
     DISPLAY l_obi02 TO obi02
END FUNCTION


FUNCTION t600_rvbs()
  DEFINE b_rvbs  RECORD  LIKE rvbs_file.*
  DEFINE l_ima25         LIKE ima_file.ima25
  DEFINE l_fac           LIKE ogb_file.ogb05_fac


 #抓取庫存單位換算率，寫到rvbs_file一律以庫存單位計量
  SELECT ima25 INTO l_ima25 FROM ima_file WHERE ima01= g_ogb[l_ac].ogb04
  IF g_ogb[l_ac].ogb05=l_ima25 THEN
     LET l_fac = 1
  ELSE
     CALL s_umfchk(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb05,l_ima25)
          RETURNING g_cnt,l_fac
  END IF
  IF cl_null(l_fac) OR l_fac = 0  THEN
    #### ----庫存/料號無法轉換 -------###
    CALL cl_err('ogb05/ima25: ','abm-731',1)
    LET g_success ='N'
    RETURN
  END IF
 #
  LET b_rvbs.rvbs00 = g_prog
  LET b_rvbs.rvbs01 = g_oga.oga01
  LET b_rvbs.rvbs02 = g_ogb[l_ac].ogb03
  LET b_rvbs.rvbs021 = g_ogb[l_ac].ogb04  #料號
  LET b_rvbs.rvbs06 = g_ogb[l_ac].ogb12 * l_fac  #數量*庫存單位換算率
  LET b_rvbs.rvbs08 = g_ogb[l_ac].ogb41
  LET b_rvbs.rvbs09 = -1  #-1出庫
  CALL s_ins_rvbs("1",b_rvbs.*)
END FUNCTION

FUNCTION t600_amount(p_qty,p_price,p_rate,p_azi03)                                                                                  
DEFINE   p_qty       LIKE ogb_file.ogb12    #數量                                                                                   
DEFINE   p_price     LIKE ogb_file.ogb13    #單價(未折扣)                                                                           
DEFINE   p_rate      LIKE ogb_file.ogb1006  #折扣率                                                                                 
DEFINE   p_azi03     LIKE azi_file.azi03    #單價位數                                                                               
DEFINE   l_price     LIKE ogb_file.ogb13    #單價(已折扣)                                                                           
DEFINE   l_amount    LIKE ogb_file.ogb14    #金額                                                                                   
                                                                                                                                    
    IF cl_null(p_rate) THEN                                                                                                         
       LET p_rate = 100                                                                                                             
    END IF                                                                                                                          
    LET l_price = cl_digcut(p_price*p_rate/100,p_azi03)                                                                             
    LET l_amount= p_qty*l_price                                                                                                     
    IF cl_null(l_amount) THEN                                                                                                       
       LET l_amount = 0                                                                                                             
    END IF                                                                                                                          
    RETURN l_amount                                                                                                                 
END FUNCTION                                                                                                                        

FUNCTION t600_chk_poz00()
  DEFINE l_exT    LIKE oax_file.oax01,
         l_oea904 LIKE oea_file.oea904,
         l_poz00  LIKE poz_file.poz00

 IF NOT cl_null(g_oga.oga16) THEN 
    SELECT oea904 INTO l_oea904 
      FROM oea_file
     WHERE oea01 = g_oga.oga16
 ELSE
  DECLARE t600_oea904 CURSOR FOR
            SELECT oea904 FROM ogb_file,oea_file
              WHERE ogb31 = oea01
                AND ogb01 = g_oga.oga01
     FOREACH t600_oea904 INTO l_oea904
       EXIT FOREACH
     END FOREACH
 END IF 
 
 
       IF NOT cl_null(l_oea904) THEN
           SELECT poz011 INTO l_poz00   #先得到流程為銷售或代採參數
             FROM poz_file
            WHERE poz01=l_oea904
           IF l_poz00 = '1' THEN  #銷售
               LET l_exT = g_oax.oax01   
           ELSE
               LET l_exT = g_pod.pod01   #代採
           END IF
       ELSE 
           IF g_oga.oga09 ='4' THEN 
               LET l_exT = g_oax.oax01   
           END IF
           IF g_oga.oga09 ='6' THEN
               LET l_exT = g_pod.pod01   #代採
           END IF
           IF g_oga.oga09 ='5' THEN      #出通單
               LET l_exT = g_oax.oax01   
           END IF
       END IF 
 
    RETURN l_exT
END FUNCTION

FUNCTION t600_m2()
DEFINE l_cnt LIKE type_file.chr1
   IF s_shut(0) THEN RETURN END IF
   IF g_oga.oga01 IS NULL THEN RETURN END IF                                                                         
   IF g_oga.ogaconf = 'X' THEN CALL cl_err('',9024,0) RETURN END IF  
   IF g_argv0 MATCHES '[15]' THEN    
      IF g_oga.ogaconf = 'Y' THEN
         CALL cl_err('',9023,0) RETURN 
      END IF
   END IF
   IF g_argv0 MATCHES '[24689]' THEN  
      IF g_oga.ogaconf = 'Y' THEN
         CALL cl_err('',9023,0) RETURN 
      END IF
      IF g_oga.ogapost = 'Y' THEN
         CALL cl_err('','mfg0175',0) RETURN 
      END IF
   END IF

   IF g_argv0 MATCHES '[15]' THEN
      LET g_cnt=0
      SELECT COUNT(*) INTO g_cnt FROM oga_file
       WHERE oga011 = g_oga.oga01
         AND oga09 IN ('2','4','6')   
         AND ogaconf != 'X'
      IF g_cnt > 0 THEN
         CALL cl_err('oga011!='':','axm-228',1)
         RETURN 
      END IF
   END IF

   IF g_oga.oga55 matches '[Ss]' THEN
       CALL cl_err('','apm-030',0)
       RETURN 
   END IF
   LET l_cnt=0 
   SELECT COUNT(*) INTO l_cnt FROM ogb_file
    WHERE ogb01=g_oga.oga01  
   IF l_cnt=0 THEN CALL cl_err('',-400,0) RETURN END IF
   LET g_rec_b3=0                                                                                    
   CALL t600_modify_rate()  
END FUNCTION

FUNCTION t600_modify_rate()
DEFINE p_row,p_col      LIKE type_file.num5                                                                                         
DEFINE i  LIKE type_file.num5                                                                                                       
DEFINE l_ogb_b    DYNAMIC ARRAY OF RECORD                                                                                          
                   l_no         LIKE ogb_file.ogb03,                                                                                
                   l_p_no       LIKE ogb_file.ogb04,                                                                                
                   l_p_desc     LIKE ogb_file.ogb06,                                                                                
                   l_koulv      LIKE ogb_file.ogb46,                                                                                
                   l_koulv2     LIKE ogb_file.ogb46                                                                                 
                END RECORD 
DEFINE l_ogb_t2 RECORD
                   l_no       LIKE ogb_file.ogb03,                                                                                
                   l_p_no     LIKE ogb_file.ogb04,                                                                                
                   l_p_desc   LIKE ogb_file.ogb06,                                                                                
                   l_koulv    LIKE ogb_file.ogb46,                                                                                
                   l_koulv2   LIKE ogb_file.ogb46                                                                                 
                END RECORD                                                                                                         
DEFINE l_exit_sw     LIKE type_file.chr1                                                                                         
DEFINE l_cnt         LIKE type_file.num5                                                                                                    
DEFINE l_no_b        LIKE ogb_file.ogb03
DEFINE l_koulv2_b    LIKE ogb_file.ogb46
DEFINE p_cmd         LIKE type_file.chr1
DEFINE l_ogb44       LIKE ogb_file.ogb44

   WHENEVER ERROR CONTINUE     
                               
   OPEN WINDOW t620_b_w WITH FORM "axm/42f/axmt410_b"
      ATTRIBUTE (STYLE = g_win_style CLIPPED)                         
   CALL cl_ui_locale('axmt410_b')                                   

   DROP TABLE ogb_b_tmp
   CREATE TEMP TABLE ogb_b_tmp
   (
    l_no     dec(5),
    l_koulv2 dec(5,2)
    );                                                                                                                           
 WHILE TRUE                       
  LET l_exit_sw = 'y'                                                                                                              
   INPUT ARRAY l_ogb_b WITHOUT DEFAULTS FROM s_oeb_b.*                                                                             
          ATTRIBUTE(COUNT=g_rec_b3,UNBUFFERED,                                                                    
                    INSERT ROW=TRUE,DELETE ROW=TRUE,APPEND ROW=TRUE)                                                                
                                                                                                                                    
     BEFORE INPUT                                                                                                                   
        IF g_rec_b3 != 0 THEN                                                                                                      
           CALL fgl_set_arr_curr(i)                                                                                                 
        END IF                                                                                                                      
                                                                                                                                    
     BEFORE ROW                                                                                                                     
        LET i=ARR_CURR()       
        IF g_rec_b3>=i THEN
           LET p_cmd='u'
           LET l_ogb_t2.*=l_ogb_b[i].*                                                                                             
           BEGIN WORK                                                                                                               
           CALL cl_show_fld_cont()
        END IF                                                                                                  
     BEFORE INSERT                      
        LET p_cmd='a'
        INITIALIZE l_ogb_t2.* TO NULL                                                                                            
        CALL cl_show_fld_cont()                                                                                                     
                                                                                                                                    
     AFTER FIELD l_no                                                                                                               
        IF NOT cl_null(l_ogb_b[i].l_no) THEN                                                                                      
           IF l_ogb_b[i].l_no<=0  THEN                                                                                             
              NEXT FIELD l_no                                                                                                       
           ELSE                                                                                                                     
              LET l_cnt=0          
             SELECT COUNT(*) INTO l_cnt FROM ogb_file                                                                              
               WHERE ogb01=g_oga.oga01 AND ogb03=l_ogb_b[i].l_no                                                    
              IF l_cnt=0 THEN                                                                                                       
                 CALL cl_err('','art-267',0)                                                                                        
                 NEXT FIELD l_no                                                                                                    
              END IF
              LET l_ogb44=''   
              SELECT ogb44 INTO l_ogb44 FROM ogb_file
               WHERE ogb01=g_oga.oga01 AND ogb03=l_ogb_b[i].l_no     
#             IF l_ogb44 !='3' OR l_ogb44 != '4' THEN  #FUN-870007-mark
              IF l_ogb44 NOT MATCHES '[34]' THEN       #FUN-870007
                 CALL cl_err('','art-439',0)
                 NEXT FIELD l_no 
              END IF                                                                                                 
           END IF
           IF l_ogb_b[i].l_no !=l_ogb_t2.l_no OR l_ogb_t2.l_no IS NULL THEN
               LET l_cnt=0              
               SELECT COUNT(*) INTO l_cnt FROM ogb_b_tmp
                WHERE l_no=l_ogb_b[i].l_no
               IF l_cnt > 0 THEN
                  CALL cl_err('',-239,0)
                  LET l_ogb_b[i].l_no=l_ogb_t2.l_no
                  NEXT FIELD l_no
               END IF
            END IF 
         END IF                                                                                                  
         SELECT ogb04,ogb06,ogb46 
           INTO l_ogb_b[i].l_p_no,l_ogb_b[i].l_p_desc,l_ogb_b[i].l_koulv                                    
          FROM ogb_file 
          WHERE ogb01=g_oga.oga01 AND ogb03=l_ogb_b[i].l_no 
         IF SQLCA.sqlcode=100 THEN 
            LET l_ogb_b[i].l_p_no=NULL
            LET l_ogb_b[i].l_p_desc=NULL
            LET l_ogb_b[i].l_koulv=NULL
         END IF                                                                                                                  
   AFTER FIELD l_koulv2                                                                                                             
      IF NOT cl_null(l_ogb_b[i].l_koulv2) THEN                                                                                     
         IF l_ogb_b[i].l_koulv2<=0 OR 
            l_ogb_b[i].l_koulv2>=100  THEN 
            CALL cl_err('','atm-070',0)                                                                                          
            NEXT FIELD l_koulv2                                                                                                     
         END IF              
         IF l_ogb_b[i].l_koulv2=l_ogb_b[i].l_koulv THEN                                                                            
            CALL cl_err('','art-270',0)                                                                                             
            NEXT FIELD l_koulv2                                                                                                     
         END IF                                                                                                                     
      END IF                                                                                                                        
    BEFORE DELETE
         IF l_ogb_t2.l_no>0 AND l_ogb_t2.l_no IS NOT NULL THEN
            IF NOT cl_delb(0,0) THEN
               CANCEL DELETE
            END IF   
            DELETE FROM ogb_b_tmp WHERE l_no = l_ogb_t2.l_no                                                                       
            IF SQLCA.sqlcode OR SQLCA.sqlerrd[3]=0 THEN                                                             
               CALL cl_err3("del","ogb_b_tmp",g_oga.oga01,"",STATUS,"","",1)                                                       
               ROLLBACK WORK
               CANCEL DELETE
            END IF
            LET g_rec_b3=g_rec_b3-1  
         END IF                                                                                                                
         COMMIT WORK                                                                                                                            
      ON ROW CHANGE 
         IF INT_FLAG THEN
            CALL cl_err('',9001,0)
            LET INT_FLAG=0
            LET l_ogb_b[i].*=l_ogb_t2.*
            ROLLBACK WORK
            EXIT INPUT
         END IF
         UPDATE ogb_b_tmp SET l_no = l_ogb_b[i].l_no,                                                                              
                            l_koulv2= l_ogb_b[i].l_koulv2                                                                          
          WHERE l_no = l_ogb_t2.l_no AND l_koulv2=l_ogb_t2.l_koulv2        
         IF SQLCA.sqlcode OR SQLCA.sqlerrd[3]=0 THEN                                                                             
            CALL cl_err3("upd","ogb_b_tmp",g_oga.oga01,"",STATUS,"","",1)                                                        
         ELSE
            MESSAGE 'UPDATE O.K'
            COMMIT WORK  
         END IF            
    AFTER INSERT                                                                                                                   
        IF INT_FLAG THEN                                                                                                            
           CALL cl_err('',9001,0)                                                                                                   
           LET INT_FLAG = 0                                                                                                         
           #CKP                                                                                                                     
           CANCEL INSERT                                                                                                            
        END IF               
        INSERT INTO ogb_b_tmp VALUES(l_ogb_b[i].l_no,l_ogb_b[i].l_koulv2)
        IF SQLCA.sqlcode THEN                                                                                                      
           CALL cl_err3("ins","ogb_b_tmp",g_oga.oga01,"",STATUS,"","",1)                                                  
           CANCEL INSERT                                                                                                         
        ELSE
           MESSAGE 'INSERT O.K'
           COMMIT WORK
           LET g_rec_b3=g_rec_b3+1 
        END IF                                                                                                                   
      
                                                                                                                  
      AFTER ROW                                                                                                                     
            LET i = ARR_CURR()                                                                                                      
            IF INT_FLAG THEN                                                                                                        
               CALL cl_err('',9001,0)                                                                                               
               LET INT_FLAG = 0
               IF p_cmd='u' THEN
                  LET l_ogb_b[i].*=l_ogb_t2.* 
               END IF                                                                                                            
               ROLLBACK WORK                                                                                                        
               EXIT INPUT                                                                                                           
            END IF 
            COMMIT WORK                                                                                                           
                                                                                                                                    
     ON IDLE g_idle_seconds                                                                                                         
       CALL cl_on_idle()                                                                                                            
       CONTINUE INPUT                                                                                                               
                                                                                                                                    
   END INPUT                                                                                                                        
                                                                                                                                    
  IF l_exit_sw='y' THEN EXIT WHILE ELSE CONTINUE WHILE END IF                                                                       
  END WHILE                                                                                                                         
                                                                                                                                    
  CLOSE WINDOW t620_b_w                 
  IF INT_FLAG THEN                                                                                                                 
      LET INT_FLAG = 0                                                                                                              
      RETURN                                                                                                                        
   END IF
  LET g_sql="SELECT * FROM ogb_b_tmp ORDER BY l_no "                                                                               
  PREPARE sele_prep1 FROM g_sql                                                                                                    
  DECLARE sele_decl1 CURSOR FOR sele_prep1                                                                                         
  FOREACH sele_decl1 INTO l_no_b,l_koulv2_b                                                                                         
     IF SQLCA.sqlcode THEN                                                                                                          
        CALL cl_err('foreach:',SQLCA.sqlcode,1)                                                                                     
        EXIT FOREACH                                                                                                                
     END IF
     UPDATE ogb_file SET ogb46=l_koulv2_b WHERE ogb01=g_oga.oga01 AND ogb03=l_no_b  
     LET l_no_b=''
     LET l_koulv2_b=''                                                  
  END FOREACH             
                     
END FUNCTION
FUNCTION t600_fetch_price(p_cmd)
DEFINE p_cmd           LIKE type_file.chr1
DEFINE l_ogb05         LIKE ogb_file.ogb05                                                                                          
DEFINE l_occ930        LIKE occ_file.occ930                                                                                        
DEFINE lc_type         LIKE type_file.chr1
DEFINE li_ret          LIKE type_file.num5  #No.FUN-870007

   IF g_sma.sma116 MATCHES '[23]' AND NOT cl_null(g_ogb[l_ac].ogb916) THEN
       LET l_ogb05=b_ogb.ogb916 #No.FUN-A10016
   ELSE
      LET l_ogb05=b_ogb.ogb05  #No.FUN-A10016
   END IF
   LET l_occ930 = ''
   SELECT occ930 INTO l_occ930 FROM occ_file WHERE occ01=g_oga.oga03
   IF cl_null(l_occ930) THEN
      LET lc_type='1' #外部客戶
   ELSE
      LET lc_type='2' #內部客戶
   END IF
   IF lc_type='1' THEN
      CALL s_fetch_price_new(g_oga.oga03,b_ogb.ogb04,l_ogb05,g_oga.oga69,
                             '2',g_oga.ogaplant,g_oga.oga23,g_oga.oga31,g_oga.oga32,
                             g_oga.oga01,b_ogb.ogb03,b_ogb.ogb917,
                             b_ogb.ogb1004,p_cmd)
        #RETURNING b_ogb.ogb13    #FUN-AB0061
         RETURNING b_ogb.ogb13,b_ogb.ogb37  #FUN-AB0061
      IF cl_null(g_ogb[l_ac].ogb13) THEN CALL s_unitprice_entry(g_oga.oga03,g_oga.oga31,g_oga.ogaplant) END IF #FUN-9C0120
   ELSE
      IF NOT cl_null(g_ogb[l_ac].ogb04) AND NOT cl_null(g_ogb[l_ac].ogb05) THEN
      CALL s_trade_price(g_oga.ogaplant,l_occ930,l_occ930,g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb05)
         RETURNING li_ret,g_ogb[l_ac].ogb13
         IF NOT li_ret THEN
            LET g_ogb[l_ac].ogb13 = 0
         ELSE 
            LET g_ogb[l_ac].ogb47 = 0
         END IF
      END IF
   END IF
#FUN-AB0061 -----------add start----------------                             
   IF cl_null(g_ogb[l_ac].ogb37) OR g_ogb[l_ac].ogb37 = 0 THEN
      LET g_ogb[l_ac].ogb37 = g_ogb[l_ac].ogb13
   END IF                                             
#FUN-AB0061 -----------add end----------------   
   IF g_oga.oga213 = 'N' THEN
      LET g_ogb[l_ac].ogb14 =t600_amount(g_ogb[l_ac].ogb917,g_ogb[l_ac].ogb13,g_ogb[l_ac].ogb1006,t_azi03) 
      CALL cl_digcut(g_ogb[l_ac].ogb14,t_azi04)  RETURNING g_ogb[l_ac].ogb14  
      LET g_ogb[l_ac].ogb14t= g_ogb[l_ac].ogb14*(1+ g_oga.oga211/100)
      CALL cl_digcut(g_ogb[l_ac].ogb14t,t_azi04) RETURNING g_ogb[l_ac].ogb14t
   ELSE
      LET g_ogb[l_ac].ogb14t=t600_amount(g_ogb[l_ac].ogb917,g_ogb[l_ac].ogb13,g_ogb[l_ac].ogb1006,t_azi03)  
      CALL cl_digcut(g_ogb[l_ac].ogb14t,t_azi04) RETURNING g_ogb[l_ac].ogb14t
      LET g_ogb[l_ac].ogb14 = g_ogb[l_ac].ogb14t/(1+ g_oga.oga211/100)
      CALL cl_digcut(g_ogb[l_ac].ogb14,t_azi04)  RETURNING g_ogb[l_ac].ogb14 
   END IF
END FUNCTION

FUNCTION t600_set_no_required()

  CALL cl_set_comp_required("oga71",FALSE)

END FUNCTION
FUNCTION t600_set_required()

   IF g_aza.aza94 = 'Y' THEN
      CALL cl_set_comp_required("oga71",TRUE)
   END IF
END FUNCTION
#No.FUN-9C0073 -----------------By chenls 10/01/18
#No.FUN-A20022 -----------------By cockroach 10/02/05
FUNCTION t600_oga95_amount()                 
  DEFINE l_ogb      DYNAMIC ARRAY OF RECORD
                        ogb04     LIKE ogb_file.ogb04,
                        ogb14t    LIKE ogb_file.ogb14t 
                    END RECORD
  DEFINE l_i          LIKE type_file.num5    
  DEFINE i            LIKE type_file.num5
  DEFINE l_flag       LIKE type_file.chr1 
  DEFINE l_amount     LIKE oga_file.oga95 
  
   DECLARE t600_point CURSOR FOR
           SELECT ogb04,ogb14t 
             FROM ogb_file 
            WHERE ogb01 = g_oga.oga01
              AND ogb1005 = '1'    #MOD-B10154  
   CALL l_ogb.clear()
   LET i = 1
   LET l_i = 1
   FOREACH t600_point INTO l_ogb[i].*
      IF STATUS THEN CALL cl_err('foreach ogb',STATUS,0) EXIT FOREACH END IF
      LET i = i + 1
   END FOREACH
   CALL l_ogb.deleteElement(i)
   LET l_i=(i-1)
 
   CALL s_point(g_oga.oga87,l_ogb) RETURNING l_flag,l_amount
   IF NOT l_flag THEN
     RETURN 0  
   ELSE 
     RETURN l_amount	
   END IF	  
   
END FUNCTION
#No.FUN-A20022 ADD END-----------------------------------------
#FUN-A70138

#FUN-A80081--Add--Begin
FUNCTION t600_g_b8()
   DEFINE l_sql           STRING   
   DEFINE p_cmd           LIKE type_file.chr1    
   DEFINE l_amt,l_net     LIKE oof_file.oof07
   DEFINE l_lock_sw       LIKE type_file.chr1     
   DEFINE l_modify_flag   LIKE type_file.chr1   
   DEFINE g_temp          STRING  
   DEFINE
          l_allow_insert  LIKE type_file.num5,  
          l_allow_delete  LIKE type_file.num5,   
          l_allow_update  LIKE type_file.num5    
   DEFINE l_rec_ape_b     LIKE type_file.num10    
   DEFINE l_n,l_i         LIKE type_file.num10    
   DEFINE i               LIKE type_file.num5
   DEFINE li_result       LIKE type_file.num5
   DEFINE l_cnt           LIKE type_file.num5
   DEFINE g_flag1         LIKE type_file.chr1
   DEFINE l_count         LIKE type_file.num5
   DEFINE l_flag          LIKE type_file.chr1
#TQC-B20053 -------------STA
#  DEFINE l_chk_res       LIKE type_file.num5         
#  DEFINE l_b2            LIKE cob_file.cob08
#  DEFINE l_ima35         LIKE ima_file.ima35
#  DEFINE l_ima36         LIKE ima_file.ima36
#TQC-B20053 -------------END
   LET l_count = 0
   LET l_flag = 'N'
   SELECT COUNT(*) INTO l_count 
     FROM ogb_file
    WHERE ogb01 = g_oga.oga01
   IF cl_null(g_oga.oga011) AND cl_null(g_oga.oga16) THEN
      IF l_count = 0 THEN
         LET l_flag = 'Y'
      END IF
   END IF
   IF l_flag = 'N' THEN
      RETURN
   END IF
   
   IF NOT cl_confirm('axm-765') THEN
      RETURN
   END IF           
  
   OPEN WINDOW t600_axm_w AT 12,2 WITH FORM "axm/42f/axmt600_c"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) 
 
    CALL cl_ui_locale("axmt600_c")

   CALL g_ogb1.clear()
   LET g_cnt =1
 
#   LET l_sql ="SELECT * ",
#              "  FROM temp table"
#   PREPARE t600_ogb_pb_bcl FROM l_sql                                                                                                       
#   DECLARE ogb_curs_bcl CURSOR FOR t600_ogb_pb_bcl
   
#  LET l_sql ="SELECT tmp_ogb04,'','',tmp_ogb09,tmp_ogb091,tmp_ogb092,'',tc_qty ",
#             "  FROM temp table",
#             " WHERE tmp_ogb04 = ? "	
#  PREPARE t600_ogb_pb_bcl_1 FROM l_sql                                                                                                       
#  DECLARE ogb_curs_bcl_1 CURSOR FOR t600_ogb_pb_bcl_1   
   
#   LET l_sql ="SELECT * ",
#              "  FROM oea_file,oeb_file",
#              " WHERE oeb04 = ?",
#              "   AND oea23 = ?",
#              "   AND oea24 = ?",
#              "   AND oea08 = ?",
#              "   AND oea03 = ?",
#              "   AND oea21 = ?",
#              "   AND oea32 = ?",
#              "   AND oea01 = oeb01",
#              "   AND oea00 = '1'",
#              "   AND oeaconf = 'Y'",
#              "   AND oeb12-oeb24+oeb25 > 0",
#              " ORDER BY oeb15"
#   PREPARE t600_ogb_pb FROM l_sql                                                                                                       
#   DECLARE ogb_curs CURSOR FOR t600_ogb_pb
 
   DROP TABLE tmp_ogb_file    
   
   CREATE TEMP TABLE tmp_ogb_file( 
    tmp_ogb04      LIKE ogb_file.ogb04,            
    tmp_ogb09      LIKE ogb_file.ogb09,        
    tmp_ogb091     LIKE ogb_file.ogb091, 
    tmp_ogb092     LIKE ogb_file.ogb092,
    tc_qty        LIKE type_file.num5)

   IF STATUS THEN CALL cl_err('create tmp',STATUS,0) 
      CALL cl_used(g_prog,g_time,2) RETURNING g_time
      EXIT PROGRAM 
   END IF 

   CALL s_showmsg_init()

   LET l_ac1= 1
   LET l_allow_insert = cl_detail_input_auth("insert")
   LET l_allow_delete = cl_detail_input_auth("delete")

   INPUT ARRAY g_ogb1 WITHOUT DEFAULTS FROM s_ogb1.*
         ATTRIBUTE(COUNT=l_rec_ape_b,MAXCOUNT=g_max_rec,UNBUFFERED,             
                   INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)
 
      BEFORE INSERT
         LET l_ac1 = ARR_CURR()
         LET p_cmd='a'
         INITIALIZE g_ogb1[l_ac1].* TO NULL
         LET g_ogb1_t.* = g_ogb1[l_ac1].*
         NEXT FIELD ogb04
 
      AFTER INSERT
         IF INT_FLAG THEN
            CALL cl_err('',9001,0)
            LET INT_FLAG = 0
            CANCEL INSERT
         END IF
         INSERT INTO tmp_ogb_file(tmp_ogb04,tmp_ogb09,tmp_ogb091,tmp_ogb092,tc_qty) 
          VALUES(g_ogb1[l_ac1].ogb04,g_ogb1[l_ac1].ogb09,g_ogb1[l_ac1].ogb091,
                 g_ogb1[l_ac1].ogb092,g_ogb1[l_ac1].qty) 
         IF SQLCA.sqlcode THEN
            CALL cl_err3("ins","tmp_ogb_file",g_ogb1[l_ac1].ogb04,g_ogb1[l_ac1].ogb09,SQLCA.sqlcode,"","ins tmp_ogb_file:",1)  
            LET g_success = 'N'
            CANCEL INSERT
         ELSE
            LET l_rec_ape_b = l_rec_ape_b + 1
            MESSAGE "insert ok"
            DISPLAY l_rec_ape_b TO FORMONLY.cnk
         END IF 
 
      BEFORE INPUT
         IF l_rec_ape_b != 0 THEN
            CALL fgl_set_arr_curr(l_ac1)
         END IF
 
      BEFORE ROW
         LET p_cmd = ''
         LET l_ac1 = ARR_CURR()
         LET l_lock_sw = 'N'
         IF l_rec_ape_b >= l_ac1 THEN
            LET p_cmd='u'
            LET g_ogb1_t.* = g_ogb1[l_ac1].*
           #OPEN ogb_curs_bcl_1 USING g_ogb1[l_ac1].ogb04                                                                          
           #IF STATUS THEN                                                                                                          
           #   CALL cl_err("OPEN ogb_curs_bcl_1:", STATUS, 1)                                                                             
           #   LET l_lock_sw = "Y"                                                                                                  
           #ELSE                                                                                                                    
           #   FETCH ogb_curs_bcl_1 INTO g_ogb1[l_ac1].*                                                                                    
           #   IF SQLCA.sqlcode THEN                                                                                                
           #      CALL cl_err(g_ogb1[l_ac1].ogb04,SQLCA.sqlcode,1)                                                                      
           #      LET l_lock_sw = "Y"                                                                                               
           #   END IF
           #END IF        
         END IF

      AFTER FIELD ogb04
         IF NOT cl_null(g_ogb1[l_ac1].ogb04) THEN
#FUN-AA0059 ---------------------start----------------------------
            IF NOT s_chk_item_no(g_ogb1[l_ac1].ogb04,"") THEN
               CALL cl_err('',g_errno,1)
               LET g_ogb1[l_ac1].ogb04= g_ogb1_t.ogb04
               NEXT FIELD ogb04
            END IF
#FUN-AA0059 ---------------------end-------------------------------

           LET l_count = 0
           SELECT COUNT(*) INTO l_count
             FROM tmp_ogb_file
            WHERE tmp_ogb04 = g_ogb1[l_ac1].ogb04
           IF l_count > 0 THEN
              NEXT FIELD ogb04
           ELSE
           	  LET g_ogb1[l_ac1].ima02 = NULL
           	  LET g_ogb1[l_ac1].ima021 = NULL
           	  SELECT ima02,ima021 INTO g_ogb1[l_ac1].ima02,g_ogb1[l_ac1].ima021
           	    FROM ima_file
           	   WHERE ima01 = g_ogb1[l_ac1].ogb04    
           END IF    
         END IF     
#TQC-B20053 ------------STA
#        CALL t600_check_ogb04('ogb04',l_ac,p_cmd) RETURNING         
#                l_chk_res,g_buf,g_buf1,l_b2,l_ima35,l_ima36
#          IF NOT l_chk_res THEN
#             NEXT FIELD ogb04
#          END IF
#TQC-B20053 ------------END
 
        AFTER FIELD ogb09
           IF NOT t600_chk_ogb09_1() THEN
              NEXT FIELD CURRENT
           END IF

        AFTER FIELD ogb092
           IF NOT t600_chk_ogb092_1() THEN
              NEXT FIELD ogb09  
           END IF

       AFTER FIELD ogb091
          CASE t600_chk_ogb91_1()
             WHEN "ogb09" NEXT FIELD ogb09
             WHEN "ogb12" NEXT FIELD ogb12
          END CASE 
          
       AFTER FIELD qty
          IF cl_null(g_ogb1[l_ac1].qty) THEN
             LET g_ogb1[l_ac1].qty = 0
          END IF   
          IF g_ogb1[l_ac1].qty <= 0 THEN
             NEXT FIELD qty
          END IF             

        BEFORE DELETE                          
           IF NOT cl_null(g_ogb1[l_ac1].ogb04) THEN
              IF NOT cl_delb(0,0) THEN
                 CANCEL DELETE
              END IF
              DELETE FROM tmp_ogb_file
               WHERE tmp_ogb04 = g_ogb1[l_ac1].ogb04
              IF SQLCA.sqlcode THEN
                 CALL cl_err3("del","tmp_ogb_file",g_ogb1[l_ac1].ogb04,'',SQLCA.sqlcode,"","",1)  
                 CANCEL DELETE
              END IF
              LET l_rec_ape_b = l_rec_ape_b - 1
              MESSAGE "delete ok"
           END IF
 
 
      ON ROW CHANGE
          IF INT_FLAG THEN
             CALL cl_err('',9001,0)
             LET INT_FLAG = 0
             LET g_ogb1[l_ac1].* = g_ogb1_t.*
             LET g_success = 'N'
             EXIT INPUT
          END IF
          IF l_lock_sw = 'Y' THEN
             CALL cl_err(g_ogb1[l_ac].ogb04,-263,1)
             LET g_ogb1[l_ac].* = g_ogb1_t.*
          ELSE
             UPDATE tmp_ogb_file SET tmp_ogb04 = g_ogb1[l_ac1].ogb04,
                                    tmp_ogb09 = g_ogb1[l_ac1].ogb09,
                                    tmp_ogb091 = g_ogb1[l_ac1].ogb091,
                                    tmp_ogb092 = g_ogb1[l_ac1].ogb092, 
                                    tc_qty = g_ogb1[l_ac1].qty                                 
             WHERE tmp_ogb04 = g_ogb1_t.ogb04
             IF STATUS OR SQLCA.SQLCODE THEN
                CALL cl_err3("upd","tmp_ogb_file",g_ogb1_t.ogb04,'',SQLCA.sqlcode,"","upd ape:",1)   
                LET g_success = 'N'
                LET g_ogb1[l_ac1].* = g_ogb1_t.*
             ELSE 
                MESSAGE "update ok"   
             END IF 
          END IF
         
      ON ACTION CONTROLP
           CASE
                 WHEN INFIELD(ogb04)
#FUN-AA0059---------mod------------str-----------------
#                     CALL cl_init_qry_var()
#                     LET g_qryparam.form ="q_ima20"
#                     CALL cl_create_qry() RETURNING g_ogb1[l_ac1].ogb04
                      CALL q_sel_ima(FALSE, "q_ima20","","","","","","","",'' ) 
                       RETURNING g_ogb1[l_ac1].ogb04  
#FUN-AA0059---------mod------------end-----------------
                      DISPLAY BY NAME g_ogb1[l_ac1].ogb04
                WHEN INFIELD(ogb09)
                    IF g_azw.azw04='2' THEN
                       CALL q_img42(FALSE,TRUE,g_ogb1[l_ac1].ogb04,'',
                             '','','A','1',g_oga.ogaplant)
                        RETURNING g_ogb1[l_ac1].ogb09,g_ogb1[l_ac1].ogb091,                                                       
                                  g_ogb1[l_ac1].ogb092   
                    ELSE
                    CALL q_img4(FALSE,TRUE,g_ogb1[l_ac1].ogb04,'','','','A')
                              RETURNING g_ogb1[l_ac1].ogb09,g_ogb1[l_ac1].ogb091,
                                        g_ogb1[l_ac1].ogb092
                    END IF 
                     IF INT_FLAG THEN
                        LET INT_FLAG = 0
                     END IF

                     DISPLAY BY NAME g_ogb1[l_ac1].ogb09
                     DISPLAY BY NAME g_ogb1[l_ac1].ogb091
                     DISPLAY BY NAME g_ogb1[l_ac1].ogb092
                     NEXT FIELD ogb09

                 WHEN INFIELD(ogb091)
                     IF g_azw.azw04='2' THEN                                                                                        
                        CALL q_img42(FALSE,TRUE,g_ogb1[l_ac1].ogb04,'',                                               
                              '','','A','1',g_oga.ogaplant)                                          
                        RETURNING g_ogb1[l_ac1].ogb09,g_ogb1[l_ac1].ogb091,                                                             
                                        g_ogb1[l_ac1].ogb092                                                                          
                     ELSE
                     CALL q_img4(FALSE,TRUE,g_ogb1[l_ac1].ogb04,'','','','A')
                              RETURNING g_ogb1[l_ac1].ogb09,g_ogb1[l_ac1].ogb091,
                                        g_ogb1[l_ac1].ogb092
                     END IF  
                     IF INT_FLAG THEN
                        LET INT_FLAG = 0
                     END IF

                     DISPLAY BY NAME g_ogb1[l_ac1].ogb09
                     DISPLAY BY NAME g_ogb1[l_ac1].ogb091
                     DISPLAY BY NAME g_ogb1[l_ac1].ogb092
                     NEXT FIELD ogb091     
                     
                 WHEN INFIELD(ogb092)
                     IF g_azw.azw04='2' THEN                                                                                        
                        CALL q_img42(FALSE,TRUE,g_ogb1[l_ac1].ogb04,'',                                               
                              '','','A','1',g_oga.ogaplant)                                          
                        RETURNING g_ogb1[l_ac1].ogb09,g_ogb1[l_ac1].ogb091,                                                             
                                        g_ogb1[l_ac1].ogb092                                                                          
                     ELSE
                     CALL q_img4(FALSE,TRUE,g_ogb1[l_ac1].ogb04,'','','','A')
                              RETURNING g_ogb1[l_ac1].ogb09,g_ogb1[l_ac1].ogb091,
                                        g_ogb1[l_ac1].ogb092
                     END IF  
                     IF INT_FLAG THEN
                        LET INT_FLAG = 0
                     END IF

                     DISPLAY BY NAME g_ogb1[l_ac1].ogb09
                     DISPLAY BY NAME g_ogb1[l_ac1].ogb091
                     DISPLAY BY NAME g_ogb1[l_ac1].ogb092
                     NEXT FIELD ogb092
           END CASE
 
      AFTER ROW
          LET l_ac1 = ARR_CURR()
          SELECT img09 INTO g_ogb1[l_ac1].img09
            FROM img_file
           WHERE img01=g_ogb1[l_ac1].ogb04 AND img02=g_ogb1[l_ac1].ogb09 
             AND img03=g_ogb1[l_ac1].ogb091 AND img04=g_ogb1[l_ac1].ogb092          
          IF INT_FLAG THEN
             CALL cl_err('',9001,0)
             LET INT_FLAG = 0
             IF p_cmd = 'u' THEN
                LET g_ogb1[l_ac1].* = g_ogb1_t.*
             END IF
             LET g_success = 'N'
             EXIT INPUT
          END IF
              
 
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         
         CALL cl_about()      
 
      ON ACTION help          
         CALL cl_show_help()  
 
      ON ACTION controlg      
         CALL cl_cmdask()     
  
      ON ACTION controls                                                                                             
         CALL cl_set_head_visible("","AUTO")   
 
   END INPUT

   IF INT_FLAG THEN
      LET g_success='N'
      LET INT_FLAG = 0
   END IF
  
   IF cl_confirm('axm-764') THEN
      CALL ogb_ins_1()          
   END IF
    
   CLOSE WINDOW t600_axm_w

END FUNCTION 

FUNCTION t600_chk_ogb09_1()
  DEFINE l_slip     LIKE oay_file.oayslip   
  DEFINE l_smyware  LIKE smy_file.smyware   
 
    IF NOT cl_null(g_ogb1[l_ac1].ogb09) THEN
       LET g_cnt=0
       SELECT count(*) INTO g_cnt  FROM imd_file
        WHERE imd01=g_ogb1[l_ac1].ogb09
          AND imd11='Y'     
          AND imdacti='Y'
       IF g_cnt=0 THEN
          CALL cl_err(g_ogb1[l_ac1].ogb09,'axm-993',0)
          RETURN FALSE
       END IF
       #No.FUN-AA0048  --Begin
       #IF g_azw.azw04= '2' THEN
       #    LET g_cnt =0
       #    SELECT COUNT(*) INTO g_cnt FROM imd_file 
       #     WHERE imd01=g_ogb1[l_ac1].ogb09 
       #       AND imd20=g_plant
       #    IF g_cnt=0 THEN 
       #       CALL cl_err(g_ogb1[l_ac1].ogb09,'art-487',0)
       #       RETURN FALSE
       #    END IF
       #END IF
       IF NOT s_chk_ware(g_ogb1[l_ac1].ogb09) THEN
          RETURN FALSE
       END IF
       #No.FUN-AA0048  --End  
    END IF
   RETURN TRUE
END FUNCTION

FUNCTION t600_chk_ogb91_1()
   DEFINE l_qty LIKE ogb_file.ogb12
   DEFINE l_cnt LIKE type_file.num5 
   DEFINE l_oea99   LIKE oea_file.oea99    
   DEFINE li_result LIKE type_file.num5    

   IF g_ogb1[l_ac1].ogb091 IS NULL THEN LET g_ogb1[l_ac1].ogb091 =' ' END IF
   IF g_oaz.oaz104 = 'N' THEN 
      IF g_ogb1[l_ac1].ogb092 IS NULL THEN LET g_ogb1[l_ac1].ogb092 =' ' END IF  
   END IF 
   IF g_ogb1[l_ac1].ogb091 IS NOT NULL AND NOT cl_null(g_ogb1[l_ac1].ogb09) THEN     
      IF g_oga.oga09 MATCHES '[12468]' THEN   
         IF NOT s_chksmz(g_ogb1[l_ac1].ogb04, g_oga.oga01,
                         g_ogb1[l_ac1].ogb09, g_ogb1[l_ac1].ogb091) THEN
            RETURN "ogb09"
         END IF
         #No.FUN-AA0048  --Begin
         #IF g_azw.azw04='2' THEN
         #   LET l_cnt =0                                                                                                      
         #   SELECT COUNT(*) INTO l_cnt FROM imd_file                                                                           
         #    WHERE imd01=g_ogb1[l_ac1].ogb09                                                                                    
         #      AND imd20=g_plant                                                                                   
         #   IF l_cnt=0 THEN                                                                                                    
         #      CALL cl_err(g_ogb1[l_ac1].ogb09,'art-487',0)                                                                      
         #      RETURN "ogb09"                                                                                                   
         #   END IF       
         #END IF
         IF NOT s_chk_ware(g_ogb1[l_ac1].ogb09) THEN
            RETURN "ogb09"
         END IF
#FUN-AB0011 ---------------------STA
        #IF s_joint_venture( g_ogb1[l_ac].ogb04,g_plant) OR NOT s_internal_item( g_ogb1[l_ac].ogb04,g_plant ) THEN
         IF s_joint_venture( g_ogb1[l_ac1].ogb04,g_plant) OR NOT s_internal_item( g_ogb1[l_ac1].ogb04,g_plant ) THEN  #Mod No:TQC-B30107
            RETURN NULL
         END IF
#FUN-AB0011 ---------------------END
         #No.FUN-AA0048  --End  
         IF g_oaz.oaz104 = 'N' THEN 
            SELECT COUNT(*) INTO g_cnt FROM img_file
             WHERE img01 = g_ogb1[l_ac1].ogb04  
               AND img02 = g_ogb1[l_ac1].ogb09  
               AND img03 = g_ogb1[l_ac1].ogb091 
               AND img04 = g_ogb1[l_ac1].ogb092  
            IF g_cnt = 0 THEN                                
              #FUN-C80107 modify begin---------------------------121107
              #CALL cl_err(g_ogb1[l_ac1].ogb04,'axm-244',0)
              #LET g_ogb1[l_ac1].ogb091 = ''
              #RETURN "ogb09"
               LET g_flag2 = NULL
               CALL s_inv_shrt_by_warehouse(g_sma.sma894[2,2],g_ogb[l_ac].ogb09) RETURNING g_flag2
               IF g_flag2 = 'N' OR g_flag2 IS NULL THEN
                  CALL cl_err(g_ogb1[l_ac1].ogb04,'axm-244',0)
                  LET g_ogb1[l_ac1].ogb091 = ''
                  RETURN "ogb09"
               ELSE
                  IF g_sma.sma892[3,3] = 'Y' THEN
                     IF g_bgjob='N' OR cl_null(g_bgjob) THEN
                        IF NOT cl_confirm('mfg1401') THEN
                           RETURN "ogb09"
                        END IF
                     END IF
                  END IF
                  CALL s_add_img(g_ogb[l_ac].ogb04,g_ogb[l_ac].ogb09,
                                 g_ogb[l_ac].ogb091,g_ogb[l_ac].ogb092,
                                 g_oga.oga01,g_ogb[l_ac].ogb03,g_oga.oga02)
                  IF g_errno='N' THEN
                     RETURN "ogb09"
                  END IF
               END IF
               #FUN-C80107 modify end-----------------------------121107
            END IF
         END IF
      END IF
   END IF
   RETURN NULL
END FUNCTION

FUNCTION t600_chk_ogb092_1()
   DEFINE l_oea99   LIKE oea_file.oea99    
   DEFINE li_result LIKE type_file.num5   
   DEFINE l_img18   LIKE img_file.img18   
#FUN-AB0011 -----------------STA
   IF s_joint_venture( g_ogb1[l_ac1].ogb04,g_plant) OR NOT s_internal_item( g_ogb1[l_ac1].ogb04,g_plant ) THEN
       RETURN TRUE
   END IF
#FUN-AB0011 -----------------END
   IF cl_null(g_ogb1[l_ac1].ogb092) THEN LET  g_ogb1[l_ac1].ogb092=' ' END IF
   IF NOT cl_null(g_ogb1[l_ac1].ogb04) AND NOT cl_null(g_ogb1[l_ac1].ogb09)
      AND g_ogb1[l_ac1].ogb091 IS NOT NULL
      AND g_ogb1[l_ac1].ogb092 IS NOT NULL THEN   

      IF g_oga.oga09 MATCHES '[12468]' THEN  
         SELECT COUNT(*) INTO g_cnt FROM img_file
          WHERE img01 = g_ogb1[l_ac1].ogb04   #料號
            AND img02 = g_ogb1[l_ac1].ogb09   #倉庫
            AND img03 = g_ogb1[l_ac1].ogb091  #儲位
            AND img04 = g_ogb1[l_ac1].ogb092  #批號
         IF g_cnt > 0 THEN
            SELECT img09 INTO g_ogb1[l_ac1].img09
              FROM img_file
             WHERE img01=g_ogb1[l_ac1].ogb04 
               AND img02=g_ogb1[l_ac1].ogb09 
               AND img03=g_ogb1[l_ac1].ogb091 
               AND img04=g_ogb1[l_ac1].ogb092         
            SELECT img18 INTO l_img18 FROM img_file
             WHERE img01 = g_ogb1[l_ac1].ogb04   #料號
               AND img02 = g_ogb1[l_ac1].ogb09   #倉庫
               AND img03 = g_ogb1[l_ac1].ogb091  #儲位
               AND img04 = g_ogb1[l_ac1].ogb092  #批號
            IF l_img18 < g_oga.oga02 THEN
               CALL cl_err('','aim-400',0)   #須修改
               RETURN FALSE
            END IF
         ELSE
           #FUN-C80107 modify begin---------------------------121024
           #CALL cl_err('','asf-507',0)
           #RETURN FALSE
            LET g_flag2 = NULL
            CALL s_inv_shrt_by_warehouse(g_sma.sma894[2,2],g_ogb1[l_ac1].ogb09) RETURNING g_flag2
            IF g_flag2 = 'N' OR g_flag2 IS NULL THEN
               CALL cl_err('','asf-507',0)
               RETURN FALSE
            ELSE
               IF g_sma.sma892[3,3] = 'Y' THEN
                  IF g_bgjob='N' OR cl_null(g_bgjob) THEN
                     IF NOT cl_confirm('mfg1401') THEN
                        RETURN FALSE
                      END IF
                   END IF
                END IF
                CALL s_add_img(g_ogb1[l_ac1].ogb04,g_ogb1[l_ac1].ogb09,
                               g_ogb1[l_ac1].ogb091,g_ogb1[l_ac1].ogb092,
                               g_oga.oga01,0,g_oga.oga02)
                IF g_errno='N' THEN
                   RETURN FALSE
                END IF
             END IF
             SELECT img09 INTO g_ogb1[l_ac1].img09
               FROM img_file
              WHERE img01=g_ogb1[l_ac1].ogb04
                AND img02=g_ogb1[l_ac1].ogb09
                AND img03=g_ogb1[l_ac1].ogb091
                AND img04=g_ogb1[l_ac1].ogb092
             SELECT img18 INTO l_img18 FROM img_file
              WHERE img01 = g_ogb1[l_ac1].ogb04   #料號
                AND img02 = g_ogb1[l_ac1].ogb09   #倉庫
                AND img03 = g_ogb1[l_ac1].ogb091  #儲位
                AND img04 = g_ogb1[l_ac1].ogb092  #批號
             IF l_img18 < g_oga.oga02 THEN
                CALL cl_err('','aim-400',0)   #須修改
                RETURN FALSE
             END IF
            #FUN-C80107 modify end ----------------------------
         END IF
      END IF  
   END IF
   RETURN TRUE
END FUNCTION

FUNCTION ogb_ins_1()        
   DEFINE l_oea           RECORD LIKE oea_file.*
   DEFINE l_oeb           RECORD LIKE oeb_file.*
   DEFINE l_ogb           RECORD LIKE ogb_file.*
   DEFINE l_cnt           LIKE type_file.num5
   DEFINE l_ogb04         LIKE ogb_file.ogb04
   DEFINE l_ogb09         LIKE ogb_file.ogb09
   DEFINE l_ogb091        LIKE ogb_file.ogb091
   DEFINE l_ogb092        LIKE ogb_file.ogb092
   DEFINE l_qty           LIKE type_file.num5
   DEFINE l_abc           LIKE ogb_file.ogb15_fac
   DEFINE l_ogb03         LIKE ogb_file.ogb03
   DEFINE l_img09         LIKE img_file.img09
   DEFINE l_img09_1       LIKE img_file.img09  ##MOD-B30301
   DEFINE l_sql           STRING
   DEFINE l_msg           LIKE ze_file.ze03
   DEFINE l_t1            LIKE ze_file.ze03
   DEFINE l_t2            LIKE ze_file.ze03
   DEFINE l_t3            LIKE ze_file.ze03
   DEFINE l_t4            LIKE ze_file.ze03
   DEFINE l_t5            LIKE ze_file.ze03   #MOD-B30301
   DEFINE l_t6            LIKE ze_file.ze03   #MOD-B30301
   DEFINE l_t9            LIKE type_file.num5 #MOD-B30301
  #DEFINE l_t5            STRING              #MOD-B30301
   DEFINE l_t7            STRING              #MOD-B30301
   
    SELECT azi03,azi04 INTO t_azi03,t_azi04 
      FROM azi_file
     WHERE azi01=g_oga.oga23

   LET l_sql ="SELECT * ",
              "  FROM tmp_ogb_file"
   PREPARE t600_ogb_pb_bcl FROM l_sql                                                                                                       
   DECLARE ogb_curs_bcl CURSOR FOR t600_ogb_pb_bcl 
   
   LET l_sql ="SELECT * ",
              "  FROM oea_file,oeb_file",
              " WHERE oeb04 = ?",
              "   AND oea23 = ?",
              "   AND oea24 = ?",
              "   AND oea08 = ?",
              "   AND oea03 = ?",
              "   AND oea21 = ?",
              "   AND oea32 = ?",
              "   AND oea01 = oeb01",
              "   AND oea00 = '1'",
              "   AND oeaconf = 'Y'",
              "   AND oeb12-oeb24+oeb25 > 0",
              " ORDER BY oeb15"
   PREPARE t600_ogb_pb FROM l_sql                                                                                                       
   DECLARE ogb_curs CURSOR FOR t600_ogb_pb
   
   LET l_ogb03 = 1
   FOREACH ogb_curs_bcl INTO l_ogb04,l_ogb09,l_ogb091,l_ogb092,l_qty      
       LET l_t9 = l_qty     #MOD-B30301 add 
       #MOD-B30301---add------ 
       SELECT img09 INTO l_img09_1
         FROM img_file
        Where img01=l_ogb04 AND img02=l_ogb09 
         AND img03=l_ogb091 AND img04=l_ogb092
       ##MOD-B30301---add-------
       #Add No:TQC-B30124
       IF g_azw.azw04='2' THEN   #零售行业可以不通过订单
          CALL t600_b8_insogb(l_ogb04,l_ogb09,l_ogb091,l_ogb092,l_qty)
       ELSE
       #End Add No:TQC-B30124
          FOREACH ogb_curs USING l_ogb04,g_oga.oga23,g_oga.oga24,g_oga.oga08,g_oga.oga03,g_oga.oga21,g_oga.oga32
             INTO l_oea.*,l_oeb.*
             LET l_ogb.ogb01 = g_oga.oga01
             LET l_ogb.ogb03 = l_ogb03
             LET l_ogb.ogb04 = l_ogb04
             LET l_ogb.ogb05 = l_oeb.oeb05
             LET l_ogb.ogb05_fac = l_oeb.oeb05_fac
             IF cl_null(l_ogb.ogb05_fac) THEN
                LET l_ogb.ogb05_fac = 1
             END IF
             SELECT img09 INTO l_img09
               FROM img_file
              Where img01=l_ogb04 AND img02=l_ogb09 
                AND img03=l_ogb091 AND img04=l_ogb092
             LET l_ogb.ogb15 = l_img09
             CALL s_umfchk(l_ogb.ogb04,l_ogb.ogb05,l_ogb.ogb15)
                     RETURNING l_cnt,l_ogb.ogb15_fac                                                                                            
             IF l_cnt = '1'  THEN                                                                                                   
                CALL cl_err(l_ogb.ogb04,'abm-731',1)                                                                                
                LET l_ogb.ogb15_fac=1                                                                                                        
             END IF          
             IF cl_null(l_ogb.ogb15_fac) THEN
                LET l_ogb.ogb15_fac = 1
             END IF                   
             LET l_ogb.ogb06 = l_oeb.oeb06
             LET l_ogb.ogb07 = l_oeb.oeb07
             LET l_ogb.ogb08 = l_oeb.oeb08
             LET l_ogb.ogb09 = l_ogb09
             LET l_ogb.ogb091 = l_ogb091
             LET l_ogb.ogb092 = l_ogb092
             IF cl_null(l_ogb.ogb091) THEN LET l_ogb.ogb091 = ' ' END IF
             IF cl_null(l_ogb.ogb092) THEN LET l_ogb.ogb092 = ' ' END IF
             LET l_ogb.ogb1001 = l_oeb.oeb1001
             LET l_ogb.ogb1002 = l_oeb.oeb1002
             LET l_ogb.ogb1003 = l_oeb.oeb15
             LET l_ogb.ogb1004 = l_oeb.oeb1004
             LET l_ogb.ogb1005 = l_oeb.oeb1003
             LET l_ogb.ogb1006 = l_oeb.oeb1006
             LET l_ogb.ogb11 = l_oeb.oeb11
             LET l_ogb.ogb12 = l_oeb.oeb12-l_oeb.oeb24+l_oeb.oeb25
             IF l_ogb.ogb12*l_ogb.ogb15_fac > l_qty THEN
                CALL s_umfchk(l_ogb.ogb04,l_img09,l_ogb.ogb15)
                     RETURNING l_cnt,l_abc                                                                                           
                IF l_cnt = '1'  THEN                                                                                                   
                   CALL cl_err(l_ogb.ogb04,'abm-731',1)                                                                                
                   LET l_abc=1                                                                                                        
                END IF             
                LET l_ogb.ogb12 = l_qty * l_abc
             END IF
             LET l_ogb.ogb16 = l_ogb.ogb12*l_ogb.ogb15_fac   
             IF cl_null(l_ogb.ogb16) THEN
                LET l_ogb.ogb16 = 0
             END IF
             LET l_ogb.ogb18 = l_ogb.ogb12
             IF cl_null(l_ogb.ogb18) THEN
                LET l_ogb.ogb18 = 0
             END IF          
             LET l_ogb.ogb13 = l_oeb.oeb13
             LET l_ogb.ogb37 = l_oeb.oeb37 #FUN-AB0061 
             IF g_oga.oga213 = 'N' THEN
                LET l_ogb.ogb14 = l_ogb.ogb12 * l_ogb.ogb13
                CALL cl_digcut(l_ogb.ogb14,t_azi04) RETURNING l_ogb.ogb14
                LET l_ogb.ogb14t= l_ogb.ogb14 * (1+ g_oga.oga211/100)
                CALL cl_digcut(l_ogb.ogb14t,t_azi04) RETURNING l_ogb.ogb14t
             ELSE
                LET l_ogb.ogb14t = l_ogb.ogb12 * l_ogb.ogb13
                CALL cl_digcut(l_ogb.ogb14t,t_azi04) RETURNING l_ogb.ogb14t
                LET l_ogb.ogb14= l_ogb.ogb14t * (1+ g_oga.oga211/100)
                CALL cl_digcut(l_ogb.ogb14,t_azi04) RETURNING l_ogb.ogb14
             END IF
             LET l_ogb.ogb31 = l_oeb.oeb01
             LET l_ogb.ogb32 = l_oeb.oeb03
             LET l_ogb.ogb908 = l_oeb.oeb908
             LET l_ogb.ogb910 = l_ogb.ogb15
             LET l_ogb.ogb911 = l_ogb.ogb15_fac
             LET l_ogb.ogb912 = l_ogb.ogb12
             LET l_ogb.ogb913 = l_oeb.oeb913
             LET l_ogb.ogb914 = l_oeb.oeb914
             LET l_ogb.ogb915 = 0
             LET l_ogb.ogb916 = l_oeb.oeb916
             CALL s_umfchk(l_ogb.ogb04,l_ogb.ogb15,l_ogb.ogb916)
                     RETURNING l_cnt,l_abc                                                                                           
             IF l_cnt = '1'  THEN                                                                                                   
                CALL cl_err(l_ogb.ogb04,'abm-731',1)                                                                                
                LET l_abc=1                                                                                                        
             END IF          
             LET l_ogb.ogb917 = l_ogb.ogb12 * l_abc
             LET l_ogb.ogb19 = l_oeb.oeb906
             LET l_ogb.ogb1007 = l_oeb.oeb1007
             LET l_ogb.ogb1008 = l_oeb.oeb1008
             LET l_ogb.ogb1009 = l_oeb.oeb1009
             LET l_ogb.ogb1010 = l_oeb.oeb1010
             LET l_ogb.ogb1011 = l_oeb.oeb1011
             LET l_ogb.ogb1012 = l_oeb.oeb1012
             LET l_ogb.ogb41 = l_oeb.oeb41
             LET l_ogb.ogb42 = l_oeb.oeb42
             LET l_ogb.ogb43 = l_oeb.oeb43
             LET l_ogb.ogb44 = '1'
             LET l_ogb.ogb47 = 0
             LET l_ogb.ogb17 = 'N'
             LET l_ogb.ogb60 = 0
             LET l_ogb.ogb63 = 0
             LET l_ogb.ogb64 = 0
             LET l_ogb.ogb930 = l_oeb.oeb930
             LET l_ogb.ogb1014 = 'N'
             LET l_ogb.ogbplant = g_plant
             LET l_ogb.ogblegal = g_legal
          #  IF cl_null(l_ogb.ogb50) THEN LET l_ogb.ogb50 = '1' END IF #FUN-AA0057

             INSERT INTO ogb_file VALUES(l_ogb.*)
             IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3]=0 THEN
                CALL s_errmsg('','',"ins ogb",SQLCA.sqlcode,1)  
             ELSE
                LET l_ogb03 = l_ogb03 +1
                LET l_qty = l_qty - (l_ogb.ogb12*l_ogb.ogb15_fac)
             END IF
             IF l_qty  = 0 THEN
                EXIT FOREACH
             END IF                       
          END FOREACH
          IF l_qty > 0 THEN  
             LET l_t4 = NULL
             SELECT ze03 INTO l_msg FROM ze_file
              WHERE ze01='axm-763' AND ze02=g_lang
             SELECT ze03 INTO l_t1 FROM ze_file
              WHERE ze01='axm-876' AND ze02=g_lang
             #MOD-B30301----mod------str-------------
            #SELECT ze03 INTO l_t2 FROM ze_file
            # WHERE ze01='axm-875' AND ze02=g_lang
            #SELECT ze03 INTO l_t3 FROM ze_file
            # WHERE ze01='axm-874' AND ze02=g_lang
            #LET l_t5 = l_qty
            #LET l_t5 = l_t5.trim()
            #LET l_t4 = l_t1,l_ogb04 CLIPPED,l_t2 CLIPPED,l_t5 CLIPPED,l_t3 
             SELECT ze03 INTO l_t2 FROM ze_file
              WHERE ze01='axm-877' AND ze02=g_lang
             SELECT ze03 INTO l_t3 FROM ze_file
              WHERE ze01='axm-878' AND ze02=g_lang    
             SELECT ze03 INTO l_t5 FROM ze_file
              WHERE ze01='axm-879' AND ze02=g_lang
             SELECT ze03 INTO l_t6 FROM ze_file
              WHERE ze01='axm-873' AND ze02=g_lang
             LET l_t7 = l_t9 - l_qty 
             LET l_t7 = l_t7.trim()   
             LET l_t4 = l_t1 CLIPPED,l_ogb04 CLIPPED,",",l_t2 CLIPPED,l_t9 ,l_img09_1 CLIPPED,",",
                        l_t3 CLIPPED,l_t7 CLIPPED,l_img09_1 CLIPPED,",",l_t5 CLIPPED,l_t7 CLIPPED,l_img09_1 CLIPPED,l_t6
              
             #MOD-B30301----mod------end------------ 
             UPDATE ze_file SET ze03 = l_t4
              WHERE ze01='axm-763' AND ze02=g_lang                                            
             LET g_showmsg=l_ogb04,"/",l_qty   
             CALL s_errmsg("oeb04,oeb12",g_showmsg,"",'axm-763',1)
             UPDATE ze_file SET ze03 = l_msg
              WHERE ze01='axm-763' AND ze02=g_lang                 
          END IF
       END IF  #Add No:TQC-B30124
   END FOREACH
   
   CALL s_showmsg()               
END FUNCTION
#FUN-A80081--Add--End
#FUN-AA0089----------Add Start----------------------
FUNCTION t600_multi_ima01()	
DEFINE tok          base.StringTokenizer			
DEFINE l_ogb        RECORD LIKE ogb_file.*
DEFINE l_misc              LIKE type_file.chr4,    
       l_n                 LIKE type_file.num5,   
       l_b2                LIKE ima_file.ima31,
       l_ima35             LIKE ima_file.ima35,
       l_ima36             LIKE ima_file.ima36,
       l_oga15     LIKE oga_file.oga15,
       l_ima31     LIKE ima_file.ima31,     #ima單位
       l_ima906    LIKE ima_file.ima906,
       l_ima907    LIKE ima_file.ima907,
       l_ima908    LIKE ima_file.ima908,
       l_factor    LIKE ima_file.ima31_fac,
       l_rty05     LIKE rty_file.rty05,
       l_rtt01     LIKE rtt_file.rtt01,                                                                                                  
       l_rtt11     LIKE rtt_file.rtt11,
       l_rtv12     LIKE rtv_file.rtv12, 
       l_rtu01     LIKE rtu_file.rtu01
DEFINE l_cnt       LIKE type_file.num5,
       i           LIKE type_file.num5  #FUN-B10010

   CALL s_showmsg_init()
   LET tok = base.StringTokenizer.create(g_multi_ima01,"|")
   LET i = 1         #FUN-B10010			
   WHILE tok.hasMoreTokens()			
      LET l_ogb.ogb04 = tok.nextToken()
      
      IF cl_null(l_ogb.ogb04) THEN
         CONTINUE WHILE
      END IF 
      
      IF NOT s_chk_item_no(l_ogb.ogb04,"") THEN
         CALL s_errmsg("",l_ogb.ogb04,"INS ogb_file",g_errno,1)   
         CONTINUE WHILE
      END IF
      
      SELECT oga01,oga15,oga46 INTO l_ogb.ogb01,l_oga15,l_ogb.ogb41 
        FROM oga_file
       WHERE oga01 = g_oga.oga01
       
      SELECT MAX(ogb03)+1 INTO l_ogb.ogb03 FROM ogb_file
       WHERE ogb01 = g_oga.oga01
      IF cl_null(l_ogb.ogb03) THEN 
         LET l_ogb.ogb03 = 1
      END IF
#FUN-B10010--add--begin
      IF i=1 THEN
         LET l_ogb.ogb48 = g_ogb[l_ac].ogb48
         LET l_ogb.ogb49 = g_ogb[l_ac].ogb49
      ELSE
         LET l_ogb.ogb48 = NULL
         LET l_ogb.ogb49 = NULL
      END IF
#FUN-B10010--add-end
      LET l_misc=l_ogb.ogb04[1,4]
      IF l_ogb.ogb04[1,4]!='MISC' THEN
         IF g_aza.aza50 = 'Y' THEN #流通配銷的判斷挪至此,因為以上程式段為對料件的正確性控管
            SELECT COUNT(*) INTO l_n FROM ima_file,tqh_file
             WHERE ima01=l_ogb.ogb04
              #AND im1006 = tqh02
               AND ima1006 = tqh02   #Mod No:TQC-B30124
               AND tqhacti ='Y'
            IF l_n=0 THEN
               CALL s_errmsg("",l_ogb.ogb04,"INS ogb_file",'atm-018',1)   
               CONTINUE WHILE
            END IF

         END IF
      END IF
      
      IF l_ogb.ogb04='MISC' THEN  
         SELECT COUNT(*) INTO l_n FROM ima_file
          WHERE ima01=l_misc
            AND ima01='MISC'
         IF l_n=0 THEN
            CALL s_errmsg("",l_ogb.ogb04,"INS ogb_file",'aim-806',1)   
            CONTINUE WHILE
         END IF  
      END IF

      SELECT ima02,ima31,ima31_fac,ima35,ima36
        INTO g_buf,l_b2,l_ogb.ogb05_fac,l_ima35,l_ima36
        FROM ima_file WHERE ima01=l_ogb.ogb04
      IF STATUS AND l_ogb.ogb04[1,4]!='MISC' THEN  
         CALL s_errmsg("",l_ogb.ogb04,"INS ogb_file",STATUS,1)   
         CONTINUE WHILE
      END IF
      IF cl_null(l_ogb.ogb05) THEN
         LET l_ogb.ogb05=l_b2
      END IF

      IF cl_null(l_ogb.ogb09) THEN
         IF g_azw.azw04='2' THEN
            SELECT rtz07 INTO l_ogb.ogb09 FROM rtz_file
             WHERE rtz01 = g_plant
         ELSE
            LET l_ogb.ogb09=l_ima35
         END IF 
      END IF
      IF cl_null(l_ogb.ogb091) THEN
         LET l_ogb.ogb091=l_ima36
      END IF

      IF NOT s_chk_ware(l_ogb.ogb09) THEN
         LET l_ogb.ogb09 = NULL
         LET l_ogb.ogb091= NULL
      END IF

      IF l_ogb.ogb06 IS NULL THEN
         LET l_ogb.ogb06 = g_buf
      END IF
      
      SELECT ima31,ima906,ima907,ima908 INTO l_ima31,l_ima906,l_ima907,l_ima908
       FROM ima_file WHERE ima01 = l_ogb.ogb04
      
      IF g_sma.sma115 = 'Y' THEN        
         IF l_ima906 = '1' THEN  #不使用雙單位
            LET l_ogb.ogb913 = NULL
            LET l_ogb.ogb914  = NULL
            LET l_ogb.ogb915  = NULL
         ELSE
            LET l_ogb.ogb913 = l_ima907
            CALL s_du_umfchk(l_ogb.ogb04,'','','',l_ima31,l_ima907,l_ima906)
                 RETURNING g_errno,l_factor
            LET l_ogb.ogb914 = l_factor
            LET l_ogb.ogb915  = 0
         END IF
         LET l_ogb.ogb910 = l_ima31
         LET l_ogb.ogb911  = 1
         LET l_ogb.ogb912  = 0
      END IF
      IF g_sma.sma116 MATCHES '[23]' THEN
         CALL s_chk_va_setting1(l_ogb.ogb04)
              RETURNING g_flag,g_ima908
         IF g_flag=1 THEN
            CONTINUE WHILE
         END IF
         IF cl_null(l_ogb.ogb916) THEN
            LET l_ogb.ogb916=g_ima908
         END IF
      END IF
      IF cl_null(l_ogb.ogb916) THEN
         LET l_ogb.ogb916=l_ogb.ogb05
      END IF
      LET g_ima31 = l_b2
      
      IF cl_null(l_ogb.ogb31) THEN
         SELECT COUNT(*) INTO l_n
           FROM obk_file
          WHERE obk01 = l_ogb.ogb04
            AND obk02 = g_oga.oga03
         IF l_n = 1 THEN
            SELECT obk11 INTO l_ogb.ogb19
              FROM obk_file
             WHERE obk01 = l_ogb.ogb04
               AND obk02 = g_oga.oga03
         ELSE
            LET l_ogb.ogb19 = 'N'
         END IF
      END IF

      SELECT obk03 INTO l_ogb.ogb11 FROM obk_file
       WHERE obk01 = l_ogb.ogb04 AND obk02 = g_oga.oga03   
      
      IF NOT s_chkima08(l_ogb.ogb04) THEN
         CONTINUE WHILE
      END IF
      
      SELECT imc02 INTO l_ogb.ogb07 FROM imc_file
       WHERE imc01 = l_ogb.ogb04
      
      SELECT img09 INTO l_ogb.ogb15 FROM img_file
       WHERE img01 = l_ogb.ogb04 AND img02 = l_ogb.ogb09
         AND img03 = l_ogb.ogb091 AND img04 = l_ogb.ogb092 
      
      IF cl_null(l_ogb.ogb15) THEN
         LET l_ogb.ogb15 = l_ogb.ogb05
      END IF
      IF l_ogb.ogb15 = l_ogb.ogb05 THEN
         LET l_ogb.ogb15_fac = 1
      ELSE
      	 CALL s_umfchk(l_ogb.ogb04,l_ogb.ogb05,l_ogb.ogb15)
                 RETURNING l_cnt,l_ogb.ogb15_fac                                                                                            
         IF l_cnt = '1'  THEN                                                                                                   
            CALL cl_err(l_ogb.ogb04,'abm-731',1)                                                                                
            LET l_ogb.ogb15_fac=1                                                                                                        
         END IF          
         IF cl_null(l_ogb.ogb15_fac) THEN
            LET l_ogb.ogb15_fac = 1
         END IF
      END IF
       
      SELECT rty06 INTO l_ogb.ogb44 FROM rty_file
       WHERE rty01 = g_plant AND rty02 = l_ogb.ogb04
      IF STATUS='100' OR cl_null(l_ogb.ogb44) THEN
         LET l_ogb.ogb44 = 1
      END IF 
      
      IF l_ogb.ogb44='3' OR l_ogb.ogb44='4' THEN                                                                           
         SELECT rty05 INTO l_rty05 FROM rty_file WHERE rty01=g_plant                                                              
          AND rty02=l_ogb.ogb04 AND rtyacti="Y"     
         IF STATUS THEN
            CALL s_errmsg("",l_ogb.ogb04,"SEL rty05",STATUS,1)   
            CONTINUE WHILE
         END IF                                                                             
         IF NOT cl_null(l_rty05) THEN                                                                                                  
            SELECT rtt01,rtt11 INTO l_rtt01,l_rtt11 FROM rtt_file,rts_file,rto_file                                                    
             WHERE rts01 = rtt01 AND rttplant = rtsplant                                                                                   
          #   AND rts02 = rtt02 AND rtt04 =l_ogb.ogb04 AND rto01 = rts04 AND rtoplant = rts9plant #TQC-B30189 MARK
              AND rts02 = rtt02 AND rtt04 =l_ogb.ogb04 AND rto01 = rts04 AND rtoplant = rtsplant #TQC-B30189 ADD
              AND rto05 = l_rty05  AND rto06 = l_ogb.ogb44 AND rto08<=g_oga.oga02                                                
              AND rto09>=g_oga.oga02 AND rtt15="Y"                                                                                     
              AND rtoconf = 'Y' AND rtsconf = 'Y' AND rto03 = rts02 AND rtoplant =  g_plant                                         
            IF NOT cl_null(l_rtt01) THEN                                                                                               
               SELECT rtv12,rtu01 INTO l_rtv12,l_rtu01 FROM rtv_file,rtu_file,rtt_file                     
                WHERE rtt01=rtu04 AND rtt02=rtu02 AND rttplant=rtuplant AND rtuplant=g_plant                                            
                 AND rtuconf="Y" AND rtuplant=rtvplant AND rtu01=rtv01 AND rtu02=rtv02                                                     
                 AND rtt01=l_rtt01 AND rtu05=l_rty05 AND rtu06=l_ogb.ogb44                                                       
                 AND rtv04=l_ogb.ogb04                                                                                           
               IF NOT cl_null(l_rtu01) THEN       
                  LET l_ogb.ogb45=l_rtv12                                                                                        
               ELSE                                                                                                                    
                  LET l_ogb.ogb45=l_rtt11                                                                                        
               END IF                                                                                                                  
            END IF                                                                                                                     
         END IF                                                                                                                        
      ELSE                                                                                                                             
         LET l_ogb.ogb45=NULL                                                                                                    
      END IF            
      CALL s_fetch_price_new(g_oga.oga03,l_ogb.ogb04,l_ogb.ogb05,g_oga.oga69,
                       '2',g_oga.ogaplant,g_oga.oga23,g_oga.oga31,g_oga.oga32,
                       g_oga.oga01,l_ogb.ogb03,l_ogb.ogb917,l_ogb.ogb1004,'a')
           #RETURNING l_ogb.ogb13   #FUN-AB0061
           RETURNING l_ogb.ogb13,l_ogb.ogb37  #FUN-AB0061
      LET l_ogb.ogb46 = l_ogb.ogb45
      LET l_ogb.ogb930=s_costcenter(l_oga15)
      LET l_ogb.ogb12   = 0
      LET l_ogb.ogb14   = 0             
      LET l_ogb.ogb14t  = 0             
      LET l_ogb.ogb16   = 0             
      LET l_ogb.ogb17   = 'N'             
      LET l_ogb.ogb18   = 0             
      LET l_ogb.ogb20   = NULL             
      LET l_ogb.ogb21   = NULL             
      LET l_ogb.ogb22   = NULL             
      LET l_ogb.ogb32   = NULL             
      LET l_ogb.ogb60   = 0                
      LET l_ogb.ogb63   = 0   
      LET l_ogb.ogb64   = 0   
      LET l_ogb.ogb901  = NULL
      LET l_ogb.ogb902  = NULL           
      LET l_ogb.ogb903  = NULL           
      LET l_ogb.ogb904  = NULL           
      LET l_ogb.ogb905  = NULL           
      LET l_ogb.ogb906  = NULL           
      LET l_ogb.ogb907  = NULL           
      LET l_ogb.ogb908  = NULL           
      LET l_ogb.ogb909  = NULL           
      LET l_ogb.ogb65   = NULL           
      LET l_ogb.ogb1001 = NULL           
      LET l_ogb.ogb1002 = NULL
      LET l_ogb.ogb1005 = 1   
      LET l_ogb.ogb1007 = NULL
      LET l_ogb.ogb1008 = NULL
      LET l_ogb.ogb1009 = NULL
      LET l_ogb.ogb1010 = NULL
      LET l_ogb.ogb1011 = NULL
      LET l_ogb.ogb1003 = NULL
      LET l_ogb.ogb1006 = 100
      LET l_ogb.ogb1012 = 'N'  
      LET l_ogb.ogb1013 = 0
      LET l_ogb.ogb1014 = 'N'
      LET l_ogb.ogb42   = NULL  
      LET l_ogb.ogb43   = NULL  
      LET l_ogb.ogb931  = NULL  
      LET l_ogb.ogb932  = NULL  
      LET l_ogb.ogbud01 = NULL  
      LET l_ogb.ogbud02 = NULL  
      LET l_ogb.ogbud03 = NULL  
      LET l_ogb.ogbud04 = NULL  
      LET l_ogb.ogbud05 = NULL  
      LET l_ogb.ogbud06 = NULL  
      LET l_ogb.ogbud07 = NULL  
      LET l_ogb.ogbud08 = NULL  
      LET l_ogb.ogbud09 = NULL  
      LET l_ogb.ogbud10 = NULL  
      LET l_ogb.ogbud11 = NULL  
      LET l_ogb.ogbud12 = NULL  
      LET l_ogb.ogbud13 = NULL  
      LET l_ogb.ogbud14 = NULL  
      LET l_ogb.ogbud15 = NULL  
      LET l_ogb.ogbplant= g_plant
      LET l_ogb.ogblegal= g_legal  
      LET l_ogb.ogb47   = 0   
#     LET l_ogb.ogb48   = NULL     #FUN-B10010
#     LET l_ogb.ogb49   = NULL     #FUN-B10010
#     LET l_ogb.ogb50   = '1'      #FUN-AA0057
      
      INSERT INTO ogb_file values (l_ogb.*)		
      IF STATUS THEN
         CALL s_errmsg("",l_ogb.ogb04,"INS ogb_file",STATUS,1)   
         CONTINUE WHILE
      END IF
      LET i = i+1         #FUN-B10010
   END WHILE
   CALL s_showmsg()	
END FUNCTION
#FUN-AA0089----------Add End  ----------------------

#Add No:TQC-B30124
#零售版 脱离订单，直接生成出货单身
#通过传产料号，仓储批，数量  插入单身(无前端单据抛转型)
#可公用
#里面不做事务处理，多笔同时插入时，符合条件的直接插入，不符合条件的直接过滤，同时记录过滤原因
FUNCTION t600_b8_insogb(p_ogb04,p_ogb09,p_ogb091,p_ogb092,p_qty)
DEFINE p_ogb04     LIKE ogb_file.ogb04
DEFINE p_ogb09     LIKE ogb_file.ogb09
DEFINE p_ogb091    LIKE ogb_file.ogb091
DEFINE p_ogb092    LIKE ogb_file.ogb092
DEFINE p_qty       LIKE ogb_file.ogb12
DEFINE l_ogb       RECORD LIKE ogb_file.*
DEFINE l_ima02     LIKE ima_file.ima02
DEFINE l_ima25     LIKE ima_file.ima25
DEFINE l_ima31     LIKE ima_file.ima31
DEFINE l_ima906    LIKE ima_file.ima906
DEFINE l_ima907    LIKE ima_file.ima907
DEFINE l_ima908    LIKE ima_file.ima908
DEFINE l_rty06     LIKE rty_file.rty06
DEFINE l_rty05     LIKE rty_file.rty05
DEFINE l_rtt01     LIKE rtt_file.rtt01
DEFINE l_rtt11     LIKE rtt_file.rtt11
DEFINE l_rtu01     LIKE rtu_file.rtu01
DEFINE l_rtv12     LIKE rtv_file.rtv12
DEFINE l_ogb03     LIKE ogb_file.ogb03
DEFINE l_cnt       LIKE type_file.num5
#计算计价数量 ogb917
DEFINE l_fac2      LIKE img_file.img21     #第二轉換率
DEFINE l_qty2      LIKE img_file.img10     #第二數量
DEFINE l_fac1      LIKE img_file.img21     #第一轉換率
DEFINE l_qty1      LIKE img_file.img10     #第一數量
DEFINE l_tot       LIKE img_file.img10     #計價數量
#end
DEFINE l_ogb05     LIKE ogb_file.ogb05
DEFINE l_qty       LIKE ogb_file.ogb917

   IF cl_null(p_ogb04) THEN
      RETURN
   END IF
   INITIALIZE l_ogb.* TO NULL
   LET l_ogb.ogb01=g_oga.oga01    #出货单号
   LET l_ogb.ogb04=p_ogb04   #产品编号
   LET l_ogb.ogb09 = p_ogb09   #出货仓库编号
   LET l_ogb.ogb091= p_ogb091  #出货储位编号
   LET l_ogb.ogb092= p_ogb092  #出货批号
   IF cl_null(l_ogb.ogb09) THEN LET l_ogb.ogb09 = ' ' END IF
   IF cl_null(l_ogb.ogb091) THEN LET l_ogb.ogb091 = ' ' END IF
   IF cl_null(l_ogb.ogb092) THEN LET l_ogb.ogb092 = ' ' END IF
   LET l_ogb.ogb12=p_qty       #实际出货数量

   IF l_ogb.ogb04[1,4]!='MISC' THEN
      IF g_aza.aza50 = 'Y' THEN #流通配銷的判斷挪至此,因為以上程式段為對料件的正確性控管
         SELECT COUNT(*) INTO l_cnt FROM ima_file,tqh_file
          WHERE ima01=l_ogb.ogb04
            AND ima1006 = tqh02
            AND tqhacti ='Y'
         IF l_cnt=0 THEN
            CALL s_errmsg("",l_ogb.ogb04,"INS ogb_file",'atm-018',1)   
            RETURN
         END IF
      END IF
   END IF

   IF l_ogb.ogb04[1,4]='MISC' THEN
      SELECT COUNT(*) INTO l_cnt FROM ima_file
       WHERE ima01='MISC'
      IF l_cnt=0 THEN
         CALL s_errmsg("",l_ogb.ogb04,"INS ogb_file",'aim-806',1)
         RETURN
      END IF
   END IF

   IF NOT s_chk_item_no(l_ogb.ogb04,"") THEN
      CALL s_errmsg("",l_ogb.ogb04,"INS ogb_file",g_errno,1)
      RETURN
   END IF

   IF NOT s_chkima08(l_ogb.ogb04) THEN
      RETURN
   END IF

   SELECT imc02 INTO l_ogb.ogb07 FROM imc_file   #额外品名编号
    WHERE imc01 = l_ogb.ogb04
      AND ROWNUM = 1

   SELECT ima31,ima25,ima02,ima906,ima907,ima908
     INTO l_ima31,l_ima25,l_ima02,l_ima906,l_ima907,l_ima908
     FROM ima_file 
    WHERE ima01 = l_ogb.ogb04
   IF SQLCA.sqlcode AND l_ogb.ogb04[1,4]!='MISC' THEN  
      CALL s_errmsg("",l_ogb.ogb04,"INS ogb_file",SQLCA.sqlcode,1)   
      RETURN
   END IF
   IF cl_null(l_ima31) THEN LET l_ima31=l_ima25 END IF

   #销售单位
   LET l_ogb.ogb05 = l_ima31
   CALL s_umfchk(l_ogb.ogb04,l_ogb.ogb05,l_ima25)
      RETURNING g_cnt,g_factor
   IF g_cnt = 1 THEN
      LET g_factor = 1
   END IF
   LET l_ogb.ogb05_fac = g_factor    #销售/库存汇总单位换算率
   #库存明细单位
   SELECT img09 INTO l_ogb.ogb15 FROM img_file
    WHERE img01 = l_ogb.ogb04 AND img02 = l_ogb.ogb09
      AND img03 = l_ogb.ogb091 AND img04 = l_ogb.ogb092
   IF cl_null(l_ogb.ogb15) THEN
      LET l_ogb.ogb15  = l_ogb.ogb05
   END IF
   IF l_ogb.ogb05 = l_ogb.ogb15 THEN
       LET l_ogb.ogb15_fac =1
   ELSE
       #檢查該發料單位與主檔之單位是否可以轉換
       CALL s_umfchk(l_ogb.ogb04,l_ogb.ogb05,l_ogb.ogb15)
                 RETURNING g_cnt,l_ogb.ogb15_fac
       IF g_cnt = '1'  THEN
          CALL cl_err(l_ogb.ogb04,'abm-731',1)
          LET l_ogb.ogb15_fac=1
       END IF
   END IF
   IF cl_null(l_ogb.ogb15_fac) THEN LET l_ogb.ogb15_fac = 1 END IF
   LET l_ogb.ogb16 = l_ogb.ogb12 * l_ogb.ogb15_fac

   LET l_ogb.ogb1012 ='N'          #搭赠
   LET l_ogb.ogb1013 =0            #已开发票未税金额 
   LET l_ogb.ogb1014 ='N'          #保税已放行否
   LET l_ogb.ogb1005 ='1'          #作业方式  1-出货,2-折扣
   LET l_ogb.ogb1006=100           #折扣率
   LET l_ogb.ogb60 = 0             #已开发票数量
   LET l_ogb.ogb63 = 0             #销退数量(需换货再出货)
   LET l_ogb.ogb64 = 0             #销退数量(不需换货出货)
   LET l_ogb.ogb18 = l_ogb.ogb12   #销退数量(不需换货出货)
   LET l_ogb.ogb65=''              #验退理由码
   LET l_ogb.ogb41 = g_oga.oga46   #专案代号
   LET l_ogb.ogb930=s_costcenter(g_oga.oga15)  #成本中心
   LET l_ogb.ogbplant = g_plant 
   LET l_ogb.ogblegal = g_legal
   LET l_ogb.ogb06 = l_ima02   #品名规格

   #ogb19 检验否,客户产品编号
   SELECT COUNT(*) INTO l_cnt
     FROM obk_file
    WHERE obk01 = l_ogb.ogb04
      AND obk02 = g_oga.oga03
   IF l_cnt = 1 THEN
      SELECT obk11,obk03 INTO l_ogb.ogb19,l_ogb.ogb11
        FROM obk_file
       WHERE obk01 = l_ogb.ogb04
         AND obk02 = g_oga.oga03
   ELSE
      LET l_ogb.ogb19 = 'N'
   END IF
   LET l_ogb.ogb17='N' #多仓储批出货否

   #多单位
   IF g_sma.sma115 = 'Y' THEN  #使用双单位
      IF l_ima906 = '1' THEN   #不使用双单位
         LET l_ogb.ogb913=''        #单位二
         LET l_ogb.ogb914=''        #第二转换率
         LET l_ogb.ogb915=''        #第二数量
      ELSE
         LET l_ogb.ogb913=l_ima907  #单位二
         LET g_factor=1
         CALL s_du_umfchk(l_ogb.ogb04,'','','',l_ima31,l_ima907,l_ima906)
              RETURNING g_errno,g_factor
         IF cl_null(g_factor) THEN LET g_factor=1 END IF
         LET l_ogb.ogb914=g_factor  #第二转换率
         LET l_ogb.ogb915=0         #第二数量
         IF l_ima906='3' THEN   #参考单位
            LET l_ogb.ogb915 = l_ogb.ogb12 / l_ogb.ogb914
         END IF
      END IF
      LET l_ogb.ogb910 = l_ima31
      LET l_ogb.ogb911  = 1
      LET l_ogb.ogb912  = p_qty
   END IF

   #计价单位
   IF g_sma.sma116 MATCHES '[23]' THEN  #是否使用计价单位  0:不使用、1:采购、2:销售、3:两者
      CALL s_chk_va_setting1(l_ogb.ogb04)
           RETURNING g_flag,l_ima908
      IF g_flag=1 THEN
         RETURN
      END IF
      LET l_ogb.ogb916=l_ima908   #计价单位
   END IF
   IF cl_null(l_ogb.ogb916) THEN
      LET l_ogb.ogb916=l_ogb.ogb05
   END IF
   #ogb917计算计价数量
   LET l_fac2=l_ogb.ogb914
   LET l_qty2=l_ogb.ogb915
   IF g_sma.sma115 = 'Y' THEN
      LET l_fac1=l_ogb.ogb911
      LET l_qty1=l_ogb.ogb912
   ELSE
      LET l_fac1=1
      LET l_qty1=l_ogb.ogb12
      CALL s_umfchk(l_ogb.ogb04,l_ogb.ogb05,l_ima31)
            RETURNING g_cnt,g_factor
      IF g_cnt = 1 THEN
         LET g_factor = 1
      END IF
   END IF
   IF cl_null(l_fac1) THEN LET l_fac1=1 END IF
   IF cl_null(l_qty1) THEN LET l_qty1=0 END IF
   IF cl_null(l_fac2) THEN LET l_fac2=1 END IF
   IF cl_null(l_qty2) THEN LET l_qty2=0 END IF
   IF g_sma.sma115 = 'Y' THEN
      CASE l_ima906
         WHEN '1' LET l_tot=l_qty1*l_fac1
         WHEN '2' LET l_tot=l_qty1*l_fac1+l_qty2*l_fac2
         WHEN '3' LET l_tot=l_qty1*l_fac1
      END CASE
   ELSE  #不使用雙單位
      LET l_tot=l_qty1*l_fac1
   END IF
   IF cl_null(l_tot) THEN LET l_tot = 0 END IF
   LET g_factor = 1
   IF g_sma.sma115 = 'Y' THEN
      CALL s_umfchk(l_ogb.ogb04,l_ogb.ogb05,l_ogb.ogb916)
          RETURNING g_cnt,g_factor
   ELSE
      CALL s_umfchk(l_ogb.ogb04,l_ima31,l_ogb.ogb916)
          RETURNING g_cnt,g_factor
   END IF
   IF g_cnt = 1 THEN
      LET g_factor = 1
   END IF
   LET l_tot = l_tot * g_factor

   LET l_ogb.ogb917 = l_tot
   #end


   #ogb44,45,46,47
   SELECT rty06 INTO l_rty06 FROM rty_file
    WHERE rty01=g_plant
      AND rty02=l_ogb.ogb04 AND rtyacti="Y" 
   LET l_ogb.ogb44=l_rty06  #经营方式
   IF cl_null(l_ogb.ogb44) THEN
      LET l_ogb.ogb44='1'
   END IF
   IF l_ogb.ogb44='3' OR l_ogb.ogb44='4' THEN
      SELECT rty05 INTO l_rty05  #主供应商
        FROM rty_file
       WHERE rty01=g_plant
         AND rty02=l_ogb.ogb04
         AND rtyacti="Y"
      IF SQLCA.sqlcode THEN
         CALL s_errmsg("",l_ogb.ogb04,"SEL rty05",SQLCA.sqlcode,1)   
         RETURN
      END IF
      IF NOT cl_null(l_rty05) THEN
         SELECT rtt01,rtt11 INTO l_rtt01,l_rtt11  #协议编号,結算扣率%
           FROM rtt_file,rts_file,rto_file
          WHERE rts01 = rtt01 AND rttplant = rtsplant
            AND rts02 = rtt02 AND rtt04 =l_ogb.ogb04
      #     AND rto01 = rts04 AND rtoplant = rts9plant   #TQC-B30189 MARK
            AND rto01 = rts04 AND rtoplant = rtsplant   #TQC-B30189 ADD
            AND rto05 = l_rty05  AND rto06 = l_ogb.ogb44
            AND rto08<=g_oga.oga02
            AND rto09>=g_oga.oga02 AND rtt15="Y"
            AND rtoconf = 'Y' AND rtsconf = 'Y'
            AND rto03 = rts02 AND rtoplant =  g_plant
         IF NOT cl_null(l_rtt01) THEN
            SELECT rtv12,rtu01 INTO l_rtv12,l_rtu01  #结算扣率%,促销协议编号
              FROM rtv_file,rtu_file,rtt_file
             WHERE rtt01=rtu04 AND rtt02=rtu02
               AND rttplant=rtuplant AND rtuplant=g_plant
               AND rtuconf="Y" AND rtuplant=rtvplant
               AND rtu01=rtv01 AND rtu02=rtv02
               AND rtt01=l_rtt01 AND rtu05=l_rty05
               AND rtu06=l_ogb.ogb44
               AND rtv04=l_ogb.ogb04
            IF NOT cl_null(l_rtu01) THEN
               LET l_ogb.ogb45=l_rtv12 #原扣率
            ELSE
               LET l_ogb.ogb45=l_rtt11 #原扣率
            END IF
         END IF
      END IF
   ELSE
      LET l_ogb.ogb45=NULL        #原扣率
   END IF
   LET l_ogb.ogb46=l_ogb.ogb45    #新扣率
   LET l_ogb.ogb47=0              #分摊折价=全部折价字段值的和值

   SELECT MAX(ogb03) INTO l_ogb03  #项次 
     FROM ogb_file
    WHERE ogb01 = g_oga.oga01
   IF l_ogb03 is null THEN
      LET l_ogb.ogb03 = 1
   ELSE
      LET l_ogb.ogb03 = l_ogb03 + 1
   END IF

   #数量单价金额
   IF g_sma.sma116 MATCHES '[23]' AND NOT cl_null(l_ogb.ogb916) THEN
      LET l_ogb05=l_ogb.ogb916
   ELSE
      LET l_ogb05=l_ogb.ogb05
   END IF
   CALL s_fetch_price_new(g_oga.oga03,l_ogb.ogb04,l_ogb05,g_oga.oga69,
                          '2',g_oga.ogaplant,g_oga.oga23,g_oga.oga31,g_oga.oga32,
                          g_oga.oga01,l_ogb.ogb03,l_ogb.ogb917,
                          l_ogb.ogb1004,'a')
       RETURNING l_ogb.ogb13,l_ogb.ogb37   #原币单价,基础单价

   IF g_sma.sma116 MATCHES '[23]' THEN
      LET l_qty =l_ogb.ogb917
   ELSE
      LET l_qty =l_ogb.ogb12
   END IF
   IF l_qty IS NULL THEN
      LET l_qty = 0
   END IF
   CALL cl_digcut(l_ogb.ogb13,t_azi03)  RETURNING l_ogb.ogb13
   CALL cl_digcut(l_ogb.ogb37,t_azi03)  RETURNING l_ogb.ogb37 

   IF g_oga.oga213 = 'N'  THEN
      LET l_ogb.ogb14=t600_amount(l_qty,l_ogb.ogb13,l_ogb.ogb1006,t_azi03)
      CALL cl_digcut(l_ogb.ogb14,t_azi04)  RETURNING l_ogb.ogb14
      LET l_ogb.ogb14t=l_ogb.ogb14*(1+g_oga.oga211/100)
      CALL cl_digcut(l_ogb.ogb14t,t_azi04) RETURNING l_ogb.ogb14t 
   ELSE
      LET l_ogb.ogb14t=t600_amount(l_qty,l_ogb.ogb13,l_ogb.ogb1006,t_azi03)
      CALL cl_digcut(l_ogb.ogb14t,t_azi04) RETURNING l_ogb.ogb14t 
      LET l_ogb.ogb14=l_ogb.ogb14t/(1+g_oga.oga211/100)
      CALL cl_digcut(l_ogb.ogb14,t_azi04)  RETURNING l_ogb.ogb14 
   END IF

   IF cl_null(l_ogb.ogb13) THEN LET l_ogb.ogb13=0 END IF
   IF cl_null(l_ogb.ogb37) THEN LET l_ogb.ogb37=0 END IF
   IF cl_null(l_ogb.ogb31) THEN LET l_ogb.ogb32='' END IF
   INSERT INTO ogb_file VALUES(l_ogb.*)
   IF SQLCA.sqlcode OR SQLCA.sqlerrd[3]=0 THEN
      CALL s_errmsg("",l_ogb.ogb04,'ins ogb',SQLCA.sqlcode,1)
   END IF
END FUNCTION
#End Add No:TQC-B30124

#FUN-B30012 ---------------STA
FUNCTION  t600_chk_ogb1001_2(p_oga01)
DEFINE p_oga01   LIKE oga_file.oga01
DEFINE l_n       LIKE type_file.num5
    
   SELECT COUNT(*) INTO l_n FROM ogb_file
    WHERE ogb01 = p_oga01
      AND ogb1001 = g_oaz.oaz88
   IF l_n > 0 THEN
      RETURN FALSE
   ELSE
      RETURN TRUE
   END IF

END FUNCTION

FUNCTION  t600_chk_ogb1001_3(p_oga01)
DEFINE p_oga01   LIKE oga_file.oga01
DEFINE l_n       LIKE type_file.num5

   SELECT COUNT(*) INTO l_n FROM ogb_file
    WHERE ogb01 = p_oga01
      AND ogb1001 = g_oaz.oaz88
      AND ogb31 IS NOT NULL
      AND ogb31 <> ' '

   IF l_n > 0 THEN
      RETURN FALSE
   ELSE
      RETURN TRUE
   END IF
END FUNCTION


#FUN-B30012 ---------------END
#-----MOD-B40263---------
FUNCTION t600_ins_oao(l_flag)
   DEFINE l_flag  LIKE type_file.chr1,
          l_cnt   LIKE type_file.num5,
          l_ogb03 LIKE ogb_file.ogb03,
          l_ogb31 LIKE ogb_file.ogb31,
          l_ogb32 LIKE ogb_file.ogb32

   IF l_flag = 'a' OR l_flag = 'u' THEN
      WHILE TRUE
         LET l_cnt = 0 
         SELECT COUNT(*) INTO l_cnt FROM oao_file
           WHERE oao01 = g_oga.oga01
             AND oao03 = 0
         IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
         IF l_cnt > 0 THEN
            IF NOT cl_confirm('axm_112') THEN
               EXIT WHILE
            END IF 
         END IF 
         
         DROP TABLE x
         
         IF g_oga.oga09 MATCHES '[2468]' AND g_oga.oga01 != g_oga.oga011 THEN #No.FUN-630061
            SELECT * FROM oao_file WHERE oao01=g_oga.oga011 AND oao03 = 0 INTO TEMP x   
         ELSE
            SELECT * FROM oao_file WHERE oao01=g_oga.oga16 AND oao03 = 0 INTO TEMP x   
         END IF
         
         UPDATE x SET oao01 = g_oga.oga01
         DELETE FROM oao_file WHERE oao01 = g_oga.oga01 AND oao03 = 0 
         INSERT INTO oao_file SELECT * FROM x
         
         CALL t600_show_oao()
         EXIT WHILE
      END WHILE
   END IF
   IF l_flag = 'b' THEN 
      WHILE TRUE
         LET l_cnt = 0
         SELECT COUNT(*) INTO l_cnt FROM oao_file
           WHERE oao01 = g_oga.oga01
             AND oao03 = g_ogb[l_ac].ogb03
         IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
         IF l_cnt > 0 THEN
            IF NOT cl_confirm('axm_113') THEN
               EXIT WHILE
            END IF
         END IF
         DROP TABLE x
         SELECT * FROM oao_file
          WHERE oao01=g_ogb[l_ac].ogb31
            AND oao03=g_ogb[l_ac].ogb32
           INTO TEMP x
         UPDATE x SET oao01 = g_oga.oga01,
                      oao03 = g_ogb[l_ac].ogb03
         DELETE FROM oao_file WHERE oao01 = g_oga.oga01 AND oao03 = g_ogb[l_ac].ogb03
         INSERT INTO oao_file SELECT * FROM x
         EXIT WHILE
      END WHILE
   END IF
   IF l_flag = 'o' THEN
      DECLARE t600_ogb31_ogb32 
        CURSOR FOR SELECT ogb03,ogb31,ogb32 FROM ogb_file  
                     WHERE ogb01 = g_oga.oga01
      FOREACH t600_ogb31_ogb32 INTO l_ogb03,l_ogb31,l_ogb32
         DROP TABLE x
         SELECT * FROM oao_file
          WHERE oao01=l_ogb31
            AND oao03=l_ogb32
           INTO TEMP x
         UPDATE x SET oao01 = g_oga.oga01,
                      oao03 = l_ogb03
         DELETE FROM oao_file WHERE oao01 = g_oga.oga01 AND oao03 = l_ogb03
         INSERT INTO oao_file SELECT * FROM x
      END FOREACH
   END IF
END FUNCTION 
#FUN-AC0074 ---------------Begin---------------------
FUNCTION t600_move_to()
   DEFINE l_ohb14    LIKE ohb_file.ohb14  
   DEFINE l_ohb14t   LIKE ohb_file.ohb14t
   DEFINE l_rxc      RECORD LIKE rxc_file.* 
   DEFINE l_msg      STRING
   DEFINE l_imaicd04 LIKE imaicd_file.imaicd04 
   DEFINE l_cnt      LIKE type_file.num5
   LET g_success = 'Y'
   SELECT MAX(ogb03) INTO b_ogb.ogb03 FROM ogb_file
    WHERE ogb31 = g_oeb.oeb01
      AND ogb01 = g_oga.oga01
   IF cl_null(b_ogb.ogb03) THEN
      LET b_ogb.ogb03 = 0
   END IF
   LET b_ogb.ogb03 = b_ogb.ogb03 + 1
   LET b_ogb.ogb910= g_oeb.oeb910
   LET b_ogb.ogb911= g_oeb.oeb911
   LET b_ogb.ogb913= g_oeb.oeb913
   LET b_ogb.ogb914= g_oeb.oeb914
   LET b_ogb.ogb916= g_oeb.oeb916
   LET b_ogb.ogb19 = g_oeb.oeb906 
   IF cl_null(b_ogb.ogb19) THEN
      LET b_ogb.ogb19 = 'N'
   END IF       
   #单位换算   
   LET b_ogb.ogb05_fac= g_oeb.oeb05_fac
   LET b_ogb.ogb06 = g_oeb.oeb06
   LET b_ogb.ogb07 = g_oeb.oeb07
   LET b_ogb.ogb08 = g_oeb.oeb08
   LET b_ogb.ogb15_fac = g_oeb.oeb05_fac
   LET b_ogb.ogb17 = 'N'     
   IF b_ogb.ogb09  IS NULL THEN LET b_ogb.ogb09  = ' ' END IF
   IF b_ogb.ogb091 IS NULL THEN LET b_ogb.ogb091 = ' ' END IF
   IF b_ogb.ogb092 IS NULL THEN LET b_ogb.ogb092 = ' ' END IF
   
   LET b_ogb.ogb11 = g_oeb.oeb11
   LET b_ogb.ogb18 = b_ogb.ogb12
   LET b_ogb.ogb13 = g_oeb.oeb13
   LET b_ogb.ogb37 = g_oeb.oeb37  
   LET b_ogb.ogb908= g_oeb.oeb908 
   LET b_ogb.ogb930= g_oeb.oeb930 
   LET b_ogb.ogb44 = g_oeb.oeb44
   LET b_ogb.ogbplant = g_oeb.oebplant
   LET b_ogb.ogblegal = g_oeb.oeblegal
   LET b_ogb.ogb45 = g_oeb.oeb45
   LET b_ogb.ogb46 = g_oeb.oeb46                                                                                              
   LET b_ogb.ogb47 = g_oeb.oeb47
      SELECT SUM(ogb14)
        INTO b_ogb.ogb14
        FROM ogb_file,oga_file
       WHERE ogb31 =g_oeb.oeb01
         AND ogb32 =g_oeb.oeb03
         AND ogb1005 =g_oeb.oeb1003
         AND ogb01 =oga01
         AND ogapost ='Y'
         AND ogaconf != 'X' 
      SELECT SUM(ohb14)
        INTO l_ohb14
        FROM ohb_file,oha_file
       WHERE ohb33 =g_oeb.oeb01
         AND ohb34 =g_oeb.oeb03
         AND ohb01 =oha01
         AND ohapost ='Y'
      IF cl_null(l_ohb14) THEN
         LET l_ohb14 = 0
      END IF
      IF cl_null(b_ogb.ogb14) THEN
         LET b_ogb.ogb14 = 0
      END IF
      LET b_ogb.ogb14 =g_oeb.oeb14 - b_ogb.ogb14 + l_ohb14

      SELECT SUM(ogb14t)
        INTO b_ogb.ogb14t
        FROM ogb_file,oga_file 
       WHERE ogb31 =g_oeb.oeb01
         AND ogb32 =g_oeb.oeb03
         AND ogb1005 =g_oeb.oeb1003
         AND ogb01 =oga01
         AND ogapost ='Y'
         AND ogaconf != 'X' 
      SELECT SUM(ohb14t)
        INTO l_ohb14t
        FROM ohb_file,oha_file
       WHERE ohb33 =g_oeb.oeb01
         AND ohb34 =g_oeb.oeb03
         AND ohb01 =oha01
         AND ohapost ='Y'
      IF cl_null(l_ohb14t) THEN
         LET l_ohb14t = 0
      END IF
      IF cl_null(b_ogb.ogb14t) THEN
         LET b_ogb.ogb14t = 0
      END IF
   LET b_ogb.ogb14t =g_oeb.oeb14t - b_ogb.ogb14t + l_ohb14t  
   LET b_ogb.ogb41 = g_oeb.oeb41
   LET b_ogb.ogb42 = g_oeb.oeb42
   LET b_ogb.ogb43 = g_oeb.oeb43

   LET b_ogb.ogb1001= g_oeb.oeb1001    
   LET b_ogb.ogb1012= g_oeb.oeb1012    
   LET b_ogb.ogb1002= g_oeb.oeb1002    
   LET b_ogb.ogb1003= g_oeb.oeb15      
   LET b_ogb.ogb1004= g_oeb.oeb1004    
   LET b_ogb.ogb1005= g_oeb.oeb1003    
   LET b_ogb.ogb1006= g_oeb.oeb1006    
   LET b_ogb.ogb1007= g_oeb.oeb1007    
   LET b_ogb.ogb1008= g_oeb.oeb1008    
   LET b_ogb.ogb1009= g_oeb.oeb1009    
   LET b_ogb.ogb1010= g_oeb.oeb1010    
   LET b_ogb.ogb1014 = 'N'  
   LET b_ogb.ogb1013 = 0    


   LET b_ogb.ogb48 = g_oeb.oeb49
   LET b_ogb.ogb49 = g_oeb.oeb50


   CALL t600_b_else()

   LET g_msg=b_ogb.ogb03,' ',b_ogb.ogb04,' ',b_ogb.ogb12
   
   CALL cl_msg(g_msg)

   IF cl_null(b_ogb.ogb05_fac) THEN
      LET b_ogb.ogb05_fac = 1
   END IF
   IF cl_null(b_ogb.ogb12) THEN
      LET b_ogb.ogb12 = 0
   END IF
                      
   IF cl_null(b_ogb.ogb37) THEN
      LET b_ogb.ogb37 = 0
   END IF                                                                             
    
   IF cl_null(b_ogb.ogb13) THEN
      LET b_ogb.ogb13 = 0
   END IF
   IF cl_null(b_ogb.ogb14) THEN
      LET b_ogb.ogb14 = 0
   END IF
   IF cl_null(b_ogb.ogb14t) THEN
      LET b_ogb.ogb14t = 0
   END IF
   IF cl_null(b_ogb.ogb15_fac) THEN
      LET b_ogb.ogb15_fac = 1
   END IF
   IF cl_null(b_ogb.ogb16) THEN
      LET b_ogb.ogb16 = 0
   END IF
   IF cl_null(b_ogb.ogb18) THEN
      LET b_ogb.ogb18 = 0
   END IF
   IF cl_null(b_ogb.ogb60) THEN
      LET b_ogb.ogb60 = 0
   END IF
   IF cl_null(b_ogb.ogb63) THEN
      LET b_ogb.ogb63 = 0
   END IF
   IF cl_null(b_ogb.ogb64) THEN
      LET b_ogb.ogb64 = 0
   END IF
   IF cl_null(b_ogb.ogb1006) THEN
      LET b_ogb.ogb1006 = 100
   END IF
   
   IF g_azw.azw04 = '2' THEN
      SELECT rtz07 INTO b_ogb.ogb09 FROM rtz_file WHERE rtz01 = g_oga.ogaplant
      IF b_ogb.ogb09 IS NULL THEN
         LET g_success = 'N' 
         RETURN
      ELSE
        IF s_internal_item( b_ogb.ogb04,g_plant ) AND  (NOT s_joint_venture( b_ogb.ogb04,g_plant)) THEN    
          SELECT COUNT(*) INTO g_cnt FROM img_file 
           WHERE img01 = b_ogb.ogb04 AND img02 = b_ogb.ogb09
          IF g_cnt IS NULL THEN LET g_cnt = 0 END IF
          IF g_cnt = 0 THEN
             LET l_msg ="(",b_ogb.ogb04 CLIPPED,"-",
                            b_ogb.ogb09 CLIPPED,")"
             IF g_sma.sma892[3,3] ='Y' THEN
                IF NOT cl_confirm('mfg1401') THEN RETURN END IF
             END IF
             CALL s_add_img(b_ogb.ogb04,b_ogb.ogb09,' ',' ',b_ogb.ogb01,
                           b_ogb.ogb03,g_oga.oga02)
          END IF                            
        END IF                             
      END IF
   END IF

   LET b_ogb.ogbplant = g_plant 
   LET b_ogb.ogblegal = g_legal  
   LET b_ogb.ogb47 = (b_ogb.ogb917/g_oeb.oeb917)*g_oeb.oeb47
   LET l_rxc.rxc00 = '02'
   LET l_rxc.rxc01 = b_ogb.ogb01
   LET l_rxc.rxc02 = b_ogb.ogb03
   LET l_rxc.rxcplant = b_ogb.ogbplant
   LET l_rxc.rxclegal = b_ogb.ogblegal
   DECLARE cur_rxc01_cs CURSOR FOR 
      SELECT rxc03,rxc04,rxc05,rxc06,rxc07,rxc08,rxc09,rxc10,rxc11,rxc15 
       FROM rxc_file WHERE rxc00 = '01' 
        AND rxc01 = g_oeb.oeb01 AND rxc02 = g_oeb.oeb03
   FOREACH cur_rxc01_cs INTO l_rxc.rxc03,l_rxc.rxc04,l_rxc.rxc05,l_rxc.rxc06,
                          l_rxc.rxc07,l_rxc.rxc08,l_rxc.rxc09,l_rxc.rxc10,
                          l_rxc.rxc11,l_rxc.rxc15       #FUN-AB0061
       LET l_rxc.rxc06 = l_rxc.rxc06*(b_ogb.ogb917/g_oeb.oeb917)
       IF l_rxc.rxc06 IS NULL THEN LET l_rxc.rxc06 = 0 END IF
       IF l_rxc.rxc09 IS NULL THEN LET l_rxc.rxc09 = 0 END IF
       IF l_rxc.rxc11 IS NULL THEN LET l_rxc.rxc11 = 'N' END IF
       INSERT INTO rxc_file(rxc00,rxc01,rxc02,rxc03,rxc04,rxc05,rxc06,
                             rxc07,rxc08,rxc09,rxc10,rxc11,rxcplant,rxclegal,rxc15)  
                      VALUES(l_rxc.rxc00,l_rxc.rxc01,l_rxc.rxc02,l_rxc.rxc03,
                             l_rxc.rxc04,l_rxc.rxc05,l_rxc.rxc06,l_rxc.rxc07,
                             l_rxc.rxc08,l_rxc.rxc09,l_rxc.rxc10,l_rxc.rxc11,
                             l_rxc.rxcplant,l_rxc.rxclegal,l_rxc.rxc15)  
   END FOREACH
   SELECT SUM(rxc06) INTO b_ogb.ogb47 FROM rxc_file
       WHERE rxc00 = '02' AND rxc01 = b_ogb.ogb01 AND rxc02 = b_ogb.ogb03
   IF b_ogb.ogb47 IS NULL THEN LET b_ogb.ogb47 = 0 END IF
END FUNCTION         
#FUN-AC0074 ---------------End-----------------------         
#-----END MOD-B40263-----
