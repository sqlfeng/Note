#該程式已解開Section, 不再透過樣板產出!
{<section id="asft300.description" >}
#應用 a00 樣板自動產生(Version:3)
#+ Standard Version.....: SD版次:0119(2017-02-21 16:54:51), PR版次:0119(2017-03-31 18:31:13)
#+ Customerized Version.: SD版次:0000(1900-01-01 00:00:00), PR版次:0000(1900-01-01 00:00:00)
#+ Build......: 000855
#+ Filename...: asft300
#+ Description: 工單維護作業
#+ Creator....: 01258(2013-11-15 14:38:20)
#+ Modifier...: 05795 -SD/PR- 07423
 
{</section>}
 
{<section id="asft300.global" >}
#應用 i00 樣板自動產生(Version:10)
#add-point:填寫註解說明 name="global.memo"
#150717  By wuxj   1.提高效能     2.删除单据时，单头单身备注一并删除
#150723  By wuxj   重算QPA分子分母调整（整数时约分，小数时直接给值，防止数值过大）
#150730  By wuxj   增加拆件工单料件明细产生按钮及相应功能  
#151110-00030#1   2015/11/11  By Shiun      'ON ACTION unconf'少了權限控管
#151117-00019#3   2015/11/18  BY Dorislai   回追產中:回寫獨立需求的問題，調整備料刪除後可修改單頭的來源單號及數量等欄位，回寫獨立需求單錯誤的問題
#151209-00006#1   2015/12/09  By Sarah 
#151224-00025#4   2015/12/28  By yihsuan    手動輸入特徵碼同步新增inam_t[料件產品特徵明細檔]
#151207-00017#2   2016/01/04  By Shiun      新增工單源為7.MPS計劃 處理事項
#160122-00003#1   2016/01/27  By whitney    b_fill效能調整
#160214-00005#3   2016/02/26  By dorislai   若來源為訂單，sfaa011欄位預設帶訂單BOM特性
#                                           若來源為多訂單，“工單來源”頁簽錄入時，要控管來源訂單上的料號+BOM特性相同
#160129-00002#9   2016/03/04  By Jessica    當工單手動發出時,需通知MES 
#160204-00011#1   2016/03/08  By xianghui   工单来源页签中的工单来源调整5.RMA判别单
#160303-00019#1   2016/03/28  By Sarah      FUNCTION asft300_statechange()中的ON ACTION confirmed裡的transaction寫的很亂,整理一下
#160314-00009#16  2016/03/28  By xujing     产品特征自动开窗增加参数判断
#160323-00004#1   2016/04/01  By fionchen   修改asft300_default_search(),將g_argv[02]傳入參數搬到g_argv[01]後
#160119-00004#1   2016/04/06  By Sarah      計算有沒有超過剩餘可生產數量應該要再加上生產損耗率
#160407-00017#1   2016/04/07  By Sarah      1.備料單身新增料號無法修改QPA 2.新增單身後按向上/下鍵移動到其他筆會出現"資料將有變動，但存在資料異常的風險"警告訊息
#160318-00025#4   2016/04/12  By 07675      將重複內容的錯誤訊息置換為公用錯誤訊息(r.v）
#160107-00010#1   2016/05/13  By Sarah      重工委外工單有走製程，當製程站有多筆時，透過工單上的"委外採購"產生的委外採購單數量會倍增
#160512-00016#14  2016/05/26  By ming       1.sfac002='1'的資料是系統產生的，產生的時候應寫入sfaa072的值，當sfaa_t修改的時候，也把sfaa072的值更新到sfac007
#160126-00020#1   2016/05/30  By dorislai   修正管理庫存特徵控管(aimm212)
#160608-00002#1   2016/06/08  By ming       在工單來源非「2.MULTI」時，「工單來源」的頁面不會有任何資料
#                                           但是進入該頁面時，會直接進入after input，直接使用來源資料推算生產數量
#                                           導致生產數量被回寫為null 
#160623-00009#1   2016/06/27  By dorislai   手動輸入備料時，不允許輸入料件類型imaa004為X.虛擬件的料件編號
#160607-00028#1   2016/06/29  By ming       1.修正asft300_upd_psab006與asft300_upd_psad006未做來源類型的判斷，所以多來源時會重覆計算 
#                                           2.刪除單據或對工單來源有異動時，都應該更新來源數量
#160601-00001#1   2016/06/29  By ming       當工單來源為2.訂單時，工單的保稅否欄位sfaa072由訂單帶出 xmdc021 
#160705-00011#1   2016/07/07  By catmoon    備料設為必須有批號時，控卡批號(sfba029)為必要輸入，而非庫存特徵管理欄位(sfba030)
#160519-00022#17  2016/07/21  By Polly      依料號設定控卡批號欄位開放，庫存管理特徵、批號可至發料時才去控卡是否必輸，故此拿掉此控卡
#160708-00013#1   2016/07/22  By Sarah      維護備料單身經過發料料號會錯誤adz-00024(SQL有錯,多組了bmea008條件)
#160308-00010#26  2016/07/28  By Jessica    修正 R已拒絕 或 D抽單，按作廢沒反應
#160519-00008#17  2016/07/29  By 02097      单据上库存管理特征栏位依依料件设定控管
#160719-00004#1   2016/08/07  By Sarah      set_entry段請把單據別中所有可能可以設定為不可修改的欄位打開(新增單據時應該要先將被關掉的欄位通通打開)
#160808-00029#1   2016/08/11  By Ann_Huang  修正7:MPS計畫預帶的完工日期
#160812-00017#5   2016/08/15  By 06137      在satatchange( )的FUNCTION中，有RETURN指令但沒有加上transaction_end( ) 造成transaction沒有結束就直接RETURN
#160729-00016#1   2016/08/19  By Sarah      工單複製改成跟修改一樣的控制方式:若單身已有備料，單頭的生產料號、生產數量、來源單號、來源項次欄位不可修改，同時原單據的工單來源資料要清空
#160701-00010#1   2016/08/22  By Sarah      拆件工單如果生產料號有輸入產品特徵，要將產品特徵自動帶入到單身產品特徵欄位
#160727-00025#1   2016/08/28  By lixiang    模具生產功能開發asft304
#160818-00017#36  2016/08/28  By lixh       单据类作业修改，删除时需重新检查状态
#160910-00001#1   2016/09/10  By Sarah      製程委外的工單類型sfaa057是1廠內,工單委外才是2委外
#160707-00044#1   2016/09/13  By Sarah      當D-MFG-0038(工單下階備料產生時機)設定為3人為決定時,會在工單確認後才產生備料
#160920-00028#1   2016/09/21  By Sarah      修正160910-00001#1,應判斷製程委外且工單類型='1' 或者 工單類型='2' 的資料都可以拋轉委外採購單
#160907-00038#1   2016/09/22  By Sarah      作廢狀態的單據不小心按到狀態按鈕後,所有按鈕的灰掉了,但應該要只是沒任何動作才對
#160906-00033#1   2016/10/03  By Whitney    单身替代建议码为不可取替代时，替代率不可修改
#160926-00034#1   2016/10/04  By ywtsai     於單身BEFORE INSERT時，要依照單據設定帶出倒扣料預設值
#160720-00016#1   2016/10/11  By Mandy      透過asfp301會考慮補給策略,當asft300工單來源為'2:訂單'時,也需考慮
#161011-00039#1   2016/10/12  By Mandy      asft300首先，先以正常流程建立工單，建立完成後刪除備料檔，修改生產數量，修改生產數量後生產料號明細的預計產出量不會跟著變動
#161012-00041#1   2016/10/13  By Whitney    將規格page6特徵(sfad_t)和page7計畫完工日期(sfae_t)相關邏輯移除
#161012-00024#1   2016/10/14  By wuxja      订单转工单应扣除结案的，且增加留置的也可以转工单
#160921-00022#1   2016/10/19  By dorislai   輸入完料件或新增時輸入完來源單號後帶出料件 1.預帶aimm215的預設成本中心(imae035)到工單的成本中心(sfaa068)
#                                                                                  2.預帶aimm215的領發料機制(imae014)到工單的發料制度(sfaa004)
#161013-00051#1   2016/10/18  By shiun      整批調整據點組織開窗
#161027-00011#1   2016/10/28  By wuxja      根据料号预设bom特性栏位
#161102-00012#1   2016/11/02  By Sarah      續160719-00004,將"製程否"以及相關資訊頁籤裡的"進度資訊"這些欄位調整為Noentry
#161103-00018#1   2016/11/03  By dorishsu   AFTER FIELD sfaadocno,應清空製程否及製程編號,一律由aooi200預設
#161109-00085#27  2016/11/11  By lienjunqi  整批調整系統星號寫法
#161116-00048#1   2016/11/17  By 00768      修改单别预设控制：
#                                           1.如果工单单别有预设为委外工单，又预设为工艺工单，提示错误，检查aooi200的单别预设设置
#                                           2.如果工单单别有预设为委外工单，没预设工艺工单，则控制工艺栏位必须为N，且不可输入
#                                           3.如果工单单别有预设为工艺工单，没预设委外工单，则控制工单类型必须为1.厂内，且不可输入  
#161110-00005#1   2016/11/24  By catmoon47  161109-00085調整不完全，導致欄位查詢出來後承接值錯誤
#161128-00010#1   2016/11/28  By liqma      APS生成的工单，在asft300更改时，若工单来源为3.计划时，来源单号项次为空时报错，应该是不报错的
#161124-00021#1   2016/11/30  By liuym      返工工单单身备料不做管控
#161206-00018#1   2016/11/30  By liuym      工单新增或者修改后，会出现页签无法切换的问题，目前解法是：规格单头folder内每个page增加actong--change_page,ui_dialog内加ON ACTION change_page,
#161205-00018#1   2016/11/30  By liuym      管控库存管理特征栏位必要性属性的逻辑放在了发料料号栏位检查，现在在BOM后面也增加检查
#161209-00026#1   2016/12/09  By liuym      委外工单部门供应商栏位依照料件aimm214设定主要供应商设定默认值
#161212-00052#1   2016/12/12  By liuym      委外工单部门供应商加据点限制，当前据点只能选择同居点下的供应商编号
#161109-00085#66  2016/12/13  By 08171      整批調整系統星號寫法
#161209-00038#3   2016/12/19  By Whitney    當abmm213有限定元件產品特徵時，在輸入單身的產品特徵不能與限定的產品特徵不同
#161219-00070#2   2016/12/21  By shiun      當訂單(預先訂單)已轉工單，則該訂單(預先訂單)對應的預先訂單(訂單)則不可再轉工單
#161219-00007#1   2016/12/22  By charles4m  asft300_ins_sfac() 加上 abmm200、abmm210 生失效日期過濾展出的資料
#161213-00010#1   2016/12/22  By liuym      备料为主要材料时，标准应发量栏位不可修改 
#161222-00007#1   2016/12/23  By shiun      檢查訂單(預先訂單)是否已產生工單排除已作廢工單
#FUN-pagetest     2016/12/14  By            進入_ui_dialog()跳到指定的page
#161226-00053#1   2016/12/28  By 00768      g_ooef016变量未赋值导致报“目的币别为空”的错误
#161228-00049#1   2016/12/29  By 00768      修正点击二次筛选当掉的问题
#161228-00036#1   2016/12/29  By dujuan     工单转采购送货地址没值
#161229-00014#1   2016/12/29  By dujuan     委外採購作業(apmt501)該料件有分採購單位(PNL)和計價單位(KG)，但轉出的委外採購單計價單位為PNL錯誤，
#170103-00054#1   2017/01/04  By Whitney    修正161208-00022
#170106-00030#1   2017/01/10  By shiun      將D-MFG-0040:工單確認後自動發放處理段mark掉
#170110-00024#1   2017/01/10  By ouhz       调整点击维护相关文件按钮报错问题
#161226-00033#1   2017/01/11  By shiun      若變更生產數量時已產生的製程資料需同步更新
#161227-00044#1   2017/01/12  By shiun      委外工單供應商需必輸
#170103-00023#1   2017/01/12  By shiun      若工單來源為6.獨立需求單且輸入的需求單號+項次對應的資料有BOM特性(psab012)，則需將其帶到sfaa011，及取得料號帶出保稅否
#161128-00045#1   2017/01/12  By shiun      更改q_xmdddocno開窗條件及程式內xmdastus改為IN ('Y','H')
#161123-00040#1   2017/01/13  By shiun      若料件預設製成編號不存在aecm200則不給到sfaa016預設上
#161221-00064#22  2017/01/10  By zhujing    增加pmao000(1-采购，2-销售),用于区分axmi120和apmi120数据显示
#160908-00025#1   2017/01/16  By shiun      单身新增和修改备料时，判断发料料号+部位+作业编号+作业序是否已存在于当前工单单身，如有，提示异常
#160905-00025#1   2017/01/16  By shiun      查询状态下，参考客户栏位开窗显示的是交易对象相关名称，“交易对象”字样，请调整为“客户”，將q_pmaa001_6改為q_pmaa001_29(更改欄位名稱用)
#170113-00037#1   2017/01/16  By 00768      “生产料号明细”页签类型为1的，控制不可以修改料号
#161228-00073#1   2017/01/18  By shiun      修改工单单头的生产数量sfaa012时，同步更新到“生产料号明细”的预计产量sfac003
#170112-00001#1   2017/01/24  By fionchen   增加指定批號開窗,開窗顯示該料號於指定庫儲下未失效有庫存之批號內容
#170106-00011#1   2017/02/07  By 00768      修正6:独立需求单預帶的完工日期要抓apst300上的需求日  
#170202-00008#1   2017/02/08  By 06694      AFTER FIELD sfba024 改用 g_sfba_d_o 新舊值並記得更新舊值變數。
#170118-00063#1   2017/02/13  By fionchen   修改工单单头的生产料號sfaa010时，同步更新到“生产料号明细”的料件內容
#170208-00006#1   2017/02/14  By Whitney    複製時單別預設不應該把原本的委外調整為廠內
#170213-00064#1   2017/02/14  By dujuan     asft300在维护BOM版本后，保存时会提示“BOM版本不存在bmfa012或bmfp007”，但从系统后台查询是有的。
#170207-00040#1   2017/02/15  By catmoon    若單別未設定部門供應商(sfaa017)才依料號填入預設值。
#161216-00029#10  2017/01/23  By xujing     主件料号栏位after field增加控管：不可输入已失效的bom料号（prog=abmt300时，判断集团bom状态；prog=abmt310时，判断据点bom状态）
#170215-00015#1   2017/02/17  By dujuan     abmt310变更的版本后。asft300的工单单据页签bom版本选择。带出相应的备料明细,
#                                           如果维护的版本，在ecn新版本中找不到，就把它当成第一张ecn的旧版本，抓第一张ecn的生效日期前一秒带入到bom有效期那个栏位
#161031-00025#17  2017/02/19  By 08992      1.將aooi360_01以嵌入的方式，用頁籤放在asft300單頭多帳期頁籤與異動資訊頁籤中間
#                                             要可修改
#                                             控制類型 =3:內部資訊傳遞 取消不要了
#                                           項次固定寫入0
#                                           2.原asft300的備註action，改為確認後可執行，直接修改單頭新的"備註"頁籤
#                                           3.asft300單身最後面增加顯示"長備註"欄位，一樣抓取aooi360的備註顯示
#                                             項次 = 單身項次
#                                             控制類型 = 列印在後
#170124-00005#1   2017/02/22  By shiun      工單查詢的時候，來源單號的項次+項序+分批序、參考單號的項次+項序+分批序那欄，就用項次做為查詢條件，
#170223-00044#1   2017/02/24  By shiun      参数设定：D-MFG-0040=Y，工单审核后自动发放，审核后，没有自动更新状态为发放状态
#170225-00003#1   2017/03/06  By Whitney    調整生產料號欄位開窗與校驗
#170226-00002#1   2017/03/07  By Whitney    單別設定參數D-MFG-0076要預帶庫位至備料明細中的庫位
#170227-00016#1   2017/03/07  BY dujuan     选择日期后会报：Non-numeric character in datetime or interval
#170221-00039#1   2017/03/07  BY dujuan     销售订单TES-XM71-170200009，有维护项目号。在开工单时，勾稽了该订单，没有带出项目号
#170301-00016#1   2017/03/07  By fionchen   調整當選擇委外時,會將單據預設的部門供應商資料清空問題
#170307-00052#1   2017/03/10  By fionchen   當工單已結案時,不可執行刪除備料
#170308-00049#1   2017/03/15  By catmoon47  工單有備置(sfba_t)資料時，需更動工單備置(sfaa043)的資訊
#170309-00002#1   2017/03/17  By catmoon47  多訂單來源時，一樣需帶入產品特徵
#170317-00049#2   2017/03/20  By fionchen   BOM版本應先抓據點ECN,若抓不到再抓集團ECN
#170307-00050#1   2017/03/21  By fionchen   調整只有已發出的工單才可轉委外工單
#170310-00012#1   2017/03/21  By fionchen   執行刪除備料與產生備料時,畫面的sfaa039[備料已產生]並未即時顯示正確狀態
#170320-00031#1   2017/03/22  By Whitney    不管工單類型生產料號要根據參數檢查是否存在bom
#170310-00015#1   2017/03/22  By fionchen   調整單身直接輸入BOM料號時,不會檢核不同项次不可以有同样的部位+作业编号+作业序+BOM料号問題
#170313-00007#1   2017/03/22  By fionchen   調整若工單單別"工单下阶备料生成时机"設定為"發放時產生"時,工單發放後畫面沒有即時顯示備料明細資料問題
#170322-00078#1   2017/03/22  By fionchen   新增工單時,保税否栏位需给預設值,若保稅資料無設定時,要給預設值
#170323-00028#1   2017/03/23  By fionchen   調整異動資訊欄位顯示錯誤的問題
#170320-00006#1   2017/03/23  By fionchen   調整多訂單來源產生後,點選[提交],工單畫面會無資料問題
#170317-00042#1   2017/03/24  By fionchen   調整於工單輸入中,可執行[多訂單產生]action
#170329-00013#1   2017/03/29  By fionchen   單身的SET替代套數不可輸入
#170325-00098#1   2017/03/30  By fionchen   增加控卡若製程工單委外制程是二個以上(包含二個)的委外廠商，出現訊息提示請由asfp400產生委外採購單
#160701-00010#1   2017/03/30  By fionchen   拆件式工單生產料號若有輸入產品特徵,需將產品特徵帶到備料單身明細
#170330-00008#1   2017/03/31  By fionchen   單身替代率不允許輸入
#end add-point
#add-point:填寫註解說明(客製用) name="global.memo_customerization"

#end add-point
 
IMPORT os
IMPORT FGL lib_cl_dlg
#add-point:增加匯入項目 name="global.import"
IMPORT util
IMPORT FGL aoo_aooi360_01   #161031-00025#17
#end add-point
 
SCHEMA ds
 
GLOBALS "../../cfg/top_global.inc"
 
#add-point:free_style模組變數(Module Variable) name="free_style.variable"
{<Module define>}

#單頭 type 宣告
 type type_g_sfaa_m        RECORD
    sfaadocno      LIKE sfaa_t.sfaadocno,
    sfaa001        LIKE sfaa_t.sfaa001,
    oobal004       LIKE type_t.chr80,
    sfaadocdt      LIKE sfaa_t.sfaadocdt,
    sfaa002        LIKE sfaa_t.sfaa002,
    sfaa002_desc   LIKE type_t.chr80,
    sfaa003        LIKE sfaa_t.sfaa003,
    sfaa057        LIKE sfaa_t.sfaa057,
    sfaa004        LIKE sfaa_t.sfaa004,
    sfaastus       LIKE sfaa_t.sfaastus,
    sfaa005        LIKE sfaa_t.sfaa005,
    sfaa007        LIKE sfaa_t.sfaa007,
    sfaa008        LIKE sfaa_t.sfaa008,
    sfaa063        LIKE sfaa_t.sfaa063,
    sfaa006        LIKE sfaa_t.sfaa006,
    l_sfaa007      STRING,
    sfaa009        LIKE sfaa_t.sfaa009,
    sfaa009_desc   LIKE type_t.chr80,
    sfaa022        LIKE sfaa_t.sfaa022,
    l_sfaa023      STRING,
    sfaa021        LIKE sfaa_t.sfaa021,
    sfaa023        LIKE sfaa_t.sfaa023,
    sfaa024        LIKE sfaa_t.sfaa024,
    sfaa064        LIKE sfaa_t.sfaa064,
    sfaa025        LIKE sfaa_t.sfaa025,
    sfaa010        LIKE sfaa_t.sfaa010,
    sfaa011        LIKE sfaa_t.sfaa011,
    sfaa010_desc   LIKE type_t.chr80,
    sfaa010_desc1  LIKE type_t.chr80,
    sfaa012        LIKE sfaa_t.sfaa012,
    sfaa013        LIKE sfaa_t.sfaa013,
    sfaa013_desc   LIKE type_t.chr80,
    sfaa058        LIKE sfaa_t.sfaa058,
    sfaa060        LIKE sfaa_t.sfaa060,
    sfaa060_desc   LIKE type_t.chr80,
    sfaa061        LIKE sfaa_t.sfaa061,
    sfaa016        LIKE sfaa_t.sfaa016,
    sfaa016_desc   LIKE type_t.chr80,
    sfaa017        LIKE sfaa_t.sfaa017,
    sfaa017_desc   LIKE type_t.chr80,
    sfaa018        LIKE sfaa_t.sfaa018,
    sfaa018_desc   LIKE type_t.chr80,
    sfaa019        LIKE sfaa_t.sfaa019,
    sfaa020        LIKE sfaa_t.sfaa020,
    sfaa068        LIKE sfaa_t.sfaa068,
    sfaa068_desc   LIKE type_t.chr80,
    sfaa014        LIKE sfaa_t.sfaa014,
    #sfaa015        DATETIME YEAR TO SECOND,#170227-00016#1---mark 
    sfaa015        LIKE sfaa_t.sfaa015, #170227-00016#1---add
    sfaa026        LIKE sfaa_t.sfaa026,
    imae020        LIKE imae_t.imae020,
    sfaa062        LIKE sfaa_t.sfaa062,
    sfaa028        LIKE sfaa_t.sfaa028,
    sfaa028_desc   LIKE type_t.chr80,
    sfaa029        LIKE sfaa_t.sfaa029,
    sfaa029_desc   LIKE type_t.chr80,
    sfaa030        LIKE sfaa_t.sfaa030,
    sfaa030_desc   LIKE type_t.chr80,
    sfaa031        LIKE sfaa_t.sfaa031,
    sfaa031_desc   LIKE type_t.chr80,
    sfaa032        LIKE sfaa_t.sfaa032,
    sfaa033        LIKE sfaa_t.sfaa033,
    sfaa034        LIKE sfaa_t.sfaa034,
    sfaa034_desc   LIKE type_t.chr80,
    sfaa035        LIKE sfaa_t.sfaa035,
    sfaa035_desc   LIKE type_t.chr80,
    sfaa059        LIKE sfaa_t.sfaa059,
    sfaa036        LIKE sfaa_t.sfaa036,
    sfaa037        LIKE sfaa_t.sfaa037,
    sfaa038        LIKE sfaa_t.sfaa038,
    sfaa072        LIKE sfaa_t.sfaa072,
    sfaa039        LIKE sfaa_t.sfaa039,
    sfaa040        LIKE sfaa_t.sfaa040,
    sfaa041        LIKE sfaa_t.sfaa041,
    sfaa042        LIKE sfaa_t.sfaa042,
    sfaa043        LIKE sfaa_t.sfaa043,
    sfaa044        LIKE sfaa_t.sfaa044,
    sfaa069        LIKE sfaa_t.sfaa069,
    sfaa070        LIKE sfaa_t.sfaa070,
    sfaa045        LIKE sfaa_t.sfaa045,
    sfaa046        LIKE sfaa_t.sfaa046,
    sfaa047        LIKE sfaa_t.sfaa047,
    sfaa048        LIKE sfaa_t.sfaa048,
    sfaa065        LIKE sfaa_t.sfaa065,
    sfaa049        LIKE sfaa_t.sfaa049,
    sfaa050        LIKE sfaa_t.sfaa050,
    sfaa051        LIKE sfaa_t.sfaa051,
    sfaa055        LIKE sfaa_t.sfaa055,
    sfaa056        LIKE sfaa_t.sfaa056,
#    ooff013        LIKE ooff_t.ooff013,
    sfaaownid      LIKE sfaa_t.sfaaownid,
    sfaaownid_desc LIKE type_t.chr80,
    sfaaowndp      LIKE sfaa_t.sfaaowndp,
    sfaaowndp_desc LIKE type_t.chr80,
    sfaacrtid      LIKE sfaa_t.sfaacrtid,
    sfaacrtid_desc LIKE type_t.chr80,
    sfaacrtdp      LIKE sfaa_t.sfaacrtdp,
    sfaacrtdp_desc LIKE type_t.chr80,
    sfaacrtdt      DATETIME YEAR TO SECOND,
    sfaamodid      LIKE sfaa_t.sfaamodid,
    sfaamodid_desc LIKE type_t.chr80,
    sfaamoddt      DATETIME YEAR TO SECOND,
    sfaacnfid      LIKE sfaa_t.sfaacnfid,
    sfaacnfid_desc LIKE type_t.chr80,
    sfaacnfdt      DATETIME YEAR TO SECOND,
    sfaapstid      LIKE sfaa_t.sfaapstid,
    sfaapstid_desc LIKE type_t.chr80,
    sfaapstdt      LIKE sfaa_t.sfaapstdt
               END RECORD

#160727-00025#1-s
#模具欄位的定義
 type type_g_sfai_m        RECORD
    sfai001        LIKE sfai_t.sfai001,
    sfai001_desc   LIKE imaal_t.imaal003,
    sfai001_desc_1 LIKE imaal_t.imaal004,
    sfai002        LIKE sfai_t.sfai002,
    sfai003        LIKE sfai_t.sfai003,
    sfai004        LIKE sfai_t.sfai004,
    sfai005        LIKE sfai_t.sfai005
               END RECORD
DEFINE g_sfai_m          type_g_sfai_m
DEFINE g_sfai_m_t        type_g_sfai_m
DEFINE g_sfai_m_o        type_g_sfai_m           
#160727-00025#1-e

#單身 type 宣告
PRIVATE type type_g_sfba_d        RECORD
    sfbaseq        LIKE sfba_t.sfbaseq,
    sfbaseq1       LIKE sfba_t.sfbaseq1,
    sfba002        LIKE sfba_t.sfba002,
    sfba002_desc   LIKE type_t.chr80,
    sfba003        LIKE sfba_t.sfba003,
    sfba003_desc   LIKE type_t.chr80,
    sfba004        LIKE sfba_t.sfba004,
    sfba005        LIKE sfba_t.sfba005,
    sfba005_desc   LIKE type_t.chr80,
    sfba005_desc1  LIKE type_t.chr80,
    replace        LIKE type_t.chr80,
    sfba022        LIKE sfba_t.sfba022,
    sfba006        LIKE sfba_t.sfba006,
    sfba006_desc   LIKE type_t.chr80,
    sfba006_desc1  LIKE type_t.chr80,
    sfba033        LIKE sfba_t.sfba033,
    imaf013        LIKE type_t.chr80,
    sfba021        LIKE sfba_t.sfba021,
    sfba021_desc   LIKE type_t.chr80,
    sfba007        LIKE sfba_t.sfba007,
    sfba008        LIKE sfba_t.sfba008,
    sfba009        LIKE sfba_t.sfba009,
    sfba010        LIKE sfba_t.sfba010,
    sfba011        LIKE sfba_t.sfba011,
    sfba012        LIKE sfba_t.sfba012,
    sfba023        LIKE sfba_t.sfba023,
    sfba024        LIKE sfba_t.sfba024,
    sfba013        LIKE sfba_t.sfba013,
    sfba014        LIKE sfba_t.sfba014,
    sfba014_desc   LIKE type_t.chr80,   
    sfba015        LIKE sfba_t.sfba015,
    sfba016        LIKE sfba_t.sfba016,
    sfba025        LIKE sfba_t.sfba025,
    number1        LIKE sfba_t.sfba013,
    number2        LIKE sfba_t.sfba013,
    sfba017        LIKE sfba_t.sfba017,
    sfba018        LIKE sfba_t.sfba018,
    number3        LIKE sfba_t.sfba013,
    number4        LIKE sfba_t.sfba013,
    sfba019        LIKE sfba_t.sfba019,
    sfba019_desc   LIKE type_t.chr80,   
    sfba020        LIKE sfba_t.sfba020,
    sfba020_desc   LIKE type_t.chr80,  
    sfba029        LIKE sfba_t.sfba029,
    sfba030        LIKE sfba_t.sfba030,
    sfba028        LIKE sfba_t.sfba028,
    sfba001        LIKE sfba_t.sfba001,
    sfba001_desc   LIKE type_t.chr80,   
    sfba001_desc1  LIKE type_t.chr80,   
    sfba026        LIKE sfba_t.sfba026,
    sfba027        LIKE sfba_t.sfba027,
    sfba034        LIKE sfba_t.sfba034,
    sfba035        LIKE sfba_t.sfba035,
#   sfba_ooff013   LIKE ooff_t.ooff013   #161031-00025#17 mark
    ooff013        LIKE ooff_t.ooff013   #161031-00025#17 add
               END RECORD

PRIVATE type type_g_sfab_d        RECORD
    sfabseq        LIKE sfab_t.sfabseq, 
    sfab001        LIKE sfab_t.sfab001,
    sfab002        LIKE sfab_t.sfab002,
    sfab003        LIKE sfab_t.sfab003,
    sfab004        LIKE sfab_t.sfab004,
    sfab005        LIKE sfab_t.sfab005,
    sfab006        LIKE sfab_t.sfab006,
    a0             LIKE xmdd_t.xmdd011,
    a1             LIKE xmdd_t.xmdd006,
    a2             LIKE xmdd_t.xmdd004,
    a3             LIKE xmdd_t.xmdd006,
    a4             LIKE sfaa_t.sfaa013,
    a5             LIKE sfab_t.sfab007,
    sfab007        LIKE sfab_t.sfab007,
    a6             LIKE xmda_t.xmda004,
    a6_desc        LIKE pmaal_t.pmaal004,
    a7             LIKE xmda_t.xmda003,
    a7_desc        LIKE ooefl_t.ooefl003,
    a8             LIKE xmda_t.xmda002,
    a8_desc        LIKE ooag_t.ooag011
               END RECORD

PRIVATE type type_g_sfac_d        RECORD
    sfacseq        LIKE sfac_t.sfacseq,
    sfac002        LIKE sfac_t.sfac002,
    sfac001        LIKE sfac_t.sfac001,
    sfac001_desc   LIKE type_t.chr80,
    sfac001_desc1  LIKE type_t.chr80,
    sfac006        LIKE sfac_t.sfac006,
    sfac006_desc   LIKE type_t.chr80,
    sfac003        LIKE sfac_t.sfac003,
    sfac004        LIKE sfac_t.sfac004,
    sfac004_desc   LIKE type_t.chr80,
    sfac005        LIKE sfac_t.sfac005
               END RECORD

PRIVATE type type_g_sfaf_d        RECORD
    sfafseq        LIKE sfaf_t.sfafseq,
    sfaf001        LIKE sfaf_t.sfaf001
               END RECORD

 TYPE type_browser RECORD
    b_statepic       LIKE type_t.chr50,
    b_sfaadocno      LIKE sfaa_t.sfaadocno,
    b_sfaa001        LIKE sfaa_t.sfaa001,
    b_sfaadocdt      LIKE sfaa_t.sfaadocdt,
    b_sfaa002        LIKE sfaa_t.sfaa002,
    b_sfaa002_desc   LIKE oofa_t.oofa011,
    b_sfaa003        LIKE sfaa_t.sfaa003,
    b_sfaa057        LIKE sfaa_t.sfaa057,
    b_sfaa004        LIKE sfaa_t.sfaa004,
    b_sfaa010        LIKE sfaa_t.sfaa010,
    b_sfaa010_desc   LIKE imaal_t.imaal003,
    b_sfaa010_desc_1 LIKE imaal_t.imaal004,
    b_sfaa012        LIKE sfaa_t.sfaa012
                      END RECORD

#模組變數(Module Variables)
DEFINE g_sfaa_m          type_g_sfaa_m
DEFINE g_sfaa_m_t        type_g_sfaa_m
DEFINE g_sfaa_m_o        type_g_sfaa_m
DEFINE g_sfaa_m_mask_o   type_g_sfaa_m #轉換遮罩前資料
DEFINE g_sfaa_m_mask_n   type_g_sfaa_m #轉換遮罩後資料

DEFINE g_sfaadocno_t     LIKE sfaa_t.sfaadocno

DEFINE g_sfba_d          DYNAMIC ARRAY OF type_g_sfba_d
DEFINE g_sfba_d_t        type_g_sfba_d
DEFINE g_sfba_d_o        type_g_sfba_d
DEFINE g_sfba_d_mask_o   type_g_sfba_d #轉換遮罩前資料
DEFINE g_sfba_d_mask_n   type_g_sfba_d #轉換遮罩後資料
DEFINE g_sfab_d          DYNAMIC ARRAY OF type_g_sfab_d
DEFINE g_sfab_d_t        type_g_sfab_d
DEFINE g_sfab_d_o        type_g_sfab_d
DEFINE g_sfab_d_mask_o   type_g_sfab_d #轉換遮罩前資料
DEFINE g_sfab_d_mask_n   type_g_sfab_d #轉換遮罩後資料
DEFINE g_sfac_d          DYNAMIC ARRAY OF type_g_sfac_d
DEFINE g_sfac_d_t        type_g_sfac_d
DEFINE g_sfac_d_o        type_g_sfac_d
DEFINE g_sfac_d_mask_o   type_g_sfac_d #轉換遮罩前資料
DEFINE g_sfac_d_mask_n   type_g_sfac_d #轉換遮罩後資料
DEFINE g_sfaf_d          DYNAMIC ARRAY OF type_g_sfaf_d
DEFINE g_sfaf_d_t        type_g_sfaf_d
DEFINE g_sfaf_d_o        type_g_sfaf_d
DEFINE g_sfaf_d_mask_o   type_g_sfaf_d #轉換遮罩前資料
DEFINE g_sfaf_d_mask_n   type_g_sfaf_d #轉換遮罩後資料

DEFINE g_browser         DYNAMIC ARRAY OF type_browser
DEFINE g_browser_f       DYNAMIC ARRAY OF type_browser

DEFINE g_wc                  STRING
DEFINE g_wc_t                STRING
DEFINE g_wc2                 STRING                          #單身CONSTRUCT結果
DEFINE g_wc2_table1          STRING
DEFINE g_wc_sfab             STRING
DEFINE g_wc_sfac             STRING
DEFINE g_wc_sfaf             STRING
DEFINE g_wc_seq              STRING   #170124-00005#1
DEFINE g_wc2_extend          STRING
DEFINE g_wc_filter           STRING
DEFINE g_wc_filter_t         STRING

DEFINE g_sql                 STRING
DEFINE g_forupd_sql          STRING
DEFINE g_cnt                 LIKE type_t.num10
DEFINE g_current_idx         LIKE type_t.num10     
DEFINE g_jump                LIKE type_t.num10        
DEFINE g_no_ask              LIKE type_t.num5        
DEFINE g_rec_b               LIKE type_t.num10           
DEFINE l_ac                  LIKE type_t.num10    
DEFINE g_curr_diag           ui.Dialog                         #Current Dialog

DEFINE g_pagestart           LIKE type_t.num10                 
DEFINE gwin_curr             ui.Window                         #Current Window
DEFINE gfrm_curr             ui.Form                           #Current Form
DEFINE g_page_action         STRING                            #page action
DEFINE g_header_hidden       LIKE type_t.num5                  #隱藏單頭
DEFINE g_worksheet_hidden    LIKE type_t.num5                  #隱藏工作Panel
DEFINE g_page                STRING                            #第幾頁
DEFINE g_state               STRING       
DEFINE g_header_cnt          LIKE type_t.num10
DEFINE g_detail_cnt          LIKE type_t.num10                  #單身總筆數
DEFINE g_detail_idx          LIKE type_t.num10                  #單身目前所在筆數
DEFINE g_detail_idx_tmp      LIKE type_t.num10                  #單身目前所在筆數
DEFINE g_detail_idx2         LIKE type_t.num10                  #單身2目前所在筆數
DEFINE g_detail_idx_list     DYNAMIC ARRAY OF LIKE type_t.num10 #單身2目前所在筆數
DEFINE g_browser_cnt         LIKE type_t.num10                  #Browser總筆數
DEFINE g_browser_idx         LIKE type_t.num10                  #Browser目前所在筆數
DEFINE g_temp_idx            LIKE type_t.num10                  #Browser目前所在筆數(暫存用)
DEFINE g_order               STRING                             #查詢排序欄位

DEFINE g_current_row         LIKE type_t.num10                  #Browser所在筆數
DEFINE g_current_sw          BOOLEAN                            #Browser所在筆數用開關
DEFINE g_current_page        LIKE type_t.num10                  #目前所在頁數
DEFINE g_insert              LIKE type_t.chr5                   #是否導到其他page

DEFINE g_ref_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_ref_vars            DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE g_rtn_fields          DYNAMIC ARRAY OF VARCHAR(500) #ap_ref用陣列
DEFINE gs_keys               DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE gs_keys_bak           DYNAMIC ARRAY OF VARCHAR(500) #同步資料用陣列
DEFINE g_bfill               LIKE type_t.chr5              #是否刷新單身
DEFINE g_error_show          LIKE type_t.num5              #是否顯示筆數提示訊息
DEFINE g_master_insert       BOOLEAN                       #確認單頭資料是否寫入

DEFINE g_wc_frozen           STRING                        #凍結欄位使用
DEFINE g_chk                 BOOLEAN                       #助記碼判斷用
DEFINE g_aw                  STRING                        #確定當下點擊的單身
DEFINE g_default             BOOLEAN                       #是否有外部參數查詢
DEFINE g_log1                STRING                        #log用
DEFINE g_log2                STRING                        #log用
DEFINE g_loc                 LIKE type_t.chr5              #判斷游標所在位置
DEFINE g_add_browse          STRING                        #新增填充用WC
DEFINE g_update              BOOLEAN                       #確定單頭/身是否異動過
DEFINE g_idx_group           om.SaxAttributes              #頁籤群組
DEFINE g_master_commit       LIKE type_t.chr1              #確認單頭是否修改過
DEFINE g_pagefocus  STRING            #記錄使用者按的page   #FUN-pagetest
{</Module define>}
#end add-point
 
#add-point:自定義模組變數(Module Variable) name="global.variable"
DEFINE g_ooef004             LIKE ooef_t.ooef004
DEFINE g_ooef008             LIKE ooef_t.ooef008
DEFINE g_ooef009             LIKE ooef_t.ooef009
DEFINE g_ooef016             LIKE ooef_t.ooef016
DEFINE g_inam                DYNAMIC ARRAY OF RECORD   #記錄產品特徵
           inam001           LIKE inam_t.inam001,
           inam002           LIKE inam_t.inam002,
           inam004           LIKE inam_t.inam004
                             END RECORD
DEFINE g_inam004_sum         LIKE sfaa_t.sfaa012

DEFINE g_detail_d            DYNAMIC ARRAY OF RECORD
            sel              LIKE type_t.chr1,
            b_sfcbdocno      LIKE sfcb_t.sfcbdocno,
            b_sfcb001        LIKE sfcb_t.sfcb001, 
            b_sfcb002        LIKE sfcb_t.sfcb002, 
            b_sfaa003        LIKE sfaa_t.sfaa003,
            b_sfaa002        LIKE sfaa_t.sfaa002,
            b_sfaa002_desc   LIKE type_t.chr500,
            b_sfaa010        LIKE sfaa_t.sfaa010,   
            b_sfaa010_desc1  LIKE imaal_t.imaal003,
            b_sfaa010_desc2  LIKE imaal_t.imaal004,                                                                  
            b_sfcb003        LIKE sfcb_t.sfcb003, 
            b_sfcb003_desc   LIKE type_t.chr500,
            b_sfcb004        LIKE sfcb_t.sfcb004, 
            b_sfcb020        LIKE sfcb_t.sfcb020, 
            b_sfcb020_desc   LIKE type_t.chr500,
            b_tot_qty        LIKE sfaa_t.sfaa012,
            b_carry_qty      LIKE sfaa_t.sfaa012,
            b_sfcb013        LIKE sfcb_t.sfcb013, 
            b_sfcb013_desc   LIKE type_t.chr500,
            b_sfcb044        LIKE sfcb_t.sfcb044, 
            b_sfcb045        LIKE sfcb_t.sfcb045, 
            b_pmdl017        LIKE pmdl_t.pmdl017,
            b_pmdl017_desc   LIKE type_t.chr500,
            b_pmdl015        LIKE pmdl_t.pmdl015,
            b_pmdl015_desc   LIKE type_t.chr500,
            b_exrate         LIKE ooan_t.ooan005,
            b_pmdl011        LIKE pmdl_t.pmdl011,
            b_pmdl011_desc   LIKE type_t.chr500,
            b_price          LIKE pmdn_t.pmdn015
          # b_pmal002        LIKE pmal_t.pmal002
                             END RECORD  
DEFINE g_arr1                DYNAMIC ARRAY OF RECORD
            sfcbdocno        LIKE sfcb_t.sfcbdocno,
            sfaa010          LIKE sfaa_t.sfaa010,
            sfcb001          LIKE sfcb_t.sfcb001,
            sfcb002          LIKE sfcb_t.sfcb002,
            sfcb003          LIKE sfcb_t.sfcb003,
            sfcb004          LIKE sfcb_t.sfcb004,
            sfcb020          LIKE sfcb_t.sfcb020,
            carry_qty        LIKE sfaa_t.sfaa012,
            sfcb013          LIKE sfcb_t.sfcb013,
            sfcb044          LIKE sfcb_t.sfcb044,
            sfcb045          LIKE sfcb_t.sfcb045,
            pmdl017          LIKE pmdl_t.pmdl017,
            pmdl015          LIKE pmdl_t.pmdl015,
            exrate           LIKE ooan_t.ooan005,
            pmdl011          LIKE pmdl_t.pmdl011,
            price            LIKE pmdn_t.pmdn015
          #  pmal002          LIKE pmal_t.pmal002
                             END RECORD

DEFINE g_arr2                DYNAMIC ARRAY OF RECORD
            sfacdocno        LIKE sfac_t.sfacdocno,
            sfac006          LIKE sfac_t.sfac006,
            carry_qty        LIKE sfac_t.sfac003
                             END RECORD 
DEFINE g_pmal                DYNAMIC ARRAY OF RECORD
            b_sfcb013        LIKE pmdl_t.pmdl004,
            pmal002          LIKE pmal_t.pmal002
                             END RECORD
DEFINE g_slip                LIKE ooba_t.ooba002           #160122-00003#1 by wuxja add
DEFINE g_sfaa011             LIKE sfaa_t.sfaa011           #160214-00005#3-add 用來接工單來源裡的BOM特性
DEFINE g_action_choice1      STRING                        #ON ACTION的名稱   #160729-00016#1 add
DEFINE g_sfka900             LIKE sfka_t.sfka900           #160727-00025#1
#161109-00085#27-s
#DEFINE  g_pmdl               RECORD LIKE pmdl_t.*          #160727-00025#1
DEFINE g_pmdl RECORD  #採購單頭檔
       pmdlent LIKE pmdl_t.pmdlent, #企業編號
       pmdlsite LIKE pmdl_t.pmdlsite, #營運據點
       pmdlunit LIKE pmdl_t.pmdlunit, #應用組織
       pmdldocno LIKE pmdl_t.pmdldocno, #採購單號
       pmdldocdt LIKE pmdl_t.pmdldocdt, #採購日期
       pmdl001 LIKE pmdl_t.pmdl001, #版次
       pmdl002 LIKE pmdl_t.pmdl002, #採購人員
       pmdl003 LIKE pmdl_t.pmdl003, #採購部門
       pmdl004 LIKE pmdl_t.pmdl004, #供應商編號
       pmdl005 LIKE pmdl_t.pmdl005, #採購性質
       pmdl006 LIKE pmdl_t.pmdl006, #多角性質
       pmdl007 LIKE pmdl_t.pmdl007, #資料來源類型
       pmdl008 LIKE pmdl_t.pmdl008, #來源單號
       pmdl009 LIKE pmdl_t.pmdl009, #付款條件
       pmdl010 LIKE pmdl_t.pmdl010, #交易條件
       pmdl011 LIKE pmdl_t.pmdl011, #稅別
       pmdl012 LIKE pmdl_t.pmdl012, #稅率
       pmdl013 LIKE pmdl_t.pmdl013, #單價含稅否
       pmdl015 LIKE pmdl_t.pmdl015, #幣別
       pmdl016 LIKE pmdl_t.pmdl016, #匯率
       pmdl017 LIKE pmdl_t.pmdl017, #取價方式
       pmdl018 LIKE pmdl_t.pmdl018, #付款優惠條件
       pmdl019 LIKE pmdl_t.pmdl019, #納入APS計算
       pmdl020 LIKE pmdl_t.pmdl020, #運送方式
       pmdl021 LIKE pmdl_t.pmdl021, #付款供應商
       pmdl022 LIKE pmdl_t.pmdl022, #送貨供應商
       pmdl023 LIKE pmdl_t.pmdl023, #採購分類一
       pmdl024 LIKE pmdl_t.pmdl024, #採購分類二
       pmdl025 LIKE pmdl_t.pmdl025, #送貨地址
       pmdl026 LIKE pmdl_t.pmdl026, #帳款地址
       pmdl027 LIKE pmdl_t.pmdl027, #供應商連絡人
       pmdl028 LIKE pmdl_t.pmdl028, #一次性交易對象識別碼
       pmdl029 LIKE pmdl_t.pmdl029, #收貨部門
       pmdl030 LIKE pmdl_t.pmdl030, #多角貿易已拋轉
       pmdl031 LIKE pmdl_t.pmdl031, #多角序號
       pmdl032 LIKE pmdl_t.pmdl032, #最終客戶
       pmdl033 LIKE pmdl_t.pmdl033, #發票類型
       pmdl040 LIKE pmdl_t.pmdl040, #採購總未稅金額
       pmdl041 LIKE pmdl_t.pmdl041, #採購總含稅金額
       pmdl042 LIKE pmdl_t.pmdl042, #採購總稅額
       pmdl043 LIKE pmdl_t.pmdl043, #留置原因
       pmdl044 LIKE pmdl_t.pmdl044, #備註
       pmdl046 LIKE pmdl_t.pmdl046, #預付款發票開立方式
       pmdl047 LIKE pmdl_t.pmdl047, #物流結案
       pmdl048 LIKE pmdl_t.pmdl048, #帳流結案
       pmdl049 LIKE pmdl_t.pmdl049, #金流結案
       pmdl050 LIKE pmdl_t.pmdl050, #多角最終站否
       pmdl051 LIKE pmdl_t.pmdl051, #多角流程編號
       pmdl052 LIKE pmdl_t.pmdl052, #最終供應商
       pmdl053 LIKE pmdl_t.pmdl053, #兩角目的據點
       pmdl054 LIKE pmdl_t.pmdl054, #內外購
       pmdl055 LIKE pmdl_t.pmdl055, #匯率計算基準
       pmdl200 LIKE pmdl_t.pmdl200, #採購中心
       pmdl201 LIKE pmdl_t.pmdl201, #聯絡電話
       pmdl202 LIKE pmdl_t.pmdl202, #傳真號碼
       pmdl203 LIKE pmdl_t.pmdl203, #採購方式
       pmdl204 LIKE pmdl_t.pmdl204, #配送中心
       pmdl900 LIKE pmdl_t.pmdl900, #保留欄位str
       pmdl999 LIKE pmdl_t.pmdl999, #保留欄位end
       pmdlownid LIKE pmdl_t.pmdlownid, #資料所有者
       pmdlowndp LIKE pmdl_t.pmdlowndp, #資料所屬部門
       pmdlcrtid LIKE pmdl_t.pmdlcrtid, #資料建立者
       pmdlcrtdp LIKE pmdl_t.pmdlcrtdp, #資料建立部門
       pmdlcrtdt LIKE pmdl_t.pmdlcrtdt, #資料創建日
       pmdlmodid LIKE pmdl_t.pmdlmodid, #資料修改者
       pmdlmoddt LIKE pmdl_t.pmdlmoddt, #最近修改日
       pmdlcnfid LIKE pmdl_t.pmdlcnfid, #資料確認者
       pmdlcnfdt LIKE pmdl_t.pmdlcnfdt, #資料確認日
       pmdlpstid LIKE pmdl_t.pmdlpstid, #資料過帳者
       pmdlpstdt LIKE pmdl_t.pmdlpstdt, #資料過帳日
       pmdlstus LIKE pmdl_t.pmdlstus, #狀態碼   
       #161109-00085#66 --s add
       pmdlud001 LIKE pmdl_t.pmdlud001, #自定義欄位(文字)001
       pmdlud002 LIKE pmdl_t.pmdlud002, #自定義欄位(文字)002
       pmdlud003 LIKE pmdl_t.pmdlud003, #自定義欄位(文字)003
       pmdlud004 LIKE pmdl_t.pmdlud004, #自定義欄位(文字)004
       pmdlud005 LIKE pmdl_t.pmdlud005, #自定義欄位(文字)005
       pmdlud006 LIKE pmdl_t.pmdlud006, #自定義欄位(文字)006
       pmdlud007 LIKE pmdl_t.pmdlud007, #自定義欄位(文字)007
       pmdlud008 LIKE pmdl_t.pmdlud008, #自定義欄位(文字)008
       pmdlud009 LIKE pmdl_t.pmdlud009, #自定義欄位(文字)009
       pmdlud010 LIKE pmdl_t.pmdlud010, #自定義欄位(文字)010
       pmdlud011 LIKE pmdl_t.pmdlud011, #自定義欄位(數字)011
       pmdlud012 LIKE pmdl_t.pmdlud012, #自定義欄位(數字)012
       pmdlud013 LIKE pmdl_t.pmdlud013, #自定義欄位(數字)013
       pmdlud014 LIKE pmdl_t.pmdlud014, #自定義欄位(數字)014
       pmdlud015 LIKE pmdl_t.pmdlud015, #自定義欄位(數字)015
       pmdlud016 LIKE pmdl_t.pmdlud016, #自定義欄位(數字)016
       pmdlud017 LIKE pmdl_t.pmdlud017, #自定義欄位(數字)017
       pmdlud018 LIKE pmdl_t.pmdlud018, #自定義欄位(數字)018
       pmdlud019 LIKE pmdl_t.pmdlud019, #自定義欄位(數字)019
       pmdlud020 LIKE pmdl_t.pmdlud020, #自定義欄位(數字)020
       pmdlud021 LIKE pmdl_t.pmdlud021, #自定義欄位(日期時間)021
       pmdlud022 LIKE pmdl_t.pmdlud022, #自定義欄位(日期時間)022
       pmdlud023 LIKE pmdl_t.pmdlud023, #自定義欄位(日期時間)023
       pmdlud024 LIKE pmdl_t.pmdlud024, #自定義欄位(日期時間)024
       pmdlud025 LIKE pmdl_t.pmdlud025, #自定義欄位(日期時間)025
       pmdlud026 LIKE pmdl_t.pmdlud026, #自定義欄位(日期時間)026
       pmdlud027 LIKE pmdl_t.pmdlud027, #自定義欄位(日期時間)027
       pmdlud028 LIKE pmdl_t.pmdlud028, #自定義欄位(日期時間)028
       pmdlud029 LIKE pmdl_t.pmdlud029, #自定義欄位(日期時間)029
       pmdlud030 LIKE pmdl_t.pmdlud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       pmdl205 LIKE pmdl_t.pmdl205, #採購最終有效日
       pmdl206 LIKE pmdl_t.pmdl206, #長效期訂單否
       pmdl207 LIKE pmdl_t.pmdl207, #所屬品類
       pmdl208 LIKE pmdl_t.pmdl208  #電子採購單號
END RECORD
#161109-00085#27-e
#161109-00085#27-s
#DEFINE  g_pmdn               RECORD LIKE pmdn_t.*          #160727-00025#1
DEFINE g_pmdn RECORD  #採購單身明細檔
       pmdnent LIKE pmdn_t.pmdnent, #企業編號
       pmdnsite LIKE pmdn_t.pmdnsite, #營運據點
       pmdnunit LIKE pmdn_t.pmdnunit, #應用組織
       pmdndocno LIKE pmdn_t.pmdndocno, #採購單號
       pmdnseq LIKE pmdn_t.pmdnseq, #項次
       pmdn001 LIKE pmdn_t.pmdn001, #料件編號
       pmdn002 LIKE pmdn_t.pmdn002, #產品特徵
       pmdn003 LIKE pmdn_t.pmdn003, #包裝容器
       pmdn004 LIKE pmdn_t.pmdn004, #作業編號
       pmdn005 LIKE pmdn_t.pmdn005, #作業序
       pmdn006 LIKE pmdn_t.pmdn006, #採購單位
       pmdn007 LIKE pmdn_t.pmdn007, #採購數量
       pmdn008 LIKE pmdn_t.pmdn008, #參考單位
       pmdn009 LIKE pmdn_t.pmdn009, #參考數量
       pmdn010 LIKE pmdn_t.pmdn010, #計價單位
       pmdn011 LIKE pmdn_t.pmdn011, #計價數量
       pmdn012 LIKE pmdn_t.pmdn012, #出貨日期
       pmdn013 LIKE pmdn_t.pmdn013, #到廠日期
       pmdn014 LIKE pmdn_t.pmdn014, #到庫日期
       pmdn015 LIKE pmdn_t.pmdn015, #單價
       pmdn016 LIKE pmdn_t.pmdn016, #稅別
       pmdn017 LIKE pmdn_t.pmdn017, #稅率
       pmdn019 LIKE pmdn_t.pmdn019, #子件特性
       pmdn020 LIKE pmdn_t.pmdn020, #緊急度
       pmdn021 LIKE pmdn_t.pmdn021, #保稅
       pmdn022 LIKE pmdn_t.pmdn022, #部分交貨
       pmdnorga LIKE pmdn_t.pmdnorga, #付款據點
       pmdn023 LIKE pmdn_t.pmdn023, #送貨供應商
       pmdn024 LIKE pmdn_t.pmdn024, #多交期
       pmdn025 LIKE pmdn_t.pmdn025, #收貨地址編號
       pmdn026 LIKE pmdn_t.pmdn026, #帳款地址編號
       pmdn027 LIKE pmdn_t.pmdn027, #供應商料號
       pmdn028 LIKE pmdn_t.pmdn028, #收貨庫位
       pmdn029 LIKE pmdn_t.pmdn029, #收貨儲位
       pmdn030 LIKE pmdn_t.pmdn030, #收貨批號
       pmdn031 LIKE pmdn_t.pmdn031, #運輸方式
       pmdn032 LIKE pmdn_t.pmdn032, #取貨模式
       pmdn033 LIKE pmdn_t.pmdn033, #備品率
       pmdn034 LIKE pmdn_t.pmdn034, #no use
       pmdn035 LIKE pmdn_t.pmdn035, #價格核決
       pmdn036 LIKE pmdn_t.pmdn036, #專案編號
       pmdn037 LIKE pmdn_t.pmdn037, #WBS編號
       pmdn038 LIKE pmdn_t.pmdn038, #活動編號
       pmdn039 LIKE pmdn_t.pmdn039, #費用原因
       pmdn040 LIKE pmdn_t.pmdn040, #取價來源
       pmdn041 LIKE pmdn_t.pmdn041, #價格參考單號
       pmdn042 LIKE pmdn_t.pmdn042, #價格參考項次
       pmdn043 LIKE pmdn_t.pmdn043, #取出價格
       pmdn044 LIKE pmdn_t.pmdn044, #價差比
       pmdn045 LIKE pmdn_t.pmdn045, #行狀態
       pmdn046 LIKE pmdn_t.pmdn046, #未稅金額
       pmdn047 LIKE pmdn_t.pmdn047, #含稅金額
       pmdn048 LIKE pmdn_t.pmdn048, #稅額
       pmdn049 LIKE pmdn_t.pmdn049, #理由碼
       pmdn050 LIKE pmdn_t.pmdn050, #備註
       pmdn051 LIKE pmdn_t.pmdn051, #留置/結案理由碼
       pmdn052 LIKE pmdn_t.pmdn052, #檢驗否
       pmdn053 LIKE pmdn_t.pmdn053, #庫存管理特徵
       pmdn200 LIKE pmdn_t.pmdn200, #商品條碼
       pmdn201 LIKE pmdn_t.pmdn201, #包裝單位
       pmdn202 LIKE pmdn_t.pmdn202, #包裝數量
       pmdn203 LIKE pmdn_t.pmdn203, #收貨部門
       pmdn204 LIKE pmdn_t.pmdn204, #No Use
       pmdn205 LIKE pmdn_t.pmdn205, #要貨組織
       pmdn206 LIKE pmdn_t.pmdn206, #庫存量
       pmdn207 LIKE pmdn_t.pmdn207, #採購在途量
       pmdn208 LIKE pmdn_t.pmdn208, #前日銷售量
       pmdn209 LIKE pmdn_t.pmdn209, #上月銷量
       pmdn210 LIKE pmdn_t.pmdn210, #第一週銷量
       pmdn211 LIKE pmdn_t.pmdn211, #第二週銷量
       pmdn212 LIKE pmdn_t.pmdn212, #第三週銷量
       pmdn213 LIKE pmdn_t.pmdn213, #第四週銷量
       pmdn214 LIKE pmdn_t.pmdn214, #採購通路
       pmdn215 LIKE pmdn_t.pmdn215, #通路性質
       pmdn216 LIKE pmdn_t.pmdn216, #經營方式
       pmdn217 LIKE pmdn_t.pmdn217, #結算方式
       pmdn218 LIKE pmdn_t.pmdn218, #合約編號
       pmdn219 LIKE pmdn_t.pmdn219, #協議編號
       pmdn220 LIKE pmdn_t.pmdn220, #採購人員
       pmdn221 LIKE pmdn_t.pmdn221, #採購部門
       pmdn222 LIKE pmdn_t.pmdn222, #採購中心
       pmdn223 LIKE pmdn_t.pmdn223, #配送中心
       pmdn224 LIKE pmdn_t.pmdn224, #採購失效日
       pmdn900 LIKE pmdn_t.pmdn900, #保留欄位str
       pmdn999 LIKE pmdn_t.pmdn999, #保留欄位end
       #161109-00085#66 --s add
       pmdnud001 LIKE pmdn_t.pmdnud001, #自定義欄位(文字)001
       pmdnud002 LIKE pmdn_t.pmdnud002, #自定義欄位(文字)002
       pmdnud003 LIKE pmdn_t.pmdnud003, #自定義欄位(文字)003
       pmdnud004 LIKE pmdn_t.pmdnud004, #自定義欄位(文字)004
       pmdnud005 LIKE pmdn_t.pmdnud005, #自定義欄位(文字)005
       pmdnud006 LIKE pmdn_t.pmdnud006, #自定義欄位(文字)006
       pmdnud007 LIKE pmdn_t.pmdnud007, #自定義欄位(文字)007
       pmdnud008 LIKE pmdn_t.pmdnud008, #自定義欄位(文字)008
       pmdnud009 LIKE pmdn_t.pmdnud009, #自定義欄位(文字)009
       pmdnud010 LIKE pmdn_t.pmdnud010, #自定義欄位(文字)010
       pmdnud011 LIKE pmdn_t.pmdnud011, #自定義欄位(數字)011
       pmdnud012 LIKE pmdn_t.pmdnud012, #自定義欄位(數字)012
       pmdnud013 LIKE pmdn_t.pmdnud013, #自定義欄位(數字)013
       pmdnud014 LIKE pmdn_t.pmdnud014, #自定義欄位(數字)014
       pmdnud015 LIKE pmdn_t.pmdnud015, #自定義欄位(數字)015
       pmdnud016 LIKE pmdn_t.pmdnud016, #自定義欄位(數字)016
       pmdnud017 LIKE pmdn_t.pmdnud017, #自定義欄位(數字)017
       pmdnud018 LIKE pmdn_t.pmdnud018, #自定義欄位(數字)018
       pmdnud019 LIKE pmdn_t.pmdnud019, #自定義欄位(數字)019
       pmdnud020 LIKE pmdn_t.pmdnud020, #自定義欄位(數字)020
       pmdnud021 LIKE pmdn_t.pmdnud021, #自定義欄位(日期時間)021
       pmdnud022 LIKE pmdn_t.pmdnud022, #自定義欄位(日期時間)022
       pmdnud023 LIKE pmdn_t.pmdnud023, #自定義欄位(日期時間)023
       pmdnud024 LIKE pmdn_t.pmdnud024, #自定義欄位(日期時間)024
       pmdnud025 LIKE pmdn_t.pmdnud025, #自定義欄位(日期時間)025
       pmdnud026 LIKE pmdn_t.pmdnud026, #自定義欄位(日期時間)026
       pmdnud027 LIKE pmdn_t.pmdnud027, #自定義欄位(日期時間)027
       pmdnud028 LIKE pmdn_t.pmdnud028, #自定義欄位(日期時間)028
       pmdnud029 LIKE pmdn_t.pmdnud029, #自定義欄位(日期時間)029
       pmdnud030 LIKE pmdn_t.pmdnud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       pmdn225 LIKE pmdn_t.pmdn225, #最終收貨組織
       pmdn054 LIKE pmdn_t.pmdn054, #還料數量
       pmdn055 LIKE pmdn_t.pmdn055, #還量參考數量
       pmdn056 LIKE pmdn_t.pmdn056, #還價數量
       pmdn057 LIKE pmdn_t.pmdn057, #還價參考數量
       pmdn226 LIKE pmdn_t.pmdn226, #長效期每次送貨量
       pmdn227 LIKE pmdn_t.pmdn227, #補貨規格說明
       pmdn058 LIKE pmdn_t.pmdn058, #預算科目
       pmdn228 LIKE pmdn_t.pmdn228  #商品品類
END RECORD
#161109-00085#27-s
#161031-00025#17-s
GLOBALS
TYPE type_g_ooff_d        RECORD
       ooff001 LIKE ooff_t.ooff001, 
   ooff002 LIKE ooff_t.ooff002, 
   ooff004 LIKE ooff_t.ooff004, 
   ooff005 LIKE ooff_t.ooff005, 
   ooff006 LIKE ooff_t.ooff006, 
   ooff007 LIKE ooff_t.ooff007, 
   ooff008 LIKE ooff_t.ooff008, 
   ooff009 LIKE ooff_t.ooff009, 
   ooff010 LIKE ooff_t.ooff010, 
   ooff011 LIKE ooff_t.ooff011, 
   ooff003 LIKE ooff_t.ooff003, 
   ooff012 LIKE ooff_t.ooff012, 
   ooff013 LIKE ooff_t.ooff013, 
   ooff014 LIKE ooff_t.ooff014
       END RECORD
 
DEFINE g_ooff_d4          DYNAMIC ARRAY OF type_g_ooff_d

DEFINE g_detail_insert   LIKE type_t.num5   #單身的新增權限
DEFINE g_detail_delete   LIKE type_t.num5   #單身的刪除權限
DEFINE g_wc2_i36001      STRING             #备注单身QBE條件
DEFINE g_d_idx_i36001    LIKE type_t.num5   #备注单身所在筆數
DEFINE g_d_cnt_i36001    LIKE type_t.num5   #备注单身總筆數
DEFINE g_appoint_idx     LIKE type_t.num5   #指定進入單身行數
DEFINE g_ooff001_d       LIKE ooff_t.ooff001
DEFINE g_ooff002_d       LIKE ooff_t.ooff002
DEFINE g_ooff003_d       LIKE ooff_t.ooff003
DEFINE g_ooff004_d       LIKE ooff_t.ooff004
DEFINE g_ooff005_d       LIKE ooff_t.ooff005
DEFINE g_ooff006_d       LIKE ooff_t.ooff006
DEFINE g_ooff007_d       LIKE ooff_t.ooff007
DEFINE g_ooff008_d       LIKE ooff_t.ooff008
DEFINE g_ooff009_d       LIKE ooff_t.ooff009
DEFINE g_ooff010_d       LIKE ooff_t.ooff010
DEFINE g_ooff011_d       LIKE ooff_t.ooff011

#160701-00010#1 add --(S)--
DEFINE g_inam1               DYNAMIC ARRAY OF RECORD   #記錄產品特徵
           inam001           LIKE inam_t.inam001,
           inam002           LIKE inam_t.inam002,
           inam004           LIKE inam_t.inam004
                             END RECORD
#160701-00010#1 add --(E)--                             
END GLOBALS
#161031-00025#17-e
DEFINE g_detail_id          STRING           #紀錄停留在哪個Page #161031-00025#17 add
#end add-point
 
#add-point:自定義客戶專用模組變數(Module Variable) name="global.variable_customerization"

#end add-point
 
{</section>}
 
{<section id="asft300.main" >}
#+ 作業開始(主程式類型)
MAIN
   #add-point:main段define(客製用) name="main.define_customerization"
 
   #end add-point
   #add-point:main段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="main.define"

   #end add-point
   
   OPTIONS
   INPUT NO WRAP
   DEFER INTERRUPT
   
   #設定SQL錯誤記錄方式 (模組內定義有效)
   WHENEVER ERROR CALL cl_err_msg_log
   
   #依模組進行系統初始化設定(系統設定)
   CALL cl_ap_init("asf","")
   
   #add-point:作業初始化 name="main.init"

   #end add-point
   
   
   
   #LOCK CURSOR (identifier)
   #add-point:SQL_define name="main.define_sql"

   #end add-point
   LET g_forupd_sql = " SELECT sfaadocno,sfaa001,sfaadocdt,sfaa002,sfaa003,sfaa057,sfaa004,sfaastus,sfaa005,sfaa007, ",
                      "        sfaa008,sfaa063,sfaa006,sfaa009,sfaa022,sfaa021,sfaa023,sfaa024,sfaa064,sfaa025, ",
                      "        sfaa010,sfaa011,sfaa012,sfaa013,sfaa058,sfaa060,sfaa061,sfaa016,sfaa017,sfaa018, ",
                      "        sfaa019,sfaa020,sfaa068,sfaa014,sfaa015,sfaa026,sfaa062,sfaa028,sfaa029,sfaa030, ",
                      "        sfaa031,sfaa032,sfaa033,sfaa034,sfaa035,sfaa059,sfaa036,sfaa037,sfaa038,sfaa072, ",
                      "        sfaa039,sfaa040,sfaa041,sfaa042,sfaa043,sfaa044,sfaa069,sfaa070,sfaa045,sfaa046, ",
                      "        sfaa047,sfaa048,sfaa065,sfaa049,sfaa050,sfaa051,sfaa055,sfaa056,sfaaownid,sfaaowndp, ",
                      "        sfaacrtid,sfaacrtdp,sfaacrtdt,sfaamodid,sfaamoddt,sfaacnfid,sfaacnfdt,sfaapstid,sfaapstdt ",
                        " FROM sfaa_t WHERE sfaaent= ? AND sfaasite= ? AND sfaadocno=? FOR UPDATE "
   #add-point:SQL_define name="main.after_define_sql"
 
   #end add-point
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)                #轉換不同資料庫語法
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE asft300_cl CURSOR FROM g_forupd_sql                 # LOCK CURSOR
   
   #160621-00002-s
   LET g_sql = " SELECT DISTINCT t0.sfaadocno,t0.sfaa001,'',t0.sfaadocdt,t0.sfaa002, ",
                               " t1.ooag011,t0.sfaa003,t0.sfaa057,t0.sfaa004,t0.sfaastus, ",
                               " t0.sfaa005,t0.sfaa007,t0.sfaa008,t0.sfaa063,t0.sfaa006, ",
                               " t0.sfaa009,t2.pmaal004,t0.sfaa022,t0.sfaa021,t0.sfaa023, ",
                               " t0.sfaa024,t0.sfaa064,t0.sfaa025,t0.sfaa010,t0.sfaa011, ",
                               " t3.imaal003 ,t3.imaal004,t0.sfaa012,t0.sfaa013,t4.oocal003, ",
                               " t0.sfaa058,t0.sfaa060,t5.oocal003,t0.sfaa061,t0.sfaa016, ",
                               " t6.ecba003,t0.sfaa017,'',t0.sfaa018,t7.ooefl003, ",
                               " t0.sfaa019,t0.sfaa020,t0.sfaa068,t8.ooefl003,t0.sfaa014, ",
                               " t0.sfaa015,t0.sfaa026,t9.imae020,t0.sfaa062,t0.sfaa028, ",
                               " t10.pjbal003,t0.sfaa029,t13.pjbbl004,t0.sfaa030,t14.pjbml004, ",
                               " t0.sfaa031,t15.oocql004,t0.sfaa032,t0.sfaa033,t0.sfaa034, ",
                               " t16.inayl003,t0.sfaa035,t17.inab003,t0.sfaa059,t0.sfaa036, ",
                               " t0.sfaa037,t0.sfaa038,t0.sfaa072,t0.sfaa039,t0.sfaa040, ",
                               " t0.sfaa041,t0.sfaa042,t0.sfaa043,t0.sfaa044,t0.sfaa069, ",
                               " t0.sfaa070,t0.sfaa045,t0.sfaa046,t0.sfaa047,t0.sfaa048, ",
                               " t0.sfaa065,t0.sfaa049,t0.sfaa050,t0.sfaa051,t0.sfaa055, ",
                              #170323-00028#1 modify --(S)-- 
                              #" t0.sfaa056,'',t0.sfaaownid,t18.ooag011,t0.sfaaowndp, ",
                               " t0.sfaa056,t0.sfaaownid,t18.ooag011,t0.sfaaowndp, ",
                              #170323-00028#1 modify --(E)-- 
                               " t19.ooefl003,t0.sfaacrtid,t20.ooag011,t0.sfaacrtdp,t21.ooefl003, ",
                               " t0.sfaacrtdt,t0.sfaamodid,t22.ooag011,t0.sfaamoddt,t0.sfaacnfid, ",
                               " t23.ooag011,t0.sfaacnfdt,t0.sfaapstid,t24.ooag011,t0.sfaapstdt ",
               " FROM sfaa_t t0 ",
               " LEFT JOIN ooag_t t1 ON t1.ooagent=t0.sfaaent AND t1.ooag001=t0.sfaa002 ",
               " LEFT JOIN pmaal_t t2 ON t2.pmaalent=t0.sfaaent AND t2.pmaal001=t0.sfaa009 AND t2.pmaal002='"||g_dlang||"' ",
               " LEFT JOIN imaal_t t3 ON t3.imaalent=t0.sfaaent AND t3.imaal001=t0.sfaa010 AND t3.imaal002='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t4 ON t4.oocalent=t0.sfaaent AND t4.oocal001=t0.sfaa013 AND t4.oocal002='"||g_dlang||"' ",
               " LEFT JOIN oocal_t t5 ON t5.oocalent=t0.sfaaent AND t5.oocal001=t0.sfaa060 AND t5.oocal002='"||g_dlang||"' ",
               " LEFT JOIN ecba_t t6 ON t6.ecbaent=t0.sfaaent AND t6.ecba001=t0.sfaa010 AND t6.ecba002=t0.sfaa016 ",
               " LEFT JOIN ooefl_t t7 ON t7.ooeflent=t0.sfaaent AND t7.ooefl001=t0.sfaa018 AND t7.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooefl_t t8 ON t8.ooeflent=t0.sfaaent AND t8.ooefl001=t0.sfaa068 AND t8.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN imae_t t9 ON t9.imaeent=t0.sfaaent AND t9.imaesite=t0.sfaasite AND t9.imae001=t0.sfaa010 ",
               " LEFT JOIN pjbal_t t10 ON t10.pjbalent=t0.sfaaent AND t10.pjbal001=t0.sfaa028 AND t10.pjbal002='"||g_dlang||"' ",
               " LEFT JOIN pjbbl_t t13 ON t13.pjbblent=t0.sfaaent AND t13.pjbbl001=t0.sfaa028 AND t13.pjbbl002=t0.sfaa029 AND t13.pjbbl003='"||g_dlang||"' ",
               " LEFT JOIN pjbml_t t14 ON t14.pjbmlent=t0.sfaaent AND t14.pjbml001=t0.sfaa028 AND t14.pjbml002=t0.sfaa030 AND t14.pjbml003='"||g_dlang||"' ",
               " LEFT JOIN oocql_t t15 ON t15.oocqlent=t0.sfaaent AND t15.oocql001='225' AND t15.oocql002=t0.sfaa031 AND t15.oocql003='"||g_dlang||"' ",
               " LEFT JOIN inayl_t t16 ON t16.inaylent=t0.sfaaent AND t16.inayl001=t0.sfaa034 AND t16.inayl002='"||g_dlang||"' ",
               " LEFT JOIN inab_t t17 ON t17.inabent=t0.sfaaent AND t17.inabsite=t0.sfaasite AND t17.inab001=t0.sfaa034 AND t17.inab002=t0.sfaa035 ",
               " LEFT JOIN ooag_t t18 ON t18.ooagent=t0.sfaaent AND t18.ooag001=t0.sfaaownid ",
               " LEFT JOIN ooefl_t t19 ON t19.ooeflent=t0.sfaaent AND t19.ooefl001=t0.sfaaowndp AND t19.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t20 ON t20.ooagent=t0.sfaaent AND t20.ooag001=t0.sfaacrtid ",
               " LEFT JOIN ooefl_t t21 ON t21.ooeflent=t0.sfaaent AND t21.ooefl001=t0.sfaacrtdp AND t21.ooefl002='"||g_dlang||"' ",
               " LEFT JOIN ooag_t t22 ON t22.ooagent=t0.sfaaent AND t22.ooag001=t0.sfaamodid ",
               " LEFT JOIN ooag_t t23 ON t23.ooagent=t0.sfaaent AND t23.ooag001=t0.sfaacnfid ",
               " LEFT JOIN ooag_t t24 ON t24.ooagent=t0.sfaaent AND t24.ooag001=t0.sfaapstid ",
               " WHERE t0.sfaaent = '" ||g_enterprise|| "' AND t0.sfaadocno = ? "
   LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
   #add-point:SQL_define name="main.after_refresh_sql"
   
   #end add-point
   PREPARE asft300_master_referesh FROM g_sql
   #160621-00002-e
   
   
   
   IF g_bgjob = "Y" THEN
      #add-point:Service Call name="main.servicecall"
      
      #end add-point
   ELSE
      #畫面開啟 (identifier)
      OPEN WINDOW w_asft300 WITH FORM cl_ap_formpath("asf",g_code)
      
      #瀏覽頁簽資料初始化
      CALL cl_ui_init()
      
      #程式初始化
      CALL asft300_init()
      
      #進入選單 Menu (="N")
      CALL asft300_ui_dialog()
      
      #add-point:畫面關閉前 name="main.before_close"
 
      #end add-point
      
      #畫面關閉
      CLOSE WINDOW w_asft300
      
   END IF
   
   CLOSE asft300_cl
   
   
   
   #add-point:作業離開前 name="main.exit"

   DROP TABLE asft300_bmce_tmp  #161209-00038#3

   #end add-point
   
   #離開作業
   CALL cl_ap_exitprogram("0")
END MAIN
{</section>}
 
{<section id="asft300.other_function" >}
#add-point:自定義元件(Function)

################################################################################
# Descriptions...: 瀏覽頁簽資料初始化
# Memo...........:
# Usage..........: CALL asft300_init()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_init()
   #add-point:init段define(客製用) name="init.define_customerization"

   #end add-point    
   #add-point:init段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="init.define"
                  
   #end add-point   
   
   #add-point:Function前置處理  name="init.pre_function"

   #end add-point
   
   LET g_bfill       = "Y"
   LET g_detail_idx  = 1 #第一層單身指標
   LET g_detail_idx2 = 1 #第二層單身指標
   
   #各個page指標
   LET g_detail_idx_list[1] = 1 
   LET g_detail_idx_list[2] = 1
   LET g_detail_idx_list[3] = 1
   LET g_detail_idx_list[4] = 1

   LET g_error_show  = 1
   LET l_ac = 1 #單身指標
   
   CALL cl_set_combo_scc_part('sfaastus','13','A,C,D,E,F,M,N,R,W,Y,X')
   CALL cl_set_combo_scc('sfaa003','4007')
   CALL cl_set_combo_scc('sfaa057','4010')
   CALL cl_set_combo_scc('sfaa004','4008')
   CALL cl_set_combo_scc('sfaa005','4009')
   CALL cl_set_combo_scc('sfaa065','4022')
   #160204-00011#1-s
   #原為noEntry，但現在變成可選擇訂單or獨立需求單
   #CALL cl_set_combo_scc('sfab001','4009')
   CALL cl_set_combo_scc_part('sfab001','4009','2,6,5')
   #160204-00011#1-e
   CALL cl_set_combo_scc('sfac002','4019')
   CALL cl_set_combo_scc('sfba008','1101')
   CALL cl_set_combo_scc('sfba026','4012')
   CALL cl_set_combo_scc('imaf013','2022')
   CALL cl_set_combo_scc('b_sfaa003','4007')
   CALL cl_set_combo_scc('b_sfaa057','4010')
   CALL cl_set_combo_scc('b_sfaa004','4008')
   
   #160727-00025#1-s
   IF g_argv[01] = '4' THEN
      CALL cl_set_combo_scc_part('sfaa003','4007','5')
   ELSE
      CALL cl_set_combo_scc_part('sfaa003','4007','1,2,3,4')
   END IF
   #160727-00025#1-e
   
   LET gwin_curr = ui.Window.getCurrent()  #取得現行畫面
   LET gfrm_curr = gwin_curr.getForm()     #取出物件化後的畫面物件
   
   #page群組
   LET g_idx_group = om.SaxAttributes.create()
   CALL g_idx_group.addAttribute("'1',","1")
   CALL g_idx_group.addAttribute("'2',","1")
   CALL g_idx_group.addAttribute("'3',","1")
   CALL g_idx_group.addAttribute("'4',","1")
   
   #add-point:畫面資料初始化 name="init.init"
   #161031-00025#17-s
   #子程式畫面取代主程式元件
   CALL cl_ui_replace_sub_window(cl_ap_formpath("aoo", "aooi360_01"), "grid_remarks", "Table", "s_detail1_aooi360_01")
   CALL cl_set_combo_scc_part('ooff012','11','1,2,4')
   CALL cl_set_comp_visible("ooff003",FALSE)
   #161031-00025#17-e
   #使用參考單位
   IF cl_get_para(g_enterprise,g_site,'S-BAS-0028') = 'N' THEN
      CALL cl_set_comp_visible("sfaa058,sfaa060,sfaa060_desc",FALSE)
   END IF
   
   #使用產品特徵
   IF cl_get_para(g_enterprise,g_site,'S-BAS-0036')  = 'N' THEN
      CALL cl_set_comp_visible("sfba021,sfba021_desc,sfac006,sfac006_desc",FALSE)
   END IF
   
   CALL cl_set_comp_visible("number3,number4",FALSE)  #160122-00003#1
   
   #160727-00025#1-s
   #模具頁簽資料
   IF g_argv[01] = '4' THEN
      CALL cl_set_toolbaritem_visible("open_asft300_07",FALSE)
   ELSE
      CALL cl_set_comp_visible('page_11',FALSE)
      CALL cl_set_toolbaritem_visible("add_allotment",FALSE)
   END IF
   #160727-00025#1-e
   
   #根据当前营运据点g_site抓取aooi120中设置的行事历参照表号
   LET g_ooef004 = ''
   LET g_ooef008 = ''
   LET g_ooef009 = ''
   LET g_ooef016 = '' #161226-00053#1 add
   SELECT ooef004,ooef008,ooef009,ooef016  #161226-00053#1 add ooef016
     INTO g_ooef004,g_ooef008,g_ooef009,g_ooef016  #161226-00053#1 add g_ooef016
     FROM ooef_t
    WHERE ooef001 = g_site AND ooefent  = g_enterprise
   
   #161209-00038#3-s
   CREATE TEMP TABLE asft300_bmce_tmp(
       bmce009    LIKE bmce_t.bmce009,
       bmce010    LIKE bmce_t.bmce010)
   #161209-00038#3-e
    LET g_pagefocus = "master_Folder_page"   #預設顯示的page #FUN-pagetest
   #end add-point
   
   #初始化搜尋條件
   CALL asft300_default_search()

END FUNCTION

################################################################################
# Descriptions...: 功能選單
# Memo...........:
# Usage..........: CALL asft300_ui_dialog()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_ui_dialog()
   #add-point:ui_dialog段define(客製用) name="ui_dialog.define_customerization"
   
   #end add-point

   #end add-point
   DEFINE li_idx     LIKE type_t.num10
   DEFINE ls_wc      STRING
   DEFINE lb_first   BOOLEAN
   DEFINE la_wc      DYNAMIC ARRAY OF RECORD
          tableid    STRING,
          wc         STRING
          END RECORD
   DEFINE la_param   RECORD
          prog       STRING,
          actionid   STRING,
          background LIKE type_t.chr1,
          param      DYNAMIC ARRAY OF STRING
          END RECORD
   DEFINE ls_js      STRING
   DEFINE la_output  DYNAMIC ARRAY OF STRING   #報表元件鬆耦合使用
   DEFINE  l_cmd_token           base.StringTokenizer   #報表作業cmdrun使用 
   DEFINE  l_cmd_next            STRING                 #報表作業cmdrun使用
   DEFINE  l_cmd_cnt             LIKE type_t.num5       #報表作業cmdrun使用
   DEFINE  l_cmd_prog_arg        STRING                 #報表作業cmdrun使用
   DEFINE  l_cmd_arg             STRING                 #報表作業cmdrun使用
   #add-point:ui_dialog段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_dialog.define"
   DEFINE l_success  LIKE type_t.num5
   DEFINE l_n        LIKE type_t.num5
   DEFINE l_sfka900  LIKE sfka_t.sfka900  #160727-00025#1
   #end add-point
   
   #add-point:Function前置處理  name="ui_dialog.pre_function"

   #end add-point
   
   CALL cl_set_act_visible("accept,cancel", FALSE)
 
   #因應查詢方案進行處理
   IF g_default THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   ELSE
      CALL gfrm_curr.setElementHidden("mainlayout",1)
      CALL gfrm_curr.setElementHidden("worksheet",0)
      LET g_main_hidden = 1
   END IF
   
   #action default動作
   #應用 a42 樣板自動產生(Version:3)
   #進入程式時預設執行的動作
   CASE g_actdefault
      WHEN "insert"
         LET g_action_choice="insert"
         LET g_actdefault = ""
         IF cl_auth_chk_act("insert") THEN
            CALL asft300_insert()
            #add-point:ON ACTION insert name="menu.default.insert"

            #END add-point
         END IF
 
      #add-point:action default自訂 name="ui_dialog.action_default"

      #end add-point
      OTHERWISE
   END CASE
   
   LET lb_first = TRUE
   
   #add-point:ui_dialog段before dialog  name="ui_dialog.before_dialog"

   #end add-point
   
   WHILE TRUE 
   
      IF g_action_choice = "logistics" THEN
         #清除畫面及相關資料
         CLEAR FORM
         CALL g_browser.clear()       
         INITIALIZE g_sfaa_m.* TO NULL
         INITIALIZE g_sfai_m.* TO NULL  #160727-00025#1
         CALL g_sfba_d.clear()
         CALL g_sfab_d.clear()
         CALL g_sfac_d.clear()
         CALL g_sfaf_d.clear()
 
         LET g_wc  = ' 1=2'
         LET g_wc2 = ' 1=1'
         LET g_action_choice = ""
         CALL asft300_init()
      END IF
   
      CALL lib_cl_dlg.cl_dlg_before_display()
            
      DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
 
         #左側瀏覽頁簽
         DISPLAY ARRAY g_browser TO s_browse.* ATTRIBUTES(COUNT=g_header_cnt)
            BEFORE ROW
               #回歸舊筆數位置 (回到當時異動的筆數)
               LET g_current_idx = DIALOG.getCurrentRow("s_browse")
               IF g_current_row > 1 AND g_current_idx = 1 AND g_current_sw = FALSE THEN
                  CALL DIALOG.setCurrentRow("s_browse",g_current_row)
                  LET g_current_idx = g_current_row
               END IF
               LET g_current_row = g_current_idx #目前指標
               LET g_current_sw = TRUE
         
               IF g_current_idx > g_browser.getLength() THEN
                  LET g_current_idx = g_browser.getLength()
               END IF 
               
               CALL asft300_fetch('') # reload data
               LET l_ac = 1
               CALL asft300_ui_detailshow() #Setting the current row 
         
               CALL asft300_idx_chk()
               #NEXT FIELD sfbaseq
         
               ON ACTION qbefield_user   #欄位隱藏設定 
                  LET g_action_choice="qbefield_user"
                  CALL cl_ui_qbefield_user()
         END DISPLAY
        
         DISPLAY ARRAY g_sfba_d TO s_detail1.* ATTRIBUTES(COUNT=g_rec_b) #page1  
    
            BEFORE ROW
               #顯示單身筆數
               CALL asft300_idx_chk()
               #確定當下選擇的筆數
               LET l_ac = DIALOG.getCurrentRow("s_detail1")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[1] = l_ac
               CALL g_idx_group.addAttribute("'1',",l_ac)
               
               #add-point:page1, before row動作 name="ui_dialog.page1.before_row"
                                                                                         
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'1',"))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_detail1")
               LET g_current_page = 1
               #顯示單身筆數
               CALL asft300_idx_chk()
               #add-point:page1自定義行為 name="ui_dialog.page1.before_display"
                                                                                          
               #end add-point
               
            #自訂ACTION(detail_show,page_1)
            
               
            #add-point:page1自定義行為 name="ui_dialog.page1.action"
                                                                        
            #end add-point
               
         END DISPLAY
    
         DISPLAY ARRAY g_sfab_d TO s_sfab.* ATTRIBUTES(COUNT=g_rec_b)  
    
            BEFORE ROW
               #顯示單身筆數
               CALL asft300_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_sfab")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[2] = l_ac
               CALL g_idx_group.addAttribute("'2',",l_ac)
               
               #add-point:page2, before row動作 name="ui_dialog.body2.before_row"
                                                                                          
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'2',"))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_sfab")
               LET g_current_page = 2
               #顯示單身筆數
               CALL asft300_idx_chk()
               #add-point:page2自定義行為 name="ui_dialog.body2.before_display"
                                                                                          
               #end add-point
      
            #自訂ACTION(detail_show,page_2)
            
         
            #add-point:page2自定義行為 name="ui_dialog.body2.action"
                                                                        
            #end add-point
         
         END DISPLAY
        
         DISPLAY ARRAY g_sfac_d TO s_sfac.* ATTRIBUTES(COUNT=g_rec_b)  
    
            BEFORE ROW
               #顯示單身筆數
               CALL asft300_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_sfac")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[3] = l_ac
               CALL g_idx_group.addAttribute("'3',",l_ac)
               
               #add-point:page3, before row動作 name="ui_dialog.body3.before_row"
                                                                                          
               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'3',"))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_sfac")
               LET g_current_page = 3
               #顯示單身筆數
               CALL asft300_idx_chk()
               #add-point:page3自定義行為 name="ui_dialog.body3.before_display"
                                                                                          
               #end add-point
      
            #自訂ACTION(detail_show,page_3)
            
         
            #add-point:page3自定義行為 name="ui_dialog.body3.action"
                                                                        
            #end add-point
         
         END DISPLAY
        
         DISPLAY ARRAY g_sfaf_d TO s_sfaf.* ATTRIBUTES(COUNT=g_rec_b)  
    
            BEFORE ROW
               #顯示單身筆數
               CALL asft300_idx_chk()
               LET l_ac = DIALOG.getCurrentRow("s_sfaf")
               LET g_detail_idx = l_ac
               LET g_detail_idx_list[4] = l_ac
               CALL g_idx_group.addAttribute("'4'",l_ac)
               
               #add-point:page6, before row動作 name="ui_dialog.body6.before_row"

               #end add-point
               
            BEFORE DISPLAY
               #如果一直都在單身1則控制筆數位置
               IF g_loc = 'm' THEN
                  CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'4'"))
               END IF
               LET g_loc = 'm'
               LET l_ac = DIALOG.getCurrentRow("s_sfaf")
               LET g_current_page = 4
               #顯示單身筆數
               CALL asft300_idx_chk()
               #add-point:page6自定義行為 name="ui_dialog.body6.before_display"

               #end add-point
      
            #自訂ACTION(detail_show,page_6)
            
         
            #add-point:page6自定義行為 name="ui_dialog.body6.action"

            #end add-point
         
         END DISPLAY
         
         #add-point:ui_dialog段自定義display array name="ui_dialog.more_displayarray"
         SUBDIALOG aoo_aooi360_01.aooi360_01_display     #161031-00025#17 add 
         #end add-point
         
         SUBDIALOG lib_cl_dlg.cl_dlg_qryplan
         SUBDIALOG lib_cl_dlg.cl_dlg_relateapps
      
         BEFORE DIALOG
            #先填充browser資料
            CALL asft300_browser_fill("")
            CALL cl_notice()
            CALL cl_navigator_setting(g_current_idx, g_detail_cnt)
            LET g_curr_diag = ui.DIALOG.getCurrent()
            LET g_current_sw = FALSE
            #回歸舊筆數位置 (回到當時異動的筆數)
            LET g_current_idx = DIALOG.getCurrentRow("s_browse")
            IF g_current_row > 1 AND g_current_idx = 1 AND g_current_sw = FALSE THEN
               CALL DIALOG.setCurrentRow("s_browse",g_current_row)
               LET g_current_idx = g_current_row
            END IF
            
            #確保g_current_idx位於正常區間內
            #小於,等於0則指到第1筆
            IF g_current_idx <= 0 THEN
               LET g_current_idx = 1
            END IF
            #超過最大筆數則指到最後1筆
            IF g_current_idx > g_browser.getLength() THEN
               LEt g_current_idx = g_browser.getLength()
            END IF
            
            LET g_current_sw = TRUE
            LET g_current_row = g_current_idx #目前指標
            
            #有資料才進行fetch
            IF g_current_idx <> 0 THEN
               CALL asft300_fetch('') # reload data
            END IF
            #LET g_detail_idx = 1
            CALL asft300_ui_detailshow() #Setting the current row
            
            #筆數顯示
            LET g_current_page = 1
            CALL asft300_idx_chk()
            CALL cl_ap_performance_cal()
            #add-point:ui_dialog段before_dialog2 name="ui_dialog.before_dialog2"
            
              #CALL gfrm_curr.ensureFieldVisible("sfaa_t.sfaa005")   #160824-00016#1 add  #FUN-pagetest mark
            CALL gfrm_curr.ensureElementVisible(g_pagefocus)   #FUN-pagetest
            display "g_pagefocus=",g_pagefocus
            
             ###FUN-pagetest START ###
#         ON ACTION nextfield   #抑制鍵盤Enter按鍵功能,DISPLAY ARRAY的nextfield不做任何事,避免page亂跳

         #記錄使用者按的page
         ON ACTION onpage_1                          #基本資料
            LET g_pagefocus = "master_Folder_page"
         ON ACTION onpage_11                         #模具資料
            LET g_pagefocus = "page_11"
         ON ACTION onpage_2                          #工單資料
            LET g_pagefocus = "page_2"
         ON ACTION onpage_3                          #相關資訊
            LET g_pagefocus = "page_3"
         ON ACTION onpage_4                          #工單來源
            LET g_pagefocus = "page_4"
         ON ACTION onpage_5                          #生產料號明細
            LET g_pagefocus = "page_5"
         ON ACTION onpage_8                          #產品序號
            LET g_pagefocus = "page_8"
#         ON ACTION onpage_9                          #備註
#            LET g_pagefocus = "page_9"
         ON ACTION onpage_info_1                     #異動資訊
            LET g_pagefocus = "page_info_1"
         ON ACTION onpage_10                     #異動資訊
            LET g_pagefocus = "page10"
         ###FUN-pagetest END ###
            #end add-point
         #add-point:ui_dialog段more_action name="ui_dialog.more_action"
         #161031-00025#17-s
         ON ACTION remarks_page
            LET g_detail_id = "remarks_page"
            NEXT FIELD ooff012
         #161031-00025#17-e
         #end add-point
         #狀態碼切換
         ON ACTION statechange
            LET g_action_choice = "statechange"
            CALL asft300_statechange()
            #根據資料狀態切換action狀態
            CALL asft300_set_act_visible()   
            CALL asft300_set_act_no_visible()
            IF NOT (g_sfaa_m.sfaadocno IS NULL) THEN
               #組合條件
               LET g_add_browse = " sfaaent = '" ||g_enterprise|| "' AND",
                                  " sfaadocno = '", g_sfaa_m.sfaadocno, "' "
               #填到對應位置
               CALL asft300_browser_fill("")
            END IF
 
         #簽核狀況
         ON ACTION bpm_status
            #查詢簽核狀況, 統一建立HyperLink
            CALL cl_bpm_status()
            #add-point:ON ACTION bpm_status name="menu.bpm_status"

            #END add-point
 
         #查詢方案選擇 
         ON ACTION queryplansel
            CALL cl_dlg_qryplan_select() RETURNING ls_wc
            #不是空條件才寫入g_wc跟重新找資料
            IF NOT cl_null(ls_wc) THEN
               CALL util.JSON.parse(ls_wc, la_wc)
               INITIALIZE g_wc, g_wc2,g_wc2_table1,g_wc2_extend TO NULL
               INITIALIZE g_wc_sfab TO NULL
               INITIALIZE g_wc_sfac TO NULL
               INITIALIZE g_wc_sfaf TO NULL
               INITIALIZE g_wc_seq  TO NULL   #170124-00005#1
               FOR li_idx = 1 TO la_wc.getLength()
                  CASE
                     WHEN la_wc[li_idx].tableid = "sfaa_t" 
                        LET g_wc = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "sfba_t" 
                        LET g_wc2_table1 = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "sfab_t" 
                        LET g_wc_sfab = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "sfac_t" 
                        LET g_wc_sfac = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "sfaf_t" 
                        LET g_wc_sfaf = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "EXTENDWC"
                        LET g_wc2_extend = la_wc[li_idx].wc
                  END CASE
               END FOR
               IF NOT cl_null(g_wc) OR NOT cl_null(g_wc2_table1) 
                  OR NOT cl_null(g_wc_sfab)
                  OR NOT cl_null(g_wc_sfac)
                  OR NOT cl_null(g_wc_sfaf)
                  OR NOT cl_null(g_wc_seq)   #170124-00005#1
                  OR NOT cl_null(g_wc2_extend)
                  THEN
                  #組合g_wc2
                  IF g_wc2_table1 <> " 1=1" AND NOT cl_null(g_wc2_table1) THEN
                     LET g_wc2 = g_wc2_table1
                  END IF
                  IF g_wc_sfab <> " 1=1" AND NOT cl_null(g_wc_sfab) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc_sfab
                  END IF
                  IF g_wc_sfac <> " 1=1" AND NOT cl_null(g_wc_sfac) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc_sfac
                  END IF
                  IF g_wc_sfaf <> " 1=1" AND NOT cl_null(g_wc_sfaf) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc_sfaf
                  END IF
                  #170124-00005#1-s-add
                  IF g_wc_seq <> " 1=1" AND NOT cl_null(g_wc_seq) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc_seq
                  END IF
                  #170124-00005#1-e-add
                  IF g_wc2_extend <> " 1=1" AND NOT cl_null(g_wc2_extend) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_extend
                  END IF
                  IF g_wc2.subString(1,5) = " AND " THEN
                     LET g_wc2 = g_wc2.subString(6,g_wc2.getLength())
                  END IF
               END IF
               CALL asft300_browser_fill("F")   #browser_fill()會將notice區塊清空
               CALL cl_notice()   #重新顯示,此處不可用EXIT DIALOG, SUBDIALOG重讀會導致部分變數消失
            END IF
         
         #查詢方案選擇
         ON ACTION qbe_select
            CALL cl_qbe_list("m") RETURNING ls_wc
            IF NOT cl_null(ls_wc) THEN
               CALL util.JSON.parse(ls_wc, la_wc)
               INITIALIZE g_wc, g_wc2,g_wc2_table1,g_wc2_extend TO NULL
               INITIALIZE g_wc_sfab TO NULL
               INITIALIZE g_wc_sfac TO NULL
               INITIALIZE g_wc_sfaf TO NULL
               INITIALIZE g_wc_seq TO NULL   #170124-00005#1
               FOR li_idx = 1 TO la_wc.getLength()
                  CASE
                     WHEN la_wc[li_idx].tableid = "sfaa_t" 
                        LET g_wc = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "sfba_t" 
                        LET g_wc2_table1 = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "sfab_t" 
                        LET g_wc_sfab = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "sfac_t" 
                        LET g_wc_sfac = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "sfaf_t" 
                        LET g_wc_sfaf = la_wc[li_idx].wc
                     WHEN la_wc[li_idx].tableid = "EXTENDWC"
                        LET g_wc2_extend = la_wc[li_idx].wc
                  END CASE
               END FOR
               IF NOT cl_null(g_wc) OR NOT cl_null(g_wc2_table1) 
                  OR NOT cl_null(g_wc_sfab)
                  OR NOT cl_null(g_wc_sfac)
                  OR NOT cl_null(g_wc_sfaf)
                  OR NOT cl_null(g_wc_seq)   #170124-00005#1
                  OR NOT cl_null(g_wc2_extend)
                  THEN
                  #組合g_wc2
                  IF g_wc2_table1 <> " 1=1" AND NOT cl_null(g_wc2_table1) THEN
                     LET g_wc2 = g_wc2_table1
                  END IF
                  IF g_wc_sfab <> " 1=1" AND NOT cl_null(g_wc_sfab) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc_sfab
                  END IF
                  IF g_wc_sfac <> " 1=1" AND NOT cl_null(g_wc_sfac) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc_sfac
                  END IF
                  IF g_wc_sfaf <> " 1=1" AND NOT cl_null(g_wc_sfaf) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc_sfaf
                  END IF
                  #170124-00005#1-s-add
                  IF g_wc_seq <> " 1=1" AND NOT cl_null(g_wc_seq) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc_seq
                  END IF
                  #170124-00005#1-e-add
                  IF g_wc2_extend <> " 1=1" AND NOT cl_null(g_wc2_extend) THEN
                     LET g_wc2 = g_wc2 ," AND ", g_wc2_extend
                  END IF
                  IF g_wc2.subString(1,5) = " AND " THEN
                     LET g_wc2 = g_wc2.subString(6,g_wc2.getLength())
                  END IF
                  #取得條件後需要重查、跳到結果第一筆資料的功能程式段
                  CALL asft300_browser_fill("F")
                  IF g_browser_cnt = 0 THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "" 
                     LET g_errparam.code   = "-100" 
                     LET g_errparam.popup  = TRUE 
                     CALL cl_err()
                     CLEAR FORM
                  ELSE
                     CALL asft300_fetch("F")
                  END IF
               END IF
            END IF
            #重新搜尋會將notice區塊清空,此處不可用EXIT DIALOG, SUBDIALOG重讀會導致部分變數消失
            CALL cl_notice()
          
         #過濾瀏覽頁資料
         ON ACTION filter
            LET g_action_choice = "fetch"
            #add-point:filter action name="ui_dialog.action.filter"
          
            #end add-point
            CALL asft300_filter()
            EXIT DIALOG
         
         ON ACTION first
            LET g_action_choice = "fetch"
            CALL asft300_fetch('F')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL asft300_idx_chk()
            
         ON ACTION previous
            LET g_action_choice = "fetch"
            CALL asft300_fetch('P')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL asft300_idx_chk()
            
         ON ACTION jump
            LET g_action_choice = "fetch"
            CALL asft300_fetch('/')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL asft300_idx_chk()
            
         ON ACTION next
            LET g_action_choice = "fetch"
            CALL asft300_fetch('N')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL asft300_idx_chk()
            
         ON ACTION last
            LET g_action_choice = "fetch"
            CALL asft300_fetch('L')
            LET g_current_row = g_current_idx
            LET g_curr_diag = ui.DIALOG.getCurrent()
            CALL asft300_idx_chk()
          
         #excel匯出功能          
         ON ACTION exporttoexcel
            LET g_action_choice="exporttoexcel"
            IF cl_auth_chk_act("exporttoexcel") THEN
               #browser
               CALL g_export_node.clear()
               IF g_main_hidden = 1 THEN
                  LET g_export_node[1] = base.typeInfo.create(g_browser)
                  LET g_export_id[1]   = "s_browse"
                  CALL cl_export_to_excel()
               #非browser
               ELSE
                  LET g_export_node[1] = base.typeInfo.create(g_sfab_d)
                  LET g_export_id[1]   = "s_sfab"
                  LET g_export_node[2] = base.typeInfo.create(g_sfba_d)
                  LET g_export_id[2]   = "s_detail1"
                  LET g_export_node[3] = base.typeInfo.create(g_sfac_d)
                  LET g_export_id[3]   = "s_sfac"
                  LET g_export_node[4] = base.typeInfo.create(g_sfaf_d)
                  LET g_export_id[4]   = "s_sfaf"
                  #add-point:ON ACTION exporttoexcel name="menu.exporttoexcel"
                  #161031-00025#17-s
                  LET g_export_node[5] = base.typeInfo.create(g_ooff_d4)
                  LET g_export_id[5]   = "s_detail1_aooi360_01"
                  #161031-00025#17-e
                  #END add-point
                  CALL cl_export_to_excel_getpage()
                  CALL cl_export_to_excel()
               END IF
            END IF
        
         ON ACTION close
            LET INT_FLAG = FALSE
            LET g_action_choice = "exit"
            EXIT DIALOG
          
         ON ACTION exit
            LET g_action_choice = "exit"
            EXIT DIALOG
    
         #主頁摺疊
         ON ACTION mainhidden
            IF g_main_hidden THEN
               CALL gfrm_curr.setElementHidden("mainlayout",0)
               CALL gfrm_curr.setElementHidden("worksheet",1)
               LET g_main_hidden = 0
            ELSE
               CALL gfrm_curr.setElementHidden("mainlayout",1)
               CALL gfrm_curr.setElementHidden("worksheet",0)
               LET g_main_hidden = 1
               CALL cl_notice()
            END IF
            
         #瀏覽頁折疊
         ON ACTION worksheethidden
            IF g_main_hidden THEN
               CALL gfrm_curr.setElementHidden("mainlayout",0)
               CALL gfrm_curr.setElementHidden("worksheet",1)
               LET g_main_hidden = 0
            ELSE
               CALL gfrm_curr.setElementHidden("mainlayout",1)
               CALL gfrm_curr.setElementHidden("worksheet",0)
               LET g_main_hidden = 1
            END IF
            IF lb_first THEN
               LET lb_first = FALSE
               NEXT FIELD sfbaseq
            END IF
       
         #單頭摺疊，可利用hot key "Alt-s"開啟/關閉單頭
         ON ACTION controls
            IF g_header_hidden THEN
               CALL gfrm_curr.setElementHidden("vb_master",0)
               CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
               LET g_header_hidden = 0     #visible
            ELSE
               CALL gfrm_curr.setElementHidden("vb_master",1)
               CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
               LET g_header_hidden = 1     #hidden
            END IF
         
         ON ACTION modify
            LET g_action_choice="modify"
            IF cl_auth_chk_act("modify") THEN
               LET g_aw = ''
               CALL asft300_modify()
               #add-point:ON ACTION modify name="menu.modify"

               #END add-point
            END IF
 
         ON ACTION modify_detail
            LET g_action_choice="modify_detail"
            IF cl_auth_chk_act("modify") THEN
               LET g_aw = g_curr_diag.getCurrentItem()
               CALL asft300_modify()
               #add-point:ON ACTION modify_detail name="menu.modify_detail"

               #END add-point
            END IF
 
         ON ACTION delete
            LET g_action_choice="delete"
            IF cl_auth_chk_act("delete") THEN
               CALL asft300_delete()
               #add-point:ON ACTION delete name="menu.delete"
                                                                                          
               #END add-point
            END IF
 
         ON ACTION insert
            LET g_action_choice="insert"
            IF cl_auth_chk_act("insert") THEN
               CALL asft300_insert()
               #add-point:ON ACTION insert name="menu.insert"
                                                                                          
               #END add-point
            END IF
 
         ON ACTION output
            LET g_action_choice="output"
            IF cl_auth_chk_act("output") THEN
               #add-point:ON ACTION output name="menu.output"
               LET g_rep_wc = " sfaaent = ",g_enterprise," AND sfaadocno = '",g_sfaa_m.sfaadocno,"' "
               #END add-point
               &include "erp/asf/asft300_rep.4gl"
               #add-point:ON ACTION output.after

               #END add-point
            END IF
 
         ON ACTION reproduce
            LET g_action_choice="reproduce"
            IF cl_auth_chk_act("reproduce") THEN
               CALL asft300_reproduce()
               #add-point:ON ACTION reproduce name="menu.reproduce"
                                                                                          
               #END add-point
            END IF
 
         ON ACTION query
            LET g_action_choice="query"
            IF cl_auth_chk_act("query") THEN
               CALL asft300_query()
               #add-point:ON ACTION query name="menu.query"
                                                                                          
               #END add-point
               #應用 a59 樣板自動產生(Version:3)  
               CALL g_curr_diag.setCurrentRow("s_detail1",1)
               CALL g_curr_diag.setCurrentRow("s_sfab",1)
               CALL g_curr_diag.setCurrentRow("s_sfac",1)
               CALL g_curr_diag.setCurrentRow("s_sfaf",1)
            END IF
 
         #產生備料
         ON ACTION gen_allotment
            LET g_action_choice="gen_allotment"
            IF cl_auth_chk_act("gen_allotment") THEN
               #160708-00014-s
               IF asft300_allotment_chk() THEN
                  CALL s_transaction_begin()
                  IF asft300_allotment_del() THEN
                     CALL s_asft300_02(g_sfaa_m.sfaadocno,g_sfaa_m.sfaa003,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa015,g_sfaa_m.sfaa012,'N') RETURNING l_success,l_n
                     IF NOT l_success THEN
                        CALL s_transaction_end('N','0')
                     ELSE                                 #170310-00012#1 add
                        LET g_sfaa_m.sfaa039 = 'Y'        #170310-00012#1 add
                        DISPLAY BY NAME g_sfaa_m.sfaa039  #170310-00012#1 add                        
                     END IF
                  ELSE
                     CALL s_transaction_end('N','0')
                  END IF
                  CALL s_transaction_end('Y','0')
               END IF
               CALL asft300_b_fill()
               #160708-00014-e
            END IF
            
         #刪除備料
         ON ACTION del_allotment
            LET g_action_choice="del_allotment"
            IF cl_auth_chk_act("del_allotment") THEN
               #160708-00014-s
               IF asft300_allotment_chk() THEN
                  CALL s_transaction_begin()
                  IF asft300_allotment_del() THEN
                     CALL s_transaction_end('Y','0')
                  ELSE
                     CALL s_transaction_end('N','0')
                  END IF
               END IF
               CALL asft300_b_fill()
               #160708-00014-e
            END IF
            
         #委外採購
         ON ACTION sub_po
            LET g_action_choice="sub_po"
            IF cl_auth_chk_act("sub_po") THEN
               IF NOT cl_null(g_sfaa_m.sfaadocno) THEN
                  CALL asft300_sub_po()
               END IF
            END IF
         
         #產生製程
         ON ACTION gen_routing
            LET g_action_choice="gen_routing"
            IF cl_auth_chk_act("gen_routing") THEN
               IF g_sfaa_m.sfaastus = 'N' AND NOT cl_null(g_sfaa_m.sfaadocno) THEN
                  LET l_n = 0
                  SELECT COUNT(1) INTO l_n
                    FROM sfca_t
                   WHERE sfcaent = g_enterprise
                     AND sfcasite = g_site
                     AND sfcadocno = g_sfaa_m.sfaadocno
                  CALL s_transaction_begin()
                  LET l_success = TRUE
                  IF l_n > 0 THEN
                     IF cl_ask_confirm('asf-00113') THEN
                        DELETE FROM sfca_t WHERE sfcaent=g_enterprise AND sfcasite=g_site AND sfcadocno=g_sfaa_m.sfaadocno
                        DELETE FROM sfcb_t WHERE sfcbent=g_enterprise AND sfcbsite=g_site AND sfcbdocno=g_sfaa_m.sfaadocno
                        DELETE FROM sfcc_t WHERE sfccent=g_enterprise AND sfccsite=g_site AND sfccdocno=g_sfaa_m.sfaadocno
                        DELETE FROM sfcd_t WHERE sfcdent=g_enterprise AND sfcdsite=g_site AND sfcddocno=g_sfaa_m.sfaadocno
                        CALL s_asft300_08(g_sfaa_m.sfaadocno,g_sfaa_m.sfaa010,g_sfaa_m.sfaa016) RETURNING l_success
                     END IF
                  ELSE
                     CALL s_asft300_08(g_sfaa_m.sfaadocno,g_sfaa_m.sfaa010,g_sfaa_m.sfaa016) RETURNING l_success
                  END IF
                  IF l_success THEN
                     CALL s_transaction_end('Y','0')
                     CALL cl_ask_confirm3("asf-00112","")
                  ELSE
                     CALL s_transaction_end('N','0')
                  END IF
               END IF
            END IF

         #製程
         ON ACTION routing
            LET g_action_choice="routing"
            IF cl_auth_chk_act("routing") THEN
               LET la_param.prog = "asft301"
               LET la_param.param[1] = g_sfaa_m.sfaadocno
               LET la_param.param[2] = 0
               LET ls_js = util.JSON.stringify(la_param)
               CALL cl_cmdrun(ls_js)
               #CALL cl_cmdrun("asft301 '"||g_sfaa_m.sfaadocno||"' "||0)
            END IF
            
         #多訂單產生
         ON ACTION po_gen
            LET g_action_choice="po_gen"
            IF cl_auth_chk_act("po_gen") THEN
               IF g_sfaa_m.sfaa005 = '1' AND NOT cl_null(g_sfaa_m.sfaadocno) AND g_sfaa_m.sfaastus = 'N' THEN
                  LET l_n = 0
                  SELECT COUNT(1) INTO l_n
                    FROM sfba_t
                   WHERE sfbaent = g_enterprise
                     AND sfbasite = g_site
                     AND sfbadocno = g_sfaa_m.sfaadocno
                  IF l_n > 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'asf-00329'
                     LET g_errparam.extend = g_sfaa_m.sfaadocno
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                  ELSE
                     CALL asft300_01(g_sfaa_m.sfaadocno)
                  END IF
               END IF
            END IF
            
         #取替代
         ON ACTION replace
            LET g_action_choice="replace"
            IF cl_auth_chk_act("replace") THEN
               IF g_sfaa_m.sfaastus MATCHES '[NYF]' AND NOT cl_null(g_sfaa_m.sfaadocno) THEN
                  CALL asft300_02(g_sfaa_m.sfaadocno)
                  CALL asft300_b_fill()
               END IF
            END IF
         
         #SET取替代
         ON ACTION replace_set
            LET g_action_choice="replace_set"
            IF cl_auth_chk_act("replace_set") THEN
               IF g_sfaa_m.sfaastus MATCHES '[NYF]' AND NOT cl_null(g_sfaa_m.sfaadocno) THEN
                  CALL asft300_03(g_sfaa_m.sfaadocno)
                  CALL asft300_b_fill()
               END IF
            END IF
         
         #備至
         ON ACTION open_asft300_05
            LET g_action_choice="open_asft300_05"
            IF cl_auth_chk_act("open_asft300_05") THEN
               LET l_n = 0
               SELECT COUNT(1) INTO l_n FROM sfba_t
                WHERE sfbaent=g_enterprise AND sfbasite=g_site AND sfbadocno=g_sfaa_m.sfaadocno
                  AND EXISTS (SELECT 1 FROM imaf_t WHERE imafent=sfbaent AND imafsite=sfbasite AND imaf001=sfba006 AND imaf058 IN ('1','2'))
               IF l_n = 0 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'asf-00805'
                  LET g_errparam.extend = g_sfaa_m.sfaadocno
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
               ELSE
                  CALL asft300_05(g_sfaa_m.sfaadocno)
                  #170308-00049#1--add--start--
                  SELECT COUNT(1) INTO l_n FROM sfbb_t 
                   WHERE sfbbent=g_enterprise 
                     AND sfbbsite=g_site 
                     AND sfbbdocno=g_sfaa_m.sfaadocno
                     AND sfbb008<>0
                   IF (l_n = 0 AND g_sfaa_m.sfaa043 = 'Y') OR (l_n > 0 AND g_sfaa_m.sfaa043 = 'N') THEN
                      IF g_sfaa_m.sfaa043 = 'Y' THEN
                         LET g_sfaa_m.sfaa043 = 'N' 
                      ELSE
                         LET g_sfaa_m.sfaa043 = 'Y'   
                      END IF
                      UPDATE sfaa_t SET sfaa043 = g_sfaa_m.sfaa043  
                       WHERE sfaaent = g_enterprise
                         AND sfaadocno = g_sfaa_m.sfaadocno
                      DISPLAY BY NAME g_sfaa_m.sfaa043   
                   END IF
                  #170308-00049#1--add--end----
               END IF
            END IF
         
         #拆建工單料件明細產生
         #150730 by wuxja add  --begin--
         ON ACTION open_asft300_07
            LET g_action_choice="open_asft300_07"
            IF cl_auth_chk_act("open_asft300_07") THEN
               IF g_sfaa_m.sfaastus = 'N' AND g_sfaa_m.sfaa003 = '3' THEN
                  IF asft300_sfaa010_feature() THEN
                     #拆件式判断是否是直接录入生产料号明细资料
                     IF asft300_07(g_sfaa_m.sfaadocno,g_inam) = '1' THEN
                        CALL asft300_input('u')
                     END IF
                     CALL asft300_b_fill_sfac()
                  END IF
               END IF
            END IF
         #150730 by wuxja add  --end--
        
         ON ACTION prog_ainq100
            LET g_action_choice="prog_ainq100"
            IF cl_auth_chk_act("prog_ainq100") THEN
               #2015/09/08 by stellar modify ----- (S)
               #使用JSON格式組合參數與作業編號(串查)
#               INITIALIZE la_param.* TO NULL
#               LET la_param.prog     = 'ainq100'
#               LET la_param.param[1] = '2'
#               LET la_param.param[2] = g_sfaa_m.sfaadocno
#               LET ls_js = util.JSON.stringify(la_param)
#               CALL cl_cmdrun_wait(ls_js)    
               MENU "" ATTRIBUTES(STYLE="popup")
                  ON ACTION open_ainq100
                     INITIALIZE la_param.* TO NULL
                     LET la_param.prog     = 'ainq100'
                     LET la_param.param[1] = '2'
                     LET la_param.param[2] = g_sfaa_m.sfaadocno
                     LET ls_js = util.JSON.stringify(la_param)
                     CALL cl_cmdrun_wait(ls_js)   
                  ON ACTION open_asfq007
                     INITIALIZE la_param.* TO NULL
                     LET la_param.prog     = 'asfq007'
                     LET la_param.param[1] = g_sfaa_m.sfaadocno
                     LET ls_js = util.JSON.stringify(la_param)
                     CALL cl_cmdrun_wait(ls_js)  
               END MENU
               #2015/09/08 by stellar modify ----- (E)
            END IF
         
         #160727-00025#1-s
         #追加備料
         ON ACTION add_allotment
            LET g_action_choice="add_allotment"
            IF cl_auth_chk_act("add_allotment") THEN
               IF NOT cl_null(g_sfaa_m.sfaadocno) THEN
                  LET l_n = 0
                  SELECT COUNT(1) INTO l_n FROM sfka_t WHERE sfkaent = g_enterprise AND sfkadocno = g_sfaa_m.sfaadocno AND sfkastus = 'N'
                  IF l_n > 0 THEN
                     #存在未確認的工單變更單，直接開啟變更單作業
                     SELECT MAX(sfka900) INTO l_sfka900 FROM sfka_t WHERE sfkaent = g_enterprise AND sfkadocno = g_sfaa_m.sfaadocno AND sfkastus = 'N'
                     LET la_param.prog = 'asft804'
                     LET la_param.param[1] = g_sfaa_m.sfaadocno
                     LET la_param.param[2] = l_sfka900
                     LET ls_js = util.JSON.stringify( la_param )
                     CALL cl_cmdrun(ls_js) 
                  ELSE
                     CALL s_transaction_begin()
                     IF asft300_add_allotment() THEN
                        CALL s_transaction_end('Y','0')
                        #存在未確認的工單變更單，直接開啟變更單作業
                        LET la_param.prog = 'asft804'
                        LET la_param.param[1] = g_sfaa_m.sfaadocno
                        LET la_param.param[2] = g_sfka900
                        LET ls_js = util.JSON.stringify( la_param )
                        CALL cl_cmdrun(ls_js) 
                        LET g_sfka900 = ''
                     ELSE
                        CALL s_transaction_end('N','0')
                     END IF
                  END IF
               END IF
            END IF
         #161031-00025#17-s   
         ON ACTION open_demo
            LET g_action_choice="open_demo"
            IF cl_auth_chk_act("open_demo") THEN                                      
               IF NOT cl_null(g_sfaa_m.sfaadocno) THEN
                  CALL asft300_remaks()
               END IF          
            END IF
         #161031-00025#17-e            
         #轉請購單
         ON ACTION gen_apmt400
            LET g_action_choice="gen_apmt400"
            IF cl_auth_chk_act("gen_apmt400") THEN
               IF NOT cl_null(g_sfaa_m.sfaadocno) THEN
                  CALL cl_err_collect_init() 
                  CALL asft300_gen_apmt400()
                  CALL cl_err_collect_show()
               END IF
            END IF
         
         #轉採購單
         ON ACTION gen_apmt500
            LET g_action_choice="gen_apmt500"
            IF cl_auth_chk_act("gen_apmt500") THEN
               IF NOT cl_null(g_sfaa_m.sfaadocno) THEN
                  CALL cl_err_collect_init() 
                  CALL asft300_gen_apmt500()
                  CALL cl_err_collect_show()
               END IF
            END IF
         
         #160727-00025#1-e

         #新增相關文件
         ON ACTION related_document
            CALL asft300_set_pk_array()
            IF cl_auth_chk_act("related_document") THEN
               #add-point:ON ACTION related_document name="ui_dialog.dialog.related_document"

               #END add-point
               CALL cl_doc()
            END IF
            
         ON ACTION agendum
            CALL asft300_set_pk_array()
            #add-point:ON ACTION agendum name="ui_dialog.dialog.agendum"

            #END add-point
            CALL cl_user_overview()
            CALL cl_user_overview_set_follow_pic()
         
         ON ACTION followup
            CALL asft300_set_pk_array()
            #add-point:ON ACTION followup name="ui_dialog.dialog.followup"

            #END add-point
            CALL cl_user_overview_follow(g_sfaa_m.sfaadocdt)
#         ON ACTION change_page      #161206-00018 add    #FUN-pagetest mark          
         #170103-00054#1-s remark
         #主選單用ACTION                               #FUN-pagetest mark    
         &include "main_menu_exit_dialog.4gl"   #FUN-pagetest mark    
         &include "relating_action.4gl"        #FUN-pagetest mark    
         
         #交談指令共用ACTION                  #FUN-pagetest mark    
         &include "common_action.4gl"      #FUN-pagetest mark
         #170103-00054#1-e remark
            CONTINUE DIALOG
      END DIALOG
      
      IF g_action_choice = "exit" AND NOT cl_null(g_action_choice) THEN
         #add-point:ui_dialog段離開dialog前 name="ui_dialog.b_exit"

         #end add-point
         EXIT WHILE
      END IF
   
   END WHILE
   
   CALL cl_set_act_visible("accept,cancel", TRUE)

END FUNCTION

################################################################################
# Descriptions...: 瀏覽頁簽資料填充
# Memo...........:
# Usage..........: CALL asft300_browser_fill(ps_page_action)
# Input parameter: ps_page_action
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_browser_fill(ps_page_action)
   #add-point:browser_fill段define(客製用) name="browser_fill.define_customerization"

   #end add-point  
   DEFINE ps_page_action    STRING
   DEFINE l_wc              STRING
   DEFINE l_wc2             STRING
   DEFINE l_sql             STRING
   DEFINE l_sub_sql         STRING
   DEFINE l_sql_rank        STRING
   #add-point:browser_fill段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="browser_fill.define"
   DEFINE l_success         LIKE type_t.num5
   DEFINE l_slip            STRING
   #end add-point    
   
   #add-point:Function前置處理 name="browser_fill.before_browser_fill"
   #161031-00025#17-s
   IF cl_null(g_add_browse) THEN
      CALL aooi360_01_clear_detail()   #清除备注单身
   END IF
   #161031-00025#17-e
   #end add-point
   
   IF cl_null(g_wc) THEN
      LET g_wc = " 1=1"
   END IF
   
   
   IF cl_null(g_wc2) THEN
      LET g_wc2 = " 1=1"
   END IF
   LET l_wc  = g_wc.trim() 
   LET l_wc2 = g_wc2.trim()
 
   #add-point:browser_fill,foreach前 name="browser_fill.before_foreach"
   #160727-00025#1-s
   CASE g_argv[01]
      WHEN "4"   #模具工單
         LET l_wc = l_wc," AND sfaa003 = '5'"
      OTHERWISE   #其他工單
         LET l_wc = l_wc," AND sfaa003 <> '5'"
   END CASE      
   #160727-00025#1-e
   #end add-point
   
#mod 150717  ---begin---
#   IF g_wc2 <> " 1=1" THEN
#      #單身有輸入搜尋條件                      
#      LET l_sub_sql = " SELECT DISTINCT sfaadocno ",
#                      " FROM sfaa_t ",
#                      " LEFT JOIN sfba_t ON sfbaent = sfaaent AND sfbasite = sfaasite AND sfbadocno = sfaadocno ",
#                      " LEFT JOIN sfab_t ON sfabent = sfaaent AND sfabsite = sfaasite AND sfabdocno = sfaadocno ",
#                      " LEFT JOIN sfac_t ON sfacent = sfaaent AND sfacsite = sfaasite AND sfacdocno = sfaadocno ",
#                      " LEFT JOIN sfaf_t ON sfafent = sfaaent AND sfafsite = sfaasite AND sfafdocno = sfaadocno ",
#                      " LEFT JOIN ooff_t ON ooffent = sfaaent AND ooff002   = sfaadocno AND ooff001 = '6' AND ooff012 = '2'",
#                      " WHERE sfaaent = '" ||g_enterprise|| "' AND sfaasite = '" ||g_site|| "' AND ",l_wc, " AND ", l_wc2, cl_sql_add_filter("sfaa_t")
#   ELSE
#      #單身未輸入搜尋條件
#      LET l_sub_sql = " SELECT DISTINCT sfaadocno ",
#                      " FROM sfaa_t ", 
#                      " LEFT JOIN sfab_t ON sfabent = sfaaent AND sfabsite = sfaasite AND sfabdocno = sfaadocno ",
#                      " LEFT JOIN sfac_t ON sfacent = sfaaent AND sfacsite = sfaasite AND sfacdocno = sfaadocno ",
#                      " LEFT JOIN sfaf_t ON sfafent = sfaaent AND sfafsite = sfaasite AND sfafdocno = sfaadocno ",
#                      " LEFT JOIN ooff_t ON ooffent = sfaaent AND ooff002   = sfaadocno AND ooff001 = '6' AND ooff012 = '2'",
#                      " WHERE sfaaent = '" ||g_enterprise|| "' AND sfaasite = '" ||g_site|| "' AND ",l_wc CLIPPED, cl_sql_add_filter("sfaa_t")
#   END IF
   #add-point:browser_fill,cnt wc name="browser_fill.cnt_sqlwc"
   LET l_sub_sql = " SELECT DISTINCT sfaadocno FROM sfaa_t "
   IF l_wc.getindexof('sfab',1) > 0 THEN
      LET l_sub_sql = l_sub_sql," LEFT JOIN sfab_t ON sfabent = sfaaent AND sfabsite = sfaasite AND sfabdocno = sfaadocno "
   END IF
   IF l_wc.getindexof('sfac',1) > 0 THEN
      LET l_sub_sql = l_sub_sql," LEFT JOIN sfac_t ON sfacent = sfaaent AND sfacsite = sfaasite AND sfacdocno = sfaadocno "
   END IF
   IF l_wc.getindexof('sfaf',1) > 0 THEN
      LET l_sub_sql = l_sub_sql," LEFT JOIN sfaf_t ON sfafent = sfaaent AND sfafsite = sfaasite AND sfafdocno = sfaadocno "
   END IF
   #161031-00025#17-s  mark
#   IF l_wc.getindexof('ooff',1) > 0 THEN 
#      LET l_sub_sql = l_sub_sql," LEFT JOIN ooff_t ON ooffent = sfaaent AND ooff002  = sfaadocno AND ooff001 = '6' AND ooff012 = '2'"
#   END IF   
   #161031-00025#17-e  mark                            
   IF g_wc2 <> " 1=1" THEN
      LET l_sub_sql = l_sub_sql," LEFT JOIN sfba_t ON sfbaent = sfaaent AND sfbasite = sfaasite AND sfbadocno = sfaadocno "
      #161031-00025#17-s
      LET l_sub_sql = l_sub_sql," LEFT JOIN ooff_t  ON ooffent = sfaaent AND ooff001 = '7' 
                                  AND ooff002 = '",g_prog,"' AND sfaadocno = ooff003 AND ooff004 = sfbaseq AND ooff005 = TO_CHAR(sfbaseq1) "                        
      #161031-00025#17-e 
      LET l_sub_sql = l_sub_sql," WHERE sfaaent = '" ||g_enterprise|| "' AND sfaasite = '" ||g_site|| "' AND ",l_wc, " AND ", l_wc2 , cl_sql_add_filter("sfaa_t")
   ELSE
      LET l_sub_sql = l_sub_sql," WHERE sfaaent = '" ||g_enterprise|| "' AND sfaasite = '" ||g_site|| "' AND ",l_wc CLIPPED, cl_sql_add_filter("sfaa_t")
   END IF
   #161031-00025#17-s
   IF NOT cl_null(g_wc2_i36001) AND g_wc2_i36001 <> " 1=1" THEN
   LET l_sub_sql = l_sub_sql CLIPPED, " AND EXISTS (SELECT ooff003 FROM ooff_t 
                                                     WHERE ooffent = ",g_enterprise," AND ooff001 = '6' 
                                                       AND ooff002 = '",g_prog,"' AND ooff003 = sfaadocno
                                                       AND ooff004 = '0' AND ",g_wc2_i36001 CLIPPED ,")" 
   END IF                                                    
   #161031-00025#17-e
#mod 150717   ---end---
   #end add-point
   
   LET g_sql = " SELECT COUNT(1) FROM (",l_sub_sql,")"
   
   #add-point:browser_fill,count前 name="browser_fill.before_count"

   #end add-point
   
   IF g_sql.getIndexOf(" 1=2",1) THEN
      DISPLAY "INFO: 1=2 jumped!"
   ELSE
      PREPARE header_cnt_pre FROM g_sql
      EXECUTE header_cnt_pre INTO g_browser_cnt   #總筆數
      FREE header_cnt_pre
   END IF
    
   IF g_browser_cnt > g_max_browse THEN
      IF g_error_show = 1 THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = g_browser_cnt
         LET g_errparam.code   = 9035 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
      END IF
      LET g_browser_cnt = g_max_browse
   END IF
   
   DISPLAY g_browser_cnt TO FORMONLY.b_count   #總筆數的顯示
   DISPLAY g_browser_cnt TO FORMONLY.h_count   #總筆數的顯示
 
   #根據行為確定資料填充位置及WC
   IF cl_null(g_add_browse) THEN
      #清除畫面
      CLEAR FORM                
      INITIALIZE g_sfaa_m.* TO NULL
      INITIALIZE g_sfai_m.* TO NULL  #160727-00025#1
      CALL g_sfba_d.clear()
      CALL g_sfab_d.clear()
      CALL g_sfac_d.clear()
      CALL g_sfaf_d.clear()
 
      #add-point:browser_fill g_add_browse段額外處理 name="browser_fill.add_browse.other"

      #end add-point   
      CALL g_browser.clear()
      LET g_cnt = 1
   ELSE
      LET l_wc  = g_add_browse
      LET l_wc2 = " 1=1" 
      LET g_cnt = g_current_idx
   END IF
 
   #依照t0.* Browser欄位定義(取代原本bs_sql功能)
   #考量到單身可能下條件, 所以此處需join單身所有table
   #DISTINCT是為了避免在join時出現重複的資料(如果不加DISTINCT則須在程式中過濾)
#mod 150717   ---begin---
#   IF g_wc2 <> " 1=1" THEN
#      #單身有輸入搜尋條件   
#      LET g_sql = " SELECT DISTINCT t0.sfaastus,t0.sfaadocno,t0.sfaa001,t0.sfaadocdt,t0.sfaa002,t1.ooag011 ,
#                                    t0.sfaa003,t0.sfaa057,t0.sfaa004,t0.sfaa010,t2.imaal003,t2.imaal004,t0.sfaa012 ",
#                  " FROM sfaa_t t0",
#                  " LEFT JOIN sfba_t ON sfbaent = t0.sfaaent AND sfbasite = t0.sfaasite AND sfbadocno = t0.sfaadocno ",
#                  " LEFT JOIN sfab_t ON sfabent = t0.sfaaent AND sfabsite = t0.sfaasite AND sfabdocno = t0.sfaadocno ",
#                  " LEFT JOIN sfac_t ON sfacent = t0.sfaaent AND sfacsite = t0.sfaasite AND sfacdocno = t0.sfaadocno ",
#                  " LEFT JOIN sfaf_t ON sfafent = t0.sfaaent AND sfafsite = t0.sfaasite AND sfafdocno = t0.sfaadocno ",
#                  " LEFT JOIN ooff_t ON ooffent = t0.sfaaent AND ooff002  = t0.sfaadocno AND ooff001 = '6' AND ooff012 = '2'",
#                  " LEFT JOIN ooag_t t1 ON t1.ooagent='"||g_enterprise||"' AND t1.ooag001=t0.sfaa002  ",
#                  " LEFT JOIN imaal_t t2 ON t2.imaalent='"||g_enterprise||"' AND t2.imaal001=t0.sfaa010 AND t2.imaal002='"||g_dlang||"' ",
#                  " WHERE t0.sfaaent = '" ||g_enterprise|| "' AND t0.sfaasite = '" ||g_site|| "' AND ",l_wc," AND ",l_wc2, cl_sql_add_filter("sfaa_t")
#   ELSE
#      #單身無輸入搜尋條件   
#      LET g_sql = " SELECT DISTINCT t0.sfaastus,t0.sfaadocno,t0.sfaa001,t0.sfaadocdt,t0.sfaa002,t1.ooag011 ,
#                                    t0.sfaa003,t0.sfaa057,t0.sfaa004,t0.sfaa010,t2.imaal003,t2.imaal004,t0.sfaa012 ",
#                  " FROM sfaa_t t0",
#                  " LEFT JOIN sfab_t ON sfabent = t0.sfaaent AND sfabsite = t0.sfaasite AND sfabdocno = t0.sfaadocno ",
#                  " LEFT JOIN sfac_t ON sfacent = t0.sfaaent AND sfacsite = t0.sfaasite AND sfacdocno = t0.sfaadocno ",
#                  " LEFT JOIN sfaf_t ON sfafent = t0.sfaaent AND sfafsite = t0.sfaasite AND sfafdocno = t0.sfaadocno ",
#                  " LEFT JOIN ooff_t ON ooffent = t0.sfaaent AND ooff002  = t0.sfaadocno AND ooff001 = '6' AND ooff012 = '2'",
#                  " LEFT JOIN ooag_t t1 ON t1.ooagent='"||g_enterprise||"' AND t1.ooag001=t0.sfaa002  ",
#                  " LEFT JOIN imaal_t t2 ON t2.imaalent='"||g_enterprise||"' AND t2.imaal001=t0.sfaa010 AND t2.imaal002='"||g_dlang||"' ",
#                  " WHERE t0.sfaaent = '" ||g_enterprise|| "' AND t0.sfaasite = '" ||g_site|| "' AND ",l_wc, cl_sql_add_filter("sfaa_t")
#   END IF
   #add-point:browser_fill,sql wc name="browser_fill.fill_sqlwc"
   LET g_sql = " SELECT DISTINCT t0.sfaastus,t0.sfaadocno,t0.sfaa001,t0.sfaadocdt,t0.sfaa002,t1.ooag011 ,
                                 t0.sfaa003,t0.sfaa057,t0.sfaa004,t0.sfaa010,t2.imaal003,t2.imaal004,t0.sfaa012 ",
               " FROM sfaa_t t0",
               " LEFT JOIN ooag_t t1 ON t1.ooagent='"||g_enterprise||"' AND t1.ooag001=t0.sfaa002  ",
               " LEFT JOIN imaal_t t2 ON t2.imaalent='"||g_enterprise||"' AND t2.imaal001=t0.sfaa010 AND t2.imaal002='"||g_dlang||"' "
   IF l_wc.getindexof('sfab',1)>0 THEN
      LET g_sql = g_sql," LEFT JOIN sfab_t ON sfabent = t0.sfaaent AND sfabsite = t0.sfaasite AND sfabdocno = t0.sfaadocno "
   END IF
   IF l_wc.getindexof('sfac',1)>0 THEN
      LET g_sql = g_sql," LEFT JOIN sfac_t ON sfacent = t0.sfaaent AND sfacsite = t0.sfaasite AND sfacdocno = t0.sfaadocno "
   END IF
   IF l_wc.getindexof('sfaf',1)>0 THEN
      LET g_sql = g_sql," LEFT JOIN sfaf_t ON sfafent = t0.sfaaent AND sfafsite = t0.sfaasite AND sfafdocno = t0.sfaadocno "
   END IF
   #161031-00025#17-s  mark
#   IF l_wc.getindexof('ooff',1)>0 THEN 
#      LET g_sql = g_sql," LEFT JOIN ooff_t ON ooffent = t0.sfaaent AND ooff002  = t0.sfaadocno AND ooff001 = '6' AND ooff012 = '2'"
#   END IF    
   #161031-00025#17-e  mark 
   IF g_wc2 <> " 1=1" THEN
      LET g_sql = g_sql," LEFT JOIN sfba_t ON sfbaent = t0.sfaaent AND sfbasite = t0.sfaasite AND sfbadocno = t0.sfaadocno "
      #161031-00025#17-s
      LET g_sql = g_sql," LEFT JOIN ooff_t  ON ooffent = sfaaent AND ooff001 = '7' 
                          AND ooff002 = '",g_prog,"' AND sfaadocno = ooff003  AND ooff004 = sfbaseq AND ooff005 = TO_CHAR(sfbaseq1) "                          
      #161031-00025#17-e
      LET g_sql = g_sql," WHERE t0.sfaaent = '" ||g_enterprise|| "' AND t0.sfaasite = '" ||g_site|| "' AND ",l_wc," AND ",l_wc2, cl_sql_add_filter("sfaa_t")
   ELSE
      LET g_sql = g_sql," WHERE t0.sfaaent = '" ||g_enterprise|| "' AND t0.sfaasite = '" ||g_site|| "' AND ",l_wc, cl_sql_add_filter("sfaa_t")
   END IF 
   #161031-00025#17-s
   IF NOT cl_null(g_wc2_i36001) AND g_wc2_i36001 <> " 1=1" THEN
   LET g_sql = g_sql CLIPPED, " AND EXISTS (SELECT ooff003 FROM ooff_t 
                                                     WHERE ooffent = ",g_enterprise," AND ooff001 = '6' 
                                                       AND ooff002 = '",g_prog,"' AND ooff003 = sfaadocno
                                                       AND ooff004 = '0' AND ",g_wc2_i36001 CLIPPED ,")" 
   END IF                                                    
   #161031-00025#17-e
#mod 150717   ---end--- 
   #end add-point
   LET g_sql = g_sql, " ORDER BY sfaadocno ",g_order
 
   #add-point:browser_fill,before_prepare name="browser_fill.before_prepare"

   #end add-point
        
   #LET g_sql = cl_sql_add_tabid(g_sql,"sfaa_t") #WC重組
   LET g_sql = cl_sql_add_mask(g_sql) #遮蔽特定資料
   
   IF g_sql.getIndexOf(" 1=2",1) THEN
      DISPLAY "INFO: 1=2 jumped!"
   ELSE
      PREPARE browse_pre FROM g_sql
      DECLARE browse_cur CURSOR FOR browse_pre
      
      #add-point:browser_fill段open cursor name="browser_fill.open"

      #end add-point
      
      FOREACH browse_cur INTO g_browser[g_cnt].b_statepic,g_browser[g_cnt].b_sfaadocno,
                              g_browser[g_cnt].b_sfaa001,g_browser[g_cnt].b_sfaadocdt,g_browser[g_cnt].b_sfaa002,
                              g_browser[g_cnt].b_sfaa002_desc,g_browser[g_cnt].b_sfaa003,g_browser[g_cnt].b_sfaa057,
                              g_browser[g_cnt].b_sfaa004,g_browser[g_cnt].b_sfaa010,g_browser[g_cnt].b_sfaa010_desc,
                              g_browser[g_cnt].b_sfaa010_desc_1,g_browser[g_cnt].b_sfaa012

         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "Foreach:",SQLERRMESSAGE 
            LET g_errparam.code   = SQLCA.sqlcode 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
            EXIT FOREACH
         END IF
      
         #add-point:browser_fill段reference name="browser_fill.reference"

         #end add-point
      
         #遮罩相關處理
#         CALL asft300_browser_mask()
      
               #應用 a24 樣板自動產生(Version:3)
      #browser顯示圖片
      CASE g_browser[g_cnt].b_statepic
         WHEN "A"
            LET g_browser[g_cnt].b_statepic = "stus/16/approved.png"
         WHEN "C"
            LET g_browser[g_cnt].b_statepic = "stus/16/closed.png"
         WHEN "D"
            LET g_browser[g_cnt].b_statepic = "stus/16/withdraw.png"
         WHEN "E"
            LET g_browser[g_cnt].b_statepic = "stus/16/closed_irregular.png"
         WHEN "F"
            LET g_browser[g_cnt].b_statepic = "stus/16/released.png"
         WHEN "M"
            LET g_browser[g_cnt].b_statepic = "stus/16/costing_closed.png"
         WHEN "N"
            LET g_browser[g_cnt].b_statepic = "stus/16/unconfirmed.png"
         WHEN "R"
            LET g_browser[g_cnt].b_statepic = "stus/16/rejection.png"
         WHEN "W"
            LET g_browser[g_cnt].b_statepic = "stus/16/signing.png"
         WHEN "Y"
            LET g_browser[g_cnt].b_statepic = "stus/16/confirmed.png"
         WHEN "X"
            LET g_browser[g_cnt].b_statepic = "stus/16/invalid.png"
         
      END CASE
 
      LET g_cnt = g_cnt + 1
      IF g_cnt > g_max_browse THEN
         EXIT FOREACH
      END IF
      
      END FOREACH
      FREE browse_pre
   END IF
   
   #清空g_add_browse, 並指定指標位置
   IF NOT cl_null(g_add_browse) THEN
      LET g_add_browse = ""
      CALL g_curr_diag.setCurrentRow("s_browse",g_current_idx)
   END IF
   
   IF cl_null(g_browser[g_cnt].b_sfaadocno) THEN
      CALL g_browser.deleteElement(g_cnt)
   END IF
   
   LET g_header_cnt  = g_browser.getLength()
   LET g_browser_cnt = g_browser.getLength()
   
   #筆數顯示
   IF g_browser_cnt > 0 THEN
      DISPLAY g_browser_idx TO FORMONLY.b_index #當下筆數
      DISPLAY g_browser_cnt TO FORMONLY.b_count #總筆數
      DISPLAY g_browser_idx TO FORMONLY.h_index #當下筆數
      DISPLAY g_browser_cnt TO FORMONLY.h_count #總筆數
      DISPLAY g_detail_idx  TO FORMONLY.idx     #單身當下筆數
      DISPLAY g_detail_cnt  TO FORMONLY.cnt     #單身總筆數
   ELSE
      DISPLAY '' TO FORMONLY.b_index #當下筆數
      DISPLAY '' TO FORMONLY.b_count #總筆數
      DISPLAY '' TO FORMONLY.h_index #當下筆數
      DISPLAY '' TO FORMONLY.h_count #總筆數
      DISPLAY '' TO FORMONLY.idx     #單身當下筆數
      DISPLAY '' TO FORMONLY.cnt     #單身總筆數
   END IF
 
   LET g_rec_b = g_cnt - 1
   LET g_detail_cnt = g_rec_b
   LET g_cnt = 0
 
   #若無資料則關閉相關功能
   IF g_browser_cnt = 0 THEN
      CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce,mainhidden", FALSE)
      CALL cl_navigator_setting(0,0)
   ELSE
      CALL cl_set_act_visible("mainhidden", TRUE)
   END IF
                  
   
   #add-point:browser_fill段結束前 name="browser_fill.after"

   #end add-point   

END FUNCTION

################################################################################
# Descriptions...: 單頭資料重新顯示
# Memo...........:
# Usage..........: CALL asft300_ui_headershow()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_ui_headershow()
   #add-point:ui_headershow段define(客製用) name="ui_headershow.define_customerization"

   #end add-point  
   #add-point:ui_headershow段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_headershow.define"
                  
   #end add-point      
   
   #add-point:Function前置處理  name="ui_headershow.pre_function"

   #end add-point
   
   LET g_sfaa_m.sfaadocno = g_browser[g_current_idx].b_sfaadocno   

   EXECUTE asft300_master_referesh USING g_sfaa_m.sfaadocno
      INTO g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.oobal004,g_sfaa_m.sfaadocdt,g_sfaa_m.sfaa002,
           g_sfaa_m.sfaa002_desc,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,
           g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,
           g_sfaa_m.sfaa009,g_sfaa_m.sfaa009_desc,g_sfaa_m.sfaa022,g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,
           g_sfaa_m.sfaa024,g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,
           g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1,g_sfaa_m.sfaa012,g_sfaa_m.sfaa013,g_sfaa_m.sfaa013_desc,
           g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa060_desc,g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,
           g_sfaa_m.sfaa016_desc,g_sfaa_m.sfaa017,g_sfaa_m.sfaa017_desc,g_sfaa_m.sfaa018,g_sfaa_m.sfaa018_desc,
           g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,g_sfaa_m.sfaa068_desc,g_sfaa_m.sfaa014,
           g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.imae020,g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,
           g_sfaa_m.sfaa028_desc,g_sfaa_m.sfaa029,g_sfaa_m.sfaa029_desc,g_sfaa_m.sfaa030,g_sfaa_m.sfaa030_desc,
           g_sfaa_m.sfaa031,g_sfaa_m.sfaa031_desc,g_sfaa_m.sfaa032,g_sfaa_m.sfaa033,g_sfaa_m.sfaa034,
           g_sfaa_m.sfaa034_desc,g_sfaa_m.sfaa035,g_sfaa_m.sfaa035_desc,g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,
           g_sfaa_m.sfaa037,g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,
           g_sfaa_m.sfaa041,g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,
           g_sfaa_m.sfaa070,g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,
           g_sfaa_m.sfaa065,g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,
           #g_sfaa_m.sfaa056,g_sfaa_m.ooff013,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,   #161031-00025#17 mark
           g_sfaa_m.sfaa056,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,                     #161031-00025#17 add
           g_sfaa_m.sfaaowndp_desc,g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtid_desc,g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdp_desc,
           g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,g_sfaa_m.sfaamodid_desc,g_sfaa_m.sfaamoddt,g_sfaa_m.sfaacnfid,
           g_sfaa_m.sfaacnfid_desc,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,g_sfaa_m.sfaapstid_desc,g_sfaa_m.sfaapstdt
   
#   CALL asft300_sfaa_t_mask()
   CALL asft300_show()

END FUNCTION

################################################################################
# Descriptions...: 單身資料重新顯示
# Memo...........:
# Usage..........: CALL asft300_ui_detailshow()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_ui_detailshow()
   #add-point:ui_detailshow段define(客製用) name="ui_detailshow.define_customerization"

   #end add-point
   #add-point:ui_detailshow段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_detailshow.define"

   #end add-point

   #add-point:Function前置處理 name="ui_detailshow.before"

   #end add-point
   
   IF g_curr_diag IS NOT NULL THEN
      CALL g_curr_diag.setCurrentRow("s_detail1",g_detail_idx)      
      CALL g_curr_diag.setCurrentRow("s_sfab",g_detail_idx)
      CALL g_curr_diag.setCurrentRow("s_sfac",g_detail_idx)
      CALL g_curr_diag.setCurrentRow("s_sfaf",g_detail_idx)
 
   END IF
   
   #add-point:ui_detailshow段after name="ui_detailshow.after"
                  
   #end add-point
   
END FUNCTION

################################################################################
# Descriptions...: 瀏覽頁簽資料重新顯示
# Memo...........:
# Usage..........: CALL asft300_ui_browser_refresh()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_ui_browser_refresh()
   #add-point:ui_browser_refresh段define(客製用) name="ui_browser_refresh.define_customerization"

   #end add-point
   DEFINE l_i  LIKE type_t.num10
   #add-point:ui_browser_refresh段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="ui_browser_refresh.define"

   #end add-point

   #add-point:Function前置處理  name="ui_browser_refresh.pre_function"

   #end add-point
   
   LET g_browser_cnt = g_browser.getLength()
   LET g_header_cnt  = g_browser.getLength()
   FOR l_i =1 TO g_browser.getLength()
      IF g_browser[l_i].b_sfaadocno = g_sfaa_m.sfaadocno THEN
         CALL g_browser.deleteElement(l_i)
         EXIT FOR
      END IF
   END FOR
   LET g_browser_cnt = g_browser_cnt - 1
   LET g_header_cnt = g_header_cnt - 1
    
   #若無資料則關閉相關功能
   IF g_browser_cnt = 0 THEN
      CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce,mainhidden", FALSE)
      CALL cl_navigator_setting(0,0)
      CLEAR FORM
   ELSE
      CALL cl_set_act_visible("mainhidden", TRUE)
   END IF
   
   #add-point:ui_browser_refresh段after name="ui_browser_refresh.after"

   #end add-point    

END FUNCTION

################################################################################
# Descriptions...: QBE資料查詢
# Memo...........:
# Usage..........: CALL asft300_construct()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_construct()
   #add-point:cs段define(客製用) name="cs.define_customerization"

   #end add-point    
   DEFINE ls_return   STRING
   DEFINE ls_result   STRING 
   DEFINE ls_wc       STRING 
   DEFINE la_wc       DYNAMIC ARRAY OF RECORD
          tableid     STRING,
          wc          STRING
          END RECORD
   DEFINE li_idx      LIKE type_t.num10
   #add-point:cs段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="cs.define"

   #end add-point    
   
   #add-point:Function前置處理  name="cs.pre_function"
   CALL aooi360_01_clear_detail()   #清除备注单身  #161031-00025#17
   #end add-point
    
   #清除畫面
   CLEAR FORM                
   INITIALIZE g_sfaa_m.* TO NULL
   INITIALIZE g_sfai_m.* TO NULL  #160727-00025#1
   CALL g_sfba_d.clear()
   CALL g_sfab_d.clear()
   CALL g_sfac_d.clear()
   CALL g_sfaf_d.clear()
   
   LET g_action_choice = ""
   
   INITIALIZE g_wc TO NULL
   INITIALIZE g_wc2 TO NULL
   INITIALIZE g_wc2_table1 TO NULL
   INITIALIZE g_wc_sfab TO NULL
   INITIALIZE g_wc_sfac TO NULL
   INITIALIZE g_wc_sfaf TO NULL
   INITIALIZE g_wc_seq  TO NULL   #170124-00005#1

   LET g_qryparam.state = 'c'
   
   #add-point:cs段開始前 name="cs.before_construct"

   #end add-point
   
   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
      
      #單頭
      CONSTRUCT BY NAME g_wc ON sfaadocno,sfaa001,sfaadocdt,sfaa002,sfaa003,sfaa057,sfaa004,sfaastus,sfaa005,sfaa007,
                                sfaa008,sfaa063,sfaa006,sfaa009,sfaa022,sfaa021,sfaa023,sfaa024,sfaa064,sfaa025,
                                sfaa010,sfaa011,sfaa012,sfaa013,sfaa058,sfaa060,sfaa061,sfaa016,sfaa017,sfaa018,
                                sfaa019,sfaa020,sfaa068,sfaa014,sfaa015,sfaa026,sfaa062,sfaa028,sfaa029,sfaa030,
                                sfaa031,sfaa032,sfaa033,sfaa034,sfaa035,sfaa059,sfaa036,sfaa037,sfaa038,sfaa072,
                                sfaa039,sfaa040,sfaa041,sfaa042,sfaa043,sfaa044,sfaa069,sfaa070,sfaa045,sfaa046,
                                sfaa047,sfaa048,sfaa065,sfaa049,sfaa050,sfaa051,sfaa055,sfaa056,sfaaownid,sfaaowndp,
                                sfaacrtid,sfaacrtdp,sfaacrtdt,sfaamodid,sfaamoddt,sfaacnfid,sfaacnfdt,sfaapstid,sfaapstdt

         BEFORE CONSTRUCT
            #add-point:cs段before_construct name="cs.head.before_construct"
            #160727-00025#1-s
            #模具工单
            IF g_argv[01] = '4' THEN
               DISPLAY '5' TO sfaa003
            END IF
            #160727-00025#1-e                                                            
            #end add-point 
            
         #公用欄位開窗相關處理
         #應用 a11 樣板自動產生(Version:3)
         #共用欄位查詢處理  
         ##----<<sfaacrtdt>>----
         AFTER FIELD sfaacrtdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
         
         #----<<sfaamoddt>>----
         AFTER FIELD sfaamoddt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
         
         #----<<sfaacnfdt>>----
         AFTER FIELD sfaacnfdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)
         
         #----<<sfaapstdt>>----
         AFTER FIELD sfaapstdt
            CALL FGL_DIALOG_GETBUFFER() RETURNING ls_result
            IF NOT cl_null(ls_result) THEN
               IF NOT cl_chk_date_symbol(ls_result) THEN
                  LET ls_result = cl_add_date_extra_cond(ls_result)
               END IF
            END IF
            CALL FGL_DIALOG_SETBUFFER(ls_result)

         #一般欄位開窗相關處理
         #---------------------------<  Master  >---------------------------

         #Ctrlp:construct.c.sfaadocno
         ON ACTION controlp INFIELD sfaadocno
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfaasite = '",g_site,"' "
            CALL q_sfaadocno_1()
            DISPLAY g_qryparam.return1 TO sfaadocno
            NEXT FIELD sfaadocno

         #Ctrlp:construct.c.sfaa002
         ON ACTION controlp INFIELD sfaa002
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()
            DISPLAY g_qryparam.return1 TO sfaa002
            NEXT FIELD sfaa002

         #Ctrlp:construct.c.sfaa007
         ON ACTION controlp INFIELD sfaa007
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfaasite = '",g_site,"' "
            CALL q_sfaa006()
            DISPLAY g_qryparam.return1 TO sfaa006
            DISPLAY g_qryparam.return2 TO sfaa007
            DISPLAY g_qryparam.return3 TO sfaa008
            DISPLAY g_qryparam.return4 TO sfaa063
            NEXT FIELD sfaa007

         #Ctrlp:construct.c.sfaa008
         ON ACTION controlp INFIELD sfaa008
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfaasite = '",g_site,"' "
            CALL q_sfaa006()
            DISPLAY g_qryparam.return1 TO sfaa006
            DISPLAY g_qryparam.return2 TO sfaa007
            DISPLAY g_qryparam.return3 TO sfaa008
            DISPLAY g_qryparam.return4 TO sfaa063
            NEXT FIELD sfaa008

         #Ctrlp:construct.c.sfaa063
         ON ACTION controlp INFIELD sfaa063
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfaasite = '",g_site,"' "
            CALL q_sfaa006()
            DISPLAY g_qryparam.return1 TO sfaa006
            DISPLAY g_qryparam.return2 TO sfaa007
            DISPLAY g_qryparam.return3 TO sfaa008
            DISPLAY g_qryparam.return4 TO sfaa063
            NEXT FIELD sfaa063

         #Ctrlp:construct.c.sfaa006
         ON ACTION controlp INFIELD sfaa006
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			   LET g_qryparam.where = " sfaasite = '",g_site,"'"
            CALL q_sfaa006()
            DISPLAY g_qryparam.return1 TO sfaa006
            DISPLAY g_qryparam.return2 TO sfaa007
            DISPLAY g_qryparam.return3 TO sfaa008
            DISPLAY g_qryparam.return4 TO sfaa063
            NEXT FIELD sfaa006

         #Ctrlp:construct.c.sfaa009
         ON ACTION controlp INFIELD sfaa009
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
			   LET g_qryparam.arg1 = g_site
			   #160905-00025#1-s-mod
#            CALL q_pmaa001_6()
            CALL q_pmaa001_29()
            #160905-00025#1-e-mod
            DISPLAY g_qryparam.return1 TO sfaa009
            NEXT FIELD sfaa009

         #Ctrlp:construct.c.sfaa022
         ON ACTION controlp INFIELD sfaa022
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfaasite = '",g_site,"' "
            CALL q_sfaa022()
            DISPLAY g_qryparam.return1 TO sfaa022
            DISPLAY g_qryparam.return2 TO sfaa023
            DISPLAY g_qryparam.return3 TO sfaa024
            DISPLAY g_qryparam.return4 TO sfaa064
            NEXT FIELD sfaa022

         #Ctrlp:construct.c.sfaa021
         ON ACTION controlp INFIELD sfaa021
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfaasite = '",g_site,"' "
            CALL q_sfaa021()
            DISPLAY g_qryparam.return1 TO sfaa021
            NEXT FIELD sfaa021

         #Ctrlp:construct.c.sfaa023
         ON ACTION controlp INFIELD sfaa023
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfaasite = '",g_site,"' "
            CALL q_sfaa022()
            DISPLAY g_qryparam.return1 TO sfaa022
            DISPLAY g_qryparam.return2 TO sfaa023
            DISPLAY g_qryparam.return3 TO sfaa024
            DISPLAY g_qryparam.return4 TO sfaa064
            NEXT FIELD sfaa023

         #Ctrlp:construct.c.sfaa024
         ON ACTION controlp INFIELD sfaa024
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfaasite = '",g_site,"'"
            CALL q_sfaa022() 
            DISPLAY g_qryparam.return1 TO sfaa022
            DISPLAY g_qryparam.return2 TO sfaa023
            DISPLAY g_qryparam.return3 TO sfaa024
            DISPLAY g_qryparam.return4 TO sfaa064
            NEXT FIELD sfaa024

         #Ctrlp:construct.c.sfaa064
         ON ACTION controlp INFIELD sfaa064
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfaasite = '",g_site,"' "
            CALL q_sfaa022()
            DISPLAY g_qryparam.return1 TO sfaa022
            DISPLAY g_qryparam.return2 TO sfaa023
            DISPLAY g_qryparam.return3 TO sfaa024
            DISPLAY g_qryparam.return4 TO sfaa064
            NEXT FIELD sfaa064

         #Ctrlp:construct.c.sfaa025
         ON ACTION controlp INFIELD sfaa025
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfaasite = '",g_site,"' "
            CALL q_sfaa025()
            DISPLAY g_qryparam.return1 TO sfaa025
            NEXT FIELD sfaa025

         #Ctrlp:construct.c.sfaa010
         ON ACTION controlp INFIELD sfaa010
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_imaa001_9()
            DISPLAY g_qryparam.return1 TO sfaa010
            NEXT FIELD sfaa010

         #Ctrlp:construct.c.sfaa011
         ON ACTION controlp INFIELD sfaa011
            #160616-00002 by whitney add start
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_sfaa011()
            DISPLAY g_qryparam.return1 TO sfaa011
            NEXT FIELD sfaa011
            #160616-00002 by whitney add end

         #Ctrlp:construct.c.sfaa013
         ON ACTION controlp INFIELD sfaa013
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooca001()
            DISPLAY g_qryparam.return1 TO sfaa013
            NEXT FIELD sfaa013

         #Ctrlp:construct.c.sfaa060
         ON ACTION controlp INFIELD sfaa060
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooca001()
            DISPLAY g_qryparam.return1 TO sfaa060
            NEXT FIELD sfaa060

         #Ctrlp:construct.c.sfaa016
         ON ACTION controlp INFIELD sfaa016
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ecba002()
            DISPLAY g_qryparam.return1 TO sfaa016
            NEXT FIELD sfaa016

         #Ctrlp:construct.c.sfaa017
         ON ACTION controlp INFIELD sfaa017
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_ooeg001()
            DISPLAY g_qryparam.return1 TO sfaa017
            NEXT FIELD sfaa017

         #Ctrlp:construct.c.sfaa018
         ON ACTION controlp INFIELD sfaa018
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			   #add--161013-00051#1 By shiun--(S)
#            CALL q_ooef001()
            CALL q_ooef001_1()
            #add--161013-00051#1 By shiun--(E)
            DISPLAY g_qryparam.return1 TO sfaa018
            NEXT FIELD sfaa018

         #Ctrlp:construct.c.sfaa068
         ON ACTION controlp INFIELD sfaa068
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = cl_get_today()
            CALL q_ooeg001_8()
            DISPLAY g_qryparam.return1 TO sfaa068
            NEXT FIELD sfaa068

         #170217-00006----add----str
          #Ctrlp:construct.c.sfaa014
         ON ACTION controlp INFIELD sfaa014
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_bmfa012_1()
            DISPLAY g_qryparam.return1 TO sfaa014
            DISPLAY g_qryparam.return2 TO sfaa015
            NEXT FIELD sfaa014
         #170217-00006----add----end

         #Ctrlp:construct.c.sfaa028
         ON ACTION controlp INFIELD sfaa028
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_pjba001()
            DISPLAY g_qryparam.return1 TO sfaa028
            NEXT FIELD sfaa028

         #Ctrlp:construct.c.sfaa029
         ON ACTION controlp INFIELD sfaa029
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_pjbb002()
            DISPLAY g_qryparam.return1 TO sfaa029
            NEXT FIELD sfaa029

         #Ctrlp:construct.c.sfaa030
         ON ACTION controlp INFIELD sfaa030
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
			   CALL q_pjbm002()  #modify by lixiang 2015/06/17
            #CALL q_pjbm01()
            DISPLAY g_qryparam.return1 TO sfaa030
            NEXT FIELD sfaa030

         #Ctrlp:construct.c.sfaa031
         ON ACTION controlp INFIELD sfaa031
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = '225'
            CALL q_oocq002()
            DISPLAY g_qryparam.return1 TO sfaa031
            NEXT FIELD sfaa031

         #Ctrlp:construct.c.sfaa034
         ON ACTION controlp INFIELD sfaa034
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_inaa001_2()
            DISPLAY g_qryparam.return1 TO sfaa034
            NEXT FIELD sfaa034

         #Ctrlp:construct.c.sfaa035
         ON ACTION controlp INFIELD sfaa035
			   INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_inab002_2()
            DISPLAY g_qryparam.return1 TO sfaa035
            NEXT FIELD sfaa035

         #Ctrlp:construct.c.sfaaownid
         ON ACTION controlp INFIELD sfaaownid
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()
            DISPLAY g_qryparam.return1 TO sfaaownid
            NEXT FIELD sfaaownid

         #Ctrlp:construct.c.sfaaowndp
         ON ACTION controlp INFIELD sfaaowndp
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_ooeg001()
            DISPLAY g_qryparam.return1 TO sfaaowndp
            NEXT FIELD sfaaowndp

         #Ctrlp:construct.c.sfaacrtid
         ON ACTION controlp INFIELD sfaacrtid
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()
            DISPLAY g_qryparam.return1 TO sfaacrtid
            NEXT FIELD sfaacrtid

         #Ctrlp:construct.c.sfaacrtdp
         ON ACTION controlp INFIELD sfaacrtdp
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooeg001()
            DISPLAY g_qryparam.return1 TO sfaacrtdp
            NEXT FIELD sfaacrtdp

         #Ctrlp:construct.c.sfaamodid
         ON ACTION controlp INFIELD sfaamodid
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()
            DISPLAY g_qryparam.return1 TO sfaamodid
            NEXT FIELD sfaamodid

         #Ctrlp:construct.c.sfaacnfid
         ON ACTION controlp INFIELD sfaacnfid
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()
            DISPLAY g_qryparam.return1 TO sfaacnfid
            NEXT FIELD sfaacnfid

         #Ctrlp:construct.c.sfaapstid
         ON ACTION controlp INFIELD sfaapstid
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooag001()
            DISPLAY g_qryparam.return1 TO sfaapstid
            NEXT FIELD sfaapstid

      END CONSTRUCT

      #單身根據table分拆construct
      CONSTRUCT g_wc2_table1 ON sfbaseq,sfbaseq1,sfba002,sfba003,sfba004,sfba005,sfba022,sfba006,sfba033,sfba021,
                                sfba007,sfba008,sfba009,sfba010,sfba011,sfba012,sfba023,sfba024,sfba013,sfba014,
                                sfba015,sfba016,sfba025,sfba017,sfba018,sfba019,sfba020,sfba029,sfba030,sfba028,
                                #sfba001,sfba026,sfba027                          #161031-00025#17 mark
                                sfba001,sfba026,sfba027,ooff013      #161031-00025#17 add
           FROM s_detail1[1].sfbaseq,s_detail1[1].sfbaseq1,s_detail1[1].sfba002,s_detail1[1].sfba003,s_detail1[1].sfba004,
                s_detail1[1].sfba005,s_detail1[1].sfba022,s_detail1[1].sfba006,s_detail1[1].sfba033,s_detail1[1].sfba021,
                s_detail1[1].sfba007,s_detail1[1].sfba008,s_detail1[1].sfba009,s_detail1[1].sfba010,s_detail1[1].sfba011,
                s_detail1[1].sfba012,s_detail1[1].sfba023,s_detail1[1].sfba024,s_detail1[1].sfba013,s_detail1[1].sfba014,
                s_detail1[1].sfba015,s_detail1[1].sfba016,s_detail1[1].sfba025,s_detail1[1].sfba017,s_detail1[1].sfba018,
                s_detail1[1].sfba019,s_detail1[1].sfba020,s_detail1[1].sfba029,s_detail1[1].sfba030,s_detail1[1].sfba028,
                #s_detail1[1].sfba001,s_detail1[1].sfba026,s_detail1[1].sfba027    #161031-00025#17 mark
                s_detail1[1].sfba001,s_detail1[1].sfba026,s_detail1[1].sfba027,s_detail1[1].ooff013  #161031-00025#17 add

         BEFORE CONSTRUCT
            #add-point:cs段before_construct
            
            #end add-point

       #單身公用欄位開窗相關處理

       #單身一般欄位開窗相關處理
       #---------------------<  Detail: page1  >---------------------

         #Ctrlp:construct.c.page1.sfba002
         ON ACTION controlp INFIELD sfba002
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = "215"
            CALL q_oocq002()
            DISPLAY g_qryparam.return1 TO sfba002
            NEXT FIELD sfba002

         #Ctrlp:construct.c.page1.sfba003
         ON ACTION controlp INFIELD sfba003
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = "221"
            CALL q_oocq002()
            DISPLAY g_qryparam.return1 TO sfba003
            NEXT FIELD sfba003

         #Ctrlp:construct.c.page1.sfba005
         ON ACTION controlp INFIELD sfba005
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_imaa001_10()
            DISPLAY g_qryparam.return1 TO sfba005
            NEXT FIELD sfba005

         #Ctrlp:construct.c.page1.sfba006
         ON ACTION controlp INFIELD sfba006
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_imaa001_10()
            DISPLAY g_qryparam.return1 TO sfba006
            NEXT FIELD sfba006

         #Ctrlp:construct.c.page1.sfba021
         ON ACTION controlp INFIELD sfba021
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_sfba021()
            DISPLAY g_qryparam.return1 TO sfba021
            NEXT FIELD sfba021

         #Ctrlp:construct.c.page1.sfba014
         ON ACTION controlp INFIELD sfba014
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_ooca001_1()
            DISPLAY g_qryparam.return1 TO sfba014
            NEXT FIELD sfba014

         #Ctrlp:construct.c.page1.sfba019
         ON ACTION controlp INFIELD sfba019
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_inaa001_2()
            DISPLAY g_qryparam.return1 TO sfba019
            NEXT FIELD sfba019

         #Ctrlp:construct.c.page1.sfba020
         ON ACTION controlp INFIELD sfba020
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = g_sfba_d[l_ac].sfba019
            CALL q_inab002_3()
            DISPLAY g_qryparam.return1 TO sfba020
            NEXT FIELD sfba020

         #Ctrlp:construct.c.page1.sfba001
         ON ACTION controlp INFIELD sfba001
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            CALL q_imaa001_10()
            DISPLAY g_qryparam.return1 TO sfba001
            NEXT FIELD sfba001

      END CONSTRUCT

      CONSTRUCT g_wc_sfab ON sfabseq,sfab001,sfab002,sfab003,sfab004,sfab005,sfab006,sfab007
           FROM s_sfab[1].sfabseq,s_sfab[1].sfab001,s_sfab[1].sfab002,s_sfab[1].sfab003,
                s_sfab[1].sfab004,s_sfab[1].sfab005,s_sfab[1].sfab006,s_sfab[1].sfab007

         #Ctrlp:construct.c.sfab002
         ON ACTION controlp INFIELD sfab002
		   	INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_sfab002()
            DISPLAY g_qryparam.return1 TO sfab002
            DISPLAY g_qryparam.return2 TO sfab003
            DISPLAY g_qryparam.return3 TO sfab004
            DISPLAY g_qryparam.return4 TO sfab005
            NEXT FIELD sfab002

      END CONSTRUCT

      CONSTRUCT g_wc_sfac ON sfacseq,sfac002,sfac001,sfac006,sfac003,sfac004,sfac005
           FROM s_sfac[1].sfacseq,s_sfac[1].sfac002,s_sfac[1].sfac001,s_sfac[1].sfac006,
                s_sfac[1].sfac003,s_sfac[1].sfac004,s_sfac[1].sfac005

         #Ctrlp:construct.c.sfac001
         ON ACTION controlp INFIELD sfac001
		   	INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_sfac001()
            DISPLAY g_qryparam.return1 TO sfac001
            DISPLAY g_qryparam.return2 TO sfac006
            NEXT FIELD sfac001

         #Ctrlp:construct.c.sfac006
         ON ACTION controlp INFIELD sfac006
		   	INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_sfac001()
            DISPLAY g_qryparam.return1 TO sfac001
            DISPLAY g_qryparam.return2 TO sfac006
            NEXT FIELD sfac006

         #Ctrlp:construct.c.sfac004
         ON ACTION controlp INFIELD sfac004           
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
			   LET g_qryparam.reqry = FALSE
            CALL q_ooca001()
            DISPLAY g_qryparam.return1 TO sfac004
            NEXT FIELD sfac004

      END CONSTRUCT

      CONSTRUCT g_wc_sfaf ON sfafseq,sfaf001
           FROM s_sfaf[1].sfafseq,s_sfaf[1].sfaf001

      END CONSTRUCT
      
      #170124-00005#1-s-add
      CONSTRUCT g_wc_seq ON sfaa007,sfaa023
         FROM l_sfaa007,l_sfaa023
           
         ON ACTION controlp INFIELD l_sfaa007
           INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfaasite = '",g_site,"' "
            CALL q_sfaa006()
            DISPLAY g_qryparam.return2 TO l_sfaa007
            NEXT FIELD l_sfaa007
            
         ON ACTION controlp INFIELD l_sfaa023
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfaasite = '",g_site,"' "
            CALL q_sfaa022()
            DISPLAY g_qryparam.return2 TO l_sfaa023
            NEXT FIELD l_sfaa023
      END CONSTRUCT
      #170124-00005#1-e-add
      
      #add-point:cs段add_cs(本段內只能出現新的CONSTRUCT指令) name="cs.add_cs"
      SUBDIALOG aoo_aooi360_01.aooi360_01_construct   #备注单身  #161031-00025#17
      #end add-point

      BEFORE DIALOG
         CALL cl_qbe_init()
         #add-point:cs段b_dialog name="cs.b_dialog"

         #end add-point

      #查詢方案列表
      ON ACTION qbe_select
         LET ls_wc = ""
         CALL cl_qbe_list("c") RETURNING ls_wc
         IF NOT cl_null(ls_wc) THEN
            CALL util.JSON.parse(ls_wc, la_wc)
            INITIALIZE g_wc, g_wc2,g_wc2_table1,g_wc2_extend TO NULL
            INITIALIZE g_wc_sfab TO NULL
            INITIALIZE g_wc_sfac TO NULL
            INITIALIZE g_wc_sfaf TO NULL
            FOR li_idx = 1 TO la_wc.getLength()
               CASE
                  WHEN la_wc[li_idx].tableid = "sfaa_t" 
                     LET g_wc = la_wc[li_idx].wc
                  WHEN la_wc[li_idx].tableid = "sfba_t" 
                     LET g_wc2_table1 = la_wc[li_idx].wc
                  WHEN la_wc[li_idx].tableid = "sfab_t" 
                     LET g_wc_sfab = la_wc[li_idx].wc
                  WHEN la_wc[li_idx].tableid = "sfac_t" 
                     LET g_wc_sfac = la_wc[li_idx].wc
                  WHEN la_wc[li_idx].tableid = "sfaf_t" 
                     LET g_wc_sfaf = la_wc[li_idx].wc
               END CASE
            END FOR
         END IF

      #條件儲存為方案
      ON ACTION qbe_save
         CALL cl_qbe_save()
 
      ON ACTION accept
         ACCEPT DIALOG
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG 
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG
   END DIALOG
   
   #組合g_wc2
   LET g_wc2 = g_wc2_table1
   #組合g_wc
   IF g_wc_sfab <> " 1=1" THEN
      LET g_wc = g_wc ," AND ", g_wc_sfab
   END IF
   IF g_wc_sfac <> " 1=1" THEN
      LET g_wc = g_wc ," AND ", g_wc_sfac
   END IF
   IF g_wc_sfaf <> " 1=1" THEN
      LET g_wc = g_wc ," AND ", g_wc_sfaf
   END IF
   
   #170124-00005#1-s-add
   IF g_wc_seq <> " 1=1" THEN
      LET g_wc = g_wc ," AND ", g_wc_seq
   END IF
   #170124-00005#1-e-add
   
   #add-point:cs段結束前 name="cs.after_construct"

   #end add-point

   IF INT_FLAG THEN
      RETURN
   END IF

END FUNCTION

################################################################################
# Descriptions...: filter過濾功能
# Memo...........:
# Usage..........: CALL asft300_filter()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........: 161228-00049#1 16/12/29 g_browser->s_browse
################################################################################
PRIVATE FUNCTION asft300_filter()
   #add-point:filter段define name="filter.define_customerization"

   #end add-point
   #add-point:filter段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="filter.define"

   #end add-point
   
   #add-point:Function前置處理  name="filter.pre_function"

   #end add-point
   
   #切換畫面
   IF NOT g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",1)
      CALL gfrm_curr.setElementHidden("worksheet",0)
      LET g_main_hidden = 1
   END IF   

   LET INT_FLAG = 0

   LET g_qryparam.state = 'c'

   LET g_wc_filter_t = g_wc_filter.trim()
   LET g_wc_t = g_wc

   LET g_wc = cl_replace_str(g_wc, g_wc_filter_t, '')

   #使用DIALOG包住 單頭CONSTRUCT及單身CONSTRUCT
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)

      #單頭
      CONSTRUCT g_wc_filter ON sfaadocno,sfaa001,sfaadocdt,sfaa002,sfaa003,sfaa057,sfaa004,sfaa010,sfaa012
                          FROM s_browse[1].b_sfaadocno,s_browse[1].b_sfaa001,s_browse[1].b_sfaadocdt,
                               s_browse[1].b_sfaa002,s_browse[1].b_sfaa003,s_browse[1].b_sfaa057,
                               s_browse[1].b_sfaa004,s_browse[1].b_sfaa010,s_browse[1].b_sfaa012

         BEFORE CONSTRUCT
            DISPLAY asft300_filter_parser('sfaadocno') TO s_browse[1].b_sfaadocno
            DISPLAY asft300_filter_parser('sfaa001') TO s_browse[1].b_sfaa001
            DISPLAY asft300_filter_parser('sfaadocdt') TO s_browse[1].b_sfaadocdt
            DISPLAY asft300_filter_parser('sfaa002') TO s_browse[1].b_sfaa002
            DISPLAY asft300_filter_parser('sfaa003') TO s_browse[1].b_sfaa003
            DISPLAY asft300_filter_parser('sfaa057') TO s_browse[1].b_sfaa057
            DISPLAY asft300_filter_parser('sfaa004') TO s_browse[1].b_sfaa004
            DISPLAY asft300_filter_parser('sfaa010') TO s_browse[1].b_sfaa010
            DISPLAY asft300_filter_parser('sfaa012') TO s_browse[1].b_sfaa012
      
         #add-point:filter段cs_ctrl name="filter.cs_ctrl"
         ON ACTION controlp INFIELD b_sfaadocno
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'c'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.where = " sfaasite = '",g_site,"' "
            CALL q_sfaadocno_1()
            DISPLAY g_qryparam.return1 TO b_sfaadocno
            NEXT FIELD b_sfaadocno

         ON ACTION controlp INFIELD b_sfaa002
		   	   INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
		   	   LET g_qryparam.reqry = FALSE
               CALL q_ooag001()
               DISPLAY g_qryparam.return1 TO b_sfaa002
               NEXT FIELD b_sfaa002

         ON ACTION controlp INFIELD b_sfaa010
		       	INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'c'
		   	   LET g_qryparam.reqry = FALSE
               CALL q_imaa001_9()
               DISPLAY g_qryparam.return1 TO b_sfaa010
               NEXT FIELD b_sfaa010
         #end add-point
      
      END CONSTRUCT
 
      #add-point:filter段add_cs name="filter.add_cs"

      #end add-point
 
      BEFORE DIALOG
         #add-point:filter段b_dialog name="filter.b_dialog"

         #end add-point  
      
      ON ACTION accept
         ACCEPT DIALOG
 
      ON ACTION cancel
         LET INT_FLAG = 1
         EXIT DIALOG 
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG
   
   END DIALOG
 
   IF NOT INT_FLAG THEN
      LET g_wc_filter = "   AND   ", g_wc_filter, "   "
      LET g_wc = g_wc , g_wc_filter
   ELSE
      LET g_wc_filter = g_wc_filter_t
      LET g_wc = g_wc_t
   END IF

   CALL asft300_filter_show('sfaadocno')
   CALL asft300_filter_show('sfaa001')
   CALL asft300_filter_show('sfaadocdt')
   CALL asft300_filter_show('sfaa002')
   CALL asft300_filter_show('sfaa003')
   CALL asft300_filter_show('sfaa057')
   CALL asft300_filter_show('sfaa004')
   CALL asft300_filter_show('sfaa010')
   CALL asft300_filter_show('sfaa012')

END FUNCTION

################################################################################
# Descriptions...: filter過濾功能
# Memo...........:
# Usage..........: CALL asft300_filter_parser(ps_field)
# Input parameter: ps_field
# Return code....: ls_var
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_filter_parser(ps_field)
   #add-point:filter段define name="filter_parser.define_customerization"

   #end add-point
   DEFINE ps_field   STRING
   DEFINE ls_tmp     STRING
   DEFINE li_tmp     LIKE type_t.num10
   DEFINE li_tmp2    LIKE type_t.num10
   DEFINE ls_var     STRING
   #add-point:filter段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="filter_parser.define"

   #end add-point
   
   #一般條件解析
   LET ls_tmp = ps_field, "='"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
   END IF

   #模糊條件解析
   LET ls_tmp = ps_field, " like '"
   LET li_tmp = g_wc_filter.getIndexOf(ls_tmp,1)
   IF li_tmp > 0 THEN
      LET li_tmp = ls_tmp.getLength() + li_tmp
      LET li_tmp2 = g_wc_filter.getIndexOf("'",li_tmp + 1) - 1
      LET ls_var = g_wc_filter.subString(li_tmp,li_tmp2)
      LET ls_var = cl_replace_str(ls_var,'%','*')
   END IF
 
   RETURN ls_var

END FUNCTION

################################################################################
# Descriptions...: 顯示過濾條件
# Memo...........:
# Usage..........: CALL asft300_filter_show(ps_field)
# Input parameter: ps_field
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_filter_show(ps_field)
   DEFINE ps_field         STRING
   DEFINE lnode_item       om.DomNode
   DEFINE ls_title         STRING
   DEFINE ls_name          STRING
   DEFINE ls_condition     STRING
 
   LET ls_name = "formonly.b_", ps_field
   LET lnode_item = gfrm_curr.findNode("TableColumn", ls_name)
   LET ls_title = lnode_item.getAttribute("text")
   IF ls_title.getIndexOf('※',1) > 0 THEN
      LEt ls_title = ls_title.subString(1,ls_title.getIndexOf('※',1)-1)
   END IF

   #顯示資料組合
   LET ls_condition = asft300_filter_parser(ps_field)
   IF NOT cl_null(ls_condition) THEN
      LET ls_title = ls_title, '※', ls_condition, '※'
   END IF

   #將資料顯示回去
   CALL lnode_item.setAttribute("text",ls_title)

END FUNCTION

################################################################################
# Descriptions...: 資料查詢QBE功能準備
# Memo...........:
# Usage..........: CALL asft300_query()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_query()
   #add-point:query段define(客製用) name="query.define_customerization"
   
   #end add-point
   DEFINE ls_wc STRING
   #add-point:query段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="query.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="query.pre_function"
   
   #end add-point
   
   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF
   
   LET ls_wc = g_wc
   
   LET INT_FLAG = 0
   CALL cl_navigator_setting( g_current_idx, g_detail_cnt )
   ERROR ""
   
   #清除畫面及相關資料
   CLEAR FORM
   CALL g_browser.clear()
   CALL g_sfba_d.clear()
   CALL g_sfab_d.clear()
   CALL g_sfac_d.clear()
   CALL g_sfaf_d.clear()
   
   #add-point:query段other name="query.other"
   CALL aooi360_01_clear_detail()   #清除备注单身  #161031-00025#17 add    
   #end add-point
   
   DISPLAY '' TO FORMONLY.idx
   DISPLAY '' TO FORMONLY.cnt
   DISPLAY '' TO FORMONLY.b_index
   DISPLAY '' TO FORMONLY.b_count
   DISPLAY '' TO FORMONLY.h_index
   DISPLAY '' TO FORMONLY.h_count
   
   CALL asft300_construct()
 
   IF INT_FLAG THEN
      #取消查詢
      LET INT_FLAG = 0
      #LET g_wc = ls_wc
      LET g_wc = " 1=2"
      CALL asft300_browser_fill("")
      CALL asft300_fetch("")
      RETURN
   END IF
   
   #儲存WC資訊
   CALL cl_dlg_save_user_latestqry("("||g_wc||") AND ("||g_wc2||")")
   
   #搜尋後資料初始化 
   LET g_detail_cnt  = 0
   LET g_current_idx = 1
   LET g_current_row = 0
   LET g_detail_idx  = 1
   LET g_detail_idx2 = 1
   LET g_detail_idx_list[1] = 1
   LET g_detail_idx_list[2] = 1
   LET g_detail_idx_list[3] = 1
   LET g_detail_idx_list[4] = 1
 
   LET g_error_show  = 1
   LET g_wc_filter   = ""
   LET l_ac = 1
   CALL FGL_SET_ARR_CURR(1)
   CALL asft300_filter_show('sfaadocno')
   CALL asft300_filter_show('sfaa001')
   CALL asft300_filter_show('sfaadocdt')
   CALL asft300_filter_show('sfaa002')
   CALL asft300_filter_show('sfaa003')
   CALL asft300_filter_show('sfaa057')
   CALL asft300_filter_show('sfaa004')
   CALL asft300_filter_show('sfaa010')
   CALL asft300_filter_show('sfaa012')
   CALL asft300_browser_fill("F")
   
   IF g_browser_cnt = 0 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = ""
      LET g_errparam.code   = "-100"
      LET g_errparam.popup  = TRUE
      CALL cl_err()
   ELSE
      CALL asft300_fetch("F")
      #顯示單身筆數
      CALL asft300_idx_chk()
   END IF

END FUNCTION

################################################################################
# Descriptions...: 指定PK後抓取單頭其他資料
# Memo...........:
# Usage..........: CALL asft300_fetch(p_flag)
# Input parameter: p_flag
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_fetch(p_flag)
   #add-point:fetch段define(客製用) name="fetch.define_customerization"

   #end add-point
   DEFINE p_flag     LIKE type_t.chr1
   DEFINE ls_msg     STRING
   #add-point:fetch段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="fetch.define"

   #end add-point

   #add-point:Function前置處理  name="fetch.pre_function"

   #end add-point

   IF g_browser_cnt = 0 THEN
      RETURN
   END IF

   #清空第二階單身
   
   CALL cl_ap_performance_next_start()
   CASE p_flag
      WHEN 'F'
         LET g_current_idx = 1
      WHEN 'L'
         LET g_current_idx = g_browser.getLength()
      WHEN 'P'
         IF g_current_idx > 1 THEN
            LET g_current_idx = g_current_idx - 1
         END IF
      WHEN 'N'
         IF g_current_idx < g_header_cnt THEN
            LET g_current_idx =  g_current_idx + 1
         END IF
      WHEN '/'
         IF (NOT g_no_ask) THEN
            CALL cl_set_act_visible("accept,cancel", TRUE)
            CALL cl_getmsg('fetch',g_lang) RETURNING ls_msg
            LET INT_FLAG = 0

            PROMPT ls_msg CLIPPED,':' FOR g_jump
               #交談指令共用ACTION
               &include "common_action.4gl"
            END PROMPT

            CALL cl_set_act_visible("accept,cancel", FALSE)
            IF INT_FLAG THEN
                LET INT_FLAG = 0
                EXIT CASE
            END IF
         END IF
         
         IF g_jump > 0 AND g_jump <= g_browser.getLength() THEN
             LET g_current_idx = g_jump
         END IF
         LET g_no_ask = FALSE
   END CASE

   CALL g_curr_diag.setCurrentRow("s_browse", g_current_idx) #設定browse 索引
   
   LET g_current_row = g_current_idx
   LET g_detail_cnt = g_header_cnt
   
   #單身總筆數顯示
   IF g_detail_cnt > 0 THEN
      #若單身有資料時, idx至少為1
      IF g_detail_idx <= 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
   ELSE
      LET g_detail_idx = 0
      DISPLAY '' TO FORMONLY.idx
   END IF
   
   #瀏覽頁筆數顯示
   LET g_browser_idx = g_pagestart+g_current_idx-1
   DISPLAY g_browser_idx TO FORMONLY.b_index   #當下筆數
   DISPLAY g_browser_idx TO FORMONLY.h_index   #當下筆數
   
   CALL cl_navigator_setting( g_current_idx, g_browser_cnt )
 
   #代表沒有資料
   IF g_current_idx = 0 OR g_browser.getLength() = 0 THEN
      RETURN
   END IF
   
   #避免超出browser資料筆數上限
   IF g_current_idx > g_browser.getLength() THEN
      LET g_browser_idx = g_browser.getLength()
      LET g_current_idx = g_browser.getLength()
   END IF
   
   LET g_sfaa_m.sfaadocno = g_browser[g_current_idx].b_sfaadocno
   
   #重讀DB,因TEMP有不被更新特性
   EXECUTE asft300_master_referesh USING g_sfaa_m.sfaadocno
      INTO g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.oobal004,g_sfaa_m.sfaadocdt,g_sfaa_m.sfaa002,
           g_sfaa_m.sfaa002_desc,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,
           g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,
           g_sfaa_m.sfaa009,g_sfaa_m.sfaa009_desc,g_sfaa_m.sfaa022,g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,
           g_sfaa_m.sfaa024,g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,
           g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1,g_sfaa_m.sfaa012,g_sfaa_m.sfaa013,g_sfaa_m.sfaa013_desc,
           g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa060_desc,g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,
           g_sfaa_m.sfaa016_desc,g_sfaa_m.sfaa017,g_sfaa_m.sfaa017_desc,g_sfaa_m.sfaa018,g_sfaa_m.sfaa018_desc,
           g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,g_sfaa_m.sfaa068_desc,g_sfaa_m.sfaa014,
           g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.imae020,g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,
           g_sfaa_m.sfaa028_desc,g_sfaa_m.sfaa029,g_sfaa_m.sfaa029_desc,g_sfaa_m.sfaa030,g_sfaa_m.sfaa030_desc,
           g_sfaa_m.sfaa031,g_sfaa_m.sfaa031_desc,g_sfaa_m.sfaa032,g_sfaa_m.sfaa033,g_sfaa_m.sfaa034,
           g_sfaa_m.sfaa034_desc,g_sfaa_m.sfaa035,g_sfaa_m.sfaa035_desc,g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,
           g_sfaa_m.sfaa037,g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,
           g_sfaa_m.sfaa041,g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,
           g_sfaa_m.sfaa070,g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,
           g_sfaa_m.sfaa065,g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,
           #g_sfaa_m.sfaa056,g_sfaa_m.ooff013,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,   #161031-00025#17  mark
           g_sfaa_m.sfaa056,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,                     #161031-00025#17  add
           g_sfaa_m.sfaaowndp_desc,g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtid_desc,g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdp_desc,
           g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,g_sfaa_m.sfaamodid_desc,g_sfaa_m.sfaamoddt,g_sfaa_m.sfaacnfid,
           g_sfaa_m.sfaacnfid_desc,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,g_sfaa_m.sfaapstid_desc,g_sfaa_m.sfaapstdt
   
#   #遮罩相關處理
#   LET g_sfaa_m_mask_o.* =  g_sfaa_m.*
#   CALL asft300_sfaa_t_mask()
#   LET g_sfaa_m_mask_n.* =  g_sfaa_m.*
   
   #根據資料狀態切換action狀態
   CALL asft300_set_act_visible()   
   CALL asft300_set_act_no_visible()
   
   #add-point:fetch段action控制 name="fetch.action_control"

   #end add-point
   
   #add-point:fetch結束前 name="fetch.after"

   #end add-point
   
   #保存單頭舊值
   LET g_sfaa_m_t.* = g_sfaa_m.*
   LET g_sfaa_m_o.* = g_sfaa_m.*
   
   #160727-00025#1-s
   #模具頁簽資料
   IF g_argv[01] ='4' THEN     
      #保存單頭舊值
      LET g_sfai_m_t.* = g_sfai_m.*
      LET g_sfai_m_o.* = g_sfai_m.*
   END IF
   #160727-00025#1-e
   
   LET g_data_owner = g_sfaa_m.sfaaownid
   LET g_data_dept  = g_sfaa_m.sfaaowndp
   
   #重新顯示
   CALL asft300_show()

   #應用 a56 樣板自動產生(Version:3)
   #檢查此單據是否需顯示BPM簽核狀況按鈕
   IF cl_bpm_chk() THEN
      CALL cl_set_act_visible("bpm_status",TRUE)
   ELSE
      CALL cl_set_act_visible("bpm_status",FALSE)
   END IF

END FUNCTION

################################################################################
# Descriptions...: 資料新增
# Memo...........:
# Usage..........: CALL asft300_insert()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_insert()
   #add-point:insert段define(客製用) name="insert.define_customerization"

   #end add-point
   #add-point:insert段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="insert.define"

   #end add-point

   #add-point:Function前置處理  name="insert.pre_function"

   #end add-point
   
   #清畫面欄位內容
   CLEAR FORM
   CALL g_sfba_d.clear()
   CALL g_sfab_d.clear()
   CALL g_sfac_d.clear()
   CALL g_sfaf_d.clear()

   INITIALIZE g_sfaa_m.* LIKE sfaa_t.*             #DEFAULT 設定
   INITIALIZE g_sfai_m.* TO NULL  #160727-00025#1
   
   LET g_sfaadocno_t = NULL
   
   LET g_master_insert = FALSE
   
   #add-point:insert段before name="insert.before"
   CALL aooi360_01_clear_detail()   #清除备注单身  #161031-00025#17 add
   #end add-point
   
   CALL s_transaction_begin()
   WHILE TRUE
      #公用欄位給值(單頭)
      #應用 a14 樣板自動產生(Version:5)    
      #公用欄位新增給值  
      LET g_sfaa_m.sfaaownid = g_user
      LET g_sfaa_m.sfaaowndp = g_dept
      LET g_sfaa_m.sfaacrtid = g_user
      LET g_sfaa_m.sfaacrtdp = g_dept 
      LET g_sfaa_m.sfaacrtdt = cl_get_current()
      LET g_sfaa_m.sfaamodid = g_user
      LET g_sfaa_m.sfaamoddt = cl_get_current()
      LET g_sfaa_m.sfaastus = 'N'

      #append欄位給值

      #一般欄位給值
      LET g_sfaa_m.sfaa001 = "0"
      LET g_sfaa_m.sfaa005 = "0"
      LET g_sfaa_m.sfaa061 = 'N'
      LET g_sfaa_m.sfaa062 = "Y"
      LET g_sfaa_m.sfaa038 = "N"
      LET g_sfaa_m.sfaa039 = "N"
      LET g_sfaa_m.sfaa040 = "N"
      LET g_sfaa_m.sfaa041 = "N"
      LET g_sfaa_m.sfaa042 = "N"
      LET g_sfaa_m.sfaa043 = "N"
      LET g_sfaa_m.sfaa044 = "N"
      LET g_sfaa_m.sfaa049 = "0"
      LET g_sfaa_m.sfaa050 = "0"
      LET g_sfaa_m.sfaa051 = "0"
      LET g_sfaa_m.sfaa055 = "0"
      LET g_sfaa_m.sfaa056 = "0"
      LET g_sfaa_m.sfaa003 = '1'
      LET g_sfaa_m.sfaa057 = '1'
      LET g_sfaa_m.sfaa065 = '0'
      LET g_sfaa_m.sfaa004 = '1'

      #add-point:單頭預設值 name="insert.default"
      LET g_sfaa_m.sfaadocdt = g_today
      LET g_sfaa_m.sfaa002 = g_user
      LET g_sfaa_m.sfaa019 = g_today
      CALL s_desc_get_person_desc(g_sfaa_m.sfaa002) RETURNING g_sfaa_m.sfaa002_desc
      DISPLAY BY NAME g_sfaa_m.sfaa002_desc
      
      #160727-00025#1-s
      #模具頁簽資料
      IF g_argv[01] ='4' THEN
         LET g_sfaa_m.sfaa003 = '5'   #模具工單
         LET g_sfaa_m.sfaa004 = '2'   #倒扣料
         LET g_sfaa_m.sfaa061 = 'Y'   #製程
         LET g_sfai_m.sfai002 = 0
         LET g_sfai_m_t.* = g_sfai_m.*
         LET g_sfai_m_o.* = g_sfai_m.*
      END IF
      #160727-00025#1-e
      #end add-point 
      
      #保存單頭舊值(用於資料輸入錯誤還原預設值時使用)
      LET g_sfaa_m_t.* = g_sfaa_m.*
      LET g_sfaa_m_o.* = g_sfaa_m.*
      
	   #根據當下狀態碼顯示圖片
      CALL asft300_status_show()
    
      CALL asft300_input("a")
      
      #add-point:單頭輸入後 name="insert.after_insert"
      #160825-00032-s
      IF NOT INT_FLAG THEN
         LET g_browser_cnt = g_browser_cnt + 1
      END IF
      CALL asft300_set_act_visible()
      CALL asft300_set_act_no_visible()
      #160825-00032-e
      #end add-point
      
      IF INT_FLAG THEN
         CALL s_transaction_end('N','0')
         LET INT_FLAG = 0
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = ''
         LET g_errparam.code   = 9001
         LET g_errparam.popup  = FALSE
         CALL cl_err()
      END IF
      
      IF NOT g_master_insert THEN
         DISPLAY g_detail_cnt  TO FORMONLY.h_count    #總筆數
         DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
         INITIALIZE g_sfaa_m.* TO NULL
         INITIALIZE g_sfai_m.* TO NULL   #160727-00025#1
         INITIALIZE g_sfba_d TO NULL
         INITIALIZE g_sfab_d TO NULL
         INITIALIZE g_sfac_d TO NULL
         INITIALIZE g_sfaf_d TO NULL

         #add-point:取消新增後 name="insert.cancel"

         #end add-point
         CALL asft300_show()
         RETURN
      END IF
      
      LET INT_FLAG = 0
      #CALL g_sfab_d.clear()
      #CALL g_sfac_d.clear()
      #CALL g_sfaf_d.clear()
      #CALL g_sfba_d.clear()

      LET g_rec_b = 0
      CALL s_transaction_end('Y','0')
      EXIT WHILE
      
   END WHILE
   
   #根據資料狀態切換action狀態
   CALL asft300_set_act_visible()
   CALL asft300_set_act_no_visible()
   
   #將新增的資料併入搜尋條件中
   LET g_sfaadocno_t = g_sfaa_m.sfaadocno
   
   #組合新增資料的條件
   LET g_add_browse = " sfaaent = '" ||g_enterprise|| "' AND sfaasite = '" ||g_site|| "' AND",
                      " sfaadocno = '", g_sfaa_m.sfaadocno, "' "

   #add-point:組合新增資料的條件後 name="insert.after.add_browse"

   #end add-point
   
   #填到最後面
   LET g_current_idx = g_browser.getLength() + 1
   CALL asft300_browser_fill("")
   
   DISPLAY g_browser_cnt TO FORMONLY.h_count    #總筆數
   DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
   CALL cl_navigator_setting(g_current_idx, g_browser_cnt)
   
   CLOSE asft300_cl
   
   CALL asft300_idx_chk()
   
   #撈取異動後的資料(主要是帶出reference)
   EXECUTE asft300_master_referesh USING g_sfaa_m.sfaadocno
      INTO g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.oobal004,g_sfaa_m.sfaadocdt,g_sfaa_m.sfaa002,
           g_sfaa_m.sfaa002_desc,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,
           g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,
           g_sfaa_m.sfaa009,g_sfaa_m.sfaa009_desc,g_sfaa_m.sfaa022,g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,
           g_sfaa_m.sfaa024,g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,
           g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1,g_sfaa_m.sfaa012,g_sfaa_m.sfaa013,g_sfaa_m.sfaa013_desc,
           g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa060_desc,g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,
           g_sfaa_m.sfaa016_desc,g_sfaa_m.sfaa017,g_sfaa_m.sfaa017_desc,g_sfaa_m.sfaa018,g_sfaa_m.sfaa018_desc,
           g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,g_sfaa_m.sfaa068_desc,g_sfaa_m.sfaa014,
           g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.imae020,g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,
           g_sfaa_m.sfaa028_desc,g_sfaa_m.sfaa029,g_sfaa_m.sfaa029_desc,g_sfaa_m.sfaa030,g_sfaa_m.sfaa030_desc,
           g_sfaa_m.sfaa031,g_sfaa_m.sfaa031_desc,g_sfaa_m.sfaa032,g_sfaa_m.sfaa033,g_sfaa_m.sfaa034,
           g_sfaa_m.sfaa034_desc,g_sfaa_m.sfaa035,g_sfaa_m.sfaa035_desc,g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,
           g_sfaa_m.sfaa037,g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,
           g_sfaa_m.sfaa041,g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,
           g_sfaa_m.sfaa070,g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,
           g_sfaa_m.sfaa065,g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,
           #g_sfaa_m.sfaa056,g_sfaa_m.ooff013,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,      #161031-00025#17 mark
           g_sfaa_m.sfaa056,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,                        #161031-00025#17 add
           g_sfaa_m.sfaaowndp_desc,g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtid_desc,g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdp_desc,
           g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,g_sfaa_m.sfaamodid_desc,g_sfaa_m.sfaamoddt,g_sfaa_m.sfaacnfid,
           g_sfaa_m.sfaacnfid_desc,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,g_sfaa_m.sfaapstid_desc,g_sfaa_m.sfaapstdt
   
#   #遮罩相關處理
#   LET g_sfaa_m_mask_o.* =  g_sfaa_m.*
#   CALL asft300_sfaa_t_mask()
#   LET g_sfaa_m_mask_n.* =  g_sfaa_m.*
   
   #將資料顯示到畫面上
   DISPLAY BY NAME g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.oobal004,g_sfaa_m.sfaadocdt,g_sfaa_m.sfaa002,
           g_sfaa_m.sfaa002_desc,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,
           g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,
           g_sfaa_m.l_sfaa007,g_sfaa_m.sfaa009,g_sfaa_m.sfaa009_desc,g_sfaa_m.sfaa022,g_sfaa_m.l_sfaa023,
           g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,g_sfaa_m.sfaa024,g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,
           g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1,g_sfaa_m.sfaa012,
           g_sfaa_m.sfaa013,g_sfaa_m.sfaa013_desc,g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa060_desc,
           g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,g_sfaa_m.sfaa016_desc,g_sfaa_m.sfaa017,g_sfaa_m.sfaa017_desc,
           g_sfaa_m.sfaa018,g_sfaa_m.sfaa018_desc,g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,
           g_sfaa_m.sfaa068_desc,g_sfaa_m.sfaa014,g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.imae020,
           g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,g_sfaa_m.sfaa028_desc,g_sfaa_m.sfaa029,g_sfaa_m.sfaa029_desc,
           g_sfaa_m.sfaa030,g_sfaa_m.sfaa030_desc,g_sfaa_m.sfaa031,g_sfaa_m.sfaa031_desc,g_sfaa_m.sfaa032,
           g_sfaa_m.sfaa033,g_sfaa_m.sfaa034,g_sfaa_m.sfaa034_desc,g_sfaa_m.sfaa035,g_sfaa_m.sfaa035_desc,
           g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,g_sfaa_m.sfaa037,g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,
           g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,g_sfaa_m.sfaa041,g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,
           g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,g_sfaa_m.sfaa070,g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,
           g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,g_sfaa_m.sfaa065,g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,
           #g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,g_sfaa_m.sfaa056,g_sfaa_m.ooff013,g_sfaa_m.sfaaownid,    #161031-00025#17  mark
           g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,g_sfaa_m.sfaa056,g_sfaa_m.sfaaownid,                      #161031-00025#17  add
           g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,g_sfaa_m.sfaaowndp_desc,g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtid_desc,
           g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdp_desc,g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,g_sfaa_m.sfaamodid_desc,
           g_sfaa_m.sfaamoddt,g_sfaa_m.sfaacnfid,g_sfaa_m.sfaacnfid_desc,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,
           g_sfaa_m.sfaapstid_desc,g_sfaa_m.sfaapstdt
   
    #161031-00025#17-s
    LET g_ooff001_d = '6'   #6.單據單頭備註
    LET g_ooff002_d = g_prog
    LET g_ooff003_d = ''    #单号
    LET g_ooff004_d = '0'     #项次
    LET g_ooff005_d = ' '
    LET g_ooff006_d = ' '
    LET g_ooff007_d = ' '
    LET g_ooff008_d = ' '
    LET g_ooff009_d = ' '
    LET g_ooff010_d = ' '
    LET g_ooff011_d = ' '
    #161031-00025#17-e  
   #add-point:新增結束後 name="insert.after"

   #end add-point
   
   LET g_data_owner = g_sfaa_m.sfaaownid      
   LET g_data_dept  = g_sfaa_m.sfaaowndp
   
   #功能已完成,通報訊息中心
   CALL asft300_msgcentre_notify('insert')

END FUNCTION

################################################################################
# Descriptions...: 資料修改
# Memo...........:
# Usage..........: CALL asft300_modify()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_modify()
   #add-point:modify段define(客製用) name="modify.define_customerization"

   #end add-point
   DEFINE l_new_key    DYNAMIC ARRAY OF STRING
   DEFINE l_old_key    DYNAMIC ARRAY OF STRING
   DEFINE l_field_key  DYNAMIC ARRAY OF STRING
   #add-point:modify段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="modify.define"

   #end add-point

   #add-point:Function前置處理  name="modify.pre_function"

   #end add-point
   
   #保存單頭舊值
   LET g_sfaa_m_t.* = g_sfaa_m.*
   LET g_sfaa_m_o.* = g_sfaa_m.*
   
   #160727-00025#1---s
   #模具頁簽資料
   IF g_argv[01] ='4' THEN     
      #保存單頭舊值
      LET g_sfai_m_t.* = g_sfai_m.*
      LET g_sfai_m_o.* = g_sfai_m.*
   END IF
   #160727-00025#1---e
   
   IF g_sfaa_m.sfaadocno IS NULL THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = ""
      LET g_errparam.code   = "std-00003"
      LET g_errparam.popup  = FALSE
      CALL cl_err()
      RETURN
   END IF

   ERROR ""

   LET g_sfaadocno_t = g_sfaa_m.sfaadocno

   CALL s_transaction_begin()
   
   OPEN asft300_cl USING g_enterprise,g_site,g_sfaa_m.sfaadocno
   IF STATUS THEN
      CLOSE asft300_cl
      CALL s_transaction_end('N','0')
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "OPEN asft300_cl:"
      LET g_errparam.code   = STATUS
      LET g_errparam.popup  = TRUE
      CALL cl_err()
      RETURN
   END IF

   #顯示最新的資料
   EXECUTE asft300_master_referesh USING g_sfaa_m.sfaadocno
      INTO g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.oobal004,g_sfaa_m.sfaadocdt,g_sfaa_m.sfaa002,
           g_sfaa_m.sfaa002_desc,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,
           g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,
           g_sfaa_m.sfaa009,g_sfaa_m.sfaa009_desc,g_sfaa_m.sfaa022,g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,
           g_sfaa_m.sfaa024,g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,
           g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1,g_sfaa_m.sfaa012,g_sfaa_m.sfaa013,g_sfaa_m.sfaa013_desc,
           g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa060_desc,g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,
           g_sfaa_m.sfaa016_desc,g_sfaa_m.sfaa017,g_sfaa_m.sfaa017_desc,g_sfaa_m.sfaa018,g_sfaa_m.sfaa018_desc,
           g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,g_sfaa_m.sfaa068_desc,g_sfaa_m.sfaa014,
           g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.imae020,g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,
           g_sfaa_m.sfaa028_desc,g_sfaa_m.sfaa029,g_sfaa_m.sfaa029_desc,g_sfaa_m.sfaa030,g_sfaa_m.sfaa030_desc,
           g_sfaa_m.sfaa031,g_sfaa_m.sfaa031_desc,g_sfaa_m.sfaa032,g_sfaa_m.sfaa033,g_sfaa_m.sfaa034,
           g_sfaa_m.sfaa034_desc,g_sfaa_m.sfaa035,g_sfaa_m.sfaa035_desc,g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,
           g_sfaa_m.sfaa037,g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,
           g_sfaa_m.sfaa041,g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,
           g_sfaa_m.sfaa070,g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,
           g_sfaa_m.sfaa065,g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,
           #g_sfaa_m.sfaa056,g_sfaa_m.ooff013,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,    #161031-00025#17  mark
           g_sfaa_m.sfaa056,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,                      #161031-00025#17  add
           g_sfaa_m.sfaaowndp_desc,g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtid_desc,g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdp_desc,
           g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,g_sfaa_m.sfaamodid_desc,g_sfaa_m.sfaamoddt,g_sfaa_m.sfaacnfid,
           g_sfaa_m.sfaacnfid_desc,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,g_sfaa_m.sfaapstid_desc,g_sfaa_m.sfaapstdt
   
   #檢查是否允許此動作
   IF NOT asft300_action_chk() THEN
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
#   #遮罩相關處理
#   LET g_sfaa_m_mask_o.* =  g_sfaa_m.*
#   CALL asft300_sfaa_t_mask()
#   LET g_sfaa_m_mask_n.* =  g_sfaa_m.*
   
   #add-point:modify段show之前 name="modify.before_show"

   #end add-point
   
   CALL asft300_show()
   #add-point:modify段show之後 name="modify.after_show"

   #end add-point
   
   WHILE TRUE
      LET g_sfaadocno_t = g_sfaa_m.sfaadocno
      
      #寫入修改者/修改日期資訊(單頭)
      LET g_sfaa_m.sfaamodid = g_user
      LET g_sfaa_m.sfaamoddt = cl_get_current()
      LET g_sfaa_m.sfaamodid_desc = cl_get_username(g_sfaa_m.sfaamodid)
      
      #add-point:modify段修改前 name="modify.before_input"
      #「D抽單 / R已拒絕」狀況碼更改資料後，需還原為「N未確認」
      IF g_sfaa_m.sfaastus MATCHES "[DR]" THEN
         LET g_sfaa_m.sfaastus = "N"
      END IF
      #end add-point
      
      #欄位更改
      LET g_loc = 'n'
      LET g_update = FALSE
      CALL asft300_input("u")
      LET g_loc = 'n'

      #add-point:modify段修改後 name="modify.after_input"

      #end add-point
      
      IF g_update OR NOT INT_FLAG THEN
         #若有modid跟moddt則進行update
         UPDATE sfaa_t SET (sfaamodid,sfaamoddt) = (g_sfaa_m.sfaamodid,g_sfaa_m.sfaamoddt)
          WHERE sfaaent = g_enterprise AND sfaadocno = g_sfaadocno_t

      END IF
    
      IF INT_FLAG THEN
         CALL s_transaction_end('N','0')
         LET INT_FLAG = 0
         LET g_sfaa_m.* = g_sfaa_m_t.*
         LET g_sfai_m.* = g_sfai_m_t.*   #160727-00025#1
         CALL asft300_show()
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = ''
         LET g_errparam.code   = 9001
         LET g_errparam.popup  = FALSE
         CALL cl_err()
         RETURN
      END IF
      
      #若單頭key欄位有變更
      IF g_sfaa_m.sfaadocno != g_sfaa_m_t.sfaadocno THEN
         CALL s_transaction_begin()
         
         #add-point:單身fk修改前 name="modify.body.b_fk_update"

         #end add-point
         
         #更新單身key值
         UPDATE sfba_t SET sfbadocno = g_sfaa_m.sfaadocno
          WHERE sfbaent = g_enterprise AND sfbasite = g_site AND sfbadocno = g_sfaadocno_t

         #add-point:單身fk修改中 name="modify.body.m_fk_update"

         #end add-point

         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            #   INITIALIZE g_errparam TO NULL 
            #   LET g_errparam.extend = "sfba_t" 
            #   LET g_errparam.code   = "std-00009" 
            #   LET g_errparam.popup  = TRUE 
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')
            #   CONTINUE WHILE
            WHEN SQLCA.sqlcode #其他錯誤
               CALL s_transaction_end('N','0')
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "sfba_t:",SQLERRMESSAGE 
               LET g_errparam.code   = SQLCA.sqlcode 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               CONTINUE WHILE
         END CASE
         
         #add-point:單身fk修改後 name="modify.body.a_fk_update"

         #end add-point
         
         UPDATE sfab_t SET sfabdocno = g_sfaa_m.sfaadocno
          WHERE sfabent = g_enterprise AND sfabdocno = g_sfaadocno_t
         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            #   INITIALIZE g_errparam TO NULL
            #   LET g_errparam.extend = "sfab_t"
            #   LET g_errparam.code   = "std-00009"
            #   LET g_errparam.popup  = TRUE
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')
            #   CONTINUE WHILE
            WHEN SQLCA.sqlcode #其他錯誤
               CALL s_transaction_end('N','0')
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = "sfab_t:",SQLERRMESSAGE
               LET g_errparam.code   = SQLCA.sqlcode
               LET g_errparam.popup  = TRUE
               CALL cl_err()
               CONTINUE WHILE
         END CASE
         UPDATE sfac_t SET sfacdocno = g_sfaa_m.sfaadocno
          WHERE sfacent = g_enterprise AND sfacdocno = g_sfaadocno_t
         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            #   INITIALIZE g_errparam TO NULL
            #   LET g_errparam.extend = "sfac_t"
            #   LET g_errparam.code   = "std-00009"
            #   LET g_errparam.popup  = TRUE
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')
            #   CONTINUE WHILE
            WHEN SQLCA.sqlcode #其他錯誤
               CALL s_transaction_end('N','0')
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = "sfac_t:",SQLERRMESSAGE
               LET g_errparam.code   = SQLCA.sqlcode
               LET g_errparam.popup  = TRUE
               CALL cl_err()
               CONTINUE WHILE
         END CASE
         UPDATE sfaf_t SET sfafdocno = g_sfaa_m.sfaadocno
          WHERE sfafent = g_enterprise AND sfafdocno = g_sfaadocno_t
         CASE
            WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            #   INITIALIZE g_errparam TO NULL
            #   LET g_errparam.extend = "sfaf_t"
            #   LET g_errparam.code   = "std-00009"
            #   LET g_errparam.popup  = TRUE
            #   CALL cl_err()
            #   CALL s_transaction_end('N','0')
            #   CONTINUE WHILE
            WHEN SQLCA.sqlcode #其他錯誤
               CALL s_transaction_end('N','0')
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = "sfaf_t:",SQLERRMESSAGE
               LET g_errparam.code   = SQLCA.sqlcode
               LET g_errparam.popup  = TRUE
               CALL cl_err()
               CONTINUE WHILE
         END CASE
         
         #UPDATE 多語言table key值
         
         CALL s_transaction_end('Y','0')
      END IF
   
      EXIT WHILE
   END WHILE

   #根據資料狀態切換action狀態
   CALL asft300_set_act_visible()   
   CALL asft300_set_act_no_visible()

   #組合新增資料的條件
   LET g_add_browse = " sfaaent = '" ||g_enterprise|| "' AND sfaasite = '" ||g_site|| "' AND",
                      " sfaadocno = '", g_sfaa_m.sfaadocno, "' "
 
   #填到對應位置
   CALL asft300_browser_fill("")

   CLOSE asft300_cl
   
   CALL s_transaction_end('Y','0')

   #功能已完成,通報訊息中心
   CALL asft300_msgcentre_notify('modify')

END FUNCTION

################################################################################
# Descriptions...: 資料輸入
# Memo...........:
# Usage..........: CALL asft300_input(p_cmd)
# Input parameter: p_cmd
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_input(p_cmd)
   #add-point:input段define(客製用) name="input.define_customerization"

   #end add-point
   DEFINE  p_cmd                 LIKE type_t.chr1
   DEFINE  l_cmd_t               LIKE type_t.chr1
   DEFINE  l_cmd                 LIKE type_t.chr1
   DEFINE  l_n                   LIKE type_t.num10                #檢查重複用  
   DEFINE  l_cnt                 LIKE type_t.num10                #檢查重複用  
   DEFINE  l_lock_sw             LIKE type_t.chr1                #單身鎖住否  
   DEFINE  l_allow_insert        LIKE type_t.num5                #可新增否 
   DEFINE  l_allow_delete        LIKE type_t.num5                #可刪除否  
   DEFINE  l_count               LIKE type_t.num10
   DEFINE  l_i                   LIKE type_t.num10
   DEFINE  l_ac_t                LIKE type_t.num10
   DEFINE  l_insert              BOOLEAN
   DEFINE  ls_return             STRING
   DEFINE  l_var_keys            DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys          DYNAMIC ARRAY OF STRING
   DEFINE  l_vars                DYNAMIC ARRAY OF STRING
   DEFINE  l_fields              DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak        DYNAMIC ARRAY OF STRING
   DEFINE  lb_reproduce          BOOLEAN
   DEFINE  li_reproduce          LIKE type_t.num10
   DEFINE  li_reproduce_target   LIKE type_t.num10
   DEFINE  ls_keys               DYNAMIC ARRAY OF VARCHAR(500)
   #add-point:input段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="input.define"
   DEFINE  l_success             LIKE type_t.num5
   DEFINE  l_flag0               LIKE type_t.chr1
   DEFINE  l_flag1               LIKE type_t.chr1
   DEFINE  l_flag2               LIKE type_t.chr1      #20150730 add 拆件式判断是否是直接录入生产料号明细资料
   DEFINE  l_flag3               LIKE type_t.chr1
   DEFINE  l_sql                 STRING
   DEFINE  l_bmaa001             LIKE bmaa_t.bmaa001
   DEFINE  l_bmaastus            LIKE bmaa_t.bmaastus
   DEFINE  l_imae017             LIKE imae_t.imae017
   DEFINE  l_imae018             LIKE imae_t.imae018
   DEFINE  l_imae019             LIKE imae_t.imae019
   DEFINE  l_imae032             LIKE imae_t.imae032
   DEFINE  l_sfaa012             LIKE sfaa_t.sfaa012
   DEFINE  l_n_sfaa012           LIKE sfaa_t.sfaa012
   DEFINE  l_ooba002             LIKE ooba_t.ooba002
   DEFINE  l_num                 LIKE type_t.num5
   
   DEFINE  l_m             LIKE type_t.num5
   DEFINE  l_sys           LIKE type_t.num5 
   DEFINE  l_imaa006       LIKE imaa_t.imaa006
   DEFINE  l_rate          LIKE type_t.num26_10  
   DEFINE  l_imaa005       LIKE imaa_t.imaa005
   DEFINE  l_inam          DYNAMIC ARRAY OF RECORD   #記錄產品特徵
              inam001      LIKE inam_t.inam001,
              inam002      LIKE inam_t.inam002,
              inam004      LIKE inam_t.inam004
                           END RECORD
   DEFINE  l_flag          LIKE type_t.chr1
   DEFINE  l_sfba013       LIKE sfba_t.sfba013
   DEFINE  l_imae015       LIKE imae_t.imae015
   DEFINE  l_sfab007_sum   LIKE sfab_t.sfab007
   DEFINE  l_sfab007_sum1  LIKE sfab_t.sfab007
   DEFINE  l_bmba          DYNAMIC ARRAY OF RECORD
           bmba001         LIKE bmba_t.bmba001,    #bom相关资料都可以通过回传的key值抓取
           bmba002         LIKE bmba_t.bmba002,
           bmba003         LIKE bmba_t.bmba003,
           bmba004         LIKE bmba_t.bmba004,
           bmba005         DATETIME YEAR TO SECOND,
           bmba007         LIKE bmba_t.bmba007,
           bmba008         LIKE bmba_t.bmba008, 
           bmba035         LIKE bmba_t.bmba035,     #保稅否  #160512-00016#14
           l_bmba011       LIKE bmba_t.bmba011,     #QPA 分子，对应于原始的主件料号
           l_bmba012       LIKE bmba_t.bmba012,     #QPA 分母，对应于原始的主件料号
           l_inam002       LIKE inam_t.inam002      #元件对应特征
                           END RECORD
   DEFINE  l_sfac003       LIKE sfac_t.sfac003
   DEFINE  l_sfac003_sum   LIKE sfac_t.sfac003
   DEFINE  l_days          LIKE type_t.num5
   DEFINE  l_j             LIKE type_t.num5
   DEFINE  l_k             LIKE type_t.num5

   #161109-00085#27-s
   #DEFINE  l_sfba          RECORD LIKE sfba_t.*
   DEFINE l_sfba RECORD  #工單備料單身檔
       sfbaent LIKE sfba_t.sfbaent, #企業編號
       sfbasite LIKE sfba_t.sfbasite, #營運據點
       sfbadocno LIKE sfba_t.sfbadocno, #單號
       sfbaseq LIKE sfba_t.sfbaseq, #項次
       sfbaseq1 LIKE sfba_t.sfbaseq1, #項序
       sfba001 LIKE sfba_t.sfba001, #上階料號
       sfba002 LIKE sfba_t.sfba002, #部位
       sfba003 LIKE sfba_t.sfba003, #作業編號
       sfba004 LIKE sfba_t.sfba004, #作業序
       sfba005 LIKE sfba_t.sfba005, #BOM料號
       sfba006 LIKE sfba_t.sfba006, #發料料號
       sfba007 LIKE sfba_t.sfba007, #投料時距
       sfba008 LIKE sfba_t.sfba008, #必要特性
       sfba009 LIKE sfba_t.sfba009, #倒扣料
       sfba010 LIKE sfba_t.sfba010, #標準QPA分子
       sfba011 LIKE sfba_t.sfba011, #標準QPA分母
       sfba012 LIKE sfba_t.sfba012, #允許誤差率
       sfba013 LIKE sfba_t.sfba013, #應發數量
       sfba014 LIKE sfba_t.sfba014, #單位
       sfba015 LIKE sfba_t.sfba015, #委外代買數量
       sfba016 LIKE sfba_t.sfba016, #已發數量
       sfba017 LIKE sfba_t.sfba017, #報廢數量
       sfba018 LIKE sfba_t.sfba018, #盤虧數量
       sfba019 LIKE sfba_t.sfba019, #指定發料倉庫
       sfba020 LIKE sfba_t.sfba020, #指定發料儲位
       sfba021 LIKE sfba_t.sfba021, #產品特徵
       sfba022 LIKE sfba_t.sfba022, #替代率
       sfba023 LIKE sfba_t.sfba023, #標準應發數量
       sfba024 LIKE sfba_t.sfba024, #調整應發數量
       sfba025 LIKE sfba_t.sfba025, #超領數量
       sfba026 LIKE sfba_t.sfba026, #SET替代狀態
       sfba027 LIKE sfba_t.sfba027, #SET替代群組
       sfba028 LIKE sfba_t.sfba028, #客供料
       sfba029 LIKE sfba_t.sfba029, #指定發料批號
       sfba030 LIKE sfba_t.sfba030, #指定庫存管理特徵    
       #161109-00085#66 --s add
       sfbaud001 LIKE sfba_t.sfbaud001, #自定義欄位(文字)001
       sfbaud002 LIKE sfba_t.sfbaud002, #自定義欄位(文字)002
       sfbaud003 LIKE sfba_t.sfbaud003, #自定義欄位(文字)003
       sfbaud004 LIKE sfba_t.sfbaud004, #自定義欄位(文字)004
       sfbaud005 LIKE sfba_t.sfbaud005, #自定義欄位(文字)005
       sfbaud006 LIKE sfba_t.sfbaud006, #自定義欄位(文字)006
       sfbaud007 LIKE sfba_t.sfbaud007, #自定義欄位(文字)007
       sfbaud008 LIKE sfba_t.sfbaud008, #自定義欄位(文字)008
       sfbaud009 LIKE sfba_t.sfbaud009, #自定義欄位(文字)009
       sfbaud010 LIKE sfba_t.sfbaud010, #自定義欄位(文字)010
       sfbaud011 LIKE sfba_t.sfbaud011, #自定義欄位(數字)011
       sfbaud012 LIKE sfba_t.sfbaud012, #自定義欄位(數字)012
       sfbaud013 LIKE sfba_t.sfbaud013, #自定義欄位(數字)013
       sfbaud014 LIKE sfba_t.sfbaud014, #自定義欄位(數字)014
       sfbaud015 LIKE sfba_t.sfbaud015, #自定義欄位(數字)015
       sfbaud016 LIKE sfba_t.sfbaud016, #自定義欄位(數字)016
       sfbaud017 LIKE sfba_t.sfbaud017, #自定義欄位(數字)017
       sfbaud018 LIKE sfba_t.sfbaud018, #自定義欄位(數字)018
       sfbaud019 LIKE sfba_t.sfbaud019, #自定義欄位(數字)019
       sfbaud020 LIKE sfba_t.sfbaud020, #自定義欄位(數字)020
       sfbaud021 LIKE sfba_t.sfbaud021, #自定義欄位(日期時間)021
       sfbaud022 LIKE sfba_t.sfbaud022, #自定義欄位(日期時間)022
       sfbaud023 LIKE sfba_t.sfbaud023, #自定義欄位(日期時間)023
       sfbaud024 LIKE sfba_t.sfbaud024, #自定義欄位(日期時間)024
       sfbaud025 LIKE sfba_t.sfbaud025, #自定義欄位(日期時間)025
       sfbaud026 LIKE sfba_t.sfbaud026, #自定義欄位(日期時間)026
       sfbaud027 LIKE sfba_t.sfbaud027, #自定義欄位(日期時間)027
       sfbaud028 LIKE sfba_t.sfbaud028, #自定義欄位(日期時間)028
       sfbaud029 LIKE sfba_t.sfbaud029, #自定義欄位(日期時間)029
       sfbaud030 LIKE sfba_t.sfbaud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       sfba031 LIKE sfba_t.sfba031, #備置量
       sfba032 LIKE sfba_t.sfba032, #備置理由碼
       sfba033 LIKE sfba_t.sfba033, #保稅否
       sfba034 LIKE sfba_t.sfba034, #SET被替代群組
       sfba035 LIKE sfba_t.sfba035  #SET替代套數
   END RECORD
   #161109-00085#27-e
   
   #161109-00085#27-s
   #DEFINE  l_sfac          RECORD LIKE sfac_t.*
   DEFINE l_sfac RECORD  #工單聯產品檔
       sfacent LIKE sfac_t.sfacent, #企業編號
       sfacsite LIKE sfac_t.sfacsite, #營運據點
       sfacdocno LIKE sfac_t.sfacdocno, #單號
       sfac001 LIKE sfac_t.sfac001, #料件編號
       sfac002 LIKE sfac_t.sfac002, #類型
       sfac003 LIKE sfac_t.sfac003, #預計產出量
       sfac004 LIKE sfac_t.sfac004, #單位
       sfac005 LIKE sfac_t.sfac005, #實際產出數量
       sfacseq LIKE sfac_t.sfacseq, #項次
       sfac006 LIKE sfac_t.sfac006, #產品特徵
       #161109-00085#66 --s add
       sfacud001 LIKE sfac_t.sfacud001, #自定義欄位(文字)001
       sfacud002 LIKE sfac_t.sfacud002, #自定義欄位(文字)002
       sfacud003 LIKE sfac_t.sfacud003, #自定義欄位(文字)003
       sfacud004 LIKE sfac_t.sfacud004, #自定義欄位(文字)004
       sfacud005 LIKE sfac_t.sfacud005, #自定義欄位(文字)005
       sfacud006 LIKE sfac_t.sfacud006, #自定義欄位(文字)006
       sfacud007 LIKE sfac_t.sfacud007, #自定義欄位(文字)007
       sfacud008 LIKE sfac_t.sfacud008, #自定義欄位(文字)008
       sfacud009 LIKE sfac_t.sfacud009, #自定義欄位(文字)009
       sfacud010 LIKE sfac_t.sfacud010, #自定義欄位(文字)010
       sfacud011 LIKE sfac_t.sfacud011, #自定義欄位(數字)011
       sfacud012 LIKE sfac_t.sfacud012, #自定義欄位(數字)012
       sfacud013 LIKE sfac_t.sfacud013, #自定義欄位(數字)013
       sfacud014 LIKE sfac_t.sfacud014, #自定義欄位(數字)014
       sfacud015 LIKE sfac_t.sfacud015, #自定義欄位(數字)015
       sfacud016 LIKE sfac_t.sfacud016, #自定義欄位(數字)016
       sfacud017 LIKE sfac_t.sfacud017, #自定義欄位(數字)017
       sfacud018 LIKE sfac_t.sfacud018, #自定義欄位(數字)018
       sfacud019 LIKE sfac_t.sfacud019, #自定義欄位(數字)019
       sfacud020 LIKE sfac_t.sfacud020, #自定義欄位(數字)020
       sfacud021 LIKE sfac_t.sfacud021, #自定義欄位(日期時間)021
       sfacud022 LIKE sfac_t.sfacud022, #自定義欄位(日期時間)022
       sfacud023 LIKE sfac_t.sfacud023, #自定義欄位(日期時間)023
       sfacud024 LIKE sfac_t.sfacud024, #自定義欄位(日期時間)024
       sfacud025 LIKE sfac_t.sfacud025, #自定義欄位(日期時間)025
       sfacud026 LIKE sfac_t.sfacud026, #自定義欄位(日期時間)026
       sfacud027 LIKE sfac_t.sfacud027, #自定義欄位(日期時間)027
       sfacud028 LIKE sfac_t.sfacud028, #自定義欄位(日期時間)028
       sfacud029 LIKE sfac_t.sfacud029, #自定義欄位(日期時間)029
       sfacud030 LIKE sfac_t.sfacud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       sfac007 LIKE sfac_t.sfac007  #保稅否
   END RECORD
   #161109-00085#27-e
   
   DEFINE  l_imaa005_1     LIKE imaa_t.imaa005
   DEFINE  l_msg           STRING
   DEFINE  l_sfaa007_str   STRING
   DEFINE  l_sfaa008_str   STRING
   DEFINE  l_sfaa063_str   STRING
   DEFINE  l_imae082       LIKE imae_t.imae082
   DEFINE  l_imae083       LIKE imae_t.imae083
   DEFINE  l_imae084       LIKE imae_t.imae084
   DEFINE  l_n_sfba013     LIKE type_t.num20
   DEFINE  l_sfab007       LIKE sfab_t.sfab007  #接收單位轉換過的回傳數量  by dorislai 20150714
   DEFINE  l_psab004       LIKE psab_t.psab004  #抓取工單來源的需求單位    by dorislai 20150714
   DEFINE  l_where         STRING               #150909 earl add
   #151117-00019#3-s
   #來源單號=獨立需求單
   DEFINE  l_psabdocno     LIKE sfaa_t.sfaa006
   DEFINE  l_psabseq       LIKE sfaa_t.sfaa007
   DEFINE  l_docno_t       LIKE sfaa_t.sfaa006
   DEFINE  l_seq_t         LIKE sfaa_t.sfaa007
   DEFINE  l_item_t        LIKE sfaa_t.sfaa010
   DEFINE  l_qty_t         LIKE sfaa_t.sfaa012
   #151117-00019#3-e
   DEFINE  l_psad004       LIKE psad_t.psad004  #151207-00017#2
   #161226-00033#1-s-add
   DEFINE  l_sfcb002       LIKE sfcb_t.sfcb002
   DEFINE  l_sfcb021       LIKE sfcb_t.sfcb021
   DEFINE  l_sfcb022       LIKE sfcb_t.sfcb022
   DEFINE  l_sfcb027       LIKE sfcb_t.sfcb027
   DEFINE  l_sql_2         STRING
   DEFINE  l_success_2     LIKE type_t.num5
   #161226-00033#1-e-add
   #170309-00002#1 add  --begin--
   DEFINE   l_inam001      LIKE inam_t.inam001
   DEFINE   l_inam002      LIKE inam_t.inam002
   DEFINE   l_inam004      LIKE inam_t.inam004
   #170309-00002#1 add  --end--
   #160701-00010#1 add --(S)--
   DEFINE   l_prog         STRING
   #160701-00010#1 add --(E)--
   #end add-point

   #add-point:Function前置處理  name="input.pre_function"

   #end add-point
   
   #先做狀態判定
   IF p_cmd = 'r' THEN
      LET l_cmd_t = 'r'
      LET p_cmd   = 'a'      
   ELSE
      LET l_cmd_t = p_cmd
   END IF
   
   #將資料輸出到畫面上
   DISPLAY BY NAME g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.oobal004,g_sfaa_m.sfaadocdt,g_sfaa_m.sfaa002,
           g_sfaa_m.sfaa002_desc,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,
           g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,
           g_sfaa_m.l_sfaa007,g_sfaa_m.sfaa009,g_sfaa_m.sfaa009_desc,g_sfaa_m.sfaa022,g_sfaa_m.l_sfaa023,
           g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,g_sfaa_m.sfaa024,g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,
           g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1,g_sfaa_m.sfaa012,
           g_sfaa_m.sfaa013,g_sfaa_m.sfaa013_desc,g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa060_desc,
           g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,g_sfaa_m.sfaa016_desc,g_sfaa_m.sfaa017,g_sfaa_m.sfaa017_desc,
           g_sfaa_m.sfaa018,g_sfaa_m.sfaa018_desc,g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,
           g_sfaa_m.sfaa068_desc,g_sfaa_m.sfaa014,g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.imae020,
           g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,g_sfaa_m.sfaa028_desc,g_sfaa_m.sfaa029,g_sfaa_m.sfaa029_desc,
           g_sfaa_m.sfaa030,g_sfaa_m.sfaa030_desc,g_sfaa_m.sfaa031,g_sfaa_m.sfaa031_desc,g_sfaa_m.sfaa032,
           g_sfaa_m.sfaa033,g_sfaa_m.sfaa034,g_sfaa_m.sfaa034_desc,g_sfaa_m.sfaa035,g_sfaa_m.sfaa035_desc,
           g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,g_sfaa_m.sfaa037,g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,
           g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,g_sfaa_m.sfaa041,g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,
           g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,g_sfaa_m.sfaa070,g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,
           g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,g_sfaa_m.sfaa065,g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,
           #g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,g_sfaa_m.sfaa056,g_sfaa_m.ooff013,g_sfaa_m.sfaaownid,   #161031-00025#17 mark
           g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,g_sfaa_m.sfaa056,g_sfaa_m.sfaaownid,                     #161031-00025#17 add
           g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,g_sfaa_m.sfaaowndp_desc,g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtid_desc,
           g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdp_desc,g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,g_sfaa_m.sfaamodid_desc,
           g_sfaa_m.sfaamoddt,g_sfaa_m.sfaacnfid,g_sfaa_m.sfaacnfid_desc,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,
           g_sfaa_m.sfaapstid_desc,g_sfaa_m.sfaapstdt
   
   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF
 
   CALL cl_set_head_visible("","YES")  
 
   LET l_insert = FALSE
   LET g_action_choice = ""
 
   #add-point:input段define_sql name="input.define_sql"

   #end add-point
   LET g_forupd_sql = " SELECT sfbaseq,sfbaseq1,sfba002,sfba003,sfba004,sfba005,sfba022,sfba006,sfba033,sfba021, ",
                             " sfba007,sfba008,sfba009,sfba010,sfba011,sfba012,sfba023,sfba024,sfba013,sfba014, ",
                             " sfba015,sfba016,sfba025,sfba017,sfba018,sfba019,sfba020,sfba029,sfba030,sfba028, ",
                             " sfba001,sfba026,sfba027,sfba034,sfba035 ",
                        " FROM sfba_t WHERE sfbaent=? AND sfbasite=? AND sfbadocno=? AND sfbaseq=? AND sfbaseq1=? FOR UPDATE "
   #add-point:input段define_sql name="input.after_define_sql"

   #end add-point 
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE asft300_bcl CURSOR FROM g_forupd_sql
   
   LET g_forupd_sql = " SELECT sfabseq,sfab001,sfab002,sfab003,sfab004,sfab005,sfab006,sfab007 ",
                      "   FROM sfab_t ",
                      "  WHERE sfabent=? AND sfabsite=? AND sfabdocno=?  AND sfabseq=? FOR UPDATE"
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE asft300_sfab_bcl CURSOR FROM g_forupd_sql
   
   LET g_forupd_sql = " SELECT sfacseq,sfac002,sfac001,sfac006,sfac003,sfac004,sfac005 ",
                      "   FROM sfac_t ",
                      "  WHERE sfacent=? AND sfacsite=? AND sfacdocno=? AND sfacseq=? FOR UPDATE "
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE asft300_sfac_bcl CURSOR FROM g_forupd_sql
   
   LET g_forupd_sql = " SELECT sfafseq,sfaf001 ",
                      "   FROM sfaf_t ",
                      "  WHERE sfafent=? AND sfafsite=? AND sfafdocno=? AND sfafseq=? FOR UPDATE "
   LET g_forupd_sql = cl_sql_forupd(g_forupd_sql)
   LET g_forupd_sql = cl_sql_add_mask(g_forupd_sql)              #遮蔽特定資料
   DECLARE asft300_sfaf_bcl CURSOR FROM g_forupd_sql
   
   #add-point:input段define_sql name="input.other_sql"

   #end add-point

   LET l_allow_insert = cl_auth_detail_input("insert")
   LET l_allow_delete = cl_auth_detail_input("delete")
   LET g_qryparam.state = 'i'
   
   #控制key欄位可否輸入
   CALL asft300_set_entry(p_cmd)
   #add-point:set_entry後 name="input.after_set_entry"
   #161031-00025#17-s
   LET g_detail_insert = l_allow_insert
   LET g_detail_delete = l_allow_delete
   #161031-00025#17-e
   #end add-point
   CALL asft300_set_no_entry(p_cmd)

   DISPLAY BY NAME g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.oobal004,g_sfaa_m.sfaadocdt,g_sfaa_m.sfaa002,
           g_sfaa_m.sfaa002_desc,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,
           g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,
           g_sfaa_m.l_sfaa007,g_sfaa_m.sfaa009,g_sfaa_m.sfaa009_desc,g_sfaa_m.sfaa022,g_sfaa_m.l_sfaa023,
           g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,g_sfaa_m.sfaa024,g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,
           g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1,g_sfaa_m.sfaa012,
           g_sfaa_m.sfaa013,g_sfaa_m.sfaa013_desc,g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa060_desc,
           g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,g_sfaa_m.sfaa016_desc,g_sfaa_m.sfaa017,g_sfaa_m.sfaa017_desc,
           g_sfaa_m.sfaa018,g_sfaa_m.sfaa018_desc,g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,
           g_sfaa_m.sfaa068_desc,g_sfaa_m.sfaa014,g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.imae020,
           g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,g_sfaa_m.sfaa028_desc,g_sfaa_m.sfaa029,g_sfaa_m.sfaa029_desc,
           g_sfaa_m.sfaa030,g_sfaa_m.sfaa030_desc,g_sfaa_m.sfaa031,g_sfaa_m.sfaa031_desc,g_sfaa_m.sfaa032,
           g_sfaa_m.sfaa033,g_sfaa_m.sfaa034,g_sfaa_m.sfaa034_desc,g_sfaa_m.sfaa035,g_sfaa_m.sfaa035_desc,
           g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,g_sfaa_m.sfaa037,g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,
           g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,g_sfaa_m.sfaa041,g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,
           g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,g_sfaa_m.sfaa070,g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,
           g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,g_sfaa_m.sfaa065,g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,
           #g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,g_sfaa_m.sfaa056,g_sfaa_m.ooff013,g_sfaa_m.sfaaownid,  #161031-00025#17 mark
           g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,g_sfaa_m.sfaa056,g_sfaa_m.sfaaownid,                    #161031-00025#17 add
           g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,g_sfaa_m.sfaaowndp_desc,g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtid_desc,
           g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdp_desc,g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,g_sfaa_m.sfaamodid_desc,
           g_sfaa_m.sfaamoddt,g_sfaa_m.sfaacnfid,g_sfaa_m.sfaacnfid_desc,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,
           g_sfaa_m.sfaapstid_desc,g_sfaa_m.sfaapstdt
   
   LET lb_reproduce = FALSE
   LET l_ac_t = 1
   
   #關閉被遮罩相關欄位輸入, 無法確定USER是否會需要輸入此欄位
   #因此先行關閉, 若有需要可於下方add-point中自行開啟
   CALL cl_mask_set_no_entry()
   
   #add-point:資料輸入前 name="input.before_input"
   
   LET l_flag1 = 'N'
   LET l_flag0 = 'Y'
   LET l_flag3 = 'Y'
   
   LET g_errshow = 1   #160727-00025#1 
   
WHILE TRUE
   #end add-point
   
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
   
      #單頭段
      INPUT BY NAME g_sfaa_m.sfaadocno,g_sfaa_m.sfaadocdt,g_sfaa_m.sfaa002,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,
                    g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,
                    g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,g_sfaa_m.l_sfaa007,g_sfaa_m.sfaa009,g_sfaa_m.sfaa010,
                    g_sfaa_m.sfaa011,g_sfaa_m.sfaa012,g_sfaa_m.sfaa013,g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,
                    g_sfaa_m.sfaa016,g_sfaa_m.sfaa017,g_sfaa_m.sfaa018,g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,
                    g_sfaa_m.sfaa068,g_sfaa_m.sfaa014,g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.sfaa062,
                    g_sfaa_m.sfaa028,g_sfaa_m.sfaa029,g_sfaa_m.sfaa030,g_sfaa_m.sfaa031,g_sfaa_m.sfaa032,
                    g_sfaa_m.sfaa033,g_sfaa_m.sfaa034,g_sfaa_m.sfaa035,g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,
                    g_sfaa_m.sfaa037,g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,g_sfaa_m.sfaa041


         ATTRIBUTE(WITHOUT DEFAULTS)
         
         #自訂ACTION(master_input)
         
     
         BEFORE INPUT
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF
            OPEN asft300_cl USING g_enterprise,g_site,g_sfaa_m.sfaadocno
            IF STATUS THEN
               CLOSE asft300_cl
               CALL s_transaction_end('N','0')
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN asft300_cl:" 
               LET g_errparam.code   = STATUS 
               LET g_errparam.popup  = TRUE 
               CALL cl_err()
               RETURN
            END IF
            
            IF l_cmd_t = 'r' THEN
               
            END IF
            #因應離開單頭後已寫入資料庫, 若重新回到單頭則視為修改
            #因此需於此處開啟/關閉欄位
            CALL asft300_set_entry(p_cmd)
            #add-point:資料輸入前 name="input.m.before_input"
            #151117-00019#3-s
            IF g_sfaa_m_t.sfaa005 = '6' OR g_sfaa_m_t.sfaa005 = '7' THEN   #151207-00017#2
               LET l_docno_t = g_sfaa_m_t.sfaa006
               LET l_seq_t = g_sfaa_m_t.sfaa007
            ELSE
               LET l_docno_t = g_sfaa_m_t.sfaa022
               LET l_seq_t = g_sfaa_m_t.sfaa023
            END IF
            LET l_item_t = g_sfaa_m_t.sfaa010
            LET l_qty_t = g_sfaa_m_t.sfaa012
            #151117-00019#3-e
            #end add-point
            CALL asft300_set_no_entry(p_cmd)
    

         #---------------------------<  Master  >---------------------------

         AFTER FIELD sfaadocno
            #160714-00018-s
            LET g_sfaa_m.oobal004 = ''
            IF NOT cl_null(g_sfaa_m.sfaadocno) THEN
               IF g_sfaa_m.sfaadocno != g_sfaa_m_o.sfaadocno OR cl_null(g_sfaa_m_o.sfaadocno) THEN
                  IF NOT asft300_sfaadocno_chk() THEN
                     LET g_sfaa_m.sfaadocno = g_sfaa_m_o.sfaadocno
                     LET g_sfaa_m.oobal004 = s_aooi200_get_slip_desc(g_sfaa_m.sfaadocno)
                     DISPLAY BY NAME g_sfaa_m.sfaadocno,g_sfaa_m.oobal004
                     NEXT FIELD CURRENT
                  END IF
               END IF
               #单别带出单据名称
               LET g_sfaa_m.oobal004 = s_aooi200_get_slip_desc(g_sfaa_m.sfaadocno)
               DISPLAY BY NAME g_sfaa_m.oobal004
               #161116-00048#1 mod-s
               #CALL asft300_sfaadocno_default()
               CALL asft300_sfaadocno_default()
                  RETURNING l_success
               IF NOT l_success THEN
                  LET g_sfaa_m.sfaadocno = g_sfaa_m_o.sfaadocno
                  LET g_sfaa_m.oobal004 = s_aooi200_get_slip_desc(g_sfaa_m.sfaadocno)
                  DISPLAY BY NAME g_sfaa_m.sfaadocno,g_sfaa_m.oobal004
                  NEXT FIELD CURRENT
               END IF
               #161116-00048#1 mod--e
            END IF
            LET g_sfaa_m_o.sfaadocno = g_sfaa_m.sfaadocno
            CALL asft300_set_entry(p_cmd)
            CALL asft300_set_no_entry(p_cmd)
            #160714-00018-e

         AFTER FIELD sfaadocdt
            IF NOT cl_null(g_sfaa_m.sfaadocdt) THEN
               IF g_sfaa_m.sfaadocdt != g_sfaa_m_o.sfaadocdt OR cl_null(g_sfaa_m_o.sfaadocdt) THEN
                  IF NOT cl_null(g_sfaa_m.sfaa019) THEN
                     IF g_sfaa_m.sfaadocdt > g_sfaa_m.sfaa019 THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'asf-00308'
                        LET g_errparam.extend = g_sfaa_m.sfaa019
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        LET g_sfaa_m.sfaadocdt = g_sfaa_m_o.sfaadocdt
                        DISPLAY BY NAME g_sfaa_m.sfaadocdt
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
            END IF
            LET g_sfaa_m_o.sfaadocdt = g_sfaa_m.sfaadocdt

         AFTER FIELD sfaa002
            LET g_sfaa_m.sfaa002_desc = ''
            IF NOT cl_null(g_sfaa_m.sfaa002) THEN
               IF g_sfaa_m.sfaa002 != g_sfaa_m_o.sfaa002 OR cl_null(g_sfaa_m_o.sfaa002) THEN
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_sfaa_m.sfaa002
                  #160318-00025#4-s
                  LET g_errshow = TRUE 
                  LET g_chkparam.err_str[1] = "aim-00070:sub-01302|aooi130|",cl_get_progname("aooi130",g_lang,"2"),"|:EXEPROGaooi130"
                  #160318-00025#4-e
                  IF NOT cl_chk_exist("v_ooag001") THEN
                     LET g_sfaa_m.sfaa002 = g_sfaa_m_o.sfaa002
                     LET g_sfaa_m.sfaa002_desc = s_desc_get_person_desc(g_sfaa_m.sfaa002)
                     DISPLAY BY NAME g_sfaa_m.sfaa002,g_sfaa_m.sfaa002_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
               LET g_sfaa_m.sfaa002_desc = s_desc_get_person_desc(g_sfaa_m.sfaa002)
               DISPLAY BY NAME g_sfaa_m.sfaa002_desc
            END IF
            LET g_sfaa_m_o.sfaa002 = g_sfaa_m.sfaa002

         AFTER FIELD sfaa003
            CALL asft300_set_entry(p_cmd)
            CALL asft300_set_no_entry(p_cmd)

         AFTER FIELD sfaa057
            #160616-00014-s
            CALL asft300_set_entry(p_cmd)
            CALL asft300_set_no_entry(p_cmd)
            #160616-00014-e

         AFTER FIELD sfaa005
            IF NOT cl_null(g_sfaa_m.sfaa005) THEN
               IF g_sfaa_m.sfaa005 != g_sfaa_m_o.sfaa005 OR cl_null(g_sfaa_m_o.sfaa005) THEN
                  IF g_sfaa_m.sfaa005 MATCHES '[34]' THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'asf-00316'
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_sfaa_m.sfaa005 = g_sfaa_m_o.sfaa005
                     DISPLAY BY NAME g_sfaa_m.sfaa005
                     NEXT FIELD CURRENT
                  END IF
                  IF g_sfaa_m.sfaa005 MATCHES '[01]' THEN
                     LET g_sfaa_m.sfaa006 = ''
                     LET g_sfaa_m.sfaa007 = ''
                     LET g_sfaa_m.sfaa008 = ''
                     LET g_sfaa_m.sfaa063 = ''
                     LET g_sfaa_m.l_sfaa007 = ''
                     DISPLAY BY NAME g_sfaa_m.sfaa006,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.l_sfaa007
                     IF cl_null(g_sfaa_m.sfaa019) THEN
                        LET g_sfaa_m.sfaa019 = cl_get_today()
                        DISPLAY BY NAME g_sfaa_m.sfaa019
                     END IF
                     
                     #當為MULTI時，先開啟多訂單來源產生子畫面，產生完後再進入工單來源頁籤
                     IF g_sfaa_m.sfaa005 = '1' THEN
                     
                        #160708-00003#1-s
                        IF NOT cl_null(g_sfaa_m.sfaa010) THEN
                           SELECT imaf034 INTO g_sfaa_m.sfaa072
                             FROM imaf_t
                            WHERE imafent = g_enterprise
                              AND imafsite = g_site
                              AND imaf001 = g_sfaa_m.sfaa010
                           #170322-00078#1 add --(S)--
                           IF cl_null(g_sfaa_m.sfaa072) THEN
                              LET g_sfaa_m.sfaa072 = 'N'
                           END IF
                           #170322-00078#1 add --(E)--                           
                           DISPLAY BY NAME g_sfaa_m.sfaa072
                        END IF
                        #160708-00003#1-e
                        #SELECT MAX(xmdd011) INTO g_sfaa_m.sfaa019 FROM xmdd_t WHERE xmddent=g_enterprise AND xmddsite=g_site AND (xmdddocno,xmddseq,xmddseq1,xmddseq2) IN (SELECT sfab002,sfab003,sfab004,sfab005 FROM sfab_t WHERE sfabent=g_enterprise AND sfabsite=g_site AND sfabdocno=g_sfaa_m.sfaadocno)
                        
                        IF p_cmd <> 'u' THEN
                           LET g_sfaa_m_t.sfaadocno = g_sfaa_m.sfaadocno
                           #自动编号
                           CALL s_aooi200_gen_docno(g_site,g_sfaa_m.sfaadocno,g_sfaa_m.sfaadocdt,g_prog)
                                RETURNING l_success,g_sfaa_m.sfaadocno
                           IF NOT l_success THEN
                              NEXT FIELD sfaadocno
                           ELSE
                              LET l_cnt = 0
                              SELECT COUNT(1) INTO l_cnt FROM sfaa_t
                               WHERE sfaaent = g_enterprise AND sfaasite = g_site AND sfaadocno = g_sfaa_m.sfaadocno
                              IF l_cnt = 0 THEN
                                 INSERT INTO sfaa_t (sfaaent,sfaasite,sfaadocno,sfaa001,sfaadocdt,sfaa002,sfaa003,sfaa057,sfaa004,sfaastus,
                                                     sfaa005,sfaa007,sfaa008,sfaa063,sfaa006,sfaa009,sfaa022,sfaa021,sfaa023,sfaa024,
                                                     sfaa064,sfaa025,sfaa010,sfaa011,sfaa012,sfaa013,sfaa058,sfaa060,sfaa061,sfaa016,
                                                     sfaa017,sfaa018,sfaa019,sfaa020,sfaa068,sfaa014,sfaa015,sfaa026,sfaa062,sfaa028,
                                                     sfaa029,sfaa030,sfaa031,sfaa032,sfaa033,sfaa034,sfaa035,sfaa059,sfaa036,sfaa037,
                                                     sfaa038,sfaa072,sfaa039,sfaa040,sfaa041,sfaa042,sfaa043,sfaa044,sfaa069,sfaa070,
                                                     sfaa045,sfaa046,sfaa047,sfaa048,sfaa065,sfaa049,sfaa050,sfaa051,sfaa055,sfaa056,
                                                     sfaaownid,sfaaowndp,sfaacrtid,sfaacrtdp,sfaacrtdt,sfaamodid,sfaamoddt,sfaacnfid,sfaacnfdt,sfaapstid,sfaapstdt)
                                 VALUES (g_enterprise,g_site,g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.sfaadocdt,
                                         g_sfaa_m.sfaa002,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,
                                         g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,
                                         g_sfaa_m.sfaa009,g_sfaa_m.sfaa022,g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,g_sfaa_m.sfaa024,
                                         g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa012,
                                         g_sfaa_m.sfaa013,g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,
                                         g_sfaa_m.sfaa017,g_sfaa_m.sfaa018,g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,
                                         g_sfaa_m.sfaa014,g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,
                                         g_sfaa_m.sfaa029,g_sfaa_m.sfaa030,g_sfaa_m.sfaa031,g_sfaa_m.sfaa032,g_sfaa_m.sfaa033,
                                         g_sfaa_m.sfaa034,g_sfaa_m.sfaa035,g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,g_sfaa_m.sfaa037,
                                         g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,g_sfaa_m.sfaa041,
                                         g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,g_sfaa_m.sfaa070,
                                         g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,g_sfaa_m.sfaa065,
                                         g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,g_sfaa_m.sfaa056,
                                         g_sfaa_m.sfaaownid,g_sfaa_m.sfaaowndp,g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,
                                         g_sfaa_m.sfaamoddt,g_sfaa_m.sfaacnfid,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,g_sfaa_m.sfaapstdt) # DISK WRITE
                                 IF SQLCA.sqlcode THEN
                                    INITIALIZE g_errparam TO NULL
                                    LET g_errparam.extend = "sfaa_t:",SQLERRMESSAGE
                                    LET g_errparam.code   = SQLCA.sqlcode
                                    LET g_errparam.popup  = TRUE
                                    CALL cl_err()
                                 END IF
                              END IF
                           END IF
                        END IF
                        
                          CALL asft300_01(g_sfaa_m.sfaadocno)
                          #170309-00002#1 add  --begin--
                          #记录订单料件对应的产品特征
                          CALL g_inam.clear() 
                          LET g_inam004_sum = 0 
                          LET l_i = 1
                          DECLARE asft300_inam_c 
                           CURSOR FOR SELECT xmdd001,xmdd002,sfab007
                                        FROM sfab_t ,xmdd_t
                                       WHERE sfabent=g_enterprise
                                         AND sfabsite=g_site
                                         AND sfabdocno=g_sfaa_m.sfaadocno
                                         AND sfabent=xmddent
                                         AND sfabsite=xmddsite
                                         AND sfab002=xmdddocno
                                         AND sfab003=xmddseq
                                         AND sfab004=xmddseq1
                                         AND sfab005=xmddseq2
                                         
                          FOREACH asft300_inam_c INTO l_inam001,l_inam002,l_inam004
                             LET g_inam[l_i].inam001 = l_inam001
                             LET g_inam[l_i].inam002 = l_inam002
                             LET g_inam[l_i].inam004 = l_inam004
                             LET l_i = l_i + 1
                             LET g_inam004_sum = g_inam004_sum+l_inam004
                          END FOREACH
                          #170309-00002#1 add  --end--
                          LET l_cnt = 0
                          SELECT COUNT(1) INTO l_cnt FROM sfab_t
                           WHERE sfabent=g_enterprise AND sfabsite=g_site AND sfabdocno=g_sfaa_m.sfaadocno
                          IF l_cnt > 0 THEN
                             LET l_flag0 = 'N'
                           #重新取得與顯示完整單據資料(最新單據資料)
                           EXECUTE asft300_master_referesh USING g_sfaa_m.sfaadocno
                              INTO g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.oobal004,g_sfaa_m.sfaadocdt,g_sfaa_m.sfaa002,
                                   g_sfaa_m.sfaa002_desc,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,
                                   g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,
                                   g_sfaa_m.sfaa009,g_sfaa_m.sfaa009_desc,g_sfaa_m.sfaa022,g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,
                                   g_sfaa_m.sfaa024,g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,
                                   g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1,g_sfaa_m.sfaa012,g_sfaa_m.sfaa013,g_sfaa_m.sfaa013_desc,
                                   g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa060_desc,g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,
                                   g_sfaa_m.sfaa016_desc,g_sfaa_m.sfaa017,g_sfaa_m.sfaa017_desc,g_sfaa_m.sfaa018,g_sfaa_m.sfaa018_desc,
                                   g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,g_sfaa_m.sfaa068_desc,g_sfaa_m.sfaa014,
                                   g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.imae020,g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,
                                   g_sfaa_m.sfaa028_desc,g_sfaa_m.sfaa029,g_sfaa_m.sfaa029_desc,g_sfaa_m.sfaa030,g_sfaa_m.sfaa030_desc,
                                   g_sfaa_m.sfaa031,g_sfaa_m.sfaa031_desc,g_sfaa_m.sfaa032,g_sfaa_m.sfaa033,g_sfaa_m.sfaa034,
                                   g_sfaa_m.sfaa034_desc,g_sfaa_m.sfaa035,g_sfaa_m.sfaa035_desc,g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,
                                   g_sfaa_m.sfaa037,g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,
                                   g_sfaa_m.sfaa041,g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,
                                   g_sfaa_m.sfaa070,g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,
                                   g_sfaa_m.sfaa065,g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,
                                   #g_sfaa_m.sfaa056,g_sfaa_m.ooff013,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,   #161031-00025#17 mark
                                   g_sfaa_m.sfaa056,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,                     #161031-00025#17 add
                                   g_sfaa_m.sfaaowndp_desc,g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtid_desc,g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdp_desc,
                                   g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,g_sfaa_m.sfaamodid_desc,g_sfaa_m.sfaamoddt,g_sfaa_m.sfaacnfid,
                                   g_sfaa_m.sfaacnfid_desc,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,g_sfaa_m.sfaapstid_desc,g_sfaa_m.sfaapstdt
                           CALL asft300_show()
                           
                             #写入工单生产料号明细,拆件式不控管
                             IF g_sfaa_m.sfaa003 != '3' AND
                              NOT cl_null(g_sfaa_m.sfaa010) AND
                              g_sfaa_m.sfaa011 IS NOT NULL AND
                              p_cmd = 'a' AND
                              l_flag1 = 'N' THEN
                              CALL asft300_ins_sfac()
                              LET l_flag1 = 'Y'
                           END IF
                           
                           #20150730 by wuxja  --begin--
                           IF g_sfaa_m.sfaa003 = '3' THEN
                              IF g_inam.getLength() > 0 THEN
                                 CALL asft300_07(g_sfaa_m.sfaadocno,g_inam) RETURNING l_flag2
                              ELSE
                                 IF asft300_sfaa010_feature() THEN
                                    CALL asft300_07(g_sfaa_m.sfaadocno,g_inam) RETURNING l_flag2
                                 END IF
                              END IF
                           END IF
                           #20150730 by wuxja  --end--
                           
                           CALL s_transaction_end('Y','0')
                             #170320-00006#1 add --(S)--
                             IF p_cmd = 'a' THEN
                                LET g_master_insert = TRUE
                             END IF                                
                             #170320-00006#1 add --(E)--
                             LET p_cmd = 'u'
                             LET g_sfaadocno_t = g_sfaa_m.sfaadocno
                             LET g_sfaa_m.sfaamodid = g_user
                           LET g_sfaa_m.sfaamoddt = cl_get_current()
                           #160921-00022#1-s-add
                           SELECT imae035,(CASE imae014 WHEN '0' THEN '1' WHEN '1' THEN '2' END )
                            INTO g_sfaa_m.sfaa068,g_sfaa_m.sfaa004 
                             FROM imae_t WHERE imaeent=g_enterprise AND imaesite=g_site AND imae001=g_sfaa_m.sfaa010
                           #取成本中心說明
                           LET g_sfaa_m.sfaa068_desc = s_desc_get_department_desc(g_sfaa_m.sfaa068)
                           DISPLAY BY NAME g_sfaa_m.sfaa068,g_sfaa_m.sfaa004,g_sfaa_m.sfaa068_desc
                           #160921-00022#1-e-add
                             EXIT DIALOG
                          ELSE
                             LET g_sfaa_m.sfaadocno = g_sfaa_m_t.sfaadocno
                          END IF
                     END IF
                  END IF
                  #非人工录入时推算预计开工日和预计完工日
                  IF g_sfaa_m.sfaa005 != 0 THEN
                  END IF
               END IF
            END IF
            LET g_sfaa_m_o.sfaa005 = g_sfaa_m.sfaa005
            CALL asft300_set_entry(p_cmd)
            CALL asft300_set_no_entry(p_cmd)

         ON CHANGE sfaa005
            #doriali-20150709-modify----(S)
            #當工單來源為2or6時，若單號與其工單來源不符，需清空相關欄位
            IF g_sfaa_m.sfaa005 MATCHES '[267]' THEN   #151207-00017#2
               IF NOT asft300_sfaa006_chk1() THEN
                  LET g_sfaa_m.sfaa006 = ''      #清空單號
                  LET g_sfaa_m.sfaa007 = ''      #清空項次
                  LET g_sfaa_m.sfaa008 = ''      #清空項序
                  LET g_sfaa_m.sfaa063 = ''      #清空分批序
                  LET g_sfaa_m.l_sfaa007 = ''    #清空項次
                  LET g_sfaa_m.sfaa009 = ''      #清空參考客戶
                  LET g_sfaa_m.sfaa010 = ''      #清空料號
                  LET g_sfaa_m.sfaa012 = ''      #清空生產數量
                  LET g_sfaa_m.sfaa013 = ''      #清空生產單位
                  LET g_sfaa_m.sfaa010_desc = '' #清空品名
                  LET g_sfaa_m.sfaa010_desc1 = ''#清空規格
               END IF
            END IF
            #dorislai-20150709-modify----(E)

         AFTER FIELD sfaa007
            IF NOT asft300_sfaa006_chk() THEN
               LET g_sfaa_m.sfaa006 = g_sfaa_m_o.sfaa006
               LET g_sfaa_m.sfaa007 = g_sfaa_m_o.sfaa007
               LET g_sfaa_m.sfaa008 = g_sfaa_m_o.sfaa008
               LET g_sfaa_m.sfaa063 = g_sfaa_m_o.sfaa063
               DISPLAY BY NAME g_sfaa_m.sfaa006,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063
               NEXT FIELD CURRENT
            END IF

         AFTER FIELD sfaa008
            IF NOT asft300_sfaa006_chk() THEN
               LET g_sfaa_m.sfaa006 = g_sfaa_m_o.sfaa006
               LET g_sfaa_m.sfaa007 = g_sfaa_m_o.sfaa007
               LET g_sfaa_m.sfaa008 = g_sfaa_m_o.sfaa008
               LET g_sfaa_m.sfaa063 = g_sfaa_m_o.sfaa063
               DISPLAY BY NAME g_sfaa_m.sfaa006,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063
               NEXT FIELD CURRENT
            END IF

         AFTER FIELD sfaa063
            IF NOT asft300_sfaa006_chk() THEN
               LET g_sfaa_m.sfaa006 = g_sfaa_m_o.sfaa006
               LET g_sfaa_m.sfaa007 = g_sfaa_m_o.sfaa007
               LET g_sfaa_m.sfaa008 = g_sfaa_m_o.sfaa008
               LET g_sfaa_m.sfaa063 = g_sfaa_m_o.sfaa063
               DISPLAY BY NAME g_sfaa_m.sfaa006,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063
               NEXT FIELD CURRENT
            END IF

         AFTER FIELD sfaa006
            IF NOT asft300_sfaa006_chk() THEN
               LET g_sfaa_m.sfaa006 = g_sfaa_m_o.sfaa006
               LET g_sfaa_m.sfaa007 = g_sfaa_m_o.sfaa007
               LET g_sfaa_m.sfaa008 = g_sfaa_m_o.sfaa008
               LET g_sfaa_m.sfaa063 = g_sfaa_m_o.sfaa063
               DISPLAY BY NAME g_sfaa_m.sfaa006,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063
               NEXT FIELD CURRENT
            END IF

         AFTER FIELD l_sfaa007
            #项次/项序/分批序 格式，例如：项次1，项序2，分批序3，则1-2-3
            IF NOT cl_null(g_sfaa_m.l_sfaa007) THEN
               IF g_sfaa_m.l_sfaa007 != g_sfaa_m_o.l_sfaa007 OR cl_null(g_sfaa_m_o.l_sfaa007) THEN
                  #根据“-”截位
                  LET l_i = g_sfaa_m.l_sfaa007.getIndexOf("-",2)
                  IF l_i > 0 THEN
                     LET g_sfaa_m.sfaa007 = g_sfaa_m.l_sfaa007.substring(1,l_i-1)#.trim()
                     LET l_j = g_sfaa_m.l_sfaa007.getIndexOf("-",l_i+1)
                     IF l_j > 0 THEN
                        LET g_sfaa_m.sfaa008 = g_sfaa_m.l_sfaa007.substring(l_i+1,l_j-1)#.trim()
                        LET g_sfaa_m.sfaa063 = g_sfaa_m.l_sfaa007.substring(l_j+1,g_sfaa_m.l_sfaa007.getLength())#.trim()
                     ELSE
                        LET g_sfaa_m.sfaa008 = g_sfaa_m.l_sfaa007.substring(l_i+1,g_sfaa_m.l_sfaa007.getLength())#.trim()
                        LET g_sfaa_m.sfaa063 = ''
                     END IF
                  ELSE
                     LET g_sfaa_m.sfaa007 = g_sfaa_m.l_sfaa007.trim()
                     LET g_sfaa_m.sfaa008 = ''
                     LET g_sfaa_m.sfaa063 = ''
                  END IF
                  IF NOT asft300_sfaa006_chk() THEN
                     LET g_sfaa_m.sfaa006 = g_sfaa_m_o.sfaa006
                     LET g_sfaa_m.sfaa007 = g_sfaa_m_o.sfaa007
                     LET g_sfaa_m.sfaa008 = g_sfaa_m_o.sfaa008
                     LET g_sfaa_m.sfaa063 = g_sfaa_m_o.sfaa063
                     LET g_sfaa_m.l_sfaa007 = g_sfaa_m_o.l_sfaa007
                     DISPLAY BY NAME g_sfaa_m.sfaa006,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.l_sfaa007
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            LET g_sfaa_m_o.l_sfaa007 = g_sfaa_m.l_sfaa007

         AFTER FIELD sfaa009
            LET g_sfaa_m.sfaa009_desc = ''
            IF NOT cl_null(g_sfaa_m.sfaa009) THEN
               IF g_sfaa_m.sfaa009 != g_sfaa_m_o.sfaa009 OR cl_null(g_sfaa_m_o.sfaa009) THEN
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_sfaa_m.sfaa009
                  LET g_chkparam.arg2 = g_site
                  #160318-00025#4-s
                  LET g_errshow = TRUE 
                  LET g_chkparam.err_str[1] = "apm-00201:sub-01302|axmm200|",cl_get_progname("axmm200",g_lang,"2"),"|:EXEPROGaxmm200"
                  #160318-00025#4-e
                  IF NOT cl_chk_exist("v_pmaa001_3") THEN
                     LET g_sfaa_m.sfaa009 = g_sfaa_m_o.sfaa009
                     LET g_sfaa_m.sfaa009_desc = s_desc_get_trading_partner_abbr_desc(g_sfaa_m.sfaa009)
                     DISPLAY BY NAME g_sfaa_m.sfaa009,g_sfaa_m.sfaa009_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
               LET g_sfaa_m.sfaa009_desc = s_desc_get_trading_partner_abbr_desc(g_sfaa_m.sfaa009)
               DISPLAY BY NAME g_sfaa_m.sfaa009_desc
            END IF
            LET g_sfaa_m_o.sfaa009 = g_sfaa_m.sfaa009

         AFTER FIELD sfaa010
            LET g_sfaa_m.sfaa010_desc = ''
            LET g_sfaa_m.sfaa010_desc1 = ''
            IF NOT cl_null(g_sfaa_m.sfaa010) THEN
               IF g_sfaa_m.sfaa010 != g_sfaa_m_o.sfaa010 OR cl_null(g_sfaa_m_o.sfaa010) THEN
                  IF NOT asft300_sfaa010_chk() THEN
                     LET g_sfaa_m.sfaa010 = g_sfaa_m_o.sfaa010
                     CALL s_desc_get_item_desc(g_sfaa_m.sfaa010) RETURNING g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1
                     DISPLAY BY NAME g_sfaa_m.sfaa010,g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1
                     NEXT FIELD CURRENT
                  END IF 
                  CALL asft300_sfaa010_defaule(p_cmd)
               END IF 
               CALL s_desc_get_item_desc(g_sfaa_m.sfaa010) RETURNING g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1
               DISPLAY BY NAME g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1
               #161216-00029#10 add(s)
               IF NOT cl_null(g_sfaa_m.sfaa011) THEN
                  LET l_n = 0 
                  SELECT COUNT(*) INTO l_n
                   FROM bmaa_t
                  WHERE bmaa001 = g_sfaa_m.sfaa010
                    AND bmaa002 = g_sfaa_m.sfaa011
                    AND bmaaent = g_enterprise
                    AND bmaasite = g_site
                    AND bmaastus = 'VO'
                  IF l_n > 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'abm-00274'
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_sfaa_m.sfaa010 = g_sfaa_m_o.sfaa010
                     NEXT FIELD CURRENT
                  END IF
               END IF
               #161216-00029#10 add(e)
            END IF
            LET g_sfaa_m_o.sfaa010 = g_sfaa_m.sfaa010
            CALL asft300_set_entry(p_cmd)
            CALL asft300_set_no_entry(p_cmd)

         BEFORE FIELD sfaa010
            #161128-00010#1 mod-----s
#            #dorislai-20150709-add----(S)
#            IF g_sfaa_m.sfaa005 MATCHES '[12367]' THEN   #151207-00017#2
#               IF cl_null(g_sfaa_m.sfaa006) OR cl_null(g_sfaa_m.sfaa007) OR cl_null(g_sfaa_m.sfaa008) OR cl_null(g_sfaa_m.sfaa063) THEN
#                  INITIALIZE g_errparam TO NULL
#                  LET g_errparam.code = 'asf-00150'
#                  LET g_errparam.popup = TRUE
#                  CALL cl_err()
#                  NEXT FIELD sfaa006
#               END IF
#            END IF
#            #dorislai-20150709-add----(E)
            #dorislai-20150709-add----(S)
            IF g_sfaa_m.sfaa005 MATCHES '[1267]' THEN   #151207-00017#2
               IF cl_null(g_sfaa_m.sfaa006) OR cl_null(g_sfaa_m.sfaa007) OR cl_null(g_sfaa_m.sfaa008) OR cl_null(g_sfaa_m.sfaa063) THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'asf-00150'
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  NEXT FIELD sfaa006
               END IF
            END IF
            #dorislai-20150709-add----(E)
            #dorislai-20150709-add----(S)
            IF g_sfaa_m.sfaa005 MATCHES '[3]' THEN   #151207-00017#2
               IF cl_null(g_sfaa_m.sfaa006) THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'asf-00646'
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  NEXT FIELD sfaa006
               END IF
            END IF
            #dorislai-20150709-add----(E)
            #161128-00010#1 mod-----e

         BEFORE FIELD sfaa011
            #161128-00010#1 mod-----s
#            #dorislai-20150709-add----(S)
#            IF g_sfaa_m.sfaa005 MATCHES '[12367]' THEN   #151207-00017#2
#               IF cl_null(g_sfaa_m.sfaa006) OR cl_null(g_sfaa_m.sfaa007) OR cl_null(g_sfaa_m.sfaa008) OR cl_null(g_sfaa_m.sfaa063) THEN
#                  INITIALIZE g_errparam TO NULL
#                  LET g_errparam.code = 'asf-00150'
#                  LET g_errparam.popup = TRUE
#                  CALL cl_err()
#                  NEXT FIELD sfaa006
#               END IF
#            END IF
#            #dorislai-20150709-add----(E)
            #dorislai-20150709-add----(S)
            IF g_sfaa_m.sfaa005 MATCHES '[1267]' THEN   #151207-00017#2
               IF cl_null(g_sfaa_m.sfaa006) OR cl_null(g_sfaa_m.sfaa007) OR cl_null(g_sfaa_m.sfaa008) OR cl_null(g_sfaa_m.sfaa063) THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'asf-00150'
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  NEXT FIELD sfaa006
               END IF
            END IF
            #dorislai-20150709-add----(E)
            #dorislai-20150709-add----(S)
            IF g_sfaa_m.sfaa005 MATCHES '[3]' THEN   #151207-00017#2
               IF cl_null(g_sfaa_m.sfaa006) THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'asf-00646'
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  NEXT FIELD sfaa006
               END IF
            END IF
            #dorislai-20150709-add----(E)
            #161128-00010#1 mod-----e

         #此段落由子樣板a02產生
         AFTER FIELD sfaa011
            IF cl_null(g_sfaa_m.sfaa011) THEN
               LET g_sfaa_m.sfaa011 = ' '
            ELSE
               IF g_sfaa_m_o.sfaa011 IS NULL OR g_sfaa_m.sfaa011 != g_sfaa_m_o.sfaa011 THEN
                  #160214-00005#3-s
                  #多來源、BOM特性不是空的，則不給改
                  IF g_sfaa_m.sfaa003 = '1' AND NOT cl_null(g_sfaa_m_t.sfaa011) THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'asf-00720' #BOM特性不為空，不可進行修改！
                     LET g_errparam.extend = g_sfaa_m.sfaa011
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_sfaa_m.sfaa011 = g_sfaa_m_t.sfaa011
                     DISPLAY BY NAME g_sfaa_m.sfaa011
                     NEXT FIELD sfaa011
                  END IF
                  #160214-00005#3-e
                  IF NOT cl_null(g_sfaa_m.sfaa010) THEN                
                    #160727-00025#1-s
                     CALL s_aooi200_get_slip(g_sfaa_m.sfaadocno) RETURNING l_success,l_ooba002
                    #IF g_sfaa_m.sfaa003 MATCHES '[145]' THEN
                     IF g_sfaa_m.sfaa003 MATCHES '[14]' OR
                       (g_sfaa_m.sfaa003 = '5' AND cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0024') <> '2') THEN
                    #160727-00025#1-e
                        LET l_bmaa001 = ''
                        LET l_bmaastus = ''
                        LET l_sql = " SELECT bmaa001,bmaastus FROM bmaa_t ",
                                    "  WHERE bmaaent = ",g_enterprise," AND bmaasite = '",g_site,"' ",
                                    "    AND bmaa001 = '", g_sfaa_m.sfaa010,"' AND bmaa002 = '",g_sfaa_m.sfaa011,"' "
                        PREPARE sel_bmaa_pre1 FROM l_sql
                        EXECUTE sel_bmaa_pre1 INTO l_bmaa001,l_bmaastus
                        IF cl_null(l_bmaa001) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = 'asf-00045'
                           LET g_errparam.extend = g_sfaa_m.sfaa011
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           LET g_sfaa_m.sfaa011 = g_sfaa_m_o.sfaa011
                           DISPLAY BY NAME g_sfaa_m.sfaa011
                           NEXT FIELD sfaa011
                        END IF
                        IF cl_null(l_bmaastus) THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = 'asf-00045'
                           LET g_errparam.extend = g_sfaa_m.sfaa011
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                           LET g_sfaa_m.sfaa011 = g_sfaa_m_o.sfaa011
                           DISPLAY BY NAME g_sfaa_m.sfaa011
                           NEXT FIELD sfaa011
                        END IF
                     END IF
                     #161216-00029#10 add(s)
                     LET l_n = 0 
                     SELECT COUNT(*) INTO l_n
                      FROM bmaa_t
                     WHERE bmaa001 = g_sfaa_m.sfaa010
                       AND bmaa002 = g_sfaa_m.sfaa011
                       AND bmaaent = g_enterprise
                       AND bmaasite = g_site
                       AND bmaastus = 'VO'
                     IF l_n > 0 THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'abm-00274'
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        LET g_sfaa_m.sfaa011 = g_sfaa_m_o.sfaa011
                        NEXT FIELD CURRENT
                     END IF
                     #161216-00029#10 add(e)
                  END IF 
               END IF
            END IF
            LET g_sfaa_m_o.sfaa011 = g_sfaa_m.sfaa011

         AFTER FIELD sfaa012
            IF NOT cl_null(g_sfaa_m.sfaa012) THEN
               IF cl_null(g_sfaa_m_o.sfaa012) OR g_sfaa_m.sfaa012 != g_sfaa_m_o.sfaa012 THEN
                  IF NOT cl_null(g_sfaa_m.sfaa013) THEN
                     #单位取位
                     CALL s_aooi250_take_decimals(g_sfaa_m.sfaa013,g_sfaa_m.sfaa012)
                          RETURNING l_success,g_sfaa_m.sfaa012
                  END IF
                  IF NOT cl_null(g_sfaa_m.sfaa010) THEN
                     SELECT imae017,imae018,imae019 INTO l_imae017,l_imae018,l_imae019 FROM imae_t
                      WHERE imaeent = g_enterprise AND imaesite = g_site AND imae001 = g_sfaa_m.sfaa010
                     IF NOT cl_null(l_imae019) THEN
                        LET l_sfaa012 = g_sfaa_m.sfaa012
                        IF NOT cl_null(l_imae018) THEN
                           IF g_sfaa_m.sfaa012 < l_imae018 THEN
                              LET l_sfaa012 = l_imae018
                           ELSE
                              LET l_sfaa012 = g_sfaa_m.sfaa012
                           END IF
                        END IF
                        IF NOT cl_null(l_imae017) AND l_imae017 != 0 THEN
                           LET l_n_sfaa012 = l_sfaa012 / l_imae017
                           IF l_sfaa012  != l_imae017 * l_n_sfaa012 THEN
                              IF l_sfaa012 > l_imae017 * l_n_sfaa012 THEN
                                 LET l_sfaa012 = l_imae017 * (l_n_sfaa012 + 1)
                              ELSE
                                 LET l_sfaa012 = l_imae017 * l_n_sfaa012
                              END IF
                           END IF
                        END IF
                        IF NOT cl_null(g_sfaa_m.sfaa013) THEN
                           #单位取位
                           CALL s_aooi250_take_decimals(g_sfaa_m.sfaa013,l_sfaa012)
                                RETURNING l_success,l_sfaa012
                        END IF
                        IF l_sfaa012 != g_sfaa_m.sfaa012 THEN
                           IF l_imae019 = '1' THEN
                              IF cl_ask_confirm('asf-00332') THEN
                                 LET g_sfaa_m.sfaa012 = l_sfaa012
                              END IF
                           END IF
                           IF l_imae019 = '2' THEN
                              IF cl_ask_confirm('asf-00452') THEN
                                 LET g_sfaa_m.sfaa012 = l_sfaa012
                              ELSE
                                 NEXT FIELD sfaa012
                              END IF
                           END IF
                        END IF
                     END IF
                  END IF
                  IF NOT asft300_sfaa012_chk() THEN
                     LET g_sfaa_m.sfaa012 = g_sfaa_m_o.sfaa012
                     DISPLAY BY NAME g_sfaa_m.sfaa012
                     NEXT FIELD CURRENT
                  END IF
                  CALL asft300_get_sfaa058()
                  CALL asft300_get_work_date(p_cmd)
                  IF g_inam.getLength() > 0 AND g_inam004_sum > 0 THEN
                     FOR l_j = 1 TO g_inam.getLength()
                        LET g_inam[l_j].inam004 = g_inam[l_j].inam004 * g_sfaa_m.sfaa012 / g_inam004_sum
                     END FOR
                  END IF
               END IF
            END IF
            LET g_sfaa_m_o.sfaa012 = g_sfaa_m.sfaa012

         AFTER FIELD sfaa013
            LET g_sfaa_m.sfaa013_desc = ''
            IF NOT cl_null(g_sfaa_m.sfaa013) THEN
               IF g_sfaa_m.sfaa013 != g_sfaa_m_o.sfaa013 OR cl_null(g_sfaa_m_o.sfaa013) THEN
                  IF NOT asft300_chk_sfaa013(g_sfaa_m.sfaa013) THEN
                     LET g_sfaa_m.sfaa013 = g_sfaa_m_o.sfaa013
                     LET g_sfaa_m.sfaa013_desc = s_desc_get_unit_desc(g_sfaa_m.sfaa013)
                     DISPLAY BY NAME g_sfaa_m.sfaa013,g_sfaa_m.sfaa013_desc
                     NEXT FIELD CURRENT
                  END IF
                  CALL asft300_get_sfaa058()
               END IF
               LET g_sfaa_m.sfaa013_desc = s_desc_get_unit_desc(g_sfaa_m.sfaa013)
               DISPLAY BY NAME g_sfaa_m.sfaa013_desc
            END IF
            LET g_sfaa_m_o.sfaa013 = g_sfaa_m.sfaa013

         AFTER FIELD sfaa058
            IF NOT cl_null(g_sfaa_m.sfaa058) THEN
               IF g_sfaa_m.sfaa058 != g_sfaa_m_o.sfaa058 OR cl_null(g_sfaa_m_o.sfaa058) THEN
                  IF NOT cl_ap_chk_Range(g_sfaa_m.sfaa058,"0","0","","","azz-00079",1) THEN
                     LET g_sfaa_m.sfaa058 = g_sfaa_m_o.sfaa058
                     DISPLAY BY NAME g_sfaa_m.sfaa058
                     NEXT FIELD CURRENT
                  END IF
                  IF NOT cl_null(g_sfaa_m.sfaa060) THEN
                     #单位取位
                     CALL s_aooi250_take_decimals(g_sfaa_m.sfaa060,g_sfaa_m.sfaa058)
                          RETURNING l_success,g_sfaa_m.sfaa058
                     DISPLAY BY NAME g_sfaa_m.sfaa058
                  END IF
               END IF
            END IF
            LET g_sfaa_m_o.sfaa058 = g_sfaa_m.sfaa058

         AFTER FIELD sfaa060
            LET g_sfaa_m.sfaa060_desc = ''
            IF NOT cl_null(g_sfaa_m.sfaa060) THEN
               IF g_sfaa_m.sfaa060 != g_sfaa_m_o.sfaa060 OR cl_null(g_sfaa_m_o.sfaa060) THEN
                  IF NOT asft300_chk_sfaa013(g_sfaa_m.sfaa060) THEN
                     LET g_sfaa_m.sfaa060_desc = s_desc_get_unit_desc(g_sfaa_m.sfaa060)
                     DISPLAY BY NAME g_sfaa_m.sfaa060,g_sfaa_m.sfaa060_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
               LET g_sfaa_m.sfaa060_desc = s_desc_get_unit_desc(g_sfaa_m.sfaa060)
               DISPLAY BY NAME g_sfaa_m.sfaa060_desc
            END IF
            LET g_sfaa_m_o.sfaa060 = g_sfaa_m.sfaa060

         AFTER FIELD sfaa061
            CALL asft300_set_entry(p_cmd)
            CALL asft300_set_no_entry(p_cmd)

         AFTER FIELD sfaa016
            LET g_sfaa_m.sfaa016_desc = ''
            IF NOT cl_null(g_sfaa_m.sfaa016) THEN
               IF g_sfaa_m.sfaa016 != g_sfaa_m_o.sfaa016 OR cl_null(g_sfaa_m_o.sfaa016) THEN
                  LET l_imae032 = asft300_get_imae032(g_sfaa_m.sfaa010)
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_site
                  LET g_chkparam.arg2 = l_imae032
                  LET g_chkparam.arg3 = g_sfaa_m.sfaa016
                  IF NOT cl_chk_exist("v_ecba002_1") THEN
                     LET g_sfaa_m.sfaa016 = g_sfaa_m_o.sfaa016
                     LET g_sfaa_m.sfaa016_desc = asft300_sfaa016_ref(l_imae032,g_sfaa_m.sfaa016)
                     DISPLAY BY NAME g_sfaa_m.sfaa016,g_sfaa_m.sfaa016_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
               LET g_sfaa_m.sfaa016_desc = asft300_sfaa016_ref(l_imae032,g_sfaa_m.sfaa016)
               DISPLAY BY NAME g_sfaa_m.sfaa016_desc
            END IF
            LET g_sfaa_m_o.sfaa016 = g_sfaa_m.sfaa016

         BEFORE FIELD sfaa016
            IF cl_null(g_sfaa_m.sfaa010) THEN
               NEXT FIELD sfaa010
            END IF

         AFTER FIELD sfaa017
            LET g_sfaa_m.sfaa017_desc = ''
            IF NOT cl_null(g_sfaa_m.sfaa017) THEN
               IF g_sfaa_m.sfaa017 != g_sfaa_m_o.sfaa017 OR cl_null(g_sfaa_m_o.sfaa017) THEN
                  INITIALIZE g_chkparam.* TO NULL
                  IF g_sfaa_m.sfaa057 = '2' THEN
                     LET g_chkparam.arg1 = g_sfaa_m.sfaa017
                     #IF NOT cl_chk_exist("v_pmaa001_1") THEN  #161212-00052#1 mark
                     IF NOT cl_chk_exist("v_pmab001_1") THEN   #161212-00052#1 add
                        LET g_sfaa_m.sfaa017 = g_sfaa_m_o.sfaa017
                        LET g_sfaa_m.sfaa017_desc = s_desc_get_trading_partner_abbr_desc(g_sfaa_m.sfaa017)
                        DISPLAY BY NAME g_sfaa_m.sfaa017,g_sfaa_m.sfaa017_desc
                        NEXT FIELD CURRENT
                     END IF
                  ELSE
                     LET g_chkparam.arg1 = g_sfaa_m.sfaa017
                     LET g_chkparam.arg2 = g_today
                     IF NOT cl_chk_exist("v_ooeg001_2") THEN
                        LET g_sfaa_m.sfaa017 = g_sfaa_m_o.sfaa017
                        LET g_sfaa_m.sfaa017_desc = s_desc_get_department_desc(g_sfaa_m.sfaa017)
                        DISPLAY BY NAME g_sfaa_m.sfaa017,g_sfaa_m.sfaa017_desc
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
               IF g_sfaa_m.sfaa057 = '2' THEN
                  LET g_sfaa_m.sfaa017_desc = s_desc_get_trading_partner_abbr_desc(g_sfaa_m.sfaa017)
               ELSE
                  LET g_sfaa_m.sfaa017_desc = s_desc_get_department_desc(g_sfaa_m.sfaa017)
               END IF
               DISPLAY BY NAME g_sfaa_m.sfaa017_desc
            END IF
            LET g_sfaa_m_o.sfaa017 = g_sfaa_m.sfaa017

         AFTER FIELD sfaa018
            LET g_sfaa_m.sfaa018_desc = ''
            IF NOT cl_null(g_sfaa_m.sfaa018) THEN
               IF g_sfaa_m.sfaa018 != g_sfaa_m_o.sfaa018 OR cl_null(g_sfaa_m_o.sfaa018) THEN
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_sfaa_m.sfaa018
                  #160318-00025#4-s
                  LET g_errshow = TRUE 
                  LET g_chkparam.err_str[1] = "aoo-00095:sub-01302|aooi125|",cl_get_progname("aooi125",g_lang,"2"),"|:EXEPROGaooi125"
                  #160318-00025#4-e
                  IF NOT cl_chk_exist("v_ooef001") THEN
                     LET g_sfaa_m.sfaa018 = g_sfaa_m_o.sfaa018
                     LET g_sfaa_m.sfaa018_desc = s_desc_get_department_desc(g_sfaa_m.sfaa018)
                     DISPLAY BY NAME g_sfaa_m.sfaa018,g_sfaa_m.sfaa018_desc
                     NEXT FIELD CURRENT
                  END IF
                  LET l_cnt = 0
                  SELECT COUNT(1) INTO l_cnt FROM ooef_t
                   WHERE ooefent = g_enterprise AND ooef001 = g_sfaa_m.sfaa018
                     AND ooef017 = (SELECT ooef017 FROM ooef_t WHERE ooefent = g_enterprise AND ooef001 = g_site)
                  IF l_cnt > 0 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'asf-00057'
                     LET g_errparam.extend = g_sfaa_m.sfaa018
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     LET g_sfaa_m.sfaa018 = g_sfaa_m_o.sfaa018
                     LET g_sfaa_m.sfaa018_desc = s_desc_get_department_desc(g_sfaa_m.sfaa018)
                     DISPLAY BY NAME g_sfaa_m.sfaa018,g_sfaa_m.sfaa018_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
               LET g_sfaa_m.sfaa018_desc = s_desc_get_department_desc(g_sfaa_m.sfaa018)
               DISPLAY BY NAME g_sfaa_m.sfaa018_desc
            END IF
            LET g_sfaa_m_o.sfaa018 = g_sfaa_m.sfaa018

         AFTER FIELD sfaa019
            IF NOT cl_null(g_sfaa_m.sfaa019) THEN
               IF g_sfaa_m.sfaa019 != g_sfaa_m_o.sfaa019 OR cl_null(g_sfaa_m_o.sfaa019) THEN
                  IF NOT cl_null(g_sfaa_m.sfaadocdt) THEN
                     IF g_sfaa_m.sfaadocdt > g_sfaa_m.sfaa019 THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'asf-00308'
                        LET g_errparam.extend = g_sfaa_m.sfaadocdt
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        LET g_sfaa_m.sfaa019 = g_sfaa_m_o.sfaa019
                        DISPLAY BY NAME g_sfaa_m.sfaa019
                        NEXT FIELD CURRENT
                     END IF
                  END IF
                  IF cl_ask_confirm('asf-00142') THEN
                     CALL s_asft300_06('1',g_sfaa_m.sfaa010,g_sfaa_m.sfaa012,g_sfaa_m.sfaa019)
                          RETURNING l_success,g_sfaa_m.sfaa020
                     DISPLAY BY NAME g_sfaa_m.sfaa020
                  END IF
                  IF NOT cl_null(g_sfaa_m.sfaa020) THEN
                     IF g_sfaa_m.sfaa019 > g_sfaa_m.sfaa020 THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'asf-00058'
                        LET g_errparam.extend = g_sfaa_m.sfaa020
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        LET g_sfaa_m.sfaa019 = g_sfaa_m_o.sfaa019
                        DISPLAY BY NAME g_sfaa_m.sfaa019
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
            END IF
            LET g_sfaa_m_o.sfaa019 = g_sfaa_m.sfaa019
            LET g_sfaa_m_o.sfaa020 = g_sfaa_m.sfaa020

         AFTER FIELD sfaa020
            IF NOT cl_null(g_sfaa_m.sfaa020) THEN
               IF g_sfaa_m.sfaa020 != g_sfaa_m_o.sfaa020 OR cl_null(g_sfaa_m_o.sfaa020) THEN
                  IF cl_ask_confirm('asf-00143') THEN
                     CALL s_asft300_06('2',g_sfaa_m.sfaa010,g_sfaa_m.sfaa012,g_sfaa_m.sfaa020)
                          RETURNING l_success,g_sfaa_m.sfaa019
                     IF g_sfaa_m.sfaa019 < g_sfaa_m.sfaadocdt THEN
                        LET g_sfaa_m.sfaa019 = g_sfaa_m.sfaadocdt
                     END IF
                     DISPLAY BY NAME g_sfaa_m.sfaa019
                  END IF
                  IF NOT cl_null(g_sfaa_m.sfaa019) THEN
                     IF g_sfaa_m.sfaa019 > g_sfaa_m.sfaa020 THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = 'asf-00058'
                        LET g_errparam.extend = g_sfaa_m.sfaa019
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        LET g_sfaa_m.sfaa020 = g_sfaa_m_o.sfaa020
                        DISPLAY BY NAME g_sfaa_m.sfaa020
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
            END IF
            LET g_sfaa_m_o.sfaa019 = g_sfaa_m.sfaa019
            LET g_sfaa_m_o.sfaa020 = g_sfaa_m.sfaa020

         AFTER FIELD sfaa068
            LET g_sfaa_m.sfaa068_desc = ''
            IF NOT cl_null(g_sfaa_m.sfaa068) THEN
               IF g_sfaa_m.sfaa068 != g_sfaa_m_o.sfaa068 OR cl_null(g_sfaa_m_o.sfaa068) THEN
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_sfaa_m.sfaa068
                  LET g_chkparam.arg2 = cl_get_today()
                  #160318-00025#4-s
                  LET g_errshow = TRUE 
                  LET g_chkparam.err_str[1] = "aoo-00029:sub-01302|aooi125|",cl_get_progname("aooi125",g_lang,"2"),"|:EXEPROGaooi125"
                  #160318-00025#4-e
                  IF NOT cl_chk_exist("v_ooeg001_4") THEN
                     LET g_sfaa_m.sfaa068 = g_sfaa_m_o.sfaa068
                     LET g_sfaa_m.sfaa068_desc = s_desc_get_department_desc(g_sfaa_m.sfaa068)
                     DISPLAY BY NAME g_sfaa_m.sfaa068,g_sfaa_m.sfaa068_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
               LET g_sfaa_m.sfaa068_desc = s_desc_get_department_desc(g_sfaa_m.sfaa068)
               DISPLAY BY NAME g_sfaa_m.sfaa068_desc
            END IF
            LET g_sfaa_m_o.sfaa068 = g_sfaa_m.sfaa068

         AFTER FIELD sfaa014
            IF NOT cl_null(g_sfaa_m.sfaa014) THEN
               IF g_sfaa_m.sfaa014 != g_sfaa_m_o.sfaa014 OR cl_null(g_sfaa_m_o.sfaa014) THEN
                  IF NOT asft300_chk_sfaa014() THEN
                     LET g_sfaa_m.sfaa014 = g_sfaa_m_o.sfaa014
                     DISPLAY BY NAME g_sfaa_m.sfaa014
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
           
            LET g_sfaa_m_o.sfaa019 = g_sfaa_m.sfaa019

         AFTER FIELD sfaa028
            LET g_sfaa_m.sfaa028_desc = ''
            IF NOT cl_null(g_sfaa_m.sfaa028) THEN
               IF g_sfaa_m.sfaa028 != g_sfaa_m_o.sfaa028 OR cl_null(g_sfaa_m_o.sfaa028) THEN
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_sfaa_m.sfaa028
                  #160318-00025#4-s
                  LET g_errshow = TRUE 
                  LET g_chkparam.err_str[1] = "apj-00012:sub-01302|apjm200|",cl_get_progname("apjm200",g_lang,"2"),"|:EXEPROGapjm200"
                  #160318-00025#4-e
                  IF NOT cl_chk_exist("v_pjba001") THEN
                     LET g_sfaa_m.sfaa028 = g_sfaa_m_o.sfaa028
                     LET g_sfaa_m.sfaa028_desc = s_desc_get_project_desc(g_sfaa_m.sfaa028)
                     DISPLAY BY NAME g_sfaa_m.sfaa028,g_sfaa_m.sfaa028_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
               LET g_sfaa_m.sfaa028_desc = s_desc_get_project_desc(g_sfaa_m.sfaa028)
               DISPLAY BY NAME g_sfaa_m.sfaa028_desc
            END IF
            LET g_sfaa_m_o.sfaa028 = g_sfaa_m.sfaa028

         AFTER FIELD sfaa029
            LET g_sfaa_m.sfaa029_desc = ''
            IF NOT cl_null(g_sfaa_m.sfaa029) THEN
               IF g_sfaa_m.sfaa029 != g_sfaa_m_o.sfaa029 OR cl_null(g_sfaa_m_o.sfaa029) THEN
                  IF NOT cl_null(g_sfaa_m.sfaa028) THEN
                     INITIALIZE g_chkparam.* TO NULL
                     LET g_chkparam.arg1 = g_sfaa_m.sfaa028
                     LET g_chkparam.arg2 = g_sfaa_m.sfaa029 
                     IF NOT cl_chk_exist("v_pjbb002") THEN
                        LET g_sfaa_m.sfaa029 = g_sfaa_m_o.sfaa029
                        LET g_sfaa_m.sfaa029_desc = s_desc_get_wbs_desc(g_sfaa_m.sfaa028,g_sfaa_m.sfaa029)
                        DISPLAY BY NAME g_sfaa_m.sfaa029,g_sfaa_m.sfaa029_desc
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
               LET g_sfaa_m.sfaa029_desc = s_desc_get_wbs_desc(g_sfaa_m.sfaa028,g_sfaa_m.sfaa029)
               DISPLAY BY NAME g_sfaa_m.sfaa029_desc
            END IF
            LET g_sfaa_m_o.sfaa029 = g_sfaa_m.sfaa029

         AFTER FIELD sfaa030
            LET g_sfaa_m.sfaa030_desc = ''
            IF NOT cl_null(g_sfaa_m.sfaa030) THEN
               IF g_sfaa_m.sfaa030 != g_sfaa_m_o.sfaa030 OR cl_null(g_sfaa_m_o.sfaa030) THEN
                  IF NOT cl_null(g_sfaa_m.sfaa028) THEN
                     INITIALIZE g_chkparam.* TO NULL
                     LET g_chkparam.arg1 = g_sfaa_m.sfaa028
                     LET g_chkparam.arg2 = g_sfaa_m.sfaa030
                     IF NOT cl_chk_exist("v_pjbm002") THEN
                        LET g_sfaa_m.sfaa030 = g_sfaa_m_o.sfaa030
                        LET g_sfaa_m.sfaa030_desc = s_desc_get_activity_desc(g_sfaa_m.sfaa028,g_sfaa_m.sfaa030)
                        DISPLAY BY NAME g_sfaa_m.sfaa030,g_sfaa_m.sfaa030_desc
                        NEXT FIELD CURRENT
                     END IF
                  END IF
               END IF
               LET g_sfaa_m.sfaa030_desc = s_desc_get_activity_desc(g_sfaa_m.sfaa028,g_sfaa_m.sfaa030)
               DISPLAY BY NAME g_sfaa_m.sfaa030_desc
            END IF
            LET g_sfaa_m_o.sfaa030 = g_sfaa_m.sfaa030

         AFTER FIELD sfaa031
            LET g_sfaa_m.sfaa031_desc = ''
            IF NOT cl_null(g_sfaa_m.sfaa031) THEN
               IF g_sfaa_m.sfaa031 != g_sfaa_m_o.sfaa031 OR cl_null(g_sfaa_m_o.sfaa031) THEN
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = '225'
                  LET g_chkparam.arg2 = g_sfaa_m.sfaa031
                  #160318-00025#4-s
                  LET g_errshow = TRUE 
                  LET g_chkparam.err_str[1] = "aqc-00032:sub-01302|aqci030|",cl_get_progname("aqci030",g_lang,"2"),"|:EXEPROGaqci030"
                  #160318-00025#4-e
                  IF NOT cl_chk_exist("v_oocq002_1") THEN
                     LET g_sfaa_m.sfaa031 = g_sfaa_m_o.sfaa031
                     LET g_sfaa_m.sfaa031_desc = s_desc_get_acc_desc('225',g_sfaa_m.sfaa031)
                     DISPLAY BY NAME g_sfaa_m.sfaa031,g_sfaa_m.sfaa031_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
               LET g_sfaa_m.sfaa031_desc = s_desc_get_acc_desc('225',g_sfaa_m.sfaa031)
               DISPLAY BY NAME g_sfaa_m.sfaa031_desc
            END IF
            LET g_sfaa_m_o.sfaa031 = g_sfaa_m.sfaa031

         AFTER FIELD sfaa032
            IF NOT cl_null(g_sfaa_m.sfaa032) THEN
               IF g_sfaa_m.sfaa032 != g_sfaa_m_o.sfaa032 OR cl_null(g_sfaa_m_o.sfaa032) THEN
                  IF NOT cl_ap_chk_Range(g_sfaa_m.sfaa032,"0","1","100","1","azz-00087",1) THEN
                     LET g_sfaa_m.sfaa032 = g_sfaa_m_o.sfaa032
                     DISPLAY BY NAME g_sfaa_m.sfaa032
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            LET g_sfaa_m_o.sfaa032 = g_sfaa_m.sfaa032

         AFTER FIELD sfaa033
            IF NOT cl_null(g_sfaa_m.sfaa033) THEN
               IF g_sfaa_m.sfaa033 != g_sfaa_m_o.sfaa033 OR cl_null(g_sfaa_m_o.sfaa033) THEN
                  IF NOT cl_ap_chk_Range(g_sfaa_m.sfaa033,"0","0","","","azz-00079",1) THEN
                     LET g_sfaa_m.sfaa033 = g_sfaa_m_o.sfaa033
                     DISPLAY BY NAME g_sfaa_m.sfaa033
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            LET g_sfaa_m_o.sfaa033 = g_sfaa_m.sfaa033

         AFTER FIELD sfaa034
            LET g_sfaa_m.sfaa034_desc = ''
            IF NOT cl_null(g_sfaa_m.sfaa034) THEN
               IF g_sfaa_m.sfaa034 != g_sfaa_m_o.sfaa034 OR cl_null(g_sfaa_m_o.sfaa034) THEN
                  IF NOT asft300_chk_warehouses() THEN
                     LET g_sfaa_m.sfaa034 = g_sfaa_m_o.sfaa034
                     LET g_sfaa_m.sfaa034_desc = s_desc_get_stock_desc(g_site,g_sfaa_m.sfaa034)
                     DISPLAY BY NAME g_sfaa_m.sfaa034,g_sfaa_m.sfaa034_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
               LET g_sfaa_m.sfaa034_desc = s_desc_get_stock_desc(g_site,g_sfaa_m.sfaa034)
               DISPLAY BY NAME g_sfaa_m.sfaa034_desc
            END IF                
            LET g_sfaa_m_o.sfaa034 = g_sfaa_m.sfaa034

         AFTER FIELD sfaa035
            LET g_sfaa_m.sfaa035_desc = ''
            IF NOT cl_null(g_sfaa_m.sfaa035) THEN
               IF g_sfaa_m.sfaa035 != g_sfaa_m_o.sfaa035 OR cl_null(g_sfaa_m_o.sfaa035) THEN
                  IF NOT asft300_chk_warehouses() THEN
                     LET g_sfaa_m.sfaa035 = g_sfaa_m_o.sfaa035
                     LET g_sfaa_m.sfaa035_desc = s_desc_get_locator_desc(g_site,g_sfaa_m.sfaa034,g_sfaa_m.sfaa035)
                     DISPLAY BY NAME g_sfaa_m.sfaa035,g_sfaa_m.sfaa035_desc
                     NEXT FIELD CURRENT
                  END IF
               END IF
               LET g_sfaa_m.sfaa035_desc = s_desc_get_locator_desc(g_site,g_sfaa_m.sfaa034,g_sfaa_m.sfaa035)
               DISPLAY BY NAME g_sfaa_m.sfaa035_desc
            END IF 
            LET g_sfaa_m_o.sfaa035 = g_sfaa_m.sfaa035

         ON ACTION controlp INFIELD sfaadocno
               INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfaa_m.sfaadocno
            LET g_qryparam.arg1 = g_ooef004 #參照表編號
            LET g_qryparam.arg2 = g_prog    #作业代号
            #150909 earl mod s
            IF NOT cl_null(g_sfaa_m.sfaa006) THEN
               CALL s_aooi210_get_search_sql(g_site,'',g_sfaa_m.sfaa006,g_prog) RETURNING l_success,l_where
               IF l_success THEN
                  LET g_qryparam.where = l_where
               END IF
            END IF
            #150909 earl mod e
            CALL q_ooba002_1()
            LET g_sfaa_m.sfaadocno = g_qryparam.return1
            DISPLAY g_sfaa_m.sfaadocno TO sfaadocno
            LET g_sfaa_m.oobal004 = s_aooi200_get_slip_desc(g_sfaa_m.sfaadocno)
            DISPLAY g_sfaa_m.oobal004 TO oobal004
            NEXT FIELD sfaadocno

         ON ACTION controlp INFIELD sfaa002
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfaa_m.sfaa002
            CALL q_ooag001()
            LET g_sfaa_m.sfaa002 = g_qryparam.return1
            DISPLAY g_sfaa_m.sfaa002 TO sfaa002
            LET g_sfaa_m.sfaa002_desc = s_desc_get_person_desc(g_sfaa_m.sfaa002)
            DISPLAY g_sfaa_m.sfaa002_desc TO sfaa002_desc
            NEXT FIELD sfaa002

         ON ACTION controlp INFIELD sfaa007
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfaa_m.sfaa006
            LET g_qryparam.default2 = g_sfaa_m.sfaa007
            LET g_qryparam.default3 = g_sfaa_m.sfaa008
            LET g_qryparam.default4 = g_sfaa_m.sfaa063
            CASE g_sfaa_m.sfaa005
               WHEN '2'  #若工單來源為訂單
                  CALL s_aooi210_get_check_sql(g_site,'',g_sfaa_m.sfaadocno,'4','','xmdddocno') RETURNING l_success,l_where
                  IF l_success THEN
                     LET g_qryparam.where = l_where
                  END IF
                  IF cl_null(g_qryparam.where) THEN 
                     LET g_qryparam.where = " 1=1 " 
                  END IF 
                  IF NOT cl_null(g_sfaa_m.sfaa006) THEN
                     LET g_qryparam.where = g_qryparam.where," AND xmdddocno = '",g_sfaa_m.sfaa006,"' "
                  END IF
                  CALL q_xmdddocno()
               WHEN '6'  #若工單來源為獨立需求
                  CALL s_aooi210_get_check_sql(g_site,'',g_sfaa_m.sfaadocno,'4','','psabdocno') RETURNING l_success,l_where
                  IF l_success THEN
                     LET g_qryparam.where = l_where
                  END IF
                  IF cl_null(g_qryparam.where) THEN
                     LET g_qryparam.where = " 1=1 "
                  END IF
                  LET g_qryparam.where = g_qryparam.where," AND (psab005 - psab006) > 0 "
                  IF NOT cl_null(g_sfaa_m.sfaa006) THEN
                     LET g_qryparam.where = g_qryparam.where," AND psabdocno = '",g_sfaa_m.sfaa006,"' "
                  END IF
                  CALL q_psabdocno()
               WHEN '7'  #若工單來源為獨立需求
                  CALL s_aooi210_get_check_sql(g_site,'',g_sfaa_m.sfaadocno,'4','','psaddocno') RETURNING l_success,l_where
                  IF l_success THEN
                     LET g_qryparam.where = l_where
                  END IF
                  IF cl_null(g_qryparam.where) THEN 
                     LET g_qryparam.where = " 1=1 " 
                  END IF 
                  LET g_qryparam.where = g_qryparam.where," AND (psad005 - psad006) > 0 " 
                  IF NOT cl_null(g_sfaa_m.sfaa006) THEN
                     LET g_qryparam.where = g_qryparam.where," AND psaddocno = '",g_sfaa_m.sfaa006,"' "
                  END IF
                  CALL q_psaddocno()
            END CASE
            LET g_sfaa_m.sfaa006 = g_qryparam.return1
            LET g_sfaa_m.sfaa007 = g_qryparam.return2
            LET g_sfaa_m.sfaa008 = g_qryparam.return3
            LET g_sfaa_m.sfaa063 = g_qryparam.return4
            DISPLAY BY NAME g_sfaa_m.sfaa006,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063
            CALL asft300_l_sfaa007()
            NEXT FIELD sfaa007

         ON ACTION controlp INFIELD sfaa008
            IF g_sfaa_m.sfaa005 = '2' THEN  #若工單來源為訂單
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_sfaa_m.sfaa006
               LET g_qryparam.default2 = g_sfaa_m.sfaa007
               LET g_qryparam.default3 = g_sfaa_m.sfaa008
               LET g_qryparam.default4 = g_sfaa_m.sfaa063
               CALL s_aooi210_get_check_sql(g_site,'',g_sfaa_m.sfaadocno,'4','','xmdddocno') RETURNING l_success,l_where
               IF l_success THEN
                  LET g_qryparam.where = l_where
               END IF
               IF cl_null(g_qryparam.where) THEN 
                  LET g_qryparam.where = " 1=1 " 
               END IF 
               IF NOT cl_null(g_sfaa_m.sfaa006) THEN
                  LET g_qryparam.where = g_qryparam.where," AND xmdddocno = '",g_sfaa_m.sfaa006,"' "
               END IF
               IF NOT cl_null(g_sfaa_m.sfaa007) THEN
                  LET g_qryparam.where = g_qryparam.where," AND xmddseq = ",g_sfaa_m.sfaa007
               END IF
               CALL q_xmdddocno()
               LET g_sfaa_m.sfaa006 = g_qryparam.return1
               LET g_sfaa_m.sfaa007 = g_qryparam.return2
               LET g_sfaa_m.sfaa008 = g_qryparam.return3
               LET g_sfaa_m.sfaa063 = g_qryparam.return4
               DISPLAY BY NAME g_sfaa_m.sfaa006,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063
               CALL asft300_l_sfaa007()
               NEXT FIELD sfaa008
            END IF
 
         ON ACTION controlp INFIELD sfaa063
            IF g_sfaa_m.sfaa005 = '2' THEN  #若工單來源為訂單
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_sfaa_m.sfaa006
               LET g_qryparam.default2 = g_sfaa_m.sfaa007
               LET g_qryparam.default3 = g_sfaa_m.sfaa008
               LET g_qryparam.default4 = g_sfaa_m.sfaa063
               CALL s_aooi210_get_check_sql(g_site,'',g_sfaa_m.sfaadocno,'4','','xmdddocno') RETURNING l_success,l_where
               IF l_success THEN
                  LET g_qryparam.where = l_where
               END IF
               IF cl_null(g_qryparam.where) THEN 
                  LET g_qryparam.where = " 1=1 " 
               END IF 
               IF NOT cl_null(g_sfaa_m.sfaa006) THEN
                  LET g_qryparam.where = g_qryparam.where," AND xmdddocno = '",g_sfaa_m.sfaa006,"' "
               END IF
               IF NOT cl_null(g_sfaa_m.sfaa007) THEN
                  LET g_qryparam.where = g_qryparam.where," AND xmddseq = ",g_sfaa_m.sfaa007
               END IF
               IF NOT cl_null(g_sfaa_m.sfaa008) THEN
                  LET g_qryparam.where = g_qryparam.where," AND xmddseq1 = ",g_sfaa_m.sfaa008
               END IF
               CALL q_xmdddocno()
               LET g_sfaa_m.sfaa006 = g_qryparam.return1
               LET g_sfaa_m.sfaa007 = g_qryparam.return2
               LET g_sfaa_m.sfaa008 = g_qryparam.return3
               LET g_sfaa_m.sfaa063 = g_qryparam.return4
               DISPLAY BY NAME g_sfaa_m.sfaa006,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063
               CALL asft300_l_sfaa007()
               NEXT FIELD sfaa008
            END IF

         ON ACTION controlp INFIELD sfaa006
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfaa_m.sfaa006
            LET g_qryparam.default2 = g_sfaa_m.sfaa007
            LET g_qryparam.default3 = g_sfaa_m.sfaa008
            LET g_qryparam.default4 = g_sfaa_m.sfaa063
            #dorislai-20150708-modify----(S)
            CASE g_sfaa_m.sfaa005
               WHEN '2'  #若工單來源為訂單
                  #150909 earl mod s
                  #組合過濾前後置單據資料SQL
                  CALL s_aooi210_get_check_sql(g_site,'',g_sfaa_m.sfaadocno,'4','','xmdddocno') RETURNING l_success,l_where
                  IF l_success THEN
                     LET g_qryparam.where = l_where
                  END IF
                  #150909 earl mod e
                  CALL q_xmdddocno()
               WHEN '6'  #若工單來源為獨立需求
                  #150909 earl mod s
                  #組合過濾前後置單據資料SQL
                  CALL s_aooi210_get_check_sql(g_site,'',g_sfaa_m.sfaadocno,'4','','psabdocno') RETURNING l_success,l_where
                  IF l_success THEN
                     LET g_qryparam.where = l_where
                  END IF
                  #150909 earl mod e
                  #add--151207-00017#2 By shiun--(S)
                  IF cl_null(g_qryparam.where) THEN
                     LET g_qryparam.where = " 1=1 "
                  END IF
                  LET g_qryparam.where = g_qryparam.where," AND (psab005 - psab006) > 0 "
                  #add--151207-00017#2 By shiun--(E)
                  CALL q_psabdocno()
            #dorislai-20150708-modify----(E)
            #add--151207-00017#2 By shiun--(S)
               WHEN '7'  #若工單來源為獨立需求
                  #組合過濾前後置單據資料SQL
                  CALL s_aooi210_get_check_sql(g_site,'',g_sfaa_m.sfaadocno,'4','','psaddocno') RETURNING l_success,l_where
                  IF l_success THEN
                     LET g_qryparam.where = l_where
                  END IF
                  #add--151207-00017#2 By shiun--(S)
                  IF cl_null(g_qryparam.where) THEN 
                     LET g_qryparam.where = " 1=1 " 
                  END IF 
                  LET g_qryparam.where = g_qryparam.where," AND (psad005 - psad006) > 0 " 
                  #add--151207-00017#2 By shiun--(E)
                  CALL q_psaddocno()
            #add--151207-00017#2 By shiun--(E)
            END CASE
            LET g_sfaa_m.sfaa006 = g_qryparam.return1
            LET g_sfaa_m.sfaa007 = g_qryparam.return2
            LET g_sfaa_m.sfaa008 = g_qryparam.return3
            LET g_sfaa_m.sfaa063 = g_qryparam.return4
            DISPLAY BY NAME g_sfaa_m.sfaa006,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063
            CALL asft300_l_sfaa007()
            NEXT FIELD sfaa006

         ON ACTION controlp INFIELD l_sfaa007
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfaa_m.sfaa006
            LET g_qryparam.default2 = g_sfaa_m.sfaa007
            LET g_qryparam.default3 = g_sfaa_m.sfaa008
            LET g_qryparam.default4 = g_sfaa_m.sfaa063
            CASE g_sfaa_m.sfaa005
               WHEN '2'  #若工單來源為訂單
                  CALL s_aooi210_get_check_sql(g_site,'',g_sfaa_m.sfaadocno,'4','','xmdddocno') RETURNING l_success,l_where
                  IF l_success THEN
                     LET g_qryparam.where = l_where
                  END IF
                  CALL q_xmdddocno()
               WHEN '6'  #若工單來源為獨立需求
                  CALL s_aooi210_get_check_sql(g_site,'',g_sfaa_m.sfaadocno,'4','','psabdocno') RETURNING l_success,l_where
                  IF l_success THEN
                     LET g_qryparam.where = l_where
                  END IF
                  IF cl_null(g_qryparam.where) THEN
                     LET g_qryparam.where = " 1=1 "
                  END IF
                  LET g_qryparam.where = g_qryparam.where," AND (psab005 - psab006) > 0 "
                  CALL q_psabdocno()
               WHEN '7'  #若工單來源為獨立需求
                  CALL s_aooi210_get_check_sql(g_site,'',g_sfaa_m.sfaadocno,'4','','psaddocno') RETURNING l_success,l_where
                  IF l_success THEN
                     LET g_qryparam.where = l_where
                  END IF
                  IF cl_null(g_qryparam.where) THEN 
                     LET g_qryparam.where = " 1=1 " 
                  END IF 
                  LET g_qryparam.where = g_qryparam.where," AND (psad005 - psad006) > 0 " 
                  CALL q_psaddocno()
            END CASE
            LET g_sfaa_m.sfaa006 = g_qryparam.return1
            LET g_sfaa_m.sfaa007 = g_qryparam.return2
            LET g_sfaa_m.sfaa008 = g_qryparam.return3
            LET g_sfaa_m.sfaa063 = g_qryparam.return4
            DISPLAY BY NAME g_sfaa_m.sfaa006,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063
            CALL asft300_l_sfaa007()
            NEXT FIELD l_sfaa007

         ON ACTION controlp INFIELD sfaa009
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfaa_m.sfaa009
            LET g_qryparam.arg1 = g_site
            #160905-00025#1-s-mod
#            CALL q_pmaa001_6()
            CALL q_pmaa001_29()
            #160905-00025#1-e-mod
            LET g_sfaa_m.sfaa009 = g_qryparam.return1
            DISPLAY g_sfaa_m.sfaa009 TO sfaa009
            LET g_sfaa_m.sfaa009_desc = s_desc_get_trading_partner_abbr_desc(g_sfaa_m.sfaa009)
            DISPLAY g_sfaa_m.sfaa009_desc TO sfaa009_desc
            NEXT FIELD sfaa009

         ON ACTION controlp INFIELD sfaa010
               INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfaa_m.sfaa010
            CALL q_imaf001_6()
            LET g_sfaa_m.sfaa010 = g_qryparam.return1
            DISPLAY g_sfaa_m.sfaa010 TO sfaa010
            CALL s_desc_get_item_desc(g_sfaa_m.sfaa010) RETURNING g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1
            DISPLAY BY NAME g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1
            NEXT FIELD sfaa010

         ON ACTION controlp INFIELD sfaa011
            #160616-00002#1-s
               INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfaa_m.sfaa011
            LET g_qryparam.arg1 = g_sfaa_m.sfaa010
            CALL q_bmaa002_2()
            LET g_sfaa_m.sfaa011 = g_qryparam.return1
            DISPLAY g_sfaa_m.sfaa011 TO sfaa011
            NEXT FIELD sfaa011
            #160616-00002#-e

         ON ACTION controlp INFIELD sfaa013
               INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfaa_m.sfaa013
            CALL q_ooca001()
            LET g_sfaa_m.sfaa013 = g_qryparam.return1
            DISPLAY g_sfaa_m.sfaa013 TO sfaa013
            LET g_sfaa_m.sfaa013_desc = s_desc_get_unit_desc(g_sfaa_m.sfaa013)
            DISPLAY g_sfaa_m.sfaa013_desc TO sfaa013_desc
            NEXT FIELD sfaa013

         ON ACTION controlp INFIELD sfaa060
               INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfaa_m.sfaa060
            CALL q_ooca001()
            LET g_sfaa_m.sfaa060 = g_qryparam.return1
            DISPLAY g_sfaa_m.sfaa060 TO sfaa060
            LET g_sfaa_m.sfaa060_desc = s_desc_get_unit_desc(g_sfaa_m.sfaa060)
            DISPLAY g_sfaa_m.sfaa060_desc TO sfaa060_desc
            NEXT FIELD sfaa060

         ON ACTION controlp INFIELD sfaa016
            LET l_imae032 = asft300_get_imae032(g_sfaa_m.sfaa010)
               INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfaa_m.sfaa016
            LET g_qryparam.arg1 = g_site
            LET g_qryparam.arg2 = l_imae032
            CALL q_ecba002_3()
            LET g_sfaa_m.sfaa016 = g_qryparam.return1
            DISPLAY g_sfaa_m.sfaa016 TO sfaa016
            LET g_sfaa_m.sfaa016_desc = asft300_sfaa016_ref(l_imae032,g_sfaa_m.sfaa016)
            DISPLAY g_sfaa_m.sfaa016_desc TO sfaa016_desc
            NEXT FIELD sfaa016

         ON ACTION controlp INFIELD sfaa017
               INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfaa_m.sfaa017
            IF g_sfaa_m.sfaa057 = '2' THEN
               #LET g_qryparam.where = " (pmaa002 = '1' OR pmaa002 ='3') " #161212-00052#1 mark 元件里面已经加了此条件，这边不用再加
               #CALL q_pmaa001()                                           #161212-00052#1 mark
               CALL q_pmab001_1()                                          #161212-00052#1 add
            ELSE
               LET g_qryparam.arg1 = g_today
               CALL q_ooeg001()
            END IF
            LET g_sfaa_m.sfaa017 = g_qryparam.return1
            DISPLAY g_sfaa_m.sfaa017 TO sfaa017
            IF g_sfaa_m.sfaa057 = '2' THEN
               LET g_sfaa_m.sfaa017_desc = s_desc_get_trading_partner_abbr_desc(g_sfaa_m.sfaa017)
            ELSE
               LET g_sfaa_m.sfaa017_desc = s_desc_get_department_desc(g_sfaa_m.sfaa017)
            END IF
            DISPLAY g_sfaa_m.sfaa017_desc TO sfaa017_desc
            NEXT FIELD sfaa017

         ON ACTION controlp INFIELD sfaa018
               INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfaa_m.sfaa018
            #add--161013-00051#1 By shiun--(S)
#            CALL q_ooef001()
            CALL q_ooef001_1()
            #add--161013-00051#1 By shiun--(E)
            LET g_sfaa_m.sfaa018 = g_qryparam.return1
            DISPLAY g_sfaa_m.sfaa018 TO sfaa018
            LET g_sfaa_m.sfaa018_desc = s_desc_get_department_desc(g_sfaa_m.sfaa018)
            DISPLAY g_sfaa_m.sfaa018_desc TO sfaa018_desc
            NEXT FIELD sfaa018

         ON ACTION controlp INFIELD sfaa068
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfaa_m.sfaa068
            LET g_qryparam.arg1 = cl_get_today()
            CALL q_ooeg001_8()
            LET g_sfaa_m.sfaa068 = g_qryparam.return1
            DISPLAY g_sfaa_m.sfaa068 TO sfaa068
            LET g_sfaa_m.sfaa068_desc = s_desc_get_department_desc(g_sfaa_m.sfaa068)
            DISPLAY g_sfaa_m.sfaa068_desc TO sfaa068_desc
            NEXT FIELD sfaa068

         #170217-00006----add----str
         ON ACTION controlp INFIELD sfaa014
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.arg1 = g_sfaa_m.sfaa010
            CALL q_bmfa012()
            LET g_sfaa_m.sfaa014 = g_qryparam.return1
            DISPLAY g_sfaa_m.sfaa014 TO sfaa014
            LET g_sfaa_m.sfaa015  = g_qryparam.return2
            DISPLAY g_sfaa_m.sfaa015 TO sfaa015
            NEXT FIELD sfaa014
         #170217-00006----add----end

         ON ACTION controlp INFIELD sfaa028
               INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfaa_m.sfaa028
            CALL q_pjba001()
            LET g_sfaa_m.sfaa028 = g_qryparam.return1
            DISPLAY g_sfaa_m.sfaa028 TO sfaa028
            LET g_sfaa_m.sfaa028_desc = s_desc_get_project_desc(g_sfaa_m.sfaa028)
            DISPLAY g_sfaa_m.sfaa028_desc TO sfaa028_desc
            NEXT FIELD sfaa028

         ON ACTION controlp INFIELD sfaa029
               INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfaa_m.sfaa029
            IF NOT cl_null(g_sfaa_m.sfaa028) THEN
               LET g_qryparam.where = " pjbb001 = '",g_sfaa_m.sfaa028,"'"
            END IF
            CALL q_pjbb002()
            LET g_sfaa_m.sfaa029 = g_qryparam.return1
            DISPLAY g_sfaa_m.sfaa029 TO sfaa029
            LET g_sfaa_m.sfaa029_desc = s_desc_get_wbs_desc(g_sfaa_m.sfaa028,g_sfaa_m.sfaa029)
            DISPLAY g_sfaa_m.sfaa029_desc TO sfaa029_desc
            NEXT FIELD sfaa029

         ON ACTION controlp INFIELD sfaa030
               INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfaa_m.sfaa030
            #IF NOT cl_null(g_sfaa_m.sfaa028) THEN
            #   LET g_qryparam.where = " pjbm001 = '",g_sfaa_m.sfaa028,"'"
            #END IF
            LET g_qryparam.arg1 = g_sfaa_m.sfaa028 #modify by lixiang 2015/06/17
            CALL q_pjbm002()  #modify by lixiang 2015/06/17
            #CALL q_pjbm01()
            LET g_sfaa_m.sfaa030 = g_qryparam.return1
            DISPLAY g_sfaa_m.sfaa030 TO sfaa030
            LET g_sfaa_m.sfaa030_desc = s_desc_get_activity_desc(g_sfaa_m.sfaa028,g_sfaa_m.sfaa030)
            DISPLAY g_sfaa_m.sfaa030_desc TO sfaa030_desc
            NEXT FIELD sfaa030

         ON ACTION controlp INFIELD sfaa031
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfaa_m.sfaa031
            LET g_qryparam.arg1 = '225'
            CALL q_oocq002()
            LET g_sfaa_m.sfaa031 = g_qryparam.return1
            DISPLAY g_sfaa_m.sfaa031 TO sfaa031
            LET g_sfaa_m.sfaa031_desc = s_desc_get_acc_desc('225',g_sfaa_m.sfaa031)
            DISPLAY g_sfaa_m.sfaa031_desc TO sfaa031_desc
            NEXT FIELD sfaa031

         ON ACTION controlp INFIELD sfaa034
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfaa_m.sfaa034
            CALL q_inaa001_2()
            LET g_sfaa_m.sfaa034 = g_qryparam.return1
            DISPLAY g_sfaa_m.sfaa034 TO sfaa034
            LET g_sfaa_m.sfaa034_desc = s_desc_get_stock_desc(g_site,g_sfaa_m.sfaa034)
            DISPLAY g_sfaa_m.sfaa034_desc TO sfaa034_desc
            NEXT FIELD sfaa034

         ON ACTION controlp INFIELD sfaa035
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfaa_m.sfaa035
            LET g_qryparam.arg1 = g_sfaa_m.sfaa034
            CALL q_inab002_3()
            LET g_sfaa_m.sfaa035 = g_qryparam.return1
            DISPLAY g_sfaa_m.sfaa035 TO sfaa035
            LET g_sfaa_m.sfaa035_desc = s_desc_get_locator_desc(g_site,g_sfaa_m.sfaa034,g_sfaa_m.sfaa035)
            DISPLAY g_sfaa_m.sfaa035_desc TO sfaa035_desc
            NEXT FIELD sfaa035


         AFTER INPUT
            IF INT_FLAG THEN
               EXIT DIALOG
            END IF

            #CALL cl_err_collect_show()      #錯誤訊息統整顯示
            #CALL cl_showmsg()
            DISPLAY BY NAME g_sfaa_m.sfaadocno

            #add-point:單頭INPUT後 name="input.head.after_input"
            IF cl_null(g_sfaa_m.sfaa011) THEN
               LET g_sfaa_m.sfaa011 = ' '
            END IF
            #委外工单部门厂商不可为空
            IF g_sfaa_m.sfaa057 = '2' AND cl_null(g_sfaa_m.sfaa017) THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'asf-00222'
               LET g_errparam.popup = FALSE
               CALL cl_err()
               NEXT FIELD sfaa017
            END IF
            #模具工單的製程編號可以為空
            IF g_argv[01] <> '4' OR cl_null(g_argv[01]) THEN  #160727-00025#1
               #当工单做制程管理时，制程编号不可为空
               IF g_sfaa_m.sfaa061 = 'Y' AND cl_null(g_sfaa_m.sfaa016) THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'asf-00190'
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  NEXT FIELD sfaa016
               END IF
            END IF  #160727-00025#1
            
            LET g_sfaa_m.sfaa069 = g_sfaa_m.sfaa012
            LET g_sfaa_m.sfaa070 = g_sfaa_m.sfaa020
            #end add-point
                        
            IF p_cmd <> 'u' THEN
    
               CALL s_transaction_begin()
               
               #add-point:單頭新增前 name="input.head.b_insert"
               #自动编号
               CALL s_aooi200_gen_docno(g_site,g_sfaa_m.sfaadocno,g_sfaa_m.sfaadocdt,g_prog)
                    RETURNING l_success,g_sfaa_m.sfaadocno
               IF NOT l_success THEN
                  NEXT FIELD sfaadocno
               END IF
               #end add-point
               
               INSERT INTO sfaa_t (sfaaent,sfaasite,sfaadocno,sfaa001,sfaadocdt,sfaa002,sfaa003,sfaa057,sfaa004,sfaastus,
                                   sfaa005,sfaa007,sfaa008,sfaa063,sfaa006,sfaa009,sfaa022,sfaa021,sfaa023,sfaa024,
                                   sfaa064,sfaa025,sfaa010,sfaa011,sfaa012,sfaa013,sfaa058,sfaa060,sfaa061,sfaa016,
                                   sfaa017,sfaa018,sfaa019,sfaa020,sfaa068,sfaa014,sfaa015,sfaa026,sfaa062,sfaa028,
                                   sfaa029,sfaa030,sfaa031,sfaa032,sfaa033,sfaa034,sfaa035,sfaa059,sfaa036,sfaa037,
                                   sfaa038,sfaa072,sfaa039,sfaa040,sfaa041,sfaa042,sfaa043,sfaa044,sfaa069,sfaa070,
                                   sfaa045,sfaa046,sfaa047,sfaa048,sfaa065,sfaa049,sfaa050,sfaa051,sfaa055,sfaa056,
                                   sfaaownid,sfaaowndp,sfaacrtid,sfaacrtdp,sfaacrtdt,sfaamodid,
                                   sfaamoddt,sfaacnfid,sfaacnfdt,sfaapstid,sfaapstdt)
               VALUES (g_enterprise,g_site,g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.sfaadocdt,
                       g_sfaa_m.sfaa002,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,
                       g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,
                       g_sfaa_m.sfaa009,g_sfaa_m.sfaa022,g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,g_sfaa_m.sfaa024,
                       g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa012,
                       g_sfaa_m.sfaa013,g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,
                       g_sfaa_m.sfaa017,g_sfaa_m.sfaa018,g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,
                       g_sfaa_m.sfaa014,g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,
                       g_sfaa_m.sfaa029,g_sfaa_m.sfaa030,g_sfaa_m.sfaa031,g_sfaa_m.sfaa032,g_sfaa_m.sfaa033,
                       g_sfaa_m.sfaa034,g_sfaa_m.sfaa035,g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,g_sfaa_m.sfaa037,
                       g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,g_sfaa_m.sfaa041,
                       g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,g_sfaa_m.sfaa070,
                       g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,g_sfaa_m.sfaa065,
                       g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,g_sfaa_m.sfaa056,
                       g_sfaa_m.sfaaownid,g_sfaa_m.sfaaowndp,g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,
                       g_sfaa_m.sfaamoddt,g_sfaa_m.sfaacnfid,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,g_sfaa_m.sfaapstdt) # DISK WRITE
               IF SQLCA.sqlcode THEN
                  CALL s_transaction_end('N','0')
                  INITIALIZE g_errparam TO NULL 
                  LET g_errparam.extend = "g_sfaa_m:",SQLERRMESSAGE 
                  LET g_errparam.code   = SQLCA.sqlcode 
                  LET g_errparam.popup  = TRUE 
                  CALL cl_err()
                  NEXT FIELD CURRENT
               END IF
               
               #add-point:單頭新增中 name="input.head.m_insert"
               LET g_ooff003_d = g_sfaa_m.sfaadocno   #161031-00025#17 add                                                                              
               #end add-point

               #add-point:單頭新增後 name="input.head.a_insert"
               #工单单头有来源单据时，写入sfab
               #dorislai-20150709-modify----(S)
#               IF NOT cl_null(g_sfaa_m.sfaa006) AND NOT cl_null(g_sfaa_m.sfaa007) AND NOT cl_null(g_sfaa_m.sfaa008) AND NOT cl_null(g_sfaa_m.sfaa063) THEN
#                  DELETE FROM sfab_t WHERE sfabent=g_enterprise AND sfabsite=g_site AND sfabdocno=g_sfaa_m.sfaadocno
#                  INSERT INTO sfab_t(sfabent,sfabsite,sfabdocno,sfabseq,sfab001,sfab002,sfab003,sfab004,sfab005,sfab006,sfab007)
#                  VALUES(g_enterprise,g_site,g_sfaa_m.sfaadocno,1,'2',g_sfaa_m.sfaa006,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,10,g_sfaa_m.sfaa012)
#                  IF SQLCA.sqlcode THEN
#                     INITIALIZE g_errparam TO NULL
#                     LET g_errparam.code = SQLCA.sqlcode
#                     LET g_errparam.extend = "ins sfab_t"
#                     LET g_errparam.popup = TRUE
#                     CALL cl_err()
#                     CONTINUE DIALOG
#                  END IF
#               END IF

               #160727-00025#1-s
               IF g_argv[01] = '4' THEN
                  INSERT INTO sfai_t (sfaient,sfaidocno,sfaisite,sfai001,sfai002,sfai003,sfai004,sfai005)
                       VALUES (g_enterprise,g_sfaa_m.sfaadocno,g_site,g_sfai_m.sfai001,
                               g_sfai_m.sfai002,g_sfai_m.sfai003,g_sfai_m.sfai004,g_sfai_m.sfai005) 
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = "g_sfai_m:",SQLERRMESSAGE 
                     LET g_errparam.code   = SQLCA.sqlcode 
                     LET g_errparam.popup  = TRUE 
                     CALL s_transaction_end('N','0')
                     CALL cl_err()
                     CONTINUE DIALOG
                  END IF
               END IF
               #160727-00025#1-e
               
               #訂單
               IF g_sfaa_m.sfaa005 = '2' THEN
                  IF NOT cl_null(g_sfaa_m.sfaa006) AND NOT cl_null(g_sfaa_m.sfaa007) AND NOT cl_null(g_sfaa_m.sfaa008) AND NOT cl_null(g_sfaa_m.sfaa063) THEN
                     DELETE FROM sfab_t WHERE sfabent=g_enterprise AND sfabsite=g_site AND sfabdocno=g_sfaa_m.sfaadocno
                     INSERT INTO sfab_t(sfabent,sfabsite,sfabdocno,sfabseq,sfab001,sfab002,sfab003,sfab004,sfab005,sfab006,sfab007)
                          VALUES (g_enterprise,g_site,g_sfaa_m.sfaadocno,1,'2',g_sfaa_m.sfaa006,
                                  g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,10,g_sfaa_m.sfaa012)
                     IF SQLCA.sqlcode THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = SQLCA.sqlcode
                        LET g_errparam.extend = "ins sfab_t",SQLERRMESSAGE
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        CONTINUE DIALOG
                     END IF
                  END IF
               END IF
               #獨立需求
               IF g_sfaa_m.sfaa005 = '6' THEN
                  IF NOT cl_null(g_sfaa_m.sfaa006) AND NOT cl_null(g_sfaa_m.sfaa007) THEN
                     DELETE FROM sfab_t WHERE sfabent=g_enterprise AND sfabsite=g_site AND sfabdocno=g_sfaa_m.sfaadocno
                     #單位換算
                     SELECT psab004 INTO l_psab004 FROM psab_t
                      WHERE psabent = g_enterprise AND psabseq = g_sfaa_m.sfaa007
                        AND psab001 = g_sfaa_m.sfaa010 AND psabdocno = g_sfaa_m.sfaa006
                     #                            生產料號     , 需求單位 ,      生產單位    ,生產數量
                     CALL s_aooi250_convert_qty(g_sfaa_m.sfaa010,l_psab004,g_sfaa_m.sfaa013,g_sfaa_m.sfaa012)
                         RETURNING l_success,l_sfab007
                     IF NOT l_success THEN
                        LET l_sfab007 = g_sfaa_m.sfaa012
                     END IF
                     INSERT INTO sfab_t(sfabent,sfabsite,sfabdocno,sfabseq,sfab001,sfab002,sfab003,sfab004,sfab005,sfab006,sfab007)
                          VALUES (g_enterprise,g_site,g_sfaa_m.sfaadocno,1,'6',g_sfaa_m.sfaa006,
                                  g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,10,l_sfab007)
                     IF SQLCA.sqlcode THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = SQLCA.sqlcode
                        LET g_errparam.extend = "ins sfab_t",SQLERRMESSAGE
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        CONTINUE DIALOG
                     END IF
                  END IF
               END IF
               #dorislai-20150709-modify----(E)
               #add--151207-00017#2 By shiun--(S)
               #MPS計劃
               IF g_sfaa_m.sfaa005 = '7' THEN
                  IF NOT cl_null(g_sfaa_m.sfaa006) AND NOT cl_null(g_sfaa_m.sfaa007) THEN
                     DELETE FROM sfab_t WHERE sfabent=g_enterprise AND sfabsite=g_site AND sfabdocno=g_sfaa_m.sfaadocno
                     #單位換算
                     SELECT psad004 INTO l_psad004 FROM psad_t
                      WHERE psadent = g_enterprise AND psadseq = g_sfaa_m.sfaa007
                        AND psad001 = g_sfaa_m.sfaa010 AND psaddocno = g_sfaa_m.sfaa006
                     #                            生產料號     , 需求單位 ,      生產單位    ,生產數量
                     CALL s_aooi250_convert_qty(g_sfaa_m.sfaa010,l_psad004,g_sfaa_m.sfaa013,g_sfaa_m.sfaa012)
                         RETURNING l_success,l_sfab007
                     IF NOT l_success THEN
                        LET l_sfab007 = g_sfaa_m.sfaa012
                     END IF
                     INSERT INTO sfab_t(sfabent,sfabsite,sfabdocno,sfabseq,sfab001,sfab002,sfab003,sfab004,sfab005,sfab006,sfab007)
                      VALUES(g_enterprise,g_site,g_sfaa_m.sfaadocno,1,'7',g_sfaa_m.sfaa006,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,10,l_sfab007)
                     IF SQLCA.sqlcode THEN
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = SQLCA.sqlcode
                        LET g_errparam.extend = "ins sfab_t",SQLERRMESSAGE
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                        CONTINUE DIALOG
                     END IF
                  END IF
               END IF
               #add--151207-00017#2 By shiun--(E)
               #工单为人工输入时，需删除sfab资料
               IF g_sfaa_m.sfaa005 = '0' THEN
                  DELETE FROM sfab_t WHERE sfabent=g_enterprise AND sfabsite=g_site AND sfabdocno=g_sfaa_m.sfaadocno
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "del sfab_t",SQLERRMESSAGE
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                     CONTINUE DIALOG
                  END IF
               END IF
               #写入工单生产料号明细，拆件式工单不控管
               IF g_sfaa_m.sfaa003 != '3' THEN
                  #160411-00005#1-s
                  #p_cmd -> l_cmd_t
                  IF NOT cl_null(g_sfaa_m.sfaa010) AND g_sfaa_m.sfaa011 IS NOT NULL AND l_cmd_t = 'a' AND l_flag1 = 'N' THEN
                  #160411-00005#1-e
                     CALL asft300_ins_sfac()
                     LET l_flag1 = 'Y'
                  END IF
               END IF
               #20150730 by wuxja  --begin--
               IF g_sfaa_m.sfaa003 = '3' THEN
                  IF g_inam.getLength() > 0 THEN
                     CALL asft300_07(g_sfaa_m.sfaadocno,g_inam) RETURNING l_flag2
                  ELSE
                     IF asft300_sfaa010_feature() THEN
                        CALL asft300_07(g_sfaa_m.sfaadocno,g_inam) RETURNING l_flag2
                     END IF
                  END IF
               END IF
               #20150730 by wuxja  --end--
               #----
               #更新獨立需求的已耗需求量
               #151117-00019#3-s
               IF g_sfaa_m.sfaa005 = '6' OR g_sfaa_m.sfaa005 = '7' THEN   #151207-00017#2
                  LET l_psabdocno = g_sfaa_m.sfaa006
                  LET l_psabseq = g_sfaa_m.sfaa007
                  #160607-00028#1-s
                  IF g_sfaa_m.sfaa005 = '6' THEN
                     IF NOT s_asft300_upd_psab006(l_psabdocno,l_psabseq,g_sfaa_m.sfaa010,0,g_sfaa_m.sfaa012,g_sfaa_m.sfaa013) THEN
                        CONTINUE DIALOG
                     END IF
                  END IF
                  IF g_sfaa_m.sfaa005 = '7' THEN
                     IF NOT s_asft300_upd_psad006(l_psabdocno,l_psabseq,g_sfaa_m.sfaa010,0,g_sfaa_m.sfaa012,g_sfaa_m.sfaa013) THEN
                        CONTINUE DIALOG
                     END IF
                  END IF
                  #160607-00028#1-e
               ELSE
                  LET l_psabdocno = g_sfaa_m.sfaa022
                  LET l_psabseq = g_sfaa_m.sfaa023
               END IF
               #151117-00019#3-e
               #160701-00010#1 add --(S)--
               IF (g_sfaa_m.sfaa003 = '3') AND (g_inam.getLength() > 0) THEN
                  CALL g_inam1.clear()
                  FOR l_i = 1 TO g_inam.getLength()
                      LET g_inam1[l_i].* = g_inam[l_i].*
                  END FOR                                
               END IF
               #160701-00010#1 add --(E)--
            #end add-point
            CALL s_transaction_end('Y','0')
               
               IF l_cmd_t = 'r' AND p_cmd = 'a' THEN
                  CALL asft300_detail_reproduce()
                  #因應特定程式需求, 重新刷新單身資料
                  CALL asft300_b_fill()
                  CALL asft300_b_fill2('0')
               END IF
               
               #add-point:單頭新增後 name="input.head.a_insert2"
               CALL asft300_show()  #160819-00040#1
               #end add-point
               
               LET g_master_insert = TRUE
               
               LET p_cmd = 'u'
            ELSE
               CALL s_transaction_begin()
            
               #add-point:單頭修改前 name="input.head.b_update"
                                                                                          
               #end add-point
               
#               #將遮罩欄位還原
#               CALL asft300_sfaa_t_mask_restore('restore_mask_o')
               
               UPDATE sfaa_t
                  SET (sfaadocno,sfaa001,sfaadocdt,sfaa002,sfaa003,sfaa057,sfaa004,sfaastus,sfaa005,sfaa007,
                       sfaa008,sfaa063,sfaa006,sfaa009,sfaa022,sfaa021,sfaa023,sfaa024,sfaa064,sfaa025,
                       sfaa010,sfaa011,sfaa012,sfaa013,sfaa058,sfaa060,sfaa061,sfaa016,sfaa017,sfaa018,
                       sfaa019,sfaa020,sfaa068,sfaa014,sfaa015,sfaa026,sfaa062,sfaa028,sfaa029,sfaa030,
                       sfaa031,sfaa032,sfaa033,sfaa034,sfaa035,sfaa059,sfaa036,sfaa037,sfaa038,sfaa072,
                       sfaa039,sfaa040,sfaa041,sfaa042,sfaa043,sfaa044,sfaa069,sfaa070,sfaa045,sfaa046,
                       sfaa047,sfaa048,sfaa065,sfaa049,sfaa050,sfaa051,sfaa055,sfaa056,sfaaownid,sfaaowndp,
                       sfaacrtid,sfaacrtdp,sfaacrtdt,sfaamodid,sfaamoddt,sfaacnfid,sfaacnfdt,sfaapstid,sfaapstdt)
                    = (g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.sfaadocdt,g_sfaa_m.sfaa002,g_sfaa_m.sfaa003,
                       g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,
                       g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,g_sfaa_m.sfaa009,g_sfaa_m.sfaa022,
                       g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,g_sfaa_m.sfaa024,g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,
                       g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa012,g_sfaa_m.sfaa013,g_sfaa_m.sfaa058,
                       g_sfaa_m.sfaa060,g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,g_sfaa_m.sfaa017,g_sfaa_m.sfaa018,
                       g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,g_sfaa_m.sfaa014,g_sfaa_m.sfaa015,
                       g_sfaa_m.sfaa026,g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,g_sfaa_m.sfaa029,g_sfaa_m.sfaa030,
                       g_sfaa_m.sfaa031,g_sfaa_m.sfaa032,g_sfaa_m.sfaa033,g_sfaa_m.sfaa034,g_sfaa_m.sfaa035,
                       g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,g_sfaa_m.sfaa037,g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,
                       g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,g_sfaa_m.sfaa041,g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,
                       g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,g_sfaa_m.sfaa070,g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,
                       g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,g_sfaa_m.sfaa065,g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,
                       g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,g_sfaa_m.sfaa056,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaowndp,
                       g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,g_sfaa_m.sfaamoddt,
                       g_sfaa_m.sfaacnfid,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,g_sfaa_m.sfaapstdt)
                WHERE sfaaent = g_enterprise AND sfaasite = g_site AND sfaadocno = g_sfaadocno_t

               IF SQLCA.sqlcode THEN
                  CALL s_transaction_end('N','0')
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = "sfaa_t:",SQLERRMESSAGE
                  LET g_errparam.code   = SQLCA.sqlcode
                  LET g_errparam.popup  = TRUE
                  CALL cl_err()
                  NEXT FIELD CURRENT
               END IF
               
               #add-point:單頭修改中 name="input.head.m_update"

               #end add-point

#               #將遮罩欄位進行遮蔽
#               CALL asft300_sfaa_t_mask_restore('restore_mask_n')
               
               #修改歷程記錄(單頭修改)
               LET g_log1 = util.JSON.stringify(g_sfaa_m_t)
               LET g_log2 = util.JSON.stringify(g_sfaa_m)
               IF NOT cl_log_modified_record(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               ELSE
                  CALL s_transaction_end('Y','0')
               END IF
               
               #add-point:單頭修改後 name="input.head.a_update"
               #161226-00033#1-s-add
               #170118-00063#1 add --(S)--
               IF (g_sfaa_m.sfaa010 <> g_sfaa_m_t.sfaa010) OR
                  (g_sfaa_m.sfaa012 <> g_sfaa_m_t.sfaa012) THEN
               #170118-00063#1 add --(E)--
                  IF g_sfaa_m.sfaa012 <> g_sfaa_m_t.sfaa012 THEN
                     LET l_count = 0
                     SELECT COUNT (1) INTO l_count
                       FROM sfca_t
                      WHERE sfcaent = g_enterprise
                        AND sfcadocno = g_sfaa_m.sfaadocno
                        AND sfca001 = 0
                  
                     IF l_count > 0 THEN
                        CALL s_transaction_begin()
                        LET l_success_2 = TRUE
                     
                        UPDATE sfca_t SET sfca003 = g_sfaa_m.sfaa012
                         WHERE sfcaent = g_enterprise
                           AND sfcadocno = g_sfaa_m.sfaadocno
                           AND sfca001 = 0
                     
                        IF SQLCA.sqlcode THEN
                           LET l_success_2 = FALSE
                        ELSE
                           LET l_sql_2 = " SELECT sfcb002,sfcb021,sfcb022,0 ",
                                         "   FROM sfcb_t ",
                                         "  WHERE sfcbent = ",g_enterprise,
                                         "    AND sfcbdocno = '",g_sfaa_m.sfaadocno,"' ",
                                         "    AND sfcb001 = 0 "
                        
                           PREPARE asft300_sfcb_p FROM l_sql_2
                           DECLARE asft300_sfcb_c CURSOR FOR asft300_sfcb_p
                          
                           FOREACH asft300_sfcb_c INTO l_sfcb002,l_sfcb021,l_sfcb022,l_sfcb027
                              IF NOT cl_null(l_sfcb022) AND l_sfcb022 > 0 THEN
                                 LET l_sfcb027 = g_sfaa_m.sfaa012 * l_sfcb021 / l_sfcb022
                                 UPDATE sfcb_t SET sfcb027 = l_sfcb027
                                  WHERE sfcbent = g_enterprise
                                    AND sfcbdocno = g_sfaa_m.sfaadocno
                                    AND sfcb001 = 0
                                    AND sfcb002 = l_sfcb002
                              
                                 IF SQLCA.sqlcode THEN
                                    LET l_success_2 = FALSE
                                    EXIT FOREACH
                                 END IF
                              END IF
                           END FOREACH
                        END IF
                        IF l_success_2 THEN
                           CALL s_transaction_end('Y','0')
                        ELSE
                           CALL s_transaction_end('N','0')
                        END IF
                     END IF      
                  END IF    #170118-00063#1 add                  
                  #161228-00073#1-s-add
                  #160701-00010#1 modify --(S)--
                  LET l_prog = g_prog      
                  #160701-00010#1 modify --(E)--                  
                  LET g_prog = 'asft300_sfac'
                  IF asft300_sfaa010_chk() THEN
                     DELETE FROM sfac_t
                      WHERE sfacent = g_enterprise
                        AND sfacdocno = g_sfaa_m.sfaadocno
                     CALL asft300_ins_sfac()
                     SELECT sfaa012,sfaa058 INTO g_sfaa_m.sfaa012,g_sfaa_m.sfaa058
                       FROM sfaa_t
                      WHERE sfaaent = g_enterprise
                        AND sfaadocno = g_sfaa_m.sfaadocno
                     
                     DISPLAY BY NAME g_sfaa_m.sfaa012,g_sfaa_m.sfaa058
                     CALL asft300_b_fill_sfac()
                  ELSE                     
                     UPDATE sfaa_t SET sfaa012 = g_sfaa_m_t.sfaa012,
                                       sfaa058 = g_sfaa_m_t.sfaa058,
                                       sfaa019 = g_sfaa_m_t.sfaa019,
                                       sfaa020 = g_sfaa_m_t.sfaa020
                      WHERE sfaaent = g_enterprise
                        AND sfaadocno = g_sfaa_m.sfaadocno
                      
                      LET g_sfaa_m.sfaa012 = g_sfaa_m_t.sfaa012
                      LET g_sfaa_m.sfaa058 = g_sfaa_m_t.sfaa058
                      LET g_sfaa_m.sfaa019 = g_sfaa_m_t.sfaa019
                      LET g_sfaa_m.sfaa020 = g_sfaa_m_t.sfaa020
                      DISPLAY BY NAME g_sfaa_m.sfaa012,g_sfaa_m.sfaa058,g_sfaa_m.sfaa019,g_sfaa_m.sfaa020
                  END IF
                 #160701-00010#1 modify --(S)--
                  LET g_prog = l_prog      
                 #LET g_prog = 'asft300'
                 #160701-00010#1 modify --(E)--
#                  CALL s_transaction_begin()
#                  IF asft300_mod_sfac() THEN
#                     CALL s_transaction_end('Y','0')
#                  ELSE
#                     CALL s_transaction_end('N','0')
#                  END IF
                  #161228-00073#1-e-add
               END IF
               #161226-00033#1-e-add
               #end add-point
            END IF
            
            LET g_sfaadocno_t = g_sfaa_m.sfaadocno

            #工单备料档无资料时产生工单备料,根据参数判断  
            IF p_cmd = 'u' AND g_master_insert = TRUE THEN
               LET l_m = 0
               SELECT COUNT(1) INTO l_m FROM sfba_t 
                WHERE sfbaent = g_enterprise AND sfbasite = g_site 
                  AND sfbadocno = g_sfaa_m.sfaadocno
               IF l_m = 0 THEN                  
                  CALL s_aooi200_get_slip(g_sfaa_m.sfaadocno) RETURNING l_success,l_ooba002
                  IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0038') = '1' THEN              
                     CALL s_transaction_begin()         
                     #161011-00039#1--add---str---
                     #写入工单生产料号明细，拆件式工单不控管
                     IF g_sfaa_m.sfaa003 != '3' THEN
                        IF NOT cl_null(g_sfaa_m.sfaa010) AND g_sfaa_m.sfaa011 IS NOT NULL AND l_cmd_t = 'u' THEN
                           #生產料號明細資料也需重新產生
                           DELETE FROM sfac_t
                            WHERE sfacent = g_enterprise AND sfacsite = g_site AND sfacdocno = g_sfaa_m.sfaadocno
                           IF SQLCA.sqlcode THEN
                              CALL s_transaction_end('N','0')
                              INITIALIZE g_errparam TO NULL
                              LET g_errparam.extend = "sfac_t:",SQLERRMESSAGE
                              LET g_errparam.code   = SQLCA.sqlcode
                              LET g_errparam.popup  = FALSE
                              CALL cl_err()
                              RETURN
                           END IF
                           LET l_flag1 = 'N'
                           CALL asft300_ins_sfac()
                           CALL asft300_b_fill_sfac()
                           LET l_flag1 = 'Y'
                        END IF
                     END IF
                     #161011-00039#1--add---end---
                     #复制的时候删除后重新产生
                     DELETE FROM sfba_t WHERE sfbaent=g_enterprise AND sfbasite=g_site AND sfbadocno=g_sfaa_m.sfaadocno
                     CALL s_asft300_02(g_sfaa_m.sfaadocno,g_sfaa_m.sfaa003,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa015,g_sfaa_m.sfaa012,'N') RETURNING l_success,l_num
                     IF NOT l_success THEN
                        CALL s_transaction_end('N','0')
                     ELSE
                        CALL s_transaction_end('Y','0')
                     END IF
                     CALL asft300_b_fill()
                     LET g_rec_b = g_sfba_d.getLength()
                  END IF
               END IF
            END IF
            
            #备注无值时，若工单来源是订单，则把订单的长备注带入
            CALL asft300_gen_bz()
            
            LET g_sfaadocno_t = g_sfaa_m.sfaadocno

           #20150730 by wuxja  --begin--
            IF l_flag2 = '1' THEN
               EXIT DIALOG
            END IF
           #20150730 by wuxja  --end--
           
      END INPUT
#161031-00025#17-s mark       
#      INPUT BY NAME g_sfaa_m.ooff013 ATTRIBUTE(WITHOUT DEFAULTS)
#         
#         BEFORE INPUT
#         
#         AFTER INPUT
#            IF INT_FLAG THEN
#               EXIT DIALOG
#            END IF
#            DISPLAY BY NAME g_sfaa_m.ooff013
#            CALL s_transaction_begin()
#            IF cl_null(g_sfaa_m.ooff013) THEN
#               IF s_aooi360_del('6',g_sfaa_m.sfaadocno,' ',' ',' ',' ',' ',' ',' ',' ',' ','2') THEN
#                  CALL s_transaction_end('Y','0')
#               ELSE
#                  CALL s_transaction_end('N','0')
#               END IF
#            ELSE
#               IF s_aooi360_gen('6',g_sfaa_m.sfaadocno,' ',' ',' ',' ',' ',' ',' ',' ',' ','2',g_sfaa_m.ooff013) THEN
#                  CALL s_transaction_end('Y','0')
#               ELSE
#                  CALL s_transaction_end('N','0')
#               END IF
#            END IF
#            
#      END INPUT
#161031-00025#17-e mark         
      #160727-00025#1-s
      INPUT BY NAME g_sfai_m.sfai001,g_sfai_m.sfai002,g_sfai_m.sfai003,g_sfai_m.sfai004,g_sfai_m.sfai005
            ATTRIBUTE(WITHOUT DEFAULTS)
         
         BEFORE INPUT
            IF s_transaction_chk("N",0) THEN
               CALL s_transaction_begin()
            END IF   
            
         AFTER FIELD sfai001
            LET g_sfai_m.sfai001_desc = ''
            LET g_sfai_m.sfai001_desc_1 = ''
            IF NOT cl_null(g_sfai_m.sfai001) THEN
               IF g_sfai_m.sfai001 != g_sfai_m_o.sfai001 OR cl_null(g_sfai_m_o.sfai001) THEN
                  INITIALIZE g_chkparam.* TO NULL 
                  LET g_chkparam.arg1 = g_sfai_m.sfai001
                  IF NOT cl_chk_exist("v_imae001_1") THEN
                     LET g_sfai_m.sfai001 = g_sfai_m_o.sfai001
                     CALL s_desc_get_item_desc(g_sfai_m.sfai001) RETURNING g_sfai_m.sfai001_desc,g_sfai_m.sfai001_desc_1
                     DISPLAY BY NAME g_sfai_m.sfai001,g_sfai_m.sfai001_desc,g_sfai_m.sfai001_desc_1
                     NEXT FIELD sfai001
                  END IF
               END IF
               CALL s_desc_get_item_desc(g_sfai_m.sfai001) RETURNING g_sfai_m.sfai001_desc,g_sfai_m.sfai001_desc_1
               DISPLAY BY NAME g_sfai_m.sfai001_desc,g_sfai_m.sfai001_desc_1
            END IF 
            LET g_sfai_m_o.sfai001 = g_sfai_m.sfai001
            
         AFTER FIELD sfai002
            IF NOT cl_null(g_sfai_m.sfai002) THEN
               IF g_sfai_m.sfai002 != g_sfai_m_o.sfai002 OR cl_null(g_sfai_m_o.sfai002) THEN
                  IF NOT cl_ap_chk_range(g_sfai_m.sfai002,"0.000","1","","","azz-00079",1) THEN
                     LET g_sfai_m.sfai002 = g_sfai_m_o.sfai002
                     DISPLAY BY NAME g_sfai_m.sfai002
                     NEXT FIELD sfai002
                  END IF
               END IF
            END IF
            LET g_sfai_m_o.sfai002 = g_sfai_m.sfai002
         
         ON ACTION controlp INFIELD sfai001           
               INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
               LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfai_m.sfai001  #給予default值
            CALL q_imaf001()                            #呼叫開窗
            LET g_sfai_m.sfai001 = g_qryparam.return1   #將開窗取得的值回傳到變數
            DISPLAY g_sfai_m.sfai001 TO sfai001         #顯示到畫面上
            CALL s_desc_get_item_desc(g_sfai_m.sfai001) RETURNING g_sfai_m.sfai001_desc,g_sfai_m.sfai001_desc_1
            DISPLAY BY NAME g_sfai_m.sfai001_desc,g_sfai_m.sfai001_desc_1
            NEXT FIELD sfai001                          #返回原欄位
         
         AFTER INPUT
            IF INT_FLAG THEN
               EXIT DIALOG
            END IF
            LET l_count = 0
            SELECT COUNT(1) INTO l_count FROM sfai_t WHERE sfaient = g_enterprise AND sfaidocno = g_sfaa_m.sfaadocno
            IF l_count = 0  OR cl_null(l_count) THEN
               CALL s_transaction_begin()
               INSERT INTO sfai_t (sfaient,sfaidocno,sfaisite,sfai001,sfai002,sfai003,sfai004,sfai005)
                   VALUES (g_enterprise,g_sfaa_m.sfaadocno,g_site,g_sfai_m.sfai001,
                           g_sfai_m.sfai002,g_sfai_m.sfai003,g_sfai_m.sfai004,g_sfai_m.sfai005) 
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = "INSERT INTO sfai_t:",SQLERRMESSAGE
                  LET g_errparam.code   = SQLCA.sqlcode
                  LET g_errparam.popup  = TRUE
                  CALL s_transaction_end('N','0')
                  CALL cl_err()
                  NEXT FIELD CURRENT
               END IF
               CALL s_transaction_end('Y','0') 
            ELSE
               CALL s_transaction_begin()
               UPDATE sfai_t SET (sfai001,sfai002,sfai003,sfai004,sfai005) = 
                      (g_sfai_m.sfai001,g_sfai_m.sfai002,g_sfai_m.sfai003,g_sfai_m.sfai004,g_sfai_m.sfai005)
                WHERE sfaient = g_enterprise AND sfaidocno = g_sfaa_m.sfaadocno
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = "UPDATE sfai_t:",SQLERRMESSAGE
                  LET g_errparam.code   = SQLCA.sqlcode
                  LET g_errparam.popup  = TRUE
                  CALL s_transaction_end('N','0')
                  CALL cl_err()
                  NEXT FIELD CURRENT
               END IF
               #修改歷程記錄(單頭修改)
               LET g_log1 = util.JSON.stringify(g_sfai_m_t)
               LET g_log2 = util.JSON.stringify(g_sfai_m)
               IF NOT cl_log_modified_record(g_log1,g_log2) THEN 
                  CALL s_transaction_end('N','0')
               ELSE
                  CALL s_transaction_end('Y','0')
               END IF
            END IF
      END INPUT
      #160727-00025#1-e
      
      #Page1 預設值產生於此處
      INPUT ARRAY g_sfba_d FROM s_detail1.*
          ATTRIBUTE(COUNT = g_rec_b,WITHOUT DEFAULTS, #MAXCOUNT = g_max_rec,
                  INSERT ROW = l_allow_insert, 
                  DELETE ROW = l_allow_delete,
                  APPEND ROW = l_allow_insert)
 
         #自訂ACTION(detail_input,page_1)
         
         
         BEFORE INPUT
            #add-point:資料輸入前 name="input.body.before_input2"

            #end add-point
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN 
              CALL FGL_SET_ARR_CURR(g_sfba_d.getLength()+1) 
              LET g_insert = 'N' 
           END IF 
 
            CALL asft300_b_fill()
            #如果一直都在單身1則控制筆數位置
            IF g_loc = 'm' AND g_rec_b != 0 THEN
               CALL FGL_SET_ARR_CURR(g_idx_group.getValue("'1',"))
            END IF
            LET g_loc = 'm'
            LET g_rec_b = g_sfba_d.getLength()
            #add-point:資料輸入前 name="input.d.before_input"
            IF g_rec_b = 0 THEN
               CALL s_aooi200_get_slip(g_sfaa_m.sfaadocno) RETURNING l_success,l_ooba002
               IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0038') = '1' THEN
                  CALL s_transaction_begin()
                  CALL s_asft300_02(g_sfaa_m.sfaadocno,g_sfaa_m.sfaa003,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa015,g_sfaa_m.sfaa012,'N') RETURNING l_success,l_num
                  IF l_success THEN
                     CALL s_transaction_end('Y','0')
                  ELSE
                     CALL s_transaction_end('N','0')
                  END IF
                  CALL asft300_b_fill()
                  LET g_rec_b = g_sfba_d.getLength()
               END IF
            END IF
            #end add-point
         
         BEFORE ROW
            #add-point:modify段before row2 name="input.body.before_row2"

            #end add-point  
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac_t = l_ac 
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac
            LET g_detail_idx_list[1] = l_ac
            LET g_current_page = 1
            
            LET l_lock_sw = 'N'            #DEFAULT
            LET l_n = ARR_COUNT()
            DISPLAY l_ac TO FORMONLY.idx
         
            CALL s_transaction_begin()
            OPEN asft300_cl USING g_enterprise,g_site,g_sfaa_m.sfaadocno
            IF STATUS THEN
               INITIALIZE g_errparam TO NULL 
               LET g_errparam.extend = "OPEN asft300_cl:" 
               LET g_errparam.code   = STATUS 
               LET g_errparam.popup  = TRUE 
               CLOSE asft300_cl
               CALL s_transaction_end('N','0')
               CALL cl_err()
               RETURN
            END IF
            
            LET g_rec_b = g_sfba_d.getLength()
            
            IF g_rec_b >= l_ac 
               AND g_sfba_d[l_ac].sfbaseq IS NOT NULL
               AND g_sfba_d[l_ac].sfbaseq1 IS NOT NULL
 
            THEN
               LET l_cmd='u'
               LET g_sfba_d_t.* = g_sfba_d[l_ac].*  #BACKUP
               LET g_sfba_d_o.* = g_sfba_d[l_ac].*  #BACKUP
               CALL asft300_set_entry_b(l_cmd)
               #add-point:modify段after_set_entry_b name="input.body.after_set_entry_b"

               #end add-point  
               CALL asft300_set_no_entry_b(l_cmd)
               IF NOT asft300_lock_b("sfba_t","'1'") THEN
                  LET l_lock_sw='Y'
               ELSE
                  FETCH asft300_bcl INTO g_sfba_d[l_ac].sfbaseq,g_sfba_d[l_ac].sfbaseq1,g_sfba_d[l_ac].sfba002,g_sfba_d[l_ac].sfba003,g_sfba_d[l_ac].sfba004,
                                         g_sfba_d[l_ac].sfba005,g_sfba_d[l_ac].sfba022,g_sfba_d[l_ac].sfba006,g_sfba_d[l_ac].sfba033,g_sfba_d[l_ac].sfba021,
                                         g_sfba_d[l_ac].sfba007,g_sfba_d[l_ac].sfba008,g_sfba_d[l_ac].sfba009,g_sfba_d[l_ac].sfba010,g_sfba_d[l_ac].sfba011,
                                         g_sfba_d[l_ac].sfba012,g_sfba_d[l_ac].sfba023,g_sfba_d[l_ac].sfba024,g_sfba_d[l_ac].sfba013,g_sfba_d[l_ac].sfba014,
                                         g_sfba_d[l_ac].sfba015,g_sfba_d[l_ac].sfba016,g_sfba_d[l_ac].sfba025,g_sfba_d[l_ac].sfba017,g_sfba_d[l_ac].sfba018,
                                         g_sfba_d[l_ac].sfba019,g_sfba_d[l_ac].sfba020,g_sfba_d[l_ac].sfba029,g_sfba_d[l_ac].sfba030,g_sfba_d[l_ac].sfba028,
                                         g_sfba_d[l_ac].sfba001,g_sfba_d[l_ac].sfba026,g_sfba_d[l_ac].sfba027,g_sfba_d[l_ac].sfba034,g_sfba_d[l_ac].sfba035
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL 
                     LET g_errparam.extend = g_sfba_d_t.sfbaseq,":",SQLERRMESSAGE 
                     LET g_errparam.code   = SQLCA.sqlcode 
                     LET g_errparam.popup  = TRUE 
                     CALL cl_err()
                     LET l_lock_sw = "Y"
                  END IF
                  
                  #遮罩相關處理
                  #LET g_sfba_d_mask_o[l_ac].* =  g_sfba_d[l_ac].*
                  #CALL asft300_sfba_t_mask()
                  #LET g_sfba_d_mask_n[l_ac].* =  g_sfba_d[l_ac].*
                  
                  LET g_bfill = "N"
                  CALL asft300_show()
                  LET g_bfill = "Y"
                  
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            #add-point:modify段before row name="input.body.before_row"

            #end add-point  
            #其他table資料備份(確定是否更改用)
            
 
            #其他table進行lock
            
 
        
         BEFORE INSERT

            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            CALL s_transaction_begin()  #160407-00017#1 add
            INITIALIZE g_sfba_d[l_ac].* TO NULL
            INITIALIZE g_sfba_d_t.* TO NULL  #170226-00002#1-s
            INITIALIZE g_sfba_d_o.* TO NULL  #170226-00002#1-s
            LET g_sfba_d[l_ac].sfba007 = 0
            LET g_sfba_d[l_ac].sfba008 = "3"
            IF g_sfaa_m.sfaa004 = '1' THEN
               LET g_sfba_d[l_ac].sfba009 = "N"
            END IF 
            IF g_sfaa_m.sfaa004 = '2' THEN
               LET g_sfba_d[l_ac].sfba009 = "Y"
            END IF
            LET g_sfba_d[l_ac].sfba010 = "1"
            LET g_sfba_d[l_ac].sfba011 = "1"
            LET g_sfba_d[l_ac].sfba012 = "0"
            LET g_sfba_d[l_ac].sfba023 = g_sfaa_m.sfaa012 * g_sfba_d[l_ac].sfba010 / g_sfba_d[l_ac].sfba011
            LET g_sfba_d[l_ac].sfba024 = "0"
            LET g_sfba_d[l_ac].sfba013 = g_sfba_d[l_ac].sfba023 + g_sfba_d[l_ac].sfba024
            LET g_sfba_d[l_ac].sfba015 = "0"
            LET g_sfba_d[l_ac].sfba016 = "0"
            LET g_sfba_d[l_ac].sfba025 = "0"
            LET g_sfba_d[l_ac].number1 = g_sfba_d[l_ac].sfba013 - g_sfba_d[l_ac].sfba016           
            LET g_sfba_d[l_ac].sfba017 = "0"
            LET g_sfba_d[l_ac].sfba018 = "0"
            LET g_sfba_d[l_ac].sfba022 = 1
            LET g_sfba_d[l_ac].sfba026 = '1'
            LET g_sfba_d[l_ac].sfba028 = "N"
            LET g_sfba_d[l_ac].sfba021 = ' '
            #LET g_sfba_d_t.* = g_sfba_d[l_ac].*     #新輸入資料  #170226-00002#1
            SELECT MAX(sfbaseq) INTO g_sfba_d[l_ac].sfbaseq FROM sfba_t
             WHERE sfbaent = g_enterprise
               AND sfbasite = g_site
               AND sfbadocno = g_sfaa_m.sfaadocno
            CALL s_aooi200_get_slip(g_sfaa_m.sfaadocno) RETURNING l_success,l_ooba002
            CALL cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0049')  RETURNING l_sys
            IF cl_null(l_sys) OR l_sys = 0 THEN LET l_sys = 1 END IF  
            #160926-00034#1-s
            CALL s_aooi200_get_doc_default(g_site,'1',l_ooba002,'sfba009',g_sfba_d[l_ac].sfba009)
            RETURNING g_sfba_d[l_ac].sfba009
            #DISPLAY BY NAME g_sfba_d[l_ac].sfba009  #170226-00002#1
            #160926-00034#1-e
            IF cl_null(g_sfba_d[l_ac].sfbaseq) THEN 
               LET g_sfba_d[l_ac].sfbaseq = l_sys                 
            ELSE  
               LET g_sfba_d[l_ac].sfbaseq = g_sfba_d[l_ac].sfbaseq+l_sys
            END IF   
            SELECT MAX(sfbaseq1)+1 INTO g_sfba_d[l_ac].sfbaseq1 FROM sfba_t
             WHERE sfbaent = g_enterprise
               AND sfbasite = g_site
               AND sfbadocno = g_sfaa_m.sfaadocno
               AND sfbaseq = g_sfba_d[l_ac].sfbaseq
            IF cl_null(g_sfba_d[l_ac].sfbaseq1) THEN
               LET g_sfba_d[l_ac].sfbaseq1 = 0 
            END IF 
            #170226-00002#1-s
            CALL s_aooi200_get_doc_default(g_site,'1',l_ooba002,'sfba019',g_sfba_d[l_ac].sfba019)
                 RETURNING g_sfba_d[l_ac].sfba019
            IF cl_null(g_sfba_d[l_ac].sfba019) THEN
               CALL cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0076')
                    RETURNING g_sfba_d[l_ac].sfba019
            END IF
            LET g_sfba_d_t.* = g_sfba_d[l_ac].*     #新輸入資料
            LET g_sfba_d_o.* = g_sfba_d[l_ac].*     #新輸入資料
            #170226-00002#1-e
            CALL cl_show_fld_cont()
            CALL asft300_set_entry_b(l_cmd)
            CALL asft300_set_no_entry_b(l_cmd)
            #公用欄位給值(單身)


            #add-point:modify段before insert
            
            #end add-point

         AFTER INSERT
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 9001
               LET g_errparam.extend = ''
               LET g_errparam.popup = FALSE
               CALL cl_err()

               LET INT_FLAG = 0
               CANCEL INSERT
            END IF

            #add-point:單身新增
            LET l_rate = ''
            LET l_imaa006 = ''
            IF NOT cl_null(g_sfba_d[l_ac].sfba006) THEN 
               SELECT imaa006 INTO l_imaa006 FROM imaa_t
                WHERE imaaent = g_enterprise
                  AND imaa001 = g_sfba_d[l_ac].sfba006  
               IF NOT cl_null(g_sfba_d[l_ac].sfba006) AND NOT cl_null(l_imaa006) THEN
                  CALL s_aimi190_get_convert(g_sfba_d[l_ac].sfba006,g_sfba_d[l_ac].sfba014,l_imaa006) RETURNING l_success,l_rate
                  IF l_success = FALSE THEN
                     LET g_sfba_d[l_ac].sfba014 = g_sfba_d_t.sfba014
                     INITIALIZE g_ref_fields TO NULL
                     LET g_ref_fields[1] = g_sfba_d[l_ac].sfba014
                     CALL ap_ref_array2(g_ref_fields,"SELECT oocal003 FROM oocal_t WHERE oocalent='"||g_enterprise||"' AND oocal001=? AND oocal002='"||g_dlang||"'","") RETURNING g_rtn_fields
                     LET g_sfba_d[l_ac].sfba014_desc = '', g_rtn_fields[1] , ''
                     DISPLAY BY NAME g_sfba_d[l_ac].sfba014_desc 
                     NEXT FIELD sfba014                        
                  END IF
               END IF 
               IF cl_null(l_imaa006) THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'abm-00021'
                  LET g_errparam.extend = l_imaa006
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  LET g_sfba_d[l_ac].sfba014 = g_sfba_d_t.sfba014
                  INITIALIZE g_ref_fields TO NULL
                  LET g_ref_fields[1] = g_sfba_d[l_ac].sfba014
                  CALL ap_ref_array2(g_ref_fields,"SELECT oocal003 FROM oocal_t WHERE oocalent='"||g_enterprise||"' AND oocal001=? AND oocal002='"||g_dlang||"'","") RETURNING g_rtn_fields
                  LET g_sfba_d[l_ac].sfba014_desc = '', g_rtn_fields[1] , ''
                  DISPLAY BY NAME g_sfba_d[l_ac].sfba014_desc 
                  NEXT FIELD sfba014 
               END IF
            END IF 
            #end add-point

            LET l_count = 1
            SELECT COUNT(1) INTO l_count FROM sfba_t
             WHERE sfbaent = g_enterprise AND sfbasite = g_site AND sfbadocno = g_sfaa_m.sfaadocno

               AND sfbaseq = g_sfba_d[l_ac].sfbaseq
               AND sfbaseq1 = g_sfba_d[l_ac].sfbaseq1



            #資料未重複, 插入新增資料
            IF l_count = 0 THEN
               #add-point:單身新增前

               #end add-point

                              INITIALIZE gs_keys TO NULL
               LET gs_keys[1] = g_sfaa_m.sfaadocno
               LET gs_keys[2] = g_sfba_d[g_detail_idx].sfbaseq
               LET gs_keys[3] = g_sfba_d[g_detail_idx].sfbaseq1
               CALL asft300_insert_b('sfba_t',gs_keys,"'1'")

               #add-point:單身新增後
               #161031-00025#17-s
               IF NOT cl_null(g_sfba_d[l_ac].ooff013) THEN
                  CALL s_aooi360_gen('7',g_prog,g_sfaa_m.sfaadocno,g_sfba_d[l_ac].sfbaseq,g_sfba_d[l_ac].sfbaseq1,'','','','','','','1',g_sfba_d[l_ac].ooff013) RETURNING l_success
               END IF
               #161031-00025#17-e               
               #end add-point
            ELSE
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = "std-00006"
               LET g_errparam.extend = 'INSERT'
               LET g_errparam.popup = TRUE
               CALL cl_err()

               INITIALIZE g_sfba_d[l_ac].* TO NULL
               CALL s_transaction_end('N','0')
               CANCEL INSERT
            END IF

            IF SQLCA.SQLcode  THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = "sfba_t"
               LET g_errparam.popup = TRUE
               CALL cl_err()

               CALL s_transaction_end('N','0')
               CANCEL INSERT
            ELSE
               #先刷新資料
               #CALL asft300_b_fill()
               #資料多語言用-增/改

               #add-point:input段-after_insert
               #单身备注写入 
               #161031-00025#17-s
#               IF NOT cl_null(g_sfba_d[l_ac].sfba_ooff013) THEN
#                  IF NOT s_aooi360_gen('7',g_sfaa_m.sfaadocno,g_sfba_d[l_ac].sfbaseq,g_sfba_d[l_ac].sfbaseq1,' ',' ',' ',' ',' ',' ',' ','2',g_sfba_d[l_ac].sfba_ooff013) THEN
#                     CALL s_transaction_end('N','0')
#                     CANCEL INSERT
#                  END IF
#               ELSE
#                  IF NOT s_aooi360_del('7',g_sfaa_m.sfaadocno,g_sfba_d[l_ac].sfbaseq,g_sfba_d[l_ac].sfbaseq1,' ',' ',' ',' ',' ',' ',' ','2') THEN
#                     CALL s_transaction_end('N','0')
#                     CANCEL INSERT
#                  END IF
#               END IF               
               IF NOT cl_null(g_sfba_d[l_ac].ooff013) THEN
                  IF NOT s_aooi360_gen('7',g_prog,g_sfaa_m.sfaadocno,g_sfba_d[l_ac].sfbaseq,g_sfba_d[l_ac].sfbaseq1,' ',' ',' ',' ',' ',' ','1',g_sfba_d[l_ac].ooff013) THEN
                     CALL s_transaction_end('N','0')
                     CANCEL INSERT
                  END IF
               ELSE
                  IF NOT s_aooi360_del('7',g_prog,g_sfaa_m.sfaadocno,g_sfba_d[l_ac].sfbaseq,g_sfba_d[l_ac].sfbaseq1,' ',' ',' ',' ',' ',' ','1') THEN
                     CALL s_transaction_end('N','0')
                     CANCEL INSERT
                  END IF
               END IF
               #161031-00025#17-e
               #其他产品特征写入DB
               IF l_inam.getLength() > 1 THEN  #因為第一筆資料已呈現在畫面並寫入DB, 從第二筆開始處理
               #161109-00085#27-s
               #SELECT * INTO l_sfba.* FROM sfba_t WHERE sfbaent = g_enterprise AND sfbasite = g_site
               #161109-00085#66 --s mark
               #SELECT sfbaent,sfbasite,sfbadocno,sfbaseq,sfbaseq1,sfba001,sfba002,sfba003,sfba004,sfba005,
               #       sfba006,sfba007,sfba008,sfba009,sfba010,sfba011,sfba012,sfba013,sfba014,sfba015,
               #       sfba016,sfba017,sfba018,sfba019,sfba020,sfba021,sfba022,sfba023,sfba024,sfba025,
               #       sfba026,sfba027,sfba028,sfba029,sfba030,sfba031,sfba032,sfba033,sfba034,sfba035 
               #  INTO l_sfba.sfbaent,l_sfba.sfbasite,l_sfba.sfbadocno,l_sfba.sfbaseq,l_sfba.sfbaseq1,
               #       l_sfba.sfba001,l_sfba.sfba002,l_sfba.sfba003,l_sfba.sfba004,l_sfba.sfba005,
               #       l_sfba.sfba006,l_sfba.sfba007,l_sfba.sfba008,l_sfba.sfba009,l_sfba.sfba010,
               #       l_sfba.sfba011,l_sfba.sfba012,l_sfba.sfba013,l_sfba.sfba014,l_sfba.sfba015,
               #       l_sfba.sfba016,l_sfba.sfba017,l_sfba.sfba018,l_sfba.sfba019,l_sfba.sfba020,
               #       l_sfba.sfba021,l_sfba.sfba022,l_sfba.sfba023,l_sfba.sfba024,l_sfba.sfba025,
               #       l_sfba.sfba026,l_sfba.sfba027,l_sfba.sfba028,l_sfba.sfba029,l_sfba.sfba030,
               #       l_sfba.sfba031,l_sfba.sfba032,l_sfba.sfba033,l_sfba.sfba034,l_sfba.sfba035 
               #161109-00085#66 --e mark        
               #161109-00085#66 --s add
               SELECT sfbaent,sfbasite,sfbadocno,sfbaseq,sfbaseq1,
                      sfba001,sfba002,sfba003,sfba004,sfba005,
                      sfba006,sfba007,sfba008,sfba009,sfba010,
                      sfba011,sfba012,sfba013,sfba014,sfba015,
                      sfba016,sfba017,sfba018,sfba019,sfba020,
                      sfba021,sfba022,sfba023,sfba024,sfba025,
                      sfba026,sfba027,sfba028,sfba029,sfba030,
                      sfbaud001,sfbaud002,sfbaud003,sfbaud004,sfbaud005,
                      sfbaud006,sfbaud007,sfbaud008,sfbaud009,sfbaud010,
                      sfbaud011,sfbaud012,sfbaud013,sfbaud014,sfbaud015,
                      sfbaud016,sfbaud017,sfbaud018,sfbaud019,sfbaud020,
                      sfbaud021,sfbaud022,sfbaud023,sfbaud024,sfbaud025,
                      sfbaud026,sfbaud027,sfbaud028,sfbaud029,sfbaud030,
                      sfba031,sfba032,sfba033,sfba034,sfba035
                 INTO l_sfba.sfbaent,l_sfba.sfbasite,l_sfba.sfbadocno,l_sfba.sfbaseq,l_sfba.sfbaseq1,
                      l_sfba.sfba001,l_sfba.sfba002,l_sfba.sfba003,l_sfba.sfba004,l_sfba.sfba005,
                      l_sfba.sfba006,l_sfba.sfba007,l_sfba.sfba008,l_sfba.sfba009,l_sfba.sfba010,
                      l_sfba.sfba011,l_sfba.sfba012,l_sfba.sfba013,l_sfba.sfba014,l_sfba.sfba015,
                      l_sfba.sfba016,l_sfba.sfba017,l_sfba.sfba018,l_sfba.sfba019,l_sfba.sfba020,
                      l_sfba.sfba021,l_sfba.sfba022,l_sfba.sfba023,l_sfba.sfba024,l_sfba.sfba025,
                      l_sfba.sfba026,l_sfba.sfba027,l_sfba.sfba028,l_sfba.sfba029,l_sfba.sfba030,
                      l_sfba.sfbaud001,l_sfba.sfbaud002,l_sfba.sfbaud003,l_sfba.sfbaud004,l_sfba.sfbaud005,
                      l_sfba.sfbaud006,l_sfba.sfbaud007,l_sfba.sfbaud008,l_sfba.sfbaud009,l_sfba.sfbaud010,
                      l_sfba.sfbaud011,l_sfba.sfbaud012,l_sfba.sfbaud013,l_sfba.sfbaud014,l_sfba.sfbaud015,
                      l_sfba.sfbaud016,l_sfba.sfbaud017,l_sfba.sfbaud018,l_sfba.sfbaud019,l_sfba.sfbaud020,
                      l_sfba.sfbaud021,l_sfba.sfbaud022,l_sfba.sfbaud023,l_sfba.sfbaud024,l_sfba.sfbaud025,
                      l_sfba.sfbaud026,l_sfba.sfbaud027,l_sfba.sfbaud028,l_sfba.sfbaud029,l_sfba.sfbaud030,
                      l_sfba.sfba031,l_sfba.sfba032,l_sfba.sfba033,l_sfba.sfba034,l_sfba.sfba035
               #161109-00085#66 --e add              
                 FROM sfba_t
                WHERE sfbaent = g_enterprise AND sfbasite = g_site
                  AND sfbadocno = g_sfaa_m.sfaadocno AND sfbaseq = g_sfba_d[l_ac].sfbaseq AND sfbaseq1 = g_sfba_d[l_ac].sfbaseq1
               #161109-00085#27-e
                  FOR l_k = 2 TO l_inam.getLength()
                     LET l_sfba.sfbaseq1 = l_sfba.sfbaseq1 + 1
                     LET l_sfba.sfba021 = l_inam[l_k].inam002
                     LET l_sfba.sfba023 = l_inam[l_k].inam004
                     LET l_sfba.sfba024 = 0
                     LET l_sfba.sfba013 = l_sfba.sfba023 + l_sfba.sfba024
                     #重算QPA分子分母
                     CALL asft300_sfba023_qpa(l_sfba.sfba023) RETURNING l_sfba.sfba010,l_sfba.sfba011
                     #建议应发数量
                     CALL s_asft300_03(l_sfba.sfba006,l_sfba.sfba013) RETURNING l_success,l_sfba013
                     IF l_success THEN
                        LET l_sfba.sfba013=l_sfba013
                     END IF               
                     LET l_sfba.sfba024 = l_sfba.sfba013 - l_sfba.sfba023
                     #2015/09/30 by stellar add ----- (S)
                     IF cl_null(l_sfba.sfba003) THEN
                        LET l_sfba.sfba003 = ' '
                     END IF
                     IF cl_null(l_sfba.sfba002) THEN
                        LET l_sfba.sfba002 = ' '
                     END IF
                     #2015/09/30 by stellar add ----- (E)
                     #161109-00085#27-s
                     #INSERT INTO sfba_t VALUES(l_sfba.*)
                     #161109-00085#66 --s mark
                     #INSERT INTO sfba_t(sfbaent,sfbasite,sfbadocno,sfbaseq,sfbaseq1,sfba001,sfba002,sfba003,sfba004,sfba005,
                     #                   sfba006,sfba007,sfba008,sfba009,sfba010,sfba011,sfba012,sfba013,sfba014,sfba015,
                     #                   sfba016,sfba017,sfba018,sfba019,sfba020,sfba021,sfba022,sfba023,sfba024,sfba025,
                     #                   sfba026,sfba027,sfba028,sfba029,sfba030,sfba031,sfba032,sfba033,sfba034,sfba035) 
                     #VALUES(l_sfba.sfbaent,l_sfba.sfbasite,l_sfba.sfbadocno,l_sfba.sfbaseq,l_sfba.sfbaseq1,
                     #       l_sfba.sfba001,l_sfba.sfba002,l_sfba.sfba003,l_sfba.sfba004,l_sfba.sfba005,
                     #       l_sfba.sfba006,l_sfba.sfba007,l_sfba.sfba008,l_sfba.sfba009,l_sfba.sfba010,
                     #       l_sfba.sfba011,l_sfba.sfba012,l_sfba.sfba013,l_sfba.sfba014,l_sfba.sfba015,
                     #       l_sfba.sfba016,l_sfba.sfba017,l_sfba.sfba018,l_sfba.sfba019,l_sfba.sfba020,
                     #       l_sfba.sfba021,l_sfba.sfba022,l_sfba.sfba023,l_sfba.sfba024,l_sfba.sfba025,
                     #       l_sfba.sfba026,l_sfba.sfba027,l_sfba.sfba028,l_sfba.sfba029,l_sfba.sfba030,
                     #       l_sfba.sfba031,l_sfba.sfba032,l_sfba.sfba033,l_sfba.sfba034,l_sfba.sfba035)
                     #161109-00085#66 --e mark
                     #161109-00085#27-e
                     #161109-00085#66 --s add
                     INSERT INTO sfba_t(sfbaent,sfbasite,sfbadocno,sfbaseq,sfbaseq1,
                                        sfba001,sfba002,sfba003,sfba004,sfba005,
                                        sfba006,sfba007,sfba008,sfba009,sfba010,
                                        sfba011,sfba012,sfba013,sfba014,sfba015,
                                        sfba016,sfba017,sfba018,sfba019,sfba020,
                                        sfba021,sfba022,sfba023,sfba024,sfba025,
                                        sfba026,sfba027,sfba028,sfba029,sfba030,
                                        sfbaud001,sfbaud002,sfbaud003,sfbaud004,sfbaud005,
                                        sfbaud006,sfbaud007,sfbaud008,sfbaud009,sfbaud010,
                                        sfbaud011,sfbaud012,sfbaud013,sfbaud014,sfbaud015,
                                        sfbaud016,sfbaud017,sfbaud018,sfbaud019,sfbaud020,
                                        sfbaud021,sfbaud022,sfbaud023,sfbaud024,sfbaud025,
                                        sfbaud026,sfbaud027,sfbaud028,sfbaud029,sfbaud030,
                                        sfba031,sfba032,sfba033,sfba034,sfba035)
                                 VALUES(l_sfba.sfbaent,l_sfba.sfbasite,l_sfba.sfbadocno,l_sfba.sfbaseq,l_sfba.sfbaseq1,
                                        l_sfba.sfba001,l_sfba.sfba002,l_sfba.sfba003,l_sfba.sfba004,l_sfba.sfba005,
                                        l_sfba.sfba006,l_sfba.sfba007,l_sfba.sfba008,l_sfba.sfba009,l_sfba.sfba010,
                                        l_sfba.sfba011,l_sfba.sfba012,l_sfba.sfba013,l_sfba.sfba014,l_sfba.sfba015,
                                        l_sfba.sfba016,l_sfba.sfba017,l_sfba.sfba018,l_sfba.sfba019,l_sfba.sfba020,
                                        l_sfba.sfba021,l_sfba.sfba022,l_sfba.sfba023,l_sfba.sfba024,l_sfba.sfba025,
                                        l_sfba.sfba026,l_sfba.sfba027,l_sfba.sfba028,l_sfba.sfba029,l_sfba.sfba030,
                                        l_sfba.sfbaud001,l_sfba.sfbaud002,l_sfba.sfbaud003,l_sfba.sfbaud004,l_sfba.sfbaud005,
                                        l_sfba.sfbaud006,l_sfba.sfbaud007,l_sfba.sfbaud008,l_sfba.sfbaud009,l_sfba.sfbaud010,
                                        l_sfba.sfbaud011,l_sfba.sfbaud012,l_sfba.sfbaud013,l_sfba.sfbaud014,l_sfba.sfbaud015,
                                        l_sfba.sfbaud016,l_sfba.sfbaud017,l_sfba.sfbaud018,l_sfba.sfbaud019,l_sfba.sfbaud020,
                                        l_sfba.sfbaud021,l_sfba.sfbaud022,l_sfba.sfbaud023,l_sfba.sfbaud024,l_sfba.sfbaud025,
                                        l_sfba.sfbaud026,l_sfba.sfbaud027,l_sfba.sfbaud028,l_sfba.sfbaud029,l_sfba.sfbaud030,
                                        l_sfba.sfba031,l_sfba.sfba032,l_sfba.sfba033,l_sfba.sfba034,l_sfba.sfba035)
                     #161109-00085#66 --e add
                  END FOR
                  CALL asft300_b_fill()
               END IF
               CALL l_inam.clear()
               #end add-point
               CALL s_transaction_end('Y','0')
               ERROR 'INSERT O.K'
               LET g_rec_b = g_rec_b + 1
            END IF

         BEFORE DELETE                            #是否取消單身
            IF l_cmd = 'a' THEN
               CALL FGL_SET_ARR_CURR(l_ac-1)
               CALL g_sfba_d.deleteElement(l_ac)
               NEXT FIELD sfbaseq
            END IF

            IF g_sfba_d[l_ac].sfbaseq IS NOT NULL
               AND g_sfba_d_t.sfbaseq1 IS NOT NULL THEN
               
              #多项序有两种情况，一种是取替代，一种是多特征的，考虑到后面成本计算，都不做删除处理，
              #如需删除此项，对于取替代的话使用取替代还原操作，对于多特征的话直接把数量改成0
              LET l_m = 0
               SELECT COUNT(1) INTO l_m FROM sfba_t
                WHERE sfbaent = g_enterprise AND sfbasite = g_site 
                  AND sfbadocno = g_sfaa_m.sfaadocno 
                  AND sfbaseq = g_sfba_d[l_ac].sfbaseq
               IF l_m > 1 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code =  'asf-00477'
                  LET g_errparam.extend = g_sfba_d[l_ac].sfbaseq
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  CANCEL DELETE
               END IF
               
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code =  -263
                  LET g_errparam.extend = ""
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  CANCEL DELETE
               END IF

               #add-point:單身刪除前
               
               #end add-point

               DELETE FROM sfba_t
                WHERE sfbaent = g_enterprise AND sfbasite = g_site AND sfbadocno = g_sfaa_m.sfaadocno AND

                      sfbaseq = g_sfba_d_t.sfbaseq
                  AND sfbaseq1 = g_sfba_d_t.sfbaseq1



               #add-point:單身刪除中
               #161031-00025#17-s
               CALL s_aooi360_del('7',g_prog,g_sfaa_m.sfaadocno,g_sfba_d_t.sfbaseq,'','','','','','','','1') RETURNING l_success
               #161031-00025#17-e                
               #end add-point

               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = "sfba_t"
               LET g_errparam.popup = TRUE
               CALL cl_err()

                  CALL s_transaction_end('N','0')
                  CANCEL DELETE
               ELSE
                  LET g_rec_b = g_rec_b-1

                  #add-point:單身刪除後
                  IF NOT s_aooi360_del('7',g_sfaa_m.sfaadocno,g_sfba_d[l_ac].sfbaseq,g_sfba_d[l_ac].sfbaseq1,' ',' ',' ',' ',' ',' ',' ','2') THEN
                     CALL s_transaction_end('N','0')
                     CANCEL DELETE
                  END IF
                  #end add-point
                  CALL s_transaction_end('Y','0')
               END IF
               CLOSE asft300_bcl
               LET l_count = g_sfba_d.getLength()
            END IF

                           INITIALIZE gs_keys TO NULL
               LET gs_keys[1] = g_sfaa_m.sfaadocno
               LET gs_keys[2] = g_sfba_d[g_detail_idx].sfbaseq
               LET gs_keys[3] = g_sfba_d[g_detail_idx].sfbaseq1


         AFTER DELETE
            #add-point:單身刪除後2
            
            #end add-point
#                           CALL asft300_delete_b('sfba_t',gs_keys,"'1'")

         #---------------------<  Detail: page1  >---------------------
         #----<<sfbaseq>>----
         #此段落由子樣板a02產生
         AFTER FIELD sfbaseq
            #此段落由子樣板a15產生
            IF NOT cl_ap_chk_Range(g_sfba_d[l_ac].sfbaseq,"0","0","","","azz-00079",1) THEN
               LET g_sfba_d[g_detail_idx].sfbaseq = g_sfba_d_t.sfbaseq
               NEXT FIELD sfbaseq
            END IF


            #add-point:AFTER FIELD sfbaseq
            #此段落由子樣板a05產生
            IF NOT cl_null(g_sfba_d[l_ac].sfbaseq) AND (cl_null(g_sfba_d_t.sfbaseq) OR g_sfba_d[l_ac].sfbaseq != g_sfba_d_t.sfbaseq) THEN
               SELECT MAX(sfbaseq1)+1 INTO g_sfba_d[l_ac].sfbaseq1 FROM sfba_t
                WHERE sfbaent = g_enterprise
                  AND sfbasite = g_site
                  AND sfbadocno = g_sfaa_m.sfaadocno
                  AND sfbaseq = g_sfba_d[l_ac].sfbaseq
               IF cl_null(g_sfba_d[l_ac].sfbaseq1) THEN
                  LET g_sfba_d[l_ac].sfbaseq1 = 0 
               END IF 
            END IF
            IF  NOT cl_null(g_sfaa_m.sfaadocno) AND NOT cl_null(g_sfba_d[g_detail_idx].sfbaseq) AND NOT cl_null(g_sfba_d[g_detail_idx].sfbaseq1) THEN
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_sfaa_m.sfaadocno != g_sfaadocno_t OR g_sfba_d[g_detail_idx].sfbaseq != g_sfba_d_t.sfbaseq OR g_sfba_d[g_detail_idx].sfbaseq1 != g_sfba_d_t.sfbaseq1)) THEN
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM sfba_t WHERE "||"sfbaent = '" ||g_enterprise|| "' AND sfbasite = '" ||g_site|| "' AND "||"sfbadocno = '"||g_sfaa_m.sfaadocno ||"' AND "|| "sfbaseq = '"||g_sfba_d[g_detail_idx].sfbaseq ||"' AND "|| "sfbaseq1 = '"||g_sfba_d[g_detail_idx].sfbaseq1 ||"'",'std-00004',0) THEN
                     LET g_sfba_d[g_detail_idx].sfbaseq = g_sfba_d_t.sfbaseq
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF

            IF g_sfba_d[g_detail_idx].sfbaseq != g_sfba_d_t.sfbaseq THEN
               IF NOT asft300_sfbaseq(l_cmd) THEN
                  LET g_sfba_d[g_detail_idx].sfbaseq = g_sfba_d_t.sfbaseq
                  NEXT FIELD CURRENT
               END IF       
            END IF 
           #160908-00025#1-s-add
           IF g_sfba_d[g_detail_idx].sfbaseq != g_sfba_d_t.sfbaseq THEN
              IF NOT asft300_sfbaseq_2(l_cmd) THEN
                 LET g_sfba_d[g_detail_idx].sfbaseq = g_sfba_d_t.sfbaseq
                 NEXT FIELD CURRENT
              END IF       
           END IF
           #160908-00025#1-e-add
           IF NOT cl_null(g_sfaa_m.sfaadocno) AND NOT cl_null(g_sfba_d[g_detail_idx].sfbaseq) AND NOT cl_null(g_sfba_d[g_detail_idx].sfbaseq1) THEN
              CALL s_asft300_07(g_sfaa_m.sfaadocno,g_sfba_d[g_detail_idx].sfbaseq,g_sfba_d[g_detail_idx].sfbaseq1) RETURNING l_success,g_sfba_d[g_detail_idx].number2
           END IF
         
          {#ADP版次:1#}
            #END add-point


         #此段落由子樣板a01產生
         BEFORE FIELD sfbaseq
            #add-point:BEFORE FIELD sfbaseq
                            
            
            #END add-point

         #此段落由子樣板a04產生
         ON CHANGE sfbaseq
            #add-point:ON CHANGE sfbaseq
            
            #END add-point

         #----<<sfbaseq1>>----
         #此段落由子樣板a02產生
         AFTER FIELD sfbaseq1
            #此段落由子樣板a15產生
            IF NOT cl_ap_chk_Range(g_sfba_d[l_ac].sfbaseq1,"0","1","","","azz-00079",1) THEN
               LET g_sfba_d[g_detail_idx].sfbaseq1 = g_sfba_d_t.sfbaseq1
               NEXT FIELD sfbaseq1
            END IF


            #add-point:AFTER FIELD sfbaseq1
            #此段落由子樣板a05產生
            IF  NOT cl_null(g_sfaa_m.sfaadocno) AND NOT cl_null(g_sfba_d[g_detail_idx].sfbaseq) AND NOT cl_null(g_sfba_d[g_detail_idx].sfbaseq1) THEN
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_sfaa_m.sfaadocno != g_sfaadocno_t OR g_sfba_d[g_detail_idx].sfbaseq != g_sfba_d_t.sfbaseq OR g_sfba_d[g_detail_idx].sfbaseq1 != g_sfba_d_t.sfbaseq1)) THEN
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM sfba_t WHERE "||"sfbaent = '" ||g_enterprise|| "' AND sfbasite = '" ||g_site|| "' AND "||"sfbadocno = '"||g_sfaa_m.sfaadocno ||"' AND "|| "sfbaseq = '"||g_sfba_d[g_detail_idx].sfbaseq ||"' AND "|| "sfbaseq1 = '"||g_sfba_d[g_detail_idx].sfbaseq1 ||"'",'std-00004',0) THEN
                     LET g_sfba_d[g_detail_idx].sfbaseq1 = g_sfba_d_t.sfbaseq1
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
           
            IF NOT cl_null(g_sfaa_m.sfaadocno) AND NOT cl_null(g_sfba_d[g_detail_idx].sfbaseq) AND NOT cl_null(g_sfba_d[g_detail_idx].sfbaseq1) THEN
               CALL s_asft300_07(g_sfaa_m.sfaadocno,g_sfba_d[g_detail_idx].sfbaseq,g_sfba_d[g_detail_idx].sfbaseq1) RETURNING l_success,g_sfba_d[g_detail_idx].number2
            END IF
            
            IF g_sfba_d[l_ac].sfbaseq1 != 0 THEN
               LET g_sfba_d[g_detail_idx].sfba010 = 0
               LET g_sfba_d[g_detail_idx].sfba011 = 0
            END IF
            CALL asft300_set_entry_b(l_cmd)
            CALL asft300_set_no_entry_b(l_cmd)
            #END add-point


         #此段落由子樣板a01產生
         BEFORE FIELD sfbaseq1
            IF cl_null(g_sfba_d[g_detail_idx].sfbaseq1) THEN 
               IF cl_null(g_sfba_d[g_detail_idx].sfbaseq) THEN
                  NEXT FIELD sfbaseq
               END IF
               SELECT MAX(sfbaseq1)+1 INTO g_sfba_d[g_detail_idx].sfbaseq1 FROM sfba_t
                WHERE sfbaent = g_enterprise
                  AND sfbasite = g_site
                  AND sfbadocno = g_sfaa_m.sfaadocno
                  AND sfbaseq = g_sfba_d[g_detail_idx].sfbaseq
               IF cl_null(g_sfba_d[g_detail_idx].sfbaseq1) THEN
                  LET g_sfba_d[g_detail_idx].sfbaseq1 = 0 
               END IF 
            END IF 

         #此段落由子樣板a04產生
         ON CHANGE sfbaseq1
            #add-point:ON CHANGE sfbaseq1
            
            #END add-point

         #----<<sfba002>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfba002
            #add-point:BEFORE FIELD sfba002
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba002
           # IF g_sfba_d[g_detail_idx].sfba002 IS NOT NULL THEN
            IF NOT cl_null(g_sfba_d[g_detail_idx].sfba002) THEN
               IF cl_null(g_sfba_d_t.sfba002) OR g_sfba_d[g_detail_idx].sfba002 != g_sfba_d_t.sfba002 THEN
                  #检查是否存在部位
                  #LET l_n = 0
                  #SELECT COUNT(1) INTO l_n FROM oocq_t WHERE oocqent = g_enterprise AND oocq001 = '215'
                  #   AND oocq002 = g_sfba_d[g_detail_idx].sfba002
                  #IF l_n = 0 THEN
                  #   CALL cl_err_msg(g_sfba_d[g_detail_idx].sfba002,'amm-00013','215',1)
                  #   LET g_sfba_d[g_detail_idx].sfba002 = g_sfba_d_t.sfba002
                  #   INITIALIZE g_chkparam.* TO NULL
                  #   LET g_chkparam.arg1 = '215'
                  #   LET g_chkparam.arg2 = g_sfba_d[l_ac].sfba002
                  #   CALL cl_ref_val("v_oocql002")
                  #   LET g_sfba_d[l_ac].sfba002_desc = g_chkparam.return1
                  #   DISPLAY BY NAME g_sfba_d[l_ac].sfba002_desc                     
                  #   NEXT FIELD sfba002
                  #END IF 
                  #LET l_n = 0
                  #SELECT COUNT(1) INTO l_n FROM oocq_t WHERE oocqent = g_enterprise AND oocq001 = '215'
                  #   AND oocq002 = g_sfba_d[g_detail_idx].sfba002 AND oocqstus = 'Y'
                  #IF l_n = 0 THEN
                  #   CALL cl_err_msg(g_sfba_d[g_detail_idx].sfba002,'amm-00014','215',1)
                  #   LET g_sfba_d[g_detail_idx].sfba002 = g_sfba_d_t.sfba002
                  #   INITIALIZE g_chkparam.* TO NULL
                  #   LET g_chkparam.arg1 = '215'
                  #   LET g_chkparam.arg2 = g_sfba_d[l_ac].sfba002
                  #   CALL cl_ref_val("v_oocql002")
                  #   LET g_sfba_d[l_ac].sfba002_desc = g_chkparam.return1
                  #   DISPLAY BY NAME g_sfba_d[l_ac].sfba002_desc
                  #   NEXT FIELD sfba002
                  #END IF
                  IF NOT s_azzi650_chk_exist('215',g_sfba_d[g_detail_idx].sfba002) THEN
                     LET g_sfba_d[g_detail_idx].sfba002 = g_sfba_d_t.sfba002
                     INITIALIZE g_chkparam.* TO NULL
                     LET g_chkparam.arg1 = '215'
                     LET g_chkparam.arg2 = g_sfba_d[l_ac].sfba002
                     CALL cl_ref_val("v_oocql002")
                     LET g_sfba_d[l_ac].sfba002_desc = g_chkparam.return1
                     DISPLAY BY NAME g_sfba_d[l_ac].sfba002_desc
                     NEXT FIELD sfba002
                  END IF
                  IF NOT asft300_sfbaseq(l_cmd) THEN
                     LET g_sfba_d[g_detail_idx].sfba002 = g_sfba_d_t.sfba002
                     INITIALIZE g_chkparam.* TO NULL
                     LET g_chkparam.arg1 = '215'
                     LET g_chkparam.arg2 = g_sfba_d[l_ac].sfba002
                     CALL cl_ref_val("v_oocql002")
                     LET g_sfba_d[l_ac].sfba002_desc = g_chkparam.return1
                     DISPLAY BY NAME g_sfba_d[l_ac].sfba002_desc
                     NEXT FIELD sfba002
                  END IF
                  #160908-00025#1-s-add
                  IF NOT asft300_sfbaseq_2(l_cmd) THEN
                     LET g_sfba_d[g_detail_idx].sfba002 = g_sfba_d_t.sfba002
                     INITIALIZE g_chkparam.* TO NULL
                     LET g_chkparam.arg1 = '215'
                     LET g_chkparam.arg2 = g_sfba_d[l_ac].sfba002
                     CALL cl_ref_val("v_oocql002")
                     LET g_sfba_d[l_ac].sfba002_desc = g_chkparam.return1
                     DISPLAY BY NAME g_sfba_d[l_ac].sfba002_desc
                     NEXT FIELD sfba002
                  END IF
                  #160908-00025#1-e-add
               END IF
            ELSE
               LET g_sfba_d[g_detail_idx].sfba002 = ' '             
            END IF
            INITIALIZE g_chkparam.* TO NULL
            LET g_chkparam.arg1 = '215'
            LET g_chkparam.arg2 = g_sfba_d[l_ac].sfba002
            CALL cl_ref_val("v_oocql002")
            LET g_sfba_d[l_ac].sfba002_desc = g_chkparam.return1
            DISPLAY BY NAME g_sfba_d[l_ac].sfba002_desc                  
         #----<<sfba003>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfba003
            #add-point:BEFORE FIELD sfba003
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba003
            #IF g_sfba_d[g_detail_idx].sfba003 IS NOT NULL THEN
            IF NOT cl_null(g_sfba_d[g_detail_idx].sfba003) THEN
               IF cl_null(g_sfba_d_t.sfba003) OR g_sfba_d[g_detail_idx].sfba003 != g_sfba_d_t.sfba003 THEN
                  #检查是否存在部位
                 #SELECT COUNT(1) INTO l_n FROM oocq_t WHERE oocqent = g_enterprise AND oocq001 = '221'
                 #   AND oocq002 = g_sfba_d[g_detail_idx].sfba003
                 #IF l_n = 0 THEN
                 #   CALL cl_err(g_sfba_d[g_detail_idx].sfba003,'',1)
                 #   LET g_sfba_d[g_detail_idx].sfba003 = g_sfba_d_t.sfba003
                 #   NEXT FIELD sfba003
                 #END IF 
                  IF NOT s_azzi650_chk_exist('221',g_sfba_d[g_detail_idx].sfba003) THEN
                     LET g_sfba_d[g_detail_idx].sfba003 = g_sfba_d_t.sfba003
                     INITIALIZE g_chkparam.* TO NULL
                     LET g_chkparam.arg1 = '221'
                     LET g_chkparam.arg2 = g_sfba_d[l_ac].sfba003
                     CALL cl_ref_val("v_oocql002")
                     LET g_sfba_d[l_ac].sfba003_desc = g_chkparam.return1
                     DISPLAY BY NAME g_sfba_d[l_ac].sfba003_desc                     
                     NEXT FIELD sfba003
                  END IF   
                  IF NOT asft300_sfbaseq(l_cmd) THEN
                     LET g_sfba_d[g_detail_idx].sfba003 = g_sfba_d_t.sfba003                  
                     #部位说明
                     INITIALIZE g_chkparam.* TO NULL
                     LET g_chkparam.arg1 = '221'
                     LET g_chkparam.arg2 = g_sfba_d[l_ac].sfba003
                     CALL cl_ref_val("v_oocql002")
                     LET g_sfba_d[l_ac].sfba003_desc = g_chkparam.return1
                     DISPLAY BY NAME g_sfba_d[l_ac].sfba003_desc                     
                     NEXT FIELD sfba003
                  END IF
                  #160908-00025#1-s-add
                  IF NOT asft300_sfbaseq_2(l_cmd) THEN
                     LET g_sfba_d[g_detail_idx].sfba003 = g_sfba_d_t.sfba003                  
                     #部位说明
                     INITIALIZE g_chkparam.* TO NULL
                     LET g_chkparam.arg1 = '221'
                     LET g_chkparam.arg2 = g_sfba_d[l_ac].sfba003
                     CALL cl_ref_val("v_oocql002")
                     LET g_sfba_d[l_ac].sfba003_desc = g_chkparam.return1
                     DISPLAY BY NAME g_sfba_d[l_ac].sfba003_desc                     
                     NEXT FIELD sfba003
                  END IF
                  #160908-00025#1-e-add
               END IF
            ELSE
               LET g_sfba_d[g_detail_idx].sfba003 = ' '            
            END IF                  
            #部位说明
            INITIALIZE g_chkparam.* TO NULL
            LET g_chkparam.arg1 = '221'
            LET g_chkparam.arg2 = g_sfba_d[l_ac].sfba003
            CALL cl_ref_val("v_oocql002")
            LET g_sfba_d[l_ac].sfba003_desc = g_chkparam.return1
            DISPLAY BY NAME g_sfba_d[l_ac].sfba003_desc

         #此段落由子樣板a04產生
         ON CHANGE sfba003
            #add-point:ON CHANGE sfba003
            
            #END add-point

         #----<<sfba004>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfba004
            #add-point:BEFORE FIELD sfba004
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba004
            IF NOT cl_null(g_sfba_d[g_detail_idx].sfba004) THEN
               IF cl_null(g_sfba_d_t.sfba004) OR g_sfba_d[g_detail_idx].sfba004 != g_sfba_d_t.sfba004 THEN
                  IF NOT asft300_sfbaseq(l_cmd) THEN
                     LET g_sfba_d[g_detail_idx].sfba004 = g_sfba_d_t.sfba004
                     NEXT FIELD sfba004
                  END IF
                  #160908-00025#1-s-add
                  IF NOT asft300_sfbaseq_2(l_cmd) THEN
                     LET g_sfba_d[g_detail_idx].sfba004 = g_sfba_d_t.sfba004
                     NEXT FIELD sfba004
                  END IF
                  #160908-00025#1-e-add
               END IF
            ELSE
               LET g_sfba_d[g_detail_idx].sfba004 = ' '
            END IF               

         #此段落由子樣板a04產生
         ON CHANGE sfba004
            #add-point:ON CHANGE sfba004
            
            #END add-point

         #----<<sfba005>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfba005
            #add-point:BEFORE FIELD sfba005
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba005

            #add-point:AFTER FIELD sfba005
            IF NOT cl_null(g_sfba_d[g_detail_idx].sfba005) THEN
               IF cl_null(g_sfba_d_t.sfba005) OR g_sfba_d[g_detail_idx].sfba005 != g_sfba_d_t.sfba005 THEN
                  #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_sfba_d[l_ac].sfba005
                  #呼叫檢查存在並帶值的library
                  IF cl_chk_exist("v_imaa001") THEN
                     IF NOT cl_chk_exist("v_imaf001_1") THEN
                        LET g_sfba_d[l_ac].sfba005 = g_sfba_d_t.sfba005
                        NEXT FIELD CURRENT
                     END IF
                  ELSE
                     LET g_sfba_d[l_ac].sfba005 = g_sfba_d_t.sfba005
                     NEXT FIELD CURRENT
                  END IF
                   
                  #160623-00009#1-add-(S)
                  IF NOT asft300_sfba005_chk(g_sfba_d[l_ac].sfba005) THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.extend = ""
                     LET g_errparam.code   = "ain-00530" #料件類別不可為'X虛擬品'！
                     LET g_errparam.popup  = TRUE
                     LET g_sfba_d[l_ac].sfba005 = g_sfba_d_t.sfba005
                     CALL cl_err()       
                     NEXT FIELD CURRENT
                  END IF
                  #160623-00009#1-add-(E)
                  
                  CALL s_aooi200_get_slip(g_sfaa_m.sfaadocno) RETURNING l_success,l_ooba002
                  LET l_flag = cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0024')
                  IF l_flag <> '2' THEN
                     #160512-00016#14 20160527 modify by ming -----(S) 
                     #CALL s_asft300_02_bom(0,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa013,1,1,g_sfaa_m.sfaa015,'Y',g_sfba_d[l_ac].sfba005,g_sfba_d[l_ac].sfba021,'')
                     #     RETURNING l_bmba
                     CALL s_asft300_02_bom(0,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa013,1,1,g_sfaa_m.sfaa015,'Y',g_sfba_d[l_ac].sfba005,g_sfba_d[l_ac].sfba021,'',g_sfba_d[l_ac].sfba033)
                          RETURNING l_bmba
                     #160512-00016#14 20160527 modify by ming -----(E) 
                    
                     IF g_sfaa_m.sfaa003 <> '2' THEN        #161124-00021#1 add
                        IF l_bmba.getLength() = 0 THEN
                           CASE l_flag
                              #单别对应参数设置为1时，不存在bom时报错重新输入
                              WHEN '1'
                                 INITIALIZE g_errparam TO NULL
                                 LET g_errparam.code = 'asf-00334'
                                 LET g_errparam.extend = g_sfba_d[l_ac].sfba005
                                 LET g_errparam.popup = TRUE
                                 CALL cl_err()
                                 LET g_sfba_d[l_ac].sfba005 = g_sfba_d_t.sfba005
                                 NEXT FIELD CURRENT
                              #单别对应参数设置为3时，不存在bom时警告
                              WHEN '3'
                                 INITIALIZE g_errparam TO NULL
                                 LET g_errparam.code = 'asf-00335'
                                 LET g_errparam.extend = g_sfba_d[l_ac].sfba005
                                 LET g_errparam.popup = TRUE
                                 CALL cl_err()
                           END CASE
                        END IF
                     END IF          #161124-00021#1 add
                  END IF
                  #170310-00015#1 add --(S)--
                  IF g_sfba_d[g_detail_idx].sfba002 IS NULL THEN LET g_sfba_d[g_detail_idx].sfba002 = ' ' END IF 
                  IF g_sfba_d[g_detail_idx].sfba003 IS NULL THEN LET g_sfba_d[g_detail_idx].sfba003 = ' ' END IF
                  IF g_sfba_d[g_detail_idx].sfba004 IS NULL THEN LET g_sfba_d[g_detail_idx].sfba004 = ' ' END IF                     
                  #170310-00015#1 add --(E)--
                  IF NOT asft300_sfbaseq(l_cmd) THEN
                     LET g_sfba_d[g_detail_idx].sfba005 = g_sfba_d_t.sfba005
                     NEXT FIELD sfba005
                  END IF
                  
                  #预带发料料号
                  #IF cl_null(g_sfba_d[l_ac].sfba006) THEN   #20151020 by stellar mark:工單單身的BOM料號如果修改，一併把發料料號也自動修改為和BOM料號一致
                     LET g_sfba_d[l_ac].sfba006 = g_sfba_d[l_ac].sfba005
                     CALL asft300_sfba006_desc()
                  #END IF   #20151020 by stellar mark
               END IF
            END IF
            #161205-00018#1 add--------s-------               
            CALL asft300_set_entry_b(l_cmd)
            CALL asft300_set_no_entry_b(l_cmd)
            #161205-00018#1 add---------e------
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_sfba_d[g_detail_idx].sfba005
            CALL ap_ref_array2(g_ref_fields,"SELECT imaal003,imaal004 FROM imaal_t WHERE imaalent='"||g_enterprise||"' AND imaal001=? AND imaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_sfba_d[g_detail_idx].sfba005_desc = '', g_rtn_fields[1] , ''
            LET g_sfba_d[g_detail_idx].sfba005_desc1 = '', g_rtn_fields[2] , ''
            DISPLAY BY NAME g_sfba_d[g_detail_idx].sfba005_desc
            DISPLAY BY NAME g_sfba_d[g_detail_idx].sfba005_desc1           
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE sfba005
            #add-point:ON CHANGE sfba005
            
            #END add-point

         #----<<replace>>----
         #此段落由子樣板a01產生
         BEFORE FIELD replace
            #add-point:BEFORE FIELD replace
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD replace

            #add-point:AFTER FIELD replace
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE replace
            #add-point:ON CHANGE replace
            
            #END add-point

         #----<<sfba022>>----
         #此段落由子樣板a02產生
         AFTER FIELD sfba022
            #此段落由子樣板a15產生
            IF NOT cl_ap_chk_Range(g_sfba_d[l_ac].sfba022,"0","0","","","azz-00087",1) THEN
               LET g_sfba_d[l_ac].sfba006 = g_sfba_d_t.sfba006
               NEXT FIELD sfba022
            END IF


            #add-point:AFTER FIELD sfba022
            IF NOT cl_null(g_sfba_d[l_ac].sfba022) THEN
            END IF
          {#ADP版次:1#}
            #END add-point


         #此段落由子樣板a01產生
         BEFORE FIELD sfba022
            #add-point:BEFORE FIELD sfba022
            
            #END add-point

         #此段落由子樣板a04產生
         ON CHANGE sfba022
            #add-point:ON CHANGE sfba022
            
            #END add-point

         #----<<sfba006>>----
         #此段落由子樣板a02產生
         AFTER FIELD sfba006

            #add-point:AFTER FIELD sfba006
            IF NOT cl_null(g_sfba_d[l_ac].sfba006) AND (cl_null(g_sfba_d_t.sfba006) OR g_sfba_d[l_ac].sfba006 != g_sfba_d_t.sfba006) THEN
               #設定g_chkparam.*的參數前，先將其初始化，避免之前設定遺留的參數值造成影響。
               INITIALIZE g_chkparam.* TO NULL
               LET g_chkparam.arg1 = g_sfba_d[l_ac].sfba006
#160708-00013#1-s mark
#v_imaa001中沒有抓取bmea_t,加上底下這個WHERE條件後SQL會報錯,先將這個條件mark掉
#               LET g_chkparam.where = " bmea008 IN (SELECT imaa001 FROM imaa_t ",
#                                      "              WHERE imaaent = '",g_enterprise,"'",
#                                      "                AND imaa004 <> 'X') "
#160708-00013#1-e mark
               #呼叫檢查存在並帶值的library
               IF cl_chk_exist("v_imaa001") THEN
                  IF NOT cl_chk_exist("v_imaf001_1") THEN
                     LET g_sfba_d[l_ac].sfba006 = g_sfba_d_t.sfba006
                     NEXT FIELD CURRENT
                  END IF
               ELSE
                  LET g_sfba_d[l_ac].sfba006 = g_sfba_d_t.sfba006
                  NEXT FIELD CURRENT
               END IF
               
               #160623-00009#1-add-(S)
               IF NOT asft300_sfba005_chk(g_sfba_d[l_ac].sfba006) THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.extend = ""
                  LET g_errparam.code   = "ain-00530" #料件類別不可為'X虛擬品'！
                  LET g_errparam.popup  = TRUE
                  LET g_sfba_d[l_ac].sfba006 = g_sfba_d_t.sfba006
                  CALL cl_err()  
                  NEXT FIELD CURRENT
               END IF
               #160623-00009#1-add-(E)
               
               CALL s_aooi200_get_slip(g_sfaa_m.sfaadocno) RETURNING l_success,l_ooba002
               LET l_flag = cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0024')
               IF l_flag <> '2' THEN 
                  #160512-00016#14 20160527 modify by ming -----(S) 
                  #CALL s_asft300_02_bom(0,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa013,1,1,g_sfaa_m.sfaa015,'Y',g_sfba_d[l_ac].sfba006,g_sfba_d[l_ac].sfba021,'')
                  #     RETURNING l_bmba
                  CALL s_asft300_02_bom(0,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa013,1,1,g_sfaa_m.sfaa015,'Y',g_sfba_d[l_ac].sfba006,g_sfba_d[l_ac].sfba021,'',g_sfba_d[l_ac].sfba033)
                       RETURNING l_bmba
                  #160512-00016#14 20160527 modify by ming -----(E) 
                  IF g_sfaa_m.sfaa003 <> '2' THEN        #161124-00021#1 add
                     IF l_bmba.getLength() = 0 THEN
                        CASE l_flag
                           #单别对应参数设置为1时，不存在bom时报错重新输入
                           WHEN '1'
                              INITIALIZE g_errparam TO NULL
                              LET g_errparam.code = 'asf-00334'
                              LET g_errparam.extend = g_sfba_d[l_ac].sfba006
                              LET g_errparam.popup = TRUE
                              CALL cl_err()
                              LET g_sfba_d[l_ac].sfba006 = g_sfba_d_t.sfba006
                              NEXT FIELD CURRENT
                           #单别对应参数设置为3时，不存在bom时警告
                           WHEN '3'
                              INITIALIZE g_errparam TO NULL
                              LET g_errparam.code = 'asf-00335'
                              LET g_errparam.extend = g_sfba_d[l_ac].sfba006
                              LET g_errparam.popup = TRUE
                              CALL cl_err()
                         END CASE
                     END IF
                  END IF        #161124-00021#1 add
               END IF 
               
               #160908-00025#1-s-add
               IF NOT asft300_sfbaseq_2(l_cmd) THEN
                  LET g_sfba_d[g_detail_idx].sfba006 = g_sfba_d_t.sfba006
                  NEXT FIELD sfba006
               END IF
               #160908-00025#1-e-add
               
               CALL asft300_sfba006_desc()
               #建议应发数量
               CALL s_asft300_03(g_sfba_d[l_ac].sfba006,g_sfba_d[l_ac].sfba013) RETURNING l_success,l_sfba013
               IF l_success THEN
                  LET g_sfba_d[l_ac].sfba013=l_sfba013
               ELSE
                  LET g_sfba_d[l_ac].sfba013=g_sfba_d_t.sfba013
               END IF               
               LET g_sfba_d[l_ac].sfba024 = g_sfba_d[l_ac].sfba013 - g_sfba_d[l_ac].sfba023
               
               #发料料号做特征管理
               CALL asft300_set_entry_b(l_cmd)
               CALL asft300_set_no_entry_b(l_cmd)
               SELECT imaa005 INTO l_imaa005 FROM imaa_t WHERE imaaent = g_enterprise AND imaa001 = g_sfba_d[l_ac].sfba006
               IF NOT cl_null(l_imaa005) THEN
                  IF s_feature_auto_chk(g_sfba_d[l_ac].sfba006) THEN #160314-00009#16 add
                     IF l_cmd = 'a' THEN 
                        CALL l_inam.clear()          
                        CALL s_feature_multi(g_sfba_d[l_ac].sfba006,'','',g_site,g_sfaa_m.sfaadocno) RETURNING l_success,l_inam
                        LET g_sfba_d[l_ac].sfba021 = l_inam[1].inam002
                        LET g_sfba_d[l_ac].sfba023 = l_inam[1].inam004
                        LET g_sfba_d[l_ac].sfba013 = g_sfba_d[l_ac].sfba023 + g_sfba_d[l_ac].sfba024
                        #重算QPA分子分母
                        CALL asft300_sfba023_qpa(g_sfba_d[l_ac].sfba023) RETURNING g_sfba_d[l_ac].sfba010,g_sfba_d[l_ac].sfba011
                        #建议应发数量
                        CALL s_asft300_03(g_sfba_d[l_ac].sfba006,g_sfba_d[l_ac].sfba013) RETURNING l_success,l_sfba013
                        IF l_success THEN
                           LET g_sfba_d[l_ac].sfba013=l_sfba013
                        END IF               
                        LET g_sfba_d[l_ac].sfba024 = g_sfba_d[l_ac].sfba013 - g_sfba_d[l_ac].sfba023                    
                     END IF
                  END IF #160314-00009#16  add
               END IF
               
               #检查产品特征
               IF NOT cl_null(g_sfba_d[l_ac].sfba021) THEN            
                  IF NOT s_feature_check(g_sfba_d[l_ac].sfba006,g_sfba_d[l_ac].sfba021) THEN
                     NEXT FIELD sfba021
                  END IF
                  #显示产品特征说明
                  CALL s_feature_description(g_sfba_d[l_ac].sfba006,g_sfba_d[l_ac].sfba021)
                     RETURNING l_success,g_sfba_d[l_ac].sfba021_desc
                  IF NOT l_success THEN
                     LET g_sfba_d[l_ac].sfba021_desc = ''
                  END IF
               ELSE
                  LET g_sfba_d[l_ac].sfba021_desc = ''
               END IF
               DISPLAY BY NAME g_sfba_d[l_ac].sfba021_desc
            END IF
          {#ADP版次:1#}
            #END add-point


         #此段落由子樣板a01產生
         BEFORE FIELD sfba006
            #add-point:BEFORE FIELD sfba006
            
            #END add-point

         #此段落由子樣板a04產生
         ON CHANGE sfba006
            #add-point:ON CHANGE sfba006
            
            #END add-point

         #----<<imaf013>>----
         #此段落由子樣板a01產生
         BEFORE FIELD imaf013
            #add-point:BEFORE FIELD imaf013
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD imaf013

            #add-point:AFTER FIELD imaf013
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE imaf013
            #add-point:ON CHANGE imaf013
            
            #END add-point

         #----<<sfba021>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfba021
            #add-point:BEFORE FIELD sfba021
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba021

            #add-point:AFTER FIELD sfba021
            IF NOT cl_null(g_sfba_d[l_ac].sfba006) AND NOT cl_null(g_sfba_d[l_ac].sfba021) THEN
               #检查产品特征
               #161209-00038#3-s
               #IF NOT s_feature_check(g_sfba_d[l_ac].sfba006,g_sfba_d[l_ac].sfba021) THEN
               IF NOT asft300_sfba021_chk() THEN
               #161209-00038#3-e
                  LET g_sfba_d[l_ac].sfba021 = g_sfba_d_t.sfba021
                  NEXT FIELD sfba021
               END IF
               #--151224-00025#4 add start--
               IF NOT s_feature_direct_input(g_sfba_d[l_ac].sfba006,g_sfba_d[l_ac].sfba021,g_sfba_d_t.sfba021,g_sfaa_m.sfaadocno,g_site) THEN
                  NEXT FIELD CURRENT
               END IF
               #--151224-00025#4 add end--
               #显示产品特征说明
               CALL s_feature_description(g_sfba_d[l_ac].sfba006,g_sfba_d[l_ac].sfba021)
                  RETURNING l_success,g_sfba_d[l_ac].sfba021_desc
               IF NOT l_success THEN
                  LET g_sfba_d[l_ac].sfba021_desc = ''
               END IF
            ELSE 
               LET g_sfba_d[l_ac].sfba021_desc = ''
            END IF

            DISPLAY BY NAME g_sfba_d[l_ac].sfba021_desc
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE sfba021
            #add-point:ON CHANGE sfba021
            
            #END add-point

         #----<<sfba007>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfba007
            #add-point:BEFORE FIELD sfba007
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba007

            #add-point:AFTER FIELD sfba007
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE sfba007
            #add-point:ON CHANGE sfba007
            
            #END add-point

         #----<<sfba008>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfba008
            #add-point:BEFORE FIELD sfba008
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba008

            #add-point:AFTER FIELD sfba008
            #161213-00010#1 add--------s------
            CALL asft300_set_entry_b(p_cmd)
            CALL asft300_set_no_entry_b(p_cmd)
            #161213-00010#1 add--------e------
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE sfba008
            #add-point:ON CHANGE sfba008
            
            #END add-point

         #----<<sfba009>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfba009
            #add-point:BEFORE FIELD sfba009
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba009

            #add-point:AFTER FIELD sfba009
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE sfba009
            #add-point:ON CHANGE sfba009
            
            #END add-point

         #----<<sfba010>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfba010
            #add-point:BEFORE FIELD sfba010
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba010

            #add-point:AFTER FIELD sfba010
            IF NOT cl_ap_chk_Range(g_sfba_d[l_ac].sfba010,"0","0","","","azz-00079",1) THEN
               LET g_sfba_d[l_ac].sfba010 = g_sfba_d_t.sfba010
               NEXT FIELD sfba010
            END IF
            IF NOT cl_null(g_sfba_d[l_ac].sfba010) AND NOT cl_null(g_sfba_d[l_ac].sfba011) THEN
               LET g_sfba_d[l_ac].sfba023 = g_sfaa_m.sfaa012 * g_sfba_d[l_ac].sfba010 / g_sfba_d[l_ac].sfba011
               LET g_sfba_d[l_ac].sfba013 = g_sfba_d[l_ac].sfba023 + g_sfba_d[l_ac].sfba024
               IF NOT cl_null(g_sfba_d[l_ac].sfba006) THEN
                  #建议应发数量
                  CALL s_asft300_03(g_sfba_d[l_ac].sfba006,g_sfba_d[l_ac].sfba013) RETURNING l_success,l_sfba013
                  IF l_success THEN
                     LET g_sfba_d[l_ac].sfba013=l_sfba013
                  ELSE
                     LET g_sfba_d[l_ac].sfba013=g_sfba_d_t.sfba013
                  END IF               
                  LET g_sfba_d[l_ac].sfba024 = g_sfba_d[l_ac].sfba013 - g_sfba_d[l_ac].sfba023
               END IF
            END IF               
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE sfba010
            #add-point:ON CHANGE sfba010
            
            #END add-point

         #----<<sfba011>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfba011
            #add-point:BEFORE FIELD sfba011
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba011

            #add-point:AFTER FIELD sfba011
            IF NOT cl_ap_chk_Range(g_sfba_d[l_ac].sfba011,"0","0","","","azz-00079",1) THEN
               LET g_sfba_d[l_ac].sfba011 = g_sfba_d_t.sfba011
               NEXT FIELD sfba011
            END IF
            IF NOT cl_null(g_sfba_d[l_ac].sfba010) AND NOT cl_null(g_sfba_d[l_ac].sfba011) THEN
               LET g_sfba_d[l_ac].sfba023 = g_sfaa_m.sfaa012 * g_sfba_d[l_ac].sfba010 / g_sfba_d[l_ac].sfba011
               LET g_sfba_d[l_ac].sfba013 = g_sfba_d[l_ac].sfba023 + g_sfba_d[l_ac].sfba024
               IF NOT cl_null(g_sfba_d[l_ac].sfba006) THEN
                  #建议应发数量
                  CALL s_asft300_03(g_sfba_d[l_ac].sfba006,g_sfba_d[l_ac].sfba013) RETURNING l_success,l_sfba013
                  IF l_success THEN
                     LET g_sfba_d[l_ac].sfba013=l_sfba013
                  ELSE
                     LET g_sfba_d[l_ac].sfba013=g_sfba_d_t.sfba013
                  END IF               
                  LET g_sfba_d[l_ac].sfba024 = g_sfba_d[l_ac].sfba013 - g_sfba_d[l_ac].sfba023
               END IF
            END IF
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE sfba011
            #add-point:ON CHANGE sfba011
            
            #END add-point

         #----<<sfba012>>----
         #此段落由子樣板a02產生
         AFTER FIELD sfba012
            #此段落由子樣板a15產生
            IF NOT cl_ap_chk_Range(g_sfba_d[l_ac].sfba012,"0","1","","","azz-00079",1) THEN
               LET g_sfba_d[l_ac].sfba012 = g_sfba_d_t.sfba012
               NEXT FIELD sfba012
            END IF


            #add-point:AFTER FIELD sfba012
            IF NOT cl_null(g_sfba_d[l_ac].sfba012) THEN
            END IF
          {#ADP版次:1#}
            #END add-point


         #此段落由子樣板a01產生
         BEFORE FIELD sfba012
            #add-point:BEFORE FIELD sfba012
            
            #END add-point

         #此段落由子樣板a04產生
         ON CHANGE sfba012
            #add-point:ON CHANGE sfba012
            
            #END add-point

         #----<<sfba023>>----
         #此段落由子樣板a02產生
         AFTER FIELD sfba023
            #此段落由子樣板a15產生
            IF NOT cl_ap_chk_Range(g_sfba_d[l_ac].sfba023,"0","1","","","azz-00079",1) THEN
               LET g_sfba_d[l_ac].sfba023 = g_sfba_d_t.sfba023
               NEXT FIELD sfba023
            END IF


            #add-point:AFTER FIELD sfba023
            IF NOT cl_null(g_sfba_d[l_ac].sfba023) AND (g_sfba_d[l_ac].sfba023 != g_sfba_d_t.sfba023 OR cl_null(g_sfba_d_t.sfba023)) THEN
               #单位取位
               IF NOT cl_null(g_sfba_d[l_ac].sfba014) THEN
                  CALL s_aooi250_take_decimals(g_sfba_d[l_ac].sfba014,g_sfba_d[l_ac].sfba023)
                       RETURNING l_success,g_sfba_d[l_ac].sfba023
               END IF
                    
               LET g_sfba_d[l_ac].sfba013 = g_sfba_d[l_ac].sfba023 + g_sfba_d[l_ac].sfba024
               
               #依发料料号发料控管方式控制
               LET l_sfba013 = g_sfba_d[l_ac].sfba013
               SELECT imae082,imae083,imae084 INTO l_imae082,l_imae083,l_imae084 FROM imae_t
                WHERE imaeent = g_enterprise AND imaesite = g_site AND imae001 = g_sfba_d[l_ac].sfba006
               IF NOT cl_null(l_imae083) THEN
                  IF g_sfba_d[l_ac].sfba013 < l_imae083 THEN
                     LET l_sfba013 = l_imae083
                  ELSE
                     LET l_sfba013 = g_sfba_d[l_ac].sfba013
                  END IF
               ELSE
                  LET l_sfba013 = g_sfba_d[l_ac].sfba013
               END IF
               
               IF NOT cl_null(l_imae082) AND l_imae082 != 0 THEN
                  LET l_n_sfba013 = l_sfba013 / l_imae082
                  IF l_sfba013  != l_imae082 * l_n_sfba013 THEN
                     IF l_sfba013 > l_imae082 * l_n_sfba013 THEN
                        LET l_sfba013 = l_imae082 * (l_n_sfba013 + 1)
                     ELSE
                        LET l_sfba013 = l_imae082 * l_n_sfba013
                     END IF
                  END IF
               END IF
               
               IF l_sfba013 != g_sfba_d[l_ac].sfba013 AND NOT cl_null(l_imae084) AND l_imae084 != '3' THEN
                  IF l_imae084 = '1' THEN
                     LET l_msg = cl_getmsg('asf-00465',g_lang),l_sfba013 USING '---,---,---,--&.&&&'
                     IF cl_ask_promp(l_msg) THEN
                        LET g_sfba_d[l_ac].sfba013 = l_sfba013
                        LET g_sfba_d[l_ac].sfba024 = g_sfba_d[l_ac].sfba013 - g_sfba_d[l_ac].sfba023
                     END IF
                  END IF
                  IF l_imae084 = '2' THEN
                     LET l_msg = cl_getmsg('asf-00466',g_lang),l_sfba013 USING '---,---,---,--&.&&&'
                     IF cl_ask_promp(l_msg) THEN
                        LET g_sfba_d[l_ac].sfba013 = l_sfba013
                        LET g_sfba_d[l_ac].sfba024 = g_sfba_d[l_ac].sfba013 - g_sfba_d[l_ac].sfba023
                     ELSE
                        LET g_sfba_d[l_ac].sfba023 = g_sfba_d_t.sfba023
                        LET g_sfba_d[l_ac].sfba013 = g_sfba_d[l_ac].sfba023 + g_sfba_d[l_ac].sfba024
                        NEXT FIELD sfaa023
                     END IF
                  END IF
               END IF
               
               #重算QPA分子分母
               CALL asft300_sfba023_qpa(g_sfba_d[l_ac].sfba023) RETURNING g_sfba_d[l_ac].sfba010,g_sfba_d[l_ac].sfba011
            END IF
          {#ADP版次:1#}
            #END add-point


         #此段落由子樣板a01產生
         BEFORE FIELD sfba023
            #add-point:BEFORE FIELD sfba023
            
            #END add-point

         #此段落由子樣板a04產生
         ON CHANGE sfba023
            #add-point:ON CHANGE sfba023
            
            #END add-point

         #----<<sfba024>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfba024
            #add-point:BEFORE FIELD sfba024
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba024

            #add-point:AFTER FIELD sfba024
            IF NOT cl_ap_chk_Range(g_sfba_d[l_ac].sfba024,"0","1","","","azz-00079",1) THEN
               LET g_sfba_d[l_ac].sfba024 = g_sfba_d_o.sfba024      #170202-00008#1 modi g_sfba_d_t.sfba024 -> g_sfba_d_o.sfba024
               NEXT FIELD sfba024
            END IF
            
            IF NOT cl_null(g_sfba_d[l_ac].sfba024) AND (g_sfba_d[l_ac].sfba024 != g_sfba_d_o.sfba024 OR cl_null(g_sfba_d_o.sfba024)) THEN   #170202-00008#1 modi g_sfba_d_t.sfba024 -> g_sfba_d_o.sfba024
               #单位取位
               IF NOT cl_null(g_sfba_d[l_ac].sfba014) THEN
                  CALL s_aooi250_take_decimals(g_sfba_d[l_ac].sfba014,g_sfba_d[l_ac].sfba024)
                       RETURNING l_success,g_sfba_d[l_ac].sfba024
               END IF
               
               LET g_sfba_d[l_ac].sfba013 = g_sfba_d[l_ac].sfba023 + g_sfba_d[l_ac].sfba024
               #依发料料号发料控管方式控制
               LET l_sfba013 = g_sfba_d[l_ac].sfba013
               SELECT imae082,imae083,imae084 INTO l_imae082,l_imae083,l_imae084 FROM imae_t
                WHERE imaeent = g_enterprise AND imaesite = g_site AND imae001 = g_sfba_d[l_ac].sfba006
               IF NOT cl_null(l_imae083) THEN
                  IF g_sfba_d[l_ac].sfba013 < l_imae083 THEN
                     LET l_sfba013 = l_imae083
                  ELSE
                     LET l_sfba013 = g_sfba_d[l_ac].sfba013
                  END IF
               ELSE
                  LET l_sfba013 = g_sfba_d[l_ac].sfba013
               END IF
               
               IF NOT cl_null(l_imae082) AND l_imae082 != 0 THEN
                  LET l_n_sfba013 = l_sfba013 / l_imae082
                  IF l_sfba013  != l_imae082 * l_n_sfba013 THEN
                     IF l_sfba013 > l_imae082 * l_n_sfba013 THEN
                        LET l_sfba013 = l_imae082 * (l_n_sfba013 + 1)
                     ELSE
                        LET l_sfba013 = l_imae082 * l_n_sfba013
                     END IF
                  END IF
               END IF
               
               IF l_sfba013 != g_sfba_d[l_ac].sfba013 AND NOT cl_null(l_imae084) AND l_imae084 != '3' THEN
                  IF l_imae084 = '1' THEN
                     LET l_msg = cl_getmsg('asf-00465',g_lang),l_sfba013 USING '---,---,---,--&.&&&'
                     IF cl_ask_promp(l_msg) THEN
                        LET g_sfba_d[l_ac].sfba013 = l_sfba013
                        LET g_sfba_d[l_ac].sfba024 = g_sfba_d[l_ac].sfba013 - g_sfba_d[l_ac].sfba023
                     END IF
                  END IF
                  IF l_imae084 = '2' THEN
                     LET l_msg = cl_getmsg('asf-00466',g_lang),l_sfba013 USING '---,---,---,--&.&&&'
                     IF cl_ask_promp(l_msg) THEN
                        LET g_sfba_d[l_ac].sfba013 = l_sfba013
                        LET g_sfba_d[l_ac].sfba024 = g_sfba_d[l_ac].sfba013 - g_sfba_d[l_ac].sfba023
                     ELSE
                        LET g_sfba_d[l_ac].sfba024 = g_sfba_d_o.sfba024    #170202-00008#1 modi g_sfba_d_t.sfba024 -> g_sfba_d_o.sfba024
                        LET g_sfba_d[l_ac].sfba013 = g_sfba_d[l_ac].sfba023 + g_sfba_d[l_ac].sfba024
                        NEXT FIELD sfaa024
                     END IF
                  END IF
               END IF
            END IF
            
            LET g_sfba_d_o.sfba024 = g_sfba_d[l_ac].sfba024   #170202-00008#1  add
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE sfba024
            #add-point:ON CHANGE sfba024
            
            #END add-point

         #----<<sfba013>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfba013
            #add-point:BEFORE FIELD sfba013
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba013

            #add-point:AFTER FIELD sfba013
            
            IF cl_null(g_sfba_d[l_ac].sfba013) THEN 
               LET g_sfba_d[l_ac].sfba013 = 0
            END IF
            IF cl_null(g_sfba_d[l_ac].sfba015) THEN 
               LET g_sfba_d[l_ac].sfba015 = 0
            END IF
            IF cl_null(g_sfba_d[l_ac].sfba016) THEN 
               LET g_sfba_d[l_ac].sfba016 = 0
            END IF 
            IF NOT cl_null(g_sfba_d[l_ac].sfba013) THEN
               #单位取位
               IF NOT cl_null(g_sfba_d[l_ac].sfba014) THEN
                  CALL s_aooi250_take_decimals(g_sfba_d[l_ac].sfba014,g_sfba_d[l_ac].sfba013)
                       RETURNING l_success,g_sfba_d[l_ac].sfba013
               END IF
               
               IF NOT cl_null(g_sfba_d[l_ac].sfba015) THEN 
                  IF g_sfba_d[l_ac].sfba015 > g_sfba_d[l_ac].sfba013 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'asf-00087'
                     LET g_errparam.extend = g_sfba_d[l_ac].sfba013
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     NEXT FIELD sfba013
                  END IF
               END IF                  
            END IF
            LET g_sfba_d[l_ac].number1 = g_sfba_d[l_ac].sfba013 - g_sfba_d[l_ac].sfba015 - g_sfba_d[l_ac].sfba016
            IF g_sfba_d[l_ac].number1 < 0 THEN
               LET g_sfba_d[l_ac].number1 = 0
            END IF
                       
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE sfba013
            #add-point:ON CHANGE sfba013
            
            #END add-point

         #----<<sfba014>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfba014
            #add-point:BEFORE FIELD sfba014
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba014

            #add-point:AFTER FIELD sfba014
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_sfba_d[l_ac].sfba014
            CALL ap_ref_array2(g_ref_fields,"SELECT oocal003 FROM oocal_t WHERE oocalent='"||g_enterprise||"' AND oocal001=? AND oocal002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_sfba_d[l_ac].sfba014_desc = '', g_rtn_fields[1] , ''
            DISPLAY BY NAME g_sfba_d[l_ac].sfba014_desc
            IF NOT cl_null(g_sfba_d[l_ac].sfba014) THEN
               INITIALIZE g_chkparam.* TO NULL
               LET g_chkparam.arg1 = g_sfba_d[l_ac].sfba014
               #160318-00025#4--add--str
               LET g_errshow = TRUE 
               LET g_chkparam.err_str[1] = "aim-00005:sub-01302|aooi250|",cl_get_progname("aooi250",g_lang,"2"),"|:EXEPROGaooi250"
               #160318-00025#4--add--end
               IF NOT cl_chk_exist("v_ooca001") THEN
                  LET g_sfba_d[l_ac].sfba014 = g_sfba_d_t.sfba014
                  INITIALIZE g_ref_fields TO NULL
                  LET g_ref_fields[1] = g_sfba_d[l_ac].sfba014
                  CALL ap_ref_array2(g_ref_fields,"SELECT oocal003 FROM oocal_t WHERE oocalent='"||g_enterprise||"' AND oocal001=? AND oocal002='"||g_dlang||"'","") RETURNING g_rtn_fields
                  LET g_sfba_d[l_ac].sfba014_desc = '', g_rtn_fields[1] , ''
                  DISPLAY BY NAME g_sfba_d[l_ac].sfba014_desc
                  NEXT FIELD sfba014
               END IF
               LET l_rate = ''
               LET l_imaa006 = ''
               IF NOT cl_null(g_sfba_d[l_ac].sfba006) THEN 
                  SELECT imaa006 INTO l_imaa006 FROM imaa_t
                   WHERE imaaent = g_enterprise
                     AND imaa001 = g_sfba_d[l_ac].sfba006  
                  IF NOT cl_null(g_sfba_d[l_ac].sfba006) AND NOT cl_null(l_imaa006) THEN
                     CALL s_aimi190_get_convert(g_sfba_d[l_ac].sfba006,g_sfba_d[l_ac].sfba014,l_imaa006) RETURNING l_success,l_rate
                     IF l_success = FALSE THEN
                        LET g_sfba_d[l_ac].sfba014 = g_sfba_d_t.sfba014
                        INITIALIZE g_ref_fields TO NULL
                        LET g_ref_fields[1] = g_sfba_d[l_ac].sfba014
                        CALL ap_ref_array2(g_ref_fields,"SELECT oocal003 FROM oocal_t WHERE oocalent='"||g_enterprise||"' AND oocal001=? AND oocal002='"||g_dlang||"'","") RETURNING g_rtn_fields
                        LET g_sfba_d[l_ac].sfba014_desc = '', g_rtn_fields[1] , ''
                        DISPLAY BY NAME g_sfba_d[l_ac].sfba014_desc 
                        NEXT FIELD sfba014                        
                     END IF
                  END IF 
                  IF cl_null(l_imaa006) THEN
                     INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'abm-00021'
                  LET g_errparam.extend = l_imaa006
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                     LET g_sfba_d[l_ac].sfba014 = g_sfba_d_t.sfba014
                     INITIALIZE g_ref_fields TO NULL
                     LET g_ref_fields[1] = g_sfba_d[l_ac].sfba014
                     CALL ap_ref_array2(g_ref_fields,"SELECT oocal003 FROM oocal_t WHERE oocalent='"||g_enterprise||"' AND oocal001=? AND oocal002='"||g_dlang||"'","") RETURNING g_rtn_fields
                     LET g_sfba_d[l_ac].sfba014_desc = '', g_rtn_fields[1] , ''
                     DISPLAY BY NAME g_sfba_d[l_ac].sfba014_desc 
                     NEXT FIELD sfba014 
                  END IF
                  #检查是否存在于料件允许使用单位里。
                  INITIALIZE g_chkparam.* TO NULL
                  LET g_chkparam.arg1 = g_sfba_d[l_ac].sfba006
                  LET g_chkparam.arg2 = g_sfba_d[l_ac].sfba014
                 
                  #呼叫檢查存在並帶值的library
                  IF NOT cl_chk_exist("v_imao002") THEN
                     INITIALIZE g_ref_fields TO NULL
                     LET g_ref_fields[1] = g_sfba_d[l_ac].sfba014
                     CALL ap_ref_array2(g_ref_fields,"SELECT oocal003 FROM oocal_t WHERE oocalent='"||g_enterprise||"' AND oocal001=? AND oocal002='"||g_dlang||"'","") RETURNING g_rtn_fields
                     LET g_sfba_d[l_ac].sfba014_desc = '', g_rtn_fields[1] , ''
                     NEXT FIELD sfba014 
                  END IF
               END IF                 
            END IF
            
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE sfba014
            #add-point:ON CHANGE sfba014
            
            #END add-point

         #----<<sfba015>>----
         #此段落由子樣板a02產生
         AFTER FIELD sfba015
            #此段落由子樣板a15產生
            IF NOT cl_ap_chk_Range(g_sfba_d[l_ac].sfba015,"0","1","","","azz-00079",1) THEN
               LET g_sfba_d[l_ac].sfba015 = g_sfba_d_t.sfba015
               NEXT FIELD sfba015
            END IF


            #add-point:AFTER FIELD sfba015
            IF cl_null(g_sfba_d[l_ac].sfba015) THEN 
               LET g_sfba_d[l_ac].sfba015 = 0
            END IF
            IF NOT cl_null(g_sfba_d[l_ac].sfba015) THEN
               IF NOT cl_null(g_sfba_d[l_ac].sfba013) THEN 
                  IF g_sfba_d[l_ac].sfba015 > g_sfba_d[l_ac].sfba013 THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'asf-00087'
                     LET g_errparam.extend = g_sfba_d[l_ac].sfba015
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET g_sfba_d[l_ac].sfba015 = g_sfba_d_t.sfba015
                     NEXT FIELD sfba015
                  END IF
               END IF                  
            END IF
            LET g_sfba_d[l_ac].number1 = g_sfba_d[l_ac].sfba013 - g_sfba_d[l_ac].sfba015 - g_sfba_d[l_ac].sfba016
            IF g_sfba_d[l_ac].number1 < 0 THEN
               LET g_sfba_d[l_ac].number1 = 0
            END IF
          {#ADP版次:1#}
            #END add-point


         #此段落由子樣板a01產生
         BEFORE FIELD sfba015
            #add-point:BEFORE FIELD sfba015
            
            #END add-point

         #此段落由子樣板a04產生
         ON CHANGE sfba015
            #add-point:ON CHANGE sfba015
            
            #END add-point

         #----<<sfba016>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfba016
            #add-point:BEFORE FIELD sfba016
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba016

            #add-point:AFTER FIELD sfba016
            #cj
            IF cl_null(g_sfba_d[l_ac].sfba013) THEN 
               LET g_sfba_d[l_ac].sfba013 = 0
            END IF
            IF cl_null(g_sfba_d[l_ac].sfba016) THEN 
               LET g_sfba_d[l_ac].sfba016 = 0
            END IF 
            LET g_sfba_d[l_ac].number1 = g_sfba_d[l_ac].sfba013 - g_sfba_d[l_ac].sfba016
            IF g_sfba_d[l_ac].number1 < 0 THEN
               LET g_sfba_d[l_ac].number1 = 0
            END IF
            #cj            
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE sfba016
            #add-point:ON CHANGE sfba016
            
            #END add-point

         #----<<sfba025>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfba025
            #add-point:BEFORE FIELD sfba025
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba025

            #add-point:AFTER FIELD sfba025
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE sfba025
            #add-point:ON CHANGE sfba025
            
            #END add-point

         #----<<number1>>----
         #此段落由子樣板a01產生
         BEFORE FIELD number1
            #add-point:BEFORE FIELD number1
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD number1

            #add-point:AFTER FIELD number1
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE number1
            #add-point:ON CHANGE number1
            
            #END add-point

         #----<<number2>>----
         #此段落由子樣板a01產生
         BEFORE FIELD number2
            #add-point:BEFORE FIELD number2
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD number2

            #add-point:AFTER FIELD number2
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE number2
            #add-point:ON CHANGE number2
            
            #END add-point

         #----<<sfba017>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfba017
            #add-point:BEFORE FIELD sfba017
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba017

            #add-point:AFTER FIELD sfba017
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE sfba017
            #add-point:ON CHANGE sfba017
            
            #END add-point

         #----<<sfba018>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfba018
            #add-point:BEFORE FIELD sfba018
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba018

            #add-point:AFTER FIELD sfba018
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE sfba018
            #add-point:ON CHANGE sfba018
            
            #END add-point

         #----<<sfba019>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfba019
            #add-point:BEFORE FIELD sfba019
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba019

            #add-point:AFTER FIELD sfba019
             #cj
             IF NOT cl_null(g_sfba_d[l_ac].sfba019) THEN
                INITIALIZE g_chkparam.* TO NULL
                LET g_chkparam.arg1 = g_sfba_d[l_ac].sfba019
                #160318-00025#4--add--str
                LET g_errshow = TRUE 
                LET g_chkparam.err_str[1] = "aim-00065:sub-01302|aini001|",cl_get_progname("aini001",g_lang,"2"),"|:EXEPROGaini001"
                #160318-00025#4--add--end
                IF NOT cl_chk_exist("v_inaa001_2") THEN
                   LET g_sfba_d[l_ac].sfba019 = g_sfba_d_t.sfba019
                   LET g_sfba_d[l_ac].sfba019_desc = s_desc_get_stock_desc(g_site,g_sfba_d[l_ac].sfba019)
                   NEXT FIELD sfba019
                END IF 
             END IF                
             LET g_sfba_d[l_ac].sfba019_desc = s_desc_get_stock_desc(g_site,g_sfba_d[l_ac].sfba019)
             DISPLAY BY NAME g_sfba_d[l_ac].sfba019_desc 
             #cj             
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE sfba019
            #add-point:ON CHANGE sfba019
            
            #END add-point

         #----<<sfba020>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfba020
            #add-point:BEFORE FIELD sfba020
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba020

            #add-point:AFTER FIELD sfba020
             #cj
             IF NOT cl_null(g_sfba_d[l_ac].sfba020) THEN
                INITIALIZE g_chkparam.* TO NULL
                LET g_chkparam.arg1 = g_site
                LET g_chkparam.arg2 = g_sfba_d[l_ac].sfba019
                LET g_chkparam.arg3 = g_sfba_d[l_ac].sfba020
                #160318-00025#4--add--str
                LET g_errshow = TRUE 
                LET g_chkparam.err_str[1] = "aim-00063:sub-01302|aini002|",cl_get_progname("aini002",g_lang,"2"),"|:EXEPROGaini002"
                #160318-00025#4--add--end
                IF NOT cl_chk_exist("v_inab002") THEN
                   LET g_sfba_d[l_ac].sfba020 = g_sfba_d_t.sfba020
                   LET g_sfba_d[l_ac].sfba020_desc = s_desc_get_locator_desc(g_site,g_sfba_d[l_ac].sfba019,g_sfba_d[l_ac].sfba020)
                   NEXT FIELD sfba020
                END IF 
             END IF            
             LET g_sfba_d[l_ac].sfba020_desc = s_desc_get_locator_desc(g_site,g_sfba_d[l_ac].sfba019,g_sfba_d[l_ac].sfba020)
             DISPLAY BY NAME g_sfba_d[l_ac].sfba020_desc  
            #cj            
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE sfba020
            #add-point:ON CHANGE sfba020
            
            #END add-point

         #----<<sfba028>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfba028
            #add-point:BEFORE FIELD sfba028
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba028

            #add-point:AFTER FIELD sfba028
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE sfba028
            #add-point:ON CHANGE sfba028
            
            #END add-point

         #----<<sfba001>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfba001
            #add-point:BEFORE FIELD sfba001
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba001

            #add-point:AFTER FIELD sfba001
            INITIALIZE g_ref_fields TO NULL
            LET g_ref_fields[1] = g_sfba_d[l_ac].sfba001
            CALL ap_ref_array2(g_ref_fields,"SELECT imaal003,imaal004 FROM imaal_t WHERE imaalent='"||g_enterprise||"' AND imaal001=? AND imaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
            LET g_sfba_d[l_ac].sfba001_desc = '', g_rtn_fields[1] , ''
            LET g_sfba_d[l_ac].sfba001_desc1 = '', g_rtn_fields[2] , ''
            DISPLAY BY NAME g_sfba_d[l_ac].sfba001_desc
            DISPLAY BY NAME g_sfba_d[l_ac].sfba001_desc1           
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE sfba001
            #add-point:ON CHANGE sfba001
            
            #END add-point

         #----<<sfba026>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfba026
            #add-point:BEFORE FIELD sfba026
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba026

            #add-point:AFTER FIELD sfba026
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE sfba026
            #add-point:ON CHANGE sfba026
            
            #END add-point

         #----<<sfba027>>----
         AFTER FIELD ooff013

            #add-point:AFTER FIELD sfba026
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE ooff013
            #add-point:ON CHANGE sfba026
            
            #END add-point
         #此段落由子樣板a01產生
         BEFORE FIELD sfba027
            #add-point:BEFORE FIELD sfba027
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfba027

            #add-point:AFTER FIELD sfba027
            
            #END add-point


         #此段落由子樣板a04產生
         ON CHANGE sfba027
            #add-point:ON CHANGE sfba027
            
            #END add-point


         #---------------------<  Detail: page1  >---------------------
         #----<<sfbaseq>>----
         #Ctrlp:input.c.page1.sfbaseq
#         ON ACTION controlp INFIELD sfbaseq
            #add-point:ON ACTION controlp INFIELD sfbaseq
            
            #END add-point

         #----<<sfbaseq1>>----
         #Ctrlp:input.c.page1.sfbaseq1
#         ON ACTION controlp INFIELD sfbaseq1
            #add-point:ON ACTION controlp INFIELD sfbaseq1
            
            #END add-point

         #----<<sfba002>>----
         #Ctrlp:input.c.page1.sfba002
         ON ACTION controlp INFIELD sfba002
            #add-point:ON ACTION controlp INFIELD sfba002
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfba_d[l_ac].sfba002
            LET g_qryparam.arg1 = "215"
            CALL q_oocq002()
            LET g_sfba_d[l_ac].sfba002 = g_qryparam.return1 
         #   DISPLAY g_sfba_d[l_ac].sfba002 TO sfba002
            NEXT FIELD sfba002
            
            #END add-point

         #----<<sfba003>>----
         #Ctrlp:input.c.page1.sfba003
         ON ACTION controlp INFIELD sfba003
            #add-point:ON ACTION controlp INFIELD sfba003
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfba_d[l_ac].sfba003
            LET g_qryparam.arg1 = "221"
            CALL q_oocq002()
            LET g_sfba_d[l_ac].sfba003 = g_qryparam.return1 
        #    DISPLAY g_sfba_d[l_ac].sfba003 TO sfba003
            NEXT FIELD sfba003            
            
            #END add-point

         #----<<sfba004>>----
         #Ctrlp:input.c.page1.sfba004
#         ON ACTION controlp INFIELD sfba004
            #add-point:ON ACTION controlp INFIELD sfba004
            
            #END add-point

         #----<<sfba005>>----
         #Ctrlp:input.c.page1.sfba005
         ON ACTION controlp INFIELD sfba005
            #add-point:ON ACTION controlp INFIELD sfba005
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfba_d[l_ac].sfba005
            #161124-00021#1 add------s---           
            IF g_sfaa_m.sfaa003='2' THEN
               LET g_qryparam.where = " imaa004 <> 'X' "
               CALL q_imaa001_10()
            ELSE
            #161124-00021#1 add------e---
               LET g_qryparam.arg1 = g_sfaa_m.sfaa010
               LET g_qryparam.arg2 = g_sfaa_m.sfaa011
               #160623-00009#1-add-(S)
               LET g_qryparam.where = " bmba003 IN (SELECT imaa001 FROM imaa_t ",
                                      "              WHERE imaaent = '",g_enterprise,"'",
                                      "                AND imaa004 <> 'X') "
               #160623-00009#1-add-(E)
               IF NOT cl_null(g_sfaa_m.sfaa015) THEN
                  LET g_qryparam.arg3 = g_sfaa_m.sfaa015
               ELSE
                  LET g_qryparam.arg3 = cl_get_today()
               END IF
               CALL q_bmba003_2()
            END IF #161124-00021#1 add
            LET g_sfba_d[l_ac].sfba005 = g_qryparam.return1 
            #单别对应参数设置为1时，需存在bom，不需再打开料号开窗
            CALL s_aooi200_get_slip(g_sfaa_m.sfaadocno) RETURNING l_success,l_ooba002
            IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0024') != '1' THEN
               IF cl_null(g_sfba_d[l_ac].sfba005) THEN
                  LET g_qryparam.where = ""  #160727-00025#1
                  CALL q_imaf001_6()
                  LET g_sfba_d[l_ac].sfba005 = g_qryparam.return1
               END IF
            END IF
            
            NEXT FIELD sfba005
            
            #END add-point

         #----<<replace>>----
         #Ctrlp:input.c.page1.replace
#         ON ACTION controlp INFIELD replace
            #add-point:ON ACTION controlp INFIELD replace
            
            #END add-point

         #----<<sfba022>>----
         #Ctrlp:input.c.page1.sfba022
#         ON ACTION controlp INFIELD sfba022
            #add-point:ON ACTION controlp INFIELD sfba022
            
            #END add-point

         #----<<sfba006>>----
         #Ctrlp:input.c.page1.sfba006
         ON ACTION controlp INFIELD sfba006
            #add-point:ON ACTION controlp INFIELD sfba006
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfba_d[l_ac].sfba006
            #160623-00009#1-add-(S)
            LET g_qryparam.where = " bmea008 IN (SELECT imaa001 FROM imaa_t ",
                                   "              WHERE imaaent = '",g_enterprise,"'",
                                   "                AND imaa004 <> 'X') "
            #160623-00009#1-add-(E)
            CALL q_bmea008_4()
            LET g_sfba_d[l_ac].sfba006 = g_qryparam.return1 
           # DISPLAY g_sfba_d[l_ac].sfba006 TO sfba006
            NEXT FIELD sfba006            
            
            #END add-point

         #----<<imaf013>>----
         #Ctrlp:input.c.page1.imaf013
#         ON ACTION controlp INFIELD imaf013
            #add-point:ON ACTION controlp INFIELD imaf013
            
            #END add-point

         #----<<sfba021>>----
         #Ctrlp:input.c.page1.sfba021
         ON ACTION controlp INFIELD sfba021
            #add-point:ON ACTION controlp INFIELD sfba021
            #发料料号做特征管理
            SELECT imaa005 INTO l_imaa005 FROM imaa_t WHERE imaaent = g_enterprise AND imaa001 = g_sfba_d[l_ac].sfba006
            IF NOT cl_null(l_imaa005) THEN
               IF l_cmd = 'a' THEN 
                  CALL l_inam.clear()          
                  CALL s_feature_multi(g_sfba_d[l_ac].sfba006,'','',g_site,g_sfaa_m.sfaadocno) RETURNING l_success,l_inam
                  LET g_sfba_d[l_ac].sfba021 = l_inam[1].inam002
                  LET g_sfba_d[l_ac].sfba023 = l_inam[1].inam004
                  LET g_sfba_d[l_ac].sfba013 = g_sfba_d[l_ac].sfba023 + g_sfba_d[l_ac].sfba024
                  #重算QPA分子分母
                  CALL asft300_sfba023_qpa(g_sfba_d[l_ac].sfba023) RETURNING g_sfba_d[l_ac].sfba010,g_sfba_d[l_ac].sfba011
                  #建议应发数量
                  CALL s_asft300_03(g_sfba_d[l_ac].sfba006,g_sfba_d[l_ac].sfba013) RETURNING l_success,l_sfba013
                  IF l_success THEN
                     LET g_sfba_d[l_ac].sfba013=l_sfba013
                  END IF               
                  LET g_sfba_d[l_ac].sfba024 = g_sfba_d[l_ac].sfba013 - g_sfba_d[l_ac].sfba023                    
               END IF
               IF l_cmd = 'u' THEN
                  CALL s_feature_single(g_sfba_d[l_ac].sfba006,g_sfba_d[l_ac].sfba021,g_site,g_sfaa_m.sfaadocno)
                     RETURNING l_success,g_sfba_d[l_ac].sfba021
               END IF
               DISPLAY BY NAME g_sfba_d[l_ac].sfba021
            END IF
            #END add-point

         #----<<sfba007>>----
         #Ctrlp:input.c.page1.sfba007
#         ON ACTION controlp INFIELD sfba007
            #add-point:ON ACTION controlp INFIELD sfba007
            
            #END add-point

         #----<<sfba008>>----
         #Ctrlp:input.c.page1.sfba008
#         ON ACTION controlp INFIELD sfba008
            #add-point:ON ACTION controlp INFIELD sfba008
            
            #END add-point

         #----<<sfba009>>----
         #Ctrlp:input.c.page1.sfba009
#         ON ACTION controlp INFIELD sfba009
            #add-point:ON ACTION controlp INFIELD sfba009
            
            #END add-point

         #----<<sfba010>>----
         #Ctrlp:input.c.page1.sfba010
#         ON ACTION controlp INFIELD sfba010
            #add-point:ON ACTION controlp INFIELD sfba010
            
            #END add-point

         #----<<sfba011>>----
         #Ctrlp:input.c.page1.sfba011
#         ON ACTION controlp INFIELD sfba011
            #add-point:ON ACTION controlp INFIELD sfba011
            
            #END add-point

         #----<<sfba012>>----
         #Ctrlp:input.c.page1.sfba012
#         ON ACTION controlp INFIELD sfba012
            #add-point:ON ACTION controlp INFIELD sfba012
            
            #END add-point

         #----<<sfba023>>----
         #Ctrlp:input.c.page1.sfba023
#         ON ACTION controlp INFIELD sfba023
            #add-point:ON ACTION controlp INFIELD sfba023
            
            #END add-point

         #----<<sfba024>>----
         #Ctrlp:input.c.page1.sfba024
#         ON ACTION controlp INFIELD sfba024
            #add-point:ON ACTION controlp INFIELD sfba024
            
            #END add-point

         #----<<sfba013>>----
         #Ctrlp:input.c.page1.sfba013
#         ON ACTION controlp INFIELD sfba013
            #add-point:ON ACTION controlp INFIELD sfba013
            
            #END add-point

         #----<<sfba014>>----
         #Ctrlp:input.c.page1.sfba014
         ON ACTION controlp INFIELD sfba014
            #add-point:ON ACTION controlp INFIELD sfba014
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfba_d[l_ac].sfba014
            CALL q_ooca001_1()
            LET g_sfba_d[l_ac].sfba014 = g_qryparam.return1 
         #   DISPLAY g_sfba_d[l_ac].sfba014 TO sfba014
            NEXT FIELD sfba014             
            
            #END add-point

         #----<<sfba015>>----
         #Ctrlp:input.c.page1.sfba015
#         ON ACTION controlp INFIELD sfba015
            #add-point:ON ACTION controlp INFIELD sfba015
            
            #END add-point

         #----<<sfba016>>----
         #Ctrlp:input.c.page1.sfba016
#         ON ACTION controlp INFIELD sfba016
            #add-point:ON ACTION controlp INFIELD sfba016
            
            #END add-point

         #----<<sfba025>>----
         #Ctrlp:input.c.page1.sfba025
#         ON ACTION controlp INFIELD sfba025
            #add-point:ON ACTION controlp INFIELD sfba025
            
            #END add-point

         #----<<number1>>----
         #Ctrlp:input.c.page1.number1
#         ON ACTION controlp INFIELD number1
            #add-point:ON ACTION controlp INFIELD number1
            
            #END add-point

         #----<<number2>>----
         #Ctrlp:input.c.page1.number2
#         ON ACTION controlp INFIELD number2
            #add-point:ON ACTION controlp INFIELD number2
            
            #END add-point

         #----<<sfba017>>----
         #Ctrlp:input.c.page1.sfba017
#         ON ACTION controlp INFIELD sfba017
            #add-point:ON ACTION controlp INFIELD sfba017
            
            #END add-point

         #----<<sfba018>>----
         #Ctrlp:input.c.page1.sfba018
#         ON ACTION controlp INFIELD sfba018
            #add-point:ON ACTION controlp INFIELD sfba018
            
            #END add-point

         #----<<sfba019>>----
         #Ctrlp:input.c.page1.sfba019
         ON ACTION controlp INFIELD sfba019
            #add-point:ON ACTION controlp INFIELD sfba019
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfba_d[l_ac].sfba019
            #add by lixh 20151208
#            IF g_sfaa_m.sfaa005 = '5' THEN
#               LET g_qryparam.where = " inaa010 = 'N' "
#            END IF   
            #add by lixh 20151208
            CALL q_inaa001_2()
            LET g_sfba_d[l_ac].sfba019 = g_qryparam.return1 
            #DISPLAY g_sfba_d[l_ac].sfba019 TO sfba019
            NEXT FIELD sfba019             
            
            #END add-point

         #----<<sfba020>>----
         #Ctrlp:input.c.page1.sfba020
         ON ACTION controlp INFIELD sfba020
            #add-point:ON ACTION controlp INFIELD sfba020
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfba_d[l_ac].sfba020
            LET g_qryparam.arg1 = g_sfba_d[l_ac].sfba019
            CALL q_inab002_3()
            LET g_sfba_d[l_ac].sfba020 = g_qryparam.return1 
            #DISPLAY g_sfba_d[l_ac].sfba020 TO sfba020
            NEXT FIELD sfba020            
            
            #END add-point

         #----<<sfba028>>----
         #Ctrlp:input.c.page1.sfba028
#         ON ACTION controlp INFIELD sfba028
            #add-point:ON ACTION controlp INFIELD sfba028
            
            #END add-point

         #----<<sfba001>>----
         #Ctrlp:input.c.page1.sfba001
#         ON ACTION controlp INFIELD sfba001
            #add-point:ON ACTION controlp INFIELD sfba001
            
            #END add-point

         #----<<sfba026>>----
         #Ctrlp:input.c.page1.sfba026
#         ON ACTION controlp INFIELD sfba026
            #add-point:ON ACTION controlp INFIELD sfba026
            
            #END add-point

         #----<<sfba027>>----
         #Ctrlp:input.c.page1.sfba027
#         ON ACTION controlp INFIELD sfba027
            #add-point:ON ACTION controlp INFIELD sfba027
            
            #END add-point
         #161031-00025#17-s mark
#         ON ACTION controlp INFIELD sfba_ooff013
#            IF NOT cl_null(g_sfba_d[l_ac].sfbaseq) AND NOT cl_null(g_sfba_d[l_ac].sfbaseq1) THEN
#               CALL aooi360_02('7',g_sfaa_m.sfaadocno,g_sfba_d[l_ac].sfbaseq,g_sfba_d[l_ac].sfbaseq1,'','','','','','','','2')
#               CALL s_aooi360_sel('7',g_sfaa_m.sfaadocno,g_sfba_d[l_ac].sfbaseq,g_sfba_d[l_ac].sfbaseq1,'','','','','','','','2')
#                    RETURNING l_success,g_sfba_d[l_ac].sfba_ooff013 
#            END IF
         #161031-00025#17-e mark
         ON ACTION controlp INFIELD ooff013
            #add-point:ON ACTION controlp INFIELD ooff013 name="input.c.page1.ooff013"
            #161031-00025#17-s
            IF NOT cl_null(g_sfaa_m.sfaadocno) AND l_ac > 0 THEN
               CALL aooi360_02('7',g_prog,g_sfaa_m.sfaadocno,g_sfba_d[l_ac].sfbaseq,g_sfba_d[l_ac].sfbaseq1,'','','','','','','1')
               CALL s_aooi360_sel('7',g_prog,g_sfaa_m.sfaadocno,g_sfba_d[l_ac].sfbaseq,g_sfba_d[l_ac].sfbaseq1,'','','','','','','1') RETURNING l_success,g_sfba_d[l_ac].ooff013
               LET g_ooff001_d = '6'   #6.單據單頭備註
               LET g_ooff002_d = g_prog
               LET g_ooff003_d = g_sfaa_m.sfaadocno   #单号
               LET g_ooff004_d = 0     #项次
               LET g_ooff005_d = ' '
               LET g_ooff006_d = ' '
               LET g_ooff007_d = ' '
               LET g_ooff008_d = ' '
               LET g_ooff009_d = ' '
               LET g_ooff010_d = ' '
               LET g_ooff011_d = ' '
               CALL aooi360_01_b_fill(g_ooff001_d,g_ooff002_d,g_ooff003_d,g_ooff004_d,g_ooff005_d,g_ooff006_d,g_ooff007_d,g_ooff008_d,g_ooff009_d,g_ooff010_d,g_ooff011_d)   #备注单身 
            END IF
            #161031-00025#17-e
         #170112-00001#1 add --(S)--
         ON ACTION controlp INFIELD sfba029
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = "i"
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfba_d[l_ac].sfba019
            LET g_qryparam.default2 = g_sfba_d[l_ac].sfba020
            LET g_qryparam.default3 = g_sfba_d[l_ac].sfba029
            LET g_qryparam.default4 = g_sfba_d[l_ac].sfba030
            LET g_qryparam.arg1 = g_site
            LET g_qryparam.arg2 = g_sfba_d[l_ac].sfba006
            IF cl_null(g_sfba_d[l_ac].sfba021) THEN
               LET g_qryparam.arg3 = ' '
            ELSE
               LET g_qryparam.arg3 = g_sfba_d[l_ac].sfba021
            END IF
            LET g_qryparam.arg4 = g_sfba_d[l_ac].sfba014
            LET g_qryparam.where = "1=1 "
            IF NOT cl_null(g_sfba_d[l_ac].sfba019) THEN
               LET g_qryparam.where = g_qryparam.where ," AND inag004 = '",g_sfba_d[l_ac].sfba019,"' "
            END IF
            IF NOT cl_null(g_sfba_d[l_ac].sfba020) THEN
               LET g_qryparam.where = g_qryparam.where ," AND inag005 = '",g_sfba_d[l_ac].sfba020,"' "
            END IF
            IF NOT cl_null(g_sfba_d[l_ac].sfba030) THEN
               LET g_qryparam.where = g_qryparam.where ," AND inag003 = '",g_sfba_d[l_ac].sfba030,"' "
            END IF
            CALL q_inag004_14()  #库位、储位、批号、库存管理特征
           
            LET g_sfba_d[l_ac].sfba019 = g_qryparam.return1
            LET g_sfba_d[l_ac].sfba020 = g_qryparam.return2
            LET g_sfba_d[l_ac].sfba029 = g_qryparam.return3
            LET g_sfba_d[l_ac].sfba030 = g_qryparam.return4
            DISPLAY g_sfba_d[l_ac].sfba019 TO sfba019
            DISPLAY g_sfba_d[l_ac].sfba020 TO sfba020
            DISPLAY g_sfba_d[l_ac].sfba029 TO sfba029 
            DISPLAY g_sfba_d[l_ac].sfba030 TO sfba030 
            LET g_sfba_d[l_ac].sfba019_desc = s_desc_get_stock_desc(g_site,g_sfba_d[l_ac].sfba019)
            LET g_sfba_d[l_ac].sfba020_desc = s_desc_get_locator_desc(g_site,g_sfba_d[l_ac].sfba019,g_sfba_d[l_ac].sfba020)
            NEXT FIELD sfba029
         #170112-00001#1 add --(E)--            

         ON ROW CHANGE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 9001
               LET g_errparam.extend = ''
               LET g_errparam.popup = FALSE
               CALL cl_err()

               LET INT_FLAG = 0
               LET g_sfba_d[l_ac].* = g_sfba_d_t.*
               CLOSE asft300_bcl
               CALL s_transaction_end('N','0')
               EXIT DIALOG
            END IF

            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = -263
               LET g_errparam.extend = g_sfba_d[l_ac].sfbaseq
               LET g_errparam.popup = TRUE
               CALL cl_err()

               LET g_sfba_d[l_ac].* = g_sfba_d_t.*
            ELSE

               #add-point:單身修改前
               LET l_rate = ''
               LET l_imaa006 = ''
               IF NOT cl_null(g_sfba_d[l_ac].sfba006) THEN 
                  SELECT imaa006 INTO l_imaa006 FROM imaa_t
                   WHERE imaaent = g_enterprise
                     AND imaa001 = g_sfba_d[l_ac].sfba006  
                  IF NOT cl_null(g_sfba_d[l_ac].sfba006) AND NOT cl_null(l_imaa006) THEN
                     CALL s_aimi190_get_convert(g_sfba_d[l_ac].sfba006,g_sfba_d[l_ac].sfba014,l_imaa006) RETURNING l_success,l_rate
                     IF l_success = FALSE THEN
                        LET g_sfba_d[l_ac].sfba014 = g_sfba_d_t.sfba014
                        INITIALIZE g_ref_fields TO NULL
                        LET g_ref_fields[1] = g_sfba_d[l_ac].sfba014
                        CALL ap_ref_array2(g_ref_fields,"SELECT oocal003 FROM oocal_t WHERE oocalent='"||g_enterprise||"' AND oocal001=? AND oocal002='"||g_dlang||"'","") RETURNING g_rtn_fields
                        LET g_sfba_d[l_ac].sfba014_desc = '', g_rtn_fields[1] , ''
                        DISPLAY BY NAME g_sfba_d[l_ac].sfba014_desc 
                        NEXT FIELD sfba006                       
                     END IF
                  END IF 
                  IF cl_null(l_imaa006) THEN
                     INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'abm-00021'
                  LET g_errparam.extend = l_imaa006
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                     LET g_sfba_d[l_ac].sfba014 = g_sfba_d_t.sfba014
                     INITIALIZE g_ref_fields TO NULL
                     LET g_ref_fields[1] = g_sfba_d[l_ac].sfba014
                     CALL ap_ref_array2(g_ref_fields,"SELECT oocal003 FROM oocal_t WHERE oocalent='"||g_enterprise||"' AND oocal001=? AND oocal002='"||g_dlang||"'","") RETURNING g_rtn_fields
                     LET g_sfba_d[l_ac].sfba014_desc = '', g_rtn_fields[1] , ''
                     DISPLAY BY NAME g_sfba_d[l_ac].sfba014_desc 
                     NEXT FIELD sfba006
                  END IF
               END IF 
               
               #160727-00025#1---s
               IF cl_null(g_sfba_d[l_ac].sfba002) THEN
                  LET g_sfba_d[l_ac].sfba002 = ' '             
               END IF
               #160727-00025#1---e
               #end add-point

               #寫入修改者/修改日期資訊(單身)


               UPDATE sfba_t SET (sfbadocno,sfbaseq,sfbaseq1,sfba002,sfba003,sfba004,sfba005,sfba022,sfba006,sfba033,  #160509-00009#4 by whitney add sfba033
                                  sfba021,sfba007,sfba008,sfba009,sfba010,sfba011,sfba012,sfba023,sfba024,sfba013,
                                  sfba014,sfba015,sfba016,sfba025,sfba017,sfba018,sfba019,sfba020,sfba029,sfba030,
                                  sfba028,sfba001,sfba026,sfba027)
                               = (g_sfaa_m.sfaadocno,g_sfba_d[l_ac].sfbaseq,g_sfba_d[l_ac].sfbaseq1,g_sfba_d[l_ac].sfba002,g_sfba_d[l_ac].sfba003,
                                  g_sfba_d[l_ac].sfba004,g_sfba_d[l_ac].sfba005,g_sfba_d[l_ac].sfba022,g_sfba_d[l_ac].sfba006,g_sfba_d[l_ac].sfba033,  #160509-00009#4 by whitney add sfba033
                                  g_sfba_d[l_ac].sfba021,g_sfba_d[l_ac].sfba007,g_sfba_d[l_ac].sfba008,g_sfba_d[l_ac].sfba009,g_sfba_d[l_ac].sfba010,
                                  g_sfba_d[l_ac].sfba011,g_sfba_d[l_ac].sfba012,g_sfba_d[l_ac].sfba023,g_sfba_d[l_ac].sfba024,g_sfba_d[l_ac].sfba013,
                                  g_sfba_d[l_ac].sfba014,g_sfba_d[l_ac].sfba015,g_sfba_d[l_ac].sfba016,g_sfba_d[l_ac].sfba025,g_sfba_d[l_ac].sfba017,
                                  g_sfba_d[l_ac].sfba018,g_sfba_d[l_ac].sfba019,g_sfba_d[l_ac].sfba020,g_sfba_d[l_ac].sfba029,g_sfba_d[l_ac].sfba030,
                                  g_sfba_d[l_ac].sfba028,g_sfba_d[l_ac].sfba001,g_sfba_d[l_ac].sfba026,g_sfba_d[l_ac].sfba027)
                WHERE sfbaent = g_enterprise AND sfbasite = g_site AND sfbadocno = g_sfaa_m.sfaadocno

                  AND sfbaseq = g_sfba_d_t.sfbaseq #項次
                  AND sfbaseq1 = g_sfba_d_t.sfbaseq1



               #add-point:單身修改中
               
               #end add-point
               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = "std-00009"
                     LET g_errparam.extend = "sfba_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CALL s_transaction_end('N','0')
                     LET g_sfba_d[l_ac].* = g_sfba_d_t.*
                  WHEN SQLCA.sqlcode #其他錯誤
                     INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = "sfba_t"
               LET g_errparam.popup = TRUE
               CALL cl_err()

                     LET g_sfba_d[l_ac].* = g_sfba_d_t.*
                     CALL s_transaction_end('N','0')
                  OTHERWISE
                                    INITIALIZE gs_keys TO NULL
               LET gs_keys[1] = g_sfaa_m.sfaadocno
               LET gs_keys_bak[1] = g_sfaadocno_t
               LET gs_keys[2] = g_sfba_d[g_detail_idx].sfbaseq
               LET gs_keys_bak[2] = g_sfba_d_t.sfbaseq
               LET gs_keys[3] = g_sfba_d[g_detail_idx].sfbaseq1
               LET gs_keys_bak[3] = g_sfba_d_t.sfbaseq1
               CALL asft300_update_b('sfba_t',gs_keys,gs_keys_bak,"'1'")
                     #資料多語言用-增/改

               END CASE

               #add-point:單身修改後
               #单身备注写入
               #161031-00025#17-s               
#               IF NOT cl_null(g_sfba_d[l_ac].sfba_ooff013) THEN
#                  IF NOT s_aooi360_gen('7',g_sfaa_m.sfaadocno,g_sfba_d[l_ac].sfbaseq,g_sfba_d[l_ac].sfbaseq1,' ',' ',' ',' ',' ',' ',' ','2',g_sfba_d[l_ac].sfba_ooff013) THEN
#                     CALL s_transaction_end('N','0')
#                  END IF
#               ELSE
#                  IF NOT s_aooi360_del('7',g_sfaa_m.sfaadocno,g_sfba_d[l_ac].sfbaseq,g_sfba_d[l_ac].sfbaseq1,' ',' ',' ',' ',' ',' ',' ','2') THEN
#                     CALL s_transaction_end('N','0')
#                  END IF
#               END IF
               IF NOT cl_null(g_sfba_d[l_ac].ooff013) THEN
                  IF NOT s_aooi360_gen('7',g_prog,g_sfaa_m.sfaadocno,g_sfba_d[l_ac].sfbaseq,g_sfba_d[l_ac].sfbaseq1,' ',' ',' ',' ',' ',' ','1',g_sfba_d[l_ac].ooff013) THEN
                     CALL s_transaction_end('N','0')
                  END IF
               ELSE
                  IF NOT s_aooi360_del('7',g_prog,g_sfaa_m.sfaadocno,g_sfba_d[l_ac].sfbaseq,g_sfba_d[l_ac].sfbaseq1,' ',' ',' ',' ',' ',' ','1') THEN
                     CALL s_transaction_end('N','0')
                  END IF
               END IF
               #161031-00025#17-e
               #end add-point

            END IF

         AFTER ROW
            #add-point:單身after_row
            
            #end add-point
            CALL asft300_unlock_b("sfba_t","'1'")
            CALL s_transaction_end('Y','0')
            #其他table進行unlock


         AFTER INPUT
            #add-point:input段after input
            
            #end add-point

      END INPUT



      INPUT ARRAY g_sfab_d FROM s_sfab.*
          ATTRIBUTE(COUNT = g_rec_b,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS,
                  INSERT ROW = l_allow_insert,
                  DELETE ROW = l_allow_delete,
                  APPEND ROW = l_allow_insert)
                  
         BEFORE INPUT
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN
               CALL FGL_SET_ARR_CURR(g_sfab_d.getLength()+1)
               LET g_insert = 'N'
            END IF

            CALL asft300_b_fill_sfab()
            LET g_rec_b = g_sfab_d.getLength()
            IF g_sfaa_m.sfaa005 != '1' OR cl_null(g_sfaa_m.sfaa010) THEN
           #当不满足条件不能进入工单来源页签时，不要报错退出dialog，直接进入到下一个能进入的页签 #20140923
           #   INITIALIZE g_errparam TO NULL
           #   LET g_errparam.code = 'asf-00161'
           #   LET g_errparam.extend = ''
           #   LET g_errparam.popup = TRUE
           #   CALL cl_err()
           #
           #   EXIT DIALOG
               NEXT FIELD sfacseq
            END IF
            
            #有單身資料時，工單類型、發料制度、工單來源、來源單號項次項序分批序、生產料號、BOM特性、生產數量、生產單位、工單來源頁籤，
            #限制不可修改，以免已存在的單身資料與單頭不合
            IF NOT cl_null(g_sfaa_m.sfaadocno) THEN
               SELECT COUNT(1) INTO l_n FROM sfba_t WHERE sfbaent=g_enterprise AND sfbasite=g_site AND sfbadocno=g_sfaa_m.sfaadocno
               IF l_n > 0 THEN
                 #当不满足条件不能进入工单来源页签时，不要报错退出dialog，直接进入到下一个能进入的页签 #20140923
                 #INITIALIZE g_errparam TO NULL
                 #LET g_errparam.code = 'asf-00329'
                 #LET g_errparam.extend = ''
                 #LET g_errparam.popup = TRUE
                 #CALL cl_err()
                 #
                 #EXIT DIALOG
                  NEXT FIELD sfacseq
               END IF
            END IF
            
         BEFORE ROW
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac_t = l_ac 
            LET g_detail_idx_list[2] = l_ac
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac
            LET g_current_page = 2

            LET l_lock_sw = 'N'  

            CALL s_transaction_begin()
            OPEN asft300_cl USING g_enterprise, g_site,g_sfaa_m.sfaadocno

            IF STATUS THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code =  STATUS
               LET g_errparam.extend = "OPEN asft300_cl:"
               LET g_errparam.popup = TRUE
               CALL cl_err()

               CLOSE asft300_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF

         #  LET g_rec_b = g_sfab_d.getLength()

            IF g_rec_b >= l_ac
               AND g_sfab_d[l_ac].sfab001 IS NOT NULL
               AND g_sfab_d[l_ac].sfab002 IS NOT NULL
               AND g_sfab_d[l_ac].sfab003 IS NOT NULL
               AND g_sfab_d[l_ac].sfab004 IS NOT NULL


            THEN
               LET l_cmd='u'
               LET g_sfab_d_t.* = g_sfab_d[l_ac].*  #BACKUP
               OPEN asft300_sfab_bcl USING g_enterprise,g_site,g_sfaa_m.sfaadocno,g_sfab_d[l_ac].sfabseq #g_sfab_d[l_ac].sfab001,g_sfab_d[l_ac].sfab002,g_sfab_d[l_ac].sfab003,g_sfab_d[l_ac].sfab004
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "OPEN asft300_sfab_bcl"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  LET l_lock_sw='Y'
               ELSE
                  FETCH asft300_sfab_bcl INTO g_sfab_d[l_ac].sfabseq,g_sfab_d[l_ac].sfab001,g_sfab_d[l_ac].sfab002,g_sfab_d[l_ac].sfab003,
                                              g_sfab_d[l_ac].sfab004,g_sfab_d[l_ac].sfab005,g_sfab_d[l_ac].sfab006,g_sfab_d[l_ac].sfab007
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = g_sfab_d_t.sfab001
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET l_lock_sw = "Y"
                  END IF

                  CALL asft300_show_sfab_desc(l_ac)
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            #add-point:modify段before row
            #dorislai-20150713-add----(S)
            CALL asft300_set_entry(p_cmd)
            CALL asft300_set_no_entry(p_cmd)
            #dorislai-20150713-add----(E)
            #160906-00033#1-s
            CALL asft300_set_entry_b(p_cmd)
            CALL asft300_set_no_entry_b(p_cmd)
            #160906-00033#1-e
            #end add-point
         BEFORE INSERT
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            CALL s_transaction_begin()  #160407-00017#1 add
            INITIALIZE g_sfab_d[l_ac].* TO NULL
            
            IF g_rec_b = 0 THEN
               LET g_sfab_d[1].sfab001 = '2'
            ELSE
               LET g_sfab_d[l_ac].sfab001 = g_sfab_d[l_ac-1].sfab001
            END IF 
            
            SELECT MAX(sfab006) INTO g_sfab_d[l_ac].sfab006 FROM sfab_t WHERE sfabent=g_enterprise AND sfabsite = g_site
               AND sfabdocno = g_sfaa_m.sfaadocno
            IF cl_null(g_sfab_d[l_ac].sfab006) THEN
               LET g_sfab_d[l_ac].sfab006 = 10
            ELSE
               LET g_sfab_d[l_ac].sfab006 = g_sfab_d[l_ac].sfab006 + 10
            END IF
            LET g_sfab_d[l_ac].sfab007 = 0
            LET g_sfab_d_t.* = g_sfab_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            #160906-00033#1-s
            CALL asft300_set_entry_b(p_cmd)
            CALL asft300_set_no_entry_b(p_cmd)
            #160906-00033#1-e
            NEXT FIELD sfabseq
                  
         AFTER INSERT
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 9001
               LET g_errparam.extend = ''
               LET g_errparam.popup = FALSE
               CALL cl_err()

               LET INT_FLAG = 0
               CANCEL INSERT
            END IF 
            
            #160607-00028#1 20160629 add by ming -----(S) 
            #如果新增時是獨立需求的話，要更新來源單據的數量 
            IF g_sfab_d[l_ac].sfab001 = '6' THEN 
               IF NOT s_asft300_upd_psab006(g_sfab_d[l_ac].sfab002,g_sfab_d[l_ac].sfab003,
                                          g_sfaa_m.sfaa010,0,g_sfab_d[l_ac].sfab007,g_sfaa_m.sfaa013) THEN
                  CONTINUE DIALOG
               END IF
            END IF 
            #160607-00028#1 20160629 add by ming -----(E) 

            SELECT COUNT(1) INTO l_count FROM sfab_t
             WHERE sfabent = g_enterprise
               AND sfabsite = g_site
               AND sfabdocno = g_sfaa_m.sfaadocno
               AND sfabseq = g_sfab_d[l_ac].sfabseq
               AND sfab001 = g_sfab_d[l_ac].sfab001
               AND sfab002 = g_sfab_d[l_ac].sfab002
               AND sfab003 = g_sfab_d[l_ac].sfab003
               AND sfab004 = g_sfab_d[l_ac].sfab004
            #資料未重複, 插入新增資料
            IF l_count = 0 THEN
               INSERT INTO sfab_t(sfabent,sfabsite,sfabdocno,sfabseq,sfab001,sfab002,sfab003,sfab004,sfab005,sfab006,sfab007)
               VALUES(g_enterprise,g_site,g_sfaa_m.sfaadocno,g_sfab_d[l_ac].sfabseq,g_sfab_d[l_ac].sfab001,g_sfab_d[l_ac].sfab002,g_sfab_d[l_ac].sfab003,g_sfab_d[l_ac].sfab004,g_sfab_d[l_ac].sfab005,g_sfab_d[l_ac].sfab006,g_sfab_d[l_ac].sfab007)
              
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "INSERT sfab_t"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  CALL s_transaction_end('N','0')
                  CANCEL INSERT
               ELSE
                  CALL s_transaction_end('Y','0')
                  ERROR 'INSERT O.K'
                  LET g_rec_b=g_rec_b+1
               END IF
            ELSE
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = "std-00006"
               LET g_errparam.extend = 'INSERT'
               LET g_errparam.popup = TRUE
               CALL cl_err()

               INITIALIZE g_sfab_d[l_ac].* TO NULL
               CALL s_transaction_end('N','0')
               CANCEL INSERT
            END IF

         BEFORE DELETE                            #是否取消單身
            IF NOT cl_null(g_sfab_d[l_ac].sfab001) THEN
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code =  -263
                  LET g_errparam.extend = ""
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  CANCEL DELETE
               END IF 
               
               #160607-00028#1 20160629 add by ming -----(S) 
               #刪除來源資料時，如果是獨立需求時，需更新其數量 
               IF g_sfab_d[l_ac].sfab001 = '6' THEN 
                  IF NOT  s_asft300_upd_psab006(g_sfab_d[l_ac].sfab002,g_sfab_d[l_ac].sfab003, 
                                              g_sfaa_m.sfaa010,g_sfab_d[l_ac].sfab007,0,g_sfaa_m.sfaa013) THEN 
                     CALL s_transaction_end('N','0') 
                     CANCEL DELETE 
                  END IF 
               END IF 
               #160607-00028#1 20160629 add by ming -----(E) 

               DELETE FROM sfab_t
                WHERE sfabent = g_enterprise
                  AND sfabsite= g_site
                  AND sfabdocno = g_sfaa_m.sfaadocno
                  AND sfabseq = g_sfab_d[l_ac].sfabseq
                  AND sfab001 = g_sfab_d[l_ac].sfab001
                  AND sfab002 = g_sfab_d[l_ac].sfab002
                  AND sfab003 = g_sfab_d[l_ac].sfab003
                  AND sfab004 = g_sfab_d[l_ac].sfab004
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "sfab_t"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  CALL s_transaction_end('N','0')
                  CANCEL DELETE
               ELSE
                  LET g_rec_b = g_rec_b-1
                  CALL s_transaction_end('Y','0')
               END IF
               CLOSE asft300_sfab_bcl
               LET l_count = g_sfab_d.getLength()
            END IF
            
         ON ROW CHANGE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 9001
               LET g_errparam.extend = ''
               LET g_errparam.popup = FALSE
               CALL cl_err()

               LET INT_FLAG = 0
               LET g_sfab_d[l_ac].* = g_sfab_d_t.*
               CLOSE asft300_sfab_bcl
               CALL s_transaction_end('N','0')
               EXIT DIALOG
            END IF

            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = -263
               LET g_errparam.extend = g_sfab_d[l_ac].sfab001
               LET g_errparam.popup = TRUE
               CALL cl_err()

               LET g_sfab_d[l_ac].* = g_sfab_d_t.*
            ELSE
               #160607-00028#1 20160629 add -----(S) 
               LET l_success = TRUE 
               IF g_sfab_d_t.sfab001 = '6' THEN 
                  IF NOT s_asft300_upd_psab006(g_sfab_d_t.sfab002,g_sfab_d_t.sfab003,
                                             g_sfaa_m.sfaa010,g_sfab_d_t.sfab007,0,g_sfaa_m.sfaa013) THEN 
                     CALL s_transaction_end('N','0')
                     LET g_sfab_d[l_ac].* = g_sfab_d_t.* 
                     LET l_success = FALSE 
                  END IF 
               END IF 
               IF g_sfab_d[l_ac].sfab001 = '6' THEN 
                  IF NOT s_asft300_upd_psab006(g_sfab_d[l_ac].sfab002,g_sfab_d[l_ac].sfab003,
                                             g_sfaa_m.sfaa010,0,g_sfab_d[l_ac].sfab007,g_sfaa_m.sfaa013) THEN 
                     CALL s_transaction_end('N','0')
                     LET g_sfab_d[l_ac].* = g_sfab_d_t.* 
                     LET l_success = FALSE 
                  END IF 
               END IF 
               #160607-00028#1 20160629 add -----(E) 
            
               IF l_success = TRUE THEN      ##160607-00028#1 20160629 add 
                  UPDATE sfab_t SET (sfabent,sfabsite,sfabdocno,sfabseq,sfab001,sfab002,sfab003,sfab004,sfab005,sfab006,sfab007) = (g_enterprise,g_site,g_sfaa_m.sfaadocno,g_sfab_d[l_ac].sfabseq,g_sfab_d[l_ac].sfab001,g_sfab_d[l_ac].sfab002,g_sfab_d[l_ac].sfab003,g_sfab_d[l_ac].sfab004,g_sfab_d[l_ac].sfab005,g_sfab_d[l_ac].sfab006,g_sfab_d[l_ac].sfab007)
                   WHERE sfabent = g_enterprise
                     AND sfabsite = g_site
                     AND sfabdocno = g_sfaa_m.sfaadocno
                     AND sfabseq = g_sfab_d_t.sfabseq
                     AND sfab001 = g_sfab_d_t.sfab001
                     AND sfab002 = g_sfab_d_t.sfab002
                     AND sfab003 = g_sfab_d_t.sfab003
                     AND sfab004 = g_sfab_d_t.sfab004
                  CASE
                     WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = "std-00009"
                        LET g_errparam.extend = "sfab_t"
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                  
                        CALL s_transaction_end('N','0')
                        LET g_sfab_d[l_ac].* = g_sfab_d_t.*
                     WHEN SQLCA.sqlcode #其他錯誤
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = SQLCA.sqlcode
                        LET g_errparam.extend = "sfab_t"
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                  
                        LET g_sfab_d[l_ac].* = g_sfab_d_t.*
                        CALL s_transaction_end('N','0')
                     OTHERWISE
                        UPDATE sfaa_t SET sfaa012 = sfaa012 + g_sfab_d[l_ac].sfab007 - g_sfab_d_t.sfab007 
                         WHERE sfaaent = g_enterprise AND sfaasite = g_site AND sfaadocno = g_sfaa_m.sfaadocno
                        IF SQLCA.sqlcode THEN
                           INITIALIZE g_errparam TO NULL
                           LET g_errparam.code = SQLCA.sqlcode
                           LET g_errparam.extend = "upd sfaa_t"
                           LET g_errparam.popup = TRUE
                           CALL cl_err()
                  
                           CALL s_transaction_end('N','0')
                        ELSE
                           CALL s_transaction_end('Y','0')
                           ERROR 'UPDATE O.K'
                        END IF
                  END CASE
               END IF      #160607-00028#1 20160629 add
            END IF
         
         BEFORE FIELD sfabseq
            IF cl_null(g_sfab_d[l_ac].sfabseq) OR g_sfab_d[l_ac].sfabseq = 0  THEN 
               SELECT MAX(sfabseq)+1 INTO g_sfab_d[l_ac].sfabseq FROM sfab_t
                WHERE sfabent = g_enterprise
                  AND sfabsite = g_site
                  AND sfabdocno = g_sfaa_m.sfaadocno
               IF cl_null(g_sfab_d[l_ac].sfabseq) THEN
                  LET g_sfab_d[l_ac].sfabseq = 1
               END IF                
            END IF
            
         AFTER FIELD sfabseq
            IF NOT cl_ap_chk_Range(g_sfab_d[l_ac].sfabseq,"0","0","","","azz-00079",1) THEN
               LET g_sfab_d[l_ac].sfabseq = g_sfab_d_t.sfabseq
               NEXT FIELD sfabseq
            END IF
            
            IF  NOT cl_null(g_sfaa_m.sfaadocno) AND NOT cl_null(g_sfab_d[l_ac].sfabseq) THEN
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_sfaa_m.sfaadocno != g_sfaadocno_t OR g_sfab_d[l_ac].sfabseq != g_sfab_d_t.sfabseq)) THEN
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM sfab_t WHERE "||"sfabent = '" ||g_enterprise|| "' AND sfabsite = '" ||g_site|| "' AND "||"sfabdocno = '"||g_sfaa_m.sfaadocno ||"' AND "|| "sfabseq = '"||g_sfab_d[l_ac].sfabseq ||"'",'std-00004',0) THEN
                     LET g_sfab_d[l_ac].sfabseq = g_sfab_d_t.sfabseq
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
             
         #----<<sfab001>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfab001
            #add-point:BEFORE FIELD sfab001
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfab001

            #add-point:AFTER FIELD sfab001
            #dorislai-20150712-add----(S)
            #獨立需求無來源項序、分批序
            CALL asft300_set_entry(p_cmd)
            CALL asft300_set_no_entry(p_cmd)
            #dorislai-20150712-add----(E)
            #END add-point


         #Ctrlp:construct.c.sfab001
#         ON ACTION controlp INFIELD sfab001
            #add-point:ON ACTION controlp INFIELD sfab001
            
            #END add-point

         #----<<sfab002>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfab002
            #add-point:BEFORE FIELD sfab002
            #160214-00005#3-add-(S)  
            #抓g_sfaa011用來當來源單號的開窗&校驗條件，因新手動輸入的資料，其BOM特性，需與前一筆相同
            IF g_sfab_d.getLength() > 1 THEN
               LET l_ac = g_sfab_d.getLength()  #160503-00040 by whitney add
               #看前一行的BOM特性是什麼
               CASE g_sfab_d[l_ac-1].sfab001
                  WHEN '2' #訂單
                     SELECT xmdd040 INTO g_sfaa011
                       FROM xmdd_t
                      WHERE xmddent = g_enterprise
                        AND xmddsite = g_site
                        AND xmdddocno = g_sfab_d[l_ac-1].sfab002
                        AND xmddseq = g_sfab_d[l_ac-1].sfab003
                        AND xmddseq1 = g_sfab_d[l_ac-1].sfab004
                        AND xmddseq2 = g_sfab_d[l_ac-1].sfab005
                  WHEN '6' #獨立需求
                     SELECT psab012 INTO g_sfaa011
                       FROM psab_t
                      WHERE psabent = g_enterprise
                        AND psabsite = g_site
                        AND psabdocno = g_sfab_d[l_ac-1].sfab002
                        AND psabseq = g_sfab_d[l_ac-1].sfab003
               END CASE
            ELSE
               LET g_sfaa011 = g_sfaa_m.sfaa011            
            END IF
            #160214-00005#3-add-(E)
            
            #dorislai-20150713-add----(S)
            IF NOT asft300_sfab002_chk() THEN
               LET g_sfab_d[l_ac].sfab002 = ''
               DISPLAY BY NAME g_sfab_d[l_ac].sfab002
            END IF
            #dorislai-20150713-add----(E)
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfab002

            #add-point:AFTER FIELD sfab002       
            IF NOT cl_null(g_sfab_d[l_ac].sfab002) AND (cl_null(g_sfab_d_t.sfab002) OR g_sfab_d[l_ac].sfab002 != g_sfab_d_t.sfab002) THEN
               IF NOT asft300_sfab002_chk() THEN
                  #dorislai-20150713-add----(S)
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'asf-00154'
                  LET g_errparam.extend = g_sfab_d[l_ac].sfab002
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  #dorislai-20150713-add----(E)
                  LET g_sfab_d[l_ac].sfab002 = g_sfab_d_t.sfab002
                  NEXT FIELD sfab002
               END IF
            END IF
            #END add-point

         #----<<sfab003>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfab003
            #add-point:BEFORE FIELD sfab003
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfab003

            #add-point:AFTER FIELD sfab003
            IF NOT cl_null(g_sfab_d[l_ac].sfab003) AND (cl_null(g_sfab_d_t.sfab003) OR g_sfab_d[l_ac].sfab003 != g_sfab_d_t.sfab003) THEN
               IF NOT asft300_sfab002_chk() THEN
                  #dorislai-20150713-add----(S)
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'asf-00154'
                  LET g_errparam.extend = g_sfab_d[l_ac].sfab002
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  #dorislai-20150713-add----(E)
                  LET g_sfab_d[l_ac].sfab003 = g_sfab_d_t.sfab003
                  NEXT FIELD sfab003
               END IF
            END IF
            #END add-point


         #----<<sfab004>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfab004
            #add-point:BEFORE FIELD sfab004
            #dorislai-20150713-add----(S)
            CALL asft300_set_entry(p_cmd)
            CALL asft300_set_no_entry(p_cmd)
            IF g_sfab_d[l_ac].sfab001 = '6' THEN
               NEXT FIELD sfab006
            END IF
            #dorislai-20150713-add----(E)
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfab004

            #add-point:AFTER FIELD sfab004
            IF NOT cl_null(g_sfab_d[l_ac].sfab004) AND (cl_null(g_sfab_d_t.sfab004) OR g_sfab_d[l_ac].sfab004 != g_sfab_d_t.sfab004) THEN
               IF NOT asft300_sfab002_chk() THEN
                  #dorislai-20150713-add----(S)
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'asf-00154'
                  LET g_errparam.extend = g_sfab_d[l_ac].sfab002
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  #dorislai-20150713-add----(E)
                  LET g_sfab_d[l_ac].sfab004 = g_sfab_d_t.sfab004
                  NEXT FIELD sfab004
               END IF
            END IF
            #END add-point

         #----<<sfab005>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfab005
            #add-point:BEFORE FIELD sfab005
            #dorislai-20150713-add----(S)
            CALL asft300_set_entry(p_cmd)
            CALL asft300_set_no_entry(p_cmd)
            IF g_sfab_d[l_ac].sfab001 = '6' THEN
               
               NEXT FIELD sfab006
            END IF
            #dorislai-20150713-add----(E)
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfab005

            #add-point:AFTER FIELD sfab005
            IF NOT cl_null(g_sfab_d[l_ac].sfab005) AND (cl_null(g_sfab_d_t.sfab005) OR g_sfab_d[l_ac].sfab005 != g_sfab_d_t.sfab005) THEN
               IF NOT asft300_sfab002_chk() THEN
                  #dorislai-20150713-add----(S)
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'asf-00154'
                  LET g_errparam.extend = g_sfab_d[l_ac].sfab002
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  #dorislai-20150713-add----(E)
                  LET g_sfab_d[l_ac].sfab005 = g_sfab_d_t.sfab005
                  NEXT FIELD sfab005
               END IF
            END IF
            #END add-point

         #此段落由子樣板a01產生
         BEFORE FIELD sfab006
            #add-point:BEFORE FIELD sfab006
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfab006

            #add-point:AFTER FIELD sfab006
            IF NOT cl_ap_chk_Range(g_sfab_d[l_ac].sfab006,"0","0","","","azz-00079",1) THEN
               LET g_sfab_d[l_ac].sfab006 = g_sfab_d_t.sfab006
               NEXT FIELD sfab006
            END IF
            
            IF NOT cl_null(g_sfab_d[l_ac].sfab006) AND (cl_null(g_sfab_d_t.sfab006) OR g_sfab_d[l_ac].sfab006 != g_sfab_d_t.sfab006) THEN
               SELECT COUNT(1) INTO l_n FROM sfab_t WHERE sfabent=g_enterprise AND sfabsite=g_site AND sfab006=g_sfab_d[l_ac].sfab006
               IF l_n > 0 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = ''
                  LET g_errparam.extend = g_sfab_d[l_ac].sfab006
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  LET g_sfab_d[l_ac].sfab006 = g_sfab_d_t.sfab006
                  NEXT FIELD sfab006
               END IF
            END IF
            #END add-point
            
         AFTER FIELD sfab007
            IF NOT cl_ap_chk_Range(g_sfab_d[l_ac].sfab007,"0","0","","","azz-00079",1) THEN
               LET g_sfab_d[l_ac].sfab007 = g_sfab_d_t.sfab007
               NEXT FIELD sfab007
            END IF
            SELECT imae015 INTO l_imae015 FROM imae_t WHERE imaeent=g_enterprise AND imaesite=g_site AND imae001=g_sfaa_m.sfaa010
            IF cl_null(l_imae015) THEN
               LET l_imae015 = 0 
            END IF
            
            #单位取位
            IF NOT cl_null(g_sfaa_m.sfaa013) THEN
               CALL s_aooi250_take_decimals(g_sfaa_m.sfaa013,g_sfab_d[l_ac].sfab007)
                    RETURNING l_success,g_sfab_d[l_ac].sfab007
            END IF
               
            IF g_sfab_d[l_ac].sfab007 > (g_sfab_d[l_ac].a3 - g_sfab_d[l_ac].a5) * (1 + l_imae015 / 100) + g_sfab_d_t.sfab007 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'asf-00157'
               LET g_errparam.extend = g_sfab_d[l_ac].sfab007
               LET g_errparam.popup = TRUE
               CALL cl_err()

               LET g_sfab_d[l_ac].sfab007 = g_sfab_d_t.sfab007
               NEXT FIELD sfab007
            END IF
            
         AFTER INPUT 
            #160608-00002#1 20160608 modify by ming -----(S) 
            #當資料來源沒有資料時，不應該重新推算生產數量 
            ##更新生产数量
            #SELECT SUM(sfab007) INTO l_sfab007_sum FROM sfab_t WHERE sfabent=g_enterprise AND sfabsite=g_site AND sfabdocno=g_sfaa_m.sfaadocno
            #IF NOT cl_null(g_sfaa_m.sfaa060) THEN
            #  #CALL s_aimi190_get_convert(g_sfaa_m.sfaa010,g_sfaa_m.sfaa013,g_sfaa_m.sfaa060) RETURNING l_success,l_rate
            #  #IF l_success THEN
            #  #   LET l_sfab007_sum1 = l_sfab007_sum * l_rate
            #  #END IF
            #   CALL s_aooi250_convert_qty(g_sfaa_m.sfaa010,g_sfaa_m.sfaa013,g_sfaa_m.sfaa060,l_sfab007_sum) 
            #        RETURNING l_success,l_sfab007_sum1
            #   IF NOT l_success THEN
            #      LET l_sfab007_sum1 = l_sfab007_sum
            #   END IF
            #END IF
            #  
            #UPDATE sfaa_t SET sfaa012 = l_sfab007_sum,sfaa058 = l_sfab007_sum1
            # WHERE sfaaent=g_enterprise AND sfaasite=g_site AND sfaadocno=g_sfaa_m.sfaadocno
            ##工单备料档无资料时产生工单备料,根据参数判断                
            #CALL s_aooi200_get_slip(g_sfaa_m.sfaadocno) RETURNING l_success,l_ooba002
            #IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0038') = '1' THEN
            #   SELECT COUNT(1) INTO l_count FROM sfba_t WHERE sfbaent=g_enterprise AND sfbasite=g_site AND sfbadocno=g_sfaa_m.sfaadocno
            #   IF l_count = 0 THEN 
            #      CALL s_transaction_begin()         
            #      CALL s_asft300_02(g_sfaa_m.sfaadocno,g_sfaa_m.sfaa003,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa015,g_sfaa_m.sfaa012,'N') RETURNING l_success,l_num
            #      IF NOT l_success THEN
            #         CALL s_transaction_end('N','0')
            #      END IF
            #      CALL asft300_b_fill()
            #      LET g_rec_b = g_sfba_d.getLength()
            #   END IF
            #END IF
            #
            ##备注无值时，若工单来源是订单，则把订单的长备注带入
            #CALL asft300_gen_bz()
            
            LET l_cnt = 0
            SELECT COUNT(1) INTO l_cnt
              FROM sfab_t
             WHERE sfabent   = g_enterprise
               AND sfabsite  = g_site
               AND sfabdocno = g_sfaa_m.sfaadocno
               
            IF l_cnt > 0 THEN   
               #更新生产数量
               SELECT SUM(sfab007) INTO l_sfab007_sum FROM sfab_t 
                WHERE sfabent   = g_enterprise 
                  AND sfabsite  = g_site 
                  AND sfabdocno = g_sfaa_m.sfaadocno
               IF NOT cl_null(g_sfaa_m.sfaa060) THEN
                  CALL s_aooi250_convert_qty(g_sfaa_m.sfaa010,g_sfaa_m.sfaa013,g_sfaa_m.sfaa060,l_sfab007_sum) 
                       RETURNING l_success,l_sfab007_sum1
                  IF NOT l_success THEN
                     LET l_sfab007_sum1 = l_sfab007_sum
                  END IF
               END IF
                 
               UPDATE sfaa_t SET sfaa012 = l_sfab007_sum,sfaa058 = l_sfab007_sum1
                WHERE sfaaent=g_enterprise AND sfaasite=g_site AND sfaadocno=g_sfaa_m.sfaadocno
               #工单备料档无资料时产生工单备料,根据参数判断                
               CALL s_aooi200_get_slip(g_sfaa_m.sfaadocno) RETURNING l_success,l_ooba002
               IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0038') = '1' THEN
                  SELECT COUNT(1) INTO l_count FROM sfba_t WHERE sfbaent=g_enterprise AND sfbasite=g_site AND sfbadocno=g_sfaa_m.sfaadocno
                  IF l_count = 0 THEN 
                     CALL s_transaction_begin()                     
                     CALL s_asft300_02(g_sfaa_m.sfaadocno,g_sfaa_m.sfaa003,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa015,g_sfaa_m.sfaa012,'N') RETURNING l_success,l_num
                     IF NOT l_success THEN
                        CALL s_transaction_end('N','0')
                     END IF
                     CALL asft300_b_fill()
                     LET g_rec_b = g_sfba_d.getLength()
                  END IF
               END IF
               
               #备注无值时，若工单来源是订单，则把订单的长备注带入
               CALL asft300_gen_bz()
            
            END IF 
            #160608-00002#1 20160608 modify by ming -----(E) 
  
         ON ACTION controlp INFIELD sfab002
#            INITIALIZE g_qryparam.* TO NULL
#            LET g_qryparam.state = 'i'
#               LET g_qryparam.reqry = FALSE
#            LET g_qryparam.default1 = g_sfab_d[l_ac].sfab002             #給予default值
#            LET g_qryparam.default2 = g_sfab_d[l_ac].sfab003             #給予default值
#            LET g_qryparam.default3 = g_sfab_d[l_ac].sfab004             #給予default值
#            LET g_qryparam.default4 = g_sfab_d[l_ac].sfab005             #給予default值
#            LET g_qryparam.where=" xmdd001='",g_sfaa_m.sfaa010,"'"
#            CALL q_xmdddocno()                                #呼叫開窗
#            LET g_sfab_d[l_ac].sfab002 = g_qryparam.return1              #將開窗取得的值回傳到變數
#            LET g_sfab_d[l_ac].sfab003 = g_qryparam.return2
#            LET g_sfab_d[l_ac].sfab004 = g_qryparam.return3
#            LET g_sfab_d[l_ac].sfab005 = g_qryparam.return4
#            NEXT FIELD sfab002                          #返回原欄位
            #若工單來源為訂單
            IF g_sfab_d[l_ac].sfab001 = '2' THEN
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
                  LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_sfab_d[l_ac].sfab002             #給予default值
               LET g_qryparam.default2 = g_sfab_d[l_ac].sfab003             #給予default值
               LET g_qryparam.default3 = g_sfab_d[l_ac].sfab004             #給予default值
               LET g_qryparam.default4 = g_sfab_d[l_ac].sfab005             #給予default值
               LET g_qryparam.where=" xmdd001='",g_sfaa_m.sfaa010,"'"
               #160214-00005#3-add-(S)
               IF cl_null(g_sfaa011) THEN
                  LET g_qryparam.where = g_qryparam.where CLIPPED," AND xmdd040 = ' '"
               ELSE
                  LET g_qryparam.where = g_qryparam.where CLIPPED," AND xmdd040 = '",g_sfaa011,"'"
               END IF
               #160214-00005#3-add-(E)
               
               #150909 earl mod s
               #組合過濾前後置單據資料SQL
               CALL s_aooi210_get_check_sql(g_site,'',g_sfaa_m.sfaadocno,'4','','xmdddocno') RETURNING l_success,l_where
               IF l_success THEN
                  LET g_qryparam.where = g_qryparam.where," AND ",l_where
                  CALL q_xmdddocno()                                #呼叫開窗
                  LET g_sfab_d[l_ac].sfab002 = g_qryparam.return1              #將開窗取得的值回傳到變數
                  LET g_sfab_d[l_ac].sfab003 = g_qryparam.return2
                  LET g_sfab_d[l_ac].sfab004 = g_qryparam.return3
                  LET g_sfab_d[l_ac].sfab005 = g_qryparam.return4
                  DISPLAY BY NAME g_sfab_d[l_ac].sfab002,g_sfab_d[l_ac].sfab003,g_sfab_d[l_ac].sfab004,g_sfab_d[l_ac].sfab005
               END IF
               #150909 earl mod e
                  
               NEXT FIELD sfab002                          #返回原欄位
            END IF
            #若工單來源為獨立需求
            IF g_sfab_d[l_ac].sfab001 = '6' THEN
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
                  LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_sfab_d[l_ac].sfab002             #給予default值
               LET g_qryparam.default2 = g_sfab_d[l_ac].sfab003             #給予default值
               LET g_qryparam.default3 = g_sfab_d[l_ac].sfab004             #給予default值
               LET g_qryparam.default4 = g_sfab_d[l_ac].sfab005             #給予default值
               LET g_qryparam.where=" psab001='",g_sfaa_m.sfaa010,"'"       #以基本資料的料號篩選開窗資料
               #160214-00005#3-add-(S)
               IF cl_null(g_sfaa011) THEN
                  LET g_qryparam.where = g_qryparam.where CLIPPED," AND psab012 = ' '"
               ELSE
                  LET g_qryparam.where = g_qryparam.where CLIPPED," AND psab012 = '",g_sfaa011,"'"
               END IF
               #160214-00005#3-add-(E)
               #給予arg
               
               #150909 earl mod s
               #組合過濾前後置單據資料SQL
               CALL s_aooi210_get_check_sql(g_site,'',g_sfaa_m.sfaadocno,'4','','psabdocno') RETURNING l_success,l_where
               IF l_success THEN
                  LET g_qryparam.where = g_qryparam.where," AND ",l_where
                  CALL q_psabdocno()                                           #呼叫開窗
                  LET g_sfab_d[l_ac].sfab002 = g_qryparam.return1              #將開窗取得的值回傳到變數
                  LET g_sfab_d[l_ac].sfab003 = g_qryparam.return2
                  LET g_sfab_d[l_ac].sfab004 = 0  
                  LET g_sfab_d[l_ac].sfab005 = 0
                  DISPLAY BY NAME g_sfab_d[l_ac].sfab002,g_sfab_d[l_ac].sfab003,g_sfab_d[l_ac].sfab004,g_sfab_d[l_ac].sfab005
               END IF
               #150909 earl mod e
               
               NEXT FIELD sfab002                          #返回原欄位
            END IF
            #add--151207-00017#2 By shiun--(S)
            IF g_sfab_d[l_ac].sfab001 = '7' THEN
               INITIALIZE g_qryparam.* TO NULL
               LET g_qryparam.state = 'i'
                  LET g_qryparam.reqry = FALSE
               LET g_qryparam.default1 = g_sfab_d[l_ac].sfab002             #給予default值
               LET g_qryparam.default2 = g_sfab_d[l_ac].sfab003             #給予default值
               LET g_qryparam.default3 = g_sfab_d[l_ac].sfab004             #給予default值
               LET g_qryparam.default4 = g_sfab_d[l_ac].sfab005             #給予default值
               LET g_qryparam.where=" psad001='",g_sfaa_m.sfaa010,"'"       #以基本資料的料號篩選開窗資料
               #給予arg
               
               #150909 earl mod s
               #組合過濾前後置單據資料SQL
               CALL s_aooi210_get_check_sql(g_site,'',g_sfaa_m.sfaadocno,'4','','psaddocno') RETURNING l_success,l_where
               IF l_success THEN
                  LET g_qryparam.where = g_qryparam.where," AND ",l_where
                  CALL q_psaddocno()                                           #呼叫開窗
                  LET g_sfab_d[l_ac].sfab002 = g_qryparam.return1              #將開窗取得的值回傳到變數
                  LET g_sfab_d[l_ac].sfab003 = g_qryparam.return2
                  LET g_sfab_d[l_ac].sfab004 = 0  
                  LET g_sfab_d[l_ac].sfab005 = 0
                  DISPLAY BY NAME g_sfab_d[l_ac].sfab002,g_sfab_d[l_ac].sfab003,g_sfab_d[l_ac].sfab004,g_sfab_d[l_ac].sfab005
               END IF
               #150909 earl mod e
               
               NEXT FIELD sfab002                          #返回原欄位
            END IF
            #add--151207-00017#2 By shiun--(E)
         ON ACTION controlp INFIELD sfab003
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfab_d[l_ac].sfab002             #給予default值
            LET g_qryparam.default2 = g_sfab_d[l_ac].sfab003             #給予default值
            LET g_qryparam.default3 = g_sfab_d[l_ac].sfab004             #給予default值
            LET g_qryparam.default4 = g_sfab_d[l_ac].sfab005             #給予default值
            LET g_qryparam.where=" xmdd001='",g_sfaa_m.sfaa010,"'"
            CALL q_xmdddocno()                                #呼叫開窗
            LET g_sfab_d[l_ac].sfab002 = g_qryparam.return1              #將開窗取得的值回傳到變數
            LET g_sfab_d[l_ac].sfab003 = g_qryparam.return2
            LET g_sfab_d[l_ac].sfab004 = g_qryparam.return3
            LET g_sfab_d[l_ac].sfab005 = g_qryparam.return4
            NEXT FIELD sfab003                          #返回原欄位
            
         ON ACTION controlp INFIELD sfab004
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfab_d[l_ac].sfab002             #給予default值
            LET g_qryparam.default2 = g_sfab_d[l_ac].sfab003             #給予default值
            LET g_qryparam.default3 = g_sfab_d[l_ac].sfab004             #給予default值
            LET g_qryparam.default4 = g_sfab_d[l_ac].sfab005             #給予default值
            LET g_qryparam.where=" xmdd001='",g_sfaa_m.sfaa010,"'"
            CALL q_xmdddocno()                                #呼叫開窗
            LET g_sfab_d[l_ac].sfab002 = g_qryparam.return1              #將開窗取得的值回傳到變數
            LET g_sfab_d[l_ac].sfab003 = g_qryparam.return2
            LET g_sfab_d[l_ac].sfab004 = g_qryparam.return3
            LET g_sfab_d[l_ac].sfab005 = g_qryparam.return4
            NEXT FIELD sfab004                         #返回原欄位
            
         ON ACTION controlp INFIELD sfab005
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfab_d[l_ac].sfab002             #給予default值
            LET g_qryparam.default2 = g_sfab_d[l_ac].sfab003             #給予default值
            LET g_qryparam.default3 = g_sfab_d[l_ac].sfab004             #給予default值
            LET g_qryparam.default4 = g_sfab_d[l_ac].sfab005             #給予default值
            LET g_qryparam.where=" xmdd001='",g_sfaa_m.sfaa010,"'"
            CALL q_xmdddocno()                                #呼叫開窗
            LET g_sfab_d[l_ac].sfab002 = g_qryparam.return1              #將開窗取得的值回傳到變數
            LET g_sfab_d[l_ac].sfab003 = g_qryparam.return2
            LET g_sfab_d[l_ac].sfab004 = g_qryparam.return3
            LET g_sfab_d[l_ac].sfab005 = g_qryparam.return4
            NEXT FIELD sfab005                          #返回原欄位

      END INPUT
      
      INPUT ARRAY g_sfac_d FROM s_sfac.*
          ATTRIBUTE(COUNT = g_rec_b,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS,
                  INSERT ROW = l_allow_insert,
                  DELETE ROW = l_allow_delete,
                  APPEND ROW = l_allow_insert)
                  
         BEFORE INPUT
           #20150730 by wuxja  --begin--
            IF l_flag2 = '1' THEN
               LET l_flag2 = ''
            END IF
           #20150730 by wuxja  --end--

            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN
               CALL FGL_SET_ARR_CURR(g_sfac_d.getLength()+1)
               LET g_insert = 'N'
            END IF

            CALL asft300_b_fill_sfac()
            LET g_rec_b = g_sfac_d.getLength()
            
         BEFORE ROW
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac_t = l_ac 
            LET g_detail_idx_list[3] = l_ac
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac
            LET g_current_page = 3

            LET l_lock_sw = 'N'  

            CALL s_transaction_begin()
            OPEN asft300_cl USING g_enterprise, g_site,g_sfaa_m.sfaadocno

            IF STATUS THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code =  STATUS
               LET g_errparam.extend = "OPEN asft300_cl:"
               LET g_errparam.popup = TRUE
               CALL cl_err()

               CLOSE asft300_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF

         #   LET g_rec_b = g_sfac_d.getLength()

            IF g_rec_b >= l_ac AND g_sfac_d[l_ac].sfac001 IS NOT NULL THEN
               LET l_cmd='u'
               LET g_sfac_d_t.* = g_sfac_d[l_ac].*  #BACKUP
               OPEN asft300_sfac_bcl USING g_enterprise,g_site,g_sfaa_m.sfaadocno,g_sfac_d[l_ac].sfacseq
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "OPEN asft300_sfac_bcl"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  LET l_lock_sw='Y'
               ELSE
                  FETCH asft300_sfac_bcl INTO g_sfac_d[l_ac].sfacseq,g_sfac_d[l_ac].sfac002,g_sfac_d[l_ac].sfac001,g_sfac_d[l_ac].sfac006,
                                              g_sfac_d[l_ac].sfac003,g_sfac_d[l_ac].sfac004,g_sfac_d[l_ac].sfac005
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = g_sfac_d_t.sfac001
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET l_lock_sw = "Y"
                  END IF
                  CALL cl_show_fld_cont()
                  IF g_sfac_d[l_ac].sfac002 = '1' THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'asf-00114'
                     LET g_errparam.extend = g_sfac_d[l_ac].sfac002
                     LET g_errparam.popup = FALSE
                     CALL cl_err()

                  END IF 
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            
            CALL asft300_set_entry_sfac()
            
         BEFORE INSERT
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            CALL s_transaction_begin()  #160407-00017#1 add
            INITIALIZE g_sfac_d[l_ac].* TO NULL
            LET g_sfac_d[l_ac].sfac005 = 0 

            LET g_sfac_d_t.* = g_sfac_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            NEXT FIELD sfacseq
                  
         AFTER INSERT
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 9001
               LET g_errparam.extend = ''
               LET g_errparam.popup = FALSE
               CALL cl_err()

               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
            
            IF cl_null(g_sfac_d[l_ac].sfac006) THEN
               LET g_sfac_d[l_ac].sfac006 = ' '
            END IF
            
            SELECT COUNT(1) INTO l_count FROM sfac_t
             WHERE sfacent = g_enterprise
               AND sfacsite = g_site
               AND sfacdocno = g_sfaa_m.sfaadocno
               AND sfac001 = g_sfac_d[l_ac].sfac001
               AND sfac006 = g_sfac_d[l_ac].sfac006

            #資料未重複, 插入新增資料
            IF l_count = 0 THEN
               IF cl_null(g_sfac_d[l_ac].sfac006) THEN
                  LET g_sfac_d[l_ac].sfac006 = ' '
               END IF
               INSERT INTO sfac_t(sfacent,sfacsite,sfacdocno,sfacseq,sfac001,sfac002,sfac003,sfac004,sfac005,sfac006)
               VALUES(g_enterprise,g_site,g_sfaa_m.sfaadocno,g_sfac_d[l_ac].sfacseq,g_sfac_d[l_ac].sfac001,g_sfac_d[l_ac].sfac002,g_sfac_d[l_ac].sfac003,g_sfac_d[l_ac].sfac004,g_sfac_d[l_ac].sfac005,g_sfac_d[l_ac].sfac006)
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "INSERT sfac_t"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  CALL s_transaction_end('N','0')
                  CANCEL INSERT
               ELSE
                  #其他产品特征写入DB
                  IF l_inam.getLength() > 1 THEN  #因為第一筆資料已呈現在畫面並寫入DB, 從第二筆開始處理
                     #161109-00085#27-s
                     #SELECT * INTO l_sfac.* FROM sfac_t WHERE sfacent = g_enterprise AND sfacsite = g_site
                     #161109-00085#66 --s mark
                     #SELECT sfacent,sfacsite,sfacdocno,sfac001,sfac002,sfac003,sfac004,sfac005,sfacseq,sfac006,sfac007 
                     #  INTO l_sfac.sfacent,l_sfac.sfacsite,l_sfac.sfacdocno,l_sfac.sfac001,l_sfac.sfac002,
                     #       l_sfac.sfac003,l_sfac.sfac004,l_sfac.sfac005,l_sfac.sfacseq,l_sfac.sfac006,
                     #       l_sfac.sfac007 
                     #161109-00085#66 --e mark
                     #161109-00085#66 --s add
                     SELECT sfacent,sfacsite,sfacdocno,sfac001,sfac002,
                            sfac003,sfac004,sfac005,sfacseq,sfac006,
                            sfacud001,sfacud002,sfacud003,sfacud004,sfacud005,
                            sfacud006,sfacud007,sfacud008,sfacud009,sfacud010,
                            sfacud011,sfacud012,sfacud013,sfacud014,sfacud015,
                            sfacud016,sfacud017,sfacud018,sfacud019,sfacud020,
                            sfacud021,sfacud022,sfacud023,sfacud024,sfacud025,
                            sfacud026,sfacud027,sfacud028,sfacud029,sfacud030,
                            sfac007
                       INTO l_sfac.sfacent,l_sfac.sfacsite,l_sfac.sfacdocno,l_sfac.sfac001,l_sfac.sfac002,
                            l_sfac.sfac003,l_sfac.sfac004,l_sfac.sfac005,l_sfac.sfacseq,l_sfac.sfac006,
                            l_sfac.sfacud001,l_sfac.sfacud002,l_sfac.sfacud003,l_sfac.sfacud004,l_sfac.sfacud005,
                            l_sfac.sfacud006,l_sfac.sfacud007,l_sfac.sfacud008,l_sfac.sfacud009,l_sfac.sfacud010,
                            l_sfac.sfacud011,l_sfac.sfacud012,l_sfac.sfacud013,l_sfac.sfacud014,l_sfac.sfacud015,
                            l_sfac.sfacud016,l_sfac.sfacud017,l_sfac.sfacud018,l_sfac.sfacud019,l_sfac.sfacud020,
                            l_sfac.sfacud021,l_sfac.sfacud022,l_sfac.sfacud023,l_sfac.sfacud024,l_sfac.sfacud025,
                            l_sfac.sfacud026,l_sfac.sfacud027,l_sfac.sfacud028,l_sfac.sfacud029,l_sfac.sfacud030,
                            l_sfac.sfac007
                     #161109-00085#66 --e add
                       FROM sfac_t
                      WHERE sfacent = g_enterprise AND sfacsite = g_site
                        AND sfacdocno = g_sfaa_m.sfaadocno AND sfacseq = g_sfac_d[l_ac].sfacseq
                     #161109-00085#27-e  
                     FOR l_k = 2 TO l_inam.getLength()
                        SELECT MAX(sfacseq)+1 INTO l_sfac.sfacseq FROM sfac_t 
                         WHERE sfacent = g_enterprise AND sfacsite = g_site
                           AND sfacdocno = g_sfaa_m.sfaadocno 
                        LET l_sfac.sfac006 = l_inam[l_k].inam002
                        LET l_sfac.sfac003 = l_inam[l_k].inam004
                        SELECT COUNT(1) INTO l_count FROM sfac_t
                         WHERE sfacent = g_enterprise
                           AND sfacsite = g_site
                           AND sfacdocno = g_sfaa_m.sfaadocno
                           AND sfac001 = g_sfac_d[l_ac].sfac001
                           AND sfac006 = l_sfac.sfac006
                        IF l_count > 0 THEN
                           CONTINUE FOR
                        END IF
                        #161109-00085#27-s
                        #INSERT INTO sfac_t VALUES(l_sfac.*)
                        #161109-00085#66 --s mark
                        #INSERT INTO sfac_t(sfacent,sfacsite,sfacdocno,sfac001,sfac002,sfac003,sfac004,sfac005,sfacseq,sfac006,sfac007) 
                        #VALUES(l_sfac.sfacent,l_sfac.sfacsite,l_sfac.sfacdocno,l_sfac.sfac001,l_sfac.sfac002,
                        #       l_sfac.sfac003,l_sfac.sfac004,l_sfac.sfac005,l_sfac.sfacseq,l_sfac.sfac006,l_sfac.sfac007)
                        #161109-00085#66 --e mark
                        #161109-00085#66 --s add
                        INSERT INTO sfac_t(sfacent,sfacsite,sfacdocno,sfac001,sfac002,
                                           sfac003,sfac004,sfac005,sfacseq,sfac006,
                                           sfacud001,sfacud002,sfacud003,sfacud004,sfacud005,
                                           sfacud006,sfacud007,sfacud008,sfacud009,sfacud010,
                                           sfacud011,sfacud012,sfacud013,sfacud014,sfacud015,
                                           sfacud016,sfacud017,sfacud018,sfacud019,sfacud020,
                                           sfacud021,sfacud022,sfacud023,sfacud024,sfacud025,
                                           sfacud026,sfacud027,sfacud028,sfacud029,sfacud030,
                                           sfac007)
                        VALUES(l_sfac.sfacent,l_sfac.sfacsite,l_sfac.sfacdocno,l_sfac.sfac001,l_sfac.sfac002,
                               l_sfac.sfac003,l_sfac.sfac004,l_sfac.sfac005,l_sfac.sfacseq,l_sfac.sfac006,
                               l_sfac.sfacud001,l_sfac.sfacud002,l_sfac.sfacud003,l_sfac.sfacud004,l_sfac.sfacud005,
                               l_sfac.sfacud006,l_sfac.sfacud007,l_sfac.sfacud008,l_sfac.sfacud009,l_sfac.sfacud010,
                               l_sfac.sfacud011,l_sfac.sfacud012,l_sfac.sfacud013,l_sfac.sfacud014,l_sfac.sfacud015,
                               l_sfac.sfacud016,l_sfac.sfacud017,l_sfac.sfacud018,l_sfac.sfacud019,l_sfac.sfacud020,
                               l_sfac.sfacud021,l_sfac.sfacud022,l_sfac.sfacud023,l_sfac.sfacud024,l_sfac.sfacud025,
                               l_sfac.sfacud026,l_sfac.sfacud027,l_sfac.sfacud028,l_sfac.sfacud029,l_sfac.sfacud030,
                               l_sfac.sfac007)
                        #161109-00085#66 --e add
                        #161109-00085#27-e
                     END FOR
                     CALL asft300_b_fill_sfac()
                  END IF
                  CALL l_inam.clear()
                 #CALL s_transaction_end('Y','0')   #160701-00010#1 mark
                  ERROR 'INSERT O.K'
                  LET g_rec_b=g_rec_b+1
               END IF
               #160701-00010#1 -s add
               IF g_sfaa_m.sfaa003 = '3' THEN
                  #复制的时候删除后重新产生
                  DELETE FROM sfba_t WHERE sfbaent=g_enterprise AND sfbasite=g_site AND sfbadocno=g_sfaa_m.sfaadocno
                  CALL s_asft300_02(g_sfaa_m.sfaadocno,g_sfaa_m.sfaa003,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa015,g_sfaa_m.sfaa012,'N') RETURNING l_success,l_num
                  IF NOT l_success THEN
                     CALL s_transaction_end('N','0')
                  ELSE
                     CALL s_transaction_end('Y','0')
                  END IF
                  CALL asft300_b_fill()
                  LET g_rec_b = g_sfba_d.getLength()               
               END IF
               #160701-00010#1 -e add 
            ELSE
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = "std-00006"
               LET g_errparam.extend = 'INSERT'
               LET g_errparam.popup = TRUE
               CALL cl_err()

               INITIALIZE g_sfac_d[l_ac].* TO NULL
               CALL s_transaction_end('N','0')
               CANCEL INSERT
            END IF

         BEFORE DELETE                            #是否取消單身
            IF NOT cl_null(g_sfac_d[l_ac].sfac001) THEN
               #160503-00004 by whitney add start
               IF g_sfac_d[l_ac].sfac002 = '1' THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'asf-00114'
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  CANCEL DELETE
               END IF
               #160503-00004 by whitney add end
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code =  -263
                  LET g_errparam.extend = ""
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  CANCEL DELETE
               END IF

               DELETE FROM sfac_t
                WHERE sfacent = g_enterprise
                  AND sfacsite= g_site
                  AND sfacdocno = g_sfaa_m.sfaadocno
                  AND sfacseq = g_sfac_d[l_ac].sfacseq
                  AND sfac001 = g_sfac_d[l_ac].sfac001
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "sfac_t"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  CALL s_transaction_end('N','0')
                  CANCEL DELETE
               ELSE
                  LET g_rec_b = g_rec_b-1
                  CALL s_transaction_end('Y','0')
               END IF
               CLOSE asft300_sfac_bcl
               LET l_count = g_sfac_d.getLength()
            END IF

         ON ROW CHANGE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 9001
               LET g_errparam.extend = ''
               LET g_errparam.popup = FALSE
               CALL cl_err()

               LET INT_FLAG = 0
               LET g_sfac_d[l_ac].* = g_sfac_d_t.*
               CLOSE asft300_sfac_bcl
               CALL s_transaction_end('N','0')
               EXIT DIALOG
            END IF
            
            IF g_sfac_d[l_ac].sfac002 != '1' THEN

            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = -263
               LET g_errparam.extend = g_sfac_d[l_ac].sfac001
               LET g_errparam.popup = TRUE
               CALL cl_err()

               LET g_sfac_d[l_ac].* = g_sfac_d_t.*
            ELSE
               IF cl_null(g_sfac_d[l_ac].sfac006) THEN
                  LET g_sfac_d[l_ac].sfac006 = ' '
               END IF
               SELECT COUNT(1) INTO l_count FROM sfac_t
                WHERE sfacent = g_enterprise
                  AND sfacsite = g_site
                  AND sfacdocno = g_sfaa_m.sfaadocno
                  AND sfac001 = g_sfac_d[l_ac].sfac001
                  AND sfac006 = g_sfac_d[l_ac].sfac006
               IF l_count <= 1 THEN
                  UPDATE sfac_t SET (sfacent,sfacsite,sfacdocno,sfac001,sfac002,sfac003,sfac004,sfac005,sfac006) = (g_enterprise,g_site,g_sfaa_m.sfaadocno,g_sfac_d[l_ac].sfac001,g_sfac_d[l_ac].sfac002,g_sfac_d[l_ac].sfac003,g_sfac_d[l_ac].sfac004,g_sfac_d[l_ac].sfac005,g_sfac_d[l_ac].sfac006)
                   WHERE sfacent = g_enterprise
                     AND sfacsite = g_site
                     AND sfacdocno = g_sfaa_m.sfaadocno
                     AND sfacseq = g_sfac_d_t.sfacseq
                     AND sfac001 = g_sfac_d_t.sfac001
                
                  CASE
                     WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                        INITIALIZE g_errparam TO NULL
                        LET g_errparam.code = "std-00009"
                        LET g_errparam.extend = "sfac_t"
                        LET g_errparam.popup = TRUE
                        CALL cl_err()
                
                        CALL s_transaction_end('N','0')
                        LET g_sfac_d[l_ac].* = g_sfac_d_t.*
                     WHEN SQLCA.sqlcode #其他錯誤
                        INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = "sfac_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
                
                        LET g_sfac_d[l_ac].* = g_sfac_d_t.*
                        CALL s_transaction_end('N','0')
                     OTHERWISE
                        #161228-00073#1-s-add
#                        SELECT SUM(sfac003) INTO l_sfac003_sum
#                          FROM sfac_t
#                         WHERE sfacent = g_enterprise
#                           AND sfacdocno = g_sfaa_m.sfaadocno
#                           AND sfac002 IN ('1','2')
#                        
#                        UPDATE sfaa_t SET sfaa012 = l_sfac003_sum
#                         WHERE sfaaent = g_enterprise
#                           AND sfaasite = g_site
#                           AND sfaadocno = g_sfaa_m.sfaadocno
#                        
#                        CASE
#                           WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
#                              INITIALIZE g_errparam TO NULL
#                              LET g_errparam.code = "std-00009"
#                              LET g_errparam.extend = "sfaa_t"
#                              LET g_errparam.popup = TRUE
#                              CALL cl_err()                           
#                              CALL s_transaction_end('N','0')
#                              LET g_sfac_d[l_ac].* = g_sfac_d_t.*
#                           WHEN SQLCA.sqlcode #其他錯誤
#                              INITIALIZE g_errparam TO NULL
#                              LET g_errparam.code = SQLCA.sqlcode
#                              LET g_errparam.extend = "sfaa_t"
#                              LET g_errparam.popup = TRUE
#                              CALL cl_err()
#                           
#                              LET g_sfac_d[l_ac].* = g_sfac_d_t.*
#                              CALL s_transaction_end('N','0')
#                        END CASE
#                        LET g_sfaa_m.sfaa012 = l_sfac003_sum
#                        DISPLAY BY NAME g_sfaa_m.sfaa012
                        #161228-00073#1-e-add
                        CALL s_transaction_end('Y','0')
                        ERROR 'UPDATE O.K'
                  END CASE
               END IF
            END IF
            END IF

         BEFORE FIELD sfacseq
            IF cl_null(g_sfac_d[l_ac].sfacseq) OR g_sfac_d[l_ac].sfacseq = 0  THEN 
               SELECT MAX(sfacseq)+1 INTO g_sfac_d[l_ac].sfacseq FROM sfac_t
                WHERE sfacent = g_enterprise
                  AND sfacsite = g_site
                  AND sfacdocno = g_sfaa_m.sfaadocno
               IF cl_null(g_sfac_d[l_ac].sfacseq) THEN
                  LET g_sfac_d[l_ac].sfacseq = 1
               END IF                
            END IF
            
         AFTER FIELD sfacseq
            IF NOT cl_ap_chk_Range(g_sfac_d[l_ac].sfacseq,"0","0","","","azz-00079",1) THEN
               LET g_sfac_d[l_ac].sfacseq = g_sfac_d_t.sfacseq
               NEXT FIELD sfacseq
            END IF

            IF  NOT cl_null(g_sfaa_m.sfaadocno) AND NOT cl_null(g_sfac_d[l_ac].sfacseq) THEN
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_sfaa_m.sfaadocno != g_sfaadocno_t OR g_sfac_d[l_ac].sfacseq != g_sfac_d_t.sfacseq)) THEN
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM sfac_t WHERE "||"sfacent = '" ||g_enterprise|| "' AND sfacsite = '" ||g_site|| "' AND "||"sfacdocno = '"||g_sfaa_m.sfaadocno ||"' AND "|| "sfacseq = '"||g_sfac_d[l_ac].sfacseq ||"'",'std-00004',0) THEN
                     LET g_sfac_d[l_ac].sfacseq = g_sfac_d_t.sfacseq
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
            
         #此段落由子樣板a02產生
         AFTER FIELD sfac002
            IF NOT cl_null(g_sfac_d[l_ac].sfac002) AND (g_sfac_d[l_ac].sfac002 != g_sfac_d_t.sfac002 OR cl_null(g_sfac_d_t.sfac002)) THEN
               IF g_sfaa_m.sfaa003 = '3' THEN
                  IF g_sfac_d[l_ac].sfac002 != '4' THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = 'asf-00049'
                     LET g_errparam.extend = g_sfac_d[l_ac].sfac002
                     LET g_errparam.popup = TRUE
                     CALL cl_err()
             
                     LET g_sfac_d[l_ac].sfac002 = g_sfac_d_t.sfac002
                     NEXT FIELD sfac002
                  END IF 
               END IF
               IF l_cmd = 'a' AND g_sfac_d[l_ac].sfac002 = '1' THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'asf-00114'
                  LET g_errparam.extend = g_sfac_d[l_ac].sfac002
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
             
                  LET g_sfac_d[l_ac].sfac002 = g_sfac_d_t.sfac002
                  NEXT FIELD sfac002
               END IF 
             
               CALL asft300_set_entry_sfac()
            END IF
            
         #此段落由子樣板a02產生
         AFTER FIELD sfac001
            #170225-00003#1-s
            #IF NOT cl_null(g_sfac_d[l_ac].sfac001) AND (cl_null(g_sfac_d_t.sfac001) OR g_sfac_d_t.sfac001 !=g_sfac_d[l_ac].sfac001) THEN
            IF NOT cl_null(g_sfac_d[l_ac].sfac001) THEN
               IF cl_null(g_sfac_d_o.sfac001) OR g_sfac_d_o.sfac001 !=g_sfac_d[l_ac].sfac001 THEN
                  CALL asft300_sfac001_chk() RETURNING l_success,l_imaa005_1
                  IF NOT l_success THEN
                     LET g_sfac_d[l_ac].sfac001 = g_sfac_d_o.sfac001
                     CALL s_desc_get_item_desc(g_sfac_d[l_ac].sfac001) RETURNING g_sfac_d[l_ac].sfac001_desc,g_sfac_d[l_ac].sfac001_desc1
                     NEXT FIELD sfac001
                  END IF
            #      #160523-00052#1-s
            #      CALL s_aooi200_get_slip(g_sfaa_m.sfaadocno) RETURNING l_success,l_ooba002
            #      LET l_flag = cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0024')
            #      IF l_flag <> '2' THEN
            #      #160523-00052#1-e
            #         IF g_sfaa_m.sfaa003 MATCHES '[145]' THEN
            #            LET l_m = 0
            #            IF g_sfac_d[l_ac].sfac002 = '2' THEN
            #               SELECT COUNT(1) INTO l_m FROM bmab_t
            #                WHERE bmabent = g_enterprise AND bmabsite = g_site 
            #                  AND bmab001 = g_sfaa_m.sfaa010 AND bmab002 = g_sfaa_m.sfaa011 AND bmab003 = g_sfac_d[l_ac].sfac001
            #            END IF 
            #            IF g_sfac_d[l_ac].sfac002 = '3' THEN
            #               SELECT COUNT(1) INTO l_m FROM bmad_t
            #                WHERE bmadent = g_enterprise AND bmadsite = g_site 
            #                  AND bmad001 = g_sfaa_m.sfaa010 AND bmad002 = g_sfaa_m.sfaa011 AND bmad003 = g_sfac_d[l_ac].sfac001
            #            END IF 
            #            IF g_sfac_d[l_ac].sfac002 = '5' THEN
            #               SELECT COUNT(1) INTO l_m FROM bmac_t
            #                WHERE bmacent = g_enterprise AND bmacsite = g_site 
            #                  AND bmac001 = g_sfaa_m.sfaa010 AND bmac002 = g_sfaa_m.sfaa011 AND bmac003 = g_sfac_d[l_ac].sfac001
            #            END IF 
            #            IF l_m = 0 THEN
            #               INITIALIZE g_errparam TO NULL
            #               LET g_errparam.code = 'asf-00050'
            #               LET g_errparam.extend = g_sfac_d[l_ac].sfac001
            #               LET g_errparam.popup = TRUE
            #               CALL cl_err()
            #               IF l_flag = '1' THEN  #160523-00052#1
            #                  LET g_sfac_d[l_ac].sfac001 = g_sfac_d_t.sfac001
            #                  NEXT FIELD sfac001
            #               END IF  #160523-00052#1
            #            END IF
            #         END IF
            #      END IF  #160523-00052#1
            #      #特征管理
            #      SELECT imaa005 INTO l_imaa005_1 FROM imaa_t WHERE imaaent = g_enterprise AND imaa001 = g_sfac_d[l_ac].sfac001
            #      IF g_sfac_d[l_ac].sfac002 = '2' THEN
            #         SELECT imaa005 INTO l_imaa005 FROM imaa_t WHERE imaaent = g_enterprise AND imaa001 = g_sfaa_m.sfaa010                 
            #         IF NOT cl_null(l_imaa005) THEN
            #            IF cl_null(l_imaa005_1) OR l_imaa005 != l_imaa005_1 THEN
            #               INITIALIZE g_errparam TO NULL
            #               LET g_errparam.code = ''
            #               LET g_errparam.extend = g_sfac_d[l_ac].sfac001
            #               LET g_errparam.popup = TRUE
            #               CALL cl_err()
            #               LET g_sfac_d[l_ac].sfac001 = g_sfac_d_t.sfac001
            #               NEXT FIELD sfac001
            #            END IF
            #         END IF
            #      END IF
            #170225-00003#1-e
                  IF s_feature_auto_chk(g_sfac_d[l_ac].sfac001) THEN    #160314-00009#16  add           
                     IF NOT cl_null(l_imaa005_1) THEN
                        IF l_cmd = 'a' THEN
                           CALL l_inam.clear()          
                           CALL s_feature_multi(g_sfac_d[l_ac].sfac001,'','',g_site,g_sfaa_m.sfaadocno) RETURNING l_success,l_inam
                           LET g_sfac_d[l_ac].sfac006 = l_inam[1].inam002
                           LET g_sfac_d[l_ac].sfac003 = l_inam[1].inam004
                        END IF
                     END IF
                  END IF   #160314-00009#16  add
                  #检查产品特征
                  IF NOT cl_null(g_sfac_d[l_ac].sfac006) THEN                 
                     IF NOT s_feature_check(g_sfac_d[l_ac].sfac001,g_sfac_d[l_ac].sfac006) THEN
                        LET g_sfac_d[l_ac].sfac006 = g_sfac_d_t.sfac006
                        NEXT FIELD sfac006
                     END IF
                     #显示产品特征说明
                     CALL s_feature_description(g_sfac_d[l_ac].sfac001,g_sfac_d[l_ac].sfac006)
                        RETURNING l_success,g_sfac_d[l_ac].sfac006_desc
                     IF NOT l_success THEN
                        LET g_sfac_d[l_ac].sfac006_desc = ''
                     END IF
                  ELSE 
                     LET g_sfac_d[l_ac].sfac006_desc = ''
                  END IF
                  DISPLAY BY NAME g_sfac_d[l_ac].sfac006_desc
               #END IF  #170225-00003#1
                  #单位为空
                  IF cl_null(g_sfac_d[l_ac].sfac004) THEN
                     SELECT imae016 INTO g_sfac_d[l_ac].sfac004 FROM imae_t 
                      WHERE imaeent = g_enterprise AND imaesite = g_site AND imae001 = g_sfac_d[l_ac].sfac001
                     IF cl_null(g_sfac_d[l_ac].sfac004) THEN
                        SELECT imaa006 INTO g_sfac_d[l_ac].sfac004 FROM imaa_t 
                         WHERE imaaent = g_enterprise AND imaa001 = g_sfac_d[l_ac].sfac001
                     END IF
                  END IF
            #170225-00003#1-s
               END IF
            END IF
            LET g_sfac_d_o.sfac001 = g_sfac_d[l_ac].sfac001
            #170225-00003#1-e

         ON ACTION controlp INFIELD sfac001
            INITIALIZE g_qryparam.* TO NULL
            LET g_qryparam.state = 'i'
            LET g_qryparam.reqry = FALSE
            LET g_qryparam.default1 = g_sfac_d[l_ac].sfac001  #給予default值
            #CALL q_imaa001()                                 #呼叫開窗  #170225-00003#1
            CALL q_imaf001_6()                                #170225-00003#1
            LET g_sfac_d[l_ac].sfac001 = g_qryparam.return1   #將開窗取得的值回傳到變數
            CALL s_desc_get_item_desc(g_sfac_d[l_ac].sfac001) RETURNING g_sfac_d[l_ac].sfac001_desc,g_sfac_d[l_ac].sfac001_desc1  #170225-00003#1
            NEXT FIELD sfac001                                #返回原欄位

         #此段落由子樣板a02產生
         AFTER FIELD sfac003
            IF g_sfac_d[l_ac].sfac003 < 0 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'agl-00041'
               LET g_errparam.extend = g_sfac_d[l_ac].sfac003
               LET g_errparam.popup = FALSE
               CALL cl_err()

               LET g_sfac_d[l_ac].sfac003 = g_sfac_d_t.sfac003
               NEXT FIELD sfac003
            END IF 
            #单位取位
            IF NOT cl_null(g_sfac_d[l_ac].sfac004) THEN
               CALL s_aooi250_take_decimals(g_sfac_d[l_ac].sfac004,g_sfac_d[l_ac].sfac003)
                    RETURNING l_success,g_sfac_d[l_ac].sfac003
            END IF
            
         AFTER FIELD sfac006
            IF NOT cl_null(g_sfac_d[l_ac].sfac001) AND NOT cl_null(g_sfac_d[l_ac].sfac006) THEN
             #20150906 by wuxja mark  --begin--
             # SELECT COUNT(1) INTO l_n FROM sfac_t 
             #  WHERE sfacent = g_enterprise AND sfacsite = g_site AND sfacdocno = g_sfaa_m.sfaadocno
             #    AND sfac006 = g_sfac_d[l_ac].sfac006 AND sfac002 = '1'
             # IF l_n = 0 THEN
             #    INITIALIZE g_errparam TO NULL
             #    LET g_errparam.code = ''
             #    LET g_errparam.extend = g_sfac_d[l_ac].sfac006
             #    LET g_errparam.popup = TRUE
             #    CALL cl_err()
             #
             #    LET g_sfac_d[l_ac].sfac006 = g_sfac_d_t.sfac006
             #    NEXT FIELD sfac006
             # END IF
             #20150906 by wuxja mark  --end--
             
               #检查产品特征
               IF NOT s_feature_check(g_sfac_d[l_ac].sfac001,g_sfac_d[l_ac].sfac006) THEN
                  LET g_sfac_d[l_ac].sfac006 = g_sfac_d_t.sfac006
                  NEXT FIELD sfac006
               END IF
               #--151224-00025#4 add start--
               IF NOT s_feature_direct_input(g_sfac_d[l_ac].sfac001,g_sfac_d[l_ac].sfac006,g_sfac_d_t.sfac006,g_sfaa_m.sfaadocno,g_site) THEN
                  NEXT FIELD CURRENT
               END IF
               #--151224-00025#4 add end--
               #显示产品特征说明
               CALL s_feature_description(g_sfac_d[l_ac].sfac001,g_sfac_d[l_ac].sfac006)
                  RETURNING l_success,g_sfac_d[l_ac].sfac006_desc
               IF NOT l_success THEN
                  LET g_sfac_d[l_ac].sfac006_desc = ''
               END IF
            ELSE 
               LET g_sfac_d[l_ac].sfac006_desc = ''
            END IF

            DISPLAY BY NAME g_sfac_d[l_ac].sfac006_desc
           
         ON ACTION controlp INFIELD sfac006
            #料号做特征管理
            SELECT imaa005 INTO l_imaa005_1 FROM imaa_t WHERE imaaent = g_enterprise AND imaa001 = g_sfac_d[l_ac].sfac001
            IF NOT cl_null(l_imaa005_1) THEN
               IF l_cmd = 'a' THEN 
                  CALL l_inam.clear()          
                  CALL s_feature_multi(g_sfac_d[l_ac].sfac001,'','',g_site,g_sfaa_m.sfaadocno) RETURNING l_success,l_inam
                  LET g_sfac_d[l_ac].sfac006 = l_inam[1].inam002
                  LET g_sfac_d[l_ac].sfac003 = l_inam[1].inam004                   
               END IF
               IF l_cmd = 'u' THEN
                  CALL s_feature_single(g_sfac_d[l_ac].sfac001,g_sfac_d[l_ac].sfac006,g_site,g_sfaa_m.sfaadocno)
                     RETURNING l_success,g_sfac_d[l_ac].sfac006
               END IF
            END IF
            
         AFTER INPUT 
            #160202 by whitney add (s)
            LET l_m = 0
            SELECT COUNT(1) INTO l_m FROM sfac_t
             WHERE sfacent = g_enterprise AND sfacdocno = g_sfaa_m.sfaadocno AND sfac002 = '3'
            IF g_sfaa_m.sfaa003 != '3' AND l_m = 0 THEN
            #160202 by whitney add (e)
            #IF g_sfaa_m.sfaa003 != '3' THEN  #160202 by whitney mark
               DECLARE asft300_input_chk_sfac_cs CURSOR FOR 
               #161109-00085#27-s
               #SELECT * FROM sfac_t
               #SELECT sfacent,sfacsite,sfacdocno,sfac001,sfac002,sfac003,sfac004,sfac005,sfacseq,sfac006,sfac007 #161109-00085#66 mark
               SELECT sfacent,sfacsite,sfacdocno,sfac001,sfac002,
                      sfac003,sfac004,sfac005,sfacseq,sfac006,
                      sfacud001,sfacud002,sfacud003,sfacud004,sfacud005,
                      sfacud006,sfacud007,sfacud008,sfacud009,sfacud010,
                      sfacud011,sfacud012,sfacud013,sfacud014,sfacud015,
                      sfacud016,sfacud017,sfacud018,sfacud019,sfacud020,
                      sfacud021,sfacud022,sfacud023,sfacud024,sfacud025,
                      sfacud026,sfacud027,sfacud028,sfacud029,sfacud030,
                      sfac007              
                 FROM sfac_t
                 WHERE sfacent = g_enterprise
                   AND sfacdocno = g_sfaa_m.sfaadocno
                   AND (sfac002 = '1' OR sfac002 = '2')
               LET l_sfac003_sum = 0
               #FOREACH asft300_input_chk_sfac_cs INTO l_sfac.*
               FOREACH asft300_input_chk_sfac_cs 
               #161109-00085#66 --s mark
               #   INTO l_sfac.sfacent,l_sfac.sfacsite,l_sfac.sfacdocno,l_sfac.sfac001,l_sfac.sfac002,
               #        l_sfac.sfac003,l_sfac.sfac004,l_sfac.sfac005,l_sfac.sfacseq,l_sfac.sfac006,
               #        l_sfac.sfac007
               #161109-00085#66 --e mark
               #161109-00085#66 --s add
                  INTO l_sfac.sfacent,l_sfac.sfacsite,l_sfac.sfacdocno,l_sfac.sfac001,l_sfac.sfac002,
                       l_sfac.sfac003,l_sfac.sfac004,l_sfac.sfac005,l_sfac.sfacseq,l_sfac.sfac006,
                       l_sfac.sfacud001,l_sfac.sfacud002,l_sfac.sfacud003,l_sfac.sfacud004,l_sfac.sfacud005,
                       l_sfac.sfacud006,l_sfac.sfacud007,l_sfac.sfacud008,l_sfac.sfacud009,l_sfac.sfacud010,
                       l_sfac.sfacud011,l_sfac.sfacud012,l_sfac.sfacud013,l_sfac.sfacud014,l_sfac.sfacud015,
                       l_sfac.sfacud016,l_sfac.sfacud017,l_sfac.sfacud018,l_sfac.sfacud019,l_sfac.sfacud020,
                       l_sfac.sfacud021,l_sfac.sfacud022,l_sfac.sfacud023,l_sfac.sfacud024,l_sfac.sfacud025,
                       l_sfac.sfacud026,l_sfac.sfacud027,l_sfac.sfacud028,l_sfac.sfacud029,l_sfac.sfacud030,
                       l_sfac.sfac007
               #161109-00085#66 --e add
               #161109-00085#27-e
                  CALL s_aooi250_convert_qty(l_sfac.sfac001,l_sfac.sfac004,g_sfaa_m.sfaa013,l_sfac.sfac003) 
                       RETURNING l_success,l_sfac003
                  IF NOT l_success THEN
                     LET l_sfac003 = l_sfac.sfac003
                  END IF
                  LET l_sfac003_sum = l_sfac003_sum + l_sfac003
               END FOREACH
               IF l_sfac003_sum != g_sfaa_m.sfaa012 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'asf-00476'
                  LET g_errparam.extend = ''
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
                  NEXT FIELD sfac003
               END IF
            END IF

      END INPUT
      
      
      INPUT ARRAY g_sfaf_d FROM s_sfaf.*
          ATTRIBUTE(COUNT = g_rec_b,MAXCOUNT = g_max_rec,WITHOUT DEFAULTS,
                  INSERT ROW = l_allow_insert,
                  DELETE ROW = l_allow_delete,
                  APPEND ROW = l_allow_insert)
                  
         BEFORE INPUT
            IF g_insert = 'Y' AND NOT cl_null(g_insert) THEN
               CALL FGL_SET_ARR_CURR(g_sfaf_d.getLength()+1)
               LET g_insert = 'N'
            END IF

            CALL asft300_b_fill_sfaf()
            LET g_rec_b = g_sfaf_d.getLength()
            
         BEFORE ROW
            LET l_insert = FALSE
            LET l_cmd = ''
            LET l_ac_t = l_ac 
            LET g_detail_idx_list[4] = l_ac
            LET l_ac = ARR_CURR()
            LET g_detail_idx = l_ac
            LET g_current_page = 6

            LET l_lock_sw = 'N'  

            CALL s_transaction_begin()
            OPEN asft300_cl USING g_enterprise, g_site,g_sfaa_m.sfaadocno

            IF STATUS THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code =  STATUS
               LET g_errparam.extend = "OPEN asft300_cl:"
               LET g_errparam.popup = TRUE
               CALL cl_err()

               CLOSE asft300_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF

         #   LET g_rec_b = g_sfaf_d.getLength()

            IF g_rec_b >= l_ac AND g_sfaf_d[l_ac].sfaf001 IS NOT NULL THEN
               LET l_cmd='u'
               LET g_sfaf_d_t.* = g_sfaf_d[l_ac].*  #BACKUP
               OPEN asft300_sfaf_bcl USING g_enterprise,g_site,g_sfaa_m.sfaadocno,g_sfaf_d[l_ac].sfafseq
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "OPEN asft300_sfaf_bcl"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  LET l_lock_sw='Y'
               ELSE
                  FETCH asft300_sfaf_bcl INTO g_sfaf_d[l_ac].sfafseq,g_sfaf_d[l_ac].sfaf001
                  IF SQLCA.sqlcode THEN
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = SQLCA.sqlcode
                     LET g_errparam.extend = g_sfaf_d_t.sfaf001
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     LET l_lock_sw = "Y"
                  END IF
               #  CALL asft300_show_sfaf_desc(l_ac)
                  CALL cl_show_fld_cont()
               END IF
            ELSE
               LET l_cmd='a'
            END IF
            
         BEFORE INSERT
            LET l_insert = TRUE
            LET l_n = ARR_COUNT()
            LET l_cmd = 'a'
            CALL s_transaction_begin()  #160407-00017#1 add
            INITIALIZE g_sfaf_d[l_ac].* TO NULL

            LET g_sfaf_d_t.* = g_sfaf_d[l_ac].*     #新輸入資料
            CALL cl_show_fld_cont()
            NEXT FIELD sfafseq
                  
         AFTER INSERT
            LET l_insert = FALSE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 9001
               LET g_errparam.extend = ''
               LET g_errparam.popup = FALSE
               CALL cl_err()

               LET INT_FLAG = 0
               CANCEL INSERT
            END IF

            SELECT COUNT(1) INTO l_count FROM sfaf_t
             WHERE sfafent = g_enterprise
               AND sfafsite = g_site
               AND sfafdocno = g_sfaa_m.sfaadocno
               AND sfafseq = g_sfaf_d[l_ac].sfafseq
               AND sfaf001 = g_sfaf_d[l_ac].sfaf001

            #資料未重複, 插入新增資料
            IF l_count = 0 THEN
               INSERT INTO sfaf_t(sfafent,sfafsite,sfafdocno,sfafseq,sfaf001)
               VALUES(g_enterprise,g_site,g_sfaa_m.sfaadocno,g_sfaf_d[l_ac].sfafseq,g_sfaf_d[l_ac].sfaf001)
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "INSERT sfaf_t"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  CALL s_transaction_end('N','0')
                  CANCEL INSERT
               ELSE
                  CALL s_transaction_end('Y','0')
                  ERROR 'INSERT O.K'
                  LET g_rec_b=g_rec_b+1
               END IF
            ELSE
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = "std-00006"
               LET g_errparam.extend = 'INSERT'
               LET g_errparam.popup = TRUE
               CALL cl_err()

               INITIALIZE g_sfaf_d[l_ac].* TO NULL
               CALL s_transaction_end('N','0')
               CANCEL INSERT
            END IF

         BEFORE DELETE                            #是否取消單身
            IF NOT cl_null(g_sfaf_d[l_ac].sfaf001) THEN
               IF NOT cl_ask_del_detail() THEN
                  CANCEL DELETE
               END IF
               IF l_lock_sw = "Y" THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code =  -263
                  LET g_errparam.extend = ""
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  CANCEL DELETE
               END IF

               DELETE FROM sfaf_t
                WHERE sfafent = g_enterprise
                  AND sfafsite= g_site
                  AND sfafdocno = g_sfaa_m.sfaadocno
                  AND sfafseq = g_sfaf_d[l_ac].sfafseq
                  AND sfaf001 = g_sfaf_d[l_ac].sfaf001
               IF SQLCA.sqlcode THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "sfaf_t"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  CALL s_transaction_end('N','0')
                  CANCEL DELETE
               ELSE
                  LET g_rec_b = g_rec_b-1
                  CALL s_transaction_end('Y','0')
               END IF
               CLOSE asft300_sfaf_bcl
               LET l_count = g_sfaf_d.getLength()
            END IF

         ON ROW CHANGE
            IF INT_FLAG THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 9001
               LET g_errparam.extend = ''
               LET g_errparam.popup = FALSE
               CALL cl_err()

               LET INT_FLAG = 0
               LET g_sfaf_d[l_ac].* = g_sfaf_d_t.*
               CLOSE asft300_sfaf_bcl
               CALL s_transaction_end('N','0')
               EXIT DIALOG
            END IF

            IF l_lock_sw = 'Y' THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = -263
               LET g_errparam.extend = g_sfaf_d[l_ac].sfaf001
               LET g_errparam.popup = TRUE
               CALL cl_err()

               LET g_sfaf_d[l_ac].* = g_sfaf_d_t.*
            ELSE
               UPDATE sfaf_t SET (sfafent,sfafsite,sfafdocno,sfafseq,sfaf001) = (g_enterprise,g_site,g_sfaa_m.sfaadocno,g_sfaf_d[l_ac].sfafseq,g_sfaf_d[l_ac].sfaf001)
                WHERE sfafent = g_enterprise
                  AND sfafsite = g_site
                  AND sfafdocno = g_sfaa_m.sfaadocno
                  AND sfafseq = g_sfaf_d_t.sfafseq
                  AND sfaf001 = g_sfaf_d_t.sfaf001

               CASE
                  WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
                     INITIALIZE g_errparam TO NULL
                     LET g_errparam.code = "std-00009"
                     LET g_errparam.extend = "sfaf_t"
                     LET g_errparam.popup = TRUE
                     CALL cl_err()

                     CALL s_transaction_end('N','0')
                     LET g_sfaf_d[l_ac].* = g_sfaf_d_t.*
                  WHEN SQLCA.sqlcode #其他錯誤
                     INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = SQLCA.sqlcode
                  LET g_errparam.extend = "sfaf_t"
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                     LET g_sfaf_d[l_ac].* = g_sfaf_d_t.*
                     CALL s_transaction_end('N','0')
                  OTHERWISE
                     CALL s_transaction_end('Y','0')
                     ERROR 'UPDATE O.K'
               END CASE
            END IF

         BEFORE FIELD sfafseq
            IF cl_null(g_sfaf_d[l_ac].sfafseq) OR g_sfaf_d[l_ac].sfafseq = 0  THEN 
               SELECT MAX(sfafseq)+1 INTO g_sfaf_d[l_ac].sfafseq FROM sfaf_t
                WHERE sfafent = g_enterprise
                  AND sfafsite = g_site
                  AND sfafdocno = g_sfaa_m.sfaadocno
               IF cl_null(g_sfaf_d[l_ac].sfafseq) THEN
                  LET g_sfaf_d[l_ac].sfafseq = 1
               END IF                
            END IF
            
         AFTER FIELD sfafseq
            IF NOT cl_ap_chk_Range(g_sfaf_d[l_ac].sfafseq,"0","0","","","azz-00079",1) THEN
               LET g_sfaf_d[l_ac].sfafseq = g_sfaf_d_t.sfafseq
               NEXT FIELD sfafseq
            END IF

            IF  NOT cl_null(g_sfaa_m.sfaadocno) AND NOT cl_null(g_sfaf_d[l_ac].sfafseq) THEN
               IF l_cmd = 'a' OR ( l_cmd = 'u' AND (g_sfaa_m.sfaadocno != g_sfaadocno_t OR g_sfaf_d[l_ac].sfafseq != g_sfaf_d_t.sfafseq)) THEN
                  IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM sfaf_t WHERE "||"sfafent = '" ||g_enterprise|| "' AND sfafsite = '" ||g_site|| "' AND "||"sfafdocno = '"||g_sfaa_m.sfaadocno ||"' AND "|| "sfafseq = '"||g_sfaf_d[l_ac].sfafseq ||"'",'std-00004',0) THEN
                     LET g_sfaf_d[l_ac].sfafseq = g_sfaf_d_t.sfafseq
                     NEXT FIELD CURRENT
                  END IF
               END IF
            END IF
             

         #----<<sfaf001>>----
         #此段落由子樣板a01產生
         BEFORE FIELD sfaf001
            #add-point:BEFORE FIELD sfaf001
            
            #END add-point

         #此段落由子樣板a02產生
         AFTER FIELD sfaf001

            #add-point:AFTER FIELD sfaf001
            IF NOT cl_null(g_sfaf_d[l_ac].sfaf001) AND (cl_null(g_sfaf_d_t.sfaf001) OR g_sfaf_d[l_ac].sfaf001 != g_sfaf_d_t.sfaf001) THEN
               SELECT COUNT(1) INTO l_n FROM sfaf_t WHERE sfafent=g_enterprise AND sfafdocno=g_sfaa_m.sfaadocno AND sfafsite=g_site AND sfaf001=g_sfaf_d[l_ac].sfaf001 
               IF l_n > 0 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'std-00004'
                  LET g_errparam.extend = g_sfaf_d[l_ac].sfaf001
                  LET g_errparam.popup = TRUE
                  CALL cl_err()

                  LET g_sfaf_d[l_ac].sfaf001=g_sfaf_d_t.sfaf001
                  NEXT FIELD sfaf001
               END IF
            END IF
            #END add-point


         #Ctrlp:construct.c.sfaf001
#         ON ACTION controlp INFIELD sfaf001
            #add-point:ON ACTION controlp INFIELD sfaf001
            
            #END add-point

      END INPUT
      
      SUBDIALOG aoo_aooi360_01.aooi360_01_input   #备注单身  #161031-00025#17 add 
      
      BEFORE DIALOG
         #add-point:input段before dialog
         #161031-00025#17-s
         #為了修改功能doubleClick可以直接進入單身, 需指定要進入哪一個單身
         IF NOT cl_null(p_cmd) AND p_cmd != 'a' THEN
            CASE g_aw
               WHEN "s_detail1_aooi360_01"
                  NEXT FIELD ooff012     
            END CASE
         END IF
         #161031-00025#17-e
         #end add-point
         #新增時強制從單頭開始填
         IF l_flag0 = 'N' THEN
            LET l_flag0 = 'Y'
            NEXT FIELD sfabseq
         END IF
         
         IF l_flag3 = 'N' THEN
            LET l_flag3 = 'Y'
            NEXT FIELD sfaf001
         END IF
         IF p_cmd = 'a' THEN
            NEXT FIELD sfaadocno
         END IF
        #20150730 by wuxja add  --begin--
         IF l_flag2 = '1' THEN
            NEXT FIELD sfacseq
         END IF
        #20150730 by wuxja add  --end--
         
      AFTER DIALOG
         
      ON ACTION produce_no
         LET g_action_choice="produce_no"
         IF cl_auth_chk_act("produce_no") THEN
            IF NOT cl_null(g_sfaa_m.sfaadocno) THEN
               CALL asft300_04(g_sfaa_m.sfaadocno)
               CALL asft300_b_fill_sfaf()
               LET g_rec_b = g_sfaf_d.getLength()
               LET l_flag3 = 'N'
               EXIT DIALOG
            END IF 
         END IF 

     #20150730 by wuxja  --begin--
      ON ACTION open_asft300_07
         LET g_action_choice="open_asft300_07"
         IF cl_auth_chk_act("open_asft300_07") THEN
            IF g_sfaa_m.sfaastus = 'N' AND g_sfaa_m.sfaa003 = '3' THEN
               IF g_inam.getLength() > 0 THEN
                  CALL asft300_07(g_sfaa_m.sfaadocno,g_inam) RETURNING l_flag2
               ELSE
                  IF asft300_sfaa010_feature() THEN
                     CALL asft300_07(g_sfaa_m.sfaadocno,g_inam) RETURNING l_flag2
                  END IF
               END IF
               IF l_flag2 = '1' THEN
                  EXIT DIALOG
               END IF
               CALL asft300_b_fill_sfac()                     
               LET l_flag2 = ''
            END IF
         END IF
     #20150730 by wuxja  --end--
     
      #170317-00042#1 add --(S)--
      ON ACTION po_gen
         LET g_action_choice="po_gen"
         IF cl_auth_chk_act("po_gen") THEN
            IF g_sfaa_m.sfaa005 = '1' AND NOT cl_null(g_sfaa_m.sfaadocno) AND g_sfaa_m.sfaastus = 'N' THEN
               LET l_n = 0
               SELECT COUNT(1) INTO l_n
                 FROM sfba_t
                WHERE sfbaent = g_enterprise
                  AND sfbasite = g_site
                  AND sfbadocno = g_sfaa_m.sfaadocno
               IF l_n > 0 THEN
                  INITIALIZE g_errparam TO NULL
                  LET g_errparam.code = 'asf-00329'
                  LET g_errparam.extend = g_sfaa_m.sfaadocno
                  LET g_errparam.popup = TRUE
                  CALL cl_err()
               ELSE
                  IF NOT cl_null(g_sfaa_m.sfaa010) THEN
                     SELECT imaf034 INTO g_sfaa_m.sfaa072
                       FROM imaf_t
                      WHERE imafent = g_enterprise
                        AND imafsite = g_site
                        AND imaf001 = g_sfaa_m.sfaa010
                     IF cl_null(g_sfaa_m.sfaa072) THEN
                        LET g_sfaa_m.sfaa072 = 'N'
                     END IF                     
                  END IF
                  IF p_cmd <> 'u' THEN
                     LET g_sfaa_m_t.sfaadocno = g_sfaa_m.sfaadocno
                     #自动编号
                     CALL s_aooi200_gen_docno(g_site,g_sfaa_m.sfaadocno,g_sfaa_m.sfaadocdt,g_prog)
                          RETURNING l_success,g_sfaa_m.sfaadocno
                     IF NOT l_success THEN
                        NEXT FIELD sfaadocno
                     ELSE
                        LET l_cnt = 0
                        SELECT COUNT(1) INTO l_cnt FROM sfaa_t
                         WHERE sfaaent = g_enterprise AND sfaasite = g_site AND sfaadocno = g_sfaa_m.sfaadocno
                        IF l_cnt = 0 THEN
                           INSERT INTO sfaa_t (sfaaent,sfaasite,sfaadocno,sfaa001,sfaadocdt,sfaa002,sfaa003,sfaa057,sfaa004,sfaastus,
                                               sfaa005,sfaa007,sfaa008,sfaa063,sfaa006,sfaa009,sfaa022,sfaa021,sfaa023,sfaa024,
                                               sfaa064,sfaa025,sfaa010,sfaa011,sfaa012,sfaa013,sfaa058,sfaa060,sfaa061,sfaa016,
                                               sfaa017,sfaa018,sfaa019,sfaa020,sfaa068,sfaa014,sfaa015,sfaa026,sfaa062,sfaa028,
                                               sfaa029,sfaa030,sfaa031,sfaa032,sfaa033,sfaa034,sfaa035,sfaa059,sfaa036,sfaa037,
                                               sfaa038,sfaa072,sfaa039,sfaa040,sfaa041,sfaa042,sfaa043,sfaa044,sfaa069,sfaa070,
                                               sfaa045,sfaa046,sfaa047,sfaa048,sfaa065,sfaa049,sfaa050,sfaa051,sfaa055,sfaa056,
                                               sfaaownid,sfaaowndp,sfaacrtid,sfaacrtdp,sfaacrtdt,sfaamodid,sfaamoddt,sfaacnfid,sfaacnfdt,sfaapstid,sfaapstdt)
                           VALUES (g_enterprise,g_site,g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.sfaadocdt,
                                   g_sfaa_m.sfaa002,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,
                                   g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,
                                   g_sfaa_m.sfaa009,g_sfaa_m.sfaa022,g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,g_sfaa_m.sfaa024,
                                   g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa012,
                                   g_sfaa_m.sfaa013,g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,
                                   g_sfaa_m.sfaa017,g_sfaa_m.sfaa018,g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,
                                   g_sfaa_m.sfaa014,g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,
                                   g_sfaa_m.sfaa029,g_sfaa_m.sfaa030,g_sfaa_m.sfaa031,g_sfaa_m.sfaa032,g_sfaa_m.sfaa033,
                                   g_sfaa_m.sfaa034,g_sfaa_m.sfaa035,g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,g_sfaa_m.sfaa037,
                                   g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,g_sfaa_m.sfaa041,
                                   g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,g_sfaa_m.sfaa070,
                                   g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,g_sfaa_m.sfaa065,
                                   g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,g_sfaa_m.sfaa056,
                                   g_sfaa_m.sfaaownid,g_sfaa_m.sfaaowndp,g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,
                                   g_sfaa_m.sfaamoddt,g_sfaa_m.sfaacnfid,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,g_sfaa_m.sfaapstdt) # DISK WRITE
                           IF SQLCA.sqlcode THEN
                              INITIALIZE g_errparam TO NULL
                              LET g_errparam.extend = "sfaa_t:",SQLERRMESSAGE
                              LET g_errparam.code   = SQLCA.sqlcode
                              LET g_errparam.popup  = TRUE
                              CALL cl_err()
                           END IF
                        END IF
                     END IF
                  END IF
                  CALL asft300_01(g_sfaa_m.sfaadocno)
                  #记录订单料件对应的产品特征
                  CALL g_inam.clear() 
                  LET g_inam004_sum = 0 
                  LET l_i = 1
                  DECLARE asft300_inam_c1 
                  CURSOR FOR SELECT xmdd001,xmdd002,sfab007
                               FROM sfab_t ,xmdd_t
                              WHERE sfabent=g_enterprise
                                AND sfabsite=g_site
                                AND sfabdocno=g_sfaa_m.sfaadocno
                                AND sfabent=xmddent
                                AND sfabsite=xmddsite
                                AND sfab002=xmdddocno
                                AND sfab003=xmddseq
                                AND sfab004=xmddseq1
                                AND sfab005=xmddseq2
                                         
                  FOREACH asft300_inam_c1 INTO l_inam001,l_inam002,l_inam004
                     LET g_inam[l_i].inam001 = l_inam001
                     LET g_inam[l_i].inam002 = l_inam002
                     LET g_inam[l_i].inam004 = l_inam004
                     LET l_i = l_i + 1
                     LET g_inam004_sum = g_inam004_sum+l_inam004
                  END FOREACH
                  LET l_cnt = 0
                  SELECT COUNT(1) INTO l_cnt FROM sfab_t
                   WHERE sfabent=g_enterprise AND sfabsite=g_site AND sfabdocno=g_sfaa_m.sfaadocno
                  IF l_cnt > 0 THEN
                     LET l_flag0 = 'N'
                     #重新取得與顯示完整單據資料(最新單據資料)
                     EXECUTE asft300_master_referesh USING g_sfaa_m.sfaadocno
                        INTO g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.oobal004,g_sfaa_m.sfaadocdt,g_sfaa_m.sfaa002,
                             g_sfaa_m.sfaa002_desc,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,
                             g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,
                             g_sfaa_m.sfaa009,g_sfaa_m.sfaa009_desc,g_sfaa_m.sfaa022,g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,
                             g_sfaa_m.sfaa024,g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,
                             g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1,g_sfaa_m.sfaa012,g_sfaa_m.sfaa013,g_sfaa_m.sfaa013_desc,
                             g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa060_desc,g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,
                             g_sfaa_m.sfaa016_desc,g_sfaa_m.sfaa017,g_sfaa_m.sfaa017_desc,g_sfaa_m.sfaa018,g_sfaa_m.sfaa018_desc,
                             g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,g_sfaa_m.sfaa068_desc,g_sfaa_m.sfaa014,
                             g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.imae020,g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,
                             g_sfaa_m.sfaa028_desc,g_sfaa_m.sfaa029,g_sfaa_m.sfaa029_desc,g_sfaa_m.sfaa030,g_sfaa_m.sfaa030_desc,
                             g_sfaa_m.sfaa031,g_sfaa_m.sfaa031_desc,g_sfaa_m.sfaa032,g_sfaa_m.sfaa033,g_sfaa_m.sfaa034,
                             g_sfaa_m.sfaa034_desc,g_sfaa_m.sfaa035,g_sfaa_m.sfaa035_desc,g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,
                             g_sfaa_m.sfaa037,g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,
                             g_sfaa_m.sfaa041,g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,
                             g_sfaa_m.sfaa070,g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,
                             g_sfaa_m.sfaa065,g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,
                             g_sfaa_m.sfaa056,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,                    
                             g_sfaa_m.sfaaowndp_desc,g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtid_desc,g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdp_desc,
                             g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,g_sfaa_m.sfaamodid_desc,g_sfaa_m.sfaamoddt,g_sfaa_m.sfaacnfid,
                             g_sfaa_m.sfaacnfid_desc,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,g_sfaa_m.sfaapstid_desc,g_sfaa_m.sfaapstdt
                     CALL asft300_show()
                           
                     #写入工单生产料号明细,拆件式不控管
                     IF g_sfaa_m.sfaa003 != '3' AND
                        NOT cl_null(g_sfaa_m.sfaa010) AND
                        g_sfaa_m.sfaa011 IS NOT NULL AND
                        p_cmd = 'a' AND l_flag1 = 'N' THEN
                        CALL asft300_ins_sfac()
                        LET l_flag1 = 'Y'
                     END IF
                           
                     IF g_sfaa_m.sfaa003 = '3' THEN
                        IF g_inam.getLength() > 0 THEN
                           CALL asft300_07(g_sfaa_m.sfaadocno,g_inam) RETURNING l_flag2
                        ELSE
                           IF asft300_sfaa010_feature() THEN
                              CALL asft300_07(g_sfaa_m.sfaadocno,g_inam) RETURNING l_flag2
                           END IF
                        END IF
                     END IF
                           
                     CALL s_transaction_end('Y','0')
                             
                     IF p_cmd = 'a' THEN
                        LET g_master_insert = TRUE
                     END IF                                
                             
                     LET p_cmd = 'u'
                     LET g_sfaadocno_t = g_sfaa_m.sfaadocno
                     LET g_sfaa_m.sfaamodid = g_user
                     LET g_sfaa_m.sfaamoddt = cl_get_current()
                           
                     SELECT imae035,(CASE imae014 WHEN '0' THEN '1' WHEN '1' THEN '2' END )
                       INTO g_sfaa_m.sfaa068,g_sfaa_m.sfaa004 
                       FROM imae_t WHERE imaeent=g_enterprise AND imaesite=g_site AND imae001=g_sfaa_m.sfaa010
                     #取成本中心說明
                     LET g_sfaa_m.sfaa068_desc = s_desc_get_department_desc(g_sfaa_m.sfaa068)
                     DISPLAY BY NAME g_sfaa_m.sfaa068,g_sfaa_m.sfaa004,g_sfaa_m.sfaa068_desc
                     CALL asft300_b_fill_sfac()            
                     EXIT DIALOG
                  ELSE
                     LET g_sfaa_m.sfaadocno = g_sfaa_m_t.sfaadocno
                  END IF
               END IF
            END IF
         END IF
      #170317-00042#1 add --(E)--
     
      ON ACTION controlf
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang)

      ON ACTION controlr
         CALL cl_show_req_fields()

      ON ACTION controls
#         CALL cl_set_head_visible("","AUTO")
            IF g_header_hidden THEN
               CALL gfrm_curr.setElementHidden("vb_master",0)
               CALL gfrm_curr.setElementImage("controls","small/arr-u.png")
               LET g_header_hidden = 0     #visible
            ELSE
               CALL gfrm_curr.setElementHidden("vb_master",1)
               CALL gfrm_curr.setElementImage("controls","small/arr-d.png")
               LET g_header_hidden = 1     #hidden     
            END IF

      ON ACTION accept
         ACCEPT DIALOG

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ON ACTION cancel      #在dialog button (放棄)
         #add-point:input段cancel name="input.cancel"
         LET g_action_choice1 = ""  #161013-00038#1

         #end add-point  
         LET INT_FLAG = TRUE 
         LET g_detail_idx  = 1
         LET g_detail_idx2 = 1
         #各個page指標
         LET g_detail_idx_list[1] = 1 
         LET g_detail_idx_list[2] = 1
         LET g_detail_idx_list[3] = 1
         LET g_detail_idx_list[4] = 1
 
         CALL g_curr_diag.setCurrentRow("s_sfba",1)    
         CALL g_curr_diag.setCurrentRow("s_sfab",1)
         CALL g_curr_diag.setCurrentRow("s_sfac",1)
         CALL g_curr_diag.setCurrentRow("s_sfaf",1)
 
         EXIT DIALOG

      ON ACTION close       #在dialog 右上角 (X)
         LET INT_FLAG = TRUE
         EXIT DIALOG

      ON ACTION exit        #toolbar 離開
         LET INT_FLAG = TRUE
         EXIT DIALOG

      #交談指令共用ACTION
      &include "common_action.4gl"
         CONTINUE DIALOG

   END DIALOG
   
   IF l_flag0 = 'N' THEN
      CONTINUE WHILE
   END IF
   
  #20150730 by wuxja  --begin--
   IF l_flag2 = '1' THEN
      CONTINUE WHILE
   END IF
  #20150730 by wuxja  --end--
   
   IF l_flag3 = 'N' THEN
      CONTINUE WHILE
   END IF

   EXIT WHILE
   
   END WHILE     

END FUNCTION

################################################################################
# Descriptions...: 單頭資料重新顯示及單身資料重抓
# Memo...........:
# Usage..........: CALL asft300_show()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_show()
   #add-point:show段define(客製用) name="show.define_customerization"
   
   #end add-point
   DEFINE l_ac_t    LIKE type_t.num10
   #add-point:show段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="show.define"
   DEFINE l_success      LIKE type_t.num5
   DEFINE l_imae032      LIKE imae_t.imae032
   DEFINE l_sfaa023_str  STRING
   DEFINE l_sfaa024_str  STRING
   DEFINE l_sfaa064_str  STRING
   #end add-point
   
   #add-point:Function前置處理 name="show.before"
   #160122-00003#1 by wuxja add    --begin--
   IF NOT cl_null(g_sfaa_m.sfaadocno) THEN
      CALL s_aooi200_get_slip(g_sfaa_m.sfaadocno) RETURNING l_success,g_slip
   END IF
   #160122-00003#1 by wuxja add    --end--
   
   #160727-00025#1-s
   #模具頁簽資料
   IF g_argv[01] ='4' THEN     
      CALL asft300_sfai_show()
   END IF
   #160727-00025#1-e
   
   #end add-point
   
   #單身填充
   IF g_bfill = "Y" THEN
      CALL asft300_b_fill_sfab()
      CALL asft300_b_fill_sfac()
      CALL asft300_b_fill_sfaf()
      CALL asft300_b_fill()
      CALL asft300_b_fill2('0')
   END IF
   
   #帶出公用欄位reference值
   #應用 a12 樣板自動產生(Version:4)
   
   #顯示followup圖示
   #應用 a48 樣板自動產生(Version:3)
   CALL asft300_set_pk_array()
   #add-point:ON ACTION agendum name="show.follow_pic"
   
   #END add-point
   CALL cl_user_overview_set_follow_pic()
   
   LET l_ac_t = l_ac
   
   #讀入ref值(單頭)
   #add-point:show段reference name="show.head.reference"
            
   #160621-00002-s
   #IF NOT cl_null(g_sfaa_m.sfaa010) THEN
   #   LET l_imae032 = ''
   #   SELECT imae020,imae032 INTO g_sfaa_m.imae020,l_imae032
   #     FROM imae_t
   #    WHERE imaeent = g_enterprise
   #      AND imaesite = g_site
   #      AND imae001 = g_sfaa_m.sfaa010
   #   IF cl_null(g_sfaa_m.imae020) THEN
   #      LET g_sfaa_m.imae020 = 0
   #   END IF
   #   IF cl_null(l_imae032) THEN
   #      LET l_imae032 = g_sfaa_m.sfaa010
   #   END IF
   #   #抓制程料号
   #   IF NOT cl_null(l_imae032) AND NOT cl_null(g_sfaa_m.sfaa016) THEN
   #      SELECT ecba003 INTO g_sfaa_m.sfaa016_desc
   #        FROM ecba_t
   #       WHERE ecbaent = g_enterprise
   #         AND ecba001 = l_imae032
   #         AND ecba002 = g_sfaa_m.sfaa016
   #   END IF
   #END IF
   #160621-00002-e
   #部門供應商
   IF g_sfaa_m.sfaa057 = '2' THEN  #委外
      SELECT pmaal004 INTO g_sfaa_m.sfaa017_desc
        FROM pmaal_t
       WHERE pmaalent = g_enterprise
         AND pmaal001 = g_sfaa_m.sfaa017
         AND pmaal002 = g_dlang
   ELSE
      CALL s_desc_get_department_desc(g_sfaa_m.sfaa017) RETURNING g_sfaa_m.sfaa017_desc
   END IF
   
   IF NOT cl_null(g_sfaa_m.sfaadocno) THEN
      #CALL s_aooi360_sel('6',g_sfaa_m.sfaadocno,'','','','','','','','','','2') RETURNING l_success,g_sfaa_m.ooff013   #161031-00025#17 mark   
      CALL s_aooi200_get_slip_desc(g_slip) RETURNING g_sfaa_m.oobal004
   END IF
   
   CALL asft300_l_sfaa007()
   
   IF NOT cl_null(g_sfaa_m.sfaa023) THEN
      LET l_sfaa023_str = g_sfaa_m.sfaa023
      LET l_sfaa024_str = g_sfaa_m.sfaa024
      LET l_sfaa064_str = g_sfaa_m.sfaa064
      LET g_sfaa_m.l_sfaa023 = l_sfaa023_str CLIPPED,"-",l_sfaa024_str CLIPPED,"-",l_sfaa064_str CLIPPED
   END IF
   #end add-point
   
#   #遮罩相關處理
#   LET g_sfaa_m_mask_o.* =  g_sfaa_m.*
#   CALL asft300_sfaa_t_mask()
#   LET g_sfaa_m_mask_n.* =  g_sfaa_m.*
   
   #將資料輸出到畫面上
   DISPLAY BY NAME g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.oobal004,g_sfaa_m.sfaadocdt,g_sfaa_m.sfaa002,
           g_sfaa_m.sfaa002_desc,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,
           g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,
           g_sfaa_m.l_sfaa007,g_sfaa_m.sfaa009,g_sfaa_m.sfaa009_desc,g_sfaa_m.sfaa022,g_sfaa_m.l_sfaa023,
           g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,g_sfaa_m.sfaa024,g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,
           g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1,g_sfaa_m.sfaa012,
           g_sfaa_m.sfaa013,g_sfaa_m.sfaa013_desc,g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa060_desc,
           g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,g_sfaa_m.sfaa016_desc,g_sfaa_m.sfaa017,g_sfaa_m.sfaa017_desc,
           g_sfaa_m.sfaa018,g_sfaa_m.sfaa018_desc,g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,
           g_sfaa_m.sfaa068_desc,g_sfaa_m.sfaa014,g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.imae020,
           g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,g_sfaa_m.sfaa028_desc,g_sfaa_m.sfaa029,g_sfaa_m.sfaa029_desc,
           g_sfaa_m.sfaa030,g_sfaa_m.sfaa030_desc,g_sfaa_m.sfaa031,g_sfaa_m.sfaa031_desc,g_sfaa_m.sfaa032,
           g_sfaa_m.sfaa033,g_sfaa_m.sfaa034,g_sfaa_m.sfaa034_desc,g_sfaa_m.sfaa035,g_sfaa_m.sfaa035_desc,
           g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,g_sfaa_m.sfaa037,g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,
           g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,g_sfaa_m.sfaa041,g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,
           g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,g_sfaa_m.sfaa070,g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,
           g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,g_sfaa_m.sfaa065,g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,
           #g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,g_sfaa_m.sfaa056,g_sfaa_m.ooff013,g_sfaa_m.sfaaownid,   #161031-00025#17 mark   
           g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,g_sfaa_m.sfaa056,g_sfaa_m.sfaaownid,                     #161031-00025#17 add
           g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,g_sfaa_m.sfaaowndp_desc,g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtid_desc,
           g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdp_desc,g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,g_sfaa_m.sfaamodid_desc,
           g_sfaa_m.sfaamoddt,g_sfaa_m.sfaacnfid,g_sfaa_m.sfaacnfid_desc,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,
           g_sfaa_m.sfaapstid_desc,g_sfaa_m.sfaapstdt
   
	#根據當下狀態碼顯示圖片
   CALL asft300_status_show()
   
   #讀入ref值(單身)
   FOR l_ac = 1 TO g_sfba_d.getLength()
      
   END FOR
   
   #add-point:show段other name="show.other"

   #end add-point
   
   LET l_ac = l_ac_t
   
   #移動上下筆可以連動切換資料
   CALL cl_show_fld_cont()
   
   CALL asft300_detail_show()
   
   #add-point:show段之後 name="show.after"
   
   #end add-point
   
END FUNCTION

################################################################################
# Descriptions...: 第二階單身reference
# Memo...........:
# Usage..........: CALL asft300_detail_show()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_detail_show()
   #add-point:detail_show段define(客製用) name="detail_show.define_customerization"
   
   #end add-point
   #add-point:detail_show段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="detail_show.define"
   
   #end add-point
   
   #add-point:Function前置處理 name="detail_show.before"
   
   #end add-point
   
   #add-point:detail_show段之後 name="detail_show.after"
   
   #end add-point

END FUNCTION

################################################################################
# Descriptions...: 資料複製
# Memo...........:
# Usage..........: CALL asft300_reproduce()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_reproduce()
   #add-point:reproduce段define(客製用) name="reproduce.define_customerization"

   #end add-point
   DEFINE l_newno     LIKE sfaa_t.sfaadocno
   DEFINE l_oldno     LIKE sfaa_t.sfaadocno
   DEFINE l_master    RECORD LIKE sfaa_t.*
   DEFINE l_cnt       LIKE type_t.num10
   #add-point:reproduce段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="reproduce.define"

   #end add-point

   #add-point:Function前置處理  name="reproduce.pre_function"
   LET g_action_choice1 = "reproduce"   #160729-00016#1 add
   #end add-point
   
   #切換畫面
   IF g_main_hidden THEN
      CALL gfrm_curr.setElementHidden("mainlayout",0)
      CALL gfrm_curr.setElementHidden("worksheet",1)
      LET g_main_hidden = 0
   END IF
   
   LET g_master_insert = FALSE
   
   IF g_sfaa_m.sfaadocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = ""
      LET g_errparam.code   = "std-00003"
      LET g_errparam.popup  = FALSE
      CALL cl_err()
      RETURN
   END IF
   
   LET g_sfaadocno_t = g_sfaa_m.sfaadocno

   LET g_sfaa_m.sfaadocno = ""

   CALL cl_set_head_visible("","YES")

   #公用欄位給予預設值
   #應用 a14 樣板自動產生(Version:5)    
   #公用欄位新增給值  
   LET g_sfaa_m.sfaaownid = g_user
   LET g_sfaa_m.sfaaowndp = g_dept
   LET g_sfaa_m.sfaacrtid = g_user
   LET g_sfaa_m.sfaacrtdp = g_dept 
   LET g_sfaa_m.sfaacrtdt = cl_get_current()
   LET g_sfaa_m.sfaamodid = g_user
   LET g_sfaa_m.sfaamoddt = cl_get_current()
   LET g_sfaa_m.sfaastus = 'N'

   CALL s_transaction_begin()
   
   #add-point:複製輸入前 name="reproduce.head.b_input"
   LET g_sfaa_m.sfaadocdt = g_today
   LET g_sfaa_m.sfaacnfid = ''
   LET g_sfaa_m.sfaacnfdt = ''
   LET g_sfaa_m.sfaa019 = g_today
   LET g_sfaa_m.sfaa020 = g_today
   #160729-00016#1-s
  #LET g_sfaa_m.sfaa039 = 'N'
   SELECT COUNT(1) INTO l_cnt FROM sfba_t WHERE sfbaent = g_enterprise AND sfbadocno = g_sfaadocno_t
   IF l_cnt > 0 THEN 
      LET g_sfaa_m.sfaa039 = 'Y'
   ELSE
      LET g_sfaa_m.sfaa039 = 'N'
   END IF
   #160729-00016#1-e
   LET g_sfaa_m.sfaa040 = 'N'
   LET g_sfaa_m.sfaa041 = 'N'
   LET g_sfaa_m.sfaa042 = 'N'
   LET g_sfaa_m.sfaa043 = 'N'
   LET g_sfaa_m.sfaa044 = 'N'
   LET g_sfaa_m.sfaa045 = ''
   LET g_sfaa_m.sfaa046 = ''
   LET g_sfaa_m.sfaa047 = ''
   LET g_sfaa_m.sfaa048 = ''
   LET g_sfaa_m.sfaa049 = '0'
   LET g_sfaa_m.sfaa050 = '0'
   LET g_sfaa_m.sfaa051 = '0'
   LET g_sfaa_m.sfaa055 = '0'
   LET g_sfaa_m.sfaa056 = '0'
   LET g_sfaa_m.sfaa065 = '0'
   #160729-00016#1-s
   #複製時，工單來源、母工單、前工單資料要清空
   LET g_sfaa_m.sfaa005 = '0'
   LET g_sfaa_m.sfaa006 = ''
   LET g_sfaa_m.sfaa007 = ''
   LET g_sfaa_m.sfaa009 = ''
   LET g_sfaa_m.sfaa021 = ''
   LET g_sfaa_m.sfaa025 = ''
   #原始預計完工日期sfaa070 = 預計完工日sfaa020
   LET g_sfaa_m.sfaa070 = g_sfaa_m.sfaa020
   #160729-00016#1-e
   #end add-point
   
	#根據當下狀態碼顯示圖片
   CALL asft300_status_show()
   
   #清空key欄位的desc
   LET g_sfaa_m.oobal004 = ''
   DISPLAY BY NAME g_sfaa_m.oobal004
   
   CALL asft300_input("r")
   
   IF INT_FLAG AND NOT g_master_insert THEN
      LET INT_FLAG = 0
      DISPLAY g_detail_cnt  TO FORMONLY.h_count    #總筆數
      DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
      LET INT_FLAG = 0
      INITIALIZE g_sfaa_m.* TO NULL
      INITIALIZE g_sfai_m.* TO NULL  #160727-00025#1
      INITIALIZE g_sfba_d TO NULL
      INITIALIZE g_sfab_d TO NULL
      INITIALIZE g_sfac_d TO NULL
      INITIALIZE g_sfaf_d TO NULL

      #add-point:複製取消後 name="reproduce.cancel"

      #end add-point
      CALL asft300_show()
      CALL s_transaction_end('N','0')
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = ''
      LET g_errparam.code   = 9001
      LET g_errparam.popup  = FALSE
      CALL cl_err()
      RETURN
   END IF
   
   #根據資料狀態切換action狀態
   CALL asft300_set_act_visible()
   CALL asft300_set_act_no_visible()
   
   #將新增的資料併入搜尋條件中
   LET g_sfaadocno_t = g_sfaa_m.sfaadocno
   
   #組合新增資料的條件
   LET g_add_browse = " sfaaent = '" ||g_enterprise|| "' AND sfaasite = '" ||g_site|| "' AND",
                      " sfaadocno = '", g_sfaa_m.sfaadocno, "' "
 
   #填到最後面
   LET g_current_idx = g_browser.getLength() + 1
   CALL asft300_browser_fill("")
   
   DISPLAY g_browser_cnt TO FORMONLY.h_count    #總筆數
   DISPLAY g_current_idx TO FORMONLY.h_index    #當下筆數
   CALL cl_navigator_setting(g_current_idx, g_browser_cnt)
   
   #add-point:完成複製段落後 name="reproduce.after_reproduce"
   LET g_action_choice1 = ""   #160729-00016#1 add
   #end add-point
   
   CALL asft300_idx_chk()
   
   LET g_data_owner = g_sfaa_m.sfaaownid
   LET g_data_dept  = g_sfaa_m.sfaaowndp
   
   #功能已完成,通報訊息中心
   CALL asft300_msgcentre_notify('reproduce')

END FUNCTION

################################################################################
# Descriptions...: 單身自動複製
# Memo...........:
# Usage..........: CALL asft300_detail_reproduce()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_detail_reproduce()
   #add-point:delete段define(客製用) name="detail_reproduce.define_customerization"

   #end add-point
   DEFINE ls_sql      STRING
   DEFINE ld_date     DATETIME YEAR TO SECOND
   DEFINE l_detail    RECORD LIKE sfba_t.*
   DEFINE l_detail2   RECORD LIKE sfab_t.*
   DEFINE l_detail3   RECORD LIKE sfac_t.*
   DEFINE l_detail6   RECORD LIKE sfaf_t.*
   #add-point:delete段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="detail_reproduce.define"

   #end add-point

   #add-point:Function前置處理  name="detail_reproduce.pre_function"

   #end add-point
   
   CALL s_transaction_begin()
   
   LET ld_date = cl_get_current()
   
   DROP TABLE asft300_detail
   
   #add-point:單身複製前1 name="detail_reproduce.body.table1.b_insert"

   #end add-point
   
   #CREATE TEMP TABLE
   SELECT * FROM sfba_t
    WHERE sfbaent = g_enterprise AND sfbasite = g_site AND sfbadocno = g_sfaadocno_t
     INTO TEMP asft300_detail
     
   #將key修正為調整後   
   UPDATE asft300_detail 
      #更新key欄位
      SET sfbadocno = g_sfaa_m.sfaadocno,
      #更新共用欄位
          sfba017 = 0,
          sfba018 = 0,
          sfba016 = 0,
          sfba025 = 0,
          sfba031 = 0  #160927-00026#1
      
   #add-point:單身修改前 name="detail_reproduce.body.table1.b_update"

   #end add-point

   #將資料塞回原table
   INSERT INTO sfba_t SELECT * FROM asft300_detail
   
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "reproduce:",SQLERRMESSAGE
      LET g_errparam.code   = SQLCA.sqlcode
      LET g_errparam.popup  = TRUE
      CALL cl_err()
      RETURN
   END IF
   
   #add-point:單身複製中1 name="detail_reproduce.body.table1.m_insert"

   #end add-point
   
   #刪除TEMP TABLE
   DROP TABLE asft300_detail
   
   #add-point:單身複製後1 name="detail_reproduce.body.table1.a_insert"

   #end add-point
 
   #160613-00015-s
#160729-00016#1-s mark
#複製時，工單來源單身要清空
#   SELECT * FROM sfab_t WHERE sfabent = g_enterprise AND sfabdocno = g_sfaadocno_t INTO TEMP asft300_detail
#   UPDATE asft300_detail SET sfabdocno = g_sfaa_m.sfaadocno
#   INSERT INTO sfab_t SELECT * FROM asft300_detail
#   DROP TABLE asft300_detail
#160729-00016#1-e mark

   SELECT * FROM sfac_t WHERE sfacent = g_enterprise AND sfacdocno = g_sfaadocno_t INTO TEMP asft300_detail
  #160729-00016#1-s
  #複製後，實際產出量sfac005要歸零
  #UPDATE asft300_detail SET sfacdocno = g_sfaa_m.sfaadocno
   UPDATE asft300_detail SET sfacdocno = g_sfaa_m.sfaadocno , sfac005 = 0
  #160729-00016#1-e
   INSERT INTO sfac_t SELECT * FROM asft300_detail
   DROP TABLE asft300_detail
   
   SELECT * FROM sfaf_t WHERE sfafent = g_enterprise AND sfafdocno = g_sfaadocno_t INTO TEMP asft300_detail
   UPDATE asft300_detail SET sfafdocno = g_sfaa_m.sfaadocno
   INSERT INTO sfaf_t SELECT * FROM asft300_detail
   DROP TABLE asft300_detail
   
   #160613-00015-e
   
   #多語言複製段落
   
   CALL s_transaction_end('Y','0')
   
   #已新增完, 調整資料內容(修改時使用)
   LET g_sfaadocno_t = g_sfaa_m.sfaadocno

END FUNCTION

################################################################################
# Descriptions...: 資料刪除
# Memo...........:
# Usage..........: CALL asft300_delete()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_delete()
   #add-point:delete段define(客製用) name="delete.define_customerization"

   #end add-point
   DEFINE  l_var_keys      DYNAMIC ARRAY OF STRING
   DEFINE  l_field_keys    DYNAMIC ARRAY OF STRING
   DEFINE  l_vars          DYNAMIC ARRAY OF STRING
   DEFINE  l_fields        DYNAMIC ARRAY OF STRING
   DEFINE  l_var_keys_bak  DYNAMIC ARRAY OF STRING
   #add-point:delete段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="delete.define"
   DEFINE  l_n             LIKE type_t.num5
   DEFINE  l_psabdocno     LIKE sfaa_t.sfaa006  #151117-00019#3-add
   DEFINE  l_psabseq       LIKE sfaa_t.sfaa007  #151117-00019#3-add 
   DEFINE  l_sql           STRING               #160607-00028#1 20160629 add 
   DEFINE  l_sfab001       LIKE sfab_t.sfab001  #160607-00028#1 20160629 add 
   DEFINE  l_sfab002       LIKE sfab_t.sfab002  #160607-00028#1 20160629 add 
   DEFINE  l_sfab003       LIKE sfab_t.sfab003  #160607-00028#1 20160629 add 
   DEFINE  l_sfab007       LIKE sfab_t.sfab007  #160607-00028#1 20160629 add 
   #end add-point

   #add-point:Function前置處理  name="delete.pre_function"

   #end add-point
   
   IF g_sfaa_m.sfaadocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = ""
      LET g_errparam.code   = "std-00003"
      LET g_errparam.popup  = FALSE
      CALL cl_err()
      RETURN
   END IF
   
   CALL s_transaction_begin()

   OPEN asft300_cl USING g_enterprise,g_site,g_sfaa_m.sfaadocno
   IF STATUS THEN
      CLOSE asft300_cl
      CALL s_transaction_end('N','0')
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "OPEN asft300_cl:"
      LET g_errparam.code   = STATUS
      LET g_errparam.popup  = TRUE
      CALL cl_err()
      RETURN
   END IF

   #顯示最新的資料
   EXECUTE asft300_master_referesh USING g_sfaa_m.sfaadocno
      INTO g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.oobal004,g_sfaa_m.sfaadocdt,g_sfaa_m.sfaa002,
           g_sfaa_m.sfaa002_desc,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,
           g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,
           g_sfaa_m.sfaa009,g_sfaa_m.sfaa009_desc,g_sfaa_m.sfaa022,g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,
           g_sfaa_m.sfaa024,g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,
           g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1,g_sfaa_m.sfaa012,g_sfaa_m.sfaa013,g_sfaa_m.sfaa013_desc,
           g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa060_desc,g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,
           g_sfaa_m.sfaa016_desc,g_sfaa_m.sfaa017,g_sfaa_m.sfaa017_desc,g_sfaa_m.sfaa018,g_sfaa_m.sfaa018_desc,
           g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,g_sfaa_m.sfaa068_desc,g_sfaa_m.sfaa014,
           g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.imae020,g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,
           g_sfaa_m.sfaa028_desc,g_sfaa_m.sfaa029,g_sfaa_m.sfaa029_desc,g_sfaa_m.sfaa030,g_sfaa_m.sfaa030_desc,
           g_sfaa_m.sfaa031,g_sfaa_m.sfaa031_desc,g_sfaa_m.sfaa032,g_sfaa_m.sfaa033,g_sfaa_m.sfaa034,
           g_sfaa_m.sfaa034_desc,g_sfaa_m.sfaa035,g_sfaa_m.sfaa035_desc,g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,
           g_sfaa_m.sfaa037,g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,
           g_sfaa_m.sfaa041,g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,
           g_sfaa_m.sfaa070,g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,
           g_sfaa_m.sfaa065,g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,
           #g_sfaa_m.sfaa056,g_sfaa_m.ooff013,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,    #161031-00025#17 mark
           g_sfaa_m.sfaa056,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,                      #161031-00025#17 add
           g_sfaa_m.sfaaowndp_desc,g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtid_desc,g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdp_desc,
           g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,g_sfaa_m.sfaamodid_desc,g_sfaa_m.sfaamoddt,g_sfaa_m.sfaacnfid,
           g_sfaa_m.sfaacnfid_desc,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,g_sfaa_m.sfaapstid_desc,g_sfaa_m.sfaapstdt
   
   #檢查是否允許此動作
   IF NOT asft300_action_chk() THEN
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
#   #遮罩相關處理
#   LET g_sfaa_m_mask_o.* =  g_sfaa_m.*
#   CALL asft300_sfaa_t_mask()
#   LET g_sfaa_m_mask_n.* =  g_sfaa_m.*
   
   CALL asft300_show()
   
   #add-point:delete段before ask name="delete.before_ask"

   #end add-point

   IF cl_ask_del_master() THEN              #確認一下
   
      #add-point:單頭刪除前 name="delete.head.b_delete"

      #end add-point
      
      #應用 a47 樣板自動產生(Version:4)
      #刪除相關文件
      CALL asft300_set_pk_array()
      #add-point:相關文件刪除前 name="delete.befroe.related_document_remove"

      #end add-point
      CALL cl_doc_remove()

      #資料備份
      LET g_sfaadocno_t = g_sfaa_m.sfaadocno

      DELETE FROM sfaa_t
       WHERE sfaaent = g_enterprise AND sfaasite = g_site AND sfaadocno = g_sfaa_m.sfaadocno
      
      #add-point:單頭刪除中 name="delete.head.m_delete"

      #end add-point
      
      IF SQLCA.sqlcode THEN
         CALL s_transaction_end('N','0')
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = g_sfaa_m.sfaadocno,":",SQLERRMESSAGE
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = FALSE
         CALL cl_err()
         RETURN
      END IF
      
      #add-point:單頭刪除後 name="delete.head.a_delete"
      
      IF NOT s_aooi200_del_docno(g_sfaa_m.sfaadocno,g_sfaa_m.sfaadocdt) THEN
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      
      #160727-00025#1-s
      DELETE FROM sfai_t
       WHERE sfaient = g_enterprise AND sfaisite = g_site AND sfaidocno = g_sfaa_m.sfaadocno

      IF SQLCA.sqlcode THEN
         CALL s_transaction_end('N','0')
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = g_sfaa_m.sfaadocno,":",SQLERRMESSAGE
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = FALSE
         CALL cl_err()
         RETURN
      END IF
      #160727-00025#1-e
      
      #2015/09/17 by stellar add ----- (S)
      #更新獨立需求的已耗需求量
      #151117-00019#3-s
      IF g_sfaa_m.sfaa005 = '6' OR g_sfaa_m.sfaa005 = '7' THEN  #151207-00017#2
         LET l_psabdocno = g_sfaa_m.sfaa006
         LET l_psabseq = g_sfaa_m.sfaa007
         
         #160607-00028#1-s
         IF g_sfaa_m.sfaa005 = '6' THEN
            IF NOT s_asft300_upd_psab006(l_psabdocno,l_psabseq,g_sfaa_m.sfaa010,g_sfaa_m.sfaa012,0,g_sfaa_m.sfaa013) THEN
               CALL s_transaction_end('N','0')
               RETURN
            END IF
         END IF

         IF g_sfaa_m.sfaa005 = '7' THEN
            IF NOT s_asft300_upd_psad006(l_psabdocno,l_psabseq,g_sfaa_m.sfaa010,g_sfaa_m.sfaa012,0,g_sfaa_m.sfaa013) THEN
               CALL s_transaction_end('N','0')
               RETURN
            END IF
         END IF
         #160607-00028#1-e
         
      ELSE
         LET l_psabdocno = g_sfaa_m.sfaa022
         LET l_psabseq = g_sfaa_m.sfaa023
      END IF
      #151117-00019#3-e
      #161031-00025#17-s
      #单头的aooi360_01的备注单身资料同步删除
      DELETE FROM ooff_t
       WHERE ooffent = g_enterprise AND ooff001 IN ('6','7')
         AND ooff002 = g_prog AND ooff003 = g_sfaa_m.sfaadocno
         
      IF SQLCA.SQLCODE THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = g_sfaa_m.sfaadocno,":",SQLERRMESSAGE  
         LET g_errparam.code = SQLCA.SQLCODE 
         LET g_errparam.popup = FALSE 
         CALL cl_err()
         CALL s_transaction_end('N','0')
         RETURN
      END IF   
      CALL aooi360_01_clear_detail()   #清除备注单身  
      #161031-00025#17-e   
      #end add-point

      #add-point:單身刪除前 name="delete.body.b_delete"
      
      #add by lixh 20150811  #刪除時回寫armt300已轉數量(rmcb010)      
      IF NOT s_asft300_upd_rmcb010(g_sfaa_m.sfaadocno) THEN
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      #add by lixh 20150811
      
      #160607-00028#1-s
      #如果單頭的工單來源是1.multi時，要去將工單來源單身的獨立需求數量更新
      IF g_sfaa_m.sfaa005 = '1' THEN
         LET l_sql = "SELECT sfab001,sfab002,sfab003,sfab007 ",
                     "  FROM sfab_t ",
                     " WHERE sfabent   = ",g_enterprise,
                     "   AND sfabsite  = '",g_site,"' ",
                     "   AND sfabdocno = '",g_sfaa_m.sfaadocno,"' ",
                     " ORDER BY sfabseq "
         PREPARE asft300_sel_sfab_for_upd_prep FROM l_sql
         DECLARE asft300_sel_sfab_for_upd_curs CURSOR FOR asft300_sel_sfab_for_upd_prep
         
         FOREACH asft300_sel_sfab_for_upd_curs INTO l_sfab001,l_sfab002,l_sfab003,l_sfab007
            IF SQLCA.sqlcode THEN 
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = 'foreach:'
               LET g_errparam.code   = SQLCA.sqlcode
               LET g_errparam.popup  = true
               CALL cl_err()
               EXIT FOREACH
            END IF
            
            IF l_sfab001 = '6' THEN
               IF NOT s_asft300_upd_psab006(l_sfab002,l_sfab003,g_sfaa_m.sfaa010,l_sfab007,0,g_sfaa_m.sfaa013) THEN
                  CALL s_transaction_end('N','0')
                  RETURN
               END IF
            END IF
            
         END FOREACH
      END IF
      #160607-00028#1-e
      
      #end add-point
      
      DELETE FROM sfba_t
       WHERE sfbaent = g_enterprise AND sfbasite = g_site AND sfbadocno = g_sfaa_m.sfaadocno

      #add-point:單身刪除中 name="delete.body.m_delete"

      #end add-point
      
      IF SQLCA.sqlcode THEN
         CALL s_transaction_end('N','0')
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = "sfba_t:",SQLERRMESSAGE
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = FALSE
         CALL cl_err()
         RETURN
      END IF

      #add-point:單身刪除後 name="delete.body.a_delete"

      DELETE FROM sfab_t
       WHERE sfabent = g_enterprise AND sfabsite = g_site AND sfabdocno = g_sfaa_m.sfaadocno
      IF SQLCA.sqlcode THEN
         CALL s_transaction_end('N','0')
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = "sfab_t:",SQLERRMESSAGE
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = FALSE
         CALL cl_err()
         RETURN
      END IF
      DELETE FROM sfac_t
       WHERE sfacent = g_enterprise AND sfacsite = g_site AND sfacdocno = g_sfaa_m.sfaadocno
      IF SQLCA.sqlcode THEN
         CALL s_transaction_end('N','0')
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = "sfac_t:",SQLERRMESSAGE
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = FALSE
         CALL cl_err()
         RETURN
      END IF
      DELETE FROM sfaf_t
       WHERE sfafent = g_enterprise AND sfafsite = g_site AND sfafdocno = g_sfaa_m.sfaadocno
      IF SQLCA.sqlcode THEN
         CALL s_transaction_end('N','0')
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = "sfaf_t:",SQLERRMESSAGE
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = FALSE
         CALL cl_err()
         RETURN
      END IF
      DELETE FROM sfca_t
       WHERE sfcaent = g_enterprise AND sfcasite = g_site AND sfcadocno = g_sfaa_m.sfaadocno
      IF SQLCA.sqlcode THEN
         CALL s_transaction_end('N','0')
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = "sfca_t:",SQLERRMESSAGE
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = FALSE
         CALL cl_err()
         RETURN
      END IF
      DELETE FROM sfcb_t
       WHERE sfcbent = g_enterprise AND sfcbsite = g_site AND sfcbdocno = g_sfaa_m.sfaadocno
      IF SQLCA.sqlcode THEN
         CALL s_transaction_end('N','0')
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = "sfcb_t:",SQLERRMESSAGE
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = FALSE
         CALL cl_err()
         RETURN
      END IF
      DELETE FROM sfcc_t
       WHERE sfccent = g_enterprise AND sfccsite = g_site AND sfccdocno = g_sfaa_m.sfaadocno
      IF SQLCA.sqlcode THEN
         CALL s_transaction_end('N','0')
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = "sfcc_t:",SQLERRMESSAGE
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = FALSE
         CALL cl_err()
         RETURN
      END IF
      DELETE FROM sfcd_t
       WHERE sfcdent = g_enterprise AND sfcdsite = g_site AND sfcddocno = g_sfaa_m.sfaadocno
      IF SQLCA.sqlcode THEN
         CALL s_transaction_end('N','0')
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = "sfcd_t:",SQLERRMESSAGE
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = FALSE
         CALL cl_err()
         RETURN
      END IF
      
      #add 150717   ---begin---删除备注
      IF NOT s_aooi360_del('8',g_sfaa_m.sfaadocno,' ',' ',' ',' ',' ',' ',' ',' ',' ','2') THEN
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      #add 150717   ---end---
      
      #stellar 130918 add ----------(S)
      #若是從APS拋轉的工單，刪除時，也要將相關資料清除
      LET l_n = 0
      SELECT COUNT(1) INTO l_n FROM psos_t
       WHERE psosent = g_enterprise
         AND psossite= g_site
         AND psos009 = '1'   #建議單據=新增
         AND psos058 = g_sfaa_m.sfaadocno
      IF NOT cl_null(l_n) AND l_n > 0 THEN
         UPDATE psos_t SET psos057 = 'N',
                           psos058 = NULL
                          ,psos062 = COALESCE(psos062,0) - g_sfaa_m.sfaa012  #160425-00006 by whitney add
          WHERE psosent = g_enterprise
            AND psossite= g_site
            AND psos009 = '1'
            AND psos058 = g_sfaa_m.sfaadocno
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = "psos_t"
            LET g_errparam.popup = FALSE
            CALL cl_err()
            CALL s_transaction_end('N','0')
            RETURN
         END IF
      END IF
      #stellar 130918 add ----------(E)

      #end add-point
      
      #修改歷程記錄(刪除)
      IF NOT cl_log_modified_record('','') THEN
         CLOSE asft300_cl
         CALL s_transaction_end('N','0')
         RETURN
      END IF
      
      CLEAR FORM
      CALL g_sfba_d.clear()
      CALL g_sfab_d.clear()
      CALL g_sfac_d.clear()
      CALL g_sfaf_d.clear()
     
      CALL asft300_ui_browser_refresh()
      #CALL asft300_ui_headershow()
      #CALL asft300_ui_detailshow()

      #add-point:多語言刪除 name="delete.lang.before_delete"

      #end add-point
      
      #單頭多語言刪除
      
      #單身多語言刪除
      
      #add-point:多語言刪除 name="delete.lang.delete"

      #end add-point
      
      IF g_browser_cnt > 0 THEN
         #CALL asft300_browser_fill("")
         CALL asft300_fetch('P')
         DISPLAY g_browser_cnt TO FORMONLY.h_count   #總筆數的顯示
         DISPLAY g_browser_cnt TO FORMONLY.b_count   #總筆數的顯示
      ELSE
         CLEAR FORM
      END IF
      
      CALL s_transaction_end('Y','0')
   ELSE
      CALL s_transaction_end('N','0')
   END IF

   CLOSE asft300_cl

   #功能已完成,通報訊息中心
   CALL asft300_msgcentre_notify('delete')

END FUNCTION

################################################################################
# Descriptions...: 單身陣列填充
# Memo...........:
# Usage..........: CALL asft300_b_fill()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_b_fill()
   #add-point:b_fill段define(客製用) name="b_fill.define_customerization"

   #end add-point
   DEFINE p_wc2      STRING
   DEFINE li_idx     LIKE type_t.num10
   #add-point:b_fill段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="b_fill.define"
   DEFINE l_success     LIKE type_t.num5
   #end add-point

   #add-point:Function前置處理  name="b_fill.pre_function"

   #end add-point
   
   #清空第一階單身
   CALL g_sfba_d.clear()

   #add-point:b_fill段sql_before name="b_fill.sql_before"

   #end add-point

   #判斷是否填充
   IF asft300_fill_chk(1) THEN
      #切換上下筆時不重組SQL
      IF g_action_choice <> 'fetch' OR cl_null(g_action_choice) THEN
         #160122-00003#1-s
         LET g_sql = " SELECT UNIQUE sfbaseq,sfbaseq1,sfba002,t1.oocql004,sfba003,t2.oocql004,sfba004,sfba005,t3.imaal003,t3.imaal004, ",
                     "               '',sfba022,sfba006,t4.imaal003,t4.imaal004,sfba033,t5.imaf013,sfba021,t6.inaml004,sfba007, ",
                     "               sfba008,sfba009,sfba010,sfba011,sfba012,sfba023,sfba024,sfba013,sfba014,t7.oocal003, ",
                     "               sfba015,sfba016,sfba025,0,0,sfba017,sfba018,0,0,sfba019, ",
                     "               t8.inayl003,sfba020,t9.inab003,sfba029,sfba030,sfba028,sfba001,t10.imaal003,t10.imaal004,sfba026, ",
                     "               sfba027,sfba034,sfba035,'' FROM sfba_t ",
                     " INNER JOIN sfaa_t ON sfaaent = sfbaent AND sfaadocno = sfbadocno ",
                     "  LEFT JOIN oocql_t t1 ON t1.oocqlent=sfbaent AND t1.oocql001='215' AND t1.oocql002=sfba002 AND t1.oocql003='"||g_dlang||"' ",
                     "  LEFT JOIN oocql_t t2 ON t2.oocqlent=sfbaent AND t2.oocql001='221' AND t2.oocql002=sfba003 AND t2.oocql003='"||g_dlang||"' ",
                     "  LEFT JOIN imaal_t t3 ON t3.imaalent=sfbaent AND t3.imaal001=sfba005 AND t3.imaal002='"||g_dlang||"' ",
                     "  LEFT JOIN imaal_t t4 ON t4.imaalent=sfbaent AND t4.imaal001=sfba006 AND t4.imaal002='"||g_dlang||"' ",
                     "  LEFT JOIN imaf_t  t5 ON t5.imafent =sfbaent AND t5.imaf001 =sfba006 AND t5.imafsite='"||g_site||"' ",
                     "  LEFT JOIN inaml_t t6 ON t6.inamlent=sfbaent AND t6.inaml001=sfba006 AND t6.inaml002=sfba021 AND t6.inaml003='"||g_dlang||"' ",
                     "  LEFT JOIN oocal_t t7 ON t7.oocalent=sfbaent AND t7.oocal001=sfba014 AND t7.oocal002='"||g_dlang||"' ",
                     "  LEFT JOIN inayl_t t8 ON t8.inaylent=sfbaent AND t8.inayl001=sfba019 AND t8.inayl002='"||g_dlang||"' ",
                     "  LEFT JOIN inab_t  t9 ON t9.inabent =sfbaent AND t9.inab001 =sfba019 AND t9.inab002=sfba020 AND t9.inabsite='"||g_site||"' ",
                     "  LEFT JOIN imaal_t t10 ON t10.imaalent=sfbaent AND t10.imaal001=sfba001 AND t10.imaal002='"||g_dlang||"' ",
                     "  LEFT JOIN imaa_t ON imaaent=sfbaent AND  imaa001=sfba006 ",
                     " WHERE sfbaent=? AND sfbasite=? AND sfbadocno=? "
         #160122-00003#1-e
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         #add-point:b_fill段sql_before name="b_fill.body.fill_sql"
         #161031-00025#17-s
         LET g_sql = " SELECT UNIQUE sfbaseq,sfbaseq1,sfba002,t1.oocql004,sfba003,t2.oocql004,sfba004,sfba005,t3.imaal003,t3.imaal004, ",
                     "               '',sfba022,sfba006,t4.imaal003,t4.imaal004,sfba033,t5.imaf013,sfba021,t6.inaml004,sfba007, ",
                     "               sfba008,sfba009,sfba010,sfba011,sfba012,sfba023,sfba024,sfba013,sfba014,t7.oocal003, ",
                     "               sfba015,sfba016,sfba025,0,0,sfba017,sfba018,0,0,sfba019, ",
                     "               t8.inayl003,sfba020,t9.inab003,sfba029,sfba030,sfba028,sfba001,t10.imaal003,t10.imaal004,sfba026, ",
                     "               sfba027,sfba034,sfba035,'' FROM sfba_t ",
                     " INNER JOIN sfaa_t ON sfaaent = sfbaent AND sfaadocno = sfbadocno ",
                     "  LEFT JOIN oocql_t t1 ON t1.oocqlent=sfbaent AND t1.oocql001='215' AND t1.oocql002=sfba002 AND t1.oocql003='"||g_dlang||"' ",
                     "  LEFT JOIN oocql_t t2 ON t2.oocqlent=sfbaent AND t2.oocql001='221' AND t2.oocql002=sfba003 AND t2.oocql003='"||g_dlang||"' ",
                     "  LEFT JOIN imaal_t t3 ON t3.imaalent=sfbaent AND t3.imaal001=sfba005 AND t3.imaal002='"||g_dlang||"' ",
                     "  LEFT JOIN imaal_t t4 ON t4.imaalent=sfbaent AND t4.imaal001=sfba006 AND t4.imaal002='"||g_dlang||"' ",
                     "  LEFT JOIN imaf_t  t5 ON t5.imafent =sfbaent AND t5.imaf001 =sfba006 AND t5.imafsite='"||g_site||"' ",
                     "  LEFT JOIN inaml_t t6 ON t6.inamlent=sfbaent AND t6.inaml001=sfba006 AND t6.inaml002=sfba021 AND t6.inaml003='"||g_dlang||"' ",
                     "  LEFT JOIN oocal_t t7 ON t7.oocalent=sfbaent AND t7.oocal001=sfba014 AND t7.oocal002='"||g_dlang||"' ",
                     "  LEFT JOIN inayl_t t8 ON t8.inaylent=sfbaent AND t8.inayl001=sfba019 AND t8.inayl002='"||g_dlang||"' ",
                     "  LEFT JOIN inab_t  t9 ON t9.inabent =sfbaent AND t9.inab001 =sfba019 AND t9.inab002=sfba020 AND t9.inabsite='"||g_site||"' ",
                     "  LEFT JOIN imaal_t t10 ON t10.imaalent=sfbaent AND t10.imaal001=sfba001 AND t10.imaal002='"||g_dlang||"' ",
                     "  LEFT JOIN imaa_t ON imaaent=sfbaent AND  imaa001=sfba006 ",
                                    " LEFT JOIN ooff_t  ON ooffent="||g_enterprise||" AND ooff002 = '",g_prog,"' AND ooff003 = sfbadocno AND ooff004 = sfbaseq", 
                     " WHERE sfbaent=? AND sfbasite=? AND sfbadocno=? "
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         #161031-00025#17-e
         #end add-point
         IF NOT cl_null(g_wc2_table1) THEN
            LET g_sql = g_sql CLIPPED, " AND ", g_wc2_table1 CLIPPED
         END IF
         
         #子單身的WC
         
         LET g_sql = g_sql, " ORDER BY sfba_t.sfbaseq,sfba_t.sfbaseq1 "
         
         #add-point:單身填充控制 name="b_fill.sql"

         #end add-point
         
         LET g_sql = cl_sql_add_mask(g_sql)              #遮蔽特定資料
         PREPARE asft300_pb FROM g_sql
         DECLARE b_fill_cs CURSOR FOR asft300_pb
      END IF
      
      LET g_cnt = l_ac
      LET l_ac = 1
      
      OPEN b_fill_cs USING g_enterprise, g_site,g_sfaa_m.sfaadocno
                                               
      #160122-00003#1-s
      FOREACH b_fill_cs INTO g_sfba_d[l_ac].sfbaseq,g_sfba_d[l_ac].sfbaseq1,g_sfba_d[l_ac].sfba002,g_sfba_d[l_ac].sfba002_desc,g_sfba_d[l_ac].sfba003,
                             g_sfba_d[l_ac].sfba003_desc,g_sfba_d[l_ac].sfba004,g_sfba_d[l_ac].sfba005,g_sfba_d[l_ac].sfba005_desc,g_sfba_d[l_ac].sfba005_desc1,
                             g_sfba_d[l_ac].replace,g_sfba_d[l_ac].sfba022,g_sfba_d[l_ac].sfba006,g_sfba_d[l_ac].sfba006_desc,g_sfba_d[l_ac].sfba006_desc1,
                             g_sfba_d[l_ac].sfba033,g_sfba_d[l_ac].imaf013,g_sfba_d[l_ac].sfba021,g_sfba_d[l_ac].sfba021_desc,g_sfba_d[l_ac].sfba007,
                             g_sfba_d[l_ac].sfba008,g_sfba_d[l_ac].sfba009,g_sfba_d[l_ac].sfba010,g_sfba_d[l_ac].sfba011,g_sfba_d[l_ac].sfba012,
                             g_sfba_d[l_ac].sfba023,g_sfba_d[l_ac].sfba024,g_sfba_d[l_ac].sfba013,g_sfba_d[l_ac].sfba014,g_sfba_d[l_ac].sfba014_desc,
                             g_sfba_d[l_ac].sfba015,g_sfba_d[l_ac].sfba016,g_sfba_d[l_ac].sfba025,g_sfba_d[l_ac].number1,g_sfba_d[l_ac].number2,
                             g_sfba_d[l_ac].sfba017,g_sfba_d[l_ac].sfba018,g_sfba_d[l_ac].number3,g_sfba_d[l_ac].number4,g_sfba_d[l_ac].sfba019,
                             g_sfba_d[l_ac].sfba019_desc,g_sfba_d[l_ac].sfba020,g_sfba_d[l_ac].sfba020_desc,g_sfba_d[l_ac].sfba029,g_sfba_d[l_ac].sfba030,
                             g_sfba_d[l_ac].sfba028,g_sfba_d[l_ac].sfba001,g_sfba_d[l_ac].sfba001_desc,g_sfba_d[l_ac].sfba001_desc1,g_sfba_d[l_ac].sfba026,
                             g_sfba_d[l_ac].sfba027,g_sfba_d[l_ac].sfba034,g_sfba_d[l_ac].sfba035,g_sfba_d[l_ac].ooff013
      #160122-00003#1-e
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE
            LET g_errparam.code   = SQLCA.sqlcode
            LET g_errparam.popup  = TRUE
            CALL cl_err()
            EXIT FOREACH
         END IF
        
         #add-point:b_fill段資料填充 name="b_fill.fill"
         CALL asft300_b_desc()
         #161031-00025#17-s
         CALL s_aooi360_sel('7',g_prog,g_sfaa_m.sfaadocno,g_sfba_d[l_ac].sfbaseq,g_sfba_d[l_ac].sfbaseq1,'','','','','','','1') RETURNING l_success,g_sfba_d[l_ac].ooff013
         #161031-00025#17-e  
         #end add-point
      
         IF l_ac > g_max_rec THEN
            IF g_error_show = 1 THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.extend = l_ac
               LET g_errparam.code   = 9035
               LET g_errparam.popup  = TRUE
               CALL cl_err()
            END IF
            EXIT FOREACH
         END IF
         
         LET l_ac = l_ac + 1
      END FOREACH
      LET g_error_show = 0
   
   END IF
   #add-point:browser_fill段其他table處理 name="browser_fill.other_fill"
   #161031-00025#17-s
   LET g_ooff001_d = '6'   #6.單據單頭備註
   LET g_ooff002_d = g_prog
   LET g_ooff003_d = g_sfaa_m.sfaadocno   #单号
   LET g_ooff004_d = '0'     #项次
   LET g_ooff005_d = ' '
   LET g_ooff006_d = ' '
   LET g_ooff007_d = ' '
   LET g_ooff008_d = ' '
   LET g_ooff009_d = ' '
   LET g_ooff010_d = ' '
   LET g_ooff011_d = ' '
   CALL aooi360_01_b_fill(g_ooff001_d,g_ooff002_d,g_ooff003_d,g_ooff004_d,g_ooff005_d,g_ooff006_d,g_ooff007_d,g_ooff008_d,g_ooff009_d,g_ooff010_d,g_ooff011_d)   #备注单身 
   #161031-00025#17-e 
   #end add-point
   CALL g_sfba_d.deleteElement(g_sfba_d.getLength())

   LET l_ac = g_cnt
   LET g_cnt = 0

   FREE asft300_pb

#   #遮罩相關處理
#   FOR l_ac = 1 TO g_sfba_d.getLength()
#      LET g_sfba_d_mask_o[l_ac].* =  g_sfba_d[l_ac].*
#      CALL asft300_xmdc_t_mask()
#      LET g_sfba_d_mask_n[l_ac].* =  g_sfba_d[l_ac].*
#   END FOR
   
   LET l_ac = li_idx
   
   CALL cl_ap_performance_next_end()

END FUNCTION

################################################################################
# Descriptions...: 刪除單身後其他table連動
# Memo...........:
# Usage..........: CALL asft300_delete_b(ps_table,ps_keys_bak,ps_page)
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_delete_b(ps_table,ps_keys_bak,ps_page)
   #add-point:delete_b段define(客製用) name="delete_b.define_customerization"

   #end add-point
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys_bak DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   DEFINE li_idx      LIKE type_t.num10
   #add-point:delete_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="delete_b.define"

   #end add-point

   #add-point:Function前置處理  name="delete_b.pre_function"

   #end add-point
   
   LET g_update = TRUE
   
   #判斷是否是同一群組的table
   LET ls_group = "'1',"
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:delete_b段刪除前 name="delete_b.b_delete"

      #end add-point
      DELETE FROM sfba_t
       WHERE sfbaent = g_enterprise AND sfbasite = g_site AND
         sfbadocno = ps_keys_bak[1] AND sfbaseq = ps_keys_bak[2] AND sfbaseq1 = ps_keys_bak[3]
      #add-point:delete_b段刪除中 name="delete_b.m_delete"
                                    
      #end add-point    
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = ":",SQLERRMESSAGE 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = FALSE 
         CALL cl_err()
         RETURN FALSE
      END IF
      LET li_idx = g_detail_idx
      IF ps_page <> "'1'" THEN 
         CALL g_sfba_d.deleteElement(li_idx) 
      END IF 
 
   END IF
   
   #add-point:delete_b段other name="delete_b.other"

   #end add-point
   
   RETURN TRUE

END FUNCTION

################################################################################
# Descriptions...: 新增單身後其他table連動
# Memo...........:
# Usage..........: CALL asft300_insert_b(ps_table,ps_keys,ps_page)
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_insert_b(ps_table,ps_keys,ps_page)
   #add-point:insert_b段define(客製用) name="insert_b.define_customerization"

   #end add-point
   DEFINE ps_table    STRING
   DEFINE ps_page     STRING
   DEFINE ps_keys     DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group    STRING
   DEFINE ls_page     STRING
   DEFINE li_idx      LIKE type_t.num10
   #add-point:insert_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="insert_b.define"

   #end add-point

   #add-point:Function前置處理  name="insert_b.pre_function"

   #end add-point
   
   LET g_update = TRUE  
   
   #判斷是否是同一群組的table
   LET ls_group = "'1',"
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN
      #add-point:insert_b段資料新增前 name="insert_b.before_insert"
      #160727-00025#1---s
      IF cl_null(g_sfba_d[g_detail_idx].sfba002) THEN
         LET g_sfba_d[g_detail_idx].sfba002 = ' '             
      END IF
      #160727-00025#1---e
      #end add-point
      INSERT INTO sfba_t
                  (sfbaent,sfbasite,sfbadocno,sfbaseq,sfbaseq1,
                   sfba002,sfba003,sfba004,sfba005,sfba022,sfba006,sfba033,sfba021,sfba007,sfba008,  #160509-00009#4 by whitney add sfba033
                   sfba009,sfba010,sfba011,sfba012,sfba023,sfba024,sfba013,sfba014,sfba015,sfba016,
                   sfba025,sfba017,sfba018,sfba019,sfba020,sfba029,sfba030,sfba028,sfba001,sfba026,
                   sfba027)
            VALUES(g_enterprise,g_site,ps_keys[1],ps_keys[2],ps_keys[3],
                   g_sfba_d[g_detail_idx].sfba002,g_sfba_d[g_detail_idx].sfba003,g_sfba_d[g_detail_idx].sfba004,g_sfba_d[g_detail_idx].sfba005,g_sfba_d[g_detail_idx].sfba022,
                   g_sfba_d[g_detail_idx].sfba006,g_sfba_d[g_detail_idx].sfba033,g_sfba_d[g_detail_idx].sfba021,g_sfba_d[g_detail_idx].sfba007,g_sfba_d[g_detail_idx].sfba008,  #160509-00009#4 by whitney add sfba033
                   g_sfba_d[g_detail_idx].sfba009,g_sfba_d[g_detail_idx].sfba010,g_sfba_d[g_detail_idx].sfba011,g_sfba_d[g_detail_idx].sfba012,g_sfba_d[g_detail_idx].sfba023,
                   g_sfba_d[g_detail_idx].sfba024,g_sfba_d[g_detail_idx].sfba013,g_sfba_d[g_detail_idx].sfba014,g_sfba_d[g_detail_idx].sfba015,g_sfba_d[g_detail_idx].sfba016,
                   g_sfba_d[g_detail_idx].sfba025,g_sfba_d[g_detail_idx].sfba017,g_sfba_d[g_detail_idx].sfba018,g_sfba_d[g_detail_idx].sfba019,g_sfba_d[g_detail_idx].sfba020,
                   g_sfba_d[g_detail_idx].sfba029,g_sfba_d[g_detail_idx].sfba030,g_sfba_d[g_detail_idx].sfba028,g_sfba_d[g_detail_idx].sfba001,g_sfba_d[g_detail_idx].sfba026,
                   g_sfba_d[g_detail_idx].sfba027)

      #add-point:insert_b段資料新增中 name="insert_b.m_insert"

      #end add-point
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "sfba_t:",SQLERRMESSAGE 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = FALSE 
         CALL cl_err()
      END IF
      
      LET li_idx = g_detail_idx
      IF ps_page <> "'1'" THEN 
         CALL g_sfba_d.insertElement(li_idx) 
      END IF 
 
      #add-point:insert_b段資料新增後 name="insert_b.after_insert"
                                    
      #end add-point 
   END IF
   
   #add-point:insert_b段other name="insert_b.other"

   #end add-point

END FUNCTION

################################################################################
# Descriptions...: 修改單身後其他table連動
# Memo...........:
# Usage..........: CALL asft300_update_b(ps_table,ps_keys,ps_keys_bak,ps_page)
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_update_b(ps_table,ps_keys,ps_keys_bak,ps_page)
   #add-point:update_b段define(客製用) name="update_b.define_customerization"

   #end add-point
   DEFINE ps_table         STRING
   DEFINE ps_page          STRING
   DEFINE ps_keys          DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ps_keys_bak      DYNAMIC ARRAY OF VARCHAR(500)
   DEFINE ls_group         STRING
   DEFINE li_idx           LIKE type_t.num10 
   DEFINE lb_chk           BOOLEAN
   DEFINE l_new_key        DYNAMIC ARRAY OF STRING
   DEFINE l_old_key        DYNAMIC ARRAY OF STRING
   DEFINE l_field_key      DYNAMIC ARRAY OF STRING
   #add-point:update_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="update_b.define"

   #end add-point

   #add-point:Function前置處理  name="update_b.pre_function"

   #end add-point
   
   LET g_update = TRUE
   
   #判斷key是否有改變
   LET lb_chk = TRUE
   FOR li_idx = 1 TO ps_keys.getLength()
      IF ps_keys[li_idx] <> ps_keys_bak[li_idx] THEN
         LET lb_chk = FALSE
         EXIT FOR
      END IF
   END FOR
   
   #不需要做處理
   IF lb_chk THEN
      RETURN
   END IF
   
   #判斷是否是同一群組的table
   LET ls_group = "'1',"
   IF ls_group.getIndexOf(ps_page,1) > 0 AND ps_table <> "sfba_t" THEN
      #add-point:update_b段修改前 name="update_b.before_update"

      #end add-point
      
#      #將遮罩欄位還原
#      CALL asft300_sfba_t_mask_restore('restore_mask_o')

      UPDATE sfba_t
         SET (sfbadocno,sfbaseq,sfbaseq1,
              sfba002,sfba003,sfba004,sfba005,sfba022,sfba006,sfba033,sfba021,sfba007,sfba008,#160509-00009#4 by whitney add sfba033
              sfba009,sfba010,sfba011,sfba012,sfba023,sfba024,sfba013,sfba014,sfba015,sfba016,
              sfba025,sfba017,sfba018,sfba019,sfba020,sfba029,sfba030,sfba028,sfba001,sfba026,
              sfba027)
           = (ps_keys[1],ps_keys[2],ps_keys[3],
              g_sfba_d[g_detail_idx].sfba002,g_sfba_d[g_detail_idx].sfba003,g_sfba_d[g_detail_idx].sfba004,g_sfba_d[g_detail_idx].sfba005,g_sfba_d[g_detail_idx].sfba022,
              g_sfba_d[g_detail_idx].sfba006,g_sfba_d[g_detail_idx].sfba033,g_sfba_d[g_detail_idx].sfba021,g_sfba_d[g_detail_idx].sfba007,g_sfba_d[g_detail_idx].sfba008,  #160509-00009#4 by whitney add sfba033
              g_sfba_d[g_detail_idx].sfba009,g_sfba_d[g_detail_idx].sfba010,g_sfba_d[g_detail_idx].sfba011,g_sfba_d[g_detail_idx].sfba012,g_sfba_d[g_detail_idx].sfba023,
              g_sfba_d[g_detail_idx].sfba024,g_sfba_d[g_detail_idx].sfba013,g_sfba_d[g_detail_idx].sfba014,g_sfba_d[g_detail_idx].sfba015,g_sfba_d[g_detail_idx].sfba016,
              g_sfba_d[g_detail_idx].sfba025,g_sfba_d[g_detail_idx].sfba017,g_sfba_d[g_detail_idx].sfba018,g_sfba_d[g_detail_idx].sfba019,g_sfba_d[g_detail_idx].sfba020,
              g_sfba_d[g_detail_idx].sfba029,g_sfba_d[g_detail_idx].sfba030,g_sfba_d[g_detail_idx].sfba028,g_sfba_d[g_detail_idx].sfba001,g_sfba_d[g_detail_idx].sfba026,
              g_sfba_d[g_detail_idx].sfba027)
         WHERE sfbaent = g_enterprise AND sfbasite = g_site AND sfbadocno = ps_keys_bak[1] AND sfbaseq = ps_keys_bak[2] AND sfbaseq1 = ps_keys_bak[3]
      #add-point:update_b段修改中 name="update_b.m_update"

      #end add-point
      CASE
         WHEN SQLCA.sqlerrd[3] = 0  #更新不到的處理
            CALL s_transaction_end('N','0')
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = "sfba_t"
            LET g_errparam.code   = "std-00009"
            LET g_errparam.popup  = TRUE
            CALL cl_err()
            
         WHEN SQLCA.sqlcode #其他錯誤
            CALL s_transaction_end('N','0')
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = "sfba_t:",SQLERRMESSAGE
            LET g_errparam.code   = SQLCA.sqlcode
            LET g_errparam.popup  = TRUE
            CALL cl_err()
            
         OTHERWISE
 
      END CASE
      
#      #將遮罩欄位進行遮蔽
#      CALL asft300_sfba_t_mask_restore('restore_mask_n')

      #add-point:update_b段修改後 name="update_b.after_update"

      #end add-point
   END IF
   
   #子表處理
   IF ls_group.getIndexOf(ps_page,1) > 0 THEN

   END IF
   
   #add-point:update_b段other name="update_b.other"

   #end add-point

END FUNCTION

################################################################################
# Descriptions...: 連動lock其他單身table資料
# Memo...........:
# Usage..........: CALL asft300_lock_b(ps_table,ps_page)
# Input parameter: ps_table
#                : ps_page
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_lock_b(ps_table,ps_page)
   #add-point:lock_b段define(客製用) name="lock_b.define_customerization"

   #end add-point
   DEFINE ps_page     STRING
   DEFINE ps_table    STRING
   DEFINE ls_group    STRING
   #add-point:lock_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="lock_b.define"

   #end add-point

   #add-point:Function前置處理  name="lock_b.pre_function"

   #end add-point
   
   #先刷新資料
   #CALL asft300_b_fill()
   
   #鎖定整組table
   #LET ls_group = "'1',"
   #僅鎖定自身table
   LET ls_group = "sfba_t"
   
   IF ls_group.getIndexOf(ps_table,1) THEN
      OPEN asft300_bcl USING g_enterprise,g_site,g_sfaa_m.sfaadocno,g_sfba_d[g_detail_idx].sfbaseq,g_sfba_d[g_detail_idx].sfbaseq1
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = "asft300_bcl:",SQLERRMESSAGE
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = TRUE
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF

   #add-point:lock_b段other name="lock_b.other"

   #end add-point
   
   RETURN TRUE

END FUNCTION

################################################################################
# Descriptions...: 連動unlock其他單身table資料
# Memo...........:
# Usage..........: CALL asft300_unlock_b(ps_table,ps_page)
# Input parameter: ps_table
#                : ps_page
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_unlock_b(ps_table,ps_page)
   #add-point:unlock_b段define(客製用) name="unlock_b.define_customerization"

   #end add-point
   DEFINE ps_page     STRING
   DEFINE ps_table    STRING
   DEFINE ls_group    STRING
   #add-point:unlock_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="unlock_b.define"

   #end add-point

   #add-point:Function前置處理  name="unlock_b.pre_function"

   #end add-point
   
   LET ls_group = "'1',"
   
   IF ls_group.getIndexOf(ps_page,1) THEN
      CLOSE asft300_bcl
   END IF

   #add-point:unlock_b段other name="unlock_b.other"

   #end add-point

END FUNCTION

################################################################################
# Descriptions...: 單頭欄位開啟設定
# Memo...........:
# Usage..........: CALL asft300_set_entry(p_cmd)
# Input parameter: p_cmd
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_set_entry(p_cmd)
   #add-point:set_entry段define(客製用) name="set_entry.define_customerization"

   #end add-point
   DEFINE p_cmd   LIKE type_t.chr1
   #add-point:set_entry段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_entry.define"
   
   #end add-point       
   
   #add-point:Function前置處理  name="set_entry.pre_function"

   #end add-point
   CALL cl_set_comp_required("sfaa017",TRUE)   #161227-00044#1
   CALL cl_set_comp_entry("sfaadocno",TRUE)
   
   IF p_cmd = 'a' THEN
      CALL cl_set_comp_entry("sfaadocno",TRUE)
      CALL cl_set_comp_entry("sfaadocdt",TRUE)
      #根據azzi850使用者身分開關特定欄位
      IF NOT cl_null(g_no_entry) THEN
         CALL cl_set_comp_entry(g_no_entry,TRUE)
      END IF
      #add-point:set_entry段欄位控制 name="set_entry.field_control"
      
      #end add-point
   END IF
   
   #add-point:set_entry段欄位控制後 name="set_entry.after_control"
   
   CALL cl_set_comp_entry("sfaa003,sfaa057,sfaa004,sfaa005,sfaa006,sfaa007,sfaa008,sfaa063,l_sfaa007,sfaa010,sfaa011,sfaa012,sfaa013",TRUE)
   
   CALL cl_set_comp_entry("sfaa025",TRUE)
   
   CALL cl_set_comp_entry("sfaa018",TRUE)
   
   CALL cl_set_comp_entry("sfaa044",TRUE)
   
   CALL cl_set_comp_entry("sfaa009",TRUE)
   
   CALL cl_set_comp_entry("sfaa016",TRUE)
   
   CALL cl_set_comp_entry("sfaa058",TRUE)


   CALL cl_set_comp_entry("sfaa059",TRUE) #160519-00022#17-add

#160719-00004#1-s add
#把單據別中所有可能可以設定為不可修改的欄位打開(因為set_no_entry將欄位關掉後,新增其他單據時應該要先將前面被關掉的欄位通通打開)
   CALL cl_set_comp_entry("sfaa001,sfaa003,sfaa057,sfaa002,sfaa004,sfaa005,sfaa006,sfaa007,sfaa008,sfaa063",TRUE)
   CALL cl_set_comp_entry("sfaa009,sfaa022,sfaa023,sfaa024,sfaa064,sfaa021,sfaa025,sfaa010,sfaa011,sfaa012",TRUE)
  #CALL cl_set_comp_entry("sfaa013,sfaa058,sfaa060,sfaa061,sfaa016,sfaa017,sfaa018,sfaa019,sfaa020,sfaa014",TRUE)   #161102-00012#1 mark
   CALL cl_set_comp_entry("sfaa013,sfaa058,sfaa060,sfaa016,sfaa017,sfaa018,sfaa019,sfaa020,sfaa014",TRUE)           #161102-00012#1 拿掉sfaa061
   CALL cl_set_comp_entry("sfaa028,sfaa015,sfaa029,sfaa026,sfaa030,sfaa031,sfaa062,sfaa032,sfaa068,sfaa072",TRUE)
   CALL cl_set_comp_entry("sfaa033,sfaa034,sfaa035,sfaa059,sfaa036,sfaa037,sfaa038,sfaa039,sfaa040,sfaa041",TRUE)
  #CALL cl_set_comp_entry("sfaa042,sfaa043,sfaa044,sfaa045,sfaa049,sfaa046,sfaa050,sfaa047,sfaa051,sfaa048,sfaa055,sfaa056",TRUE)   #161102-00012#1 mark
   CALL cl_set_comp_entry("sfaa042,sfaa043,sfaa044",TRUE)   #161102-00012#1 拿掉sfaa045,sfaa049,sfaa046,sfaa050,sfaa047,sfaa051,sfaa048,sfaa055,sfaa056
#160719-00004#1-e add

   #end add-point

END FUNCTION

################################################################################
# Descriptions...: 單頭欄位關閉設定
# Memo...........:
# Usage..........: CALL asft300_set_no_entry(p_cmd)
# Input parameter: p_cmd
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........: 160616-00014 by whitney
################################################################################
PRIVATE FUNCTION asft300_set_no_entry(p_cmd)
   #add-point:set_no_entry段define(客製用) name="set_no_entry.define_customerization"

   #end add-point
   DEFINE p_cmd   LIKE type_t.chr1
   #add-point:set_no_entry段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_no_entry.define"
   DEFINE l_n          LIKE type_t.num5   
   DEFINE l_fields     STRING
   DEFINE l_imaf055    LIKE imaf_t.imaf055  #160519-00022#17-add
   DEFINE l_imaf061    LIKE imaf_t.imaf061  #160519-00022#17-add   
   #end add-point     
   
   #add-point:Function前置處理  name="set_no_entry.pre_function"

   #end add-point
   
   IF p_cmd = 'u' AND g_chkey = 'N' THEN
      CALL cl_set_comp_entry("sfaadocno",FALSE)
      #根據azzi850使用者身分開關特定欄位
      IF NOT cl_null(g_no_entry) THEN
         CALL cl_set_comp_entry(g_no_entry,FALSE)
      END IF
      #add-point:set_no_entry段欄位控制 name="set_no_entry.field_control"
      #20150730 by wuxja mark  --begin--这样写会导致数组越界      
      ##dorislai-20150711-add----(S)
      #IF g_sfab_d[l_ac].sfab001 = '6' THEN
      #   CALL cl_set_comp_entry("sfab004,sfab005",FALSE)
      #END IF
      ##dorislai-20150711-add----(E)
      #20150730 by wuxja mark  --end--
      #end add-point
   END IF
   
   IF p_cmd = 'u' THEN  #docno,ld欄位確認是絕對關閉
      CALL cl_set_comp_entry("sfaadocno",FALSE)
   END IF

   IF p_cmd = 'u' THEN  #docdt欄位依照設定關閉(FALSE則為設定不同意修正)
      IF NOT cl_chk_update_docdt() THEN
         CALL cl_set_comp_entry("sfaadocdt",FALSE)
      END IF
   END IF
   
   #add-point:set_no_entry段欄位控制後 name="set_no_entry.after_control"
   
   #有單身資料時，限制不可修改，以免已存在的單身資料與單頭不合
   #工單類型、發料制度、工單來源、來源單號項次項序分批序、生產料號、BOM特性、生產數量、生產單位、工單來源頁籤
   LET l_n = 0
   SELECT COUNT(1) INTO l_n
     FROM sfba_t
    WHERE sfbaent = g_enterprise
      AND sfbasite = g_site
      AND sfbadocno = g_sfaa_m.sfaadocno
  #IF l_n > 0 THEN                                     #160729-00016#1 mark
   IF l_n > 0 OR g_action_choice1 = "reproduce" THEN   #160729-00016#1 mod
      CALL cl_set_comp_entry("sfaa003,sfaa057,sfaa004,sfaa005,sfaa006,sfaa007,sfaa008,sfaa063,l_sfaa007,sfaa010,sfaa011,sfaa012,sfaa013",FALSE)
   END IF
   
   #161116-00048#1 add--s
   #如果为工艺工单，控制工单类型必须为厂内的，且不能输入
   IF g_sfaa_m.sfaa061 = 'Y' THEN
      LET g_sfaa_m.sfaa057 = '1'
      DISPLAY BY NAME g_sfaa_m.sfaa057
      CALL cl_set_comp_entry("sfaa057",FALSE)
   END IF
   #161116-00048#1 add--e
   
   #依單據別設定aooi200的欄位預設值不可更改，將欄位關閉
   IF NOT cl_null(g_sfaa_m.sfaadocno) THEN
      LET l_fields = ''
      CALL s_aooi200_get_doc_fields(g_site,'1',g_sfaa_m.sfaadocno) RETURNING l_fields
#160719-00004#1-s
#     CALL cl_set_comp_entry(l_fields,TRUE)
      CALL cl_set_comp_entry(l_fields,FALSE)
#160719-00004#1-e
   END IF
   
   #3.拆件式工單才能維護前工單單號
   IF g_sfaa_m.sfaa003 <> '5' THEN 
      CALL cl_set_comp_entry("sfaa025",FALSE)
   END IF
   
   IF g_sfaa_m.sfaa057 = '2' THEN
      #委外不可以走FQC
      LET g_sfaa_m.sfaa044 = 'N'
      DISPLAY BY NAME g_sfaa_m.sfaa044
      CALL cl_set_comp_entry("sfaa044",FALSE)
   ELSE
      #廠內不可以維護協作據點
      CALL cl_set_comp_entry("sfaa018",FALSE)
   END IF
   
   #3.計劃,4.母工單轉入不可以變更工單來源
   IF g_sfaa_m_t.sfaa005 MATCHES '[34]' THEN
      CALL cl_set_comp_entry('sfaa005',FALSE)
   END IF
   
   #工單來源為0.人工輸入,1.MULTI,4.母工單轉入不能維護來源單號
   IF g_sfaa_m.sfaa005 MATCHES '[014]' THEN
      CALL cl_set_comp_entry("sfaa006,sfaa007,sfaa008,sfaa063,l_sfaa007",FALSE)
   END IF
   
   #工單來源為0.人工輸入,1.MULTI才可以維護生產料號,特性
   IF g_sfaa_m.sfaa005 NOT MATCHES '[01]' THEN
      CALL cl_set_comp_entry('sfaa010,sfaa011',FALSE)
   END IF
   
   #2.訂單,6.獨立需求單,7.MPS計劃不能維護參考客戶
   IF g_sfaa_m.sfaa005 MATCHES '[267]' THEN
      CALL cl_set_comp_entry("sfaa009",FALSE)
   END IF
   
   #160727-00025#1---s
   #模具工单制程否直接给Y，制程编号栏位都可以维护，不管单别参数如何设置
   IF g_sfaa_m.sfaa003 = '5' THEN
      LET g_sfaa_m.sfaa061 = 'Y'
      DISPLAY BY NAME g_sfaa_m.sfaa061
      CALL cl_set_comp_entry("sfaa061",FALSE)
      CALL cl_set_comp_entry("sfaa016",TRUE)
   END IF
   #160727-00025#1---e
   
   #製程
   IF g_sfaa_m.sfaa061 = 'N' THEN
      CALL cl_set_comp_entry("sfaa016",FALSE)
   END IF 
   
   #參考單位>數量
   IF cl_null(g_sfaa_m.sfaa060) THEN
      CALL cl_set_comp_entry('sfaa058',FALSE)
   END IF

   #160519-00022#17-s-add-(S)
   #批號
   CALL s_axmt540_get_imaf(g_sfaa_m.sfaa010) RETURNING l_imaf055,l_imaf061

   IF l_imaf061 = '2' THEN
      CALL cl_set_comp_entry("sfaa059",FALSE)
   END IF
   #160519-00022#17-e-add-(E)
   #161227-00044#1-s-add
   IF g_sfaa_m.sfaa057 <> '2' THEN
      CALL cl_set_comp_required("sfaa017",FALSE)   
   END IF
   #161227-00044#1-e-add
   
   #end add-point

END FUNCTION

################################################################################
# Descriptions...: 單身欄位開啟設定
# Memo...........:
# Usage..........: CALL asft300_set_entry_b(p_cmd)
# Input parameter: p_cmd
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_set_entry_b(p_cmd)
   #add-point:set_entry_b段define(客製用) name="set_entry_b.define_customerization"

   #end add-point     
   DEFINE p_cmd   LIKE type_t.chr1   
   #add-point:set_entry_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_entry_b.define"
   
   #end add-point     
   
   #add-point:Function前置處理  name="set_entry_b.pre_function"

   #end add-point
    
   IF p_cmd = 'a' THEN
      CALL cl_set_comp_entry("",TRUE)
      #add-point:set_entry段欄位控制 name="set_entry_b.field_control"

      #end add-point  
   END IF
   
   #add-point:set_entry_b段 name="set_entry_b.set_entry_b"
   
   CALL cl_set_comp_entry("sfba010,sfba011",TRUE)  #160407-00017#1 add
   
   CALL cl_set_comp_entry('sfba009',TRUE)
   
   CALL cl_set_comp_entry('sfba023,sfba024',TRUE)
   
   CALL cl_set_comp_entry("sfba021",TRUE)
   
   #160126-00020#1-add-(S)
   CALL cl_set_comp_entry("sfba029,sfba030",TRUE)
  #CALL cl_set_comp_required("sfba029,sfba030",FALSE)  #160519-00022#17 mark
   #160126-00020#1-add-(E)
   CALL cl_set_comp_required("sfba030",TRUE)      #160519-00008#17
  #CALL cl_set_comp_entry("sfba022",TRUE)  #160906-00033#1   #170330-00008#1 mark
   
   #end add-point
END FUNCTION

################################################################################
# Descriptions...: 單身欄位關閉設定
# Memo...........:
# Usage..........: CALL asft300_set_no_entry_b(p_cmd)
# Input parameter: p_cmd
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_set_no_entry_b(p_cmd)
   #add-point:set_no_entry_b段define(客製用) name="set_no_entry_b.define_customerization"

   #end add-point
   DEFINE p_cmd   LIKE type_t.chr1
   #add-point:set_no_entry_b段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_no_entry_b.define"
   DEFINE l_success    LIKE type_t.num5
   DEFINE l_ooba002    LIKE ooba_t.ooba002
   DEFINE l_imaa005    LIKE imaa_t.imaa005
   DEFINE l_imaf055    LIKE imaf_t.imaf055  #160126-00020#1-add
   DEFINE l_imaf061    LIKE imaf_t.imaf061  #160126-00020#1-add
   #end add-point
   
   #add-point:Function前置處理  name="set_no_entry_b.pre_function"

   #end add-point
   
   IF p_cmd = 'u' AND g_chkey = 'N' THEN
      CALL cl_set_comp_entry("",FALSE)
      #add-point:set_no_entry_b段欄位控制 name="set_no_entry_b.field_control"

      #end add-point
   END IF
   
   #add-point:set_no_entry_b段 name="set_no_entry_b.set_no_entry_b"
   
   #160407-00017#1 add str
   IF NOT cl_null(g_sfba_d[l_ac].sfba001) OR g_sfba_d[l_ac].sfbaseq1 != 0 THEN
      CALL cl_set_comp_entry("sfba010,sfba011",FALSE)
   END IF
   #160407-00017#1 add end
   
   #倒扣料
   IF g_sfaa_m.sfaa004 = '2' THEN
      CALL cl_set_comp_entry('sfba009',FALSE)
   END IF
   
   CALL s_aooi200_get_slip(g_sfaa_m.sfaadocno) RETURNING l_success,l_ooba002
   
   CASE g_sfba_d[l_ac].sfba008
      WHEN '1'  #主要材料
         #主要材料可修改調整應發量
         IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0034') = 'N' THEN
            CALL cl_set_comp_entry("sfba023,sfba024",FALSE) #161213-00010#1 add sfba023
         ELSE
            CALL cl_set_comp_entry("sfba023",FALSE)         #161213-00010#1 add 主要材料标准应发量栏位不可修改    
         END IF
      WHEN '2'  #次要材料
         #次要材料可修改標準應發量、調整應發量
         IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0035') = 'N' THEN
            CALL cl_set_comp_entry("sfba023,sfba024",FALSE)
         END IF
      WHEN '3'  #間接材料
         #間接材料可修改
         IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0036') = 'N' THEN
            CALL cl_set_comp_entry("sfba023,sfba024",FALSE)
         END IF
      WHEN '4'  #參考材料
   END CASE
   
   #產品特徵
   LET l_imaa005 = ''
   SELECT imaa005 INTO l_imaa005
     FROM imaa_t
    WHERE imaaent = g_enterprise
      AND imaa001 = g_sfba_d[l_ac].sfba006
   IF cl_null(l_imaa005) THEN
      CALL cl_set_comp_entry("sfba021",FALSE)
      LET g_sfba_d[l_ac].sfba021 = ' '
   END IF
   
   #160126-00020#1-add-(S)
   #庫存管理特微,批號
   CALL s_axmt540_get_imaf(g_sfba_d[l_ac].sfba006) RETURNING l_imaf055,l_imaf061
   #160519-00008#17--(S)
   IF l_imaf055 <> '1' THEN
      CALL cl_set_comp_required("sfba030",FALSE)
   END IF
   #160519-00008#17--(E)
   CASE l_imaf055
      WHEN '1'  #必須有庫存管理特徵
        #CALL cl_set_comp_required("sfba030",TRUE)  #160519-00022#17 mark
         #160519-00008#17--(S)
         IF g_sfba_d[l_ac].sfba030 = ' ' THEN
            LET g_sfba_d[l_ac].sfba030 = ''
         END IF
         #160519-00008#17--(E)
      WHEN '2'  #不可有庫存管理特徵
         CALL cl_set_comp_entry("sfba030",FALSE)
   END CASE
   CASE l_imaf061
      WHEN '1'  #必須有批號
        #CALL cl_set_comp_required("sfba029",TRUE)  #160519-00022#17 mark
      WHEN '2'  #不可有批號
         CALL cl_set_comp_entry("sfba029",FALSE)
   END CASE
   #160126-00020#1-add-(E)
   
   #160906-00033#1-s
  #IF g_sfba_d[l_ac].replace = '0' THEN    #170330-00008#1 mark
      CALL cl_set_comp_entry("sfba022",FALSE)
  #END IF                                  #170330-00008#1 mark
   #160906-00033#1-e
   #170329-00013#1 add --(S)--
   CALL cl_set_comp_entry('sfba035',FALSE)
   #170329-00013#1 add --(E)--
   #end add-point
END FUNCTION

################################################################################
# Descriptions...: 生产料号明细页签sfac006 特征栏位开启关闭
# Memo...........:
# Usage..........: CALL asft300_set_entry_sfac()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_set_entry_sfac()
DEFINE l_n        LIKE type_t.num5

   #160503-00004 by whitney add start
   CALL cl_set_comp_entry("sfac002",TRUE)
   CALL cl_set_comp_entry("sfac001",TRUE)   #170113-00037#1 add
   IF g_sfac_d[l_ac].sfac002 = '1' THEN
      CALL cl_set_comp_entry("sfac002",FALSE)
      CALL cl_set_comp_entry("sfac001",FALSE)   #170113-00037#1 add
   END IF
   #160503-00004 by whitney add end

   #主件有维护特征
   CALL cl_set_comp_entry("sfac006",FALSE)
   IF NOT cl_null(g_sfac_d[l_ac].sfac002) AND g_sfac_d[l_ac].sfac002 = '2' THEN
      LET l_n = 0
      SELECT COUNT(1) INTO l_n
        FROM sfac_t 
       WHERE sfacent = g_enterprise
         AND sfacsite = g_site
         AND sfacdocno = g_sfaa_m.sfaadocno
         AND sfac002 = '1'
         AND sfac006 IS NOT NULL
      IF l_n > 0 THEN
         CALL cl_set_comp_entry("sfac006",TRUE)
      END IF
   END IF

END FUNCTION

################################################################################
# Descriptions...: 單頭權限開啟
# Memo...........:
# Usage..........: CALL asft300_set_act_visible()
# Input parameter: 
# Return code....: 
# Date & Author..: 160621-00002 By whitney
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_set_act_visible()
   #add-point:set_act_visible段define(客製用) name="set_act_visible.define_customerization"

   #end add-point
   #add-point:set_act_visible段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_act_visible.define"

   #end add-point
   #add-point:set_act_visible段 name="set_act_visible.set_act_visible"
   
   CALL cl_set_act_visible("statechange,insert,modify,modify_detail,delete,reproduce,mainhidden", TRUE)
   CALL cl_set_act_visible("open_asft300_05,open_asft300_07", TRUE)  #150730 add open_asft300_07
   
   CALL cl_set_act_visible("add_allotment,gen_apmt400,gen_apmt500",TRUE)  #160727-00025#1
   CALL cl_set_act_visible("open_demo",TRUE)  #161031-00025#17
   CALL cl_set_act_visible("gen_allotment,del_allotment",TRUE)           #170307-00052#1 add
   #end add-point
END FUNCTION

################################################################################
# Descriptions...: 單頭權限關閉
# Memo...........:
# Usage..........: CALL asft300_set_act_no_visible()
# Input parameter: 
# Return code....: 
# Date & Author..: 160621-00002 By whitney
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_set_act_no_visible()
   #add-point:set_act_no_visible段define(客製用) name="set_act_no_visible.define_customerization"

   #end add-point
   #add-point:set_act_no_visible段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_act_no_visible.define"

   #end add-point
   #add-point:set_act_no_visible段 name="set_act_no_visible.set_act_no_visible"
   
   #若無資料則關閉相關功能
   IF g_browser_cnt = 0 THEN
      CALL cl_set_act_visible("statechange,modify,modify_detail,delete,reproduce,mainhidden", FALSE)
      CALL cl_navigator_setting(0,0)
   END IF
   # N未確認/D抽單/R已拒絕允許修改
   IF g_sfaa_m.sfaastus NOT MATCHES "[NDR]" THEN
      CALL cl_set_act_visible("modify,delete,modify_detail", FALSE)
   END IF
   
   IF g_sfaa_m.sfaastus != 'F' THEN
      CALL cl_set_act_visible("open_asft300_05", FALSE)
   END IF
   #150730 add  --begin--
   IF g_sfaa_m.sfaastus != 'N' OR g_sfaa_m.sfaa003 != '3' THEN
      CALL cl_set_act_visible("open_asft300_07", FALSE)
   END IF
   #150730 add  --end--
   
   #160727-00025#1---s
   #已確認或已發出狀態下可以使用
   IF g_sfaa_m.sfaastus NOT MATCHES '[YF]' THEN
      CALL cl_set_act_visible("add_allotment",FALSE) 
   END IF
   
   #已確認後的狀態都可以使用
   IF g_sfaa_m.sfaastus MATCHES '[NDR]' THEN
      CALL cl_set_act_visible("gen_apmt400,gen_apmt500",FALSE) 
   END IF

   IF g_sfaa_m.sfaa003 = '5' THEN
      CALL cl_set_act_visible("open_asft300_07",FALSE)
   ELSE
      CALL cl_set_act_visible("add_allotment",FALSE)
   END IF
   #160727-00025#1---e
   #161031-00025#17-s
   IF g_sfaa_m.sfaastus MATCHES '[CMEX]' THEN
      CALL cl_set_act_visible("open_demo",FALSE) 
   END IF
   #161031-00025#17-e
   
   #170307-00052#1 add --(S)--
   #工單已結案不可執行產生備料,刪除備料
   IF g_sfaa_m.sfaastus MATCHES '[CMEX]' THEN
      CALL cl_set_act_visible("gen_allotment,del_allotment",FALSE) 
   END IF
   #170307-00052#1 add --(E)--
   #end add-point
END FUNCTION

################################################################################
# Descriptions...: 外部參數搜尋
# Memo...........:
# Usage..........: CALL asft300_default_search()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_default_search()
   #add-point:default_search段define(客製用) name="default_search.define_customerization"

   #end add-point  
   DEFINE li_idx     LIKE type_t.num10
   DEFINE li_cnt     LIKE type_t.num10
   DEFINE ls_wc      STRING
   DEFINE la_wc      DYNAMIC ARRAY OF RECORD
          tableid    STRING,
          wc         STRING
          END RECORD
   DEFINE ls_where   STRING
   #add-point:default_search段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="default_search.define"
                  
   #end add-point  
   
   #add-point:Function前置處理 name="default_search.before"
                  
   #end add-point  
   
   LET g_pagestart = 1
   
   IF cl_null(g_order) THEN
      LET g_order = "ASC"
   END IF
   
   
   #160727-00025#1--s
   #第一個參數用來區分工單類型
   #IF NOT cl_null(g_argv[01]) THEN
   #   LET ls_wc = ls_wc, " sfaadocno = '", g_argv[01], "' AND "
   #END IF
   #
   ##add-point:default_search段after sql name="default_search.after_sql"
   ##160323-00004 add start -----------------------
   ##傳單號範圍至asft300,一次查詢可查詢出多個單號資料
   #IF NOT cl_null(g_argv[02]) THEN
   #   LET ls_wc = ls_wc, g_argv[02], " AND "
   #END IF
   ##160323-00004 add end   -----------------------
   ##end add-point  
   
   IF NOT cl_null(g_argv[02]) THEN
      LET ls_wc = ls_wc, " sfaadocno = '", g_argv[02], "' AND "
   END IF
   
   #add-point:default_search段after sql name="default_search.after_sql"
   #160323-00004 add start -----------------------
   #傳單號範圍至asft300,一次查詢可查詢出多個單號資料
   IF NOT cl_null(g_argv[03]) THEN
      LET ls_wc = ls_wc, g_argv[03], " AND "
   END IF
   #160323-00004 add end   -----------------------
   
   #160727-00025#1---e
   
   IF NOT cl_null(ls_wc) THEN
      LET g_wc = ls_wc.subString(1,ls_wc.getLength()-5)
      LET g_default = TRUE
   ELSE
      #若無外部參數則預設為1=2
      LET g_default = FALSE
      
      #預設查詢條件
      CALL cl_qbe_get_default_qryplan() RETURNING ls_where
      IF NOT cl_null(ls_where) THEN
         CALL util.JSON.parse(ls_where, la_wc)
         INITIALIZE g_wc, g_wc2,g_wc2_table1,g_wc2_extend TO NULL
         INITIALIZE g_wc_sfab TO NULL
         INITIALIZE g_wc_sfac TO NULL
         INITIALIZE g_wc_sfaf TO NULL
         INITIALIZE g_wc_seq  TO NULL   #170124-00005#1
 
         FOR li_idx = 1 TO la_wc.getLength()
            CASE
               WHEN la_wc[li_idx].tableid = "sfaa_t" 
                  LET g_wc = la_wc[li_idx].wc
               WHEN la_wc[li_idx].tableid = "sfba_t" 
                  LET g_wc2_table1 = la_wc[li_idx].wc
               WHEN la_wc[li_idx].tableid = "sfab_t" 
                  LET g_wc_sfab = la_wc[li_idx].wc
               WHEN la_wc[li_idx].tableid = "sfac_t" 
                  LET g_wc_sfac = la_wc[li_idx].wc
               WHEN la_wc[li_idx].tableid = "sfaf_t" 
                  LET g_wc_sfaf = la_wc[li_idx].wc
               WHEN la_wc[li_idx].tableid = "EXTENDWC"
                  LET g_wc2_extend = la_wc[li_idx].wc
            END CASE
         END FOR
         IF NOT cl_null(g_wc) OR NOT cl_null(g_wc2_table1) 
            OR NOT cl_null(g_wc_sfab)
            OR NOT cl_null(g_wc_sfac)
            OR NOT cl_null(g_wc_sfaf)
            OR NOT cl_null(g_wc_seq)   #170124-00005#1
            OR NOT cl_null(g_wc2_extend)
            THEN
            #組合g_wc2
            IF g_wc2_table1 <> " 1=1" AND NOT cl_null(g_wc2_table1) THEN
               LET g_wc2 = g_wc2_table1
            END IF
            IF g_wc_sfab <> " 1=1" AND NOT cl_null(g_wc_sfab) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc_sfab
            END IF
            IF g_wc_sfac <> " 1=1" AND NOT cl_null(g_wc_sfac) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc_sfac
            END IF
            IF g_wc_sfaf <> " 1=1" AND NOT cl_null(g_wc_sfaf) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc_sfaf
            END IF
            #170124-00005#1-s-add
            IF g_wc_seq <> " 1=1" AND NOT cl_null(g_wc_seq) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc_seq
            END IF
            #170124-00005#1-e-add
            IF g_wc2_extend <> " 1=1" AND NOT cl_null(g_wc2_extend) THEN
               LET g_wc2 = g_wc2 ," AND ", g_wc2_extend
            END IF
         
            IF g_wc2.subString(1,5) = " AND " THEN
               LET g_wc2 = g_wc2.subString(6,g_wc2.getLength())
            END IF
         END IF
      END IF
    
      IF cl_null(g_wc) AND cl_null(g_wc2) THEN
         LET g_wc = " 1=2"
      END IF
   END IF
   
   #add-point:default_search段結束前 name="default_search.after"
   #2014/10/30 by stellar add -------- (S)
   #給予批次串程式使用
   IF NOT cl_null(g_argv[03]) THEN
      LET g_wc = " ", g_argv[03]
   END IF
   #2014/10/30 by stellar add -------- (E)
   #end add-point  
 
   IF g_wc.getIndexOf(" 1=2", 1) THEN
      LET g_default = TRUE
   END IF

END FUNCTION

################################################################################
# Descriptions...: 確認碼變更
# Memo...........:
# Usage..........: CALL asft300_statechange()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........: 160621-00002 by whitney
################################################################################
PRIVATE FUNCTION asft300_statechange()
   #add-point:statechange段define(客製用) name="statechange.define_customerization"
   
   #end add-point
   DEFINE lc_state LIKE type_t.chr5
   #add-point:statechange段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="statechange.define"
   DEFINE l_success    LIKE type_t.num5
   DEFINE l_ooba002    LIKE ooba_t.ooba002
   
   #end add-point
   
   #add-point:Function前置處理 name="statechange.before"
   
   #end add-point
   
   ERROR ""     #清空畫面右下側ERROR區塊
   
   IF g_sfaa_m.sfaadocno IS NULL
   
   THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = ""
      LET g_errparam.code   = "std-00003"
      LET g_errparam.popup  = FALSE
      CALL cl_err()
      RETURN
   END IF
   
   CALL s_transaction_begin()
   
   OPEN asft300_cl USING g_enterprise,g_site,g_sfaa_m.sfaadocno
   IF STATUS THEN
      CLOSE asft300_cl
      CALL s_transaction_end('N','0')
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "OPEN asft300_cl:"
      LET g_errparam.code   = STATUS
      LET g_errparam.popup  = TRUE
      CALL cl_err()
      RETURN
   END IF
   
   #顯示最新的資料
   EXECUTE asft300_master_referesh USING g_sfaa_m.sfaadocno
      INTO g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.oobal004,g_sfaa_m.sfaadocdt,g_sfaa_m.sfaa002,
           g_sfaa_m.sfaa002_desc,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,
           g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,
           g_sfaa_m.sfaa009,g_sfaa_m.sfaa009_desc,g_sfaa_m.sfaa022,g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,
           g_sfaa_m.sfaa024,g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,
           g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1,g_sfaa_m.sfaa012,g_sfaa_m.sfaa013,g_sfaa_m.sfaa013_desc,
           g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa060_desc,g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,
           g_sfaa_m.sfaa016_desc,g_sfaa_m.sfaa017,g_sfaa_m.sfaa017_desc,g_sfaa_m.sfaa018,g_sfaa_m.sfaa018_desc,
           g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,g_sfaa_m.sfaa068_desc,g_sfaa_m.sfaa014,
           g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.imae020,g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,
           g_sfaa_m.sfaa028_desc,g_sfaa_m.sfaa029,g_sfaa_m.sfaa029_desc,g_sfaa_m.sfaa030,g_sfaa_m.sfaa030_desc,
           g_sfaa_m.sfaa031,g_sfaa_m.sfaa031_desc,g_sfaa_m.sfaa032,g_sfaa_m.sfaa033,g_sfaa_m.sfaa034,
           g_sfaa_m.sfaa034_desc,g_sfaa_m.sfaa035,g_sfaa_m.sfaa035_desc,g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,
           g_sfaa_m.sfaa037,g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,
           g_sfaa_m.sfaa041,g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,
           g_sfaa_m.sfaa070,g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,
           g_sfaa_m.sfaa065,g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,
           #g_sfaa_m.sfaa056,g_sfaa_m.ooff013,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,    #161031-00025#17 mark
           g_sfaa_m.sfaa056,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,                      #161031-00025#17 add
           g_sfaa_m.sfaaowndp_desc,g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtid_desc,g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdp_desc,
           g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,g_sfaa_m.sfaamodid_desc,g_sfaa_m.sfaamoddt,g_sfaa_m.sfaacnfid,
           g_sfaa_m.sfaacnfid_desc,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,g_sfaa_m.sfaapstid_desc,g_sfaa_m.sfaapstdt
   
   #檢查是否允許此動作
   IF NOT asft300_action_chk() THEN
      CLOSE asft300_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #將資料顯示到畫面上
   DISPLAY BY NAME g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.oobal004,g_sfaa_m.sfaadocdt,g_sfaa_m.sfaa002,
           g_sfaa_m.sfaa002_desc,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,
           g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,
           g_sfaa_m.l_sfaa007,g_sfaa_m.sfaa009,g_sfaa_m.sfaa009_desc,g_sfaa_m.sfaa022,g_sfaa_m.l_sfaa023,
           g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,g_sfaa_m.sfaa024,g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,
           g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1,g_sfaa_m.sfaa012,
           g_sfaa_m.sfaa013,g_sfaa_m.sfaa013_desc,g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa060_desc,
           g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,g_sfaa_m.sfaa016_desc,g_sfaa_m.sfaa017,g_sfaa_m.sfaa017_desc,
           g_sfaa_m.sfaa018,g_sfaa_m.sfaa018_desc,g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,
           g_sfaa_m.sfaa068_desc,g_sfaa_m.sfaa014,g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.imae020,
           g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,g_sfaa_m.sfaa028_desc,g_sfaa_m.sfaa029,g_sfaa_m.sfaa029_desc,
           g_sfaa_m.sfaa030,g_sfaa_m.sfaa030_desc,g_sfaa_m.sfaa031,g_sfaa_m.sfaa031_desc,g_sfaa_m.sfaa032,
           g_sfaa_m.sfaa033,g_sfaa_m.sfaa034,g_sfaa_m.sfaa034_desc,g_sfaa_m.sfaa035,g_sfaa_m.sfaa035_desc,
           g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,g_sfaa_m.sfaa037,g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,
           g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,g_sfaa_m.sfaa041,g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,
           g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,g_sfaa_m.sfaa070,g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,
           g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,g_sfaa_m.sfaa065,g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,
           #g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,g_sfaa_m.sfaa056,g_sfaa_m.ooff013,g_sfaa_m.sfaaownid,        #161031-00025#17 mark
           g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,g_sfaa_m.sfaa056,g_sfaa_m.sfaaownid,                          #161031-00025#17 add
           g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,g_sfaa_m.sfaaowndp_desc,g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtid_desc,
           g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdp_desc,g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,g_sfaa_m.sfaamodid_desc,
           g_sfaa_m.sfaamoddt,g_sfaa_m.sfaacnfid,g_sfaa_m.sfaacnfid_desc,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,
           g_sfaa_m.sfaapstid_desc,g_sfaa_m.sfaapstdt
   
   CALL asft300_status_show()
   
   #add-point:資料刷新後 name="statechange.after_refresh"
   
   #end add-point
   
   MENU "" ATTRIBUTES (STYLE="popup")
      BEFORE MENU
         HIDE OPTION "approved"
         HIDE OPTION "rejection"
         CASE g_sfaa_m.sfaastus
            
            WHEN "A"
               HIDE OPTION "approved"
            WHEN "C"
               HIDE OPTION "closed"
            WHEN "D"
               HIDE OPTION "withdraw"
            WHEN "E"
               HIDE OPTION "closed_irregular"
            WHEN "F"
               HIDE OPTION "released"
            WHEN "M"
               HIDE OPTION "costing_closed"
            WHEN "N"
               HIDE OPTION "unconfirmed"
            WHEN "R"
               HIDE OPTION "rejection"
            WHEN "W"
               HIDE OPTION "signing"
            WHEN "Y"
               HIDE OPTION "confirmed"
            WHEN "X"
               HIDE OPTION "invalid"
         END CASE
     
      #add-point:menu前 name="statechange.before_menu"
      CALL cl_set_act_visible("unconfirmed,unreleased,released,invalid,confirmed",TRUE)
      #無條件關結案
      CALL cl_set_act_visible("closed,costing_closed,closed_irregular",FALSE)
      #提交和抽單一開始先無條件關
      CALL cl_set_act_visible("signing,withdraw",FALSE)
      
      CASE g_sfaa_m.sfaastus
         #已核准只能顯示確認;其餘應用功能皆隱藏
         WHEN "A"
            CALL cl_set_act_visible("confirmed ",TRUE)
            CALL cl_set_act_visible("unconfirmed,invalid,unreleased,released",FALSE)
         WHEN "C"
            CALL cl_set_act_visible("unconfirmed,unreleased,released,invalid,confirmed",FALSE)
            CALL s_transaction_end('N','0')   #160907-00038#1 add
            RETURN                            #160907-00038#1 add
         WHEN "D"
            CALL cl_set_act_visible("unconfirmed,unreleased,released,confirmed",FALSE)
         WHEN "E"
         WHEN "F"
            CALL cl_set_act_visible("unconfirmed,released,invalid,confirmed",FALSE)
         WHEN "M"
         WHEN "N"
            CALL cl_set_act_visible("unconfirmed,released,unreleased",FALSE)
            #需提交至BPM時，則顯示「提交」功能並隱藏「確認」功能
            IF cl_bpm_chk() THEN
               CALL cl_set_act_visible("signing",TRUE)
               CALL cl_set_act_visible("confirmed",FALSE)
            END IF
         #保留修改的功能(如作廢)，隱藏其他應用功能
         WHEN "R"
            CALL cl_set_act_visible("unconfirmed,unreleased,released,confirmed",FALSE)
         #送簽中只能顯示抽單;其餘應用功能皆隱藏
         WHEN "W"
            CALL cl_set_act_visible("withdraw",TRUE)
            CALL cl_set_act_visible("unconfirmed,unreleased,released,invalid,confirmed",FALSE)
         WHEN "Y"
            CALL cl_set_act_visible("invalid,confirmed,unreleased",FALSE)
         WHEN "X"
            CALL cl_set_act_visible("unconfirmed,released,unreleased,invalid,confirmed",FALSE)
            CALL s_transaction_end('N','0')   #160907-00038#1 add
            RETURN                            #160907-00038#1 add
      END CASE
      #end add-point
      #已核准
      ON ACTION approved
         IF cl_auth_chk_act("approved") THEN
            LET lc_state = "A"
            #add-point:action控制 name="statechange.approved"
            
            #end add-point
         END IF
         EXIT MENU
      #結案
      ON ACTION closed
         IF cl_auth_chk_act("closed") THEN
            LET lc_state = "C"
            #add-point:action控制 name="statechange.closed"
            CALL cl_err_collect_init()  #汇总错误讯息初始化
            IF NOT s_asft300_closed_chk(g_sfaa_m.sfaadocno) THEN
               CALL cl_err_collect_show()
               CLOSE asft300_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF
            IF NOT s_asft300_closed_upd(g_sfaa_m.sfaadocno) THEN
               CALL cl_err_collect_show()
               CLOSE asft300_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF
            CALL cl_err_collect_show()
            #end add-point
         END IF
         EXIT MENU
      #抽單
      ON ACTION withdraw
         IF cl_auth_chk_act("withdraw") THEN
            IF NOT asft300_draw_out() THEN
               CALL s_transaction_end('N','0')
            ELSE
               CALL s_transaction_end('Y','0')
            END IF
            #因應簽核行為, 該動作完成後不再進行後續處理
            #於此處直接返回
            CLOSE asft300_cl
            RETURN
         END IF
      #
      ON ACTION closed_irregular
         IF cl_auth_chk_act("closed_irregular") THEN
            LET lc_state = "E"
            #add-point:action控制
            
            #end add-point
         END IF
         EXIT MENU
      #已發出
      ON ACTION released
         IF cl_auth_chk_act("released") THEN
            LET lc_state = "F"
            #add-point:action控制
            CALL cl_err_collect_init()  #汇总错误讯息初始化
            IF NOT s_asft300_released_chk(g_sfaa_m.sfaadocno) THEN
               CALL cl_err_collect_show()
               CLOSE asft300_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF
            IF NOT s_asft300_released_upd(g_sfaa_m.sfaadocno) THEN
               CALL cl_err_collect_show()
               CLOSE asft300_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF
            CALL cl_err_collect_show()
            #end add-point
         END IF
         EXIT MENU
      #成本結案
      ON ACTION costing_closed
         IF cl_auth_chk_act("costing_closed") THEN
            LET lc_state = "M"
            #add-point:action控制
            
            #end add-point
         END IF
         EXIT MENU
      #未確認
      ON ACTION unconfirmed
         IF cl_auth_chk_act("unconfirmed") THEN
            LET lc_state = "N"
            #add-point:action控制 name="statechange.unconfirmed"
            CALL cl_err_collect_init()  #汇总错误讯息初始化
            IF NOT s_asft300_unconfirmed_chk(g_sfaa_m.sfaadocno) THEN
               CALL cl_err_collect_show()
               CLOSE asft300_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF
            IF NOT s_asft300_unconfirmed_upd(g_sfaa_m.sfaadocno) THEN
               CALL cl_err_collect_show()
               CLOSE asft300_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF
            CALL cl_err_collect_show()
            #end add-point
         END IF
         EXIT MENU
      #已拒絕
      ON ACTION rejection
         IF cl_auth_chk_act("rejection") THEN
            LET lc_state = "R"
            #add-point:action控制 name="statechange.rejection"
            
            #end add-point
         END IF
         EXIT MENU
      #提交
      ON ACTION signing
         IF cl_auth_chk_act("signing") THEN
            IF NOT asft300_send() THEN
               CALL s_transaction_end('N','0')
            ELSE
               CALL s_transaction_end('Y','0')
            END IF
            #因應簽核行為, 該動作完成後不再進行後續處理
            #於此處直接返回
            CLOSE asft300_cl
            RETURN
         END IF
      #已確認
      ON ACTION confirmed
         IF cl_auth_chk_act("confirmed") THEN
            LET lc_state = "Y"
            #add-point:action控制 name="statechange.confirmed"
            CALL cl_err_collect_init()  #汇总错误讯息初始化
            IF NOT s_asft300_confirmed_chk(g_sfaa_m.sfaadocno) THEN
               CALL cl_err_collect_show()
               CLOSE asft300_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF
            IF NOT cl_ask_confirm('aim-00108') THEN
               CALL cl_err_collect_show()
               CLOSE asft300_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF
            IF NOT s_asft300_confirmed_upd(g_sfaa_m.sfaadocno) THEN
               CALL cl_err_collect_show()
               CLOSE asft300_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF
            #170223-00044#1-s-add
            #當D-MFG-0040:工單確認後自動發放=Y 且前面確認動作成功時，變更lc_state = "F"
            CALL s_aooi200_get_slip(g_sfaa_m.sfaadocno) RETURNING l_success,l_ooba002
#            #D-MFG-0040:工單確認後自動發放
            IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0040') = 'Y' THEN
               LET lc_state = "F"
            END IF
            #170223-00044#1-e-add
            #170106-00030#1-s-mark
#            CALL s_aooi200_get_slip(g_sfaa_m.sfaadocno) RETURNING l_success,l_ooba002
#            #D-MFG-0040:工單確認後自動發放
#            IF cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0040') = 'Y' THEN
#               IF NOT s_asft300_released_upd(g_sfaa_m.sfaadocno) THEN
#                  CALL cl_err_collect_show()
#                  CLOSE asft300_cl
#                  CALL s_transaction_end('N','0')
#                  RETURN
#               ELSE
#                  LET lc_state = "F"
#               END IF
#            END IF
            #170106-00030#1-e-mark
            CALL cl_err_collect_show()
            #end add-point
         END IF
         EXIT MENU
      #作廢
      ON ACTION invalid
         IF cl_auth_chk_act("invalid") THEN
            LET lc_state = "X"
            #add-point:action控制 name="statechange.invalid"
            CALL cl_err_collect_init()  #汇总错误讯息初始化
            IF NOT s_asft300_invalid_chk(g_sfaa_m.sfaadocno) THEN
               CALL cl_err_collect_show()
               CLOSE asft300_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF
            IF NOT cl_ask_confirm('aim-00109') THEN
               CALL cl_err_collect_show()
               CLOSE asft300_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF
            IF NOT s_asft300_invalid_upd(g_sfaa_m.sfaadocno) THEN
               CALL cl_err_collect_show()
               CLOSE asft300_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF
            CALL cl_err_collect_show()
            #end add-point
         END IF
         EXIT MENU
      
      #add-point:stus控制 name="statechange.more_control"
      #發出還原
      ON ACTION unreleased
         IF cl_auth_chk_act("unreleased") THEN
            LET lc_state = 'Y'
            CALL cl_err_collect_init()  #汇总错误讯息初始化
            IF NOT s_asft300_unreleased_chk(g_sfaa_m.sfaadocno) THEN
               CALL cl_err_collect_show()
               CLOSE asft300_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF
            IF NOT s_asft300_unreleased_upd(g_sfaa_m.sfaadocno) THEN
               CALL cl_err_collect_show()
               CLOSE asft300_cl
               CALL s_transaction_end('N','0')
               RETURN
            END IF
            CALL cl_err_collect_show()
         END IF
         EXIT MENU
      #end add-point
      
   END MENU
   
   #確認被選取的狀態碼在清單中
   IF (lc_state <> "A"
      AND lc_state <> "C"
      AND lc_state <> "D"
      AND lc_state <> "E"
      AND lc_state <> "F"
      AND lc_state <> "M"
      AND lc_state <> "N"
      AND lc_state <> "R"
      AND lc_state <> "W"
      AND lc_state <> "Y"
      AND lc_state <> "X"
      ) OR 
      g_sfaa_m.sfaastus = lc_state OR cl_null(lc_state) THEN
      CLOSE asft300_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #add-point:stus修改前 name="statechange.b_update"
   
   #end add-point
   
   LET g_sfaa_m.sfaamodid = g_user
   LET g_sfaa_m.sfaamoddt = cl_get_current()
   LET g_sfaa_m.sfaastus = lc_state
   
   #異動狀態碼欄位/修改人/修改日期
   UPDATE sfaa_t 
      SET (sfaastus,sfaamodid,sfaamoddt) 
        = (g_sfaa_m.sfaastus,g_sfaa_m.sfaamodid,g_sfaa_m.sfaamoddt)     
    WHERE sfaaent = g_enterprise AND sfaadocno = g_sfaa_m.sfaadocno
   
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = ""
      LET g_errparam.code   = SQLCA.sqlcode
      LET g_errparam.popup  = FALSE
      CALL cl_err()
   ELSE
      CALL asft300_status_show()
      
      #撈取異動後的資料
      EXECUTE asft300_master_referesh USING g_sfaa_m.sfaadocno
         INTO g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.oobal004,g_sfaa_m.sfaadocdt,g_sfaa_m.sfaa002,
              g_sfaa_m.sfaa002_desc,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,
              g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,
              g_sfaa_m.sfaa009,g_sfaa_m.sfaa009_desc,g_sfaa_m.sfaa022,g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,
              g_sfaa_m.sfaa024,g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,
              g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1,g_sfaa_m.sfaa012,g_sfaa_m.sfaa013,g_sfaa_m.sfaa013_desc,
              g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa060_desc,g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,
              g_sfaa_m.sfaa016_desc,g_sfaa_m.sfaa017,g_sfaa_m.sfaa017_desc,g_sfaa_m.sfaa018,g_sfaa_m.sfaa018_desc,
              g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,g_sfaa_m.sfaa068_desc,g_sfaa_m.sfaa014,
              g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.imae020,g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,
              g_sfaa_m.sfaa028_desc,g_sfaa_m.sfaa029,g_sfaa_m.sfaa029_desc,g_sfaa_m.sfaa030,g_sfaa_m.sfaa030_desc,
              g_sfaa_m.sfaa031,g_sfaa_m.sfaa031_desc,g_sfaa_m.sfaa032,g_sfaa_m.sfaa033,g_sfaa_m.sfaa034,
              g_sfaa_m.sfaa034_desc,g_sfaa_m.sfaa035,g_sfaa_m.sfaa035_desc,g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,
              g_sfaa_m.sfaa037,g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,
              g_sfaa_m.sfaa041,g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,
              g_sfaa_m.sfaa070,g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,
              g_sfaa_m.sfaa065,g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,
              #g_sfaa_m.sfaa056,g_sfaa_m.ooff013,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,     #161031-00025#17 mark
              g_sfaa_m.sfaa056,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,                       #161031-00025#17 add
              g_sfaa_m.sfaaowndp_desc,g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtid_desc,g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdp_desc,
              g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,g_sfaa_m.sfaamodid_desc,g_sfaa_m.sfaamoddt,g_sfaa_m.sfaacnfid,
              g_sfaa_m.sfaacnfid_desc,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,g_sfaa_m.sfaapstid_desc,g_sfaa_m.sfaapstdt
      
      #將資料顯示到畫面上
      DISPLAY BY NAME g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.oobal004,g_sfaa_m.sfaadocdt,g_sfaa_m.sfaa002,
              g_sfaa_m.sfaa002_desc,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,
              g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,
              g_sfaa_m.l_sfaa007,g_sfaa_m.sfaa009,g_sfaa_m.sfaa009_desc,g_sfaa_m.sfaa022,g_sfaa_m.l_sfaa023,
              g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,g_sfaa_m.sfaa024,g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,
              g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1,g_sfaa_m.sfaa012,
              g_sfaa_m.sfaa013,g_sfaa_m.sfaa013_desc,g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa060_desc,
              g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,g_sfaa_m.sfaa016_desc,g_sfaa_m.sfaa017,g_sfaa_m.sfaa017_desc,
              g_sfaa_m.sfaa018,g_sfaa_m.sfaa018_desc,g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,
              g_sfaa_m.sfaa068_desc,g_sfaa_m.sfaa014,g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.imae020,
              g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,g_sfaa_m.sfaa028_desc,g_sfaa_m.sfaa029,g_sfaa_m.sfaa029_desc,
              g_sfaa_m.sfaa030,g_sfaa_m.sfaa030_desc,g_sfaa_m.sfaa031,g_sfaa_m.sfaa031_desc,g_sfaa_m.sfaa032,
              g_sfaa_m.sfaa033,g_sfaa_m.sfaa034,g_sfaa_m.sfaa034_desc,g_sfaa_m.sfaa035,g_sfaa_m.sfaa035_desc,
              g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,g_sfaa_m.sfaa037,g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,
              g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,g_sfaa_m.sfaa041,g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,
              g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,g_sfaa_m.sfaa070,g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,
              g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,g_sfaa_m.sfaa065,g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,
              #g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,g_sfaa_m.sfaa056,g_sfaa_m.ooff013,g_sfaa_m.sfaaownid,   #161031-00025#17 mark
              g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,g_sfaa_m.sfaa056,g_sfaa_m.sfaaownid,                     #161031-00025#17 add
              g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,g_sfaa_m.sfaaowndp_desc,g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtid_desc,
              g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdp_desc,g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,g_sfaa_m.sfaamodid_desc,
              g_sfaa_m.sfaamoddt,g_sfaa_m.sfaacnfid,g_sfaa_m.sfaacnfid_desc,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,
              g_sfaa_m.sfaapstid_desc,g_sfaa_m.sfaapstdt
              
      #170313-00007#1 add --(S)--
      CALL s_aooi200_get_slip(g_sfaa_m.sfaadocno) RETURNING l_success,l_ooba002
      IF lc_state = 'F' AND cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0038') = '2' THEN
         CALL asft300_b_fill() 
      END IF
      #170313-00007#1 add --(E)--       
   END IF
   
   #add-point:stus修改後 name="statechange.a_update"
   
   #end add-point
   
   #add-point:statechange段結束前 name="statechange.after"
   
   #end add-point
   
   CLOSE asft300_cl
   CALL s_transaction_end('Y','0')
   
   #功能已完成,通報訊息中心
   CALL asft300_msgcentre_notify('statechange:'||lc_state)

END FUNCTION

################################################################################
# Descriptions...: 顯示正確的單身資料筆數
# Memo...........:
# Usage..........: CALL asft300_idx_chk()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_idx_chk()
   #add-point:idx_chk段define(客製用) name="idx_chk.define_customerization"
   
   #end add-point
   #add-point:idx_chk段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="idx_chk.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="idx_chk.pre_function"
   
   #end add-point
   
   IF g_current_page = 1 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_detail1")
      IF g_detail_idx > g_sfba_d.getLength() THEN
         LET g_detail_idx = g_sfba_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_sfba_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_sfba_d.getLength() TO FORMONLY.cnt
   END IF
   
   IF g_current_page = 2 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_sfab")
      IF g_detail_idx > g_sfab_d.getLength() THEN
         LET g_detail_idx = g_sfab_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_sfab_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_sfab_d.getLength() TO FORMONLY.cnt
   END IF
   IF g_current_page = 3 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_sfac")
      IF g_detail_idx > g_sfac_d.getLength() THEN
         LET g_detail_idx = g_sfac_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_sfac_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_sfac_d.getLength() TO FORMONLY.cnt
   END IF
   IF g_current_page = 4 THEN
      LET g_detail_idx = g_curr_diag.getCurrentRow("s_sfaf")
      IF g_detail_idx > g_sfaf_d.getLength() THEN
         LET g_detail_idx = g_sfaf_d.getLength()
      END IF
      IF g_detail_idx = 0 AND g_sfaf_d.getLength() <> 0 THEN
         LET g_detail_idx = 1
      END IF
      DISPLAY g_detail_idx TO FORMONLY.idx
      DISPLAY g_sfaf_d.getLength() TO FORMONLY.cnt
   END IF
   
   #add-point:idx_chk段other name="idx_chk.other"
                  
   #end add-point  

END FUNCTION

################################################################################
# Descriptions...: 單身陣列填充2
# Memo...........:
# Usage..........: CALL asft300_b_fill2(pi_idx)
# Input parameter: pi_idx
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_b_fill2(pi_idx)
   #add-point:b_fill2段define(客製用) name="b_fill2.define_customerization"

   #end add-point
   DEFINE pi_idx                 LIKE type_t.num10
   DEFINE li_ac                  LIKE type_t.num10
   DEFINE li_detail_idx_tmp      LIKE type_t.num10
   DEFINE ls_chk                 LIKE type_t.chr1
   #add-point:b_fill2段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="b_fill2.define"
                  
   #end add-point
   
   #add-point:Function前置處理  name="b_fill2.pre_function"

   #end add-point
   
   LET li_ac = l_ac 
   
   IF g_detail_idx <= 0 THEN
      RETURN
   END IF
   
   LET li_detail_idx_tmp = g_detail_idx
   
   #add-point:單身填充後 name="b_fill2.after_fill"
                  
   #end add-point
    
   LET l_ac = li_ac
   
   CALL asft300_detail_show()
   
   LET g_detail_idx = li_detail_idx_tmp

END FUNCTION

################################################################################
# Descriptions...: 單身填充確認
# Memo...........:
# Usage..........: CALL asft300_fill_chk(ps_idx)
# Input parameter: ps_idx
# Return code....: TRUE OR FALSE
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_fill_chk(ps_idx)
   #add-point:fill_chk段define(客製用) name="fill_chk.define_customerization"
   
   #end add-point
   DEFINE ps_idx        LIKE type_t.chr10
   #add-point:fill_chk段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="fill_chk.define"
   
   #end add-point
   
   #add-point:Function前置處理 name="fill_chk.before_chk"
   
   #end add-point
   
   #此funtion功能暫時停用(2015/1/12)
   #無論傳入值為何皆回傳true(代表要填充該單身)
   
   #全部為1=1 or null時回傳true
   IF (cl_null(g_wc2_table1) OR g_wc2_table1.trim() = '1=1')  AND
      (cl_null(g_wc_sfab) OR g_wc_sfab.trim() = '1=1')  AND
      (cl_null(g_wc_sfac) OR g_wc_sfac.trim() = '1=1')  AND
      (cl_null(g_wc_seq) OR g_wc_seq.trim() = '1=1')    AND   #170124-00005#1
      (cl_null(g_wc_sfaf) OR g_wc_sfaf.trim() = '1=1') THEN
      #add-point:fill_chk段other_chk name="fill_chk.other_chk"
      
      #end add-point
      RETURN TRUE
   END IF
   
   #add-point:fill_chk段after_chk name="fill_chk.after_chk"
   
   #end add-point
   
   RETURN TRUE

END FUNCTION

################################################################################
# Descriptions...: 
# Memo...........:
# Usage..........: CALL asft300_status_show()
# Input parameter: 
# Return code....: 
# Date & Author..: 160621-00002 By whitney
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_status_show()
   #add-point:status_show段define(客製用) name="status_show.define_customerization"
   
   #end add-point
   #add-point:status_show段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="status_show.define"
   
   #end add-point
   
   #add-point:status_show段status_show name="status_show.status_show"
   CASE g_sfaa_m.sfaastus
      WHEN "A"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/approved.png")
      WHEN "C"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/closed.png")
      WHEN "D"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/withdraw.png")
      WHEN "E"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/closed_irregular.png")
      WHEN "F"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/released.png")
      WHEN "M"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/costing_closed.png")
      WHEN "N"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/unconfirmed.png")
      WHEN "R"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/rejection.png")
      WHEN "W"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/signing.png")
      WHEN "Y"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/confirmed.png")
      WHEN "X"
         CALL gfrm_curr.setElementImage("statechange", "stus/32/invalid.png")
   END CASE
   #end add-point
END FUNCTION

################################################################################
# Descriptions...: BPM提交
# Memo...........:
# Usage..........: CALL asft300_send()
# Input parameter: 
# Return code....: TRUE OR FALSE
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_send()
   #add-point:send段define(客製用) name="send.define_customerization"
   
   #end add-point
   #add-point:send段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="send.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="send.pre_function"
   
   #end add-point
   
   #依據單據個數，需要指定所有單身條件為" 1=1"  (單身有幾個就要設幾個)
   LET g_wc2_table1 = " 1=1 "
   LET g_wc_sfab = " 1=1 "
   LET g_wc_sfac = " 1=1 "
   LET g_wc_sfaf = " 1=1 "
   LET g_wc_seq = " 1=1 "   #170124-00005#1
   
   CALL asft300_show()
   CALL asft300_set_pk_array()
   
   #add-point: 初始化的ADP name="send.before_send"
   #確認前檢核段
   IF NOT s_asft300_01_confirm_chk(g_sfaa_m.sfaadocno) THEN
      RETURN FALSE
   END IF
   #end add-point
   
   #公用變數初始化
   CALL cl_bpm_data_init()
   
   #依照主檔/單身個數產生 CALL cl_bpm_set_master_data() / cl_bpm_set_detail_data()
   #單頭固定為 CALL cl_bpm_set_master_data(util.JSONObject.fromFGL(xxxx)) 傳入參數: (1)單頭陣列  ; 回傳值: 無
   CALL cl_bpm_set_master_data(util.JSONObject.fromFGL(g_sfaa_m))
   
   #單身固定為 CALL cl_bpm_set_detail_data(s_detailX, util.JSONArray.fromFGL(xxxx)) 傳入參數: (1)單身SR名稱  (2)單身陣列  ; 回傳值: 無
   CALL cl_bpm_set_detail_data("s_detail1", util.JSONArray.fromFGL(g_sfba_d))
   CALL cl_bpm_set_detail_data("s_sfab", util.JSONArray.fromFGL(g_sfab_d))
   CALL cl_bpm_set_detail_data("s_sfac", util.JSONArray.fromFGL(g_sfac_d))
   CALL cl_bpm_set_detail_data("s_sfaf", util.JSONArray.fromFGL(g_sfaf_d))
   
   # cl_bpm_cli() 裡有包含以前的aws_condition()=>送簽資料檢核和更新單據狀況碼為'W'
   # cl_bpm_cli() 傳入參數:無  ;  回傳值: 0 開單失敗; 1 開單成功
   
   #add-point: 提交前的ADP name="send.before_cli"
   
   #end add-point
   
   #開單失敗
   IF NOT cl_bpm_cli() THEN
      RETURN FALSE
   END IF
   
   #add-point: 提交後的ADP name="send.after_send"
   
   #end add-point
   
   #此段落不需要刪除資料,但是否需要refresh圖片樣式???
   #CALL asft300_ui_browser_refresh()
   
   #重新指定此筆單據資料狀態圖片=>送簽中
   LET g_browser[g_current_idx].b_statepic = "stus/16/signing.png"
   
   #重新取得單頭/單身資料,DISPLAY在畫面上
   CALL asft300_ui_headershow()
   CALL asft300_ui_detailshow()
   
   RETURN TRUE

END FUNCTION

################################################################################
# Descriptions...: BPM抽單
# Memo...........:
# Usage..........: CALL asft300_draw_out()
# Input parameter: 
# Return code....: TRUE OR FALSE
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_draw_out()
   #add-point:draw段define name="draw.define_customerization"
   
   #end add-point
   #add-point:draw段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="draw.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="draw.pre_function"
   
   #end add-point
   
   #抽單失敗
   IF NOT cl_bpm_draw_out() THEN
      RETURN FALSE
   END IF
   
   #重新指定此筆單據資料狀態圖片=>抽單
   LET g_browser[g_current_idx].b_statepic = "stus/16/draw_out.png"
   
   #重新取得單頭/單身資料,DISPLAY在畫面上
   CALL asft300_ui_headershow()
   CALL asft300_ui_detailshow()
   
   #add-point:Function後置處理  name="draw.after_function"
   
   #end add-point
   
   RETURN TRUE

END FUNCTION

################################################################################
# Descriptions...: 給予pk_array內容
# Memo...........:
# Usage..........: asft300_set_pk_array()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_set_pk_array()
   #add-point:set_pk_array段define name="set_pk_array.define_customerization"
   
   #end add-point
   #add-point:set_pk_array段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="set_pk_array.define"
   
   #end add-point
   
   #add-point:Function前置處理 name="set_pk_array.before"
   
   #end add-point
   
   #若l_ac<=0代表沒有資料  
  #IF l_ac <= 0 THEN                     #170110-00024#1 mark   
   IF cl_null(g_sfaa_m.sfaadocno) THEN   #170110-00024#1 add   #若工单单号为空则表示没资料
      RETURN
   END IF
   
   CALL g_pk_array.clear()
   LET g_pk_array[1].values = g_sfaa_m.sfaadocno
   LET g_pk_array[1].column = 'sfaadocno'
   
   #add-point:set_pk_array段之後 name="set_pk_array.after"
   
   #end add-point

END FUNCTION

################################################################################
# Descriptions...: 通報訊息中心
# Memo...........:
# Usage..........: CALL asft300_msgcentre_notify(lc_state)
# Input parameter: lc_state
# Return code....: 
# Date & Author..: 160621-00002 By whitney
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_msgcentre_notify(lc_state)
   #add-point:msgcentre_notify段define name="msgcentre_notify.define_customerization"
   
   #end add-point
   DEFINE lc_state LIKE type_t.chr80
   #add-point:msgcentre_notify段define(請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="msgcentre_notify.define"
   
   #end add-point
   
   #add-point:Function前置處理  name="msgcentre_notify.pre_function"
   
   #end add-point
   
   INITIALIZE g_msgparam TO NULL
   
   #action-id與狀態填寫
   LET g_msgparam.state = lc_state
   
   #PK資料填寫
   CALL asft300_set_pk_array()
   #單頭資料填寫
   LET g_msgparam.data[1] = util.JSON.stringify(g_sfaa_m)
   
   #add-point:msgcentre其他通知 name="msgcentre_notify.process"
   
   #end add-point
   
   #呼叫訊息中心傳遞本關完成訊息
   CALL cl_msgcentre_notify()

END FUNCTION

################################################################################
# Descriptions...: 修改/刪除前行為檢查(是否可允許此動作), 若有其他行為須管控也可透過此段落
# Memo...........:
# Usage..........: CALL asft300_action_chk()
# Input parameter: 
# Return code....: TRUE OR FALSE
# Date & Author..: 160621-00002 By whitney
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_action_chk()
   #add-point:action_chk段define(客製用) name="action_chk.define_customerization"
   
   #end add-point
   #add-point:action_chk段define (請盡量不要在客製環境修改此段落內容, 否則將後續patch的調整需人工處理) name="action_chk.define"
   DEFINE l_n          LIKE type_t.num5
   #end add-point
   
   #add-point:action_chk段action_chk name="action_chk.action_chk"
    #160818-00017#36-s
   SELECT sfaastus INTO g_sfaa_m.sfaastus FROM sfaa_t
    WHERE sfaaent = g_enterprise
      AND sfaasite = g_site
      AND sfaadocno = g_sfaa_m.sfaadocno
   IF (g_action_choice="modify" OR g_action_choice="delete" OR g_action_choice="modify_detail")  THEN
     LET g_errno = NULL
     CASE g_sfaa_m.sfaastus
        WHEN 'W'
           LET g_errno = 'sub-01347'
        WHEN 'X'
           LET g_errno = 'sub-00229'
        WHEN 'Y'
           LET g_errno = 'sub-00178'
        WHEN 'C'
           LET g_errno = 'ain-00197'
        WHEN 'E'
           LET g_errno = 'sub-01360'
        WHEN 'F'
           LET g_errno = 'sub-01343'
        WHEN 'M'
           LET g_errno = 'sub-01346'
     END CASE

     IF NOT cl_null(g_errno) THEN
        INITIALIZE g_errparam TO NULL
        LET g_errparam.code = g_errno
        LET g_errparam.extend = g_sfaa_m.sfaadocno
        LET g_errparam.popup = TRUE
        CALL cl_err()
        LET g_errno = NULL
        CALL asft300_set_act_visible()
        CALL asft300_set_act_no_visible()
        CALL asft300_show()
        RETURN FALSE
     END IF
   END IF      
   #160818-00017#36-e

   
   CASE g_action_choice
      WHEN "delete"
         #已存在子工单资料不可删除
         LET l_n = 0
         SELECT COUNT(1) INTO l_n
           FROM sfaa_t
          WHERE sfaaent = g_enterprise
            AND sfaasite = g_site
            AND sfaa021 = g_sfaa_m.sfaadocno
         IF l_n > 0 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = "asf-00439"
            LET g_errparam.extend = g_sfaa_m.sfaadocno
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN FALSE
         END IF
   END CASE
   #end add-point
   
   RETURN TRUE

END FUNCTION

################################################################################
# Descriptions...: sfab资料显示
# Memo...........:
# Usage..........: CALL asft300_b_fill_sfab()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_b_fill_sfab()

   CALL g_sfab_d.clear()

   IF g_action_choice <> 'fetch' OR cl_null(g_action_choice) THEN
      LET g_sql = " SELECT UNIQUE sfabseq,sfab001,sfab002,sfab003,sfab004,sfab005,sfab006,'','','','','','',sfab007,'','','','','','' ",
                  "   FROM sfab_t ",
                  "  WHERE sfabent=? AND sfabsite=? AND sfabdocno=? "
      IF NOT cl_null(g_wc_sfab) THEN
         LET g_sql = g_sql CLIPPED," AND ",g_wc_sfab CLIPPED
      END IF
      LET g_sql = g_sql CLIPPED," ORDER BY sfab_t.sfabseq,sfab_t.sfab001,sfab_t.sfab002,sfab_t.sfab003,sfab_t.sfab004 "
      PREPARE asft300_sfab_pb FROM g_sql
      DECLARE b_fill_sfab_cs CURSOR FOR asft300_sfab_pb
   END IF
   
   LET g_cnt = l_ac
   LET l_ac = 1
   
   OPEN b_fill_sfab_cs USING g_enterprise,g_site,g_sfaa_m.sfaadocno
   
   FOREACH b_fill_sfab_cs INTO g_sfab_d[l_ac].sfabseq,g_sfab_d[l_ac].sfab001,g_sfab_d[l_ac].sfab002,g_sfab_d[l_ac].sfab003,g_sfab_d[l_ac].sfab004,
                               g_sfab_d[l_ac].sfab005,g_sfab_d[l_ac].sfab006,g_sfab_d[l_ac].a0,g_sfab_d[l_ac].a1,g_sfab_d[l_ac].a2,
                               g_sfab_d[l_ac].a3,g_sfab_d[l_ac].a4,g_sfab_d[l_ac].a5,g_sfab_d[l_ac].sfab007,g_sfab_d[l_ac].a6,
                               g_sfab_d[l_ac].a6_desc,g_sfab_d[l_ac].a7,g_sfab_d[l_ac].a7_desc,g_sfab_d[l_ac].a8,g_sfab_d[l_ac].a8_desc
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = TRUE
         CALL cl_err()
         EXIT FOREACH
      END IF
      CALL asft300_show_sfab_desc(l_ac)
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_ac
            LET g_errparam.code   = 9035
            LET g_errparam.popup  = TRUE
            CALL cl_err()
         END IF
         EXIT FOREACH
      END IF
      LET l_ac = l_ac + 1
   END FOREACH

   CALL g_sfab_d.deleteElement(g_sfab_d.getLength())

   LET l_ac = g_cnt
   LET g_cnt = 0

   FREE asft300_sfab_pb
END FUNCTION

################################################################################
# Descriptions...: 生产料号明细资料显示
# Memo...........:
# Usage..........: CALL asft300_b_fill_sfac()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_b_fill_sfac()

   CALL g_sfac_d.clear()

   IF g_action_choice <> 'fetch' OR cl_null(g_action_choice) THEN
      LET g_sql = " SELECT UNIQUE sfacseq,sfac002,sfac001,imaal003,imaal004,sfac006,inaml004,sfac003,sfac004,oocal003,sfac005 ",
                  "   FROM sfac_t ",
                  "   LEFT JOIN imaal_t ON imaalent=sfacent AND imaal001=sfac001 AND imaal002='"||g_dlang||"' ",
                  "   LEFT JOIN inaml_t ON inamlent=sfacent AND inaml001=sfac001 AND inaml002=sfac006 AND inaml003='"||g_dlang||"' ",
                  "   LEFT JOIN oocal_t ON oocalent=sfacent AND oocal001=sfac004 AND oocal002='"||g_dlang||"' ",
                  "  WHERE sfacent=? AND sfacsite=? AND sfacdocno=? "
      IF NOT cl_null(g_wc_sfac) THEN
         LET g_sql = g_sql CLIPPED," AND ",g_wc_sfac CLIPPED
      END IF
      LET g_sql = g_sql CLIPPED," ORDER BY sfac_t.sfacseq,sfac_t.sfac002,sfac_t.sfac001 "
      PREPARE asft300_sfac_pb FROM g_sql
      DECLARE b_fill_sfac_cs CURSOR FOR asft300_sfac_pb
   END IF
   
   LET g_cnt = l_ac
   LET l_ac = 1
   
   OPEN b_fill_sfac_cs USING g_enterprise,g_site,g_sfaa_m.sfaadocno
   
   FOREACH b_fill_sfac_cs INTO g_sfac_d[l_ac].sfacseq,g_sfac_d[l_ac].sfac002,g_sfac_d[l_ac].sfac001,g_sfac_d[l_ac].sfac001_desc,g_sfac_d[l_ac].sfac001_desc1,
                               g_sfac_d[l_ac].sfac006,g_sfac_d[l_ac].sfac006_desc,g_sfac_d[l_ac].sfac003,g_sfac_d[l_ac].sfac004,g_sfac_d[l_ac].sfac004_desc,
                               g_sfac_d[l_ac].sfac005
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = TRUE
         CALL cl_err()
         EXIT FOREACH
      END IF
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_ac
            LET g_errparam.code   = 9035
            LET g_errparam.popup  = TRUE
            CALL cl_err()
         END IF
         EXIT FOREACH
      END IF
      LET l_ac = l_ac + 1
   END FOREACH

   CALL g_sfac_d.deleteElement(g_sfac_d.getLength())

   LET l_ac = g_cnt
   LET g_cnt = 0

   FREE asft300_sfac_pb
END FUNCTION

################################################################################
# Descriptions...: 产品序号资料显示
# Memo...........:
# Usage..........: CALL asft300_b_fill_sfaf()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_b_fill_sfaf()

   CALL g_sfaf_d.clear()

   IF g_action_choice <> 'fetch' OR cl_null(g_action_choice) THEN
      LET g_sql = " SELECT UNIQUE sfafseq,sfaf001 ",
                  "   FROM sfaf_t ",
                  "  WHERE sfafent=? AND sfafsite=? AND sfafdocno=? "
      IF NOT cl_null(g_wc_sfaf) THEN
         LET g_sql = g_sql CLIPPED," AND ",g_wc_sfaf CLIPPED
      END IF
      LET g_sql = g_sql CLIPPED," ORDER BY sfaf_t.sfafseq "
      PREPARE asft300_sfaf_pb FROM g_sql
      DECLARE b_fill_sfaf_cs CURSOR FOR asft300_sfaf_pb
   END IF
   
   LET g_cnt = l_ac
   LET l_ac = 1
   
   OPEN b_fill_sfaf_cs USING g_enterprise,g_site,g_sfaa_m.sfaadocno
   
   FOREACH b_fill_sfaf_cs INTO g_sfaf_d[l_ac].sfafseq,g_sfaf_d[l_ac].sfaf001
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = "FOREACH:",SQLERRMESSAGE
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = TRUE
         CALL cl_err()
         EXIT FOREACH
      END IF
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.extend = l_ac
            LET g_errparam.code   = 9035
            LET g_errparam.popup  = TRUE
            CALL cl_err()
         END IF
         EXIT FOREACH
      END IF
      LET l_ac = l_ac + 1
   END FOREACH

   CALL g_sfaf_d.deleteElement(g_sfaf_d.getLength())

   LET l_ac = g_cnt
   LET g_cnt = 0

   FREE asft300_sfaf_pb
END FUNCTION

################################################################################
# Descriptions...: 單身參考欄位說明帶值
# Memo...........:
# Usage..........: CALL asft300_b_desc()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........: 
################################################################################
PRIVATE FUNCTION asft300_b_desc()
DEFINE  l_success        LIKE type_t.num5
#160122-00003#1-s
#DEFINE  l_sql            STRING
#DEFINE  l_inag           RECORD LIKE inag_t.*
#DEFINE  l_sfba013        LIKE sfba_t.sfba013
#DEFINE  l_sfba014        LIKE sfba_t.sfba014
#DEFINE  l_sfba015        LIKE sfba_t.sfba015
#DEFINE  l_sfba016        LIKE sfba_t.sfba016
#DEFINE  l_rate           LIKE inaj_t.inaj014
#DEFINE  l_inag008        LIKE inag_t.inag008
#DEFINE  l_qty            LIKE sfba_t.sfba013
#DEFINE  l_qty1           LIKE sfba_t.sfba013
#160122-00003#1-e

   #取替代建议
   LET g_sfba_d[l_ac].replace = s_abmm201_get_proposal(g_site,g_sfba_d[l_ac].sfba001,g_sfaa_m.sfaa011,g_sfba_d[l_ac].sfba005,g_sfba_d[l_ac].sfba002,g_sfba_d[l_ac].sfba003,g_sfba_d[l_ac].sfba004)
   
   IF NOT cl_null(g_sfaa_m.sfaadocno) AND NOT cl_null(g_sfba_d[l_ac].sfbaseq) AND NOT cl_null(g_sfba_d[l_ac].sfbaseq1) THEN
      #CALL s_aooi360_sel('7',g_sfaa_m.sfaadocno,g_sfba_d[l_ac].sfbaseq,g_sfba_d[l_ac].sfbaseq1,'','','','','','','','2')
           #RETURNING l_success,g_sfba_d[l_ac].sfba_ooff013  
      CALL s_aooi360_sel('7',g_prog,g_sfaa_m.sfaadocno,g_sfba_d[l_ac].sfbaseq,g_sfba_d[l_ac].sfbaseq1,'','','','','','','1')
           RETURNING l_success,g_sfba_d[l_ac].ooff013           
      CALL s_asft300_07(g_sfaa_m.sfaadocno,g_sfba_d[l_ac].sfbaseq,g_sfba_d[l_ac].sfbaseq1) RETURNING l_success,g_sfba_d[l_ac].number2
   END IF 
   IF cl_null(g_sfba_d[l_ac].number2) THEN LET g_sfba_d[l_ac].number2 = 0 END IF
   IF cl_null(g_sfba_d[l_ac].sfba013) THEN LET g_sfba_d[l_ac].sfba013 = 0 END IF
   IF cl_null(g_sfba_d[l_ac].sfba016) THEN LET g_sfba_d[l_ac].sfba016 = 0 END IF
   LET g_sfba_d[l_ac].number1 = g_sfba_d[l_ac].sfba013 - g_sfba_d[l_ac].sfba015 - g_sfba_d[l_ac].sfba016
   IF g_sfba_d[l_ac].number1 < 0 THEN LET g_sfba_d[l_ac].number1 = 0 END IF
   
#160122-00003#1-s
#   #对应发料料号库存可用量
#   LET l_sql = "SELECT * FROM inag_t WHERE inagent = ",g_enterprise," AND inagsite = '",g_site,"'",
#               "   AND inag001 = '",g_sfba_d[l_ac].sfba006,"' AND inag010 = 'Y'"
#   IF NOT cl_null(g_sfba_d[l_ac].sfba021) THEN
#      LET l_sql = l_sql," AND inag002 = '",g_sfba_d[l_ac].sfba021,"'"
#   END IF
#   IF NOT cl_null(g_sfba_d[l_ac].sfba030) THEN
#      LET l_sql = l_sql," AND inag003 = '",g_sfba_d[l_ac].sfba030,"'"
#   END IF            
#   IF NOT cl_null(g_sfba_d[l_ac].sfba019) THEN
#      LET l_sql = l_sql," AND inag004 = '",g_sfba_d[l_ac].sfba019,"'"
#   END IF
#   IF NOT cl_null(g_sfba_d[l_ac].sfba020) THEN
#      LET l_sql = l_sql," AND inag005 = '",g_sfba_d[l_ac].sfba020,"'"
#   END IF
#   IF NOT cl_null(g_sfba_d[l_ac].sfba029) THEN
#      LET l_sql = l_sql," AND inag006 = '",g_sfba_d[l_ac].sfba029,"'"
#   END IF
#   LET g_sfba_d[l_ac].number3 = 0
#   PREPARE asft300_b_desc_pre1 FROM l_sql
#   DECLARE asft300_b_desc_cur1 CURSOR FOR asft300_b_desc_pre1
#   FOREACH asft300_b_desc_cur1 INTO l_inag.*
#     #CALL s_aimi190_get_convert(g_sfba_d[l_ac].sfba006,l_inag.inag007,g_sfba_d[l_ac].sfba014) RETURNING l_success,l_rate
#     #IF cl_null(l_rate) THEN
#     #   LET l_rate = 1
#     #END IF
#     #
#      CALL s_aooi250_convert_qty(g_sfba_d[l_ac].sfba006,l_inag.inag007,g_sfba_d[l_ac].sfba014,l_inag.inag008)
#           RETURNING l_success,l_inag008
#      IF l_success THEN
#         LET l_inag008 = l_inag.inag008
#      END IF
#      IF cl_null(l_inag008) THEN
#        LET l_inag008 = 0 
#      END IF
#      LET g_sfba_d[l_ac].number3 = g_sfba_d[l_ac].number3 + l_inag008
#   END FOREACH
#   
#   #已开工单未发数量
#   LET l_sql = "SELECT sfba013,sfba014,sfba015,sfba016 FROM sfaa_t,sfba_t",
#               " WHERE sfaaent = sfbaent AND sfaadocno = sfbadocno AND sfaastus NOT IN('X','C','M') ",
#               "   AND sfbaent = ",g_enterprise," AND sfbasite = '",g_site,"'",
#               "   AND sfba006 = '",g_sfba_d[l_ac].sfba006,"'"
#   IF NOT cl_null(g_sfba_d[l_ac].sfba021) THEN
#      LET l_sql = l_sql," AND sfba021 = '",g_sfba_d[l_ac].sfba021,"'"
#   END IF
#   LET g_sfba_d[l_ac].number4 = 0
#   PREPARE asft300_b_desc_pre2 FROM l_sql
#   DECLARE asft300_b_desc_cur2 CURSOR FOR asft300_b_desc_pre2
#   FOREACH asft300_b_desc_cur2 INTO l_sfba013,l_sfba014,l_sfba015,l_sfba016
#    # CALL s_aimi190_get_convert(g_sfba_d[l_ac].sfba006,l_sfba014,g_sfba_d[l_ac].sfba014) RETURNING l_success,l_rate
#    # IF cl_null(l_rate) THEN
#    #    LET l_rate = 1
#    # END IF
#      IF cl_null(l_sfba013) THEN
#         LET l_sfba013 = 0
#      END IF
#      IF cl_null(l_sfba015) THEN
#         LET l_sfba015 = 0
#      END IF
#      IF cl_null(l_sfba016) THEN
#         LET l_sfba016 = 0
#      END IF
#     #LET g_sfba_d[l_ac].number4 = g_sfba_d[l_ac].number4 + (l_sfba013 - l_sfba015 - l_sfba016) * l_rate
#      LET l_qty = l_sfba013 - l_sfba015 - l_sfba016
#      CALL s_aooi250_convert_qty(g_sfba_d[l_ac].sfba006,l_sfba014,g_sfba_d[l_ac].sfba014,l_qty)
#           RETURNING l_success,l_qty1
#      IF NOT l_success THEN
#         LET l_qty1 = l_qty
#      END IF
#      LET g_sfba_d[l_ac].number4 = g_sfba_d[l_ac].number4 + l_qty1
#   END FOREACH
#160122-00003#1-e

END FUNCTION

################################################################################
# Descriptions...: 單別檢核
# Memo...........:
# Usage..........: CALL asft300_sfaadocno_chk()
#                  RETURNING TRUE OR FALSE
# Input parameter: 
# Return code....: 
# Date & Author..: 160714-00018 By whitney
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_sfaadocno_chk()
DEFINE l_success    LIKE type_t.num5
DEFINE l_flag       LIKE type_t.num5

#   IF NOT ap_chk_notDup("","SELECT COUNT(1) FROM sfaa_t WHERE "||"sfaaent = '" ||g_enterprise|| "' AND sfaasite = '" ||g_site|| "' AND "||"sfaadocno = '"||g_sfaa_m.sfaadocno ||"'",'std-00004',0) THEN
#      RETURN FALSE
#   END IF

   IF NOT s_aooi200_chk_slip(g_site,'',g_sfaa_m.sfaadocno,g_prog) THEN
      RETURN FALSE
   END IF

   #150909 earl add s
   #檢核前後置單別的合理性
   IF NOT cl_null(g_sfaa_m.sfaa006) THEN
      IF NOT s_aooi210_check_doc(g_site,'',g_sfaa_m.sfaa006,g_sfaa_m.sfaadocno,'3','') THEN
         RETURN FALSE
      END IF
   END IF
   #150909 earl add e

   #檢核輸入的單據別是否可以被key人員對應的控制組使用,'6' 為生管控制組類型
   CALL s_control_chk_doc('1',g_sfaa_m.sfaadocno,'6',g_user,g_dept,'','') RETURNING l_success,l_flag
   IF l_success THEN
      IF NOT l_flag THEN
         RETURN FALSE
      END IF
   END IF

   RETURN TRUE
END FUNCTION

################################################################################
# Descriptions...: 單別預設
# Memo...........:
# Usage..........: CALL asft300_sfaadocno_default()
# Input parameter: 
# Return code....: r_success 单别预设有异常的情况需报错返回  161116-00048#1 add
# Date & Author..: 160714-00018 By whitney
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_sfaadocno_default()
DEFINE l_imae032    LIKE imae_t.imae032
DEFINE r_success    LIKE type_t.num5    #161116-00048#1 add

   LET g_sfaa_m.sfaa016 = ''    #161103-00018#1 add
   LET g_sfaa_m.sfaa061 = 'N'   #161103-00018#1 add
  #LET g_sfaa_m.sfaa057 = '1'   #委外类型  161116-00048#1 add  #170208-00006#1
   LET g_sfaa_m.sfaa001 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa001',g_sfaa_m.sfaa001)
   LET g_sfaa_m.sfaa002 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa002',g_sfaa_m.sfaa002)
   LET g_sfaa_m.sfaa003 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa003',g_sfaa_m.sfaa003)
   LET g_sfaa_m.sfaa057 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa057',g_sfaa_m.sfaa057)
   LET g_sfaa_m.sfaa004 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa004',g_sfaa_m.sfaa004)
   LET g_sfaa_m.sfaa005 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa005',g_sfaa_m.sfaa005)
   LET g_sfaa_m.sfaa007 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa007',g_sfaa_m.sfaa007)
   LET g_sfaa_m.sfaa008 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa008',g_sfaa_m.sfaa008)
   LET g_sfaa_m.sfaa063 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa063',g_sfaa_m.sfaa063)
   LET g_sfaa_m.sfaa006 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa006',g_sfaa_m.sfaa006)
   LET g_sfaa_m.sfaa009 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa009',g_sfaa_m.sfaa009)
   LET g_sfaa_m.sfaa022 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa022',g_sfaa_m.sfaa022)
   LET g_sfaa_m.sfaa021 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa021',g_sfaa_m.sfaa021)
   LET g_sfaa_m.sfaa023 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa023',g_sfaa_m.sfaa023)
   LET g_sfaa_m.sfaa024 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa024',g_sfaa_m.sfaa024)
   LET g_sfaa_m.sfaa064 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa064',g_sfaa_m.sfaa064)
   LET g_sfaa_m.sfaa025 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa025',g_sfaa_m.sfaa025)
   LET g_sfaa_m.sfaa010 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa010',g_sfaa_m.sfaa010)
   LET g_sfaa_m.sfaa011 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa011',g_sfaa_m.sfaa011)
   LET g_sfaa_m.sfaa012 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa012',g_sfaa_m.sfaa012)
   LET g_sfaa_m.sfaa013 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa013',g_sfaa_m.sfaa013)
   LET g_sfaa_m.sfaa058 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa058',g_sfaa_m.sfaa058)
   LET g_sfaa_m.sfaa060 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa060',g_sfaa_m.sfaa060)
   LET g_sfaa_m.sfaa061 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa061',g_sfaa_m.sfaa061)
   LET g_sfaa_m.sfaa016 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa016',g_sfaa_m.sfaa016)
   LET g_sfaa_m.sfaa017 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa017',g_sfaa_m.sfaa017)
   LET g_sfaa_m.sfaa018 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa018',g_sfaa_m.sfaa018)
   LET g_sfaa_m.sfaa019 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa019',g_sfaa_m.sfaa019)
   LET g_sfaa_m.sfaa020 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa020',g_sfaa_m.sfaa020)
   LET g_sfaa_m.sfaa068 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa068',g_sfaa_m.sfaa068)
   LET g_sfaa_m.sfaa014 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa014',g_sfaa_m.sfaa014)
   LET g_sfaa_m.sfaa015 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa015',g_sfaa_m.sfaa015)
   LET g_sfaa_m.sfaa026 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa026',g_sfaa_m.sfaa026)
   LET g_sfaa_m.sfaa062 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa062',g_sfaa_m.sfaa062)
   LET g_sfaa_m.sfaa028 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa028',g_sfaa_m.sfaa028)
   LET g_sfaa_m.sfaa029 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa029',g_sfaa_m.sfaa029)
   LET g_sfaa_m.sfaa030 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa030',g_sfaa_m.sfaa030)
   LET g_sfaa_m.sfaa031 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa031',g_sfaa_m.sfaa031)
   LET g_sfaa_m.sfaa032 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa032',g_sfaa_m.sfaa032)
   LET g_sfaa_m.sfaa033 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa033',g_sfaa_m.sfaa033)
   LET g_sfaa_m.sfaa034 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa034',g_sfaa_m.sfaa034)
   LET g_sfaa_m.sfaa035 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa035',g_sfaa_m.sfaa035)
   LET g_sfaa_m.sfaa059 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa059',g_sfaa_m.sfaa059)
   LET g_sfaa_m.sfaa036 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa036',g_sfaa_m.sfaa036)
   LET g_sfaa_m.sfaa037 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa037',g_sfaa_m.sfaa037)
   LET g_sfaa_m.sfaa038 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa038',g_sfaa_m.sfaa038)
   LET g_sfaa_m.sfaa072 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa072',g_sfaa_m.sfaa072)
   LET g_sfaa_m.sfaa039 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa039',g_sfaa_m.sfaa039)
   LET g_sfaa_m.sfaa040 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa040',g_sfaa_m.sfaa040)
   LET g_sfaa_m.sfaa041 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa041',g_sfaa_m.sfaa041)
   LET g_sfaa_m.sfaa042 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa042',g_sfaa_m.sfaa042)
   LET g_sfaa_m.sfaa043 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa043',g_sfaa_m.sfaa043)
   LET g_sfaa_m.sfaa044 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa044',g_sfaa_m.sfaa044)
   LET g_sfaa_m.sfaa069 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa069',g_sfaa_m.sfaa069)
   LET g_sfaa_m.sfaa070 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa070',g_sfaa_m.sfaa070)
   LET g_sfaa_m.sfaa045 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa045',g_sfaa_m.sfaa045)
   LET g_sfaa_m.sfaa046 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa046',g_sfaa_m.sfaa046)
   LET g_sfaa_m.sfaa047 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa047',g_sfaa_m.sfaa047)
   LET g_sfaa_m.sfaa048 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa048',g_sfaa_m.sfaa048)
   LET g_sfaa_m.sfaa065 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa065',g_sfaa_m.sfaa065)
   LET g_sfaa_m.sfaa049 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa049',g_sfaa_m.sfaa049)
   LET g_sfaa_m.sfaa050 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa050',g_sfaa_m.sfaa050)
   LET g_sfaa_m.sfaa051 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa051',g_sfaa_m.sfaa051)
   LET g_sfaa_m.sfaa055 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa055',g_sfaa_m.sfaa055)
   LET g_sfaa_m.sfaa056 = s_aooi200_get_doc_default(g_site,'1',g_sfaa_m.sfaadocno,'sfaa056',g_sfaa_m.sfaa056)
   
   #160727-00025#1-s
   #模具頁簽資料
   IF g_argv[01] ='4' THEN
      LET g_sfaa_m.sfaa003 = '5'   #模具工單
      LET g_sfaa_m.sfaa061 = 'Y'   #製程
   END IF
   #160727-00025#1-e
   
   #161116-00048#1 add--s
   #1.如果工单单别有预设为委外工单，又预设为工艺工单，提示错误，检查aooi200的单别预设设置
   IF g_sfaa_m.sfaa057 = '2' AND g_sfaa_m.sfaa061 = 'Y' THEN
      #单据别默认字段设置错误，不允许既是委外工单又是工艺工单;请检查【aooi200单据别维护作业】中的默认字段设置，并修正后重新输入
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'aoo-00718'
      LET g_errparam.extend = g_sfaa_m.sfaadocno
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   #2.如果工单单别有预设为委外工单，没预设工艺工单，则控制工艺栏位必须为N，且不可输入
   IF g_sfaa_m.sfaa057 = '2' AND cl_null(g_sfaa_m.sfaa061) THEN
      LET g_sfaa_m.sfaa061 = 'N'
      LET g_sfaa_m.sfaa016 = ''
   END IF
   #3.如果工单单别有预设为工艺工单，没预设委外工单，则控制工单类型必须为1.厂内，且不可输入
   IF g_sfaa_m.sfaa061 = 'Y' AND cl_null(g_sfaa_m.sfaa057) THEN
      LET g_sfaa_m.sfaa057 = '1'
   END IF
   #161116-00048#1 add--e
   
   DISPLAY BY NAME g_sfaa_m.sfaa001,g_sfaa_m.sfaa002,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,
                   g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,
                   g_sfaa_m.sfaa009,g_sfaa_m.sfaa022,g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,g_sfaa_m.sfaa024,
                   g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa012,
                   g_sfaa_m.sfaa013,g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,
                   g_sfaa_m.sfaa017,g_sfaa_m.sfaa018,g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,
                   g_sfaa_m.sfaa014,g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,
                   g_sfaa_m.sfaa029,g_sfaa_m.sfaa030,g_sfaa_m.sfaa031,g_sfaa_m.sfaa032,g_sfaa_m.sfaa033,
                   g_sfaa_m.sfaa034,g_sfaa_m.sfaa035,g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,g_sfaa_m.sfaa037,
                   g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,g_sfaa_m.sfaa041,
                   g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,g_sfaa_m.sfaa070,
                   g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,g_sfaa_m.sfaa065,
                   g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,g_sfaa_m.sfaa056
   
   LET g_sfaa_m.sfaa002_desc = s_desc_get_person_desc(g_sfaa_m.sfaa002)
   DISPLAY BY NAME g_sfaa_m.sfaa002_desc
   
   LET g_sfaa_m.sfaa009_desc = s_desc_get_trading_partner_abbr_desc(g_sfaa_m.sfaa009)
   DISPLAY BY NAME g_sfaa_m.sfaa009_desc
   
   CALL s_desc_get_item_desc(g_sfaa_m.sfaa010) RETURNING g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1
   DISPLAY BY NAME g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1
   
   LET g_sfaa_m.sfaa013_desc = s_desc_get_unit_desc(g_sfaa_m.sfaa013)
   DISPLAY BY NAME g_sfaa_m.sfaa013_desc
   
   LET g_sfaa_m.sfaa060_desc = s_desc_get_unit_desc(g_sfaa_m.sfaa060)
   DISPLAY BY NAME g_sfaa_m.sfaa060_desc
   
   LET l_imae032 = asft300_get_imae032(g_sfaa_m.sfaa010)
   LET g_sfaa_m.sfaa016_desc = asft300_sfaa016_ref(l_imae032,g_sfaa_m.sfaa016)
   DISPLAY BY NAME g_sfaa_m.sfaa016_desc
   
   IF g_sfaa_m.sfaa057 = '2' THEN
      LET g_sfaa_m.sfaa017_desc = s_desc_get_trading_partner_abbr_desc(g_sfaa_m.sfaa017)
   ELSE
      LET g_sfaa_m.sfaa017_desc = s_desc_get_department_desc(g_sfaa_m.sfaa017)
   END IF
   DISPLAY BY NAME g_sfaa_m.sfaa017_desc
   
   LET g_sfaa_m.sfaa018_desc = s_desc_get_department_desc(g_sfaa_m.sfaa018)
   DISPLAY BY NAME g_sfaa_m.sfaa018_desc
   
   LET g_sfaa_m.sfaa068_desc = s_desc_get_department_desc(g_sfaa_m.sfaa068)
   DISPLAY BY NAME g_sfaa_m.sfaa068_desc
   
   LET g_sfaa_m.sfaa028_desc = s_desc_get_project_desc(g_sfaa_m.sfaa028)
   DISPLAY BY NAME g_sfaa_m.sfaa028_desc
   
   LET g_sfaa_m.sfaa029_desc = s_desc_get_wbs_desc(g_sfaa_m.sfaa028,g_sfaa_m.sfaa029)
   DISPLAY BY NAME g_sfaa_m.sfaa029_desc
   
   LET g_sfaa_m.sfaa030_desc = s_desc_get_activity_desc(g_sfaa_m.sfaa028,g_sfaa_m.sfaa030)
   DISPLAY BY NAME g_sfaa_m.sfaa030_desc
   
   LET g_sfaa_m.sfaa031_desc = s_desc_get_acc_desc('225',g_sfaa_m.sfaa031)
   DISPLAY BY NAME g_sfaa_m.sfaa031_desc
   
   LET g_sfaa_m.sfaa034_desc = s_desc_get_stock_desc(g_site,g_sfaa_m.sfaa034)
   DISPLAY BY NAME g_sfaa_m.sfaa034_desc
   
   LET g_sfaa_m.sfaa035_desc = s_desc_get_locator_desc(g_site,g_sfaa_m.sfaa034,g_sfaa_m.sfaa035)
   DISPLAY BY NAME g_sfaa_m.sfaa035_desc
   
   CALL asft300_l_sfaa007()

   LET g_sfaa_m_o.* = g_sfaa_m.*
   
   #161116-00048#1 add--s
   LET r_success = TRUE
   RETURN r_success
   #161116-00048#1 add--e
END FUNCTION

################################################################################
# Descriptions...: 抓制程料号
# Memo...........:
# Usage..........: CALL asft300_get_imae032(p_imae001)
#                  RETURNING r_imae032
# Input parameter: 
# Return code....: 
# Date & Author..: 160714-00018 By whitney
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_get_imae032(p_imae001)
DEFINE p_imae001    LIKE imae_t.imae001
DEFINE r_imae032    LIKE imae_t.imae032

   LET r_imae032 = ''
   SELECT imae032 INTO r_imae032
     FROM imae_t
    WHERE imaeent = g_enterprise
      AND imaesite = g_site
      AND imae001 = p_imae001
   IF cl_null(r_imae032) THEN
      LET r_imae032 = p_imae001
   END IF
   
   RETURN r_imae032
END FUNCTION

################################################################################
# Descriptions...: 製程說明
# Memo...........:
# Usage..........: CALL asft300_sfaa016_ref(p_ecba001,p_ecba002)
#                  RETURNING r_ecba003
# Input parameter: 
# Return code....: 
# Date & Author..: 160714-00018 By whitney
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_sfaa016_ref(p_ecba001,p_ecba002)
DEFINE p_ecba001    LIKE ecba_t.ecba001
DEFINE p_ecba002    LIKE ecba_t.ecba002
DEFINE r_ecba003    LIKE ecba_t.ecba003

   LET r_ecba003 = ''
   SELECT ecba003 INTO r_ecba003
     FROM ecba_t
    WHERE ecbaent = g_enterprise
      AND ecba001 = p_ecba001
      AND ecba002 = p_ecba002
   
   RETURN r_ecba003
END FUNCTION

################################################################################
# Descriptions...: 訂單，有項次、項序、分批序=>需用'-'串；6.獨立需求單，僅有項次=>無須用'-'串
# Memo...........:
# Usage..........: CALL asft300_l_sfaa007()
# Input parameter: 
# Return code....: 
# Date & Author..: 160714-00018 By whitney
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_l_sfaa007()
DEFINE l_sfaa007_str  STRING
DEFINE l_sfaa008_str  STRING
DEFINE l_sfaa063_str  STRING

   LET g_sfaa_m.l_sfaa007 = ''
   IF NOT cl_null(g_sfaa_m.sfaa007) THEN
      #dorislai-20150709-modify----(S)
      IF g_sfaa_m.sfaa005 = '2' THEN
         LET l_sfaa007_str = g_sfaa_m.sfaa007
         LET l_sfaa008_str = g_sfaa_m.sfaa008
         LET l_sfaa063_str = g_sfaa_m.sfaa063
         LET g_sfaa_m.l_sfaa007 = l_sfaa007_str CLIPPED,"-",l_sfaa008_str CLIPPED,"-",l_sfaa063_str CLIPPED
      END IF
      #IF g_sfaa_m.sfaa005 = '6' THEN
      IF g_sfaa_m.sfaa005 MATCHES '[567]' THEN   #modify--151207-00017#2 By shiun
         LET g_sfaa_m.l_sfaa007 = g_sfaa_m.sfaa007
      END IF
      #dorislai-20150709-modify----(E)
   END IF
   DISPLAY BY NAME g_sfaa_m.l_sfaa007
END FUNCTION

################################################################################
# Descriptions...: 料号相关校验及逻辑处理
# Memo...........:
# Usage..........: CALL asft300_sfaa010_chk()
#                  RETURNING TRUE OR FALSE
# Input parameter: 
# Return code....: 
# Date & Author..: 
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_sfaa010_chk()
DEFINE l_success    LIKE type_t.num5
DEFINE l_flag       LIKE type_t.num5
DEFINE l_ooba002    LIKE ooba_t.ooba002
DEFINE l_sql        STRING
DEFINE l_n          LIKE type_t.num5
DEFINE l_imaf012    LIKE imaf_t.imaf012
DEFINE l_imaf013    LIKE imaf_t.imaf013  #160720-00016#1
DEFINE l_imaf016    LIKE imaf_t.imaf016  #160706-00034#1
DEFINE l_oocq005    LIKE oocq_t.oocq005
DEFINE l_oocq006    LIKE oocq_t.oocq006

   INITIALIZE g_chkparam.* TO NULL
   LET g_chkparam.arg1 = g_sfaa_m.sfaa010 
   IF NOT cl_chk_exist("v_imaa001") THEN
      RETURN FALSE
   END IF
   IF NOT cl_chk_exist("v_imaf001_1") THEN
      RETURN FALSE
   END IF
   
   #判斷輸入的料件編號是否在控制組限制的產品範圍內，若不在限制內則不允許請購此料
   CALL s_control_chk_group('3','6',g_user,g_dept,g_sfaa_m.sfaa010,'','','','') RETURNING l_success,l_flag
   IF NOT l_success THEN   #处理状态
      RETURN FALSE
   END IF
   IF NOT l_flag THEN      #是否存在
      RETURN FALSE
   END IF
   
   #檢核輸入的料件的生命週期是否在單據別限制範圍內，若不在限制內則不允許請購此料
   CALL s_control_chk_doc('4',g_sfaa_m.sfaadocno,g_sfaa_m.sfaa010,'','','','') RETURNING l_success,l_flag
   IF NOT l_success THEN   #处理状态
      RETURN FALSE
   END IF
   IF NOT l_flag THEN      #是否存在
      RETURN FALSE
   END IF
   
   #檢核輸入的料件的產品分類是否在單據別限制範圍內，若不在限制內則不允許請購此料
   CALL s_control_chk_doc('5',g_sfaa_m.sfaadocno,g_sfaa_m.sfaa010,'','','','') RETURNING l_success,l_flag
   IF NOT l_success THEN   #处理状态
      RETURN FALSE
   END IF
   IF NOT l_flag THEN      #是否存在
      RETURN FALSE
   END IF
   
  #160727-00025#1-s
   CALL s_aooi200_get_slip(g_sfaa_m.sfaadocno) RETURNING l_success,l_ooba002
  #IF g_sfaa_m.sfaa003 MATCHES '[145]' THEN
   IF g_sfaa_m.sfaa003 MATCHES '[14]' OR
     (g_sfaa_m.sfaa003 ='5' AND cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0024') <> '2') THEN
  #160727-00025#1-e
      LET l_sql = " SELECT COUNT(bmaa001) FROM bmaa_t ",
                  "  WHERE bmaaent = ",g_enterprise," AND bmaasite = '",g_site,"' ",
                  "    AND bmaa001 = '",g_sfaa_m.sfaa010,"' AND bmaastus='Y' "
      IF NOT cl_null(g_sfaa_m.sfaa011) THEN
         LET l_sql = l_sql," AND bmaa002 = '",g_sfaa_m.sfaa011,"' "
      END IF
      PREPARE sel_bmaa_pre FROM l_sql
      LET l_n = 0
      EXECUTE sel_bmaa_pre INTO l_n
      IF l_n = 0 THEN
         #160921-00022#1-s-add
         LET g_sfaa_m.sfaa068 = g_sfaa_m_o.sfaa068
         LET g_sfaa_m.sfaa014 = g_sfaa_m_o.sfaa014
         #160921-00022#1-e-add
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'asf-00045'
         LET g_errparam.extend = g_sfaa_m.sfaa010
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
   
   #160706-00034#1-s
   #imaa010->imaf016
   LET l_imaf012 = ''
   LET l_imaf013 = ''
   LET l_imaf016 = ''
   SELECT imaf012,imaf013,imaf016 INTO l_imaf012,l_imaf013,l_imaf016
     FROM imaf_t
    WHERE imafent = g_enterprise
      AND imafsite = g_site
      AND imaf001 = g_sfaa_m.sfaa010
   IF NOT cl_null(l_imaf016) THEN
      LET l_oocq005 = ''
      LET l_oocq006 = ''
      SELECT oocq005,oocq006 INTO l_oocq005,l_oocq006 FROM oocq_t
       WHERE oocqent = g_enterprise AND oocq001 = '210' AND oocq002 = l_imaf016 AND oocqstus = 'Y'
   #160706-00034#1-e
      IF g_sfaa_m.sfaa003 = '4' THEN
         IF l_oocq005 = 'N' THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'asf-00052'
            LET g_errparam.extend = g_sfaa_m.sfaa010
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN FALSE
         END IF
      ELSE
         IF l_oocq006 = 'N' THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'asf-00053'
            LET g_errparam.extend = g_sfaa_m.sfaa010
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN FALSE
         END IF
      END IF 
   END IF 
   #160720-00016#1-s
   IF g_sfaa_m.sfaa005 = '2' THEN #訂單
      IF l_imaf013 NOT MATCHES '[23]' THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'asf-00802'
         LET g_errparam.extend = g_sfaa_m.sfaa010
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF
   #160720-00016#1-e
   
   IF g_sfaa_m.sfaa003 = '1' AND cl_get_doc_para(g_enterprise,g_site,g_sfaa_m.sfaadocno,'D-MFG-0065') = 'Y' THEN
      CASE 
         WHEN l_imaf012 = '1' 
            IF g_sfaa_m.sfaa005 != '2' THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'asf-00054'
               LET g_errparam.extend = g_sfaa_m.sfaa010
               LET g_errparam.popup = TRUE
               CALL cl_err()
               RETURN FALSE
            END IF
         WHEN l_imaf012 = '2' 
            IF g_sfaa_m.sfaa005 NOT MATCHES '[367]' THEN   #151207-00017#2
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'asf-00055'
               LET g_errparam.extend = g_sfaa_m.sfaa010
               LET g_errparam.popup = TRUE
               CALL cl_err()
               RETURN FALSE
            END IF
         WHEN l_imaf012 = '3' OR l_imaf012 = '4' 
            IF g_sfaa_m.sfaa005 = '2' THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = 'asf-00056'
               LET g_errparam.extend = g_sfaa_m.sfaa010
               LET g_errparam.popup = TRUE
               CALL cl_err()
               RETURN FALSE
            END IF
         OTHERWISE EXIT CASE
      END CASE
   END IF
   
   #特征管理
   IF g_prog <> 'asft300_sfac' THEN         #170118-00063#1 add
      IF NOT asft300_sfaa010_feature() THEN
         RETURN FALSE
      END IF
   END IF                                   #170118-00063#1 add
   
   RETURN TRUE
END FUNCTION

################################################################################
# Descriptions...: 
# Memo...........:
# Usage..........: CALL asft300_sfaa010_defaule(p_cmd)
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........: #160509-00009#4
# Modify.........: #160708-00003#1
################################################################################
PRIVATE FUNCTION asft300_sfaa010_defaule(p_cmd)
DEFINE p_cmd        LIKE type_t.chr1
DEFINE l_imae032    LIKE imae_t.imae032
DEFINE l_imae033    LIKE imae_t.imae033
DEFINE l_imae034    LIKE imae_t.imae034  #170207-00040#1 add
DEFINE l_imaf072    LIKE imaf_t.imaf072  #160708-00003#1
DEFINE l_count      LIKE type_t.num5   #161123-00040#1

   #160921-00022#1-s-mod 多抓imae035,imae014
   #SELECT imae016,imae020,imae032,imae033,imae034
   #  INTO g_sfaa_m.sfaa013,g_sfaa_m.imae020,l_imae032,l_imae033,g_sfaa_m.sfaa017
   #  FROM imae_t
   # WHERE imaeent = g_enterprise AND imaesite = g_site AND imae001 = g_sfaa_m.sfaa010
   SELECT imae016,imae020,imae032,imae033,imae034,imae035,(CASE imae014 WHEN '0' THEN '1' WHEN '1' THEN '2' END ),imae037            #161027-00011#1 add imae037
    #INTO g_sfaa_m.sfaa013,g_sfaa_m.imae020,l_imae032,l_imae033,g_sfaa_m.sfaa017,g_sfaa_m.sfaa068,g_sfaa_m.sfaa004,g_sfaa_m.sfaa011  #161027-00011#1 add sfaa011 #170207-00040#1 mark
     INTO g_sfaa_m.sfaa013,g_sfaa_m.imae020,l_imae032,l_imae033,l_imae034,g_sfaa_m.sfaa068,g_sfaa_m.sfaa004,g_sfaa_m.sfaa011                                     #170207-00040#1 add
     FROM imae_t
    WHERE imaeent = g_enterprise AND imaesite = g_site AND imae001 = g_sfaa_m.sfaa010
   #160921-00022#1-e-mod   
   IF cl_null(g_sfaa_m.imae020) THEN
      LET g_sfaa_m.imae020 = 0
   END IF
   IF g_sfaa_m.sfaa061 = 'Y' THEN
      LET g_sfaa_m.sfaa016 = l_imae033
      IF cl_null(l_imae032) THEN
         LET l_imae032 = g_sfaa_m.sfaa010
      END IF
      #161123-00040#1-s-add
      IF NOT cl_null(g_sfaa_m.sfaa016) THEN
         LET l_count = 0
         SELECT COUNT(1) INTO l_count
           FROM ecba_t
          WHERE ecbaent = g_enterprise
            AND ecbasite = g_site
            AND ecba001 = l_imae032
            AND ecba002 = g_sfaa_m.sfaa016
         
         IF l_count = 0 THEN
            LET g_sfaa_m.sfaa016 = ''
         END IF
      END IF
      #161123-00040#1-s-add      
   END IF
  #170301-00016#1 mark --(S)--
  #移到下面與委外取採購主要供應商一起處理
  ##170207-00040#1--add--start--
  #IF cl_null(g_sfaa_m.sfaa017) THEN
  #   LET g_sfaa_m.sfaa017 = l_imae034
  #END IF 
  ##170207-00040#1--add--end----
  #170301-00016#1 mark --(E)--
   SELECT imaf015,imaf034,imaf072                              
     INTO g_sfaa_m.sfaa060,g_sfaa_m.sfaa072,l_imaf072                 
     FROM imaf_t
    WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = g_sfaa_m.sfaa010
   #170322-00078#1 add --(S)--
   IF cl_null(g_sfaa_m.sfaa072) THEN
      LET g_sfaa_m.sfaa072 = 'N'
   END IF
   #170322-00078#1 add --(E)--     
   IF g_sfaa_m.sfaa005 = '1' THEN
      LET g_sfaa_m.sfaa072 = l_imaf072
   END IF
   
   CALL asft300_get_sfaa058()
   
   DISPLAY BY NAME g_sfaa_m.sfaa013,g_sfaa_m.sfaa016,g_sfaa_m.sfaa017,g_sfaa_m.imae020,g_sfaa_m.sfaa060,g_sfaa_m.sfaa072
   
   LET g_sfaa_m.sfaa013_desc = s_desc_get_unit_desc(g_sfaa_m.sfaa013)
   DISPLAY BY NAME g_sfaa_m.sfaa013_desc
   
   LET g_sfaa_m.sfaa016_desc = asft300_sfaa016_ref(l_imae032,g_sfaa_m.sfaa016)
   DISPLAY BY NAME g_sfaa_m.sfaa016_desc
   
   IF cl_null(g_sfaa_m.sfaa017) THEN   #170301-00016#1 add
      IF g_sfaa_m.sfaa057 = '2' THEN
         #161209-00026#1 add-------s----
         SELECT imaf153   INTO g_sfaa_m.sfaa017                  
           FROM imaf_t
          WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = g_sfaa_m.sfaa010
         #161209-00026#1 add-------e----
      #170301-00016#1 add --(S)--   
      ELSE
         LET g_sfaa_m.sfaa017 = l_imae034
      END IF      
      #170301-00016#1 add --(E)--
      LET g_sfaa_m.sfaa017_desc = s_desc_get_trading_partner_abbr_desc(g_sfaa_m.sfaa017)

   ELSE
      LET g_sfaa_m.sfaa017_desc = s_desc_get_department_desc(g_sfaa_m.sfaa017)
   END IF
   DISPLAY BY NAME g_sfaa_m.sfaa017_desc
   
   #160921-00022#1-s-add
   #取成本中心說明
   LET g_sfaa_m.sfaa068_desc = s_desc_get_department_desc(g_sfaa_m.sfaa068)
   DISPLAY BY NAME g_sfaa_m.sfaa068,g_sfaa_m.sfaa004,g_sfaa_m.sfaa068_desc
   #160921-00022#1-e-add
   CALL asft300_get_work_date(p_cmd)
   
END FUNCTION

################################################################################
# Descriptions...: 
# Memo...........:
# Usage..........: CALL asft300_get_work_date(p_cmd)
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_get_work_date(p_cmd)
DEFINE p_cmd        LIKE type_t.chr1
DEFINE l_success    LIKE type_t.num5
DEFINE l_days       LIKE type_t.num5
   
   IF NOT cl_null(g_sfaa_m.sfaa010) AND NOT cl_null(g_sfaa_m.sfaa012) AND
     (NOT cl_null(g_sfaa_m.sfaa019) OR NOT cl_null(g_sfaa_m.sfaa020)) THEN
      IF p_cmd = 'u' THEN
         IF NOT cl_ask_confirm('asf-00192') THEN
            RETURN
         END IF
      END IF
      IF cl_null(g_sfaa_m.sfaa020) THEN
         IF NOT cl_null(g_sfaa_m.sfaa019) THEN
            CALL s_asft300_06('1',g_sfaa_m.sfaa010,g_sfaa_m.sfaa012,g_sfaa_m.sfaa019) RETURNING l_success,g_sfaa_m.sfaa020
         END IF
      ELSE
         CALL s_asft300_06('2',g_sfaa_m.sfaa010,g_sfaa_m.sfaa012,g_sfaa_m.sfaa020) RETURNING l_success,g_sfaa_m.sfaa019
         IF g_sfaa_m.sfaa019 < g_sfaa_m.sfaadocdt THEN
            LET l_days = g_sfaa_m.sfaadocdt - g_sfaa_m.sfaa019
            LET g_sfaa_m.sfaa019 = g_sfaa_m.sfaadocdt        
            CALL s_date_get_work_date(g_site,g_ooef008,'2',g_sfaa_m.sfaa020,0,l_days) RETURNING g_sfaa_m.sfaa020 
         END IF
      END IF
      DISPLAY BY NAME g_sfaa_m.sfaa019,g_sfaa_m.sfaa020
   END IF

END FUNCTION

################################################################################
# Descriptions...: 参考数量预设
# Memo...........:
# Usage..........: CALL asft300_get_sfaa058()
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_get_sfaa058()
DEFINE l_success                 LIKE type_t.num5

   IF cl_null(g_sfaa_m.sfaa060) THEN
      LET g_sfaa_m.sfaa060 = g_sfaa_m.sfaa013
   END IF
   IF cl_null(g_sfaa_m.sfaa012) THEN
      LET g_sfaa_m.sfaa012 = 0
   END IF
   IF NOT cl_null(g_sfaa_m.sfaa010) AND NOT cl_null(g_sfaa_m.sfaa013) THEN
      CALL s_aooi250_convert_qty(g_sfaa_m.sfaa010,g_sfaa_m.sfaa013,g_sfaa_m.sfaa060,g_sfaa_m.sfaa012) RETURNING l_success,g_sfaa_m.sfaa058
      IF NOT l_success THEN
         LET g_sfaa_m.sfaa058 = g_sfaa_m.sfaa012
      END IF
   END IF
   DISPLAY BY NAME g_sfaa_m.sfaa012,g_sfaa_m.sfaa058,g_sfaa_m.sfaa060

END FUNCTION

################################################################################
# Descriptions...: 单位检查
# Memo...........:
# Usage..........: CALL asft300_chk_sfaa013(p_sfaa013)
# Input parameter: 
# Return code....: 
# Date & Author..: 日期 By 作者
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_chk_sfaa013(p_sfaa013)
DEFINE p_sfaa013    LIKE sfaa_t.sfaa013
DEFINE l_imaa006    LIKE imaa_t.imaa006
DEFINE l_success    LIKE type_t.num5
DEFINE l_rate       LIKE inaj_t.inaj014

   #1.检查单位资料档
   INITIALIZE g_chkparam.* TO NULL
   LET g_chkparam.arg1 = p_sfaa013
   #160318-00025#4-s
   LET g_errshow = TRUE 
   LET g_chkparam.err_str[1] = "aim-00005:sub-01302|aooi250|",cl_get_progname("aooi250",g_lang,"2"),"|:EXEPROGaooi250"
   #160318-00025#4-e
   IF NOT cl_chk_exist("v_ooca001") THEN
      RETURN FALSE
   END IF
   
   #2.检查与基础单位是否有转换率
   SELECT imaa006 INTO l_imaa006 FROM imaa_t
    WHERE imaaent = g_enterprise AND imaa001 = g_sfaa_m.sfaa010
   CALL s_aimi190_get_convert(g_sfaa_m.sfaa010,p_sfaa013,l_imaa006) RETURNING l_success,l_rate
   IF NOT l_success THEN
      RETURN FALSE
   END IF
   
   #3.检查是否存在于料件允许使用单位里。
   INITIALIZE g_chkparam.* TO NULL
   LET g_chkparam.arg1 = g_sfaa_m.sfaa010
   LET g_chkparam.arg2 = p_sfaa013
   IF NOT cl_chk_exist("v_imao002") THEN
      RETURN FALSE
   END IF
   
   RETURN TRUE
END FUNCTION
# Descriptions...: 预设sfac资料
PRIVATE FUNCTION asft300_ins_sfac()
DEFINE l_sql1     STRING
DEFINE l_sql2     STRING
DEFINE l_sql3     STRING
DEFINE l_n        LIKE type_t.num5
DEFINE l_j        LIKE type_t.num5
DEFINE l_sfac001  LIKE sfac_t.sfac001
DEFINE l_sfac003  LIKE sfac_t.sfac003
DEFINE l_sfac004  LIKE sfac_t.sfac004
DEFINE l_sfaa015       DATETIME YEAR TO SECOND          #161219-00007#1 add
DEFINE l_sfaa015_1     LIKE type_t.chr20    #BOM有效日期 #161219-00007#1 add

     #161219-00007#1 ---add (s)---
     #当p_date为null时，bom有效日期为当前日期
      IF cl_null(g_sfaa_m.sfaa015) THEN
         LET l_sfaa015 = cl_get_current()
         LET l_sfaa015_1 = l_sfaa015
      ELSE
         LET l_sfaa015 = g_sfaa_m.sfaa015
         LET l_sfaa015_1 = l_sfaa015
      END IF
     #161219-00007#1 ---add (e)---

      LET l_sql1 = "SELECT UNIQUE '','2',bmab003,'','',' ','',bmab004*",g_sfaa_m.sfaa012/100,",'','',0 FROM bmab_t WHERE bmabent = '",g_enterprise,"'",
                   "   AND bmabsite = '",g_site,"' AND bmab001 = '",g_sfaa_m.sfaa010,"' AND bmab002 = '",g_sfaa_m.sfaa011,"'"
                   ,"   AND to_char(bmab005,'YYYY-MM-DD hh24:mi:ss')<= '",l_sfaa015_1,"'",                    #161219-00007#1 add
                   "   AND (bmab006 IS NULL OR to_char(bmab006,'YYYY-MM-DD hh24:mi:ss')> '",l_sfaa015_1,"') " #161219-00007#1 add
      LET l_sql2 = "SELECT UNIQUE '','3',bmad003,'','',' ','',bmad004*",g_sfaa_m.sfaa012,",bmad005,'',0 FROM bmad_t WHERE bmadent='",g_enterprise,"'",
                   "   AND bmadsite='",g_site,"' AND bmad001='",g_sfaa_m.sfaa010,"' AND bmad002 = '",g_sfaa_m.sfaa011,"'"
                   ,"   AND to_char(bmad006,'YYYY-MM-DD hh24:mi:ss')<= '",l_sfaa015_1,"' ",                   #161219-00007#1 add
                   "   AND (bmad007 IS NULL OR to_char(bmad007,'YYYY-MM-DD hh24:mi:ss')> '",l_sfaa015_1,"') " #161219-00007#1 add
      LET l_sql3 = "SELECT UNIQUE '','5',bmac003,'','',' ','',bmac005/bmac006*",g_sfaa_m.sfaa012,",bmac004,'',0 FROM bmac_t WHERE bmacent='",g_enterprise,"'",
                   "   AND bmacsite='",g_site,"' AND bmac001='",g_sfaa_m.sfaa010,"' AND bmac002 = '",g_sfaa_m.sfaa011,"'" 
                   ,"   AND to_char(bmac007,'YYYY-MM-DD hh24:mi:ss')<= '",l_sfaa015_1,"' ",                   #161219-00007#1 add
                   "   AND (bmac008 IS NULL OR to_char(bmac008,'YYYY-MM-DD hh24:mi:ss')> '",l_sfaa015_1,"') " #161219-00007#1 add
      LET g_sql = l_sql1," UNION ",l_sql2," UNION ",l_sql3
      PREPARE asft300_sfac_pb1 FROM g_sql
      DECLARE b_fill_sfac_cs1 CURSOR FOR asft300_sfac_pb1
      LET l_ac = 1
      CALL g_sfac_d.clear()
      SELECT COUNT(1) INTO l_n FROM bmad_t WHERE bmadent=g_enterprise AND bmadsite=g_site AND bmad001=g_sfaa_m.sfaa010 AND bmad002=g_sfaa_m.sfaa011
    # IF l_n = 0 THEN 
    # IF l_n = 0 OR g_sfaa_m.sfaa003 = '3' THEN    #拆件式工单只产生‘一般’资料，不产生联产品、副产品、多产出主件
      IF l_n = 0 THEN       #多产出主件不产生生产料号明细资料
         SELECT MAX(sfacseq)+1 INTO g_sfac_d[l_ac].sfacseq FROM sfac_t WHERE sfacent = g_enterprise AND sfacsite = g_site AND sfacdocno= g_sfaa_m.sfaadocno
         IF cl_null(g_sfac_d[l_ac].sfacseq) THEN
            LET g_sfac_d[l_ac].sfacseq = 1
         END IF 
         LET g_sfac_d[l_ac].sfac002 = '1' 
         LET g_sfac_d[l_ac].sfac001 = g_sfaa_m.sfaa010
         LET g_sfac_d[l_ac].sfac003 = g_sfaa_m.sfaa012
         LET g_sfac_d[l_ac].sfac004 = g_sfaa_m.sfaa013
         LET g_sfac_d[l_ac].sfac005 = 0
         LET g_sfac_d[l_ac].sfac006 = ' '
         
         #160512-00016#14 20160526 modify by ming -----(S) 
         INSERT INTO sfac_t(sfacent,sfacsite,sfacdocno,sfacseq,sfac001,sfac002,sfac003,sfac004,sfac005,sfac006,
                            sfac007)
                     VALUES(g_enterprise,g_site,g_sfaa_m.sfaadocno,g_sfac_d[l_ac].sfacseq,g_sfac_d[l_ac].sfac001,
                            g_sfac_d[l_ac].sfac002,g_sfac_d[l_ac].sfac003,g_sfac_d[l_ac].sfac004,g_sfac_d[l_ac].sfac005,g_sfac_d[l_ac].sfac006,
                            g_sfaa_m.sfaa072)
         #160512-00016#14 20160526 modify by ming -----(E) 
         LET l_ac = l_ac + 1
         #有做特征管理时
         IF g_inam.getLength() > 0 AND g_inam004_sum > 0 THEN
            #170309-00002#1--add--start--
            LET g_sfac_d[1].sfac003=g_inam[1].inam004
            LET g_sfac_d[1].sfac006=g_inam[1].inam002
            #170309-00002#1--add--end----
            UPDATE sfac_t SET sfac003 = g_inam[1].inam004,sfac006 = g_inam[1].inam002 
             WHERE sfacent = g_enterprise AND sfacsite = g_site AND sfacdocno= g_sfaa_m.sfaadocno AND sfac002 = '1'
            FOR l_j = 2 TO g_inam.getLength()
               IF cl_null(g_inam[l_j].inam001) THEN
                  EXIT FOR
               END IF
               SELECT MAX(sfacseq)+1 INTO g_sfac_d[l_ac].sfacseq FROM sfac_t WHERE sfacent = g_enterprise AND sfacsite = g_site AND sfacdocno= g_sfaa_m.sfaadocno
               IF cl_null(g_sfac_d[l_ac].sfacseq) THEN
                  LET g_sfac_d[l_ac].sfacseq = 1
               END IF 
               LET g_sfac_d[l_ac].sfac002 = '1' 
               LET g_sfac_d[l_ac].sfac001 = g_sfaa_m.sfaa010
               LET g_sfac_d[l_ac].sfac004 = g_sfaa_m.sfaa013
               LET g_sfac_d[l_ac].sfac005 = 0
               LET g_sfac_d[l_ac].sfac003 = g_inam[l_j].inam004
               LET g_sfac_d[l_ac].sfac006 = g_inam[l_j].inam002
               
               #160512-00016#14 20160526 modify by ming -----(S) 
               INSERT INTO sfac_t(sfacent,sfacsite,sfacdocno,sfacseq,sfac001,sfac002,sfac003,sfac004,sfac005,sfac006,
                                  sfac007)
                           VALUES(g_enterprise,g_site,g_sfaa_m.sfaadocno,g_sfac_d[l_ac].sfacseq,g_sfac_d[l_ac].sfac001,
                                  g_sfac_d[l_ac].sfac002,g_sfac_d[l_ac].sfac003,g_sfac_d[l_ac].sfac004,g_sfac_d[l_ac].sfac005,g_sfac_d[l_ac].sfac006, 
                                  g_sfaa_m.sfaa072)
               #160512-00016#14 20160526 modify by ming -----(E) 
               LET l_ac = l_ac + 1
            END FOR
         END IF
      END IF      
      
     #IF g_sfaa_m.sfaa003 != '3' THEN   #拆件式工单只产生‘一般’资料，不产生联产品、副产品、多产出主件
      FOREACH b_fill_sfac_cs1 INTO g_sfac_d[l_ac].*
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = SQLCA.sqlcode
            LET g_errparam.extend = "FOREACH:"
            LET g_errparam.popup = TRUE
            CALL cl_err()

            EXIT FOREACH
         END IF
         IF cl_null(g_sfac_d[l_ac].sfac001) THEN
            CONTINUE FOREACH
         END IF
         SELECT MAX(sfacseq)+1 INTO g_sfac_d[l_ac].sfacseq FROM sfac_t WHERE sfacent = g_enterprise AND sfacsite = g_site AND sfacdocno= g_sfaa_m.sfaadocno
         IF cl_null(g_sfac_d[l_ac].sfacseq) THEN
            LET g_sfac_d[l_ac].sfacseq = 1
         END IF 
         IF cl_null(g_sfac_d[l_ac].sfac004) THEN
            SELECT bmaa004 INTO g_sfac_d[l_ac].sfac004 FROM bmaa_t WHERE bmaaent = g_enterprise AND bmaasite = g_site AND bmaa001 = g_sfaa_m.sfaa010 AND bmaa002=g_sfaa_m.sfaa011
         END IF             
         
         #160512-00016#14 20160526 modify by ming -----(S) 
         INSERT INTO sfac_t(sfacent,sfacsite,sfacdocno,sfacseq,sfac001,sfac002,sfac003,sfac004,sfac005,sfac006,
                            sfac007)
                     VALUES(g_enterprise,g_site,g_sfaa_m.sfaadocno,g_sfac_d[l_ac].sfacseq,g_sfac_d[l_ac].sfac001,
                            g_sfac_d[l_ac].sfac002,g_sfac_d[l_ac].sfac003,g_sfac_d[l_ac].sfac004,g_sfac_d[l_ac].sfac005,g_sfac_d[l_ac].sfac006,
                            'N')
         #160512-00016#14 20160526 modify by ming -----(E) 
         
         IF g_sfac_d[l_ac].sfac002 = '2' THEN
            #做特征管理
            IF g_inam.getLength() > 0 AND g_inam004_sum > 0 THEN
               LET l_sfac001 = g_sfac_d[l_ac].sfac001
               LET l_sfac004 = g_sfac_d[l_ac].sfac004
               LET l_sfac003 = g_sfac_d[l_ac].sfac003
               UPDATE sfac_t SET sfac003 = sfac003 * g_inam[1].inam004 / g_sfaa_m.sfaa012,sfac006 = g_inam[1].inam002 
                WHERE sfacent = g_enterprise AND sfacsite = g_site AND sfacdocno= g_sfaa_m.sfaadocno AND sfac002 = '2'
                  AND sfacseq = g_sfac_d[l_ac].sfacseq
               UPDATE sfac_t SET sfac003=sfac003 - l_sfac003 * g_inam[1].inam004 / g_sfaa_m.sfaa012 WHERE sfacent = g_enterprise
                  AND sfacsite = g_site AND sfacdocno= g_sfaa_m.sfaadocno AND sfac002='1'
                  AND sfac006 = g_inam[1].inam002
               FOR l_j = 2 TO g_inam.getLength()
                  IF cl_null(g_inam[l_j].inam001) THEN
                     EXIT FOR
                  END IF
                  LET l_ac = l_ac + 1
                  SELECT MAX(sfacseq)+1 INTO g_sfac_d[l_ac].sfacseq FROM sfac_t 
                   WHERE sfacent = g_enterprise AND sfacsite = g_site AND sfacdocno= g_sfaa_m.sfaadocno
                  
                  LET g_sfac_d[l_ac].sfac002 = '2' 
                  LET g_sfac_d[l_ac].sfac001 = l_sfac001
                  LET g_sfac_d[l_ac].sfac004 = l_sfac004
                  LET g_sfac_d[l_ac].sfac005 = 0
                  LET g_sfac_d[l_ac].sfac003 = g_inam[l_j].inam004 / g_sfaa_m.sfaa012 * l_sfac003
                  LET g_sfac_d[l_ac].sfac006 = g_inam[l_j].inam002
                  
                  #160512-00016#14 20160526 modify by ming -----(S) 
                  INSERT INTO sfac_t(sfacent,sfacsite,sfacdocno,sfacseq,sfac001,sfac002,sfac003,sfac004,sfac005,sfac006,
                                     sfac007)
                              VALUES(g_enterprise,g_site,g_sfaa_m.sfaadocno,g_sfac_d[l_ac].sfacseq,g_sfac_d[l_ac].sfac001,
                                     g_sfac_d[l_ac].sfac002,g_sfac_d[l_ac].sfac003,g_sfac_d[l_ac].sfac004,g_sfac_d[l_ac].sfac005,g_sfac_d[l_ac].sfac006,
                                     'N')
                  #160512-00016#14 20160526 modify by ming -----(E) 
                  UPDATE sfac_t SET sfac003=sfac003-g_sfac_d[l_ac].sfac003 WHERE sfacent = g_enterprise
                     AND sfacsite = g_site AND sfacdocno= g_sfaa_m.sfaadocno AND sfac002='1'
                     AND sfac006 = g_inam[l_j].inam002
               END FOR
            ELSE
               UPDATE sfac_t SET sfac003=sfac003-g_sfac_d[l_ac].sfac003 WHERE sfacent = g_enterprise
                  AND sfacsite = g_site AND sfacdocno= g_sfaa_m.sfaadocno AND sfac002='1'
            END IF                     
         END IF 
         LET l_ac = l_ac + 1
         
         IF l_ac > g_max_rec THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code =  9035
            LET g_errparam.extend =  ''
            LET g_errparam.popup = FALSE
            CALL cl_err()

            EXIT FOREACH
         END IF
      END FOREACH
     #END IF
      
END FUNCTION
# Descriptions...: 检查仓库sfaa034、库位sfaa035的正确性
PRIVATE FUNCTION asft300_chk_warehouses()
   DEFINE r_success      LIKE type_t.num5

   LET r_success = FALSE

   #1.检查库位基础档
   IF NOT cl_null(g_sfaa_m.sfaa034) THEN
      INITIALIZE g_chkparam.* TO NULL
      LET g_chkparam.arg1 = g_sfaa_m.sfaa034
      #160318-00025#4--add--str
      LET g_errshow = TRUE 
      LET g_chkparam.err_str[1] = "aim-00065:sub-01302|aini001|",cl_get_progname("aini001",g_lang,"2"),"|:EXEPROGaini001"
      #160318-00025#4--add--end
      IF NOT cl_chk_exist("v_inaa001_2") THEN
         RETURN r_success
      END IF
   END IF

   #2.检查储位
   IF NOT cl_null(g_sfaa_m.sfaa034) AND g_sfaa_m.sfaa035 IS NOT NULL THEN
      INITIALIZE g_chkparam.* TO NULL
      LET g_chkparam.arg1 = g_site
      LET g_chkparam.arg2 = g_sfaa_m.sfaa034
      LET g_chkparam.arg3 = g_sfaa_m.sfaa035
      #160318-00025#4--add--str
      LET g_errshow = TRUE 
      LET g_chkparam.err_str[1] = "aim-00063:sub-01302|aini002|",cl_get_progname("aini002",g_lang,"2"),"|:EXEPROGaini002"
      #160318-00025#4--add--end
      IF NOT cl_chk_exist("v_inab002") THEN
         RETURN r_success
   END IF
      END IF
   
   LET r_success = TRUE
   RETURN r_success
END FUNCTION
#sfbaseq栏位检查
#同项次的部位+作业编号+制程序+BOM料号为相同,不同项次不可以有同样的部位+作业编号+制程序+BOM料号
PRIVATE FUNCTION asft300_sfbaseq(p_cmd)
DEFINE p_cmd     LIKE type_t.chr1
DEFINE l_n       LIKE type_t.num5
DEFINE l_n1      LIKE type_t.num5

  IF cl_null(g_sfba_d[g_detail_idx].sfbaseq) THEN
     RETURN TRUE
  END IF 
  IF g_sfba_d[g_detail_idx].sfba002 IS NULL THEN
     RETURN TRUE
  END IF 
  IF g_sfba_d[g_detail_idx].sfba003 IS NULL THEN
     RETURN TRUE
  END IF
  IF g_sfba_d[g_detail_idx].sfba004 IS NULL THEN
     RETURN TRUE
  END IF
  IF g_sfba_d[g_detail_idx].sfba005 IS NULL THEN
     RETURN TRUE
  END IF
  SELECT COUNT(1) INTO l_n FROM sfba_t WHERE sfbaent = g_enterprise AND sfbasite = g_site AND sfbadocno = g_sfaa_m.sfaadocno
     AND sfbaseq = g_sfba_d[g_detail_idx].sfbaseq
  IF (l_n > 1 AND p_cmd = 'u') OR (l_n > 0 AND p_cmd = 'a') THEN
     SELECT COUNT(1) INTO l_n1 FROM sfba_t WHERE sfbaent = g_enterprise AND sfbasite = g_site AND sfbadocno = g_sfaa_m.sfaadocno
        AND sfbaseq = g_sfba_d[g_detail_idx].sfbaseq AND sfba002 = g_sfba_d[g_detail_idx].sfba002 AND sfba003 = g_sfba_d[g_detail_idx].sfba003
        AND sfba004 = g_sfba_d[g_detail_idx].sfba004 AND sfba005 = g_sfba_d[g_detail_idx].sfba005
     IF l_n1 = 0 THEN
        INITIALIZE g_errparam TO NULL
        LET g_errparam.code = 'asf-00070'
        LET g_errparam.extend = ''
        LET g_errparam.popup = TRUE
        CALL cl_err()

        RETURN FALSE
     END IF
  ELSE
     SELECT COUNT(1) INTO l_n1 FROM sfba_t WHERE sfbaent = g_enterprise AND sfbasite = g_site AND sfbadocno = g_sfaa_m.sfaadocno
        AND sfba002 = g_sfba_d[g_detail_idx].sfba002 AND sfba003 = g_sfba_d[g_detail_idx].sfba003
        AND sfba004 = g_sfba_d[g_detail_idx].sfba004 AND sfba005 = g_sfba_d[g_detail_idx].sfba005
     IF l_n1 > 0 THEN
        INITIALIZE g_errparam TO NULL
        LET g_errparam.code = 'asf-00070'
        LET g_errparam.extend = ''
        LET g_errparam.popup = TRUE
        CALL cl_err()

        RETURN FALSE
     END IF
  END IF
  RETURN TRUE
END FUNCTION
################################################################################
# Descriptions...: sfba006帶值
PRIVATE FUNCTION asft300_sfba006_desc()
   INITIALIZE g_ref_fields TO NULL
   LET g_ref_fields[1] = g_sfba_d[l_ac].sfba006
   CALL ap_ref_array2(g_ref_fields,"SELECT imaal003,imaal004 FROM imaal_t WHERE imaalent='"||g_enterprise||"' AND imaal001=? AND imaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
   LET g_sfba_d[l_ac].sfba006_desc = '', g_rtn_fields[1] , ''
   LET g_sfba_d[l_ac].sfba006_desc1 = '', g_rtn_fields[2] , ''
   DISPLAY BY NAME g_sfba_d[l_ac].sfba006_desc
   DISPLAY BY NAME g_sfba_d[l_ac].sfba006_desc1
   IF NOT cl_null(g_sfba_d[g_detail_idx].sfba006) THEN
      SELECT imaf013,imaf034  #160509-00009#4 by whitney add imaf034
        INTO g_sfba_d[g_detail_idx].imaf013,g_sfba_d[g_detail_idx].sfba033  #160509-00009#4 by whitney add sfba033
        FROM imaf_t
       WHERE imafent = g_enterprise
         AND imafsite = g_site
         AND imaf001 = g_sfba_d[g_detail_idx].sfba006
       #170322-00078#1 add --(S)--
       IF cl_null(g_sfba_d[g_detail_idx].sfba033) THEN
          LET g_sfba_d[g_detail_idx].sfba033 = 'N'
       END IF
       #170322-00078#1 add --(E)--     
       DISPLAY BY NAME g_sfba_d[g_detail_idx].imaf013
      SELECT imae023,imae081 INTO g_sfba_d[g_detail_idx].sfba008,g_sfba_d[g_detail_idx].sfba014  #160106-00010 by whitney add imae023
        FROM imae_t
       WHERE imaeent = g_enterprise
         AND imaesite = g_site
         AND imae001 = g_sfba_d[g_detail_idx].sfba006
      DISPLAY BY NAME g_sfba_d[g_detail_idx].sfba014               
   END IF 
END FUNCTION
#来源单号项次项序检查及带值
PRIVATE FUNCTION asft300_sfaa006_chk()
DEFINE p_cmd         LIKE type_t.chr1
DEFINE l_sql         STRING
DEFINE l_sql1        STRING
DEFINE l_sql2        STRING
DEFINE l_n           LIKE type_t.num5
DEFINE l_xmda004     LIKE xmda_t.xmda004
DEFINE l_xmda007     LIKE xmda_t.xmda007
DEFINE l_xmda008     LIKE xmda_t.xmda008
#161109-00085#27-s
#DEFINE l_xmdd        RECORD LIKE xmdd_t.*
DEFINE l_xmdd RECORD  #訂單交期明細檔
       xmddent LIKE xmdd_t.xmddent, #企業編號
       xmddsite LIKE xmdd_t.xmddsite, #營運據點
       xmdddocno LIKE xmdd_t.xmdddocno, #訂單單號
       xmddseq LIKE xmdd_t.xmddseq, #項次
       xmddseq1 LIKE xmdd_t.xmddseq1, #項序
       xmddseq2 LIKE xmdd_t.xmddseq2, #分批序
       xmdd001 LIKE xmdd_t.xmdd001, #料件編號
       xmdd002 LIKE xmdd_t.xmdd002, #產品特徵
       xmdd003 LIKE xmdd_t.xmdd003, #子件特性
       xmdd004 LIKE xmdd_t.xmdd004, #銷售單位
       xmdd005 LIKE xmdd_t.xmdd005, #訂購總數量
       xmdd006 LIKE xmdd_t.xmdd006, #分批訂購數量
       xmdd007 LIKE xmdd_t.xmdd007, #摺合主件數量
       xmdd008 LIKE xmdd_t.xmdd008, #QPA
       xmdd009 LIKE xmdd_t.xmdd009, #交期類型
       xmdd010 LIKE xmdd_t.xmdd010, #出貨時段
       xmdd011 LIKE xmdd_t.xmdd011, #約定交貨日期
       xmdd012 LIKE xmdd_t.xmdd012, #預計簽收日期
       xmdd013 LIKE xmdd_t.xmdd013, #MRP交期凍結
       xmdd014 LIKE xmdd_t.xmdd014, #已出貨量
       xmdd015 LIKE xmdd_t.xmdd015, #已銷退量
       xmdd016 LIKE xmdd_t.xmdd016, #銷退換貨數量
       xmdd017 LIKE xmdd_t.xmdd017, #出貨狀態
       xmdd018 LIKE xmdd_t.xmdd018, #參考價格
       xmdd019 LIKE xmdd_t.xmdd019, #稅別
       xmdd020 LIKE xmdd_t.xmdd020, #稅率
       xmdd021 LIKE xmdd_t.xmdd021, #電子訂購單號
       xmdd022 LIKE xmdd_t.xmdd022, #最近修改人員
       xmdd023 LIKE xmdd_t.xmdd023, #最近修改時間
       xmdd024 LIKE xmdd_t.xmdd024, #分批參考單位
       xmdd025 LIKE xmdd_t.xmdd025, #分批參考數量
       xmdd026 LIKE xmdd_t.xmdd026, #分批計價單位
       xmdd027 LIKE xmdd_t.xmdd027, #分批計價數量
       xmdd028 LIKE xmdd_t.xmdd028, #分批未稅金額
       xmdd029 LIKE xmdd_t.xmdd029, #分批含稅金額
       xmdd030 LIKE xmdd_t.xmdd030, #分批稅額
       xmdd031 LIKE xmdd_t.xmdd031, #已轉出通數量
       xmdd032 LIKE xmdd_t.xmdd032, #備置量
       xmdd033 LIKE xmdd_t.xmdd033, #備置原因
       xmdd034 LIKE xmdd_t.xmdd034, #已簽退量
       xmdd035 LIKE xmdd_t.xmdd035, #已分配量
       xmdd200 LIKE xmdd_t.xmdd200, #促銷方案
       xmdd201 LIKE xmdd_t.xmdd201, #分批包裝單位
       xmdd202 LIKE xmdd_t.xmdd202, #分批包裝數量
       xmdd203 LIKE xmdd_t.xmdd203, #標準價
       xmdd204 LIKE xmdd_t.xmdd204, #促銷價
       xmdd205 LIKE xmdd_t.xmdd205, #交易價
       xmdd206 LIKE xmdd_t.xmdd206, #折價金額
       xmddunit LIKE xmdd_t.xmddunit, #應用組織
       xmdd207 LIKE xmdd_t.xmdd207, #收貨網點
       xmdd208 LIKE xmdd_t.xmdd208, #送貨地址碼
       xmdd209 LIKE xmdd_t.xmdd209, #送貨站點
       xmdd210 LIKE xmdd_t.xmdd210, #送貨時段
       xmdd211 LIKE xmdd_t.xmdd211, #送貨客戶
       xmdd212 LIKE xmdd_t.xmdd212, #MRP凍結
       xmdd213 LIKE xmdd_t.xmdd213, #庫位/庫區
       xmdd214 LIKE xmdd_t.xmdd214, #儲位
       xmdd215 LIKE xmdd_t.xmdd215, #批號
       xmdd216 LIKE xmdd_t.xmdd216, #庫存鎖定等級
       xmdd217 LIKE xmdd_t.xmdd217, #庫存餘額
       xmdd218 LIKE xmdd_t.xmdd218, #銷售渠道
       xmdd219 LIKE xmdd_t.xmdd219, #產品組編號
       xmdd220 LIKE xmdd_t.xmdd220, #銷售範圍編號
       xmdd221 LIKE xmdd_t.xmdd221, #備註
       xmdd222 LIKE xmdd_t.xmdd222, #辦事處
       xmdd223 LIKE xmdd_t.xmdd223, #業務人員
       xmdd224 LIKE xmdd_t.xmdd224, #業務部門
       xmdd225 LIKE xmdd_t.xmdd225, #主合約編號
       xmdd226 LIKE xmdd_t.xmdd226, #經營方式
       xmdd227 LIKE xmdd_t.xmdd227, #結算類型
       xmdd228 LIKE xmdd_t.xmdd228, #結算方式
       xmddorga LIKE xmdd_t.xmddorga, #帳務組織
       xmdd229 LIKE xmdd_t.xmdd229, #交易類型
       xmdd230 LIKE xmdd_t.xmdd230, #分批包裝銷退換貨數量
       #161109-00085#66 --s add
       xmddud001 LIKE xmdd_t.xmddud001, #自定義欄位(文字)001
       xmddud002 LIKE xmdd_t.xmddud002, #自定義欄位(文字)002
       xmddud003 LIKE xmdd_t.xmddud003, #自定義欄位(文字)003
       xmddud004 LIKE xmdd_t.xmddud004, #自定義欄位(文字)004
       xmddud005 LIKE xmdd_t.xmddud005, #自定義欄位(文字)005
       xmddud006 LIKE xmdd_t.xmddud006, #自定義欄位(文字)006
       xmddud007 LIKE xmdd_t.xmddud007, #自定義欄位(文字)007
       xmddud008 LIKE xmdd_t.xmddud008, #自定義欄位(文字)008
       xmddud009 LIKE xmdd_t.xmddud009, #自定義欄位(文字)009
       xmddud010 LIKE xmdd_t.xmddud010, #自定義欄位(文字)010
       xmddud011 LIKE xmdd_t.xmddud011, #自定義欄位(數字)011
       xmddud012 LIKE xmdd_t.xmddud012, #自定義欄位(數字)012
       xmddud013 LIKE xmdd_t.xmddud013, #自定義欄位(數字)013
       xmddud014 LIKE xmdd_t.xmddud014, #自定義欄位(數字)014
       xmddud015 LIKE xmdd_t.xmddud015, #自定義欄位(數字)015
       xmddud016 LIKE xmdd_t.xmddud016, #自定義欄位(數字)016
       xmddud017 LIKE xmdd_t.xmddud017, #自定義欄位(數字)017
       xmddud018 LIKE xmdd_t.xmddud018, #自定義欄位(數字)018
       xmddud019 LIKE xmdd_t.xmddud019, #自定義欄位(數字)019
       xmddud020 LIKE xmdd_t.xmddud020, #自定義欄位(數字)020
       xmddud021 LIKE xmdd_t.xmddud021, #自定義欄位(日期時間)021
       xmddud022 LIKE xmdd_t.xmddud022, #自定義欄位(日期時間)022
       xmddud023 LIKE xmdd_t.xmddud023, #自定義欄位(日期時間)023
       xmddud024 LIKE xmdd_t.xmddud024, #自定義欄位(日期時間)024
       xmddud025 LIKE xmdd_t.xmddud025, #自定義欄位(日期時間)025
       xmddud026 LIKE xmdd_t.xmddud026, #自定義欄位(日期時間)026
       xmddud027 LIKE xmdd_t.xmddud027, #自定義欄位(日期時間)027
       xmddud028 LIKE xmdd_t.xmddud028, #自定義欄位(日期時間)028
       xmddud029 LIKE xmdd_t.xmddud029, #自定義欄位(日期時間)029
       xmddud030 LIKE xmdd_t.xmddud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       xmdd036 LIKE xmdd_t.xmdd036, #還量數量
       xmdd037 LIKE xmdd_t.xmdd037, #還量參考數量
       xmdd038 LIKE xmdd_t.xmdd038, #還價數量
       xmdd039 LIKE xmdd_t.xmdd039, #還價參考數量
       xmdd231 LIKE xmdd_t.xmdd231, #庫存管理特徵
       xmdd040 LIKE xmdd_t.xmdd040  #BOM特性
END RECORD
#161109-00085#27-e

DEFINE l_success     LIKE type_t.num5
DEFINE l_rate        LIKE type_t.num5
DEFINE l_imae032     LIKE imae_t.imae032
DEFINE l_sum         LIKE sfaa_t.sfaa012
DEFINE l_num         LIKE sfaa_t.sfaa012
DEFINE l_num1        LIKE sfaa_t.sfaa012
DEFINE l_xmdddocno   LIKE xmdd_t.xmdddocno
DEFINE l_xmddseq     LIKE xmdd_t.xmddseq
DEFINE l_xmddseq1    LIKE xmdd_t.xmddseq1
DEFINE l_xmddseq2    LIKE xmdd_t.xmddseq2
DEFINE l_days        LIKE type_t.num5
DEFINE l_sfaa007     STRING
DEFINE l_sfaa008     STRING
DEFINE l_sfaa063     STRING
#161109-00085#27-s
#DEFINE l_psab        RECORD LIKE psab_t.*   #20150709 by dorislai
DEFINE l_psab RECORD  #獨立需求單身檔
       psabent LIKE psab_t.psabent, #企業編號
       psabsite LIKE psab_t.psabsite, #營運據點
       psabdocno LIKE psab_t.psabdocno, #需求單號
       psabseq LIKE psab_t.psabseq, #項次
       psab001 LIKE psab_t.psab001, #料件編號
       psab002 LIKE psab_t.psab002, #產品特徵
       psab003 LIKE psab_t.psab003, #需求日期
       psab004 LIKE psab_t.psab004, #單位
       psab005 LIKE psab_t.psab005, #需求數量
       psab006 LIKE psab_t.psab006, #已耗需求
       psab007 LIKE psab_t.psab007, #備註
       psab008 LIKE psab_t.psab008, #結案
       psab009 LIKE psab_t.psab009, #MRP凍結
       #161109-00085#66 --s add
       psabud001 LIKE psab_t.psabud001, #自定義欄位(文字)001
       psabud002 LIKE psab_t.psabud002, #自定義欄位(文字)002
       psabud003 LIKE psab_t.psabud003, #自定義欄位(文字)003
       psabud004 LIKE psab_t.psabud004, #自定義欄位(文字)004
       psabud005 LIKE psab_t.psabud005, #自定義欄位(文字)005
       psabud006 LIKE psab_t.psabud006, #自定義欄位(文字)006
       psabud007 LIKE psab_t.psabud007, #自定義欄位(文字)007
       psabud008 LIKE psab_t.psabud008, #自定義欄位(文字)008
       psabud009 LIKE psab_t.psabud009, #自定義欄位(文字)009
       psabud010 LIKE psab_t.psabud010, #自定義欄位(文字)010
       psabud011 LIKE psab_t.psabud011, #自定義欄位(數字)011
       psabud012 LIKE psab_t.psabud012, #自定義欄位(數字)012
       psabud013 LIKE psab_t.psabud013, #自定義欄位(數字)013
       psabud014 LIKE psab_t.psabud014, #自定義欄位(數字)014
       psabud015 LIKE psab_t.psabud015, #自定義欄位(數字)015
       psabud016 LIKE psab_t.psabud016, #自定義欄位(數字)016
       psabud017 LIKE psab_t.psabud017, #自定義欄位(數字)017
       psabud018 LIKE psab_t.psabud018, #自定義欄位(數字)018
       psabud019 LIKE psab_t.psabud019, #自定義欄位(數字)019
       psabud020 LIKE psab_t.psabud020, #自定義欄位(數字)020
       psabud021 LIKE psab_t.psabud021, #自定義欄位(日期時間)021
       psabud022 LIKE psab_t.psabud022, #自定義欄位(日期時間)022
       psabud023 LIKE psab_t.psabud023, #自定義欄位(日期時間)023
       psabud024 LIKE psab_t.psabud024, #自定義欄位(日期時間)024
       psabud025 LIKE psab_t.psabud025, #自定義欄位(日期時間)025
       psabud026 LIKE psab_t.psabud026, #自定義欄位(日期時間)026
       psabud027 LIKE psab_t.psabud027, #自定義欄位(日期時間)027
       psabud028 LIKE psab_t.psabud028, #自定義欄位(日期時間)028
       psabud029 LIKE psab_t.psabud029, #自定義欄位(日期時間)029
       psabud030 LIKE psab_t.psabud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       psab010 LIKE psab_t.psab010, #專案編號
       psab011 LIKE psab_t.psab011, #WBS編號
       psab012 LIKE psab_t.psab012, #BOM特性
       psab013 LIKE psab_t.psab013  #保稅否
END RECORD
#161109-00085#27-e

#161109-00085#27-s
#DEFINE l_psad        RECORD LIKE psad_t.*   #add--151207-00017#2 By shiun
DEFINE l_psad RECORD  #MPS計劃單身檔
       psadent LIKE psad_t.psadent, #企業編號
       psadsite LIKE psad_t.psadsite, #營運據點
       psaddocno LIKE psad_t.psaddocno, #MPS計劃單號
       psadseq LIKE psad_t.psadseq, #項次
       psad001 LIKE psad_t.psad001, #料件編號
       psad002 LIKE psad_t.psad002, #產品特徵
       psad003 LIKE psad_t.psad003, #預計生產完工日期
       psad004 LIKE psad_t.psad004, #單位
       psad005 LIKE psad_t.psad005, #計劃產量
       psad006 LIKE psad_t.psad006, #已開工單量
       psad007 LIKE psad_t.psad007, #備註
       psad008 LIKE psad_t.psad008, #結案
       psad009 LIKE psad_t.psad009, #MRP凍結
       #161109-00085#66 --s add
       psadud001 LIKE psad_t.psadud001, #自定義欄位(文字)001
       psadud002 LIKE psad_t.psadud002, #自定義欄位(文字)002
       psadud003 LIKE psad_t.psadud003, #自定義欄位(文字)003
       psadud004 LIKE psad_t.psadud004, #自定義欄位(文字)004
       psadud005 LIKE psad_t.psadud005, #自定義欄位(文字)005
       psadud006 LIKE psad_t.psadud006, #自定義欄位(文字)006
       psadud007 LIKE psad_t.psadud007, #自定義欄位(文字)007
       psadud008 LIKE psad_t.psadud008, #自定義欄位(文字)008
       psadud009 LIKE psad_t.psadud009, #自定義欄位(文字)009
       psadud010 LIKE psad_t.psadud010, #自定義欄位(文字)010
       psadud011 LIKE psad_t.psadud011, #自定義欄位(數字)011
       psadud012 LIKE psad_t.psadud012, #自定義欄位(數字)012
       psadud013 LIKE psad_t.psadud013, #自定義欄位(數字)013
       psadud014 LIKE psad_t.psadud014, #自定義欄位(數字)014
       psadud015 LIKE psad_t.psadud015, #自定義欄位(數字)015
       psadud016 LIKE psad_t.psadud016, #自定義欄位(數字)016
       psadud017 LIKE psad_t.psadud017, #自定義欄位(數字)017
       psadud018 LIKE psad_t.psadud018, #自定義欄位(數字)018
       psadud019 LIKE psad_t.psadud019, #自定義欄位(數字)019
       psadud020 LIKE psad_t.psadud020, #自定義欄位(數字)020
       psadud021 LIKE psad_t.psadud021, #自定義欄位(日期時間)021
       psadud022 LIKE psad_t.psadud022, #自定義欄位(日期時間)022
       psadud023 LIKE psad_t.psadud023, #自定義欄位(日期時間)023
       psadud024 LIKE psad_t.psadud024, #自定義欄位(日期時間)024
       psadud025 LIKE psad_t.psadud025, #自定義欄位(日期時間)025
       psadud026 LIKE psad_t.psadud026, #自定義欄位(日期時間)026
       psadud027 LIKE psad_t.psadud027, #自定義欄位(日期時間)027
       psadud028 LIKE psad_t.psadud028, #自定義欄位(日期時間)028
       psadud029 LIKE psad_t.psadud029, #自定義欄位(日期時間)029
       psadud030 LIKE psad_t.psadud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       psad010 LIKE psad_t.psad010  #保稅否
END RECORD
#161109-00085#27-e

DEFINE l_qty         LIKE psad_t.psad005    #add--151207-00017#2 By shiun
#161219-00070#2-add-s
DEFINE l_count       LIKE type_t.num5
DEFINE l_sql3        STRING
DEFINE l_xmdadocno   LIKE xmda_t.xmdadocno
DEFINE l_xmda005     LIKE xmda_t.xmda005
#161219-00070#2-add-e

#161128-00010#1 mod-----s
#   IF cl_null(g_sfaa_m.sfaa006) OR
#      cl_null(g_sfaa_m.sfaa007) OR
#      cl_null(g_sfaa_m.sfaa008) OR
#      cl_null(g_sfaa_m.sfaa063) THEN
#      IF g_sfaa_m.sfaa005 MATCHES '[23]'THEN
#         INITIALIZE g_errparam TO NULL
#         LET g_errparam.code = 'asf-00150'
#         LET g_errparam.popup = TRUE
#         CALL cl_err()
#         RETURN FALSE
#      END IF
#   END IF
   IF cl_null(g_sfaa_m.sfaa006) THEN
      IF g_sfaa_m.sfaa005 MATCHES '[3]'THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'asf-00646'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN FALSE
      END IF
      IF cl_null(g_sfaa_m.sfaa007) OR
         cl_null(g_sfaa_m.sfaa008) OR
         cl_null(g_sfaa_m.sfaa063) THEN
         IF g_sfaa_m.sfaa005 MATCHES '[2]'THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'asf-00150'
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN FALSE
         END IF
      END IF
   END IF
#161128-00010#1 mod-----e
   
   #當等於訂單、計畫等，檢查是否存在來源資料裡
   IF NOT cl_null(g_sfaa_m.sfaa006) THEN
      IF g_sfaa_m.sfaa006 != g_sfaa_m_o.sfaa006 OR cl_null(g_sfaa_m_o.sfaa006) THEN
         #150909 earl add s
         IF NOT s_aooi210_check_doc(g_site,'',g_sfaa_m.sfaa006,g_sfaa_m.sfaadocno,'4','') THEN
            RETURN FALSE
         END IF
         #150909 earl add e
      END IF
      IF g_sfaa_m.sfaa006 != g_sfaa_m_o.sfaa006 OR cl_null(g_sfaa_m_o.sfaa006) OR
         g_sfaa_m.sfaa007 != g_sfaa_m_o.sfaa007 OR cl_null(g_sfaa_m_o.sfaa007) OR
         g_sfaa_m.sfaa008 != g_sfaa_m_o.sfaa008 OR cl_null(g_sfaa_m_o.sfaa008) OR
         g_sfaa_m.sfaa063 != g_sfaa_m_o.sfaa063 OR cl_null(g_sfaa_m_o.sfaa063) THEN

     #订单
     IF g_sfaa_m.sfaa005 = '2' THEN
        LET l_sql1 = "SELECT COUNT(1) "
        LET l_sql2 = "SELECT xmddseq,xmddseq1,xmddseq2 "
       #161012-00024#1  mark  --begin--
       #LET l_sql = " FROM xmda_t,xmdd_t WHERE xmdaent=xmddent AND xmdadocno=xmdddocno ",
       #            "   AND xmddent='",g_enterprise,"' AND xmddsite='",g_site,"'",
       #            "   AND xmdddocno='",g_sfaa_m.sfaa006,"' AND xmdastus='Y'"
       #161012-00024#1  mark  --end--
       #161012-00024#1  add   --begin--
        LET l_sql = "  FROM xmda_t,xmdc_t,xmdd_t WHERE xmdaent=xmddent AND xmdadocno=xmdddocno ",
                    "   AND xmddent=xmdcent AND xmdddocno=xmdcdocno AND xmddseq=xmdcseq ",
                    "   AND xmddent='",g_enterprise,"' AND xmddsite='",g_site,"'",
                    "   AND xmdddocno='",g_sfaa_m.sfaa006,"' AND (xmdastus='Y' OR xmdastus='H')",
                    "   AND (xmdc045='1' OR xmdc045='5')"
       #161012-00024#1  add   --end--
        IF NOT cl_null(g_sfaa_m.sfaa007) THEN
           LET l_sql = l_sql," AND xmddseq=", g_sfaa_m.sfaa007
        END IF
        IF NOT cl_null(g_sfaa_m.sfaa008) THEN
           LET l_sql = l_sql," AND xmddseq1=", g_sfaa_m.sfaa008
        END IF
        IF NOT cl_null(g_sfaa_m.sfaa063) THEN
           LET l_sql = l_sql," AND xmddseq2=", g_sfaa_m.sfaa063
        END IF
        LET l_sql1 = l_sql1,l_sql        
        PREPARE asft300_sfaa006_pre1 FROM l_sql1
        EXECUTE asft300_sfaa006_pre1 INTO l_n
        
        IF l_n = 0 THEN
           INITIALIZE g_errparam TO NULL
           LET g_errparam.code = 'asf-00154'
           LET g_errparam.extend = g_sfaa_m.sfaa006
           LET g_errparam.popup = TRUE
           CALL cl_err()

           RETURN FALSE
        END IF
        
        #161219-00070#2-add-s
        SELECT xmda005,xmda007,xmda008 INTO l_xmda005,l_xmda007,l_xmda008
          FROM xmda_t
         WHERE xmdaent = g_enterprise
           AND xmdadocno = g_sfaa_m.sfaa006
        
        LET l_sql3 = " SELECT xmdadocno ",
                     "   FROM xmda_t ",
                     "  WHERE xmdaent = ",g_enterprise,
                     #161128-00045-s-mod
#                     "    AND xmdastus = 'Y' ",
                     "    AND xmdastus IN ('Y','H') ",
                     #161128-00045-e-mod
                     "    AND xmda007 = '2' ",
                     "    AND xmda008 = ? "
        PREPARE asft300_chk_xmda_p FROM l_sql3
        DECLARE asft300_chk_xmda_c CURSOR FOR asft300_chk_xmda_p
        
        LET l_sql3 = " SELECT COUNT(1) ",
                     "   FROM sfaa_t ",
                     "  WHERE sfaaent = ",g_enterprise,
                     "    AND sfaastus <> 'X' ",   #161222-00007#1
                     "    AND sfaa005 = '2' ",
                     "    AND sfaa006 = ? "
        PREPARE asft300_chk_sfaa_p FROM l_sql3
        LET l_sql3 = " SELECT COUNT(1) ",
                     "   FROM sfaa_t,sfab_t ",
                     "  WHERE sfaaent = sfabent ",
                     "    AND sfaadocno = sfabdocno ",
                     "    AND sfaastus <> 'X' ",   #161222-00007#1
                     "    AND sfabent = ",g_enterprise,                     
                     "    AND sfab001 = '2' ",
                     "    AND sfab002 = ? "
        PREPARE asft300_chk_sfab_p FROM l_sql3
        IF l_xmda005 = '5' THEN   #若訂單性質為預先訂單，需檢查該預先訂單對應的訂單是否有轉工單
           LET l_xmdadocno = ''           
           FOREACH asft300_chk_xmda_c USING g_sfaa_m.sfaa006 INTO l_xmdadocno
              LET l_count = 0
              EXECUTE asft300_chk_sfaa_p USING l_xmdadocno INTO l_count
              IF l_count = 0 THEN
                 EXECUTE asft300_chk_sfab_p USING l_xmdadocno INTO l_count                 
              END IF
              IF l_count > 0 THEN
                 INITIALIZE g_errparam TO NULL
                 LET g_errparam.code = 'asf-00824'   #輸入的預先訂單單號在工單上存在其訂單資料！
                 LET g_errparam.extend = g_sfaa_m.sfaa006
                 LET g_errparam.popup = TRUE
                 CALL cl_err()
                 RETURN FALSE
              END IF
           END FOREACH
        ELSE
           IF l_xmda007 = '2' THEN
              LET l_count = 0
              EXECUTE asft300_chk_sfaa_p USING l_xmda008 INTO l_count
              IF l_count = 0 THEN
                 EXECUTE asft300_chk_sfab_p USING l_xmda008 INTO l_count                 
              END IF
              IF l_count > 0 THEN
                 INITIALIZE g_errparam TO NULL
                 LET g_errparam.code = 'asf-00823'   #輸入的訂單單號在工單上存在其預先訂單資料！
                 LET g_errparam.extend = g_sfaa_m.sfaa006
                 LET g_errparam.popup = TRUE
                 CALL cl_err()
                 RETURN FALSE
              END IF
           END IF
        END IF
        #161219-00070#2-add-e
        
        IF l_n = 1 THEN
           LET l_sql2 = l_sql2,l_sql
           PREPARE asft300_sfaa006_pre2 FROM l_sql2
           EXECUTE asft300_sfaa006_pre2 INTO g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063
        ELSE
           #开窗选择
           INITIALIZE g_qryparam.* TO NULL
           LET g_qryparam.state = 'i'
			  LET g_qryparam.reqry = FALSE
           LET g_qryparam.where = " xmdddocno = '",g_sfaa_m.sfaa006,"'"
           IF NOT cl_null(g_sfaa_m.sfaa007) THEN
              LET g_qryparam.where = g_qryparam.where," AND xmddseq = ",g_sfaa_m.sfaa007
           END IF
           IF NOT cl_null(g_sfaa_m.sfaa008) THEN
              LET g_qryparam.where = g_qryparam.where," AND xmddseq1 = ",g_sfaa_m.sfaa008
           END IF
           IF NOT cl_null(g_sfaa_m.sfaa063) THEN
              LET g_qryparam.where = g_qryparam.where," AND xmddseq2 = ",g_sfaa_m.sfaa063
           END IF
           CALL q_xmdddocno()                                #呼叫開窗        
           LET g_sfaa_m.sfaa006 = g_qryparam.return1              #將開窗取得的值回傳到變數
           LET g_sfaa_m.sfaa007 = g_qryparam.return2
           LET g_sfaa_m.sfaa008 = g_qryparam.return3
           LET g_sfaa_m.sfaa063 = g_qryparam.return4
        END IF   
        LET l_sfaa007 = g_sfaa_m.sfaa007
        LET l_sfaa008 = g_sfaa_m.sfaa008
        LET l_sfaa063 = g_sfaa_m.sfaa063
        LET g_sfaa_m.l_sfaa007 = l_sfaa007 CLIPPED,"-",l_sfaa008 CLIPPED,"-",l_sfaa063 CLIPPED
        DISPLAY BY NAME g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.l_sfaa007
     END IF
     #dorislai-20150708-add----(S)
     #獨立需求單
     IF g_sfaa_m.sfaa005 = '6' THEN
        LET l_sql1 = "SELECT COUNT(1) "
        LET l_sql2 = "SELECT psabseq "
        LET l_sql = " FROM psaa_t,psab_t WHERE psaaent=psabent AND psaadocno=psabdocno ",
                    "   AND psabent='",g_enterprise,"' AND psabsite='",g_site,"'",
                    "   AND psabdocno='",g_sfaa_m.sfaa006,"' AND psaastus='Y'"
        IF NOT cl_null(g_sfaa_m.sfaa007) THEN
           LET l_sql = l_sql," AND psabseq=", g_sfaa_m.sfaa007    #項次
        END IF

        LET l_sql1 = l_sql1,l_sql  #確認是否存在這筆單號資料      
        PREPARE asft300_sfaa006_pre1_1 FROM l_sql1
        EXECUTE asft300_sfaa006_pre1_1 INTO l_n
        #沒撈到資料
        IF l_n = 0 THEN
           INITIALIZE g_errparam TO NULL
           LET g_errparam.code = 'asf-00154'   #來源單號不存在！
           LET g_errparam.extend = g_sfaa_m.sfaa006
           LET g_errparam.popup = TRUE
           CALL cl_err()

           RETURN FALSE
        END IF
        
        #有撈到資料
        IF l_n = 1 THEN
           LET l_sql2 = l_sql2,l_sql
           PREPARE asft300_sfaa006_pre2_1 FROM l_sql2
           EXECUTE asft300_sfaa006_pre2_1 INTO g_sfaa_m.sfaa007    #項次
        ELSE
           #開窗選擇
           INITIALIZE g_qryparam.* TO NULL
           LET g_qryparam.state = 'i'
			  LET g_qryparam.reqry = FALSE
           LET g_qryparam.where = " psabdocno = '",g_sfaa_m.sfaa006,"'"
           IF NOT cl_null(g_sfaa_m.sfaa007) THEN
              LET g_qryparam.where = g_qryparam.where," AND psabseq = ",g_sfaa_m.sfaa007
           END IF

           CALL q_psabdocno()                                #呼叫開窗        
           LET g_sfaa_m.sfaa006 = g_qryparam.return1         #將開窗取得的值回傳到變數
           LET g_sfaa_m.sfaa007 = g_qryparam.return2
           LET g_sfaa_m.sfaa008 = ' '
           LET g_sfaa_m.sfaa063 = ' '
        END IF   
        LET l_sfaa007 = g_sfaa_m.sfaa007
        LET g_sfaa_m.l_sfaa007 = l_sfaa007
        DISPLAY BY NAME g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.l_sfaa007
  
     END IF
     #dorislai-20150708-add----(E)
     #add--151207-00017#2 By shiun--(S)
     #MPS計劃
     IF g_sfaa_m.sfaa005 = '7' THEN
        LET l_sql1 = "SELECT COUNT(1) "
        LET l_sql2 = "SELECT psadseq "
        LET l_sql = " FROM psac_t,psad_t WHERE psacent=psadent AND psacdocno=psaddocno ",
                    "   AND psadent='",g_enterprise,"' AND psadsite='",g_site,"'",
                    "   AND psaddocno='",g_sfaa_m.sfaa006,"' AND psacstus='Y' AND psad008 = 'N' "
        IF NOT cl_null(g_sfaa_m.sfaa007) THEN
           LET l_sql = l_sql," AND psadseq=", g_sfaa_m.sfaa007    #項次
        END IF

        LET l_sql1 = l_sql1,l_sql  #確認是否存在這筆單號資料      
        PREPARE asft300_sfaa006_pre1_2 FROM l_sql1
        EXECUTE asft300_sfaa006_pre1_2 INTO l_n
        #沒撈到資料
        IF l_n = 0 THEN
           INITIALIZE g_errparam TO NULL
           LET g_errparam.code = 'asf-00154'   #來源單號不存在！
           LET g_errparam.extend = g_sfaa_m.sfaa006
           LET g_errparam.popup = TRUE
           CALL cl_err()

           RETURN FALSE
        END IF
        
        #有撈到資料
        IF l_n = 1 THEN
           LET l_sql2 = l_sql2,l_sql
           PREPARE asft300_sfaa006_pre2_2 FROM l_sql2
           EXECUTE asft300_sfaa006_pre2_2 INTO g_sfaa_m.sfaa007    #項次
        ELSE
           #開窗選擇
           INITIALIZE g_qryparam.* TO NULL
           LET g_qryparam.state = 'i'
			  LET g_qryparam.reqry = FALSE
           LET g_qryparam.where = " psaddocno = '",g_sfaa_m.sfaa006,"'"
           IF NOT cl_null(g_sfaa_m.sfaa007) THEN
              LET g_qryparam.where = g_qryparam.where," AND psadseq = ",g_sfaa_m.sfaa007
           END IF

           CALL q_psaddocno()                                #呼叫開窗        
           LET g_sfaa_m.sfaa006 = g_qryparam.return1         #將開窗取得的值回傳到變數
           LET g_sfaa_m.sfaa007 = g_qryparam.return2
           LET g_sfaa_m.sfaa008 = ' '
           LET g_sfaa_m.sfaa063 = ' '
        END IF   
        LET l_sfaa007 = g_sfaa_m.sfaa007
        LET g_sfaa_m.l_sfaa007 = l_sfaa007
        DISPLAY BY NAME g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.l_sfaa007
     END IF
     #add--151207-00017#2 By shiun--(E)
  ELSE
     RETURN FALSE
  END IF

  

  #带值
  IF g_sfaa_m.sfaa005 ='2' THEN
     IF NOT cl_null(g_sfaa_m.sfaa006) AND NOT cl_null(g_sfaa_m.sfaa007) AND NOT cl_null(g_sfaa_m.sfaa008) AND NOT cl_null(g_sfaa_m.sfaa063) THEN
       #SELECT xmda004,xmda007,xmda008,xmdd_t.* INTO l_xmda004,l_xmda007,l_xmda008,l_xmdd.* FROM xmda_t,xmdd_t   #161110-00005#1 mark
       #161110-00005#1--add--start--
        SELECT xmda004,xmda007,xmda008,
               xmddent,xmddsite,xmdddocno,xmddseq,xmddseq1,xmddseq2,
               xmdd001,xmdd002,xmdd003,xmdd004,xmdd005,xmdd006,
               xmdd007,xmdd008,xmdd009,xmdd010,xmdd011,xmdd012,
               xmdd013,xmdd014,xmdd015,xmdd016,xmdd017,xmdd018,
               xmdd019,xmdd020,xmdd021,xmdd022,xmdd023,xmdd024,
               xmdd025,xmdd026,xmdd027,xmdd028,xmdd029,xmdd030,
               xmdd031,xmdd032,xmdd033,xmdd034,xmdd035,xmdd200,
               xmdd201,xmdd202,xmdd203,xmdd204,xmdd205,xmdd206,
               xmddunit,xmdd207,xmdd208,xmdd209,xmdd210,xmdd211,
               xmdd212,xmdd213,xmdd214,xmdd215,xmdd216,xmdd217,
               xmdd218,xmdd219,xmdd220,xmdd221,xmdd222,xmdd223,
               xmdd224,xmdd225,xmdd226,xmdd227,xmdd228,xmddorga,
               xmdd229,xmdd230,xmdd036,xmdd037,xmdd038,xmdd039,
               xmdd231,xmdd040
          INTO l_xmda004,l_xmda007,l_xmda008,
               l_xmdd.xmddent,l_xmdd.xmddsite,l_xmdd.xmdddocno,l_xmdd.xmddseq,l_xmdd.xmddseq1,l_xmdd.xmddseq2,
               l_xmdd.xmdd001,l_xmdd.xmdd002,l_xmdd.xmdd003,l_xmdd.xmdd004,l_xmdd.xmdd005,l_xmdd.xmdd006,
               l_xmdd.xmdd007,l_xmdd.xmdd008,l_xmdd.xmdd009,l_xmdd.xmdd010,l_xmdd.xmdd011,l_xmdd.xmdd012,
               l_xmdd.xmdd013,l_xmdd.xmdd014,l_xmdd.xmdd015,l_xmdd.xmdd016,l_xmdd.xmdd017,l_xmdd.xmdd018,
               l_xmdd.xmdd019,l_xmdd.xmdd020,l_xmdd.xmdd021,l_xmdd.xmdd022,l_xmdd.xmdd023,l_xmdd.xmdd024,
               l_xmdd.xmdd025,l_xmdd.xmdd026,l_xmdd.xmdd027,l_xmdd.xmdd028,l_xmdd.xmdd029,l_xmdd.xmdd030,
               l_xmdd.xmdd031,l_xmdd.xmdd032,l_xmdd.xmdd033,l_xmdd.xmdd034,l_xmdd.xmdd035,l_xmdd.xmdd200,
               l_xmdd.xmdd201,l_xmdd.xmdd202,l_xmdd.xmdd203,l_xmdd.xmdd204,l_xmdd.xmdd205,l_xmdd.xmdd206,
               l_xmdd.xmddunit,l_xmdd.xmdd207,l_xmdd.xmdd208,l_xmdd.xmdd209,l_xmdd.xmdd210,l_xmdd.xmdd211,
               l_xmdd.xmdd212,l_xmdd.xmdd213,l_xmdd.xmdd214,l_xmdd.xmdd215,l_xmdd.xmdd216,l_xmdd.xmdd217,
               l_xmdd.xmdd218,l_xmdd.xmdd219,l_xmdd.xmdd220,l_xmdd.xmdd221,l_xmdd.xmdd222,l_xmdd.xmdd223,
               l_xmdd.xmdd224,l_xmdd.xmdd225,l_xmdd.xmdd226,l_xmdd.xmdd227,l_xmdd.xmdd228,l_xmdd.xmddorga,
               l_xmdd.xmdd229,l_xmdd.xmdd230,l_xmdd.xmdd036,l_xmdd.xmdd037,l_xmdd.xmdd038,l_xmdd.xmdd039,
               l_xmdd.xmdd231,l_xmdd.xmdd040
          FROM xmda_t,xmdd_t
       #161110-00005#1--add--end----       
         WHERE xmdaent=xmddent AND xmdadocno=xmdddocno
           AND xmddent=g_enterprise AND xmddsite=g_site
           AND xmdddocno=g_sfaa_m.sfaa006 AND xmddseq=g_sfaa_m.sfaa007
           AND xmddseq1=g_sfaa_m.sfaa008 AND xmddseq2=g_sfaa_m.sfaa063
                 
        LET g_sfaa_m.sfaa010=l_xmdd.xmdd001
        LET g_sfaa_m.sfaa011 = l_xmdd.xmdd040 #160214-00005#3-add
        #160214-00005#3-mod-(S)
#        SELECT imae037 INTO g_sfaa_m.sfaa011 FROM imae_t WHERE imaeent=g_enterprise AND imaesite=g_site AND imae001=g_sfaa_m.sfaa010
#         IF cl_null(g_sfaa_m.sfaa011) THEN
#           LET g_sfaa_m.sfaa011 = ' '
#        END IF
        IF cl_null(g_sfaa_m.sfaa011) THEN
           SELECT NVL(imae037,' ') INTO g_sfaa_m.sfaa011 FROM imae_t WHERE imaeent=g_enterprise AND imaesite=g_site AND imae001=g_sfaa_m.sfaa010
        END IF
        #160214-00005#3-mod-(E)
        #160921-00022#1-s-add 
        SELECT imae035,(CASE imae014 WHEN '0' THEN '1' WHEN '1' THEN '2' END ) 
          INTO g_sfaa_m.sfaa068,g_sfaa_m.sfaa004
          FROM imae_t WHERE imaeent=g_enterprise AND imaesite=g_site AND imae001=g_sfaa_m.sfaa010
        #160921-00022#1-e-add  
        #订单对应的料号应chk
        IF NOT asft300_sfaa010_chk() THEN
           IF p_cmd = 'a' THEN
              LET g_sfaa_m.sfaa010 = g_sfaa_m_t.sfaa010
              LET g_sfaa_m.sfaa011 = g_sfaa_m_t.sfaa011
           END IF

           RETURN FALSE
        END IF
        
        LET g_sfaa_m.sfaa012=l_xmdd.xmdd006
        LET g_sfaa_m.sfaa013=l_xmdd.xmdd004        
        
        #已开工单量计算
        CALL asft300_sfaa006_chk_qty(g_sfaa_m.sfaa006,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa013) RETURNING l_sum
            
        LET g_sfaa_m.sfaa012 = g_sfaa_m.sfaa012 - l_sum
        IF g_sfaa_m.sfaa012 <= 0 THEN
           INITIALIZE g_errparam TO NULL
           LET g_errparam.code = 'asf-00336'
           LET g_errparam.extend = ''
           LET g_errparam.popup = TRUE
           CALL cl_err()

           IF p_cmd = 'a' THEN
              LET g_sfaa_m.sfaa010 = g_sfaa_m_t.sfaa010
              LET g_sfaa_m.sfaa011 = g_sfaa_m_t.sfaa011
              LET g_sfaa_m.sfaa012 = g_sfaa_m_t.sfaa012
              LET g_sfaa_m.sfaa013 = g_sfaa_m_t.sfaa013
           END IF
           RETURN FALSE
        END IF
        
        #预先订单对应已开工单数量也纳入计算
        IF l_xmda007 = '2' AND NOT cl_null(l_xmda008) THEN
           LET l_sql = "SELECT xmdddocno,xmddseq,xmddseq1,xmddseq2 FROM xmdd_t,xmda_t WHERE xmdaent=xmddent AND xmdasite=xmddsite AND xmdadocno=xmdddocno",
                      "   AND xmddent=",g_enterprise," AND xmddsite='",g_site,"' AND xmdadocno='",l_xmda008,"'",
                      #161128-00045-s-mod
#                      "   AND xmdd001='",g_sfaa_m.sfaa010,"' AND xmdastus='Y'"
                      "   AND xmdd001='",g_sfaa_m.sfaa010,"' AND xmdastus IN ('Y','H') "
                      #161128-00045-e-mod
           PREPARE asft300_01_pre_1 FROM l_sql
           DECLARE asft300_01_cs_1 CURSOR FOR asft300_01_pre_1
           LET l_num = 0
           FOREACH asft300_01_cs_1 INTO l_xmdddocno,l_xmddseq,l_xmddseq1,l_xmddseq2
              IF SQLCA.sqlcode THEN
                 INITIALIZE g_errparam TO NULL
                 LET g_errparam.code = SQLCA.sqlcode
                 LET g_errparam.extend = "FOREACH:"
                 LET g_errparam.popup = TRUE
                 CALL cl_err()

                 EXIT FOREACH
              END IF
              CALL asft300_sfaa006_chk_qty(l_xmdddocno,l_xmddseq,l_xmddseq1,l_xmddseq2,g_sfaa_m.sfaa013) RETURNING l_num1
              LET l_num = l_num + l_num1
           END FOREACH
           LET g_sfaa_m.sfaa012 = g_sfaa_m.sfaa012 - l_num
           IF g_sfaa_m.sfaa012 <= 0 THEN
              INITIALIZE g_errparam TO NULL
           LET g_errparam.code = 'asf-00336'
           LET g_errparam.extend = ''
           LET g_errparam.popup = TRUE
           CALL cl_err()

              IF p_cmd = 'a' THEN
                 LET g_sfaa_m.sfaa010 = g_sfaa_m_t.sfaa010
                 LET g_sfaa_m.sfaa011 = g_sfaa_m_t.sfaa011
                 LET g_sfaa_m.sfaa012 = g_sfaa_m_t.sfaa012
                 LET g_sfaa_m.sfaa013 = g_sfaa_m_t.sfaa013
              END IF
              RETURN FALSE
           END IF
        END IF        

        LET g_sfaa_m.sfaa009=l_xmda004        
        LET g_sfaa_m.sfaa058=l_xmdd.xmdd025
        LET g_sfaa_m.sfaa060=l_xmdd.xmdd024
        LET g_sfaa_m.sfaa020=l_xmdd.xmdd011 
        #重算参考数量
        IF l_sum > 0 OR l_num > 0 THEN
          #CALL s_aimi190_get_convert(g_sfaa_m.sfaa010,g_sfaa_m.sfaa013,g_sfaa_m.sfaa060) RETURNING l_success,l_rate
          #IF l_success THEN
          #   LET g_sfaa_m.sfaa058 = g_sfaa_m.sfaa012 * l_rate
          #END IF
           CALL s_aooi250_convert_qty(g_sfaa_m.sfaa010,g_sfaa_m.sfaa013,g_sfaa_m.sfaa060,g_sfaa_m.sfaa012)
                RETURNING l_success,g_sfaa_m.sfaa058
           IF NOT l_success THEN
              LET g_sfaa_m.sfaa058 = g_sfaa_m.sfaa012
           END IF
        END IF
         
        IF NOT cl_null(g_sfaa_m.sfaa010) AND NOT cl_null(g_sfaa_m.sfaa012) THEN
           IF NOT cl_null(g_sfaa_m.sfaa020) THEN
              CALL s_asft300_06('2',g_sfaa_m.sfaa010,g_sfaa_m.sfaa012,g_sfaa_m.sfaa020) RETURNING l_success,g_sfaa_m.sfaa019
              IF g_sfaa_m.sfaa019 < g_sfaa_m.sfaadocdt THEN
                 LET l_days = g_sfaa_m.sfaadocdt - g_sfaa_m.sfaa019
                 LET g_sfaa_m.sfaa019 = g_sfaa_m.sfaadocdt        
                 #根据当前营运据点g_site抓取aooi120中设置的行事历参照表号
                 CALL s_date_get_work_date(g_site,g_ooef008,'2',g_sfaa_m.sfaa020,0,l_days) RETURNING g_sfaa_m.sfaa020 
              END IF
           ELSE
              IF NOT cl_null(g_sfaa_m.sfaa019) THEN
                 CALL s_asft300_06('1',g_sfaa_m.sfaa010,g_sfaa_m.sfaa012,g_sfaa_m.sfaa019) RETURNING l_success,g_sfaa_m.sfaa020
              END IF
           END IF
        END IF
        
        #20150906 By wuxja add  --begin--
        #记录订单料件对应的产品特征
        IF NOT cl_null(l_xmdd.xmdd002) THEN
           LET g_inam[1].inam001 = g_sfaa_m.sfaa010
           LET g_inam[1].inam002 = l_xmdd.xmdd002
           LET g_inam[1].inam004 = g_sfaa_m.sfaa012
           LET g_inam004_sum = g_sfaa_m.sfaa012
        END IF
        #20150906 By wuxja add  --end--
        
        LET g_sfaa_m_t.sfaa006=g_sfaa_m.sfaa006
        LET g_sfaa_m_t.sfaa007=g_sfaa_m.sfaa007
        LET g_sfaa_m_t.sfaa008=g_sfaa_m.sfaa008
        LET g_sfaa_m_t.sfaa063=g_sfaa_m.sfaa063
        LET g_sfaa_m_t.sfaa010=g_sfaa_m.sfaa010
        LET g_sfaa_m_t.sfaa011=g_sfaa_m.sfaa011
        LET g_sfaa_m_t.sfaa012=g_sfaa_m.sfaa012
        LET g_sfaa_m_t.sfaa013=g_sfaa_m.sfaa013
        LET g_sfaa_m_t.sfaa019=g_sfaa_m.sfaa019
        LET g_sfaa_m_t.sfaa020=g_sfaa_m.sfaa020 
        
        #160601-00001#1 20160629 add by ming -----(S) 
        SELECT xmdc021 INTO g_sfaa_m.sfaa072
          FROM xmdc_t 
         WHERE xmdcent   = g_enterprise  
           AND xmdcdocno = g_sfaa_m.sfaa006 
           AND xmdcseq   = g_sfaa_m.sfaa007 
        
        LET g_sfaa_m_t.sfaa072 = g_sfaa_m.sfaa072 
      
        #160601-00001#1 20160629 add by ming -----(E) 
     END IF
  END IF
  
  #dorislai-20150709-add----(S)
  IF g_sfaa_m.sfaa005 = '6' THEN
     IF NOT cl_null(g_sfaa_m.sfaa006) AND NOT cl_null(g_sfaa_m.sfaa007) THEN
        #161109-00085#27-s
        #SELECT psab_t.* INTO l_psab.*
        #161109-00085#66 --s mark
        #SELECT psabent,psabsite,psabdocno,psabseq,psab001,psab002,psab003,psab004,psab005,psab006,
        #       psab007,psab008,psab009,psab010,psab011,psab012,psab013
        #  INTO l_psab.psabent,l_psab.psabsite,l_psab.psabdocno,l_psab.psabseq,l_psab.psab001,
        #       l_psab.psab002,l_psab.psab003,l_psab.psab004,l_psab.psab005,l_psab.psab006,
        #       l_psab.psab007,l_psab.psab008,l_psab.psab009,l_psab.psab010,l_psab.psab011,
        #       l_psab.psab012,l_psab.psab013      
        #161109-00085#66 --e mark
        #161109-00085#66 --s add
        SELECT psabent,psabsite,psabdocno,psabseq,psab001,
               psab002,psab003,psab004,psab005,psab006,
               psab007,psab008,psab009,psabud001,psabud002,
               psabud003,psabud004,psabud005,psabud006,psabud007,
               psabud008,psabud009,psabud010,psabud011,psabud012,
               psabud013,psabud014,psabud015,psabud016,psabud017,
               psabud018,psabud019,psabud020,psabud021,psabud022,
               psabud023,psabud024,psabud025,psabud026,psabud027,
               psabud028,psabud029,psabud030,psab010,psab011,
               psab012,psab013
          INTO l_psab.psabent,l_psab.psabsite,l_psab.psabdocno,l_psab.psabseq,l_psab.psab001,
               l_psab.psab002,l_psab.psab003,l_psab.psab004,l_psab.psab005,l_psab.psab006,
               l_psab.psab007,l_psab.psab008,l_psab.psab009,l_psab.psabud001,l_psab.psabud002,
               l_psab.psabud003,l_psab.psabud004,l_psab.psabud005,l_psab.psabud006,l_psab.psabud007,
               l_psab.psabud008,l_psab.psabud009,l_psab.psabud010,l_psab.psabud011,l_psab.psabud012,
               l_psab.psabud013,l_psab.psabud014,l_psab.psabud015,l_psab.psabud016,l_psab.psabud017,
               l_psab.psabud018,l_psab.psabud019,l_psab.psabud020,l_psab.psabud021,l_psab.psabud022,
               l_psab.psabud023,l_psab.psabud024,l_psab.psabud025,l_psab.psabud026,l_psab.psabud027,
               l_psab.psabud028,l_psab.psabud029,l_psab.psabud030,l_psab.psab010,l_psab.psab011,
               l_psab.psab012,l_psab.psab013
        #161109-00085#66 --e add
        #161109-00085#27-e        
          FROM psaa_t,psab_t 
         WHERE psaaent=psabent AND psaadocno=psabdocno
           AND psabent=g_enterprise AND psabsite=g_site
           AND psabdocno=g_sfaa_m.sfaa006 AND psabseq=g_sfaa_m.sfaa007
                 
        LET g_sfaa_m.sfaa010 = l_psab.psab001
        
        #160921-00022#1-s-mod
        ##抓取特性
        #SELECT imae037 INTO g_sfaa_m.sfaa011 FROM imae_t WHERE imaeent=g_enterprise AND imaesite=g_site AND imae001=g_sfaa_m.sfaa010
        #抓取特性、成本中心、發料機制
        SELECT imae037,imae035,(CASE imae014 WHEN '0' THEN '1' WHEN '1' THEN '2' END ) 
          INTO g_sfaa_m.sfaa011,g_sfaa_m.sfaa068,g_sfaa_m.sfaa004 
          FROM imae_t WHERE imaeent=g_enterprise AND imaesite=g_site AND imae001=g_sfaa_m.sfaa010
        #160921-00022#1-e-mod
        
        #170103-00023#1-s-add
        IF NOT cl_null(l_psab.psab012) THEN
           LET g_sfaa_m.sfaa011 = l_psab.psab012   
        END IF
        #170103-00023#1-e-add
        
        IF cl_null(g_sfaa_m.sfaa011) THEN
           LET g_sfaa_m.sfaa011 = ' '
        END IF
        #訂單對應的料號chk
        IF NOT asft300_sfaa010_chk() THEN
           LET g_sfaa_m.sfaa006 = g_sfaa_m_t.sfaa006  #單號
           LET g_sfaa_m.l_sfaa007 = ''                #項次
           LET g_sfaa_m.sfaa010 = ''                  #生產料號
           LET g_sfaa_m.sfaa010_desc = ''             #清空品名
           LET g_sfaa_m.sfaa010_desc1 = ''            #清空規格
           LET g_sfaa_m.sfaa011 = ''                  #特性
     
           RETURN FALSE
        END IF
        
        LET g_sfaa_m.sfaa012 = l_psab.psab005 #需求數量
        LET g_sfaa_m.sfaa013 = l_psab.psab004 #單位        
        LET g_sfaa_m.sfaa020 = l_psab.psab003 #170106-00011#1 add #預計完工日應該要抓apst300上的需求日 
        
        
        #已开工单量计算
        #modify--151207-00017#2 By shiun--(S)
#        CALL asft300_sfaa006_chk_qty(g_sfaa_m.sfaa006,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa013) RETURNING l_sum
#        LET g_sfaa_m.sfaa012 = g_sfaa_m.sfaa012 - l_sum
        LET l_qty = l_psab.psab006 
        CALL s_aooi250_convert_qty(g_sfaa_m.sfaa010,l_psab.psab004,g_sfaa_m.sfaa013,l_qty)
             RETURNING l_success,l_qty 
        LET g_sfaa_m.sfaa012 = g_sfaa_m.sfaa012 - l_qty 
        #modify--151207-00017#2 By shiun--(E)
        IF g_sfaa_m.sfaa012 <= 0 THEN
           INITIALIZE g_errparam TO NULL
           LET g_errparam.code = 'asf-00717'
           LET g_errparam.extend = ''
           LET g_errparam.popup = TRUE
           CALL cl_err()

           IF p_cmd = 'a' THEN
              LET g_sfaa_m.sfaa010 = g_sfaa_m_t.sfaa010
              LET g_sfaa_m.sfaa011 = g_sfaa_m_t.sfaa011
              LET g_sfaa_m.sfaa012 = g_sfaa_m_t.sfaa012
              LET g_sfaa_m.sfaa013 = g_sfaa_m_t.sfaa013
           END IF
           RETURN FALSE
        END IF

         
        IF NOT cl_null(g_sfaa_m.sfaa010) AND NOT cl_null(g_sfaa_m.sfaa012) THEN
           IF NOT cl_null(g_sfaa_m.sfaa020) THEN
              CALL s_asft300_06('2',g_sfaa_m.sfaa010,g_sfaa_m.sfaa012,g_sfaa_m.sfaa020) RETURNING l_success,g_sfaa_m.sfaa019
              IF g_sfaa_m.sfaa019 < g_sfaa_m.sfaadocdt THEN
                 LET l_days = g_sfaa_m.sfaadocdt - g_sfaa_m.sfaa019
                 LET g_sfaa_m.sfaa019 = g_sfaa_m.sfaadocdt        
                 #根据当前营运据点g_site抓取aooi120中设置的行事历参照表号
                 CALL s_date_get_work_date(g_site,g_ooef008,'2',g_sfaa_m.sfaa020,0,l_days) RETURNING g_sfaa_m.sfaa020 
              END IF
           ELSE
              IF NOT cl_null(g_sfaa_m.sfaa019) THEN
                 CALL s_asft300_06('1',g_sfaa_m.sfaa010,g_sfaa_m.sfaa012,g_sfaa_m.sfaa019) RETURNING l_success,g_sfaa_m.sfaa020
              END IF
           END IF
        END IF
        LET g_sfaa_m_t.sfaa006 = g_sfaa_m.sfaa006
        LET g_sfaa_m_t.sfaa007 = g_sfaa_m.sfaa007
        LET g_sfaa_m_t.sfaa008 = g_sfaa_m.sfaa008
        LET g_sfaa_m_t.sfaa063 = g_sfaa_m.sfaa063
        LET g_sfaa_m_t.sfaa010 = g_sfaa_m.sfaa010
        LET g_sfaa_m_t.sfaa011 = g_sfaa_m.sfaa011
        LET g_sfaa_m_t.sfaa012 = g_sfaa_m.sfaa012
        LET g_sfaa_m_t.sfaa013 = g_sfaa_m.sfaa013
        LET g_sfaa_m_t.sfaa019 = g_sfaa_m.sfaa019
        LET g_sfaa_m_t.sfaa020 = g_sfaa_m.sfaa020
        LET g_sfaa_m_t.l_sfaa007=g_sfaa_m.l_sfaa007
     END IF
  END IF
  #dorislai-20150709-add----(E)
  #add--151207-00017#2 By shiun--(S)
  IF g_sfaa_m.sfaa005 = '7' THEN
     IF NOT cl_null(g_sfaa_m.sfaa006) AND NOT cl_null(g_sfaa_m.sfaa007) THEN
        #161109-00085#27-s
        #SELECT psad_t.* INTO l_psad.* FROM psac_t,psad_t
        #161109-00085#66 --s mark
        #SELECT psadent,psadsite,psaddocno,psadseq,psad001,psad002,psad003,psad004,psad005,psad006,
        #       psad007,psad008,psad009,psad010
        #  INTO l_psad.psadent,l_psad.psadsite,l_psad.psaddocno,l_psad.psadseq,l_psad.psad001,
        #       l_psad.psad002,l_psad.psad003,l_psad.psad004,l_psad.psad005,l_psad.psad006,
        #       l_psad.psad007,l_psad.psad008,l_psad.psad009,l_psad.psad010
        #  FROM psac_t,psad_t 
        #161109-00085#66 --e mark
        #161109-00085#66 --s add
        SELECT psadent,psadsite,psaddocno,psadseq,psad001,
               psad002,psad003,psad004,psad005,psad006,
               psad007,psad008,psad009,psadud001,psadud002,
               psadud003,psadud004,psadud005,psadud006,psadud007,
               psadud008,psadud009,psadud010,psadud011,psadud012,
               psadud013,psadud014,psadud015,psadud016,psadud017,
               psadud018,psadud019,psadud020,psadud021,psadud022,
               psadud023,psadud024,psadud025,psadud026,psadud027,
               psadud028,psadud029,psadud030,psad010
          INTO l_psad.psadent,l_psad.psadsite,l_psad.psaddocno,l_psad.psadseq,l_psad.psad001,
               l_psad.psad002,l_psad.psad003,l_psad.psad004,l_psad.psad005,l_psad.psad006,
               l_psad.psad007,l_psad.psad008,l_psad.psad009,l_psad.psadud001,l_psad.psadud002,
               l_psad.psadud003,l_psad.psadud004,l_psad.psadud005,l_psad.psadud006,l_psad.psadud007,
               l_psad.psadud008,l_psad.psadud009,l_psad.psadud010,l_psad.psadud011,l_psad.psadud012,
               l_psad.psadud013,l_psad.psadud014,l_psad.psadud015,l_psad.psadud016,l_psad.psadud017,
               l_psad.psadud018,l_psad.psadud019,l_psad.psadud020,l_psad.psadud021,l_psad.psadud022,
               l_psad.psadud023,l_psad.psadud024,l_psad.psadud025,l_psad.psadud026,l_psad.psadud027,
               l_psad.psadud028,l_psad.psadud029,l_psad.psadud030,l_psad.psad010
          FROM psac_t,psad_t 
        #161109-00085#66 --e add        
        #161109-00085#27-e 
         WHERE psacent=psadent AND psacdocno=psaddocno
           AND psadent=g_enterprise AND psadsite=g_site
           AND psaddocno=g_sfaa_m.sfaa006 AND psadseq=g_sfaa_m.sfaa007 AND psad008 = 'N'
                 
        LET g_sfaa_m.sfaa010=l_psad.psad001
        #160921-00022#1-s-mod
        ##抓取特性
        #SELECT imae037 INTO g_sfaa_m.sfaa011 FROM imae_t WHERE imaeent=g_enterprise AND imaesite=g_site AND imae001=g_sfaa_m.sfaa010
        #抓取特性、成本中心、發料機制
        SELECT imae037,imae035,(CASE imae014 WHEN '0' THEN '1' WHEN '1' THEN '2' END ) 
          INTO g_sfaa_m.sfaa011,g_sfaa_m.sfaa068,g_sfaa_m.sfaa004 
          FROM imae_t WHERE imaeent=g_enterprise AND imaesite=g_site AND imae001=g_sfaa_m.sfaa010
        #160921-00022#1-e-mod
        IF cl_null(g_sfaa_m.sfaa011) THEN
           LET g_sfaa_m.sfaa011 = ' '
        END IF
        #MPS對應的料號chk
        IF NOT asft300_sfaa010_chk() THEN
           LET g_sfaa_m.sfaa006 = g_sfaa_m_t.sfaa006  #單號
           LET g_sfaa_m.l_sfaa007 = ''                #項次
           LET g_sfaa_m.sfaa010 = ''                  #生產料號
           LET g_sfaa_m.sfaa010_desc = ''             #清空品名
           LET g_sfaa_m.sfaa010_desc1 = ''            #清空規格
           LET g_sfaa_m.sfaa011 = ''                  #特性
     
           RETURN FALSE
        END IF
        
        LET g_sfaa_m.sfaa012=l_psad.psad005 #計劃產量
        LET g_sfaa_m.sfaa013=l_psad.psad004 #單位 
        LET g_sfaa_m.sfaa020=l_psad.psad003 #160808-00029#1 add #預計完工日應該要抓apst310上的完工日 
        
        #已开工单量计算
        #modify--151207-00017#2 By shiun--(S)
#        CALL asft300_sfaa006_chk_qty(g_sfaa_m.sfaa006,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa013) RETURNING l_sum            
#        LET g_sfaa_m.sfaa012 = g_sfaa_m.sfaa012 - l_sum
        LET l_qty = l_psad.psad006 
        CALL s_aooi250_convert_qty(g_sfaa_m.sfaa010,l_psad.psad004,g_sfaa_m.sfaa013,l_qty)
             RETURNING l_success,l_qty 
        LET g_sfaa_m.sfaa012 = g_sfaa_m.sfaa012 - l_qty
        #modify--151207-00017#2 By shiun--(E)
        IF g_sfaa_m.sfaa012 <= 0 THEN
           INITIALIZE g_errparam TO NULL
           LET g_errparam.code = 'asf-00718'
           LET g_errparam.extend = ''
           LET g_errparam.popup = TRUE
           CALL cl_err()

           IF p_cmd = 'a' THEN
              LET g_sfaa_m.sfaa010 = g_sfaa_m_t.sfaa010
              LET g_sfaa_m.sfaa011 = g_sfaa_m_t.sfaa011
              LET g_sfaa_m.sfaa012 = g_sfaa_m_t.sfaa012
              LET g_sfaa_m.sfaa013 = g_sfaa_m_t.sfaa013
           END IF
           RETURN FALSE
        END IF

         
        IF NOT cl_null(g_sfaa_m.sfaa010) AND NOT cl_null(g_sfaa_m.sfaa012) THEN
           IF NOT cl_null(g_sfaa_m.sfaa020) THEN
              CALL s_asft300_06('2',g_sfaa_m.sfaa010,g_sfaa_m.sfaa012,g_sfaa_m.sfaa020) RETURNING l_success,g_sfaa_m.sfaa019
              IF g_sfaa_m.sfaa019 < g_sfaa_m.sfaadocdt THEN
                 LET l_days = g_sfaa_m.sfaadocdt - g_sfaa_m.sfaa019
                 LET g_sfaa_m.sfaa019 = g_sfaa_m.sfaadocdt        
                 #根据当前营运据点g_site抓取aooi120中设置的行事历参照表号
                 CALL s_date_get_work_date(g_site,g_ooef008,'2',g_sfaa_m.sfaa020,0,l_days) RETURNING g_sfaa_m.sfaa020 
              END IF
           ELSE
              IF NOT cl_null(g_sfaa_m.sfaa019) THEN
                 CALL s_asft300_06('1',g_sfaa_m.sfaa010,g_sfaa_m.sfaa012,g_sfaa_m.sfaa019) RETURNING l_success,g_sfaa_m.sfaa020
              END IF
           END IF
        END IF
        LET g_sfaa_m_t.sfaa006 = g_sfaa_m.sfaa006
        LET g_sfaa_m_t.sfaa007 = g_sfaa_m.sfaa007
        LET g_sfaa_m_t.sfaa008 = g_sfaa_m.sfaa008
        LET g_sfaa_m_t.sfaa063 = g_sfaa_m.sfaa063
        LET g_sfaa_m_t.sfaa010 = g_sfaa_m.sfaa010
        LET g_sfaa_m_t.sfaa011 = g_sfaa_m.sfaa011
        LET g_sfaa_m_t.sfaa012 = g_sfaa_m.sfaa012
        LET g_sfaa_m_t.sfaa013 = g_sfaa_m.sfaa013
        LET g_sfaa_m_t.sfaa019 = g_sfaa_m.sfaa019
        LET g_sfaa_m_t.sfaa020 = g_sfaa_m.sfaa020
        LET g_sfaa_m_t.l_sfaa007=g_sfaa_m.l_sfaa007
     END IF
  END IF
  #add--151207-00017#2 By shiun--(E)
  IF g_sfaa_m.sfaa061 = 'Y' THEN
     SELECT imae033 INTO g_sfaa_m.sfaa016 FROM imae_t
      WHERE imaeent = g_enterprise AND imaesite = g_site AND imae001 = g_sfaa_m.sfaa010
     SELECT imae032 INTO l_imae032 FROM imae_t WHERE imaeent=g_enterprise AND imaesite=g_site AND imae001=g_sfaa_m.sfaa010
     IF cl_null(l_imae032) THEN
        LET l_imae032 = g_sfaa_m.sfaa010
     END IF
  END IF
  
  
  DISPLAY BY NAME g_sfaa_m.sfaa009,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa012,g_sfaa_m.sfaa013,g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa016,g_sfaa_m.sfaa019,g_sfaa_m.sfaa020
  INITIALIZE g_ref_fields TO NULL
  LET g_ref_fields[1] = g_sfaa_m.sfaa010
  CALL ap_ref_array2(g_ref_fields,"SELECT imaal003 FROM imaal_t WHERE imaalent='"||g_enterprise||"' AND imaal001=? AND imaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
  LET g_sfaa_m.sfaa010_desc = '', g_rtn_fields[1] , ''
  DISPLAY BY NAME g_sfaa_m.sfaa010_desc
  
  INITIALIZE g_ref_fields TO NULL
  LET g_ref_fields[1] = g_sfaa_m.sfaa010
  CALL ap_ref_array2(g_ref_fields,"SELECT imaal004 FROM imaal_t WHERE imaalent='"||g_enterprise||"' AND imaal001=? AND imaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
  LET g_sfaa_m.sfaa010_desc1 = '', g_rtn_fields[1] , ''
  DISPLAY BY NAME g_sfaa_m.sfaa010_desc1
  
  #170103-00023#1-s-add
  SELECT imaf034 INTO g_sfaa_m.sfaa072
    FROM imaf_t
   WHERE imafent = g_enterprise
     AND imafsite = g_site
     AND imaf001 = g_sfaa_m.sfaa010     
  
  IF cl_null(g_sfaa_m.sfaa072) THEN
     LET g_sfaa_m.sfaa072 = 'N'
  END IF
  LET g_sfaa_m_t.sfaa072 = g_sfaa_m.sfaa072
  #170103-00023#1-e-add
  
  IF NOT cl_null(g_sfaa_m.sfaa009) THEN
     INITIALIZE g_ref_fields TO NULL
     LET g_ref_fields[1] = g_sfaa_m.sfaa009
     CALL ap_ref_array2(g_ref_fields,"SELECT pmaal004 FROM pmaal_t WHERE pmaalent='"||g_enterprise||"' AND pmaal001=? AND pmaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
     LET g_sfaa_m.sfaa009_desc = '', g_rtn_fields[1] , ''
  ELSE
     LET g_sfaa_m.sfaa009_desc = ''
  END IF
  DISPLAY BY NAME g_sfaa_m.sfaa009_desc 
  
  IF NOT cl_null(l_imae032) AND NOT cl_null(g_sfaa_m.sfaa016) THEN
     INITIALIZE g_ref_fields TO NULL
     LET g_ref_fields[1] = l_imae032
     LET g_ref_fields[2] = g_sfaa_m.sfaa016
     CALL ap_ref_array2(g_ref_fields,"SELECT ecba003 FROM ecba_t WHERE ecbaent='"||g_enterprise||"' AND ecba001=? AND ecba002=? ","") RETURNING g_rtn_fields
     LET g_sfaa_m.sfaa016_desc = '', g_rtn_fields[1] , ''
  ELSE
     LET g_sfaa_m.sfaa016_desc = ''
  END IF
  END IF
  #160921-00022#1-s-add
  #取成本中心說明
  LET g_sfaa_m.sfaa068_desc = s_desc_get_department_desc(g_sfaa_m.sfaa068)
  DISPLAY BY NAME g_sfaa_m.sfaa068,g_sfaa_m.sfaa004,g_sfaa_m.sfaa068_desc
  #160921-00022#1-e-add
  DISPLAY BY NAME g_sfaa_m.sfaa016_desc  
#170221-00039----add---str
   SELECT xmdc036 INTO g_sfaa_m.sfaa028   
     FROM xmdc_t 
    WHERE xmdcent   = g_enterprise  
      AND xmdcdocno = g_sfaa_m.sfaa006 
      AND xmdcseq   = g_sfaa_m.sfaa007 
   DISPLAY BY NAME g_sfaa_m.sfaa028     
#170221-00039----add---end  
  RETURN TRUE
  
END FUNCTION
#工单来源检查
PRIVATE FUNCTION asft300_sfab002_chk()
DEFINE l_sql         STRING
DEFINE l_n           LIKE type_t.num5
#161219-00070#2-add-s
DEFINE l_sql2      STRING
DEFINE l_count      LIKE type_t.num5
DEFINE l_xmdadocno  LIKE xmda_t.xmdadocno
DEFINE l_xmda005    LIKE xmda_t.xmda005
DEFINE l_xmda007    LIKE xmda_t.xmda007
DEFINE l_xmda008    LIKE xmda_t.xmda008
#161219-00070#2-add-e


  #當等於訂單、計畫等，檢查是否存在來源資料裡
  IF NOT cl_null(g_sfab_d[l_ac].sfab002) THEN
  
     #150909 earl add s
     IF NOT s_aooi210_check_doc(g_site,'',g_sfab_d[l_ac].sfab002,g_sfaa_m.sfaadocno,'4','') THEN
        RETURN FALSE
     END IF
     #150909 earl add e
  
     #订单
     IF g_sfab_d[l_ac].sfab001 = '2' THEN
        LET l_sql = "SELECT COUNT(1) FROM xmda_t,xmdd_t WHERE xmdaent=xmddent AND xmdadocno=xmdddocno ",
                    "   AND xmddent='",g_enterprise,"' AND xmddsite='",g_site,"'",
                    "   AND xmdddocno='",g_sfab_d[l_ac].sfab002,"' AND xmdd001='",g_sfaa_m.sfaa010,"'",
                    #161128-00045-s-mod
#                    "   AND xmdastus = 'Y'"
                    "   AND xmdastus IN ('Y','H') "
                    #161128-00045-e-mod
        IF NOT cl_null(g_sfab_d[l_ac].sfab003) THEN
           LET l_sql = l_sql," AND xmddseq=", g_sfab_d[l_ac].sfab003
        END IF
        IF NOT cl_null(g_sfab_d[l_ac].sfab004) THEN
           LET l_sql = l_sql," AND xmddseq1=", g_sfab_d[l_ac].sfab004
        END IF
        IF NOT cl_null(g_sfab_d[l_ac].sfab005) THEN
           LET l_sql = l_sql," AND xmddseq2=", g_sfab_d[l_ac].sfab005
        END IF  
        #160214-00005#3-add-(S)
        IF cl_null(g_sfaa011) THEN
           LET l_sql = l_sql CLIPPED," AND xmdd040 = ' '"
        ELSE
           LET l_sql = l_sql CLIPPED," AND xmdd040 = '",g_sfaa011,"'"
        END IF
        #160214-00005#3-add-(E)
        PREPARE asft300_sfab002_pre1 FROM l_sql
        EXECUTE asft300_sfab002_pre1 INTO l_n
     END IF 
     #dorislai-20150711-add----(S)
     #獨立需求單
     IF g_sfab_d[l_ac].sfab001 = '6' THEN
        LET l_n = 0
        LET l_sql = "SELECT COUNT(1) FROM psaa_t,psab_t WHERE psaaent=psabent AND psaadocno=psabdocno ",
                    "   AND psabent='",g_enterprise,"' AND psabsite='",g_site,"'",
                    "   AND psabdocno='",g_sfab_d[l_ac].sfab002,"' AND psab001='",g_sfaa_m.sfaa010,"'",
                    "   AND psaastus = 'Y'"
        
        IF NOT cl_null(g_sfab_d[l_ac].sfab003) THEN
           LET l_sql = l_sql," AND psabseq=", g_sfab_d[l_ac].sfab003
        END IF
        #160214-00005#3-add-(S)
        IF cl_null(g_sfaa011) THEN
           LET l_sql = l_sql CLIPPED," AND psab012 = ' '"
        ELSE
           LET l_sql = l_sql CLIPPED," AND psab012 = '",g_sfaa011,"'"
        END IF
        #160214-00005#3-add-(E)
        
        PREPARE asft300_sfab002_pre1_1 FROM l_sql
        EXECUTE asft300_sfab002_pre1_1 INTO l_n
     END IF
     #160214-00005#3-mark-(S) 
     #會導致更新錯誤
#     IF l_n > 0 THEN
#        LET g_sfab_d_t.sfab002 = g_sfab_d[l_ac].sfab002  #單號
#        LET g_sfab_d_t.sfab003 = g_sfab_d[l_ac].sfab003  #項次
#     END IF
     #160214-00005#3-mark-(E) 
     #dorislai-20150711-add----(E)
     #计划     
     IF g_sfaa_m.sfaa005 = '3' THEN
     END IF
     IF l_n = 0 THEN
        #dorislai-20150713-mark-(S)-此段跳出錯誤訊息，放至各判斷式中
        #移位子原因：因要在before field sfab002先判斷單號是否相符        
#        INITIALIZE g_errparam TO NULL
#        LET g_errparam.code = 'asf-00154'
#        LET g_errparam.extend = g_sfab_d[l_ac].sfab002
#        LET g_errparam.popup = TRUE
#        CALL cl_err()
        #dorislai-20150713-mark-(E)
        #160214-00005#3-mark-(S) 
#        LET g_sfab_d[l_ac].sfab002 = g_sfab_d_t.sfab002   #單號-20150714 by dorislai
#        LET g_sfab_d[l_ac].sfab003 = g_sfab_d_t.sfab003   #項次-20150714 by dorislai
        #160214-00005#3-mark-(E) 
        RETURN FALSE
     END IF
     
     #161219-00070#2-add-s
     IF g_sfab_d[l_ac].sfab001 = '2' THEN        
        SELECT xmda005,xmda007,xmda008 INTO l_xmda005,l_xmda007,l_xmda008
          FROM xmda_t
         WHERE xmdaent = g_enterprise
           AND xmdadocno = g_sfab_d[l_ac].sfab002
        
        LET l_sql2 = " SELECT xmdadocno ",
                     "   FROM xmda_t ",
                     "  WHERE xmdaent = ",g_enterprise,
                    #161128-00045-s-mod
#                     "    AND xmdastus = 'Y' ",
                     "    AND xmdastus IN ('Y','H') ",
                     #161128-00045-e-mod
                     "    AND xmda007 = '2' ",
                     "    AND xmda008 = ? "
        PREPARE asft300_chk_xmda_p2 FROM l_sql2
        DECLARE asft300_chk_xmda_c2 CURSOR FOR asft300_chk_xmda_p2
        
        LET l_sql2 = " SELECT COUNT(1) ",
                     "   FROM sfaa_t ",
                     "  WHERE sfaaent = ",g_enterprise,
                     "    AND sfaastus <> 'X' ",   #161222-00007#1
                     "    AND sfaa005 = '2' ",
                     "    AND sfaa006 = ? "
        PREPARE asft300_chk_sfaa_p2 FROM l_sql2
        LET l_sql2 = " SELECT COUNT(1) ",
                     "   FROM sfaa_t,sfab_t ",
                     "  WHERE sfaaent = sfabent ",
                     "    AND sfaadocno = sfabdocno ",
                     "    AND sfaastus <> 'X' ",   #161222-00007#1
                     "    AND sfabent = ",g_enterprise,                     
                     "    AND sfab001 = '2' ",
                     "    AND sfab002 = ? "
        PREPARE asft300_chk_sfab_p2 FROM l_sql2
        IF l_xmda005 = '5' THEN   #若訂單性質為預先訂單，需檢查該預先訂單對應的訂單是否有轉工單
           LET l_xmdadocno = ''           
           FOREACH asft300_chk_xmda_c2 USING g_sfab_d[l_ac].sfab002 INTO l_xmdadocno
              LET l_count = 0
              EXECUTE asft300_chk_sfaa_p2 USING l_xmdadocno INTO l_count
              IF l_count = 0 THEN
                 EXECUTE asft300_chk_sfab_p2 USING l_xmdadocno INTO l_count                 
              END IF
              IF l_count > 0 THEN
                 INITIALIZE g_errparam TO NULL
                 LET g_errparam.code = 'asf-00824'   #輸入的預先訂單單號在工單上存在其訂單資料！
                 LET g_errparam.extend = g_sfab_d[l_ac].sfab002
                 LET g_errparam.popup = TRUE
                 CALL cl_err()
                 RETURN FALSE
              END IF
           END FOREACH
        ELSE
           IF l_xmda007 = '2' THEN
              LET l_count = 0
              EXECUTE asft300_chk_sfaa_p2 USING l_xmda008 INTO l_count
              IF l_count = 0 THEN
                 EXECUTE asft300_chk_sfab_p2 USING l_xmda008 INTO l_count                 
              END IF
              IF l_count > 0 THEN
                 INITIALIZE g_errparam TO NULL
                 LET g_errparam.code = 'asf-00823'   #輸入的訂單單號在工單上存在其預先訂單資料！
                 LET g_errparam.extend = g_sfab_d[l_ac].sfab002
                 LET g_errparam.popup = TRUE
                 CALL cl_err()
                 RETURN FALSE
              END IF
           END IF
        END IF        
     END IF
     #161219-00070#2-add-e

  ELSE
     RETURN FALSE
  END IF
  
  CALL asft300_show_sfab_desc(l_ac)
  RETURN TRUE
  
END FUNCTION

#BOM版本检查及带值
PRIVATE FUNCTION asft300_chk_sfaa014()
DEFINE r_success         LIKE type_t.num5
DEFINE l_n               LIKE type_t.num5
DEFINE l_bmfa005         DATETIME YEAR TO SECOND

   LET r_success = FALSE
   IF cl_null(g_sfaa_m.sfaa014) THEN
      LET r_success = TRUE
      RETURN r_success
   END IF
   #170213-00064#1-----add----s
   IF cl_null(g_sfaa_m.sfaa011) THEN
      LET g_sfaa_m.sfaa011 = ' '
   END IF
   #170213-00064#1-----add----e
   #BOM版本檢查是否有存在bmfa012或bmfp007
   SELECT COUNT(1) INTO l_n FROM bmfa_t WHERE bmfaent=g_enterprise AND (bmfasite='ALL' OR bmfasite=g_site)
      AND bmfa003=g_sfaa_m.sfaa010 AND bmfa004=g_sfaa_m.sfaa011 AND bmfa012=g_sfaa_m.sfaa014
   IF l_n = 0 THEN
      SELECT COUNT(1) INTO l_n FROM bmfp_t WHERE bmfpent=g_enterprise AND (bmfpsite='ALL' OR bmfpsite=g_site)
         AND bmfp002=g_sfaa_m.sfaa010 AND bmfp003=g_sfaa_m.sfaa011 AND bmfp007=g_sfaa_m.sfaa014
      IF l_n = 0 THEN
      
         #170215-00015#1---add--end
         SELECT COUNT(*) INTO l_n FROM bmfa_t WHERE bmfaent=g_enterprise AND (bmfasite='ALL' OR bmfasite=g_site)
         AND bmfa003=g_sfaa_m.sfaa010 AND bmfa004=g_sfaa_m.sfaa011 AND bmfa011=g_sfaa_m.sfaa014
         IF l_n = 0 THEN
         #170215-00015#1---add-----end
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'asf-00323'
            LET g_errparam.extend = g_sfaa_m.sfaa014
            LET g_errparam.popup = TRUE
            CALL cl_err()
   
            RETURN r_success
         #170215-00015#1---add--str
          ELSE
           #SELECT MAX(bmfa005)-(1/24/3600) INTO l_bmfa005 FROM bmfa_t WHERE bmfaent=g_enterprise AND (bmfasite='ALL' OR bmfasite=g_site)  #170317-00049#2 mark
            SELECT MAX(bmfa005)-(1/24/3600) INTO l_bmfa005 FROM bmfa_t WHERE bmfaent=g_enterprise AND bmfasite=g_site                      #170317-00049#2 add
            AND bmfa003=g_sfaa_m.sfaa010 AND bmfa004=g_sfaa_m.sfaa011 AND bmfa011=g_sfaa_m.sfaa014
            #170317-00049#2 add --(S)--
            IF cl_null(l_bmfa005) THEN
               SELECT MAX(bmfa005)-(1/24/3600) INTO l_bmfa005 FROM bmfa_t WHERE bmfaent=g_enterprise AND bmfasite='ALL'                      
                  AND bmfa003=g_sfaa_m.sfaa010 AND bmfa004=g_sfaa_m.sfaa011 AND bmfa011=g_sfaa_m.sfaa014
            END IF            
            #170317-00049#2 add --(E)--
          END IF
          #170215-00015#1---add-----end 
      ELSE
         SELECT MAX(bmfa005) INTO l_bmfa005 FROM bmfa_t,bmfp_t WHERE bmfaent=bmfpent AND bmfasite=bmfpsite
            AND bmfadocno=bmfpdocno AND bmfa003=bmfp002 AND bmfa004=bmfp003 
           #AND bmfaent=g_enterprise AND (bmfasite='ALL' OR bmfasite=g_site)                                              #170317-00049#2 mark
            AND bmfaent=g_enterprise AND bmfasite=g_site                                                                  #170317-00049#2 add
            AND bmfa003=g_sfaa_m.sfaa010 AND bmfa004=g_sfaa_m.sfaa011 AND bmfp007=g_sfaa_m.sfaa014
         #170317-00049#2 add --(S)--
         IF cl_null(l_bmfa005) THEN
            SELECT MAX(bmfa005) INTO l_bmfa005 FROM bmfa_t,bmfp_t WHERE bmfaent=bmfpent AND bmfasite=bmfpsite
            AND bmfadocno=bmfpdocno AND bmfa003=bmfp002 AND bmfa004=bmfp003 
            AND bmfaent=g_enterprise AND bmfasite='ALL'                                                                 
            AND bmfa003=g_sfaa_m.sfaa010 AND bmfa004=g_sfaa_m.sfaa011 AND bmfp007=g_sfaa_m.sfaa014 
         END IF
         #170317-00049#2 add --(E)--            
      END IF
   ELSE
      #BOM版本应先抓据点ECN，抓不到再抓集团ECN
     #SELECT MAX(bmfa005) INTO l_bmfa005 FROM bmfa_t WHERE bmfaent=g_enterprise AND (bmfasite='ALL' OR bmfasite=g_site)   #170317-00049#2 mark
      SELECT MAX(bmfa005) INTO l_bmfa005 FROM bmfa_t WHERE bmfaent=g_enterprise AND bmfasite=g_site                       #170317-00049#2 add 
         AND bmfa003=g_sfaa_m.sfaa010 AND bmfa004=g_sfaa_m.sfaa011 AND bmfa012=g_sfaa_m.sfaa014
      #170317-00049#2 add --(S)--
      IF cl_null(l_bmfa005) THEN
         SELECT MAX(bmfa005) INTO l_bmfa005 FROM bmfa_t WHERE bmfaent=g_enterprise AND bmfasite='ALL'                       
            AND bmfa003=g_sfaa_m.sfaa010 AND bmfa004=g_sfaa_m.sfaa011 AND bmfa012=g_sfaa_m.sfaa014
      END IF      
      #170317-00049#2 add --(E)--      
   END IF
   LET g_sfaa_m.sfaa015 = l_bmfa005 
   DISPLAY BY NAME g_sfaa_m.sfaa015
   LET r_success = TRUE
   RETURN r_success
END FUNCTION

#工单来源页签ref栏位显示
PRIVATE FUNCTION asft300_show_sfab_desc(p_ac)
DEFINE p_ac              LIKE type_t.num5
DEFINE l_sfaa013         LIKE sfaa_t.sfaa013
DEFINE l_sfab007         LIKE sfab_t.sfab007
DEFINE l_sql             STRING
#161109-00085#27-s
#DEFINE l_xmdd        RECORD LIKE xmdd_t.*
DEFINE l_xmdd RECORD  #訂單交期明細檔
       xmddent LIKE xmdd_t.xmddent, #企業編號
       xmddsite LIKE xmdd_t.xmddsite, #營運據點
       xmdddocno LIKE xmdd_t.xmdddocno, #訂單單號
       xmddseq LIKE xmdd_t.xmddseq, #項次
       xmddseq1 LIKE xmdd_t.xmddseq1, #項序
       xmddseq2 LIKE xmdd_t.xmddseq2, #分批序
       xmdd001 LIKE xmdd_t.xmdd001, #料件編號
       xmdd002 LIKE xmdd_t.xmdd002, #產品特徵
       xmdd003 LIKE xmdd_t.xmdd003, #子件特性
       xmdd004 LIKE xmdd_t.xmdd004, #銷售單位
       xmdd005 LIKE xmdd_t.xmdd005, #訂購總數量
       xmdd006 LIKE xmdd_t.xmdd006, #分批訂購數量
       xmdd007 LIKE xmdd_t.xmdd007, #摺合主件數量
       xmdd008 LIKE xmdd_t.xmdd008, #QPA
       xmdd009 LIKE xmdd_t.xmdd009, #交期類型
       xmdd010 LIKE xmdd_t.xmdd010, #出貨時段
       xmdd011 LIKE xmdd_t.xmdd011, #約定交貨日期
       xmdd012 LIKE xmdd_t.xmdd012, #預計簽收日期
       xmdd013 LIKE xmdd_t.xmdd013, #MRP交期凍結
       xmdd014 LIKE xmdd_t.xmdd014, #已出貨量
       xmdd015 LIKE xmdd_t.xmdd015, #已銷退量
       xmdd016 LIKE xmdd_t.xmdd016, #銷退換貨數量
       xmdd017 LIKE xmdd_t.xmdd017, #出貨狀態
       xmdd018 LIKE xmdd_t.xmdd018, #參考價格
       xmdd019 LIKE xmdd_t.xmdd019, #稅別
       xmdd020 LIKE xmdd_t.xmdd020, #稅率
       xmdd021 LIKE xmdd_t.xmdd021, #電子訂購單號
       xmdd022 LIKE xmdd_t.xmdd022, #最近修改人員
       xmdd023 LIKE xmdd_t.xmdd023, #最近修改時間
       xmdd024 LIKE xmdd_t.xmdd024, #分批參考單位
       xmdd025 LIKE xmdd_t.xmdd025, #分批參考數量
       xmdd026 LIKE xmdd_t.xmdd026, #分批計價單位
       xmdd027 LIKE xmdd_t.xmdd027, #分批計價數量
       xmdd028 LIKE xmdd_t.xmdd028, #分批未稅金額
       xmdd029 LIKE xmdd_t.xmdd029, #分批含稅金額
       xmdd030 LIKE xmdd_t.xmdd030, #分批稅額
       xmdd031 LIKE xmdd_t.xmdd031, #已轉出通數量
       xmdd032 LIKE xmdd_t.xmdd032, #備置量
       xmdd033 LIKE xmdd_t.xmdd033, #備置原因
       xmdd034 LIKE xmdd_t.xmdd034, #已簽退量
       xmdd035 LIKE xmdd_t.xmdd035, #已分配量
       xmdd200 LIKE xmdd_t.xmdd200, #促銷方案
       xmdd201 LIKE xmdd_t.xmdd201, #分批包裝單位
       xmdd202 LIKE xmdd_t.xmdd202, #分批包裝數量
       xmdd203 LIKE xmdd_t.xmdd203, #標準價
       xmdd204 LIKE xmdd_t.xmdd204, #促銷價
       xmdd205 LIKE xmdd_t.xmdd205, #交易價
       xmdd206 LIKE xmdd_t.xmdd206, #折價金額
       xmddunit LIKE xmdd_t.xmddunit, #應用組織
       xmdd207 LIKE xmdd_t.xmdd207, #收貨網點
       xmdd208 LIKE xmdd_t.xmdd208, #送貨地址碼
       xmdd209 LIKE xmdd_t.xmdd209, #送貨站點
       xmdd210 LIKE xmdd_t.xmdd210, #送貨時段
       xmdd211 LIKE xmdd_t.xmdd211, #送貨客戶
       xmdd212 LIKE xmdd_t.xmdd212, #MRP凍結
       xmdd213 LIKE xmdd_t.xmdd213, #庫位/庫區
       xmdd214 LIKE xmdd_t.xmdd214, #儲位
       xmdd215 LIKE xmdd_t.xmdd215, #批號
       xmdd216 LIKE xmdd_t.xmdd216, #庫存鎖定等級
       xmdd217 LIKE xmdd_t.xmdd217, #庫存餘額
       xmdd218 LIKE xmdd_t.xmdd218, #銷售渠道
       xmdd219 LIKE xmdd_t.xmdd219, #產品組編號
       xmdd220 LIKE xmdd_t.xmdd220, #銷售範圍編號
       xmdd221 LIKE xmdd_t.xmdd221, #備註
       xmdd222 LIKE xmdd_t.xmdd222, #辦事處
       xmdd223 LIKE xmdd_t.xmdd223, #業務人員
       xmdd224 LIKE xmdd_t.xmdd224, #業務部門
       xmdd225 LIKE xmdd_t.xmdd225, #主合約編號
       xmdd226 LIKE xmdd_t.xmdd226, #經營方式
       xmdd227 LIKE xmdd_t.xmdd227, #結算類型
       xmdd228 LIKE xmdd_t.xmdd228, #結算方式
       xmddorga LIKE xmdd_t.xmddorga, #帳務組織
       xmdd229 LIKE xmdd_t.xmdd229, #交易類型
       xmdd230 LIKE xmdd_t.xmdd230, #分批包裝銷退換貨數量
       #161109-00085#66 --s add
       xmddud001 LIKE xmdd_t.xmddud001, #自定義欄位(文字)001
       xmddud002 LIKE xmdd_t.xmddud002, #自定義欄位(文字)002
       xmddud003 LIKE xmdd_t.xmddud003, #自定義欄位(文字)003
       xmddud004 LIKE xmdd_t.xmddud004, #自定義欄位(文字)004
       xmddud005 LIKE xmdd_t.xmddud005, #自定義欄位(文字)005
       xmddud006 LIKE xmdd_t.xmddud006, #自定義欄位(文字)006
       xmddud007 LIKE xmdd_t.xmddud007, #自定義欄位(文字)007
       xmddud008 LIKE xmdd_t.xmddud008, #自定義欄位(文字)008
       xmddud009 LIKE xmdd_t.xmddud009, #自定義欄位(文字)009
       xmddud010 LIKE xmdd_t.xmddud010, #自定義欄位(文字)010
       xmddud011 LIKE xmdd_t.xmddud011, #自定義欄位(數字)011
       xmddud012 LIKE xmdd_t.xmddud012, #自定義欄位(數字)012
       xmddud013 LIKE xmdd_t.xmddud013, #自定義欄位(數字)013
       xmddud014 LIKE xmdd_t.xmddud014, #自定義欄位(數字)014
       xmddud015 LIKE xmdd_t.xmddud015, #自定義欄位(數字)015
       xmddud016 LIKE xmdd_t.xmddud016, #自定義欄位(數字)016
       xmddud017 LIKE xmdd_t.xmddud017, #自定義欄位(數字)017
       xmddud018 LIKE xmdd_t.xmddud018, #自定義欄位(數字)018
       xmddud019 LIKE xmdd_t.xmddud019, #自定義欄位(數字)019
       xmddud020 LIKE xmdd_t.xmddud020, #自定義欄位(數字)020
       xmddud021 LIKE xmdd_t.xmddud021, #自定義欄位(日期時間)021
       xmddud022 LIKE xmdd_t.xmddud022, #自定義欄位(日期時間)022
       xmddud023 LIKE xmdd_t.xmddud023, #自定義欄位(日期時間)023
       xmddud024 LIKE xmdd_t.xmddud024, #自定義欄位(日期時間)024
       xmddud025 LIKE xmdd_t.xmddud025, #自定義欄位(日期時間)025
       xmddud026 LIKE xmdd_t.xmddud026, #自定義欄位(日期時間)026
       xmddud027 LIKE xmdd_t.xmddud027, #自定義欄位(日期時間)027
       xmddud028 LIKE xmdd_t.xmddud028, #自定義欄位(日期時間)028
       xmddud029 LIKE xmdd_t.xmddud029, #自定義欄位(日期時間)029
       xmddud030 LIKE xmdd_t.xmddud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       xmdd036 LIKE xmdd_t.xmdd036, #還量數量
       xmdd037 LIKE xmdd_t.xmdd037, #還量參考數量
       xmdd038 LIKE xmdd_t.xmdd038, #還價數量
       xmdd039 LIKE xmdd_t.xmdd039, #還價參考數量
       xmdd231 LIKE xmdd_t.xmdd231, #庫存管理特徵
       xmdd040 LIKE xmdd_t.xmdd040  #BOM特性
END RECORD
#161109-00085#27-e
DEFINE l_success         LIKE type_t.num5
DEFINE l_rate            LIKE inaj_t.inaj014
DEFINE l_imae016         LIKE imae_t.imae016
DEFINE l_psaa002           LIKE psaa_t.psaa002   #dorislai-20150711-add----(S)
DEFINE l_psaa001           LIKE psaa_t.psaa001
#161109-00085#27-s
#DEFINE l_psab        RECORD LIKE psab_t.*   #20150709 by dorislai
DEFINE l_psab RECORD  #獨立需求單身檔
       psabent LIKE psab_t.psabent, #企業編號
       psabsite LIKE psab_t.psabsite, #營運據點
       psabdocno LIKE psab_t.psabdocno, #需求單號
       psabseq LIKE psab_t.psabseq, #項次
       psab001 LIKE psab_t.psab001, #料件編號
       psab002 LIKE psab_t.psab002, #產品特徵
       psab003 LIKE psab_t.psab003, #需求日期
       psab004 LIKE psab_t.psab004, #單位
       psab005 LIKE psab_t.psab005, #需求數量
       psab006 LIKE psab_t.psab006, #已耗需求
       psab007 LIKE psab_t.psab007, #備註
       psab008 LIKE psab_t.psab008, #結案
       psab009 LIKE psab_t.psab009, #MRP凍結
       #161109-00085#66 --s add
       psabud001 LIKE psab_t.psabud001, #自定義欄位(文字)001
       psabud002 LIKE psab_t.psabud002, #自定義欄位(文字)002
       psabud003 LIKE psab_t.psabud003, #自定義欄位(文字)003
       psabud004 LIKE psab_t.psabud004, #自定義欄位(文字)004
       psabud005 LIKE psab_t.psabud005, #自定義欄位(文字)005
       psabud006 LIKE psab_t.psabud006, #自定義欄位(文字)006
       psabud007 LIKE psab_t.psabud007, #自定義欄位(文字)007
       psabud008 LIKE psab_t.psabud008, #自定義欄位(文字)008
       psabud009 LIKE psab_t.psabud009, #自定義欄位(文字)009
       psabud010 LIKE psab_t.psabud010, #自定義欄位(文字)010
       psabud011 LIKE psab_t.psabud011, #自定義欄位(數字)011
       psabud012 LIKE psab_t.psabud012, #自定義欄位(數字)012
       psabud013 LIKE psab_t.psabud013, #自定義欄位(數字)013
       psabud014 LIKE psab_t.psabud014, #自定義欄位(數字)014
       psabud015 LIKE psab_t.psabud015, #自定義欄位(數字)015
       psabud016 LIKE psab_t.psabud016, #自定義欄位(數字)016
       psabud017 LIKE psab_t.psabud017, #自定義欄位(數字)017
       psabud018 LIKE psab_t.psabud018, #自定義欄位(數字)018
       psabud019 LIKE psab_t.psabud019, #自定義欄位(數字)019
       psabud020 LIKE psab_t.psabud020, #自定義欄位(數字)020
       psabud021 LIKE psab_t.psabud021, #自定義欄位(日期時間)021
       psabud022 LIKE psab_t.psabud022, #自定義欄位(日期時間)022
       psabud023 LIKE psab_t.psabud023, #自定義欄位(日期時間)023
       psabud024 LIKE psab_t.psabud024, #自定義欄位(日期時間)024
       psabud025 LIKE psab_t.psabud025, #自定義欄位(日期時間)025
       psabud026 LIKE psab_t.psabud026, #自定義欄位(日期時間)026
       psabud027 LIKE psab_t.psabud027, #自定義欄位(日期時間)027
       psabud028 LIKE psab_t.psabud028, #自定義欄位(日期時間)028
       psabud029 LIKE psab_t.psabud029, #自定義欄位(日期時間)029
       psabud030 LIKE psab_t.psabud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       psab010 LIKE psab_t.psab010, #專案編號
       psab011 LIKE psab_t.psab011, #WBS編號
       psab012 LIKE psab_t.psab012, #BOM特性
       psab013 LIKE psab_t.psab013  #保稅否
END RECORD
#161109-00085#27-e


 
   #带值
   IF g_sfab_d[p_ac].sfab001 ='2' THEN
      IF NOT cl_null(g_sfab_d[p_ac].sfab002) AND NOT cl_null(g_sfab_d[p_ac].sfab003) AND NOT cl_null(g_sfab_d[p_ac].sfab004) AND NOT cl_null(g_sfab_d[p_ac].sfab005) THEN
        #SELECT xmda004,xmda003,xmda002,xmdd_t.* INTO g_sfab_d[p_ac].a6,g_sfab_d[p_ac].a7,g_sfab_d[p_ac].a8,l_xmdd.* FROM xmda_t,xmdd_t WHERE xmdaent=xmddent AND xmdadocno=xmdddocno #161110-00005#1 mark
        #161110-00005#1--add--start--
         SELECT xmda004,xmda003,xmda002,
                xmddent,xmddsite,xmdddocno,xmddseq,xmddseq1,xmddseq2,
                xmdd001,xmdd002,xmdd003,xmdd004,xmdd005,xmdd006,
                xmdd007,xmdd008,xmdd009,xmdd010,xmdd011,xmdd012,
                xmdd013,xmdd014,xmdd015,xmdd016,xmdd017,xmdd018,
                xmdd019,xmdd020,xmdd021,xmdd022,xmdd023,xmdd024,
                xmdd025,xmdd026,xmdd027,xmdd028,xmdd029,xmdd030,
                xmdd031,xmdd032,xmdd033,xmdd034,xmdd035,xmdd200,
                xmdd201,xmdd202,xmdd203,xmdd204,xmdd205,xmdd206,
                xmddunit,xmdd207,xmdd208,xmdd209,xmdd210,xmdd211,
                xmdd212,xmdd213,xmdd214,xmdd215,xmdd216,xmdd217,
                xmdd218,xmdd219,xmdd220,xmdd221,xmdd222,xmdd223,
                xmdd224,xmdd225,xmdd226,xmdd227,xmdd228,xmddorga,
                xmdd229,xmdd230,xmdd036,xmdd037,xmdd038,xmdd039,
                xmdd231,xmdd040
           INTO g_sfab_d[p_ac].a6,g_sfab_d[p_ac].a7,g_sfab_d[p_ac].a8,
                l_xmdd.xmddent,l_xmdd.xmddsite,l_xmdd.xmdddocno,l_xmdd.xmddseq,l_xmdd.xmddseq1,l_xmdd.xmddseq2,
                l_xmdd.xmdd001,l_xmdd.xmdd002,l_xmdd.xmdd003,l_xmdd.xmdd004,l_xmdd.xmdd005,l_xmdd.xmdd006,
                l_xmdd.xmdd007,l_xmdd.xmdd008,l_xmdd.xmdd009,l_xmdd.xmdd010,l_xmdd.xmdd011,l_xmdd.xmdd012,
                l_xmdd.xmdd013,l_xmdd.xmdd014,l_xmdd.xmdd015,l_xmdd.xmdd016,l_xmdd.xmdd017,l_xmdd.xmdd018,
                l_xmdd.xmdd019,l_xmdd.xmdd020,l_xmdd.xmdd021,l_xmdd.xmdd022,l_xmdd.xmdd023,l_xmdd.xmdd024,
                l_xmdd.xmdd025,l_xmdd.xmdd026,l_xmdd.xmdd027,l_xmdd.xmdd028,l_xmdd.xmdd029,l_xmdd.xmdd030,
                l_xmdd.xmdd031,l_xmdd.xmdd032,l_xmdd.xmdd033,l_xmdd.xmdd034,l_xmdd.xmdd035,l_xmdd.xmdd200,
                l_xmdd.xmdd201,l_xmdd.xmdd202,l_xmdd.xmdd203,l_xmdd.xmdd204,l_xmdd.xmdd205,l_xmdd.xmdd206,
                l_xmdd.xmddunit,l_xmdd.xmdd207,l_xmdd.xmdd208,l_xmdd.xmdd209,l_xmdd.xmdd210,l_xmdd.xmdd211,
                l_xmdd.xmdd212,l_xmdd.xmdd213,l_xmdd.xmdd214,l_xmdd.xmdd215,l_xmdd.xmdd216,l_xmdd.xmdd217,
                l_xmdd.xmdd218,l_xmdd.xmdd219,l_xmdd.xmdd220,l_xmdd.xmdd221,l_xmdd.xmdd222,l_xmdd.xmdd223,
                l_xmdd.xmdd224,l_xmdd.xmdd225,l_xmdd.xmdd226,l_xmdd.xmdd227,l_xmdd.xmdd228,l_xmdd.xmddorga,
                l_xmdd.xmdd229,l_xmdd.xmdd230,l_xmdd.xmdd036,l_xmdd.xmdd037,l_xmdd.xmdd038,l_xmdd.xmdd039,
                l_xmdd.xmdd231,l_xmdd.xmdd040
           FROM xmda_t,xmdd_t 
          WHERE xmdaent=xmddent 
            AND xmdadocno=xmdddocno
        #161110-00005#1--add--end----       
            AND xmddent=g_enterprise AND xmddsite=g_site AND xmdd001=g_sfaa_m.sfaa010
            AND xmdddocno=g_sfab_d[p_ac].sfab002 AND xmddseq=g_sfab_d[p_ac].sfab003
            AND xmddseq1=g_sfab_d[p_ac].sfab004 AND xmddseq2=g_sfab_d[p_ac].sfab005
         LET g_sfab_d[p_ac].a1=l_xmdd.xmdd006
         LET g_sfab_d[p_ac].a2=l_xmdd.xmdd004
         LET g_sfab_d[p_ac].a4=g_sfaa_m.sfaa013
        #CALL s_aimi190_get_convert(l_xmdd.xmdd001,g_sfab_d[p_ac].a2,g_sfab_d[p_ac].a4) RETURNING l_success,l_rate
        #IF l_success THEN
        #   LET g_sfab_d[p_ac].a3=g_sfab_d[p_ac].a1 * l_rate
        #END IF
         CALL s_aooi250_convert_qty(l_xmdd.xmdd001,g_sfab_d[p_ac].a2,g_sfab_d[p_ac].a4,g_sfab_d[p_ac].a1)
              RETURNING l_success,g_sfab_d[p_ac].a3
         IF NOT l_success THEN
            LET g_sfab_d[p_ac].a3 = g_sfab_d[p_ac].a1
         END IF
         
         LET g_sfab_d[p_ac].a0 = l_xmdd.xmdd011
            
         #已开工单数量
         LET l_sql = "SELECT sfaa013,sfab007 FROM sfaa_t,sfab_t WHERE sfaaent=sfabent AND sfaadocno=sfabdocno",
               "   AND sfaaent=",g_enterprise," AND sfaasite='",g_site,"'",
               "   AND sfaa010='",g_sfaa_m.sfaa010,"' AND sfaastus != 'X'",
               "   AND sfab002='",g_sfab_d[p_ac].sfab002,"' AND sfab003=",g_sfab_d[p_ac].sfab003,
               "   AND sfab004=",g_sfab_d[p_ac].sfab004," AND sfab005=",g_sfab_d[p_ac].sfab005
         PREPARE asft300_qty2_pre FROM l_sql
         DECLARE asft300_qty2_cs CURSOR FOR asft300_qty2_pre
         LET g_sfab_d[p_ac].a5 = 0
         FOREACH asft300_qty2_cs INTO l_sfaa013,l_sfab007
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = "FOREACH:"
               LET g_errparam.popup = TRUE
               CALL cl_err()
   
               EXIT FOREACH
            END IF    
           #CALL s_aimi190_get_convert(g_sfaa_m.sfaa010,l_sfaa013,g_sfab_d[p_ac].a4) RETURNING l_success,l_rate
           #IF l_success THEN
           #   LET l_sfab007 = l_sfab007 * l_rate
           #END IF
            CALL s_aooi250_convert_qty(g_sfaa_m.sfaa010,l_sfaa013,g_sfab_d[p_ac].a4,l_sfab007)
                 RETURNING l_success,l_sfab007
            LET g_sfab_d[p_ac].a5 = g_sfab_d[p_ac].a5 + l_sfab007
         END FOREACH 
         
         INITIALIZE g_ref_fields TO NULL
         LET g_ref_fields[1] = g_sfab_d[p_ac].a8
         CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
         LET g_sfab_d[p_ac].a8_desc = '', g_rtn_fields[1] , ''
         
         INITIALIZE g_ref_fields TO NULL
         LET g_ref_fields[1] = g_sfab_d[p_ac].a7
         CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
         LET g_sfab_d[p_ac].a7_desc = '', g_rtn_fields[1] , ''
        
         INITIALIZE g_ref_fields TO NULL
         LET g_ref_fields[1] = g_sfab_d[p_ac].a6
         CALL ap_ref_array2(g_ref_fields,"SELECT pmaal004 FROM pmaal_t WHERE pmaalent='"||g_enterprise||"' AND pmaal001=? AND pmaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
         LET g_sfab_d[p_ac].a6_desc = '', g_rtn_fields[1] , ''
      END IF
   END IF
   
   #dorislai-20150711-add----(S)
   #带值(獨立需求)
   IF g_sfab_d[p_ac].sfab001 ='6' THEN
      IF NOT cl_null(g_sfab_d[p_ac].sfab002) AND NOT cl_null(g_sfab_d[p_ac].sfab003) THEN
         #161109-00085#27-s
         #SELECT psaa002,psaa001,psab_t.* INTO g_sfab_d[p_ac].a7,g_sfab_d[p_ac].a8,l_psab.* FROM psaa_t,psab_t WHERE psaaent=psabent AND psaadocno=psabdocno
         SELECT psaa002,psaa001,
                #161109-00085#66 --s mark
                #psabent,psabsite,psabdocno,psabseq,psab001,psab002,psab003,psab004,psab005,psab006,
                #psab007,psab008,psab009,psab010,psab011,psab012,psab013 
                #161109-00085#66 --e mark
                #161109-00085#66 --s add
                psabent,psabsite,psabdocno,psabseq,psab001,
                psab002,psab003,psab004,psab005,psab006,
                psab007,psab008,psab009,psabud001,psabud002,
                psabud003,psabud004,psabud005,psabud006,psabud007,
                psabud008,psabud009,psabud010,psabud011,psabud012,
                psabud013,psabud014,psabud015,psabud016,psabud017,
                psabud018,psabud019,psabud020,psabud021,psabud022,
                psabud023,psabud024,psabud025,psabud026,psabud027,
                psabud028,psabud029,psabud030,psab010,psab011,
                psab012,psab013
                #161109-00085#66 --e add
           INTO g_sfab_d[p_ac].a7,g_sfab_d[p_ac].a8,
                #161109-00085#66 --s add
                l_psab.psabent,l_psab.psabsite,l_psab.psabdocno,l_psab.psabseq,l_psab.psab001,
                l_psab.psab002,l_psab.psab003,l_psab.psab004,l_psab.psab005,l_psab.psab006,
                l_psab.psab007,l_psab.psab008,l_psab.psab009,l_psab.psabud001,l_psab.psabud002,
                l_psab.psabud003,l_psab.psabud004,l_psab.psabud005,l_psab.psabud006,l_psab.psabud007,
                l_psab.psabud008,l_psab.psabud009,l_psab.psabud010,l_psab.psabud011,l_psab.psabud012,
                l_psab.psabud013,l_psab.psabud014,l_psab.psabud015,l_psab.psabud016,l_psab.psabud017,
                l_psab.psabud018,l_psab.psabud019,l_psab.psabud020,l_psab.psabud021,l_psab.psabud022,
                l_psab.psabud023,l_psab.psabud024,l_psab.psabud025,l_psab.psabud026,l_psab.psabud027,
                l_psab.psabud028,l_psab.psabud029,l_psab.psabud030,l_psab.psab010,l_psab.psab011,
                l_psab.psab012,l_psab.psab013
                #161109-00085#66 --e add
                #161109-00085#66 --s mark
                #l_psab.psabent,l_psab.psabsite,l_psab.psabdocno,l_psab.psabseq,l_psab.psab001,
                #l_psab.psab002,l_psab.psab003,l_psab.psab004,l_psab.psab005,l_psab.psab006,
                #l_psab.psab007,l_psab.psab008,l_psab.psab009,l_psab.psab010,l_psab.psab011,
                #l_psab.psab012,l_psab.psab013
                #161109-00085#66 --e mark
           FROM psaa_t,psab_t
          WHERE psaaent=psabent AND psaadocno=psabdocno  
        #161109-00085#27-e
            AND psabent=g_enterprise AND psabsite=g_site AND psab001=g_sfaa_m.sfaa010
            AND psabdocno=g_sfab_d[p_ac].sfab002 AND psabseq=g_sfab_d[p_ac].sfab003

         LET g_sfab_d[p_ac].a1=l_psab.psab005   #原始需求量=需求數量
         LET g_sfab_d[p_ac].a2=l_psab.psab004   #需求單位=單位
         LET g_sfab_d[p_ac].a4=g_sfaa_m.sfaa013 #生產單位
        #CALL s_aimi190_get_convert(l_xmdd.xmdd001,g_sfab_d[p_ac].a2,g_sfab_d[p_ac].a4) RETURNING l_success,l_rate
        #IF l_success THEN
        #   LET g_sfab_d[p_ac].a3=g_sfab_d[p_ac].a1 * l_rate
        #END IF
         CALL s_aooi250_convert_qty(l_psab.psab001,g_sfab_d[p_ac].a2,g_sfab_d[p_ac].a4,g_sfab_d[p_ac].a1)
              RETURNING l_success,g_sfab_d[p_ac].a3
         IF NOT l_success THEN
            LET g_sfab_d[p_ac].a3 = g_sfab_d[p_ac].a1
         END IF
         
         LET g_sfab_d[p_ac].a0 = l_psab.psab003   #需求日期
         
         #已開工單數量
         LET l_sql = "SELECT sfaa013,sfab007 FROM sfaa_t,sfab_t WHERE sfaaent=sfabent AND sfaadocno=sfabdocno",
               "   AND sfaaent=",g_enterprise," AND sfaasite='",g_site,"'",
               "   AND sfaa010='",g_sfaa_m.sfaa010,"' AND sfaastus != 'X'",
               "   AND sfab002='",g_sfab_d[p_ac].sfab002,"' AND sfab003=",g_sfab_d[p_ac].sfab003

         PREPARE asft300_qty2_pre_1 FROM l_sql
         DECLARE asft300_qty2_cs_1 CURSOR FOR asft300_qty2_pre_1
         LET g_sfab_d[p_ac].a5 = 0   #已開工單量
         FOREACH asft300_qty2_cs_1 INTO l_sfaa013,l_sfab007
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = "FOREACH:"
               LET g_errparam.popup = TRUE
               CALL cl_err()
 
               EXIT FOREACH
            END IF    
           #CALL s_aimi190_get_convert(g_sfaa_m.sfaa010,l_sfaa013,g_sfab_d[p_ac].a4) RETURNING l_success,l_rate
           #IF l_success THEN
           #   LET l_sfab007 = l_sfab007 * l_rate
           #END IF
            CALL s_aooi250_convert_qty(g_sfaa_m.sfaa010,l_sfaa013,g_sfab_d[p_ac].a4,l_sfab007)
                 RETURNING l_success,l_sfab007
            LET g_sfab_d[p_ac].a5 = g_sfab_d[p_ac].a5 + l_sfab007   #已開工單量+他單 本次轉開工單
         END FOREACH 
         FREE asft300_qty2_pre_1
         
         INITIALIZE g_ref_fields TO NULL
         LET g_ref_fields[1] = g_sfab_d[p_ac].a8
         CALL ap_ref_array2(g_ref_fields,"SELECT ooag011 FROM ooag_t WHERE ooagent='"||g_enterprise||"' AND ooag001=? ","") RETURNING g_rtn_fields
         LET g_sfab_d[p_ac].a8_desc = '', g_rtn_fields[1] , ''
         
         INITIALIZE g_ref_fields TO NULL
         LET g_ref_fields[1] = g_sfab_d[p_ac].a7
         CALL ap_ref_array2(g_ref_fields,"SELECT ooefl003 FROM ooefl_t WHERE ooeflent='"||g_enterprise||"' AND ooefl001=? AND ooefl002='"||g_dlang||"'","") RETURNING g_rtn_fields
         LET g_sfab_d[p_ac].a7_desc = '', g_rtn_fields[1] , ''
        
         INITIALIZE g_ref_fields TO NULL
         LET g_ref_fields[1] = g_sfab_d[p_ac].a6
         CALL ap_ref_array2(g_ref_fields,"SELECT pmaal004 FROM pmaal_t WHERE pmaalent='"||g_enterprise||"' AND pmaal001=? AND pmaal002='"||g_dlang||"'","") RETURNING g_rtn_fields
         LET g_sfab_d[p_ac].a6_desc = '', g_rtn_fields[1] , ''
      END IF
   END IF
   #dorislai-20150711-add----(E)

END FUNCTION

#已开工单量计算
PRIVATE FUNCTION asft300_sfaa006_chk_qty(p_sfab002,p_sfab003,p_sfab004,p_sfab005,p_unit)
DEFINE p_sfab002         LIKE sfab_t.sfab002
DEFINE p_sfab003         LIKE sfab_t.sfab003
DEFINE p_sfab004         LIKE sfab_t.sfab004
DEFINE p_sfab005         LIKE sfab_t.sfab005
DEFINE p_unit            LIKE sfaa_t.sfaa013
DEFINE l_sql             STRING
DEFINE l_sum             LIKE sfaa_t.sfaa012
DEFINE l_sfab007         LIKE sfab_t.sfab007
DEFINE l_sfaa013         LIKE sfaa_t.sfaa013
DEFINE l_success         LIKE type_t.num5
DEFINE l_rate            LIKE type_t.num26_10

  LET l_sql = "SELECT sfaa013,sfab007 FROM sfaa_t,sfab_t WHERE sfaaent=sfabent AND sfaadocno=sfabdocno",
              "   AND sfaaent=",g_enterprise," AND sfaasite='",g_site,"'",
              "   AND sfaa010='",g_sfaa_m.sfaa010,"' AND sfaastus != 'X'",
              "   AND sfab002=? AND sfab003=? AND sfab004=? AND sfab005=?"
  PREPARE asft300_01_qty2_pre FROM l_sql
  DECLARE asft300_01_qty2_cs CURSOR FOR asft300_01_qty2_pre
  LET l_sum = 0
  FOREACH asft300_01_qty2_cs USING p_sfab002,p_sfab003,p_sfab004,p_sfab005 INTO l_sfaa013,l_sfab007
     IF SQLCA.sqlcode THEN
        INITIALIZE g_errparam TO NULL
        LET g_errparam.code = SQLCA.sqlcode
        LET g_errparam.extend = "FOREACH:"
        LET g_errparam.popup = TRUE
        CALL cl_err()

        EXIT FOREACH
     END IF    
    #CALL s_aimi190_get_convert(g_sfaa_m.sfaa010,l_sfaa013,g_sfaa_m.sfaa013) RETURNING l_success,l_rate
    #IF l_success THEN
    #   LET l_sfab007 = l_sfab007 * l_rate
    #END IF
     CALL s_aooi250_convert_qty(g_sfaa_m.sfaa010,l_sfaa013,g_sfaa_m.sfaa013,l_sfab007)
          RETURNING l_success,l_sfab007
     LET l_sum = l_sum + l_sfab007
  END FOREACH     
     
  RETURN l_sum   

END FUNCTION

#订单时chk数量不可大于剩余可生产量
PRIVATE FUNCTION asft300_sfaa012_chk()
DEFINE l_sql         STRING
DEFINE l_xmda007     LIKE xmda_t.xmda007
DEFINE l_xmda008     LIKE xmda_t.xmda008
#161109-00085#27-s
#DEFINE l_xmdd        RECORD LIKE xmdd_t.*
DEFINE l_xmdd RECORD  #訂單交期明細檔
       xmddent LIKE xmdd_t.xmddent, #企業編號
       xmddsite LIKE xmdd_t.xmddsite, #營運據點
       xmdddocno LIKE xmdd_t.xmdddocno, #訂單單號
       xmddseq LIKE xmdd_t.xmddseq, #項次
       xmddseq1 LIKE xmdd_t.xmddseq1, #項序
       xmddseq2 LIKE xmdd_t.xmddseq2, #分批序
       xmdd001 LIKE xmdd_t.xmdd001, #料件編號
       xmdd002 LIKE xmdd_t.xmdd002, #產品特徵
       xmdd003 LIKE xmdd_t.xmdd003, #子件特性
       xmdd004 LIKE xmdd_t.xmdd004, #銷售單位
       xmdd005 LIKE xmdd_t.xmdd005, #訂購總數量
       xmdd006 LIKE xmdd_t.xmdd006, #分批訂購數量
       xmdd007 LIKE xmdd_t.xmdd007, #摺合主件數量
       xmdd008 LIKE xmdd_t.xmdd008, #QPA
       xmdd009 LIKE xmdd_t.xmdd009, #交期類型
       xmdd010 LIKE xmdd_t.xmdd010, #出貨時段
       xmdd011 LIKE xmdd_t.xmdd011, #約定交貨日期
       xmdd012 LIKE xmdd_t.xmdd012, #預計簽收日期
       xmdd013 LIKE xmdd_t.xmdd013, #MRP交期凍結
       xmdd014 LIKE xmdd_t.xmdd014, #已出貨量
       xmdd015 LIKE xmdd_t.xmdd015, #已銷退量
       xmdd016 LIKE xmdd_t.xmdd016, #銷退換貨數量
       xmdd017 LIKE xmdd_t.xmdd017, #出貨狀態
       xmdd018 LIKE xmdd_t.xmdd018, #參考價格
       xmdd019 LIKE xmdd_t.xmdd019, #稅別
       xmdd020 LIKE xmdd_t.xmdd020, #稅率
       xmdd021 LIKE xmdd_t.xmdd021, #電子訂購單號
       xmdd022 LIKE xmdd_t.xmdd022, #最近修改人員
       xmdd023 LIKE xmdd_t.xmdd023, #最近修改時間
       xmdd024 LIKE xmdd_t.xmdd024, #分批參考單位
       xmdd025 LIKE xmdd_t.xmdd025, #分批參考數量
       xmdd026 LIKE xmdd_t.xmdd026, #分批計價單位
       xmdd027 LIKE xmdd_t.xmdd027, #分批計價數量
       xmdd028 LIKE xmdd_t.xmdd028, #分批未稅金額
       xmdd029 LIKE xmdd_t.xmdd029, #分批含稅金額
       xmdd030 LIKE xmdd_t.xmdd030, #分批稅額
       xmdd031 LIKE xmdd_t.xmdd031, #已轉出通數量
       xmdd032 LIKE xmdd_t.xmdd032, #備置量
       xmdd033 LIKE xmdd_t.xmdd033, #備置原因
       xmdd034 LIKE xmdd_t.xmdd034, #已簽退量
       xmdd035 LIKE xmdd_t.xmdd035, #已分配量
       xmdd200 LIKE xmdd_t.xmdd200, #促銷方案
       xmdd201 LIKE xmdd_t.xmdd201, #分批包裝單位
       xmdd202 LIKE xmdd_t.xmdd202, #分批包裝數量
       xmdd203 LIKE xmdd_t.xmdd203, #標準價
       xmdd204 LIKE xmdd_t.xmdd204, #促銷價
       xmdd205 LIKE xmdd_t.xmdd205, #交易價
       xmdd206 LIKE xmdd_t.xmdd206, #折價金額
       xmddunit LIKE xmdd_t.xmddunit, #應用組織
       xmdd207 LIKE xmdd_t.xmdd207, #收貨網點
       xmdd208 LIKE xmdd_t.xmdd208, #送貨地址碼
       xmdd209 LIKE xmdd_t.xmdd209, #送貨站點
       xmdd210 LIKE xmdd_t.xmdd210, #送貨時段
       xmdd211 LIKE xmdd_t.xmdd211, #送貨客戶
       xmdd212 LIKE xmdd_t.xmdd212, #MRP凍結
       xmdd213 LIKE xmdd_t.xmdd213, #庫位/庫區
       xmdd214 LIKE xmdd_t.xmdd214, #儲位
       xmdd215 LIKE xmdd_t.xmdd215, #批號
       xmdd216 LIKE xmdd_t.xmdd216, #庫存鎖定等級
       xmdd217 LIKE xmdd_t.xmdd217, #庫存餘額
       xmdd218 LIKE xmdd_t.xmdd218, #銷售渠道
       xmdd219 LIKE xmdd_t.xmdd219, #產品組編號
       xmdd220 LIKE xmdd_t.xmdd220, #銷售範圍編號
       xmdd221 LIKE xmdd_t.xmdd221, #備註
       xmdd222 LIKE xmdd_t.xmdd222, #辦事處
       xmdd223 LIKE xmdd_t.xmdd223, #業務人員
       xmdd224 LIKE xmdd_t.xmdd224, #業務部門
       xmdd225 LIKE xmdd_t.xmdd225, #主合約編號
       xmdd226 LIKE xmdd_t.xmdd226, #經營方式
       xmdd227 LIKE xmdd_t.xmdd227, #結算類型
       xmdd228 LIKE xmdd_t.xmdd228, #結算方式
       xmddorga LIKE xmdd_t.xmddorga, #帳務組織
       xmdd229 LIKE xmdd_t.xmdd229, #交易類型
       xmdd230 LIKE xmdd_t.xmdd230, #分批包裝銷退換貨數量
       #161109-00085#66 --s add
       xmddud001 LIKE xmdd_t.xmddud001, #自定義欄位(文字)001
       xmddud002 LIKE xmdd_t.xmddud002, #自定義欄位(文字)002
       xmddud003 LIKE xmdd_t.xmddud003, #自定義欄位(文字)003
       xmddud004 LIKE xmdd_t.xmddud004, #自定義欄位(文字)004
       xmddud005 LIKE xmdd_t.xmddud005, #自定義欄位(文字)005
       xmddud006 LIKE xmdd_t.xmddud006, #自定義欄位(文字)006
       xmddud007 LIKE xmdd_t.xmddud007, #自定義欄位(文字)007
       xmddud008 LIKE xmdd_t.xmddud008, #自定義欄位(文字)008
       xmddud009 LIKE xmdd_t.xmddud009, #自定義欄位(文字)009
       xmddud010 LIKE xmdd_t.xmddud010, #自定義欄位(文字)010
       xmddud011 LIKE xmdd_t.xmddud011, #自定義欄位(數字)011
       xmddud012 LIKE xmdd_t.xmddud012, #自定義欄位(數字)012
       xmddud013 LIKE xmdd_t.xmddud013, #自定義欄位(數字)013
       xmddud014 LIKE xmdd_t.xmddud014, #自定義欄位(數字)014
       xmddud015 LIKE xmdd_t.xmddud015, #自定義欄位(數字)015
       xmddud016 LIKE xmdd_t.xmddud016, #自定義欄位(數字)016
       xmddud017 LIKE xmdd_t.xmddud017, #自定義欄位(數字)017
       xmddud018 LIKE xmdd_t.xmddud018, #自定義欄位(數字)018
       xmddud019 LIKE xmdd_t.xmddud019, #自定義欄位(數字)019
       xmddud020 LIKE xmdd_t.xmddud020, #自定義欄位(數字)020
       xmddud021 LIKE xmdd_t.xmddud021, #自定義欄位(日期時間)021
       xmddud022 LIKE xmdd_t.xmddud022, #自定義欄位(日期時間)022
       xmddud023 LIKE xmdd_t.xmddud023, #自定義欄位(日期時間)023
       xmddud024 LIKE xmdd_t.xmddud024, #自定義欄位(日期時間)024
       xmddud025 LIKE xmdd_t.xmddud025, #自定義欄位(日期時間)025
       xmddud026 LIKE xmdd_t.xmddud026, #自定義欄位(日期時間)026
       xmddud027 LIKE xmdd_t.xmddud027, #自定義欄位(日期時間)027
       xmddud028 LIKE xmdd_t.xmddud028, #自定義欄位(日期時間)028
       xmddud029 LIKE xmdd_t.xmddud029, #自定義欄位(日期時間)029
       xmddud030 LIKE xmdd_t.xmddud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       xmdd036 LIKE xmdd_t.xmdd036, #還量數量
       xmdd037 LIKE xmdd_t.xmdd037, #還量參考數量
       xmdd038 LIKE xmdd_t.xmdd038, #還價數量
       xmdd039 LIKE xmdd_t.xmdd039, #還價參考數量
       xmdd231 LIKE xmdd_t.xmdd231, #庫存管理特徵
       xmdd040 LIKE xmdd_t.xmdd040  #BOM特性
END RECORD
#161109-00085#27-e
DEFINE l_success     LIKE type_t.num5
DEFINE l_rate        LIKE type_t.num5
DEFINE l_sum         LIKE sfaa_t.sfaa012
DEFINE l_num         LIKE sfaa_t.sfaa012
DEFINE l_num1        LIKE sfaa_t.sfaa012
DEFINE l_xmdddocno   LIKE xmdd_t.xmdddocno
DEFINE l_xmddseq     LIKE xmdd_t.xmddseq
DEFINE l_xmddseq1    LIKE xmdd_t.xmddseq1
DEFINE l_xmddseq2    LIKE xmdd_t.xmddseq2
DEFINE l_sfaa012     LIKE sfaa_t.sfaa012
#161109-00085#27-s
#DEFINE l_psab        RECORD LIKE psab_t.*   #20150709 by dorislai
DEFINE l_psab RECORD  #獨立需求單身檔
       psabent LIKE psab_t.psabent, #企業編號
       psabsite LIKE psab_t.psabsite, #營運據點
       psabdocno LIKE psab_t.psabdocno, #需求單號
       psabseq LIKE psab_t.psabseq, #項次
       psab001 LIKE psab_t.psab001, #料件編號
       psab002 LIKE psab_t.psab002, #產品特徵
       psab003 LIKE psab_t.psab003, #需求日期
       psab004 LIKE psab_t.psab004, #單位
       psab005 LIKE psab_t.psab005, #需求數量
       psab006 LIKE psab_t.psab006, #已耗需求
       psab007 LIKE psab_t.psab007, #備註
       psab008 LIKE psab_t.psab008, #結案
       psab009 LIKE psab_t.psab009, #MRP凍結
       #161109-00085#66 --s add
       psabud001 LIKE psab_t.psabud001, #自定義欄位(文字)001
       psabud002 LIKE psab_t.psabud002, #自定義欄位(文字)002
       psabud003 LIKE psab_t.psabud003, #自定義欄位(文字)003
       psabud004 LIKE psab_t.psabud004, #自定義欄位(文字)004
       psabud005 LIKE psab_t.psabud005, #自定義欄位(文字)005
       psabud006 LIKE psab_t.psabud006, #自定義欄位(文字)006
       psabud007 LIKE psab_t.psabud007, #自定義欄位(文字)007
       psabud008 LIKE psab_t.psabud008, #自定義欄位(文字)008
       psabud009 LIKE psab_t.psabud009, #自定義欄位(文字)009
       psabud010 LIKE psab_t.psabud010, #自定義欄位(文字)010
       psabud011 LIKE psab_t.psabud011, #自定義欄位(數字)011
       psabud012 LIKE psab_t.psabud012, #自定義欄位(數字)012
       psabud013 LIKE psab_t.psabud013, #自定義欄位(數字)013
       psabud014 LIKE psab_t.psabud014, #自定義欄位(數字)014
       psabud015 LIKE psab_t.psabud015, #自定義欄位(數字)015
       psabud016 LIKE psab_t.psabud016, #自定義欄位(數字)016
       psabud017 LIKE psab_t.psabud017, #自定義欄位(數字)017
       psabud018 LIKE psab_t.psabud018, #自定義欄位(數字)018
       psabud019 LIKE psab_t.psabud019, #自定義欄位(數字)019
       psabud020 LIKE psab_t.psabud020, #自定義欄位(數字)020
       psabud021 LIKE psab_t.psabud021, #自定義欄位(日期時間)021
       psabud022 LIKE psab_t.psabud022, #自定義欄位(日期時間)022
       psabud023 LIKE psab_t.psabud023, #自定義欄位(日期時間)023
       psabud024 LIKE psab_t.psabud024, #自定義欄位(日期時間)024
       psabud025 LIKE psab_t.psabud025, #自定義欄位(日期時間)025
       psabud026 LIKE psab_t.psabud026, #自定義欄位(日期時間)026
       psabud027 LIKE psab_t.psabud027, #自定義欄位(日期時間)027
       psabud028 LIKE psab_t.psabud028, #自定義欄位(日期時間)028
       psabud029 LIKE psab_t.psabud029, #自定義欄位(日期時間)029
       psabud030 LIKE psab_t.psabud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       psab010 LIKE psab_t.psab010, #專案編號
       psab011 LIKE psab_t.psab011, #WBS編號
       psab012 LIKE psab_t.psab012, #BOM特性
       psab013 LIKE psab_t.psab013  #保稅否
END RECORD
#161109-00085#27-e
#161109-00085#27-s
#DEFINE l_psad        RECORD LIKE psad_t.*   #add--151207-00017#2 By shiun
DEFINE l_psad RECORD  #MPS計劃單身檔
       psadent LIKE psad_t.psadent, #企業編號
       psadsite LIKE psad_t.psadsite, #營運據點
       psaddocno LIKE psad_t.psaddocno, #MPS計劃單號
       psadseq LIKE psad_t.psadseq, #項次
       psad001 LIKE psad_t.psad001, #料件編號
       psad002 LIKE psad_t.psad002, #產品特徵
       psad003 LIKE psad_t.psad003, #預計生產完工日期
       psad004 LIKE psad_t.psad004, #單位
       psad005 LIKE psad_t.psad005, #計劃產量
       psad006 LIKE psad_t.psad006, #已開工單量
       psad007 LIKE psad_t.psad007, #備註
       psad008 LIKE psad_t.psad008, #結案
       psad009 LIKE psad_t.psad009, #MRP凍結
       #161109-00085#66 --s add
       psadud001 LIKE psad_t.psadud001, #自定義欄位(文字)001
       psadud002 LIKE psad_t.psadud002, #自定義欄位(文字)002
       psadud003 LIKE psad_t.psadud003, #自定義欄位(文字)003
       psadud004 LIKE psad_t.psadud004, #自定義欄位(文字)004
       psadud005 LIKE psad_t.psadud005, #自定義欄位(文字)005
       psadud006 LIKE psad_t.psadud006, #自定義欄位(文字)006
       psadud007 LIKE psad_t.psadud007, #自定義欄位(文字)007
       psadud008 LIKE psad_t.psadud008, #自定義欄位(文字)008
       psadud009 LIKE psad_t.psadud009, #自定義欄位(文字)009
       psadud010 LIKE psad_t.psadud010, #自定義欄位(文字)010
       psadud011 LIKE psad_t.psadud011, #自定義欄位(數字)011
       psadud012 LIKE psad_t.psadud012, #自定義欄位(數字)012
       psadud013 LIKE psad_t.psadud013, #自定義欄位(數字)013
       psadud014 LIKE psad_t.psadud014, #自定義欄位(數字)014
       psadud015 LIKE psad_t.psadud015, #自定義欄位(數字)015
       psadud016 LIKE psad_t.psadud016, #自定義欄位(數字)016
       psadud017 LIKE psad_t.psadud017, #自定義欄位(數字)017
       psadud018 LIKE psad_t.psadud018, #自定義欄位(數字)018
       psadud019 LIKE psad_t.psadud019, #自定義欄位(數字)019
       psadud020 LIKE psad_t.psadud020, #自定義欄位(數字)020
       psadud021 LIKE psad_t.psadud021, #自定義欄位(日期時間)021
       psadud022 LIKE psad_t.psadud022, #自定義欄位(日期時間)022
       psadud023 LIKE psad_t.psadud023, #自定義欄位(日期時間)023
       psadud024 LIKE psad_t.psadud024, #自定義欄位(日期時間)024
       psadud025 LIKE psad_t.psadud025, #自定義欄位(日期時間)025
       psadud026 LIKE psad_t.psadud026, #自定義欄位(日期時間)026
       psadud027 LIKE psad_t.psadud027, #自定義欄位(日期時間)027
       psadud028 LIKE psad_t.psadud028, #自定義欄位(日期時間)028
       psadud029 LIKE psad_t.psadud029, #自定義欄位(日期時間)029
       psadud030 LIKE psad_t.psadud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       psad010 LIKE psad_t.psad010  #保稅否
END RECORD
#161109-00085#27-e
DEFINE l_qty         LIKE psad_t.psad005    #add--151207-00017#2 By shiun
DEFINE l_imae015     LIKE imae_t.imae015    #160119-00004#1 add   #生產損耗率

  IF NOT cl_ap_chk_Range(g_sfaa_m.sfaa012,"0","0","","","azz-00079",1) THEN
     RETURN FALSE
  END IF
  
  #160119-00004#1 add str
   #生產損耗率
   LET l_imae015 = NULL
   SELECT imae015 INTO l_imae015
    FROM imae_t
   WHERE imaeent = g_enterprise AND imaesite = g_site AND imae001 = g_sfaa_m.sfaa010
   IF cl_null(l_imae015) THEN LET l_imae015 = 0 END IF   
  #160119-00004#1 add end 

  IF g_sfaa_m.sfaa005 ='2' THEN
     IF NOT cl_null(g_sfaa_m.sfaa006) AND NOT cl_null(g_sfaa_m.sfaa007) AND 
        NOT cl_null(g_sfaa_m.sfaa008) AND NOT cl_null(g_sfaa_m.sfaa063) THEN
       #SELECT xmda007,xmda008,xmdd_t.*      #161110-00005#1 mark
       #  INTO l_xmda007,l_xmda008,l_xmdd.*  #161110-00005#1 mark
       #161110-00005#1--add--start--
        SELECT xmda007,xmda008,
               xmddent,xmddsite,xmdddocno,xmddseq,xmddseq1,xmddseq2,
               xmdd001,xmdd002,xmdd003,xmdd004,xmdd005,xmdd006,
               xmdd007,xmdd008,xmdd009,xmdd010,xmdd011,xmdd012,
               xmdd013,xmdd014,xmdd015,xmdd016,xmdd017,xmdd018,
               xmdd019,xmdd020,xmdd021,xmdd022,xmdd023,xmdd024,
               xmdd025,xmdd026,xmdd027,xmdd028,xmdd029,xmdd030,
               xmdd031,xmdd032,xmdd033,xmdd034,xmdd035,xmdd200,
               xmdd201,xmdd202,xmdd203,xmdd204,xmdd205,xmdd206,
               xmddunit,xmdd207,xmdd208,xmdd209,xmdd210,xmdd211,
               xmdd212,xmdd213,xmdd214,xmdd215,xmdd216,xmdd217,
               xmdd218,xmdd219,xmdd220,xmdd221,xmdd222,xmdd223,
               xmdd224,xmdd225,xmdd226,xmdd227,xmdd228,xmddorga,
               xmdd229,xmdd230,xmdd036,xmdd037,xmdd038,xmdd039,
               xmdd231,xmdd040
          INTO l_xmda007,l_xmda008,
               l_xmdd.xmddent,l_xmdd.xmddsite,l_xmdd.xmdddocno,l_xmdd.xmddseq,l_xmdd.xmddseq1,l_xmdd.xmddseq2,
               l_xmdd.xmdd001,l_xmdd.xmdd002,l_xmdd.xmdd003,l_xmdd.xmdd004,l_xmdd.xmdd005,l_xmdd.xmdd006,
               l_xmdd.xmdd007,l_xmdd.xmdd008,l_xmdd.xmdd009,l_xmdd.xmdd010,l_xmdd.xmdd011,l_xmdd.xmdd012,
               l_xmdd.xmdd013,l_xmdd.xmdd014,l_xmdd.xmdd015,l_xmdd.xmdd016,l_xmdd.xmdd017,l_xmdd.xmdd018,
               l_xmdd.xmdd019,l_xmdd.xmdd020,l_xmdd.xmdd021,l_xmdd.xmdd022,l_xmdd.xmdd023,l_xmdd.xmdd024,
               l_xmdd.xmdd025,l_xmdd.xmdd026,l_xmdd.xmdd027,l_xmdd.xmdd028,l_xmdd.xmdd029,l_xmdd.xmdd030,
               l_xmdd.xmdd031,l_xmdd.xmdd032,l_xmdd.xmdd033,l_xmdd.xmdd034,l_xmdd.xmdd035,l_xmdd.xmdd200,
               l_xmdd.xmdd201,l_xmdd.xmdd202,l_xmdd.xmdd203,l_xmdd.xmdd204,l_xmdd.xmdd205,l_xmdd.xmdd206,
               l_xmdd.xmddunit,l_xmdd.xmdd207,l_xmdd.xmdd208,l_xmdd.xmdd209,l_xmdd.xmdd210,l_xmdd.xmdd211,
               l_xmdd.xmdd212,l_xmdd.xmdd213,l_xmdd.xmdd214,l_xmdd.xmdd215,l_xmdd.xmdd216,l_xmdd.xmdd217,
               l_xmdd.xmdd218,l_xmdd.xmdd219,l_xmdd.xmdd220,l_xmdd.xmdd221,l_xmdd.xmdd222,l_xmdd.xmdd223,
               l_xmdd.xmdd224,l_xmdd.xmdd225,l_xmdd.xmdd226,l_xmdd.xmdd227,l_xmdd.xmdd228,l_xmdd.xmddorga,
               l_xmdd.xmdd229,l_xmdd.xmdd230,l_xmdd.xmdd036,l_xmdd.xmdd037,l_xmdd.xmdd038,l_xmdd.xmdd039,
               l_xmdd.xmdd231,l_xmdd.xmdd040
       #161110-00005#1--add--end----       
          FROM xmda_t,xmdd_t 
         WHERE xmdaent=xmddent AND xmdadocno=xmdddocno
           AND xmddent=g_enterprise AND xmddsite=g_site
           AND xmdddocno=g_sfaa_m.sfaa006 AND xmddseq=g_sfaa_m.sfaa007
           AND xmddseq1=g_sfaa_m.sfaa008 AND xmddseq2=g_sfaa_m.sfaa063       
        
        #此笔工单原始数量
        SELECT sfaa012 INTO l_sfaa012 FROM sfaa_t
         WHERE sfaaent=g_enterprise AND sfaasite=g_site AND sfaadocno=g_sfaa_m.sfaadocno
        IF cl_null(l_sfaa012) THEN LET l_sfaa012 = 0 END IF
        
       #CALL s_aimi190_get_convert(g_sfaa_m.sfaa010,l_xmdd.xmdd006,g_sfaa_m.sfaa013) RETURNING l_success,l_rate
       #IF l_success THEN
       #   LET l_xmdd.xmdd006 = l_xmdd.xmdd006 * l_rate
       #END IF
       #dorislai-20150710-modify----(S)
#        CALL s_aooi250_convert_qty(g_sfaa_m.sfaa010,l_xmdd.xmdd006,g_sfaa_m.sfaa013,l_xmdd.xmdd006)
#             RETURNING l_success,l_xmdd.xmdd006
        CALL s_aooi250_convert_qty(g_sfaa_m.sfaa010,l_xmdd.xmdd004,g_sfaa_m.sfaa013,l_xmdd.xmdd006)
             RETURNING l_success,l_xmdd.xmdd006
       #dorislai-20150710-modify----(E)
       
       #160119-00004#1 add str       
        #數量加上生產損耗率
        LET l_xmdd.xmdd006 = l_xmdd.xmdd006 * (1 + l_imae015 / 100)
       #160119-00004#1 add end
       
        #已开工单量计算
        CALL asft300_sfaa006_chk_qty(g_sfaa_m.sfaa006,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa013)
             RETURNING l_sum
       
        IF g_sfaa_m.sfaa012 > l_xmdd.xmdd006 - l_sum + l_sfaa012 THEN
           INITIALIZE g_errparam TO NULL
           LET g_errparam.code = 'asf-00337'
           LET g_errparam.extend = ''
           LET g_errparam.popup = TRUE
           CALL cl_err()
           RETURN FALSE
        END IF
        
        #预先订单对应已开工单数量也纳入计算
        IF l_xmda007 = '2' AND NOT cl_null(l_xmda008) THEN
           LET l_sql = "SELECT xmdddocno,xmddseq,xmddseq1,xmddseq2",
                       "  FROM xmdd_t,xmda_t",
                       " WHERE xmdaent=xmddent AND xmdasite=xmddsite AND xmdadocno=xmdddocno",
                       "   AND xmddent=",g_enterprise,
                       "   AND xmddsite='",g_site,"'",
                       "   AND xmdadocno='",l_xmda008,"'",
                       "   AND xmdd001='",g_sfaa_m.sfaa010,"'",
                       #161128-00045-s-mod
#                       "   AND xmdastus='Y'"                       
                       "   AND xmdastus IN ('Y','H') "
                       #161128-00045-e-mod
           PREPARE asft300_01_pre_2 FROM l_sql
           DECLARE asft300_01_cs_2 CURSOR FOR asft300_01_pre_2
           LET l_num = 0
           FOREACH asft300_01_cs_2 INTO l_xmdddocno,l_xmddseq,l_xmddseq1,l_xmddseq2
              IF SQLCA.sqlcode THEN
                 INITIALIZE g_errparam TO NULL
                 LET g_errparam.code = SQLCA.sqlcode
                 LET g_errparam.extend = "FOREACH:"
                 LET g_errparam.popup = TRUE
                 CALL cl_err()
                 EXIT FOREACH
              END IF
              CALL asft300_sfaa006_chk_qty(l_xmdddocno,l_xmddseq,l_xmddseq1,l_xmddseq2,g_sfaa_m.sfaa013) RETURNING l_num1
              LET l_num = l_num + l_num1
           END FOREACH
           IF g_sfaa_m.sfaa012 > l_xmdd.xmdd006 - l_sum + l_sfaa012 - l_num THEN
              INITIALIZE g_errparam TO NULL
              LET g_errparam.code = 'asf-00337'
              LET g_errparam.extend = ''
              LET g_errparam.popup = TRUE
              CALL cl_err()
              RETURN FALSE
           END IF
        END IF  
     END IF
  END IF
  #dorislai-20150710-add----(S)
  IF g_sfaa_m.sfaa005 = '6' THEN
     IF NOT cl_null(g_sfaa_m.sfaa006) AND NOT cl_null(g_sfaa_m.sfaa007) THEN
        #161109-00085#27-s
        #SELECT psab_t.* INTO l_psab.*
        #161109-00085#66 --s mark
        #SELECT psabent,psabsite,psabdocno,psabseq,psab001,psab002,psab003,psab004,psab005,psab006,
        #       psab007,psab008,psab009,psab010,psab011,psab012,psab013
        #  INTO l_psab.psabent,l_psab.psabsite,l_psab.psabdocno,l_psab.psabseq,l_psab.psab001,
        #       l_psab.psab002,l_psab.psab003,l_psab.psab004,l_psab.psab005,l_psab.psab006,
        #       l_psab.psab007,l_psab.psab008,l_psab.psab009,l_psab.psab010,l_psab.psab011,
        #       l_psab.psab012,l_psab.psab013 
        #161109-00085#66 --e mark        
        #161109-00085#27-e
        #161109-00085#66 --s add
        SELECT psabent,psabsite,psabdocno,psabseq,psab001,
               psab002,psab003,psab004,psab005,psab006,
               psab007,psab008,psab009,psabud001,psabud002,
               psabud003,psabud004,psabud005,psabud006,psabud007,
               psabud008,psabud009,psabud010,psabud011,psabud012,
               psabud013,psabud014,psabud015,psabud016,psabud017,
               psabud018,psabud019,psabud020,psabud021,psabud022,
               psabud023,psabud024,psabud025,psabud026,psabud027,
               psabud028,psabud029,psabud030,psab010,psab011,
               psab012,psab013
          INTO l_psab.psabent,l_psab.psabsite,l_psab.psabdocno,l_psab.psabseq,l_psab.psab001,
               l_psab.psab002,l_psab.psab003,l_psab.psab004,l_psab.psab005,l_psab.psab006,
               l_psab.psab007,l_psab.psab008,l_psab.psab009,l_psab.psabud001,l_psab.psabud002,
               l_psab.psabud003,l_psab.psabud004,l_psab.psabud005,l_psab.psabud006,l_psab.psabud007,
               l_psab.psabud008,l_psab.psabud009,l_psab.psabud010,l_psab.psabud011,l_psab.psabud012,
               l_psab.psabud013,l_psab.psabud014,l_psab.psabud015,l_psab.psabud016,l_psab.psabud017,
               l_psab.psabud018,l_psab.psabud019,l_psab.psabud020,l_psab.psabud021,l_psab.psabud022,
               l_psab.psabud023,l_psab.psabud024,l_psab.psabud025,l_psab.psabud026,l_psab.psabud027,
               l_psab.psabud028,l_psab.psabud029,l_psab.psabud030,l_psab.psab010,l_psab.psab011,
               l_psab.psab012,l_psab.psab013
         #161109-00085#66 --e add
          FROM psaa_t,psab_t 
         WHERE psaaent=psabent AND psaadocno=psabdocno
           AND psabent=g_enterprise AND psabsite=g_site
           AND psabdocno=g_sfaa_m.sfaa006 AND psabseq=g_sfaa_m.sfaa007
 
        #此筆工單原始數量
        SELECT sfaa012 INTO l_sfaa012 FROM sfaa_t
         WHERE sfaaent=g_enterprise AND sfaasite=g_site AND sfaadocno=g_sfaa_m.sfaadocno
        IF cl_null(l_sfaa012) THEN LET l_sfaa012 = 0 END IF
        #add--151207-00017#2 By shiun--(S)
        #剩餘數量計算 
        LET l_qty = l_psab.psab005 - l_psab.psab006
        #add--151207-00017#2 By shiun--(E)
        #modify--151207-00017#2 By shiun--(S)
        #對數量進行不同單位的換算
#        CALL s_aooi250_convert_qty(g_sfaa_m.sfaa010,l_psab.psab004,g_sfaa_m.sfaa013,l_psab.psab006)
#             RETURNING l_success,l_psab.psab006
        CALL s_aooi250_convert_qty(g_sfaa_m.sfaa010,l_psab.psab004,g_sfaa_m.sfaa013,l_qty)
             RETURNING l_success,l_qty
       #160119-00004#1 add str       
        #數量加上生產損耗率
        LET l_qty = l_qty * (1 + l_imae015 / 100)
       #160119-00004#1 add end             
        #以開工單計算
        CALL asft300_sfaa006_chk_qty(g_sfaa_m.sfaa006,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa013)
             RETURNING l_sum
        #這次輸入的數量>已耗數量-本次轉開工單量+他筆資料中相同單號&項次的生產數量
#        IF g_sfaa_m.sfaa012 > l_psab.psab006 - l_sum + l_sfaa012 THEN
        IF g_sfaa_m.sfaa012 > l_qty - l_sum + l_sfaa012 THEN
        #modify--151207-00017#2 By shiun--(E)
           INITIALIZE g_errparam TO NULL
           LET g_errparam.code = 'asf-00337'
           LET g_errparam.extend = ''
           LET g_errparam.popup = TRUE
           CALL cl_err()
           RETURN FALSE
        END IF
     END IF
  END IF
  #dorislai-20150710-add----(E)
  #add--151207-00017#2 By shiun--(S)
  IF g_sfaa_m.sfaa005 = '7' THEN
     IF NOT cl_null(g_sfaa_m.sfaa006) AND NOT cl_null(g_sfaa_m.sfaa007) THEN

        #161109-00085#27-s
        #SELECT psad_t.* INTO l_psad.* FROM psac_t,psad_t
        #161109-00085#66 --s mark
        #SELECT psadent,psadsite,psaddocno,psadseq,psad001,psad002,psad003,psad004,psad005,psad006,
        #       psad007,psad008,psad009,psad010
        #  INTO l_psad.psadent,l_psad.psadsite,l_psad.psaddocno,l_psad.psadseq,l_psad.psad001,
        #       l_psad.psad002,l_psad.psad003,l_psad.psad004,l_psad.psad005,l_psad.psad006,
        #       l_psad.psad007,l_psad.psad008,l_psad.psad009,l_psad.psad010
        #161109-00085#66 --e mark
        #161109-00085#66 --s add
        SELECT psadent,psadsite,psaddocno,psadseq,psad001,
               psad002,psad003,psad004,psad005,psad006,
               psad007,psad008,psad009,psadud001,psadud002,
               psadud003,psadud004,psadud005,psadud006,psadud007,
               psadud008,psadud009,psadud010,psadud011,psadud012,
               psadud013,psadud014,psadud015,psadud016,psadud017,
               psadud018,psadud019,psadud020,psadud021,psadud022,
               psadud023,psadud024,psadud025,psadud026,psadud027,
               psadud028,psadud029,psadud030,psad010
          INTO l_psad.psadent,l_psad.psadsite,l_psad.psaddocno,l_psad.psadseq,l_psad.psad001,
               l_psad.psad002,l_psad.psad003,l_psad.psad004,l_psad.psad005,l_psad.psad006,
               l_psad.psad007,l_psad.psad008,l_psad.psad009,l_psad.psadud001,l_psad.psadud002,
               l_psad.psadud003,l_psad.psadud004,l_psad.psadud005,l_psad.psadud006,l_psad.psadud007,
               l_psad.psadud008,l_psad.psadud009,l_psad.psadud010,l_psad.psadud011,l_psad.psadud012,
               l_psad.psadud013,l_psad.psadud014,l_psad.psadud015,l_psad.psadud016,l_psad.psadud017,
               l_psad.psadud018,l_psad.psadud019,l_psad.psadud020,l_psad.psadud021,l_psad.psadud022,
               l_psad.psadud023,l_psad.psadud024,l_psad.psadud025,l_psad.psadud026,l_psad.psadud027,
               l_psad.psadud028,l_psad.psadud029,l_psad.psadud030,l_psad.psad010
        #161109-00085#66 --e add
          FROM psac_t,psad_t               
        #161109-00085#27-e  
         WHERE psacent=psadent AND psacdocno=psaddocno
           AND psadent=g_enterprise AND psadsite=g_site
           AND psaddocno=g_sfaa_m.sfaa006 AND psadseq=g_sfaa_m.sfaa007 AND psad008 = 'N'
 
        #此筆工單原始數量
        SELECT sfaa012 INTO l_sfaa012 FROM sfaa_t
         WHERE sfaaent=g_enterprise AND sfaasite=g_site AND sfaadocno=g_sfaa_m.sfaadocno
        IF cl_null(l_sfaa012) THEN LET l_sfaa012 = 0 END IF
        #add--151207-00017#2 By shiun--(S)
        LET l_qty = l_psad.psad005 - l_psad.psad006
        #add--151207-00017#2 By shiun--(E)
        #modify--151207-00017#2 By shiun--(S)
        #對數量進行不同單位的換算
#        CALL s_aooi250_convert_qty(g_sfaa_m.sfaa010,l_psad.psad004,g_sfaa_m.sfaa013,l_psad.psad006)
#             RETURNING l_success,l_psad.psad006
        CALL s_aooi250_convert_qty(g_sfaa_m.sfaa010,l_psad.psad004,g_sfaa_m.sfaa013,l_qty)
             RETURNING l_success,l_qty
       #160119-00004#1 add str       
        #數量加上生產損耗率
        LET l_qty = l_qty * (1 + l_imae015 / 100)
       #160119-00004#1 add end 
        #以開工單計算
        CALL asft300_sfaa006_chk_qty(g_sfaa_m.sfaa006,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa013)
             RETURNING l_sum
        #這次輸入的數量>已耗數量-本次轉開工單量+他筆資料中相同單號&項次的生產數量
#        IF g_sfaa_m.sfaa012 > l_psad.psad006 - l_sum + l_sfaa012 THEN
        IF g_sfaa_m.sfaa012 > l_qty - l_sum + l_sfaa012 THEN
        #modify--151207-00017#2 By shiun--(E)
           INITIALIZE g_errparam TO NULL
           LET g_errparam.code = 'asf-00337'
           LET g_errparam.extend = ''
           LET g_errparam.popup = TRUE
           CALL cl_err()
           RETURN FALSE
        END IF
     END IF
  END IF
  #add--151207-00017#2 By shiun--(E)
  RETURN TRUE
END FUNCTION

#根据标准应发量重新算QPA
PRIVATE FUNCTION asft300_sfba023_qpa(p_sfba023)
DEFINE p_sfba023         LIKE sfba_t.sfba023
DEFINE r_sfba010         LIKE sfba_t.sfba010
DEFINE r_sfba011         LIKE sfba_t.sfba011
DEFINE l_num1            LIKE sfaa_t.sfaa012
DEFINE l_num2            LIKE sfaa_t.sfaa012
DEFINE l_num1_t          LIKE type_t.num20
DEFINE l_num2_t          LIKE type_t.num20
DEFINE l_j               LIKE type_t.num10
DEFINE l_k               LIKE type_t.num10

   LET l_num1 = g_sfaa_m.sfaa012
   LET l_num2 = p_sfba023
   LET l_num1_t = l_num1
   LET l_num2_t = l_num2
  #WHILE TRUE           #mark 150723
     #存在小数情况           
     IF l_num1 = l_num1_t AND l_num2 = l_num2_t THEN
       #150723
       #EXIT WHILE
        #QPA分子分母约分计算
        IF l_num1 < l_num2 THEN
           LET l_j = l_num1_t
        ELSE
           LET l_j = l_num2_t
        END IF
        FOR l_k = l_j TO 1 STEP -1
           IF (l_num1_t MOD l_k = 0) AND (l_num2_t MOD l_k = 0) THEN
              EXIT FOR
           END IF
        END FOR
        
        LET r_sfba010 = l_num2_t / l_k
        LET r_sfba011 = l_num1_t / l_k
       #150723
     ELSE
       #150723
       #LET l_num1 = l_num1 * 10
       #LET l_num1_t = l_num1
       #LET l_num2 = l_num2 * 10
       #LET l_num2_t = l_num2
       #CONTINUE WHILE
        LET r_sfba010 = l_num2
        LET r_sfba011 = l_num1
       #150723
     END IF
  #END WHILE     #mark 150723
  #mark 150723    
  ##QPA分子分母约分计算
  #IF l_num1 < l_num2 THEN
  #   LET l_j = l_num1_t
  #ELSE
  #   LET l_j = l_num2_t
  #END IF
  #FOR l_k = l_j TO 1 STEP -1
  #   IF (l_num1_t MOD l_k = 0) AND (l_num2_t MOD l_k = 0) THEN
  #      EXIT FOR
  #   END IF
  #END FOR
  #
  #LET r_sfba010 = l_num2_t / l_k
  #LET r_sfba011 = l_num1_t / l_k
  #mark 150723
   RETURN r_sfba010,r_sfba011
END FUNCTION

#生产料号做特征管理相关处理逻辑
PRIVATE FUNCTION asft300_sfaa010_feature()
DEFINE l_imaa005         LIKE imaa_t.imaa005
DEFINE l_success         LIKE type_t.num5
DEFINE r_success         LIKE type_t.num5
DEFINE l_i               LIKE type_t.num5
DEFINE l_imae017         LIKE imae_t.imae017
DEFINE l_imae018         LIKE imae_t.imae018
DEFINE l_imae019         LIKE imae_t.imae019
DEFINE l_sfaa012         LIKE sfaa_t.sfaa012
DEFINE l_n_sfaa012       LIKE type_t.num20
DEFINE l_msg             STRING

   LET r_success = TRUE
   CALL g_inam.clear() 
   
   SELECT imaa005 INTO l_imaa005 FROM imaa_t WHERE imaaent = g_enterprise AND imaa001 = g_sfaa_m.sfaa010
   IF cl_null(l_imaa005) THEN
      RETURN r_success
   END IF
            
   CALL s_feature_multi(g_sfaa_m.sfaa010,'','',g_site,g_sfaa_m.sfaadocno) RETURNING l_success,g_inam
   IF NOT l_success THEN
      LET r_success = FALSE
      RETURN r_success
   END IF
   LET g_inam004_sum = 0 
   FOR l_i = 1 TO g_inam.getLength()
      IF cl_null(g_inam[l_i].inam001) THEN
         EXIT FOR
      END IF
      LET g_inam004_sum = g_inam004_sum + g_inam[l_i].inam004
   END FOR
   LET g_sfaa_m.sfaa012 = g_inam004_sum 
   
   LET l_sfaa012 = g_sfaa_m.sfaa012
   SELECT imae017,imae018,imae019 INTO l_imae017,l_imae018,l_imae019 FROM imae_t
    WHERE imaeent = g_enterprise AND imaesite = g_site AND imae001 = g_sfaa_m.sfaa010
   IF NOT cl_null(l_imae018) THEN
      IF g_sfaa_m.sfaa012 < l_imae018 THEN
         LET l_sfaa012 = l_imae018
      ELSE
         LET l_sfaa012 = g_sfaa_m.sfaa012
      END IF
   ELSE
      LET l_sfaa012 = g_sfaa_m.sfaa012
   END IF
   
   IF NOT cl_null(l_imae017) AND l_imae017 != 0 THEN
      LET l_n_sfaa012 = l_sfaa012 / l_imae017
      IF l_sfaa012  != l_imae017 * l_n_sfaa012 THEN
         IF l_sfaa012 > l_imae017 * l_n_sfaa012 THEN
            LET l_sfaa012 = l_imae017 * (l_n_sfaa012 + 1)
         ELSE
            LET l_sfaa012 = l_imae017 * l_n_sfaa012
         END IF
      END IF
 # ELSE
 #    LET l_sfaa012 = g_sfaa_m.sfaa012
   END IF
   
   IF l_sfaa012 != g_sfaa_m.sfaa012 AND NOT cl_null(l_imae019) AND l_imae019 != '3' THEN
      IF l_imae019 = '1' THEN
         LET l_msg = cl_getmsg('asf-00332',g_lang),l_sfaa012 USING '---,---,---,--&.&&&'
         IF cl_ask_promp(l_msg) THEN
            IF asft300_sfaa010_feature() THEN
            END IF
         END IF
      END IF
      IF l_imae019 = '2' THEN
         LET l_msg = cl_getmsg('asf-00452',g_lang),l_sfaa012 USING '---,---,---,--&.&&&'
         IF cl_ask_promp(l_msg) THEN
            IF asft300_sfaa010_feature() THEN
            END IF
         ELSE
            LET r_success = FALSE
            RETURN r_success
         END IF
      END IF
   END IF
   
   DISPLAY BY NAME g_sfaa_m.sfaa012
   
   RETURN r_success
   
END FUNCTION

#訂單轉工單，要將訂單單身的長備註，轉到工單單頭的備註
PRIVATE FUNCTION asft300_gen_bz()
#161109-00085#27-s
#DEFINE l_sfab                RECORD LIKE sfab_t.*
DEFINE l_sfab RECORD  #工單來源檔
       sfabent LIKE sfab_t.sfabent, #企業編號
       sfabsite LIKE sfab_t.sfabsite, #營運據點
       sfabdocno LIKE sfab_t.sfabdocno, #單號
       sfab001 LIKE sfab_t.sfab001, #來源
       sfab002 LIKE sfab_t.sfab002, #來源單號
       sfab003 LIKE sfab_t.sfab003, #來源項次
       sfab004 LIKE sfab_t.sfab004, #來源項序
       sfab005 LIKE sfab_t.sfab005, #分批序
       sfab006 LIKE sfab_t.sfab006, #分配優先序
       sfab007 LIKE sfab_t.sfab007, #本次轉開工單量
      #sfabseq LIKE sfab_t.sfabseq  #項次 #161109-00085#66 mark
       #161109-00085#66 --s add
       sfabseq LIKE sfab_t.sfabseq, #項次
       sfabud001 LIKE sfab_t.sfabud001, #自定義欄位(文字)001
       sfabud002 LIKE sfab_t.sfabud002, #自定義欄位(文字)002
       sfabud003 LIKE sfab_t.sfabud003, #自定義欄位(文字)003
       sfabud004 LIKE sfab_t.sfabud004, #自定義欄位(文字)004
       sfabud005 LIKE sfab_t.sfabud005, #自定義欄位(文字)005
       sfabud006 LIKE sfab_t.sfabud006, #自定義欄位(文字)006
       sfabud007 LIKE sfab_t.sfabud007, #自定義欄位(文字)007
       sfabud008 LIKE sfab_t.sfabud008, #自定義欄位(文字)008
       sfabud009 LIKE sfab_t.sfabud009, #自定義欄位(文字)009
       sfabud010 LIKE sfab_t.sfabud010, #自定義欄位(文字)010
       sfabud011 LIKE sfab_t.sfabud011, #自定義欄位(數字)011
       sfabud012 LIKE sfab_t.sfabud012, #自定義欄位(數字)012
       sfabud013 LIKE sfab_t.sfabud013, #自定義欄位(數字)013
       sfabud014 LIKE sfab_t.sfabud014, #自定義欄位(數字)014
       sfabud015 LIKE sfab_t.sfabud015, #自定義欄位(數字)015
       sfabud016 LIKE sfab_t.sfabud016, #自定義欄位(數字)016
       sfabud017 LIKE sfab_t.sfabud017, #自定義欄位(數字)017
       sfabud018 LIKE sfab_t.sfabud018, #自定義欄位(數字)018
       sfabud019 LIKE sfab_t.sfabud019, #自定義欄位(數字)019
       sfabud020 LIKE sfab_t.sfabud020, #自定義欄位(數字)020
       sfabud021 LIKE sfab_t.sfabud021, #自定義欄位(日期時間)021
       sfabud022 LIKE sfab_t.sfabud022, #自定義欄位(日期時間)022
       sfabud023 LIKE sfab_t.sfabud023, #自定義欄位(日期時間)023
       sfabud024 LIKE sfab_t.sfabud024, #自定義欄位(日期時間)024
       sfabud025 LIKE sfab_t.sfabud025, #自定義欄位(日期時間)025
       sfabud026 LIKE sfab_t.sfabud026, #自定義欄位(日期時間)026
       sfabud027 LIKE sfab_t.sfabud027, #自定義欄位(日期時間)027
       sfabud028 LIKE sfab_t.sfabud028, #自定義欄位(日期時間)028
       sfabud029 LIKE sfab_t.sfabud029, #自定義欄位(日期時間)029
       sfabud030 LIKE sfab_t.sfabud030  #自定義欄位(日期時間)030
       #161109-00085#66 --e add
END RECORD
#161109-00085#27-e

DEFINE l_ooff013_1           LIKE ooff_t.ooff013
DEFINE l_ooff013_2           LIKE ooff_t.ooff013
DEFINE l_ooff013_3           LIKE ooff_t.ooff013
DEFINE l_ooff013             LIKE ooff_t.ooff013
DEFINE l_success             LIKE type_t.num5
   
   #工单备注已经有值时，不覆盖
   #161031-00025#17-s mark
#   IF NOT cl_null(g_sfaa_m.ooff013) THEN
#      RETURN 
#   END IF
   #161031-00025#17-e mark 
   #订单的单身长备注设置为ooff015='Y'(内部信息传递)时,要把订单长备注带至工单备注中
   #仅当sfab001='2'(订单）,sfab002(来源单号),sfab003(来源项次)有具体值时,才处理
   DECLARE asft300_gen_bz_cs CURSOR FOR
   #161109-00085#27-s
    #SELECT * FROM sfab_t
    #SELECT sfabent,sfabsite,sfabdocno,sfab001,sfab002,sfab003,sfab004,sfab005,sfab006,sfab007,sfabseq #161109-00085#66 mark
    #161109-00085#66 --s add
    SELECT sfabent,sfabsite,sfabdocno,sfab001,sfab002,
           sfab003,sfab004,sfab005,sfab006,sfab007,
           sfabseq,sfabud001,sfabud002,sfabud003,sfabud004,
           sfabud005,sfabud006,sfabud007,sfabud008,sfabud009,
           sfabud010,sfabud011,sfabud012,sfabud013,sfabud014,
           sfabud015,sfabud016,sfabud017,sfabud018,sfabud019,
           sfabud020,sfabud021,sfabud022,sfabud023,sfabud024,
           sfabud025,sfabud026,sfabud027,sfabud028,sfabud029,
           sfabud030
    #161109-00085#66 --e add    
      FROM sfab_t
     WHERE sfabent = g_enterprise AND sfabsite = g_site
       AND sfabdocno = g_sfaa_m.sfaadocno AND sfab001 = '2'
   #FOREACH asft300_gen_bz_cs INTO l_sfab.*
   FOREACH asft300_gen_bz_cs 
   #161109-00085#66 --s mark
   #   INTO l_sfab.sfabent,l_sfab.sfabsite,l_sfab.sfabdocno,l_sfab.sfab001,l_sfab.sfab002,
   #        l_sfab.sfab003,l_sfab.sfab004,l_sfab.sfab005,l_sfab.sfab006,l_sfab.sfab007,
   #        l_sfab.sfabseq 
   #161109-00085#66 --e mark
   #161109-00085#66 --s add
      INTO l_sfab.sfabent,l_sfab.sfabsite,l_sfab.sfabdocno,l_sfab.sfab001,l_sfab.sfab002,
           l_sfab.sfab003,l_sfab.sfab004,l_sfab.sfab005,l_sfab.sfab006,l_sfab.sfab007,
           l_sfab.sfabseq,l_sfab.sfabud001,l_sfab.sfabud002,l_sfab.sfabud003,l_sfab.sfabud004,
           l_sfab.sfabud005,l_sfab.sfabud006,l_sfab.sfabud007,l_sfab.sfabud008,l_sfab.sfabud009,
           l_sfab.sfabud010,l_sfab.sfabud011,l_sfab.sfabud012,l_sfab.sfabud013,l_sfab.sfabud014,
           l_sfab.sfabud015,l_sfab.sfabud016,l_sfab.sfabud017,l_sfab.sfabud018,l_sfab.sfabud019,
           l_sfab.sfabud020,l_sfab.sfabud021,l_sfab.sfabud022,l_sfab.sfabud023,l_sfab.sfabud024,
           l_sfab.sfabud025,l_sfab.sfabud026,l_sfab.sfabud027,l_sfab.sfabud028,l_sfab.sfabud029,
           l_sfab.sfabud030
   #161109-00085#66 --e add
   #161109-00085#27-e
      IF NOT cl_null(l_sfab.sfab002) AND NOT cl_null(l_sfab.sfab003) THEN
         SELECT ooff013 INTO l_ooff013_1 FROM ooff_t
          WHERE ooffent = g_enterprise
            AND ooff001 = '7'
            AND ooff002 = l_sfab.sfab002
            AND ooff003 = l_sfab.sfab003
            AND ooff012 = '1'
            AND ooff015 = 'Y'
      
         SELECT ooff013 INTO l_ooff013_2 FROM ooff_t
          WHERE ooffent = g_enterprise
            AND ooff001 = '7'
            AND ooff002 = l_sfab.sfab002
             AND ooff003 = l_sfab.sfab003
             AND ooff012 = '2'
             AND ooff015 = 'Y'

          SELECT ooff013 INTO l_ooff013_3 FROM ooff_t
           WHERE ooffent = g_enterprise
             AND ooff001 = '7'
             AND ooff002 = l_sfab.sfab002
             AND ooff003 = l_sfab.sfab003
             AND ooff012 = '4'
             AND ooff015 = 'Y'

          LET l_ooff013 = ''
          IF NOT cl_null(l_ooff013_1) THEN
             LET l_ooff013 = l_ooff013_1
          END IF
          
          IF NOT cl_null(l_ooff013_2) THEN
             IF NOT cl_null(l_ooff013) THEN
                LET l_ooff013 = l_ooff013 CLIPPED,'\n',l_ooff013_2
             ELSE
                LET l_ooff013 = l_ooff013_2
             END IF
          END IF

          IF NOT cl_null(l_ooff013_3) THEN
             IF NOT cl_null(l_ooff013) THEN
                LET l_ooff013 = l_ooff013 CLIPPED,'\n',l_ooff013_3
             ELSE
                LET l_ooff013 = l_ooff013_3
             END IF
          END IF

          IF NOT cl_null(l_ooff013) THEN
             CALL s_aooi360_gen('6',g_sfaa_m.sfaadocno,' ',' ',' ',' ',' ',' ',' ',' ',' ','2',l_ooff013)
                  RETURNING l_success
          END IF
       END IF
    END FOREACH
END FUNCTION

#工单转委外
PRIVATE FUNCTION asft300_sub_po()
#161109-00085#27-s
#DEFINE l_sfcb           RECORD LIKE sfcb_t.*
DEFINE l_sfcb RECORD  #工單製程單身檔
       sfcbent LIKE sfcb_t.sfcbent, #企業編號
       sfcbsite LIKE sfcb_t.sfcbsite, #營運據點
       sfcbdocno LIKE sfcb_t.sfcbdocno, #單號
       sfcb001 LIKE sfcb_t.sfcb001, #RUN CARD
       sfcb002 LIKE sfcb_t.sfcb002, #項次
       sfcb003 LIKE sfcb_t.sfcb003, #本站作業
       sfcb004 LIKE sfcb_t.sfcb004, #作業序
       sfcb005 LIKE sfcb_t.sfcb005, #群組性質
       sfcb006 LIKE sfcb_t.sfcb006, #群組
       sfcb007 LIKE sfcb_t.sfcb007, #上站作業
       sfcb008 LIKE sfcb_t.sfcb008, #上站作業序
       sfcb009 LIKE sfcb_t.sfcb009, #下站作業
       sfcb010 LIKE sfcb_t.sfcb010, #下站作業序
       sfcb011 LIKE sfcb_t.sfcb011, #工作站
       sfcb012 LIKE sfcb_t.sfcb012, #允許委外
       sfcb013 LIKE sfcb_t.sfcb013, #主要加工廠
       sfcb014 LIKE sfcb_t.sfcb014, #Move in
       sfcb015 LIKE sfcb_t.sfcb015, #Check in
       sfcb016 LIKE sfcb_t.sfcb016, #報工站
       sfcb017 LIKE sfcb_t.sfcb017, #PQC
       sfcb018 LIKE sfcb_t.sfcb018, #Check out
       sfcb019 LIKE sfcb_t.sfcb019, #Move out
       sfcb020 LIKE sfcb_t.sfcb020, #轉出單位
       sfcb021 LIKE sfcb_t.sfcb021, #單位轉換率分子
       sfcb022 LIKE sfcb_t.sfcb022, #單位轉換率分母
       sfcb023 LIKE sfcb_t.sfcb023, #固定工時
       sfcb024 LIKE sfcb_t.sfcb024, #標準工時
       sfcb025 LIKE sfcb_t.sfcb025, #固定機時
       sfcb026 LIKE sfcb_t.sfcb026, #標準機時
       sfcb027 LIKE sfcb_t.sfcb027, #標準產出量
       sfcb028 LIKE sfcb_t.sfcb028, #良品轉入
       sfcb029 LIKE sfcb_t.sfcb029, #重工轉入
       sfcb030 LIKE sfcb_t.sfcb030, #回收轉入
       sfcb031 LIKE sfcb_t.sfcb031, #分割轉入
       sfcb032 LIKE sfcb_t.sfcb032, #合併轉入
       sfcb033 LIKE sfcb_t.sfcb033, #良品轉出
       sfcb034 LIKE sfcb_t.sfcb034, #重工轉出
       sfcb035 LIKE sfcb_t.sfcb035, #回收轉出
       sfcb036 LIKE sfcb_t.sfcb036, #當站報廢
       sfcb037 LIKE sfcb_t.sfcb037, #當站下線
       sfcb038 LIKE sfcb_t.sfcb038, #分割轉出
       sfcb039 LIKE sfcb_t.sfcb039, #合併轉出
       sfcb040 LIKE sfcb_t.sfcb040, #Bonus
       sfcb041 LIKE sfcb_t.sfcb041, #委外加工數
       sfcb042 LIKE sfcb_t.sfcb042, #委外完工數
       sfcb043 LIKE sfcb_t.sfcb043, #盤點數
       sfcb044 LIKE sfcb_t.sfcb044, #預計開工日
       sfcb045 LIKE sfcb_t.sfcb045, #預計完工日
       sfcb046 LIKE sfcb_t.sfcb046, #待Move in數
       sfcb047 LIKE sfcb_t.sfcb047, #待Check in數
       sfcb048 LIKE sfcb_t.sfcb048, #待Check out數
       sfcb049 LIKE sfcb_t.sfcb049, #待Move out數
       sfcb050 LIKE sfcb_t.sfcb050, #在製數
       sfcb051 LIKE sfcb_t.sfcb051, #待PQC數
       sfcb052 LIKE sfcb_t.sfcb052, #轉入單位
       sfcb053 LIKE sfcb_t.sfcb053, #轉入單位轉換率分子
       sfcb054 LIKE sfcb_t.sfcb054, #轉入單位轉換率分母
       #sfcb055 LIKE sfcb_t.sfcb055  #回收站 #161109-00085#66 mark
       #161109-00085#66 --s add
       sfcb055 LIKE sfcb_t.sfcb055, #回收站
       sfcbud001 LIKE sfcb_t.sfcbud001, #自定義欄位(文字)001
       sfcbud002 LIKE sfcb_t.sfcbud002, #自定義欄位(文字)002
       sfcbud003 LIKE sfcb_t.sfcbud003, #自定義欄位(文字)003
       sfcbud004 LIKE sfcb_t.sfcbud004, #自定義欄位(文字)004
       sfcbud005 LIKE sfcb_t.sfcbud005, #自定義欄位(文字)005
       sfcbud006 LIKE sfcb_t.sfcbud006, #自定義欄位(文字)006
       sfcbud007 LIKE sfcb_t.sfcbud007, #自定義欄位(文字)007
       sfcbud008 LIKE sfcb_t.sfcbud008, #自定義欄位(文字)008
       sfcbud009 LIKE sfcb_t.sfcbud009, #自定義欄位(文字)009
       sfcbud010 LIKE sfcb_t.sfcbud010, #自定義欄位(文字)010
       sfcbud011 LIKE sfcb_t.sfcbud011, #自定義欄位(數字)011
       sfcbud012 LIKE sfcb_t.sfcbud012, #自定義欄位(數字)012
       sfcbud013 LIKE sfcb_t.sfcbud013, #自定義欄位(數字)013
       sfcbud014 LIKE sfcb_t.sfcbud014, #自定義欄位(數字)014
       sfcbud015 LIKE sfcb_t.sfcbud015, #自定義欄位(數字)015
       sfcbud016 LIKE sfcb_t.sfcbud016, #自定義欄位(數字)016
       sfcbud017 LIKE sfcb_t.sfcbud017, #自定義欄位(數字)017
       sfcbud018 LIKE sfcb_t.sfcbud018, #自定義欄位(數字)018
       sfcbud019 LIKE sfcb_t.sfcbud019, #自定義欄位(數字)019
       sfcbud020 LIKE sfcb_t.sfcbud020, #自定義欄位(數字)020
       sfcbud021 LIKE sfcb_t.sfcbud021, #自定義欄位(日期時間)021
       sfcbud022 LIKE sfcb_t.sfcbud022, #自定義欄位(日期時間)022
       sfcbud023 LIKE sfcb_t.sfcbud023, #自定義欄位(日期時間)023
       sfcbud024 LIKE sfcb_t.sfcbud024, #自定義欄位(日期時間)024
       sfcbud025 LIKE sfcb_t.sfcbud025, #自定義欄位(日期時間)025
       sfcbud026 LIKE sfcb_t.sfcbud026, #自定義欄位(日期時間)026
       sfcbud027 LIKE sfcb_t.sfcbud027, #自定義欄位(日期時間)027
       sfcbud028 LIKE sfcb_t.sfcbud028, #自定義欄位(日期時間)028
       sfcbud029 LIKE sfcb_t.sfcbud029, #自定義欄位(日期時間)029
       sfcbud030 LIKE sfcb_t.sfcbud030  #自定義欄位(日期時間)030
       #161109-00085#66 --e add
END RECORD
#161109-00085#27-e

DEFINE l_n              LIKE type_t.num5
DEFINE l_i              LIKE type_t.num5
DEFINE l_doc_type       LIKE ooba_t.ooba002     
DEFINE l_date           LIKE type_t.dat    
DEFINE l_combine        LIKE type_t.chr1   
DEFINE l_begin_no       LIKE pmdl_t.pmdldocno   
DEFINE l_end_no         LIKE pmdl_t.pmdldocno
DEFINE l_success        LIKE type_t.num5
DEFINE l_choice         LIKE type_t.num5
DEFINE la_param         RECORD
                        prog   STRING,
                        param  DYNAMIC ARRAY OF STRING
                        END RECORD
DEFINE ls_js            STRING
DEFINE l_j              LIKE type_t.num5
DEFINE l_k              LIKE type_t.num5
DEFINE l_l              LIKE type_t.num5
DEFINE l_flag           LIKE type_t.chr1
DEFINE l_pmdldocno      LIKE pmdl_t.pmdldocno
DEFINE l_pmdl_where     STRING

   #170307-00050#1 remove add --(S)--
   #已经存在工单对应委外采购单，则直接开启apmt501
   DECLARE asft300_sub_po_pmdl_cs CURSOR FOR
    SELECT pmdldocno FROM pmdl_t 
     WHERE pmdlent = g_enterprise AND pmdlsite = g_site
       AND pmdl005 = '2' AND pmdl007 = '4' AND pmdl008 = g_sfaa_m.sfaadocno
       AND pmdlstus != 'X'
   FOREACH asft300_sub_po_pmdl_cs INTO l_pmdldocno
      IF cl_null(l_pmdl_where) THEN
         LET l_pmdl_where = "'",l_pmdldocno,"'"
      ELSE
         LET l_pmdl_where = l_pmdl_where,",","'",l_pmdldocno,"'"
      END IF
   END FOREACH
   IF NOT cl_null(l_pmdl_where) THEN
      LET la_param.prog     = "apmt501"
      LET la_param.param[1] = ''
      LET la_param.param[2] = " 1=1 AND pmdldocno IN(",l_pmdl_where,")"    
      LET ls_js = util.JSON.stringify( la_param )
      CALL cl_cmdrun(ls_js)
      RETURN
   END IF
   #170307-00050#1 remove add --(E)-- 

  #原來判斷已發出的狀態才可開委外採購單,須改為判斷F.已發出/C.結案/M.成本結案三者其中之一才可開委外採購單
  #IF g_sfaa_m.sfaastus != 'Y' AND g_sfaa_m.sfaastus != 'F' THEN
 #IF NOT (g_sfaa_m.sfaastus = 'F' OR g_sfaa_m.sfaastus = 'C' OR g_sfaa_m.sfaastus = 'M') THEN   #20150914 mod by Sarah   #170307-00050#1 mark
   IF g_sfaa_m.sfaastus != 'F' THEN    #170307-00050#1 add #調整只有已發出的工單才可轉委外工單
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = g_sfaa_m.sfaadocno
      LET g_errparam.code   = 'asf-00444'      
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN
   END IF
   
   SELECT COUNT(1) INTO l_n FROM sfcb_t 
    WHERE sfcbent = g_enterprise AND sfcbsite = g_site
      AND sfcbdocno = g_sfaa_m.sfaadocno AND sfcb012 = 'Y'
   IF l_n = 0 AND g_sfaa_m.sfaa057 != '2' THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = g_sfaa_m.sfaadocno
      LET g_errparam.code   = 'asf-00445'      
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN
   END IF

   #170325-00098#1 add --(S)--
   #若製程工單委外製程是二個以上(包含二個)的委外廠商，需由asfp400產生委外採購單
   IF g_sfaa_m.sfaa061 = 'Y' THEN
      LET l_n = 0
   
      SELECT COUNT(DISTINCT sfcb013) INTO l_n FROM sfcb_t 
       WHERE sfcbent = g_enterprise AND sfcbsite = g_site
         AND sfcbdocno = g_sfaa_m.sfaadocno AND sfcb012 = 'Y' 
         AND (sfcb013 is not null OR sfcb013 <> '') 
      
      IF cl_null(l_n) THEN LET l_n = 0 END IF
    
      IF l_n >= 2 THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = g_sfaa_m.sfaadocno
         LET g_errparam.code   = 'asf-00847'      
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         RETURN
      END IF   
   END IF
   #170325-00098#1 add --(E)--
   
  #170307-00050#1 mark --(S)--
  ##已经存在工单对应委外采购单，则直接开启apmt501
  #DECLARE asft300_sub_po_pmdl_cs CURSOR FOR
  # SELECT pmdldocno FROM pmdl_t 
  #  WHERE pmdlent = g_enterprise AND pmdlsite = g_site
  #    AND pmdl005 = '2' AND pmdl007 = '4' AND pmdl008 = g_sfaa_m.sfaadocno
  #    AND pmdlstus != 'X'
  #FOREACH asft300_sub_po_pmdl_cs INTO l_pmdldocno
  #   IF cl_null(l_pmdl_where) THEN
  #      LET l_pmdl_where = "'",l_pmdldocno,"'"
  #   ELSE
  #      LET l_pmdl_where = l_pmdl_where,",","'",l_pmdldocno,"'"
  #   END IF
  #END FOREACH
  #IF NOT cl_null(l_pmdl_where) THEN
  #   LET la_param.prog     = "apmt501"
  #   LET la_param.param[1] = ''
  #   LET la_param.param[2] = " AND pmdldocno IN(",l_pmdl_where,")"      
  #   LET ls_js = util.JSON.stringify( la_param )
  #   CALL cl_cmdrun(ls_js)
  #   RETURN
  #END IF
  #170307-00050#1 mark --(E)-- 
   
   #可委外数大于0时才可委外
   #可委外數=標準產出數量(sfcb027)+重工轉入(sfcb029)+工單轉入(sfcb030)+分割轉入(sfcb031)+合併轉入(sfcb032)
   #        -良品轉出(sfcb033)-重工轉出(sfcb034)-工單轉出(sfcb035)-當站報廢(sfcb036)-當站下線(sfcb037)
   #        -分割轉出(sfcb038)-合併轉出(sfcb039)-委外數量(sfcb041)+委外完工數量(sfcb042) 
   SELECT COUNT(1) INTO l_n FROM sfcb_t 
    WHERE sfcbent = g_enterprise AND sfcbsite = g_site
      AND sfcbdocno = g_sfaa_m.sfaadocno
      AND sfcb012  = 'Y'  #160822-00039#1
      AND (sfcb027+sfcb029+sfcb030+sfcb031+sfcb032-sfcb033-sfcb034-sfcb035-sfcb036-sfcb037-sfcb038-sfcb039-sfcb041+sfcb042) > 0
   IF l_n = 0 THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = g_sfaa_m.sfaadocno
      LET g_errparam.code   = 'asf-00446'      
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN
   END IF  
   
   DECLARE asft300_sub_po CURSOR FOR
   #161109-00085#27-s
   #SELECT sfcb_t.* FROM sfaa_t,sfcb_t
   #161109-00085#66 --s mark
   #SELECT sfcbent,sfcbsite,sfcbdocno,sfcb001,sfcb002,sfcb003,sfcb004,sfcb005,sfcb006,sfcb007,
   #       sfcb008,sfcb009,sfcb010,sfcb011,sfcb012,sfcb013,sfcb014,sfcb015,sfcb016,sfcb017,
   #       sfcb018,sfcb019,sfcb020,sfcb021,sfcb022,sfcb023,sfcb024,sfcb025,sfcb026,sfcb027,
   #       sfcb028,sfcb029,sfcb030,sfcb031,sfcb032,sfcb033,sfcb034,sfcb035,sfcb036,sfcb037,
   #       sfcb038,sfcb039,sfcb040,sfcb041,sfcb042,sfcb043,sfcb044,sfcb045,sfcb046,sfcb047,
   #       sfcb048,sfcb049,sfcb050,sfcb051,sfcb052,sfcb053,sfcb054,sfcb055
   #161109-00085#66 --e mark
   #161109-00085#66 --s add
   SELECT sfcbent,sfcbsite,sfcbdocno,sfcb001,sfcb002,
          sfcb003,sfcb004,sfcb005,sfcb006,sfcb007,
          sfcb008,sfcb009,sfcb010,sfcb011,sfcb012,
          sfcb013,sfcb014,sfcb015,sfcb016,sfcb017,
          sfcb018,sfcb019,sfcb020,sfcb021,sfcb022,
          sfcb023,sfcb024,sfcb025,sfcb026,sfcb027,
          sfcb028,sfcb029,sfcb030,sfcb031,sfcb032,
          sfcb033,sfcb034,sfcb035,sfcb036,sfcb037,
          sfcb038,sfcb039,sfcb040,sfcb041,sfcb042,
          sfcb043,sfcb044,sfcb045,sfcb046,sfcb047,
          sfcb048,sfcb049,sfcb050,sfcb051,sfcb052,
          sfcb053,sfcb054,sfcb055,sfcbud001,sfcbud002,
          sfcbud003,sfcbud004,sfcbud005,sfcbud006,sfcbud007,
          sfcbud008,sfcbud009,sfcbud010,sfcbud011,sfcbud012,
          sfcbud013,sfcbud014,sfcbud015,sfcbud016,sfcbud017,
          sfcbud018,sfcbud019,sfcbud020,sfcbud021,sfcbud022,
          sfcbud023,sfcbud024,sfcbud025,sfcbud026,sfcbud027,
          sfcbud028,sfcbud029,sfcbud030
   #161109-00085#66 --e add
     FROM sfaa_t,sfcb_t
   #161109-00085#27-e    
     WHERE sfaaent = sfcbent AND sfaasite = sfcbsite AND sfaadocno = sfcbdocno
       AND sfcbent = g_enterprise AND sfcbsite = g_site AND sfcbdocno = g_sfaa_m.sfaadocno 
      #160822-00039#1-s
      #AND (sfcb012  = 'Y' OR sfaa057 = '2')
      #160920-00028#1-s mod
      #AND sfcb012  = 'Y' AND sfaa057 = '1'    #160910-00001#1 mod sfaa057='2'->'1'
       AND ((sfcb012  = 'Y' AND sfaa057 = '1') OR sfaa057 = '2')
      #160920-00028#1-e mod
      #160822-00039#1-e
       AND (sfaastus = 'F' OR sfaastus = 'Y')
       AND (sfcb027+sfcb029+sfcb030+sfcb031+sfcb032-sfcb033-sfcb034-sfcb035-sfcb036-sfcb037-sfcb038-sfcb039-sfcb041+sfcb042) > 0
     ORDER BY sfcbdocno,sfcb001,sfcb002
     
   LET l_i = 1
   LET l_date = cl_get_today()   #2015/09/08 by stellar add
   #161109-00085#27-s
   #FOREACH asft300_sub_po INTO l_sfcb.*
   #161109-00085#66 --s mark
   #FOREACH asft300_sub_po INTO l_sfcb.sfcbent,l_sfcb.sfcbsite,l_sfcb.sfcbdocno,l_sfcb.sfcb001,l_sfcb.sfcb002,
   #                            l_sfcb.sfcb003,l_sfcb.sfcb004,l_sfcb.sfcb005,l_sfcb.sfcb006,l_sfcb.sfcb007,
   #                            l_sfcb.sfcb008,l_sfcb.sfcb009,l_sfcb.sfcb010,l_sfcb.sfcb011,l_sfcb.sfcb012,
   #                            l_sfcb.sfcb013,l_sfcb.sfcb014,l_sfcb.sfcb015,l_sfcb.sfcb016,l_sfcb.sfcb017,
   #                            l_sfcb.sfcb018,l_sfcb.sfcb019,l_sfcb.sfcb020,l_sfcb.sfcb021,l_sfcb.sfcb022,
   #                            l_sfcb.sfcb023,l_sfcb.sfcb024,l_sfcb.sfcb025,l_sfcb.sfcb026,l_sfcb.sfcb027,
   #                            l_sfcb.sfcb028,l_sfcb.sfcb029,l_sfcb.sfcb030,l_sfcb.sfcb031,l_sfcb.sfcb032,
   #                            l_sfcb.sfcb033,l_sfcb.sfcb034,l_sfcb.sfcb035,l_sfcb.sfcb036,l_sfcb.sfcb037,
   #                            l_sfcb.sfcb038,l_sfcb.sfcb039,l_sfcb.sfcb040,l_sfcb.sfcb041,l_sfcb.sfcb042,
   #                            l_sfcb.sfcb043,l_sfcb.sfcb044,l_sfcb.sfcb045,l_sfcb.sfcb046,l_sfcb.sfcb047,
   #                            l_sfcb.sfcb048,l_sfcb.sfcb049,l_sfcb.sfcb050,l_sfcb.sfcb051,l_sfcb.sfcb052,
   #                            l_sfcb.sfcb053,l_sfcb.sfcb054,l_sfcb.sfcb055
   #161109-00085#66 --e mark
   #161109-00085#27-e
   #161109-00085#66 --s add
   FOREACH asft300_sub_po INTO l_sfcb.sfcbent,l_sfcb.sfcbsite,l_sfcb.sfcbdocno,l_sfcb.sfcb001,l_sfcb.sfcb002,
                               l_sfcb.sfcb003,l_sfcb.sfcb004,l_sfcb.sfcb005,l_sfcb.sfcb006,l_sfcb.sfcb007,
                               l_sfcb.sfcb008,l_sfcb.sfcb009,l_sfcb.sfcb010,l_sfcb.sfcb011,l_sfcb.sfcb012,
                               l_sfcb.sfcb013,l_sfcb.sfcb014,l_sfcb.sfcb015,l_sfcb.sfcb016,l_sfcb.sfcb017,
                               l_sfcb.sfcb018,l_sfcb.sfcb019,l_sfcb.sfcb020,l_sfcb.sfcb021,l_sfcb.sfcb022,
                               l_sfcb.sfcb023,l_sfcb.sfcb024,l_sfcb.sfcb025,l_sfcb.sfcb026,l_sfcb.sfcb027,
                               l_sfcb.sfcb028,l_sfcb.sfcb029,l_sfcb.sfcb030,l_sfcb.sfcb031,l_sfcb.sfcb032,
                               l_sfcb.sfcb033,l_sfcb.sfcb034,l_sfcb.sfcb035,l_sfcb.sfcb036,l_sfcb.sfcb037,
                               l_sfcb.sfcb038,l_sfcb.sfcb039,l_sfcb.sfcb040,l_sfcb.sfcb041,l_sfcb.sfcb042,
                               l_sfcb.sfcb043,l_sfcb.sfcb044,l_sfcb.sfcb045,l_sfcb.sfcb046,l_sfcb.sfcb047,
                               l_sfcb.sfcb048,l_sfcb.sfcb049,l_sfcb.sfcb050,l_sfcb.sfcb051,l_sfcb.sfcb052,
                               l_sfcb.sfcb053,l_sfcb.sfcb054,l_sfcb.sfcb055,l_sfcb.sfcbud001,l_sfcb.sfcbud002,
                               l_sfcb.sfcbud003,l_sfcb.sfcbud004,l_sfcb.sfcbud005,l_sfcb.sfcbud006,l_sfcb.sfcbud007,
                               l_sfcb.sfcbud008,l_sfcb.sfcbud009,l_sfcb.sfcbud010,l_sfcb.sfcbud011,l_sfcb.sfcbud012,
                               l_sfcb.sfcbud013,l_sfcb.sfcbud014,l_sfcb.sfcbud015,l_sfcb.sfcbud016,l_sfcb.sfcbud017,
                               l_sfcb.sfcbud018,l_sfcb.sfcbud019,l_sfcb.sfcbud020,l_sfcb.sfcbud021,l_sfcb.sfcbud022,
                               l_sfcb.sfcbud023,l_sfcb.sfcbud024,l_sfcb.sfcbud025,l_sfcb.sfcbud026,l_sfcb.sfcbud027,
                               l_sfcb.sfcbud028,l_sfcb.sfcbud029,l_sfcb.sfcbud030
   #161109-00085#66 --e add
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL 
         LET g_errparam.extend = "FOREACH:" 
         LET g_errparam.code   = SQLCA.sqlcode 
         LET g_errparam.popup  = TRUE 
         CALL cl_err()
         EXIT FOREACH
      END IF 
      INITIALIZE g_detail_d[l_i].* TO NULL
      LET g_detail_d[l_i].sel              = 'Y'   
      LET g_detail_d[l_i].b_sfcbdocno      = l_sfcb.sfcbdocno
      LET g_detail_d[l_i].b_sfcb001        = l_sfcb.sfcb001
      LET g_detail_d[l_i].b_sfcb002        = l_sfcb.sfcb002
      LET g_detail_d[l_i].b_sfaa003        = g_sfaa_m.sfaa003
      LET g_detail_d[l_i].b_sfaa002        = g_sfaa_m.sfaa002
      LET g_detail_d[l_i].b_sfaa010        = g_sfaa_m.sfaa010                                                         
      LET g_detail_d[l_i].b_sfcb003        = l_sfcb.sfcb003
      LET g_detail_d[l_i].b_sfcb004        = l_sfcb.sfcb004
      LET g_detail_d[l_i].b_sfcb020        = l_sfcb.sfcb020
      
      IF cl_null(l_sfcb.sfcb027) THEN LET l_sfcb.sfcb027 = 0 END IF
      IF cl_null(l_sfcb.sfcb029) THEN LET l_sfcb.sfcb029 = 0 END IF
      IF cl_null(l_sfcb.sfcb030) THEN LET l_sfcb.sfcb030 = 0 END IF
      IF cl_null(l_sfcb.sfcb031) THEN LET l_sfcb.sfcb031 = 0 END IF
      IF cl_null(l_sfcb.sfcb032) THEN LET l_sfcb.sfcb032 = 0 END IF
      IF cl_null(l_sfcb.sfcb033) THEN LET l_sfcb.sfcb033 = 0 END IF
      IF cl_null(l_sfcb.sfcb034) THEN LET l_sfcb.sfcb034 = 0 END IF
      IF cl_null(l_sfcb.sfcb035) THEN LET l_sfcb.sfcb035 = 0 END IF
      IF cl_null(l_sfcb.sfcb036) THEN LET l_sfcb.sfcb036 = 0 END IF
      IF cl_null(l_sfcb.sfcb037) THEN LET l_sfcb.sfcb037 = 0 END IF
      IF cl_null(l_sfcb.sfcb038) THEN LET l_sfcb.sfcb038 = 0 END IF
      IF cl_null(l_sfcb.sfcb039) THEN LET l_sfcb.sfcb039 = 0 END IF
      IF cl_null(l_sfcb.sfcb041) THEN LET l_sfcb.sfcb041 = 0 END IF
      IF cl_null(l_sfcb.sfcb042) THEN LET l_sfcb.sfcb042 = 0 END IF
      LET g_detail_d[l_i].b_tot_qty        = l_sfcb.sfcb027 + l_sfcb.sfcb029 + l_sfcb.sfcb030 + l_sfcb.sfcb031 + l_sfcb.sfcb032 
                                         - l_sfcb.sfcb033 - l_sfcb.sfcb034 - l_sfcb.sfcb035 - l_sfcb.sfcb036 - l_sfcb.sfcb037 
                                         - l_sfcb.sfcb038 - l_sfcb.sfcb039 - l_sfcb.sfcb041 + l_sfcb.sfcb042
   
      LET g_detail_d[l_i].b_carry_qty      = g_detail_d[l_i].b_tot_qty
      LET g_detail_d[l_i].b_sfcb013        = l_sfcb.sfcb013
      IF cl_null(g_detail_d[l_i].b_sfcb013) THEN
         LET g_detail_d[l_i].b_sfcb013     = g_sfaa_m.sfaa017
      END IF
      LET g_detail_d[l_i].b_sfcb044        = l_sfcb.sfcb044
      LET g_detail_d[l_i].b_sfcb045        = l_sfcb.sfcb045
    #  LET g_detail_d[l_ac].b_pmal002       = ''
      CALL asft300_b_sfcb013_reference(l_i)
      LET g_detail_d[l_i].b_exrate         = asft300_get_b_exrate(g_detail_d[l_i].b_pmdl015)
      LET g_detail_d[l_i].b_price          = 0       
#160411-00039 by whitney mark start
#      #2015/09/08 by stellar add ----- (S)
#      IF l_date > g_detail_d[l_i].b_sfcb045 THEN
#         LET l_date = g_detail_d[l_i].b_sfcb045
#      END IF
#      #2015/09/08 by stellar add ----- (E)
#160411-00039 by whitney mark end
      LET l_i = l_i + 1
      IF l_ac > g_max_rec THEN
         IF g_error_show = 1 THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend =  "" 
            LET g_errparam.code   =  9035 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
 
         END IF
         EXIT FOREACH
      END IF
      
   END FOREACH
   
   CALL g_detail_d.deleteElement(l_i)
   CALL g_pmal.clear()
   
   #2015/09/08 by stellar modify ----- (S)
   #修改：委外採購單號=工單單號，不再做自動編碼
#   CALL asfp400_01(g_detail_d)
#        RETURNING l_success,l_doc_type,l_date,l_combine
#   IF NOT l_success THEN
#      RETURN
#   END IF   
   IF cl_null(l_date) THEN
      LET l_date = cl_get_today()
   END IF
   LET l_combine = 'Y'
   #2015/09/08 by stellar modify ----- (E)
   
   DECLARE asft300_sub_po_tz_cs CURSOR FOR
    SELECT sfacdocno,sfac006,sum(sfac003) FROM sfac_t
     WHERE sfacent = g_enterprise AND sfacsite = g_site
       AND sfacdocno = g_sfaa_m.sfaadocno
       AND sfac002 IN ('1','2')
      #AND sfac006 IS NOT NULL AND sfac006 <> ' '   #160107-00010#1 add  #160608-00010 by whitney mark
       AND sfac006 IS NOT NULL  #160608-00010 by whitney add
     GROUP BY sfacdocno,sfac006
     ORDER BY sfacdocno,sfac006
   
   CALL g_arr1.clear()
   CALL g_arr2.clear()
   LET l_j = 1
   LET l_k = 1
   CALL cl_err_collect_init()
   LET l_flag = 'Y'
   FOR l_l = 1 TO g_detail_d.getLength()
      LET g_arr1[l_j].sfcbdocno = g_detail_d[l_l].b_sfcbdocno
      LET g_arr1[l_j].sfaa010   = g_detail_d[l_l].b_sfaa010  
      LET g_arr1[l_j].sfcb001   = g_detail_d[l_l].b_sfcb001  
      LET g_arr1[l_j].sfcb002   = g_detail_d[l_l].b_sfcb002  
      LET g_arr1[l_j].sfcb003   = g_detail_d[l_l].b_sfcb003  
      LET g_arr1[l_j].sfcb004   = g_detail_d[l_l].b_sfcb004  
      LET g_arr1[l_j].sfcb020   = g_detail_d[l_l].b_sfcb020  
      LET g_arr1[l_j].carry_qty = g_detail_d[l_l].b_carry_qty
      LET g_arr1[l_j].sfcb013   = g_detail_d[l_l].b_sfcb013  
      LET g_arr1[l_j].sfcb044   = g_detail_d[l_l].b_sfcb044  
      LET g_arr1[l_j].sfcb045   = g_detail_d[l_l].b_sfcb045  
      LET g_arr1[l_j].pmdl017   = g_detail_d[l_l].b_pmdl017  
      LET g_arr1[l_j].pmdl015   = g_detail_d[l_l].b_pmdl015  
      LET g_arr1[l_j].exrate    = g_detail_d[l_l].b_exrate   
      LET g_arr1[l_j].pmdl011   = g_detail_d[l_l].b_pmdl011  
      LET g_arr1[l_j].price     = g_detail_d[l_l].b_price   
   #   LET g_arr1[l_i].pmal002   = g_detail_d[l_i].b_pmal002
      #160822-00039#1-s
      #FOREACH asft300_sub_po_tz_cs INTO g_arr2[l_k].*
      #    IF SQLCA.sqlcode THEN
      #       INITIALIZE g_errparam TO NULL
      #       LET g_errparam.code = SQLCA.sqlcode
      #       LET g_errparam.extend = 'foreach asft300_sub_po_tz_cs'
      #       LET g_errparam.popup = TRUE
      #       CALL cl_err()
      #       LET l_flag = 'N'
      #    END IF
      #    LET l_k = l_k + 1
      #END FOREACH
      #160822-00039#1-e
      IF NOT s_asfp400_chk_before_carry(g_arr1[l_j].*,l_doc_type,l_date) THEN
         LET l_flag = 'N'
         CONTINUE FOR
      END IF
      
      LET l_j = l_j + 1                     
   END FOR
   #160822-00039#1-s
   FOREACH asft300_sub_po_tz_cs INTO g_arr2[l_k].*
       IF SQLCA.sqlcode THEN
          INITIALIZE g_errparam TO NULL
          LET g_errparam.code = SQLCA.sqlcode
          LET g_errparam.extend = 'foreach asft300_sub_po_tz_cs'
          LET g_errparam.popup = TRUE
          CALL cl_err()
          LET l_flag = 'N'
       END IF
       LET l_k = l_k + 1
   END FOREACH
   #160822-00039#1-e
   
   CALL g_arr1.deleteElement(l_j)
   CALL g_arr2.deleteElement(l_k)
   CALL cl_err_collect_show()  
   IF l_flag = 'N' THEN      
      RETURN
   END IF
             
   CALL s_asfp400_cre_tmp_table(l_doc_type,l_date,g_arr1,g_arr2)
        RETURNING l_success
   IF NOT l_success THEN
      RETURN 
   END IF
   
   CALL s_transaction_begin()
   CALL s_asfp400_carry_po(l_doc_type,l_date,l_combine,g_arr1,g_arr2)
        RETURNING l_success,l_begin_no,l_end_no
   IF l_success THEN
      CALL s_transaction_end('Y',0)
      #成功产生单据，单据范围：%1 ~ %2
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'asf-00251'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      LET g_errparam.replace[1] = l_begin_no 
      LET g_errparam.replace[2] = l_end_no
      CALL cl_err()
   ELSE    
      CALL s_transaction_end('N',1)
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'asf-00447'
      LET g_errparam.extend = ''
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN
   END IF
   
   IF l_success AND NOT cl_null(l_begin_no) THEN
      #是否要运行apmt501查看生成的采购单信息[Y/N]?
      LET l_choice = cl_ask_promp('asf-00261')
      IF l_choice = TRUE THEN
          LET la_param.prog     = "apmt501"
         # LET la_param.param[1] = '1'
         # LET la_param.param[2] = " pmdldocno BETWEEN '",l_begin_no,"' AND '",l_end_no,"'"
          LET la_param.param[1] = l_begin_no        
          LET ls_js = util.JSON.stringify( la_param )
          CALL cl_cmdrun(ls_js)
          CURRENT WINDOW IS w_asft300
      END IF
   END IF
   
END FUNCTION

################################################################################
# Descriptions...: 厂商相关字段的DEFAULT
# Memo...........:
# Usage..........: CALL asft300_b_sfcb013_reference(p_i)
# Date & Author..: 14/10/20 By wuxja
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_b_sfcb013_reference(p_i)
DEFINE p_i            LIKE type_t.num5
#161109-00085#27-s
#DEFINE l_pmal         RECORD LIKE pmal_t.*
DEFINE l_pmal RECORD  #採購控制組供應商預設條件檔
       pmalent LIKE pmal_t.pmalent, #企業編號
       pmal001 LIKE pmal_t.pmal001, #交易對象編號
       pmal002 LIKE pmal_t.pmal002, #控制組編號
       pmal003 LIKE pmal_t.pmal003, #慣用交易幣別
       pmal004 LIKE pmal_t.pmal004, #慣用稅務規則
       pmal005 LIKE pmal_t.pmal005, #慣用發票開立方式
       pmal006 LIKE pmal_t.pmal006, #慣用付款條件
       pmal008 LIKE pmal_t.pmal008, #慣用採購通路
       pmal009 LIKE pmal_t.pmal009, #慣用採購分類
       pmal010 LIKE pmal_t.pmal010, #慣用報表語言
       pmal011 LIKE pmal_t.pmal011, #慣用交運方式
       pmal012 LIKE pmal_t.pmal012, #慣用交運起點
       pmal013 LIKE pmal_t.pmal013, #慣用交運終點
       pmal014 LIKE pmal_t.pmal014, #慣用卸貨港
       pmal015 LIKE pmal_t.pmal015, #慣用佣金率
       pmal016 LIKE pmal_t.pmal016, #折扣率
       pmal017 LIKE pmal_t.pmal017, #慣用ForWarder
       pmal018 LIKE pmal_t.pmal018, #慣用Notify
       pmal019 LIKE pmal_t.pmal019, #負責採購人員
       pmal020 LIKE pmal_t.pmal020, #慣用交易條件
       pmal021 LIKE pmal_t.pmal021, #慣用取價方式
       pmal022 LIKE pmal_t.pmal022, #慣用票類型
       pmal023 LIKE pmal_t.pmal023, #慣用內外購
       pmal024 LIKE pmal_t.pmal024, #慣用匯率計算基準
       pmalownid LIKE pmal_t.pmalownid, #資料所有者
       pmalowndp LIKE pmal_t.pmalowndp, #資料所屬部門
       pmalcrtid LIKE pmal_t.pmalcrtid, #資料建立者
       pmalcrtdp LIKE pmal_t.pmalcrtdp, #資料建立部門
       pmalcrtdt LIKE pmal_t.pmalcrtdt, #資料創建日
       pmalmodid LIKE pmal_t.pmalmodid, #資料修改者
       pmalmoddt LIKE pmal_t.pmalmoddt, #最近修改日
       pmalstus LIKE pmal_t.pmalstus, #狀態碼
       #pmal025 LIKE pmal_t.pmal025   #負責採購部門 #161109-00085#66 mark
       #161109-00085#66 --s add
       pmal025 LIKE pmal_t.pmal025, #負責採購部門
       pmalud001 LIKE pmal_t.pmalud001, #自定義欄位(文字)001
       pmalud002 LIKE pmal_t.pmalud002, #自定義欄位(文字)002
       pmalud003 LIKE pmal_t.pmalud003, #自定義欄位(文字)003
       pmalud004 LIKE pmal_t.pmalud004, #自定義欄位(文字)004
       pmalud005 LIKE pmal_t.pmalud005, #自定義欄位(文字)005
       pmalud006 LIKE pmal_t.pmalud006, #自定義欄位(文字)006
       pmalud007 LIKE pmal_t.pmalud007, #自定義欄位(文字)007
       pmalud008 LIKE pmal_t.pmalud008, #自定義欄位(文字)008
       pmalud009 LIKE pmal_t.pmalud009, #自定義欄位(文字)009
       pmalud010 LIKE pmal_t.pmalud010, #自定義欄位(文字)010
       pmalud011 LIKE pmal_t.pmalud011, #自定義欄位(數字)011
       pmalud012 LIKE pmal_t.pmalud012, #自定義欄位(數字)012
       pmalud013 LIKE pmal_t.pmalud013, #自定義欄位(數字)013
       pmalud014 LIKE pmal_t.pmalud014, #自定義欄位(數字)014
       pmalud015 LIKE pmal_t.pmalud015, #自定義欄位(數字)015
       pmalud016 LIKE pmal_t.pmalud016, #自定義欄位(數字)016
       pmalud017 LIKE pmal_t.pmalud017, #自定義欄位(數字)017
       pmalud018 LIKE pmal_t.pmalud018, #自定義欄位(數字)018
       pmalud019 LIKE pmal_t.pmalud019, #自定義欄位(數字)019
       pmalud020 LIKE pmal_t.pmalud020, #自定義欄位(數字)020
       pmalud021 LIKE pmal_t.pmalud021, #自定義欄位(日期時間)021
       pmalud022 LIKE pmal_t.pmalud022, #自定義欄位(日期時間)022
       pmalud023 LIKE pmal_t.pmalud023, #自定義欄位(日期時間)023
       pmalud024 LIKE pmal_t.pmalud024, #自定義欄位(日期時間)024
       pmalud025 LIKE pmal_t.pmalud025, #自定義欄位(日期時間)025
       pmalud026 LIKE pmal_t.pmalud026, #自定義欄位(日期時間)026
       pmalud027 LIKE pmal_t.pmalud027, #自定義欄位(日期時間)027
       pmalud028 LIKE pmal_t.pmalud028, #自定義欄位(日期時間)028
       pmalud029 LIKE pmal_t.pmalud029, #自定義欄位(日期時間)029
       pmalud030 LIKE pmal_t.pmalud030  #自定義欄位(日期時間)030
       #161109-00085#66 --e add
END RECORD
#161109-00085#27-e
#161109-00085#27-s
#DEFINE l_pmab         RECORD LIKE pmab_t.*
DEFINE l_pmab RECORD  #交易對象據點檔
       pmabent LIKE pmab_t.pmabent, #企業編號
       pmabsite LIKE pmab_t.pmabsite, #營運據點
       pmab001 LIKE pmab_t.pmab001, #交易對象編號
       pmab002 LIKE pmab_t.pmab002, #信用額度查核
       pmab003 LIKE pmab_t.pmab003, #額度交易對象
       pmab004 LIKE pmab_t.pmab004, #信用評核等級
       pmab005 LIKE pmab_t.pmab005, #額度計算幣別
       pmab006 LIKE pmab_t.pmab006, #企業額度
       pmab007 LIKE pmab_t.pmab007, #可超出率
       pmab008 LIKE pmab_t.pmab008, #有效期限
       pmab009 LIKE pmab_t.pmab009, #逾期帳款寬限天數
       pmab010 LIKE pmab_t.pmab010, #允許除外額度
       pmab011 LIKE pmab_t.pmab011, #額度警示水準一
       pmab012 LIKE pmab_t.pmab012, #水準一通知層
       pmab013 LIKE pmab_t.pmab013, #額度警示水準二
       pmab014 LIKE pmab_t.pmab014, #水準二通知層
       pmab015 LIKE pmab_t.pmab015, #額度警示水準三
       pmab016 LIKE pmab_t.pmab016, #水準三通知層
       pmab017 LIKE pmab_t.pmab017, #啟動預期應收通知
       pmab018 LIKE pmab_t.pmab018, #預期應收通知層
       pmab030 LIKE pmab_t.pmab030, #供應商ABC分類
       pmab031 LIKE pmab_t.pmab031, #負責採購人員
       pmab032 LIKE pmab_t.pmab032, #供應商慣用報表語言
       pmab033 LIKE pmab_t.pmab033, #供應商慣用交易幣別
       pmab034 LIKE pmab_t.pmab034, #供應商慣用交易稅別
       pmab035 LIKE pmab_t.pmab035, #供應商慣用發票開立方式
       pmab036 LIKE pmab_t.pmab036, #供應商慣用立帳方式
       pmab037 LIKE pmab_t.pmab037, #供應商慣用付款條件
       pmab038 LIKE pmab_t.pmab038, #供應商慣用採購通路
       pmab039 LIKE pmab_t.pmab039, #供應商慣用採購分類
       pmab040 LIKE pmab_t.pmab040, #供應商慣用交運方式
       pmab041 LIKE pmab_t.pmab041, #供應商慣用交運起點
       pmab042 LIKE pmab_t.pmab042, #供應商慣用交運終點
       pmab043 LIKE pmab_t.pmab043, #供應商慣用卸貨港
       pmab044 LIKE pmab_t.pmab044, #供應商慣用其他條件
       pmab045 LIKE pmab_t.pmab045, #供應商慣用佣金率
       pmab046 LIKE pmab_t.pmab046, #供應商折扣率
       pmab047 LIKE pmab_t.pmab047, #供應商慣用Forwarder
       pmab048 LIKE pmab_t.pmab048, #供應商慣用 Notify
       pmab049 LIKE pmab_t.pmab049, #預設允許分批收貨
       pmab050 LIKE pmab_t.pmab050, #最多可拆解批次
       pmab051 LIKE pmab_t.pmab051, #預設允許提前收貨
       pmab052 LIKE pmab_t.pmab052, #可提前收貨天數
       pmab053 LIKE pmab_t.pmab053, #慣用交易條件
       pmab054 LIKE pmab_t.pmab054, #慣用取價方式
       pmab055 LIKE pmab_t.pmab055, #應付帳款類別
       pmab056 LIKE pmab_t.pmab056, #供應商慣用發票類型
       pmab057 LIKE pmab_t.pmab057, #供應商慣用內外購
       pmab058 LIKE pmab_t.pmab058, #供應商慣用匯率計算基準
       pmab060 LIKE pmab_t.pmab060, #供應商評鑑計算分類
       pmab061 LIKE pmab_t.pmab061, #價格評分
       pmab062 LIKE pmab_t.pmab062, #達交率評分
       pmab063 LIKE pmab_t.pmab063, #品質評分
       pmab064 LIKE pmab_t.pmab064, #配合度評分
       pmab065 LIKE pmab_t.pmab065, #調整加減分
       pmab066 LIKE pmab_t.pmab066, #定性評分一
       pmab067 LIKE pmab_t.pmab067, #定性評分二
       pmab068 LIKE pmab_t.pmab068, #定性評分三
       pmab069 LIKE pmab_t.pmab069, #定性評分四
       pmab070 LIKE pmab_t.pmab070, #定性評分五
       pmab071 LIKE pmab_t.pmab071, #檢驗程度
       pmab072 LIKE pmab_t.pmab072, #檢驗水準
       pmab073 LIKE pmab_t.pmab073, #檢驗級數
       pmab080 LIKE pmab_t.pmab080, #客戶ABC分類
       pmab081 LIKE pmab_t.pmab081, #負責業務人員
       pmab082 LIKE pmab_t.pmab082, #客戶慣用報表語言
       pmab083 LIKE pmab_t.pmab083, #客戶慣用交易幣別
       pmab084 LIKE pmab_t.pmab084, #客戶慣用交易稅別
       pmab085 LIKE pmab_t.pmab085, #客戶慣用發票開立方式
       pmab086 LIKE pmab_t.pmab086, #客戶慣用立帳方式
       pmab087 LIKE pmab_t.pmab087, #客戶慣用收款條件
       pmab088 LIKE pmab_t.pmab088, #客戶慣用銷售通路
       pmab089 LIKE pmab_t.pmab089, #客戶慣用銷售分類
       pmab090 LIKE pmab_t.pmab090, #客戶慣用交運方式
       pmab091 LIKE pmab_t.pmab091, #客戶慣用交運起點
       pmab092 LIKE pmab_t.pmab092, #客戶慣用交運終點
       pmab093 LIKE pmab_t.pmab093, #客戶慣用卸貨港
       pmab094 LIKE pmab_t.pmab094, #客戶慣用其他條件
       pmab095 LIKE pmab_t.pmab095, #客戶慣用佣金率
       pmab096 LIKE pmab_t.pmab096, #客戶折扣率
       pmab097 LIKE pmab_t.pmab097, #客戶慣用Forwarder
       pmab098 LIKE pmab_t.pmab098, #客戶慣用 Notify
       pmab099 LIKE pmab_t.pmab099, #預設允許分批交貨
       pmab100 LIKE pmab_t.pmab100, #最多可拆解批次
       pmab101 LIKE pmab_t.pmab101, #預設允許提前交貨
       pmab102 LIKE pmab_t.pmab102, #可提前交貨天數
       pmab103 LIKE pmab_t.pmab103, #慣用交易條件
       pmab104 LIKE pmab_t.pmab104, #慣用取價方式
       pmab105 LIKE pmab_t.pmab105, #應收帳款類別
       pmab106 LIKE pmab_t.pmab106, #客戶慣用發票類型
       pmab107 LIKE pmab_t.pmab107, #客戶慣用內外銷
       pmab108 LIKE pmab_t.pmab108, #客戶慣用匯率計算基準
       pmabownid LIKE pmab_t.pmabownid, #資料所有者
       pmabowndp LIKE pmab_t.pmabowndp, #資料所有部門
       pmabcrtid LIKE pmab_t.pmabcrtid, #資料建立者
       pmabcrtdp LIKE pmab_t.pmabcrtdp, #資料建立部門
       pmabcrtdt LIKE pmab_t.pmabcrtdt, #資料創建日
       pmabmodid LIKE pmab_t.pmabmodid, #資料修改者
       pmabmoddt LIKE pmab_t.pmabmoddt, #最近修改日
       pmabcnfid LIKE pmab_t.pmabcnfid, #資料確認者
       pmabcnfdt LIKE pmab_t.pmabcnfdt, #資料確認日
       pmabstus LIKE pmab_t.pmabstus, #狀態碼
       #161109-00085#66 --s add
       pmabud001 LIKE pmab_t.pmabud001, #自定義欄位(文字)001
       pmabud002 LIKE pmab_t.pmabud002, #自定義欄位(文字)002
       pmabud003 LIKE pmab_t.pmabud003, #自定義欄位(文字)003
       pmabud004 LIKE pmab_t.pmabud004, #自定義欄位(文字)004
       pmabud005 LIKE pmab_t.pmabud005, #自定義欄位(文字)005
       pmabud006 LIKE pmab_t.pmabud006, #自定義欄位(文字)006
       pmabud007 LIKE pmab_t.pmabud007, #自定義欄位(文字)007
       pmabud008 LIKE pmab_t.pmabud008, #自定義欄位(文字)008
       pmabud009 LIKE pmab_t.pmabud009, #自定義欄位(文字)009
       pmabud010 LIKE pmab_t.pmabud010, #自定義欄位(文字)010
       pmabud011 LIKE pmab_t.pmabud011, #自定義欄位(數字)011
       pmabud012 LIKE pmab_t.pmabud012, #自定義欄位(數字)012
       pmabud013 LIKE pmab_t.pmabud013, #自定義欄位(數字)013
       pmabud014 LIKE pmab_t.pmabud014, #自定義欄位(數字)014
       pmabud015 LIKE pmab_t.pmabud015, #自定義欄位(數字)015
       pmabud016 LIKE pmab_t.pmabud016, #自定義欄位(數字)016
       pmabud017 LIKE pmab_t.pmabud017, #自定義欄位(數字)017
       pmabud018 LIKE pmab_t.pmabud018, #自定義欄位(數字)018
       pmabud019 LIKE pmab_t.pmabud019, #自定義欄位(數字)019
       pmabud020 LIKE pmab_t.pmabud020, #自定義欄位(數字)020
       pmabud021 LIKE pmab_t.pmabud021, #自定義欄位(日期時間)021
       pmabud022 LIKE pmab_t.pmabud022, #自定義欄位(日期時間)022
       pmabud023 LIKE pmab_t.pmabud023, #自定義欄位(日期時間)023
       pmabud024 LIKE pmab_t.pmabud024, #自定義欄位(日期時間)024
       pmabud025 LIKE pmab_t.pmabud025, #自定義欄位(日期時間)025
       pmabud026 LIKE pmab_t.pmabud026, #自定義欄位(日期時間)026
       pmabud027 LIKE pmab_t.pmabud027, #自定義欄位(日期時間)027
       pmabud028 LIKE pmab_t.pmabud028, #自定義欄位(日期時間)028
       pmabud029 LIKE pmab_t.pmabud029, #自定義欄位(日期時間)029
       pmabud030 LIKE pmab_t.pmabud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       pmab059 LIKE pmab_t.pmab059, #負責採購部門
       pmab109 LIKE pmab_t.pmab109, #負責業務部門
       pmab110 LIKE pmab_t.pmab110, #供應商條碼包裝數量
       pmab111 LIKE pmab_t.pmab111, #客戶條碼包裝數量
       pmab019 LIKE pmab_t.pmab019, #逾期帳款寬限額度
       pmab020 LIKE pmab_t.pmab020, #除外額有效日期
       pmab112 LIKE pmab_t.pmab112  #是否使用EC
END RECORD
#161109-00085#27-e

DEFINE l_pmal002      LIKE pmal_t.pmal002   #控制组
DEFINE l_success      LIKE type_t.num5
DEFINE l_i            LIKE type_t.num5
   
   IF p_i <= 0 THEN
      RETURN
   END IF
   
   IF cl_null(g_detail_d[p_i].b_sfcb013) THEN
      RETURN
   END IF
   #相同的供应商时,仅提供一次取pmal002的机会,否则可能同一个供应商,有几十笔资料时,跳几十次选择的情形
   LET l_pmal002 = ''
   FOR l_i = 1 TO g_pmal.getLength()
       IF g_pmal[l_i].b_sfcb013 = g_detail_d[p_i].b_sfcb013 AND NOT cl_null(g_pmal[l_i].pmal002) THEN
          LET l_pmal002 = g_pmal[l_i].pmal002
          EXIT FOR
       END IF
   END FOR

   IF cl_null(l_pmal002) THEN
      CALL s_control_get_pmal002('4',g_user,g_dept,g_detail_d[p_i].b_sfcb013)
           RETURNING l_success,l_pmal002
      IF NOT l_success THEN
         LET l_pmal002 = NULL
      END IF        
      IF NOT cl_null(l_pmal002) THEN
         CALL g_pmal.insertElement(1)
         LET g_pmal[1].b_sfcb013 = g_detail_d[p_i].b_sfcb013
         LET g_pmal[1].pmal002 = l_pmal002
      END IF
   END IF
   
   #取供应商的控制组预设条件
   #161109-00085#27-s
   #SELECT * INTO l_pmal.* FROM pmal_t
   #161109-00085#66 --s mark
   #SELECT pmalent,pmal001,pmal002,pmal003,pmal004,pmal005,pmal006,pmal008,pmal009,pmal010,
   #       pmal011,pmal012,pmal013,pmal014,pmal015,pmal016,pmal017,pmal018,pmal019,pmal020,
   #       pmal021,pmal022,pmal023,pmal024,pmalownid,pmalowndp,pmalcrtid,pmalcrtdp,pmalcrtdt,pmalmodid,
   #       pmalmoddt,pmalstus,pmal025 
   #  INTO l_pmal.pmalent,l_pmal.pmal001,l_pmal.pmal002,l_pmal.pmal003,l_pmal.pmal004,
   #       l_pmal.pmal005,l_pmal.pmal006,l_pmal.pmal008,l_pmal.pmal009,l_pmal.pmal010,
   #       l_pmal.pmal011,l_pmal.pmal012,l_pmal.pmal013,l_pmal.pmal014,l_pmal.pmal015,
   #       l_pmal.pmal016,l_pmal.pmal017,l_pmal.pmal018,l_pmal.pmal019,l_pmal.pmal020,
   #       l_pmal.pmal021,l_pmal.pmal022,l_pmal.pmal023,l_pmal.pmal024,l_pmal.pmalownid,
   #       l_pmal.pmalowndp,l_pmal.pmalcrtid,l_pmal.pmalcrtdp,l_pmal.pmalcrtdt,l_pmal.pmalmodid,
   #       l_pmal.pmalmoddt,l_pmal.pmalstus,l_pmal.pmal025 
   #161109-00085#66 --e mark
   #161109-00085#66 --s add
   SELECT pmalent,pmal001,pmal002,pmal003,pmal004,
          pmal005,pmal006,pmal008,pmal009,pmal010,
          pmal011,pmal012,pmal013,pmal014,pmal015,
          pmal016,pmal017,pmal018,pmal019,pmal020,
          pmal021,pmal022,pmal023,pmal024,pmalownid,
          pmalowndp,pmalcrtid,pmalcrtdp,pmalcrtdt,pmalmodid,
          pmalmoddt,pmalstus,pmal025,pmalud001,pmalud002,
          pmalud003,pmalud004,pmalud005,pmalud006,pmalud007,
          pmalud008,pmalud009,pmalud010,pmalud011,pmalud012,
          pmalud013,pmalud014,pmalud015,pmalud016,pmalud017,
          pmalud018,pmalud019,pmalud020,pmalud021,pmalud022,
          pmalud023,pmalud024,pmalud025,pmalud026,pmalud027,
          pmalud028,pmalud029,pmalud030
     INTO l_pmal.pmalent,l_pmal.pmal001,l_pmal.pmal002,l_pmal.pmal003,l_pmal.pmal004,
          l_pmal.pmal005,l_pmal.pmal006,l_pmal.pmal008,l_pmal.pmal009,l_pmal.pmal010,
          l_pmal.pmal011,l_pmal.pmal012,l_pmal.pmal013,l_pmal.pmal014,l_pmal.pmal015,
          l_pmal.pmal016,l_pmal.pmal017,l_pmal.pmal018,l_pmal.pmal019,l_pmal.pmal020,
          l_pmal.pmal021,l_pmal.pmal022,l_pmal.pmal023,l_pmal.pmal024,l_pmal.pmalownid,
          l_pmal.pmalowndp,l_pmal.pmalcrtid,l_pmal.pmalcrtdp,l_pmal.pmalcrtdt,l_pmal.pmalmodid,
          l_pmal.pmalmoddt,l_pmal.pmalstus,l_pmal.pmal025,l_pmal.pmalud001,l_pmal.pmalud002,
          l_pmal.pmalud003,l_pmal.pmalud004,l_pmal.pmalud005,l_pmal.pmalud006,l_pmal.pmalud007,
          l_pmal.pmalud008,l_pmal.pmalud009,l_pmal.pmalud010,l_pmal.pmalud011,l_pmal.pmalud012,
          l_pmal.pmalud013,l_pmal.pmalud014,l_pmal.pmalud015,l_pmal.pmalud016,l_pmal.pmalud017,
          l_pmal.pmalud018,l_pmal.pmalud019,l_pmal.pmalud020,l_pmal.pmalud021,l_pmal.pmalud022,
          l_pmal.pmalud023,l_pmal.pmalud024,l_pmal.pmalud025,l_pmal.pmalud026,l_pmal.pmalud027,
          l_pmal.pmalud028,l_pmal.pmalud029,l_pmal.pmalud030
   #161109-00085#66 --e add
     FROM pmal_t
   #161109-00085#27-e
    WHERE pmalent = g_enterprise
      AND pmal001 = g_detail_d[p_i].b_sfcb013
      AND pmal002 = l_pmal002
   #161109-00085#27-s   
   #SELECT * INTO l_pmab.* FROM pmab_t
   #161109-00085#66 --s mark
   #SELECT pmabent,pmabsite,pmab001,pmab002,pmab003,pmab004,pmab005,pmab006,pmab007,pmab008,
   #       pmab009,pmab010,pmab011,pmab012,pmab013,pmab014,pmab015,pmab016,pmab017,pmab018,
   #       pmab030,pmab031,pmab032,pmab033,pmab034,pmab035,pmab036,pmab037,pmab038,pmab039,
   #       pmab040,pmab041,pmab042,pmab043,pmab044,pmab045,pmab046,pmab047,pmab048,pmab049,
   #       pmab050,pmab051,pmab052,pmab053,pmab054,pmab055,pmab056,pmab057,pmab058,pmab060,
   #       pmab061,pmab062,pmab063,pmab064,pmab065,pmab066,pmab067,pmab068,pmab069,pmab070,
   #       pmab071,pmab072,pmab073,pmab080,pmab081,pmab082,pmab083,pmab084,pmab085,pmab086,
   #       pmab087,pmab088,pmab089,pmab090,pmab091,pmab092,pmab093,pmab094,pmab095,pmab096,
   #       pmab097,pmab098,pmab099,pmab100,pmab101,pmab102,pmab103,pmab104,pmab105,pmab106,
   #       pmab107,pmab108,pmabownid,pmabowndp,pmabcrtid,pmabcrtdp,pmabcrtdt,pmabmodid,pmabmoddt,pmabcnfid,
   #       pmabcnfdt,pmabstus,pmab059,pmab109,pmab110,pmab111,pmab019,pmab020,pmab112 
   #  INTO l_pmab.pmabent,l_pmab.pmabsite,l_pmab.pmab001,l_pmab.pmab002,l_pmab.pmab003,
   #       l_pmab.pmab004,l_pmab.pmab005,l_pmab.pmab006,l_pmab.pmab007,l_pmab.pmab008,
   #       l_pmab.pmab009,l_pmab.pmab010,l_pmab.pmab011,l_pmab.pmab012,l_pmab.pmab013,
   #       l_pmab.pmab014,l_pmab.pmab015,l_pmab.pmab016,l_pmab.pmab017,l_pmab.pmab018,
   #       l_pmab.pmab030,l_pmab.pmab031,l_pmab.pmab032,l_pmab.pmab033,l_pmab.pmab034,
   #       l_pmab.pmab035,l_pmab.pmab036,l_pmab.pmab037,l_pmab.pmab038,l_pmab.pmab039,
   #       l_pmab.pmab040,l_pmab.pmab041,l_pmab.pmab042,l_pmab.pmab043,l_pmab.pmab044,
   #       l_pmab.pmab045,l_pmab.pmab046,l_pmab.pmab047,l_pmab.pmab048,l_pmab.pmab049,
   #       l_pmab.pmab050,l_pmab.pmab051,l_pmab.pmab052,l_pmab.pmab053,l_pmab.pmab054,
   #       l_pmab.pmab055,l_pmab.pmab056,l_pmab.pmab057,l_pmab.pmab058,l_pmab.pmab060,
   #       l_pmab.pmab061,l_pmab.pmab062,l_pmab.pmab063,l_pmab.pmab064,l_pmab.pmab065,
   #       l_pmab.pmab066,l_pmab.pmab067,l_pmab.pmab068,l_pmab.pmab069,l_pmab.pmab070,
   #       l_pmab.pmab071,l_pmab.pmab072,l_pmab.pmab073,l_pmab.pmab080,l_pmab.pmab081,
   #       l_pmab.pmab082,l_pmab.pmab083,l_pmab.pmab084,l_pmab.pmab085,l_pmab.pmab086,
   #       l_pmab.pmab087,l_pmab.pmab088,l_pmab.pmab089,l_pmab.pmab090,l_pmab.pmab091,
   #       l_pmab.pmab092,l_pmab.pmab093,l_pmab.pmab094,l_pmab.pmab095,l_pmab.pmab096,
   #       l_pmab.pmab097,l_pmab.pmab098,l_pmab.pmab099,l_pmab.pmab100,l_pmab.pmab101,
   #       l_pmab.pmab102,l_pmab.pmab103,l_pmab.pmab104,l_pmab.pmab105,l_pmab.pmab106,
   #       l_pmab.pmab107,l_pmab.pmab108,l_pmab.pmabownid,l_pmab.pmabowndp,l_pmab.pmabcrtid,
   #       l_pmab.pmabcrtdp,l_pmab.pmabcrtdt,l_pmab.pmabmodid,l_pmab.pmabmoddt,l_pmab.pmabcnfid,
   #       l_pmab.pmabcnfdt,l_pmab.pmabstus,l_pmab.pmab059,l_pmab.pmab109,l_pmab.pmab110,
   #       l_pmab.pmab111,l_pmab.pmab019,l_pmab.pmab020,l_pmab.pmab112
   #161109-00085#66 --e mark
   #161109-00085#66 --s add
   SELECT pmabent,pmabsite,pmab001,pmab002,pmab003,
          pmab004,pmab005,pmab006,pmab007,pmab008,
          pmab009,pmab010,pmab011,pmab012,pmab013,
          pmab014,pmab015,pmab016,pmab017,pmab018,
          pmab030,pmab031,pmab032,pmab033,pmab034,
          pmab035,pmab036,pmab037,pmab038,pmab039,
          pmab040,pmab041,pmab042,pmab043,pmab044,
          pmab045,pmab046,pmab047,pmab048,pmab049,
          pmab050,pmab051,pmab052,pmab053,pmab054,
          pmab055,pmab056,pmab057,pmab058,pmab060,
          pmab061,pmab062,pmab063,pmab064,pmab065,
          pmab066,pmab067,pmab068,pmab069,pmab070,
          pmab071,pmab072,pmab073,pmab080,pmab081,
          pmab082,pmab083,pmab084,pmab085,pmab086,
          pmab087,pmab088,pmab089,pmab090,pmab091,
          pmab092,pmab093,pmab094,pmab095,pmab096,
          pmab097,pmab098,pmab099,pmab100,pmab101,
          pmab102,pmab103,pmab104,pmab105,pmab106,
          pmab107,pmab108,pmabownid,pmabowndp,pmabcrtid,
          pmabcrtdp,pmabcrtdt,pmabmodid,pmabmoddt,pmabcnfid,
          pmabcnfdt,pmabstus,pmabud001,pmabud002,pmabud003,
          pmabud004,pmabud005,pmabud006,pmabud007,pmabud008,
          pmabud009,pmabud010,pmabud011,pmabud012,pmabud013,
          pmabud014,pmabud015,pmabud016,pmabud017,pmabud018,
          pmabud019,pmabud020,pmabud021,pmabud022,pmabud023,
          pmabud024,pmabud025,pmabud026,pmabud027,pmabud028,
          pmabud029,pmabud030,pmab059,pmab109,pmab110,
          pmab111,pmab019,pmab020,pmab112
     INTO l_pmab.pmabent,l_pmab.pmabsite,l_pmab.pmab001,l_pmab.pmab002,l_pmab.pmab003,
          l_pmab.pmab004,l_pmab.pmab005,l_pmab.pmab006,l_pmab.pmab007,l_pmab.pmab008,
          l_pmab.pmab009,l_pmab.pmab010,l_pmab.pmab011,l_pmab.pmab012,l_pmab.pmab013,
          l_pmab.pmab014,l_pmab.pmab015,l_pmab.pmab016,l_pmab.pmab017,l_pmab.pmab018,
          l_pmab.pmab030,l_pmab.pmab031,l_pmab.pmab032,l_pmab.pmab033,l_pmab.pmab034,
          l_pmab.pmab035,l_pmab.pmab036,l_pmab.pmab037,l_pmab.pmab038,l_pmab.pmab039,
          l_pmab.pmab040,l_pmab.pmab041,l_pmab.pmab042,l_pmab.pmab043,l_pmab.pmab044,
          l_pmab.pmab045,l_pmab.pmab046,l_pmab.pmab047,l_pmab.pmab048,l_pmab.pmab049,
          l_pmab.pmab050,l_pmab.pmab051,l_pmab.pmab052,l_pmab.pmab053,l_pmab.pmab054,
          l_pmab.pmab055,l_pmab.pmab056,l_pmab.pmab057,l_pmab.pmab058,l_pmab.pmab060,
          l_pmab.pmab061,l_pmab.pmab062,l_pmab.pmab063,l_pmab.pmab064,l_pmab.pmab065,
          l_pmab.pmab066,l_pmab.pmab067,l_pmab.pmab068,l_pmab.pmab069,l_pmab.pmab070,
          l_pmab.pmab071,l_pmab.pmab072,l_pmab.pmab073,l_pmab.pmab080,l_pmab.pmab081,
          l_pmab.pmab082,l_pmab.pmab083,l_pmab.pmab084,l_pmab.pmab085,l_pmab.pmab086,
          l_pmab.pmab087,l_pmab.pmab088,l_pmab.pmab089,l_pmab.pmab090,l_pmab.pmab091,
          l_pmab.pmab092,l_pmab.pmab093,l_pmab.pmab094,l_pmab.pmab095,l_pmab.pmab096,
          l_pmab.pmab097,l_pmab.pmab098,l_pmab.pmab099,l_pmab.pmab100,l_pmab.pmab101,
          l_pmab.pmab102,l_pmab.pmab103,l_pmab.pmab104,l_pmab.pmab105,l_pmab.pmab106,
          l_pmab.pmab107,l_pmab.pmab108,l_pmab.pmabownid,l_pmab.pmabowndp,l_pmab.pmabcrtid,
          l_pmab.pmabcrtdp,l_pmab.pmabcrtdt,l_pmab.pmabmodid,l_pmab.pmabmoddt,l_pmab.pmabcnfid,
          l_pmab.pmabcnfdt,l_pmab.pmabstus,l_pmab.pmabud001,l_pmab.pmabud002,l_pmab.pmabud003,
          l_pmab.pmabud004,l_pmab.pmabud005,l_pmab.pmabud006,l_pmab.pmabud007,l_pmab.pmabud008,
          l_pmab.pmabud009,l_pmab.pmabud010,l_pmab.pmabud011,l_pmab.pmabud012,l_pmab.pmabud013,
          l_pmab.pmabud014,l_pmab.pmabud015,l_pmab.pmabud016,l_pmab.pmabud017,l_pmab.pmabud018,
          l_pmab.pmabud019,l_pmab.pmabud020,l_pmab.pmabud021,l_pmab.pmabud022,l_pmab.pmabud023,
          l_pmab.pmabud024,l_pmab.pmabud025,l_pmab.pmabud026,l_pmab.pmabud027,l_pmab.pmabud028,
          l_pmab.pmabud029,l_pmab.pmabud030,l_pmab.pmab059,l_pmab.pmab109,l_pmab.pmab110,
          l_pmab.pmab111,l_pmab.pmab019,l_pmab.pmab020,l_pmab.pmab112
   #161109-00085#66 --e add
     FROM pmab_t
   #161109-00085#27-e   
    WHERE pmabent  = g_enterprise
      AND pmabsite = g_site  
      AND pmab001  = g_detail_d[p_i].b_sfcb013

   #取价方式
   LET g_detail_d[p_i].b_pmdl017 = l_pmal.pmal021
   IF cl_null(g_detail_d[p_i].b_pmdl017) THEN
      LET g_detail_d[p_i].b_pmdl017 = l_pmab.pmab054
   END IF
   CALL s_desc_get_price_type_desc(g_detail_d[p_i].b_pmdl017)
        RETURNING g_detail_d[p_i].b_pmdl017_desc

   #币种
   LET g_detail_d[p_i].b_pmdl015 = l_pmal.pmal003
   IF cl_null(g_detail_d[p_i].b_pmdl015) THEN
      LET g_detail_d[p_i].b_pmdl015 = l_pmab.pmab033
   END IF
   CALL s_desc_get_currency_desc(g_detail_d[p_i].b_pmdl015)
        RETURNING g_detail_d[p_i].b_pmdl015_desc

   #税别
   LET g_detail_d[p_i].b_pmdl011 = l_pmal.pmal004
   IF cl_null(g_detail_d[p_i].b_pmdl011) THEN
      LET g_detail_d[p_i].b_pmdl011 = l_pmab.pmab034
   END IF
   CALL s_desc_get_tax_desc1(g_site,g_detail_d[p_i].b_pmdl011)
        RETURNING g_detail_d[p_i].b_pmdl011_desc
        
 #  LET g_detail_d[p_i].b_pmal002 = l_pmal002

END FUNCTION

################################################################################
# Descriptions...: 取汇率
# Memo...........:
# Usage..........: CALL asft300_get_b_exrate(p_b_pmdl015)
#                  RETURNING r_b_exrate
# Input parameter: p_b_pmdl015    币种
# Return code....: r_b_exrate     汇率
# Date & Author..: 2014-10-20 By wuxja
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_get_b_exrate(p_b_pmdl015)
   DEFINE p_b_pmdl015        LIKE pmdl_t.pmdl015
   DEFINE r_b_exrate         LIKE ooan_t.ooan005
   DEFINE l_date             LIKE type_t.dat
   DEFINE l_acc40            LIKE type_t.chr80
   
   LET r_b_exrate = 1
   IF cl_null(p_b_pmdl015) THEN
      RETURN r_b_exrate
   END IF
   
   LET l_date = cl_get_today()
   CALL cl_get_para(g_enterprise,g_site,'S-BAS-0010') RETURNING l_acc40
   CALL s_aooi160_get_exrate('1',g_site,l_date,p_b_pmdl015,g_ooef016,0,l_acc40)
        RETURNING r_b_exrate   
   
   RETURN r_b_exrate
END FUNCTION

################################################################################
# Descriptions...: 来源单号项次项序检查及带值
# Memo...........:
# Usage..........: asft300_sfaa006_chk1()
#                  RETURNING TRUE/FALSE
# Input parameter: 
# Return code....: 回傳 TRUE/FALSE
# Date & Author..: 201507010 By dorislai
#                  (從原本的asft300_sfaa006_chk拉出來寫)
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_sfaa006_chk1()
   DEFINE p_cmd         LIKE type_t.chr1
   DEFINE l_sql         STRING
   DEFINE l_sql1        STRING
   DEFINE l_sql2        STRING
   DEFINE l_n           LIKE type_t.num5
   DEFINE l_xmda004     LIKE xmda_t.xmda004
   DEFINE l_xmda007     LIKE xmda_t.xmda007
   DEFINE l_xmda008     LIKE xmda_t.xmda008
#161109-00085#27-s
#DEFINE l_xmdd        RECORD LIKE xmdd_t.*
DEFINE l_xmdd RECORD  #訂單交期明細檔
       xmddent LIKE xmdd_t.xmddent, #企業編號
       xmddsite LIKE xmdd_t.xmddsite, #營運據點
       xmdddocno LIKE xmdd_t.xmdddocno, #訂單單號
       xmddseq LIKE xmdd_t.xmddseq, #項次
       xmddseq1 LIKE xmdd_t.xmddseq1, #項序
       xmddseq2 LIKE xmdd_t.xmddseq2, #分批序
       xmdd001 LIKE xmdd_t.xmdd001, #料件編號
       xmdd002 LIKE xmdd_t.xmdd002, #產品特徵
       xmdd003 LIKE xmdd_t.xmdd003, #子件特性
       xmdd004 LIKE xmdd_t.xmdd004, #銷售單位
       xmdd005 LIKE xmdd_t.xmdd005, #訂購總數量
       xmdd006 LIKE xmdd_t.xmdd006, #分批訂購數量
       xmdd007 LIKE xmdd_t.xmdd007, #摺合主件數量
       xmdd008 LIKE xmdd_t.xmdd008, #QPA
       xmdd009 LIKE xmdd_t.xmdd009, #交期類型
       xmdd010 LIKE xmdd_t.xmdd010, #出貨時段
       xmdd011 LIKE xmdd_t.xmdd011, #約定交貨日期
       xmdd012 LIKE xmdd_t.xmdd012, #預計簽收日期
       xmdd013 LIKE xmdd_t.xmdd013, #MRP交期凍結
       xmdd014 LIKE xmdd_t.xmdd014, #已出貨量
       xmdd015 LIKE xmdd_t.xmdd015, #已銷退量
       xmdd016 LIKE xmdd_t.xmdd016, #銷退換貨數量
       xmdd017 LIKE xmdd_t.xmdd017, #出貨狀態
       xmdd018 LIKE xmdd_t.xmdd018, #參考價格
       xmdd019 LIKE xmdd_t.xmdd019, #稅別
       xmdd020 LIKE xmdd_t.xmdd020, #稅率
       xmdd021 LIKE xmdd_t.xmdd021, #電子訂購單號
       xmdd022 LIKE xmdd_t.xmdd022, #最近修改人員
       xmdd023 LIKE xmdd_t.xmdd023, #最近修改時間
       xmdd024 LIKE xmdd_t.xmdd024, #分批參考單位
       xmdd025 LIKE xmdd_t.xmdd025, #分批參考數量
       xmdd026 LIKE xmdd_t.xmdd026, #分批計價單位
       xmdd027 LIKE xmdd_t.xmdd027, #分批計價數量
       xmdd028 LIKE xmdd_t.xmdd028, #分批未稅金額
       xmdd029 LIKE xmdd_t.xmdd029, #分批含稅金額
       xmdd030 LIKE xmdd_t.xmdd030, #分批稅額
       xmdd031 LIKE xmdd_t.xmdd031, #已轉出通數量
       xmdd032 LIKE xmdd_t.xmdd032, #備置量
       xmdd033 LIKE xmdd_t.xmdd033, #備置原因
       xmdd034 LIKE xmdd_t.xmdd034, #已簽退量
       xmdd035 LIKE xmdd_t.xmdd035, #已分配量
       xmdd200 LIKE xmdd_t.xmdd200, #促銷方案
       xmdd201 LIKE xmdd_t.xmdd201, #分批包裝單位
       xmdd202 LIKE xmdd_t.xmdd202, #分批包裝數量
       xmdd203 LIKE xmdd_t.xmdd203, #標準價
       xmdd204 LIKE xmdd_t.xmdd204, #促銷價
       xmdd205 LIKE xmdd_t.xmdd205, #交易價
       xmdd206 LIKE xmdd_t.xmdd206, #折價金額
       xmddunit LIKE xmdd_t.xmddunit, #應用組織
       xmdd207 LIKE xmdd_t.xmdd207, #收貨網點
       xmdd208 LIKE xmdd_t.xmdd208, #送貨地址碼
       xmdd209 LIKE xmdd_t.xmdd209, #送貨站點
       xmdd210 LIKE xmdd_t.xmdd210, #送貨時段
       xmdd211 LIKE xmdd_t.xmdd211, #送貨客戶
       xmdd212 LIKE xmdd_t.xmdd212, #MRP凍結
       xmdd213 LIKE xmdd_t.xmdd213, #庫位/庫區
       xmdd214 LIKE xmdd_t.xmdd214, #儲位
       xmdd215 LIKE xmdd_t.xmdd215, #批號
       xmdd216 LIKE xmdd_t.xmdd216, #庫存鎖定等級
       xmdd217 LIKE xmdd_t.xmdd217, #庫存餘額
       xmdd218 LIKE xmdd_t.xmdd218, #銷售渠道
       xmdd219 LIKE xmdd_t.xmdd219, #產品組編號
       xmdd220 LIKE xmdd_t.xmdd220, #銷售範圍編號
       xmdd221 LIKE xmdd_t.xmdd221, #備註
       xmdd222 LIKE xmdd_t.xmdd222, #辦事處
       xmdd223 LIKE xmdd_t.xmdd223, #業務人員
       xmdd224 LIKE xmdd_t.xmdd224, #業務部門
       xmdd225 LIKE xmdd_t.xmdd225, #主合約編號
       xmdd226 LIKE xmdd_t.xmdd226, #經營方式
       xmdd227 LIKE xmdd_t.xmdd227, #結算類型
       xmdd228 LIKE xmdd_t.xmdd228, #結算方式
       xmddorga LIKE xmdd_t.xmddorga, #帳務組織
       xmdd229 LIKE xmdd_t.xmdd229, #交易類型
       xmdd230 LIKE xmdd_t.xmdd230, #分批包裝銷退換貨數量
       #161109-00085#66 --s add
       xmddud001 LIKE xmdd_t.xmddud001, #自定義欄位(文字)001
       xmddud002 LIKE xmdd_t.xmddud002, #自定義欄位(文字)002
       xmddud003 LIKE xmdd_t.xmddud003, #自定義欄位(文字)003
       xmddud004 LIKE xmdd_t.xmddud004, #自定義欄位(文字)004
       xmddud005 LIKE xmdd_t.xmddud005, #自定義欄位(文字)005
       xmddud006 LIKE xmdd_t.xmddud006, #自定義欄位(文字)006
       xmddud007 LIKE xmdd_t.xmddud007, #自定義欄位(文字)007
       xmddud008 LIKE xmdd_t.xmddud008, #自定義欄位(文字)008
       xmddud009 LIKE xmdd_t.xmddud009, #自定義欄位(文字)009
       xmddud010 LIKE xmdd_t.xmddud010, #自定義欄位(文字)010
       xmddud011 LIKE xmdd_t.xmddud011, #自定義欄位(數字)011
       xmddud012 LIKE xmdd_t.xmddud012, #自定義欄位(數字)012
       xmddud013 LIKE xmdd_t.xmddud013, #自定義欄位(數字)013
       xmddud014 LIKE xmdd_t.xmddud014, #自定義欄位(數字)014
       xmddud015 LIKE xmdd_t.xmddud015, #自定義欄位(數字)015
       xmddud016 LIKE xmdd_t.xmddud016, #自定義欄位(數字)016
       xmddud017 LIKE xmdd_t.xmddud017, #自定義欄位(數字)017
       xmddud018 LIKE xmdd_t.xmddud018, #自定義欄位(數字)018
       xmddud019 LIKE xmdd_t.xmddud019, #自定義欄位(數字)019
       xmddud020 LIKE xmdd_t.xmddud020, #自定義欄位(數字)020
       xmddud021 LIKE xmdd_t.xmddud021, #自定義欄位(日期時間)021
       xmddud022 LIKE xmdd_t.xmddud022, #自定義欄位(日期時間)022
       xmddud023 LIKE xmdd_t.xmddud023, #自定義欄位(日期時間)023
       xmddud024 LIKE xmdd_t.xmddud024, #自定義欄位(日期時間)024
       xmddud025 LIKE xmdd_t.xmddud025, #自定義欄位(日期時間)025
       xmddud026 LIKE xmdd_t.xmddud026, #自定義欄位(日期時間)026
       xmddud027 LIKE xmdd_t.xmddud027, #自定義欄位(日期時間)027
       xmddud028 LIKE xmdd_t.xmddud028, #自定義欄位(日期時間)028
       xmddud029 LIKE xmdd_t.xmddud029, #自定義欄位(日期時間)029
       xmddud030 LIKE xmdd_t.xmddud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       xmdd036 LIKE xmdd_t.xmdd036, #還量數量
       xmdd037 LIKE xmdd_t.xmdd037, #還量參考數量
       xmdd038 LIKE xmdd_t.xmdd038, #還價數量
       xmdd039 LIKE xmdd_t.xmdd039, #還價參考數量
       xmdd231 LIKE xmdd_t.xmdd231, #庫存管理特徵
       xmdd040 LIKE xmdd_t.xmdd040  #BOM特性
END RECORD
#161109-00085#27-e
   DEFINE l_success     LIKE type_t.num5
   DEFINE l_rate        LIKE type_t.num5
   DEFINE l_imae032     LIKE imae_t.imae032
   DEFINE l_sum         LIKE sfaa_t.sfaa012
   DEFINE l_num         LIKE sfaa_t.sfaa012
   DEFINE l_num1        LIKE sfaa_t.sfaa012
   DEFINE l_xmdddocno   LIKE xmdd_t.xmdddocno
   DEFINE l_xmddseq     LIKE xmdd_t.xmddseq
   DEFINE l_xmddseq1    LIKE xmdd_t.xmddseq1
   DEFINE l_xmddseq2    LIKE xmdd_t.xmddseq2
   DEFINE l_days        LIKE type_t.num5
   DEFINE l_sfaa007     STRING
   DEFINE l_sfaa008     STRING
   DEFINE l_sfaa063     STRING
#161109-00085#27-s
#DEFINE l_psab        RECORD LIKE psab_t.*   #20150709 by dorislai
DEFINE l_psab RECORD  #獨立需求單身檔
       psabent LIKE psab_t.psabent, #企業編號
       psabsite LIKE psab_t.psabsite, #營運據點
       psabdocno LIKE psab_t.psabdocno, #需求單號
       psabseq LIKE psab_t.psabseq, #項次
       psab001 LIKE psab_t.psab001, #料件編號
       psab002 LIKE psab_t.psab002, #產品特徵
       psab003 LIKE psab_t.psab003, #需求日期
       psab004 LIKE psab_t.psab004, #單位
       psab005 LIKE psab_t.psab005, #需求數量
       psab006 LIKE psab_t.psab006, #已耗需求
       psab007 LIKE psab_t.psab007, #備註
       psab008 LIKE psab_t.psab008, #結案
       psab009 LIKE psab_t.psab009, #MRP凍結
       #161109-00085#66 --s add
       psabud001 LIKE psab_t.psabud001, #自定義欄位(文字)001
       psabud002 LIKE psab_t.psabud002, #自定義欄位(文字)002
       psabud003 LIKE psab_t.psabud003, #自定義欄位(文字)003
       psabud004 LIKE psab_t.psabud004, #自定義欄位(文字)004
       psabud005 LIKE psab_t.psabud005, #自定義欄位(文字)005
       psabud006 LIKE psab_t.psabud006, #自定義欄位(文字)006
       psabud007 LIKE psab_t.psabud007, #自定義欄位(文字)007
       psabud008 LIKE psab_t.psabud008, #自定義欄位(文字)008
       psabud009 LIKE psab_t.psabud009, #自定義欄位(文字)009
       psabud010 LIKE psab_t.psabud010, #自定義欄位(文字)010
       psabud011 LIKE psab_t.psabud011, #自定義欄位(數字)011
       psabud012 LIKE psab_t.psabud012, #自定義欄位(數字)012
       psabud013 LIKE psab_t.psabud013, #自定義欄位(數字)013
       psabud014 LIKE psab_t.psabud014, #自定義欄位(數字)014
       psabud015 LIKE psab_t.psabud015, #自定義欄位(數字)015
       psabud016 LIKE psab_t.psabud016, #自定義欄位(數字)016
       psabud017 LIKE psab_t.psabud017, #自定義欄位(數字)017
       psabud018 LIKE psab_t.psabud018, #自定義欄位(數字)018
       psabud019 LIKE psab_t.psabud019, #自定義欄位(數字)019
       psabud020 LIKE psab_t.psabud020, #自定義欄位(數字)020
       psabud021 LIKE psab_t.psabud021, #自定義欄位(日期時間)021
       psabud022 LIKE psab_t.psabud022, #自定義欄位(日期時間)022
       psabud023 LIKE psab_t.psabud023, #自定義欄位(日期時間)023
       psabud024 LIKE psab_t.psabud024, #自定義欄位(日期時間)024
       psabud025 LIKE psab_t.psabud025, #自定義欄位(日期時間)025
       psabud026 LIKE psab_t.psabud026, #自定義欄位(日期時間)026
       psabud027 LIKE psab_t.psabud027, #自定義欄位(日期時間)027
       psabud028 LIKE psab_t.psabud028, #自定義欄位(日期時間)028
       psabud029 LIKE psab_t.psabud029, #自定義欄位(日期時間)029
       psabud030 LIKE psab_t.psabud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       psab010 LIKE psab_t.psab010, #專案編號
       psab011 LIKE psab_t.psab011, #WBS編號
       psab012 LIKE psab_t.psab012, #BOM特性
       psab013 LIKE psab_t.psab013  #保稅否
END RECORD
#161109-00085#27-e


  #當等於訂單、計畫等，檢查是否存在來源資料裡
  IF NOT cl_null(g_sfaa_m.sfaa006) THEN
     #订单
     IF g_sfaa_m.sfaa005 = '2' THEN
        LET l_sql1 = "SELECT COUNT(1) "
        LET l_sql2 = "SELECT xmddseq,xmddseq1,xmddseq2 "
        LET l_sql = " FROM xmda_t,xmdd_t WHERE xmdaent=xmddent AND xmdadocno=xmdddocno ",
                    "   AND xmddent='",g_enterprise,"' AND xmddsite='",g_site,"'",
                    #161128-00045-s-mod
#                    "   AND xmdddocno='",g_sfaa_m.sfaa006,"' AND xmdastus='Y'"
                    "   AND xmdddocno='",g_sfaa_m.sfaa006,"' AND xmdastus IN ('Y','H') "
                    #161128-00045-e-mod
        IF NOT cl_null(g_sfaa_m.sfaa007) THEN
           LET l_sql = l_sql," AND xmddseq=", g_sfaa_m.sfaa007
        END IF
        IF NOT cl_null(g_sfaa_m.sfaa008) THEN
           LET l_sql = l_sql," AND xmddseq1=", g_sfaa_m.sfaa008
        END IF
        IF NOT cl_null(g_sfaa_m.sfaa063) THEN
           LET l_sql = l_sql," AND xmddseq2=", g_sfaa_m.sfaa063
        END IF
        LET l_sql1 = l_sql1,l_sql        
        PREPARE asft300_sfaa006_chk_pre1 FROM l_sql1
        EXECUTE asft300_sfaa006_chk_pre1 INTO l_n
        
        IF l_n = 0 THEN
#           INITIALIZE g_errparam TO NULL
#           LET g_errparam.code = 'asf-00154'
#           LET g_errparam.extend = g_sfaa_m.sfaa006
#           LET g_errparam.popup = TRUE
#           CALL cl_err()

           RETURN FALSE
        END IF
        
        IF l_n = 1 THEN
           LET l_sql2 = l_sql2,l_sql
           PREPARE asft300_sfaa006_chk_pre2 FROM l_sql2
           EXECUTE asft300_sfaa006_chk_pre2 INTO g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063
        ELSE
           #开窗选择
           INITIALIZE g_qryparam.* TO NULL
           LET g_qryparam.state = 'i'
			  LET g_qryparam.reqry = FALSE
           LET g_qryparam.where = " xmdddocno = '",g_sfaa_m.sfaa006,"'"
           IF NOT cl_null(g_sfaa_m.sfaa007) THEN
              LET g_qryparam.where = g_qryparam.where," AND xmddseq = ",g_sfaa_m.sfaa007
           END IF
           IF NOT cl_null(g_sfaa_m.sfaa008) THEN
              LET g_qryparam.where = g_qryparam.where," AND xmddseq1 = ",g_sfaa_m.sfaa008
           END IF
           IF NOT cl_null(g_sfaa_m.sfaa063) THEN
              LET g_qryparam.where = g_qryparam.where," AND xmddseq2 = ",g_sfaa_m.sfaa063
           END IF
           CALL q_xmdddocno()                                #呼叫開窗        
           LET g_sfaa_m.sfaa006 = g_qryparam.return1              #將開窗取得的值回傳到變數
           LET g_sfaa_m.sfaa007 = g_qryparam.return2
           LET g_sfaa_m.sfaa008 = g_qryparam.return3
           LET g_sfaa_m.sfaa063 = g_qryparam.return4
        END IF   
        LET l_sfaa007 = g_sfaa_m.sfaa007
        LET l_sfaa008 = g_sfaa_m.sfaa008
        LET l_sfaa063 = g_sfaa_m.sfaa063
        LET g_sfaa_m.l_sfaa007 = l_sfaa007 CLIPPED,"-",l_sfaa008 CLIPPED,"-",l_sfaa063 CLIPPED
        DISPLAY BY NAME g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.l_sfaa007
     END IF
     #dorislai-20150708-add----(S)
     #獨立需求單
     IF g_sfaa_m.sfaa005 = '6' THEN
        LET l_sql1 = "SELECT COUNT(1) "
        LET l_sql2 = "SELECT psabseq "
        LET l_sql = " FROM psaa_t,psab_t WHERE psaaent=psabent AND psaadocno=psabdocno ",
                    "   AND psabent='",g_enterprise,"' AND psabsite='",g_site,"'",
                    "   AND psabdocno='",g_sfaa_m.sfaa006,"' AND psaastus='Y'"
        IF NOT cl_null(g_sfaa_m.sfaa007) THEN
           LET l_sql = l_sql," AND psabseq=", g_sfaa_m.sfaa007    #項次
        END IF

        LET l_sql1 = l_sql1,l_sql  #確認是否存在這筆單號資料      
        PREPARE asft300_sfaa006_chk_pre1_1 FROM l_sql1
        EXECUTE asft300_sfaa006_chk_pre1_1 INTO l_n
        #沒撈到資料
        IF l_n = 0 THEN
#           INITIALIZE g_errparam TO NULL
#           LET g_errparam.code = 'asf-00154'   #來源單號不存在！
#           LET g_errparam.extend = g_sfaa_m.sfaa006
#           LET g_errparam.popup = TRUE
#           CALL cl_err()

           RETURN FALSE
        END IF
        
        #有撈到資料
        IF l_n = 1 THEN
           LET l_sql2 = l_sql2,l_sql
           PREPARE asft300_sfaa006_chk_pre2_1 FROM l_sql2
           EXECUTE asft300_sfaa006_chk_pre2_1 INTO g_sfaa_m.sfaa007    #項次
        ELSE
           #開窗選擇
           INITIALIZE g_qryparam.* TO NULL
           LET g_qryparam.state = 'i'
			  LET g_qryparam.reqry = FALSE
           LET g_qryparam.where = " psabdocno = '",g_sfaa_m.sfaa006,"'"
           IF NOT cl_null(g_sfaa_m.sfaa007) THEN
              LET g_qryparam.where = g_qryparam.where," AND psabseq = ",g_sfaa_m.sfaa007
           END IF

           CALL q_psabdocno()                                #呼叫開窗        
           LET g_sfaa_m.sfaa006 = g_qryparam.return1         #將開窗取得的值回傳到變數
           LET g_sfaa_m.sfaa007 = g_qryparam.return2
           LET g_sfaa_m.sfaa008 = ' '
           LET g_sfaa_m.sfaa063 = ' '
        END IF   
        LET l_sfaa007 = g_sfaa_m.sfaa007
        LET g_sfaa_m.l_sfaa007 = l_sfaa007
        DISPLAY BY NAME g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.l_sfaa007
  
     END IF
     #dorislai-20150708-add----(E)
     #add--151207-00017#2 By shiun--(S)
     #MPS計劃
     IF g_sfaa_m.sfaa005 = '7' THEN
        LET l_sql1 = "SELECT COUNT(1) "
        LET l_sql2 = "SELECT psadseq "
        LET l_sql = " FROM psac_t,psad_t WHERE psacent=psadent AND psacdocno=psaddocno ",
                    "   AND psadent='",g_enterprise,"' AND psadsite='",g_site,"'",
                    "   AND psaddocno='",g_sfaa_m.sfaa006,"' AND psacstus='Y' AND psad008 = 'N' "
        IF NOT cl_null(g_sfaa_m.sfaa007) THEN
           LET l_sql = l_sql," AND psadseq=", g_sfaa_m.sfaa007    #項次
        END IF

        LET l_sql1 = l_sql1,l_sql  #確認是否存在這筆單號資料      
        PREPARE asft300_sfaa006_chk_pre1_2 FROM l_sql1
        EXECUTE asft300_sfaa006_chk_pre1_2 INTO l_n
        #沒撈到資料
        IF l_n = 0 THEN
           RETURN FALSE
        END IF
        
        #有撈到資料
        IF l_n = 1 THEN
           LET l_sql2 = l_sql2,l_sql
           PREPARE asft300_sfaa006_chk_pre2_2 FROM l_sql2
           EXECUTE asft300_sfaa006_chk_pre2_2 INTO g_sfaa_m.sfaa007    #項次
        ELSE
           #開窗選擇
           INITIALIZE g_qryparam.* TO NULL
           LET g_qryparam.state = 'i'
			  LET g_qryparam.reqry = FALSE
           LET g_qryparam.where = " psaddocno = '",g_sfaa_m.sfaa006,"'"
           IF NOT cl_null(g_sfaa_m.sfaa007) THEN
              LET g_qryparam.where = g_qryparam.where," AND psadseq = ",g_sfaa_m.sfaa007
           END IF

           CALL q_psaddocno()                                #呼叫開窗        
           LET g_sfaa_m.sfaa006 = g_qryparam.return1         #將開窗取得的值回傳到變數
           LET g_sfaa_m.sfaa007 = g_qryparam.return2
           LET g_sfaa_m.sfaa008 = ' '
           LET g_sfaa_m.sfaa063 = ' '
        END IF   
        LET l_sfaa007 = g_sfaa_m.sfaa007
        LET g_sfaa_m.l_sfaa007 = l_sfaa007
        DISPLAY BY NAME g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.l_sfaa007
  
     END IF
     #add--151207-00017#2 By shiun--(E)
  ELSE
     RETURN FALSE
  END IF

  RETURN TRUE
  

END FUNCTION

################################################################################
# Descriptions...: 料件類型(imaa004)是否為X:虛擬品
# Memo...........:
# Usage..........: CALL asft300_sfba005_chk(p_sfba005)
#                  RETURNING r_success
# Input parameter: p_sfba005      料號
# Return code....: r_success      TRUE/FALSE
# Date & Author..: 2016/06/27 By dorislai(#160623-00009#1)
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_sfba005_chk(p_sfba005)
   DEFINE p_sfba005 LIKE sfba_t.sfba005
   DEFINE r_success LIKE type_t.num5
   DEFINE l_imaa004 LIKE imaa_t.imaa004
   
   LET r_success = TRUE
   
   SELECT imaa004 INTO l_imaa004
     FROM imaa_t
    WHERE imaaent = g_enterprise
      AND imaa001 = p_sfba005

   IF l_imaa004 = 'X'  THEN
      LET r_success = FALSE
   END IF
   
   RETURN r_success
END FUNCTION

################################################################################
# Descriptions...: 删除备料
# Memo...........:
# Usage..........: CALL asft300_allotment_del()
#                  RETURNING TRUE OR FALSE
# Input parameter: 
# Return code....: 
# Date & Author..: 14/2/11 By wuxja
# Modify.........: 160708-00014 By whitney
################################################################################
PRIVATE FUNCTION asft300_allotment_del()
DEFINE l_n         LIKE type_t.num5
DEFINE l_msg       LIKE type_t.chr10

   #此工單存在子工單，是否繼續異動備料明細，將其子工單作廢並重新產生？
   LET l_n = 0
   SELECT COUNT(1) INTO l_n
     FROM sfaa_t
    WHERE sfaaent = g_enterprise
      AND sfaasite = g_site
      AND sfaa021 = g_sfaa_m.sfaadocno
      AND sfaastus != 'X'
   IF l_n > 0 THEN
      IF cl_ask_confirm('asf-00741') THEN
         UPDATE sfaa_t SET sfaastus = 'X'
          WHERE sfaaent = g_enterprise
            AND sfaasite = g_site
            AND sfaa021 = g_sfaa_m.sfaadocno
            AND sfaastus != 'X'
         IF SQLCA.sqlcode THEN
            INITIALIZE g_errparam TO NULL 
            LET g_errparam.extend = "sfaa_t:",SQLERRMESSAGE 
            LET g_errparam.code   = SQLCA.sqlcode 
            LET g_errparam.popup  = TRUE 
            CALL cl_err()
            RETURN FALSE
         END IF
      ELSE
         RETURN FALSE
      END IF
   END IF

   LET l_n = 0
   SELECT COUNT(1) INTO l_n
     FROM sfba_t
    WHERE sfbaent = g_enterprise
      AND sfbasite = g_site
      AND sfbadocno = g_sfaa_m.sfaadocno
   IF l_n = 0 THEN
      RETURN TRUE
   ELSE
      CASE g_action_choice
         WHEN "gen_allotment"
            #工單單身備料檔已存在，是否重新產生？
            LET l_msg = 'asf-00198'
         WHEN "del_allotment"
            #工單單身備料檔已存在，是否刪除？
            LET l_msg = 'asf-00199'
      END CASE
      IF NOT cl_ask_confirm(l_msg) THEN
         RETURN FALSE
      END IF
   END IF
   
   DELETE FROM sfba_t
    WHERE sfbaent = g_enterprise
      AND sfbasite = g_site
      AND sfbadocno = g_sfaa_m.sfaadocno
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "sfba_t:",SQLERRMESSAGE 
      LET g_errparam.code   = SQLCA.sqlcode 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN FALSE
   END IF
   
   UPDATE sfaa_t SET sfaa039 = 'N'
    WHERE sfaaent = g_enterprise
      AND sfaasite = g_site
      AND sfaadocno = g_sfaa_m.sfaadocno
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "sfba_t:",SQLERRMESSAGE 
      LET g_errparam.code   = SQLCA.sqlcode 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN FALSE
   END IF

   #成功刪除工單備料檔資料
   IF g_action_choice = "del_allotment" THEN
      CALL cl_ask_confirm3("asf-00167","")
   END IF
   
   LET g_sfaa_m.sfaa039 = 'N'            #170310-00012#1 add
   DISPLAY BY NAME g_sfaa_m.sfaa039      #170310-00012#1 add
      
   RETURN TRUE
END FUNCTION

################################################################################
# Descriptions...: 模具頁簽的資料內容顯示
# Memo...........:
# Usage..........: CALL asft300_sfai_show()
# Date & Author..: 2016/08/29 By lixiang
# Modify.........: #160727-00025#1 
################################################################################
PRIVATE FUNCTION asft300_sfai_show()
    
    SELECT sfai001,imaal003,imaal004,sfai002,sfai003,sfai004,sfai005 
       INTO g_sfai_m.sfai001,g_sfai_m.sfai001_desc,g_sfai_m.sfai001_desc_1,g_sfai_m.sfai002,
            g_sfai_m.sfai003,g_sfai_m.sfai004,g_sfai_m.sfai005
       FROM sfai_t 
         LEFT JOIN imaal_t ON imaalent = g_enterprise AND imaal001 = sfai001 AND imaal002 = g_dlang
      WHERE sfaient = g_enterprise AND sfaidocno = g_sfaa_m.sfaadocno
      
   DISPLAY BY NAME g_sfai_m.sfai001,g_sfai_m.sfai001_desc,g_sfai_m.sfai001_desc_1,g_sfai_m.sfai002,
                   g_sfai_m.sfai003,g_sfai_m.sfai004,g_sfai_m.sfai005
                   
END FUNCTION

################################################################################
# Descriptions...: 模具工單追加備料資料
# Memo...........:
# Usage..........: CALL asft300_add_allotment()
#                  RETURNING r_success
# Date & Author..: 2016/08/30 By lixiang
# Modify.........: #160727-00025#1
################################################################################
PRIVATE FUNCTION asft300_add_allotment()
DEFINE r_success     LIKE type_t.num5
DEFINE l_n           LIKE type_t.num10

   LET r_success = TRUE
   
   IF g_sfaa_m.sfaadocno IS NULL  THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "std-00003" 
      LET g_errparam.popup  = FALSE 
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   #顯示最新的資料
   EXECUTE asft300_master_referesh USING g_sfaa_m.sfaadocno
      INTO g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.oobal004,g_sfaa_m.sfaadocdt,g_sfaa_m.sfaa002,
           g_sfaa_m.sfaa002_desc,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,
           g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,
           g_sfaa_m.sfaa009,g_sfaa_m.sfaa009_desc,g_sfaa_m.sfaa022,g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,
           g_sfaa_m.sfaa024,g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,
           g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1,g_sfaa_m.sfaa012,g_sfaa_m.sfaa013,g_sfaa_m.sfaa013_desc,
           g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa060_desc,g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,
           g_sfaa_m.sfaa016_desc,g_sfaa_m.sfaa017,g_sfaa_m.sfaa017_desc,g_sfaa_m.sfaa018,g_sfaa_m.sfaa018_desc,
           g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,g_sfaa_m.sfaa068_desc,g_sfaa_m.sfaa014,
           g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.imae020,g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,
           g_sfaa_m.sfaa028_desc,g_sfaa_m.sfaa029,g_sfaa_m.sfaa029_desc,g_sfaa_m.sfaa030,g_sfaa_m.sfaa030_desc,
           g_sfaa_m.sfaa031,g_sfaa_m.sfaa031_desc,g_sfaa_m.sfaa032,g_sfaa_m.sfaa033,g_sfaa_m.sfaa034,
           g_sfaa_m.sfaa034_desc,g_sfaa_m.sfaa035,g_sfaa_m.sfaa035_desc,g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,
           g_sfaa_m.sfaa037,g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,
           g_sfaa_m.sfaa041,g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,
           g_sfaa_m.sfaa070,g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,
           g_sfaa_m.sfaa065,g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,
           #g_sfaa_m.sfaa056,g_sfaa_m.ooff013,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,     #161031-00025#17 mark
           g_sfaa_m.sfaa056,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,                       #161031-00025#17 add
           g_sfaa_m.sfaaowndp_desc,g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtid_desc,g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdp_desc,
           g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,g_sfaa_m.sfaamodid_desc,g_sfaa_m.sfaamoddt,g_sfaa_m.sfaacnfid,
           g_sfaa_m.sfaacnfid_desc,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,g_sfaa_m.sfaapstid_desc,g_sfaa_m.sfaapstdt
   
   IF g_sfaa_m.sfaastus NOT MATCHES '[YF]' THEN
      LET r_success = FALSE
      RETURN r_success
   END IF
   
   #檢查BOM表與備料明細，判断存在bom中，但不存在工单备料单身的才提示
   #变更单单头资料，sfka_t
   IF NOT asft300_gen_sfka() THEN
      RETURN r_success
   END IF
   
   #变更单工单来源页签资料，sfkb
   IF NOT asft300_gen_sfkb() THEN
      RETURN r_success
   END IF
   
   #变更单工单生產料號明細页签资料，sfkc
   IF NOT asft300_gen_sfkc() THEN
      RETURN r_success
   END IF
   
   #变更单工单商品序号页签资料，sfkf
   IF NOT asft300_gen_sfkf() THEN
      RETURN r_success
   END IF
   
   #变更单工单備料檔页签资料，sfkg
   IF NOT asft300_gen_sfkg() THEN
      RETURN r_success
   END IF
   
   #变更单工单模具页签资料，sfki
   IF NOT asft300_gen_sfki() THEN
      RETURN r_success
   END IF
   
   RETURN r_success
    
END FUNCTION

################################################################################
# Descriptions...: 轉請購單
# Memo...........:
# Usage..........: CALL asft300_gen_apmt400()
#                  RETURNING r_success
# Date & Author..: 2016/08/30 By lixiang
# Modify.........: #160727-00025#1
################################################################################
PRIVATE FUNCTION asft300_gen_apmt400()
DEFINE r_success     LIKE type_t.num5
DEFINE l_n           LIKE type_t.num10
DEFINE l_success     LIKE type_t.num5
DEFINE l_pmdadocno   LIKE pmda_t.pmdadocno
DEFINE l_count       LIKE type_t.num10

   LET r_success = TRUE
   
   IF g_sfaa_m.sfaadocno IS NULL  THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "std-00003" 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN 
   END IF
   
   #顯示最新的資料
   EXECUTE asft300_master_referesh USING g_sfaa_m.sfaadocno
      INTO g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.oobal004,g_sfaa_m.sfaadocdt,g_sfaa_m.sfaa002,
           g_sfaa_m.sfaa002_desc,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,
           g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,
           g_sfaa_m.sfaa009,g_sfaa_m.sfaa009_desc,g_sfaa_m.sfaa022,g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,
           g_sfaa_m.sfaa024,g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,
           g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1,g_sfaa_m.sfaa012,g_sfaa_m.sfaa013,g_sfaa_m.sfaa013_desc,
           g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa060_desc,g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,
           g_sfaa_m.sfaa016_desc,g_sfaa_m.sfaa017,g_sfaa_m.sfaa017_desc,g_sfaa_m.sfaa018,g_sfaa_m.sfaa018_desc,
           g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,g_sfaa_m.sfaa068_desc,g_sfaa_m.sfaa014,
           g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.imae020,g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,
           g_sfaa_m.sfaa028_desc,g_sfaa_m.sfaa029,g_sfaa_m.sfaa029_desc,g_sfaa_m.sfaa030,g_sfaa_m.sfaa030_desc,
           g_sfaa_m.sfaa031,g_sfaa_m.sfaa031_desc,g_sfaa_m.sfaa032,g_sfaa_m.sfaa033,g_sfaa_m.sfaa034,
           g_sfaa_m.sfaa034_desc,g_sfaa_m.sfaa035,g_sfaa_m.sfaa035_desc,g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,
           g_sfaa_m.sfaa037,g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,
           g_sfaa_m.sfaa041,g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,
           g_sfaa_m.sfaa070,g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,
           g_sfaa_m.sfaa065,g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,
           #g_sfaa_m.sfaa056,g_sfaa_m.ooff013,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,       #161031-00025#17 mark
           g_sfaa_m.sfaa056,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,                         #161031-00025#17 add
           g_sfaa_m.sfaaowndp_desc,g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtid_desc,g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdp_desc,
           g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,g_sfaa_m.sfaamodid_desc,g_sfaa_m.sfaamoddt,g_sfaa_m.sfaacnfid,
           g_sfaa_m.sfaacnfid_desc,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,g_sfaa_m.sfaapstid_desc,g_sfaa_m.sfaapstdt
   
   #已確認後的狀態都可以使用
   IF g_sfaa_m.sfaastus MATCHES '[NDR]' THEN
      RETURN 
   END IF
   
   #判斷是否存在採購資料
   LET l_n = 0
   SELECT COUNT(1) INTO l_n FROM pmdl_t,pmdp_t 
      WHERE pmdlent = pmdpent AND pmdldocno = pmdpdocno AND pmdlstus <> 'X'
        AND pmdpent = g_enterprise AND pmdp003 = g_sfaa_m.sfaadocno
   IF l_n > 0 THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "asf-00760" 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN
   END IF
   
   #判斷單身是否存在補給策略是採購的資料
   LET l_n = 0
   SELECT COUNT(1) INTO l_n FROM sfba_t,imaf_t 
       WHERE sfbaent = imafent AND sfba006 = imaf001 AND imafsite = g_site AND imaf013 = '1'
         AND sfbaent = g_enterprise AND sfbadocno = g_sfaa_m.sfaadocno 
   IF l_n = 0 OR cl_null(l_n) THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "asf-00763" 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN
   END IF
   
   #備料單身補給策略是採購是否都已經開立子工單，如已經開立，則不產生
   LET l_n = 0
   SELECT COUNT(1) INTO l_n FROM sfba_t,imaf_t 
       WHERE sfbaent = imafent AND sfba006 = imaf001 AND imafsite = g_site AND imaf013 = '1'
         AND sfbaent = g_enterprise AND sfbadocno = g_sfaa_m.sfaadocno 
         AND sfba006 NOT IN (SELECT sfaa010 FROM sfaa_t WHERE sfaaent = g_enterprise AND sfaa005 = '4' AND sfaa021 = g_sfaa_m.sfaadocno AND sfaastus <> 'X')
   IF l_n = 0 OR cl_null(l_n) THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "asf-00788" 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN
   END IF
   
   CALL s_transaction_begin()
   
   OPEN asft300_cl USING g_enterprise,g_site,g_sfaa_m.sfaadocno
   IF STATUS THEN
      CLOSE asft300_cl
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "OPEN asft300_cl:"
      LET g_errparam.code   = STATUS
      LET g_errparam.popup  = TRUE
      CALL cl_err()
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   CALL asft300_gen_apmt400_pmda() RETURNING l_success,l_pmdadocno
   
   IF (NOT l_success) OR cl_null(l_pmdadocno) THEN
      CLOSE asft300_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   CALL asft300_gen_apmt400_pmdb(l_pmdadocno) RETURNING l_success,l_count
   IF l_success AND (l_count = 0 OR cl_null(l_count)) THEN  #單身新增筆數為0
      CLOSE asft300_cl
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = ""
      LET g_errparam.code   = "asf-00765"
      LET g_errparam.popup  = TRUE
      CALL cl_err()
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   CLOSE asft300_cl
   CALL s_transaction_end('Y','0')
   INITIALIZE g_errparam TO NULL
   LET g_errparam.code = 'asf-00766'
   LET g_errparam.extend = ''
   LET g_errparam.popup = TRUE
   LET g_errparam.replace[1] = l_pmdadocno
   CALL cl_err()
   
END FUNCTION

################################################################################
# Descriptions...: 異動備料檢核
# Memo...........:
# Usage..........: CALL asft300_allotment_chk()
#                  RETURNING TRUE OR FALSE
# Input parameter: 
# Return code....: 
# Date & Author..: 160708-00014 By whitney
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_allotment_chk()
DEFINE l_n            LIKE type_t.num5
DEFINE l_success      LIKE type_t.num5     #160707-00044#1 add
DEFINE l_ooba002      LIKE ooba_t.ooba002  #160707-00044#1 add
DEFINE l_para         LIKE type_t.chr80    #160707-00044#1 add

   IF g_sfaa_m.sfaadocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code   = "std-00003"
      LET g_errparam.popup  = FALSE
      CALL cl_err()
      RETURN FALSE
   END IF
   
   #170307-00052#1 add --(S)--
   IF g_sfaa_m.sfaastus MATCHES '[CM]' THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code   = "asf-00264"
      LET g_errparam.popup  = FALSE
      CALL cl_err()
      RETURN FALSE
   END IF
   #170307-00052#1 add --(E)--

#160707-00044#1-s add
   #工單單別參數"工單下階備料產生時機"<>1.工單輸入時產生時，會在確認後才產生備料
   CALL s_aooi200_get_slip(g_sfaa_m.sfaadocno) RETURNING l_success,l_ooba002
   CALL cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0038') RETURNING l_para
   IF l_para = '1' THEN
#160707-00044#1-e add
      #工單狀態須為未確認或已確認才能異動備料！
      IF g_sfaa_m.sfaastus NOT MATCHES '[NY]' THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code   = "asf-00736"
         LET g_errparam.popup  = TRUE
         CALL cl_err()
         RETURN FALSE
      END IF
   END IF   #160707-00044#1 add

   #存在已發料之子工單，無法異動母工單備料明細！
   LET l_n = 0
   SELECT COUNT(1) INTO l_n
     FROM sfaa_t
    WHERE sfaaent = g_enterprise
      AND sfaa021 = g_sfaa_m.sfaadocno
      AND sfaastus != 'X'
      AND (sfaadocno IN (SELECT sfdc001 FROM sfda_t,sfdc_t WHERE sfdaent=sfdcent AND sfdadocno=sfdcdocno AND sfdaent=g_enterprise AND sfdastus !='X')
       OR  sfaadocno IN (SELECT sfdb001 FROM sfda_t,sfdb_t WHERE sfdaent=sfdbent AND sfdadocno=sfdbdocno AND sfdaent=g_enterprise AND sfdastus !='X'))
   IF l_n > 0 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code   = "asf-00737"
      LET g_errparam.popup  = TRUE
      CALL cl_err()
      RETURN FALSE
   END IF

   #存在已入庫之子工單，無法異動母工單備料明細！
   LET l_n = 0
   SELECT COUNT(1) INTO l_n
     FROM sfaa_t
    WHERE sfaaent = g_enterprise
      AND sfaa021 = g_sfaa_m.sfaadocno
      AND sfaastus != 'X'
      AND (sfaadocno IN (SELECT sfec001 FROM sfea_t,sfec_t WHERE sfeaent=sfecent AND sfeadocno=sfecdocno AND sfeaent=g_enterprise AND sfeastus !='X')
       OR  sfaadocno IN (SELECT sfeb001 FROM sfea_t,sfeb_t WHERE sfeaent=sfebent AND sfeadocno=sfebdocno AND sfeaent=g_enterprise AND sfeastus !='X'))
   IF l_n > 0 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code   = "asf-00738"
      LET g_errparam.popup  = TRUE
      CALL cl_err()
      RETURN FALSE
   END IF

   #存在已報工之子工單，無法異動母工單備料明細！
   LET l_n = 0
   SELECT COUNT(1) INTO l_n
     FROM sfaa_t
    WHERE sfaaent = g_enterprise
      AND sfaa021 = g_sfaa_m.sfaadocno
      AND sfaastus != 'X'
      AND sfaadocno IN (SELECT sffb005 FROM sffb_t WHERE sffbent=g_enterprise AND sffbstus !='X')
   IF l_n > 0 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code   = "asf-00739"
      LET g_errparam.popup  = TRUE
      CALL cl_err()
      RETURN FALSE
   END IF

   #存在已委外採購之子工單，無法異動母工單備料明細！
   LET l_n = 0
   SELECT COUNT(1) INTO l_n
     FROM sfaa_t
    WHERE sfaaent = g_enterprise
      AND sfaa021 = g_sfaa_m.sfaadocno
      AND sfaastus != 'X'
      AND sfaadocno IN (SELECT pmdl008 FROM pmdl_t WHERE pmdlent=g_enterprise AND pmdlstus !='X')
   IF l_n > 0 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code   = "asf-00740"
      LET g_errparam.popup  = TRUE
      CALL cl_err()
      RETURN FALSE
   END IF

   RETURN TRUE
END FUNCTION

################################################################################
# Descriptions...: 轉採購單
# Memo...........:
# Usage..........: CALL asft300_gen_apmt500()
#                  RETURNING r_success
# Date & Author..: 2016/08/30 By lixiang
# Modify.........: #160727-00025#1
################################################################################
PRIVATE FUNCTION asft300_gen_apmt500()
DEFINE r_success     LIKE type_t.num5
DEFINE l_n           LIKE type_t.num10
DEFINE l_cnt         LIKE type_t.num10
DEFINE l_sql         STRING
DEFINE l_sfba_d    RECORD
          sfbadocno  LIKE sfba_t.sfbadocno,
          sfbaseq    LIKE sfba_t.sfbaseq,
          sfbaseq1   LIKE sfba_t.sfbaseq1,
          sfba013    LIKE sfba_t.sfba013,
          imaf153    LIKE imaf_t.imaf153
                   END RECORD
DEFINE l_pmdp023     LIKE pmdp_t.pmdp023                   
DEFINE l_imaf153     LIKE imaf_t.imaf153
DEFINE l_success     LIKE type_t.num5
DEFINE l_docno       LIKE pmdl_t.pmdldocno   
DEFINE l_success_doc DYNAMIC ARRAY OF RECORD
          pmdldocno  LIKE pmdl_t.pmdldocno
                     END RECORD
DEFINE l_sfbadocno   LIKE sfba_t.sfbadocno
DEFINE l_sfbaseq     LIKE sfba_t.sfbaseq
DEFINE l_sfbaseq1    LIKE sfba_t.sfbaseq1
DEFINE l_sfba013     LIKE sfba_t.sfba013
DEFINE l_pmdl040     LIKE pmdl_t.pmdl040
DEFINE l_pmdl041     LIKE pmdl_t.pmdl041
DEFINE l_pmdl042     LIKE pmdl_t.pmdl042
   
   DROP TABLE asft300_tmp;
   CREATE TEMP TABLE asft300_tmp(
      sfbadocno  LIKE sfba_t.sfbadocno,
      sfbaseq    LIKE sfba_t.sfbaseq,
      sfbaseq1   LIKE sfba_t.sfbaseq1,
      sfba013    LIKE sfba_t.sfba013,
      imaf153    LIKE imaf_t.imaf153)
      
   IF g_sfaa_m.sfaadocno IS NULL  THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "std-00003" 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN
   END IF
   
   #顯示最新的資料
   EXECUTE asft300_master_referesh USING g_sfaa_m.sfaadocno
      INTO g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.oobal004,g_sfaa_m.sfaadocdt,g_sfaa_m.sfaa002,
           g_sfaa_m.sfaa002_desc,g_sfaa_m.sfaa003,g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,
           g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,
           g_sfaa_m.sfaa009,g_sfaa_m.sfaa009_desc,g_sfaa_m.sfaa022,g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,
           g_sfaa_m.sfaa024,g_sfaa_m.sfaa064,g_sfaa_m.sfaa025,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,
           g_sfaa_m.sfaa010_desc,g_sfaa_m.sfaa010_desc1,g_sfaa_m.sfaa012,g_sfaa_m.sfaa013,g_sfaa_m.sfaa013_desc,
           g_sfaa_m.sfaa058,g_sfaa_m.sfaa060,g_sfaa_m.sfaa060_desc,g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,
           g_sfaa_m.sfaa016_desc,g_sfaa_m.sfaa017,g_sfaa_m.sfaa017_desc,g_sfaa_m.sfaa018,g_sfaa_m.sfaa018_desc,
           g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,g_sfaa_m.sfaa068_desc,g_sfaa_m.sfaa014,
           g_sfaa_m.sfaa015,g_sfaa_m.sfaa026,g_sfaa_m.imae020,g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,
           g_sfaa_m.sfaa028_desc,g_sfaa_m.sfaa029,g_sfaa_m.sfaa029_desc,g_sfaa_m.sfaa030,g_sfaa_m.sfaa030_desc,
           g_sfaa_m.sfaa031,g_sfaa_m.sfaa031_desc,g_sfaa_m.sfaa032,g_sfaa_m.sfaa033,g_sfaa_m.sfaa034,
           g_sfaa_m.sfaa034_desc,g_sfaa_m.sfaa035,g_sfaa_m.sfaa035_desc,g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,
           g_sfaa_m.sfaa037,g_sfaa_m.sfaa038,g_sfaa_m.sfaa072,g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,
           g_sfaa_m.sfaa041,g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,
           g_sfaa_m.sfaa070,g_sfaa_m.sfaa045,g_sfaa_m.sfaa046,g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,
           g_sfaa_m.sfaa065,g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,
           #g_sfaa_m.sfaa056,g_sfaa_m.ooff013,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,      #161031-00025#17  mark
           g_sfaa_m.sfaa056,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaownid_desc,g_sfaa_m.sfaaowndp,                        #161031-00025#17  add
           g_sfaa_m.sfaaowndp_desc,g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtid_desc,g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdp_desc,
           g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,g_sfaa_m.sfaamodid_desc,g_sfaa_m.sfaamoddt,g_sfaa_m.sfaacnfid,
           g_sfaa_m.sfaacnfid_desc,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,g_sfaa_m.sfaapstid_desc,g_sfaa_m.sfaapstdt
   
   #已確認後的狀態都可以使用
   IF g_sfaa_m.sfaastus MATCHES '[NDR]' THEN
      RETURN
   END IF
   
   #判斷是否存在請購資料
   LET l_n = 0
   SELECT COUNT(1) INTO l_n FROM pmda_t,pmdb_t
      WHERE pmdaent = pmdbent AND pmdadocno = pmdbdocno AND pmdastus <> 'X'
        AND pmdbent = g_enterprise AND pmdb001 = g_sfaa_m.sfaadocno
   IF l_n > 0 THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "asf-00761" 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN
   END IF
   
   #判斷是否存在委外採購資料
   LET l_n = 0
   SELECT COUNT(1) INTO l_n FROM pmdl_t,pmdp_t 
      WHERE pmdlent = pmdpent AND pmdldocno = pmdpdocno AND pmdlstus <> 'X' AND pmdl005 ='2'
        AND pmdpent = g_enterprise AND pmdp003 = g_sfaa_m.sfaadocno
   IF l_n > 0 THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "asf-00762" 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN
   END IF
   
   #判斷單身是否存在補給策略是採購的資料
   LET l_n = 0
   SELECT COUNT(1) INTO l_n FROM sfba_t,imaf_t 
       WHERE sfbaent = imafent AND sfba006 = imaf001 AND imafsite = g_site AND imaf013 = '1'
         AND sfbaent = g_enterprise AND sfbadocno = g_sfaa_m.sfaadocno 
   IF l_n = 0 OR cl_null(l_n) THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "asf-00763" 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN
   END IF
   
   #備料單身補給策略是採購是否都已經開立子工單，如已經開立，則不產生
   LET l_n = 0
   SELECT COUNT(1) INTO l_n FROM sfba_t,imaf_t 
       WHERE sfbaent = imafent AND sfba006 = imaf001 AND imafsite = g_site AND imaf013 = '1'
         AND sfbaent = g_enterprise AND sfbadocno = g_sfaa_m.sfaadocno 
         AND sfba006 NOT IN (SELECT sfaa010 FROM sfaa_t WHERE sfaaent = g_enterprise AND sfaa005 = '4' AND sfaa021 = g_sfaa_m.sfaadocno AND sfaastus <> 'X')
   IF l_n = 0 OR cl_null(l_n) THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "asf-00788" 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN
   END IF
   
   #委外工單需拋轉委外採購單
   IF g_sfaa_m.sfaa057 = '2' THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "" 
      LET g_errparam.code   = "asf-00764" 
      LET g_errparam.popup  = TRUE 
      CALL cl_err()
      RETURN
   END IF
   
   CALL s_transaction_begin()
   
   OPEN asft300_cl USING g_enterprise,g_site,g_sfaa_m.sfaadocno
   IF STATUS THEN
      CLOSE asft300_cl
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "OPEN asft300_cl:"
      LET g_errparam.code   = STATUS
      LET g_errparam.popup  = TRUE
      CALL cl_err()
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #有維護先帶部門供應商、沒有維護抓料件預設、料件沒有預設就維持空白，採購單不能確認，資料到採購單上補
   IF NOT cl_null(g_sfaa_m.sfaa017) THEN
      LET l_sql = "SELECT sfbadocno,sfbaseq,sfbaseq1,sfba013,sfaa017 FROM sfba_t,sfaa_t,imaf_t ",
                  "  WHERE sfbaent = sfaaent AND sfbasite = sfaasite AND sfbadocno = sfaadocno ",
                  "    AND sfbaent = imafent AND sfba006 = imaf001 AND imafsite = sfbasite AND imaf013 = '1' ",
                  "    AND sfbaent = ",g_enterprise," AND sfbasite = '",g_site,"' AND sfbadocno = '",g_sfaa_m.sfaadocno,"' ",
                  "    AND sfba006 NOT IN (SELECT sfaa010 FROM sfaa_t WHERE sfaaent = ",g_enterprise," AND sfaa005 = '4' AND sfaa021 = '",g_sfaa_m.sfaadocno,"' AND sfaastus <> 'X') "
   ELSE
      LET l_sql = "SELECT sfbadocno,sfbaseq,sfbaseq1,sfba013,imaf153 FROM sfba_t,imaf_t ",
                  "  WHERE sfbaent = imafent AND sfbasite = imafsite AND sfba006 = imaf001 AND imaf013 = '1' ",
                  "    AND sfbaent = ",g_enterprise," AND sfbasite = '",g_site,"' AND sfbadocno = '",g_sfaa_m.sfaadocno,"' ",
                  "    AND sfba006 NOT IN (SELECT sfaa010 FROM sfaa_t WHERE sfaaent = ",g_enterprise," AND sfaa005 = '4' AND sfaa021 = '",g_sfaa_m.sfaadocno,"' AND sfaastus <> 'X') "
   END IF
   
   PREPARE asft300_sel_pr FROM l_sql
   DECLARE asft300_sel_cs CURSOR FOR asft300_sel_pr     
   
   FOREACH asft300_sel_cs INTO l_sfba_d.*
      IF cl_null(l_sfba_d.imaf153) THEN 
         LET l_sfba_d.imaf153 = ' '
      END IF
      LET l_pmdp023 = 0
      SELECT SUM(pmdp023) INTO l_pmdp023
        FROM pmdl_t,pmdp_t
       WHERE pmdlent = pmdpent AND pmdldocno = pmdpdocno AND pmdlent = g_enterprise
         AND pmdp003 = l_sfba_d.sfbadocno AND pmdp004 = l_sfba_d.sfbaseq AND pmdp005 = l_sfba_d.sfbaseq1
         AND pmdlstus <> 'X'    
      IF cl_null(l_pmdp023) THEN LET l_pmdp023 = 0 END IF
      IF l_pmdp023 >= l_sfba_d.sfba013 THEN
         CONTINUE FOREACH
      END IF
      LET l_sfba_d.sfba013 = l_sfba_d.sfba013 - l_pmdp023
      #161109-00085#27-s
      #INSERT INTO asft300_tmp VALUES(l_sfba_d.*)
      INSERT INTO asft300_tmp(sfbadocno,sfbaseq,sfbaseq1,sfba013,imaf153)
      VALUES(l_sfba_d.sfbadocno,l_sfba_d.sfbaseq,l_sfba_d.sfbaseq1,l_sfba_d.sfba013,l_sfba_d.imaf153)
      #161109-00085#27-e      
   END FOREACH           
   LET l_cnt = 0
   SELECT COUNT(1) INTO l_cnt FROM asft300_tmp
   IF cl_null(l_cnt) OR l_cnt = 0 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'asf-00765'  #已無數量可轉請購/採購單！
      LET g_errparam.extend = g_sfaa_m.sfaadocno
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN   
   END IF
   
   #依據aooi210所設置對應的採購單別
   CALL s_aooi210_get_doc(g_site,'',4,g_sfaa_m.sfaadocno,'apmt500','') RETURNING l_success,l_docno
   IF NOT l_success THEN
      LET r_success = FALSE
      RETURN r_success    
   END IF  
   IF cl_null(l_docno) THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'agl-00122'
      LET g_errparam.extend = g_sfaa_m.sfaadocno
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN    
   END IF   
   
   #依供應商產生多筆採購單
   LET l_sql = "SELECT DISTINCT imaf153,sfbadocno FROM asft300_tmp"        
   PREPARE asft300_tmp_pr FROM l_sql
   DECLARE asft300_tmp_cs CURSOR FOR asft300_tmp_pr
   
   LET l_sql = "SELECT sfbaseq,sfbaseq1,sfba013 FROM asft300_tmp" ,         
               " WHERE imaf153 = ? ",
               " ORDER BY sfbaseq,sfbaseq1 "
   PREPARE asft300_sfba_pr FROM l_sql
   DECLARE asft300_sfba_cs CURSOR FOR asft300_sfba_pr

   CALL l_success_doc.clear()                             
   LET l_n = 1                                           
   FOREACH asft300_tmp_cs INTO l_imaf153,l_sfbadocno  
      #產生採購單單頭檔
      IF NOT asft300_gen_apmt500_pmdl(l_docno,l_sfbadocno,l_imaf153) THEN         
         RETURN  
      END IF     
      #將相同的供應商產生成一張採購單   
      FOREACH asft300_sfba_cs USING l_imaf153 INTO l_sfbaseq,l_sfbaseq1,l_sfba013  
         #產生採購單單身檔
         IF NOT asft300_gen_apmt500_pmdn(l_sfbadocno,l_sfbaseq,l_sfbaseq1,l_sfba013) THEN  
            RETURN            
          END IF          
      END FOREACH 
      #未税/含税/税额
      SELECT SUM(pmdn046),SUM(pmdn047),SUM(pmdn048) INTO l_pmdl040,l_pmdl041,l_pmdl042
        FROM pmdn_t
       WHERE pmdnent   = g_enterprise
         AND pmdndocno = g_pmdl.pmdldocno   
      IF cl_null(l_pmdl040) THEN LET l_pmdl040 = 0 END IF
      IF cl_null(l_pmdl041) THEN LET l_pmdl041 = 0 END IF
      IF cl_null(l_pmdl042) THEN LET l_pmdl042 = 0 END IF
      UPDATE pmdl_t SET pmdl040 = l_pmdl040, pmdl041 = l_pmdl041, pmdl042 = l_pmdl042
       WHERE pmdlent   = g_enterprise
         AND pmdldocno = g_pmdl.pmdldocno    
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'update pmdl_t SUM'
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN 
      END IF
   
      LET l_success_doc[l_n].pmdldocno = g_pmdl.pmdldocno   
      LET l_n = l_n + 1                                     
   END FOREACH   
  
   FOR l_n = 1 TO l_success_doc.getLength()
      INITIALIZE g_errparam TO NULL       
      LET g_errparam.code   = 'axm-00780'
      LET g_errparam.extend = ''
      LET g_errparam.replace[1] = l_success_doc[l_n].pmdldocno
      LET g_errparam.popup  = TRUE
      CALL cl_err()
   END FOR          

   CLOSE asft300_cl
   CALL s_transaction_end('Y','0')
    
END FUNCTION

################################################################################
# Descriptions...: 轉請購單單頭
# Memo...........:
# Usage..........: CALL asft300_gen_apmt400_pmda()
#                  RETURNING r_success,r_pmdadocno
# Date & Author..: 2016/08/30 By lixiang
# Modify.........: #160727-00025#1
################################################################################
PRIVATE FUNCTION asft300_gen_apmt400_pmda()
DEFINE l_success     LIKE type_t.num5
DEFINE r_success     LIKE type_t.num5
DEFINE l_pmdacrtdt   DATETIME YEAR TO SECOND
DEFINE l_prog        LIKE type_t.chr20     #作業編號 (gzzz001)
#161109-00085#27-s
#DEFINE l_pmda        RECORD LIKE pmda_t.*
DEFINE l_pmda RECORD  #請購單單頭頭檔
       pmdaent LIKE pmda_t.pmdaent, #企業編號
       pmdaownid LIKE pmda_t.pmdaownid, #資料所有者
       pmdaowndp LIKE pmda_t.pmdaowndp, #資料所屬部門
       pmdacrtid LIKE pmda_t.pmdacrtid, #資料建立者
       pmdacrtdp LIKE pmda_t.pmdacrtdp, #資料建立部門
       pmdacrtdt LIKE pmda_t.pmdacrtdt, #資料創建日
       pmdamodid LIKE pmda_t.pmdamodid, #資料修改者
       pmdamoddt LIKE pmda_t.pmdamoddt, #最近修改日
       pmdacnfid LIKE pmda_t.pmdacnfid, #資料確認者
       pmdacnfdt LIKE pmda_t.pmdacnfdt, #資料確認日
       pmdapstid LIKE pmda_t.pmdapstid, #資料過帳者
       pmdapstdt LIKE pmda_t.pmdapstdt, #資料過帳日
       pmdastus LIKE pmda_t.pmdastus, #狀態碼
       pmdasite LIKE pmda_t.pmdasite, #營運據點
       pmdadocno LIKE pmda_t.pmdadocno, #請購單號
       pmdadocdt LIKE pmda_t.pmdadocdt, #請購日期
       pmda001 LIKE pmda_t.pmda001, #版次
       pmda002 LIKE pmda_t.pmda002, #請購人員
       pmda003 LIKE pmda_t.pmda003, #請購部門
       pmda004 LIKE pmda_t.pmda004, #單價為必要輸入
       pmda005 LIKE pmda_t.pmda005, #幣別
       pmda006 LIKE pmda_t.pmda006, #No Use
       pmda007 LIKE pmda_t.pmda007, #費用部門
       pmda008 LIKE pmda_t.pmda008, #請購總未稅金額
       pmda009 LIKE pmda_t.pmda009, #請購總含稅金額
       pmda010 LIKE pmda_t.pmda010, #稅別
       pmda011 LIKE pmda_t.pmda011, #稅率
       pmda012 LIKE pmda_t.pmda012, #單價含稅否
       pmda020 LIKE pmda_t.pmda020, #納入APS計算
       pmda021 LIKE pmda_t.pmda021, #運送方式
       pmda022 LIKE pmda_t.pmda022, #備註
       pmda200 LIKE pmda_t.pmda200, #來源類型
       pmda201 LIKE pmda_t.pmda201, #採購方式
       pmda202 LIKE pmda_t.pmda202, #所屬品類
       pmda203 LIKE pmda_t.pmda203, #需求組織
       pmda204 LIKE pmda_t.pmda204, #採購中心
       pmda205 LIKE pmda_t.pmda205, #配送中心
       pmda206 LIKE pmda_t.pmda206, #配送倉
       pmda207 LIKE pmda_t.pmda207, #到貨日期
       pmda208 LIKE pmda_t.pmda208, #包裝總數量
       pmda900 LIKE pmda_t.pmda900, #保留欄位str
       pmda999 LIKE pmda_t.pmda999, #保留欄位end
       #161109-00085#66 --s add
       pmdaud001 LIKE pmda_t.pmdaud001, #自定義欄位(文字)001
       pmdaud002 LIKE pmda_t.pmdaud002, #自定義欄位(文字)002
       pmdaud003 LIKE pmda_t.pmdaud003, #自定義欄位(文字)003
       pmdaud004 LIKE pmda_t.pmdaud004, #自定義欄位(文字)004
       pmdaud005 LIKE pmda_t.pmdaud005, #自定義欄位(文字)005
       pmdaud006 LIKE pmda_t.pmdaud006, #自定義欄位(文字)006
       pmdaud007 LIKE pmda_t.pmdaud007, #自定義欄位(文字)007
       pmdaud008 LIKE pmda_t.pmdaud008, #自定義欄位(文字)008
       pmdaud009 LIKE pmda_t.pmdaud009, #自定義欄位(文字)009
       pmdaud010 LIKE pmda_t.pmdaud010, #自定義欄位(文字)010
       pmdaud011 LIKE pmda_t.pmdaud011, #自定義欄位(數字)011
       pmdaud012 LIKE pmda_t.pmdaud012, #自定義欄位(數字)012
       pmdaud013 LIKE pmda_t.pmdaud013, #自定義欄位(數字)013
       pmdaud014 LIKE pmda_t.pmdaud014, #自定義欄位(數字)014
       pmdaud015 LIKE pmda_t.pmdaud015, #自定義欄位(數字)015
       pmdaud016 LIKE pmda_t.pmdaud016, #自定義欄位(數字)016
       pmdaud017 LIKE pmda_t.pmdaud017, #自定義欄位(數字)017
       pmdaud018 LIKE pmda_t.pmdaud018, #自定義欄位(數字)018
       pmdaud019 LIKE pmda_t.pmdaud019, #自定義欄位(數字)019
       pmdaud020 LIKE pmda_t.pmdaud020, #自定義欄位(數字)020
       pmdaud021 LIKE pmda_t.pmdaud021, #自定義欄位(日期時間)021
       pmdaud022 LIKE pmda_t.pmdaud022, #自定義欄位(日期時間)022
       pmdaud023 LIKE pmda_t.pmdaud023, #自定義欄位(日期時間)023
       pmdaud024 LIKE pmda_t.pmdaud024, #自定義欄位(日期時間)024
       pmdaud025 LIKE pmda_t.pmdaud025, #自定義欄位(日期時間)025
       pmdaud026 LIKE pmda_t.pmdaud026, #自定義欄位(日期時間)026
       pmdaud027 LIKE pmda_t.pmdaud027, #自定義欄位(日期時間)027
       pmdaud028 LIKE pmda_t.pmdaud028, #自定義欄位(日期時間)028
       pmdaud029 LIKE pmda_t.pmdaud029, #自定義欄位(日期時間)029
       pmdaud030 LIKE pmda_t.pmdaud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       pmda023 LIKE pmda_t.pmda023, #留置原因
       pmda024 LIKE pmda_t.pmda024, #送貨地址
       pmda025 LIKE pmda_t.pmda025, #帳款地址
       pmda209 LIKE pmda_t.pmda209, #包裝總金額
       pmda210 LIKE pmda_t.pmda210, #品種數
       pmda211 LIKE pmda_t.pmda211, #需求時間
       pmda027 LIKE pmda_t.pmda027, #前端單號
       pmda028 LIKE pmda_t.pmda028  #前端類型
END RECORD
#161109-00085#27-e

DEFINE l_oobn003     LIKE oobn_t.oobn003

   LET r_success = TRUE
   
   INITIALIZE l_pmda.* TO NULL
   
   LET l_prog = "apmt400"
   
   #獲取後置請購單別
   CALL s_aooi210_get_doc(g_site,'','4',g_sfaa_m.sfaadocno,l_prog,'') RETURNING l_success,l_oobn003
   IF NOT l_success THEN
      LET r_success = FALSE  
      RETURN r_success,l_pmda.pmdadocno
   END IF
   
   LET l_pmda.pmdaownid = g_user
   LET l_pmda.pmdaowndp = g_dept
   LET l_pmda.pmdacrtid = g_user
   LET l_pmda.pmdacrtdp = g_dept 
   LET l_pmda.pmdacrtdt = cl_get_current()
   LET l_pmda.pmdamodid = g_user
   LET l_pmda.pmdamoddt = cl_get_current()
   LET l_pmdacrtdt = cl_get_current()
   
   LET l_pmda.pmdastus = 'N'
    
   LET l_pmda.pmda001 = "0"
   LET l_pmda.pmdastus = "N"
   LET l_pmda.pmda004 = "N"
   LET l_pmda.pmda012 = "N"
   LET l_pmda.pmda008 = "0"
   LET l_pmda.pmda009 = "0"
   LET l_pmda.pmda020 = "Y"
    
   LET l_pmda.pmdasite = g_site
   
   LET l_pmda.pmdadocdt = g_today
   LET l_pmda.pmda002 = g_user
   LET l_pmda.pmda003 = g_dept
   LET l_pmda.pmda007 = l_pmda.pmda003
     
   CALL s_aooi200_gen_docno(g_site,l_oobn003,g_today,l_prog) RETURNING l_success,l_pmda.pmdadocno
   IF NOT l_success THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'apm-00003'
      LET g_errparam.extend = l_pmda.pmdadocno
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE  
      RETURN r_success,l_pmda.pmdadocno
   END IF
   
   INSERT INTO pmda_t (pmdaent,pmdasite,pmdadocno,pmda001,pmdadocdt,pmda002,pmda003,pmdastus, 
       pmda004,pmda010,pmda011,pmda012,pmda005,pmda008,pmda009,pmda007,pmda021,pmda020,pmda006, 
       pmda023,pmda022,pmda024,pmda025,pmdaownid,pmdaowndp,pmdacrtid,pmdacrtdp,pmdacrtdt, 
       pmdamodid,pmdamoddt,pmdacnfid,pmdacnfdt)
   VALUES (g_enterprise,l_pmda.pmdasite,l_pmda.pmdadocno,l_pmda.pmda001,l_pmda.pmdadocdt, 
       l_pmda.pmda002,l_pmda.pmda003,l_pmda.pmdastus,l_pmda.pmda004,l_pmda.pmda010, 
       l_pmda.pmda011,l_pmda.pmda012,l_pmda.pmda005,l_pmda.pmda008,l_pmda.pmda009, 
       l_pmda.pmda007,l_pmda.pmda021,l_pmda.pmda020,l_pmda.pmda006,l_pmda.pmda023, 
       l_pmda.pmda022,l_pmda.pmda024,l_pmda.pmda025,l_pmda.pmdaownid,l_pmda.pmdaowndp, 
       l_pmda.pmdacrtid,l_pmda.pmdacrtdp,l_pmdacrtdt,l_pmda.pmdamodid,l_pmdacrtdt, 
       l_pmda.pmdacnfid,l_pmda.pmdacnfdt) 
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "l_pmda:",SQLERRMESSAGE 
      LET g_errparam.code   = SQLCA.sqlcode 
      LET g_errparam.popup  = TRUE 
      CALL s_transaction_end('N','0')
      CALL cl_err()
      LET r_success = FALSE  
      RETURN r_success,l_pmda.pmdadocno
   END IF
   
   RETURN r_success,l_pmda.pmdadocno
    
END FUNCTION

################################################################################
# Descriptions...: 轉請購單單身
# Memo...........:
# Usage..........: CALL asft300_gen_apmt400_pmdb(p_pmdadocno)
#                  RETURNING r_success,r_count
# Date & Author..: 2016/08/30 By lixiang
# Modify.........: #160727-00025#1
################################################################################
PRIVATE FUNCTION asft300_gen_apmt400_pmdb(p_pmdadocno)
DEFINE p_pmdadocno   LIKE pmda_t.pmdadocno
DEFINE l_success     LIKE type_t.num5
DEFINE r_success     LIKE type_t.num5
DEFINE r_count       LIKE type_t.num10
#161109-00085#27-s
#DEFINE l_pmda        RECORD LIKE pmda_t.*
DEFINE l_pmda RECORD  #請購單單頭頭檔
       pmdaent LIKE pmda_t.pmdaent, #企業編號
       pmdaownid LIKE pmda_t.pmdaownid, #資料所有者
       pmdaowndp LIKE pmda_t.pmdaowndp, #資料所屬部門
       pmdacrtid LIKE pmda_t.pmdacrtid, #資料建立者
       pmdacrtdp LIKE pmda_t.pmdacrtdp, #資料建立部門
       pmdacrtdt LIKE pmda_t.pmdacrtdt, #資料創建日
       pmdamodid LIKE pmda_t.pmdamodid, #資料修改者
       pmdamoddt LIKE pmda_t.pmdamoddt, #最近修改日
       pmdacnfid LIKE pmda_t.pmdacnfid, #資料確認者
       pmdacnfdt LIKE pmda_t.pmdacnfdt, #資料確認日
       pmdapstid LIKE pmda_t.pmdapstid, #資料過帳者
       pmdapstdt LIKE pmda_t.pmdapstdt, #資料過帳日
       pmdastus LIKE pmda_t.pmdastus, #狀態碼
       pmdasite LIKE pmda_t.pmdasite, #營運據點
       pmdadocno LIKE pmda_t.pmdadocno, #請購單號
       pmdadocdt LIKE pmda_t.pmdadocdt, #請購日期
       pmda001 LIKE pmda_t.pmda001, #版次
       pmda002 LIKE pmda_t.pmda002, #請購人員
       pmda003 LIKE pmda_t.pmda003, #請購部門
       pmda004 LIKE pmda_t.pmda004, #單價為必要輸入
       pmda005 LIKE pmda_t.pmda005, #幣別
       pmda006 LIKE pmda_t.pmda006, #No Use
       pmda007 LIKE pmda_t.pmda007, #費用部門
       pmda008 LIKE pmda_t.pmda008, #請購總未稅金額
       pmda009 LIKE pmda_t.pmda009, #請購總含稅金額
       pmda010 LIKE pmda_t.pmda010, #稅別
       pmda011 LIKE pmda_t.pmda011, #稅率
       pmda012 LIKE pmda_t.pmda012, #單價含稅否
       pmda020 LIKE pmda_t.pmda020, #納入APS計算
       pmda021 LIKE pmda_t.pmda021, #運送方式
       pmda022 LIKE pmda_t.pmda022, #備註
       pmda200 LIKE pmda_t.pmda200, #來源類型
       pmda201 LIKE pmda_t.pmda201, #採購方式
       pmda202 LIKE pmda_t.pmda202, #所屬品類
       pmda203 LIKE pmda_t.pmda203, #需求組織
       pmda204 LIKE pmda_t.pmda204, #採購中心
       pmda205 LIKE pmda_t.pmda205, #配送中心
       pmda206 LIKE pmda_t.pmda206, #配送倉
       pmda207 LIKE pmda_t.pmda207, #到貨日期
       pmda208 LIKE pmda_t.pmda208, #包裝總數量
       pmda900 LIKE pmda_t.pmda900, #保留欄位str
       pmda999 LIKE pmda_t.pmda999, #保留欄位end
       #161109-00085#66 --s add
       pmdaud001 LIKE pmda_t.pmdaud001, #自定義欄位(文字)001
       pmdaud002 LIKE pmda_t.pmdaud002, #自定義欄位(文字)002
       pmdaud003 LIKE pmda_t.pmdaud003, #自定義欄位(文字)003
       pmdaud004 LIKE pmda_t.pmdaud004, #自定義欄位(文字)004
       pmdaud005 LIKE pmda_t.pmdaud005, #自定義欄位(文字)005
       pmdaud006 LIKE pmda_t.pmdaud006, #自定義欄位(文字)006
       pmdaud007 LIKE pmda_t.pmdaud007, #自定義欄位(文字)007
       pmdaud008 LIKE pmda_t.pmdaud008, #自定義欄位(文字)008
       pmdaud009 LIKE pmda_t.pmdaud009, #自定義欄位(文字)009
       pmdaud010 LIKE pmda_t.pmdaud010, #自定義欄位(文字)010
       pmdaud011 LIKE pmda_t.pmdaud011, #自定義欄位(數字)011
       pmdaud012 LIKE pmda_t.pmdaud012, #自定義欄位(數字)012
       pmdaud013 LIKE pmda_t.pmdaud013, #自定義欄位(數字)013
       pmdaud014 LIKE pmda_t.pmdaud014, #自定義欄位(數字)014
       pmdaud015 LIKE pmda_t.pmdaud015, #自定義欄位(數字)015
       pmdaud016 LIKE pmda_t.pmdaud016, #自定義欄位(數字)016
       pmdaud017 LIKE pmda_t.pmdaud017, #自定義欄位(數字)017
       pmdaud018 LIKE pmda_t.pmdaud018, #自定義欄位(數字)018
       pmdaud019 LIKE pmda_t.pmdaud019, #自定義欄位(數字)019
       pmdaud020 LIKE pmda_t.pmdaud020, #自定義欄位(數字)020
       pmdaud021 LIKE pmda_t.pmdaud021, #自定義欄位(日期時間)021
       pmdaud022 LIKE pmda_t.pmdaud022, #自定義欄位(日期時間)022
       pmdaud023 LIKE pmda_t.pmdaud023, #自定義欄位(日期時間)023
       pmdaud024 LIKE pmda_t.pmdaud024, #自定義欄位(日期時間)024
       pmdaud025 LIKE pmda_t.pmdaud025, #自定義欄位(日期時間)025
       pmdaud026 LIKE pmda_t.pmdaud026, #自定義欄位(日期時間)026
       pmdaud027 LIKE pmda_t.pmdaud027, #自定義欄位(日期時間)027
       pmdaud028 LIKE pmda_t.pmdaud028, #自定義欄位(日期時間)028
       pmdaud029 LIKE pmda_t.pmdaud029, #自定義欄位(日期時間)029
       pmdaud030 LIKE pmda_t.pmdaud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       pmda023 LIKE pmda_t.pmda023, #留置原因
       pmda024 LIKE pmda_t.pmda024, #送貨地址
       pmda025 LIKE pmda_t.pmda025, #帳款地址
       pmda209 LIKE pmda_t.pmda209, #包裝總金額
       pmda210 LIKE pmda_t.pmda210, #品種數
       pmda211 LIKE pmda_t.pmda211, #需求時間
       pmda027 LIKE pmda_t.pmda027, #前端單號
       pmda028 LIKE pmda_t.pmda028  #前端類型
END RECORD
#161109-00085#27-e
#161109-00085#27-s
#DEFINE l_pmdb        RECORD LIKE pmdb_t.*
DEFINE l_pmdb RECORD  #請購單明細檔
       pmdbent LIKE pmdb_t.pmdbent, #企業編號
       pmdbsite LIKE pmdb_t.pmdbsite, #營運據點
       pmdbdocno LIKE pmdb_t.pmdbdocno, #請購單號
       pmdbseq LIKE pmdb_t.pmdbseq, #項次
       pmdb001 LIKE pmdb_t.pmdb001, #來源單號
       pmdb002 LIKE pmdb_t.pmdb002, #來源項次
       pmdb003 LIKE pmdb_t.pmdb003, #來源項序
       pmdb004 LIKE pmdb_t.pmdb004, #料件編號
       pmdb005 LIKE pmdb_t.pmdb005, #產品特徵
       pmdb006 LIKE pmdb_t.pmdb006, #需求數量
       pmdb007 LIKE pmdb_t.pmdb007, #單位
       pmdb008 LIKE pmdb_t.pmdb008, #參考數量
       pmdb009 LIKE pmdb_t.pmdb009, #參考單位
       pmdb010 LIKE pmdb_t.pmdb010, #計價數量
       pmdb011 LIKE pmdb_t.pmdb011, #計價單位
       pmdb012 LIKE pmdb_t.pmdb012, #包裝容器
       pmdb014 LIKE pmdb_t.pmdb014, #供應商選擇
       pmdb015 LIKE pmdb_t.pmdb015, #供應商編號
       pmdb016 LIKE pmdb_t.pmdb016, #付款條件
       pmdb017 LIKE pmdb_t.pmdb017, #交易條件
       pmdb018 LIKE pmdb_t.pmdb018, #稅率
       pmdb019 LIKE pmdb_t.pmdb019, #參考單價
       pmdb020 LIKE pmdb_t.pmdb020, #參考未稅金額
       pmdb021 LIKE pmdb_t.pmdb021, #參考含稅金額
       pmdb030 LIKE pmdb_t.pmdb030, #需求日期
       pmdb031 LIKE pmdb_t.pmdb031, #理由碼
       pmdb032 LIKE pmdb_t.pmdb032, #行狀態
       pmdb033 LIKE pmdb_t.pmdb033, #緊急度
       pmdb034 LIKE pmdb_t.pmdb034, #專案編號
       pmdb035 LIKE pmdb_t.pmdb035, #WBS
       pmdb036 LIKE pmdb_t.pmdb036, #活動編號
       pmdb037 LIKE pmdb_t.pmdb037, #收貨據點
       pmdb038 LIKE pmdb_t.pmdb038, #收貨庫位
       pmdb039 LIKE pmdb_t.pmdb039, #收貨儲位
       pmdb040 LIKE pmdb_t.pmdb040, #no use
       pmdb041 LIKE pmdb_t.pmdb041, #允許部份交貨
       pmdb042 LIKE pmdb_t.pmdb042, #允許提前交貨
       pmdb043 LIKE pmdb_t.pmdb043, #保稅
       pmdb044 LIKE pmdb_t.pmdb044, #納入APS
       pmdb045 LIKE pmdb_t.pmdb045, #交期凍結否
       pmdb046 LIKE pmdb_t.pmdb046, #費用部門
       pmdb048 LIKE pmdb_t.pmdb048, #收貨時段
       pmdb049 LIKE pmdb_t.pmdb049, #已轉採購量
       pmdb050 LIKE pmdb_t.pmdb050, #備註
       pmdb051 LIKE pmdb_t.pmdb051, #結案/留置理由碼
       pmdb200 LIKE pmdb_t.pmdb200, #商品條碼
       pmdb201 LIKE pmdb_t.pmdb201, #包裝單位
       pmdb202 LIKE pmdb_t.pmdb202, #件裝數
       pmdb203 LIKE pmdb_t.pmdb203, #配送中心
       pmdb204 LIKE pmdb_t.pmdb204, #配送倉庫
       pmdb205 LIKE pmdb_t.pmdb205, #採購中心
       pmdb206 LIKE pmdb_t.pmdb206, #採購員
       pmdb207 LIKE pmdb_t.pmdb207, #採購方式
       pmdb208 LIKE pmdb_t.pmdb208, #經營方式
       pmdb209 LIKE pmdb_t.pmdb209, #結算方式
       pmdb210 LIKE pmdb_t.pmdb210, #促銷開始日
       pmdb211 LIKE pmdb_t.pmdb211, #促銷結束日
       pmdb212 LIKE pmdb_t.pmdb212, #要貨件數
       pmdb250 LIKE pmdb_t.pmdb250, #合理庫存
       pmdb251 LIKE pmdb_t.pmdb251, #最高庫存
       pmdb252 LIKE pmdb_t.pmdb252, #現有庫存
       pmdb253 LIKE pmdb_t.pmdb253, #入庫在途量
       pmdb254 LIKE pmdb_t.pmdb254, #前一週銷量
       pmdb255 LIKE pmdb_t.pmdb255, #前二週銷量
       pmdb256 LIKE pmdb_t.pmdb256, #前三週銷量
       pmdb257 LIKE pmdb_t.pmdb257, #前四週銷量
       pmdb258 LIKE pmdb_t.pmdb258, #要貨在途量
       pmdb259 LIKE pmdb_t.pmdb259, #週平均銷量
       pmdb900 LIKE pmdb_t.pmdb900, #保留欄位str
       pmdb999 LIKE pmdb_t.pmdb999, #保留欄位end
       #161109-00085#66 --s add
       pmdbud001 LIKE pmdb_t.pmdbud001, #自定義欄位(文字)001
       pmdbud002 LIKE pmdb_t.pmdbud002, #自定義欄位(文字)002
       pmdbud003 LIKE pmdb_t.pmdbud003, #自定義欄位(文字)003
       pmdbud004 LIKE pmdb_t.pmdbud004, #自定義欄位(文字)004
       pmdbud005 LIKE pmdb_t.pmdbud005, #自定義欄位(文字)005
       pmdbud006 LIKE pmdb_t.pmdbud006, #自定義欄位(文字)006
       pmdbud007 LIKE pmdb_t.pmdbud007, #自定義欄位(文字)007
       pmdbud008 LIKE pmdb_t.pmdbud008, #自定義欄位(文字)008
       pmdbud009 LIKE pmdb_t.pmdbud009, #自定義欄位(文字)009
       pmdbud010 LIKE pmdb_t.pmdbud010, #自定義欄位(文字)010
       pmdbud011 LIKE pmdb_t.pmdbud011, #自定義欄位(數字)011
       pmdbud012 LIKE pmdb_t.pmdbud012, #自定義欄位(數字)012
       pmdbud013 LIKE pmdb_t.pmdbud013, #自定義欄位(數字)013
       pmdbud014 LIKE pmdb_t.pmdbud014, #自定義欄位(數字)014
       pmdbud015 LIKE pmdb_t.pmdbud015, #自定義欄位(數字)015
       pmdbud016 LIKE pmdb_t.pmdbud016, #自定義欄位(數字)016
       pmdbud017 LIKE pmdb_t.pmdbud017, #自定義欄位(數字)017
       pmdbud018 LIKE pmdb_t.pmdbud018, #自定義欄位(數字)018
       pmdbud019 LIKE pmdb_t.pmdbud019, #自定義欄位(數字)019
       pmdbud020 LIKE pmdb_t.pmdbud020, #自定義欄位(數字)020
       pmdbud021 LIKE pmdb_t.pmdbud021, #自定義欄位(日期時間)021
       pmdbud022 LIKE pmdb_t.pmdbud022, #自定義欄位(日期時間)022
       pmdbud023 LIKE pmdb_t.pmdbud023, #自定義欄位(日期時間)023
       pmdbud024 LIKE pmdb_t.pmdbud024, #自定義欄位(日期時間)024
       pmdbud025 LIKE pmdb_t.pmdbud025, #自定義欄位(日期時間)025
       pmdbud026 LIKE pmdb_t.pmdbud026, #自定義欄位(日期時間)026
       pmdbud027 LIKE pmdb_t.pmdbud027, #自定義欄位(日期時間)027
       pmdbud028 LIKE pmdb_t.pmdbud028, #自定義欄位(日期時間)028
       pmdbud029 LIKE pmdb_t.pmdbud029, #自定義欄位(日期時間)029
       pmdbud030 LIKE pmdb_t.pmdbud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       pmdb260 LIKE pmdb_t.pmdb260, #收貨部門
       pmdb052 LIKE pmdb_t.pmdb052, #來源分批序
       pmdb227 LIKE pmdb_t.pmdb227, #補貨規格說明
       pmdb053 LIKE pmdb_t.pmdb053, #預算細項
       pmdb213 LIKE pmdb_t.pmdb213, #參考進價
       pmdb054 LIKE pmdb_t.pmdb054, #庫存管理特徵
       pmdb214 LIKE pmdb_t.pmdb214  #需求時間
END RECORD
#161109-00085#27-e

DEFINE l_sfba014     LIKE sfba_t.sfba014   #工單備料單身的單位
DEFINE l_sfba013     LIKE sfba_t.sfba013   #總應發數量
DEFINE l_pmdb006     LIKE pmdb_t.pmdb006
DEFINE l_slip        LIKE pmda_t.pmdadocno
DEFINE l_pmdb007     LIKE pmdb_t.pmdb007
DEFINE l_imaf171     LIKE imaf_t.imaf171
DEFINE l_imaf172     LIKE imaf_t.imaf172
DEFINE l_imaf173     LIKE imaf_t.imaf173
DEFINE l_imaf174     LIKE imaf_t.imaf174
DEFINE l_imaf175     LIKE imaf_t.imaf175
DEFINE l_time1       LIKE imaf_t.imaf171
DEFINE l_time2       LIKE imaf_t.imaf171
   
   LET r_success = TRUE
   LET r_count = 0
   
   INITIALIZE l_pmda.* TO NULL
   INITIALIZE l_pmdb.* TO NULL
   #161109-00085#27-s
   #SELECT * INTO l_pmda.* FROM pmda_t WHERE pmdaent = g_enterprise AND pmdadocno = p_pmdadocno
   #161109-00085#66 --s mark
   #SELECT pmdaent,pmdaownid,pmdaowndp,pmdacrtid,pmdacrtdp,pmdacrtdt,pmdamodid,pmdamoddt,pmdacnfid,pmdacnfdt,
   #       pmdapstid,pmdapstdt,pmdastus,pmdasite,pmdadocno,pmdadocdt,pmda001,pmda002,pmda003,pmda004,
   #       pmda005,pmda006,pmda007,pmda008,pmda009,pmda010,pmda011,pmda012,pmda020,pmda021,
   #       pmda022,pmda200,pmda201,pmda202,pmda203,pmda204,pmda205,pmda206,pmda207,pmda208,
   #       pmda900,pmda999,pmda023,pmda024,pmda025,pmda209,pmda210,pmda211,pmda027,pmda028 
   #  INTO l_pmda.pmdaent,l_pmda.pmdaownid,l_pmda.pmdaowndp,l_pmda.pmdacrtid,l_pmda.pmdacrtdp,
   #       l_pmda.pmdacrtdt,l_pmda.pmdamodid,l_pmda.pmdamoddt,l_pmda.pmdacnfid,l_pmda.pmdacnfdt,
   #       l_pmda.pmdapstid,l_pmda.pmdapstdt,l_pmda.pmdastus,l_pmda.pmdasite,l_pmda.pmdadocno,
   #       l_pmda.pmdadocdt,l_pmda.pmda001,l_pmda.pmda002,l_pmda.pmda003,l_pmda.pmda004,
   #       l_pmda.pmda005,l_pmda.pmda006,l_pmda.pmda007,l_pmda.pmda008,l_pmda.pmda009,
   #       l_pmda.pmda010,l_pmda.pmda011,l_pmda.pmda012,l_pmda.pmda020,l_pmda.pmda021,
   #       l_pmda.pmda022,l_pmda.pmda200,l_pmda.pmda201,l_pmda.pmda202,l_pmda.pmda203,
   #       l_pmda.pmda204,l_pmda.pmda205,l_pmda.pmda206,l_pmda.pmda207,l_pmda.pmda208,
   #       l_pmda.pmda900,l_pmda.pmda999,l_pmda.pmda023,l_pmda.pmda024,l_pmda.pmda025,
   #       l_pmda.pmda209,l_pmda.pmda210,l_pmda.pmda211,l_pmda.pmda027,l_pmda.pmda028
   #161109-00085#66 --e mark
   #161109-00085#66 --s add
   SELECT pmdaent,pmdaownid,pmdaowndp,pmdacrtid,pmdacrtdp,
          pmdacrtdt,pmdamodid,pmdamoddt,pmdacnfid,pmdacnfdt,
          pmdapstid,pmdapstdt,pmdastus,pmdasite,pmdadocno,
          pmdadocdt,pmda001,pmda002,pmda003,pmda004,
          pmda005,pmda006,pmda007,pmda008,pmda009,
          pmda010,pmda011,pmda012,pmda020,pmda021,
          pmda022,pmda200,pmda201,pmda202,pmda203,
          pmda204,pmda205,pmda206,pmda207,pmda208,
          pmda900,pmda999,pmdaud001,pmdaud002,pmdaud003,
          pmdaud004,pmdaud005,pmdaud006,pmdaud007,pmdaud008,
          pmdaud009,pmdaud010,pmdaud011,pmdaud012,pmdaud013,
          pmdaud014,pmdaud015,pmdaud016,pmdaud017,pmdaud018,
          pmdaud019,pmdaud020,pmdaud021,pmdaud022,pmdaud023,
          pmdaud024,pmdaud025,pmdaud026,pmdaud027,pmdaud028,
          pmdaud029,pmdaud030,pmda023,pmda024,pmda025,
          pmda209,pmda210,pmda211,pmda027,pmda028
     INTO l_pmda.pmdaent,l_pmda.pmdaownid,l_pmda.pmdaowndp,l_pmda.pmdacrtid,l_pmda.pmdacrtdp,
          l_pmda.pmdacrtdt,l_pmda.pmdamodid,l_pmda.pmdamoddt,l_pmda.pmdacnfid,l_pmda.pmdacnfdt,
          l_pmda.pmdapstid,l_pmda.pmdapstdt,l_pmda.pmdastus,l_pmda.pmdasite,l_pmda.pmdadocno,
          l_pmda.pmdadocdt,l_pmda.pmda001,l_pmda.pmda002,l_pmda.pmda003,l_pmda.pmda004,
          l_pmda.pmda005,l_pmda.pmda006,l_pmda.pmda007,l_pmda.pmda008,l_pmda.pmda009,
          l_pmda.pmda010,l_pmda.pmda011,l_pmda.pmda012,l_pmda.pmda020,l_pmda.pmda021,
          l_pmda.pmda022,l_pmda.pmda200,l_pmda.pmda201,l_pmda.pmda202,l_pmda.pmda203,
          l_pmda.pmda204,l_pmda.pmda205,l_pmda.pmda206,l_pmda.pmda207,l_pmda.pmda208,
          l_pmda.pmda900,l_pmda.pmda999,l_pmda.pmdaud001,l_pmda.pmdaud002,l_pmda.pmdaud003,
          l_pmda.pmdaud004,l_pmda.pmdaud005,l_pmda.pmdaud006,l_pmda.pmdaud007,l_pmda.pmdaud008,
          l_pmda.pmdaud009,l_pmda.pmdaud010,l_pmda.pmdaud011,l_pmda.pmdaud012,l_pmda.pmdaud013,
          l_pmda.pmdaud014,l_pmda.pmdaud015,l_pmda.pmdaud016,l_pmda.pmdaud017,l_pmda.pmdaud018,
          l_pmda.pmdaud019,l_pmda.pmdaud020,l_pmda.pmdaud021,l_pmda.pmdaud022,l_pmda.pmdaud023,
          l_pmda.pmdaud024,l_pmda.pmdaud025,l_pmda.pmdaud026,l_pmda.pmdaud027,l_pmda.pmdaud028,
          l_pmda.pmdaud029,l_pmda.pmdaud030,l_pmda.pmda023,l_pmda.pmda024,l_pmda.pmda025,
          l_pmda.pmda209,l_pmda.pmda210,l_pmda.pmda211,l_pmda.pmda027,l_pmda.pmda028
   #161109-00085#66 --e add
     FROM pmda_t
    WHERE pmdaent = g_enterprise AND pmdadocno = p_pmdadocno        
   #161109-00085#27-e   
   DECLARE asft300_ins_pmdb CURSOR FOR
      SELECT sfbadocno,sfbaseq,sfbaseq1,sfba006,sfba021,sfba014,sfba013 FROM sfba_t,imaf_t 
       WHERE sfbaent = imafent AND sfba006 = imaf001 AND imafsite = g_site AND imaf013 = '1'
         AND sfbaent = g_enterprise AND sfbadocno = g_sfaa_m.sfaadocno 
         AND sfba006 NOT IN (SELECT sfaa010 FROM sfaa_t WHERE sfaaent = g_enterprise AND sfaa005 = '4' AND sfaa021 = g_sfaa_m.sfaadocno AND sfaastus <> 'X')
      
   FOREACH asft300_ins_pmdb INTO l_pmdb.pmdb001,l_pmdb.pmdb002,l_pmdb.pmdb003,l_pmdb.pmdb004,l_pmdb.pmdb005,
                                 l_sfba014,l_sfba013
                                 
      LET l_pmdb.pmdbent = g_enterprise
      LET l_pmdb.pmdbsite = g_site
      LET l_pmdb.pmdbdocno = p_pmdadocno
      LET l_pmdb.pmdb037 = g_site
      
      LET l_pmdb.pmdb014 = "1"
      LET l_pmdb.pmdb019 = 0
      LET l_pmdb.pmdb043 = "N"
      
      LET l_pmdb.pmdb030 = g_sfaa_m.sfaa019  #需求日期 = 預計開工日
      
      LET l_pmdb.pmdb032 = "1"    #行狀態
      LET l_pmdb.pmdb033 = "1"   #緊急度
      LET l_pmdb.pmdb034 = g_sfaa_m.sfaa028
      LET l_pmdb.pmdb035 = g_sfaa_m.sfaa029
      LET l_pmdb.pmdb036 = g_sfaa_m.sfaa030
      
      LET l_pmdb.pmdb049 = 0     #已轉採購量
      
      LET l_pmdb.pmdb018 = l_pmda.pmda011  #稅率
      LET l_pmdb.pmdb020 = 0
      LET l_pmdb.pmdb021 = 0
      
      LET l_pmdb.pmdb046 = l_pmda.pmda007  #費用部門
      
      LET l_pmdb.pmdb044 = l_pmda.pmda020  #MRP/MPS計算
      LET l_pmdb.pmdb045 = "N"   #MRP交期凍結
      LET l_pmdb.pmdb041 = "N"   #允許部分交貨
      LET l_pmdb.pmdb042 = "N"   #允許提前交貨
       
      #預帶預設庫位的值，aooi200抓值優先順序：預設欄位>應用參數
      IF cl_null(l_pmdb.pmdb038) THEN
         #預設欄位
         CALL s_aooi200_get_slip(p_pmdadocno) RETURNING l_success,l_slip
         IF l_success THEN
            CALL s_aooi200_get_doc_default(g_site,'1',l_slip,'pmdb038',l_pmdb.pmdb038) RETURNING l_pmdb.pmdb038
            #應用參數
            IF cl_null(l_pmdb.pmdb038) THEN
               CALL cl_get_doc_para(g_enterprise,g_site,l_slip,'D-MFG-0076') RETURNING l_pmdb.pmdb038
            END IF
         END IF          
      END IF
      
      #採購單位、參考單位、收貨時段、慣用包裝容器
      SELECT imaf143,imaf015,imaf176,imaf157 INTO l_pmdb.pmdb007,l_pmdb.pmdb009,l_pmdb.pmdb048,l_pmdb.pmdb012
         FROM imaf_t
         WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = l_pmdb.pmdb004
      
      #計算可以轉請購數量
      DECLARE pmdb006_cs CURSOR FOR
         SELECT pmdb006,pmdb007 FROM pmda_t,pmdb_t 
            WHERE pmdaent = pmdbent AND pmdadocno = pmdbdocno AND pmdastus <> 'X' AND pmdaent = g_enterprise
              AND pmdb001 = l_pmdb.pmdb001 AND pmdb002 = l_pmdb.pmdb002 AND pmdb003 = l_pmdb.pmdb003
      FOREACH pmdb006_cs INTO l_pmdb006,l_pmdb007
         IF l_pmdb007 <> l_sfba014 THEN
            CALL s_aooi250_convert_qty(l_pmdb.pmdb004,l_pmdb007,l_sfba014,l_pmdb006)
              RETURNING l_success,l_pmdb006
         END IF
         LET l_sfba013 = l_sfba013 - l_pmdb006  #總應發數量 - 已轉請購量
      END FOREACH
      
      IF l_sfba013 = 0 THEN
         CONTINUE FOREACH
      END IF
      
      IF l_pmdb.pmdb007 <> l_sfba014 THEN
         CALL s_aooi250_convert_qty(l_pmdb.pmdb004,l_sfba014,l_pmdb.pmdb007,l_sfba013)
           RETURNING l_success,l_pmdb.pmdb006
      ELSE
         LET l_pmdb.pmdb006 = l_sfba013
      END IF
      
      IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" THEN  #體參數使用採購計價單位
         SELECT imaf144 INTO l_pmdb.pmdb011 FROM imaf_t
            WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = l_pmdb.pmdb004                     
      END IF
                   
      #計算參考數量
      IF NOT cl_null(l_pmdb.pmdb009) THEN
         CALL s_aooi250_convert_qty(l_pmdb.pmdb004,l_pmdb.pmdb007,l_pmdb.pmdb009,l_pmdb.pmdb006)
           RETURNING l_success,l_pmdb.pmdb008
      END IF
      
      #若參數有使用計價單位時，則輸入[C:需求數量]時則應自動推算計價數量，
      #[C:計價數量]=[C:需求數量]*[C:單位]與[C:計價單位]換算率
      IF (cl_get_para(g_enterprise,g_site,'S-BAS-0019')) = "Y" AND (NOT cl_null(l_pmdb.pmdb011)) THEN  #體參數使用採購計價單位
         CALL s_aooi250_convert_qty(l_pmdb.pmdb004,l_pmdb.pmdb007,l_pmdb.pmdb011,l_pmdb.pmdb006)
           RETURNING l_success,l_pmdb.pmdb010
      ELSE
         LET l_pmdb.pmdb010 = l_pmdb.pmdb006
         LET l_pmdb.pmdb011 = l_pmdb.pmdb007
      END IF
      
      #計算緊急度
      SELECT imaf171,imaf172,imaf173,imaf174,imaf175 INTO l_imaf171,l_imaf172,l_imaf173,l_imaf174,l_imaf175
        FROM imaf_t 
        WHERE imafent = g_enterprise AND imafsite = g_site AND imaf001 = l_pmdb.pmdb004
      LET l_time1 = l_pmdb.pmdb030 - g_today         #需求日期 - g_today
      LET l_time2 = l_imaf171+l_imaf172+l_imaf173+l_imaf174  #[T:料件據點進銷存檔]設置的(文件+交貨+到廠+入庫)前置天數
      
      #1.若輸入的需求日期 - g_today >[T:料件據點進銷存檔]設置的(文件+交貨+到廠+入庫)前置天數時，則[C:緊急度] = '1'(一般)
      IF l_time1 >= l_time2 THEN
         LET l_pmdb.pmdb033 = '1'
      END IF
      
      #2.若輸入的需求日期 - g_today <[T:料件據點進銷存檔]設置的(文件+交貨+到廠+入庫)前置天數，
      #   且需求日期 - g_today >[T:料件據點進銷存檔].[C:嚴守交期前置時間]時，則[C:緊急度] = '2'(緊急)
      IF l_time1 < l_time2 AND l_time1 >= l_imaf175 THEN
         LET l_pmdb.pmdb033 = '2'
      END IF
      
      #3.若輸入的需求日期 - g_today <[T:料件據點進銷存檔].[C:嚴守交期前置時間]時，則[C:緊急度] = '3'(特急)
      IF l_time1 < l_imaf175 THEN
         LET l_pmdb.pmdb033 = '3'
      END IF
      
      SELECT MAX(pmdbseq)+1 INTO l_pmdb.pmdbseq FROM pmdb_t
        WHERE pmdbent = g_enterprise AND pmdbdocno = p_pmdadocno
      IF cl_null(l_pmdb.pmdbseq) OR l_pmdb.pmdbseq = 0 THEN
         LET l_pmdb.pmdbseq = 1
      END IF
      
      INSERT INTO pmdb_t 
            (pmdbent,pmdbsite,pmdbdocno,pmdbseq,pmdb001,pmdb002,pmdb003,pmdb004,pmdb005,pmdb007,pmdb006,
             pmdb009,pmdb008,pmdb011,pmdb010,pmdb030,pmdb048,pmdb031,pmdb050,pmdb032,pmdb051,pmdb033,
             pmdb049,pmdb012,pmdb014,pmdb015,pmdb016,pmdb017,pmdb018,pmdb019,pmdb020,pmdb021,pmdb034,
             pmdb035,pmdb036,pmdb037,pmdb038,pmdb039,pmdb041,pmdb042,pmdb043,pmdb044,pmdb045,pmdb046,pmdb052) 
           VALUES(l_pmdb.pmdbent,l_pmdb.pmdbsite,l_pmdb.pmdbdocno,l_pmdb.pmdbseq,l_pmdb.pmdb001,l_pmdb.pmdb002, 
                  l_pmdb.pmdb003,l_pmdb.pmdb004,l_pmdb.pmdb005,l_pmdb.pmdb007,l_pmdb.pmdb006,l_pmdb.pmdb009, 
                  l_pmdb.pmdb008,l_pmdb.pmdb011,l_pmdb.pmdb010,l_pmdb.pmdb030,l_pmdb.pmdb048,l_pmdb.pmdb031, 
                  l_pmdb.pmdb050,l_pmdb.pmdb032,l_pmdb.pmdb051,l_pmdb.pmdb033,l_pmdb.pmdb049,l_pmdb.pmdb012, 
                  l_pmdb.pmdb014,l_pmdb.pmdb015,l_pmdb.pmdb016,l_pmdb.pmdb017,l_pmdb.pmdb018,l_pmdb.pmdb019, 
                  l_pmdb.pmdb020,l_pmdb.pmdb021,l_pmdb.pmdb034,l_pmdb.pmdb035,l_pmdb.pmdb036,l_pmdb.pmdb037,
                  l_pmdb.pmdb038,l_pmdb.pmdb039,
                  l_pmdb.pmdb041,l_pmdb.pmdb042,l_pmdb.pmdb043,l_pmdb.pmdb044,l_pmdb.pmdb045,l_pmdb.pmdb046,
                  l_pmdb.pmdb052) 
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "pmdb_t"
         LET g_errparam.popup = TRUE
         CALL cl_err()
         LET r_success = FALSE
         RETURN r_success,r_count
      END IF
      
      LET r_count = r_count + 1
                    
      INITIALIZE l_pmdb.* TO NULL       
   END FOREACH

   RETURN r_success,r_count
    
END FUNCTION

################################################################################
# Descriptions...: #变更单单头资料
# Memo...........:
# Usage..........: CALL asft300_gen_sfka()
#                  RETURNING r_success
# Date & Author..: 2016/08/30 By lixiang
# Modify.........: #160727-00025#1
################################################################################
PRIVATE FUNCTION asft300_gen_sfka()
DEFINE r_success              LIKE type_t.num5
#161109-00085#27-s
#DEFINE l_sfka                 RECORD LIKE sfka_t.*
DEFINE l_sfka RECORD  #工單變更單單頭檔
       sfkaent LIKE sfka_t.sfkaent, #企業編號
       sfkasite LIKE sfka_t.sfkasite, #營運據點
       sfkadocno LIKE sfka_t.sfkadocno, #工單單號
       sfkadocdt LIKE sfka_t.sfkadocdt, #開單日期
       sfka001 LIKE sfka_t.sfka001, #變更版本
       sfka002 LIKE sfka_t.sfka002, #生管人員
       sfka003 LIKE sfka_t.sfka003, #工單類型
       sfka004 LIKE sfka_t.sfka004, #發料制度
       sfka005 LIKE sfka_t.sfka005, #工單來源
       sfka006 LIKE sfka_t.sfka006, #來源單號
       sfka007 LIKE sfka_t.sfka007, #來源項次
       sfka008 LIKE sfka_t.sfka008, #來源項序
       sfka009 LIKE sfka_t.sfka009, #參考客戶
       sfka010 LIKE sfka_t.sfka010, #生產料號
       sfka011 LIKE sfka_t.sfka011, #特性
       sfka012 LIKE sfka_t.sfka012, #生產數量
       sfka013 LIKE sfka_t.sfka013, #生產單位
       sfka014 LIKE sfka_t.sfka014, #BOM版本
       sfka015 LIKE sfka_t.sfka015, #BOM有效日期
       sfka016 LIKE sfka_t.sfka016, #製程編號
       sfka017 LIKE sfka_t.sfka017, #部門供應商
       sfka018 LIKE sfka_t.sfka018, #協作據點
       sfka019 LIKE sfka_t.sfka019, #預計開工日
       sfka020 LIKE sfka_t.sfka020, #預計完工日
       sfka021 LIKE sfka_t.sfka021, #母工單單號
       sfka022 LIKE sfka_t.sfka022, #參考原始單號
       sfka023 LIKE sfka_t.sfka023, #參考原始項次
       sfka024 LIKE sfka_t.sfka024, #參考原始項序
       sfka025 LIKE sfka_t.sfka025, #前工單單號
       sfka026 LIKE sfka_t.sfka026, #料表批號(PBI)
       sfka027 LIKE sfka_t.sfka027, #No Use
       sfka028 LIKE sfka_t.sfka028, #專案編號
       sfka029 LIKE sfka_t.sfka029, #WBS
       sfka030 LIKE sfka_t.sfka030, #活動
       sfka031 LIKE sfka_t.sfka031, #理由碼
       sfka032 LIKE sfka_t.sfka032, #緊急比率
       sfka033 LIKE sfka_t.sfka033, #優先順序
       sfka034 LIKE sfka_t.sfka034, #預計入庫庫位
       sfka035 LIKE sfka_t.sfka035, #預計入庫儲位
       sfka036 LIKE sfka_t.sfka036, #手冊編號
       sfka037 LIKE sfka_t.sfka037, #保稅核准文號
       sfka038 LIKE sfka_t.sfka038, #保稅核銷
       sfka039 LIKE sfka_t.sfka039, #備料已產生
       sfka040 LIKE sfka_t.sfka040, #生產途程已確認
       sfka041 LIKE sfka_t.sfka041, #凍結
       sfka042 LIKE sfka_t.sfka042, #重工
       sfka043 LIKE sfka_t.sfka043, #備置
       sfka044 LIKE sfka_t.sfka044, #FQC
       sfka045 LIKE sfka_t.sfka045, #實際開始發料日
       sfka046 LIKE sfka_t.sfka046, #最後入庫日
       sfka047 LIKE sfka_t.sfka047, #生管結案日
       sfka048 LIKE sfka_t.sfka048, #成本結案日
       sfka049 LIKE sfka_t.sfka049, #已發料套數
       sfka050 LIKE sfka_t.sfka050, #已入庫合格量
       sfka051 LIKE sfka_t.sfka051, #已入庫不合格量
       sfka052 LIKE sfka_t.sfka052, #Bouns
       sfka053 LIKE sfka_t.sfka053, #工單轉入數量
       sfka054 LIKE sfka_t.sfka054, #工單轉出數量
       sfka055 LIKE sfka_t.sfka055, #下線數量
       sfka056 LIKE sfka_t.sfka056, #報廢數量
       sfka057 LIKE sfka_t.sfka057, #委外類型
       sfka058 LIKE sfka_t.sfka058, #參考數量
       sfka059 LIKE sfka_t.sfka059, #預計入庫批號
       sfka060 LIKE sfka_t.sfka060, #參考單位
       sfka061 LIKE sfka_t.sfka061, #製程
       sfka062 LIKE sfka_t.sfka062, #納入MRP/MPS計算
       sfka900 LIKE sfka_t.sfka900, #變更序
       sfka901 LIKE sfka_t.sfka901, #變更類型
       sfka902 LIKE sfka_t.sfka902, #變更日期
       sfka905 LIKE sfka_t.sfka905, #變更理由
       sfka906 LIKE sfka_t.sfka906, #變更備註
       sfkaownid LIKE sfka_t.sfkaownid, #資料所有者
       sfkaowndp LIKE sfka_t.sfkaowndp, #資料所屬部門
       sfkacrtid LIKE sfka_t.sfkacrtid, #資料建立者
       sfkacrtdp LIKE sfka_t.sfkacrtdp, #資料建立部門
       sfkacrtdt LIKE sfka_t.sfkacrtdt, #資料創建日
       sfkamodid LIKE sfka_t.sfkamodid, #資料修改者
       sfkamoddt LIKE sfka_t.sfkamoddt, #最近修改日
       sfkacnfid LIKE sfka_t.sfkacnfid, #資料確認者
       sfkacnfdt LIKE sfka_t.sfkacnfdt, #資料確認日
       sfkapstid LIKE sfka_t.sfkapstid, #資料過帳者
       sfkapstdt LIKE sfka_t.sfkapstdt, #資料過帳日
       sfkastus LIKE sfka_t.sfkastus, #狀態碼
       sfkaacti LIKE sfka_t.sfkaacti, #工單結案
       sfka063 LIKE sfka_t.sfka063, #來源分批序
       sfka064 LIKE sfka_t.sfka064, #參考來源分批序
       sfka065 LIKE sfka_t.sfka065, #生管結案狀態
       #161109-00085#66 --s add
       sfkaud001 LIKE sfka_t.sfkaud001, #自定義欄位(文字)001
       sfkaud002 LIKE sfka_t.sfkaud002, #自定義欄位(文字)002
       sfkaud003 LIKE sfka_t.sfkaud003, #自定義欄位(文字)003
       sfkaud004 LIKE sfka_t.sfkaud004, #自定義欄位(文字)004
       sfkaud005 LIKE sfka_t.sfkaud005, #自定義欄位(文字)005
       sfkaud006 LIKE sfka_t.sfkaud006, #自定義欄位(文字)006
       sfkaud007 LIKE sfka_t.sfkaud007, #自定義欄位(文字)007
       sfkaud008 LIKE sfka_t.sfkaud008, #自定義欄位(文字)008
       sfkaud009 LIKE sfka_t.sfkaud009, #自定義欄位(文字)009
       sfkaud010 LIKE sfka_t.sfkaud010, #自定義欄位(文字)010
       sfkaud011 LIKE sfka_t.sfkaud011, #自定義欄位(數字)011
       sfkaud012 LIKE sfka_t.sfkaud012, #自定義欄位(數字)012
       sfkaud013 LIKE sfka_t.sfkaud013, #自定義欄位(數字)013
       sfkaud014 LIKE sfka_t.sfkaud014, #自定義欄位(數字)014
       sfkaud015 LIKE sfka_t.sfkaud015, #自定義欄位(數字)015
       sfkaud016 LIKE sfka_t.sfkaud016, #自定義欄位(數字)016
       sfkaud017 LIKE sfka_t.sfkaud017, #自定義欄位(數字)017
       sfkaud018 LIKE sfka_t.sfkaud018, #自定義欄位(數字)018
       sfkaud019 LIKE sfka_t.sfkaud019, #自定義欄位(數字)019
       sfkaud020 LIKE sfka_t.sfkaud020, #自定義欄位(數字)020
       sfkaud021 LIKE sfka_t.sfkaud021, #自定義欄位(日期時間)021
       sfkaud022 LIKE sfka_t.sfkaud022, #自定義欄位(日期時間)022
       sfkaud023 LIKE sfka_t.sfkaud023, #自定義欄位(日期時間)023
       sfkaud024 LIKE sfka_t.sfkaud024, #自定義欄位(日期時間)024
       sfkaud025 LIKE sfka_t.sfkaud025, #自定義欄位(日期時間)025
       sfkaud026 LIKE sfka_t.sfkaud026, #自定義欄位(日期時間)026
       sfkaud027 LIKE sfka_t.sfkaud027, #自定義欄位(日期時間)027
       sfkaud028 LIKE sfka_t.sfkaud028, #自定義欄位(日期時間)028
       sfkaud029 LIKE sfka_t.sfkaud029, #自定義欄位(日期時間)029
       sfkaud030 LIKE sfka_t.sfkaud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       sfka066 LIKE sfka_t.sfka066, #多角流程編號
       sfka067 LIKE sfka_t.sfka067, #多角流程式號
       sfka068 LIKE sfka_t.sfka068, #成本中心
       sfka069 LIKE sfka_t.sfka069, #可供給量
       sfka070 LIKE sfka_t.sfka070, #原始預計完工日期
       sfka071 LIKE sfka_t.sfka071, #齊料套數
       sfka072 LIKE sfka_t.sfka072  #保稅否
END RECORD
#161109-00085#27-e

DEFINE l_sfkacrtdt            DATETIME YEAR TO SECOND  #资料建立日期

   LET r_success = FALSE
   INITIALIZE l_sfka.* TO NULL
   
   LET l_sfka.sfkaent = g_enterprise
   LET l_sfka.sfkasite = g_site
   LET l_sfka.sfkadocno = g_sfaa_m.sfaadocno
   LET l_sfka.sfkadocdt = g_sfaa_m.sfaadocdt
   LET l_sfka.sfka001 = g_sfaa_m.sfaa001 + 1   #版本 = 目前[T:工單單頭檔].[C:版本]加1
   #變更序=採購變更單的變更序最大值+1
   SELECT MAX(sfka900)+1 INTO l_sfka.sfka900 FROM sfka_t
    WHERE sfkaent = g_enterprise
      AND sfkadocno = g_sfaa_m.sfaadocno
   IF cl_null(l_sfka.sfka900) OR l_sfka.sfka900 = 0 THEN
      LET l_sfka.sfka900 = 1
   END IF
   
   LET g_sfka900 = l_sfka.sfka900
   
   LET l_sfka.sfka002 = g_sfaa_m.sfaa002
   LET l_sfka.sfka003 = g_sfaa_m.sfaa003
   LET l_sfka.sfka004 = g_sfaa_m.sfaa004
   LET l_sfka.sfka005 = g_sfaa_m.sfaa005
   LET l_sfka.sfka006 = g_sfaa_m.sfaa006
   LET l_sfka.sfka007 = g_sfaa_m.sfaa007
   LET l_sfka.sfka008 = g_sfaa_m.sfaa008
   LET l_sfka.sfka009 = g_sfaa_m.sfaa009
   LET l_sfka.sfka010 = g_sfaa_m.sfaa010
   LET l_sfka.sfka011 = g_sfaa_m.sfaa011
   LET l_sfka.sfka012 = g_sfaa_m.sfaa012
   LET l_sfka.sfka013 = g_sfaa_m.sfaa013
   LET l_sfka.sfka014 = g_sfaa_m.sfaa014
   LET l_sfka.sfka015 = g_sfaa_m.sfaa015
   LET l_sfka.sfka016 = g_sfaa_m.sfaa016
   LET l_sfka.sfka017 = g_sfaa_m.sfaa017
   LET l_sfka.sfka018 = g_sfaa_m.sfaa018
   LET l_sfka.sfka019 = g_sfaa_m.sfaa019
   LET l_sfka.sfka020 = g_sfaa_m.sfaa020
   LET l_sfka.sfka021 = g_sfaa_m.sfaa021
   LET l_sfka.sfka022 = g_sfaa_m.sfaa022
   LET l_sfka.sfka023 = g_sfaa_m.sfaa023
   LET l_sfka.sfka024 = g_sfaa_m.sfaa024
   LET l_sfka.sfka025 = g_sfaa_m.sfaa025
   LET l_sfka.sfka026 = g_sfaa_m.sfaa026

   LET l_sfka.sfka028 = g_sfaa_m.sfaa028
   LET l_sfka.sfka029 = g_sfaa_m.sfaa029
   LET l_sfka.sfka030 = g_sfaa_m.sfaa030
   LET l_sfka.sfka031 = g_sfaa_m.sfaa031
   LET l_sfka.sfka032 = g_sfaa_m.sfaa032
   LET l_sfka.sfka033 = g_sfaa_m.sfaa033
   LET l_sfka.sfka034 = g_sfaa_m.sfaa034
   LET l_sfka.sfka035 = g_sfaa_m.sfaa035
   LET l_sfka.sfka036 = g_sfaa_m.sfaa036
   LET l_sfka.sfka037 = g_sfaa_m.sfaa037
   LET l_sfka.sfka038 = g_sfaa_m.sfaa038
   LET l_sfka.sfka072 = g_sfaa_m.sfaa072 
   LET l_sfka.sfka039 = g_sfaa_m.sfaa039
   LET l_sfka.sfka040 = g_sfaa_m.sfaa040
   LET l_sfka.sfka041 = g_sfaa_m.sfaa041
   LET l_sfka.sfka042 = g_sfaa_m.sfaa042
   LET l_sfka.sfka043 = g_sfaa_m.sfaa043
   LET l_sfka.sfka044 = g_sfaa_m.sfaa044
   LET l_sfka.sfka045 = g_sfaa_m.sfaa045
   LET l_sfka.sfka046 = g_sfaa_m.sfaa046
   LET l_sfka.sfka047 = g_sfaa_m.sfaa047
   LET l_sfka.sfka048 = g_sfaa_m.sfaa048
   LET l_sfka.sfka049 = g_sfaa_m.sfaa049
   LET l_sfka.sfka050 = g_sfaa_m.sfaa050
   LET l_sfka.sfka051 = g_sfaa_m.sfaa051

   LET l_sfka.sfka055 = g_sfaa_m.sfaa055
   LET l_sfka.sfka056 = g_sfaa_m.sfaa056
   LET l_sfka.sfka057 = g_sfaa_m.sfaa057
   LET l_sfka.sfka058 = g_sfaa_m.sfaa058
   LET l_sfka.sfka059 = g_sfaa_m.sfaa059
   LET l_sfka.sfka060 = g_sfaa_m.sfaa060
   LET l_sfka.sfka061 = g_sfaa_m.sfaa061
   LET l_sfka.sfka062 = g_sfaa_m.sfaa062
   LET l_sfka.sfka063 = g_sfaa_m.sfaa063
   LET l_sfka.sfka064 = g_sfaa_m.sfaa064
   LET l_sfka.sfka065 = g_sfaa_m.sfaa065
   LET l_sfka.sfka068 = g_sfaa_m.sfaa068    
   LET l_sfka.sfka901 = 'N'
   LET l_sfka.sfka902 = g_today
   LET l_sfka.sfkaownid =  g_user
   LET l_sfka.sfkaowndp =  g_dept
   LET l_sfka.sfkacrtid =  g_user
   LET l_sfka.sfkacrtdp =  g_dept 
   LET l_sfka.sfkacrtdt =  cl_get_current()
   LET l_sfka.sfkamodid =  g_user
   LET l_sfka.sfkamoddt =  cl_get_current()
   LET l_sfka.sfkastus  =  "N"
   LET l_sfka.sfkaacti  =  "N"
   LET l_sfkacrtdt = cl_get_current()

   INSERT INTO sfka_t (sfkaent,sfkadocno,sfka001,sfka902,sfka003,sfka057,sfka002,sfka004, 
       sfka900,sfkastus,sfka005,sfka007,sfka008,sfka063,sfka006,sfka009,sfka022,sfka021, 
       sfka023,sfka024,sfka064,sfka025,sfka010,sfka011,sfka012,sfka013,sfka058,sfka060,sfka061, 
       sfka016,sfka017,sfka018,sfka019,sfka020,sfka068,sfka905,sfka906,sfkaacti,sfkasite, 
       sfka014,sfka028,sfka015,sfka029,sfka026,sfka030,sfka031,sfka032,sfka033,sfka034,sfka035, 
       sfka059,sfka036,sfka037,sfka038,sfka072,sfka039,sfka069,sfka040,sfka070,sfka041,sfka042, 
       sfka043,sfka044,sfka045,sfka049,sfka046,sfka050,sfka047,sfka051,sfka048,sfka055,sfka056, 
       sfkaownid,sfkaowndp,sfkacrtid,sfkacrtdp,sfkacrtdt,sfkamodid,sfkamoddt,sfkacnfid,sfkacnfdt) 
    
   VALUES (g_enterprise,l_sfka.sfkadocno,l_sfka.sfka001,l_sfka.sfka902,l_sfka.sfka003, 
       l_sfka.sfka057,l_sfka.sfka002,l_sfka.sfka004,l_sfka.sfka900,l_sfka.sfkastus, 
       l_sfka.sfka005,l_sfka.sfka007,l_sfka.sfka008,l_sfka.sfka063,l_sfka.sfka006, 
       l_sfka.sfka009,l_sfka.sfka022,l_sfka.sfka021,l_sfka.sfka023,l_sfka.sfka024, 
       l_sfka.sfka064,l_sfka.sfka025,l_sfka.sfka010,l_sfka.sfka011,l_sfka.sfka012, 
       l_sfka.sfka013,l_sfka.sfka058,l_sfka.sfka060,l_sfka.sfka061,l_sfka.sfka016, 
       l_sfka.sfka017,l_sfka.sfka018,l_sfka.sfka019,l_sfka.sfka020,l_sfka.sfka068, 
       l_sfka.sfka905,l_sfka.sfka906,l_sfka.sfkaacti,l_sfka.sfkasite,l_sfka.sfka014, 
       l_sfka.sfka028,l_sfka.sfka015,l_sfka.sfka029,l_sfka.sfka026,l_sfka.sfka030, 
       l_sfka.sfka031,l_sfka.sfka032,l_sfka.sfka033,l_sfka.sfka034,l_sfka.sfka035, 
       l_sfka.sfka059,l_sfka.sfka036,l_sfka.sfka037,l_sfka.sfka038,l_sfka.sfka072, 
       l_sfka.sfka039,l_sfka.sfka069,l_sfka.sfka040,l_sfka.sfka070,l_sfka.sfka041, 
       l_sfka.sfka042,l_sfka.sfka043,l_sfka.sfka044,l_sfka.sfka045,l_sfka.sfka049, 
       l_sfka.sfka046,l_sfka.sfka050,l_sfka.sfka047,l_sfka.sfka051,l_sfka.sfka048, 
       l_sfka.sfka055,l_sfka.sfka056,l_sfka.sfkaownid,l_sfka.sfkaowndp,l_sfka.sfkacrtid, 
       l_sfka.sfkacrtdp,l_sfkacrtdt,l_sfka.sfkamodid,l_sfkacrtdt,l_sfka.sfkacnfid, 
       l_sfka.sfkacnfdt) 
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = "l_sfka:",SQLERRMESSAGE 
      LET g_errparam.code   = SQLCA.sqlcode 
      LET g_errparam.popup  = TRUE 
      CALL s_transaction_end('N','0')
      CALL cl_err()
      RETURN r_success
   END IF

   LET r_success = TRUE
   RETURN r_success
   
   
END FUNCTION

################################################################################
# Descriptions...: #变更单工单来源页签资料，sfkb
# Memo...........:
# Usage..........: CALL asft300_gen_sfkb()
#                  RETURNING r_success
# Date & Author..: 2016/08/30 By lixiang
# Modify.........: #160727-00025#1
################################################################################
PRIVATE FUNCTION asft300_gen_sfkb()
DEFINE r_success              LIKE type_t.num5
#161109-00085#27-s
#DEFINE l_sfab                RECORD LIKE sfab_t.*
DEFINE l_sfab RECORD  #工單來源檔
       sfabent LIKE sfab_t.sfabent, #企業編號
       sfabsite LIKE sfab_t.sfabsite, #營運據點
       sfabdocno LIKE sfab_t.sfabdocno, #單號
       sfab001 LIKE sfab_t.sfab001, #來源
       sfab002 LIKE sfab_t.sfab002, #來源單號
       sfab003 LIKE sfab_t.sfab003, #來源項次
       sfab004 LIKE sfab_t.sfab004, #來源項序
       sfab005 LIKE sfab_t.sfab005, #分批序
       sfab006 LIKE sfab_t.sfab006, #分配優先序
       sfab007 LIKE sfab_t.sfab007, #本次轉開工單量
       #sfabseq LIKE sfab_t.sfabseq  #項次 #161109-00085#66 mark
       #161109-00085#66 --s add
       sfabseq LIKE sfab_t.sfabseq, #項次
       sfabud001 LIKE sfab_t.sfabud001, #自定義欄位(文字)001
       sfabud002 LIKE sfab_t.sfabud002, #自定義欄位(文字)002
       sfabud003 LIKE sfab_t.sfabud003, #自定義欄位(文字)003
       sfabud004 LIKE sfab_t.sfabud004, #自定義欄位(文字)004
       sfabud005 LIKE sfab_t.sfabud005, #自定義欄位(文字)005
       sfabud006 LIKE sfab_t.sfabud006, #自定義欄位(文字)006
       sfabud007 LIKE sfab_t.sfabud007, #自定義欄位(文字)007
       sfabud008 LIKE sfab_t.sfabud008, #自定義欄位(文字)008
       sfabud009 LIKE sfab_t.sfabud009, #自定義欄位(文字)009
       sfabud010 LIKE sfab_t.sfabud010, #自定義欄位(文字)010
       sfabud011 LIKE sfab_t.sfabud011, #自定義欄位(數字)011
       sfabud012 LIKE sfab_t.sfabud012, #自定義欄位(數字)012
       sfabud013 LIKE sfab_t.sfabud013, #自定義欄位(數字)013
       sfabud014 LIKE sfab_t.sfabud014, #自定義欄位(數字)014
       sfabud015 LIKE sfab_t.sfabud015, #自定義欄位(數字)015
       sfabud016 LIKE sfab_t.sfabud016, #自定義欄位(數字)016
       sfabud017 LIKE sfab_t.sfabud017, #自定義欄位(數字)017
       sfabud018 LIKE sfab_t.sfabud018, #自定義欄位(數字)018
       sfabud019 LIKE sfab_t.sfabud019, #自定義欄位(數字)019
       sfabud020 LIKE sfab_t.sfabud020, #自定義欄位(數字)020
       sfabud021 LIKE sfab_t.sfabud021, #自定義欄位(日期時間)021
       sfabud022 LIKE sfab_t.sfabud022, #自定義欄位(日期時間)022
       sfabud023 LIKE sfab_t.sfabud023, #自定義欄位(日期時間)023
       sfabud024 LIKE sfab_t.sfabud024, #自定義欄位(日期時間)024
       sfabud025 LIKE sfab_t.sfabud025, #自定義欄位(日期時間)025
       sfabud026 LIKE sfab_t.sfabud026, #自定義欄位(日期時間)026
       sfabud027 LIKE sfab_t.sfabud027, #自定義欄位(日期時間)027
       sfabud028 LIKE sfab_t.sfabud028, #自定義欄位(日期時間)028
       sfabud029 LIKE sfab_t.sfabud029, #自定義欄位(日期時間)029
       sfabud030 LIKE sfab_t.sfabud030  #自定義欄位(日期時間)030
       #161109-00085#66 --e add
END RECORD
#161109-00085#27-e
#161109-00085#27-s
#DEFINE l_sfkb                 RECORD LIKE sfkb_t.*
DEFINE l_sfkb RECORD  #工單變更單來源檔
       sfkbent LIKE sfkb_t.sfkbent, #企業編號
       sfkbsite LIKE sfkb_t.sfkbsite, #營運據點
       sfkbdocno LIKE sfkb_t.sfkbdocno, #工單單號
       sfkbseq LIKE sfkb_t.sfkbseq, #項次
       sfkb001 LIKE sfkb_t.sfkb001, #來源
       sfkb002 LIKE sfkb_t.sfkb002, #來源單號
       sfkb003 LIKE sfkb_t.sfkb003, #來源項次
       sfkb004 LIKE sfkb_t.sfkb004, #來源項序
       sfkb005 LIKE sfkb_t.sfkb005, #分批序
       sfkb006 LIKE sfkb_t.sfkb006, #分配優先序
       sfkb007 LIKE sfkb_t.sfkb007, #本次轉開工單量
       sfkb900 LIKE sfkb_t.sfkb900, #變更序
       sfkb901 LIKE sfkb_t.sfkb901, #變更類型
       sfkb902 LIKE sfkb_t.sfkb902, #變更日期
       sfkb905 LIKE sfkb_t.sfkb905, #變更理由
      #sfkb906 LIKE sfkb_t.sfkb906  #變更備註 #161109-00085#66 mark
       #161109-00085#66 --s add
       sfkb906 LIKE sfkb_t.sfkb906, #變更備註
       sfkbud001 LIKE sfkb_t.sfkbud001, #自定義欄位(文字)001
       sfkbud002 LIKE sfkb_t.sfkbud002, #自定義欄位(文字)002
       sfkbud003 LIKE sfkb_t.sfkbud003, #自定義欄位(文字)003
       sfkbud004 LIKE sfkb_t.sfkbud004, #自定義欄位(文字)004
       sfkbud005 LIKE sfkb_t.sfkbud005, #自定義欄位(文字)005
       sfkbud006 LIKE sfkb_t.sfkbud006, #自定義欄位(文字)006
       sfkbud007 LIKE sfkb_t.sfkbud007, #自定義欄位(文字)007
       sfkbud008 LIKE sfkb_t.sfkbud008, #自定義欄位(文字)008
       sfkbud009 LIKE sfkb_t.sfkbud009, #自定義欄位(文字)009
       sfkbud010 LIKE sfkb_t.sfkbud010, #自定義欄位(文字)010
       sfkbud011 LIKE sfkb_t.sfkbud011, #自定義欄位(數字)011
       sfkbud012 LIKE sfkb_t.sfkbud012, #自定義欄位(數字)012
       sfkbud013 LIKE sfkb_t.sfkbud013, #自定義欄位(數字)013
       sfkbud014 LIKE sfkb_t.sfkbud014, #自定義欄位(數字)014
       sfkbud015 LIKE sfkb_t.sfkbud015, #自定義欄位(數字)015
       sfkbud016 LIKE sfkb_t.sfkbud016, #自定義欄位(數字)016
       sfkbud017 LIKE sfkb_t.sfkbud017, #自定義欄位(數字)017
       sfkbud018 LIKE sfkb_t.sfkbud018, #自定義欄位(數字)018
       sfkbud019 LIKE sfkb_t.sfkbud019, #自定義欄位(數字)019
       sfkbud020 LIKE sfkb_t.sfkbud020, #自定義欄位(數字)020
       sfkbud021 LIKE sfkb_t.sfkbud021, #自定義欄位(日期時間)021
       sfkbud022 LIKE sfkb_t.sfkbud022, #自定義欄位(日期時間)022
       sfkbud023 LIKE sfkb_t.sfkbud023, #自定義欄位(日期時間)023
       sfkbud024 LIKE sfkb_t.sfkbud024, #自定義欄位(日期時間)024
       sfkbud025 LIKE sfkb_t.sfkbud025, #自定義欄位(日期時間)025
       sfkbud026 LIKE sfkb_t.sfkbud026, #自定義欄位(日期時間)026
       sfkbud027 LIKE sfkb_t.sfkbud027, #自定義欄位(日期時間)027
       sfkbud028 LIKE sfkb_t.sfkbud028, #自定義欄位(日期時間)028
       sfkbud029 LIKE sfkb_t.sfkbud029, #自定義欄位(日期時間)029
       sfkbud030 LIKE sfkb_t.sfkbud030  #自定義欄位(日期時間)030
       #161109-00085#66 --e add
END RECORD
#161109-00085#27-e

   LET r_success = FALSE
   
   DECLARE asft300_gen_sfkb_cs CURSOR FOR 
   #161109-00085#27-s
    #SELECT * FROM sfab_t
    #SELECT sfabent,sfabsite,sfabdocno,sfab001,sfab002,sfab003,sfab004,sfab005,sfab006,sfab007,sfabseq #161109-00085#66 mark
    #161109-00085#66 --s add
    SELECT sfabent,sfabsite,sfabdocno,sfab001,sfab002,
           sfab003,sfab004,sfab005,sfab006,sfab007,
           sfabseq,sfabud001,sfabud002,sfabud003,sfabud004,
           sfabud005,sfabud006,sfabud007,sfabud008,sfabud009,
           sfabud010,sfabud011,sfabud012,sfabud013,sfabud014,
           sfabud015,sfabud016,sfabud017,sfabud018,sfabud019,
           sfabud020,sfabud021,sfabud022,sfabud023,sfabud024,
           sfabud025,sfabud026,sfabud027,sfabud028,sfabud029,
           sfabud030
    #161109-00085#66 --e add  
      FROM sfab_t
     WHERE sfabent = g_enterprise AND sfabsite = g_site AND sfabdocno = g_sfaa_m.sfaadocno
   #FOREACH asft300_gen_sfkb_cs INTO l_sfab.*
   FOREACH asft300_gen_sfkb_cs 
      #161109-00085#66 --s mark
      #INTO l_sfab.sfabent,l_sfab.sfabsite,l_sfab.sfabdocno,l_sfab.sfab001,l_sfab.sfab002,
      #     l_sfab.sfab003,l_sfab.sfab004,l_sfab.sfab005,l_sfab.sfab006,l_sfab.sfab007,
      #     l_sfab.sfabseq
      #161109-00085#66 --e mark
   #161109-00085#27-e
   #161109-00085#66 --s add
      INTO l_sfab.sfabent,l_sfab.sfabsite,l_sfab.sfabdocno,l_sfab.sfab001,l_sfab.sfab002,
           l_sfab.sfab003,l_sfab.sfab004,l_sfab.sfab005,l_sfab.sfab006,l_sfab.sfab007,
           l_sfab.sfabseq,l_sfab.sfabud001,l_sfab.sfabud002,l_sfab.sfabud003,l_sfab.sfabud004,
           l_sfab.sfabud005,l_sfab.sfabud006,l_sfab.sfabud007,l_sfab.sfabud008,l_sfab.sfabud009,
           l_sfab.sfabud010,l_sfab.sfabud011,l_sfab.sfabud012,l_sfab.sfabud013,l_sfab.sfabud014,
           l_sfab.sfabud015,l_sfab.sfabud016,l_sfab.sfabud017,l_sfab.sfabud018,l_sfab.sfabud019,
           l_sfab.sfabud020,l_sfab.sfabud021,l_sfab.sfabud022,l_sfab.sfabud023,l_sfab.sfabud024,
           l_sfab.sfabud025,l_sfab.sfabud026,l_sfab.sfabud027,l_sfab.sfabud028,l_sfab.sfabud029,
           l_sfab.sfabud030
   #161109-00085#66 --e add
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "FOREACH:"
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF
      INITIALIZE l_sfkb.* TO NULL   #清空数组
      
      LET l_sfkb.sfkbent = g_enterprise 
      LET l_sfkb.sfkbsite = g_site
      LET l_sfkb.sfkbdocno = l_sfab.sfabdocno
      LET l_sfkb.sfkbseq = l_sfab.sfabseq
      LET l_sfkb.sfkb001 = l_sfab.sfab001
      LET l_sfkb.sfkb002 = l_sfab.sfab002
      LET l_sfkb.sfkb003 = l_sfab.sfab003
      LET l_sfkb.sfkb004 = l_sfab.sfab004
      LET l_sfkb.sfkb005 = l_sfab.sfab005
      LET l_sfkb.sfkb006 = l_sfab.sfab006
      LET l_sfkb.sfkb007 = l_sfab.sfab007
      LET l_sfkb.sfkb900 = g_sfka900
      LET l_sfkb.sfkb901 = '1'
      
      INSERT INTO sfkb_t
                 (sfkbent,sfkbsite,sfkbdocno,sfkb900,sfkbseq,
                  sfkb001,sfkb002,sfkb003,sfkb004,sfkb005,sfkb006,sfkb007,sfkb901,sfkb905,sfkb906) 
           VALUES(l_sfkb.sfkbent,l_sfkb.sfkbsite,l_sfkb.sfkbdocno,l_sfkb.sfkb900,l_sfkb.sfkbseq,
                  l_sfkb.sfkb001,l_sfkb.sfkb002,l_sfkb.sfkb003, 
                  l_sfkb.sfkb004,l_sfkb.sfkb005,l_sfkb.sfkb006, 
                  l_sfkb.sfkb007,l_sfkb.sfkb901,l_sfkb.sfkb905, 
                  l_sfkb.sfkb906)
                      
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'INSERT sfkb_t'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF
      INITIALIZE l_sfab.* TO NULL   #清空数组
   END FOREACH
   LET r_success = TRUE
   RETURN r_success
   
END FUNCTION

################################################################################
# Descriptions...: #变更单工单生產料號明細页签资料，sfkc
# Memo...........:
# Usage..........: CALL asft300_gen_sfkc()
#                  RETURNING r_success
# Date & Author..: 2016/08/30 By lixiang
# Modify.........: #160727-00025#1
################################################################################
PRIVATE FUNCTION asft300_gen_sfkc()
DEFINE r_success              LIKE type_t.num5
#161109-00085#27-s
#DEFINE l_sfac                 RECORD LIKE sfac_t.*
DEFINE l_sfac RECORD  #工單聯產品檔
       sfacent LIKE sfac_t.sfacent, #企業編號
       sfacsite LIKE sfac_t.sfacsite, #營運據點
       sfacdocno LIKE sfac_t.sfacdocno, #單號
       sfac001 LIKE sfac_t.sfac001, #料件編號
       sfac002 LIKE sfac_t.sfac002, #類型
       sfac003 LIKE sfac_t.sfac003, #預計產出量
       sfac004 LIKE sfac_t.sfac004, #單位
       sfac005 LIKE sfac_t.sfac005, #實際產出數量
       sfacseq LIKE sfac_t.sfacseq, #項次
       sfac006 LIKE sfac_t.sfac006, #產品特徵
       #161109-00085#66 --s add
       sfacud001 LIKE sfac_t.sfacud001, #自定義欄位(文字)001
       sfacud002 LIKE sfac_t.sfacud002, #自定義欄位(文字)002
       sfacud003 LIKE sfac_t.sfacud003, #自定義欄位(文字)003
       sfacud004 LIKE sfac_t.sfacud004, #自定義欄位(文字)004
       sfacud005 LIKE sfac_t.sfacud005, #自定義欄位(文字)005
       sfacud006 LIKE sfac_t.sfacud006, #自定義欄位(文字)006
       sfacud007 LIKE sfac_t.sfacud007, #自定義欄位(文字)007
       sfacud008 LIKE sfac_t.sfacud008, #自定義欄位(文字)008
       sfacud009 LIKE sfac_t.sfacud009, #自定義欄位(文字)009
       sfacud010 LIKE sfac_t.sfacud010, #自定義欄位(文字)010
       sfacud011 LIKE sfac_t.sfacud011, #自定義欄位(數字)011
       sfacud012 LIKE sfac_t.sfacud012, #自定義欄位(數字)012
       sfacud013 LIKE sfac_t.sfacud013, #自定義欄位(數字)013
       sfacud014 LIKE sfac_t.sfacud014, #自定義欄位(數字)014
       sfacud015 LIKE sfac_t.sfacud015, #自定義欄位(數字)015
       sfacud016 LIKE sfac_t.sfacud016, #自定義欄位(數字)016
       sfacud017 LIKE sfac_t.sfacud017, #自定義欄位(數字)017
       sfacud018 LIKE sfac_t.sfacud018, #自定義欄位(數字)018
       sfacud019 LIKE sfac_t.sfacud019, #自定義欄位(數字)019
       sfacud020 LIKE sfac_t.sfacud020, #自定義欄位(數字)020
       sfacud021 LIKE sfac_t.sfacud021, #自定義欄位(日期時間)021
       sfacud022 LIKE sfac_t.sfacud022, #自定義欄位(日期時間)022
       sfacud023 LIKE sfac_t.sfacud023, #自定義欄位(日期時間)023
       sfacud024 LIKE sfac_t.sfacud024, #自定義欄位(日期時間)024
       sfacud025 LIKE sfac_t.sfacud025, #自定義欄位(日期時間)025
       sfacud026 LIKE sfac_t.sfacud026, #自定義欄位(日期時間)026
       sfacud027 LIKE sfac_t.sfacud027, #自定義欄位(日期時間)027
       sfacud028 LIKE sfac_t.sfacud028, #自定義欄位(日期時間)028
       sfacud029 LIKE sfac_t.sfacud029, #自定義欄位(日期時間)029
       sfacud030 LIKE sfac_t.sfacud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       sfac007 LIKE sfac_t.sfac007  #保稅否
END RECORD
#161109-00085#27-e

#161109-00085#27-s
#DEFINE l_sfkc                 RECORD LIKE sfkc_t.*
DEFINE l_sfkc RECORD  #工單變更單聯產品檔
       sfkcent LIKE sfkc_t.sfkcent, #企業編號
       sfkcsite LIKE sfkc_t.sfkcsite, #營運據點
       sfkcdocno LIKE sfkc_t.sfkcdocno, #工單單號
       sfkcseq LIKE sfkc_t.sfkcseq, #項次
       sfkc001 LIKE sfkc_t.sfkc001, #料件編號
       sfkc002 LIKE sfkc_t.sfkc002, #類型
       sfkc003 LIKE sfkc_t.sfkc003, #預計產出量
       sfkc004 LIKE sfkc_t.sfkc004, #單位
       sfkc005 LIKE sfkc_t.sfkc005, #實際產出數量
       sfkc900 LIKE sfkc_t.sfkc900, #變更序
       sfkc901 LIKE sfkc_t.sfkc901, #變更類型
       sfkc902 LIKE sfkc_t.sfkc902, #變更日期
       sfkc006 LIKE sfkc_t.sfkc006, #產品特征
       sfkc904 LIKE sfkc_t.sfkc904, #變更理由
       sfkc905 LIKE sfkc_t.sfkc905, #變更備註
       #161109-00085#66 --s add
       sfkcud001 LIKE sfkc_t.sfkcud001, #自定義欄位(文字)001
       sfkcud002 LIKE sfkc_t.sfkcud002, #自定義欄位(文字)002
       sfkcud003 LIKE sfkc_t.sfkcud003, #自定義欄位(文字)003
       sfkcud004 LIKE sfkc_t.sfkcud004, #自定義欄位(文字)004
       sfkcud005 LIKE sfkc_t.sfkcud005, #自定義欄位(文字)005
       sfkcud006 LIKE sfkc_t.sfkcud006, #自定義欄位(文字)006
       sfkcud007 LIKE sfkc_t.sfkcud007, #自定義欄位(文字)007
       sfkcud008 LIKE sfkc_t.sfkcud008, #自定義欄位(文字)008
       sfkcud009 LIKE sfkc_t.sfkcud009, #自定義欄位(文字)009
       sfkcud010 LIKE sfkc_t.sfkcud010, #自定義欄位(文字)010
       sfkcud011 LIKE sfkc_t.sfkcud011, #自定義欄位(數字)011
       sfkcud012 LIKE sfkc_t.sfkcud012, #自定義欄位(數字)012
       sfkcud013 LIKE sfkc_t.sfkcud013, #自定義欄位(數字)013
       sfkcud014 LIKE sfkc_t.sfkcud014, #自定義欄位(數字)014
       sfkcud015 LIKE sfkc_t.sfkcud015, #自定義欄位(數字)015
       sfkcud016 LIKE sfkc_t.sfkcud016, #自定義欄位(數字)016
       sfkcud017 LIKE sfkc_t.sfkcud017, #自定義欄位(數字)017
       sfkcud018 LIKE sfkc_t.sfkcud018, #自定義欄位(數字)018
       sfkcud019 LIKE sfkc_t.sfkcud019, #自定義欄位(數字)019
       sfkcud020 LIKE sfkc_t.sfkcud020, #自定義欄位(數字)020
       sfkcud021 LIKE sfkc_t.sfkcud021, #自定義欄位(日期時間)021
       sfkcud022 LIKE sfkc_t.sfkcud022, #自定義欄位(日期時間)022
       sfkcud023 LIKE sfkc_t.sfkcud023, #自定義欄位(日期時間)023
       sfkcud024 LIKE sfkc_t.sfkcud024, #自定義欄位(日期時間)024
       sfkcud025 LIKE sfkc_t.sfkcud025, #自定義欄位(日期時間)025
       sfkcud026 LIKE sfkc_t.sfkcud026, #自定義欄位(日期時間)026
       sfkcud027 LIKE sfkc_t.sfkcud027, #自定義欄位(日期時間)027
       sfkcud028 LIKE sfkc_t.sfkcud028, #自定義欄位(日期時間)028
       sfkcud029 LIKE sfkc_t.sfkcud029, #自定義欄位(日期時間)029
       sfkcud030 LIKE sfkc_t.sfkcud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       sfkc007 LIKE sfkc_t.sfkc007  #保稅否
END RECORD
#161109-00085#27-e


   LET r_success = FALSE

   DECLARE asft300_gen_sfkc_cs CURSOR FOR 
   #161109-00085#27-s
   #SELECT * FROM sfac_t WHERE sfacent = g_enterprise AND sfacsite = g_site AND sfacdocno = g_sfaa_m.sfaadocno
   #SELECT sfacent,sfacsite,sfacdocno,sfac001,sfac002,sfac003,sfac004,sfac005,sfacseq,sfac006,sfac007 #161109-00085#66 mark
   #161109-00085#66 --s add
   SELECT sfacent,sfacsite,sfacdocno,sfac001,sfac002,
          sfac003,sfac004,sfac005,sfacseq,sfac006,
          sfacud001,sfacud002,sfacud003,sfacud004,sfacud005,
          sfacud006,sfacud007,sfacud008,sfacud009,sfacud010,
          sfacud011,sfacud012,sfacud013,sfacud014,sfacud015,
          sfacud016,sfacud017,sfacud018,sfacud019,sfacud020,
          sfacud021,sfacud022,sfacud023,sfacud024,sfacud025,
          sfacud026,sfacud027,sfacud028,sfacud029,sfacud030,
          sfac007
   #161109-00085#66 --e add
     FROM sfac_t
    WHERE sfacent = g_enterprise AND sfacsite = g_site AND sfacdocno = g_sfaa_m.sfaadocno
   #FOREACH asft300_gen_sfkc_cs INTO l_sfac.*
   FOREACH asft300_gen_sfkc_cs 
   #161109-00085#66 --s mark
   #   INTO l_sfac.sfacent,l_sfac.sfacsite,l_sfac.sfacdocno,l_sfac.sfac001,l_sfac.sfac002,
   #        l_sfac.sfac003,l_sfac.sfac004,l_sfac.sfac005,l_sfac.sfacseq,l_sfac.sfac006,
   #        l_sfac.sfac007
   #161109-00085#66 --e mark
   #161109-00085#66 --s add
     INTO l_sfac.sfacent,l_sfac.sfacsite,l_sfac.sfacdocno,l_sfac.sfac001,l_sfac.sfac002,
          l_sfac.sfac003,l_sfac.sfac004,l_sfac.sfac005,l_sfac.sfacseq,l_sfac.sfac006,
          l_sfac.sfacud001,l_sfac.sfacud002,l_sfac.sfacud003,l_sfac.sfacud004,l_sfac.sfacud005,
          l_sfac.sfacud006,l_sfac.sfacud007,l_sfac.sfacud008,l_sfac.sfacud009,l_sfac.sfacud010,
          l_sfac.sfacud011,l_sfac.sfacud012,l_sfac.sfacud013,l_sfac.sfacud014,l_sfac.sfacud015,
          l_sfac.sfacud016,l_sfac.sfacud017,l_sfac.sfacud018,l_sfac.sfacud019,l_sfac.sfacud020,
          l_sfac.sfacud021,l_sfac.sfacud022,l_sfac.sfacud023,l_sfac.sfacud024,l_sfac.sfacud025,
          l_sfac.sfacud026,l_sfac.sfacud027,l_sfac.sfacud028,l_sfac.sfacud029,l_sfac.sfacud030,
          l_sfac.sfac007
   #161109-00085#66 --e add
   #161109-00085#27-e
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "FOREACH:"
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF
      
      INITIALIZE l_sfkc.* TO NULL   #清空数组
      
      LET l_sfkc.sfkcent = g_enterprise 
      LET l_sfkc.sfkcsite = g_site
      LET l_sfkc.sfkcdocno = l_sfac.sfacdocno
      LET l_sfkc.sfkcseq = l_sfac.sfacseq
      LET l_sfkc.sfkc001 = l_sfac.sfac001
      LET l_sfkc.sfkc002 = l_sfac.sfac002
      LET l_sfkc.sfkc003 = l_sfac.sfac003
      LET l_sfkc.sfkc004 = l_sfac.sfac004
      LET l_sfkc.sfkc005 = l_sfac.sfac005
      LET l_sfkc.sfkc006 = l_sfac.sfac006
      LET l_sfkc.sfkc900 = g_sfka900
      LET l_sfkc.sfkc901 = '1'
      LET l_sfkc.sfkc007 = l_sfac.sfac007   #add--160512-00016#17 By shiun
      
      INSERT INTO sfkc_t
                  (sfkcent,sfkcdocno,sfkc900,sfkcseq,
                   sfkc002,sfkc001,sfkc006,sfkc003,sfkc004,sfkc005,sfkc901,sfkc904,sfkc905,sfkcsite,sfkc007) 
            VALUES(l_sfkc.sfkcent,l_sfkc.sfkcdocno,l_sfkc.sfkc900,l_sfkc.sfkcseq,
                   l_sfkc.sfkc002,l_sfkc.sfkc001,l_sfkc.sfkc006, 
                   l_sfkc.sfkc003,l_sfkc.sfkc004,l_sfkc.sfkc005, 
                   l_sfkc.sfkc901,l_sfkc.sfkc904,l_sfkc.sfkc905, 
                   l_sfkc.sfkcsite,l_sfkc.sfkc007)
                       
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'INSERT sfkc_t'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF
      INITIALIZE l_sfac.* TO NULL   #清空数组
   END FOREACH
   LET r_success = TRUE
   RETURN r_success
   
END FUNCTION

################################################################################
# Descriptions...: #变更单工单產品序號页签资料，sfkf
# Memo...........:
# Usage..........: CALL asft300_gen_sfkf()
#                  RETURNING r_success
# Date & Author..: 2016/08/30 By lixiang
# Modify.........: #160727-00025#1
################################################################################
PRIVATE FUNCTION asft300_gen_sfkf()
DEFINE r_success              LIKE type_t.num5
#161109-00085#27-s
#DEFINE l_sfaf                 RECORD LIKE sfaf_t.*
DEFINE l_sfaf RECORD  #工單產品序號檔
       sfafent LIKE sfaf_t.sfafent, #企業編號
       sfafsite LIKE sfaf_t.sfafsite, #營運據點
       sfafdocno LIKE sfaf_t.sfafdocno, #單號
       sfaf001 LIKE sfaf_t.sfaf001, #產品序號
      #sfafseq LIKE sfaf_t.sfafseq #項次 #161109-00085#66 mark
       #161109-00085#66 --s add
       sfafseq LIKE sfaf_t.sfafseq, #項次
       sfafud001 LIKE sfaf_t.sfafud001, #自定義欄位(文字)001
       sfafud002 LIKE sfaf_t.sfafud002, #自定義欄位(文字)002
       sfafud003 LIKE sfaf_t.sfafud003, #自定義欄位(文字)003
       sfafud004 LIKE sfaf_t.sfafud004, #自定義欄位(文字)004
       sfafud005 LIKE sfaf_t.sfafud005, #自定義欄位(文字)005
       sfafud006 LIKE sfaf_t.sfafud006, #自定義欄位(文字)006
       sfafud007 LIKE sfaf_t.sfafud007, #自定義欄位(文字)007
       sfafud008 LIKE sfaf_t.sfafud008, #自定義欄位(文字)008
       sfafud009 LIKE sfaf_t.sfafud009, #自定義欄位(文字)009
       sfafud010 LIKE sfaf_t.sfafud010, #自定義欄位(文字)010
       sfafud011 LIKE sfaf_t.sfafud011, #自定義欄位(數字)011
       sfafud012 LIKE sfaf_t.sfafud012, #自定義欄位(數字)012
       sfafud013 LIKE sfaf_t.sfafud013, #自定義欄位(數字)013
       sfafud014 LIKE sfaf_t.sfafud014, #自定義欄位(數字)014
       sfafud015 LIKE sfaf_t.sfafud015, #自定義欄位(數字)015
       sfafud016 LIKE sfaf_t.sfafud016, #自定義欄位(數字)016
       sfafud017 LIKE sfaf_t.sfafud017, #自定義欄位(數字)017
       sfafud018 LIKE sfaf_t.sfafud018, #自定義欄位(數字)018
       sfafud019 LIKE sfaf_t.sfafud019, #自定義欄位(數字)019
       sfafud020 LIKE sfaf_t.sfafud020, #自定義欄位(數字)020
       sfafud021 LIKE sfaf_t.sfafud021, #自定義欄位(日期時間)021
       sfafud022 LIKE sfaf_t.sfafud022, #自定義欄位(日期時間)022
       sfafud023 LIKE sfaf_t.sfafud023, #自定義欄位(日期時間)023
       sfafud024 LIKE sfaf_t.sfafud024, #自定義欄位(日期時間)024
       sfafud025 LIKE sfaf_t.sfafud025, #自定義欄位(日期時間)025
       sfafud026 LIKE sfaf_t.sfafud026, #自定義欄位(日期時間)026
       sfafud027 LIKE sfaf_t.sfafud027, #自定義欄位(日期時間)027
       sfafud028 LIKE sfaf_t.sfafud028, #自定義欄位(日期時間)028
       sfafud029 LIKE sfaf_t.sfafud029, #自定義欄位(日期時間)029
       sfafud030 LIKE sfaf_t.sfafud030  #自定義欄位(日期時間)030
       #161109-00085#66 --e add
END RECORD
#161109-00085#27-e
#161109-00085#27-s
#DEFINE l_sfkf                 RECORD LIKE sfkf_t.*
DEFINE l_sfkf RECORD  #工單變更單產品序號檔
       sfkfent LIKE sfkf_t.sfkfent, #企業編號
       sfkfsite LIKE sfkf_t.sfkfsite, #營運據點
       sfkfdocno LIKE sfkf_t.sfkfdocno, #工單單號
       sfkfseq LIKE sfkf_t.sfkfseq, #項次
       sfkf001 LIKE sfkf_t.sfkf001, #產品序號
       sfkf900 LIKE sfkf_t.sfkf900, #變更序
       sfkf901 LIKE sfkf_t.sfkf901, #變更類型
       sfkf902 LIKE sfkf_t.sfkf902, #變更日期
       sfkf905 LIKE sfkf_t.sfkf905, #變更理由
       sfkf906 LIKE sfkf_t.sfkf906  #變更備註 #161109-00085#66 mark
END RECORD
#161109-00085#27-e

   LET r_success = FALSE

   DECLARE asft300_gen_sfkf_cs CURSOR FOR 
   #161109-00085#27-s
   #SELECT * FROM sfaf_t WHERE sfafent = g_enterprise AND sfafsite = g_site AND sfafdocno = g_sfaa_m.sfaadocno
   #SELECT sfafent,sfafsite,sfafdocno,sfaf001,sfafseq #161109-00085#66 mark
   #161109-00085#66 --s add
   SELECT sfafent,sfafsite,sfafdocno,sfaf001,sfafseq,
          sfafud001,sfafud002,sfafud003,sfafud004,sfafud005,
          sfafud006,sfafud007,sfafud008,sfafud009,sfafud010,
          sfafud011,sfafud012,sfafud013,sfafud014,sfafud015,
          sfafud016,sfafud017,sfafud018,sfafud019,sfafud020,
          sfafud021,sfafud022,sfafud023,sfafud024,sfafud025,
          sfafud026,sfafud027,sfafud028,sfafud029,sfafud030
   #161109-00085#66 --e add
     FROM sfaf_t
    WHERE sfafent = g_enterprise AND sfafsite = g_site AND sfafdocno = g_sfaa_m.sfaadocno
   #FOREACH asft300_gen_sfkf_cs INTO l_sfaf.*
   FOREACH asft300_gen_sfkf_cs 
   #   INTO l_sfaf.sfafent,l_sfaf.sfafsite,l_sfaf.sfafdocno,l_sfaf.sfaf001,l_sfaf.sfafseq #161109-00085#66 mark
   #161109-00085#66 --s add
      INTO l_sfaf.sfafent,l_sfaf.sfafsite,l_sfaf.sfafdocno,l_sfaf.sfaf001,l_sfaf.sfafseq,
           l_sfaf.sfafud001,l_sfaf.sfafud002,l_sfaf.sfafud003,l_sfaf.sfafud004,l_sfaf.sfafud005,
           l_sfaf.sfafud006,l_sfaf.sfafud007,l_sfaf.sfafud008,l_sfaf.sfafud009,l_sfaf.sfafud010,
           l_sfaf.sfafud011,l_sfaf.sfafud012,l_sfaf.sfafud013,l_sfaf.sfafud014,l_sfaf.sfafud015,
           l_sfaf.sfafud016,l_sfaf.sfafud017,l_sfaf.sfafud018,l_sfaf.sfafud019,l_sfaf.sfafud020,
           l_sfaf.sfafud021,l_sfaf.sfafud022,l_sfaf.sfafud023,l_sfaf.sfafud024,l_sfaf.sfafud025,
           l_sfaf.sfafud026,l_sfaf.sfafud027,l_sfaf.sfafud028,l_sfaf.sfafud029,l_sfaf.sfafud030
   #161109-00085#66 --e add
   #161109-00085#27-e
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "FOREACH:"
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF
      INITIALIZE l_sfkf.* TO NULL   #清空数组
      
      LET l_sfkf.sfkfent = g_enterprise 
      LET l_sfkf.sfkfsite = g_site
      LET l_sfkf.sfkfdocno = l_sfaf.sfafdocno
      LET l_sfkf.sfkfseq = l_sfaf.sfafseq
      LET l_sfkf.sfkf001 = l_sfaf.sfaf001
      LET l_sfkf.sfkf900 = g_sfka900
      LET l_sfkf.sfkf901 = '1'
      
      INSERT INTO sfkf_t
                  (sfkfent,sfkfdocno,sfkf900,sfkfseq,
                   sfkf001,sfkf901,sfkf905,sfkf906,sfkfsite) 
            VALUES(l_sfkf.sfkfent,l_sfkf.sfkfdocno,l_sfkf.sfkf900,l_sfkf.sfkfseq,
                   l_sfkf.sfkf001,l_sfkf.sfkf901,l_sfkf.sfkf905, 
                   l_sfkf.sfkf906,l_sfkf.sfkfsite)
                       
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'INSERT sfkf_t'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF
      INITIALIZE l_sfaf.* TO NULL   #清空数组
   END FOREACH
   LET r_success = TRUE
   RETURN r_success
   
END FUNCTION

################################################################################
# Descriptions...: #变更单工单模具页签资料，sfki
# Memo...........:
# Usage..........: CALL asft300_gen_sfki()
#                  RETURNING r_success
# Date & Author..: 2016/08/30 By lixiang
# Modify.........: #160727-00025#1
################################################################################
PRIVATE FUNCTION asft300_gen_sfki()
DEFINE r_success              LIKE type_t.num5
#161109-00085#27-s
#DEFINE l_sfai                 RECORD LIKE sfai_t.*
DEFINE l_sfai RECORD  #工單模具檔
       sfaient LIKE sfai_t.sfaient, #企業代碼
       sfaisite LIKE sfai_t.sfaisite, #營運據點
       sfaidocno LIKE sfai_t.sfaidocno, #工單單號
       sfai001 LIKE sfai_t.sfai001, #製品料號
       sfai002 LIKE sfai_t.sfai002, #送樣數量
       sfai003 LIKE sfai_t.sfai003, #圖別
       sfai004 LIKE sfai_t.sfai004, #版別
       sfai005 LIKE sfai_t.sfai005  #穴數
END RECORD
#161109-00085#27-e
#161109-00085#27-s
#DEFINE l_sfki                 RECORD LIKE sfki_t.*
DEFINE l_sfki RECORD  #工單變更單模具檔
       sfkient LIKE sfki_t.sfkient, #企業代碼
       sfkisite LIKE sfki_t.sfkisite, #營運據點
       sfkidocno LIKE sfki_t.sfkidocno, #工單單號
       sfki001 LIKE sfki_t.sfki001, #製品料號
       sfki002 LIKE sfki_t.sfki002, #送樣數量
       sfki003 LIKE sfki_t.sfki003, #圖別
       sfki004 LIKE sfki_t.sfki004, #版別
       sfki005 LIKE sfki_t.sfki005, #穴數
       sfki900 LIKE sfki_t.sfki900, #變更序
       sfki901 LIKE sfki_t.sfki901, #變更類型
       sfki902 LIKE sfki_t.sfki902, #變更日期
       sfki905 LIKE sfki_t.sfki905, #變更理由
       sfki906 LIKE sfki_t.sfki906  #變更備註
END RECORD
#161109-00085#27-e
   LET r_success = FALSE
   
   INITIALIZE l_sfai.* TO NULL   #清空数组
   
   #161109-00085#27-s
   #SELECT * INTO l_sfai.*
   SELECT sfaient,sfaisite,sfaidocno,sfai001,sfai002,sfai003,sfai004,sfai005 
     INTO l_sfai.sfaient,l_sfai.sfaisite,l_sfai.sfaidocno,l_sfai.sfai001,l_sfai.sfai002,
          l_sfai.sfai003,l_sfai.sfai004,l_sfai.sfai005 
     FROM sfai_t
    WHERE sfaient = g_enterprise AND sfaidocno = g_sfaa_m.sfaadocno
   #161109-00085#27-e   

   INITIALIZE l_sfki.* TO NULL   #清空数组
   
   LET l_sfki.sfkient = g_enterprise 
   LET l_sfki.sfkisite = g_site
   LET l_sfki.sfkidocno = l_sfai.sfaidocno
   LET l_sfki.sfki001 = l_sfai.sfai001
   LET l_sfki.sfki002 = l_sfai.sfai002
   LET l_sfki.sfki003 = l_sfai.sfai003
   LET l_sfki.sfki004 = l_sfai.sfai004
   LET l_sfki.sfki005 = l_sfai.sfai005
   LET l_sfki.sfki900 = g_sfka900
   LET l_sfki.sfki901 = '1'
   
   INSERT INTO sfki_t
               (sfkient,sfkidocno,sfki900,
                sfki001,sfki002,sfki003,sfki004,sfki005,sfki901,sfki905,sfki906,sfkisite) 
         VALUES(l_sfki.sfkient,l_sfki.sfkidocno,l_sfki.sfki900,
                l_sfki.sfki001,l_sfki.sfki002,l_sfki.sfki003,l_sfki.sfki004,l_sfki.sfki005, 
                l_sfki.sfki901,l_sfki.sfki905,l_sfki.sfki906, 
                l_sfki.sfkisite)
                    
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'INSERT sfki_t'
      LET g_errparam.popup = TRUE
      CALL cl_err()
    
      RETURN r_success
   END IF

   LET r_success = TRUE
   RETURN r_success
   
END FUNCTION

################################################################################
# Descriptions...: 產生一般採購單單頭檔
# Memo...........:
# Usage..........: CALL asft300_gen_apmt500_pmdl(p_docno,p_sfbadocno,p_imaf153)
#                  RETURNING r_success
# Date & Author..: 2016/08/30 By lixiang
# Modify.........: #160727-00025#1
############################################################################################################################################################
PRIVATE FUNCTION asft300_gen_apmt500_pmdl(p_docno,p_sfbadocno,p_imaf153)
DEFINE p_docno        LIKE pmdl_t.pmdldocno
DEFINE p_sfbadocno    LIKE sfba_t.sfbadocno
DEFINE p_imaf153      LIKE imaf_t.imaf153
DEFINE l_success      LIKE type_t.num5
DEFINE r_success      LIKE type_t.num5
DEFINE l_n            LIKE type_t.num5
DEFINE l_controlno    LIKE ooha_t.ooha001
DEFINE l_oodbl004     LIKE oodbL_t.oodbl004
DEFINE l_oodb011      LIKE oodb_t.oodb011
DEFINE l_scc40        LIKE type_t.chr2
DEFINE l_oofb002      LIKE oofb_t.oofb002    #161229-00014#1---dujuan-----add

  LET r_success = TRUE  
  
  INITIALIZE g_pmdl.* TO NULL
  
  
  #公用欄位給值
  LET g_pmdl.pmdlownid = g_user
  LET g_pmdl.pmdlowndp = g_dept
  LET g_pmdl.pmdlcrtid = g_user
  LET g_pmdl.pmdlcrtdp = g_dept
  LET g_pmdl.pmdlcrtdt = cl_get_current()
  LET g_pmdl.pmdlmodid = ""
  LET g_pmdl.pmdlmoddt = ""
  LET g_pmdl.pmdlstus = "N"  
  #一般欄位給值
  LET g_pmdl.pmdlsite = g_site
  LET g_pmdl.pmdldocdt = g_today    #採購日期
  LET g_pmdl.pmdl001 = "0"          #版次
  LET g_pmdl.pmdl002 = g_user       #採購人員
  LET g_pmdl.pmdl003 = g_dept       #採購部門   
  LET g_pmdl.pmdl004 = p_imaf153    #供應商   
  LET g_pmdl.pmdl005 = "1"          #採購性質：1一般採購
  LET g_pmdl.pmdl006 = "1"          #多角性質：1一般交易
  LET g_pmdl.pmdl007 = "4"          #資料來源類型：4工單
  LET g_pmdl.pmdl008 = p_sfbadocno  #來源單號
  LET g_pmdl.pmdl019 = "Y"          #納入 MPS/MRP計算
  LET g_pmdl.pmdl030 = "N"          #多角貿易已拋轉
  LET g_pmdl.pmdl040 = "0"          #採購總未稅金額
  LET g_pmdl.pmdl041 = "0"          #採購總含稅金額 
  LET g_pmdl.pmdl042 = "0"          #採購總稅額
  LET g_pmdl.pmdl046 = "1"          #預付款發票開立方式：1不開立發票
  LET g_pmdl.pmdl047 = "N"          #物流結案
  LET g_pmdl.pmdl048 = "N"          #帳流結案
  LET g_pmdl.pmdl049 = "N"          #金流結案 


  #依供應商的慣用交易條件帶出預設值
  #先判斷這個供應商是否有設多個當前採購控制組範圍內的供應商預設條件，則開窗，讓user 選擇帶哪一個控制組的資料
  LET l_controlno = ''
  CALL s_control_get_group('4',g_user,g_dept) RETURNING l_success,l_controlno
  
  IF NOT cl_null(l_controlno) THEN
     #判斷供應商是否有設置採購控制組供應商預設條件(apmi110)，若有則抓取相關的預設條件default到採購單上
     SELECT COUNT(1) INTO l_n FROM pmal_t 
      WHERE pmalent = g_enterprise 
        AND pmal001 = g_pmdl.pmdl004 
        AND pmal002 = l_controlno 
        AND pmalstus = 'Y'
     IF l_n > 0 THEN
        SELECT pmal006,pmal020,pmal004,pmal003,pmal021,
               pmal011,pmal008,pmal009,pmal022,pmal023,
               pmal024 
          INTO g_pmdl.pmdl009,g_pmdl.pmdl010,g_pmdl.pmdl011,g_pmdl.pmdl015,g_pmdl.pmdl017,
               g_pmdl.pmdl020,g_pmdl.pmdl023,g_pmdl.pmdl024,g_pmdl.pmdl033,g_pmdl.pmdl054,
               g_pmdl.pmdl055
          FROM pmal_t 
         WHERE pmalent = g_enterprise 
           AND pmal001 = g_pmdl.pmdl004 
           AND pmal002 = l_controlno 
           AND pmalstus = 'Y'
     END IF
  END IF     
  #若沒有設置採購控制組供應商預設條件資料則改抓供應商據點預設條件(apmm202)資料  
  IF cl_null(l_controlno) OR l_n = 0 THEN
     SELECT pmab037,pmab053,pmab034,pmab033,pmab054,
            pmab040,pmab038,pmab039,pmab056,pmab057,
            pmab058
       INTO g_pmdl.pmdl009,g_pmdl.pmdl010,g_pmdl.pmdl011,g_pmdl.pmdl015,g_pmdl.pmdl017,
            g_pmdl.pmdl020,g_pmdl.pmdl023,g_pmdl.pmdl024,g_pmdl.pmdl033,g_pmdl.pmdl054,
            g_pmdl.pmdl055
       FROM pmab_t 
      WHERE pmabent = g_enterprise 
        AND pmabsite = g_site 
        AND pmab001 = g_pmdl.pmdl004          
  END IF
  #內外購
  IF cl_null(g_pmdl.pmdl054) THEN  
     LET g_pmdl.pmdl054 = "1"          
  END IF
  #匯率計算基準
  IF cl_null(g_pmdl.pmdl055) THEN
     LET g_pmdl.pmdl055 = "1"                
  END IF
   
  #取稅率、單價含稅否、稅別說明
  IF NOT cl_null(g_pmdl.pmdl011) THEN
     CALL s_tax_chk(g_site,g_pmdl.pmdl011)
       RETURNING l_success,l_oodbl004,g_pmdl.pmdl013,g_pmdl.pmdl012,l_oodb011
  END IF
  
  #根據內外購獲取當前營運據點參數設置的匯率
  IF NOT cl_null(g_pmdl.pmdl015) THEN         
     LET l_scc40 = ''
     IF g_pmdl.pmdl054 = '1' THEN   #內購
        LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0014')
     END IF
     IF g_pmdl.pmdl054 = '2' THEN   #外購
        LET l_scc40 = cl_get_para(g_enterprise,g_site,'S-BAS-0015')
     END IF
     IF NOT cl_null(l_scc40) THEN
        CALL s_aooi160_get_exrate('1',g_site,g_today,g_pmdl.pmdl015,g_ooef016,0,l_scc40) RETURNING g_pmdl.pmdl016
     END IF
  END IF
   
  #付款供應商：抓取交易對象夥伴關係檔且交易類型為"1:收/付款對象"，若無則預設採購供應商
  SELECT pmac002 INTO g_pmdl.pmdl021 
    FROM pmac_t 
   WHERE pmacent = g_enterprise 
     AND pmac001 = g_pmdl.pmdl004 
     AND pmac003 = '1' 
     AND pmacstus = 'Y' 
     AND pmac004 = 'Y'
  IF cl_null(g_pmdl.pmdl021) THEN
     SELECT pmac002 INTO g_pmdl.pmdl021 
       FROM pmac_t 
      WHERE pmacent = g_enterprise 
        AND pmac001 = g_pmdl.pmdl004 
        AND pmac003 = '1' 
        AND pmacstus = 'Y' 
        AND rownum = 1
     IF cl_null(g_pmdl.pmdl021) THEN
        LET g_pmdl.pmdl021 = g_pmdl.pmdl004
     END IF
  END IF
   
  #送貨供應商：抓取交易對象夥伴關係檔且交易類型為"2:出貨對象"，若無則預設採購供應商
  SELECT pmac002 INTO g_pmdl.pmdl022 
    FROM pmac_t
   WHERE pmacent = g_enterprise 
     AND pmac001 = g_pmdl.pmdl004 
     AND pmac003 = '2' 
     AND pmacstus = 'Y' 
     AND pmac004 = 'Y'
  IF cl_null(g_pmdl.pmdl022) THEN
     SELECT pmac002 INTO g_pmdl.pmdl022 
       FROM pmac_t 
      WHERE pmacent = g_enterprise 
        AND pmac001 = g_pmdl.pmdl004 
        AND pmac003 = '2' 
        AND pmacstus = 'Y' 
        AND rownum = 1
     IF cl_null(g_pmdl.pmdl022) THEN
        LET g_pmdl.pmdl022 = g_pmdl.pmdl004
     END IF
  END IF
  #供應商連絡人：抓取交易對象聯絡人明細檔的聯絡對像識別碼
  SELECT pmaj002 INTO g_pmdl.pmdl027 
    FROM pmaj_t 
   WHERE pmajent = g_enterprise 
     AND pmaj001 = g_pmdl.pmdl004 
     AND pmajstus = 'Y' 
     AND pmaj004 = 'Y'
  IF cl_null(g_pmdl.pmdl022) THEN
     SELECT pmaj002 INTO g_pmdl.pmdl027 
       FROM pmaj_t
      WHERE pmajent = g_enterprise 
        AND pmaj001 = g_pmdl.pmdl004 
        AND pmajstus = 'Y' 
        AND pmaj004 = 'Y' 
        AND rownum = 1  
  END IF
  
   ##161228-00036#1------dujuan----add---str
   #送貨地址
   SELECT pmaa027 INTO l_oofb002 FROM pmaa_t
    WHERE pmaaent = g_enterprise
      AND pmaa001 = g_pmdl.pmdl004 
      
   IF cl_null(g_pmdl.pmdl025) THEN   
       SELECT oofb019 INTO g_pmdl.pmdl025 
       FROM oofb_t
        WHERE oofbent  = g_enterprise
          AND oofb002  = l_oofb002
          AND oofb008  = '3'                    
          AND oofbstus = 'Y'
        ORDER BY oofb010 DESC
   END IF
   
   #帳款地址
   IF cl_null(g_pmdl.pmdl026) THEN   
       SELECT oofb019 INTO g_pmdl.pmdl004 
       FROM oofb_t
        WHERE oofbent  = g_enterprise
          AND oofb002  = l_oofb002
          AND oofb008  = '5'
          AND oofbstus = 'Y'
        ORDER BY oofb010 DESC
   END IF 
     ##161228-00036#1------dujuan----add---end

  #取單號
  CALL s_aooi200_gen_docno(g_site,p_docno,g_today,'apmt500') RETURNING l_success,g_pmdl.pmdldocno
  IF NOT l_success THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'apm-00003'
      LET g_errparam.extend = g_pmdl.pmdldocno
      LET g_errparam.popup = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success           
  END IF

  INSERT INTO pmdl_t (pmdlent,pmdlsite,pmdldocno,pmdl001,pmdldocdt,pmdl002,pmdl004,pmdl003,
                      pmdlstus,pmdl005,pmdl006,pmdl007,pmdl008,pmdl027,pmdl052,pmdl053,pmdl009,pmdl010,
                      pmdl011,pmdl012,pmdl013,pmdl033,pmdl015,pmdl016,pmdl017,pmdl018,pmdl019,pmdl023,pmdl043,
                      pmdl044,pmdl051,pmdl020,pmdl025,pmdl026,pmdl029,pmdl021,pmdl022,pmdl032,pmdl024,pmdl054,
                      pmdl055,pmdl030,pmdl031,pmdl028,pmdl040,pmdl041,pmdl042,pmdl047,pmdl048,pmdl049,pmdl046,
                      pmdlownid,pmdlowndp,pmdlcrtid,pmdlcrtdp,pmdlcrtdt,pmdlcnfid,pmdlcnfdt)
  VALUES (g_enterprise,g_pmdl.pmdlsite,g_pmdl.pmdldocno,g_pmdl.pmdl001,g_pmdl.pmdldocdt,
          g_pmdl.pmdl002,g_pmdl.pmdl004,g_pmdl.pmdl003,g_pmdl.pmdlstus,g_pmdl.pmdl005,
          g_pmdl.pmdl006,g_pmdl.pmdl007,g_pmdl.pmdl008,g_pmdl.pmdl027,g_pmdl.pmdl052,
          g_pmdl.pmdl053,g_pmdl.pmdl009,g_pmdl.pmdl010,g_pmdl.pmdl011,g_pmdl.pmdl012,
          g_pmdl.pmdl013,g_pmdl.pmdl033,g_pmdl.pmdl015,g_pmdl.pmdl016,g_pmdl.pmdl017,
          g_pmdl.pmdl018,g_pmdl.pmdl019,g_pmdl.pmdl023,g_pmdl.pmdl043,g_pmdl.pmdl044,
          g_pmdl.pmdl051,g_pmdl.pmdl020,g_pmdl.pmdl025,g_pmdl.pmdl026,g_pmdl.pmdl029,
          g_pmdl.pmdl021,g_pmdl.pmdl022,g_pmdl.pmdl032,g_pmdl.pmdl024,g_pmdl.pmdl054,
          g_pmdl.pmdl055,g_pmdl.pmdl030,g_pmdl.pmdl031,g_pmdl.pmdl028,g_pmdl.pmdl040,
          g_pmdl.pmdl041,g_pmdl.pmdl042,g_pmdl.pmdl047,g_pmdl.pmdl048,g_pmdl.pmdl049,
          g_pmdl.pmdl046,g_pmdl.pmdlownid,g_pmdl.pmdlowndp,g_pmdl.pmdlcrtid,g_pmdl.pmdlcrtdp,
          g_pmdl.pmdlcrtdt,g_pmdl.pmdlcnfid,g_pmdl.pmdlcnfdt)
  IF SQLCA.sqlcode THEN
     INITIALIZE g_errparam TO NULL
     LET g_errparam.extend = "INSERT INTO pmdl_t"
     LET g_errparam.code   = SQLCA.sqlcode
     LET g_errparam.popup  = TRUE
     CALL cl_err()
     LET r_success = FALSE
     RETURN r_success 
  END IF
  RETURN r_success

END FUNCTION

################################################################################
# Descriptions...: #变更单工单備料檔页签资料，sfkg
# Memo...........:
# Usage..........: CALL asft300_gen_sfkg()
#                  RETURNING r_success
# Date & Author..: 2016/08/30 By lixiang
# Modify.........: #160727-00025#1
################################################################################
PRIVATE FUNCTION asft300_gen_sfkg()
DEFINE r_success       LIKE type_t.num5
#161109-00085#27-s
#DEFINE l_sfba          RECORD LIKE sfba_t.*
DEFINE l_sfba RECORD  #工單備料單身檔
       sfbaent LIKE sfba_t.sfbaent, #企業編號
       sfbasite LIKE sfba_t.sfbasite, #營運據點
       sfbadocno LIKE sfba_t.sfbadocno, #單號
       sfbaseq LIKE sfba_t.sfbaseq, #項次
       sfbaseq1 LIKE sfba_t.sfbaseq1, #項序
       sfba001 LIKE sfba_t.sfba001, #上階料號
       sfba002 LIKE sfba_t.sfba002, #部位
       sfba003 LIKE sfba_t.sfba003, #作業編號
       sfba004 LIKE sfba_t.sfba004, #作業序
       sfba005 LIKE sfba_t.sfba005, #BOM料號
       sfba006 LIKE sfba_t.sfba006, #發料料號
       sfba007 LIKE sfba_t.sfba007, #投料時距
       sfba008 LIKE sfba_t.sfba008, #必要特性
       sfba009 LIKE sfba_t.sfba009, #倒扣料
       sfba010 LIKE sfba_t.sfba010, #標準QPA分子
       sfba011 LIKE sfba_t.sfba011, #標準QPA分母
       sfba012 LIKE sfba_t.sfba012, #允許誤差率
       sfba013 LIKE sfba_t.sfba013, #應發數量
       sfba014 LIKE sfba_t.sfba014, #單位
       sfba015 LIKE sfba_t.sfba015, #委外代買數量
       sfba016 LIKE sfba_t.sfba016, #已發數量
       sfba017 LIKE sfba_t.sfba017, #報廢數量
       sfba018 LIKE sfba_t.sfba018, #盤虧數量
       sfba019 LIKE sfba_t.sfba019, #指定發料倉庫
       sfba020 LIKE sfba_t.sfba020, #指定發料儲位
       sfba021 LIKE sfba_t.sfba021, #產品特徵
       sfba022 LIKE sfba_t.sfba022, #替代率
       sfba023 LIKE sfba_t.sfba023, #標準應發數量
       sfba024 LIKE sfba_t.sfba024, #調整應發數量
       sfba025 LIKE sfba_t.sfba025, #超領數量
       sfba026 LIKE sfba_t.sfba026, #SET替代狀態
       sfba027 LIKE sfba_t.sfba027, #SET替代群組
       sfba028 LIKE sfba_t.sfba028, #客供料
       sfba029 LIKE sfba_t.sfba029, #指定發料批號
       sfba030 LIKE sfba_t.sfba030, #指定庫存管理特徵 
       #161109-00085#66 --s add
       sfbaud001 LIKE sfba_t.sfbaud001, #自定義欄位(文字)001
       sfbaud002 LIKE sfba_t.sfbaud002, #自定義欄位(文字)002
       sfbaud003 LIKE sfba_t.sfbaud003, #自定義欄位(文字)003
       sfbaud004 LIKE sfba_t.sfbaud004, #自定義欄位(文字)004
       sfbaud005 LIKE sfba_t.sfbaud005, #自定義欄位(文字)005
       sfbaud006 LIKE sfba_t.sfbaud006, #自定義欄位(文字)006
       sfbaud007 LIKE sfba_t.sfbaud007, #自定義欄位(文字)007
       sfbaud008 LIKE sfba_t.sfbaud008, #自定義欄位(文字)008
       sfbaud009 LIKE sfba_t.sfbaud009, #自定義欄位(文字)009
       sfbaud010 LIKE sfba_t.sfbaud010, #自定義欄位(文字)010
       sfbaud011 LIKE sfba_t.sfbaud011, #自定義欄位(數字)011
       sfbaud012 LIKE sfba_t.sfbaud012, #自定義欄位(數字)012
       sfbaud013 LIKE sfba_t.sfbaud013, #自定義欄位(數字)013
       sfbaud014 LIKE sfba_t.sfbaud014, #自定義欄位(數字)014
       sfbaud015 LIKE sfba_t.sfbaud015, #自定義欄位(數字)015
       sfbaud016 LIKE sfba_t.sfbaud016, #自定義欄位(數字)016
       sfbaud017 LIKE sfba_t.sfbaud017, #自定義欄位(數字)017
       sfbaud018 LIKE sfba_t.sfbaud018, #自定義欄位(數字)018
       sfbaud019 LIKE sfba_t.sfbaud019, #自定義欄位(數字)019
       sfbaud020 LIKE sfba_t.sfbaud020, #自定義欄位(數字)020
       sfbaud021 LIKE sfba_t.sfbaud021, #自定義欄位(日期時間)021
       sfbaud022 LIKE sfba_t.sfbaud022, #自定義欄位(日期時間)022
       sfbaud023 LIKE sfba_t.sfbaud023, #自定義欄位(日期時間)023
       sfbaud024 LIKE sfba_t.sfbaud024, #自定義欄位(日期時間)024
       sfbaud025 LIKE sfba_t.sfbaud025, #自定義欄位(日期時間)025
       sfbaud026 LIKE sfba_t.sfbaud026, #自定義欄位(日期時間)026
       sfbaud027 LIKE sfba_t.sfbaud027, #自定義欄位(日期時間)027
       sfbaud028 LIKE sfba_t.sfbaud028, #自定義欄位(日期時間)028
       sfbaud029 LIKE sfba_t.sfbaud029, #自定義欄位(日期時間)029
       sfbaud030 LIKE sfba_t.sfbaud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       sfba031 LIKE sfba_t.sfba031, #備置量
       sfba032 LIKE sfba_t.sfba032, #備置理由碼
       sfba033 LIKE sfba_t.sfba033, #保稅否
       sfba034 LIKE sfba_t.sfba034, #SET被替代群組
       sfba035 LIKE sfba_t.sfba035  #SET替代套數
END RECORD
#161109-00085#27-e
#161109-00085#27-s
#DEFINE l_sfkg          RECORD LIKE sfkg_t.*
DEFINE l_sfkg RECORD  #工單變更單備料單身
       sfkgent LIKE sfkg_t.sfkgent, #企業編號
       sfkgsite LIKE sfkg_t.sfkgsite, #營運據點
       sfkgdocno LIKE sfkg_t.sfkgdocno, #工單單號
       sfkgseq LIKE sfkg_t.sfkgseq, #項次
       sfkgseq1 LIKE sfkg_t.sfkgseq1, #項序
       sfkg001 LIKE sfkg_t.sfkg001, #上階料號
       sfkg002 LIKE sfkg_t.sfkg002, #部位
       sfkg003 LIKE sfkg_t.sfkg003, #作業編號
       sfkg004 LIKE sfkg_t.sfkg004, #製程式
       sfkg005 LIKE sfkg_t.sfkg005, #BOM料號
       sfkg006 LIKE sfkg_t.sfkg006, #發料料號
       sfkg007 LIKE sfkg_t.sfkg007, #投料時距
       sfkg008 LIKE sfkg_t.sfkg008, #必要特性
       sfkg009 LIKE sfkg_t.sfkg009, #倒扣料
       sfkg010 LIKE sfkg_t.sfkg010, #標準QPA
       sfkg011 LIKE sfkg_t.sfkg011, #實際QPA
       sfkg012 LIKE sfkg_t.sfkg012, #允許誤差率
       sfkg013 LIKE sfkg_t.sfkg013, #應發數量
       sfkg014 LIKE sfkg_t.sfkg014, #單位
       sfkg015 LIKE sfkg_t.sfkg015, #委外代買數量
       sfkg016 LIKE sfkg_t.sfkg016, #已發數量
       sfkg017 LIKE sfkg_t.sfkg017, #報廢數量
       sfkg018 LIKE sfkg_t.sfkg018, #盤虧數量
       sfkg019 LIKE sfkg_t.sfkg019, #指定發料倉庫
       sfkg020 LIKE sfkg_t.sfkg020, #指定發料儲位
       sfkg021 LIKE sfkg_t.sfkg021, #產品特徵
       sfkg022 LIKE sfkg_t.sfkg022, #替代率
       sfkg023 LIKE sfkg_t.sfkg023, #標準應發數量
       sfkg024 LIKE sfkg_t.sfkg024, #調整應發數量
       sfkg025 LIKE sfkg_t.sfkg025, #超領數量
       sfkg026 LIKE sfkg_t.sfkg026, #SET替代狀態
       sfkg027 LIKE sfkg_t.sfkg027, #SET替代群組
       sfkg028 LIKE sfkg_t.sfkg028, #客供料
       sfkg900 LIKE sfkg_t.sfkg900, #變更序
       sfkg901 LIKE sfkg_t.sfkg901, #變更類型
       sfkg902 LIKE sfkg_t.sfkg902, #變更日期
       sfkg904 LIKE sfkg_t.sfkg904, #變更理由
       sfkg905 LIKE sfkg_t.sfkg905, #變更備註
       #161109-00085#66 --s add
       sfkgud001 LIKE sfkg_t.sfkgud001, #自定義欄位(文字)001
       sfkgud002 LIKE sfkg_t.sfkgud002, #自定義欄位(文字)002
       sfkgud003 LIKE sfkg_t.sfkgud003, #自定義欄位(文字)003
       sfkgud004 LIKE sfkg_t.sfkgud004, #自定義欄位(文字)004
       sfkgud005 LIKE sfkg_t.sfkgud005, #自定義欄位(文字)005
       sfkgud006 LIKE sfkg_t.sfkgud006, #自定義欄位(文字)006
       sfkgud007 LIKE sfkg_t.sfkgud007, #自定義欄位(文字)007
       sfkgud008 LIKE sfkg_t.sfkgud008, #自定義欄位(文字)008
       sfkgud009 LIKE sfkg_t.sfkgud009, #自定義欄位(文字)009
       sfkgud010 LIKE sfkg_t.sfkgud010, #自定義欄位(文字)010
       sfkgud011 LIKE sfkg_t.sfkgud011, #自定義欄位(數字)011
       sfkgud012 LIKE sfkg_t.sfkgud012, #自定義欄位(數字)012
       sfkgud013 LIKE sfkg_t.sfkgud013, #自定義欄位(數字)013
       sfkgud014 LIKE sfkg_t.sfkgud014, #自定義欄位(數字)014
       sfkgud015 LIKE sfkg_t.sfkgud015, #自定義欄位(數字)015
       sfkgud016 LIKE sfkg_t.sfkgud016, #自定義欄位(數字)016
       sfkgud017 LIKE sfkg_t.sfkgud017, #自定義欄位(數字)017
       sfkgud018 LIKE sfkg_t.sfkgud018, #自定義欄位(數字)018
       sfkgud019 LIKE sfkg_t.sfkgud019, #自定義欄位(數字)019
       sfkgud020 LIKE sfkg_t.sfkgud020, #自定義欄位(數字)020
       sfkgud021 LIKE sfkg_t.sfkgud021, #自定義欄位(日期時間)021
       sfkgud022 LIKE sfkg_t.sfkgud022, #自定義欄位(日期時間)022
       sfkgud023 LIKE sfkg_t.sfkgud023, #自定義欄位(日期時間)023
       sfkgud024 LIKE sfkg_t.sfkgud024, #自定義欄位(日期時間)024
       sfkgud025 LIKE sfkg_t.sfkgud025, #自定義欄位(日期時間)025
       sfkgud026 LIKE sfkg_t.sfkgud026, #自定義欄位(日期時間)026
       sfkgud027 LIKE sfkg_t.sfkgud027, #自定義欄位(日期時間)027
       sfkgud028 LIKE sfkg_t.sfkgud028, #自定義欄位(日期時間)028
       sfkgud029 LIKE sfkg_t.sfkgud029, #自定義欄位(日期時間)029
       sfkgud030 LIKE sfkg_t.sfkgud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       sfkg029 LIKE sfkg_t.sfkg029, #指定發料批號
       sfkg030 LIKE sfkg_t.sfkg030, #指定庫存管理特征
       sfkg031 LIKE sfkg_t.sfkg031, #備置量
       sfkg032 LIKE sfkg_t.sfkg032, #備置理由碼
       sfkg033 LIKE sfkg_t.sfkg033  #保稅否
END RECORD
#161109-00085#27-e

DEFINE l_sfaa011       LIKE sfaa_t.sfaa011
DEFINE l_sfaa015       DATETIME YEAR TO SECOND
DEFINE l_sfaa015_1     LIKE type_t.chr20    #BOM有效日期
DEFINE l_n             LIKE type_t.num10
DEFINE l_bmba          DYNAMIC ARRAY OF RECORD
        bmba001         LIKE bmba_t.bmba001,    #bom相关资料都可以通过回传的key值抓取
        bmba002         LIKE bmba_t.bmba002,
        bmba003         LIKE bmba_t.bmba003,
        bmba004         LIKE bmba_t.bmba004,
        bmba005         DATETIME YEAR TO SECOND,
        bmba007         LIKE bmba_t.bmba007,
        bmba008         LIKE bmba_t.bmba008, 
        bmba035         LIKE bmba_t.bmba035,     #保稅否 
        l_bmba011       LIKE bmba_t.bmba011,     #QPA 分子，对应于原始的主件料号
        l_bmba012       LIKE bmba_t.bmba012,     #QPA 分母，对应于原始的主件料号
        l_inam002       LIKE inam_t.inam002      #元件对应特征
                       END RECORD
DEFINE l_flag           LIKE type_t.chr1 
DEFINE l_i              LIKE type_t.num10
#161109-00085#27-s
#DEFINE l_bmba2          RECORD LIKE bmba_t.*
DEFINE l_bmba2 RECORD  #產品結構研發資料單身檔
       bmbaent LIKE bmba_t.bmbaent, #企業編號
       bmbasite LIKE bmba_t.bmbasite, #營運據點
       bmba001 LIKE bmba_t.bmba001, #主件料號
       bmba002 LIKE bmba_t.bmba002, #特性
       bmba003 LIKE bmba_t.bmba003, #元件料號
       bmba004 LIKE bmba_t.bmba004, #部位編號
       bmba005 LIKE bmba_t.bmba005, #生效日期時間
       bmba006 LIKE bmba_t.bmba006, #失效日期時間
       bmba007 LIKE bmba_t.bmba007, #作業編號
       bmba008 LIKE bmba_t.bmba008, #作業序
       bmba009 LIKE bmba_t.bmba009, #項次
       bmba010 LIKE bmba_t.bmba010, #發料單位
       bmba011 LIKE bmba_t.bmba011, #組成用量
       bmba012 LIKE bmba_t.bmba012, #主件底數
       bmba013 LIKE bmba_t.bmba013, #必要
       bmba014 LIKE bmba_t.bmba014, #特徵管理
       bmba015 LIKE bmba_t.bmba015, #指定發料庫位
       bmba016 LIKE bmba_t.bmba016, #指定發料儲位
       bmba017 LIKE bmba_t.bmba017, #FAS選擇群組
       bmba018 LIKE bmba_t.bmba018, #插件位置
       bmba019 LIKE bmba_t.bmba019, #參照研發中心
       bmba020 LIKE bmba_t.bmba020, #可選件
       bmba021 LIKE bmba_t.bmba021, #工單展開選項
       bmba022 LIKE bmba_t.bmba022, #代買料
       bmba023 LIKE bmba_t.bmba023, #元件投料時距
       bmba024 LIKE bmba_t.bmba024, #主要替代料
       bmba025 LIKE bmba_t.bmba025, #附屬零件
       bmba026 LIKE bmba_t.bmba026, #ECN單號
       bmba027 LIKE bmba_t.bmba027, #用量是否使用公式
       bmba028 LIKE bmba_t.bmba028, #用量公式
       bmba029 LIKE bmba_t.bmba029, #損耗率型態
       bmba030 LIKE bmba_t.bmba030, #倒扣料
       bmba031 LIKE bmba_t.bmba031, #客供料
       bmba032 LIKE bmba_t.bmba032, #指定庫存管理特徵
       #161109-00085#66 --s add
       bmbaud001 LIKE bmba_t.bmbaud001, #自定義欄位(文字)001
       bmbaud002 LIKE bmba_t.bmbaud002, #自定義欄位(文字)002
       bmbaud003 LIKE bmba_t.bmbaud003, #自定義欄位(文字)003
       bmbaud004 LIKE bmba_t.bmbaud004, #自定義欄位(文字)004
       bmbaud005 LIKE bmba_t.bmbaud005, #自定義欄位(文字)005
       bmbaud006 LIKE bmba_t.bmbaud006, #自定義欄位(文字)006
       bmbaud007 LIKE bmba_t.bmbaud007, #自定義欄位(文字)007
       bmbaud008 LIKE bmba_t.bmbaud008, #自定義欄位(文字)008
       bmbaud009 LIKE bmba_t.bmbaud009, #自定義欄位(文字)009
       bmbaud010 LIKE bmba_t.bmbaud010, #自定義欄位(文字)010
       bmbaud011 LIKE bmba_t.bmbaud011, #自定義欄位(數字)011
       bmbaud012 LIKE bmba_t.bmbaud012, #自定義欄位(數字)012
       bmbaud013 LIKE bmba_t.bmbaud013, #自定義欄位(數字)013
       bmbaud014 LIKE bmba_t.bmbaud014, #自定義欄位(數字)014
       bmbaud015 LIKE bmba_t.bmbaud015, #自定義欄位(數字)015
       bmbaud016 LIKE bmba_t.bmbaud016, #自定義欄位(數字)016
       bmbaud017 LIKE bmba_t.bmbaud017, #自定義欄位(數字)017
       bmbaud018 LIKE bmba_t.bmbaud018, #自定義欄位(數字)018
       bmbaud019 LIKE bmba_t.bmbaud019, #自定義欄位(數字)019
       bmbaud020 LIKE bmba_t.bmbaud020, #自定義欄位(數字)020
       bmbaud021 LIKE bmba_t.bmbaud021, #自定義欄位(日期時間)021
       bmbaud022 LIKE bmba_t.bmbaud022, #自定義欄位(日期時間)022
       bmbaud023 LIKE bmba_t.bmbaud023, #自定義欄位(日期時間)023
       bmbaud024 LIKE bmba_t.bmbaud024, #自定義欄位(日期時間)024
       bmbaud025 LIKE bmba_t.bmbaud025, #自定義欄位(日期時間)025
       bmbaud026 LIKE bmba_t.bmbaud026, #自定義欄位(日期時間)026
       bmbaud027 LIKE bmba_t.bmbaud027, #自定義欄位(日期時間)027
       bmbaud028 LIKE bmba_t.bmbaud028, #自定義欄位(日期時間)028
       bmbaud029 LIKE bmba_t.bmbaud029, #自定義欄位(日期時間)029
       bmbaud030 LIKE bmba_t.bmbaud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       bmba033 LIKE bmba_t.bmba033, #損耗率是否使用公式
       bmba034 LIKE bmba_t.bmba034, #損耗率公式
       bmba035 LIKE bmba_t.bmba035  #保稅否
END RECORD
#161109-00085#27-e

DEFINE l_bmba005_1      LIKE type_t.chr20    #BOM有效日期

DEFINE l_d_mfg_0049 LIKE type_t.num5       #工單項次間隔數
DEFINE l_d_mfg_0046 LIKE type_t.chr1       #使用產品特徵
DEFINE l_s_bas_0036 LIKE type_t.chr1       #工單備料數量是否考慮外加損耗率
DEFINE l_bmbb011    LIKE bmbb_t.bmbb011
DEFINE l_bmbb012    LIKE bmbb_t.bmbb012
DEFINE l_sfba013    LIKE sfba_t.sfba013
DEFINE l_sfbaseq    LIKE sfba_t.sfbaseq
DEFINE l_sfbaseq1   LIKE sfba_t.sfbaseq1
DEFINE l_ooff013    LIKE ooff_t.ooff013
DEFINE l_success    LIKE type_t.num5
DEFINE l_sfkh003    LIKE sfkh_t.sfkh003
DEFINE l_sfkh007    LIKE sfkh_t.sfkh007

   LET r_success = FALSE

   DECLARE asft300_gen_sfkg_cs CURSOR FOR 
   #161109-00085#27-s
   #SELECT * FROM sfba_t WHERE sfbaent = g_enterprise AND sfbasite = g_site AND sfbadocno = g_sfaa_m.sfaadocno
   #161109-00085#66 --s mark
   #SELECT sfbaent,sfbasite,sfbadocno,sfbaseq,sfbaseq1,sfba001,sfba002,sfba003,sfba004,sfba005,
   #       sfba006,sfba007,sfba008,sfba009,sfba010,sfba011,sfba012,sfba013,sfba014,sfba015,
   #       sfba016,sfba017,sfba018,sfba019,sfba020,sfba021,sfba022,sfba023,sfba024,sfba025,
   #       sfba026,sfba027,sfba028,sfba029,sfba030,sfba031,sfba032,sfba033,sfba034,sfba035
   #161109-00085#66 --e mark
   #161109-00085#66 --s add
   SELECT sfbaent,sfbasite,sfbadocno,sfbaseq,sfbaseq1,
          sfba001,sfba002,sfba003,sfba004,sfba005,
          sfba006,sfba007,sfba008,sfba009,sfba010,
          sfba011,sfba012,sfba013,sfba014,sfba015,
          sfba016,sfba017,sfba018,sfba019,sfba020,
          sfba021,sfba022,sfba023,sfba024,sfba025,
          sfba026,sfba027,sfba028,sfba029,sfba030,
          sfbaud001,sfbaud002,sfbaud003,sfbaud004,sfbaud005,
          sfbaud006,sfbaud007,sfbaud008,sfbaud009,sfbaud010,
          sfbaud011,sfbaud012,sfbaud013,sfbaud014,sfbaud015,
          sfbaud016,sfbaud017,sfbaud018,sfbaud019,sfbaud020,
          sfbaud021,sfbaud022,sfbaud023,sfbaud024,sfbaud025,
          sfbaud026,sfbaud027,sfbaud028,sfbaud029,sfbaud030,
          sfba031,sfba032,sfba033,sfba034,sfba035
   #161109-00085#66 --e add
     FROM sfba_t
    WHERE sfbaent = g_enterprise AND sfbasite = g_site AND sfbadocno = g_sfaa_m.sfaadocno
   #FOREACH asft300_gen_sfkg_cs INTO l_sfba.*
   FOREACH asft300_gen_sfkg_cs 
      INTO l_sfba.sfbaent,l_sfba.sfbasite,l_sfba.sfbadocno,l_sfba.sfbaseq,l_sfba.sfbaseq1,
           l_sfba.sfba001,l_sfba.sfba002,l_sfba.sfba003,l_sfba.sfba004,l_sfba.sfba005,
           l_sfba.sfba006,l_sfba.sfba007,l_sfba.sfba008,l_sfba.sfba009,l_sfba.sfba010,
           l_sfba.sfba011,l_sfba.sfba012,l_sfba.sfba013,l_sfba.sfba014,l_sfba.sfba015,
           l_sfba.sfba016,l_sfba.sfba017,l_sfba.sfba018,l_sfba.sfba019,l_sfba.sfba020,
           l_sfba.sfba021,l_sfba.sfba022,l_sfba.sfba023,l_sfba.sfba024,l_sfba.sfba025,
           l_sfba.sfba026,l_sfba.sfba027,l_sfba.sfba028,l_sfba.sfba029,l_sfba.sfba030,
           #161109-00085#66 --s add
           l_sfba.sfbaud001,l_sfba.sfbaud002,l_sfba.sfbaud003,l_sfba.sfbaud004,l_sfba.sfbaud005,
           l_sfba.sfbaud006,l_sfba.sfbaud007,l_sfba.sfbaud008,l_sfba.sfbaud009,l_sfba.sfbaud010,
           l_sfba.sfbaud011,l_sfba.sfbaud012,l_sfba.sfbaud013,l_sfba.sfbaud014,l_sfba.sfbaud015,
           l_sfba.sfbaud016,l_sfba.sfbaud017,l_sfba.sfbaud018,l_sfba.sfbaud019,l_sfba.sfbaud020,
           l_sfba.sfbaud021,l_sfba.sfbaud022,l_sfba.sfbaud023,l_sfba.sfbaud024,l_sfba.sfbaud025,
           l_sfba.sfbaud026,l_sfba.sfbaud027,l_sfba.sfbaud028,l_sfba.sfbaud029,l_sfba.sfbaud030,
           #161109-00085#66 --e add
           l_sfba.sfba031,l_sfba.sfba032,l_sfba.sfba033,l_sfba.sfba034,l_sfba.sfba035
   #161109-00085#27-e   
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "FOREACH:"
         LET g_errparam.popup = TRUE
         CALL cl_err()

         EXIT FOREACH
      END IF
      
      INITIALIZE l_sfkg.* TO NULL   #清空数组
      
      LET l_sfkg.sfkgent = g_enterprise 
      LET l_sfkg.sfkgsite = g_site
      LET l_sfkg.sfkgdocno = l_sfba.sfbadocno
      LET l_sfkg.sfkgseq = l_sfba.sfbaseq
      LET l_sfkg.sfkgseq1 = l_sfba.sfbaseq1
      LET l_sfkg.sfkg001 = l_sfba.sfba001
      LET l_sfkg.sfkg002 = l_sfba.sfba002
      LET l_sfkg.sfkg003 = l_sfba.sfba003
      LET l_sfkg.sfkg004 = l_sfba.sfba004
      LET l_sfkg.sfkg005 = l_sfba.sfba005
      LET l_sfkg.sfkg006 = l_sfba.sfba006
      LET l_sfkg.sfkg033 = l_sfba.sfba033   #add--160512-00016#17 By shiun
      LET l_sfkg.sfkg007 = l_sfba.sfba007
      LET l_sfkg.sfkg008 = l_sfba.sfba008
      LET l_sfkg.sfkg009 = l_sfba.sfba009
      LET l_sfkg.sfkg010 = l_sfba.sfba010
      LET l_sfkg.sfkg011 = l_sfba.sfba011
      LET l_sfkg.sfkg012 = l_sfba.sfba012
      LET l_sfkg.sfkg013 = l_sfba.sfba013
      LET l_sfkg.sfkg014 = l_sfba.sfba014
      LET l_sfkg.sfkg015 = l_sfba.sfba015
      LET l_sfkg.sfkg016 = l_sfba.sfba016
      LET l_sfkg.sfkg017 = l_sfba.sfba017
      LET l_sfkg.sfkg018 = l_sfba.sfba018
      LET l_sfkg.sfkg019 = l_sfba.sfba019
      LET l_sfkg.sfkg020 = l_sfba.sfba020
      LET l_sfkg.sfkg021 = l_sfba.sfba021
      LET l_sfkg.sfkg022 = l_sfba.sfba022
      LET l_sfkg.sfkg023 = l_sfba.sfba023
      LET l_sfkg.sfkg024 = l_sfba.sfba024
      LET l_sfkg.sfkg025 = l_sfba.sfba025
      LET l_sfkg.sfkg026 = l_sfba.sfba026
      LET l_sfkg.sfkg027 = l_sfba.sfba027
      LET l_sfkg.sfkg028 = l_sfba.sfba028
      LET l_sfkg.sfkg029 = l_sfba.sfba029
      LET l_sfkg.sfkg030 = l_sfba.sfba030
      LET l_sfkg.sfkg031 = l_sfba.sfba031
      LET l_sfkg.sfkg032 = l_sfba.sfba032
      LET l_sfkg.sfkg900 = g_sfka900
      LET l_sfkg.sfkg901 = '1'
      
      INSERT INTO sfkg_t
                  (sfkgent,sfkgdocno,sfkg900,sfkgseq,sfkgseq1,
                   sfkg002,sfkg003,sfkg004,sfkg005,sfkg022,sfkg006,sfkg033,sfkg021,sfkg007,sfkg008,sfkg009,sfkg010,sfkg011,sfkg012,sfkg023,sfkg024,sfkg013,sfkg014,sfkg015,sfkg016,sfkg025,sfkg017,sfkg018,sfkg019,sfkg020,sfkg029,sfkg030,sfkg028,sfkg001,sfkg026,sfkg027,sfkg901,sfkg904,sfkg905,sfkgsite) 
            VALUES(l_sfkg.sfkgent,l_sfkg.sfkgdocno,l_sfkg.sfkg900,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,
                   l_sfkg.sfkg002,l_sfkg.sfkg003,l_sfkg.sfkg004, 
                   l_sfkg.sfkg005,l_sfkg.sfkg022,l_sfkg.sfkg006, 
                   l_sfkg.sfkg033,l_sfkg.sfkg021,l_sfkg.sfkg007, 
                   l_sfkg.sfkg008,l_sfkg.sfkg009,l_sfkg.sfkg010, 
                   l_sfkg.sfkg011,l_sfkg.sfkg012,l_sfkg.sfkg023, 
                   l_sfkg.sfkg024,l_sfkg.sfkg013,l_sfkg.sfkg014, 
                   l_sfkg.sfkg015,l_sfkg.sfkg016,l_sfkg.sfkg025, 
                   l_sfkg.sfkg017,l_sfkg.sfkg018,l_sfkg.sfkg019, 
                   l_sfkg.sfkg020,l_sfkg.sfkg029,l_sfkg.sfkg030, 
                   l_sfkg.sfkg028,l_sfkg.sfkg001,l_sfkg.sfkg026, 
                   l_sfkg.sfkg027,l_sfkg.sfkg901,l_sfkg.sfkg904, 
                   l_sfkg.sfkg905,l_sfkg.sfkgsite)

      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = 'INSERT sfkg_t'
         LET g_errparam.popup = TRUE
         CALL cl_err()

         RETURN r_success
      END IF
      INITIALIZE l_sfba.* TO NULL   #清空数组
   END FOREACH
   
   #檢查BOM表與備料明細，如果有不同時，則詢問：是否依據BOM和單身備料不同做新增？
　 #  若選否，自動依據工單開立工單變更單，單頭資料用預設，工單單身變更類型為1:未變更
　 #  若選是，將BOM與單身差異的元件新增進變更單單身，工單變更類型為3:單身新增
   LET l_sfaa011 = g_sfaa_m.sfaa011
   IF cl_null(l_sfaa011) THEN
      LET l_sfaa011 = ' '
   END IF
   
   #当p_date为null时，bom有效日期为当前日期
   IF cl_null(g_sfaa_m.sfaa015) THEN
      LET l_sfaa015 = cl_get_current()
      LET l_sfaa015_1 = l_sfaa015
   ELSE
      LET l_sfaa015 = g_sfaa_m.sfaa015
      LET l_sfaa015_1 = l_sfaa015
   END IF
   
   SELECT COUNT(1) INTO l_n FROM bmaa_t,bmba_t 
       WHERE bmaaent = bmbaent AND bmaasite = bmbasite AND bmaa001 = bmba001 AND bmaa002 = bmba002
         AND bmaaent = g_enterprise AND bmaasite = g_site AND bmaa001 = g_sfaa_m.sfaa010
         AND NVL(bmaa002,' ') = l_sfaa011 AND bmaastus = 'Y'
         AND (bmba019 = '1' OR bmba019 ='3')
         AND to_char(bmba005,'YYYY-MM-DD hh24:mi:ss')<=l_sfaa015_1
         AND (bmba006 IS NULL OR to_char(bmba006,'YYYY-MM-DD hh24:mi:ss')>l_sfaa015_1)
         AND bmba003 NOT IN 
             (SELECT sfba005 FROM sfba_t WHERE sfbaent = g_enterprise AND sfbasite = g_site AND sfbadocno = g_sfaa_m.sfaadocno)
   IF l_n > 0 THEN
      IF cl_ask_confirm('asf-00769') THEN  #是否依據BOM和單身備料不同做新增？
         
         #判断工单来源是否有订单，若有，在展bom的时候，可选件要在订单内有被选择的才可展出
         LET l_n = 0
         SELECT COUNT(1) INTO l_n FROM sfab_t
          WHERE sfabent = g_enterprise AND sfabsite = g_site 
            AND sfabdocno = g_sfaa_m.sfaadocno AND sfab001 = '2'  #订单
         IF l_n > 0 THEN
            LET l_flag = 'Y'
         ELSE
            LET l_flag = 'N'
         END IF
         #工單項次間隔數
         LET l_d_mfg_0049 = cl_get_doc_para(g_enterprise,g_site,g_slip,'D-MFG-0049')
         
         IF cl_null(l_d_mfg_0049) OR l_d_mfg_0049 = 0 THEN
            LET l_d_mfg_0049 = 1
         END IF
         
         #工單備料數量是否考慮外加損耗率
         LET l_d_mfg_0046 = cl_get_doc_para(g_enterprise,g_site,g_slip,'D-MFG-0046')
   
         LET l_s_bas_0036 = cl_get_para(g_enterprise,g_site,'S-BAS-0036')
         
         CALL s_asft300_02_bom(0,g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa013,1,1,g_sfaa_m.sfaa015,'N','',' ',l_flag,g_sfaa_m.sfaa072) 
            RETURNING l_bmba
         FOR l_i = 1 TO l_bmba.getLength()
            
            #不存在工單備料單身時，才新增
            LET l_n = 0 
            SELECT COUNT(1) INTO l_n FROM sfba_t 
               WHERE sfbaent = g_enterprise AND sfbasite = g_site AND sfbadocno = g_sfaa_m.sfaadocno AND sfba005 = l_bmba[l_i].bmba003
            IF l_n > 0 THEN
               CONTINUE FOR
            END IF
            
            INITIALIZE l_sfkg.* TO NULL   #清空数组
            
            LET l_sfkg.sfkgent = g_enterprise 
            LET l_sfkg.sfkgsite = g_site
            LET l_sfkg.sfkgdocno = g_sfaa_m.sfaadocno
            
            SELECT MAX(sfbaseq) INTO l_sfkg.sfkgseq FROM sfba_t  WHERE sfbaent = g_enterprise  AND sfbasite = g_site  AND sfbadocno = g_sfaa_m.sfaadocno
            IF cl_null(l_sfkg.sfkgseq) THEN
               LET l_sfkg.sfkgseq = l_d_mfg_0049
            ELSE
               LET l_sfkg.sfkgseq = l_sfkg.sfkgseq + l_d_mfg_0049
            END IF

            LET l_sfkg.sfkgseq1 = 0
            
            LET l_sfkg.sfkg023 = g_sfaa_m.sfaa012 * l_bmba[l_i].l_bmba011/l_bmba[l_i].l_bmba012  #數量
            
            LET l_bmba005_1 = l_bmba[l_i].bmba005
            
            SELECT bmba001,bmba002,bmba003,bmba004,bmba007,bmba008,bmba010,bmba013,bmba015,bmba016, 
                      bmba021,bmba022,bmba023,bmba024,bmba027,bmba028,bmba029,bmba030,bmba031,bmba032, 
                      bmba033,bmba034,bmbb011,bmbb012 
                 INTO l_bmba2.bmba001,l_bmba2.bmba002,l_bmba2.bmba003,l_bmba2.bmba004,l_bmba2.bmba007,
                      l_bmba2.bmba008,l_bmba2.bmba010,l_bmba2.bmba013,l_bmba2.bmba015,l_bmba2.bmba016,
                      l_bmba2.bmba021,l_bmba2.bmba022,l_bmba2.bmba023,l_bmba2.bmba024,l_bmba2.bmba027,
                      l_bmba2.bmba028,l_bmba2.bmba029,l_bmba2.bmba030,l_bmba2.bmba031,l_bmba2.bmba032,
                      l_bmba2.bmba033,l_bmba2.bmba034,l_bmbb011,l_bmbb012
                 FROM bmba_t 
                 LEFT OUTER JOIN bmbb_t ON bmbbent = bmbaent AND bmbbsite = bmbasite AND bmbb001 = bmba001 
                                   AND bmbb002 = bmba002 AND bmbb003 = bmba003 AND bmbb004 = bmba004 
                                   AND bmbb007 = bmba007 AND bmbb008 = bmba008 AND bmbb005 = bmba005 
                                   AND ((bmbb009<=l_sfkg.sfkg023 AND bmbb010 IS NULL) OR (bmbb009<=l_sfkg.sfkg023 AND bmbb010>=l_sfkg.sfkg023 )) 
                WHERE bmbaent=g_enterprise AND bmbasite=g_site 
                  AND bmba001=l_bmba[l_i].bmba001 AND bmba002=l_bmba[l_i].bmba002 AND bmba003=l_bmba[l_i].bmba003
                  AND bmba004=l_bmba[l_i].bmba004 AND bmba007=l_bmba[l_i].bmba007 AND bmba008=l_bmba[l_i].bmba008
                  AND to_char(bmba005,'yyyy-mm-dd hh24:mi:ss')=l_bmba005_1
               
            LET l_sfkg.sfkg001 = l_bmba2.bmba001
            LET l_sfkg.sfkg002 = l_bmba2.bmba004
            LET l_sfkg.sfkg003 = l_bmba2.bmba007
            LET l_sfkg.sfkg004 = l_bmba2.bmba008
            LET l_sfkg.sfkg005 = l_bmba2.bmba003
            LET l_sfkg.sfkg006 = l_bmba2.bmba003
            LET l_sfkg.sfkg007 = l_bmba2.bmba023
            LET l_sfkg.sfkg008 = l_bmba2.bmba013
            LET l_sfkg.sfkg009 = l_bmba2.bmba030
            LET l_sfkg.sfkg010 = l_bmba[l_i].l_bmba011
            LET l_sfkg.sfkg011 = l_bmba[l_i].l_bmba012
            
            #倒扣料
            IF g_sfaa_m.sfaa004 = '2' THEN
               LET l_sfkg.sfkg009 = 'Y'
            END IF
  
            IF l_bmba2.bmba033 = 'Y' THEN
               CALL s_asft300_04(g_sfaa_m.sfaadocno,l_bmba2.bmba001,l_bmba2.bmba003,l_bmba2.bmba034,' ',l_sfkg.sfkg023)
                    RETURNING l_success,l_bmbb011
            END IF
            IF cl_null(l_bmbb011) THEN LET l_bmbb011 = 0 END IF
            IF cl_null(l_bmbb012) THEN LET l_bmbb012 = 0 END IF
            #BOM的損秏為內含損秏時，允許誤差率=BOM變動損秏率，如果為外加損秏則=0
            IF l_bmba2.bmba029 = '1' THEN
               LET l_sfkg.sfkg012 = l_bmbb011
            ELSE
               LET l_sfkg.sfkg012 = 0
            END IF
      
            
            LET l_sfkg.sfkg012 = l_sfba.sfba012
            LET l_sfkg.sfkg013 = l_sfba.sfba013
            
            LET l_sfkg.sfkg014 = l_bmba2.bmba010
            IF cl_null(l_sfkg.sfkg014) THEN
               SELECT imae081 INTO l_sfkg.sfkg014
                 FROM imae_t
                WHERE imaeent = g_enterprise
                  AND imaesite = g_site
                  AND imae001 = l_sfkg.sfkg006
               IF cl_null(l_sfkg.sfkg014) THEN
                  SELECT imaa006 INTO l_sfkg.sfkg014
                    FROM imaa_t
                   WHERE imaaent = g_enterprise
                     AND imaa001 = l_sfkg.sfkg006
               END IF
            END IF
            
            #若标准应发量发生改变了，则需回算QPA分子分母
            CALL s_aooi250_take_decimals(l_sfkg.sfkg014,l_sfkg.sfkg023)
                 RETURNING l_success,l_sfkg.sfkg023
            
            IF l_bmba2.bmba029 = '2' AND l_d_mfg_0046 = 'Y' THEN
               LET l_sfba013 = l_sfkg.sfkg023 * l_bmbb011 / 100 + l_bmbb012
            ELSE
               LET l_sfba013 = 0
            END IF
            LET l_sfkg.sfkg013 = l_sfkg.sfkg023 + l_sfba013
            CALL s_asft300_03(l_sfkg.sfkg006,l_sfkg.sfkg013) RETURNING l_success,l_sfba013
            IF l_success THEN
               LET l_sfkg.sfkg013 = l_sfba013
            END IF
            #单位取位
            CALL s_aooi250_take_decimals(l_sfkg.sfkg014,l_sfkg.sfkg013)
                 RETURNING l_success,l_sfkg.sfkg013
      
            #代買料
            IF l_bmba2.bmba022 = 'Y' THEN 
               LET l_sfkg.sfkg015 = l_sfkg.sfkg013
            ELSE
               LET l_sfkg.sfkg015 = 0
            END IF
            
            LET l_sfkg.sfkg016  = 0
            LET l_sfkg.sfkg017  = 0
            LET l_sfkg.sfkg018  = 0
            LET l_sfkg.sfkg019  = l_bmba2.bmba015
            LET l_sfkg.sfkg020  = l_bmba2.bmba016
            LET l_sfkg.sfkg021  = l_bmba[l_i].l_inam002
            LET l_sfkg.sfkg022  = 1
            LET l_sfkg.sfkg024  = l_sfkg.sfkg013 - l_sfkg.sfkg023
            LET l_sfkg.sfkg025  = 0
            LET l_sfkg.sfkg026  = '1'
            LET l_sfkg.sfkg028  = l_bmba2.bmba031
            LET l_sfkg.sfkg030  = l_bmba2.bmba032
            LET l_sfkg.sfkg033  = l_bmba[l_i].bmba035   
            
            LET l_sfkg.sfkg900 = g_sfka900
            LET l_sfkg.sfkg901 = '3'   #單身新增
            
            IF cl_null(l_sfkg.sfkg002) THEN
               LET l_sfkg.sfkg002 = ' '
            END IF
            
            INSERT INTO sfkg_t
                        (sfkgent,sfkgdocno,sfkg900,sfkgseq,sfkgseq1,
                         sfkg002,sfkg003,sfkg004,sfkg005,sfkg022,sfkg006,sfkg033,sfkg021,sfkg007,sfkg008,sfkg009,sfkg010,sfkg011,sfkg012,sfkg023,sfkg024,sfkg013,sfkg014,sfkg015,sfkg016,sfkg025,sfkg017,sfkg018,sfkg019,sfkg020,sfkg029,sfkg030,sfkg028,sfkg001,sfkg026,sfkg027,sfkg901,sfkg904,sfkg905,sfkgsite) 
                  VALUES(l_sfkg.sfkgent,l_sfkg.sfkgdocno,l_sfkg.sfkg900,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,
                         l_sfkg.sfkg002,l_sfkg.sfkg003,l_sfkg.sfkg004, 
                         l_sfkg.sfkg005,l_sfkg.sfkg022,l_sfkg.sfkg006, 
                         l_sfkg.sfkg033,l_sfkg.sfkg021,l_sfkg.sfkg007, 
                         l_sfkg.sfkg008,l_sfkg.sfkg009,l_sfkg.sfkg010, 
                         l_sfkg.sfkg011,l_sfkg.sfkg012,l_sfkg.sfkg023, 
                         l_sfkg.sfkg024,l_sfkg.sfkg013,l_sfkg.sfkg014, 
                         l_sfkg.sfkg015,l_sfkg.sfkg016,l_sfkg.sfkg025, 
                         l_sfkg.sfkg017,l_sfkg.sfkg018,l_sfkg.sfkg019, 
                         l_sfkg.sfkg020,l_sfkg.sfkg029,l_sfkg.sfkg030, 
                         l_sfkg.sfkg028,l_sfkg.sfkg001,l_sfkg.sfkg026, 
                         l_sfkg.sfkg027,l_sfkg.sfkg901,l_sfkg.sfkg904, 
                         l_sfkg.sfkg905,l_sfkg.sfkgsite)
            
            IF SQLCA.sqlcode THEN
               INITIALIZE g_errparam TO NULL
               LET g_errparam.code = SQLCA.sqlcode
               LET g_errparam.extend = 'INSERT sfkg_t'
               LET g_errparam.popup = TRUE
               CALL cl_err()
            
               RETURN r_success
            END IF
            
            #写入bom单身备注至备料单身
            CALL s_aooi360_sel('5',g_site,l_bmba2.bmba001,l_bmba2.bmba002,l_bmba2.bmba003,l_bmba2.bmba004,l_bmba005_1,l_bmba2.bmba007,l_bmba2.bmba008,'','','4')
                 RETURNING l_success,l_ooff013
            IF NOT cl_null(l_ooff013) THEN
            #161031-00025#17-s
#               CALL s_aooi360_gen('7',l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,' ',' ',' ',' ',' ',' ',' ','2',l_ooff013) 
#                    RETURNING l_success
                CALL s_aooi360_gen('7',g_prog,l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,' ',' ',' ',' ',' ',' ','1',l_ooff013) 
                     RETURNING l_success
            END IF
            #161031-00025#17-e
            LET l_sfkh003 = '3'
            #项次
            IF l_sfkg.sfkgseq IS NOT NULL THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfbaseq',l_sfkh003,'',l_sfkg.sfkgseq,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #项序
            IF l_sfkg.sfkgseq1 IS NOT NULL THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfbaseq1',l_sfkh003,'',l_sfkg.sfkgseq1,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #部位
            IF l_sfkg.sfkg002 IS NOT NULL THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba002',l_sfkh003,'',l_sfkg.sfkg002,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #作业编号
            IF l_sfkg.sfkg003 IS NOT NULL  THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba003',l_sfkh003,'',l_sfkg.sfkg003,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #作业序
            IF l_sfkg.sfkg004 THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba004',l_sfkh003,'',l_sfkg.sfkg004,l_sfkh007) THEN
                  RETURN r_success
               END IF
            
            END IF
            #BOM料号
            IF l_sfkg.sfkg005 IS NOT NULL THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba005',l_sfkh003,'',l_sfkg.sfkg005,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #替代率
            IF l_sfkg.sfkg022 IS NOT NULL THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba022',l_sfkh003,'',l_sfkg.sfkg022,l_sfkh007) THEN
                  RETURN r_success
               END IF
               LET l_flag = 'Y'
            ELSE
               IF NOT s_asft800_del_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba022') THEN
                  RETURN r_success
               END IF
            END IF
            #发料料号
            IF (l_sfkg.sfkg006 IS NOT NULL AND (l_sfkg.sfkg006 != l_sfba.sfba006 OR l_sfba.sfba006 IS NULL)) OR
               (l_sfkg.sfkg006 IS NULL AND l_sfba.sfba006 IS NOT NULL) THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba006',l_sfkh003,'',l_sfkg.sfkg006,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            
            #保稅否
            IF (l_sfkg.sfkg033 IS NOT NULL AND (l_sfkg.sfkg033 != l_sfba.sfba033 OR l_sfba.sfba033 IS NULL)) OR
               (l_sfkg.sfkg033 IS NULL AND l_sfba.sfba033 IS NOT NULL) THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba033',l_sfkh003,'',l_sfkg.sfkg033,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            
            #特征
            IF l_sfkg.sfkg021 IS NOT NULL THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba021',l_sfkh003,'',l_sfkg.sfkg021,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #投料时距
            IF l_sfkg.sfkg007 IS NOT NULL  THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba007',l_sfkh003,'',l_sfkg.sfkg007,l_sfkh007) THEN
                  RETURN r_success
               END IF
            
            END IF
            #必要特性
            IF l_sfkg.sfkg008 IS NOT NULL  THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba008',l_sfkh003,'',l_sfkg.sfkg008,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #倒扣料
            IF l_sfkg.sfkg009 IS NOT NULL  THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba009',l_sfkh003,'',l_sfkg.sfkg009,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #标准QPA分子
            IF l_sfkg.sfkg010 IS NOT NULL  THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba010',l_sfkh003,'',l_sfkg.sfkg010,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #标准QPA分母
            IF l_sfkg.sfkg011 IS NOT NULL  THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba011',l_sfkh003,'',l_sfkg.sfkg011,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #允许误差率
            IF l_sfkg.sfkg012 IS NOT NULL  THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba012',l_sfkh003,'',l_sfkg.sfkg012,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #标准应发数量
            IF l_sfkg.sfkg023 IS NOT NULL  THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba023',l_sfkh003,'',l_sfkg.sfkg023,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #调整应发数量
            IF l_sfkg.sfkg024 IS NOT NULL THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba024',l_sfkh003,'',l_sfkg.sfkg024,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #总应发数量
            IF l_sfkg.sfkg013 IS NOT NULL THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba013',l_sfkh003,'',l_sfkg.sfkg013,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #单位
            IF l_sfkg.sfkg014 IS NOT NULL THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba014',l_sfkh003,'',l_sfkg.sfkg014,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #委外代买数量
            IF l_sfkg.sfkg015 IS NOT NULL  THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba015',l_sfkh003,'',l_sfkg.sfkg015,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #已发数量
            IF l_sfkg.sfkg016 IS NOT NULL  THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba016',l_sfkh003,'',l_sfkg.sfkg016,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #超领数量
            IF l_sfkg.sfkg025 IS NOT NULL  THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba025',l_sfkh003,'',l_sfkg.sfkg025,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            
            #报废数量
            IF l_sfkg.sfkg017 IS NOT NULL  THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba017',l_sfkh003,'',l_sfkg.sfkg017,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #盘亏数量
            IF l_sfkg.sfkg018 IS NOT NULL THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba018',l_sfkh003,'',l_sfkg.sfkg018,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #指定发料仓库
            IF l_sfkg.sfkg019 IS NOT NULL THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba019',l_sfkh003,'',l_sfkg.sfkg019,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #指定发料储位
            IF l_sfkg.sfkg020 IS NOT NULL  THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba020',l_sfkh003,'',l_sfkg.sfkg020,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            
            #指定发料批号
            IF l_sfkg.sfkg029 IS NOT NULL THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba029',l_sfkh003,'',l_sfkg.sfkg029,l_sfkh007) THEN
                  RETURN r_success
               END IF 
            END IF
            
            #指定库存管理特征
            IF l_sfkg.sfkg030 IS NOT NULL THEN
               #其說明的SQL
               LET l_sfkh007 = " "
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba030',l_sfkh003,'',l_sfkg.sfkg030,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            
            #客供料
            IF l_sfkg.sfkg028 IS NOT NULL  THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba028',l_sfkh003,'',l_sfkg.sfkg028,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #上阶料号
            IF l_sfkg.sfkg001 IS NOT NULL  THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba001',l_sfkh003,'',l_sfkg.sfkg001,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #SET替代状态
            IF l_sfkg.sfkg026 IS NOT NULL THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba026',l_sfkh003,'',l_sfkg.sfkg026,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
            #SET替代群组
            IF l_sfkg.sfkg027 IS NOT NULL THEN
               #其說明的SQL
               LET l_sfkh007 = ""
               IF NOT s_asft800_ins_sfkh(l_sfkg.sfkgdocno,l_sfkg.sfkgseq,l_sfkg.sfkgseq1,g_sfka900,'sfba027',l_sfkh003,'',l_sfkg.sfkg027,l_sfkh007) THEN
                  RETURN r_success
               END IF
            END IF
             
         END FOR
            
      END IF    
   END IF
   
   LET r_success = TRUE
   RETURN r_success
   
END FUNCTION

################################################################################
# Descriptions...: 產生採購單單身
# Memo...........:
# Usage..........: CALL asft300_gen_apmt500_pmdn(p_sfbadocno,p_sfbaseq,p_sfbaseq1,p_sfba013)
#                  RETURNING r_success
# Date & Author..: 2016/08/30 By lixiang
# Modify.........: #160727-00025#1
################################################################################
PRIVATE FUNCTION asft300_gen_apmt500_pmdn(p_sfbadocno,p_sfbaseq,p_sfbaseq1,p_sfba013)
DEFINE p_sfbadocno   LIKE sfba_t.sfbadocno
DEFINE p_sfbaseq     LIKE sfba_t.sfbaseq
DEFINE p_sfbaseq1    LIKE sfba_t.sfbaseq1
DEFINE p_sfba013     LIKE sfba_t.sfba013
DEFINE l_imaf153     LIKE imaf_t.imaf153
DEFINE l_success     LIKE type_t.num5      
DEFINE r_success     LIKE type_t.num5
DEFINE l_ooba002     LIKE ooba_t.ooba002
#161109-00085#27-s
#DEFINE l_sfba          RECORD LIKE sfba_t.*
DEFINE l_sfba RECORD  #工單備料單身檔
       sfbaent LIKE sfba_t.sfbaent, #企業編號
       sfbasite LIKE sfba_t.sfbasite, #營運據點
       sfbadocno LIKE sfba_t.sfbadocno, #單號
       sfbaseq LIKE sfba_t.sfbaseq, #項次
       sfbaseq1 LIKE sfba_t.sfbaseq1, #項序
       sfba001 LIKE sfba_t.sfba001, #上階料號
       sfba002 LIKE sfba_t.sfba002, #部位
       sfba003 LIKE sfba_t.sfba003, #作業編號
       sfba004 LIKE sfba_t.sfba004, #作業序
       sfba005 LIKE sfba_t.sfba005, #BOM料號
       sfba006 LIKE sfba_t.sfba006, #發料料號
       sfba007 LIKE sfba_t.sfba007, #投料時距
       sfba008 LIKE sfba_t.sfba008, #必要特性
       sfba009 LIKE sfba_t.sfba009, #倒扣料
       sfba010 LIKE sfba_t.sfba010, #標準QPA分子
       sfba011 LIKE sfba_t.sfba011, #標準QPA分母
       sfba012 LIKE sfba_t.sfba012, #允許誤差率
       sfba013 LIKE sfba_t.sfba013, #應發數量
       sfba014 LIKE sfba_t.sfba014, #單位
       sfba015 LIKE sfba_t.sfba015, #委外代買數量
       sfba016 LIKE sfba_t.sfba016, #已發數量
       sfba017 LIKE sfba_t.sfba017, #報廢數量
       sfba018 LIKE sfba_t.sfba018, #盤虧數量
       sfba019 LIKE sfba_t.sfba019, #指定發料倉庫
       sfba020 LIKE sfba_t.sfba020, #指定發料儲位
       sfba021 LIKE sfba_t.sfba021, #產品特徵
       sfba022 LIKE sfba_t.sfba022, #替代率
       sfba023 LIKE sfba_t.sfba023, #標準應發數量
       sfba024 LIKE sfba_t.sfba024, #調整應發數量
       sfba025 LIKE sfba_t.sfba025, #超領數量
       sfba026 LIKE sfba_t.sfba026, #SET替代狀態
       sfba027 LIKE sfba_t.sfba027, #SET替代群組
       sfba028 LIKE sfba_t.sfba028, #客供料
       sfba029 LIKE sfba_t.sfba029, #指定發料批號
       sfba030 LIKE sfba_t.sfba030, #指定庫存管理特徵
       #161109-00085#66 --s add
       sfbaud001 LIKE sfba_t.sfbaud001, #自定義欄位(文字)001
       sfbaud002 LIKE sfba_t.sfbaud002, #自定義欄位(文字)002
       sfbaud003 LIKE sfba_t.sfbaud003, #自定義欄位(文字)003
       sfbaud004 LIKE sfba_t.sfbaud004, #自定義欄位(文字)004
       sfbaud005 LIKE sfba_t.sfbaud005, #自定義欄位(文字)005
       sfbaud006 LIKE sfba_t.sfbaud006, #自定義欄位(文字)006
       sfbaud007 LIKE sfba_t.sfbaud007, #自定義欄位(文字)007
       sfbaud008 LIKE sfba_t.sfbaud008, #自定義欄位(文字)008
       sfbaud009 LIKE sfba_t.sfbaud009, #自定義欄位(文字)009
       sfbaud010 LIKE sfba_t.sfbaud010, #自定義欄位(文字)010
       sfbaud011 LIKE sfba_t.sfbaud011, #自定義欄位(數字)011
       sfbaud012 LIKE sfba_t.sfbaud012, #自定義欄位(數字)012
       sfbaud013 LIKE sfba_t.sfbaud013, #自定義欄位(數字)013
       sfbaud014 LIKE sfba_t.sfbaud014, #自定義欄位(數字)014
       sfbaud015 LIKE sfba_t.sfbaud015, #自定義欄位(數字)015
       sfbaud016 LIKE sfba_t.sfbaud016, #自定義欄位(數字)016
       sfbaud017 LIKE sfba_t.sfbaud017, #自定義欄位(數字)017
       sfbaud018 LIKE sfba_t.sfbaud018, #自定義欄位(數字)018
       sfbaud019 LIKE sfba_t.sfbaud019, #自定義欄位(數字)019
       sfbaud020 LIKE sfba_t.sfbaud020, #自定義欄位(數字)020
       sfbaud021 LIKE sfba_t.sfbaud021, #自定義欄位(日期時間)021
       sfbaud022 LIKE sfba_t.sfbaud022, #自定義欄位(日期時間)022
       sfbaud023 LIKE sfba_t.sfbaud023, #自定義欄位(日期時間)023
       sfbaud024 LIKE sfba_t.sfbaud024, #自定義欄位(日期時間)024
       sfbaud025 LIKE sfba_t.sfbaud025, #自定義欄位(日期時間)025
       sfbaud026 LIKE sfba_t.sfbaud026, #自定義欄位(日期時間)026
       sfbaud027 LIKE sfba_t.sfbaud027, #自定義欄位(日期時間)027
       sfbaud028 LIKE sfba_t.sfbaud028, #自定義欄位(日期時間)028
       sfbaud029 LIKE sfba_t.sfbaud029, #自定義欄位(日期時間)029
       sfbaud030 LIKE sfba_t.sfbaud030, #自定義欄位(日期時間)030
       #161109-00085#66 --e add
       sfba031 LIKE sfba_t.sfba031, #備置量
       sfba032 LIKE sfba_t.sfba032, #備置理由碼
       sfba033 LIKE sfba_t.sfba033, #保稅否
       sfba034 LIKE sfba_t.sfba034, #SET被替代群組
       sfba035 LIKE sfba_t.sfba035  #SET替代套數
END RECORD
#161109-00085#27-e

DEFINE l_imaf173     LIKE imaf_t.imaf173
DEFINE l_imaf174     LIKE imaf_t.imaf174
DEFINE l_cnt         LIKE type_t.num10
DEFINE l_pmdl040     LIKE pmdl_t.pmdl040
DEFINE l_pmdl041     LIKE pmdl_t.pmdl041
DEFINE l_pmdl042     LIKE pmdl_t.pmdl042
DEFINE l_sql         STRING
DEFINE l_oodbl004    LIKE oodbl_t.oodbl004  #稅別名稱
DEFINE l_oodb005     LIKE oodb_t.oodb005    #含稅否
DEFINE l_oodb006     LIKE oodb_t.oodb006    #稅率 
DEFINE l_oodb011     LIKE oodb_t.oodb011    #取得稅別類型1:正常稅率2:依料件設定   

   LET r_success = TRUE  
   INITIALIZE g_pmdn.* TO NULL
   
   LET g_pmdn.pmdnent   = g_enterprise      #企業編號
   LET g_pmdn.pmdnsite  = g_pmdl.pmdlsite
   LET g_pmdn.pmdndocno = g_pmdl.pmdldocno    #單號  
   #項次   
   SELECT MAX(pmdnseq)+1 INTO g_pmdn.pmdnseq FROM pmdn_t
    WHERE pmdnent = g_enterprise 
      AND pmdndocno = g_pmdl.pmdldocno
   IF cl_null(g_pmdn.pmdnseq) OR g_pmdn.pmdnseq = 0 THEN
      LET g_pmdn.pmdnseq = 1
   END IF  
   #161109-00085#27-s
   #SELECT * INTO l_sfba.* FROM sfba_t WHERE sfbaent = g_enterprise AND sfbadocno = p_sfbadocno AND sfbaseq = p_sfbaseq AND sfbaseq1 = p_sfbaseq1
   #161109-00085#66 --s mark
   #SELECT sfbaent,sfbasite,sfbadocno,sfbaseq,sfbaseq1,sfba001,sfba002,sfba003,sfba004,sfba005,
   #       sfba006,sfba007,sfba008,sfba009,sfba010,sfba011,sfba012,sfba013,sfba014,sfba015,
   #       sfba016,sfba017,sfba018,sfba019,sfba020,sfba021,sfba022,sfba023,sfba024,sfba025,
   #       sfba026,sfba027,sfba028,sfba029,sfba030,sfba031,sfba032,sfba033,sfba034,sfba035 
   #  INTO l_sfba.sfbaent,l_sfba.sfbasite,l_sfba.sfbadocno,l_sfba.sfbaseq,l_sfba.sfbaseq1,
   #       l_sfba.sfba001,l_sfba.sfba002,l_sfba.sfba003,l_sfba.sfba004,l_sfba.sfba005,
   #       l_sfba.sfba006,l_sfba.sfba007,l_sfba.sfba008,l_sfba.sfba009,l_sfba.sfba010,
   #       l_sfba.sfba011,l_sfba.sfba012,l_sfba.sfba013,l_sfba.sfba014,l_sfba.sfba015,
   #       l_sfba.sfba016,l_sfba.sfba017,l_sfba.sfba018,l_sfba.sfba019,l_sfba.sfba020,
   #       l_sfba.sfba021,l_sfba.sfba022,l_sfba.sfba023,l_sfba.sfba024,l_sfba.sfba025,
   #       l_sfba.sfba026,l_sfba.sfba027,l_sfba.sfba028,l_sfba.sfba029,l_sfba.sfba030,
   #       l_sfba.sfba031,l_sfba.sfba032,l_sfba.sfba033,l_sfba.sfba034,l_sfba.sfba035 
   #161109-00085#66 --e mark
   #161109-00085#66 --s add
   SELECT sfbaent,sfbasite,sfbadocno,sfbaseq,sfbaseq1,
          sfba001,sfba002,sfba003,sfba004,sfba005,
          sfba006,sfba007,sfba008,sfba009,sfba010,
          sfba011,sfba012,sfba013,sfba014,sfba015,
          sfba016,sfba017,sfba018,sfba019,sfba020,
          sfba021,sfba022,sfba023,sfba024,sfba025,
          sfba026,sfba027,sfba028,sfba029,sfba030,
          sfbaud001,sfbaud002,sfbaud003,sfbaud004,sfbaud005,
          sfbaud006,sfbaud007,sfbaud008,sfbaud009,sfbaud010,
          sfbaud011,sfbaud012,sfbaud013,sfbaud014,sfbaud015,
          sfbaud016,sfbaud017,sfbaud018,sfbaud019,sfbaud020,
          sfbaud021,sfbaud022,sfbaud023,sfbaud024,sfbaud025,
          sfbaud026,sfbaud027,sfbaud028,sfbaud029,sfbaud030,
          sfba031,sfba032,sfba033,sfba034,sfba035
     INTO l_sfba.sfbaent,l_sfba.sfbasite,l_sfba.sfbadocno,l_sfba.sfbaseq,l_sfba.sfbaseq1,
          l_sfba.sfba001,l_sfba.sfba002,l_sfba.sfba003,l_sfba.sfba004,l_sfba.sfba005,
          l_sfba.sfba006,l_sfba.sfba007,l_sfba.sfba008,l_sfba.sfba009,l_sfba.sfba010,
          l_sfba.sfba011,l_sfba.sfba012,l_sfba.sfba013,l_sfba.sfba014,l_sfba.sfba015,
          l_sfba.sfba016,l_sfba.sfba017,l_sfba.sfba018,l_sfba.sfba019,l_sfba.sfba020,
          l_sfba.sfba021,l_sfba.sfba022,l_sfba.sfba023,l_sfba.sfba024,l_sfba.sfba025,
          l_sfba.sfba026,l_sfba.sfba027,l_sfba.sfba028,l_sfba.sfba029,l_sfba.sfba030,
          l_sfba.sfbaud001,l_sfba.sfbaud002,l_sfba.sfbaud003,l_sfba.sfbaud004,l_sfba.sfbaud005,
          l_sfba.sfbaud006,l_sfba.sfbaud007,l_sfba.sfbaud008,l_sfba.sfbaud009,l_sfba.sfbaud010,
          l_sfba.sfbaud011,l_sfba.sfbaud012,l_sfba.sfbaud013,l_sfba.sfbaud014,l_sfba.sfbaud015,
          l_sfba.sfbaud016,l_sfba.sfbaud017,l_sfba.sfbaud018,l_sfba.sfbaud019,l_sfba.sfbaud020,
          l_sfba.sfbaud021,l_sfba.sfbaud022,l_sfba.sfbaud023,l_sfba.sfbaud024,l_sfba.sfbaud025,
          l_sfba.sfbaud026,l_sfba.sfbaud027,l_sfba.sfbaud028,l_sfba.sfbaud029,l_sfba.sfbaud030,
          l_sfba.sfba031,l_sfba.sfba032,l_sfba.sfba033,l_sfba.sfba034,l_sfba.sfba035
   #161109-00085#66 --e add          
     FROM sfba_t
    WHERE sfbaent = g_enterprise AND sfbadocno = p_sfbadocno AND sfbaseq = p_sfbaseq AND sfbaseq1 = p_sfbaseq1
   #161109-00085#27-e
   LET g_pmdn.pmdn001   = l_sfba.sfba006    #料件編號
   LET g_pmdn.pmdn002   = l_sfba.sfba021    #產品特徵
   LET g_pmdn.pmdn003   = ''                #包裝容器
   LET g_pmdn.pmdn004   = l_sfba.sfba003    #作業編號
   LET g_pmdn.pmdn005   = l_sfba.sfba004    #製程序  
   LET g_pmdn.pmdn006   = l_sfba.sfba014    #採購單位
   LET g_pmdn.pmdn007   = p_sfba013  #採購數量
   
   #參考單位
   SELECT imaf015 INTO g_pmdn.pmdn008 FROM imaf_t
    WHERE imafent  = g_enterprise
      AND imafsite = g_pmdn.pmdnsite
      AND imaf001  = g_pmdn.pmdn001
      
   #參考數量 
   #若没有参考单位时,参考数量DEFAULT NULL
   IF cl_null(g_pmdn.pmdn008) THEN
      LET g_pmdn.pmdn009 = NULL
   ELSE
      CALL s_aooi250_convert_qty(g_pmdn.pmdn001,g_pmdn.pmdn006,g_pmdn.pmdn008,g_pmdn.pmdn007)
           RETURNING l_success,g_pmdn.pmdn009
   END IF
      
#   LET g_pmdn.pmdn010   = g_pmdn.pmdn006    #計價單位   #161229-00014#1-----dujuan-----mark 
#   LET g_pmdn.pmdn011   = g_pmdn.pmdn007    #計價數量   #161229-00014#1-----dujuan-----mark 
   LET g_pmdn.pmdn014   = g_sfaa_m.sfaa019    #到庫日期
   
   #161229-00014#1-----dujuan-----str 
   IF cl_get_para(g_enterprise,g_site,'S-BAS-0019') = "Y" THEN
         SELECT imaf144 INTO g_pmdn.pmdn010
         FROM imaf_t
         WHERE imafent  = g_enterprise
         AND imafsite = g_site
         AND imaf001  = g_pmdn.pmdn001
            
         IF cl_null(g_pmdn.pmdn010) THEN
         LET g_pmdn.pmdn010   = g_pmdn.pmdn006    #計價單位   
         END IF
            
         CALL s_aooi250_convert_qty(g_pmdn.pmdn001,g_pmdn.pmdn006,g_pmdn.pmdn010,g_pmdn.pmdn007)
         RETURNING l_success,g_pmdn.pmdn011
         IF NOT cl_null(g_pmdn.pmdn011) THEN
         CALL s_apmt500_unit_round(g_pmdn.pmdn010,g_pmdn.pmdn011) 
         RETURNING g_pmdn.pmdn011 
         END IF
   ELSE
         LET g_pmdn.pmdn010   = g_pmdn.pmdn006    #計價單位
         LET g_pmdn.pmdn011   = g_pmdn.pmdn007    #計價數量         
   END IF
   #161229-00014#1-----dujuan----end
   
   #推算"到厂日期"及"出貨日期"
   LET l_imaf173 = 0
   LET l_imaf174 = 0
   SELECT imaf173,imaf174,imaf153 INTO l_imaf173,l_imaf174,l_imaf153 
     FROM imaf_t
    WHERE imafent = g_enterprise AND imafsite = g_pmdn.pmdnsite AND imaf001 = g_pmdn.pmdn001
   IF cl_null(l_imaf153) THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'axm-00553'
      LET g_errparam.extend = g_pmdl.pmdldocno
      LET g_errparam.replace[1] = g_pmdn.pmdn001
      LET g_errparam.popup = TRUE
      CALL cl_err()       
   END IF
   
   LET l_imaf173 = l_imaf173 * -1
   LET l_imaf174 = l_imaf174 * -1
   
        
   #以下倒推,由到库日期往前推算到厂日期,再由到厂日期推算交货日期
   #1.到廠日期 = 到库日期 - [T:料件據點進銷存檔].[C:到庫前置時間]
   IF NOT cl_null(l_imaf174) AND l_imaf174 <> 0 THEN
      CALL s_date_get_work_date(g_pmdn.pmdnsite,g_ooef008,g_ooef009,g_pmdn.pmdn014,0,l_imaf174) RETURNING g_pmdn.pmdn013
   ELSE
      LET g_pmdn.pmdn013 = g_pmdn.pmdn014
   END IF
   #2.出貨日期= 到厂日期 - [T:料件據點進銷存檔].[C:到廠前置時間]                              
   IF NOT cl_null(l_imaf173) AND l_imaf173 <> 0 THEN
      CALL s_date_get_work_date(g_pmdn.pmdnsite,g_ooef008,g_ooef009,g_pmdn.pmdn013,0,l_imaf173) RETURNING g_pmdn.pmdn012
   ELSE
      LET g_pmdn.pmdn012 = g_pmdn.pmdn013
   END IF
    
   LET g_pmdn.pmdn016   = g_pmdl.pmdl011    #稅別 
   LET g_pmdn.pmdn017   = g_pmdl.pmdl012    #稅率 
   
   #取得稅別類型
   CALL s_tax_chk(g_pmdn.pmdnsite,g_pmdl.pmdl011)
     RETURNING l_success,l_oodbl004,l_oodb005,l_oodb006,l_oodb011
   IF l_oodb011 = '2' AND NOT cl_null(g_pmdn.pmdn001) AND NOT cl_null(g_pmdl.pmdl024) THEN
      #依料件設定
      CALL s_tax_chktype(g_pmdn.pmdnsite,g_pmdl.pmdl004,g_pmdn.pmdn001,'2',g_pmdl.pmdl024)
           RETURNING l_success,g_pmdn.pmdn016,g_pmdn.pmdn017
      IF NOT l_success THEN
         #稅別檢查失敗，將稅別、稅率清空
         LET g_pmdn.pmdn016 = ''
         LET g_pmdn.pmdn017 = ''
      END IF                   
   END IF
   IF cl_null(g_pmdn.pmdn016) OR cl_null(g_pmdn.pmdn017) THEN
      #依正常稅率
      LET g_pmdn.pmdn016 = g_pmdl.pmdl011
      LET g_pmdn.pmdn017 = g_pmdl.pmdl012
   END IF 
   
   #子件特性
   #若拆件式工单时,为'10',否则为'1'
   LET l_cnt = 0
   SELECT COUNT(1) INTO l_cnt FROM sfba_t
    WHERE sfbaent   = g_enterprise
      AND sfbadocno = p_sfbadocno
      AND sfba006   = g_pmdn.pmdn001
      AND sfba015   > 0
   IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
   IF l_cnt > 0 THEN
      LET g_pmdn.pmdn019 = '8'    #代买料
   ELSE
      IF g_sfaa_m.sfaa003 = '3' THEN      
         LET g_pmdn.pmdn019= '10'  #拆件主件
      ELSE
         LET g_pmdn.pmdn019= '1'  #一般
      END IF
   END IF
   
   LET g_pmdn.pmdn020   = '1'               #緊急度                       
   LET g_pmdn.pmdn021   = 'N'               #保稅                    
   LET g_pmdn.pmdn022   = 'Y'               #部分交貨                
   LET g_pmdn.pmdnunit  = g_site            #收貨據點                 
   LET g_pmdn.pmdnorga  = g_site            #付款據點                 
   LET g_pmdn.pmdn023   = g_pmdl.pmdl004    #送貨供應商              
   LET g_pmdn.pmdn024   = 'N'               #多交期                  
   LET g_pmdn.pmdn025   = g_pmdl.pmdl025    #收貨地址代碼            
   LET g_pmdn.pmdn026   = g_pmdl.pmdl026    #帳款地址代碼    
   #供應商料號
   DECLARE asft300_ins_pmdn_sel_cs1 SCROLL CURSOR FOR
    SELECT pmao004 FROM pmao_t
     WHERE pmaoent = g_enterprise 
       AND pmao001 = g_pmdl.pmdl004
       AND pmao002 = g_pmdn.pmdn001
       AND pmao003 = g_pmdn.pmdn002
       AND pmao000 = '1'   #161221-00064#22  add
     ORDER BY pmao007 DESC
     
   OPEN asft300_ins_pmdn_sel_cs1 
   FETCH FIRST asft300_ins_pmdn_sel_cs1 INTO g_pmdn.pmdn027
        
   LET g_pmdn.pmdn028   = g_sfaa_m.sfaa034    #收貨庫位

   IF cl_null(g_pmdn.pmdn028) THEN
      CALL s_aooi200_get_slip(g_pmdl.pmdldocno) RETURNING l_success,l_ooba002
      CALL cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0076') RETURNING g_pmdn.pmdn028
   END IF

   LET g_pmdn.pmdn029   = g_sfaa_m.sfaa035    #收貨儲位                
   LET g_pmdn.pmdn030   = g_sfaa_m.sfaa059    #收貨批號                
   LET g_pmdn.pmdn031   = g_pmdl.pmdl020    #運輸方式                
   LET g_pmdn.pmdn032   = '1'               #取貨模式                
   LET g_pmdn.pmdn033   = 0                 #備品率                  
   LET g_pmdn.pmdn035   = '1'               #價格核決                
   LET g_pmdn.pmdn036   = g_sfaa_m.sfaa028    #專案編號                
   LET g_pmdn.pmdn037   = g_sfaa_m.sfaa029    #WBS編號                 
   LET g_pmdn.pmdn038   = g_sfaa_m.sfaa030    #活動編號                
   LET g_pmdn.pmdn039   = ''                #費用原因
     
   LET g_pmdn.pmdn040   = '1'               #取價來源    
   LET g_pmdn.pmdn041   = ''                #價格參考單號
   LET g_pmdn.pmdn042   = ''                #價格參考項次
   LET g_pmdn.pmdn043   = 0                 #取出價格    
   LET g_pmdn.pmdn044   = 0                 #價差比      
   LET g_pmdn.pmdn045   ='1'                #行狀態   
    
   CALL s_apmt500_get_price(g_pmdl.pmdl017,g_pmdl.pmdl004,g_pmdn.pmdn001,g_pmdn.pmdn002,g_pmdl.pmdl015,
       g_pmdn.pmdn016,g_pmdl.pmdl009,g_pmdl.pmdl010,g_pmdl.pmdl023,g_pmdn.pmdndocno,
       g_pmdl.pmdldocdt,g_pmdn.pmdn010,g_pmdn.pmdn011,g_pmdn.pmdnsite,g_pmdl.pmdl054,'2',g_pmdn.pmdn004,g_pmdn.pmdn005)
     RETURNING g_pmdn.pmdn040,g_pmdn.pmdn043,g_pmdn.pmdn041,g_pmdn.pmdn042
   
   LET g_pmdn.pmdn015 = g_pmdn.pmdn043
   
   #未稅金額/#含稅金額/#稅額
   CALL s_apmt500_get_amount(g_pmdn.pmdndocno,g_pmdn.pmdnseq,g_pmdl.pmdl015,
                             g_pmdn.pmdn007,g_pmdn.pmdn015,g_pmdn.pmdn016)
        RETURNING g_pmdn.pmdn046,g_pmdn.pmdn048,g_pmdn.pmdn047
    
   LET g_pmdn.pmdn049   = ''                #理由碼      
   LET g_pmdn.pmdn050   = ''                #備註        
   LET g_pmdn.pmdn051   = ''                #結案理由碼  
   LET g_pmdn.pmdn900   = ''                #保留欄位str 
   LET g_pmdn.pmdn999   = ''                #保留欄位end 
   
   LET g_pmdn.pmdn052 = ''
   LET l_sql = " SELECT qcap006 FROM qcap_t ",
              " WHERE qcapent = '",g_enterprise,"' ",
              "  AND qcapsite = '",g_pmdn.pmdnsite,"' ",
              "  AND qcap001 = '",g_pmdn.pmdn001,"' ",
              "  AND qcap002 = '",g_pmdl.pmdl004,"' "
              
   IF g_pmdn.pmdn002 IS NOT NULL THEN
      LET l_sql = l_sql ," AND qcap005 = '",g_pmdn.pmdn002,"' "
   END IF
   IF (NOT cl_null(g_pmdn.pmdn004)) AND (NOT cl_null(g_pmdn.pmdn005)) THEN
      LET l_sql = l_sql ," AND qcap003 = '",g_pmdn.pmdn004,"' AND qcap004 = '",g_pmdn.pmdn005,"' "
   END IF
   
   PREPARE get_qcap1 FROM l_sql
   EXECUTE get_qcap1 INTO g_pmdn.pmdn052  
   FREE get_qcap1
   
   IF cl_null(g_pmdn.pmdn052) THEN
      #若沒有維護aqci050,再從aqci040中帶值
      SELECT imae114 INTO g_pmdn.pmdn052 FROM imae_t 
          WHERE imaeent = g_enterprise AND imaesite = g_pmdn.pmdnsite AND imae001 = g_pmdn.pmdn001
          
   END IF
        
   IF cl_null(g_pmdn.pmdn052) THEN
      LET g_pmdn.pmdn052 = 'N'
   END IF
      
   LET g_pmdn.pmdn054   = 0
   LET g_pmdn.pmdn055   = 0
   LET g_pmdn.pmdn056   = 0
   LET g_pmdn.pmdn057   = 0
      
   INSERT INTO pmdn_t (pmdnent,pmdnsite,pmdndocno,pmdnseq,pmdnunit,pmdnorga,
                       pmdn001,pmdn002,pmdn003,pmdn004,pmdn005,
                       pmdn006,pmdn007,pmdn008,pmdn009,pmdn010,
                       pmdn011,pmdn012,pmdn013,pmdn014,pmdn015,
                       pmdn016,pmdn017,pmdn019,pmdn020,
                       pmdn021,pmdn022,pmdn023,pmdn024,pmdn025,
                       pmdn026,pmdn027,pmdn028,pmdn029,pmdn030,
                       pmdn031,pmdn032,pmdn033,pmdn035,
                       pmdn036,pmdn037,pmdn038,pmdn039,pmdn040,
                       pmdn041,pmdn042,pmdn043,pmdn044,pmdn045,
                       pmdn046,pmdn047,pmdn048,pmdn049,pmdn050,
                       pmdn052)
        VALUES (g_pmdn.pmdnent,g_pmdn.pmdnsite,g_pmdn.pmdndocno,g_pmdn.pmdnseq,g_pmdn.pmdnunit,g_pmdn.pmdnorga,
                g_pmdn.pmdn001,g_pmdn.pmdn002,g_pmdn.pmdn003,g_pmdn.pmdn004,g_pmdn.pmdn005,
                g_pmdn.pmdn006,g_pmdn.pmdn007,g_pmdn.pmdn008,g_pmdn.pmdn009,g_pmdn.pmdn010,
                g_pmdn.pmdn011,g_pmdn.pmdn012,g_pmdn.pmdn013,g_pmdn.pmdn014,g_pmdn.pmdn015,
                g_pmdn.pmdn016,g_pmdn.pmdn017,g_pmdn.pmdn019,g_pmdn.pmdn020,
                g_pmdn.pmdn021,g_pmdn.pmdn022,g_pmdn.pmdn023,g_pmdn.pmdn024,g_pmdn.pmdn025,
                g_pmdn.pmdn026,g_pmdn.pmdn027,g_pmdn.pmdn028,g_pmdn.pmdn029,g_pmdn.pmdn030,
                g_pmdn.pmdn031,g_pmdn.pmdn032,g_pmdn.pmdn033,g_pmdn.pmdn035,
                g_pmdn.pmdn036,g_pmdn.pmdn037,g_pmdn.pmdn038,g_pmdn.pmdn039,g_pmdn.pmdn040,
                g_pmdn.pmdn041,g_pmdn.pmdn042,g_pmdn.pmdn043,g_pmdn.pmdn044,g_pmdn.pmdn045,
                g_pmdn.pmdn046,g_pmdn.pmdn047,g_pmdn.pmdn048,g_pmdn.pmdn049,g_pmdn.pmdn050,
                g_pmdn.pmdn052)

    IF SQLCA.sqlcode THEN
       INITIALIZE g_errparam TO NULL
       LET g_errparam.extend = "INSERT INTO pmdn_t"
       LET g_errparam.code   = SQLCA.sqlcode
       LET g_errparam.popup  = TRUE
       CALL cl_err()
       LET r_success = FALSE
       RETURN r_success 
    END IF
    
    #需產生交期匯總明細(pmdq_t)
    IF NOT s_apmt500_gen_pmdq(g_pmdn.pmdndocno,g_pmdn.pmdnseq) THEN     
       LET r_success = FALSE
       RETURN r_success 
    END IF
    #產生採購單關聯明細檔
    IF NOT asft300_gen_apmt500_pmdp(p_sfbadocno,p_sfbaseq,p_sfbaseq1,p_sfba013) THEN   
       LET r_success = FALSE
       RETURN r_success          
    END IF    
    #自動產生採購單交期明細
    IF NOT s_apmt500_gen_pmdo(g_pmdn.pmdndocno,g_pmdn.pmdnseq) THEN
       LET r_success = FALSE
       RETURN r_success     
    END IF   
    
    RETURN r_success


END FUNCTION

################################################################################
# Descriptions...: 產生採購單單身
# Memo...........:
# Usage..........: CALL asft300_gen_apmt500_pmdp(p_sfbadocno,p_sfbaseq,p_sfbaseq1,p_sfba013)
#                  RETURNING r_success
# Date & Author..: 2016/08/30 By lixiang
# Modify.........: #160727-00025#1
################################################################################
PRIVATE FUNCTION asft300_gen_apmt500_pmdp(p_sfbadocno,p_sfbaseq,p_sfbaseq1,p_sfba013)
DEFINE p_sfbadocno   LIKE sfba_t.sfbadocno
DEFINE p_sfbaseq     LIKE sfba_t.sfbaseq
DEFINE p_sfbaseq1    LIKE sfba_t.sfbaseq1
DEFINE p_sfba013     LIKE sfba_t.sfba013
DEFINE l_imaf153     LIKE imaf_t.imaf153
DEFINE l_success     LIKE type_t.num5      
DEFINE r_success     LIKE type_t.num5
DEFINE l_ooba002     LIKE ooba_t.ooba002
#161109-00085#27-s
#DEFINE l_pmdp        RECORD LIKE pmdp_t.*
DEFINE l_pmdp RECORD  #採購關聯單據明細檔
       pmdpent LIKE pmdp_t.pmdpent, #企業編號
       pmdpsite LIKE pmdp_t.pmdpsite, #營運據點
       pmdpdocno LIKE pmdp_t.pmdpdocno, #採購單號
       pmdpseq LIKE pmdp_t.pmdpseq, #採購項次
       pmdpseq1 LIKE pmdp_t.pmdpseq1, #項序
       pmdp001 LIKE pmdp_t.pmdp001, #料件編號
       pmdp002 LIKE pmdp_t.pmdp002, #產品特徵
       pmdp003 LIKE pmdp_t.pmdp003, #來源單號
       pmdp004 LIKE pmdp_t.pmdp004, #來源項次
       pmdp005 LIKE pmdp_t.pmdp005, #來源項序
       pmdp006 LIKE pmdp_t.pmdp006, #來源分批序
       pmdp007 LIKE pmdp_t.pmdp007, #來源料號
       pmdp008 LIKE pmdp_t.pmdp008, #來源產品特徵
       pmdp009 LIKE pmdp_t.pmdp009, #來源作業編號
       pmdp010 LIKE pmdp_t.pmdp010, #來源作業序
       pmdp011 LIKE pmdp_t.pmdp011, #來源BOM特性
       pmdp012 LIKE pmdp_t.pmdp012, #來源生產控制組
       pmdp021 LIKE pmdp_t.pmdp021, #沖銷順序
       pmdp022 LIKE pmdp_t.pmdp022, #需求單位
       pmdp023 LIKE pmdp_t.pmdp023, #需求數量
       pmdp024 LIKE pmdp_t.pmdp024, #折合採購量
       pmdp025 LIKE pmdp_t.pmdp025, #已收貨量
       pmdp026 LIKE pmdp_t.pmdp026, #已入庫量
       pmdp900 LIKE pmdp_t.pmdp900, #保留欄位str
       pmdp999 LIKE pmdp_t.pmdp999  #保留欄位end
END RECORD
#161109-00085#27-e


   LET r_success = TRUE  
   
   INITIALIZE l_pmdp.* TO NULL

   LET l_pmdp.pmdpdocno = g_pmdn.pmdndocno
   LET l_pmdp.pmdpseq = g_pmdn.pmdnseq
   LET l_pmdp.pmdp001 = g_pmdn.pmdn001
   LET l_pmdp.pmdp002 = g_pmdn.pmdn002
   LET l_pmdp.pmdp003 = p_sfbadocno
   LET l_pmdp.pmdp004 = p_sfbaseq
   LET l_pmdp.pmdp005 = p_sfbaseq1
   LET l_pmdp.pmdp006 = 0
   LET l_pmdp.pmdp007 = g_pmdn.pmdn001
   LET l_pmdp.pmdp008 = g_pmdn.pmdn002
   LET l_pmdp.pmdp022 = g_pmdn.pmdn006         
   
   #項序  
   SELECT MAX(pmdpseq1)+1 INTO l_pmdp.pmdpseq1 FROM pmdp_t
    WHERE pmdpent = g_enterprise 
      AND pmdpdocno = g_pmdn.pmdndocno
      AND pmdpseq = g_pmdn.pmdnseq
   IF cl_null(l_pmdp.pmdpseq1) OR l_pmdp.pmdpseq1 = 0 THEN
      LET l_pmdp.pmdpseq1 = 1
   END IF 
   LET l_pmdp.pmdp023 = p_sfba013                          
   #沖銷順序 
   SELECT MAX(pmdp021)+1 INTO l_pmdp.pmdp021 FROM pmdp_t
    WHERE pmdpent = g_enterprise 
      AND pmdpdocno = g_pmdn.pmdndocno
      AND pmdpseq = g_pmdn.pmdnseq
   IF cl_null(l_pmdp.pmdp021) OR l_pmdp.pmdp021 = 0 THEN
      LET l_pmdp.pmdp021 = 1
   END IF
   
   #折合採購量
   LET l_pmdp.pmdp024 = l_pmdp.pmdp023
   
   INSERT INTO pmdp_t (pmdpent,pmdpsite,pmdpdocno,pmdpseq,pmdpseq1,
                       pmdp001,pmdp002,pmdp003,pmdp004,pmdp005,
                       pmdp006,pmdp007,pmdp008,pmdp021,pmdp022,
                       pmdp023,pmdp024) 
        VALUES (g_enterprise,g_site,l_pmdp.pmdpdocno,l_pmdp.pmdpseq,l_pmdp.pmdpseq1,
                l_pmdp.pmdp001,l_pmdp.pmdp002,l_pmdp.pmdp003,l_pmdp.pmdp004,l_pmdp.pmdp005,
                l_pmdp.pmdp006,l_pmdp.pmdp007,l_pmdp.pmdp008,l_pmdp.pmdp021,l_pmdp.pmdp022,
                l_pmdp.pmdp023,l_pmdp.pmdp024)
   
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.extend = "INSERT INTO pmdp_t"
      LET g_errparam.code   = SQLCA.sqlcode
      LET g_errparam.popup  = TRUE
      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF  
   RETURN r_success
   
END FUNCTION

################################################################################
# Descriptions...: copy s_feature_chk()
# Memo...........:
# Usage..........: CALL asft300_sfba021_chk()
#                  RETURNING TRUE/FALSE
# Input parameter: 
# Return code....: 
# Date & Author..: #161209-00038#3 By Whitney
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_sfba021_chk()
DEFINE l_imeb001    LIKE imeb_t.imeb001
DEFINE l_sfaa015    DATETIME YEAR TO SECOND
DEFINE l_sql        STRING
DEFINE l_cnt        LIKE type_t.num5
DEFINE l_cnt1       LIKE type_t.num5
DEFINE l_cnt2       LIKE type_t.num5
DEFINE tok          base.StringTokenizer
DEFINE l_imak003    LIKE imak_t.imak003
DEFINE l_success    LIKE type_t.num5
DEFINE l_errno      LIKE gzze_t.gzze001
DEFINE l_value      LIKE type_t.chr30
DEFINE l_imeb  DYNAMIC ARRAY OF RECORD
    imeb003    LIKE imeb_t.imeb003,
    imeb004    LIKE imeb_t.imeb004,
    bmce010    LIKE bmce_t.bmce010
           END RECORD
DEFINE l_bmce  RECORD
    bmce009    LIKE bmce_t.bmce009,
    bmce010    LIKE bmce_t.bmce010
           END RECORD

   WHENEVER ERROR CONTINUE

   IF cl_null(g_sfba_d[l_ac].sfba006) THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'sub-00152'
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN FALSE
   END IF
   
   LET l_imeb001 = ''
   SELECT imaa005 INTO l_imeb001 FROM imaa_t
    WHERE imaaent = g_enterprise
      AND imaa001 = g_sfba_d[l_ac].sfba006
   IF cl_null(l_imeb001) AND NOT cl_null(g_sfba_d[l_ac].sfba021) THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'sub-01366'
      LET g_errparam.extend = g_sfba_d[l_ac].sfba006
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN FALSE
   END IF
   IF cl_null(g_sfba_d[l_ac].sfba021) AND NOT cl_null(l_imeb001) THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'sub-01367'
      LET g_errparam.extend = g_sfba_d[l_ac].sfba006
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN FALSE
   END IF
   
   IF cl_null(g_sfaa_m.sfaa015) THEN
      LET l_sfaa015 = cl_get_current()
   ELSE
      LET l_sfaa015 = g_sfaa_m.sfaa015
   END IF
   
   DELETE FROM asft300_bmce_tmp
   LET l_sql = " SELECT bmce009,bmce010 FROM bmce_t ",
               "  WHERE bmceent = ",g_enterprise,
               "    AND bmcesite = '",g_site,"'",
               "    AND bmce001 = '",g_sfaa_m.sfaa010,"'",
               "    AND bmce002 = '",g_sfaa_m.sfaa011,"'",
               "    AND bmce003 = '",g_sfba_d[l_ac].sfba006,"'",
               "    AND bmce004 = '",g_sfba_d[l_ac].sfba002,"'",
               "    AND bmce007 = '",g_sfba_d[l_ac].sfba003,"'",
               "    AND bmce008 = '",g_sfba_d[l_ac].sfba004,"'",
               "    AND to_char(bmce005,'YYYY-MM-DD hh24:mi:ss') <= '",l_sfaa015,"'"
   PREPARE asft300_bmce_tmp_p FROM l_sql
   DECLARE asft300_bmce_tmp_c CURSOR FOR asft300_bmce_tmp_p
   FOREACH asft300_bmce_tmp_c INTO l_bmce.bmce009,l_bmce.bmce010
      INSERT INTO asft300_bmce_tmp(bmce009,bmce010)
           VALUES (l_bmce.bmce009,l_bmce.bmce010)
   END FOREACH
   
   LET l_sql = "SELECT imeb003,imeb004,bmce010 FROM imeb_t",
               "  LEFT JOIN asft300_bmce_tmp ON bmce009 = imeb004",
               " WHERE imebent = ",g_enterprise,
               "   AND imeb001 = '",l_imeb001,"'",
               " ORDER BY imeb002"
   PREPARE s_feature_imeb_p FROM l_sql
   DECLARE s_feature_imeb_c CURSOR FOR s_feature_imeb_p
   LET l_cnt1 = 1
   FOREACH s_feature_imeb_c INTO l_imeb[l_cnt1].imeb003,l_imeb[l_cnt1].imeb004,l_imeb[l_cnt1].bmce010
      LET l_cnt1 = l_cnt1 + 1
   END FOREACH
   LET l_cnt1 = l_cnt1 - 1
   
   LET l_cnt2 = 1
   LET tok = base.StringTokenizer.createExt(g_sfba_d[l_ac].sfba021,'_','',TRUE)
   WHILE tok.hasMoreTokens()
      LET l_imak003 = tok.nextToken()
      IF l_cnt2 > l_cnt1 THEN 
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'sub-00600'
         LET g_errparam.extend = g_sfba_d[l_ac].sfba021
         LET g_errparam.popup = TRUE
         CALL cl_err()
         RETURN FALSE      
      END IF
      
      IF l_imeb[l_cnt2].imeb003 = '1' THEN 
         LET l_cnt = 0
         SELECT COUNT(1) INTO l_cnt
           FROM imak_t
          WHERE imakent = g_enterprise
            AND imak001 = g_sfba_d[l_ac].sfba006
            AND imak002 = l_imeb[l_cnt2].imeb004
            AND imak003 = l_imak003
         IF l_cnt = 0 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'aim-00258'
            LET g_errparam.extend = l_imeb[l_cnt2].imeb004
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN FALSE
         END IF
      ELSE
         CALL s_aimi092_chk_eigenvalue(l_imeb001,l_imeb[l_cnt2].imeb004,l_imak003,g_sfba_d[l_ac].sfba006,'2')
              RETURNING l_success,l_errno,l_value
         IF NOT l_success THEN 
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = l_errno
            LET g_errparam.extend = l_imeb[l_cnt2].imeb004
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN FALSE
         END IF
      END IF
      
      IF NOT cl_null(l_imeb[l_cnt2].bmce010) THEN
         IF l_imak003 <> l_imeb[l_cnt2].bmce010 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'asf-00822'
            LET g_errparam.replace[1] = l_imak003
            LET g_errparam.replace[2] = l_imeb[l_cnt2].bmce010
            LET g_errparam.extend = g_sfba_d[l_ac].sfba006
            LET g_errparam.popup = TRUE
            CALL cl_err()
            RETURN FALSE
         END IF
      END IF
      
      LET l_cnt2 = l_cnt2 + 1
   END WHILE
   
   LET l_cnt2 = l_cnt2 - 1
   IF l_cnt1 > l_cnt2 THEN 
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = 'sub-00601'
      LET g_errparam.extend = g_sfba_d[l_ac].sfba021
      LET g_errparam.popup = TRUE
      CALL cl_err()
      RETURN FALSE
   END IF
   
   RETURN TRUE
END FUNCTION

################################################################################
# Descriptions...: 同項次的部位+作業代號+作業序+發料料號為相同,不同項次不可以有同樣的部位+作業代號+作業序+發料料號
# Memo...........:
# Usage..........: CALL asft300_sfbaseq_2(p_cmd)
#                  RETURNING r_success
# Input parameter: p_cmd       狀態
# Return code....: r_success   TRUE/FALSE
# Date & Author..: 2017/01/16 By shiun   #160908-00025#1
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_sfbaseq_2(p_cmd)
DEFINE p_cmd     LIKE type_t.chr1
DEFINE l_n       LIKE type_t.num5
DEFINE l_n1      LIKE type_t.num5

  IF cl_null(g_sfba_d[g_detail_idx].sfbaseq) THEN
     RETURN TRUE
  END IF 
  IF g_sfba_d[g_detail_idx].sfba002 IS NULL THEN
     RETURN TRUE
  END IF 
  IF g_sfba_d[g_detail_idx].sfba003 IS NULL THEN
     RETURN TRUE
  END IF
  IF g_sfba_d[g_detail_idx].sfba004 IS NULL THEN
     RETURN TRUE
  END IF
  IF g_sfba_d[g_detail_idx].sfba006 IS NULL THEN
     RETURN TRUE
  END IF
  SELECT COUNT(1) INTO l_n FROM sfba_t WHERE sfbaent = g_enterprise AND sfbasite = g_site AND sfbadocno = g_sfaa_m.sfaadocno
     AND sfbaseq = g_sfba_d[g_detail_idx].sfbaseq
  IF (l_n > 1 AND p_cmd = 'u') OR (l_n > 0 AND p_cmd = 'a') THEN
     SELECT COUNT(1) INTO l_n1 FROM sfba_t WHERE sfbaent = g_enterprise AND sfbasite = g_site AND sfbadocno = g_sfaa_m.sfaadocno
        AND sfbaseq = g_sfba_d[g_detail_idx].sfbaseq AND sfba002 = g_sfba_d[g_detail_idx].sfba002 AND sfba003 = g_sfba_d[g_detail_idx].sfba003
        AND sfba004 = g_sfba_d[g_detail_idx].sfba004 AND sfba006 = g_sfba_d[g_detail_idx].sfba006
     IF l_n1 = 0 THEN
        INITIALIZE g_errparam TO NULL
        LET g_errparam.code = 'asf-00827'
        LET g_errparam.extend = ''
        LET g_errparam.popup = TRUE
        CALL cl_err()

        RETURN FALSE
     END IF
  ELSE
     SELECT COUNT(1) INTO l_n1 FROM sfba_t WHERE sfbaent = g_enterprise AND sfbasite = g_site AND sfbadocno = g_sfaa_m.sfaadocno
        AND sfba002 = g_sfba_d[g_detail_idx].sfba002 AND sfba003 = g_sfba_d[g_detail_idx].sfba003
        AND sfba004 = g_sfba_d[g_detail_idx].sfba004 AND sfba006 = g_sfba_d[g_detail_idx].sfba006
     IF l_n1 > 0 THEN
        INITIALIZE g_errparam TO NULL
        LET g_errparam.code = 'asf-00827'
        LET g_errparam.extend = ''
        LET g_errparam.popup = TRUE
        CALL cl_err()

        RETURN FALSE
     END IF
  END IF
  RETURN TRUE
END FUNCTION

################################################################################
# Descriptions...: 修改生產數量後異動sfac數量
# Memo...........:
# Usage..........: CALL asft300_mod_sfac()
#                  RETURNING r_success
# Input parameter: 
# Return code....: r_success   TRUE/FALSE
# Date & Author..: 2017/01/18 By shiun   #161228-00073#1-add
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_mod_sfac()
   DEFINE r_success     LIKE type_t.num5
   DEFINE l_sql         STRING
   DEFINE l_rate        LIKE sfaa_t.sfaa012
   DEFINE l_success     LIKE type_t.num5
   DEFINE l_sfac003_sum LIKE sfac_t.sfac003
   DEFINE l_sfac        RECORD  #工單聯產品檔
          sfacseq       LIKE sfac_t.sfacseq, #項次
          sfac003       LIKE sfac_t.sfac003, #預計產出量
          sfac004       LIKE sfac_t.sfac004 #單位
   END RECORD
   
   LET r_success = TRUE
   LET l_rate = g_sfaa_m.sfaa012 / g_sfaa_m_t.sfaa012
   LET l_sql = " SELECT sfacseq,sfac003,sfac004 ",
               "   FROM sfac_t ",
               "  WHERE sfacent = ",g_enterprise,
               "    AND sfacdocno = '",g_sfaa_m.sfaadocno,"' ",
               "    AND sfac002 NOT IN ('4','5') "
               
   PREPARE asft300_sfac_p FROM l_sql
   DECLARE asft300_sfac_c CURSOR FOR asft300_sfac_p
   FOREACH asft300_sfac_c INTO l_sfac.sfacseq,l_sfac.sfac003,l_sfac.sfac004
      LET l_sfac.sfac003 = l_sfac.sfac003 * l_rate
      CALL s_aooi250_take_decimals(l_sfac.sfac004,l_sfac.sfac003)
         RETURNING l_success,l_sfac.sfac003
      
      UPDATE sfac_t SET sfac003 = l_sfac.sfac003
       WHERE sfacent = g_enterprise
        AND sfacdocno = g_sfaa_m.sfaadocno
        AND sfacseq = l_sfac.sfacseq
       
       IF SQLCA.sqlcode THEN
         LET r_success = FALSE
         EXIT FOREACH
       END IF
   END FOREACH
   
   IF NOT r_success THEN
      RETURN r_success
   END IF
   
   LET l_sfac003_sum = 0
   SELECT SUM(sfac003) INTO l_sfac003_sum
     FROM sfac_t
    WHERE sfacent = g_enterprise
      AND sfacdocno = g_sfaa_m.sfaadocno
      AND sfac002 IN ('1','2')
      
   IF l_sfac003_sum <> g_sfaa_m.sfaa012 THEN
      LET l_sfac003_sum = l_sfac003_sum - g_sfaa_m.sfaa012
      SELECT sfacseq INTO l_sfac.sfacseq
        FROM sfac_t
       WHERE sfacent = g_enterprise
         AND sfacdocno = g_sfaa_m.sfaadocno
         AND sfac002 IN('1','2')
         AND sfac003 = (SELECT MAX(sfac003) 
                          FROM sfac_t
                         WHERE sfacent = g_enterprise
                           AND sfacdocno = g_sfaa_m.sfaadocno
                           AND sfac002 IN('1','2'))
        AND rownum = 1
        
      UPDATE sfac_t SET sfac003 = sfac003 + l_sfac003_sum
       WHERE sfacent = g_enterprise
         AND sfacdocno = g_sfaa_m.sfaadocno
         AND sfacseq = l_sfac.sfacseq
      
      IF SQLCA.sqlcode THEN
         LET r_success = FALSE
      END IF
   END IF
   
   RETURN r_success
END FUNCTION

PRIVATE FUNCTION asft300_upd_sfcb(p_sfcc003,p_sfcc004)
DEFINE p_sfcc003         LIKE sfcc_t.sfcc003
DEFINE p_sfcc004         LIKE sfcc_t.sfcc004
DEFINE l_sfcb            RECORD LIKE sfcb_t.*
DEFINE l_sfcc            RECORD LIKE sfcc_t.*
DEFINE l_flag            LIKE type_t.chr1

   DECLARE asft300_sel_sfcc_init CURSOR FOR
      SELECT * FROM sfcc_t
       WHERE sfccent   = g_enterprise
         AND sfccsite  = g_site
         AND sfccdocno = g_sfaa_m.sfaadocno
         AND sfcc001   = 0
         AND sfcc003   = p_sfcc003
         AND sfcc004   = p_sfcc004
       ORDER BY sfccdocno,sfcc001,sfcc002
   LET l_flag = 'N'
   FOREACH asft300_sel_sfcc_init INTO l_sfcc.*
      LET l_flag = 'Y'
      SELECT * INTO l_sfcb.* FROM sfcb_t WHERE sfcbent = g_enterprise AND sfcbsite = g_site
         AND sfcbdocno = g_sfaa_m.sfaadocno AND sfcb001   = 0 AND sfcb002 = l_sfcc.sfcc002

      IF l_sfcb.sfcb014 = 'Y' THEN
         UPDATE sfcb_t SET sfcb046 = g_sfaa_m.sfaa012 * l_sfcb.sfcb053 / l_sfcb.sfcb054
          WHERE sfcbent = g_enterprise AND sfcbsite = g_site
            AND sfcbdocno = g_sfaa_m.sfaadocno AND sfcb001   = 0 AND sfcb002 = l_sfcc.sfcc002
         RETURN TRUE
      END IF
      IF l_sfcb.sfcb015 = 'Y' THEN
         UPDATE sfcb_t SET sfcb047 = g_sfaa_m.sfaa012 * l_sfcb.sfcb053 / l_sfcb.sfcb054
          WHERE sfcbent = g_enterprise AND sfcbsite = g_site
            AND sfcbdocno = g_sfaa_m.sfaadocno AND sfcb001   = 0 AND sfcb002 = l_sfcc.sfcc002
         RETURN TRUE
      END IF
      IF l_sfcb.sfcb016 = 'Y' THEN
         UPDATE sfcb_t SET sfcb050 = g_sfaa_m.sfaa012 * l_sfcb.sfcb053 / l_sfcb.sfcb054
          WHERE sfcbent = g_enterprise AND sfcbsite = g_site
            AND sfcbdocno = g_sfaa_m.sfaadocno AND sfcb001   = 0 AND sfcb002 = l_sfcc.sfcc002
         RETURN TRUE
      END IF
      IF l_sfcb.sfcb017 = 'Y' THEN
         UPDATE sfcb_t SET sfcb051 = g_sfaa_m.sfaa012 * l_sfcb.sfcb053 / l_sfcb.sfcb054
          WHERE sfcbent = g_enterprise AND sfcbsite = g_site
            AND sfcbdocno = g_sfaa_m.sfaadocno AND sfcb001   = 0 AND sfcb002 = l_sfcc.sfcc002
         RETURN TRUE
      END IF
      IF l_sfcb.sfcb018 = 'Y' THEN
         UPDATE sfcb_t SET sfcb048 = g_sfaa_m.sfaa012 * l_sfcb.sfcb053 / l_sfcb.sfcb054
          WHERE sfcbent = g_enterprise AND sfcbsite = g_site
            AND sfcbdocno = g_sfaa_m.sfaadocno AND sfcb001   = 0 AND sfcb002 = l_sfcc.sfcc002
         RETURN TRUE
      END IF
      IF l_sfcb.sfcb019 = 'Y' THEN
         UPDATE sfcb_t SET sfcb049 = g_sfaa_m.sfaa012 * l_sfcb.sfcb053 / l_sfcb.sfcb054
          WHERE sfcbent = g_enterprise AND sfcbsite = g_site
            AND sfcbdocno = g_sfaa_m.sfaadocno AND sfcb001   = 0 AND sfcb002 = l_sfcc.sfcc002
         RETURN TRUE
      END IF
   END FOREACH

   FOREACH asft300_sel_sfcc_init INTO l_sfcc.*
      IF asft300_upd_sfcb(l_sfcc.sfcc003,l_sfcc.sfcc004) THEN
         RETURN TRUE
      END IF
   END FOREACH

   IF l_flag = 'N' THEN
      UPDATE sfcb_t SET sfcb050 = g_sfaa_m.sfaa012
       WHERE sfcbent = g_enterprise AND sfcbsite = g_site
         AND sfcbdocno = g_sfaa_m.sfaadocno AND sfcb001   = 0
      RETURN TRUE
   END IF
   RETURN FALSE
END FUNCTION

PRIVATE FUNCTION asft300_get_rmcb010()
DEFINE  l_sql           STRING
DEFINE  l_sfab          RECORD LIKE sfab_t.*
DEFINE  r_success       LIKE type_t.num5
DEFINE  l_rmcb001       LIKE rmcb_t.rmcb001
DEFINE  l_rmcb002       LIKE rmcb_t.rmcb002

   #刪除OR作廢時回寫armt300已轉數量(rmcb010)
   LET r_success = TRUE
   LET l_sql = " SELECT * FROM sfab_t WHERE sfabent = '",g_enterprise,"'",
               "    AND sfabsite = '",g_site,"'",
               "    AND sfabdocno = '",g_sfaa_m.sfaadocno,"'"

   PREPARE asft300_sfab_pre FROM l_sql
   DECLARE asft300_sfab_cs CURSOR FOR asft300_sfab_pre
   FOREACH asft300_sfab_cs INTO l_sfab.*
      IF cl_null(l_sfab.sfab007) THEN LET l_sfab.sfab007 = 0 END IF
      UPDATE rmcb_t SET rmcb010 = rmcb010 - l_sfab.sfab007
       WHERE rmcbent = g_enterprise
         AND rmcbdocno = l_sfab.sfab002
         AND rmcbseq = l_sfab.sfab003

      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "rmcb_t"
         LET g_errparam.popup = FALSE
         CALL cl_err()
         LET r_success = FALSE
         EXIT FOREACH
      END IF

      #add by lixh 20150916
      SELECT rmcb001,rmcb002 INTO l_rmcb001,l_rmcb002 FROM rmcb_t
       WHERE rmcbent = g_enterprise
         AND rmcbdocno = l_sfab.sfab002
         AND rmcbseq = l_sfab.sfab003

      UPDATE rmab_t SET rmab014 = rmab014 - l_sfab.sfab007
       WHERE rmabent = g_enterprise
         AND rmabdocno = l_rmcb001
         AND rmabseq = l_rmcb002

      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = SQLCA.sqlcode
         LET g_errparam.extend = "rmab_t"
         LET g_errparam.popup = FALSE
         CALL cl_err()
         LET r_success = FALSE
         EXIT FOREACH
      END IF
      #add by lixh 20150916

   END FOREACH
   RETURN r_success
END FUNCTION

PRIVATE FUNCTION asft300_upd_psab006(p_psabdocno,p_psabseq,p_psab001,p_qty1,p_qty2)
DEFINE p_psabdocno       LIKE psab_t.psabdocno   #151117-00019#3-add
DEFINE p_psabseq         LIKE psab_t.psabseq     #151117-00019#3-add
DEFINE p_psab001         LIKE psab_t.psab001     #151117-00019#3-add
DEFINE p_qty1            LIKE sfaa_t.sfaa012
DEFINE p_qty2            LIKE sfaa_t.sfaa012
DEFINE r_success         LIKE type_t.num5
DEFINE l_count           LIKE type_t.num5
DEFINE l_psab004         LIKE psab_t.psab004
DEFINE l_psab006         LIKE psab_t.psab006
DEFINE l_psabdocno       LIKE psab_t.psabdocno
DEFINE l_psabseq         LIKE psab_t.psabseq
DEFINE l_success         LIKE type_t.num5

   LET r_success = TRUE

   IF cl_null(p_qty1) THEN
      LET p_qty1 = 0
   END IF

   IF cl_null(p_qty2) THEN
      LET p_qty2 = 0
   END IF
   #151117-00019#3-mod-(S)
#   IF g_sfaa_m.sfaa005 = '6' THEN
#      LET l_psabdocno = g_sfaa_m.sfaa006
#      LET l_psabseq = g_sfaa_m.sfaa007
#   ELSE
#      RETURN r_success
#   END IF
   LET l_psabdocno = p_psabdocno
   LET l_psabseq = p_psabseq
   #151117-00019#3-mod-(E)
   IF cl_null(l_psabdocno) OR cl_null(l_psabseq) THEN
      RETURN r_success
   END IF

   #檢查是否有獨立需求單
   LET l_count = 0
   SELECT COUNT(*) INTO l_count
     FROM psab_t
    WHERE psabent = g_enterprise
      AND psabdocno = l_psabdocno
      AND psabseq = l_psabseq
#      AND psab001 = g_sfaa_m.sfaa010 #151117-00019#3-mark
      AND psab001 = p_psab001   #151117-00019#3-add
   IF cl_null(l_count) OR l_count <= 0 THEN
      RETURN r_success
   END IF

   #抓取已耗需求數量
   LET l_psab006 = 0
   SELECT psab004,psab006 INTO l_psab004,l_psab006
     FROM psab_t
    WHERE psabent = g_enterprise
      AND psabdocno = l_psabdocno
      AND psabseq = l_psabseq
#      AND psab001 = g_sfaa_m.sfaa010  #151117-00019#3-mark
      AND psab001 = p_psab001  #151117-00019#3-add
   IF cl_null(l_psab006) THEN LET l_psab006 = 0 END IF

   #單位換算
   CALL s_aooi250_convert_qty(g_sfaa_m.sfaa010,g_sfaa_m.sfaa013,l_psab004,p_qty1)
        RETURNING l_success,p_qty1

   #單位換算
   CALL s_aooi250_convert_qty(g_sfaa_m.sfaa010,g_sfaa_m.sfaa013,l_psab004,p_qty2)
        RETURNING l_success,p_qty2

   #已耗需求數量=原已耗需求數量-欲減少的已耗需求數量+欲增加的已耗需求數量
   LET l_psab006 = l_psab006 - p_qty1 + p_qty2

   #更新已耗需求數量
   UPDATE psab_t SET psab006 = l_psab006
    WHERE psabent = g_enterprise
      AND psabdocno = l_psabdocno
      AND psabseq = l_psabseq
#      AND psab001 = g_sfaa_m.sfaa010  #151117-00019#3-mod
      AND psab001 = p_psab001  #151117-00019#3-add
   IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'upd psab006'
      LET g_errparam.popup = TRUE

      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF

   RETURN r_success
END FUNCTION

PRIVATE FUNCTION asft300_upd_psad006(p_psaddocno,p_psadseq,p_psad001,p_qty1,p_qty2)
DEFINE p_psaddocno       LIKE psad_t.psaddocno
DEFINE p_psadseq         LIKE psad_t.psadseq
DEFINE p_psad001         LIKE psad_t.psad001
DEFINE p_qty1            LIKE sfaa_t.sfaa012
DEFINE p_qty2            LIKE sfaa_t.sfaa012
DEFINE r_success         LIKE type_t.num5
DEFINE l_count           LIKE type_t.num5
DEFINE l_psad004         LIKE psad_t.psad004
DEFINE l_psad006         LIKE psad_t.psad006
DEFINE l_success         LIKE type_t.num5

   LET r_success = TRUE

   IF cl_null(p_qty1) THEN
      LET p_qty1 = 0
   END IF

   IF cl_null(p_qty2) THEN
      LET p_qty2 = 0
   END IF

   IF cl_null(p_psaddocno) OR cl_null(p_psadseq) THEN
      RETURN r_success
   END IF

   #檢查是否有獨立需求單
   LET l_count = 0
   SELECT COUNT(*) INTO l_count
     FROM psad_t
    WHERE psadent = g_enterprise
      AND psaddocno = p_psaddocno
      AND psadseq = p_psadseq
      AND psad001 = p_psad001
   IF cl_null(l_count) OR l_count <= 0 THEN
      RETURN r_success
   END IF

   #抓取已耗需求數量
   LET l_psad006 = 0
   SELECT psad004,psad006 INTO l_psad004,l_psad006
     FROM psad_t
    WHERE psadent = g_enterprise
      AND psaddocno = p_psaddocno
      AND psadseq = p_psadseq
#      AND psad001 = g_sfaa_m.sfaa010  #151117-00019#3-mark
      AND psad001 = p_psad001  #151117-00019#3-add
   IF cl_null(l_psad006) THEN LET l_psad006 = 0 END IF

   #單位換算
   CALL s_aooi250_convert_qty(g_sfaa_m.sfaa010,g_sfaa_m.sfaa013,l_psad004,p_qty1)
        RETURNING l_success,p_qty1

   #單位換算
   CALL s_aooi250_convert_qty(g_sfaa_m.sfaa010,g_sfaa_m.sfaa013,l_psad004,p_qty2)
        RETURNING l_success,p_qty2

   #已耗需求數量=原已耗需求數量-欲減少的已耗需求數量+欲增加的已耗需求數量
   LET l_psad006 = l_psad006 - p_qty1 + p_qty2

   #更新已耗需求數量
   UPDATE psad_t SET psad006 = l_psad006
    WHERE psadent = g_enterprise
      AND psaddocno = p_psaddocno
      AND psadseq = p_psadseq
#      AND psad001 = g_sfaa_m.sfaa010  #151117-00019#3-mod
      AND psad001 = p_psad001  #151117-00019#3-add
   IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = SQLCA.sqlcode
      LET g_errparam.extend = 'upd psad006'
      LET g_errparam.popup = TRUE

      CALL cl_err()
      LET r_success = FALSE
      RETURN r_success
   END IF

   RETURN r_success
END FUNCTION

PRIVATE FUNCTION asft300_del_inan010()
   DEFINE l_pre_qty LIKE type_t.num5
   DEFINE l_sql     STRING
   DEFINE l_success LIKE type_t.num5
   DEFINE r_success LIKE type_t.num5
   DEFINE l_sfbb    RECORD LIKE sfbb_t.*

   LET r_success = TRUE

   LET l_sql = "SELECT * FROM sfbb_t",
               " WHERE sfbbent = '",g_enterprise,"'",
               "   AND sfbbdocno = '",g_sfaa_m.sfaadocno,"'"
   PREPARE asft300_inan_pre FROM l_sql
   DECLARE asft300_inan_cs CURSOR FOR asft300_inan_pre

   FOREACH asft300_inan_cs INTO l_sfbb.*
      IF SQLCA.sqlcode THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.extend = "Foreach:",SQLERRMESSAGE
         LET g_errparam.code   = SQLCA.sqlcode
         LET g_errparam.popup  = TRUE
         CALL cl_err()
         LET r_success = FALSE
         EXIT FOREACH
      END IF

      IF l_sfbb.sfbb008 > 0 THEN
         #                         類型,營運據點,     料件編號 ,   產品特徵   ,   庫存管理特徵    ,
         CALL s_inventory_upd_inan('-2',g_site,l_sfbb.sfbb001,l_sfbb.sfbb002,l_sfbb.sfbb003,
         #                              庫位     ,     儲位      ,     批號     ,    交易單位   ,
                                   l_sfbb.sfbb004,l_sfbb.sfbb005,l_sfbb.sfbb006,l_sfbb.sfbb007,
         #                             在揀數量   ,    單據編號    ,      項次     ,      項序     ,
                                   l_sfbb.sfbb008,l_sfbb.sfbbdocno,l_sfbb.sfbbseq,l_sfbb.sfbbseq1,
         #                         營運據點
                                   ''    )  RETURNING l_success
         IF NOT l_success THEN
            LET r_success = FALSE
         END IF
      END IF
   END FOREACH

   RETURN r_success
END FUNCTION

PRIVATE FUNCTION asft300_show_sfac_desc(p_ac)
DEFINE p_ac        LIKE type_t.num5
DEFINE l_success   LIKE type_t.num5

  SELECT imaal003,imaal004 INTO g_sfac_d[p_ac].sfac001_desc,g_sfac_d[p_ac].sfac001_desc1 FROM imaal_t
   WHERE imaalent = g_enterprise AND imaal001 = g_sfac_d[p_ac].sfac001 AND imaal002 = g_lang

  SELECT oocal003 INTO g_sfac_d[p_ac].sfac004_desc FROM oocal_t
   WHERE oocalent=g_enterprise AND oocal001=g_sfac_d[p_ac].sfac004 AND oocal002=g_lang

  CALL s_feature_description(g_sfac_d[p_ac].sfac001,g_sfac_d[p_ac].sfac006)
     RETURNING l_success,g_sfac_d[p_ac].sfac006_desc
  IF NOT l_success THEN
     LET g_sfac_d[p_ac].sfac006_desc = ''
  END IF

  DISPLAY BY NAME g_sfac_d[p_ac].sfac001_desc,g_sfac_d[p_ac].sfac001_desc1,g_sfac_d[p_ac].sfac004_desc

END FUNCTION

PRIVATE FUNCTION asft300_sfaa058(p_sfaa010,p_sfaa012,p_sfaa013,p_sfaa060)
DEFINE p_sfaa010                 LIKE sfaa_t.sfaa010
DEFINE p_sfaa012                 LIKE sfaa_t.sfaa012
DEFINE p_sfaa013                 LIKE sfaa_t.sfaa013
DEFINE p_sfaa060                 LIKE sfaa_t.sfaa060
DEFINE l_success                 LIKE type_t.num5
DEFINE l_rate                    LIKE inaj_t.inaj014

   IF cl_null(p_sfaa012) OR cl_null(p_sfaa013) OR cl_null(p_sfaa060) THEN
      RETURN
   END IF
  #CALL s_aimi190_get_convert(p_sfaa010,p_sfaa013,p_sfaa060) RETURNING l_success,l_rate
  #IF l_success THEN
  #   LET g_sfaa_m.sfaa058 = p_sfaa012 * l_rate
  #ELSE
  #   LET g_sfaa_m.sfaa058 = p_sfaa012
  #END IF
   CALL s_aooi250_convert_qty(p_sfaa010,p_sfaa013,p_sfaa060,p_sfaa012) RETURNING l_success,g_sfaa_m.sfaa058
   IF NOT l_success THEN
      LET g_sfaa_m.sfaa058 = p_sfaa012
   END IF
   #单位取位
   CALL s_aooi250_take_decimals(p_sfaa060,g_sfaa_m.sfaa058)
        RETURNING l_success,g_sfaa_m.sfaa058
   DISPLAY BY NAME g_sfaa_m.sfaa058
END FUNCTION

################################################################################
#161031-00025#17 add
#維護備註單身
################################################################################
PRIVATE FUNCTION asft300_remaks()

   IF g_sfaa_m.sfaadocno IS NULL THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code = "std-00003"
      LET g_errparam.extend = ""
      LET g_errparam.popup = FALSE
      CALL cl_err()
      RETURN
   END IF
       
   CALL s_transaction_begin()
   
   OPEN asft300_cl USING g_enterprise,g_site,g_sfaa_m.sfaadocno

   IF STATUS THEN
      INITIALIZE g_errparam TO NULL
      LET g_errparam.code =  STATUS
      LET g_errparam.extend = "OPEN asft300_cl:"
      LET g_errparam.popup = TRUE
      CALL cl_err()
      CLOSE asft300_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
   
   #鎖住將被更改的資料
   FETCH asft300_cl INTO g_sfaa_m.sfaadocno,g_sfaa_m.sfaa001,g_sfaa_m.sfaadocdt,g_sfaa_m.sfaa002,g_sfaa_m.sfaa003,
                         g_sfaa_m.sfaa057,g_sfaa_m.sfaa004,g_sfaa_m.sfaastus,g_sfaa_m.sfaa005,g_sfaa_m.sfaa007,
                         g_sfaa_m.sfaa008,g_sfaa_m.sfaa063,g_sfaa_m.sfaa006,g_sfaa_m.sfaa009,g_sfaa_m.sfaa022,
                         g_sfaa_m.sfaa021,g_sfaa_m.sfaa023,g_sfaa_m.sfaa024,g_sfaa_m.sfaa064,g_sfaa_m.sfaa025, 
                         g_sfaa_m.sfaa010,g_sfaa_m.sfaa011,g_sfaa_m.sfaa012,g_sfaa_m.sfaa013,g_sfaa_m.sfaa058,
                         g_sfaa_m.sfaa060,g_sfaa_m.sfaa061,g_sfaa_m.sfaa016,g_sfaa_m.sfaa017,g_sfaa_m.sfaa018, 
                         g_sfaa_m.sfaa019,g_sfaa_m.sfaa020,g_sfaa_m.sfaa068,g_sfaa_m.sfaa014,g_sfaa_m.sfaa015,
                         g_sfaa_m.sfaa026,g_sfaa_m.sfaa062,g_sfaa_m.sfaa028,g_sfaa_m.sfaa029,g_sfaa_m.sfaa030, 
                         g_sfaa_m.sfaa031,g_sfaa_m.sfaa032,g_sfaa_m.sfaa033,g_sfaa_m.sfaa034,g_sfaa_m.sfaa035,
                         g_sfaa_m.sfaa059,g_sfaa_m.sfaa036,g_sfaa_m.sfaa037,g_sfaa_m.sfaa038,g_sfaa_m.sfaa072, 
                         g_sfaa_m.sfaa039,g_sfaa_m.sfaa040,g_sfaa_m.sfaa041,g_sfaa_m.sfaa042,g_sfaa_m.sfaa043,
                         g_sfaa_m.sfaa044,g_sfaa_m.sfaa069,g_sfaa_m.sfaa070,g_sfaa_m.sfaa045,g_sfaa_m.sfaa046, 
                         g_sfaa_m.sfaa047,g_sfaa_m.sfaa048,g_sfaa_m.sfaa065,g_sfaa_m.sfaa049,g_sfaa_m.sfaa050,
                         g_sfaa_m.sfaa051,g_sfaa_m.sfaa055,g_sfaa_m.sfaa056,g_sfaa_m.sfaaownid,g_sfaa_m.sfaaowndp,
                         g_sfaa_m.sfaacrtid,g_sfaa_m.sfaacrtdp,g_sfaa_m.sfaacrtdt,g_sfaa_m.sfaamodid,g_sfaa_m.sfaamoddt,
                         g_sfaa_m.sfaacnfid,g_sfaa_m.sfaacnfdt,g_sfaa_m.sfaapstid,g_sfaa_m.sfaapstdt
       
   #資料被他人LOCK, 或是sql執行時出現錯誤
   IF SQLCA.sqlcode THEN
      INITIALIZE g_errparam TO NULL 
      LET g_errparam.extend = g_sfaa_m.sfaadocno
      LET g_errparam.code   = SQLCA.sqlcode 
      LET g_errparam.popup  = FALSE 
      CALL cl_err()
      CLOSE asft300_cl
      CALL s_transaction_end('N','0')
      RETURN 
   END IF
 
   #檢查是否允許此動作
   IF NOT asft300_action_chk() THEN
      CLOSE asft300_cl
      CALL s_transaction_end('N','0')
      RETURN
   END IF
 
   LET g_detail_insert = cl_auth_detail_input("insert")
   LET g_detail_delete = cl_auth_detail_input("delete")
   
   LET g_ooff001_d = '6'   #6.單據單頭備註
   LET g_ooff002_d = g_prog   
   LET g_ooff003_d = g_sfaa_m.sfaadocno   #单号  
   LET g_ooff004_d = '0'    #项次
   LET g_ooff005_d = ' '
   LET g_ooff006_d = ' '
   LET g_ooff007_d = ' '
   LET g_ooff008_d = ' '
   LET g_ooff009_d = ' '
   LET g_ooff010_d = ' '
   LET g_ooff011_d = ' '
   
   DIALOG ATTRIBUTES(UNBUFFERED,FIELD ORDER FORM)
   
      SUBDIALOG aoo_aooi360_01.aooi360_01_input   #备注单身
      
      ON ACTION accept  
         ACCEPT DIALOG
        
      ON ACTION cancel      #在dialog button (放棄) 
         LET INT_FLAG = TRUE 
         LET g_detail_idx  = 1
         LET g_detail_idx2 = 1
         #各個page指標
         LET g_detail_idx_list[1] = 1 
         LET g_detail_idx_list[2] = 1
         LET g_detail_idx_list[3] = 1
 
         CALL g_curr_diag.setCurrentRow("s_detail1",1)    
         CALL g_curr_diag.setCurrentRow("s_detail2",1)
         CALL g_curr_diag.setCurrentRow("s_detail3",1)
 
         EXIT DIALOG
 
      ON ACTION close       #在dialog 右上角 (X)
         LET INT_FLAG = TRUE 
         EXIT DIALOG
 
      ON ACTION exit        #toolbar 離開
         LET INT_FLAG = TRUE 
         LET g_detail_idx  = 1
         LET g_detail_idx2 = 1
         #各個page指標
         LET g_detail_idx_list[1] = 1 
         LET g_detail_idx_list[2] = 1
         LET g_detail_idx_list[3] = 1
 
         CALL g_curr_diag.setCurrentRow("s_detail1",1)    
         CALL g_curr_diag.setCurrentRow("s_detail2",1)
         CALL g_curr_diag.setCurrentRow("s_detail3",1)
 
         EXIT DIALOG
 
      #交談指令共用ACTION
      &include "common_action.4gl" 
         CONTINUE DIALOG 
   END DIALOG
    
   CLOSE asft300_cl
   
   CALL s_transaction_end('Y','0')
   
   CALL aooi360_01_b_fill(g_ooff001_d,g_ooff002_d,g_ooff003_d,g_ooff004_d,g_ooff005_d,g_ooff006_d,g_ooff007_d,g_ooff008_d,g_ooff009_d,g_ooff010_d,g_ooff011_d)   #备注单身
   
END FUNCTION

################################################################################
# Descriptions...: 生產料號檢核
# Memo...........:
# Usage..........: CALL asft300_sfac001_chk()
#                  RETURNING r_success,r_imaa005
# Input parameter: 
# Return code....: 
# Date & Author..: #170225-00003#1 By Whitney
# Modify.........:
################################################################################
PRIVATE FUNCTION asft300_sfac001_chk()
DEFINE r_success    LIKE type_t.num5
DEFINE r_imaa005    LIKE imaa_t.imaa005
DEFINE l_success    LIKE type_t.num5
DEFINE l_flag       LIKE type_t.chr1
DEFINE l_ooba002    LIKE ooba_t.ooba002
DEFINE l_n          LIKE type_t.num5
DEFINE l_imaa005    LIKE imaa_t.imaa005
   
   LET r_success = FALSE
   LET r_imaa005 = ''
   
   #特征管理
   SELECT imaa005 INTO r_imaa005 FROM imaa_t WHERE imaaent = g_enterprise AND imaa001 = g_sfac_d[l_ac].sfac001
   IF g_sfac_d[l_ac].sfac002 = '2' THEN
      SELECT imaa005 INTO l_imaa005 FROM imaa_t WHERE imaaent = g_enterprise AND imaa001 = g_sfaa_m.sfaa010                 
      IF NOT cl_null(l_imaa005) THEN
         IF cl_null(r_imaa005) OR l_imaa005 != r_imaa005 THEN
            INITIALIZE g_errparam TO NULL
            LET g_errparam.code = 'abm-00114'
            LET g_errparam.extend = g_sfac_d[l_ac].sfac001
            LET g_errparam.popup = TRUE
            CALL cl_err()
            LET g_sfac_d[l_ac].sfac001 = g_sfac_d_t.sfac001
            RETURN r_success,r_imaa005
         END IF
      END IF
   END IF
   
   CALL s_aooi200_get_slip(g_sfaa_m.sfaadocno) RETURNING l_success,l_ooba002
   LET l_flag = cl_get_doc_para(g_enterprise,g_site,l_ooba002,'D-MFG-0024')
   #170320-00031#1-s
   #IF l_flag <> '2' AND g_sfaa_m.sfaa003 MATCHES '[145]' AND g_sfac_d[l_ac].sfac002 MATCHES '[235]' THEN
   IF l_flag <> '2' AND g_sfac_d[l_ac].sfac002 MATCHES '[235]' THEN
   #170320-00031#1-e
      LET l_n = 0
      CASE g_sfac_d[l_ac].sfac002
         WHEN '2'
            SELECT COUNT(1) INTO l_n FROM bmab_t
             WHERE bmabent = g_enterprise AND bmabsite = g_site 
               AND bmab001 = g_sfaa_m.sfaa010 AND bmab002 = g_sfaa_m.sfaa011 AND bmab003 = g_sfac_d[l_ac].sfac001
         WHEN '3'
            SELECT COUNT(1) INTO l_n FROM bmad_t
             WHERE bmadent = g_enterprise AND bmadsite = g_site 
               AND bmad001 = g_sfaa_m.sfaa010 AND bmad002 = g_sfaa_m.sfaa011 AND bmad003 = g_sfac_d[l_ac].sfac001
         WHEN '5'
            SELECT COUNT(1) INTO l_n FROM bmac_t
             WHERE bmacent = g_enterprise AND bmacsite = g_site 
               AND bmac001 = g_sfaa_m.sfaa010 AND bmac002 = g_sfaa_m.sfaa011 AND bmac003 = g_sfac_d[l_ac].sfac001
      END CASE
      IF l_n = 0 THEN
         INITIALIZE g_errparam TO NULL
         LET g_errparam.code = 'asf-00050'
         LET g_errparam.extend = g_sfac_d[l_ac].sfac001
         LET g_errparam.popup = TRUE
         CALL cl_err()
         IF l_flag = '1' THEN
            RETURN r_success,r_imaa005
         END IF
      END IF
   END IF
   
   INITIALIZE g_chkparam.* TO NULL
   LET g_chkparam.arg1 = g_sfac_d[l_ac].sfac001
   IF NOT cl_chk_exist("v_imaa001") THEN
      RETURN r_success,r_imaa005
   END IF
   IF NOT cl_chk_exist("v_imaf001_1") THEN
      RETURN r_success,r_imaa005
   END IF
   
   LET r_success = TRUE
   RETURN r_success,r_imaa005
END FUNCTION

#end add-point
{</section>}
 
