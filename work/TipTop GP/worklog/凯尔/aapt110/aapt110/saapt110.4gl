# Prog. Version..: '5.30.06-13.04.22(00010)'     #
#
# Descriptions...: 帳款維護
# Date & Author..: 92/11/25 By Roger
# Memo...........: 開窗輸入多發票時,稅額可為零& 須update 單頭原幣金額
#                  1.確認還原增加判斷付款方式 2.差異處理之4.將單頭金額分攤至單身公式修改
#                  出現分錄已產生之問句,未判斷是新增或修改之狀況
#                  輸入多發票後未update apa31f,apa32f,apa34f,aapt110_d.per增加問句,問是否update
#                  輸入多發票後,如稅額為0,無法跳出
#                  1.差異調整本幣合計金額未設小數位數  2.V.分錄產生增加判斷折讓性質為1者不產生
#                  預付產生待抵改為在確認時產生,取消確認時刪除
#                  產生分錄改在確認產生,取消確認刪除,差異處理為'1'者,不產生分錄
#                  幣別未default廠商,人員輸入default部門,輸入後更改會有錯誤
#                  預付更改或刪除時不須判斷待抵是否存在, 2.單身輸完後不update單頭金額
# Modify.........: 97/03/12 By Danny 1.取消確認時, 判斷若有折讓單, 則將折讓單刪除, 並將apa59更新為null
# Modify.........: 97/05/08 By Danny 1.判斷立帳日期不可小於關帳日期
#                                    2.確認, 取消確認時立帳日期不可小於關帳日期
#                                    3.推算付款日時, 須考慮結帳日
# Modify.........: 00/02/17 By Carol 單頭add專案代號輸入,專案代號有輸入時,單身apb21須輸入費用代號
# Modify.........: 01/05/15 By plum  立暫估由aapp115(apa08='UNAP',零稅率不申報)
#                                    產生,不允許手動輸入
# Modify.........: No.5954 02/10/01 By Kammy 多發票檔增加"稅別"、"幣別"、
#                                            "原幣未稅"、"原幣稅額"、"原幣總額"
#                                            等欄位。(稅率記錄在apk29欄位)
# Modify.........: No.7875 03/08/21 By Kammy 呼叫自動取單號時應在 Transction中
# Modify.........: No.8014 03/09/02 By Wiky  t110_compute_apa33設的變數寫死為dec(12,0),故後面取位也無效
# Modify.........: No.8150 03/09/09 Kammy 1.add apa99 多角序號
#                                         2.若多角序號not null則不可取消確認
# Modify.........: No.8394 03/10/01 Kitty t110_apz08修改稅額未出現問題
# Modify.........: No.8511 03/10/20 Kitty t110_ddd apk03若為NULL則存入空白
# Modify.........: No.8593 03/10/30 Kitty t110_ddd 小窗的稅額要先顯示
# Modify.........: No.8620 03/10/31 Kitty t110_aph_upd 與oob_file的串連改為判斷aph03='0'
# Modify.........: No.8625 03/11/03 Kitty 連續display二個apa32,一個改為31
# Modify.........: No.8654 03/11/05 Kitty 多發票畫面的發票日期應要先輸入否則check
#                                         發票字軌會無日期可判斷
# Modify.........: No.8901 03/12/16 ching apz07='Y'時,apa08 key 'AAA'時系統未檢查
# Modify.........: No.A105 04/01/12 Danny 修改大陸版運輸發票的算法
# Modify.........: No.9383 04/03/31 kitty 增加判斷t110_show_ref若aapt210本身
#                                         沒有拋轉傳票才 show aapt330所拋的傳票
# Modify.........: No.9599 04/05/28 kitty t110_ddd加LET INT_FLAG=0,相關INT_FL
# Modify.........: No.9615 04/06/02 kitty INSERT nme_file時，將nme14現金變動
# Modify.........: No.9695 04/06/29 Kitty t110_aph_upd UPDATE apa_file WHERE條件錯誤
# Modify.........: No.9770 04/07/19 Nicola aapt120寫入一筆帳款編號空白之資料
# Modify.........: No.MOD-470041 04/07/16 Nicola 修改INSERT INTO 語法
# Modify.........: No.MOD-480131 Kitty run完沖暫估時出現-255 open t110_cl
# Modify.........: No.MOD-480387 Kammy aapt210在補單身發票時，資料未回寫 apk
# Modify.........: No.MOD-480441 Kammy 多發票時，廠商統一編號須控管要輸入
# Modify.........: No.MOD-480608 04/09/02 ching 按 "留置" 按放棄無法離開
# Modify.........: No.MOD-490018 04/09/03 ching apz59='N'僅DISPLAY單身
# Modify.........: No.MOD-490217 04/09/10 yiting 料件欄位放大
# Modify.........: No.MOD-490344 04/09/21 By Kitty Controlp 未加display
# Modify.........: No.MOD-440608 04/09/24 ching 不限制在其欄位始可action
# Modify.........: No.MOD-4A0193 04/10/14 ching 稅額欄位輸入修改
# Modify.........: No.MOD-4A0253 04/10/19 echo 新增簽核流程
# Modify.........: No.MOD-490323 04/10/21 ching 詢問異動金額修改
# Modify.........: No.MOD-4A0288 04/10/21 ching 沖帳功能錯誤修改
# Modify.........: No.MOD-4B0002 04/11/01 echo  單據無法確認,出現無單身資料無法確認
# Modify.........: No.MOD-4B0015 04/11/01 By kitty 12及15的單子無法存入單身
# Modify.........: No.FUN-4B0009 04/11/02 By ching add '轉Excel檔' action
# Modify.........: No.MOD-4B0124 04/11/12 By ching t110_apa05檢查修改
# Modify.........: No.FUN-4B0054 04/11/23 By ching add 匯率開窗 call s_rate
# Modify.........: No.MOD-4B0243 04/11/24 By ching 多發票INPUT修改
# Modify.........: No.MOD-4B0269 04/11/26 By ching apz13='Y' 科目預設
# Modify.........: No.MOD-4B0277 04/11/30 By echo 在確認時程式會檢查無單身不能確認,但是雜項請款本來就允許可以無單身
# Modify.........: No.MOD-4B0308 04/11/30 By ching apa58='3' ins apk
# Modify ........: No.FUN-4B0079 04/11/30 By ching 單價,金額改成 DEC(20,6)
# Modify ........: No.FUN-4C0008 04/12/01 By kitty firm1UPDATEapa73的apa35加上()
# Modify.........: No.FUN-4C0047 04/12/08 By Nicola 權限控管修改
# Modify.........: No.MOD-4C0041 04/12/14 By Echo  查看"簽核狀況"的button
# Modify.........: No.MOD-4C0093 04/12/16 By Nicola apk06f,apk07f,apk08f update時漏掉
# Modify.........: No.FUN-4C0073 04/12/17 By pengu  匯率幣別欄位修改，與aoos010的aza17做判斷，
#                                                   如果二個幣別相同時，匯率強制為 1
# Modify.........: No.MOD-4C0113 04/12/17 By Nicola aapt210,aapt220 列印串aapr129
# Modify.........: No.FUN-4C0091 04/12/27 By Kitty apa17,apk17,扣抵區分增加可輸入3,4
# Modify.........: No.MOD-510014 05/01/07 By Kitty 控制這些欄位可不可以輸入是參考apz16(進貨發票請款時可否修改進貨單價),22的應該不用參考
# Modify.........: No.MOD-510036 05/01/14 By Kitty 判斷發票長度時先看是否為2聯或3聯發票(用gec05判斷)
# Modify.........: No.MOD-510035 05/01/14 By Kitty 多借方的部門要配合科目決定是否要entry
# Modify.........: No.MOD-4C0154 05/01/17 By Kitty 在aapt210修改單頭匯率,金額未更新發票金額apk_file
# Modify.........: No.MOD-510106 05/01/18 By Kitty FUNCTION t110_sum_apa 未判斷幣別的小數位數(本幣稅額)
# Modify.........: No.MOD-510148 05/01/24 By Kitty FUNCTION t110_k多一個g_success='Y'
# Modify.........: No.MOD-510184 05/02/01 By Kitty 如果直接付款, 選擇[6,7,8,9]完全沒有回寫原本待抵已付金額
# Modify.........: No.MOD-510180 05/02/02 By Kitty t110_apa17增加判斷apa41='Y'才可Input 否則只能 display
# Modify.........: No.MOD-510140 05/03/01 By Kitty check折讓與發票的部份修改
# Modify.........: No.FUN-530015 05/03/15 By Nicola 匯率自由格式設定
# Modify.........: No.MOD-530274 05/03/25 By Nicola 1.付款方式上方有一欄位無欄位名稱
#                                                   2.單身科目沒有做部門拒絕/接受檢查
#                                                   3.單頭科目沒有做部門拒絕/接受檢查
#                                                   4.單身金額與單頭有差異時,出現差異處理視窗,選:繼續處理單身,但系統沒有處理
#                                                   6.稅額輸入值和系統計算值不合時,欄位應停留在稅額欄位
#                                                   7.有稅率時,其稅額科目應要必須輸入
#                                                   8.匯率,原幣,本幣金額依幣別沒有做小數取位
# Modify.........: No.MOD-530687 05/03/26 Elva  修改大陸版運輸發票的算法,將DATA TYPE VAR CHAR改成CHAR
# Modify.........: No.MOD-530296 05/03/30 By Nicola 在多發票原來無稅額的稅別改為有稅額的稅別無重計算稅額
# Modify.........: No.MOD-530422 05/03/30 By Nicola 單身輸入科目，該科目需做部門管理，但單身部門欄位可空白
# Modify.........: No.MOD-530527 05/03/31 By Nicola 發票維護功能若為UNAP時,應不可做資料異動
# Modify.........: No.MOD-530494 05/03/31 By Nicola 多借方時，作部門管理及異動碼管理
# Modify.........: No.MOD-530047 05/03/31 By Nicola 若是沖暫估時,目前系統無法同時處理'直接付款',應必須開放此功能
# Modify.........: No.MOD-530307 05/03/31 By Nicola 4.無稅率時,其稅額科目應不可輸入
#                                                   5.直接付款視窗:單頭原幣,本幣未做小數取位
#                                                   7.應付未稅本幣金額輸入與原幣金額不符時(NTD),按ENTER,畫面會重新計算,但應付金額卻與未稅不符(無稅)
#                                                   8.若資料已確認,若有直接付款:2 銀行存款時,應不可做'日期修正'功能
# Modify.........: No.MOD-530439 05/04/04 By Nicola 3.單頭單身金額不平時自動留置處理，但做完差異處理後留置碼不會自動消失，需要手動處理取消留置
#                                                   2.差異處理自動產生請款折讓時，aapt210沒有帶到aapt110的匯率
# Modify.........: No.FUN-540041 05/04/20 By Smapmin  TIPTOP & EasyFlow整合程式修改方式
# Modify.........: No.FUN-550063 05/05/09 By ching  fix單身loop問題
# Modify.........: No.FUN-550030 05/05/16 By wujie  單據編號加大
# Modify.........: No.MOD-540018 05/05/23 By ching  disable _apa54()
# Modify.........: No.MOD-550108 05/06/01 By ching  預設預付aapr111列印品名
# Modify.........: No.FUN-530041 05/06/01 By Smapmin 只詢問一次"是否重新產生分錄"
# Modify.........: No.FUN-560002 05/06/03 By Will 單據編號修改
# Modify.........: No.FUN-550042 05/06/11 By Echo 確認段與整合段拆開。 aapt150,aapt210,aapt220 新增 TIPTOP 與 EasyFlow 整合
# Modify.........: No.MOD-560007 05/06/11 By Echo 重新定義整合FUN名稱
# Modify ........: No.FUN-560060 05/06/15 By vivien 單據編號加大返工				
# Modify.........: No.FUN-560070 05/06/18 By Smapmin 單位數量改抓計價單位計價數量
# Modify.........: NO.FUN-560099 05/06/20 By Smapmin 查詢時, 單身採購單號查詢程式會當出來, p_qry 無 q_pmm
# Modify.........: No.MOD-560102 05/07/01 By ching fix 部門拒絕允許
# Modify.........: No.MOD-560111 05/07/04 By ching fix ddd_c 變數清空
# Modify.........: No.FUN-570042 05/07/05 By ching default 折讓付款日=帳款日
# Modify.........: No.MOD-560236 05/07/26 By Nicola 幣別取位修正Q
# Modify.........: No.MOD-560240 05/08/02 By Smapmin 離開多借方的畫面後，借方科目會被清為空白
# Modify.........: No.MOD-540169 05/07/26 By ice 修改發票資料的顯示格式與單身資料一致,修正單身做完發票維護后顯示的問題
# Modify.........: No.MOD-580043 05/08/11 By Smapmin 在 after insert 時未call t110_ins_apk
# Modify.........: No.FUN-580006 05/08/16 By ice 是否使用進項防偽稅控接口.有稅控時,發票代碼Required
# Modify.........: No.FUN-570158 05/08/22 By Sarah 在複製裡增加set_entry段
# Modify.........: No.MOD-580079 05/08/25 By Smapmin 維護單張發票時,其格式輸入後按取消或離開後,apk171格式資料會消失.
#                                                    沖帳時應check該待抵帳帳款的付款廠商是否=aapt120請款作業上的付款廠商.
#                                                    CALL t110_compute_apa33()時判斷是不是預付情況
# Modify.........: No.FUN-580114 05/08/25 By Dido 以EF為backend engine,由TIPTOP處理前端簽核動作
# Modify.........: No.FUN-580012 05/09/12 By Elva 新增紅衝功能
# Modify.........: No.MOD-580365 05/08/31 By Carrier 調整匯差位置,考慮月底重評價
# Modify.........: No.MOD-590342 05/09/23 By Dido FUNCTION t110_apb07() 取消 FUN-560070 的修改
# Modify.........: No.MOD-580051 05/09/26 By Smapmin 修改"下QBE條件時不能正常列印"等問題
# Modify.........: No.FUN-590124 05/10/04 By Dido aag02 放寬
# Modify.........: No.MOD-590301 05/10/21 By Smapmin 確認功能做部份調整,以及其他修改.
# Modify.........: No.CHI-5A0001 05/10/27 By day  大陸版加稅控時aapt210進單身應可修改發票號碼
# Modify.........: No.MOD-590460 05/10/24 By Smapmin 按更改修改原幣金額,重新產生分錄後,單身合計沒有改變,出現本幣差異.
# Modify.........: No.MOD-5B0255 05/11/24 By Smapmin 匯率已有資料,不可再重新產生一次.
#                                                    借方科目清除,即會出現18字元.....的錯誤訊息
#                                                    本幣金額要預設為原幣金額*匯率.
#                                                    發票號碼開窗只能帶該廠商的可折讓資料.
#                                                    差異處理選3時,當我數量為0,開窗出來的視窗,原幣和本幣金額會被重算變成0;底下的原幣折讓金額也算錯了.
#                                                    將g_errno的值先清空
#                                                    帳款類別欄位不可空白的限制要在after field & after input的地方都要擋
# Modify.........: No.FUN-5A0131 05/11/28 By ice 應收帳款發票查詢可查看其詳細帳款信息
# Modify.........: No.MOD-5B0053 05/11/28 By ice 依月底重評價對AP未付金額調整,修正未付金額apa73的計算方法
# Modify.........: No.FUN-5B0135 05/12/02 By Sarah 修改單身後單頭的資料更改者,最近修改日應update
# Modify.........: No.MOD-5B0338 05/12/06 By Smapmin aapt210 增加"發票明細"Action
# Modify.........: No.MOD-5B0340 05/12/07 By Smapmin 修改MOD-560111
# Modify.........: No.TQC-5C0002 05/12/07 By Smapmin 新增單據時,簽核欄位有誤
# Modify.........: No.MOD-5B0005 05/12/07 By Smapmin 專案代號為空時,單身專案費用代號可以不用輸入
# Modify.........: No.FUN-5B0081 05/12/08 By wujie 退貨立暫估相關修改
# Modify.........: No.TQC-5B0016 05/12/15 By Smapmin apb25按 apa51='STOCK'的邏輯重新抓取科目資料
#                                                    若為進貨發票時,發票欄位'UNAP',應不可做直接付款作業.
#                                                    稅額變動後未重新UPDATE
#                                                    確認時, 選擇完確認範圍, 詢問確認否時, 若選擇'否', 則會跳出整個作業
# Modify.........: No.MOD-5C0088 05/12/15 By Smapmin LET g_errno = ''
# Modify.........: NO.MOD-5C0080 05/12/19 By Smapmin 修改稅率 * 未稅金額 依多發票檢核(+-2元)一致是稅額允許的範圍
# Modify.........: No.MOD-5B0111 05/12/20 By Smapmin 多發票功能,若輸入格式為22之發票,應可不輸入廠商統編.
# Modify.........: No.FUN-5C0015 051229 BY GILL 多借方新增異動碼欄位(共7個)
# Modify.........: NO.MOD-5B0135 06/01/05 BY yiting 選列印時,多發票參數請傳'Y'
# Modify.........: NO.MOD-5B0083 05/12/15 BY yiting 單身會科,部門沒有控制科目拒絕/允許部門.
# MOdify.........: No.MOD-610120 06/01/19 By Smapmin 條件修改
# Modify.........: No.MOD-610023 06/01/19 By Smapmin aapt120本幣差異計算有誤
# Modify.........: No.MOD-610011 06/01/19 By Smapmin aapt110取消複製功能
# Modify.........: No.MOD-5B0040 06/01/03 By smapmin 折讓發票維護後,INSERT INTO 至apk_file時,
#                                                    apk17(扣抵區分)應該取原發票的扣抵區分,而非單頭default的apa17
# Modify.........: No.MOD-5B0132 06/01/20 By Smapmin 沖帳:輸入原幣金額沒有即時判斷不可超過未沖金額
# Modify.........: NO.FUN-5C0031 06/01/23 BY yiting 複製時, 應包含多借方檔案之複製,便於習慣使用 多借方之客戶使用
# Modify.........: NO.MOD-610143 06/01/25 By Smapmin 發票號碼為UNAP時,該欄位不可修改
# Modify.........: No.MOD-620004 06/02/07 By Smapmin 單身有資料且本幣金額不為零，但是"本幣單身合計金額"卻為零
# Modify.........: No.MOD-620008 06/02/08 By Smapmin 已有沖帳之資料不可取消確認或作廢
# Modify.........: No.TQC-610135 06/02/08 By Smapmin 僅aapt110發票編號為UNAP時,不可直接付款
# Modify.........: No.MOD-620048 06/02/20 By Smapmin 發票編號無法由MISC改為其他發票編號
# Modify.........: No.TQC-620018 06/02/22 By Smapmin 單身按CONTROLO時,項次要累加1
# Modify.........: No.TQC-630032 06/03/06 l_arr1變數型態應改為char(16)
# Modify.........: No.TQC-630044 06/03/07 By Pengu 單身無法產生料號
# Modify.........: No.TQC-620113 06/02/23 By Smapmin 當 apk171 為 28,29 時, apk12,13 則不可異動
# Modify.........: No.FUN-630010 06/03/09 By saki 流程訊息通知功能
# Modify.........: No.TQC-630082 06/03/17 By Smapmin 當稅別的格式為 XX(不申報) 與 22(載有憑證) 時，不應該控管發票長度為10碥
#                                                    當稅別的格式為 28,29 時，碼數為 14 碼 
# Modify.........: No.TQC-630173 06/03/17 By Smapmin aapt150確認時,預付單號抓取有誤
# Modify.........: NO.FUN-630043 06/03/14 By Melody 多工廠帳務中心功能修改
# Modify.........: No.TQC-630134 06/03/30 By Smapmin 拿掉apz24的判斷
# Modify.........: No.MOD-630070 06/03/30 By Smapmin 採購單單別抓取有誤
# Modify.........: No.MOD-630089 06/03/31 By Smapmin 修正FUNCTION t110_apa34f()幣別取位問題
# Modify.........: No.TQC-620052 06/03/31 By Smapmin 雜項廠商的Action於新增時才出現
# Modify.........: No.FUN-630081 06/03/31 By Smapmin 拿掉單頭的CONTROLO
# Modify.........: No.TQC-630285 06/03/31 By Smapmin aapt210單身金額之稅額未自動SUM到單頭
# Modify.........: No.FUN-630068 06/04/04 By Ray 修改‘A’性質稅種的稅額計算方法，同‘T’性質稅種
# Modify.........: No.TQC-630164 06/04/09 By Smapmin 付款廠商為MISC時,統一編號不可為空白,且輸入的統編必須回饋到apa07
# Modify.........: No.TQC-630188 06/04/09 By Smapmin 11類別,單身金額可以輸入負數
# Modify.........: No.MOD-630131 06/04/09 By Smapmin 12or15類別,未輸入單身時,單身合計金額等於單頭金額
# Modify.........: No.TQC-630088 06/04/09 By Smapmin 直接付款金額回寫到apa35f,apa35
# Modify.........: No.MOD-640140 06/04/09 By Smapmin aapt210無法列印
# Modify.........: No.FUN-640022 06/04/10 By kim GP3.0 匯率參數功能改善
# Modify.........: No.MOD-640111 06/04/10 By Smapmin 單身合計金額有誤
# Modify.........: No.MOD-640225 06/04/10 By Smapmin 取消確認時,要將相對應的折讓單刪除
# Modify.........: No.FUN-640124 06/04/13 By Smapmin aapt210列印報表改串aapr220
# Modify.........: No.MOD-640473 06/04/14 By Smapmin 匯率變動後,單頭本幣要跟著改變
# Modify.........: No.MOD-640457 06/04/17 By Smapmin 多發票的本幣總額有誤
# Modify.........: No.MOD-640446 06/04/17 By Smapmin 確定新增成功後才insert into apk_file
# Modify.........: No.MOD-640458 06/04/17 By Smapmin 重新讀取目前傳票資料
# Modify.........: No.TQC-5C0093 06/04/19 By wujie   更新退貨立暫估已衝金額正負相反
# Modify.........: No.MOD-640329 06/04/19 By Smapmin 可分批沖暫估
# Modify.........: No.MOD-640518 06/04/20 By Smapmin 輸入多發票時,若格式不為'XX',則扣抵欄位不可空白
# Modify.........: No.FUN-640231 06/04/24 By Smapmin 確認段時,重新SELECT apa_file
# Modify.........: No.MOD-640549 06/04/24 By Smapmin aapt120不做差異處理
# Modify.........: No.FUN-640035 06/04/25 By kim 調整per畫面及輸入順序
# Modify.........: No.MOD-640537 06/04/25 By Carrier t110_k()中將更新衝帳款的重評后本幣未付變量修改為l_apa.apa73,不要與當前帳款的變量衝突
# Modify.........: No.MOD-650048 06/05/15 By Smapmin 修改查詢狀態變數值傳遞
# Modify.........: No.MOD-650061 06/05/16 By pengu限控制有問題,若主單身沒有刪除權限,則子功能之單身有刪除權限卻無法使用
# Modify.........: No.FUN-640240 06/05/16 By Echo 自動執行確認功能
# Modify.........: No.MOD-650063 06/05/22 By Nicola 直接付款問題:
#                                                   直接付款後未付欄位(apa35_uf)未重新計算
#                                                   執行確認 action 後原本已付金額被清空(apa35f)
# Modify.........: No.FUN-650068 06/05/23 By Smapmin 發票資料視窗多一個
# Modify.........: NO.MOD-650085 06/05/23 By Smapmin 修改變數定義
# Modify.........: No.FUN-630055 06/06/01 By rainy   apb另外開一個欄位apb31將專案代號由apb21中拉出來另外儲存
# Modify.........: No.MOD-650127 06/06/09 By Nicola aapt220的請款廠商可修改
# Modify.........: No.FUN-660122 06/06/16 By Hellen cl_err --> cl_err3
# Modify.........: No.FUN-660117 06/06/21 By Rainy Char改為 Like
# Modify.........: No.FUN-5C0106 06/06/22 By Rainy 將輸入順序改為稅別->稅率->發票號碼
# Modify.........: No.FUN-5C0023 06/06/22 By rainy 新增Action 費用分攤
# Modify.........: No.MOD-660093 06/06/22 By Smapmin 21類多判斷折讓類別為2
# Modify.........: No.MOD-660095 06/06/23 By Smapmin 沖帳金額做幣別取位
# Modify.........: No.MOD-660104 06/06/27 By Smapmin 修改依變動比率分攤的方式
# Modify.........: No.MOD-660111 06/06/28 By Smapmin aapt110 檢查多發票t110_invoice_chk 是否重複時,應該排除其 apk171 格式為'23''24'
# Modify.........: No.MOD-660132 06/06/30 By Smapmin 只有在11類時才會重算單頭差異金額
# Modify.........: No.MOD-660142 06/06/30 By Sarah 按"沖帳查詢"未出現其沖帳資料
# Modify.........: No.TQC-670008 06/07/04 By rainy 權限修正
# Modify.........: No.MOD-660086 06/07/05 By Sarah 查詢一筆未確認的單號後按新增再放棄,再按作廢,之前查詢的那筆會被作廢掉
# Modify.........: No.MOD-670016 06/07/05 By Smapmin 21類的作業不新增單頭的發票資料
# Modify.........: No.FUN-660216 06/07/10 By Rainy CALL cl_cmdrun()中的程式如果是"p"或"t"，則改成CALL cl_cmdrun_wait()
# Modify.........: No.MOD-670056 06/07/13 By Nicola g_apa.apa44 IS NOT NULL 改為 NOT cl_null(g_apa.apa44)
# Modify.........: No.FUN-670064 06/07/17 By kim GP3.5 利潤中心
# Modify.........: No.MOD-670075 06/07/17 By Smapmin 修改串接到aapr111的參數
# Modify.........: No.MOD-670131 06/07/28 By Smapmin 已沖暫估查詢action只有aapt110有使用,其他支皆需隱藏
# Modify.........: No.FUN-670060 06/07/28 By Rayven 新增"直接拋轉總帳"功能 
# Modify.........: No.FUN-680027 06/08/14 By wujie  多帳期修改
# Modify.........: No.FUN-680029 06/08/28 By wujie  兩套帳修改
# Modify.........: No.FUN-680110 06/09/05 By Sarah 增加aapt116,aapt260,畫面增加顯示rvv40(沖暫估否),apb01_unap(暫估帳款單號)
# Modify.........: No.FUN-690028 06/09/12 By flowld 欄位型態用LIKE定義
# Modify.........: No.FUN-690022 06/09/21 By jamie 判斷imaacti
# Modify.........: No.FUN-690024 06/09/21 By jamie 判斷pmcacti
# Modify.........: No.FUN-690025 06/09/21 By jamie 改判斷狀況碼pmc05
# Modify.........: No.FUN-690080 06/09/23 By ice 零用金管理
# Modify.........: No.FUN-680064 06/10/18 By johnray 在新增函數_a()中單身函數_b()前初始化g_rec_b
# Modify.........: No.CHI-6A0004 06/10/31 By bnlent g_azixx(本幣取位)與t_azixx(原幣取位)變數定義問題修改
# Modify.........: No.MOD-6A0073 06/11/01 By cl      修正衝待扺帳款時，本幣可為0的情況。
# Modify.........: No.FUN-690090 06/11/06 By Rayven 新增欄位apa992
# Modify.........: No.MOD-680012 06/11/15 By Smapmin aapt120單身確認後,不應再去update單頭金額
# Modify.........: No.MOD-680029 06/11/15 By Smapmin 沖帳時,DIFF本幣金額未依幣別取位
# Modify.........: No.MOD-680036 06/11/15 By Smapmin 除了非沖暫估且不直接付款外,其餘皆要insert into apf_file
# Modify.........: No.MOD-680082 06/11/15 By Smapmin 有直接沖帳金額存在時,不可以作廢
# Modify.........: No.MOD-690025 06/11/15 By Smapmin aapt120帳款單身要秀出入庫單號
# Modify.........: No.MOD-690134 06/11/15 By Smapmin aapt110單身料號品名不可輸入
# Modify.........: No.MOD-6A0025 06/11/15 By Smapmin 應將入庫與退貨一併產生到aapt110的單身
# Modify.........: No.MOD-6B0034 06/11/15 By Smapmin 費用分攤總金額為空
# Modify.........: No.MOD-6B0035 06/11/15 By Smapmin 離開多發票視窗後,INT_FLAG要還原
# Modify.........: No.MOD-6B0067 06/11/15 By Smapmin 修改分攤的原幣金額
# Modify.........: No.FUN-6A0016 06/11/15 By jamie 1.FUNCTION _q() 一開始應清空key值
#                                                  2.新增action"相關文件"
# Modify.........: No.FUN-690090 06/11/20 By cl    當apa992(集團代付單號)不為空才可取消審核
# Modify.........: No.FUN-680110 06/11/20 By Sarah "費用分攤"功能只有aapt120能用,其他程式須隱藏此Action
# Modify.........: No.TQC-6B0066 06/11/24 By wujie  多帳期二次修改
# Modify.........: No.FUN-6B0033 06/11/27 By hellen 新增單頭折疊功能
# Modify.........: No.MOD-6C0031 06/12/07 By Smapmin 預付款時,採購單位與數量應抓取計價單位與計價數量
# Modify.........: No.MOD-6B0156 06/12/07 By Smapmin aapq230沖帳查詢時也要能夠查到由aapt900做成本分攤的資料
# Modify.........: No.FUN-680003 06/12/07 By Smapmin 期初時,輸入aapt210的單身發票編號時,可不存在apk_file,改判斷是否存在amd_file
# Modify.........: No.MOD-6B0051 06/12/07 By Smapmin 折讓(t110_21_ins2)應判斷,'21'轉'23','28'轉'29','XX'轉'XX',其於轉'24'
# Modify.........: No.TQC-6B0118 06/12/07 By Smapmin 除了類別12,15,13,17不顯示apb21之外,其餘皆顯示apb21與apb31
# Modify.........: No.MOD-6B0088 06/12/07 By Smapmin aapt120輸入料號後,應可以自動帶入料件之會計科目
# Modify.........: No.MOD-6B0066 06/12/07 By Smapmin 稅額幣別取位問題
# Modify.........: No.MOD-6A0124 06/12/07 By Smapmin 折讓類別應可查詢
# Modify.........: No.TQC-6C0074 06/12/13 By douzh   aapt121作業還款銀行和還款異動碼開窗時check支付方式，銀行類別等信息 
# Modify.........: No.FUN-6C0037 06/12/18 By Smapmin 修改應稅內含金額計算方式
# Modify.........: No.MOD-6C0122 06/12/19 By Smapmin 已沖暫估之資料不可取消確認
# Modify.........: No.TQC-6C0044 06/12/22 By Smapmin 修改回寫待抵已付金額
# Modify.........: No.MOD-6C0164 06/12/26 By Smapmin 列印多發票資料
# Modify.........: No.MOD-710006 07/01/02 By Smapmin 待沖暫估金額有誤
# Modify.........: No.MOD-710040 07/01/05 By Smapmin 確認後不可再執行直接付款
# Modify.........: No.MOD-6C0178 07/01/11 By Smapmin 修改稅額計算方式
# Modify.........: No.MOD-720023 07/02/06 By Smapmin aapt120沖暫估,若帳款編號為DIFF則不需執行UPDATE aapt110的已付金額
# Modify.........: No.MOD-720062 07/02/08 By Smapmin 改變 g_sql,g_wc等定義為STRING
# Modify.........: No.MOD-720104 07/02/14 By Smapmin 作廢後不可再產生分錄
# Modify.........: No.TQC-720043 07/02/27 By Rayven 付款廠商輸入EMPL選取員工編號后不能帶出名稱
# Modify.........: No.TQC-720045 07/02/27 By Rayven aza46判斷錯誤
# Modify.........: No.TQC-710097 07/02/27 By Rayven AFTER FIELD apa31f稅前金額及稅額反推錯誤
# Modify.........: No.MOD-720064 07/02/28 By Smapmin 走防偽稅控且暫估時,不可輸入多發票
# Modify.........: No.TQC-6B0105 07/03/06 By carrier 連續兩次查詢,第二次查不到資料,做修改等操作會將當前筆停在上次查詢到的資料上
# Modify.........: No.TQC-730027 07/03/07 By Rayven aapt210大陸版使用aapr129,其他情況使用aapr220
# Modify.........: No.FUN-730032 07/03/22 By wujie   網銀功能相關修改，nme新增欄位
# Modify.........: No.MOD-730092 07/03/22 By Smapmin 單身輸入異常
# Modify.........: No.MOD-730141 07/03/30 By Smapmin s_chkdept已mark掉,之後的錯誤訊息判斷也要mark
# Modify.........: No.FUN-730064 07/04/04 By Lynn    會計科目加帳套
# Modify ........: No.TQC-740042 07/04/09 By johnray s_get_bookno和s_get_bookno1參數應先取出年份
# Modify ........: No.TQC-740030 07/04/10 By Rayven aapp115拋轉的帳款刪除后無法重新拋轉
# Modify.........: No.MOD-740030 07/04/11 By Smapmin 多角貿易拋轉至此,未產生傳票者仍可修改分錄
# Modify.........: No.TQC-740050 07/04/11 By Judy 單身品號未控管
# Modify.........: No.TQC-740067 07/04/13 By Rayven aapt110測試bug統一修改
# Modify.........: No.TQC-740080 07/04/13 By Rayven aap測試bug統一修改
# Modify.........: No.MOD-730098 07/04/16 By Smapmin 修改UPDATE apa_file 的錯誤訊息判斷
# Modify.........: No.TQC-740093 07/04/17 By Lynn    會計科目加帳套
# Modify.........: No.MOD-740057 07/04/19 By Smapmin 比照aapt330 insert/delete nme_file的做法
# Modify.........: No.TQC-740159 07/04/21 By wujie   子帳期每一期的原幣和本幣金額計算時應在計算完后再和應付原幣和本幣檢核一次，把尾差調至最后一筆子帳期上。現在沒有！
#                                                    按“多帳期維護”進去維護時，退出時必須檢核子帳期原幣合計和本幣合計是否與應付單頭的原幣應付和本幣應付一致，如不一致則繼續維護多帳期資料。
# Modify.........: No.TQC-740168 07/04/22 By Rayven aap-921報錯信息彈出顯示，以免被忽視
# Modify.........: No.TQC-740167 07/04/22 By Rayven 單身輸入金額后,系統會回寫單頭未稅金額欄位,但未計算稅額
# Modify.........: No.MOD-740070 07/04/22 By 原幣金額不可為0或null
# Modify.........: No.MOD-740346 07/04/23 By Rayven 不使用網銀時不去判斷是否未轉
# Modify.........: No.MOD-740369 07/04/24 By wujie  多帳期錯誤修改
# Modify.........: No.TQC-740281 07/04/24 By Echo 從ERP簽核時，「拋轉傳票」、「傳票拋轉還原」、「多帳期維護」、「費用分攤」action應隱藏
# Modify.........: No.TQC-740315 07/04/25 By Rayven 在應付單別設置為”自動拋轉總賬”時，撤銷審核時應把該單據從總帳拋轉還原的時間點前提到執行撤銷審核的作業前
# Modify.........: No.TQC-740314 07/04/26 By wujie 衝帳時衝帳金額與子帳期合計，已付金額的比較的修改
# Modify.........: No.MOD-750002 07/05/08 By Smapmin 修正MOD-610143
# Modify.........: No.MOD-750014 07/05/08 By Smapmin aapt210發票明細資料有誤
# Modify.........: No.CHI-750003 07/05/08 By kim aapt210,aapt260 單身 "報銷明細說明(apb33)" "員工編號(apb32)" 應隱藏!  ,未使用多帳別(aza63='N') 科目二應隱藏
# Modify.........: No.MOD-740500 07/05/09 By Jackho aapt121衝賬及分錄修正
# Modify.........: No.CHI-750011 07/05/09 By kim aapt260(暫估退貨) 應 hide "Restore Info"
# Modify.........: No.CHI-750015 07/05/11 By Smapmin 手動於aapt210新增一個折讓類別為2.退貨折讓時,確認時也要可以新增發票檔
# Modify.........: No.MOD-750056 07/05/14 By Smapmin 將q_apa3改為使用CONSTRUCT功能
# Modify.........: No.MOD-750050 07/05/14 By Smapmin 沖帳時,金額依幣別取位後再比較原幣金額與本幣金額是否有差異
# Modify.........: No.MOD-750048 07/05/14 By Smapmin 修正TQC-5C0093
# Modify.........: No.MOD-750064 07/05/15 By Smapmin 修改單身欄位名稱
# Modify.........: No.TQC-750041 07/05/16 By sherry  點日期修正，先彈到付款方式欄位上
# Modify.........: No.CHI-750020 07/05/17 By Smapmin aapt210單身發票編號空白否的控管與折讓類別3.一致
# Modify.........: No.TQC-750104 07/05/21 By rainy 採購單項次未檢查
# Modify.........: No.TQC-750121 07/05/21 By rainy 1.MISC發票 會檢查 amd-010 此類發票為10碼...    但 非MISC ,於apa08(發票號碼) 輸入確無相同處理!
#                                                  2.直接付款  轉帳時,卻仍需輸入子帳期項次  控制點應與 aapt330 付款單身處理一致"
#                                                  3.多借方維護時,科目設定部門管理(aag05='Y')未維護部門確可離開,所有欄位處理應檢查是否與s_fsgl一致!
#                                                  4.多借方維護時,執行 action ""分攤"" 出現 -284 error
#                                                  5.單身輸入 MISC1 確警告 aap-924
#                                                  6.多借方維護時ok, 再次維護多借方,卻未抓出先前維護資料! 
#                                                  7.分兩次成本分攤    ""費用分攤"" action 卻只可查出一筆 aapt900
# Modify.........: No.FUN-750051 07/05/22 By johnray 連續二次查詢key值時,若第二次查詢不到key值時,會顯示錯誤key值
# Modify.........: No.TQC-750139 07/05/23 By rainy 單身 ""原發票號碼"" 應可開窗查詢 apk_file在相同 稅別(apk11)下
#                                                  aapt151(員工借支) 若沖帳 程式 應call t110_k_2() 抓  待抵資料(apa00='25') 
# Modify.........: No.TQC-750140 07/05/23 By rainy aapt210/aapt220/aapt260 還款資料應隱藏，apa37f/apa37隱藏
# Modify.........: No.TQC-750140 07/05/24 By rainy aapt121沖帳時，待抵開窗資料應只能查出待抵借支款資料
# Modify.........: No.TQC-750129 07/05/24 By wujie 差異處理選留置時，未更新子帳期留置金額
# Modify.........: No.TQC-750177 07/05/25 By rainy 1.aapt210,aapt220 (折讓,DM) apa08是 ""參考號碼""不必check ""發票號碼""
#                                                  2.aapt121(報銷還款) ""直接付款"" 時   若選 8.借款待抵 應該只可查 aapq231(員工借支待抵資料)當 apa00='13' ,'17' 時,其它情況不可影響到 
# Modify.........: No.TQC-750181 07/05/28 By Rayven 暫估并且衝暫估時重復減了rvv23
# Modify.........: No.TQC-750244 07/05/30 By Smapmin 修改ora檔
# Modify.........: No.FUN-710078 07/05/30 By jamie 單頭及單身增加部門名稱及科目名稱
# Modify.........: No.MOD-750143 07/06/06 By Smapmin 將del nme_file放到foreach外,並判斷nme_file是否存在
# Modify.........: No.MOD-760089 07/06/22 By Smapmin 沖帳功能匯差計算方式要先將金額取位後再做相減
# Modify.........: No.MOD-770005 07/07/03 By Smapmin 已有產生折讓發票,不可取消確認
# Modify.........: No.MOD-770001 07/07/03 By Smapmin 刪除整張單據時,連apg/aph也要刪除
# Modify.........: No.TQC-770027 07/07/04 By Judy 單頭或單身金額有變動時對多帳期的處理
# Modify.........: No.TQC-770056 07/07/11 By chenl  1.若單頭項目編號為空，則單身項目費用代碼欄位不可輸入。
# Modify.........:                                  2.判別預算時，增加帳別條件。
# Modify.........:                                  3.科目抓取時增加帳套條件。
# Modify.........:                                  4.增加對入庫單及退貨單的控管。
# Modify.........: No.MOD-770041 07/07/18 By Smapmin 帳款幣別與採購單幣別不符時,要卡死
# Modify.........: No.MOD-770044 07/07/18 By Smapmin 單據無法作廢
# Modify.........: No.MOD-770066 07/07/18 By Smapmin 差異處理狀態為待處理時,不可執行確認
# Modify.........: No.MOD-770050 07/07/18 By Smapmin 大陸版必須將發票明細中的格式加以隱藏
# Modify.........: No.MOD-770081 07/07/19 By Smampin 修改產生折讓單後的相關卡關動作
# Modify.........: No.MOD-770121 07/07/26 By Smapmin 發票號碼不應影響申報格式
# Modify.........: No.MOD-770138 07/07/30 By Smapmin 發票字軌檢查
# Modify.........: No.MOD-780009 07/08/02 By Smapmin 只有付款類別為2*且折讓類別為'1'的,才會經由單身資料update發票資料
# Modify.........: No.MOD-780028 07/08/07 By wujie   eapc_file -->apc_file
# Modify.........: No.MOD-780042 07/08/08 By Smapmin AFTER INSERT 已經有 set rvv40 = 'Y',因此相對的 BEFORE DELETE 亦需增加此調整
# Modify.........: No.FUN-770043 07/08/17 By Smapmin 確認後仍需要看直接沖帳的資料
# Modify.........: No.MOD-780129 07/08/21 By kim 確認自動拋傳票後,單頭傳票號碼未顯示,須重新Q才會出來
# Modify.........: No.TQC-780065 07/08/22 By Smapmin 留置金額以原幣角度維護,故依原幣取位方式.
# Modify.........: No.MOD-780152 07/08/30 By wujie 多帳期留置功能修改
# Modify.........: No.MOD-780123 07/08/31 By wujie aapt121應付-已付=0時也不能還款
# Modify.........: No.MOD-780281 07/09/03 By Smapmin 差異處理選擇4.將單頭金額分攤到單身時,金額有誤
# Modify.........: No.MOD-780274 07/09/03 By Smapmin 沖暫估/直接付款新增到付款的類別應為11/16
# Modify.........: No.CHI-780046 07/09/10 By sherry  新增時，請款人員帶不到資料，把cpf_file換成gen_file
# Modify.........: NO.MOD-790042 07/09/17 By Smapmin 帳款日期與幣別有更改時,應同時update匯率與金額
# Modify.........: No.MOD-790086 07/09/17 By Smapmin 取消確認時判斷是否已有沖帳資料,應過濾apf00='11' AND apf00='16'
# Modify.........: No.MOD-790038 07/09/17 By Smapmin nme02指定貸方到期日;若無再指定為付款日
# Modify.........: No.MOD-790010 07/09/17 By Smapmin 當取消確認時,api26 為 DIFF 者,無須更新 apa_file 原始應付立帳
# Modify.........: No.MOD-790046 07/09/17 By Smapmin 修改請款單取消確認時,對請款折讓單的處理
#                                                    以apk_file的角度查詢請款折讓單
# Modify.........: No.MOD-790057 07/09/20 By Smapmin 21類帳款取消多發票功能
# Modify.........: No.TQC-790128 07/09/24 By Judy 直接付款資料已更改，未更新到子帳期
# Modify.........: No.TQC-790133 07/09/26 By Smapmin 將q_aag改為q_aag02
# Modify.........: No.MOD-790124 07/09/26 By Smapmin 輸入發票明細後回到主畫面,付款廠商說明就會變空白
# Modify.........: No.TQC-790158 07/09/27 By xufeng  大陸版時,從aapp111拋轉到aapp210的資料,審核時會報
#                                                    折讓發票金額大于原發票金額的錯誤
# Modify.........: No.TQC-790167 07/09/29 By Judy 單頭apa08為MISC時，執行多發金額調整后更新單頭，無法審核
# Modify.........: No.MOD-7A0006 07/10/04 By Dido aapp400 拋轉參數修改
# Modify.........: No.MOD-7A0015 07/10/05 By Smapmin 發票格式為XX時,發票編號可以不打
# Modify.........: No.MOD-7A0040 07/10/09 By Smapmin 雜項暫估流程應在aapt120執行
# Modify.........: No.MOD-7A0049 07/10/11 By Smapmin apc16留置金額未同步update 
# Modify.........: No.FUN-7B0024 07/10/12 By Sarah 當單頭的apa51是UNAP時，表示此單為沖暫估，單身才需要show沖暫估否與暫估帳款單號
# Modify.........: No.MOD-7A0069 07/10/15 By Sarah 當單身有沖暫估倉退時,沖暫估選項未打勾且暫估帳款單號未出現
# Modify.........: No.CHI-7A0030 07/10/16 By Smapmin 13類的多發票視窗,不能看到稅額攔位
# Modify.........: No.CHI-7A0024 07/10/16 By Smapmin 由於歐美客戶沒有發票機制,所使用的 invoice 是採廠商自行編碼原則,因此會有可能不同廠商會有相同之 invoice
#                                                    請增加若系統參數為歐美(aza26='1')時則採廠商+invoice檢核 invoice 是否重複的問題
# Modify.........: No.MOD-7A0082 07/10/18 By Smapmin 修改單頭金額時,未同步update多帳期金額
# Modify.........: No.TQC-7A0041 07/10/18 By Smapmin 留置金額無法輸入
# Modify.........: No.MOD-7A0116 07/10/22 By Smapmin 12類,除借方科目為UNAP外,其餘皆可更改請款廠商
# Modify.........: No.FUN-7A0050 07/10/23 By Sarah 1.aapt160增加可輸入"費用暫估"資料,此時單身"入庫單號","入庫項次"可不輸入,"料號"(apb12),"品名"(apb27)可輸入MISC
#                                                  2.aapt120單身增加輸入"暫估單號"(apb21),"暫估項次"(apb22),可空白,可開窗查aapt160費用暫估資料,並檢查是否為aapt160費用暫估資料
# Modify.........: No.MOD-7A0143 07/10/25 By Smapmin 修改變數定義大小
# Modify.........: No.MOD-7A0124 07/10/25 By Smapmin 整張單據刪除時,無法update rvb06
# Modify.........: No.TQC-7A0095 07/10/25 By chenl   1.原：當apa31>0時對apa51進行字段判斷，現：apa31>=0，進行判斷。
# Modify.........:                                   2.當apa00='15'時，即產生預付款時，不需要考慮多帳期的情況。
# Modify.........:                                   3.衝賬時，原先對原幣金額的判斷作mark處理
# Modify.........:                                   4.修正：當借方第二科目為"MISC"時，無法保存記錄的錯誤。
# Modify.........:                                   5.開啟多借方時，按不同帳套取科目名稱。
# Modify.........: No.CHI-7A0039 07/11/01 By Sarah 單身部門控管問題:
#                                                  1.不走多帳別時,此科目有做部門控管卻會被第二套帳的條件導致無法輸入
#                                                  2.若走多帳別時,若主財務帳有部門管理,另一帳別不做部門管理時,此欄位的就應不做部門管理
# Modify.........: No.FUN-7B0012 07/11/07 By Carrier db分隔符,call s_dbstring()處理
# Modify.........: No.MOD-7B0096 07/11/12 By Xufeng 付款條件為自定義的時候,沒有更新apc13字段的值,導致后續使用這個欄位時出現問題
# Modify.........: No.MOD-7B0033 07/11/12 By Smapmin 發票編號為空時,不可insert apk_file
# Modify.........: No.MOD-7B0009 07/11/12 By Xufeng  1.修正"當批次自動產生請款單時，單頭科目二的名稱都未被帶出顯示"
# Modify.........:                        By chenl   2.取消審核時，刪除直接付款資料。
# Modify.........: No.MOD-7B0091 07/11/13 By Smapmin aapt160不可有複製功能
# Modify.........: No.MOD-7B0101 07/11/13 By Smapmin 付款條件不可為NULL
# Modify.........: No.TQC-7B0051 07/11/13 By Smapmin 單別不產生分錄則不需執行傳票拋轉還原動作
# Modify.........: No.MOD-7B0128 07/11/13 By xufeng  發票非台灣版時不需要控制為10碼
# Modify.........: No.FUN-7B0055 07/11/14 By Carrier CALL _oox()時考慮多帳期
# Modify.........: No.TQC-7B0098 07/11/16 By Rayven copy的資料不能更改，upd apc報錯，應該是復制時未復制apc資料
# Modify.........: No.TQC-7B0063 07/11/16 By chenl   修正單價，數量，金額正負錯誤。
# Modify.........: No.TQC-7B0100 07/11/16 By wujie   有直接付款時，不能更改資料  
#                                                    付款方式為多帳期，作直接付款后審核，再取消審核時，單頭已付金額會把直接付款的金額還原，多帳期資料亦會如此。建議：取消審核，直接付款資料不做任何異動。
# Modify.........: No.TQC-7B0063 07/11/19 By chenl   修改單價金額的正負問題。
# Modify.........: No.TQC-7B0109 07/11/19 By Rayven 單身中無法錄入無收貨單的倉退單
# Modify.........: No.MOD-7B0159 07/11/20 By Smapmin 拋轉傳票時,user要帶g_apa.apauser
# Modify.........: No.TQC-7B0117 07/11/20 By Smapmin 已沖暫估查詢應由aapt110移至aapt160
# Modify.........: No.TQC-7B0122 07/11/21 By chenl   修改科目和科目二的查詢，現在查詢要求為，根據帳套，且屬于獨立科目或明細科目，科目性質為帳戶。
# Modify.........: No.TQC-7B0123 07/11/21 By wujie   做完直接付款后，再次進入直接付款，將剛才做的直接付款資料刪除，但是子帳期對應的金額沒有更新，apc10，apc11應該為0，apc13=apc09。
#                                                    取消審核后不應清除已付金額
# Modify.........: No.TQC-7B0083 07/11/22 By Carrier 1.單身字段rvv40改為apb34
#                                                    2.計算rvv23/rvv88邏輯(正常請款/立暫估/衝暫估)
#                                                    3.衝暫估時,入庫單年月可以和立帳年月不同
#                                                    4.衝暫估action功能修正
#                                                    5.判斷單身總額非負
# Modify.........: No.MOD-7C0020 07/12/05 By Smapmin 修改還款查詢視窗title/field name
# Modify.........: No.MOD-7B0258 07/12/05 By Smapmin 少了WHERE 條件
# Modify.........: No.MOD-7B0209 07/12/05 By Smapmin 改以cl_cmdrun_wait來執行aapp400
# Modify.........: No.TQC-7C0049 07/12/06 By Carrier 差異處理后,apa33有被重新計算,但是apa33f沒有做計算,造成兩者不一致
# Modify.........: No.TQC-7C0039 07/12/06 By Smapmin SQL語法錯誤
# Modify.........: No.MOD-7B0257 07/12/06 By Smapmin 若不使用多帳別功能時,科目二不可輸入
# Modify.........: No.MOD-7B0180 07/12/07 By Smapmin 單頭金額為0,自動計算單身合計金額到單頭,包含稅額的部份
#                                                    直接付款針對aapq230的已沖金額回寫部份,已於輸入直接付款資料時就回寫,不需再確認/取消確認段做
# Modify.........: No.MOD-7C0053 07/12/07 By Smapmin 多發票視窗依含稅的稅別自動計算金額
# Modify.........: No.TQC-7C0094 07/12/08 By chenl   1.對還款功能進行修正
# Modify.........:                                   2.增加未還金額的顯示.
# Modify.........:                                   3.衝賬時,對apc14,apc15進行更新.
# Modify.........:                                   4.修正TQC-7A0095，關于待扺帳款子帳期的錯誤，原：apa00=15時產生一筆，現為apa00=
# Modify.........: No.TQC-7C0134 07/12/12 By Rayven  去除還款按鈕
# Modify.........: No.TQC-7C0140 07/12/12 By carrier 期初衝暫估時,單身可能沒有資料,但應該也可以做審核
# Modify.........: No.MOD-7C0139 07/12/20 By Smapmin 確認時,aapt210折讓類別為2/3,單身發票編號不可空白
# Modify.........: No.MOD-7C0201 07/12/26 By Smapmin 傳至aapr111的參數有誤
# Modify.........: No.MOD-7C0203 07/12/27 By Smapmin 輸入付款廠商後,也要default匯率
# Modify.........: No.MOD-810013 08/01/07 By Smapmin 更改單頭匯率時,單頭本幣金額未同步更改
# Modify.........: No.MOD-810050 08/01/07 By Smapmin 已存在沖暫估資料時,借方科目不可更改(一定要為UNAP)
# Modify.........: No.MOD-810064 08/01/09 By Sarah   aapt220新增單據出現更新到應付系統多帳期明細檔(apc_file)的失敗錯誤訊息
# Modify.........: No.TQC-810047 08/01/15 By carrier 期初衝暫估時,單身可能沒有資料,但應該也可以做審核
# Modify.........: No.MOD-810111 08/01/16 By Smapmin 檢查輸入之沖帳帳款編號+子帳期是否已有沖帳記錄時應該使用apv[i].apv03之帳款編號,而不是使用g_apa.apa01之帳款編號
# Modify.........: No.MOD-810104 08/01/16 By Smapmin 新增時,單頭金額為0,由單身update單頭金額時,多帳期資料未update 
# Modify.........: No.FUN-810046 08/01/15 By Johnray 增加串查段
# Modify.........: No.MOD-810156 08/01/21 By Smapmin 未設定多帳期時,多帳期資料應自動Insert 
# Modify.........: No.MOD-810168 08/01/21 By Smapmin 改善SQL語法,增加效率
# Modify.........: No.MOD-810244 08/01/31 By Smapmin 由於可以部份沖暫估,故將MOD-810050的功能拿掉
# Modify.........: No.MOD-810242 08/01/31 By Smapmin 借方科目為NULL,不應insert api_file
# Modify.........: No.MOD-810207 08/01/31 By Smapmin 多借方資料存在時,不可改變為MISC的借方科目,必須先將多借方資料刪除
# Modify.........: No.TQC-810091 08/01/31 By chenl   對api05,api05f進行截位。
# Modify.........: No.FUN-810045 08/01/31 By rainy   項目管理，單身子劃面aapt110_5取消,新增項目編號(apb35)WBS編號(apb36)費用原因(apb31)預算編號(apb30)
# Modify.........: No.MOD-830040 08/03/06 By Smapmin 以s_ahe_qry取代q_aee
# Modify.........: No.TQC-830007 08/03/07 By claire 中斷點的AR應允許可以取消確認
# Modify.........: No.MOD-830018 08/03/07 By Smapmin 傳票編號顯示有誤
# Modify.........: No.MOD-820103 08/03/07 By Smapmin 原幣本幣金額相反
# Modify.........: No.CHI-810018 08/03/07 By Smapmin 票據系統立帳資料不可取消確認
# Modify.........: No.MOD-830075 08/03/10 By Smapmin 多發票視窗的匯率修改後,應自動計算本幣金額
# Modify.........: No.MOD-830059 08/03/11 By Smapmin 直接付款insert into apg_file 的動作移到update apc_file當下再處理
# Modify.........: No.MOD-830089 08/03/12 By Smapmin 修正FUN-680027
# Modify.........: No.MOD-820129 08/03/12 By Smapmin 為暫估帳款不能進行沖帳
# Modify.........: No.MOD-820002 08/03/12 By Smapmin 僅抓取同一付款廠商的資料
# Modify.........: No.MOD-820050 08/03/12 By Smapmin 費用類暫估(16)也要可以做費用分攤
# Modify.........: No.MOD-820008 08/03/17 By Smapmin 修改待抵沖帳時,回寫單身應付帳款單號所屬的金額
# Modify.........: No.MOD-830121 08/03/18 By Smapmin 退貨折讓更改單頭金額時,不可影響發票金額
# Modify.........: No.CHI-820015 08/03/19 By Smapmin 修正沖帳後多帳期金額update部份
# Modify.........: No.MOD-810269 08/03/19 By Smapmin 取消FUN-6C0037所修改的程式段(含稅時未稅金額自動計算)
# Modify.........: No.MOD-830213 08/03/27 By Smapmin 調整多發票金額時,若有update單頭金額,則應重算差異的金額
# Modify.........: No.MOD-830234 08/03/31 By Smapmin 沖帳資料中,DIFF的資料不需update apa_file的資料
# Modify.........: No.FUN-830091 08/03/31 By Smapmin 增加多角分錄底稿
# Modify.........: No.FUN-830161 08/03/31 By Carrier 去掉預算編號apb30/api25/apa71
# Modify.........: No.MOD-830244 08/04/01 By Smapmin 複製時,apc的欄位應依照apa的欄位給預設值
# Modify.........: No.MOD-840040 08/04/07 By Smapmin 單據已確認,多借方視窗按X無法離開
# Modify.........: No.MOD-840046 08/04/09 By chenl   對apk_file金額字段檢查并增加取位處理。
# Modify.........: No.MOD-840087 08/04/14 By Smapmin 執行沖帳後仍要可以開多帳期的窗
# Modify.........: No.MOD-840079 08/04/14 By Smapmin 輸入多發票時,未同步處理apa57的變數
# Modify.........: No.MOD-840119 08/04/15 By Smapmin 單身科目為空時,部門也不可以輸入
# Modify.........: No.MOD-840134 08/04/17 By Smapmin 修正MOD-830213
# Modify.........: No.MOD-840203 08/04/20 By Dido    產生至 aapq230 時 apa54 與 aapt150 一致
# Modify.........: No.MOD-840531 08/04/22 By hellen  增加功能：差異處理后詢問分錄底稿是否重新產生
# Modify.........: No.MOD-840535 08/04/23 By Smapmin aapt150單身可不打採購單
# Modify.........: No.MOD-840611 08/04/23 By Carrier 單別不做預算時,費用代號應該可以為空白
# Modify.........: No.CHI-840046 08/04/23 By Smapmin 修正MOD-840119
# Modify.........: No.MOD-840179 08/04/23 By hellen  單身采購單號改成開窗q_pmm9,選出與單頭請款廠商及幣別一致的資料
# Modify.........: No.MOD-840381 08/04/24 By Carrier 取消審核時,檢查暫估單是否已在api_file(衝暫估單)中存在
# Modify.........: No.MOD-840385 08/04/24 By Carrier 審核時,檢查api_file中的衝暫估資料是否被取消審核了,若是,則不得做資料審核
# Modify.........: No.MOD-840449 08/04/24 By douzh 1. 若單身入庫單/項次尚未確認或找不到資料，不應show aap-316錯誤訊息。
# Modify.........:                                    應提示該單據尚未確認或是無此筆資料，不應show入庫年月與立帳年月不同，易誤導user
# Modify.........:                                    因為立帳年月跟null比，當然是不一致。
# Modify.........:                                 2. 若單身費用原因空白且不做專案管理時，費用原因應提示必填，非(aap-301) 無此專案+費用代號的資料,請查核..!
# Modify.........: NO.FUN-840132 08/04/24 By lilingyu aapt210 aapt220列印時增加一個選擇串aapr111的憑証報表
# Modify.........: No.MOD-840649 08/04/24 By Smapmin 抓取會科資料時,要加上帳別條件
# Modify.........: No.MOD-840668 08/04/28 By Smapmin 輸入完多發票後,若無差異金額,將差異狀態更改為'0'
# Modify.........: No.MOD-840701 08/04/30 By Smapmin 入庫單+項次對應到的收貨單+項次,若未補登發票,不可輸入於aapt110單身
# Modify.........: No.TQC-850001 08/05/01 By Carrier 追單 CHI-840018
# Modify.........: No.FUN-850038 08/05/19 By TSD.lucasyeh 自定欄位功能修改
# Modify.........: No.MOD-850206 08/05/20 By Smapmin 取消MOD-840701
# Modify.........: No.MOD-850155 08/05/20 By Smapmin 抓取沖帳金額應加上api02='2'的條件 
# Modify.........: No.CHI-840021 08/05/20 By Smapmin 沖帳時,若全額沖銷,將自行調整本幣未稅金額的差異也視為匯差
# Modify.........: No.MOD-840632 08/05/21 By Smapmin 修改本幣金額計算方式
# Modify.........: No.MOD-850081 08/05/23 By Sarah 沖暫估話畫面單頭的金額不需扣到折讓金額(apa60,apa60f)
# Modify.........: No.MOD-850114 08/05/15 By Sarah aapt210單身輸入發票(apb11)時,需檢核apa00=1*的apk_file對應的帳款已確認才可輸入
# Modify.........: No.MOD-850100 08/05/23 By Sarah 檢核借方科目(apa51)若有預算控管時(aag21='Y'),須提示卡關請輸入在單身的訊息
# Modify.........: No.FUN-850027 08/05/23 By douzh WBS編碼錄入時要求時尾階并且為成本對象的WBS編碼
# Modify.........: No.MOD-850205 08/05/26 By Sarah 錯誤訊息aap-779抓取條件WHERE apc01=g_apa.apa01改為WHERE apc01=g_apv[i].apv03
# Modify.........: No.MOD-850245 08/05/26 By Sarah 將t110_r()裡,刪除aph_file段落搬到t110_r_cur3之後,因為t110_r_cur3會去抓aph_file
# Modify.........: No.MOD-850251 08/06/06 By Sarah t110_apb22_11(),判斷當執行aapt160時,rvv87-rvv88<=0表示此入庫單+項次已立暫估,不可重覆輸入
# Modify.........: No.MOD-850268 08/06/06 By Sarah t110_ins_nme_1(),有段依單身產生nme_file,修正為只產生一筆nme_file
# Modify.........: No.CHI-850032 08/06/06 By Sarah 在確認段寫入apk_file前,先檢核apk_file是否存在,若是則先刪除再新增
# Modify.........: No.MOD-850283 08/06/06 By Sarah 當輸入的稅別類型是運輸發票(T)時,在多發票頁籤中計算出來的稅額(apk07f,apk07)是錯的
# Modify.........: No.MOD-850301 08/06/06 By Sarah 回寫待抵帳款的已付金額的時機,改於確認段再回寫
# Modify.........: No.MOD-850316 08/06/06 By Sarah aapt210單身apb21改為"退貨單號/費用類暫估單號",當單頭折讓類別為3時,apb21開放輸入aapt260的暫估單號
# Modify.........: No.MOD-850302 08/06/06 By Sarah 1.aapt160若有入庫單號時,單身金額不可修改(apz16='N'=>除apb25會計科目、apb251會計科目二、apb26部門可改外,其餘皆不可修改,apz16='Y',維持原控制)
#                                                  2.aapt110單身輸入沖暫估時,金額直接抓取
# Modify.........: No.MOD-850320 08/06/06 By Sarah t110_21_ins2()段,增加l_apa.apa171 WHEN '23' LET toapk.apk171 = '23'
# Modify.........: No.CHI-850025 08/06/07 By Sarah 當匯率為1時,需檢核原幣與本幣的稅額、金額需相同
# Modify.........: No.MOD-860075 08/06/10 By Carrier 直接拋轉總帳時，aba07(來源單號)沒有取得值
# Modify.........: No.TQC-860021 08/06/10 By Sarah INPUT,PROMPT,MENU段漏了ON IDLE控制
# Modify.........: No.MOD-860148 08/06/16 By Sarah aapt110若更改時,單身無資料應可開放apa05(請款廠商)調整
# Modify.........: No.FUN-850027 08/06/18 By douzh 計算并檢核預算耗用時考慮是以部門還是以營運中心傳入計算耗用
# Modify.........: No.MOD-860179 08/06/26 By Sarah 增加判斷,若l_apa.apa171為25時,toapk.apk171應為23
# Modify.........: No.MOD-860203 08/06/27 By Sarah apa11計算apa12,apa64段,增加計算apa00 = 21,22,26類別
# Modify.........: No.MOD-860245 08/06/27 By Sarah FUNCTION t110_apc_check寫入apg_file段取消,因為後續確認段會再寫一次
# Modify.........: No.MOD-860221 08/06/27 By Sarah apb10應統一為apb24*apa14
# Modify.........: No.MOD-860251 08/06/27 By Sarah 匯率改變時,需重新計算沖帳視窗中的匯差
# Modify.........: No.MOD-860267 08/07/01 By Sarah t110_firm1_c_apv,t110_firm2_c_apv增加過濾條件apv03!='DIFF'
# Modify.........: No.MOD-860272 08/07/02 By Sarah 抓apf_file資料的SQL出現了AND aph04=g_apv[i].apv05條件,需改為AND apv05=g_apv[i].apv05
# Modify.........: No.FUN-860004 08/07/02 By xiaofeizhu aapt160 增加復制功能(只復制abp21為空的單身)
# Modify.........: No.MOD-870011 08/07/08 By Sarah 沖暫估做DIFF時，金額合計不等同此筆帳款金額時，卻仍可存檔
# Modify.........: No.MOD-870022 08/07/08 By Sarah 稅別格式若為22時,提示警訊即可,不控卡
# Modify.........: No.MOD-870029 08/07/08 By Sarah 多發票時,增加更新apkacti='Y',apkgrup=g_grup,apkuser=g_user,apkdate=g_today
# Modify.........: No.MOD-860303 08/07/08 By Sarah 單身若有採購單時,單頭金額不可大於單身金額
# Modify.........: No.MOD-860332 08/07/09 By Sarah 當使用大陸版且apa08='UNAP'時,不可執行待抵沖帳(offset_contra)action
# Modify.........: No.MOD-870109 08/07/11 By Sarah 單身無入庫單時,無須更新rvv_file
# Modify.........: No.MOD-830006 08/07/16 By jan   增加暫估資料金額的取位處理。
# Modify.........: No.MOD-870194 08/07/16 By Smapmin ora檔未轉換到
# Modify.........: No.MOD-870215 08/07/22 By Sarah 無單身時(期初暫估)應可修改單頭未稅金額
# Modify.........: No.MOD-870264 08/07/22 By Sarah mfg-043訊息前,增加判斷輸入的發票號碼是否存在amdi100且已確認,若沒有才顯示mfg-043
# Modify.........: No.FUN-860107 08/07/24 By sherry 當其單據性質之【傳票單別】非空白者,即可有ACTION 【拋轉總帳】及【傳票拋轉還原】功能
# Modify.........: No.TQC-870040 08/07/29 By chenyu g_ape數組超過48行時程序會出錯，現將數組改成DYNAMIC ARRAY
# Modify.........: No.MOD-870232 08/07/29 By Sarah 當發票格式為'XX'(不申報)時,統一編號可無須輸入
# Modify.........: No.MOD-880017 08/08/05 By Sarah 還原MOD-790038所改,l_nme.nme02還是帶入m_apa.apa02
# Modify.........: No.CHI-880003 08/08/06 By Sarah 抓azr_file的地方改抓azp_file
# Modify.........: No.MOD-880041 08/08/06 By Sarah CHI-850025只判斷匯率=1就檢核,增加判斷幣別也等於aza17才檢核
# Modify.........: No.MOD-880044 08/08/08 By Sarah 修改MOD-870232,判斷式改為IF g_apa.apa06='MISC' AND g_apk[i].apk171!='XX' THEN
# Modify.........: No.MOD-880101 08/08/13 By Sarah aapq230,aapq240查詢時,不需過濾傳票編號欄位(apa44)
# Modify.........: No.MOD-880103 08/08/18 By Sarah 當apa08不為MISC且apa06為MISC時,維護完apl_file資料後請回寫apa07
# Modify.........: No.MOD-880080 08/08/18 By Sarah 1.若為直接付款,應可修改非金額欄位
#                                                  2.直接付款先不更新apa35f,apa35,於確認後再更新
#                                                  3.將之前MOD-860245所MARK掉部分還原
# Modify.........: No.MOD-880144 08/08/22 By Sarah 檢查aap-779訊息,改用SUM(apc10)與apv04f比較,SUM(apc11)與apv04比較
# Modify.........: No.MOD-880181 08/08/22 By Sarah aapt210判斷單身有輸入暫估單(apb21)時才需檢核aapt260的資料
# Modify.........: No.MOD-880173 08/08/22 By Sarah 申報格式28時,統一編碼不應卡一定要輸入
# Modify.........: No.MOD-880146 08/08/26 By Sarah aapt121輸入多發票後,不管選擇何稅別,都不計算稅額(apk07/apk07f)
# Modify.........: No.MOD-880222 08/08/27 By Sarah 1.直接付款應在未確認時更新apa_file,MOD-880080增加之確認段更新apa35,apa35f做法需mark
#                                                  2.修正MOD-880017,l_nme.nme02應帶入m_apa.apa12
# Modify.........: No.FUN-880095 08/08/28 By xiaofeizhu apmq520呼叫aapt150時查詢單身是否有存在此張采購單號有存在時自動帶出
# Modify.........: No.FUN-880094 08/08/28 By sherry AP加參數 : 預付金額是否與采購單勾稽[1/2/3]Yes/No/依廠商
# Modify.........: No.MOD-880212 08/09/09 By Sarah 沖暫估視窗內的立帳本幣金額若已有重評價應取api05*apa72金額
# Modify.........: No.MOD-880231 08/09/09 By Sarah 沖帳資料依全額比較,sum相關沖帳金額與apc08,apc09比較,沖帳金額若大於時則提示錯誤訊息
# Modify.........: No.TQC-890010 08/09/09 By Sarah 由於沖暫估與直接付款不可同時做,故確認段CALL t110_ins_apg()段,只需處理UNAP的部分,t110_ins_apg()段l_apg.apg02給值方式還原成原作法
# Modify.........: No.MOD-890038 08/09/09 By Sarah 取消AFTER FIELD api26 DIFF多筆檢核判斷,但仍須控管帳款金額與沖暫估金額合計值需一致問題
# Modify.........: No.MOD-890084 08/09/09 By Sarah 沖暫估視窗在做科目允許/不允許部門的檢查時,應以api07,而非單頭的apa22
# Modify.........: No.MOD-890007 08/09/01 By chenl 若有衝暫估資料，則不可直接付款。
# Modify.........: No.MOD-890177 08/09/24 By Sarah aapt110若單身空白時需進入差異處理
# Modify.........: No.MOD-890227 08/09/25 By chenl 將MOD-860303功能切分成僅限台灣地區版本，大陸版本不使用該功能。
# Modify.........: No.MOD-890220 08/10/01 By Sarah 多借方視窗增加檢核,api04,api041(aza63='Y'時)不可為空值
# Modify.........: No.MOD-890281 08/10/01 By Sarah t110_ccc()與t110_ppp()段,檢查單號是否為NULL改寫成cl_null(s_get_serial_no(g_apa.apa01))
# Modify.........: No.MOD-890282 08/10/01 By Sarah aapt120單身apb21開窗的資料,應過濾單頭的付款廠商
# Modify.........: No.MOD-890213 08/10/01 By Sarah t110_chk()檢查只適用於台灣版,非台灣版就直接回傳1
# Modify.........: No.MOD-8A0004 08/10/01 By Smapmin 直接付款產生付款單單頭資料時,金額應抓取已沖金額
# Modify.........: No.MOD-8A0016 08/10/03 By Sarah 當借方科目二不是設定MISC時,在輸入部門時不需檢核api041不可為NULL
# Modify.........: NO.FUN-870037 08/10/06 by yiting  add nme26
# Modify.........: NO.FUN-890128 08/10/06 By Vicky 確認段_chk()與異動資料_upd()若只需顯示提示訊息不可用cl_err()寫法,應改為cl_getmsg()
# Modify.........: No.MOD-8A0051 08/10/06 By clover 單身輸入採溝單時,採購單項次只可為"2.轉成採購單"
# Modify.........: No.MOD-8A0079 08/10/08 By clover 修改本幣之後,不再回推原幣
# Modify.........: No.MOD-8A0129 08/10/16 By Sarah 確認時,判斷aap-030的判斷式不需扣除折讓金額(apa60)
# Modify.........: No.MOD-8A0139 08/10/17 By Sarah q_pmm902回傳值增加apb07
# Modify.........: No.MOD-8A0177 08/10/20 By Sarah 4933行判斷式增加()
# Modify.........: No.MOD-8A0188 08/10/21 By Sarah inv_no欄位開窗CALL q_apk02,需傳入g_qryparam.arg1 = g_apa.apa01,default1應為g_apa.apa08
# Modify.........: No.MOD-8A0220 08/10/24 By chenl 帶出對衝暫估金額時，應判斷該暫估單尚有余額是否滿足所要對衝的金額。
# Modify.........: No.TQC-860014 08/08/08 By chenl 1.增加手動分攤差異金額功能。
# Modify.........:                                 2.若無帳款單號，則不可使用差異處理功能按鈕。
# Modify.........: No.MOD-8A0212 08/10/29 By Sarah 檢核單別之apydmy3是否為'N',若為'N'才需要show_ref_c3帶出aapt330的傳票資料
# Modify.........: No.MOD-8A0213 08/10/29 By Sarah 若稅別為為不申報(gec05='X')時,無須檢核sub-005訊息
# Modify.........: No.FUN-8A0108 08/10/29 By xiaofeizhu aapq720呼叫aapt210時，管控某些action不顯示
# Modify.........: No.MOD-8A0266 08/10/30 By Sarah 當稅率改變時,若有發票資料需逐筆更新稅額與含稅金額
# Modify.........: No.FUN-8A0075 08/10/30 By jan   apa63 = 'S'，可再修改以下指定 位：
#                                                  單頭：apa51、apa511，apa54、apa541，apa52、apa521
#                                                  單身：apb26，apb25,apb251,apb27 
#                                                  可執行以下function:多發票，衝帳，衝暫估，直接付款，分錄底稿產生，分錄底稿
# Modify.........: No.MOD-8B0090 08/11/07 By chenl 直接付款退出時，應判斷單據是否已審核，若未審核再更新分錄底稿。
# Modify.........: No.MOD-8B0034 08/11/10 By Sarah aapt160也要增加判斷aap-328訊息
# Modify.........: No.TQC-8A0079 08/11/11 By Sarah 單價含稅時,含稅金額=含稅單價*計價數量
#                                                             未稅金額=含稅金額/(1+稅額)/100
#                                                  單價未稅時,未稅金額=未稅單價*計價數量
#                                                             含稅金額=未稅金額*(1+稅額)/100
# Modify.........: No.MOD-8B0149 08/11/14 By Sarah api05計算邏輯改為api05=api05f*apa14                                      
# Modify.........: No.MOD-8B0164 08/11/20 By Sarah MOD-8A0212微調,當l_apydmy3!='N'時,LET g_apa.apa44=f_apa.apa44
# Modify.........: No.MOD-8B0170 08/11/20 By Sarah aapt210應同進貨發票,開放可以修改單頭稅額,且彈性2元差異
# Modify.........: No.MOD-8B0183 08/11/20 By Sarah 若此帳款為直接付款時,無須執行FOREACH zp_curs1,直接抓取apf_file,apg_file資料
# Modify.........: No.MOD-8B0224 08/11/21 By Sarah 若帳款類別為21,22,23,25時,無須執行FOREACH zp_curs2,直接抓取apf_file,apg_file資料
# Modify.........: No.MOD-8B0231 08/11/21 By wujie aapt150產生aapq230資料時借貸科目抓反了
# Modify.........: No.CHI-890017 08/11/24 By Sarah 回寫apa35時也需一併回寫apa73=apa34-apa35+g_net
# Modify.........: No.MOD-8B0266 08/11/25 By Sarah aapt150單身原幣單價、原幣金額欄位需做取位
# Modify.........: No.CHI-8B0055 08/11/27 By claire 取消確認時不需判斷來源單據pmm906='Y',因有可能是代採買
# Modify.........: No.MOD-8C0005 08/12/03 By sherry 在aapt210里面對折讓性質是‘2退貨折讓’的退貨立賬單應該需要檢查立賬日期apa02和單據日期rvv09是否在相同年月
# Modify.........: No.MOD-8C0009 08/12/03 By Sarah t110_show()段除了21,22類要顯示apa58外,26類也需顯示
# Modify.........: No.MOD-8C0016 08/12/03 By Sarah 沖暫估的本幣金額(api05),應以原幣金額(api05f)*暫估立帳匯率,若分次沖暫估,最後一次的本幣金額應以倒扣方式計算
# Modify.........: No.MOD-8C0020 08/12/04 By sherry 在aapt160里面立暫估的時候，金額與入庫單的金額不一致
# Modify.........: No.CHI-8C0005 08/12/09 By Sarah 當使用利潤中心時(aaz90=Y),CALL s_chkdept()允許/拒絕部門的判斷請改用成本中心
# Modify.........: No.MOD-8C0011 08/12/09 By Sarah 原先沖帳已輸入待抵帳款A01,單身修改為待抵帳款A02,卻沒將A01的已衝金額扣回
# Modify.........: No.MOD-8C0082 08/12/12 By Sarah t110_k()與t110_k_2()段對apc_file的寫入應一致
# Modify.........: No.MOD-8C0067 08/12/15 By Sarah 單據確認後,不會回寫到aapt160的已付金額(差異處理:5:沖期初開帳的暫估)
# Modify.........: No.TQC-8C0031 08/12/16 By sherry 由於共用問題判斷稅別問題,請增加 apb06 <> '' 時才需要抓取 pmm_file 
# Modify.........: No.MOD-8C0221 08/12/23 By Sarah t110_diff_rtn()段需判斷apydmy3='Y'才問axr-309
# Modify.........: No.MOD-8C0224 08/12/23 By Sarah t110_set_no_entry_b()段,將CALL cl_set_comp_entry("apb12,apb27,apb09,apb28,apb25,apb251,apb26",FALSE)這行mark掉
# Modify.........: No.MOD-8C0272 08/12/26 By clover 改 IF g_smy.smy59 <> 'Y' =>IF cl_null(g_smy.smy59) or g_smy.smy59 = 'N'  
# Modify.........: No.FUN-8C0106 09/01/05 By jamie 依參數控管,檢查會科/部門/成本中心 AFTER FIELD 
# Modify.........: No.MOD-910014 09/01/05 By Nicola 數量為0 時，api05/api05f直接帶暫估金額
# Modify.........: No.MOD-910044 09/01/06 By Nicola 加上cl_null的判斷
# Modify.........: No.MOD-910021 09/01/08 By chenl  t110_bud()抓取apy檔。
# Modify.........: No.MOD-910020 09/01/08 By chenl 增加SQL條件,apg03=g_plant.
# Modify.........: No.TQC-8C0076 09/01/09 By clover mark #ATTRIBUTE(YELLOW)
# Modify.........: No.MOD-910094 09/01/09 By Nicola AFTER FIELD apb09 的 IF l_gec07='Y' THEN 修改為 IF l_gec07='Y' AND (g_aptype = '11' OR g_aptype = '16' ) THEN
# Modify.........: No.MOD-910069 09/01/09 By Nicola AFTER FIELD api05f 計算 l_apa34f 並未分辨若為 aapt260 的暫估(apa00 = '26')應需在 * -1
# Modify.........: No.MOD-910086 09/01/12 By wujie 更改單身入庫單時，檢查rvv87-rvv23-rvv88 >0
# Modify.........: No.MOD-910098 09/01/13 By Sarah t110_apb22_21()段,應增加判斷g_aptype='26'
# Modify.........: No.MOD-910109 09/01/13 By Sarah 單身的成本中心需不需要輸入的檢查點,應與部門一致
# Modify.........: No.FUN-880113 09/01/15 By jan 如為多帳期才能維護"多帳期"功能鍵帶出畫面的資料，否則只能DISPLAY 不能MODIFY
# Modify.........: No.MOD-910161 09/01/15 By Sarah aapt150單身帶入採購單資料時，並未帶出專案編號欄位
# Modify.........: No.MOD-910170 09/01/15 By Sarah 將aap-344判斷段取消
# Modify.........: No.MOD-910181 09/01/16 By Sarah aapt160存檔後,再變更幣別時,本幣金額會全為零,原幣稅額也會為零
# Modify.........: No.MOD-910062 09/01/20 By Nicola 倉退單 數量若為 0 時不需要與已請款數量比較
# Modify.........: No.MOD-910197 09/01/22 By Sarah 將t110_r()段INSERT azo_file移到COMMIT前
# Modify.........: No.MOD-910249 09/01/22 By Sarah 新增時不需default傳票日期(apa43)
# Modify.........: No.MOD-920013 09/02/02 By sherry 如果單價含稅，算未稅單價時先取位再除于稅率 
# Modify.........: No.MOD-920034 09/02/03 By Sarah 當pmb05為NULL時default值應給予100
# Modify.........: No.MOD-920052 09/02/03 By wujie 判斷a56！=0時才會在差異處理后詢問是否產生分錄底稿
# Modify.........: No.MOD-920102 09/02/07 By Sarah 按"直接付款"時,當單據確認碼不為Y時,CALL t110_apc_check需傳w,確認碼為Y時傳''
# Modify.........: No.FUN-920077 09/02/10 By sabrina 當aaps100參數設定為apz59='N'時，
#                                                    單身b25、b26、apb930、gem02c、apb21、apb22的欄位名稱要能正常的顯示
# Modify.........: No.MOD-920170 09/02/16 By Sarah 當執行aapt150時,單身科目apb25應default成單頭的借方科目,當單頭借方科目為NULL時,應開放單身科目輸入
# Modify.........: No.MOD-920182 09/02/16 By Smapmin 維護完多發票金額後,詢問是否重新產生分錄
# Modify.........: No.MOD-920252 09/02/20 By Sarah rvv87-rvv23<=0才卡aap-782訊息
# Modify.........: No.MOD-920352 09/02/26 By Sarah FUNCTION t110_b()段結束前,CALL t110_sum_apa()這行拿掉
# Modify.........: No.MOD-920359 09/02/26 By Smapmin 傳票編號顯示有誤
# Modify.........: No.MOD-920381 09/03/02 By Sarah 當刪除單身沖暫估資料時,應一併刪除api_file資料
# Modify.........: No.MOD-920382 09/03/02 By Sarah 為避免誤按沖暫估視窗維護,增加判斷,若無單身資料時,不可開啟沖暫估視窗
# Modify.........: No.CHI-930001 09/03/04 By Sarah 差異處理選擇5.沖期初開帳暫估時,不論單頭借方科目是否為UNAP、單身是否有資料,只要有差異都應可選則開帳暫估資料
# Modify.........: No.CHI-930014 09/03/05 By Sarah 取消MOD-860203增加計算21,22,26類的apa12,apa64功能
# Modify.........: No.MOD-930072 09/03/06 By shiwuying 沖暫估單身不應納入一起分攤
# Modify.........: No.MOD-930074 09/03/09 By shiwuying 預付總額不能大於單身之含稅金額，而不是未稅金額
# Modify.........: No.MOD-930030 09/03/10 By Sarah 當暫估數量已全數沖完時,api05f金額直接default暫估的金額
# Modify.........: No.TQC-930073 09/03/11 By chenl aapt160/aapt260稅種開窗只顯示不申報的稅種.
# Modify.........: No.MOD-930169 09/03/19 By Sarah t110_api_unap()計算api05時應比照t110_ppp(),應抓取暫估單aapt160的重評價匯率apa72來計算
# Modify.........: No.FUN-920186 09/03/20 By lala  理由碼apb31必須為費用原因
# Modify.........: No.MOD-930245 09/03/30 By Sarah 預付請款檢查時採購單單價*計價數量所計算出來的金額未依幣別取位
# Modify.........: No.MOD-930266 09/03/25 By chenl 匯率*原幣應取小數位后再與本幣進行比較。
# Modify.........: No.MOD-940008 09/04/03 By Sarah p_zz有勾選可修改key,aapt110修改完單據編號,存檔失敗
# Modify.........: No.MOD-940069 09/03/07 By lilingyu 當是否直接拋磚總帳='Y'時,才可調用s_chknpq 
# Modify.........: No.MOD-940079 09/03/07 By lilingyu 確認時,aapt210折讓類別為2/3,單身發票編號不可空白,如單頭稅別apa15的發票聯數='X',不需檢查
# Modify.........: No.MOD-940090 09/04/08 By lilingyu 未異動apc13
# Modify.........: No.MOD-940158 09/04/11 By Sarah t110_copy()段,當aapt160複製時,不需清空apa08 
# Modify.........: No.MOD-940178 09/04/13 By Sarah FUNCTION t110_b()結束後,CALL t110_ddd1()重寫apk_file
# Modify.........: No.MOD-940213 09/04/15 By lilingyu 將MOD-8B0183的修改段增加條件apz26
# Modify.........: No.CHI-940018 09/04/15 By lilingyu 修改多輸入發票資料時,單身寫法改成逐筆存入資料庫
# Modify.........: No.MOD-940223 09/04/15 By lilingyu 將TQC-630164這張單修改要回寫apa07段mark掉
# Modify.........: No.MOD-940239 09/04/21 By lilingyu 單頭匯率調整后,詢問是否更新單身金額時,應一并重算衝暫估的DIFF
# Modify.........: No.MOD-940297 09/04/23 By chenl    若為aapt260和aapt160時，稅率應為零稅率。
# Modify.........: No.MOD-940358 09/04/27 By Sarah SQL裡少個","
# Modify.........: No.TQC-940171 09/04/28 By Sarah 當不走重評價時,沖暫估(api_file)裡的本幣金額應該用暫估單的匯率算出,目前會用立帳的匯率來算本幣金額
# Modify.........: No.MOD-940381 09/04/28 By lilingyu 延續MOD-910094的修改,增加g_aptype的條件
# Modify.........: No.MOD-940392 09/04/30 By Sarah t110_firm2()段,刪除apc_file的語法在IFX環境有誤
# Modify.........: No.MOD-940411 09/05/04 By Sarah 修改單價(apb23)時,若單身有輸入採購單(apb06,apb07),則需判斷修改的單價不可高於採購單價(pmn31)
# Modify.........: No.MOD-940326 09/05/04 By Sarah t110_b()段,檢核科目+部門為允許/拒絕部門控制寫法修改
# Modify.........: No.TQC-950004 09/05/05 By wujie 多借方界面中，換不同的分攤方式會報錯
# Modify.........: No.MOD-940416 09/05/05 By lilingyu 當aapt160仍有未衝余額時,在衝暫估未確認前,aaot120可以輸入一筆以上的資料(其總額>aapt160可衝余額) 
# ...................................................凡是在aapt120能新增的資料,就可以確認,導致aapt120衝暫估金額大于apt160可衝暫估余額
# Modify.........: No.MOD-950045 09/05/06 By lilingyu CALL t110_apa05(p_cmd),若l_pmc05='0'時,LET g_errno='aap-032' 
# Modify.........: No:TQC-910032 09/05/07 By Sarah 當apz59=N時,aapt120單身的apb12欄位的抬頭應顯示"品號"
# Modify.........: No.TQC-940178 09/05/12 By Cockroach 跨庫SQL一律改為調用s_dbstring()  
# Modify.........: No.MOD-950138 09/05/13 By lilingyu 檢核mfg-011訊息前,判斷當稅別不為不申報時才檢核
# Modify.........: No.MOD-950158 09/05/15 By lilingyu t110_apb22_11(),t110_apb22_12(),t110_apb22_21()三段一開始都需要增加檢核輸入的入庫/倉退單是否有立暫估,
# ...................................................若有暫估資料但該資料未確認,則需提示訊息aap-118
# Modify.........: No.FUN-930165 09/05/15 By jan MISC料件改抓請購單單頭的部門(pmk13) 
# Modify.........: No.MOD-950058 09/05/17 By Sarah 修正MOD-940411,應只針對26類卡修改單價不可超過採購單價
# Modify.........: No.MOD-950112 09/05/17 By Sarah 需判斷是從什麼地方進入t110_ddd(),若是修改段CALL過來,則BEFORE ROW不需再做LOCK單頭Table,若不是則要LOCK單頭Table
# Modify.........: No.MOD-950177 09/05/18 By lilingyu 調整只要為MISC開頭的料件,單身部門就捉取請購部門
# Modify.........: No.TQC-950113 09/05/25 By wujie   衝帳后apv04和apv04f為0的資料都刪除
#                                                    衝帳時帳款編號開窗可開出待扺借支款資料
# Modify.........: No.MOD-950226 09/05/21 By Sarah 多發票刪除單身某一筆發票後再輸入一次,應該是新增,卻變成UPDATE,造成錯誤,畫面增加顯示項次,處理apk_file的SQL條件增加apk02
# Modify.........: No.MOD-950284 09/06/03 By Smapmin 使用利潤中心功能又做預算控管時,會一直卡在會計科目的欄位
#                                                    確認段的預算控管沒有功用
# Modify.........: No.MOD-960010 09/06/03 By Sarah 修改單頭稅別後會重新寫入apc_file,但最後放棄修改時,卻沒將apc_file重新產生
# Modify.........: No.MOD-960026 09/06/03 By baofei原判斷IF g_aptype = '15' AND g_aza.aza26 != '2' THEN 
#                                                  改為g_aptype = '15' AND g_aza.aza26 != '2' AND (g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y')) THEN
# Modify.........: No.TQC-960021 09/06/04 By xiaofeizhu 修改aapt120錄入“借方科目二”后，沒能帶出“借方科目二名稱"的問題
# Modify.........: No.TQC-960012 09/06/08 By xiaofeizhu 3.立應付時,若發票種類為'T'或'A'時,應該由含稅金額推算未稅金額.未稅金額=含稅金額*(1-稅率)
# Modify.........: No.FUN-940083 09/06/08 By shiwuying VMI 採購改善
# Modify.........: No.MOD-960152 09/06/15 By xiaofeizhu
# Modify.........: No.MOD-960095 09/06/28 By Sarah AFTER FIELD apb23段計算單價含稅金額時,應增加判斷11,16,21,26類別才抓rvv38t重算
# Modify.........: No.MOD-960119 09/06/28 By Sarah 修正MOD-960010,當新增放棄時不需重新產生apc_file
# Modify.........: No.MOD-960128 09/06/28 By Sarah 修正MOD-950226,t110_inv()段改用g_apk1
# Modify.........: No.MOD-960264 09/06/28 By Sarah 當單頭輸入稅別(apa15)之發票聯數(gec05)為4或X時,aapt120的發票欄位(apa08)允許不輸入
# Modify.........: No.MOD-960266 09/06/28 By Sarah t110_api_unap()段在計算暫估未沖金額時,應抓暫估單單身金額才對
# Modify.........: No.MOD-960280 09/06/28 By Sarah 沖帳檢查錯誤訊息aap-779，本幣金額應以重估後的金額apc13做判斷才合理
# Modify.........: No.CHI-960074 09/06/28 By Sarah 新增完aapt160單頭要進入單身前,增加提示aap-166訊息
# Modify.........: No.MOD-960302 09/06/28 By Sarah 需檢查12/13/16/22/23/25類帳款是否存在成本分攤單據中,若有不允許取消確認
# Modify.........: No.MOD-960328 09/06/28 By Sarah 單身段輸入完數量後,需判斷apb34='N'才要重算本幣單價與本幣金額
# Modify.........: No.MOD-960329 09/06/30 By Sarah 在INSERT INTO apg_file前,先檢查pag05/apg05f是否為Null,若是則default為0
# Modify.........: No.CHI-910035 09/06/30 By Sarah ㄧ張採購單可能預付多次,aapt150需增加檢核預付是否已經超過採購單金額
# Modify.........: No.MOD-940329 09/06/08 By Carrier 倉退數量判斷修改
# Modify.........: No.FUN-960141 09/06/26 By dongbg GP5.2修改:增加門店編號欄位
# Modify.........: No.MOD-970061 09/07/09 By Sarah 檢查入庫/倉退單對應的收貨單若已有發票,就不可再產生暫估/退貨暫估
# Modify.........: No.CHI-910036 09/07/14 By baofei修改api06先抓ahb04,若ahb04為NULL，再抓apa25                                      
# Modify.........: No.CHI-910032 09/07/14 By baofei 修改若單頭不為MISC(表示為單一發票)，先將apk_file刪除，再重新產生                
#                                                   修改單身單頭金額不一致時單身累加回寫單頭                                        
# Modify.........: No.MOD-970111 09/07/14 By baofei apa08為‘MISC’時修改單頭稅別和稅率后，不要重算單頭的金額欄位                   
# Modify.........: No.MOD-970115 09/07/14 By baofei 1.t110_api_diff()搬至 apa56為5的判斷之后                                        
#                                                   2.t110_firm1_chk()段，arm-034的判斷條件增加apa56<>'5'                           
# Modify.........: No.MOD-960059 09/07/14 By baofei g_aptype=12時apa08不可為空
# Modify.........: No.MOD-960106 09/07/14 By baofei 修改t100_ddd()段CALL t110_apz08()的條件                                          
# Modify.........: No.MOD-960121 09/07/14 By baofei 付款廠商apa06開窗由 q_pmc1改成a_pmc  
# Modify.........: No.FUN-970008 09/07/14 By douzh  大陸版列印需要兩個ACTION明細表(aapr129)和應付憑証(aapr111)
# Modify.........: No.MOD-970145 09/07/17 By baofei 1.t110_ddd_c()段拿掉ORDER BY                                                    
#                                                    2.修改ON ROW CHANGE UPDATE apb_file改為apk_file                                
#                                                    3.t110_ddd()拿掉ORDER BY  
# Modify.........: No.FUN-960081 09/07/21 By dxfwo   s_get_serial_no自動編號添加參數
# Modify.........: No.MOD-970213 09/07/23 By mike 點選[留置]出現詢問視窗后,無輸入選擇直接點選[放棄],應不可進入輸入留置原因碼.
# Modify.........: No.MOD-970197 09/07/22 By mike 請款單在axrt400衝帳后,在aapt120右邊衝帳查詢點開后目前是查不到資料的,              
#                                                 應該要可以查詢的到axrt400衝銷的資料.   
# Modify.........: No.FUN-950056 09/07/27 By chenmoyan 去掉ima920
# Modify.........: No.MOD-970220 09/07/23 By mike aapt160與aapp115稅別開窗邏輯仍不一致,                                             
#                                                 aapt160 after field稅別欄位的控管邏輯應與aapp115一致,                             
#                                                 加控管aap-977與aap-008     
# Modify.........: No.MOD-970221 09/07/23 By mike FUNCTION t110_copy()段,在清空apa08時,也應一并清空apa09                            
# Modify.........: No.MOD-980002 09/08/03 By mike FUNCTION t110_account_period()段,l_apc13/l_apc14/l_apc15請改成用ARRAY             
# Modify.........: No.MOD-980029 09/08/04 By mike FUNCTION t110_ins_nme(),改成LET l_nme.nme02=m_apa.apa02                           
# Modify.........: No.MOD-980030 09/08/05 By Sarah 詢問aap-336前,增加判斷單身是否有沖暫估資料,若有則不更新單頭金額
# Modify.........: No.MOD-980032 09/08/05 By Sarah 修正CHI-910035,比較預付金額有沒有超過原採購單金額,應該以aapt150單頭金額來比較
# Modify.........: No.MOD-970278 09/08/06 By Sarah 檢核aap-210時,應考量沖帳的單據,若原先預付時有稅額應扣除
# Modify.........: No.FUN-980001 09/08/11 By TSD.sar2436 GP5.2架構重整，修改 INSERT INTO 語法
# Modify.........: No.TQC-980068 09/08/12 By xiaofeizhu 隱藏aapq231會計資料頁簽中的貸方科目欄位
# Modify.........: No.MOD-980141 09/08/18 By Sarah 當apz27='N'時,輸入完發票號碼(apa08)欄位程式會當掉
# Modify.........: No.TQC-970195 09/07/21 By Carrier '15'單據時,單身科目二default方式同單身科目一
# Modify.........: No.CHI-930020 09/08/13 By hongmei增加1.發票輸入時檢查字軌;2.發票為2/3聯檢查
# Modify.........: No.MOD-980218 09/08/27 By mike 取消確認前請先重新讀取單頭檔    
# Modify.........: No.FUN-980020 09/08/31 By douzh GP5.2架構重整，修改sub相關傳參
# Modify.........: No.FUN-980030 09/08/31 By Hiko 加上GP5.2的相關設定
# Modify.........: No.MOD-970065 09/09/17 By wujie   更改時，運輸發票的稅別應輸入含稅金額自動轉為未稅金額+稅額
# Modify.........: No.MOD-970101 09/09/17 By wujie  廠商DM審核時不需要檢查待扺衝帳
# Modify.........: No.CHI-990015 09/09/07 By Sarah aapt120當單身料號為MISC*時,帶出料件主檔的會科到單身的科目(apb25),當科目要做部門管理時,自動帶單頭的部門到單身部門(apb26)
# Modify.........: No.FUN-990069 09/09/27 By baofei 修改GP5.2的相關設定
# Modify.........: No.FUN-970108 09/08/21 By hongmei add apa77申報統編
# Modify.........: No.FUN-990014 09/09/08 By hongmei先抓apyvcode申報統編，若無則將apz63的值寫入apa77/apk32
# Modify.........: No.CHI-990056 09/09/27 By hongmei 修改BEFORE FIELD apa77
# Modify.........: No.FUN-960038 09/07/30 By chenmoyan 專案加上'結案'的判斷
# Modify.........: No.TQC-9A0017 09/10/09 By Sarah CALL s_chkban()應傳入統一編號
# Modify.........: No.MOD-9A0070 09/10/09 By Sarah 發票號碼輸入MISC,進入多發票維護完資料回到單頭時,發票號碼欄位會變回舊值
# Modify.........: No.TQC-9A0086 09/10/15 By liuxqa 控管匯率不可小于零。
# Modify.........: No.TQC-9A0087 09/10/15 By xiaofeizhu 稅率控管為不可小于零.
# Modify.........: No.MOD-990130 09/10/16 By mike 一待扺預付132-09090001分兩次衝帳,若衝帳方式不同,會檢查錯誤.                       
# Modify.........: No.MOD-990132 09/10/16 By mike  aapt160  查詢　時,在稅別　^p 居查到銷項的稅別．請控制，僅能查到進項　且　不申報,>
# Modify.........: No.MOD-990155 09/10/16 By mike aapt151 借支單維護作業，在修改單頭時，AFTER FIELD apa31f后，會卡在 原幣 借款 的欄>
#                                                 錯誤訊息為aap-937 不可超過原采購單金額   
# Modify.........: No.MOD-990174 09/10/18 By mike FUNCTION t110_u()段,CALL t110_i()后,當放棄后應該不用UPDATE單身                    
# Modify.........: No.MOD-990177 09/10/18 By mike FUNCTION t110_ddd()段最后,加上 OR g_apz.apz08='2'                                 
# Modify.........: No.MOD-990200 09/10/18 By mike 1.使用多帳期時,於多帳期維護輸入留置金額,單頭無留置原因碼                          
#                                                 2.點選留置,若無輸入123選項按確定,應視為放棄return                                 
# Modify.........: No.MOD-990239 09/10/19 By mike 當FUNCTION t110_apz08(),要回寫帳款單頭檔apa_file時,判斷若稅額l_apa32不為0,        
#                                                 需以apa15到稅別檔(gec_file)抓取稅額科目gec03,將gec03寫入到稅額科目apa52           
# Modify.........: No:MOD-970040 09/10/20 By Sabrina 當aza26=2時，單身的發票號碼在輸入完退貨單號和項次後要自動帶出
# Modify.........: No:MOD-970049 09/10/20 By Sabrina 預付時，以pmn31t來做卡關
# Modify.........: No:MOD-970173 09/10/20 By sabrina aapt160單身異動類別若為空白時，應仍可算出合計金額
# Modify.........: No:MOD-970179 09/10/20 By sabrina (1)異動帳款日期或付款廠商後，apc04的應付款日並沒有被更新到
#                                                    (2)apa02異動後還未按確定前又在異動一次時，apa12並不會依最新的apa02日期來做異動
# Modify.........: No:MOD-980148 09/10/20 By sabrina 當付款日期apa12有變動時，允許票期及票到期日也要跟著變動 
# Modify.........: No:MOD-990058 09/10/20 By sabrina 單頭匯率(apa14)取出後不需取位
# Modify.........: No:MOD-990188 09/10/20 By sabrina aapt160作廢時不考慮有發票號碼UNAP 
# Modify.........: No:MOD-9A0032 09/10/20 By sabrina 系統沒檢查預付請款總額是否超過採購單總額 
# Modify.........: No:MOD-9A0051 09/10/20 By sabrina 多發票視窗匯率修改後，要將重算後的金額顯示到畫面上 
# Modify.........: No:TQC-9A0015 09/10/20 By sabrina 第二套帳分錄產生有問題 
# Modify.........: No:MOD-990125 09/10/20 By mike 若已做直接付款,后續有再調整單頭資料時,會將apc_file已付金額又歸零
# Modify.........: No:MOD-9A0113 09/10/20 By mike FUNCTION t110_b(),AFTER FIELD apb24,
#                                                 當單身有輸入apb07(采購單項次),請先抓取apb06+apb07在aapt150已預付過多少金額,這次可預付的金額不可>采購單項次金額-已預付金額
#                                                 當單身沒輸入apb07(采購單項次),請先抓取apb06在aapt150已預付過多少金額,這次可預付的金額不可>采購單總金額-已預付金額
# Modify.........: No:MOD-990248 09/10/21 By mike FUNCTION t110_k()的AFTER INPUT段,l_amt的计算修改                                  
# Modify.........: No:MOD-990250 09/10/21 By mike FUNCTION t110_cs(),apb25与apb251的开窗,请改成用q_aag                              
# Modify.........: No:MOD-9A0075 09/10/23 By mike FUNCTION t110_pay_record(),IF g_aptype MATCHES '2*' THEN段,增加抓取apg_file资料   
# Modify.........: No:TQC-9A0119 09/10/23 By Sarah 應判斷apz14或g_aza.aza21為Y再搭配CALL s_chkban()判斷統一編號的正確性
# Modify.........: No:MOD-9A0155 09/10/27 By sabrina 多發票, lock cursor串apl_file導致FETCH不到資料,  t110_ddd_c()
# Modify.........: No:MOD-9A0085 09/10/29 By mike FUNCTION t110_apb22_21(),当g_aptype = '21'且g_apa.apa58 = '3'时,会检查资料是否存在
#                                                 若在aapt260找不到,请再到仓退单找,若仓退单也没有,才显示aap-091并RETURN             
# Modify.........: No:MOD-9A0093 09/10/29 By mike 当aapt1210确认时,当税别是不申报时,且无对应采购单时,即不check发票资料,即不应出现aap
# Modify.........: No:MOD-9A0100 09/10/29 By mike aapt110差异处理选择折让时,aapt210产生的apc_file,已付金额均为0                     
# Modify.........: No:MOD-9A0109 09/10/30 By mike 系预付费用之请款，根本没有采购单，怎麽还要控管不能超过采购单                      
# Modify.........: No:FUN-9A0093 09/10/30 By lutingting單身新增欄位機構編號apb37,其他欄位如入庫單號等根據機構編號過濾
# Modify.........: No:MOD-9A0135 09/11/03 By mike FUNCTION t110_b(),AFTER FIELD apb24与AFTER INPUT段,会检核apb24<=0的话需卡关,      
# Modify.........: No:MOD-9A0143 09/11/03 By mike 在aapt110维护单身资料时，单身采购单的币别必须与单头的币别相同，                   
#                                                 在输入完入库单号项次后，如果不管aap-041的错误讯息，直接按确定的话，可以避过币别的>
#                                                 造成单头币别与单身采购单据币别不符的情况。  
# Modify.........: No:MOD-9A0147 09/11/03 By mike 暂估产生api时, FUNCTION t110_api_unap(), 捞取aapt110/aapt120已确认冲暂估金额应加条
# Modify.........: No:TQC-9B0019 09/11/04 By Carrier SQL STANDARDIZE
# Modify.........: No:MOD-9A0188 09/10/29 By Sarah t110_ddd_c()段算完l_tot1f,l_tot2f,l_tot3f後請增加將之顯示出來
# Modify.........: No:MOD-9A0201 09/11/02 By Sarah aapt120雜項輸入時,稅別若為內含,輸入原幣單價後應為含稅單價,需回推為未稅單價
# Modify.........: No:MOD-9B0001 09/11/03 By Sarah aapt210/aapt220列印時,報表apa08說明應顯示參考單號,明細應顯示退貨單號而非入庫單號
# Modify.........: No.MOD-9B0043 09/11/06 By lutingting 取消對單頭營運中心apa100得可錄控管,開放其一直可錄
# Modify.........: No:MOD-9B0048 09/11/09 By Sarah 若同一張採購單在單身輸入多筆(可能是輸入不同的項次)時,應該只能SUM一次單頭金額,否則會重複
# Modify.........: No:MOD-9B0089 09/11/13 By Sarah 輸入完apa06後,若非MISC需重帶apa07
# Modify.........: No:MOD-9B0050 09/11/24 By sabrina 修改MOD-990130的調整 
# Modify.........: No:MOD-9B0054 09/11/24 By sabrina 單身若有修改金額，沖暫估的金額也要一併變更 
# Modify.........: No:MOD-9B0168 09/11/25 By Sarah aapt220應可同aapt120微調單頭的稅額
# Modify.........: No:MOD-9B0190 09/11/30 By Sarah aapt150輸入發票號碼後應檢查是否有重覆輸入
# Modify.........: No:MOD-9B0200 09/11/30 By Sarah 大陸版輸入多發票時，無法按確定離開
# Modify.........: No:MOD-9B0202 09/11/30 By Sarah 大陸版輸入多發票應是以原幣*匯率算出本幣,離開前不需再以本幣/匯率回算原幣
# Modify.........: No:MOD-9B0203 09/11/30 By Sarah 大陸版輸入完多發票金額欄位後應取位
# Modify.........: No:MOD-9C0012 09/12/02 By sabrina apa08新增判斷條件：apa08是MISC且為1*類帳款才不可入單頭金額 
# Modify.........: No:MOD-9C0085 09/12/08 By Sarah FUNCTION t110_j(),算完apb14與apb14f後需取位
# Modify.........: No:FUN-990017 09/09/08 By Carrier 去掉 "待抵冲帐"功能
# Modfiy.........: No.FUN-9C0041 09/12/09 By lutingting 1.單頭增加經營方式欄位且經營方式若為代銷,則科目取相應代銷科目.
#                                                       2.由于可以將同一法人下其他營運中心得資料立在同一張單里所以刪除得時候也要考慮到營運中心
#                                                       3.t110_stock_act加傳參數營運中心,可以跨庫抓取科目
# Modify.........: No.TQC-9C0099 09/12/14 By jan GP5.2架構重整，修改sub相關傳參
# Modify.........: No:CHI-9C0015 09/12/15 By Sarah 當參數設定預付金額輸入需與採購單勾稽時,控管輸入金額不可超過採購單的含稅金額
# Modify.........: No:FUN-990053 09/09/16 By hongmei s_chkban前先检查aza21 = 'Y'   
# Modify.........: No:MOD-9C0145 09/12/16 By Sarah 計算預付金額時,需先清空變數值
# Modify.........: No:MOD-9C0148 09/12/16 By Sarah 修改完發票日期後,也應該CALL s_paydate()重算付款日與票到期日
# Modify.........: No:MOD-9C0252 09/12/19 By sherry  l_api03_a[i]改為l_api03_a[i].api03
# Modify.........: No.MOD-9C0263 09/12/19 By lutingting aapq230 aapq231 aapq240 隱藏欄位apa76
# Modify.........: No.MOD-9C0259 09/12/19 By Carrier 费用UNAP时,不check 入库单
# Modify.........: No.MOD-9C0334 09/12/22 By sabrina 若單身apb06有值則串回採購單抓取pmm22(幣別)，若與apa13不同則不可確認
# Modify.........: No:MOD-9C0264 09/12/23 By sabrina 單身的"部門"欄位應依"科目"欄位判斷是否需做控卡 
# Modify.........: No:MOD-9C0267 09/12/23 By sabrina 若aza63<>'Y'則不需判斷apa511的條件 
# Modify.........: No.FUN-9C0001 09/12/24 By lutingting t110_g_gl加參數
# Modify.........: No:MOD-9B0150 09/12/28 By wujie 冲帐时若原币冲完，应直接带出本币
#                                                  汇差的计算方式调整，若冲帐原币=立账原币，则取两者本币的差异
# Modify.........: No:MOD-9C0416 09/12/28 By Sarah 大陸版做aap-151檢核時,不需過濾apk171條件
# Modify.........: No:MOD-9C0342 09/12/29 By Sarah t110_ddd()的BEFORE FIELD apk02,寫到DISPLAY g_apk[i].apk02 TO apk02與DISPLAY g_apk[i].apk03 TO apk03,請mark掉
# Modify.........: No:MOD-9C0356 09/12/29 By Sarah CALL s_apkchk()前,請先將g_msg變數清空
# Modify.........: No:MOD-9C0394 09/12/29 By Sarah 重過程式即可
# Modify.........: No:MOD-9C0444 09/12/30 By Sarah 修正當aza26<>'2'時才做CHI-930020的發票檢核
# Modify.........: No:MOD-9C0457 09/12/31 By Sarah 預付單身輸入金額判斷是超過原採購單金額時,應判斷有輸入採購單者才需檢查
# Modify.........: No:MOD-9C0454 09/12/31 By Sarah 大陸版做aap-037檢核時,apk171增加XX條件
# Modify.........: No:FUN-9C0072 10/01/04 By vealxu 精簡程式碼
# Modify.........: No.FUN-A10011 10/01/07 By lutingting apa76欄位在零售時 aapt160 以及aapt260 顯示,其他情況以及其他程序如aapt110都不顯示該欄位 
# Modify.........: No.TQC-A10060 10/01/07 Bu wuxj    修改INSERT INTO加入oriu及orig這2個欄位
# Modify.........: No.FUN-9C0140 10/01/08 By lutingting 有update語句沒有execute
# Modify.........: No.MOD-A10055 10/01/11 By liuxqa 多帐期冲账时，冲账资料重复。
# Modify.........: No:TQC-A10146 10/01/21 By Sarah 將MOD-9A0201修改段移除
# Modify.........: No:MOD-A10133 10/01/25 By Sarah 修改完單身後應將金額累加至單頭
# Modify.........: No:MOD-A20009 10/02/02 By wujie 大陆版时，不同年月未立暂估单的入库单不能使用
# Modify.........: No:MOD-9C0437 10/02/04 By sabrina aapt210新增"發票資料"按鈕 
# Modify.........: No:MOD-A20091 10/02/23 By sabrina 若已有設定留置金額，再去做日期修正後，會將apc16留置金額歸零 
# Modify.........: No:TQC-A20061 10/02/25 By sherry 資料來源營運中心沒有帶出名稱 
# Modify.........: No.FUN-9B0098 10/02/24 by tommas delete cl_doc
# Modify.........: No:MOD-A20108 10/02/26 By sabrina 在雜項應付使用直接付款，選"8"預付，帳款單號選aapq230單據
#                                                    之後aapt120將單據刪除，aapq230多帳期金額並沒扣回 
# Modify.........: No.TQC-A20062 10/03/01 By lutingting拿掉參數apz26
# Modify.........: No:MOD-A30008 10/03/02 By sabrina "FOR UPDATE"只能串一個table，兩個table時會有錯 
# Modify.........: No:MOD-A30045 10/03/09 By sabrina 當apz61=2時，單身的單價及金額要可維護 
# Modify.........: No:MOD-A20113 10/03/09 By sabrina 倉退單不可存在於別張帳款中 
# Modify.........: No:MOD-A30046 10/03/09 By sabrina 修改A20113
# Modify.........: No:MOD-A30059 10/03/12 By sabrina 將apb06_cs的IF g_apa.apa31f > l_pmm40t - l_apa31f THEN判斷式移到foreach外判斷
# Modify.........: No:TQC-A30072 10/03/15 By Carrier 申報統編apa77 若用戶修改,則以用戶修改為准,不得再將默認設定值賦值
# Modify.........: No:TQC-A30076 10/03/16 By Carrier "多發票"后,若apz59 = 'N'時,要即時將多發票資料顯示于單身中
# Modify.........: No:TQC-A30079 10/03/16 By Carrier 1.多發票錄入完后更新帳款金額 設定為 3.不更新 時,要開放單頭未稅/稅額字段
#                                                    2.多發票錄入完后更新帳款金額 設定為 2.詢問&詢問為不更新/3.不更新,則不做update 單頭apa各金額的動作
#                                                    3.大陸版時,MOD-9B0200修改的緣故,導致無法對發票做更新,更新會失敗
# Modify.........: No:MOD-A30113 10/03/16 By sabrina 抓取預算(aglt600)時應以期別角度抓取，不應以當年度年月抓取預算
# Modify.........: No:TQC-A30087 10/03/17 By Carrier 1.insert nme出错语法错误
#                                                    2.多发票时,程序直接当出,g_apk变量的内容和画面s_apk的不一致 
# Modify.........: No:TQC-A30068 10/03/17 By Carrier apz59='N'时,apb37 title显示错误
# Modify.........: No:MOD-A30084 10/03/17 By sabrina 原先有設定留置，執行差異處理後在按確認會出現aap-129錯誤訊息
# Modify.........: No:FUN-A20044 10/03/19 By vealxu  ima26x 調整
# Modify.........: No:MOD-A30142 10/03/19 By sabrina 當差異折讓時寫入apk175應改為NULL 
# Modify.........: No:MOD-A30140 10/03/23 By sabrina 大陸版多發票apk03可以不需輸入
# Modify.........: No:TQC-A30127 10/03/24 By lilingyu aapq230：根據待抵編號查詢時,申報統編無法顯示出來
# Modify.........: No:MOD-A30208 10/03/26 By sabrina 單頭留置金額變更後，子帳期apc16也要變更
# Modify.........: No:MOD-A30209 10/03/26 By sabrina FUNCTION t110_ins_apc中，若l_apa20為null，就給予0 
# Modify.........: No:TQC-A30133 10/03/29 By Carrier '多借方'action时,若借方科目非'MISC'时,给提示信息
# Modify.........: No:TQC-A30134 10/03/29 By Carrier s_get_serial_no传参错误
# Modify.........: No:FUN-A30106 10/03/29 By wujie   增加凭证联查功能
# Modify.........: No:MOD-A30230 10/03/29 By sabrina 無論apz61的值為何，單身的單價與金額都要可以修改
# Modify.........: No:TQC-A30152 10/03/30 By destiny 审核时aapt1101的画面的“原含税金额”没值
# Modify.........: No:TQC-A30160 10/03/30 By destiny TQC-A30152修改有误，现更正        
# Modify.........: No:CHI-A30023 10/03/31 By sabrina aapt260單身可不需輸入退貨單+項次
# Modify.........: No:TQC-A30161 10/03/31 By destiny 新增时当单头与单身金额有差异时，点差异处理，选6，跳出的窗口显示差异额不正确
# Modify.........: No:TQC-A30129 10/04/12 By lilingyu 先進入"原幣金額 原幣稅額"未給值,然后再次進入,給值后,稅額科目apa52未帶出值 
# Modify.........: No:MOD-A40078 10/04/19 By Smapmin 多角貿易帳款必須要由批次整批產生,不能由各站自已登打(中斷點除外)
# Modify.........: No:CHI-A10006 10/04/19 By Summer 寫入api_file段,若原幣金額加總為剩餘未沖原幣金額,
#                                                   則本幣金額也應全數沖完,將尾差調在金額最大的一筆上
# Modify.........: No:CHI-A40005 10/04/22 By Summer  1.重新開放多發票視窗,僅修改稅額(apk07/apk07f),不可新增與刪除
#                                                    2.此多發票視窗需檢核稅額金額須等於單頭原幣稅額與本幣稅額  
# Modify.........: No:TQC-A40102 10/04/21 By xiaofeizhu ¿ýô۰ʱa¥»¦ì                                                      
# Modify.........: No:TQC-A40106 10/04/22 By xiaofeizhu aaps100¤¤ªº"Â¶µ½дڳ樭¿ýC¸ê"¤§°ѼÆ¥u°w¹ïpt120¶i¦汱ºÞ¤£3¸ӹï
# Modify.........: No:TQC-A40107 10/04/22 By xiaofeizhu aapt151¼W¥[§PÂ³æ©M³樭ª÷O§_¤@­P
# Modify.........: No:MOD-A40102 10/04/20 By sabrina FUNCTION t110_apb07(p_cmd)增加判斷
# Modify.........: No:CHI-A30035 10/04/28 By sabrina 沖帳畫面按確定後，單頭沖帳金額有誤
# Modify.........: No:MOD-A50005 10/05/03 By sabrina aapt120執行多發票，若無資料存在或是新增狀況下按"放棄"後 ，程式會整個關掉
# Modify.........: No:MOD-A40184 10/05/04 By sabrina 變更單頭日期，單頭匯率變動時，單身本幣金額沒有跟著變動 
# Modify.........: No:MOD-A50011 10/05/06 By sabrina MOD-A20108多增加三個條件，aph03='6'、'7'、'9'
# Modify.........: No:MOD-A50086 10/05/13 By sabrina FUNCTION t110_copy()中apainpd應等於g_today 
# Modify.........: No:MOD-A50098 10/05/17 By Dido 1.複製時,日期調整應重算付款日與票到期日 2.計數單身有誤 
# Modify.........: No:FUN-A40003 10/05/19 By wujie  insert时增加apa79,apa79='Y'的资料不可删除不可取消审核不可无效
# Modify.........: No:MOD-A50152 10/05/25 By sabrina 大陸版在更新狀態下-調整單頭發票欄位(apa08)為MISC -->維護多發票資料--> 
#                                                    回主畫面--> 按放棄
#                                                    此時多發票資料已寫入,但aapt110發票資料欄位不是MISC的 
# Modify.........: No:MOD-A50180 10/05/26 By Dido 發票號碼檢核問題調整 
# Modify.........: No:CHI-A50042 10/06/04 By Summer 開放可調整多帳期中有多筆資料的日期修正
# Modify.........: No:MOD-A60004 10/06/07 By Dido 預收單身控制問題
# Modify.........: No:MOD-A60078 10/06/10 By Dido aapt120 單身不可輸入有入庫單的暫估單
# Modify.........: No:TQC-A60054 10/06/12 By xiaofeizhu 過單
# Modify.........: No:FUN-A60024 10/06/12 By wujie   调整apa79的值为0 
# Modify.........: No:MOD-A60095 10/06/14 By Dido aapt120 員工簡稱應符合 10 位輸入原則 
# Modify.........: No:MOD-A60115 10/06/18 By Dido 單身放棄控制調整 
# Modify.........: No.FUN-A60056 10/06/22 By lutingting GP5.2財務串前段問題整批調整
# Modify.........: No.MOD-A60160 10/06/25 By Dido 沖暫估更新時未使用 apilegal 導致有誤 
# Modify.........: No:MOD-A70003 10/07/02 By Dido 若單身部門已有值不可再被覆蓋 
# Modify.........: No:MOD-A70006 10/07/05 By Dido aapt150 單頭 apa58 無須顯示 
# Modify.........: No:MOD-A70037 10/07/05 By Dido 新增待抵時 apc16 應為 0 
# Modify.........: No:MOD-A70048 10/07/06 By Dido 當 MISC* 抓取不到時再用 MISC 資料 
# Modify.........: No:MOD-A70095 10/07/13 By Dido 沖帳的 DIFF 改用差異數更新方式 
# Modify.........: No:MOD-A70116 10/07/15 By sabrina 單頭留置金額(apa20)為0時，多帳期留置金額應要為0 
# Modify.........: No:MOD-A70122 10/07/19 By sabrina 暫估資料api_file若存在apb_file，則不可修改金額
# Modify.........: No:MOD-A70153 10/07/20 By Dido 差異處理增加 tansation 架構 
# Modify.........: No:MOD-A70158 10/07/21 By sabrina 從aapt150轉到aapq230時，apa19要應給空白，apa20應給0 
# Modify.........: No.FUN-A50102 10/07/23 By lixia 跨庫寫法統一改為用cl_get_target_table()來實現
# Modify.........: No:CHI-A50028 10/07/27 By Summer 程式增加 aqaconf <> 'X' 判斷
# Modify.........: No:MOD-A70214 10/07/29 By Dido aapt120 單身若有對應暫估,則 apa57 會被清空 
# Modify.........: No:TQC-A70123 10/07/29 By xiaofeizhu 修改點擊"直接付款"退出系統的BUG
# Modify.........: No:MOD-A70229 10/07/30 By Dido 自動請款折讓產生時如為不申報抓取其他折讓應過濾屬於 apa00 = '2*',發票輸入時應增加不申報狀態 
# Modify.........: No:MOD-A40103 10/08/03 By sabrina 帳款金額<>發票金額時，差異處理apa56並未顯示為1:待處理
# Modify.........: No:MOD-A30248 10/08/03 By sabrina (1)當apz61='1'或apz61='3'單身清空時，單頭金額也要清空
#                                                    (2)單身採購單金額檢核應扣除其他筆單筆資料
# Modify.........: No:MOD-A80051 10/08/06 By Dido 單身限制應依循整體參數為主 
# Modify.........: No:MOD-A80052 10/08/09 By Dido 若為運輸發票(gec05='T')時,稅額與未稅金額邏輯調整 
# Modify.........: No:MOD-A80069 10/08/10 By Dido 差異處理應維持原處理狀態 
# Modify.........: No:MOD-A80093 10/08/11 By Dido 大陸版由於apb24/apb10金額已依入庫項次維護在gapi140中,因此不可再重算 
# Modify.........: No:MOD-A80103 10/08/12 By wujie apb25/apb251预设ima39的判断去除12的限制
# Modify.........: No:CHI-A80008 10/08/12 By Summer 作廢時刪除發票資料,單身資料,單頭金額清為0 
# Modify.........: No:MOD-A80123 10/08/16 By wujie aapq231还款查询不到
# Modify.........: No.FUN-950053 10/08/17 By vealxu 廠商基本資料的關係人設定搭配異動碼彈性設定
# Modify.........: No.TQC-A80101 10/08/18 By xiaofeizhu apb21處的判斷增加apa00=26的情況
# Modify.........: No.FUN-950094 10/08/22 By vealxu g_aptype= '13'時將稅額相關欄位元加回畫面
# Modify.........: No:MOD-A80159 10/08/23 By Dido aapt210 apa15稅別異動後應更新apk11
# Modify.........: No:MOD-A80204 10/08/25 By Dido aapt110 單頭異動日期應檢核單身入庫單月份 
# Modify.........: No:MOD-A80208 10/08/26 By Dido aapt210 作廢;拋轉傳票;傳票拋轉還原增加權限控管 
# Modify.........: No.FUN-A40036 10/08/27 By vealxu aapt120中的apa07欄位管控的調整 
# Modify.........: No.FUN-990025 10/08/27 By vealxu add b32
# Modify.........: No:MOD-A80217 10/08/27 By Dido 沖帳差異改用一致的 FUNCTION 處理 
# Modify.........: No:TQC-A80186 10/08/31 By Dido 沖帳預設 apv04 邏輯調整
# Modify.........: No:FUN-A80111 10/08/31 By wujie 调整apa79的栏位值
# Modify.........: No:MOD-A90022 10/09/06 By Dido aapt210 單身品號無法預設帶出問題改善
# Modify.........: No:MOD-A90089 10/09/13 By Dido 還款頁簽僅限於 aapt121 使用 
# Modify.........: No:MOD-A90094 10/09/14 By Dido apb25會預設apb26,在檢核預算時如有錯誤需跳至apb26 
# Modify.........: No:MOD-A90146 10/09/23 By Dido aapt120 單身暫估金額需檢核是否有超額問題 
# Modify.........: No:CHI-A80031 10/09/27 By Summer 整批確認時,其他單號的資料也需檢查
# Modify.........: No:MOD-A10127 10/09/28 By sabrina 營運中心是台灣時才判斷稅籍 
# Modify.........: No:MOD-A10129 10/09/28 By sabrina 更改apa31f，確認後值並沒有被更新 
# Modify.........: No:MOD-A90181 10/09/29 By Dido apz61 為否時,單身為 memo 性質不檢核採購資訊 
# Modify.........: No:MOD-AA0027 10/10/06 By Dido 沖帳單據不可為原單據 
# Modify.........: No:MOD-AA0035 10/10/08 By Dido 不申報則不檢核發票編號重複問題 
# Modify.........: No:MOD-AA0061 10/10/12 By Dido aap-816 檢核應排除 '22' 資料 
# Modify.........: No:CHI-A90037 10/10/13 By Summer 增加apa00='26'的資料 
# Modify.........: No:MOD-AA0105 10/10/18 By Dido 廠商異動後,apa15舊值需清空 
# Modify.........: No:MOD-AA0116 10/10/20 By Dido aapt210 折讓類別'3'時,倉退單只維護計價數量,刪除帳款時無法回寫 rvv23  
# Modify.........: No:MOD-AA0120 10/10/20 By Dido 1.差異處理時,判斷原狀態為 '1' 則改變為 '0',其他狀態維持不變 
#                                                 2.沖暫估抓取匯率異常 
# Modify.........: No:MOD-AA0187 10/10/28 By Dido apa20與sum(apc16)不同時才需重算apc16;確認後若為留置應可維護apc16
# Modify.........: No:MOD-AA0190 10/10/29 By Dido 差異金額僅 aapt110 適用 
# Modify.........: No:MOD-AB0038 10/11/04 By Dido 複製時匯率問題
# Modify.........: No:CHI-AA0028 10/11/04 By Summer 原先有卡apydmy5='Y'時apb31(費用原因)不可為Null,請將此卡關拿掉
# Modify.........: No:MOD-AB0069 10/11/08 By Dido 複製後匯率異動重新計算單頭與單身本幣金額
# Modify.........: No:MOD-AB0117 10/11/12 By Dido aapt121 當無未付金額時不可修改日期 
# Modify.........: No:MOD-AB0132 10/11/15 By Dido 預算計算函式進入前需判斷會科是否有預算控管
# Modify.........: No:MOD-AB0133 10/11/15 By Dido apa58 只須於 aapt210/220 顯示 
# Modify.........: No:MOD-AB0162 10/11/16 By Dido 多帳期視窗若 g_hold 為 null 則為 DISPLAY 
# Modify.........: No:MOD-AB0167 10/11/17 By Dido 進入 t110_chkapb24 僅限 g_aptype為12時檢核 
# Modify.........: No:CHI-AB0017 10/11/19 By Summer 允許票期為負數時加提示訊息
# Modify.........: No:MOD-AB0201 10/11/24 By Dido 倉退單檢核排除自身帳款 
# Modify.........: No:TQC-AB0025 10/11/24 By chenying 修改Sybas問題
# Modify.........: No:TQC-AB0118 10/11/28 By suncx 新增檢查g_apy.apygslp/g_apy.apygslp1
# Modify.........: No:MOD-AB0256 10/11/30 By Dido 若自定義修改 apc08/apc09 後應更新 apc13
# Modify.........: No:TQC-AB0200 10/12/01 By chenying 手工輸入時,單身無法輸入倉退單+項次
# Modify.........: No:TQC-AB0266 10/12/04 By chenying apk06f加小於零的控管
# Modify.........: No:MOD-AC0066 10/12/09 By Dido 若已確認時,提示詢問並自動重新產生 
# Modify.........: No:TQC-AB0025 10/12/13 By chenying 稅號錄入報錯后仍可以錄下一個欄位至新增成功
# Modify.........: No:MOD-AC0101 10/12/13 By Dido 當輸入稅別(apk11)之發票聯數(gec05)為4或X時,aapt120的發票欄位(apk03)允許不輸入
# Modify.........: No:TQC-AB0025 10/12/14 By chenying 修改apa101,apa102 開窗的where條件
# Modify.........: No:TQC-AB0041 10/12/14 By lixh1    增加拋轉后提示信息
# Modify.........: No:MOD-AC0116 10/12/14 By Dido set entry 控制調整 
# Modify.........: No:MOD-AC0130 10/12/15 By wujie  单身中b_fill的参数调整
# Modify.........: No:MOD-AC0124 10/12/16 By Dido 折讓產生發票時,若 apk_file 不存在再抓取 amd_file
# Modify.........: No:MOD-AC0128 10/12/16 By Dido 產生折讓時 apa171 需轉換 
# Modify.........: No:TQC-AC0282 10/12/18 By lixia 第一帳套和第二帳套檢查時機修改
# Modify.........: No:MOD-AC0237 10/12/20 By Dido apa37/apa37f/page5 僅 aapt121 使用,其他不可顯示 
# Modify.........: No:MOD-AC0238 10/12/21 By shiwuying 入庫單為空不用判斷
# Modify.........: No:MOD-AC0268 10/12/23 By Dido aapt210 確認時再增加檢核稅額與多發票稅額是否相同 
# Modify.........: No:MOD-AC0328 10/12/27 By Dido 寫入 azo_file 應以實際程式代號為宜 
# Modify.........: No:TQC-AC0367 10/12/28 By yinhy 點選"審核"按鈕程序down出
# Modify.........: No:MOD-B10013 11/01/03 By Dido 調整 luck cursor 位置 
# Modify.........: No:MOD-B10011 11/01/04 By Dido control + o 帶出後無法直接儲存 
# Modify.........: No:MOD-B10016 11/01/04 By Dido 會科尚未輸入直接 RETURN 
# Modify.........: No:MOD-B10041 11/01/06 By Dido aapp400 增加參數 gl_summary = 'Y' 
# Modify.........: No:MOD-B10061 11/01/07 By Summer FUNCTION t110_ddd(),BEFORE ROW的BEGIN WORK請還原 
# Modify.........: No:MOD-B10070 11/01/11 By Dido 發票若已有輸入則不需再清空 
# Modify.........: No:CHI-B10017 11/01/11 By Summer 將大陸版的稅別欄位開放 
# Modify.........: No:TQC-B10096 11/01/12 By Dido 調整大陸版多發票 luck cursor 位置 
# Modify.........: No:MOD-B10093 11/01/13 By Dido 多借方 api35/api36 欄位控制調整 
# Modify.........: No:MOD-B10104 11/01/14 By Dido 大陸版稅別選擇後需預設稅率 
# Modify.........: No.FUN-B10050 11/01/21 By Carrier 科目查询自动过滤
# Modify.........: No:MOD-B10191 11/01/24 By Dido 統一編號增加訊息提示 
# Modify.........: No:MOD-B10211 11/01/26 By Dido 費用暫估無須更新入庫資料 
# Modify.........: No:MOD-B10239 11/01/28 By Dido 調整確認段顯示應付金額問題 
# Modify.........: No:CHI-B10042 11/02/09 By Summer 將upd()段判斷狀況碼要為1.已核准才可以確認的段落往上搬到chk()段 
# Modify.........: No:MOD-B20017 11/02/09 By Dido 產生折讓時,發票日期抓取調整
# Modify.........: No:CHI-B20007 11/02/14 By Summer 修正CHI-A80008
#                                                   aapt121與aapt151因為單身沒有前端單據的問題,故不需將單身刪除
#                                                   aapt120單身若apb21有值的話,就需要刪除單身,若apb21為空值時就不需將單身刪除
# Modify.........: No:MOD-AC0034 11/02/14 By wujie 原币冲完暂估后，剩余的本币都归入最后一笔
# Modify.........: No:MOD-B20046 11/02/15 By Dido 取消確認時若為預付帳款則檢核aqb_file應以待抵帳款檢核
# Modify.........: No:MOD-B20082 11/02/18 By Dido axr-065 應僅限11/16/21/26檢核 
# Modify.........: No:FUN-B20059 11/02/22 By wujie  科目自动开窗hard code修改
# Modify.........: No:TQC-B20109 11/02/23 By Dido 相關使用 FOREACH 給 g_apb 部分都少了自訂欄位 
# Modify.........: No:MOD-B20137 11/02/24 By Dido 費用數量不做倒扣,直接給予 1 
# Modify.........: No:MOD-B20152 11/02/25 By Dido 確認段預算檢核邏輯調整 
# Modify.........: No:CHI-B30009 11/03/07 By Sarah CALL t110_bu()前需確保先抓到g_apb04/g_apb05/g_apb04_t/g_apb05_t等變數值
# Modify.........: No:MOD-B30233 11/03/16 By lixia g_apa.apa19為空時才重新賦予值apz12
# Modify.........: No:MOD-B30214 11/03/17 By lixia 當apk171(格式)<>'XX'時,apk03與apk04不可空白
# Modify.........: No:MOD-B30179 11/03/18 By Sarah aapt150輸入時若挑選有稅率的稅別,需卡發票號碼不可空白
# Modify.........: No:MOD-B30183 11/03/18 By Sarah 金額不可為0的卡關改為提示就好,不然從aapp110拋過來單價為0的資料都會被卡住
# Modify.........: No:MOD-B30578 11/03/18 By Sarah 當執行aapt160然後跑到FUNCTION t110_apb22_11()的話,大陸版apb24與apb10的值會是Null
# Modify.........: No:MOD-B30622 11/03/21 By Dido t110_duplicate 無須再檢核發票合理性,因已在t110_invoice_chk檢核 
# Modify.........: No:MOD-B30663 11/03/24 By Dido 訊息 app-053 改為 aap-053 
# Modify.........: No:MOD-B30691 11/03/29 By Sarah 台灣當發票格式為零稅不申報時發票號碼可以不輸入,大陸版也應如此處理
# Modify.........: NO.FUN-B30166 11/03/29 By zhangweib nme_file add nme27
# Modify.........: NO.FUN-B30211 11/03/30 By yangtingting 離開前未加cl_used(2)
# Modify.........: NO.FUN-B30147 11/04/01 By Lilan 純過單,無異動程式
# Modify.........: No:MOD-B40050 11/04/08 By Sarah FUNCTION t110_21_ins2()裡apa171的CASE判斷式請調整的跟MOD-AC0128其它修改段一樣
# Modify.........: NO.TQC-B40051 11/04/08 By yinhy 大陸版“稅種”欄位開窗顯示畫面q_gec8隱藏“媒體申報格式”欄位
# Modify.........: No:MOD-B40036 11/04/11 By Dido 若 transaction 失敗時,變數也需還原回原資料  
# Modify.........: No:MOD-B40070 11/04/12 By Sarah apb21的開窗需判斷apb29,故改為用q_rvv2
# Modify.........: No:MOD-B40108 11/04/14 By Dido apa00 = '13' 多發票時不申報可不用輸入發票 
# Modify.........: No:MOD-B40086 11/04/14 By Dido 檢核多發票稅額移至輸入後檢核 
# Modify.........: No:MOD-B40115 11/04/19 By Sarah 當apa171=28或29時,不做t110_chk()的檢查
# Modify.........: No:MOD-B40117 11/04/20 By Sarah 確認段預算檢查(t110_budchk->t110_bud_s)耗用金額重複計算
# Modify.........: No:MOD-B40183 11/04/21 By wujie 多发票维护时，原币税前金额没有按币种截位 
#                                                  更改帐款类型，科目名称没有刷新
# Modify.........: No:MOD-B40252 11/04/27 By Sarah 當apa171<>'XX'時,應控卡apa18不可空白
# Modify.........: No:MOD-B40261 11/04/28 By wujie apz61 =1时，aapt150单身采购单号必输
# Modify.........: No:FUN-B40096 11/04/29 By zhangll 單身刪除異常報錯修正
# Modify.........: No:MOD-B50017 11/05/04 By Dido 沖帳查詢資料需刪除空白行資料 
# Modify.........: No:FUN-B50019 11/05/04 By elva 删除时未更新暂估数量rvv88,请款数量rvv23
# Modify.........: No:CHI-B50012 11/05/06 By Sarah 單身加入可查詢apb12與apb27
# Modify.........: No:FUN-B40056 11/05/10 By lixia 刪除資料時一併刪除tic_file的資料
# Modify.........: No.FUN-B50090 11/05/17 By suncx 財務關帳日期加嚴控管修正
# Modify.........: No:MOD-B50143 11/05/17 By Dido t110_apz08 增加 apa37 
# Modify.........: No.TQC-B50067 11/05/17 By yinhy api36開窗修改
# Modify.........: No.TQC-B50105 11/05/19 By yinhy aapt120冲账時，請款員工與還款作業上的請款人員不同不可沖帳
# Modify.........: No:TQC-B50108 11/05/19 By yinhy aapt151 當無未付金額時不可修改日期 
# Modify.........: No:MOD-B50183 11/05/20 By Dido apa18/apk04 空白控卡應排除格式為 28/29 
# Modify.........: No:MOD-B50190 11/05/21 By Dido 取消確認段若格式為22且發票聯數為收據者不控管 aap-666  
# Modify.........: No:FUN-B50105 11/05/23 By zhangweib 講aaz88的範圍修改成0~4 添加aaz125設定5~8的異動碼數
# Modify.........: No:MOD-B50218 11/05/25 By Dido AFTER FIELD apa06 新舊值邏輯調整 
# Modify.........: No:CHI-820005 11/05/26 By zhangweib 檢查發票號碼是否有重複時,應多判斷已存在的發票資料其發票日期年度是否為今年,若是的話才卡住.
# Modify.........: No:MOD-B50228 11/05/26 By Dido 抓取第一筆傳遞參數有誤 
# Modify.........: No:MOD-B50235 11/05/27 By Dido aapt210 異動 apa08 時不可刪除 apk_file 
# Modify.........: No:MOD-B50242 11/05/27 By Dido aapt121 有直接付款時無法取消確認
# Modify.........: No:MOD-B50255 11/05/30 By Dido 沖暫估單身部分應帶立暫估部門資料 
# Modify.........: No:MOD-B60016 11/06/03 By Dido 大陸版無須檢核 aap-212  
# Modify.........: No:TQC-B60025 11/06/09 By yinhy aapt160隐藏异动別欄位
# Modify.........: No:MOD-B60066 11/06/09 By Dido 沖帳後 apc_file 相關金額調整
# Modify.........: NO.TQC-B60093 11/06/17 By Polly 延續FUN-A40041處理，調整g_sys為實際系統代號
# Modify.........: No:TQC-B60206 11/06/20 By Dido FUNCTION ins_apc 調整 apc08/apc09 需含沖帳金額 
# Modify.........: No:TQC-B60238 11/06/20 By zhangweib 系統報錯“ins nme: 找到一個未成對的引號”
# Modify.........: No:MOD-B60156 11/06/20 By Dido apa05 在單身無參考單號時開放允許修改 
# Modify.........: No:TQC-B60272 11/06/21 By zhangweib FUNCTION t110_duplicate 中 g_apk[i] 改為 g_apk[l_idx]
# Modify.........: No:TQC-B60280 11/06/22 By zhangweib 在查詢時,查找所有存在於zaw_file表中的營運中心
# Modify.........: No:TQC-B60291 11/06/22 By Sarah 修正MOD-B60066
# Modify.........: No:TQC-B60324 11/06/24 By yinhy 科目不存在時return
# Modify.........: No:MOD-B60218 11/06/24 By Sarah aapt121規還借款的計算有誤
# Modify.........: No:MOD-B60221 11/06/25 By Sarah 修正MOD-B60066,FUNCTION t110_ins_prepaid()計算apa31f,apa31,apa34f,apa34等值不需要扣掉apa65f,apa65
# Modify.........: No:MOD-B70047 11/07/07 By Dido 多漲期視窗增加 apc14/apc15 顯示
# Modify.........: No:MOD-B70053 11/07/07 By JoHung 修改MOD-B50190，將格式為'XX'的也不納入判斷
# Modify.........: No:MOD-B70086 11/07/11 By lilingyu 取消留置後,apa56的值仍為1
# Modify.........: No:CHI-B70013 11/07/13 By Sarah 預付輸入單身資料時,開放數量欄位可以做調整
# Modify.........: No:MOD-B70119 11/07/14 By Dido 差異分攤若分攤比率金額太小時,差異金額調整在最大筆或依筆數平均分攤
# Modify.........: No:TQC-B70021 11/07/18 By wujie 删除nme时按参数删除tic
# Modify.........: No:MOD-B70180 11/07/19 By Sarah 沖帳DIFF的算法,應該是(apa31+apa32)-apv04
# Modify.........: No:MOD-B70202 11/07/22 By Polly 當異動立帳日期(afa02)時,在 t110_apa13 會重新給予匯率(apa14),請增加判斷若與原匯率不同時,請重新計算本幣金額
# Modify.........: No:MOD-B70251 11/07/27 By Sarah aapt210點選右邊的發票明細程式會當掉
# Modify.........: No:CHI-B60063 11/07/27 By Sarah 確認時若碰到應付金額=0的資料,增加詢問"應付金額為0,是否確定執行確認(Y/N)?"
# Modify.........: No.MOD-B70280 11/07/29 By Polly 相關使用到 aag_file 部分，增加 aagacti = 'Y' 條件
# Modify.........: No:TQC-B70209 11/07/29 By guoch tic_file数据删除时候逻辑错误，进行bug修复
# Modify.........: No.MOD-B80015 11/08/02 By Polly 將IF l_gec05 != 'X' THEN 改為 IF l_gec05 NOT MATCHES '[4X]' THEN
# Modify.........: No:TQC-B80049 11/08/03 By Sarah 修正MOD-B70202,應該判斷單身資料筆數>0才以單身金額回寫單頭
# Modify.........: No:MOD-B80053 11/08/04 By Polly 當aapt210單身有異動(新增、修改、刪除)時就要CALL t110_21_ins2()重新產生apk_file的資料
# Modify.........: No:MOD-B80060 11/08/05 By Polly 修正l_dbs_new所組出來的字串會為「dsds.」造成-206錯誤
# Modify.........: No:TQC-B70131 11/08/05 By Dido aapt160 刪除時若單身無入庫單則不需更新 rvv_file
# Modify.........: No:TQC-B80082 11/08/08 By guoch 修正料号为MISC时，科目二未带出的BUG 
# Modify.........: No:TQC-B80066 11/08/15 By guoch aapt151 剔除L/C类的付款类型
# Modify.........: No.FUN-B80058 11/08/15 By lixia 兩套帳內容修改，新增azf141
# Modify.........: No:MOD-B80144 11/08/15 By lixia 增加nma21檢查
# Modify.........: No:MOD-B80140 11/08/16 By polly 增加判斷，如果入庫未稅金額小於預付未稅金額，則不用做稅額計算
# Modify.........: No:MOD-B80165 11/08/17 By johung 修正單頭借貸方科目為NULL時未清空說明
# Modify.........: No:MOD-B80127 11/08/17 By johung 修正刪除項次後直接輸入採購單號無法帶出資料
# Modify.........: No:MOD-B80193 11/08/22 By Dido 單身異動確認單頭更新有誤 
# Modify.........: No:TQC-B80175 11/08/24 By guoch 在审核时，aag21为Y的时候科目一和科目二控管有差异
# Modify.........: No:MOD-B80277 11/08/24 By Sarah 手動輸入單身入庫單號與入庫項次,出現的錯誤訊息與實際不符
# Modify.........: No:MOD-B80278 11/08/24 By Sarah 修正CHI-B70013,增加的數量檢核需搭配apz61參數的設定
# Modify.........: No:MOD-B80270 11/08/25 By yinhy 為暫估差异diff科目更改默認取值為aps44
# Modify.........: No:MOD-B80300 11/08/27 By Dido 多發票視窗回寫需對留置金額再重新檢核 
# Modify.........: No.MOD-B80345 11/08/31 By Polly after FIELD apb22提示錯誤訊息aec-009後應NEXT FIELD apb22
# Modify.........: No.MOD-B90002 11/09/02 By Polly 修正apc14與apc15沒有寫入沖帳金額
# Modify.........: No.MOD-B90020 11/09/05 By Polly aapt160多帳期應維持一筆，調整判斷apc_file不可修改
# Modify.........: No.MOD-B90056 11/09/08 By Dido aapt120 沖暫估應只能有一筆 
# Modify.........: No.MOD-B90115 11/09/15 By Polly 錯誤訊息aap-945增加檢核判斷
# Modify.........: No.MOD-B90110 11/09/15 By Polly 複製前給予 apa173/aoa174/apa175 為 null
# Modify.........: No.FUN-B90062 11/09/16 By wujie 产生nme_file时同时产生tic_file 
# Modify.........: No.MOD-B90191 11/09/22 By yinhy 當多次點擊衝賬按鈕，衝同一筆單据時，apc13值更新錯誤
# Modify.........: No.MOD-B90164 11/09/23 By Polly 1.調整api05f、回寫aapt260已沖金額計算
# Modify.........: No.MOD-B90213 11/09/26 By yinhy "留置"按钮，选择子賬期留置金額錄入后，apa19不維護留置原因而是取消的,留置金額仍會保存
# Modify.........: No.MOD-B90194 11/09/26 By Polly 增加FUNCTION t110_apb07的l_apb24條件apa00 = '15'
# Modify.........: No.CHI-B80054 11/09/28 By Polly 新增時，CALL s_paydate前面判斷，此欄位的舊值是否為 NULL OR 新舊值不同，才需要重算的方式處理
# Modify.........: No.CHI-B80023 11/09/28 By Polly 取消採購單必要欄位控制
# Modify.........: No.CHI-B90030 11/09/29 By Polly 修正gec05 = '2' AND gec07 = 'Y'時，單頭單身登打金額後，反推未稅金額
# Modify.........: No.MOD-B90246 11/09/29 By Dido 錯誤訊息 aap-890 應增加屬於進貨請款(11)條件
# Modify.........: No.TQC-B90213 11/10/10 By Carrier 单身科目字段apb25/apb251 KEY IN时增加有效否判断
# Modify.........: No.TQC-B90242 11/10/20 By yinhy aapt210點選右邊的“發票明細”資料，發票資料畫面中“離開”功能鈕應該開放
# Modify.........: No.TQC-B90255 11/10/20 By yinhy 查詢時，資料建立者，資料建立部門欄位無法下查詢條件
# Modify.........: No.TQC-BA0050 11/10/20 By yinhy aapt121 剔除L/C类的付款类型
# Modify.........: No.MOD-BA0125 11/10/20 By yinhy 開窗查aapt260扣款折讓暫估資料，應該改為apa00='22'
# Modify.........: No.MOD-BA0132 11/10/19 By Polly aap-273錯誤訊息條件調整
# Modify.........: No.MOD-BA0173 11/10/25 By Polly 判斷apa12為NULL時，才抓取g_apa.apa02
# Modify.........: No.TQC-BA0155 11/10/26 By yinhy 費用暫估單身料件“品名”未依據料號帶出相關內容
# Modify.........: No.MOD-BA0189 11/10/30 By Dido 新增輸入段給予帳別改在 BEFORE INPUT
# Modify.........: No.MOD-BB0020 11/11/04 By yinhy 沖帳時，aapt220回寫已沖金額錯誤
# Modify.........: No.MOD-BB0056 11/11/04 By Polly 調整沖帳時，應控管只可拉小於帳款日的待抵帳款沖銷
# Modify.........: No.MOD-BA0221 11/11/01 By Polly 將使用到apg03條件的SQL拿除
# Modify.........: No.MOD-BB0099 11/11/08 By jt_chen 修改AFTER INPUT中的aap-761錯誤訊息
# Modify.........: No.MOD-BB0106 11/11/10 By Polly 增加傳票還原失敗錯誤訊息aap-929
# Modify.........: No.MOD-BB0144 11/11/11 By yinhy 修改幣別，匯率更新，過匯率欄位後，本幣金額會改變，但確定之後，又變回原來的值
# Modify.........: No.MOD-BB0121 11/11/14 By Polly 大陸地區調整統一編號(apk04)為不必填欄位
# Modify.........: No.MOD-BB0154 11/11/15 By Polly 調整aapt120更改時，apk12、apk13可以修改
# Modify.........: No.MOD-BB0175 11/11/16 By Polly PREPARE sel_rvv38_cs6  改為 rvv_file
# Modify.........: No.MOD-BB0209 11/11/17 By Polly 調整沖帳查詢所串查的SQL
# Modify.........: No.MOD-BB0304 11/11/29 By Dido 送簽中不可修改與單身調整 
# Modify.........: No.MOD-BC0054 11/12/06 By yinhy 更改rvv23回寫值
# Modify.........: No.FUN-BC0031 11/12/08 By yinhy aapt210增加差異處理功能
# Modify.........: No.FUN-BB0001 11/12/12 By pauline 新增rvv22,INSERT/UPDATE rvb22時,同時INSERT/UPDATE rvv22
# Modify.........: No.MOD-BC0153 11/12/15 By Polly 取消作廢排除排除 aapt121/aapt151控卡
# Modify.........: No.MOD-BC0140 11/12/15 By Polly  修正新增時無法放棄，無法跳出迴圈
# Modify.........: No.MOD-BC0102 11/12/15 By Polly 增日控管，aapt150不可使用多借方資料
# Modify.........: No.MOD-BC0194 11/12/20 By Polly 多發票金額維護時，不需重用總額計算出稅額金額
# Modify.........: No.MOD-BC0218 11/12/22 By yinhy 單身部門賦值更改
# Modify.........: No.MOD-BC0238 11/12/26 By Polly 調整複製時，選完日期後才取號存入
# Modify.........: No.MOD-BC0239 11/12/27 By Polly aapt150走預算需單身輸入採購單號後自動帶出部門編號
# Modify.........: No.FUN-910088 11/12/29 By chenjing  增加數量欄位小數取位
# Modify.........: No.MOD-C10043 12/01/09 By Dido 訊息 aap-048 數量異動需還原原值 
# Modify.........: No.MOD-C10062 12/01/10 By Polly 維護多發票時，稅別零稅、格式XX應可不用維護發票，預設空白
# Modify.........: No.MOD-C10063 12/01/10 By Polly 調整取消作廢時，若單身沒有暫估單號會有錯誤息
# Modify.........: No.MOD-C10083 12/01/10 By Polly 修正衝暫估無法跨月問題
# Modify.........: No:FUN-C10039 12/02/02 by Hiko 整批修改資料歸屬設定
# Modify.........: No:MOD-C10214 12/02/02 By Polly 調整順序，先show出錯誤訊息後再RETURN
# Modify.........: No.FUN-C20010 12/02/04 By Abby EF功能調整-客戶不以整張單身資料送簽問題
# Modify.........: No:MOD-C20032 12/02/06 By Polly 將錯誤訊息aap-976改不開窗顯示
# Modify.........: No:MOD-C20051 12/02/08 By Polly apc13(本幣未沖金額)需扣掉apc11(已付金額)
# Modify.........: No:MOD-C20048 12/02/08 By Polly 修正進入多發票段lock cursor但未close cursor
# Modify.........: No:MOD-C20088 12/02/09 By Polly 調整會計科目與部門互相控卡問題
# Modify.........: No.MOD-BB0022 12/02/09 By jt_chen 增加檢核多發票日期及發票資料日期不可為空白的控卡
# Modify.........: No.TQC-C10017 12/02/10 By yinhy 調整apb25，apb26，apb27，apb36，apb31，apb930欄位的值
# Modify.........: No.MOD-C10111 12/02/10 By yinhy 修正作廢rvv88未更新問題
# Modify.........: No.MOD-C20104 12/02/10 By Dido 沖暫估時,重評價金額比較差異,金額調整在最大筆中
# Modify.........: No.TQC-C20183 12/02/15 By chenjing 對數量欄位小數取位的調整
# Modify.........: No:MOD-C20162 12/02/20 By Polly 已核準狀態單據可做日期修正，拿掉mfg3557控卡
# Modify.........: No:CHI-C20003 12/02/21 By Polly 將確認後為自動拋轉傳票移至FOREACH t110_firm1_c3迴圈處理
# Modify.........: No:MOD-C20165 12/02/22 By Polly afa34f和apa31f皆為0時，才不進行判斷分錄底稿
# Modify.........: No:TQC-C20421 12/02/23 By yinhy 待抵單隱藏多賬期按鈕
# Modify.........: No:MOD-C20184 12/02/24 By Polly 調整控卡送簽中不行修改的狀態拿除1的判斷
# Modify.........: No:MOD-C20206 12/02/24 By Polly 修正單頭匯率時需重寫api_file的值
# Modify.........: No:TQC-C20254 12/02/28 By zhangweib 修改拋轉憑證寫法
# Modify.........: No:MOD-C30014 12/03/03 By Dido 差異處理若為沖期初暫估時檢核 apa51 應為 UNAP 
# Modify.........: No:MOD-C30031 12/03/06 by Polly 調整「留置」檢核，應付確認後仍可進行留置
# Modify.........: No:MOD-C30024 12/03/06 by Polly 調整「發票資料」檢核，確認後仍可顯示發票資料
# Modify.........: No:MOD-C30061 12/03/07 By yinhy aapt210已沖金額回寫錯誤
# Modify.........: No:MOD-C30063 12/03/08 By Polly 單別設定為不拋轉傳票時，直接付款後不需產生分錄底稿
# Modify.........: No:MOD-C30689 12/03/14 By minpp 差異處理後應提示一次產生分錄訊息即可
# Modify.........: No:MOD-C30700 12/03/14 By minpp 修改 FUNCTION t110_ins_prepaid/FUNCTION t110_21_ins中apa63='1'
# Modify.........: No:MOD-C30708 12/03/15 By minpp 沖暫估查詢時,將 apa63 MATCHES '[Ss1]' 請改為 apa63 MATCHES '[Ss]'
# Modify.........: No:MOD-C30717 12/03/15 By zhangweib CALL q_apa2時新增參數:請款員工(apa07)
# Modify.........: No:MOD-C30737 12/03/15 By wangrr 調整畫面欄位順序為apb31,apb25,apb26,apb35,apb36
# Modify.........: No:MOD-C30896 12/03/29 By Polly 調整aec-009判斷式，原則上21類與26類別都只能存在一筆
# Modify.........: No:TQC-C30334 12/03/30 By Dido 新增段後需要再重新顯示畫面 
# Modify.........: No:MOD-C30916 12/04/02 By Polly 單頭調整匯率時，多發票也需一併調整
# Modify.........: No:MOD-C40040 12/04/06 By Polly 單身部門開窗改開q_gem，排除已失效的部門
# Modify.........: No:MOD-C40075 12/04/10 By Polly 稅別不同時，需重帶稅率
# Modify.........: No:MOD-C40102 12/04/16 By yinhy 單頭控管金額不可錄入負數
# Modify.........: No.MOD-C40155 12/04/24 By Polly 多借方分攤時，增加帳別條件；aglt1101畫面增加aba00欄位
# Modify.........: No.MOD-C50017 12/05/04 By Polly 調整aap-210訊息控卡位置
# Modify.........: No.MOD-C50035 12/05/08 By Elise 單身與多發票總金額一致
# Modify.........: No:TQC-C50047 12/05/09 By xuxz l_sql調整
# Modify.........: No.MOD-C50094 12/05/14 By Polly FUNCTION t110_apa36取消CALL t110_show動作改直接顯示會科名稱
# Modify.........: No.MOD-C40225 12/05/15 By Elise 並未再次判斷發票聯數，只檢查了採購單號
# Modify.........: No:MOD-C40157 12/05/15 By Elise 應依法人為主,一法人只會有一個財務帳
# Modify.........: No.MOD-C50076 12/05/15 By Polly 增加內含稅2聯式發票控卡
# Modify.........: No:MOD-C50075 12/05/16 By yinhy 單身數量填寫大于暫估單和入庫單，應不可通過apb09欄位
# Modify.........: No:MOD-C50105 12/05/15 By yinhy 調整已審核的多角應付單據分錄底稿不可重新產生
# Modify.........: No:MOD-C50093 12/05/17 By Polly 1.呼叫 aapp400 動作,移到 COMMIT WORK 後處理
#                                                  2.呼叫aap400所產生的傳票編號改用匯總訊息顯示
# Modify.........: No:TQC-C50191 12/05/22 By yinhy 單數數量更改時報錯
# Modify.........: No.TQC-B90062 12/05/22 By Elise 在aapp110拋轉時會因為判斷發票金額為 0 時不寫入apk_file建議將此部分開放寫入
# Modify.........: No.CHI-C30002 12/05/25 By yuhuabao 離開單身時若單身無資料提示是否刪除單頭資料
# Modify.........: No.TQC-C50220 12/05/28 By lujh 已核准的單子要可以費用分攤
# Modify.........: No.MOD-C50237 12/05/30 By yinhy 更改apa02時，增加對單身入庫單日期的判斷
# Modify.........: No.MOD-C50242 12/05/31 By Polly 發票已補滿金額，需將留置金額清空
# Modify.........: No.MOD-C50228 12/05/31 By Polly 調整沖暫估，修改單頭匯率後，產生的DIFF金額異常
# Modify.........: No.MOD-C40218 12/06/01 By Elise FUNCTION t110_ppp 中,AFTER FIELD api26 取消更新 api05f/api05 動作,應以單身為計算為主
# Modify.........: No.MOD-C50243 12/06/01 By Polly g_success = 'Y'時，才做拋轉；取消清訊息功能
# Modify.........: No.MOD-C50241 12/06/01 By Polly 增加暫估數量抓取判斷
# Modify.........: No.MOD-C60039 12/06/07 By Polly 增加tis-022訊息卡關條件
# Modify.........: No.MOD-C50253 12/06/07 By Polly 重算付款日後需再重算票據到期日(apa64)
# Modify.........: No.MOD-C30828 12/06/11 By Polly 多發票內含稅需回推未稅金額
# Modify.........: No.TQC-C60104 12/06/11 By lujh 當廠商簡稱更改后，審核時要提示與分錄底稿中的不一致
# Modify.........: No.MOD-C60132 12/06/19 By Polly 調整沖帳查詢所串查的SQL
# Modify.........: No.CHI-C30107 12/06/21 By yuhuabao  整批修改將確認的詢問窗口放到chk段的前面
# Modify.........: No.MOD-C60168 12/06/21 By Polly 刪除單頭，刪不需進入t110_ins_apc段新增apc_file
# Modify.........: No.MOD-C60190 12/06/21 By Polly 調整多發票未含稅金額計算
# Modify.........: No.MOD-C60195 12/06/21 By Polyy 當天帳款也需沖帳
# Modify.........: No.TQC-C60212 12/06/26 By yuhuabao 修改CHI-C30107 調整的問題
# Modify.........: No.MOD-C60107 12/06/29 By Elise 差異處理
# Modify.........: No.TQC-C60241 12/06/29 By lujh 暫估退貨單aapt260單身料件的數量比退貨單apmt722料件的數量多
# Modify.........: No.TQC-C70027 12/07/04 By lujh 錄入apa06廠商為MISC雜項類的單據，apa07的開窗查詢的內容不對，
#                                                 應該開窗查詢所有未衝銷完畢的待抵預付/待抵溢付的MISC廠商的簡稱，目前系統查詢員工檔q_gen
# Modify.........: No.MOD-C60246 12/07/03 By Polly 反推未稅金額時，需區分台灣與大陸的計算邏輯
# Modify.........: No.MOD-C70057 12/07/06 By Polly 確認檢查段增加aap-029控卡
# Modify.........: No.MOD-C70069 12/07/06 By Polly 類型15/17或預算科目不需將單頭科目清空,預算科目時單身科目需一致
# Modify.........: No.TQC-C70079 12/07/12 By lujh aapt120沖帳時,回寫apa和apc表時要一致
# Modify.........: No.MOD-C70147 12/07/13 By Polly 調整判斷關閉apb35、apb36欄位
# Modify.........: No.MOD-C70161 12.07/16 By Polly 差異處理方式調整如不選擇，將它預設為1待處理狀態
# Modify.........: No.MOD-C70137 12/07/16 By Polly aapt120沖帳寫入apc_file時，沖帳金額應累計
# Modify.........: No.TQC-BA0054 12/07/17 By yinhy aapq231留置原因和留置金額無法顯示
# Modify.........: No.MOD-C70159 12/07/17 By Polly 改用gec05為2/3/5/6檢查字軌
# Modify.........: No.MOD-C70181 12/07/17 By Polly 增加判斷apz14 = 'Y' OR aza21 = 'Y'時apa18為必要欄位
# Modify.........: No.MOD-C70185 12/07/18 By Polly 類型為'1*'開頭，且不為收據或不申報時,才控卡發票是否空白
# Modify.........: No.FUN-C70075 12/07/20 By xuxz 沖暫估時可以直接付款
# Modify.........: No.MOD-C70257 12/07/25 By yinhy 調用發票資料開窗aapt110_g時，加上大陸版判斷
# Modify.........: No.MOD-C70268 12/07/27 By Polly aapt110_n 呼叫子畫面，改用cl_ui_locale()
# Modify.........: No.MOD-C70293 12/07/30 By yinhy 將MOD-C30014的修改增加台灣功能別的判斷，即大陸別不需要判斷UNAP
# Modify.........: No.MOD-C70266 12/07/30 By Polly FUNCTION t110_api_unap 中，有乘算動作都需做取位
# Modify.........: No.FUN-C80018 12/08/06 By minpp 大陸版時如果anmi030沒有維護單身時，簿號和支票號碼可以手動輸入
# Modify.........: No:TQC-C30227 12/08/08 By yinhy 拋轉憑證后報錯信息修改
# Modify.........: No.MOD-C60166 12/08/08 By yinhy 批量確認時更改抓取l_apb10變量
# Modify.........: No.TQC-C80061 12/08/09 By lujh FUNCTION t110_ins_apc(m_apa)內所有用到g_apa的變數,應改用m_apa較為合理
# Modify.........: No:FUN-C30027 12/08/13 By bart 複製後停在新料號畫面
# Modify.........: No:FUN-C70129 12/08/14 By xuxz mod 17--->20
# Modify.........: NO.CHI-C80043 12/08/16 BY yiting MOD-C60039 調整錯誤造成金額倍數
# Modify.........: NO.MOD-C80100 12/08/16 By yinhy 大陸版隱藏多發票開窗后的稅號和廠商名稱
# Modify.........: NO.MOD-C80076 12/08/16 By yinhy 沖帳時，本幣未沖金額應為重評價后的金額
# Modify.........: No.MOD-C80113 12/08/16 By Polly 確認段增加分錄底稿的檢查控卡
# Modify.........: No.FUN-BC0017 12/08/23 By wangwei aapt150單身AFTER FIELD apb24調整不考慮是否含稅
# Modify.........: NO.MOD-C80191 12/08/27 By Elise 多借方在單據確認後，應該要可以開啟畫面查詢
# Modify.........: No.MOD-C80172 12/08/30 By Elise 預付開完了數量，開窗應不能再抓到資料
# Modify.........: No.MOD-C80261 12/09/04 By Polly 調整MOD-B80140增加條件，如有稅額，才需判斷入庫未稅金額小於預附未稅金額做歸零動作
# Modify.........: No.MOD-C90054 12/09/10 By Polly 發票號碼檢查，取消gec08= '22'不檢查，改用gec05為2/3/5/6檢查
# Modify.........: No.TQC-BB0251 12/09/11 By wangwei 增加稅額不可小於0判斷
# Modify.........: No.TQC-BC0115 12/09/11 By wangwei q_apa2更改
# Modify.........: No.TQC-C20027 12/09/12 By wangwei apv05表示本帳單子賬期項次，更改AFTER FIELD apv05判斷
# Modify.........: No.TQC-C90065 12/09/12 By lujh "aap-227"報錯信息有誤
# Modify.........: No.TQC-C90078 12/09/17 By lujh 自動產生分錄時加上apa58=1的判斷
# Modify.........: No:FUN-C90079 12/09/24 By xuxz 大陸版添加審核時沖帳判斷的邏輯
# Modify.........: No:FUN-C90028 12/09/24 By xuxz 大陸版不顯示申報稅號
# Modify.........: No:FUN-C90027 12/09/25 By xuxz aapt220增加apa79栏位并显示
# Modify.........: No:TQC-CA0008 12/10/02 By Belle 修改未稅金額計算方式
# Modify.........: NO.MOD-C80183 12/10/10 By yinhy 不做預算控管時，單身部門應帶採購單頭部門
# Modify.........: No:MOD-CA0073 12/10/11 By yinhy 單頭更改時增加apa56='5'的判斷條件
# Modify.........: No.TQC-C50254 12/10/12 By yinhy 點沖帳按健時選擇'待抵帳款編號’時請帶出項次
# Modify.........: No.FUN-C90127 12/10/10 By zhangwei 沖帳查詢時,查找單號存在於aapt330且類型為E時存在於anmt302的資料
# Modify.........: No.MOD-C90177 12/09/21 By Polly 多發票稅率抓取調整
# Modify.........: No.MOD-C90206 12/09/24 By Polly 調整是否可執行「差異處理」的功能條件
# Modify.........: No:MOD-C90246 12/10/01 By Polly 訊息匯總顯示增加anm-710傳票拋轉成功提示
# Modify.........: No:MOD-CA0038 12/10/04 By Polly 增加專案控管條件來開啟專案代號欄位apb35
# Modify.........: No:MOD-CA0043 12/10/05 By Polly 暫估沒有發票金額故也需重算apb10
# Modify.........: No:MOD-CA0049 12/10/08 By Polly after field apb24段增加處理，若屬於沖暫估且匯率為1時更新api05
# Modify.........: No:MOD-CA0079 12/10/18 By Polly 調整tis-002控卡條件
# Modify.........: No:MOD-CA0106 12/10/18 By Polly 單據複製時，若單別未設定自動編碼，需檢核單據編碼
# Modify.........: No:MOD-CA0147 12/10/23 By Polly 增加控卡，單據類別為15時，科目不可使用STOCK
# Modify.........: No:MOD-CA0167 12/10/24 By Polly 調整apb24金額計算
# Modify.........: No:MOD-CA0194 12/10/29 By Polly aapt150和採購單勾稽時，稅別為內含稅，單身金額需反推
# Modify.........: No:MOD-C90254 12/11/02 By Dido 判斷已有分錄資料時確認段需要檢核分錄 
# Modify.........: No.FUN-CB0019 12/11/06 By Carrier 新增时,若符合条件的单别只有一个,则自动带出此单别,不做开窗挑选
# Modify.........: No.MOD-CB0094 12/11/09 By Polly 採購單單身是可以走無請購單的流程，故拿除pml和pmk條件
# Modify.........: No.MOD-CB0104 12/11/13 By Polly 單據復製時給予應付款日值
# Modify.........: No.MOD-CB0091 12/11/13 By Polly 調整aap-666控卡條件
# Modify.........: No.MOD-CB0128 12/11/14 By Polly 調整判斷產生分錄底稿
# Modify.........: No.TQC-CB0066 12/11/21 By zhangweib t110_invoice_chk 增加傳遞 apk28 參數
#                                                      於 t110_invoice_chk 函式中如 aza26 為 2 時,l_n1/l_n2 增加 apk28 條件
# Modify.........: No.MOD-CB0126 12/11/22 By Polly g_apa80判斷調整 
# Modify.........: No.MOD-CB0107 12/11/23 By jt_chen 修正SQL語法錯誤
# Modify.........: No.CHI-C80041 12/11/26 By bart 取消單頭資料控制
# Modify.........: No.MOD-CC0067 12/12/10 By Polly agl-003訊息改為agl-202
# Modify.........: No.MOD-CC0138 12/12/18 By Polly 調整產生分錄底稿條件
# Modify.........: No.FUN-C80078 12/12/22 By Abby  Service CALL FUNCTION t110_c()調整
# Modify.........: No.MOD-CB0175 12/12/25 By yinhy 沖帳時更改沖帳金額時原幣賬款金額等欄位值會變掉
# Modify.........: No.FUN-CB0054 12/12/25 By wangrr aapt160,aapt260增加"整批刪除"功能
# Modify.........: No.FUN-CB0080 12/12/26 By wangrr 增加"資料清單"頁簽
# Modify.........: No.MOD-CC0287 13/01/02 By Polly 修改段按放棄需還原所以舊值
# Modify.........: No.FUN-CB0094 13/01/04 By wangrr 增加"整批取消確認"
# Modify.........: No.TQC-D10016 13/01/05 By yangtt 錄入時，【稅率】不可以修改 
# Modify.........: No.MOD-CC0194 12/12/21 By Polly 在BEFORE ROW時再判斷一次那些欄位需被開啟或關閉
# Modify.........: No.MOD-D10009 13/01/02 By Polly 類別為12取消多發票與單身檢核控卡
# Modify.........: No.FUN-CB0089 13/01/07 By wangrr 9主機追單到30
# Modify.........: No.FUN-CB0048 13/01/09 By zhangweib 刪除時，若為大陸版，則更新gapi140發票維護作業的帳款編號
# Modify.........: No.MOD-CC0258 13/01/10 By Polly 調整單身料號MISC無法輸入品名；會科無做預算管理，不需輸入預算項目
# Modify.........: No.MOD-D10087 13/01/10 By Polly 此單別需拋轉傳票時，不應顯示原沖帳帳款的傳票編號
# Modify.........: No.MOD-C50008 13/01/14 By Elise 檢核訊息 aap-937 應抓取原採購單的 pmm40t 金額檢核才對
# Modify.........: No:FUN-CC0142 13/01/14 By Nina aapt120來源類型原本3:HRM新流程;4:HRM舊流程，調整為N:HRM新流程;O:HRM舊流程
# Modify.........: No.MOD-CC0238 13/01/17 By Polly 增加控卡廠商/員工資料檢核；調整apa06若為MISC則開啟雜項廠商，EMPL則開啟員工編號
# Modify.........: No.MOD-D10165 13/01/07 By Polly 付款方式非與發票日有關者，不需再重算apa12/apa64值
# Modify.........: No.MOD-CC0070 13/01/17 By Vampire 抓取 apt_file 增加 aptacti 欄位判斷,若為 N 則提示 ams-106 訊息
# Modify.........: No.TQC-CC0035 13/01/22 By zhangweib by zhangweib:修改saapt110.4gl中1.AFTER FIELD apk172報錯後的NEXT FIELD
#                                                                                     2.修改AFTER FIELD apk172、apk07的l_tax小數取位
# Modify.........: No.MOD-D10210 13/01/23 By Polly 多發票本幣金額調整後需DISPLAY，以致可跑AFTER ROW存入資料
# Modify.........: No.CHI-D10057 13/01/31 By Lori 將MOD-CC0238 修改處 控卡的pmc14 = '2' 條件移除
# Modify.........: No.MOD-D20029 13/02/07 By Polly 增對多發票統用pak11條件抓取gec05的值
# Modify.........: No.TQC-D20011 13/02/18 By wangrr aapt160隱藏單身數量合計欄位,資料清單雙擊主畫面不顯示"確定""取消"按鈕
# Modify.........: No:FUN-D20035 13/02/20 By minpp 將作廢功能分成作廢與取消作廢2個action
# Modify.........: No.FUN-CB0056 13/02/21 By minpp 1.aapt150税种预设为aps03,aapt160/260,预设税种为aps02
#..................................................2.aapt121,aapt151时，付款条件（apa11）自动带apz71的值
#................................................. 3.aapt121,还款银行，还款异动码，自动带apz72，apz73
# Modify.........: No.MOD-D20103 13/02/20 By Polly 調整沖帳本幣金額、原幣金幣顯示
# Modify.........: No.MOD-CB0133 13/02/21 By Polly 21類增加aap-052控卡金額不可大於發票金額
# Modify.........: No.MOD-D20112 13/02/21 By Polly 差異處理分攤至單身時，抓取最大金額的項次應該要排除暫估的資料
# Modify.........: No:CHI-C10043 12/02/24 By Polly 週六週日遇到上班日，需增加詢問是否要移至非假日
# Modify.........: No.MOD-D20139 13/02/25 By Polly 增加26類作廢時刪除單身單頭歸零
# Modify.........: No.MOD-D20144 13/02/25 By Polly aapt210的apb21欄位屬於共用性質欄位，可存放退貨單或暫估單號，故取消MOD-BA0125修改
# Modify.........: No.MOD-D20149 13/02/25 By Polly 大陸版已確認帳款需開放可查看多發票
# Modify.........: No.FUN-D20025 13/02/25 By minpp CALL aws_efapp_flowaction 中有的有void 增加undo_void
# Modify.........: No.MOD-D20176 13/02/28 By yinhy 借方科目為UNAP的賬款也應INSERT INTO apf中
# Modify.........: No.MOD-D20174 13/03/01 By Polly 取消針對MISC雜項廠商需存在pmc_file控卡
# Modify.........: No.MOD-D30004 13/03/05 By Polly 票據到期日例假日推算調整
# Modify.........: No.MOD-D30020 13/03/06 By Polly 增加幣別取位
# Modify.........: No.FUN-D10058 13/03/07 By lujh aza70不勾選時，隱藏apa992
# Modify.........: No.FUN-D10057 13/03/07 By wangrr aapt150,aapt151顯示預付待抵單好
# Modify.........: No.MOD-D30078 13/03/11 By Polly 調整16/26類沖暫估apb24金額抓取條件
# Modify.........: No.MOD-D30068 13/03/11 By Polly 調整期初暫估無單身資料無法確認錯誤
# Modify.........: No.MOD-D30074 13/03/11 By Polly 增加地區別判斷檢查發票號碼是否正確
# Modify.........: No.MOD-D30102 13/03/12 By Polly 調整刪除單身後沒有重新更新單頭金額條件
# Modify.........: No.MOD-C90093 13/03/12 By apo 送貨/付款廠商異動時,付款廠商簡稱連動問題處理 
# Modify.........: No.MOD-D30138 13/03/14 By Polly 當aag05為N時，調整apb930、b26的預設值
# Modify.........: No.MOD-D30142 13/03/14 By Polly l_amtarr改用動態陣列
# Modify.........: No.MOD-D30159 13/03/15 By Polly 調整變數給予預設值
# Modify.........: No.MOD-D30189 13/03/22 By Polly aapt160/aapt260 隱藏沖暫估 action
# Modify.........: No:FUN-D30032 13/04/01 By fengrui 修改單身新增時按下放棄鍵未執行AFTER INSERT的問題
# Modify.........: No:MOD-D40014 13/04/02 By Lori 補充多發票資料稅別修改時記錄舊值
# Modify.........: No:MOD-D40013 13/04/02 By Lori 單身若有輸入採購項次時應以此筆項次檢查,若沒問題的話再檢查整張採購單的金額
# Modify.........: No.MOD-C90100 13/04/03 By apo 部分沖帳時,最後一次沖帳應以剩餘的本幣金額為主
# Modify.........: No.MOD-CB0096 13/04/03 By apo aapt160控卡不可以費用暫估與入庫暫估打在同一筆
# Modify.........: No.MOD-CB0097 13/04/03 By apo 稅額為零稅時，不需重新計算
# Modify.........: No.MOD-C80066 13/04/08 By apo 輸入完多發票回寫單頭未稅金額欄位需加上預付金額
# Modify.........: No:TQC-D40025 13/04/12 By xumm 修改FUN-D30032遗留问题 
# Modify.........: No:MOD-D40097 13/04/16 By Lori 折讓性質為3.扣款折讓時,若單身的退貨單項次的退貨數量>0需控卡
# Modify.........: No:MOD-D40150 13/04/22 By Polly 確認後重新show畫面
# Modify.........: No.FUN-D40089 13/04/23 By lujh 批次審核的報錯,加show單據編號
# Modify.........: No:MOD-D50011 13/06/05 By yinhy 大陸版檢查發票號碼是否重複
# Modify.........: No:FUN-D70028 13/07/04 By zhangweib 新增aapt140客戶費用報銷作業
# Modify.........: No:MOD-D70039 13/07/08 By yinhy 調整待抵單金額回寫
# Modify.........: No:MOD-D70065 13/07/10 By yinhy 增加預付金額與採購單勾稽段判斷
# Modify.........: No:yinhy130729 13/07/29 By yinhy 未付金额减掉汇兑损益
# Modify.........: No:MOD-D80028 13/08/05 By yinhy 刪除成功應做commit work
# Modify.........: No:MOD-D80030 13/08/05 By yinhy 單別自動拋磚憑證勾選，批量審核時傳參錯誤
# Modify.........: No:TQC-D80019 13/08/12 By lixh1 調整FUNCTION t110_apb09_check(p_apa32f,p_apb24t,p_pmc913)參數位置
# Modify.........: No:FUN-D80031 13/08/12 By yuhuabao aapt140增加按鈕生成待抵帳扣費用單
# Modify.........: No:FUN-D80049 13/08/15 By yuhuabao aapt150和aapq230的開窗可選為供應商或者客戶
# Modify.........: No:FUN-D80071 13/08/19 By wangrr aapt121"還款資料"頁簽中"還款銀行""還款異動碼"增加說明欄位
# Modify.........: No.TQC-D90007 13/09/09 By fengrui aapt260確認函數添加aap-939檢查
# Modify.........: No.cjy20130930 13/09/30 By yuhuabao  票据系统已经关帐不可直接付款
# Modify.........: No:FUN-DA0051 13/10/12 By yuhuabao apa05及apa06的开窗逻辑修改:1>非大陆版 只开窗厂商 2>大陆版按照参数apz74
#                                                     (是否允许客户立账)判断 注:aapt140只开客户,i:apz74= 'Y' 开窗 客户+厂商
#                                                     ii:apz74= 'N' 开窗 厂商
# Modify.........: NO:MOD-DB0017 13/11/04 By yinhy 關帳日期報錯條件修改
# Modify.........: No:FUN-DA0054 13/12/12 By fengmy 原標記cjy20130930,30更新9主機,票据系统已经关帐不可直接付款
# Modify.........: No:yinhy131213 13/12/13 BY yinhy 增加檢核如果g_apa.apa01為單別不可INSERT到apc_file中
# Modify.........: No:yinhy140210 14/02/10 By yinhy aapt150預付單身單價抓含稅單價
# Modify.........: No:yinhy140217 14/02/10 By yinhy 修改t110_kkk_c0中apa08条件
# Modify.........: No:yinhy140313 14/03/13 By yinhy aapt110無單身更改匯率本幣金額也應一併變動
# Modify.........: No:CHI-E30030 14/03/20 By yihsuan 確認段/取消確認段回寫 aapt160 的已付金額比照回寫單頭方式處理
# Modify.........: No:yinhy140528 14/05/28 By yinhy 折讓類型默認帶出付款日和票到期日為當天，允許票期為0
# Modify.........: NO:MOD-E70117 14/07/23 By qiull 修改付款日期之後,tic現金流量明細重複
# Modify.........: No:MOD-E70145 14/07/29 By qiull 差異調整-衝期初暫估,沒有產生apf_file
# Modify.........: No:qiull140806 14/08/06 By qiull 取消分批預付時扣除金額計算(追單MOD-D50266)
# Modify.........: No:MOD-F30090 15/03/17 By doris t110_api_unap/t110_ppp 段沖暫估 api40應為 aapt160/aapt260單身的項次(apb02) 
DATABASE ds
 
GLOBALS "../../config/top.global"
GLOBALS "../4gl/saapt110.global"   #FUN-C80078 

#FUN-C80078 mark str---
#將變數挪至saapt110.global
#模組變數(Module Variables)
#DEFINE g_aps           RECORD LIKE aps_file.*,
#       g_apa           RECORD LIKE apa_file.*,       #
#       g_apv           RECORD LIKE apv_file.*,       #
#       g_apv_t         RECORD LIKE apv_file.*,       #
#       g_apx           RECORD LIKE apx_file.*,       #No.FUN-690080
#       g_apx_t         RECORD LIKE apx_file.*,       #No.FUN-690080
#       m_apa           RECORD LIKE apa_file.*,       #
#       g_apa80         LIKE apa_file.apa80, #FUN-C70075 
#       gs_cnt          LIKE type_file.num10,#FUN-C70075
#       gs_cnt2         LIKE type_file.num10,#FUN-C70075
#       m_aph           RECORD LIKE aph_file.*,
#       g_apa_t         RECORD LIKE apa_file.*,       #
#       g_apa_o         RECORD LIKE apa_file.*,       #
#       g_apa01_t       LIKE apa_file.apa01,   #AP #     (舊值)
#       g_apb_sarrno    LIKE type_file.num5,      # No.FUN-690028 SMALLINT,              #螢幕變數的個數
#       g_apb           DYNAMIC ARRAY OF RECORD   #程式變數(Program Variables)
#              apb02      LIKE apb_file.apb02,
#              apb33      LIKE apb_file.apb33, #No.FUN-690080
#              apb11      LIKE apb_file.apb11,
#              apb29      LIKE apb_file.apb29,
#              apb37      LIKE apb_file.apb37, #FUN-9A0093
#              apb21      LIKE apb_file.apb21,
#              apb22      LIKE apb_file.apb22,
#              apb34      LIKE apb_file.apb34,   #FUN-680110 add  #No.TQC-7B0083
#              apb01_unap LIKE apb_file.apb01,   #FUN-680110 add
#              apb06      LIKE apb_file.apb06,
#              apb07      LIKE apb_file.apb07,
#              apb12      LIKE apb_file.apb12,
#              apb27      LIKE apb_file.apb27,
#              apb09      LIKE apb_file.apb09,
#              apb28      LIKE apb_file.apb28,
#              #apb35      LIKE apb_file.apb35, #MOD-C30737 mark-- 
#              #apb36      LIKE apb_file.apb36, #MOD-C30737 mark--
#              apb31      LIKE apb_file.apb31, 
#              apb32      LIKE apb_file.apb32, #No.FUN-690080
#              b32        LIKE gen_file.gen02,  #FUN-990025 add  
#              apb25      LIKE apb_file.apb25,
#              b25        LIKE aag_file.aag02,  #FUN-710078 add
#              apb251     LIKE apb_file.apb251, #FUN-680029
#              b251       LIKE aag_file.aag02,  #FUN-710078 add
#              apb26      LIKE apb_file.apb26,
#              b26        LIKE gem_file.gem02,  #FUN-710078 add
#              apb35      LIKE apb_file.apb35,  #MOD-C30737 add
#              apb36      LIKE apb_file.apb36,  #MOD-C30737 add  
#              apb930     LIKE apb_file.apb930, #FUN-670064
#              gem02c     LIKE gem_file.gem02,  #FUN-670064
#              apb23      LIKE apb_file.apb23,
#              apb24      LIKE apb_file.apb24,
#              apb08      LIKE apb_file.apb08,
#              apb10      LIKE apb_file.apb10,
#              apbud01    LIKE apb_file.apbud01,
#              apbud02    LIKE apb_file.apbud02,
#              apbud03    LIKE apb_file.apbud03,
#              apbud04    LIKE apb_file.apbud04,
#              apbud05    LIKE apb_file.apbud05,
#              apbud06    LIKE apb_file.apbud06,
#              apbud07    LIKE apb_file.apbud07,
#              apbud08    LIKE apb_file.apbud08,
#              apbud09    LIKE apb_file.apbud09,
#              apbud10    LIKE apb_file.apbud10,
#              apbud11    LIKE apb_file.apbud11,
#              apbud12    LIKE apb_file.apbud12,
#              apbud13    LIKE apb_file.apbud13,
#              apbud14    LIKE apb_file.apbud14,
#              apbud15    LIKE apb_file.apbud15
#                       END RECORD,
#       g_apb_t         RECORD                 #程式變數 (舊值)
#              apb02      LIKE apb_file.apb02,
#              apb33      LIKE apb_file.apb33, #No.FUN-690080
#              apb11      LIKE apb_file.apb11,
#              apb29      LIKE apb_file.apb29,
#              apb37      LIKE apb_file.apb37, #FUN-9A0093
#              apb21      LIKE apb_file.apb21,
#              apb22      LIKE apb_file.apb22,
#              apb34      LIKE apb_file.apb34,   #FUN-680110 add  #No.TQC-7B0083
#              apb01_unap LIKE apb_file.apb01,   #FUN-680110 add
#              apb06      LIKE apb_file.apb06,
#              apb07      LIKE apb_file.apb07,
#              apb12      LIKE apb_file.apb12,
#              apb27      LIKE apb_file.apb27,
#              apb09      LIKE apb_file.apb09,
#              apb28      LIKE apb_file.apb28,
#              #apb35      LIKE apb_file.apb35, #MOD-C30737 mark--
#              #apb36      LIKE apb_file.apb36, #MOD-C30737 mark--
#              apb31      LIKE apb_file.apb31, 
#              apb32      LIKE apb_file.apb32,    #No.FUN-690080
#              b32        LIKE gen_file.gen02,    #FUN-990025 add   
#              apb25      LIKE apb_file.apb25,
#              b25        LIKE aag_file.aag02,    #FUN-710078 add
#              apb251     LIKE apb_file.apb251,   #FUN-680029
#              b251       LIKE aag_file.aag02,    #FUN-710078 add
#              apb26      LIKE apb_file.apb26,
#              b26        LIKE gem_file.gem02,    #FUN-710078 add
#              apb35      LIKE apb_file.apb35,  #MOD-C30737 add
#              apb36      LIKE apb_file.apb36,  #MOD-C30737 add
#              apb930     LIKE apb_file.apb930,   #FUN-670064
#              gem02c     LIKE gem_file.gem02,    #FUN-670064
#              apb23      LIKE apb_file.apb23,
#              apb24      LIKE apb_file.apb24,
#              apb08      LIKE apb_file.apb08,
#              apb10      LIKE apb_file.apb10,
#              apbud01    LIKE apb_file.apbud01,
#              apbud02    LIKE apb_file.apbud02,
#              apbud03    LIKE apb_file.apbud03,
#              apbud04    LIKE apb_file.apbud04,
#              apbud05    LIKE apb_file.apbud05,
#              apbud06    LIKE apb_file.apbud06,
#              apbud07    LIKE apb_file.apbud07,
#              apbud08    LIKE apb_file.apbud08,
#              apbud09    LIKE apb_file.apbud09,
#              apbud10    LIKE apb_file.apbud10,
#              apbud11    LIKE apb_file.apbud11,
#              apbud12    LIKE apb_file.apbud12,
#              apbud13    LIKE apb_file.apbud13,
#              apbud14    LIKE apb_file.apbud14,
#              apbud15    LIKE apb_file.apbud15
#                       END RECORD,
#       g_apk1          DYNAMIC ARRAY OF RECORD   #MOD-960128 add
#             #apk02      LIKE apk_file.apk02,    #MOD-950226 add   #MOD-B70251 mark
#              apk11      LIKE apk_file.apk11,
#              apk171     LIKE apk_file.apk171,
#              apk17      LIKE apk_file.apk17,
#              apk172     LIKE apk_file.apk172,
#              apk05      LIKE apk_file.apk05,    #No:8511 No:8654
#              apk03      LIKE apk_file.apk03,
#              apk04      LIKE apk_file.apk04,
#              apk12      LIKE apk_file.apk12,
#              apk13      LIKE apk_file.apk13,
#              apk08f     LIKE apk_file.apk08f,
#              apk07f     LIKE apk_file.apk07f,
#              apk06f     LIKE apk_file.apk06f,
#              apk08      LIKE apk_file.apk08,
#              apk07      LIKE apk_file.apk07,
#              apk06      LIKE apk_file.apk06,
#              apk32      LIKE apk_file.apk32     #FUN-970108 add
#                       END RECORD,
#       g_apk           DYNAMIC ARRAY OF RECORD
#              apk02      LIKE apk_file.apk02,    #MOD-950226 add
#              apk11      LIKE apk_file.apk11,
#              apk171     LIKE apk_file.apk171,
#              apk17      LIKE apk_file.apk17,
#              apk172     LIKE apk_file.apk172,
#              apk05      LIKE apk_file.apk05,    #No:8511 No:8654
#              apk03      LIKE apk_file.apk03,
#              apk04      LIKE apk_file.apk04,
#              apk12      LIKE apk_file.apk12,
#              apk13      LIKE apk_file.apk13,
#              apk08f     LIKE apk_file.apk08f,
#              apk07f     LIKE apk_file.apk07f,
#              apk06f     LIKE apk_file.apk06f,
#              apk08      LIKE apk_file.apk08,
#              apk07      LIKE apk_file.apk07,
#              apk06      LIKE apk_file.apk06,
#              apk32      LIKE apk_file.apk32     #FUN-970108 add
##             apkoriu    LIKE apk_file.apkoriu,  #No.FUN-980030 10/01/04   #No.TQC-A30087
##             apkorig    LIKE apk_file.apkorig   #No.FUN-980030 10/01/04    #No.TQC-A30087
#                       END RECORD,
#       g_apk_t         RECORD
#              apk02      LIKE apk_file.apk02,    #MOD-950226 add
#              apk11      LIKE apk_file.apk11,
#              apk171     LIKE apk_file.apk171,
#              apk17      LIKE apk_file.apk17,
#              apk172     LIKE apk_file.apk172,
#              apk05      LIKE apk_file.apk05,    
#              apk03      LIKE apk_file.apk03,
#              apk04      LIKE apk_file.apk04,
#              apk12      LIKE apk_file.apk12,
#              apk13      LIKE apk_file.apk13,
#              apk08f     LIKE apk_file.apk08f,
#              apk07f     LIKE apk_file.apk07f,
#              apk06f     LIKE apk_file.apk06f,
#              apk08      LIKE apk_file.apk08,
#              apk07      LIKE apk_file.apk07,
#              apk06      LIKE apk_file.apk06,
#              apk32      LIKE apk_file.apk32     #FUN-970108 add
##             apkoriu    LIKE apk_file.apkoriu,  #No.FUN-980030 10/01/04  #No.TQC-A30087
##             apkorig    LIKE apk_file.apkorig   #No.FUN-980030 10/01/04  #No.TQC-A30087
#                       END RECORD,
#       g_apk_c         DYNAMIC ARRAY OF RECORD
#              apk02      LIKE apk_file.apk02,
#              apk11      LIKE apk_file.apk11, #CHI-B10017 add
#              apk172     LIKE apk_file.apk172,#CHI-B10017 add
#              apk28      LIKE apk_file.apk28,
#              apk03      LIKE apk_file.apk03,
#              apk04      LIKE apk_file.apk04,
#              apl02      LIKE apl_file.apl02,
#              apk05      LIKE apk_file.apk05,
#              apk29      LIKE apk_file.apk29,
#              apk08f     LIKE apk_file.apk08f,
#              apk08      LIKE apk_file.apk08,
#              apk07f     LIKE apk_file.apk07f,
#              apk07      LIKE apk_file.apk07,
#              apk06f     LIKE apk_file.apk06f,
#              apk06      LIKE apk_file.apk06,
#              apk171     LIKE apk_file.apk171,
#             #apk172     LIKE apk_file.apk172, #CHI-B10017 mark
#              apk30      LIKE apk_file.apk30,
#              apk32      LIKE apk_file.apk32    #FUN-970108 add
#                       END RECORD,
#       g_apk_c_t       RECORD
#              apk02      LIKE apk_file.apk02,
#              apk11      LIKE apk_file.apk11, #CHI-B10017 add
#              apk172     LIKE apk_file.apk172,#CHI-B10017 add
#              apk28      LIKE apk_file.apk28,
#              apk03      LIKE apk_file.apk03,
#              apk04      LIKE apk_file.apk04,
#              apl02      LIKE apl_file.apl02,
#              apk05      LIKE apk_file.apk05,
#              apk29      LIKE apk_file.apk29,               
#              apk08f     LIKE apk_file.apk08f,
#              apk08      LIKE apk_file.apk08,
#              apk07f     LIKE apk_file.apk07f,
#              apk07      LIKE apk_file.apk07,
#              apk06f     LIKE apk_file.apk06f,
#              apk06      LIKE apk_file.apk06,                  
#              apk171     LIKE apk_file.apk171,
#             #apk172     LIKE apk_file.apk172, #CHI-B10017 mark
#              apk30      LIKE apk_file.apk30,
#              apk32      LIKE apk_file.apk32    #FUN-970108 add
#                       END RECORD,
#       g_apb04         LIKE apb_file.apb04,
#       g_apb05         LIKE apb_file.apb05,
#       g_apb30         LIKE apb_file.apb30,
#       g_apb04_t       LIKE apb_file.apb04,
#       g_apb05_t       LIKE apb_file.apb05,
#       g_apb09         LIKE apb_file.apb09,                  #MOD-A90146
#       g_apb10         LIKE apb_file.apb10,
#       g_apb24         LIKE apb_file.apb24,                  #MOD-A90146
#       g_aba           RECORD
#              aba13      LIKE aba_file.aba13,  #FUN-4B0079
#              aba14      LIKE aba_file.aba14,  #FUN-4B0079
#              aba15      LIKE aba_file.aba15,  #FUN-4B0079
#              aba00      LIKE aba_file.aba00   #MOD-C40155 add
#                       END RECORD,
#       g_api           DYNAMIC ARRAY OF RECORD
#              api04      LIKE api_file.api04,
#              aag02      LIKE aag_file.aag02,
#              api041     LIKE api_file.api041,     #No.FUN-680029
#              aag021     LIKE aag_file.aag02,      #No.FUN-680029
#              api07      LIKE api_file.api07,
#              api930     LIKE api_file.api930,     #CHI-8C0005 add
#              api06      LIKE api_file.api06,
#              api05f     LIKE api_file.api05f,
#              api05      LIKE api_file.api05,
#              api21      LIKE api_file.api21,
#              api22      LIKE api_file.api22,
#              api23      LIKE api_file.api23,
#              api24      LIKE api_file.api24,
#              api31      LIKE api_file.api31,  #異動碼5
#              api32      LIKE api_file.api32,  #異動碼6
#              api33      LIKE api_file.api33,  #異動碼7
#              api34      LIKE api_file.api34,  #異動碼8
#              api37      LIKE api_file.api37,  #關係人異動碼
#              api26      LIKE api_file.api26,
#              api35      LIKE api_file.api35,  #異動碼9(WBS)
#              api36      LIKE api_file.api36   #異動碼10(費用原因)
#                       END RECORD,
#       g_wc,g_wc2      STRING,  #No.FUN-580092 HCN
#       g_sql           STRING,  #No.FUN-580092 HCN
#       g_rec_b         LIKE type_file.num5,                #單身筆數  #No.FUN-690028 SMALLINT
#       g_buf           LIKE type_file.chr1000,             #  #No.FUN-690028 VARCHAR(78)
#       g_aptype        LIKE apa_file.apa00, #帳款種類  #FUN-660117
#       g_cal_code      LIKE type_file.chr2,        # No.FUN-690028 VARCHAR(2),               #Calendar code
##      g_qty1,g_qty2,g_qty3     LIKE ima_file.ima26,      # No.FUN-690028 DEC(15,3),  #FUN-4B0079  #FUN-A20044
#       g_qty1,g_qty2,g_qty3     LIKE type_file.num15_3,   # No.FUN-A20044
##      g_qty5          LIKE ima_file.ima26,        #No.TQC-7B0083          #FUN-A20044
#       g_qty5          LIKE type_file.num15_3,     #No.FUN-A20044
#       g_amt1f,g_amt2f,g_amt3f,g_amt4f,g_amt5f,g_amt6f  LIKE type_file.num20_6,    #MOD-820008 #MOD-C30061 add amt6f
#       g_amt1,g_amt2,g_amt3,g_amt4,g_amt5,g_amt6      LIKE type_file.num20_6,     #MOD-820008  #MOD-C30061 add amt6
#       g_tax           LIKE type_file.num20_6,     # No.FUN-690028 DEC(20,6),  #FUN-4B0079
#       g_gec05         LIKE gec_file.gec05,      #No.MOD-530687
#       g_pma11         LIKE pma_file.pma11,
#       g_rvb10         LIKE rvb_file.rvb10,
#       g_statu         LIKE type_file.chr1,        # No.FUN-690028 VARCHAR(01),              #是否從新賦予等級
#       g_flag          LIKE type_file.chr1,        #控制請款折讓是否要重新刪除再產生  #No.FUN-690028 VARCHAR(1)
#       g_n             LIKE type_file.num10,       # No.FUN-690028 INTEGER,
#       g_no            LIKE apb_file.apb12,
#       g_dbs_nm        LIKE type_file.chr21,       # No.FUN-690028 VARCHAR(21),
#       g_dbs_gl        LIKE type_file.chr21,       # No.FUN-690028 VARCHAR(21),
#       g_plant_nm      LIKE type_file.chr21,       # No.FUN-A50102 VARCHAR(21),
#       g_plant_gl      LIKE type_file.chr21,       # No.FUN-A50102 VARCHAR(21),
#       l_ac            LIKE type_file.num5,                #目前處理的ARRAY CNT  #No.FUN-690028 SMALLINT
#       g_rvv38_n       LIKE rvv_file.rvv38,
#       g_chr2          LIKE type_file.chr1,    #No.FUN-690028 VARCHAR(1)
#       g_chr3          LIKE type_file.chr1                  #FUN-580114  #No.FUN-690028 VARCHAR(1)
#DEFINE g_gem02         LIKE gem_file.gem02    #FUN-710078 add
#DEFINE g_a51           LIKE aag_file.aag02    #FUN-710078 add
#DEFINE g_a52           LIKE aag_file.aag02    #FUN-710078 add
#DEFINE g_a54           LIKE aag_file.aag02    #FUN-710078 add
#DEFINE g_a511          LIKE aag_file.aag02    #FUN-710078 add
#DEFINE g_a521          LIKE aag_file.aag02    #FUN-710078 add
#DEFINE g_a541          LIKE aag_file.aag02    #FUN-710078 add
#DEFINE g_net           LIKE apv_file.apv04    #MOD-590312
#DEFINE g_laststage     LIKE type_file.chr1    # No.FUN-690028 VARCHAR(1)                #FUN-580114
#DEFINE g_cmd           LIKE type_file.chr1000    #No.FUN-690028 VARCHAR(500)
#DEFINE g_ape           DYNAMIC ARRAY OF RECORD   #No.TQC-870040 add
#              no         LIKE apv_file.apv01,        # No.FUN-690028 VARCHAR(16),  #FUN-580012
#              sq         LIKE type_file.num5,        # No.FUN-690028 SMALLINT,
#              amtf       LIKE type_file.num20_6,     # No.FUN-690028 DEC(20,6),  #FUN-4B0079
#              amt        LIKE type_file.num20_6,     # No.FUN-690028 DEC(20,6),  #FUN-4B0079
#              nmd02      LIKE nmd_file.nmd02,        # No.FUN-690028 VARCHAR(10),
#              nmd05      LIKE type_file.dat,         # No.FUN-690028 DATE,
#              nmd04      LIKE type_file.num10        # No.FUN-690028 INTEGER
#                       END RECORD
#DEFINE g_hold          LIKE type_file.chr1       #用來標記是單頭留置還是子帳期單筆留置，當g_hlod='2'時為子帳期單筆留置   #No.MOD-780152
#DEFINE g_forupd_sql    STRING   #SELECT ... FOR UPDATE SQL
#DEFINE g_before_input_done  LIKE type_file.num5    #No.FUN-690028 SMALLINT
#DEFINE g_chr           LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
#DEFINE g_cnt           LIKE type_file.num10   #No.FUN-690028 INTEGER
#DEFINE g_i             LIKE type_file.num5     #count/index for any purpose  #No.FUN-690028 SMALLINT
#DEFINE g_msg           LIKE type_file.chr1000 #No.FUN-690028 VARCHAR(72)
#DEFINE g_str           STRING     #No.FUN-670060
#DEFINE g_wc_gl         STRING     #No.FUN-670060
#DEFINE g_sn            LIKE type_file.chr1    #TQC-770027
#DEFINE g_row_count     LIKE type_file.num10   #No.FUN-690028 INTEGER
#DEFINE g_curs_index    LIKE type_file.num10   #No.FUN-690028 INTEGER
#DEFINE g_jump          LIKE type_file.num10   #No.FUN-690028 INTEGER
#DEFINE g_no_ask        LIKE type_file.num5    #No.FUN-690028 SMALLINT
#DEFINE g_argv1         LIKE apa_file.apa01   # No.FUN-690028 VARCHAR(16)         #No.FUN-630010
#DEFINE g_argv2         STRING           #No.FUN-630010
#DEFINE g_argv3         STRING           #MOD-650085
#DEFINE g_argv4         STRING           #FUN-880095 
#DEFINE i               LIKE type_file.num5      #No.FUN-690028 SMALLINT
#DEFINE g_apc           DYNAMIC ARRAY OF RECORD
#              apc02       LIKE apc_file.apc02,
#              apc03       LIKE apc_file.apc03,
#              apc03_pma02 LIKE pma_file.pma02,
#              apc04       LIKE apc_file.apc04,
#              apc05       LIKE apc_file.apc05,
#              apc06       LIKE apc_file.apc06,
#              apc07       LIKE apc_file.apc07,
#              apc08       LIKE apc_file.apc08,
#              apc09       LIKE apc_file.apc09,
#              apc10       LIKE apc_file.apc10,
#              apc11       LIKE apc_file.apc11,
#              apc16       LIKE apc_file.apc16,
#              apc12       LIKE apc_file.apc12, 
#              apc14       LIKE apc_file.apc14,    #MOD-B70047  
#              apc15       LIKE apc_file.apc15     #MOD-B70047 
#                       END RECORD
#DEFINE g_apc_t         RECORD
#              apc02       LIKE apc_file.apc02,
#              apc03       LIKE apc_file.apc03,
#              apc03_pma02 LIKE pma_file.pma02,
#              apc04       LIKE apc_file.apc04,
#              apc05       LIKE apc_file.apc05,
#              apc06       LIKE apc_file.apc06,
#              apc07       LIKE apc_file.apc07,
#              apc08       LIKE apc_file.apc08,
#              apc09       LIKE apc_file.apc09,
#              apc10       LIKE apc_file.apc10,
#              apc11       LIKE apc_file.apc11,
#              apc16       LIKE apc_file.apc16,
#              apc12       LIKE apc_file.apc12, 
#              apc14       LIKE apc_file.apc14,    #MOD-B70047  
#              apc15       LIKE apc_file.apc15     #MOD-B70047 
#                       END RECORD
#DEFINE g_azp03         LIKE azp_file.azp03    #No.FUN-730064                                                                    
#DEFINE g_bookno1       LIKE aza_file.aza81    #No.FUN-730064                                                                    
#DEFINE g_bookno2       LIKE aza_file.aza82    #No.FUN-730064                                                                    
#DEFINE g_bookno        LIKE aag_file.aag00    #No.FUN-730064                                                                    
#DEFINE g_dbsm          LIKE type_file.chr21   #No.FUN-730064                                                                    
#DEFINE g_plantm        LIKE type_file.chr10   #No.FUN-980020
#DEFINE g_db_type       LIKE type_file.chr3    #No.FUN-730064
#DEFINE g_db1           LIKE type_file.chr21   #No.FUN-730064
#DEFINE g_flag1         LIKE type_file.chr1    #No.FUN-730064
#DEFINE g_fac_type      STRING                 #No.MOD-840179 add 傳入q_pmm9的參數
#DEFINE g_sn1           LIKE type_file.chr1    #FUN-880113
#DEFINE g_chr_1         LIKE type_file.chr1    #MOD-950158
#DEFINE g_chr_2         LIKE type_file.chr1    #MOD-950158
#DEFINE g_chr_3         LIKE type_file.chr1    #MOD-950158
#DEFINE g_pmc903        LIKE pmc_file.pmc903   #FUN-950053  
#DEFINE li_dbs          LIKE type_file.chr21   #FUN-9A0093 
#DEFINE l_sql           LIKE type_file.chr1000 #FUN-9A0093
#DEFINE l_apz59         LIKE apz_file.apz59    #TQC-A40106
#DEFINE g_modify_date   LIKE type_file.chr1    #用來標記是否由日期修改進入多帳期維護 #CHI-A50042 add
#DEFINE m_plant         LIKE azp_file.azp01    #FUN-A50102
#DEFINE g_pass          LIKE type_file.chr1    #No.FUN-B10050
#DEFINE g_flag2         LIKE type_file.chr1        #CHI-B60063 add
#DEFINE g_apa14_t       LIKE apa_file.apa14        #MOD-BB014:
#DEFINE g_apb28_t       LIKE apb_file.apb28    #FUN-910088--add--
#FUN-C80078 mark end---

#FUN-C80078 add str---
#
#作用:lock cursor
#回傳值:無
#
FUNCTION t110_lock_cl()
   DEFINE l_forupd_sql STRING

   LET g_forupd_sql = "SELECT * FROM apa_file WHERE apa01 = ? FOR UPDATE"
   LET g_forupd_sql = cl_forupd_sql(g_forupd_sql)
   DECLARE t110_cl CURSOR FROM g_forupd_sql

END FUNCTION
#FUN-C80078 add end---

FUNCTION t110(p_aptype,p_argv1,p_argv2,p_argv3,p_argv4)  #No.FUN-630010   #FUN-880095 Add p_argv3,p_argv4  
   DEFINE p_aptype       LIKE apa_file.apa00    #No.FUN-690028  VARCHAR(2)
   DEFINE p_argv1        LIKE apa_file.apa01    #No.FUN-690028  VARCHAR(16)         #No.FUN-630010
   DEFINE p_argv2        STRING                 #No.FUN-630010
   DEFINE p_argv3        STRING                 #No.FUN-880095  
   DEFINE p_argv4        STRING                 #No.FUN-880095
 
   WHENEVER ERROR CALL cl_err_msg_log
 
   LET g_sn = 'n'       #TQC-770027
   LET g_sn1 = 'N'      #FUN-880113
   LET g_argv1_apa01= p_argv1          #No.FUN-630010      #FUN-C80078 g_argv1-->g_argv1_apa01
   LET g_argv2_str= p_argv2                #No.FUN-630010  #FUN-C80078 g_argv2-->g_argv2_str
   LET g_argv3 = ARG_VAL(3)   #MOD-650085
   LET g_argv4= p_argv4                #No.FUN-880095
   LET l_apz59 = g_apz.apz59           #TQC-A40106
 
   IF fgl_getenv('EASYFLOW') = "1" THEN
      LET g_argv1_apa01 = aws_efapp_wsk(1)   #參數:key-1  #FUN-C80078 g_argv1-->g_argv1_apa01
   END IF
   IF cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
      LET g_argv1_apa01=g_dash CLIPPED  #FUN-C80078 g_argv1-->g_argv1_apa01
      LET g_dash = NULL
   END IF
 
   LET g_plant_new=g_apz.apz04p
   CALL s_getdbs()
   LET g_dbs_nm=g_dbs_new
   LET g_plant_nm = g_plant_new  #FUN-A50102
   IF cl_null(g_dbs_nm) THEN
      LET g_dbs_nm = NULL
      LET g_plant_nm = NULL  #FUN-A50102
   END IF
 
   LET g_plant_new=g_apz.apz02p
   CALL s_getdbs()
   LET g_dbs_gl=g_dbs_new
   LET g_plant_gl = g_plant_new  #FUN-A50102
   IF cl_null(g_dbs_gl) THEN
      LET g_dbs_gl = NULL
      LET g_plant_gl = NULL  #FUN-A50102
   END IF
   
   #LET g_sql = "SELECT aaz72  FROM ",g_dbs_gl CLIPPED,"aaz_file ",
   LET g_sql = "SELECT aaz72  FROM ",cl_get_target_table(g_plant_gl,'aaz_file'), #FUN-A50102
               " WHERE aaz00 = '0' "
 	 CALL cl_replace_sqldb(g_sql) RETURNING g_sql        #FUN-920032
     CALL cl_parse_qry_sql(g_sql,g_plant_gl) RETURNING g_sql #FUN-A50102
   PREPARE t110_get_aaz72_p FROM g_sql
   DECLARE t110_get_aaz72_c CURSOR FOR t110_get_aaz72_p
   OPEN t110_get_aaz72_c
   FETCH t110_get_aaz72_c INTO g_aaz.aaz72
   LET g_wc=' 1=1'
 
  #FUN-C80078 mark str---
  #LET g_forupd_sql = "SELECT * FROM apa_file WHERE apa01 = ? FOR UPDATE"
  #LET g_forupd_sql = cl_forupd_sql(g_forupd_sql)
  #DECLARE t110_cl CURSOR FROM g_forupd_sql
  #FUN-C80078 mark end---
   LET g_aptype = p_aptype
 
   CASE
      WHEN g_aptype = '11'
         LET g_apb_sarrno = 2
         LET g_prog = 'aapt110'
      WHEN g_aptype = '12'
         IF l_apz59='N' THEN           #TQC-A40106 change g_apz.apz59->l_apz59
            LET g_apb_sarrno = 0
         ELSE
            LET g_apb_sarrno = 2
         END IF
         LET g_prog = 'aapt120'
     #No.FUN-D70028 ---Add--- Start
      WHEN g_aptype = '14'
         LET g_apb_sarrno = 2
         LET g_prog = 'aapt140'
     #No.FUN-D70028 ---Add--- End
      WHEN g_aptype = '15'
         LET g_apb_sarrno = 2
         LET g_prog = 'aapt150'
      WHEN g_aptype = '16'
         LET g_apb_sarrno = 2
         LET g_prog = 'aapt160'
      WHEN g_aptype = '21'
         LET g_apb_sarrno = 2
      WHEN g_aptype = '22'
         LET g_apb_sarrno = 2
      WHEN g_aptype = '23'
         LET g_apb_sarrno = 0
      WHEN g_aptype = '24'
         LET g_apb_sarrno = 0
      WHEN g_aptype = '26'
         LET g_apb_sarrno = 2
         LET g_prog = 'aapt260'
      WHEN g_aptype = '13'          #報銷/還款維護作業
         IF l_apz59='N' THEN        #TQC-A40106 Add 
            LET l_apz59= 'Y'        #TQC-A40106 Add 
         END IF                     #TQC-A40106 Add      
         IF l_apz59='N' THEN        #TQC-A40106 change g_apz.apz59->l_apz59
            LET g_apb_sarrno = 0
         ELSE
            LET g_apb_sarrno = 2
         END IF
         LET g_prog = 'aapt121'
      WHEN g_aptype = '17'          #借支單維護作業
         LET g_apb_sarrno = 2
         LET g_prog = 'aapt151'
      WHEN g_aptype = '25'
         LET g_apb_sarrno = 0
   END CASE
 
   CASE
      WHEN g_aptype = '11' OR g_aptype = '16'   #FUN-680110 add g_aptype = '16'
         IF g_bgjob='N' OR cl_null(g_bgjob) THEN
 
            OPEN WINDOW t110_w11 WITH FORM "aap/42f/aapt110"
               ATTRIBUTE (STYLE = g_win_style CLIPPED) 
            CALL cl_ui_init()
            IF g_aptype='11' THEN   #MOD-820050
               CALL cl_set_act_visible("appor_expense",FALSE)    #FUN-680110 add
            END IF   #MOD-820050
            CALL cl_set_comp_visible("apa77",g_aza.aza26!= '2') #FUN-C90028 add
            CALL cl_set_comp_visible("apa992",FALSE)  #No.FUN-690090 
           #FUN-A10011--mod--str--
            IF g_aptype = '16' THEN
               IF g_azw.azw04 = '2' THEN
                  CALL cl_set_comp_visible("apa76",TRUE)
               ELSE
           #FUN-A10011--mod--end
                  CALL cl_set_comp_visible("apa76",FALSE)
               END IF  
           #FUN-A10011--add--str--
               CALL cl_set_comp_visible("apb29",FALSE) #No.TQC-B60025 add
               CALL cl_set_comp_visible("sum",FALSE)   #TQC-D20011 add
               CALL cl_set_comp_visible("sum1",FALSE)  #add by lili 170723
               CALL cl_set_act_visible("contra_tmp_est",FALSE)   #MOD-D30189 add
            ELSE
                CALL cl_set_comp_visible("apa76",FALSE)
            END IF 
           #FUN-A10011--mod--end
           #No.FUN-D70028 ---Add--- Start
            IF g_aptype <> '14' THEN
               CALL cl_set_act_visible("expenses",FALSE)
            END IF
           #No.FUN-D70028 ---Add--- End
            CALL cl_set_comp_visible("apa31_1,apa31f_1",FALSE) #FUN-CB0080 add
            CALL t110_set_form_default() #FUN-670064
            IF NOT cl_null(g_argv3) THEN
               CALL t110_q()
            END IF
         END IF
 
         #如果由表單追蹤區觸發程式, 此參數指定為何種資料匣
         #當為 EasyFlow 簽核時, 加入 EasyFlow 簽核 toolbar icon
         CALL aws_efapp_toolbar()    #FUN-580114
 
         IF NOT cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
            CASE g_argv2_str  #FUN-C80078 g_argv2-->g_argv2_str
               WHEN "query"
                  LET g_action_choice = "query"
                  IF cl_chk_act_auth() THEN
                     CALL t110_q()
                  END IF
               WHEN "insert"
                  LET g_action_choice = "insert"
                  IF cl_chk_act_auth() THEN
                     CALL t110_a()
                  END IF
               WHEN "efconfirm"
                  CALL t110_q()
                  CALL s_showmsg_init() #CHI-A80031 add
                  CALL t110_firm1_chk()          #CALL 原確認的 check 段
                  IF g_success = "Y" THEN
                     CALL t110_firm1_upd()       #CALL 原確認的 update 段
                  END IF
                  CALL s_showmsg()  #CHI-A80031 add
                  CALL cl_used(g_prog,g_time,2) RETURNING g_time    #FUN-B30211
                  EXIT PROGRAM
               OTHERWISE
                  CALL t110_q()
            END CASE
         END IF
 
         #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
         CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, undo_void,   #FUN-D20025 add--undo_void
                                    confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,
                                    single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,
                                    entry_sheet,entry_sheet2,T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,
                                    contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
              RETURNING g_laststage
 
         CALL t110_menu()
         CLOSE WINDOW t110_w11
 
      WHEN g_aptype = '12' OR g_aptype = '14'   #No.FUN-D70028   Add  OR g_aptype = '14'
         IF g_bgjob='N' OR cl_null(g_bgjob) THEN
         
            OPEN WINDOW t110_w12 WITH FORM "aap/42f/aapt120"
               ATTRIBUTE (STYLE = g_win_style CLIPPED) 
            CALL cl_ui_init()
            CALL cl_set_comp_visible("apa77",g_aza.aza26!= '2') #FUN-C90028 add
            CALL cl_set_comp_visible("apa76",FALSE)   #FUN-A10011
            CALL cl_set_comp_visible("apa31_1,apa31f_1",FALSE) #FUN-CB0080 add
            #FUN-D10058--add--str--
            IF g_aza.aza26 = '2' AND g_aza.aza70 = 'N' THEN
               CALL cl_set_comp_visible("apa992",FALSE)
            END IF
            #FUN-D10058--add--end--
           #No.FUN-D70028 ---Add--- Start
            IF g_aptype <> '14' THEN
               CALL cl_set_act_visible("expenses",FALSE)
            ELSE
               CALL cl_set_act_visible("contra",FALSE)
            END IF
           #No.FUN-D70028 ---Add--- End
            CALL t110_set_form_default() #FUN-670064
         END IF
 
         #如果由表單追蹤區觸發程式, 此參數指定為何種資料匣
         #當為 EasyFlow 簽核時, 加入 EasyFlow 簽核 toolbar icon
         CALL aws_efapp_toolbar()    #FUN-580114
 
         CALL t110_misc_clear()
         IF NOT cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
            CASE g_argv2_str  #FUN-C80078 g_argv2-->g_argv2_str
               WHEN "query"
                  LET g_action_choice = "query"
                  IF cl_chk_act_auth() THEN
                     CALL t110_q()
                  END IF
               WHEN "insert"
                  LET g_action_choice = "insert"
                  IF cl_chk_act_auth() THEN
                     CALL t110_a()
                  END IF
               WHEN "efconfirm"
                  CALL t110_q()
                  CALL s_showmsg_init() #CHI-A80031 add
                  CALL t110_firm1_chk()          #CALL 原確認的 check 段
                  IF g_success = "Y" THEN
                     CALL t110_firm1_upd()       #CALL 原確認的 update 段
                  END IF
                  CALL s_showmsg()  #CHI-A80031 add
                  CALL cl_used(g_prog,g_time,2) RETURNING g_time    #FUN-B30211
                  EXIT PROGRAM
               OTHERWISE
                  CALL t110_q()
            END CASE
         END IF
         #FUN-D10057--add--str--
         IF NOT cl_null(g_argv3) THEN
            CALL t110_q()
         END IF
         #FUN-D10057--add--end-- 
         #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
         CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, undo_void,   #FUN-D20025 add--undo_void
                                    confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,
                                    single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,
                                    entry_sheet,entry_sheet2,T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
              RETURNING g_laststage
 
         CALL t110_menu()
         CLOSE WINDOW t110_w12
 
      WHEN g_aptype = '15'
         IF g_bgjob='N' OR cl_null(g_bgjob) THEN
            OPEN WINDOW t110_w15 WITH FORM "aap/42f/aapt150"
               ATTRIBUTE (STYLE = g_win_style CLIPPED)
            CALL cl_ui_init()
            CALL cl_set_act_visible("appor_expense",FALSE)      #FUN-680110 add
            CALL cl_set_comp_visible("apa77",g_aza.aza26!= '2') #FUN-C90028 add
            CALL cl_set_comp_visible("apa992",FALSE)  #No.FUN-690090 
            CALL cl_set_comp_visible("apa76",FALSE)   #FUN-A10011
            CALL cl_set_comp_visible("apa31_1,apa31f_1",FALSE) #FUN-CB0080 add
#No.MOD-B40261 --begin    #CHI-B80023 mark
           #IF g_apz.apz61='1' THEN
           #   CALL cl_set_comp_required("apb06,apb07",TRUE) 
           #END IF
#No.MOD-B40261 --end      #CHI-B80023 mark
            CALL cl_set_comp_visible("no",g_aza.aza26='2') #FUN-D10057 add
           #No.FUN-D70028 ---Add--- Start
            IF g_aptype <> '14' THEN
               CALL cl_set_act_visible("expenses",FALSE)
            END IF
           #No.FUN-D70028 ---Add--- End
            CALL t110_set_form_default() #FUN-670064 
 
            IF NOT cl_null(g_argv4) THEN
               CALL t110_q()
            END IF
         END IF
 
         #如果由表單追蹤區觸發程式, 此參數指定為何種資料匣
         #當為 EasyFlow 簽核時, 加入 EasyFlow 簽核 toolbar icon
         CALL aws_efapp_toolbar()    #FUN-580114
 
         IF NOT cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
            CASE g_argv2_str  #FUN-C80078 g_argv2-->g_argv2_str
               WHEN "query"
                  LET g_action_choice = "query"
                  IF cl_chk_act_auth() THEN
                     CALL t110_q()
                  END IF
               WHEN "insert"
                  LET g_action_choice = "insert"
                  IF cl_chk_act_auth() THEN
                     CALL t110_a()
                  END IF
               WHEN "efconfirm"
                  CALL t110_q()
                  CALL s_showmsg_init() #CHI-A80031 add
                  CALL t110_firm1_chk()          #CALL 原確認的 check 段
                  IF g_success = "Y" THEN
                     CALL t110_firm1_upd()       #CALL 原確認的 update 段
                  END IF
                  CALL s_showmsg()  #CHI-A80031 add
                  CALL cl_used(g_prog,g_time,2) RETURNING g_time    #FUN-B30211
                  EXIT PROGRAM
               OTHERWISE
                  CALL t110_q()
            END CASE
         END IF
 
         #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
         CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, undo_void,   #FUN-D20025 add--undo_void
                                    confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,
                                    single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,
                                    entry_sheet,entry_sheet2,T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
              RETURNING g_laststage
 
         CALL t110_menu()
         CLOSE WINDOW t110_w15
 
      WHEN g_aptype = '21' OR g_aptype = '26'   #FUN-680110 add g_aptype = '26'
         IF g_bgjob='N' OR cl_null(g_bgjob) THEN
            OPEN WINDOW t110_w21 WITH FORM "aap/42f/aapt210"
                 ATTRIBUTE (STYLE = g_win_style CLIPPED)
            CALL cl_ui_init()
            CALL cl_set_act_visible("appor_expense",FALSE)   #FUN-680110 add
            CALL cl_set_comp_visible("apa77",g_aza.aza26!= '2') #FUN-C90028 add
            CALL cl_set_comp_visible("apa992",FALSE)  #No.FUN-690090
            IF g_argv2_str = 'aapq720' THEN                                          #FUN-8A0108  #FUN-C80078 g_argv2-->g_argv2_str
               CALL cl_set_act_visible("insert,delete,modify,query,detail",FALSE)    #FUN-8A0108                                    
            END IF                                                                   #FUN-8A0108 
            CALL cl_set_comp_visible("apa37,apa37f,page05",FALSE)
            CALL cl_set_comp_visible("apa31_1,apa31f_1",FALSE) #FUN-CB0080 add
           #FUN-A10011--mod--str--
            IF g_aptype = '26' THEN 
               IF g_azw.azw04 = '2' THEN
                  CALL cl_set_comp_visible("apa76",TRUE)
               ELSE
           #FUN-A10011--mod--end
                  CALL cl_set_comp_visible("apa76",FALSE)
               END IF  
               CALL cl_set_act_visible("contra_tmp_est",FALSE)   #MOD-D30189 add
           #FUN-A10011--add--str--
            ELSE
               CALL cl_set_comp_visible("apa76",FALSE)
            END IF 
           #FUN-A10011--add--end  
           #FUN-A10011--add--end
           #No.FUN-D70028 ---Add--- Start
            IF g_aptype <> '14' THEN
               CALL cl_set_act_visible("expenses",FALSE)
            END IF
           #No.FUN-D70028 ---Add--- End
            CALL t110_set_form_default() #FUN-670064
            IF NOT cl_null(g_argv3) THEN
               CALL t110_q()
            END IF
         END IF
 
         #如果由表單追蹤區觸發程式, 此參數指定為何種資料匣
         #當為 EasyFlow 簽核時, 加入 EasyFlow 簽核 toolbar icon
         CALL aws_efapp_toolbar()    #FUN-580114
 
         IF NOT cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
            CASE g_argv2_str  #FUN-C80078 g_argv2-->g_argv2_str
               WHEN "query"
                  LET g_action_choice = "query"
                  IF cl_chk_act_auth() THEN
                     CALL t110_q()
                  END IF
               WHEN "insert"
                  LET g_action_choice = "insert"
                  IF cl_chk_act_auth() THEN
                     CALL t110_a()
                  END IF
               WHEN "efconfirm"
                  CALL t110_q()
                  CALL s_showmsg_init() #CHI-A80031 add
                  CALL t110_firm1_chk()          #CALL 原確認的 check 段
                  IF g_success = "Y" THEN
                     CALL t110_firm1_upd()       #CALL 原確認的 update 段
                  END IF
                  CALL s_showmsg()  #CHI-A80031 add
                  CALL cl_used(g_prog,g_time,2) RETURNING g_time    #FUN-B30211
                  EXIT PROGRAM
               OTHERWISE
                  CALL t110_q()
            END CASE
         END IF
 
         #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
         CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, undo_void,   #FUN-D20025 add--undo_void
                                    confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,
                                    single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,
                                    entry_sheet,entry_sheet2,T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
              RETURNING g_laststage
 
         CALL t210_menu()
         CLOSE WINDOW t110_w21
 
      WHEN g_aptype = '22'
 
         IF g_bgjob='N' OR cl_null(g_bgjob) THEN
            OPEN WINDOW t110_w22 WITH FORM "aap/42f/aapt220"
               ATTRIBUTE (STYLE = g_win_style CLIPPED) #No.FUN-580092 HCN
            CALL cl_ui_init()
 
            CALL cl_set_act_visible("appor_expense",FALSE)      #FUN-680110 add
            CALL cl_set_comp_visible("apa77",g_aza.aza26!= '2') #FUN-C90028 add
            CALL cl_set_comp_visible("apa37,apa37f,page05",FALSE)
            CALL cl_set_comp_visible("apa76",FALSE)   #FUN-A10011
            CALL cl_set_comp_visible("apa31_1,apa31f_1",FALSE) #FUN-CB0080 add
            CALL t110_set_form_default() #FUN-670064
            #FUN-D10058--add--str--
            IF g_aza.aza26 = '2' AND g_aza.aza70 = 'N' THEN
               CALL cl_set_comp_visible("apa992",FALSE)
            END IF
            #FUN-D10058--add--end--
           #No.FUN-D70028 ---Add--- Start
            IF g_aptype <> '14' THEN
               CALL cl_set_act_visible("expenses",FALSE)
            END IF
           #No.FUN-D70028 ---Add--- End
         END IF
 
         #如果由表單追蹤區觸發程式, 此參數指定為何種資料匣
         #當為 EasyFlow 簽核時, 加入 EasyFlow 簽核 toolbar icon
         CALL aws_efapp_toolbar()    #FUN-580114
 
         IF NOT cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
            CASE g_argv2_str  #FUN-C80078 g_argv2-->g_argv2_str
               WHEN "query"
                  LET g_action_choice = "query"
                  IF cl_chk_act_auth() THEN
                     CALL t110_q()
                  END IF
               WHEN "insert"
                  LET g_action_choice = "insert"
                  IF cl_chk_act_auth() THEN
                     CALL t110_a()
                  END IF
               WHEN "efconfirm"
                  CALL t110_q()
                  CALL s_showmsg_init() #CHI-A80031 add
                  CALL t110_firm1_chk()          #CALL 原確認的 check 段
                  IF g_success = "Y" THEN
                     CALL t110_firm1_upd()       #CALL 原確認的 update 段
                  END IF
                  CALL s_showmsg()  #CHI-A80031 add
                  CALL cl_used(g_prog,g_time,2) RETURNING g_time    #FUN-B30211
                  EXIT PROGRAM
               OTHERWISE
                  CALL t110_q()
            END CASE
         END IF
        
         #FUN-D10057--add--str--
         IF NOT cl_null(g_argv3) THEN
            CALL t110_q()
         END IF
         #FUN-D10057--add--end--
 
         #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
         CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, undo_void,   #FUN-D20025 add--undo_void
                                    confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,
                                    single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,
                                    entry_sheet,entry_sheet2,T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
              RETURNING g_laststage
 
         CALL t210_menu()
         CLOSE WINDOW t110_w22
 
      WHEN g_aptype = '23'
         OPEN WINDOW t110_w23 WITH FORM "aap/42f/aapq230"
             ATTRIBUTE (STYLE = g_win_style CLIPPED) 
         CALL cl_ui_init()
         CALL cl_set_act_visible("appor_expense",FALSE)  
         CALL cl_set_comp_visible("apa77",g_aza.aza26!= '2') #FUN-C90028 add
         CALL cl_set_comp_visible("apa76",FALSE)    #MOD-9C0263
         CALL t110_set_form_default() #FUN-670064
         #FUN-D10058--add--str--
         IF g_aza.aza26 = '2' AND g_aza.aza70 = 'N' THEN
            CALL cl_set_comp_visible("apa992",FALSE)
         END IF
         #FUN-D10058--add--end--
         #No.FUN-D70028 ---Add--- Start
          IF g_aptype <> '14' THEN
             CALL cl_set_act_visible("expenses",FALSE)
          END IF
         #No.FUN-D70028 ---Add--- End
 
         IF NOT cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
            CASE g_argv2_str  #FUN-C80078 g_argv2-->g_argv2_str
               WHEN "query"
                  LET g_action_choice = "query"
                  IF cl_chk_act_auth() THEN
                     CALL t110_q()
                  END IF
               WHEN "insert"
                  LET g_action_choice = "insert"
                  IF cl_chk_act_auth() THEN
                     CALL t110_a()
                  END IF
               OTHERWISE
                  CALL t110_q()
            END CASE
         END IF
 
         WHILE TRUE
           LET g_action_choice=""
           CALL t230_menu()
           IF g_action_choice="exit" THEN EXIT WHILE END IF
         END WHILE
 
         CLOSE WINDOW t110_w23
 
      WHEN g_aptype = '24'
 
         OPEN WINDOW t110_w24 WITH FORM "aap/42f/aapq240"
             ATTRIBUTE (STYLE = g_win_style CLIPPED)
         CALL cl_ui_init()
         CALL cl_set_act_visible("appor_expense",FALSE)   #FUN-680110 add
         CALL cl_set_comp_visible("apa77",g_aza.aza26!= '2') #FUN-C90028 add
         #FUN-D10058--add--str--
         IF g_aza.aza26 = '2' AND g_aza.aza70 = 'N' THEN
            CALL cl_set_comp_visible("apa992",FALSE)
         END IF
         #FUN-D10058--add--end--
        #No.FUN-D70028 ---Add--- Start
         IF g_aptype <> '14' THEN
            CALL cl_set_act_visible("expenses",FALSE)
         END IF
        #No.FUN-D70028 ---Add--- End
         CALL t110_set_form_default() #FUN-670064
         CALL cl_set_comp_visible("apa76",FALSE)   #MOD-9C0263
         IF NOT cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
            CASE g_argv2_str  #FUN-C80078 g_argv2-->g_argv2_str
               WHEN "query"
                  LET g_action_choice = "query"
                  IF cl_chk_act_auth() THEN
                     CALL t110_q()
                  END IF
               WHEN "insert"
                  LET g_action_choice = "insert"
                  IF cl_chk_act_auth() THEN
                     CALL t110_a()
                  END IF
               OTHERWISE
                  CALL t110_q()
            END CASE
         END IF
         WHILE TRUE
           LET g_action_choice=""
           CALL t230_menu()
           IF g_action_choice="exit" THEN EXIT WHILE END IF
         END WHILE
         CLOSE WINDOW t110_w24
 
      WHEN g_aptype = '13'          #報銷/還款維護作業
         IF g_bgjob='N' OR cl_null(g_bgjob) THEN
            OPEN WINDOW t110_w13 WITH FORM "aap/42f/aapt121"
               ATTRIBUTE (STYLE = g_win_style CLIPPED)
            CALL cl_ui_init()
            CALL cl_set_act_visible("appor_expense",FALSE)    #FUN-680110 add
            CALL cl_set_comp_visible("apa992",FALSE)  #No.FUN-690090 
            CALL cl_set_comp_visible("apa77",g_aza.aza26!= '2') #FUN-C90028 add
            CALL cl_set_comp_visible("apa76",FALSE)   #FUN-A10011
            CALL cl_set_comp_visible("apa05_1,pmc03_1",FALSE) #FUN-CB0080 add
           #No.FUN-D70028 ---Add--- Start
            IF g_aptype <> '14' THEN
               CALL cl_set_act_visible("expenses",FALSE)
            END IF
           #No.FUN-D70028 ---Add--- End
            CALL t110_set_form_default()
            IF NOT cl_null(g_argv3) THEN
               CALL t110_q()
            END IF
         END IF
         #如果由表單追蹤區觸發程式, 此參數指定為何種資料匣
         #當為 EasyFlow 簽核時, 加入 EasyFlow 簽核 toolbar icon
         CALL aws_efapp_toolbar()
         CALL t110_misc_clear()
         IF NOT cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
            CASE g_argv2_str  #FUN-C80078 g_argv2-->g_argv2_str
               WHEN "query"
                  LET g_action_choice = "query"
                  IF cl_chk_act_auth() THEN
                     CALL t110_q()
                  END IF
               WHEN "insert"
                  LET g_action_choice = "insert"
                  IF cl_chk_act_auth() THEN
                     CALL t110_a()
                  END IF
               WHEN "efconfirm"
                  CALL t110_q()
                  CALL s_showmsg_init() #CHI-A80031 add
                  CALL t110_firm1_chk()
                  IF g_success = "Y" THEN
                     CALL t110_firm1_upd()
                  END IF
                  CALL s_showmsg()  #CHI-A80031 add
                  CALL cl_used(g_prog,g_time,2) RETURNING g_time    #FUN-B30211
                  EXIT PROGRAM
               OTHERWISE
                  CALL t110_q()
            END CASE
         END IF
         #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
         CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, undo_void,   #FUN-D20025 add--undo_void
                                    confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,
                                    mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,
                                    T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
            RETURNING g_laststage
         CALL t110_menu()
         CLOSE WINDOW t110_w13
 
      WHEN g_aptype = '17'          #借支單維護作業
         IF g_bgjob='N' OR cl_null(g_bgjob) THEN
            OPEN WINDOW t110_w17 WITH FORM "aap/42f/aapt151"
               ATTRIBUTE (STYLE = g_win_style CLIPPED)
            CALL cl_ui_init()
            CALL cl_set_act_visible("appor_expense",FALSE)    #FUN-680110 add
            CALL cl_set_comp_visible("apa992",FALSE)  #No.FUN-690090 
            CALL cl_set_comp_visible("apa77",g_aza.aza26!= '2') #FUN-C90028 add
            CALL cl_set_comp_visible("apa76",FALSE)   #FUN-A10011
            CALL cl_set_comp_visible("apa05_1,pmc03_1",FALSE) #FUN-CB0080 add
            CALL cl_set_comp_visible("no",g_aza.aza26='2') #FUN-D10057 add
           #No.FUN-D70028 ---Add--- Start
            IF g_aptype <> '14' THEN
               CALL cl_set_act_visible("expenses",FALSE)
            END IF
           #No.FUN-D70028 ---Add--- End
            CALL t110_set_form_default()
         END IF
         #如果由表單追蹤區觸發程式, 此參數指定為何種資料匣
         #當為 EasyFlow 簽核時, 加入 EasyFlow 簽核 toolbar icon
         CALL aws_efapp_toolbar()
         call t110_misc_clear()
 
         IF NOT cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
            CASE g_argv2_str  #FUN-C80078 g_argv2-->g_argv2_str
               WHEN "query"
                  LET g_action_choice = "query"
                  IF cl_chk_act_auth() THEN
                     CALL t110_q()
                  END IF
               WHEN "insert"
                  LET g_action_choice = "insert"
                  IF cl_chk_act_auth() THEN
                     CALL t110_a()
                  END IF
               WHEN "efconfirm"
                  CALL t110_q()
                  CALL s_showmsg_init() #CHI-A80031 add
                  CALL t110_firm1_chk()          #CALL 原確認的 check 段
                  IF g_success = "Y" THEN
                     CALL t110_firm1_upd()       #CALL 原確認的 update 段
                  END IF
                  CALL s_showmsg()  #CHI-A80031 add
                  CALL cl_used(g_prog,g_time,2) RETURNING g_time    #FUN-B30211
                  EXIT PROGRAM
               OTHERWISE
                  CALL t110_q()
            END CASE
         END IF
         #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
         #CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
         CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, undo_void,   #FUN-D20025 add--undo_void
                                    confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,
                                    mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
              RETURNING g_laststage
         CALL t110_menu()
         CLOSE WINDOW t110_w17
 
      WHEN g_aptype = '25'
         OPEN WINDOW t110_w25 WITH FORM "aap/42f/aapq231"
            ATTRIBUTE (STYLE = g_win_style CLIPPED)
         CALL cl_ui_init()
         CALL cl_set_act_visible("appor_expense",FALSE)   #FUN-680110 add
         CALL cl_set_comp_visible("apa992",FALSE)  #No.FUN-690090
         CALL cl_set_comp_visible("apa77",g_aza.aza26!= '2') #FUN-C90028 add
         CALL cl_set_comp_visible("apa54,a54",FALSE)  #No.TQC-980068 
         CALL cl_set_comp_visible("apa76",FALSE)    #MOD-9C0263
        #No.FUN-D70028 ---Add--- Start
         IF g_aptype <> '14' THEN
            CALL cl_set_act_visible("expenses",FALSE)
         END IF
        #No.FUN-D70028 ---Add--- End
         CALL t110_set_form_default()
         IF NOT cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
            CASE g_argv2_str  #FUN-C80078 g_argv2-->g_argv2_str
               WHEN "query"
                  LET g_action_choice = "query"
                  IF cl_chk_act_auth() THEN
                     CALL t110_q()
                  END IF
               WHEN "insert"
                  LET g_action_choice = "insert"
                  IF cl_chk_act_auth() THEN
                     CALL t110_a()
                  END IF
               OTHERWISE
                  CALL t110_q()
            END CASE
         END IF
         WHILE TRUE
           LET g_action_choice=""
           CALL t230_menu()
           IF g_action_choice="exit" THEN EXIT WHILE END IF
         END WHILE
 
         CLOSE WINDOW t110_w25
   END CASE
 
END FUNCTION
 
FUNCTION t110_cs()
DEFINE  lc_qbe_sn       LIKE    gbm_file.gbm01    #No.FUN-580031  HCN
   DEFINE g_t1                           LIKE oay_file.oayslip                  #No.FUN-550030  #No.FUN-690028 VARCHAR(05)
   DEFINE  l_apa15_wc   LIKE type_file.chr1000  #TQC-750139
   CLEAR FORM                             #清除畫面
   CALL t110_misc_clear()
   DISPLAY "g_argv3=",g_argv3
   IF NOT cl_null(g_argv3) THEN
      LET g_wc2 = " 1=1"
      #FUN-D10057--add--str--
      IF g_aptype='12' OR g_aptype='22' THEN
         LET g_wc=" apa08= '",g_argv3 CLIPPED,"'"
      ELSE
      #FUN-D10057--add--end--
         DISPLAY "LENGTH(g_argv3)=",LENGTH(g_argv3)
         IF LENGTH(g_argv3) > 11 THEN
            LET g_wc = " apa01 IN ",g_argv3 CLIPPED," "
         ELSE
           LET g_wc = " apa01 = '",g_argv3 CLIPPED,"'"
         END IF
      END IF #FUN-D10057
   ELSE
   DISPLAY "g_wc=",g_wc
 
   IF NOT cl_null(g_argv1_apa01) THEN  #FUN-C80078 g_argv1-->g_argv1_apa01
     #IF LENGTH(g_argv1) > 17 THEN     #No.FUN-560196 #FUN-C70129 mark
      IF LENGTH(g_argv1_apa01) > 20 THEN     #FUN-C70129 add  #FUN-C80078 g_argv1-->g_argv1_apa01
         LET g_wc=" apa01 IN ",g_argv1_apa01 CLIPPED," "  #FUN-C80078 g_argv1-->g_argv1_apa01
      ELSE
         LET g_wc=" apa01='",g_argv1_apa01 CLIPPED,"'"  #FUN-C80078 g_argv1-->g_argv1_apa01
      END IF
   ELSE                                                  #FUN-880095
   IF NOT cl_null(g_argv4) THEN                          #FUN-880095
      LET g_wc = " 1=1"                                  #FUN-880095
   ELSE                                                           	
      CALL cl_set_head_visible("","YES")     #No.FUN-6B0033
 
      INITIALIZE g_apa.* TO NULL    #No.FUN-750051
      IF NOT (g_aptype='23' OR g_aptype='24' OR g_aptype='25') THEN   #MOD-880101 add
         CONSTRUCT BY NAME g_wc ON
                apa01,apa02,apa05,apa06,apa07,apa21,
                apa22,apa930,apa76,apa44,apa992,apa63,apamksg,apa42,apa41,apa79, #FUN-670064  #No.FUN-690090 add apa992  #FUN-960141  #FUN-960141 090824 刪除apaplant #FUN-9C0041 add apa76   FUN-A40003 add apa79
                apa36,apa13,apa14,apa15,apa16,apa08,apa77,apa58,   #FUN-5C0106 apa08在apa15,16之後 #MOD-6A0124 #FUN-970108 add apa77
                apa11,apa12,apa24,apa64,apa55,
                apa31f,apa32f,apa60f,apa61f,apa65f,apa37f,apa34f,apa35f, #FUN-640035 #No.FUN-690080
                apa31,apa32,apa60,apa61,apa65,apa37,apa34,apa35,         #FUN-640035 #No.FUN-690080
                apa19,apa20,       #No.FUN-680029
                apa56,apa33,apa66,apa25,apa100,
                apainpd,apa99,apa51,apa52,apa54,apa511,apa521,apa541,    #No.FUN-680029
                apa101,apa102,                                           #No.FUN-690080
                apaoriu,apaorig,                                         #No.TQC-B90255
                apauser,apagrup,apamodu,apadate,apaacti,
                apaud01,apaud02,apaud03,apaud04,apaud05,
                apaud06,apaud07,apaud08,apaud09,apaud10,
                apaud11,apaud12,apaud13,apaud14,apaud15
 
            BEFORE CONSTRUCT
               CALL cl_qbe_init()
               CALL cl_set_act_visible("qbe_save",FALSE)
 
            AFTER FIELD apa15
               CALL GET_FLDBUF(apa15) RETURNING l_apa15_wc
               LET l_apa15_wc = cl_replace_str(l_apa15_wc,"|","','")
               LET l_apa15_wc = "'",l_apa15_wc CLIPPED,"'"
 
            ON ACTION CONTROLP
               CASE
                  WHEN INFIELD(apa01) #查詢單据
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_apa"
                     LET g_qryparam.arg1 = g_aptype
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa01
                     NEXT FIELD apa01
                  WHEN INFIELD(apa05) #PAY TO VENDOR
                     #FUN-DA0051--add--str--
                     #大陆版且允许客户立账的情况下可以开窗客户+厂商
                     IF g_aza.aza26 = '2' AND g_apz.apz74 = 'Y'
                        AND (g_prog = 'aapt150' OR g_prog = 'aapq230' OR g_prog = 'aapq240') THEN
                        CALL q_occ_pmc(TRUE,TRUE,g_plant) RETURNING g_qryparam.multiret
                     ELSE
                     #FUN-DA0051--add--end
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
#                    LET g_qryparam.form ="q_pmc1"   #FUN-D80031 mark
                     #FUN-D80031 add ------- begin
                     CASE g_prog
                        WHEN 'aapt140'
                           LET g_qryparam.form ="q_occ02"
                        OTHERWISE
                           LET g_qryparam.form ="q_pmc1"
                     END CASE
                     #FUN-D80031 add ------- end
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     END IF #FUN-DA0051
                     DISPLAY g_qryparam.multiret TO apa05
                     NEXT FIELD apa05
                  WHEN INFIELD(apa06) #PAY TO VENDOR
                     #FUN-DA0051--add--str--
                     #大陆版且允许客户立账的情况下可以开窗客户+厂商
                     IF g_aza.aza26 = '2' AND g_apz.apz74 = 'Y'                                   
                        AND (g_prog = 'aapt150' OR g_prog = 'aapq230' OR g_prog = 'aapq240') THEN 
                        CALL q_occ_pmc(TRUE,TRUE,g_plant) RETURNING g_qryparam.multiret
                     ELSE
                     #FUN-DA0051--add--end
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     IF g_aptype = '13' OR g_aptype = '17' OR g_aptype = '25' THEN
                        LET g_qryparam.form ="q_gen"          #No.CHI-780046   
                     ELSE
#                       LET g_qryparam.form ="q_pmc"  #MOD-960121  #FUN-D80031 mark
                        #FUN-D80031 add ------- begin
                        CASE g_prog
                           WHEN 'aapt140'
                              LET g_qryparam.form ="q_occ02"
                           OTHERWISE
                              LET g_qryparam.form ="q_pmc"
                        END CASE
                        #FUN-D80031 add ------- end
                     END IF
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     END IF #FUN-DA0051
                     DISPLAY g_qryparam.multiret TO apa06
                  WHEN INFIELD(apa11) # PAY TERM
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_pma"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa11
                  WHEN INFIELD(apa13) # CURRENCY
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_azi"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa13
                  WHEN INFIELD(apa15) # TAX CODE
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     IF g_aza.aza26 = '2' THEN                #No.TQC-B40051     
                        LET g_qryparam.form ="q_gec8_1"   #No.TQC-B40051 #大陸版本去掉gec08
                     ELSE 
                     	  LET g_qryparam.form ="q_gec8" #MOD-990132 q_gec-->q_gec8 
                     END IF 
                     LET g_qryparam.arg1 = '1' #MOD-990132   
                     IF g_prog = 'aapt160' OR g_prog = 'aapt260' THEN
                        LET g_qryparam.where = " gec05 = 'X' AND gec06 = '2' "  #No.MOD-940297 add gec06
                     END IF
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa15
                  WHEN INFIELD(apa77)
                     CALL cl_init_qry_var()
                     LET g_qryparam.state= "c"
                     LET g_qryparam.form = "q_ama02"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa77
                  WHEN INFIELD(apa19) # HOLD CODE
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_apo"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa19
                  WHEN INFIELD(apa07) # Employee CODE
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                    #LET g_qryparam.form ="q_gen"                              #TQC-C70027 mark
                    #LET g_qryparam.form ="q_apa11"                            #TQC-C70027 add #MOD-CC0238 mark
                    #------------MOD-CC0238------------(S)
                     IF g_aptype = '12'  THEN               
                        LET g_qryparam.form ="q_pmc"      
                     ELSE                                   
                        LET g_qryparam.form ="q_gen"
                     END IF  
                    #------------MOD-CC0238------------(E)
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa07
                  WHEN INFIELD(apa21) # Employee CODE
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_gen"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa21
                  WHEN INFIELD(apa22) # Dept CODE
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_gem"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa22
                  WHEN INFIELD(apa36) # Class
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_apr"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa36
                  WHEN INFIELD(apa51) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa51
                  WHEN INFIELD(apa52) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa52
                  WHEN INFIELD(apa54) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa54
                  WHEN INFIELD(apa511) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa511
                  WHEN INFIELD(apa521) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa521
                  WHEN INFIELD(apa541) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa541
                  WHEN INFIELD(apa101)   #還款銀行
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_nma"
                     IF g_aptype='13' THEN                          
                       IF g_aza.aza26!='2' THEN     #FUN-C80018 
                         LET g_qryparam.where ="nma28 !=1 and nma37 !=0 and nma10='",g_apa.apa13,"'" 
                       ELSE                                                                 #FUN-C80018
                         LET g_qryparam.where ="nma37 !=0 and nma10='",g_apa.apa13,"'"      #FUN-C80018
                       END IF                                                               #FUN-C80018
                     END IF
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa101
                  WHEN INFIELD(apa102)   #還款異動碼
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_nma"
                     IF g_aptype='13' THEN
                        LET g_qryparam.where =" nmc03=1"
                     END IF
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa102
                  WHEN INFIELD(apa66) #專案代號
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_pja2"    #FUN-810045 
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa66
                  WHEN INFIELD(apa930)
                     CALL cl_init_qry_var()
                     LET g_qryparam.form  = "q_gem4"
                     LET g_qryparam.state = "c"   #多選
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa930
                     NEXT FIELD apa930
                  OTHERWISE EXIT CASE
               END CASE
 
            ON IDLE g_idle_seconds
               CALL cl_on_idle()
               CONTINUE CONSTRUCT
 
            ON ACTION about         #MOD-4C0121
               CALL cl_about()      #MOD-4C0121
 
            ON ACTION help          #MOD-4C0121
               CALL cl_show_help()  #MOD-4C0121
 
            ON ACTION controlg      #MOD-4C0121
               CALL cl_cmdask()     #MOD-4C0121
 
            ON ACTION qbe_select
               CALL cl_qbe_list() RETURNING lc_qbe_sn
               CALL cl_qbe_display_condition(lc_qbe_sn)
 
         END CONSTRUCT
         CALL cl_set_act_visible("qbe_save",TRUE)
      ELSE
         CONSTRUCT BY NAME g_wc ON
                apa01,apa02,apa05,apa06,apa07,apa21,
                apa22,apa930,apa76,apa992,apa63,apamksg,apa42,apa41, #FUN-670064  #No.FUN-690090 add apa992 #FUN-960141  #FUN-960141 刪除apaplant   #FUN-9C0041 add apa76
                apa36,apa13,apa14,apa15,apa16,apa08,apa77,apa58,   #FUN-5C0106 apa08在apa15,16之後 #MOD-6A0124 #FUN-970108 add apa77
                apa11,apa12,apa24,apa64,apa55,
                apa31f,apa32f,apa60f,apa61f,apa65f,apa37f,apa34f,apa35f, #FUN-640035 #No.FUN-690080
                apa31,apa32,apa60,apa61,apa65,apa37,apa34,apa35,         #FUN-640035 #No.FUN-690080
                apa19,apa20,       #No.FUN-680029
                apa56,apa33,apa66,apa25,apa100,
                apainpd,apa99,apa51,apa52,apa54,apa511,apa521,apa541,    #No.FUN-680029
                apa101,apa102,                                           #No.FUN-690080
                apaoriu,apaorig,                                         #No.TQC-B90255
                apauser,apagrup,apamodu,apadate,apaacti,
                apaud01,apaud02,apaud03,apaud04,apaud05,
                apaud06,apaud07,apaud08,apaud09,apaud10,
                apaud11,apaud12,apaud13,apaud14,apaud15
 
            BEFORE CONSTRUCT
               CALL cl_qbe_init()
 
            AFTER FIELD apa15
               CALL GET_FLDBUF(apa15) RETURNING l_apa15_wc
               LET l_apa15_wc = cl_replace_str(l_apa15_wc,"|","','")
               LET l_apa15_wc = "'",l_apa15_wc CLIPPED,"'"
 
            ON ACTION CONTROLP
               CASE
                  WHEN INFIELD(apa01) #查詢單据
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_apa"
                     LET g_qryparam.arg1 = g_aptype
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa01
                     NEXT FIELD apa01
                  WHEN INFIELD(apa05) #PAY TO VENDOR
                     #FUN-DA0051--add--str--
                     #大陆版且允许客户立账的情况下可以开窗客户+厂商
                     IF g_aza.aza26 = '2' AND g_apz.apz74 = 'Y'                                   
                        AND (g_prog = 'aapt150' OR g_prog = 'aapq230' OR g_prog = 'aapq240') THEN 
                        CALL q_occ_pmc(TRUE,TRUE,g_plant) RETURNING g_qryparam.multiret
                     ELSE
                     #FUN-DA0051--add--end
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
#                    LET g_qryparam.form ="q_pmc1"   #FUN-D80031  mark
                     #FUN-D80031 add ------- begin
                     CASE g_prog
                        WHEN 'aapt140'
                           LET g_qryparam.form ="q_occ02"
                        OTHERWISE
                           LET g_qryparam.form ="q_pmc1"
                     END CASE
                     #FUN-D80031 add ------- end
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     END IF #FUN-DA0051
                     DISPLAY g_qryparam.multiret TO apa05
                     NEXT FIELD apa05
                  WHEN INFIELD(apa06) #PAY TO VENDOR
                     #FUN-DA0051--add--str--
                     #大陆版且允许客户立账的情况下可以开窗客户+厂商
                     IF g_aza.aza26 = '2' AND g_apz.apz74 = 'Y'                                  
                        AND (g_prog = 'aapt150' OR g_prog = 'aapq230' OR g_prog = 'aapq240') THEN
                        CALL q_occ_pmc(TRUE,TRUE,g_plant) RETURNING g_qryparam.multiret
                     ELSE
                     #FUN-DA0051--add--end
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     IF g_aptype = '13' OR g_aptype = '17' OR g_aptype = '25' THEN
                        LET g_qryparam.form ="q_gen"          #No.CHI-780046   
                     ELSE
#                       LET g_qryparam.form ="q_pmc"  #MOD-960121  #FUN-D80031 mark
                        #FUN-D80031 add ------- begin
                        IF g_prog = 'aapt140' THEN
                           LET g_qryparam.form ="q_occ02"
                        ELSE
                           LET g_qryparam.form ="q_pmc"
                        END IF
                        #FUN-D80031 add ------- end
                     END IF
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     END IF #FUN-DA0051
                     DISPLAY g_qryparam.multiret TO apa06
#TQC-A30127 --BEGIN--
                  WHEN INFIELD(apa08) #查詢預付號碼
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_apa081"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa08
                     NEXT FIELD apa08
#TQC-A30127 --END--
                  WHEN INFIELD(apa11) # PAY TERM
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_pma"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa11
                  WHEN INFIELD(apa13) # CURRENCY
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_azi"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa13
                  WHEN INFIELD(apa15) # TAX CODE
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     IF g_aza.aza26 = '2' THEN                #No.TQC-B40051
                        LET g_qryparam.form ="q_gec8_1"   #No.TQC-B40051 #大陸版本去掉gec08
                     ELSE                                 #No.TQC-B40051
                        LET g_qryparam.form ="q_gec8" #MOD-990132 q_gec-->q_gec8                                                       
                     END IF                               #No.TQC-B40051
                     LET g_qryparam.arg1 = '1' #MOD-990132                     
                     IF g_prog = 'aapt160' OR g_prog = 'aapt260' THEN
                        LET g_qryparam.where = " gec05 = 'X' AND gec06 = '2' " #No.MOD-940297 add gec06
                     END IF
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa15
                  WHEN INFIELD(apa77)
                     CALL cl_init_qry_var()
                     LET g_qryparam.state= "c"
                     LET g_qryparam.form = "q_ama02"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa77
                  #FUN-970108---End
                  WHEN INFIELD(apa19) # HOLD CODE
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_apo"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa19
                  WHEN INFIELD(apa07) # Employee CODE
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                    #LET g_qryparam.form ="q_gen"                      #TQC-C70027 mark
                    #LET g_qryparam.form ="q_apa11"                    #TQC-C70027 add #MOD-CC0238 mark
                    #------------MOD-CC0238------------(S)
                     IF g_aptype = '12'  THEN
                        LET g_qryparam.form ="q_pmc"  
                     ELSE
                        LET g_qryparam.form ="q_gen"
                     END IF
                    #------------MOD-CC0238------------(E)
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa07
                  WHEN INFIELD(apa21) # Employee CODE
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_gen"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa21
                  WHEN INFIELD(apa22) # Dept CODE
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_gem"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa22
                  WHEN INFIELD(apa36) # Class
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_apr"
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa36
                  WHEN INFIELD(apa51) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa51
                  WHEN INFIELD(apa52) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa52
                  WHEN INFIELD(apa54) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa54
                  WHEN INFIELD(apa511) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa511
                  WHEN INFIELD(apa521) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa521
                  WHEN INFIELD(apa541) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa541
                  WHEN INFIELD(apa101)   #還款銀行
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_nma"
                     IF g_aptype='13' THEN 
                        #LET g_qryparam.where ="nma28 !=1 and nma37 !=0 and nma10='",g_apa.apa13,"'"   #FUN-C80018
                     #FUN-C80018--ADD---STR
                       IF g_aza.aza26!='2' THEN                
                         LET g_qryparam.where ="nma28 !=1 and nma37 !=0 and nma10='",g_apa.apa13,"'" 
                       ELSE
                         LET g_qryparam.where ="nma37 !=0 and nma10='",g_apa.apa13,"'"
                       END IF
                     #FUN-C80018--ADD---END
                     END IF
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa101
                  WHEN INFIELD(apa102)   #還款異動碼
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_nma"
                     IF g_aptype='13' THEN
                        LET g_qryparam.where =" nmc03=1"
                     END IF
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa102
                  WHEN INFIELD(apa66) #專案代號
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_pja2"    #FUN-810045 
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa66
                  WHEN INFIELD(apa930)
                     CALL cl_init_qry_var()
                     LET g_qryparam.form  = "q_gem4"
                     LET g_qryparam.state = "c"   #多選
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa930
                     NEXT FIELD apa930
                  OTHERWISE EXIT CASE
               END CASE
 
            ON IDLE g_idle_seconds
               CALL cl_on_idle()
               CONTINUE CONSTRUCT
 
            ON ACTION about         #MOD-4C0121
               CALL cl_about()      #MOD-4C0121
 
            ON ACTION help          #MOD-4C0121
               CALL cl_show_help()  #MOD-4C0121
 
            ON ACTION controlg      #MOD-4C0121
               CALL cl_cmdask()     #MOD-4C0121
 
            ON ACTION qbe_select
               CALL cl_qbe_select()
 
            ON ACTION qbe_save
               CALL cl_qbe_save()
 
         END CONSTRUCT
         CALL cl_set_act_visible("qbe_save",TRUE)
      END IF
      IF INT_FLAG THEN
         LET g_apa.apa01 = NULL   #MOD-660086 add
         RETURN
      END IF
   END IF
   END IF                         #FUN-880095
 
   LET g_wc = g_wc CLIPPED,cl_get_extra_cond('apauser', 'apagrup')
 
   LET g_wc2 = " 1=1"
   IF NOT cl_null(g_argv4) THEN                          #FUN-880095
      IF LENGTH(g_argv4) > 17 THEN                       #FUN-880095
         LET g_wc2=" apb06 IN ",g_argv4 CLIPPED," "      #FUN-880095
      ELSE                                               #FUN-880095
         LET g_wc2=" apb06='",g_argv4 CLIPPED,"'"        #FUN-880095
      END IF                                             #FUN-880095
   ELSE                                                  #FUN-880095
   IF g_apb_sarrno > 0 AND cl_null(g_argv1_apa01) THEN   #FUN-C80078 g_argv1-->g_argv1_apa01
      CONSTRUCT g_wc2 ON apb02,apb33,apb11,apb37,apb21,apb22,apb34,apb06,apb07,  #No.TQC-7B0083   #FUN-810045 30/31移至36後   #FUN-9A0093 add apb37
                         apb12,apb27,   #CHI-B50012 add
                         #apb09,apb35,apb36,apb31,apb32,apb25,apb251,apb26, #FUN-650033 add apb31  #No.FUN-680029 #No.FUN-690080 #TQC-750139 add apb11  #FUN-810045 add apb35/36  #No.FUN-830161 remove apb30 #MOD-C30737 mark
                         apb09,apb31,apb32,apb25,apb251,apb26,apb35,apb36,  #MOD-C30737 add
                         apb930,apb23,apb24,apb08,apb10,apb29     #FUN-670064
                        ,apbud01,apbud02,apbud03,apbud04,apbud05
                        ,apbud06,apbud07,apbud08,apbud09,apbud10
                        ,apbud11,apbud12,apbud13,apbud14,apbud15
             FROM s_apb[1].apb02,s_apb[1].apb33,s_apb[1].apb11,s_apb[1].apb37,  #FUN-9A0093 add apb37 
                  s_apb[1].apb21,s_apb[1].apb22,  #FUN-650033 add apb31 #No.FUN-690080     #TQC-750139 add apb11
                  s_apb[1].apb34,   #No.TQC-7B0083
                  s_apb[1].apb06,s_apb[1].apb07,
                  s_apb[1].apb12,s_apb[1].apb27,   #CHI-B50012 add
                  s_apb[1].apb09,
                  #s_apb[1].apb35,s_apb[1].apb36,s_apb[1].apb31,  #FUN-810045  #No.FUN-830161 remove apb30 #MOD-C30737 mark
                  s_apb[1].apb31,   #MOD-C30737 add
                  s_apb[1].apb32,  #No.FUN-690080
                  s_apb[1].apb25,s_apb[1].apb251,s_apb[1].apb26,
                  s_apb[1].apb35,s_apb[1].apb36,   #MOD-C30737 add  
                  s_apb[1].apb930,s_apb[1].apb23,                  #FUN-670064  #No.FUN-680029
                  s_apb[1].apb24,s_apb[1].apb08,s_apb[1].apb10,
                  s_apb[1].apb29
                 ,s_apb[1].apbud01,s_apb[1].apbud02,s_apb[1].apbud03
		 ,s_apb[1].apbud04,s_apb[1].apbud05,s_apb[1].apbud06
                 ,s_apb[1].apbud07,s_apb[1].apbud08,s_apb[1].apbud09
		 ,s_apb[1].apbud10,s_apb[1].apbud11,s_apb[1].apbud12
                 ,s_apb[1].apbud13,s_apb[1].apbud14,s_apb[1].apbud15
 
	BEFORE CONSTRUCT
	   CALL cl_qbe_display_condition(lc_qbe_sn)
 
         ON ACTION CONTROLP
            CASE
	        WHEN INFIELD(apb11)
                      CALL cl_init_qry_var()
                      LET g_qryparam.state = "c"
                      LET g_qryparam.form ="q_apk03"
                      IF cl_null(l_apa15_wc) THEN
                        LET g_qryparam.arg1 = "'%'"
                        LET g_qryparam.arg2 = "%"
                      ELSE
                        LET g_qryparam.arg1 = l_apa15_wc
                        LET g_qryparam.arg2 = "**"
                      END IF
                      CALL cl_create_qry() RETURNING g_qryparam.multiret
                      DISPLAY g_qryparam.multiret TO apb11
	       WHEN INFIELD(apb31)
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_azf01a"   #FUN-920186
                     LET g_qryparam.arg1 = '7'         #FUN-920186
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apb31
 
               WHEN INFIELD(apb37)
                 CALL cl_init_qry_var()
                 LET g_qryparam.form = "q_azw"
                 LET g_qryparam.state = "c"
                 CALL cl_create_qry() RETURNING g_qryparam.multiret
                 DISPLAY g_qryparam.multiret TO apb37
                 NEXT FIELD apb37
 
               WHEN INFIELD(apb21) OR INFIELD(apb22)
                     IF g_aptype MATCHES '1*' THEN
                      #str FUN-7A0050 add
                       #aapt120單身apb21(暫估單號),apb22(暫估項次)開窗查aapt160費用暫估資料
                        IF g_aptype = '12' THEN
                           CALL cl_init_qry_var()
                           LET g_qryparam.state = "c"
                           LET g_qryparam.form ="q_apb"   
                           CALL cl_create_qry() RETURNING g_qryparam.multiret
                        ELSE
                       #end FUN-7A0050 add
                          #str MOD-B40070 mod
                          #CALL q_rvv(TRUE,TRUE,g_apa.apa05,g_apb[1].apb21,
                          #           g_apb[1].apb22)
                          #RETURNING g_qryparam.multiret
                           CALL q_rvv2(TRUE,TRUE,g_apa.apa05,
                                       g_apb[1].apb21,g_apb[1].apb22,g_apb[1].apb29,g_apb[1].apb37)
                           RETURNING g_qryparam.multiret
                          #end MOD-B40070 mod
                        END IF   #FUN-7A0050 add
                        DISPLAY g_qryparam.multiret TO apb21
                     ELSE
                       #aapt210單身apb21(暫估單號),apb22(暫估項次)開窗查aapt260扣款折讓暫估資料
                        IF g_aptype = '21' THEN
                           CALL cl_init_qry_var()
                           LET g_qryparam.state = "c"
                           LET g_qryparam.form ="q_apb1"   
                           CALL cl_create_qry() RETURNING g_qryparam.multiret
                        ELSE
                           CALL q_rvv2(TRUE,TRUE,g_apa.apa05,
                                       g_apb[1].apb21,g_apb[1].apb22,'3',g_apb[1].apb37)   #FUN-9A0093 
                           RETURNING g_qryparam.multiret
                        END IF   #MOD-850316 add
                        DISPLAY g_qryparam.multiret TO apb21
                     END IF
                  IF INFIELD(apb21) THEN
                     DISPLAY g_qryparam.multiret TO apb21
                  END IF
                  IF INFIELD(apb22) THEN
                     DISPLAY g_qryparam.multiret TO apb22
                  END IF
               WHEN INFIELD(apb25) # Account number
                  CALL cl_init_qry_var()
                  LET g_qryparam.state = "c"
                  LET g_qryparam.form ="q_aag"   #No.TQC-7B0122  #MOD-990250 q_aag10-->q_aag  
                  LET g_qryparam.where = " aag07 MATCHES '[23]' AND aag03 MATCHES '[2]'" #MOD-990250     
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apb25
               WHEN INFIELD(apb251) # Account number
                  CALL cl_init_qry_var()
                  LET g_qryparam.state = "c"
                  LET g_qryparam.form ="q_aag"   #No.TQC-7B0122 #MOD-990250 q_aag10-->q_aag   
                  LET g_qryparam.where = " aag07 MATCHES '[23]' AND aag03 MATCHES '[2]'" #MOD-990250  
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apb251
               WHEN INFIELD(apb26) # Dept CODE
                  CALL cl_init_qry_var()
                  LET g_qryparam.state = "c"
                  #FUN-D80031 add ----------- begin
                  IF g_prog = 'aapt140' THEN
                     LET g_qryparam.form ="q_occ02"
                  ELSE
                     LET g_qryparam.form ="q_gem"
                  END IF
                  #FUN-D80031 add ----------- end
#                 LET g_qryparam.form ="q_gem"    #FUN-D80031 mark
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apb26
               WHEN INFIELD(apb06)
                  CALL cl_init_qry_var()
                  LET g_qryparam.state = "c"
                  LET g_qryparam.form ="q_pmm"
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apb06
               WHEN INFIELD(apb12) #料件編號
                  CALL cl_init_qry_var()
                  LET g_qryparam.state = "c"
                  LET g_qryparam.form ="q_ima"
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apb12
                  NEXT FIELD apb12
               WHEN INFIELD(apb28) #採購單位
                  CALL cl_init_qry_var()
                  LET g_qryparam.state = "c"
                  LET g_qryparam.form ="q_gfe"
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apb28
                  NEXT FIELD apb28
               WHEN INFIELD(apb32) #人員編號
                  CALL cl_init_qry_var()
                  LET g_qryparam.form  = "q_gen"        #No.CHI-780046   
                  LET g_qryparam.state = "c"   #多選
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apb32
                  NEXT FIELD apb32
                WHEN INFIELD(apb35)   #專案
                  CALL cl_init_qry_var()
                  LET g_qryparam.form ="q_pja2"  
                  LET g_qryparam.state = "c"   #多選
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apb35
                  NEXT FIELD apb35
                WHEN INFIELD(apb36)  #WBS
                  CALL cl_init_qry_var()
                  LET g_qryparam.form ="q_pjb4"
                  LET g_qryparam.state = "c"   #多選
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apb36
                  NEXT FIELD apb36
               WHEN INFIELD(apb930)
                  CALL cl_init_qry_var()
                  LET g_qryparam.form  = "q_gem4"
                  LET g_qryparam.state = "c"   #多選
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apb930
                  NEXT FIELD apb930
               OTHERWISE
                  EXIT CASE
            END CASE
 
         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE CONSTRUCT
 
          ON ACTION about         #MOD-4C0121
             CALL cl_about()      #MOD-4C0121
 
          ON ACTION help          #MOD-4C0121
             CALL cl_show_help()  #MOD-4C0121
 
          ON ACTION controlg      #MOD-4C0121
             CALL cl_cmdask()     #MOD-4C0121
 
                    ON ACTION qbe_save
		       CALL cl_qbe_save()
      END CONSTRUCT
 
      IF INT_FLAG THEN
         LET g_apa.apa01 = NULL   #MOD-660086 add
         RETURN
      END IF
   END IF
   END IF   #FUN-880095   
   END IF   #MOD-650085
   
 
   IF g_wc2 = " 1=1" THEN               # 若單身未輸入條件
      LET g_sql = "SELECT apa01 FROM apa_file ",
                  " WHERE ", g_wc CLIPPED,
                  "   AND apa00 = '",g_aptype,"'",
                  " ORDER BY apa01"
   ELSE                         # 若單身有輸入條件
      LET g_sql = "SELECT UNIQUE apa01 ",
                  "  FROM apa_file, apb_file ",
                  " WHERE apa01 = apb01",
                  "   AND ", g_wc CLIPPED, " AND ",g_wc2 CLIPPED,
                  "   AND apa00 = '",g_aptype,"'",
                  " ORDER BY apa01"
   END IF
 
   PREPARE t110_prepare FROM g_sql
   DECLARE t110_cs                         #SCROLL CURSOR
       SCROLL CURSOR WITH HOLD FOR t110_prepare
   DECLARE t110_list_cs CURSOR FOR t110_prepare  #FUN-CB0080 add
   IF g_wc2 = " 1=1" THEN               # 取合乎條件筆數
      LET g_sql="SELECT COUNT(*) FROM apa_file WHERE ",g_wc CLIPPED,
                "   AND apa00 = '",g_aptype,"'"
   ELSE
      LET g_sql="SELECT COUNT(DISTINCT apa01) FROM apa_file,apb_file WHERE ",
                "apb01=apa01 AND ",g_wc CLIPPED," AND ",g_wc2 CLIPPED,
                "   AND apa00 = '",g_aptype,"'"
   END IF
 
   PREPARE t110_precount FROM g_sql
   DECLARE t110_count CURSOR FOR t110_precount
 
END FUNCTION
 
FUNCTION t110_menu()
   DEFINE l_creator    LIKE type_file.chr1        # No.FUN-690028 VARCHAR(1)
   DEFINe l_flowuser   LIKE type_file.chr1        # No.FUN-690028 VARCHAR(1)         # 是否有指定加簽人員      #FUN-580011
   DEFINE l_azp03      LIKE azp_file.azp03  # FUN-630043
   DEFINE l_pmb02      LIKE pmb_file.pmb02  #TQC-770027
   DEFINE l_cnt        LIKE type_file.num5  #No.MOD-890007  
   DEFINE l_npq22 LIKE npq_file.npq22   #TQC-C60104  add
   DEFINE g_nmz10         LIKE nmz_file.nmz10 #cjy20130930
 
   LET l_flowuser = "N"
   #FUN-D80031 add ----- begin
   IF g_prog <> 'aapt140' THEN
      CALL cl_set_act_visible('to_be_accounted',FALSE)
   END IF
   #FUN-D80031 add ----- end
 
   WHILE TRUE
      CALL t110_bp("G")
      CASE g_action_choice
 
      WHEN "insert"
         IF cl_chk_act_auth() THEN
            CALL t110_a()
            CALL t110_list_fill()   #FUN-CB0080
         END IF
      WHEN "delete"
         IF cl_chk_act_auth() THEN
            CALL t110_r()
            CALL t110_list_fill()   #FUN-CB0080
         END IF
      WHEN "modify"
         IF cl_chk_act_auth() THEN
            CALL t110_u()
            CALL t110_list_fill()   #FUN-CB0080
         END IF
      WHEN "query"
         IF cl_chk_act_auth() THEN
            CALL t110_q()
         END IF
      WHEN "first"
         CALL t110_fetch('F')
      WHEN "previous"
         CALL t110_fetch('P')
      WHEN "jump"
         CALL t110_fetch('/')
      WHEN "next"
         CALL t110_fetch('N')
      WHEN "last"
         CALL t110_fetch('L')
      WHEN "reproduce"
         IF cl_chk_act_auth() THEN
            CALL t110_copy()
         END IF
      WHEN "detail"
         IF cl_chk_act_auth() THEN
            IF g_aza.aza53='Y' THEN
               SELECT azp03 INTO l_azp03 FROM azp_file WHERE azp01=g_apa.apa100
               IF STATUS THEN LET l_azp03=g_dbs END IF
               IF g_dbs!=l_azp03 AND (g_apa.apa100='11' OR g_apa.apa100='12' OR g_apa.apa100='15' OR g_apa.apa100='21' OR g_apa.apa100='22') THEN  
                  DATABASE l_azp03    
                  CALL cl_ins_del_sid(1,g_apa.apa100) #FUN-980030   #FUN-990069
                  CALL t110_b('b')
                  DATABASE g_dbs  
                  CALL cl_ins_del_sid(1,g_plant) #FUN-980030   #FUN-990069
               ELSE
                  CALL t110_b('b')
               END IF
            ELSE
               CALL t110_b('b')
            END IF
         ELSE
            LET g_action_choice = NULL
         END IF
      WHEN "help"
         CALL cl_show_help()
      WHEN "exit"
         EXIT WHILE
      WHEN "controlg"
         CALL cl_cmdask()
 
      WHEN "exporttoexcel"
          IF cl_chk_act_auth() THEN
             #CALL cl_export_to_excel                                         #FUN-D60015 mark      
             #(ui.Interface.getRootNode(),base.TypeInfo.create(g_apb),'','')  #FUN-D60015 mark

             #FUN-D60015---add---str---
             LET w = ui.Window.getCurrent()
             LET f = w.getForm()
             IF cl_null(g_bp_flag) OR g_bp_flag = "main" THEN
                LET page = f.FindNode("Page","page1")
                CALL cl_export_to_excel(page,base.TypeInfo.create(g_apb),'','')
             END IF
             IF g_bp_flag = "list" THEN
                LET page = f.FindNode("Page","page2")
                CALL cl_export_to_excel(page,base.TypeInfo.create(g_apa_1),'','')
             END IF
             #FUN-D60015---add---end---
          END IF
 
      WHEN "account_period"
         IF cl_chk_act_auth() THEN
            CALL t110_account_period()
         END IF
      WHEN "on_hold"
         IF cl_chk_act_auth() THEN
            CALL t110_hold()
         END IF
      WHEN "undo_on_hold"
         IF cl_chk_act_auth() THEN
            CALL t110_unhold()
         END IF
      WHEN "mul_invoice"
         CALL t110_ddd('2')   #MOD-950112 add參數
         DISPLAY BY NAME g_apa.apa07      #TQC-630164 
         CALL t110_diff_rtn('0')          #MOD-B80300
         CALL t110_show_multi_invoice()   #No.TQC-A30076 
      WHEN "mul_debit"
         IF g_apa.apa51='MISC' OR g_apa.apa511 ='MISC' THEN         #No.FUN-680029
            CALL t110_ccc('1')
         #No.TQC-A30133  --Begin                                                
         ELSE                                                                   
            CALL cl_err(g_apa.apa51,'aap-704',0)                                
         #No.TQC-A30133  --End
         END IF
      WHEN "contra_tmp_est"
            CALL t110_ppp('2')
      WHEN "qry_contra"
         CALL t110_pay_record()
      WHEN "memo"
         CALL t110_m()
      WHEN "var_process"
         IF cl_chk_act_auth() THEN
            IF NOT cl_null(g_apa.apa01) THEN   #No.TQC-860014
               CALL t110_diff_rtn('0')  #TQC-750140
              #CALL t110_api_diff()     #No.TQC-7B0083   #MOD-C60107 mark
            END IF                             #No.TQC-860014
         END IF
      WHEN "output"
         IF cl_chk_act_auth() THEN
            CALL t110_out('o')
         END IF
      WHEN "contra"
         CASE
            WHEN g_aptype = '16' OR g_aptype = '26'
               CALL cl_err(g_apa.apa01,'aap-926',0)
            WHEN g_apa.apa42 = 'Y'
               CALL cl_err(g_apa.apa01,'aap-927',0)
            OTHERWISE
               IF g_aptype = '13' OR g_aptype = '17' THEN  #TQC-750139
                  CALL t110_k_2()
                  CALL t110_apc_check2()   #MOD-8C0082 add
               ELSE
                  CALL t110_k()
                  CALL t110_apc_check2()   #CHI-820015
               END IF
         END CASE

     #No.FUN-D70028 ---Add--- Start
      WHEN "expenses"
         IF cl_chk_act_auth() THEN
            CALL t110_e()
         END IF
     #No.FUN-D70028 ---Add--- End

     #No.FUN-D80031 add ------ begin
      WHEN "to_be_accounted"
         IF cl_chk_act_auth() THEN
            CALL t110_to_be_accounted()
         END IF
     #No.FUN-D80031 add ------ end
      WHEN "revert" #還款
         IF cl_chk_act_auth() THEN
            CALL t110_k_1()
            CALL t110_list_fill()   #FUN-CB0080
         END IF
      WHEN "revert_query" #還款查詢
         IF cl_chk_act_auth() THEN
            CALL t110_pay_record_1()
         END IF
      WHEN "modify_date"
         IF cl_chk_act_auth() THEN
            CALL t110_date()
            CALL t110_list_fill()   #FUN-CB0080
         END IF
      WHEN "pay_direct"
         IF cl_chk_act_auth() THEN
            IF cl_null(g_apa.apa01) THEN 
#              RETURN                                    #TQC-A70123 Mark                                                           
               CALL cl_err('','axr-072',1)               #TQC-A70123 Add                                                            
               LET g_action_choice = NULL                #TQC-A70123 Add                                                            
               CONTINUE WHILE                            #TQC-A70123 Add 
            END IF 
           #-MOD-BB0304-add-

         #cjy20130930 --- begin 直接付款不能大于票据关帐
          LET g_nmz10 = ''
          SELECT nmz10 INTO g_nmz10 FROM nmz_file
          #IF g_nmz10 > g_apa.apa02 THEN
          IF g_nmz10 >= g_apa.apa02 THEN   #MOD-DB0017
             CALL cl_err('','cxr-072',1)
             LET g_action_choice = NULL 
             CONTINUE WHILE
          END IF
         #cjy20130930 --- end
            IF g_apa.apa63 MATCHES '[Ss]' THEN
               CALL cl_err('','mfg3557',0)
               LET g_action_choice = NULL            
               CONTINUE WHILE         
            END IF
           #-MOD-BB0304-end-
            LET l_cnt = 0 
            SELECT COUNT(*) INTO l_cnt FROM apb_file 
             WHERE apb01=g_apa.apa01 AND apb34='Y'
            CASE
              #FUN-C70075--mark--str
              #WHEN (g_apa.apa51 = 'UNAP' OR l_cnt > 0 ) #No.MOD-890007 
              #   CALL cl_err(g_apa.apa51,'aap-029',0)   #No.MOD-890007 
              #FUN-C70075--mark--end
               WHEN g_apa.apa42 = 'Y' #已作廢
                  CALL cl_err(g_apa.apa01,'aap-165',0)
               WHEN g_aptype = '16' OR g_aptype = '26'
                  CALL cl_err(g_apa.apa01,'aap-926',0)
               OTHERWISE
                  CALL t110_w(g_apa.apa01)
                  SELECT * INTO g_apa.* FROM apa_file WHERE apa01=g_apa.apa01
                  CALL t110_unpay()     #No.MOD-650063
                  DISPLAY BY NAME g_apa.apa55,g_apa.apa35f,g_apa.apa35   #TQC-630088
                     LET g_apa_t.apa31 =g_apa.apa31
                     LET g_apa_t.apa32 =g_apa.apa32
                     LET g_apa_t.apa34 =g_apa.apa34
                     LET g_apa_t.apa57 =g_apa.apa57
                     LET g_apa_t.apa73 =g_apa.apa73
                     LET g_apa_t.apa31f =g_apa.apa31f
                     LET g_apa_t.apa32f =g_apa.apa32f
                     LET g_apa_t.apa34f =g_apa.apa34f
                     LET g_apa_t.apa57f =g_apa.apa57f
                       IF g_apa.apa35 <> g_apa_t.apa35 OR g_apa.apa35f <> g_apa_t.apa35f THEN
                          LET g_sn = 'y'
                       END IF
                       IF g_apa.apa41 != 'Y' THEN
                          CALL t110_apc_check('w')
                       ELSE
                          CALL t110_apc_check('')
                       END IF
                       LET g_sn = 'n'
                    #IF g_apa.apa41 <> 'Y' THEN                            #No.MOD-8B0090 #MOD-C30063 mark
                     IF g_apa.apa41 <> 'Y' AND g_apy.apydmy3 = 'Y' THEN    #MOD-C30063 add
                        CALL t110_g_gl(g_apa.apa00,g_apa.apa01,'0','')   #FUN-9C0001  add ''
                        IF g_aza.aza63 ='Y' THEN 
                           CALL t110_g_gl(g_apa.apa00,g_apa.apa01,'1','')   #FUN-9C0001 add ''
                        END IF
                     END IF    #No.MOD-8B0090
            END CASE
            CALL t110_list_fill()   #FUN-CB0080
         END IF
      WHEN "gen_entry"
         IF cl_chk_act_auth() THEN
            CALL t110_v0()   #MOD-740030
         END IF
      WHEN "entry_sheet"
         IF cl_chk_act_auth() THEN
            CALL t110_sheet('0')
            CALL t110_npp02('0')             #No.FUN-680029
         END IF
   
      WHEN "entry_sheet2"
         IF cl_chk_act_auth() THEN
            CALL t110_sheet('1')
            CALL t110_npp02('1')
         END IF
 
      WHEN "T_T_entry_sheet"
         IF cl_chk_act_auth() THEN
            CALL t110_sheet('0')
            CALL t110_npp02('0')
         END IF
 
      WHEN "T_T_entry_sheet2"
         IF cl_chk_act_auth() THEN
            CALL t110_sheet('1')
            CALL t110_npp02('1')
         END IF
 
      WHEN "carry_voucher" 
         IF cl_chk_act_auth() THEN
            IF g_apa.apa41 = 'Y' THEN  
               CALL t110_carry_voucher() 
            ELSE 
               CALL cl_err('','atm-402',1)
            END IF 
            
         END IF 
      WHEN "undo_carry_voucher" 
         IF cl_chk_act_auth() THEN
            IF g_apa.apa41 = 'Y' THEN 
               CALL t110_undo_carry_voucher()
            ELSE 
               CALL cl_err('','atm-403',1)
            END IF
         END IF 
 
      WHEN "appor_expense"
         IF cl_chk_act_auth() THEN
            CALL t110_appor_expense()
         END IF
         
      WHEN "void"
         IF cl_chk_act_auth() THEN
           #CALL t110_c()                   #FUN-D20035
            CALL t110_c(1)                   #FUN-D20035
            IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF
            CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,"")   #FUN-540041
            CALL t110_list_fill()   #FUN-CB0080
         END IF

      #FUN-D20035----add--str
      WHEN "undo_void"
         IF cl_chk_act_auth() THEN
            CALL t110_c(2)                   
            IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF
            CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,"")  
            CALL t110_list_fill()   
         END IF
      #FUN-D20035----add---end

      WHEN "single_invoice"
         CALL t110_apa17('u')
         DISPLAY BY NAME g_apa.apa07   #TQC-630164 
         DISPLAY BY NAME g_apa.apa24,g_apa.apa12,g_apa.apa64  #MOD-9C0148 add
 
      WHEN "qry_contra_tmp_est"
         IF g_aptype = '16' THEN   #TQC-7B0117
            CALL t110_5()
         END IF
 
      WHEN "qry_bill_allowance"
         CALL t110_21()
 
      WHEN "confirm"
         IF cl_chk_act_auth() THEN
            #FUN-C90079 add--str
            IF g_aza.aza26 = '2' AND (g_aptype = '11' OR g_aptype = '12' ) THEN
               CALL t110_auto_contra() 
            END IF
            #FUN-C90079--add--end
            CALL s_showmsg_init() #CHI-A80031 add
            #TQC-C60104--add--str--
            IF g_aza.aza63 = 'Y' THEN
               SELECT DISTINCT(npq22) INTO l_npq22 FROM npq_file WHERE npq01 = g_apa.apa01 AND npqtype='1'
            ELSE
               SELECT DISTINCT(npq22) INTO l_npq22 FROM npq_file WHERE npq01 = g_apa.apa01 AND npqtype='0'
            END IF
            IF l_npq22 != g_apa.apa07 THEN
               IF cl_confirm('aap-943') THEN
                  CALL t110_v0()
               END IF
            END IF
            #TQC-C60104--add--end--
            CALL t110_firm1_chk()          #CALL 原確認的 check 段
            IF g_success = "Y" THEN
               CALL t110_firm1_upd()       #CALL 原確認的 update 段
            END IF
            CALL s_showmsg()  #CHI-A80031 add
            CALL t110_show()               #No.FUN-670060
            CALL t110_list_fill()   #FUN-CB0080
         END IF
      WHEN "undo_confirm"
         IF cl_chk_act_auth() THEN
         	  #No.MOD-D50049  --Begin
         	  LET g_cnt = 0 
         	  SELECT COUNT(*) INTO g_cnt FROM cap_file WHERE cap04 = g_apa.apa01 AND cap15 = 'Y'
         	  IF g_cnt >0 THEN
         	     CALL cl_err(g_apa.apa01,"aap-170",0)   
               CONTINUE WHILE
         	  END IF
         	  #No.MOD-D50049  --End
            SELECT * INTO g_apa.* FROM apa_file WHERE apa01=g_apa.apa01 #MOD-980218    
            IF cl_null(g_apa.apa992) THEN                      #No.FUN-690090      
               #CALL t110_firm2() #FUN-CB0094 mark
               CALL s_t110_unconfirm(g_aptype,g_apa.apa01,g_apa.apa41,g_apb[1].apb06,g_apb[1].apb37,g_plant_nm) #FUN-CB0094   
               #yinhy131012  --Begin
               SELECT apa44,apa43 INTO g_apa.apa44,g_apa.apa43 FROM apa_file 
                WHERE apa01 = g_apa.apa01
               DISPLAY BY NAME g_apa.apa44
               #yinhy131012  --End
            ELSE                                      #No.FUN-690090  
               CALL cl_err(g_apa.apa992,"aap-066",0)  #No.FUN-690090   
               CONTINUE WHILE                         #No.FUN-690090  
            END IF                                    #No.FUN-690090  
            #IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF  #FUN-CB0094 mark
            #CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,g_apa.apaacti) #FUN-CB0094 mark
            CALL t110_list_fill()   #FUN-CB0080
         END IF
 
      #@WHEN "准"
      WHEN "agree"
         IF g_laststage = "Y" AND l_flowuser = "N" THEN  #最後一關並且沒有加簽人員
            CALL t110_firm1_upd()      #CALL 原確認的 update 段
         ELSE
            LET g_success = "Y"
            IF NOT aws_efapp_formapproval() THEN
               LET g_success = "N"
            END IF
         END IF
         IF g_success = 'Y' THEN
            IF cl_confirm('aws-081') THEN  #詢問是否繼續下一筆資料的簽核
              IF aws_efapp_getnextforminfo() THEN #取得下一筆簽核單號
                 LET l_flowuser = "N"
                 LET g_argv1_apa01 = aws_efapp_wsk(1)   #取得單號  #FUN-C80078 g_argv1-->g_argv1_apa01
                 IF NOT cl_null(g_argv1_apa01) THEN     #自動 query 帶出資料  #FUN-C80078 g_argv1-->g_argv1_apa01
                   CALL t110_q()
                  #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
                   CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, undo_void,   #FUN-D20025 add--undo_void
                                              confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,
                                              mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
                        RETURNING g_laststage
                 ELSE
                     EXIT WHILE
                 END IF
               ELSE
                 EXIT WHILE
               END IF
            ELSE
               EXIT WHILE
            END IF
         END IF
 
      #@WHEN "不准"
       WHEN "deny"
       IF (l_creator := aws_efapp_backflow()) IS NOT NULL THEN
            IF aws_efapp_formapproval() THEN
               IF l_creator = "Y" THEN
                  LET g_apa.apa63= 'R'
                  DISPLAY BY NAME g_apa.apa63
               END IF
               IF cl_confirm('aws-081') THEN     #詢問是否繼續下一筆資料的簽核
                  IF aws_efapp_getnextforminfo() THEN #取得下一筆簽核單號
                    LET l_flowuser = "N"
                    LET g_argv1_apa01 = aws_efapp_wsk(1)    #取得單號  #FUN-C80078 g_argv1-->g_argv1_apa01
                    IF NOT cl_null(g_argv1_apa01) THEN      #自動 query 帶出資料  #FUN-C80078 g_argv1-->g_argv1_apa01
                       CALL t110_q()
                     #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
                       #CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, 
                       #                            confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
                       CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void, undo_void,   #FUN-D20025 add--undo_void
                                                  confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
                           RETURNING g_laststage
                    ELSE
                          EXIT WHILE
                    END IF
                  ELSE
                     EXIT WHILE
                  END IF
               ELSE
                  EXIT WHILE
               END IF
            END IF
         END IF
 
      #@WHEN "加簽"
      WHEN "modify_flow"
           IF aws_efapp_flowuser() THEN   #選擇欲加簽人員
              LET l_flowuser = 'Y'
           ELSE
              LET l_flowuser = 'N'
           END IF
 
      #@WHEN "撤簽"
      WHEN "withdraw"
           IF cl_confirm("aws-080") THEN
              IF aws_efapp_formapproval() THEN
                 EXIT WHILE
              END IF
           END IF
 
      #@WHEN "抽單"
      WHEN "org_withdraw"
           IF cl_confirm("aws-079") THEN
              IF aws_efapp_formapproval() THEN
                 EXIT WHILE
                 END IF
           END IF
 
      #@WHEN "簽核意見"
      WHEN "phrase"
           CALL aws_efapp_phrase()
 
     #@WHEN "簽核狀況"
      WHEN "approval_status"               # MOD-4C0041
          IF cl_chk_act_auth() THEN        #DISPLAY ONLY
             IF aws_condition2() THEN                #FUN-550042
                  CALL aws_efstat2()                  #MOD-560007
             END IF
          END IF
 
       WHEN "easyflow_approval"     #FUN-550042
          IF cl_chk_act_auth() THEN
              #FUN-C20010 add str---
               SELECT * INTO g_apa.* FROM apa_file
                WHERE apa01 = g_apa.apa01
               CALL t110_show()
               CALL t110_b_fill(' 1=1')
              #FUN-C20010 add end---
               CALL t110_ef()
               CALL t110_show()  #FUN-C20010 add
          END IF
 
       WHEN "related_document"  #相關文件
            IF cl_chk_act_auth() THEN
               IF g_apa.apa01 IS NOT NULL THEN
               LET g_doc.column1 = "apa01"
               LET g_doc.value1 = g_apa.apa01
               CALL cl_doc()
             END IF
       END IF
#No.FUN-A30106 --begin                                                          
       WHEN "drill_down"                                                        
          IF cl_chk_act_auth() THEN                                             
             CALL t110_drill_down()                                             
          END IF                                                                
#No.FUN-A30106 --end 
      END CASE
   END WHILE
END FUNCTION
 
FUNCTION t210_menu()
   DEFINE l_creator    LIKE type_file.chr1        # No.FUN-690028 VARCHAR(1)
   DEFINe l_flowuser   LIKE type_file.chr1        # No.FUN-690028 VARCHAR(1)         # 是否有指定加簽人員      #FUN-580011
   DEFINE l_azp03      LIKE azp_file.azp03  # FUN-630043
 
   LET l_flowuser = "N"
 
   WHILE TRUE
      CALL t210_bp("G")
      CASE g_action_choice
 
      WHEN "insert"
         IF cl_chk_act_auth() THEN
            CALL t110_a()
            CALL t110_list_fill()   #FUN-CB0080
         END IF
      WHEN "query"
         IF cl_chk_act_auth() THEN
            CALL t110_q()
         END IF
     #MOD-9C0437---add---start---
      WHEN "single_invoice"
         CALL t110_apa17('u')
         DISPLAY BY NAME g_apa.apa07  
         DISPLAY BY NAME g_apa.apa24,g_apa.apa12,g_apa.apa64 
     #MOD-9C0437---add---end---
      WHEN "first"
         CALL t110_fetch('F')
      WHEN "previous"
         CALL t110_fetch('P')
      WHEN "jump"
         CALL t110_fetch('/')
      WHEN "next"
         CALL t110_fetch('N')
      WHEN "last"
         CALL t110_fetch('L')
      WHEN "modify"
         IF cl_chk_act_auth() THEN
            CALL t110_u()
            CALL t110_list_fill()   #FUN-CB0080
         END IF
      WHEN "delete"
         IF cl_chk_act_auth() THEN
            CALL t110_r()
            CALL t110_list_fill()   #FUN-CB0080
         END IF
      WHEN "detail"
         IF cl_chk_act_auth() THEN
            IF g_aza.aza53='Y' THEN
               SELECT azp03 INTO l_azp03 FROM azp_file WHERE azp01=g_apa.apa100
               IF STATUS THEN LET l_azp03=g_dbs END IF
               IF g_dbs!=l_azp03 AND (g_apa.apa100='11' OR g_apa.apa100='12' OR g_apa.apa100='15' OR g_apa.apa100='21' OR g_apa.apa100='22') THEN  
                  DATABASE l_azp03    
                  CALL cl_ins_del_sid(1,g_apa.apa100) #FUN-980030  ##FUN-990069
                  CALL t110_b('b')
                  DATABASE g_dbs  
                  CALL cl_ins_del_sid(1,g_plant) #FUN-980030  #FUN-990069
               ELSE
                  CALL t110_b('b')
               END IF
            ELSE
               CALL t110_b('b')
            END IF
         ELSE
            LET g_action_choice = NULL
         END IF
      WHEN "account_period"
         IF cl_chk_act_auth() THEN
            CALL t110_account_period()
         END IF
      WHEN "contra_tmp_est"
            CALL t110_ppp('2')
      WHEN "help"
         CALL cl_show_help()
      WHEN "output"
         IF cl_chk_act_auth() THEN
            LET g_wc = 'apa01="',g_apa.apa01,'"'           # "新增"則印單張
            IF g_aza.aza26 = '2' THEN
               CALL t210_out1()        
            ELSE
              CALL t210_out()          #NO.FUN-840132
            END IF
         END IF
      WHEN "exit"
         EXIT WHILE
      WHEN "controlg"
         CALL cl_cmdask()
      WHEN "gen_entry"
         IF cl_chk_act_auth() THEN
            CALL t110_v0()   #MOD-740030
         END IF
      WHEN "entry_sheet"
         IF cl_chk_act_auth() THEN
            CALL t110_sheet('0') 
            CALL t110_npp02('0')       #No.FUN-680029
         END IF
 
      WHEN "entry_sheet2"
         IF cl_chk_act_auth() THEN
            CALL t110_sheet('1') 
            CALL t110_npp02('1')
         END IF
 
      WHEN "T_T_entry_sheet"
         IF cl_chk_act_auth() THEN
            CALL t110_sheet('0')
            CALL t110_npp02('0')           
         END IF
 
      WHEN "T_T_entry_sheet2"
         IF cl_chk_act_auth() THEN
            CALL t110_sheet('1')
            CALL t110_npp02('1')           
         END IF
 
      WHEN "carry_voucher" 
         IF cl_chk_act_auth() THEN                 #MOD-A80208
            IF g_apa.apa41 = 'Y' THEN  
               CALL t110_carry_voucher() 
            ELSE 
               CALL cl_err('','atm-402',1)
            END IF 
         END IF                                    #MOD-A80208
        	     
      WHEN "undo_carry_voucher" 
         IF cl_chk_act_auth() THEN                 #MOD-A80208
            IF g_apa.apa41 = 'Y' THEN 
               CALL t110_undo_carry_voucher()
            ELSE 
               CALL cl_err('','atm-403',1)
            END IF
         END IF                                    #MOD-A80208
 
      WHEN "void"
         IF cl_chk_act_auth() THEN                 #MOD-A80208
           #CALL t110_c()                           #FUN-D20035
            CALL t110_c(1)                          #FUN-D20035
            IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF   #FUN-540041
            CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,"")   #FUN-540041
            CALL t110_list_fill()   #FUN-CB0080
         END IF                                    #MOD-A80208

      #FUN-D20035----add--str
      WHEN "undo_void"
         IF cl_chk_act_auth() THEN                 #MOD-A80208
            CALL t110_c(2)                
            IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF   #FUN-540041
            CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,"")   #FUN-540041
            CALL t110_list_fill()   #FUN-CB0080
         END IF                          
      #FUN-D20035----add---end
    
      WHEN "on_hold"
         IF cl_chk_act_auth() THEN
            CALL t110_hold()
         END IF
      WHEN "undo_on_hold"
         IF cl_chk_act_auth() THEN
            CALL t110_unhold()
         END IF
      WHEN "mul_invoice"
         CALL t110_ddd('2')   #MOD-950112 add參數
         DISPLAY BY NAME g_apa.apa07      #TQC-630164 
         CALL t110_show_multi_invoice()   #No.TQC-A30076 
     WHEN "invoice_detail"
        CALL t110_inv()
      WHEN "qry_contra"
         CALL t110_pay_record()
      WHEN "memo"
         IF cl_chk_act_auth() THEN
            CALL t110_m()
         END IF
      WHEN "confirm"
         IF cl_chk_act_auth() THEN
            CALL s_showmsg_init() #CHI-A80031 add
            CALL t110_firm1_chk()          #CALL 原確認的 check 段
            IF g_success = "Y" THEN
               CALL t110_firm1_upd()       #CALL 原確認的 update 段
            END IF
            CALL s_showmsg()        #CHI-A80031 add
            CALL t110_show()        #MOD-D40150 add
            CALL t110_list_fill()   #FUN-CB0080
         END IF
      WHEN "undo_confirm"
         IF cl_chk_act_auth() THEN
            SELECT * INTO g_apa.* FROM apa_file WHERE apa01=g_apa.apa01 #MOD-980218    
            IF cl_null(g_apa.apa992) THEN              #No.FUN-690090            
               #CALL t110_firm2() #FUN-CB0094 mark
               CALL s_t110_unconfirm(g_aptype,g_apa.apa01,g_apa.apa41,g_apb[1].apb06,g_apb[1].apb37,g_plant_nm) #FUN-CB0094
               #yinhy131012  --Begin
               SELECT apa44,apa43 INTO g_apa.apa44,g_apa.apa43 FROM apa_file 
                WHERE apa01 = g_apa.apa01
               DISPLAY BY NAME g_apa.apa44
               #yinhy131012  --End
            ELSE                                       #No.FUN-690090   
               CALL cl_err(g_apa.apa992,"aap-066",0)   #No.FUN-690090   
               CONTINUE WHILE                          #No.FUN-690090     
            END IF                                     #No.FUN-690090 
            #IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF #FUN-CB0094 mark
            #CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,g_apa.apaacti) #FUN-CB0094 mark
            CALL t110_list_fill()   #FUN-CB0080
         END IF
 
      WHEN "exporttoexcel"
          IF cl_chk_act_auth() THEN
             #CALL cl_export_to_excel                                            #FUN-D60015 mark
             #(ui.Interface.getRootNode(),base.TypeInfo.create(g_apb),'','')     #FUN-D60015 mark

             #FUN-D60015---add---str---
             LET w = ui.Window.getCurrent()
             LET f = w.getForm()
             IF cl_null(g_bp_flag) OR g_bp_flag = "main" THEN
                LET page = f.FindNode("Page","page1")
                CALL cl_export_to_excel(page,base.TypeInfo.create(g_apb),'','')
             END IF
             IF g_bp_flag = "list" THEN
                LET page = f.FindNode("Page","page2")
                CALL cl_export_to_excel(page,base.TypeInfo.create(g_apa_1),'','')
             END IF
             #FUN-D60015---add---end---
          END IF

      #@WHEN "准"
      WHEN "agree"
         IF g_laststage = "Y" AND l_flowuser = "N" THEN  #最後一關並且沒有加簽人員
            CALL t110_firm1_upd()      #CALL 原確認的 update 段
         ELSE
            LET g_success = "Y"
            IF NOT aws_efapp_formapproval() THEN
               LET g_success = "N"
            END IF
         END IF
         IF g_success = 'Y' THEN
            IF cl_confirm('aws-081') THEN  #詢問是否繼續下一筆資料的簽核
              IF aws_efapp_getnextforminfo() THEN #取得下一筆簽核單號
                 LET l_flowuser = "N"
                 LET g_argv1_apa01 = aws_efapp_wsk(1)   #取得單號  #FUN-C80078 g_argv1-->g_argv1_apa01
                 IF NOT cl_null(g_argv1_apa01) THEN     #自動 query 帶出資料  #FUN-C80078 g_argv1-->g_argv1_apa01
                   CALL t110_q()
                  #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
                   CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void,   undo_void,   #FUN-D20025 add--undo_void
                                              confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
                        RETURNING g_laststage
                 ELSE
                     EXIT WHILE
                 END IF
               ELSE
                 EXIT WHILE
               END IF
            ELSE
               EXIT WHILE
            END IF
         END IF
 
      #@WHEN "不准"
      WHEN "deny"
         IF (l_creator := aws_efapp_backflow()) IS NOT NULL THEN
            IF aws_efapp_formapproval() THEN
               IF l_creator = "Y" THEN
                  LET g_apa.apa63 = 'R'
                  DISPLAY BY NAME g_apa.apa63
               END IF
               IF cl_confirm('aws-081') THEN     #詢問是否繼續下一筆資料的簽核
                  IF aws_efapp_getnextforminfo() THEN #取得下一筆簽核單號
                    LET l_flowuser = "N"
                    LET g_argv1_apa01 = aws_efapp_wsk(1)    #取得單號  #FUN-C80078 g_argv1-->g_argv1_apa01
                    IF NOT cl_null(g_argv1_apa01) THEN      #自動 query 帶出資料  #FUN-C80078 g_argv1-->g_argv1_apa01
                       CALL t110_q()
                     #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
                       CALL aws_efapp_flowaction("insert, modify, delete, reproduce, detail, query,locale, void,   undo_void,   #FUN-D20025 add--undo_void
                                                  confirm, undo_confirm, easyflow_approval,on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,carry_voucher,undo_carry_voucher,account_period,appor_expense")  #No.FUN-680029  #TQC-740281   #FUN-830091
                           RETURNING g_laststage
                    ELSE
                          EXIT WHILE
                    END IF
                  ELSE
                     EXIT WHILE
                  END IF
               ELSE
                  EXIT WHILE
               END IF
            END IF
         END IF
 
      #@WHEN "加簽"
      WHEN "modify_flow"
           IF aws_efapp_flowuser() THEN   #選擇欲加簽人員
              LET l_flowuser = 'Y'
           ELSE
              LET l_flowuser = 'N'
           END IF
 
      #@WHEN "撤簽"
      WHEN "withdraw"
           IF cl_confirm("aws-080") THEN
              IF aws_efapp_formapproval() THEN
                 EXIT WHILE
              END IF
           END IF
 
      #@WHEN "抽單"
      WHEN "org_withdraw"
           IF cl_confirm("aws-079") THEN
              IF aws_efapp_formapproval() THEN
                 EXIT WHILE
                 END IF
           END IF
 
      #@WHEN "簽核意見"
      WHEN "phrase"
           CALL aws_efapp_phrase()
 
    #@WHN "簽核狀況"
     WHEN "approval_status"               # MOD-4C0041
         IF cl_chk_act_auth() THEN        #DISPLAY ONLY
            IF aws_condition2() THEN                #FUN-550042
                 CALL aws_efstat2()                  #MOD-560007
            END IF
         END IF
 
      WHEN "easyflow_approval"     #FUN-550042
         IF cl_chk_act_auth() THEN
              CALL t110_ef()
         END IF
 
      WHEN "related_document"  #相關文件
           IF cl_chk_act_auth() THEN
              IF g_apa.apa01 IS NOT NULL THEN
              LET g_doc.column1 = "apa01"
              LET g_doc.value1 = g_apa.apa01
              CALL cl_doc()
            END IF
      END IF
#No.FUN-A30106 --begin                                                          
       WHEN "drill_down"                                                        
          IF cl_chk_act_auth() THEN                                             
             CALL t110_drill_down()                                             
          END IF                                                                
#No.FUN-A30106 --end 
      #No.FUN-BC0031  --Begin
      WHEN "var_process"
         IF cl_chk_act_auth() THEN
            IF NOT cl_null(g_apa.apa01) THEN   #No.TQC-860014
               CALL t110_diff_rtn('0')  #TQC-750140
               CALL t110_api_diff()     #No.TQC-7B0083
            END IF                             #No.TQC-860014
         END IF
       #No.FUN-BC0031  --End
      END CASE
   END WHILE
END FUNCTION
 
FUNCTION t230_menu()
    MENU ""
 
        BEFORE MENU
            CALL cl_navigator_setting( g_curs_index, g_row_count )
            IF g_aptype <> '25' THEN
               CALL cl_set_act_visible("revert_query",FALSE)
            END IF
 
         ON ACTION query
            LET g_action_choice="query"
            IF cl_chk_act_auth() THEN
               CALL t110_q()
            END IF
         ON ACTION first
            CALL t110_fetch('F')         #MOD-B50228 mod P -> F
         ON ACTION jump
            CALL t110_fetch('/')
         ON ACTION previous
            CALL t110_fetch('P')
         ON ACTION next
            CALL t110_fetch('N')
         ON ACTION last
            CALL t110_fetch('L')
         ON ACTION help
            CALL cl_show_help()
         ON ACTION exit
            LET g_action_choice = "exit"
            EXIT MENU
         ON ACTION controlg
            CALL cl_cmdask()
         ON ACTION qry_contra
            CALL t110_pay_record()
         ON ACTION revert_query
            CALL t110_pay_record_1()
         #No.TQC-C20421 --Begin
         #ON ACTION account_period
         #      CALL t110_account_period()
         #No.TQC-C20421 --End
         ON ACTION locale
            CALL cl_dynamic_locale()
            CALL cl_show_fld_cont()   #FUN-550037(smin)
            LET g_chr2= 'N'
            CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,g_apa.apaacti)
         ON IDLE g_idle_seconds
            CALL cl_on_idle()
 
         ON ACTION about         #MOD-4C0121
            CALL cl_about()      #MOD-4C0121
 
         ON ACTION related_document       #相關文件
            LET g_action_choice="related_document"
              IF cl_chk_act_auth() THEN
                 IF g_apa.apa01 IS NOT NULL THEN
                 LET g_doc.column1 = "apa01"
                 LET g_doc.value1 = g_apa.apa01
                 CALL cl_doc()
               END IF
            END IF
            LET g_action_choice = "exit"
            CONTINUE MENU
 
         -- for Windows close event trapped
         ON ACTION close   #COMMAND KEY(INTERRUPT) #FUN-9B0145  
             LET INT_FLAG=FALSE 		#MOD-570244	mars
             LET g_action_choice = "exit"
             EXIT MENU
#No.FUN-A30106 --begin                                                          
         ON ACTION drill_down                                                   
            CALL t110_drill_down()                                              
#No.FUN-A30106 --end
 
   END MENU
END FUNCTION
 
FUNCTION t110_npp02(p_npptype)                       #No.FUN-680029
DEFINE   p_npptype       LIKE npp_file.npptype       #No.FUN-680029
DEFINE   l_tic01     LIKE tic_file.tic01   #MOD-E70117 add
DEFINE   l_tic02     LIKE tic_file.tic02   #MOD-E70117 add
   UPDATE npp_file SET npp02=g_apa.apa02
    WHERE npp01=g_apa.apa01
      AND npp011=1
      AND nppsys = 'AP'
      AND npptype=p_npptype                          #No.FUN-680029
   IF STATUS THEN
      CALL cl_err3("upd","npp_file",g_apa.apa01,"",STATUS,"","upd npp02:",1)  #No.FUN-660122
   END IF
   #MOD-E70117---add---str---
   SELECT nmz70 INTO g_nmz.nmz70 FROM nmz_file
   IF g_nmz.nmz70 = '3' THEN
      LET l_tic01=YEAR(g_apa.apa02)
      LET l_tic02=MONTH(g_apa.apa02)
      UPDATE tic_file SET tic01=l_tic01,
                          tic02=l_tic02
      WHERE tic04=g_apa.apa01
      IF SQLCA.sqlcode THEN
         CALL cl_err3("upd","tic_file",g_apa.apa01,"",STATUS,"","upd tic01 tic02",1)
      END IF
   END IF
   #MOD-E70117---add---end---
 
END FUNCTION
 
FUNCTION t110_a()
   DEFINE g_t1     LIKE oay_file.oayslip                  #No.FUN-550030  #No.FUN-690028 VARCHAR(05)
   DEFINE li_result   LIKE type_file.num5    #No.FUN-690028 SMALLINT
   IF s_aapshut(0) THEN
      RETURN
   END IF
 
   MESSAGE ""
   CLEAR FORM
   CALL g_apb.clear()
   CALL t110_misc_clear()
   INITIALIZE g_apa.* LIKE apa_file.*             #DEFAULT 設定
   LET g_apa_t.*=g_apa.*
   LET g_apa01_t = NULL
   #預設值及將數值類變數清成零
   LET g_apa.apa00=g_aptype
   IF g_apa.apa00='16' OR g_apa.apa00='26' THEN
      LET g_apa.apa08='UNAP'
   END IF
   IF g_apa.apa02 IS NULL THEN
      LET g_apa.apa02=g_today
   ELSE
      LET g_apa.apa02=g_apa_t.apa02
   END IF
   LET g_apa.apa14=1
   LET g_apa.apa16=0
   LET g_apa.apa17='1'
   LET g_apa.apa13=g_aza.aza17        #TQC-A40102 Add
 
   CASE
      WHEN g_aptype = '11'
         LET g_apa.apa171='21'
      WHEN g_aptype = '12'
         LET g_apa.apa171='21'
      WHEN g_aptype = '13'
         LET g_apa.apa171='22'
      WHEN g_aptype = '21'
         LET g_apa.apa171='23'
   END CASE
 
   LET g_apa.apa172='1'
   LET g_apa.apa20=0
 
   IF cl_null(g_apa_t.apa21) THEN
      LET g_apa.apa21=g_user
   ELSE
      LET g_apa.apa21=g_apa_t.apa21
   END IF
 
   IF cl_null(g_apa_t.apa22) THEN
      SELECT gen03 INTO g_apa.apa22 FROM gen_file
       WHERE gen01=g_apa.apa21
   ELSE
      LET g_apa.apa22=g_apa_t.apa22
   END IF
 
   IF cl_null(g_apa.apa21) THEN
      LET g_apa.apa21=g_user
   END IF

   #FUN-CB0056---add----str
   IF g_aptype = '13' OR g_aptype = '17' THEN
      LET g_apa.apa11 = g_apz.apz71
   END IF
   IF g_aptype = '13' THEN
      LET g_apa.apa101 = g_apz.apz72
      LET g_apa.apa102 = g_apz.apz73
   END IF
   #FUN-CB0056---add----end
 
   LET g_apa.apa31f= 0
   LET g_apa.apa31 = 0
   LET g_apa.apa32f= 0
   LET g_apa.apa32 = 0
   LET g_apa.apa65f= 0
   LET g_apa.apa65 = 0
   LET g_apa.apa34f= 0
   LET g_apa.apa34 = 0
   LET g_apa.apa35f= 0
   LET g_apa.apa35 = 0
   LET g_apa.apa33f= 0
   LET g_apa.apa37f= 0   #No.FUN-690080
   LET g_apa.apa37 = 0   #No.FUN-690080
   LET g_apa.apa33 = 0
   LET g_apa.apa36 = g_apa_t.apa36
   LET g_apa.apa60f= 0
   LET g_apa.apa60 = 0
   LET g_apa.apa61f= 0
   LET g_apa.apa61 = 0
   LET g_apa.apa41 = 'N'
   LET g_apa.apa42 = 'N'
   LET g_apa.apa55 = '1'
   LET g_apa.apa56 = '0'
   LET g_apa.apa57f= 0
   LET g_apa.apa57 = 0
   LET g_apa.apa74 =  'N'
   LET g_apa.apa75 =  'N'
   LET g_apa.apa63 = '0'
   
   # add by quan 20170612 
     if  g_prog = 'aapt120' or g_prog = 'aapt121' then 
     	 let g_apa.apa08='MISC'
     END IF 
 
   IF g_aptype='21' THEN
      LET g_apa.apa58='3'
   END IF
 
   IF g_aptype='22' THEN
      LET g_apa.apa58='3'
   END IF
 
   INITIALIZE g_apa_o.* TO NULL
   LET g_apa.apaprno=0
   LET g_apa.apainpd=g_today
   LET g_apa.apauser=g_user
   LET g_apa.apaoriu = g_user #FUN-980030
   LET g_apa.apaorig = g_grup #FUN-980030
   LET g_apa.apagrup=g_grup
   LET g_apa.apadate=g_today
   LET g_apa.apaacti='Y'              #資料有效
   LET g_apa.apa100= g_plant   #No.FUN-630043
   LET g_apa.apa930=s_costcenter(g_apa.apa22)  #FUN-670064
   LET g_apa.apa76 = '1'      #FUN-9C0041
   LET g_apa.apalegal=g_legal #FUN-980001 add
   LET g_apa.apaoriu = g_user  #TQC-A10060 add
   LET g_apa.apaorig = g_grup  #TQC-A10060 add
   LET g_apa.apa79 ='0'        #No.FUN-A40003   #No.FUN-A60024
   CALL cl_opmsg('a')
 
   WHILE TRUE
      CALL t110_i("a")                #輸入單頭
      IF INT_FLAG THEN                   #使用者不玩了
         LET INT_FLAG = 0
         INITIALIZE g_apa.* TO NULL
         CALL cl_err('',9001,0)
         EXIT WHILE
      END IF
 
      IF g_apa.apa01 IS NULL THEN                # KEY 不可空白
         CONTINUE WHILE
      END IF
 
      BEGIN WORK
       CALL s_auto_assign_no("aap",g_apa.apa01,g_apa.apa02,g_apa.apa00,"apa_file","apa01","","","")
       RETURNING li_result,g_apa.apa01
      IF (NOT li_result) THEN
         CONTINUE WHILE
      END IF
      DISPLAY BY NAME g_apa.apa01
      IF g_apa.apa08 IS NULL THEN
         LET g_apa.apa08 = g_apa.apa01
         DISPLAY BY NAME g_apa.apa08
      END IF
 
      LET g_apa.apa72 = g_apa.apa14
      CALL t110_comp_oox(g_apa.apa01) RETURNING g_net
      LET g_apa.apa73 = g_apa.apa34 - g_apa.apa35 + g_net
 
      MESSAGE ''
      IF cl_null(g_apa.apamksg) THEN
          LET  g_apa.apamksg = 'N'
      END IF
 
      IF g_apa.apa00[1,1]='2' THEN
         IF cl_null(g_apa.apa12) THEN    #MOD-BA0173 ADD
            LET g_apa.apa12=g_apa.apa02
         END IF                          #MOD-BA0173 ADD
      END IF
      
      #No.TQC-A30072  --Begin
      #CALL s_get_doc_no(g_apa.apa01) RETURNING g_t1
      #SELECT apyvcode INTO g_apa.apa77  FROM apy_file WHERE apyslip = g_t1   
      #IF cl_null(g_apa.apa77) THEN 
      #   LET g_apa.apa77 = g_apz.apz63 
      #END IF     
      #No.TQC-A30072  --End  
      
      INSERT INTO apa_file VALUES (g_apa.*)
      IF SQLCA.sqlcode THEN        #置入資料庫不成功 
         CALL cl_err3("ins","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","",1)  #No.FUN-660122
         ROLLBACK WORK
         CONTINUE WHILE
      ELSE
         COMMIT WORK
         CALL cl_flow_notify(g_apa.apa01,'I')
      END IF
 
      LET g_apa_t.* = g_apa.*
      SELECT apa01 INTO g_apa.apa01 FROM apa_file
       WHERE apa01 = g_apa.apa01
 
      SELECT * INTO g_apa.* FROM apa_file WHERE apa01 = g_apa.apa01
 
      IF g_apa.apa08 ='UNAP' AND g_apa.apa00 MATCHES '1[1-2]' THEN
         DELETE FROM apk_file WHERE apk01=g_apa.apa01
      END IF
 
      #使用稅控系統且多發票時, 需先輸入單身資料
      IF g_apa.apa08 = 'MISC' THEN
         IF g_aza.aza26 != '2' AND g_apa.apa00[1,1] !='2'  THEN
            CALL t110_ddd('2')   #MOD-950112 add參數
            DISPLAY BY NAME g_apa.apa07      #TQC-630164 
            CALL t110_show_multi_invoice()   #No.TQC-A30076 
         END IF
      ELSE
         IF g_apa.apa08 != g_apa.apa01 AND NOT cl_null(g_apa.apa08) AND
            g_apa.apa08 != 'MISC' AND                           #MOD-990188 add
            g_apa.apa08 !='UNAP' AND g_apa.apa00 != '21' THEN   #MOD-670016
            CALL t110_ddd1('a')
         END IF
      END IF
 
      IF g_apa.apa51='MISC' OR g_apa.apa511 ='MISC' THEN         #No.FUN-680029
         CALL t110_ccc('1')
      END IF
 
      IF g_apa.apa51 = 'UNAP' THEN
         CALL t110_ppp('2')
      END IF
 
      CALL t110_ins_apc(g_apa.*)   #MOD-7A0049
      IF g_apb_sarrno > 0 THEN
         CALL g_apb.clear()
         LET g_rec_b = 0                    #No.FUN-680064
         IF g_aptype="16" THEN
            CALL cl_err('','aap-166',1)
         END IF
         CALL t110_b('a')              #輸入單身
      END IF
      IF cl_null(g_apa.apa01) THEN          #MOD-C60168   # 若單身無資料用戶選擇刪除單頭時候則退出
         RETURN                             #MOD-C60168
      END IF                                #MOD-C60168
 
      LET g_apa01_t = g_apa.apa01     #保留舊值
  
      DELETE FROM apc_file WHERE apc01=g_apa.apa01   #MOD-810104 
      CALL t110_ins_apc(g_apa.*)   #MOD-810104 取消MOD-7A0049的mark
 
      CASE
         WHEN g_apa.apa00 = '11' AND g_apz.apz31 = 'N'
            EXIT WHILE
         WHEN (g_apa.apa00 = '12' OR g_apa.apa00 = '13') AND g_apz.apz32 = 'N'   #No.FUN-690080
            EXIT WHILE
      END CASE
      CALL s_get_doc_no(g_apa.apa01) RETURNING g_t1
 
      IF NOT cl_null(g_apa.apa01) AND g_apy.apyprint='Y' THEN  #是否馬上列印
         IF cl_confirm('mfg3242') THEN
            CALL t110_out('a')
         END IF
      END IF
 
     #IF (g_apa.apa00 = '12' OR g_apa.apa00 = '13') AND g_apz.apz32 = 'Y' AND l_apz59='N' THEN  #No.FUN-690080 #TQC-A40106 change g_apz.apz59->l_apz59 #MOD-CB0128 mark
     #IF (g_apa.apa00 = '12' OR g_apa.apa00 = '13') AND g_apz.apz32 = 'Y' THEN                  #MOD-CB0128 add #MOD-CC0138 mark
         CALL t110_gen_gl()
     #END IF                                                                                    #MOD-CC0138 mark
 
      IF (g_aptype = '12' OR g_aptype = '13') AND l_apz59='N' THEN  #No.FUN-690080  #TQC-A40106 change g_apz.apz59->l_apz59
         CALL t110_misc_display() RETURN
      END IF
      display "apyapr:",g_apy.apyapr
      IF NOT cl_null(g_apa.apa01) AND g_apy.apydmy1='Y'  #確認
      AND g_apy.apyapr <> 'Y'                                      #FUN-640240
      THEN
          LET g_action_choice = "insert"      #FUN-640240
          CALL s_showmsg_init() #CHI-A80031 add
          CALL t110_firm1_chk()          #CALL 原確認的 check 段
          IF g_success = "Y" THEN
             CALL t110_firm1_upd()       #CALL 原確認的 update 段
          END IF
          CALL s_showmsg()  #CHI-A80031 add
      END IF
 
      EXIT WHILE
   END WHILE
   CALL cl_set_act_visible("entry_sheet,entry_sheet2,
                            T_T_entry_sheet,T_T_entry_sheet2",TRUE)
   IF cl_null(g_apa.apa99) THEN
      CALL cl_set_act_visible("T_T_entry_sheet,T_T_entry_sheet2",FALSE)
      IF g_aza.aza63 = 'N' THEN
         CALL cl_set_act_visible("entry_sheet2",FALSE)
      END IF
   ELSE
      CALL cl_set_act_visible("entry_sheet,entry_sheet2",FALSE)
      IF g_aza.aza63 = 'N' THEN
         CALL cl_set_act_visible("T_T_entry_sheet2",FALSE)
      END IF
   END IF
   CALL t110_show()   #TQC-C30334
 
END FUNCTION
 
FUNCTION t110_ddd1(p_cmd)
 DEFINE l_azi04 LIKE azi_file.azi04
 DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
 DEFINE g_apk   RECORD LIKE apk_file.*
 DEFINE g_t1    LIKE oay_file.oayslip  #FUN-990014 add
 
   INITIALIZE g_apk.* TO NULL
   IF p_cmd!='a' THEN
      DELETE FROM apk_file WHERE apk01=g_apa.apa01
   END IF
 
   LET g_apk.apk01=g_apa.apa01
   LET g_apk.apk02=1
   LET g_apk.apk28=g_apa.apa46   #FUN-650068
   LET g_apk.apk03=g_apa.apa08
   LET g_apk.apk04=g_apa.apa18
   LET g_apk.apk05=g_apa.apa09
   LET g_apk.apk06=g_apa.apa31+g_apa.apa32
   LET g_apk.apk07=g_apa.apa32
   LET g_apk.apk08=g_apa.apa31
   LET g_apk.apk06 = cl_digcut(g_apk.apk06,g_azi04)
   LET g_apk.apk07 = cl_digcut(g_apk.apk07,g_azi04)
   LET g_apk.apk08 = cl_digcut(g_apk.apk08,g_azi04)
   LET g_apk.apk11  = g_apa.apa15
   LET g_apk.apk29  = g_apa.apa16
   LET g_apk.apk12  = g_apa.apa13
   LET g_apk.apk13  = g_apa.apa14
   LET g_apk.apk06f = g_apa.apa31f+g_apa.apa32f
   LET g_apk.apk07f = g_apa.apa32f
   LET g_apk.apk08f = g_apa.apa31f
   SELECT azi04 INTO l_azi04 FROM azi_file WHERE azi01 = g_apk.apk12
   LET g_apk.apk06f = cl_digcut(g_apk.apk06f,l_azi04)
   LET g_apk.apk07f = cl_digcut(g_apk.apk07f,l_azi04)
   LET g_apk.apk08f = cl_digcut(g_apk.apk08f,l_azi04)
   LET g_apk.apk17=g_apa.apa17
   LET g_apk.apk171=g_apa.apa171
   LET g_apk.apk172=g_apa.apa172
   LET g_apk.apkacti='Y'
   LET g_apk.apkgrup=g_grup
   LET g_apk.apkuser=g_user
   LET g_apk.apkdate=g_today
   LET g_apk.apklegal=g_legal #FUN-980001 add 
   LET g_apk.apkoriu = g_user  #TQC-A10060 add
   LET g_apk.apkorig = g_grup  #TQC-A10060 add 
   IF NOT cl_null(g_apa.apa77) THEN 
      LET g_apk.apk32 = g_apa.apa77
   ELSE
      CALL s_get_doc_no(g_apk.apk01) RETURNING g_t1
      SELECT apyvcode INTO g_apk.apk32  FROM apy_file WHERE apyslip = g_t1   
       IF cl_null(g_apk.apk32) THEN 
          LET g_apk.apk32 = g_apz.apz63  
       END IF
   END IF
   #大陸版且不使用稅控系統
 
   IF g_aza.aza26 = '2' THEN
      SELECT gec05 INTO g_apk.apk172 FROM gec_file WHERE gec01 = g_apa.apa15  AND gec011='1'    #No:8511 加上gec011
      LET g_apk.apk29 = g_apa.apa16
      LET g_apk.apk30 = 0
   END IF
   
   IF NOT cl_null(g_apa.apa08) THEN   #MOD-7B0033 
      LET g_apk.apkoriu = g_user      #No.FUN-980030 10/01/04
      LET g_apk.apkorig = g_grup      #No.FUN-980030 10/01/04
      INSERT INTO apk_file VALUES (g_apk.*)
   END IF   #MOD-7B0033
 
END FUNCTION
 
FUNCTION t110_ins_prepaid()
 DEFINE l_apa  RECORD LIKE apa_file.*,
        l_dmy  LIKE apb_file.apb03,      # No.FUN-690028 VARCHAR(5) ,         #No.FUN-550030
        l_msg  LIKE type_file.chr1000    # No.FUN-690028 VARCHAR(60)
 DEFINE g_t1   LIKE oay_file.oayslip     #FUN-990014 add
   LET l_apa.*  = m_apa.*
   LET l_dmy    = s_get_doc_no(m_apa.apa01)   #TQC-630173
   SELECT * INTO g_apy.* FROM apy_file
    WHERE apyslip = l_dmy
   IF cl_null(g_apy.apydmy4) THEN
      CALL cl_err('','aap-068',1)
      LET g_success='N'
      RETURN
   END IF
   IF g_aptype = '17' THEN
      LET l_apa.apa00 = '25'
   ELSE
      LET l_apa.apa00 = '23'
   END IF
   #--->依據相對應單別
   LET l_apa.apa01[1,g_doc_len] = g_apy.apydmy4
   LET l_apa.apa08 = m_apa.apa01
   LET l_apa.apa09 = m_apa.apa02
   LET l_apa.apa12 = m_apa.apa12     #No.TQC-7A0095
   LET l_apa.apa19 = NULL            #MOD-A70158 add
   LET l_apa.apa20 = 0               #MOD-A70158 add
   LET l_apa.apa24 = 0
   LET l_apa.apa64 = m_apa.apa64     #No.TQC-7A0095
   LET l_apa.apa15 = m_apa.apa15
   LET l_apa.apa16 = 0            
   LET l_apa.apa32f= 0            
   LET l_apa.apa33f= 0
   LET l_apa.apa65f= 0
   LET l_apa.apa35f= 0
   LET l_apa.apa32 = 0  
   LET l_apa.apa33 = 0
   LET l_apa.apa65 = 0
   LET l_apa.apa35 = 0
   LET l_apa.apa31f= l_apa.apa31f                 #MOD-B60066 mark  #MOD-B60221 remark
  #LET l_apa.apa31f= m_apa.apa31f - m_apa.apa65f  #MOD-B60066       #MOD-B60221 mark
   LET l_apa.apa34f= l_apa.apa31f                 #MOD-B60066 mark  #MOD-B60221 remark   #(不包含稅額)
  #LET l_apa.apa34f= m_apa.apa31f - m_apa.apa65f  #MOD-B60066       #MOD-B60221 mark
   LET l_apa.apa31 = l_apa.apa31                  #MOD-B60066 mark  #MOD-B60221 remark
  #LET l_apa.apa31 = m_apa.apa31  - m_apa.apa65   #MOD-B60066       #MOD-B60221 mark
   LET l_apa.apa34 = l_apa.apa31                  #MOD-B60066 mark  #MOD-B60221 remark   #(不包含稅額)
  #LET l_apa.apa34 = m_apa.apa31  - m_apa.apa65   #MOD-B60066       #MOD-B60221 mark
   LET l_apa.apa41 = 'Y'                   # 視同已確認
   LET l_apa.apa42 = 'N'
   LET l_apa.apa54 = l_apa.apa51                     #MOD-840203 mark
   LET l_apa.apa541= l_apa.apa511     #No.FUN-680029 #MOD-840203 mark
   LET l_apa.apa55 = '1'
   LET l_apa.apa60f= 0
   LET l_apa.apa60 = 0
   LET l_apa.apa61f= 0
   LET l_apa.apa61 = 0
   LET l_apa.apa67 = m_apa.apa67
   LET l_apa.apa68 = m_apa.apa68
   LET l_apa.apa69 = m_apa.apa69
   LET l_apa.apa70 = m_apa.apa70
   LET l_apa.apa66 = m_apa.apa66
   LET l_apa.apa74 = 'N'
   LET l_apa.apa75 = 'N'
   LET l_apa.apainpd = g_today
   LET l_apa.apaprno = 0
   LET l_apa.apa72=l_apa.apa14
   LET l_apa.apa73=l_apa.apa34-l_apa.apa35
   LET l_apa.apa930=m_apa.apa930 #FUN-670064
   LET l_apa.apa76 = '1'      #FUN-9C0041
   LET l_apa.apa100 = g_plant     #FUN-960141 090824 add
   LET l_apa.apalegal=g_legal    #FUN-980001 add
   LET l_apa.apaoriu = g_user  #TQC-A10060 add
   LET l_apa.apaorig = g_grup  #TQC-A10060 add
   LET l_apa.apa79 ='0'        #No.FUN-A40003   #No.FUN-A60024
   CALL s_get_doc_no(l_apa.apa01) RETURNING g_t1
   SELECT apyvcode INTO l_apa.apa77  FROM apy_file WHERE apyslip = g_t1   
     IF cl_null(l_apa.apa77) THEN 
        LET l_apa.apa77 = g_apz.apz63  #FUN-970108 add
     END IF     
   LET l_apa.apaoriu = g_user      #No.FUN-980030 10/01/04
   LET l_apa.apaorig = g_grup      #No.FUN-980030 10/01/04
   LET l_apa.apa63 ='1'  #MOD-C30700 ADD
  
   INSERT INTO apa_file VALUES(l_apa.*)
   IF SQLCA.sqlcode THEN
      CALL cl_err3("ins","apa_file",l_apa.apa01,"",SQLCA.sqlcode,"","ins apa(type 23):",1)  #No.FUN-660122
      LET g_success = 'N'
   ELSE
      CALL cl_getmsg('aap-083',g_lang) RETURNING l_msg
            LET INT_FLAG = 0  ######add for prompt bug
      LET l_msg=l_msg CLIPPED,l_apa.apa01,"!"
      CALL cl_msgany(1,1,l_msg)
     CALL t110_ins_apc(l_apa.*)
   END IF
 
END FUNCTION
 
FUNCTION t110_u()
 DEFINE l_apa35  LIKE apa_file.apa35,
        l_apa41  LIKE apa_file.apa41,
        l_apb02  LIKE apb_file.apb02,
        l_apb08  LIKE apb_file.apb08,
        l_apb081 LIKE apb_file.apb081,
        l_apb09  LIKE apb_file.apb09,
        l_apb23  LIKE apb_file.apb23,
        l_apb24  LIKE apb_file.apb24,    #MOD-860221 add
        l_apb10  LIKE apb_file.apb10,
        l_apb101 LIKE apb_file.apb101,
        l_n      LIKE type_file.num5,    #No.FUN-690028 SMALLINT
        g_apk    RECORD LIKE apk_file.*
DEFINE l_apa13         LIKE apa_file.apa13
DEFINE l_apa14         LIKE apa_file.apa14
DEFINE l_apa72         LIKE apa_file.apa72    
DEFINE l_api05         LIKE api_file.api05   
DEFINE l_api05f        LIKE api_file.api05f   
DEFINE l_apb21         LIKE apb_file.apb21    
DEFINE l_sum           LIKE type_file.num20_6  
DEFINE l_pmc913        LIKE pmc_file.pmc913  #No.MOD-960026 
 
    IF s_aapshut(0) THEN
       RETURN
    END IF
 
#No.FUN-A40003 --begin
    SELECT apa79 INTO g_apa.apa79 FROM apa_file WHERE apa01 =g_apa.apa01
   #FUN-C80078 mod str---
   #IF g_apa.apa79  <> '0'  THEN   #No.FUN-A60024  #No.FUN-A80111
    IF g_apa.apa79 MATCHES '[123]' THEN
   #FUN-C80078 mod end---
       CALL cl_err('','aap-829',1) 
       RETURN 
    END IF  
#No.FUN-A40003 --end 

    IF g_apa.apa01 IS NULL THEN
       CALL cl_err('apa01 null',-400,0)
       RETURN
    END IF
 
    SELECT * INTO g_apa.* FROM apa_file
     WHERE apa01=g_apa.apa01
 
    IF g_apa.apaacti ='N' THEN
       CALL cl_err('acti=N',9027,0)
       RETURN
    END IF
 
    IF g_apa.apa41 = 'Y' THEN
       CALL cl_err("apa41=Y",'aap-086',0)
       RETURN
    END IF

  #add by dengsy 20150914  start
    IF g_apa.apa99  IS NOT NULL  THEN
       RETURN
    END IF
  #add by dengsy 20150914  end
    IF g_apa.apa42 = 'Y' THEN
       CALL cl_err("apa42=Y",'aap-165',0)
       RETURN
    END IF
 
    IF g_apa.apa74 = 'Y' THEN
       CALL cl_err('apa74=Y','aap-334',0)
       RETURN
    END IF
 
    IF NOT cl_null(g_apa.apa44) THEN   #No.MOD-670056
       #IF NOT s_chkpost(g_apa.apa44,g_apa.apa01) THEN  #FUN-CB0054 mark
       IF NOT s_chkpost(g_apa.apa44,g_apa.apa01,0) THEN #FUN-CB0054 add
          RETURN
       END IF
    END IF
 
    IF g_apa.apa00='21' THEN
       IF NOT cl_null(g_apa.apa08) THEN
          SELECT COUNT(*) INTO l_n FROM apb_file
           WHERE apb01=g_apa.apa08 AND apb16='Y'
          IF l_n > 0 THEN
             CALL cl_err('','aap-289',0)
             RETURN
          END IF
       END IF
    END IF
 
   #-MOD-BB0304-add-
    IF g_apa.apa63 MATCHES '[Ss]' THEN
       CALL cl_err(g_apa.apa63,'apm-030',0)
       RETURN
    END IF
   #-MOD-BB0304-end-

    MESSAGE ""
    CALL cl_opmsg('u')
    LET g_apa01_t = g_apa.apa01
    LET g_apa_t.* = g_apa.*       #BACKUP  #MOD-B40036 mod g_apa_o -> g_apa_t 
    LET g_apa_o.* = g_apa.*       #BACKUP  #MOD-CC0287 add
    LET g_success = 'Y'
    BEGIN WORK
 
    CALL t110_lock_cl()  #FUN-C80078 add
    OPEN t110_cl USING g_apa.apa01
    IF STATUS THEN
       CALL cl_err("OPEN t110_cl u:", STATUS, 1)
       CLOSE t110_cl
       ROLLBACK WORK
       RETURN
    END IF
 
    FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
    IF SQLCA.sqlcode THEN
        CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
        CLOSE t110_cl
        ROLLBACK WORK
        RETURN
    END IF
 
    CALL t110_show()
 
    WHILE TRUE
       LET g_apa01_t = g_apa.apa01
       LET g_apa.apamodu=g_user
       LET g_apa.apadate=g_today
       CALL t110_i("u")                      #欄位更改
       IF INT_FLAG THEN
          LET INT_FLAG = 0
          IF g_apa.apa14 <> g_apa_t.apa14 THEN
             SELECT COUNT(*) INTO g_cnt FROM apb_file
              WHERE apb01=g_apa.apa01
 
             IF g_cnt > 0 THEN
                DECLARE upd_apb_cs2 CURSOR FOR
                 SELECT apb23,apb09,apb02,apb24   #MOD-860221 add apb24
                   FROM apb_file WHERE apb01=g_apa.apa01
 
                FOREACH upd_apb_cs2 INTO l_apb23,l_apb09,l_apb02,l_apb24   #MOD-860221 add l_apb24
                   LET l_apb08 = l_apb23 * g_apa_t.apa14 #MOD-990174   
                   LET l_apb08 = cl_digcut(l_apb08,g_azi03)   #MOD-6B0066
                   LET l_apb081= l_apb08
                   LET l_apb10 = l_apb24 * g_apa_t.apa14   #MOD-860221 #MOD-990174      
                   LET l_apb10 = cl_digcut(l_apb10,g_azi04)   #MOD-6B0066
                   LET l_apb101= l_apb10
 
                   UPDATE apb_file SET apb08  = l_apb08,
                                       apb081 = l_apb081,
                                       apb10  = l_apb10,
                                       apb101 = l_apb101
                    WHERE apb01=g_apa.apa01 AND apb02=l_apb02
                   IF STATUS OR SQLCA.SQLCODE THEN
                      CALL cl_err3("upd","apb_file",g_apa_t.apa01,l_apb02,SQLCA.sqlcode,"","upd apb:",1)  #No.FUN-660122
                      LET g_success='N'
                      EXIT FOREACH
                   END IF
 
                END FOREACH
 
                IF g_success='N' THEN
                   ROLLBACK WORK
                   LET g_apa.* = g_apa_t.*       #MOD-B40036
                   RETURN
                END IF
 
                CALL t110_b_fill(' 1=1')
 
             END IF
          END IF
          LET g_apa.* = g_apa_o.*                   #MOD-CC0287 mod t->o
          CALL t110_show()
          CALL cl_err('','9001',0)
          LET g_success = 'N'                       #MOD-CC0287 add
          EXIT WHILE
      #-MOD-C20206-mark-
      #ELSE
      #   #單頭匯率調整後,應重算沖暫估的DIFF金額
      #   DECLARE upd_apb_t120 CURSOR FOR
      #      SELECT apb24,apb21 FROM apb_file WHERE apb01=g_apa.apa01
      #   LET l_sum = 0            
      #   LET l_api05f = 0         
      #   FOREACH upd_apb_t120 INTO l_apb24,l_apb21   
      #      SELECT apa13,apa14,apa72 INTO l_apa13,l_apa14,l_apa72
      #        FROM apa_file
      #       WHERE apa01 = l_apb21 AND apa41 = 'Y' AND apa42 = 'N'
      #      IF g_apz.apz27 = 'Y' AND g_aza.aza17 != l_apa13 THEN 
      #         LET l_api05 = l_apb24 * l_apa72                    
      #      ELSE
      #     	LET l_api05 = l_apb24 * l_apa14
      #      END IF    
      #      LET l_api05 = cl_digcut(l_api05,g_azi04)
      #                                         
      #      LET l_sum = l_sum + l_api05    
      #      SELECT azi04 INTO t_azi04 FROM azi_file WHERE azi01 = l_apa13 
      #      LET l_api05f = l_api05f + l_apb24
      #      LET l_api05f = cl_digcut(l_api05f,t_azi04)                                 
      #   END FOREACH
      #   #No.CHI-A10006 mod --start--
      #   #LET l_api05 = g_apa.apa31 - l_sum
      #   IF g_apa.apa34f - g_apa.apa35f = l_api05f THEN
      #      LET l_api05 = g_apa.apa34 - g_apa.apa35
      #   ELSE 
      #      LET l_api05 = g_apa.apa31 - l_sum
      #   END IF     
      #   #No.CHI-A10006 mod --end--
      #   LET l_api05f= g_apa.apa31f- l_api05f
      #   
      #   UPDATE api_file SET api05 = l_api05,
      #                       api05f= l_api05f   
      #    WHERE api01 = g_apa.apa01
      #      AND api02 = '2'
      #      AND api26 = 'DIFF'
      #   IF STATUS THEN 
      #      CALL cl_err3("upd","api_file","","",STATUS,"","api",1)                     
      #      ROLLBACK WORK
      #      LET g_apa.* = g_apa_t.*       #MOD-B40036
      #      RETURN 
      #   END IF                 
      #-MOD-C20206-mark-
       END IF
 
       IF g_apa.apa01 != g_apa01_t THEN            # 更改單號
          UPDATE apb_file SET apb01 = g_apa.apa01 WHERE apb01 = g_apa01_t
          IF STATUS THEN
             CALL cl_err3("upd","apb_file",g_apa01_t,"",STATUS,"","apb",1)  #No.FUN-660122
             ROLLBACK WORK
             LET g_apa.* = g_apa_t.*       #MOD-B40036
             RETURN
          END IF
 
          UPDATE apc_file SET apc01 = g_apa.apa01 WHERE apc01 = g_apa01_t
          IF STATUS THEN
             CALL cl_err3("upd","apc_file",g_apa01_t,"",STATUS,"","apc",1)
             ROLLBACK WORK
             LET g_apa.* = g_apa_t.*       #MOD-B40036
             RETURN
          END IF
 
          UPDATE npp_file SET npp01 = g_apa.apa01
           WHERE npp01 = g_apa01_t
             AND nppsys = 'AP'
             AND npp00 = 1
             AND npp011 = 1
          IF STATUS THEN
             CALL cl_err3("upd","npp_file",g_apa01_t,"",STATUS,"","npp",1)  #No.FUN-660122
             ROLLBACK WORK
             LET g_apa.* = g_apa_t.*       #MOD-B40036
             RETURN
          END IF
 
          UPDATE npq_file SET npq01 = g_apa.apa01
           WHERE npq01 = g_apa01_t
             AND npqsys = 'AP'
             AND npq00 = 1
             AND npq011 = 1
          IF STATUS THEN
             CALL cl_err3("upd","npq_file",g_apa01_t,"",STATUS,"","npq",1)  #No.FUN-660122
             ROLLBACK WORK
             LET g_apa.* = g_apa_t.*       #MOD-B40036
             RETURN
          END IF
 
          UPDATE apd_file SET apd01 = g_apa.apa01 WHERE apd01 = g_apa01_t
          IF STATUS THEN
             CALL cl_err3("upd","apd_file",g_apa01_t,"",STATUS,"","apd",1)  #No.FUN-660122
             ROLLBACK WORK
             LET g_apa.* = g_apa_t.*       #MOD-B40036
             RETURN
          END IF
 
          UPDATE api_file SET api01 = g_apa.apa01 WHERE api01 = g_apa01_t
          IF STATUS THEN
             CALL cl_err3("upd","api_file",g_apa01_t,"",STATUS,"","api",1)  #No.FUN-660122
             ROLLBACK WORK
             LET g_apa.* = g_apa_t.*       #MOD-B40036
             RETURN
          END IF
 
          UPDATE apk_file SET apk01 = g_apa.apa01 WHERE apk01 = g_apa01_t
          IF STATUS THEN
             CALL cl_err3("upd","apk_file",g_apa01_t,"",STATUS,"","apk",1)  #No.FUN-660122
             ROLLBACK WORK
             LET g_apa.* = g_apa_t.*       #MOD-B40036
             RETURN
          END IF
 
          UPDATE apv_file SET apv01 = g_apa.apa01 WHERE apv01 = g_apa01_t
          IF STATUS THEN
             CALL cl_err3("upd","apv_file",g_apa01_t,"",STATUS,"","apv",1)  #No.FUN-660122
             ROLLBACK WORK
             LET g_apa.* = g_apa_t.*       #MOD-B40036
             RETURN
          END IF
       END IF
 
      #單身若有採購單時,單頭金額不可大於單身金額
        SELECT pmc913 INTO l_pmc913 FROM pmc_file                                                                                   
         WHERE pmc01 = g_apa.apa05                                                                                                  
        IF g_aptype = '15' AND g_aza.aza26 != '2' AND (g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y')) THEN             
          LET l_n = 0
          SELECT COUNT(*) INTO l_n FROM apb_file WHERE apb06 IS NOT NULL
                                                   AND apb01=g_apa.apa01
          IF l_n > 0 THEN
             SELECT SUM(apb10),SUM(apb24) INTO l_apb10,l_apb24
               FROM apb_file
              WHERE apb01=g_apa.apa01
             IF cl_null(l_apb24) THEN LET l_apb24 = 0 END IF
             IF cl_null(l_apb10) THEN LET l_apb10 = 0 END IF
             IF g_apa.apa31f > l_apb24 OR g_apa.apa31 > l_apb10 THEN
                #單頭金額大於單身合計金額, (1)修改單頭 (2)修改單身:
                CALL cl_getmsg('aap-117',g_lang) RETURNING g_msg
                WHILE TRUE
                   LET g_chr=' '
                   LET INT_FLAG = 0  ######add for prompt bug
                   PROMPT g_msg CLIPPED FOR CHAR g_chr
                      ON IDLE g_idle_seconds
                         CALL cl_on_idle()
 
                      ON ACTION about         #MOD-4C0121
                         CALL cl_about()      #MOD-4C0121
 
                      ON ACTION help          #MOD-4C0121
                         CALL cl_show_help()  #MOD-4C0121
 
                      ON ACTION controlg      #MOD-4C0121
                         CALL cl_cmdask()     #MOD-4C0121
                   END PROMPT
                   IF INT_FLAG THEN LET INT_FLAG = 0 END IF
                   IF g_chr MATCHES "[12]" THEN EXIT WHILE END IF
                END WHILE
                IF g_chr = '2' THEN CALL t110_b("") END IF
                IF g_chr = '1' THEN CONTINUE WHILE END IF
             END IF
          END IF
       END IF
 
       #IF g_apa.apa14 <> g_apa_t.apa14 THEN #MOD-BB0144
       IF g_apa.apa14 <> g_apa14_t THEN  #MOD-BB0144
          LET g_cnt = 0
          SELECT COUNT(*) INTO g_cnt FROM apb_file
            WHERE apb01 = g_apa.apa01
          IF g_cnt > 0 THEN
             SELECT SUM(apb10) INTO g_apa.apa57 FROM apb_file
              WHERE apb01=g_apa.apa01
             IF cl_null(g_apa.apa57) THEN
                LET g_apa.apa57 = 0
             END IF
             DISPLAY BY NAME g_apa.apa57
          END IF   #MOD-910181 add
       END IF
 
       LET g_apa.apa72=g_apa.apa14
       CALL t110_comp_oox(g_apa.apa01) RETURNING g_net  #CHI-890017 add
       LET g_apa.apa73=g_apa.apa34-g_apa.apa35+g_net    #CHI-890017
       IF g_apa.apa63 NOT matches '[Ss]' THEN  #FUN-8A0075 
          LET g_apa.apa63 = '0'             #FUN-550042
       END IF                                  #FUN-8A0075
 
       UPDATE apa_file set * = g_apa.* WHERE apa01 = g_apa01_t    #MOD-940008
       IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
          CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa:",1)  #No.FUN-660122
          ROLLBACK WORK
          LET g_apa.* = g_apa_t.*       #MOD-B40036
          RETURN
       END IF
       DELETE FROM apc_file WHERE apc01 = g_apa.apa01
       CALL t110_ins_apc(g_apa.*)
       CALL t110_apc_check('w') #MOD-990125
 
       IF g_apa.apa58 != '1' AND g_apa.apa00[1,1] = '2' THEN
         #IF g_apa.apa16 != g_apa_t.apa16 OR g_apa.apa14!= g_apa_t.apa14 THEN       #MOD-A80159 mark
          IF g_apa.apa16 != g_apa_t.apa16 OR g_apa.apa14!= g_apa_t.apa14            #MOD-A80159
              OR g_apa.apa15!= g_apa_t.apa15 THEN                                   #MOD-A80159
             DECLARE curr_apk_21 CURSOR FOR
              SELECT * FROM apk_file WHERE apk01 = g_apa.apa01
 
             FOREACH curr_apk_21 INTO g_apk.*
                IF g_apa.apa14 != g_apa_t.apa14 THEN
                   LET g_apk.apk13 = g_apa.apa14
                   LET g_apk.apk08 = g_apk.apk08f * g_apk.apk13
                   LET g_apk.apk07 = g_apk.apk07f * g_apk.apk13
                   LET g_apk.apk06 = g_apk.apk07 + g_apk.apk08        #含稅金額
                END IF
                IF g_apa.apa16 != g_apa_t.apa16 THEN       #稅率變更
                   LET g_apk.apk07 = g_apk.apk08 * g_apa.apa16 / 100  #稅額
                   LET g_apk.apk08 = g_apk.apk08                      #未稅金額
                   LET g_apk.apk06 = g_apk.apk07 + g_apk.apk08        #含稅金額
                   LET g_apk.apk07f= g_apk.apk08f* g_apa.apa16 / 100  #稅額
                   LET g_apk.apk08f= g_apk.apk08f                     #未稅金額
                   LET g_apk.apk06f= g_apk.apk07f+ g_apk.apk08f       #含稅金額
                   LET g_apk.apk29 = g_apa.apa16                      #MOD-A80159
                END IF
               #-MOD-A80159-add-
                IF g_apa.apa15 != g_apa_t.apa15 THEN       #稅別變更
                   LET g_apk.apk11 = g_apa.apa15    
                   SELECT gec06
                     INTO g_apk.apk172
                     FROM gec_file
                    WHERE gec01 = g_apk.apk11 AND gec011='1'  #進項
                      AND gecacti = 'Y'
                END IF
               #-MOD-A80159-end-
 
                  LET g_apk.apk06 = cl_digcut(g_apk.apk06,g_azi04)
                  LET g_apk.apk07 = cl_digcut(g_apk.apk07,g_azi04)
                  LET g_apk.apk08 = cl_digcut(g_apk.apk08,g_azi04)
                  LET g_apk.apk06f= cl_digcut(g_apk.apk06f,t_azi04) 
                  LET g_apk.apk07f= cl_digcut(g_apk.apk07f,t_azi04)
                  LET g_apk.apk08f= cl_digcut(g_apk.apk08f,t_azi04)
 
                UPDATE apk_file SET apk13 = g_apa.apa14,       #No.MOD-4C0154
                                    apk06 = g_apk.apk06,
                                    apk07 = g_apk.apk07,
                                    apk08 = g_apk.apk08,
                                    apk06f= g_apk.apk06f,   #MOD-8A0266 add
                                    apk07f= g_apk.apk07f,   #MOD-8A0266 add
                                    apk08f= g_apk.apk08f,   #MOD-8A0266 add
                                    apk11 = g_apk.apk11,    #MOD-A80159
                                    apk172= g_apk.apk172,   #MOD-A80159
                                    apk29 = g_apk.apk29,    #MOD-A80159
                                    apk32 = g_apk.apk32     #FUN-970108 add
                 WHERE apk01 = g_apk.apk01
                   AND apk02 = g_apk.apk02
                   AND apk03 = g_apk.apk03
                IF STATUS OR SQLCA.SQLCODE THEN
                   CALL cl_err3("upd","apk_file",g_apk.apk01,g_apk.apk02,SQLCA.sqlcode,"","upd apk",1)  #No.FUN-660122
                   ROLLBACK WORK
                   LET g_apa.* = g_apa_t.*       #MOD-B40036
                   RETURN
                END IF
             END FOREACH
          END IF
       END IF
 
       IF g_apa.apa08 ='UNAP' AND g_apa.apa00 MATCHES '1[1-2]' THEN
          DELETE FROM apk_file WHERE apk01=g_apa.apa01
       END IF
 
       IF g_apa.apa08 != 'MISC' AND g_apa.apa08 != g_apa_t.apa08 AND
         #cl_null(g_apa.apa08) THEN                          #MOD-B50235 mark
          cl_null(g_apa.apa08) AND g_apa.apa00 != '21' THEN  #MOD-B50235
          DELETE FROM apk_file WHERE apk01=g_apa.apa01
       END IF
 
       IF g_apa.apa08 != 'MISC' AND g_apa.apa08 != g_apa.apa01 AND
          NOT cl_null(g_apa.apa08) AND g_apa.apa08 !='UNAP' AND
          g_apa.apa00 != '21' THEN   #MOD-670016
          CALL t110_ddd1('u')
       END IF
 
       CALL t110_diff_rtn('0')  ##TQC-750140
 
      CALL t110_ins_apc(g_apa.*)
       CASE
          WHEN g_apa.apa00 = '11' AND g_apz.apz31 = 'N'
             EXIT WHILE
          WHEN (g_apa.apa00 = '12' OR g_apa.apa00 = '13') AND g_apz.apz32 = 'N'   #No.FUN-690080
             EXIT WHILE
       END CASE
 
       CALL t110_up_gl()
       EXIT WHILE
    END WHILE
 
    CLOSE t110_cl
 
    IF g_success = 'Y' THEN
       IF g_apa.apa18 IS NOT NULL AND
          (g_apa.apa18 != g_apa_t.apa18 OR g_apa_t.apa18 IS NULL) THEN
          SELECT COUNT(*) INTO g_cnt FROM apk_file
           WHERE apk01 = g_apa.apa01
          IF g_cnt > 0 THEN
             UPDATE apk_file SET apk04 = g_apa.apa18
              WHERE apk01 = g_apa.apa01
             IF SQLCA.sqlcode OR SQLCA.sqlerrd[3]=0 THEN
                CALL cl_err3("upd","apk_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apk",1)  #No.FUN-660122
                ROLLBACK WORK
                LET g_apa.* = g_apa_t.*       #MOD-B40036
             ELSE
                COMMIT WORK
                CALL cl_flow_notify(g_apa.apa01,'U')
             END IF
          ELSE
             COMMIT WORK
             CALL cl_flow_notify(g_apa.apa01,'U')
          END IF
       ELSE
          COMMIT WORK
          CALL cl_flow_notify(g_apa.apa01,'U')
       END IF
       CALL t110_gen_gl()                                                                  #MOD-CC0287 add
    ELSE
       ROLLBACK WORK
       LET g_apa.* = g_apa_t.*       #MOD-B40036
    END IF
   #IF (g_apa.apa00 = '12' OR g_apa.apa00 = '13') AND g_apz.apz32 = 'Y' THEN               #MOD-CB0128 add #MOD-CC0138 mark
   #CALL t110_gen_gl()                                                                     #MOD-CB0128 add #MOD-CC0287 mark
   #END IF                                                                                 #MOD-CB0128 add #MOD-CC0138 mark
 
    IF (g_apa.apa51='UNAP' AND (g_apa_t.apa51<>'UNAP' OR g_apa_t.apa51 IS NULL)) OR g_apa.apa56 = '5' THEN  #MOD-CA0073 add apa56
       CALL t110_ppp('2')
    END IF
   DISPLAY BY NAME g_apa.apa63
   IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF
   CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,g_apa.apaacti)
 
END FUNCTION
 
#處理INPUT
FUNCTION t110_i(p_cmd)
   DEFINE l_azp02_1   LIKE azp_file.azp02     #FUN-960141
   DEFINE l_azp03_1   LIKE azp_file.azp03     #FUN-960141
   DEFINE li_result   LIKE type_file.num5    #No.FUN-690028 SMALLINT
   DEFINE l_n         LIKE type_file.num5    #MOD-C50237
   DEFINE l_n1        LIKE type_file.num5    #yinhy130605
   DEFINE l_aag09         LIKE aag_file.aag09    #No.FUN-690080
   DEFINE l_aag21         LIKE aag_file.aag21    #MOD-850100 add
   DEFINE l_flag          LIKE type_file.chr1,                 #判斷必要欄位是否有輸入  #No.FUN-690028 VARCHAR(1)
          p_cmd           LIKE type_file.chr1,                 #a:輸入 u:更改  #No.FUN-690028 VARCHAR(1)
          g_t1            LIKE oay_file.oayslip,               #No.FUN-550030  #No.FUN-690028 VARCHAR(5)
          l_amb01,l_amb02 LIKE type_file.num5,        # No.FUN-690028 SMALLINT,
          l_amb03         LIKE amb_file.amb03,        # No.FUN-690028 VARCHAR(2),
          l_apa32f        LIKE apa_file.apa32f,  #MOD-4A0193
          l_apa32         LIKE apa_file.apa32 ,  #MOD-4A0193
          t_apa31f        LIKE apa_file.apa31f,  #MOD-B80140
          t_apa31         LIKE apa_file.apa31,   #MOD-B80140
          t_apa32f        LIKE apa_file.apa32f,  #MOD-970278 add
          t_apa32         LIKE apa_file.apa32 ,  #MOD-970278 add
          l_apb02         LIKE apb_file.apb02,
          l_apb08         LIKE apb_file.apb08,
          l_apb081        LIKE apb_file.apb081,
          l_apb09         LIKE apb_file.apb09,
          l_apb21         LIKE apb_file.apb21,   #MOD-A80204
          l_apb23         LIKE apb_file.apb23,
          l_apb24         LIKE apb_file.apb24,   #MOD-860221 add
          l_apb10         LIKE apb_file.apb10,
          l_apb101        LIKE apb_file.apb101,
          l_apa31f_t      LIKE apa_file.apa31f,  #No.MOD-530687
          l_apa31f_o      LIKE apa_file.apa31f,  #No.MOD-530687
          l_paydate       LIKE type_file.dat,    #No.FUN-690028 DATE
          l_aag05         LIKE aag_file.aag05,   #MOD-580051
          l_pmc30         LIKE pmc_file.pmc30,   #MOD-590301
          l_pmc913        LIKE pmc_file.pmc913,  #MOD-A90181
          l_gen01         LIKE gen_file.gen01    #FUN-5B0081
   DEFINE l_nochk         LIKE type_file.num5    #TQC-750121
   DEFINE l_pmb02         LIKE pmb_file.pmb02    #TQC-770027
   DEFINE l_cnt           SMALLINT   #MOD-810050   #MOD-810244  #MOD-810207
   DEFINE l_gec05         LIKE gec_file.gec05    #MOD-8A0213 add
   DEFINE l_apb06         LIKE apb_file.apb06    #MOD-980032 add
   DEFINE l_apa31f        LIKE apa_file.apa31f   #MOD-980032 add 
   DEFINE l_pmm40         LIKE pmm_file.pmm40    #MOD-980032 add 
   DEFINE l_pmm40t        LIKE pmm_file.pmm40t   #CHI-9C0015 add 
   DEFINE l_apa02         LIKE apa_file.apa02    #MOD-970179 add
   DEFINE l_apb01         LIKE apb_file.apb01    #MOD-9B0048 add
   DEFINE l_apa31f0       LIKE apa_file.apa31f   #MOD-9B0048 add 
   DEFINE l_pmm40t_tot    LIKE pmm_file.pmm40t   #MOD-A30059 add
   DEFINE l_apb37         LIKE apb_file.apb37    #FUN-A60056
   DEFINE l_rvu03         LIKE rvu_file.rvu03    #MOD-A80204
   DEFINE g_gec07         LIKE gec_file.gec07    #CHI-B90030 add
   DEFINE l_gec07         LIKE gec_file.gec07    #MOD-C60190 add
   DEFINE l_w             LIKE type_file.num5    #CHI-C10043 add
   DEFINE l_pma11         LIKE pma_file.pma11    #CHI-C10043 add
   DEFINE l_sme02         LIKE sme_file.sme02    #CHI-C10043 add
   DEFINE l_apa64         LIKE apa_file.apa64    #CHI-C10043 add
   DEFINE l_occ02_pmc03   LIKE occ_file.occ02    #FUN-D80049 add
   DEFINE l_apa101_desc   LIKE nma_file.nma02    #FUN-D80071
   DEFINE l_apa102_desc   LIKE nmc_file.nmc02    #FUN-D80071

   CALL cl_set_head_visible("","YES")            #No.FUN-6B0033
 
   #FUN-A50102--add--str--
   IF NOT cl_null(g_apa.apa100) THEN
      LET m_plant = g_apa.apa100
   ELSE
      LET m_plant = g_plant
   END IF 
   #FUN-A50102--add--end 
   INPUT BY NAME g_apa.apa01,g_apa.apa02,g_apa.apa05,g_apa.apa06,g_apa.apa07, g_apa.apaoriu,g_apa.apaorig,
                 g_apa.apa21,g_apa.apa22,g_apa.apa930,g_apa.apa76, #FUN-960141 add apaplant  #FUN-960141 090824 del apaplant  #FUN-9C0041 add apa76
                 g_apa.apamksg,g_apa.apa42,g_apa.apa41,g_apa.apa79,  #FUN-670064         #No.FUn-A40003 add apa79
                 g_apa.apa44,g_apa.apa992,g_apa.apa63,g_apa.apa36,g_apa.apa13,g_apa.apa14,  #No.FUN-690090 add apa992
                 g_apa.apa15,g_apa.apa16,g_apa.apa08,g_apa.apa77,g_apa.apa58,g_apa.apa11, #FUN-5C0106 #FUN-970108 add apa77
                 g_apa.apa12,g_apa.apa24,g_apa.apa64,g_apa.apa55,g_apa.apa31f,
                 g_apa.apa32f,g_apa.apa60f,g_apa.apa61f,g_apa.apa65f,g_apa.apa37f,g_apa.apa34f,g_apa.apa35f, #No.FUN-690080
                 g_apa.apa31,g_apa.apa32,g_apa.apa60,g_apa.apa61,g_apa.apa65,
                 g_apa.apa37,g_apa.apa34,g_apa.apa35,                               #No.FUN-690080
                 g_apa.apa56,g_apa.apa33,g_apa.apa66,
                 g_apa.apa25,g_apa.apa100,g_apa.apainpd,g_apa.apa99,g_apa.apa51,g_apa.apa52,g_apa.apa54,g_apa.apa511,g_apa.apa521,g_apa.apa541,   #No:8150 add #FUN-630043 #No.FUN-690080
                 g_apa.apa101,g_apa.apa102,                                   #No.FUN-690080
                 g_apa.apauser,g_apa.apagrup,g_apa.apamodu,g_apa.apadate,g_apa.apaacti,  #No.FUN-690080
                 g_apa.apaud01,g_apa.apaud02,g_apa.apaud03,g_apa.apaud04,
                 g_apa.apaud05,g_apa.apaud06,g_apa.apaud07,g_apa.apaud08,
                 g_apa.apaud09,g_apa.apaud10,g_apa.apaud11,g_apa.apaud12,
                 g_apa.apaud13,g_apa.apaud14,g_apa.apaud15
                 WITHOUT DEFAULTS
 
      BEFORE INPUT
         LET g_before_input_done = FALSE
         IF NOT cl_null(g_apa.apa02) THEN  #MOD-BA0189
            CALL t110_bookno()             #MOD-BA0189
         END IF                            #MOD-BA0189
         CALL t110_set_entry(p_cmd)
         CALL t110_set_entry_1()     #No.FUN-8A0075
         CALL t110_set_no_entry(p_cmd)
         CALL t110_set_no_entry_1()  #No.FUN-8A0075
         LET g_before_input_done = TRUE
         CALL cl_set_act_visible("maintain_misc_vender",TRUE)
         CALL cl_set_docno_format("apa01")
         CALL t110_set_no_apa_required()  #FUN-970108 
         CALL t110_set_apa_required()     #FUN-970108
         LET l_apa02 = g_apa_t.apa02           #MOD-970179 add
   
      #NO.FUN-CB0019  --Begin
      BEFORE FIELD apa01
         IF cl_null(g_apa.apa01) THEN
            CALL s_get_slip('aap','apy_file','apyslip','apykind','apyacti',g_aptype,'')
                 RETURNING g_apa.apa01
            DISPLAY BY NAME g_apa.apa01
         END IF
      #NO.FUN-CB0019  --End

      AFTER FIELD apa01                  #帳款編號
 
         IF NOT cl_null(g_apa.apa01) THEN   #No.FUN-690080
            IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa01 != g_apa01_t) THEN
               CALL s_check_no("aap",g_apa.apa01,g_apa01_t,g_aptype,"apa_file","apa01","")
               RETURNING li_result,g_apa.apa01
               DISPLAY BY NAME g_apa.apa01
               IF (NOT li_result) THEN
                  LET g_apa.apa01=g_apa_t.apa01       #MOD-B50218 mod g_apa_o -> g_apa_t
                  NEXT FIELD apa01
               END IF
               IF NOT cl_null(g_apa.apa01[1,1]) THEN
 
                  CALL s_get_doc_no(g_apa.apa01) RETURNING g_t1
                  SELECT * INTO g_apy.* FROM apy_file
                     WHERE apyslip=g_t1 AND apyacti = 'Y'
                                        AND apykind=g_apa.apa00
                     IF g_apa_t.apa01 IS NULL OR (g_apa.apa01 != g_apa_t.apa01 ) THEN
                        LET  g_apa.apamksg = g_apy.apyapr
                        DISPLAY BY NAME g_apa.apamksg   #簽核否
                     END IF
 
               END IF
            END IF
         END IF   #No.FUN-690080
         SELECT apyvcode INTO g_apa.apa77  FROM apy_file WHERE apyslip = g_t1   
         IF cl_null(g_apa.apa77) THEN 
            LET g_apa.apa77 = g_apz.apz63 
         END IF     
         
      AFTER FIELD apa02
         IF NOT cl_null(g_apa.apa02) THEN
            CALL t110_bookno()                #No.FUN-730064
            #FUN-B50090 add begin-------------------------
            #重新抓取關帳日期
            SELECT apz57 INTO g_apz.apz57 FROM apz_file WHERE apz00='0'
            #FUN-B50090 add -end--------------------------
            IF g_apa.apa02 <= g_apz.apz57 THEN   #立帳日期不可小於關帳日期
               CALL cl_err(g_apa.apa01,'aap-176',1)
               NEXT FIELD apa02
            END IF
 
            IF cl_null(g_apa.apa09) THEN
               LET g_apa.apa09=g_apa.apa02
            END IF
 
            IF g_aptype[1,1] = '1' AND   #MOD-860203 mark  #CHI-930014 mark回復
               g_apa.apa11 IS NOT NULL AND
               g_apa.apa02 != l_apa02 AND l_apa02 IS NOT NULL THEN  #MOD-970179 modify g_apa_t.apa02改為l_apa02
               IF g_apa_t.apa02 IS NULL OR g_apa_t.apa02<>g_apa.apa02 THEN           #CHI-B80054 add
                  IF g_aptype = '13' OR g_aptype = '17' THEN
                     CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apa.apa11,'EMPL')
                          RETURNING l_paydate,g_apa.apa64,g_apa.apa24
                  ELSE
                     CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apa.apa11,g_apa.apa06)
                          RETURNING l_paydate,g_apa.apa64,g_apa.apa24
                  END IF
               END IF                                                                #CHI-B80054 add
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa01,g_errno,0)
                  LET g_apa.apa64 = g_apa_t.apa64   
                  LET g_apa.apa24 = g_apa_t.apa24  
               ELSE
                  LET g_apa.apa12 = l_paydate               
               END IF
              #---------------------MOD-C50253----------------------(S)
               CALL s_duedate(g_apa.apa06,g_apa.apa12,g_apa.apa24)
                    RETURNING g_apa.apa64
              #---------------------MOD-C50253----------------------(E)
               DISPLAY BY NAME g_apa.apa24,g_apa.apa12,g_apa.apa64
               #CHI-AB0017 add --start--
               IF g_apa.apa24 < 0 THEN
                  IF NOT cl_confirm('aap-142') THEN NEXT FIELD apa02 END IF
               END IF
               #CHI-AB0017 add --end--
            END IF
            IF g_apa.apa02 != l_apa02 THEN    #MOD-970179 modify g_apa_t.apa02改為l_apa02
               CALL t110_apa13('u')
#----------------No.MOD-B70202-------------------------------------------------start
               IF (NOT cl_null(g_apa.apa14) AND g_apa.apa14 != g_apa_t.apa14) OR cl_null(g_apa.apa14) THEN
                  IF NOT t110_apa14(g_apa.apa01) THEN
                     NEXT FIELD apa02 
                  END IF
               END IF
#----------------No.MOD-B70202-------------------------------------------------end
              #-MOD-A80204-add-
               LET l_cnt = 0
               SELECT COUNT(*) INTO l_cnt
                 FROM apb_file
                WHERE apb01 = g_apa.apa01 AND apb34 = 'N'
                  AND apb21 IS NOT NULL     #MOD-B20082
              #IF l_cnt > 0 THEN                                                                                 #MOD-B20082 mark 
               IF l_cnt > 0 AND (g_aptype = '11' OR g_aptype = '16' OR g_aptype = '21' OR g_aptype = '26') THEN  #MOD-B20082
                  DECLARE chk_rvu_cs CURSOR FOR
                     SELECT DISTINCT apb21,apb37 
                       FROM apb_file
                      WHERE apb01=g_apa.apa01 AND apb34 = 'N'
                        AND apb21 IS NOT NULL     #MOD-B20082
                  FOREACH chk_rvu_cs INTO l_apb21,l_apb37
                     LET g_sql = "SELECT rvu03 FROM ",cl_get_target_table(l_apb37,'rvu_file'), 
                                 " WHERE rvu01 = '",l_apb21,"' "
                     CALL cl_replace_sqldb(g_sql) RETURNING g_sql             
	             CALL cl_parse_qry_sql(g_sql,l_apb37) RETURNING g_sql 
                     PREPARE sel_rvu03_pre FROM g_sql
                     EXECUTE sel_rvu03_pre INTO l_rvu03
                     IF g_aza.aza26 = '2' THEN
                        IF (YEAR(l_rvu03) > YEAR(g_apa.apa02) OR (YEAR(l_rvu03) = YEAR(g_apa.apa02)
                           AND MONTH(l_rvu03) > MONTH(g_apa.apa02))) THEN 
                           CALL cl_err('','axr-065',1)
                           NEXT FIELD apa02
                           EXIT FOREACH
                        END IF
                        #No.MOD-C50237  --Begin
                        IF g_aptype = '11' THEN
                           IF YEAR(l_rvu03) <> YEAR(g_apa.apa02) OR MONTH(l_rvu03) <> MONTH(g_apa.apa02) THEN                           
                              LET l_n = 0                                               
                              SELECT COUNT(apa01) INTO l_n FROM apb_file,apa_file       
                               WHERE apb21 = l_apb21 
                                 AND apb01 = apa01                                      
                                 AND (apa00 ='16' OR apa00 ='26')
                                 AND YEAR(apa02) = YEAR(l_rvu03)
                                 AND MONTH(apa02) = MONTH(l_rvu03)
                              IF l_n = 0 THEN                                           
                                 CALL cl_err('','gap-145',0)                            
                                 NEXT FIELD apa02
                                 EXIT FOREACH
                              END IF        
                           END IF
                        END IF
                        #No.MOD-C50237  --End
                     ELSE
                        IF (YEAR(l_rvu03) != YEAR(g_apa.apa02) OR (YEAR(l_rvu03) = YEAR(g_apa.apa02)
                           AND MONTH(l_rvu03) != MONTH(g_apa.apa02))) THEN
                           CALL cl_err('','axr-065',1)
                           NEXT FIELD apa02
                           EXIT FOREACH
                        END IF
                     END IF
                  END FOREACH                  
               END IF
              #-MOD-A80204-end-
            END IF
         END IF
         LET l_apa02 = g_apa.apa02                   #MOD-970179 add

      AFTER FIELD apa05
         IF NOT cl_null(g_apa.apa05) THEN
           #IF g_apa_o.apa05 IS NULL OR g_apa.apa05 != g_apa_o.apa05 THEN         #MOD-B50218 mark
            IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa05 != g_apa_t.apa05) THEN #MOD-B50218
               #FUN-D80031 add ---------- begin #如果是aapt140來源于occ_file
               CASE g_prog
                  WHEN 'aapt140'
                     CALL t110_apa05_1(p_cmd)
                  #FUN-D80049 add ----- begin
                  WHEN 'aapt150'
                     IF g_aza.aza26 = '2' AND g_apz.apz74 = 'Y' THEN #FUN-DA0051 add
                        CALL t110_apa05_1(p_cmd)
                        IF NOT cl_null(g_errno) THEN
                           CALL t110_apa05('a')
                        END IF
                     ELSE                                            #FUN-DA0051 add
                        CALL t110_apa05('a')                         #FUN-DA0051 add
                     END IF                                          #FUN-DA0051 add
                  #FUN-D80049 add ----- end
                  OTHERWISE
                     CALL t110_apa05('a')
               END CASE
               #FUN-D80031 add ---------- end
 #             CALL t110_apa05('a')    #FUN-D80031 mark
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa05,g_errno,0)
                  LET g_apa.apa05 = g_apa_t.apa05     #MOD-B50218 mod g_apa_o -> g_apa_t
                  DISPLAY BY NAME g_apa.apa05
                  NEXT FIELD apa05
               END IF
               DISPLAY BY NAME g_apa.apa05
            END IF
            LET g_apa_t.apa05 = g_apa.apa05           #MOD-B50218 mod g_apa_o -> g_apa_t
          # SELECT pmc903 INTO g_pmc903  FROM pmc_file   #FUN-950053 add  #FUN-D80031 mark
          #  WHERE pmc01 = g_apa.apa05                   #FUN-950053      #FUN-D80031 mark
            #FUN-D80031 add ---------- begin
            IF g_prog = 'aapt140' THEN
               SELECT occ37 INTO g_pmc903 FROM occ_file WHERE occ01=g_apa.apa05
            ELSE
               SELECT pmc903 INTO g_pmc903  FROM pmc_file WHERE pmc01 = g_apa.apa05
               #FUN-D80049 add ----- begin
              #IF g_prog = 'aapt150' THEN                                                #FUN-DA0051 mark
               IF g_prog = 'aapt150' AND g_aza.aza26 = '2' AND g_apz.apz74 = 'Y' THEN    #FUN-DA0051 add
                  IF cl_null(g_pmc903) THEN
                     SELECT occ37 INTO g_pmc903 FROM occ_file WHERE occ01=g_apa.apa05
                  END IF
               END IF
               #FUN-D80049 add ----- end
            END IF
            #FUN-D80031 add ---------- end
         END IF
 
      BEFORE FIELD apa06
         CALL t110_set_entry(p_cmd)
 
      AFTER FIELD apa06
         IF NOT cl_null(g_apa.apa06) THEN
#           IF NOT (g_aptype = '13' OR g_aptype = '17') THEN  #FUN-D80031 mark
            IF NOT (g_aptype = '13' OR g_aptype = '17' OR g_prog = 'aapt140' OR g_prog ='aapt150') THEN #FUN-D80031 add #FUN-D80049
               #MOD-590301 付款廠商的廠商性質應為 2 or 3
               SELECT pmc30 INTO l_pmc30 FROM pmc_file
                WHERE pmc01=g_apa.apa06
               IF l_pmc30 NOT MATCHES "[23]" THEN
                  CALL cl_err('','aap-050',0)
                  NEXT FIELD apa06
               END IF
            END IF
           #IF g_apa_o.apa06 IS NULL OR g_apa.apa06 != g_apa_o.apa06 THEN         #MOD-B50218 mark
            IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa06 != g_apa_t.apa06) THEN #MOD-B50218
               IF g_aptype = '13' OR g_aptype = '17' THEN
                  CALL t110_gen(g_apa.apa06,'0')        #No.CHI-780046
               ELSE
                  #FUN-D80031 add ---------- begin
                  IF g_prog = 'aapt140' THEN            
                     IF p_cmd = 'u' AND g_apa.apa06 != g_apa_t.apa06 THEN
                        #如果單身存在對應的收款客戶的門店資料則不能修改
                        SELECT COUNT(*) INTO l_n FROM apb_file WHERE apb01=g_apa.apa01
                        IF l_n > 0 THEN
                           CALL cl_err('','axr-632',0)
                           LET g_apa.apa06 = g_apa_t.apa06
                           DISPLAY BY NAME g_apa.apa06
                           NEXT FIELD apa06
                        END IF
                     END IF
                     CALL t110_apa06_1(p_cmd)
                  ELSE
                  #FUN-D80031 add ---------- end
                     LET l_occ02_pmc03 = NULL                                         #FUN-D80049 add
                     SELECT pmc01,pmc03 INTO g_apa.apa06,l_occ02_pmc03 FROM pmc_file  #FUN-D80049 add pmc03
                      WHERE pmc01=g_apa.apa06
                     DISPLAY BY NAME g_apa.apa06
                     #FUN-D80049 ------ ADD ---------- begin
                    #IF g_prog = 'aapt150' THEN                                              #FUN-DA0051 mark
                     IF g_prog = 'aapt150' AND g_aza.aza26 = '2' AND g_apz.apz74 = 'Y'       #FUN-DA0051 add
                        AND cl_null(l_occ02_pmc03) THEN                                      #FUN-DA0051 add
                       ##FUN-DA0051 ------ mark ----- begin
                       #IF NOT cl_null(l_occ02_pmc03) THEN
                       #   #MOD-590301 付款廠商的廠商性質應為 2 or 3
                       #   SELECT pmc30 INTO l_pmc30 FROM pmc_file
                       #    WHERE pmc01=g_apa.apa06
                       #   IF l_pmc30 NOT MATCHES "[23]" THEN
                       #      CALL cl_err('','aap-050',0)
                       #      NEXT FIELD apa06
                       #   END IF
                       #   CALL t110_apa06('a')
                       #ELSE
                       #   CALL t110_apa06_1(p_cmd)
                       #END IF
                       ##FUN-DA0051 ------ mark ----- end
                       CALL t110_apa06_1(p_cmd)   #FUN-DA0051 add
                     ELSE
                        #FUN-DA0051 ------ add  ----- begin
                        SELECT pmc30 INTO l_pmc30 FROM pmc_file
                         WHERE pmc01=g_apa.apa06
                        IF l_pmc30 NOT MATCHES "[23]" THEN
                           CALL cl_err('','aap-050',0)
                           NEXT FIELD apa06
                        END IF
                        #FUN-DA0051 ------ add  ----- end
                        CALL t110_apa06('a')
                     END IF
                     #FUN-D80049 ------ ADD ---------- end
                     #CALL t110_apa06('a')  #FUN-D80049
                  END IF   #FUN-D80031 add
               END IF
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa06,g_errno,0)
                  LET g_apa.apa06 = g_apa_t.apa06       #MOD-B50218 mod g_apa_o -> g_apa_t
                  DISPLAY BY NAME g_apa.apa06
                  NEXT FIELD apa06
               END IF
 
               IF g_aptype[1,1] = '1' AND   #MOD-860203 mark  #CHI-930014 mark回復
                   g_apa.apa11 IS NOT NULL THEN
                  SELECT pma11 INTO g_pma11 FROM pma_file
                   WHERE pma01=g_apa.apa11
                  DISPLAY g_pma11 TO pma11
 
                 #IF g_apa_o.apa11 IS NULL OR g_apa_o.apa11<>g_apa.apa11 THEN           #MOD-B50218 mark
                 #IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa11 != g_apa_t.apa11) THEN #MOD-B50218 #CHI-B80054
                  IF g_apa_t.apa06 IS NULL OR g_apa_t.apa06<>g_apa.apa06 THEN           #CHI-B80054 add 
                     IF g_aptype = '13' OR g_aptype = '17' THEN
                        CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apa.apa11,'EMPL')
                             RETURNING l_paydate,g_apa.apa64,g_apa.apa24   #No.+106
                     ELSE
                        CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apa.apa11,
                                       g_apa.apa06)
                             RETURNING l_paydate,g_apa.apa64,g_apa.apa24   #No.+106
                     END IF
                     DISPLAY BY NAME g_apa.apa24
                     LET g_apa.apa12 = l_paydate
                    #---------------------MOD-C50253----------------------(S)
                     CALL s_duedate(g_apa.apa06,g_apa.apa12,g_apa.apa24)
                          RETURNING g_apa.apa64
                    #---------------------MOD-C50253----------------------(E)
                     DISPLAY BY NAME g_apa.apa12
                     DISPLAY BY NAME g_apa.apa64
                     #CHI-AB0017 add --start--
                     IF g_apa.apa24 < 0 THEN
                        IF NOT cl_confirm('aap-142') THEN NEXT FIELD apa06 END IF
                     END IF
                     #CHI-AB0017 add --end--
                  END IF
               END IF
            END IF
            IF g_aptype = '13' OR g_aptype = '17' THEN
               LET g_apa.apa21 = g_apa.apa06    #請款人員
               LET g_apa.apa05 = g_apa.apa06    #請款人員
            END IF
           #-MOD-C90093-add-
            IF cl_null(g_apa.apa07) THEN
#              CALL t110_apa06('a')  #FUN-D80031 mark
               #FUN-D80031 add ---------- begin
               IF g_prog = 'aapt140' THEN
                  CALL t110_apa06_1('a')
               ELSE
                 #CALL t110_apa06('a')                                                   #FUN-D80049 mark
                  #FUN-D80031 ------- add ------- begin
                 #IF g_prog = 'aapt150' THEN                                             #FUN-DA0051 mark
                  IF g_prog = 'aapt150' AND g_aza.aza26 = '2' AND g_apz.apz74 = 'Y' THEN #FUN-DA0051 add
                     CALL t110_apa06_1('a')
                     IF cl_null(g_apa.apa07) THEN
                        CALL t110_apa06('a')
                     END IF
                  ELSE
                       CALL t110_apa06('a')
                  END IF
                  #FUN-D80031 ------- add ------- end
               END IF
               #FUN-D80031 add ---------- end
            END IF
            #No.yinhy140528  --Begin
            IF cl_null(g_apa.apa12) THEN
            	 LET g_apa.apa12=g_today
            	 LET g_apa.apa64=g_today
            	 LET g_apa.apa24 = 0
            	 SELECT pma11 INTO g_pma11 FROM pma_file
                WHERE pma01 = g_apa.apa11        
               DISPLAY g_pma11 TO pma11
            	 DISPLAY BY NAME g_apa.apa12,g_apa.apa24,g_apa.apa64
            END IF
            #No.yinhy140528  --Begin
            LET g_apa_t.apa06 = g_apa.apa06 
           #-MOD-C90093-end-
         END IF
        #LET g_apa_t.apa06 = g_apa.apa06   #MOD-C90093 mark   #MOD-9B0089 add   #MOD-B50218 mod g_apa_o -> g_apa_t
         CALL t110_set_no_entry(p_cmd)
 
      AFTER FIELD apa07
         IF NOT cl_null(g_apa.apa07) THEN
            #TQC-C70027--mark--str--
            #IF g_apa.apa07[1,1]='.' THEN
            #  #LET g_msg = g_apa.apa07[2,9]     #MOD-A60095 mark
            #   LET g_msg = g_apa.apa07[2,11]    #MOD-A60095
            #   LET g_msg = g_msg CLIPPED   #No.TQC-720043
            #   SELECT gen02 INTO g_apa.apa07 FROM gen_file WHERE gen01=g_msg
            #   DISPLAY BY NAME g_apa.apa07
            #   IF STATUS THEN
            #      NEXT FIELD apa07
            #   END IF
            #END IF
            #TQC-C70027--mark--end--
          #-------------------MOD-CC0238-----------------(S)                                  
           #--MOD-CC0238--mark
           ##TQC-C70027--add--str--
           #SELECT COUNT(*) INTO l_n FROM apa_file 
           # WHERE apa07 = g_apa.apa07 
           #   AND apa00 in ('11','12','15') 
           #   AND apa34f != apa35f 
           #   AND apa34 != apa35 
           #   AND apa06 = 'MISC'  
           #IF l_n = 0 THEN 
           #   CALL cl_err('','aap-356',0)
           #   NEXT FIELD apa07
           #END IF       
           ##TQC-C70027--add--str--
           #--MOD-CC0238--mark
            IF g_apa.apa07[1,1]='.' THEN                                  
               LET g_msg = g_apa.apa07[2,11]                                     
               LET g_msg = g_msg CLIPPED                                     
               IF g_aptype = '12' AND g_apa.apa06 = 'MISC' THEN                                
                  SELECT pmc03 INTO g_apa.apa07 
                    FROM pmc_file WHERE pmc01=g_msg                
               ELSE                                                                            
                  SELECT gen02 INTO g_apa.apa07 
                    FROM gen_file WHERE gen01=g_msg                
               END IF                                                                          
               DISPLAY BY NAME g_apa.apa07                                  
               IF STATUS THEN                                  
                  NEXT FIELD apa07                                  
               END IF                                  
            END IF                                  
           #----------------MOD-D20174-----------mark                                  
           #IF g_apa.apa06 = 'MISC' THEN                                  
           #   LET l_cnt = 0                                  
           #   SELECT COUNT(*) INTO l_cnt FROM pmc_file                                  
           #    WHERE pmc03 = g_apa.apa07                                  
           #     #AND pmc14 = '2'                           #CHI-D10057 mark                           
           #      AND pmcacti = 'Y'                                  
           #   IF l_cnt = 0 THEN                                  
           #      CALL cl_err('','aap-356',0)                                  
           #      NEXT FIELD apa07                                  
           #   END IF                                  
           #END IF                                  
           #----------------MOD-D20174-----------mark                                  
            IF g_apa.apa06 = 'EMPL' THEN                                  
               LET l_cnt = 0                                  
               SELECT COUNT(*) INTO l_cnt FROM gen_file                                  
                WHERE gen02 = g_apa.apa07                                  
                  AND genacti = 'Y'                                  
               IF l_cnt = 0 THEN                                  
                  CALL cl_err('','aoo-070',0)                                  
                  NEXT FIELD apa07                                  
               END IF                                  
            END IF                                  
          #-------------------MOD-CC0238-----------------(E)
         END IF
 
      BEFORE FIELD apa08
         CALL t110_set_entry(p_cmd)
 
      AFTER FIELD apa08
         IF (g_apa.apa00!='16' AND g_apa.apa00!='26' AND g_apa.apa00!='12') AND g_apa.apa08='UNAP' THEN   #MOD-7A0040
            CALL cl_err_msg('','aap-923','aapt160,aapt260',1)   #非aapt160,aapt260此欄位不可輸入UNAP
            NEXT FIELD apa08
         END IF
 
        #----------------MOD-C70185-----------------mark
        #IF g_aptype ='11' THEN                     #MOD-960059  #MOD-960264 mark回復
        #   IF cl_null(g_apa.apa08) THEN
        #      CALL cl_err('apa08 is null: ','aap-099',0)
        #      NEXT FIELD apa08
        #   END IF
        #END IF
        #----------------MOD-C70185-----------------mark
        #當發票聯數(gec05)不為4或X時,aapt120的發票欄位(apa08)為必輸
        #IF g_aptype ='12' OR g_aptype ='13' OR g_aptype ='15' THEN   #MOD-B30179 add15#MOD-B40108 add 13 #MOD-C70185 mark
         #IF g_aptype MATCHES '1*' THEN                                #MOD-C70185 add
         IF g_aptype MATCHES '1*' AND g_aptype != '15' THEN   #mod by lili 170527
            LET l_gec05 = ''
            SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01=g_apa.apa15
            IF l_gec05 NOT MATCHES '[4X]' AND cl_null(g_apa.apa08) THEN
               CALL cl_err('apa08 is null: ','aap-099',0)
               NEXT FIELD apa08
            END IF
         END IF
         #add by lili 170527 ---s---
         IF g_aptype = '13' THEN
            IF cl_null(g_apa.apa08) OR g_apa.apa08 = ' ' THEN
               CALL cl_err('apa08 is null: ','aap-099',0)
               NEXT FIELD apa08
            END IF
         END IF
         #add by lili 170527 ---e---
         IF g_apa.apa08 IS NULL THEN
            LET g_apa.apa08 = ' '
         END IF
 
         IF g_apa_t.apa08  ='UNAP' AND g_apa.apa08 !='UNAP' AND
            g_apa.apa00 !='12' AND g_apa.apa00 !='13' THEN   #No.FUN-690080
            LET g_apa.apa08=g_apa_t.apa08
            DISPLAY BY NAME g_apa.apa08
            CALL cl_err(g_apa.apa08,'aap-015',0)
            NEXT FIELD apa08
         END IF
 
         IF (g_apa_t.apa08 !='UNAP' OR g_apa_t.apa08 IS NULL) AND
             g_apa.apa08    ='UNAP' AND g_apa.apa00 !='12' AND g_apa.apa00 !='13' THEN   #No.FUN-690080
             LET g_apa.apa08=g_apa_t.apa08
             DISPLAY BY NAME g_apa.apa08
             CALL cl_err(g_apa.apa08,'aap-001',0)
             NEXT FIELD apa08
         END IF
         IF g_aptype !='21' AND g_aptype!='22' THEN   #TQC-750177
           IF g_apa.apa08 != 'MISC' AND NOT cl_null(g_apa.apa08) AND
              g_apa.apa08 != 'UNAP' THEN
              LET l_nochk = LENGTH(g_apa.apa08)
              IF g_apa.apa171 = '28' OR g_apa.apa171 = '29' THEN
                 IF l_nochk != 14 THEN
                    CALL cl_err(g_apa.apa08,'amd-009',0)
                    NEXT FIELD apa08
                 END IF
              ELSE
                 IF NOT cl_null(g_apa.apa08) THEN
                    IF g_aza.aza26<>'2' THEN   #No.MOD-7B0128
                       IF g_apa.apa171 != 'XX' AND g_apa.apa171 != '22' THEN  
                          IF l_nochk != 10 THEN
                             CALL cl_err(g_apa.apa08,'amd-010',0)
                             NEXT FIELD apa08
                          END IF
                        ELSE
                          #稅別格式若為22時,提示警訊即可,不控卡
                           IF g_apa.apa171='22' THEN
                              CALL cl_err(g_apa.apa08,'amd-010',0)
                           END IF
                       END IF
                    END IF
                 END IF
              END IF
           END IF    #TQC-750177
         END IF
 
         IF g_apa.apa08 != 'MISC' AND NOT cl_null(g_apa.apa08) AND
            g_apa.apa08 != 'UNAP' AND
            ((g_apa_t.apa08 IS NOT NULL AND g_apa.apa08!=g_apa.apa01) OR
             (g_apa_t.apa08 IS NULL)) THEN
            LET l_gec05 = ''
            SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01=g_apa.apa15
           #IF l_gec05 != 'X' THEN                   #No.MOD-B80015 mark
            IF l_gec05 NOT MATCHES '[4X]' THEN       #No.MOD-B80015 add
              #IF g_apa_t.apa08 IS NULL AND NOT t110_chk(g_apa.apa08) THEN     #MOD-A50180 mark
               IF NOT t110_chk(g_apa.apa08) THEN                               #MOD-A50180
                  CALL cl_err(g_apa.apa08,'sub-005',0)
                  NEXT FIELD apa08
               END IF
            END IF   #MOD-8A0213 add
            LET l_amb03=g_apa.apa08[1,2]
            IF g_apa.apa02 != g_apa.apa09 THEN
               LET l_amb01=YEAR(g_apa.apa09)
               LET l_amb02=MONTH(g_apa.apa09)
            ELSE
               LET l_amb01=YEAR(g_apa.apa02)
               LET l_amb02=MONTH(g_apa.apa02)
            END IF
            LET g_msg = ""   #MOD-9C0356 add
            #CHI-930020--Begin 
           #SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01 = g_apa.apa15  #MOD-C60190 mark
            SELECT gec05,gec07 INTO l_gec05,l_gec07                            #MOD-C60190 add
              FROM gec_file                                                    #MOD-C60190 add
             WHERE gec01 = g_apa.apa15                                         #MOD-C60190 add
           #IF g_apz.apz07 = 'Y' AND (l_gec05 = '2' OR l_gec05 = '3') AND                  #MOD-C70159 mark
            IF g_apz.apz07 = 'Y' AND (l_gec05 MATCHES '[2356]') AND                        #MOD-C70159 add
               g_aza.aza26!= '2' THEN   #MOD-9C0444 add
               CALL s_apkchk(l_amb01,l_amb02,l_amb03,g_apa.apa171)            
                    RETURNING g_errno,g_msg                                   
            END IF            
            #CHI-930020---End                                                
            IF NOT cl_null(g_msg) THEN
               CALL cl_getmsg(g_msg,g_lang) RETURNING g_msg
               ERROR g_msg clipped,' invoice =',g_apa.apa08,' SQLCODE=',g_errno
                IF cl_confirm('aap-766') THEN  #No.MOD-480431
                  IF NOT cl_null(g_errno) THEN
                     NEXT FIELD apa08
                  END IF
               END IF
            END IF
 
         IF g_apa_t.apa08 IS NOT NULL AND g_apa_t.apa08 = 'MISC' THEN  #原本是多發票
            SELECT COUNT(*) INTO g_cnt FROM apk_file
             WHERE apk01 = g_apa.apa01
            IF g_cnt > 0 AND g_apa_t.apa08 != g_apa.apa08 THEN
               CALL cl_err(g_apa.apa08,'aap-761',0)
               LET g_apa.apa08 = g_apa_t.apa08
               DISPLAY BY NAME g_apa.apa08
               NEXT FIELD apa08
            END IF
         END IF
 
            IF g_apa.apa08 != 'MISC' AND g_apa.apa08 != 'UNAP' AND
               NOT cl_null(g_apa.apa08) THEN
               IF g_aza.aza26 <> '2' THEN                                                 #MOD-D30074 add
                  IF g_aptype='11' OR g_aptype='12' OR 
                     g_aptype='13' OR g_aptype='15' THEN  #No.FUN-690080  #MOD-9B0190 add 15
                     IF g_apa.apa08 IS NOT NULL AND (g_apa_t.apa08 IS NULL OR
                        g_apa.apa08 != g_apa_t.apa08) THEN
                       #CALL t110_invoice_chk(g_apa.apa08,'')   #MOD-770138
                       #CALL t110_invoice_chk(g_apa.apa08,'',g_apa.apa09)   #CHI-820005   #No.TQC-CB0066   Mark
                       #CALL t110_invoice_chk(g_apa.apa08,'',g_apa.apa09,g_apa.apa46)     #No.TQC-CB0066 Add #MOD-D30074 mark
                        CALL t110_invoice_chk(g_apa.apa08,'',g_apa.apa09,'')              #MOD-D30074 add
                        IF NOT cl_null(g_errno) THEN
                           CALL cl_err(g_apa.apa08,g_errno,0)
                           NEXT FIELD apa08
                        END IF
                     END IF
                  END IF
               ELSE
                  #No.MOD-D50011  --Begin
                  IF g_aptype='11' OR g_aptype='12' OR 
                     g_aptype='13' OR g_aptype='15' THEN
                     IF g_apa.apa08 IS NOT NULL AND (g_apa_t.apa08 IS NULL OR
                        g_apa.apa08 != g_apa_t.apa08) THEN
                        LET l_n = 0         
                        SELECT COUNT(*) INTO l_n FROM apk_file
                         WHERE apk03 = g_apa.apa08
                           AND apk01 IN (SELECT apa01 FROM apa_file) 
                        IF cl_null(l_n) THEN LET l_n = 0 END IF   
                        SELECT COUNT(*) INTO l_n1 FROM rvw_file
                         WHERE rvw01 =  g_apa.apa08
                        IF l_n + l_n1> 0 THEN
                           CALL cl_err('','apm-241',0)
                           NEXT FIELD apa08 
                        END IF
                        
                     END IF
                  END IF
                  #No.MOD-D50011  --End
               END IF                                               #MOD-D30074 add
               #IF g_apa.apa18 IS NULL THEN                          #MOD-C70257 mark #MOD-D30074 remark
               IF g_apa.apa18 IS NULL AND g_aza.aza26 <> '2' THEN   #MOD-C70257 #MOD-D30074 mark             #yinhy130510 大陸版不需要彈窗
                  CALL t110_apa17('a')
                  DISPLAY BY NAME g_apa.apa07   #TQC-630164  
                  DISPLAY BY NAME g_apa.apa24,g_apa.apa12,g_apa.apa64  #MOD-9C0148 add
               END IF
            END IF
         END IF
 
         IF p_cmd='u' AND g_apa.apa08='MISC' AND
            (g_apa_t.apa08<>'MISC' OR g_apa_t.apa08 IS NULL)
            AND g_apa.apa00[1,1] !='2' THEN
            IF g_aza.aza26 != '2' THEN #FUN-C90028 add
            CALL t110_ddd('1')   #MOD-950112 add參數
            END IF #FUN-C90028 add
            DISPLAY BY NAME g_apa.apa07      #TQC-630164  
            CALL t110_show_multi_invoice()   #No.TQC-A30076 
         END IF

         UPDATE apc_file SET apc12 =g_apa.apa08
          WHERE apc01 =g_apa.apa01
         CALL t110_set_no_entry(p_cmd)
 
      BEFORE FIELD apa77
        IF g_apa.apa77 IS NULL THEN      #No.TQC-A30072
           LET g_t1=s_get_doc_no(g_apa.apa01)
           SELECT apyvcode INTO g_apa.apa77 FROM apy_file WHERE apyslip = g_t1
           IF cl_null(g_apa.apa77) THEN
              LET g_apa.apa77 = g_apz.apz63
           END IF
           DISPLAY BY NAME g_apa.apa77   #No.TQC-A30072                       
        END IF                           #No.TQC-A30072
 
      AFTER FIELD apa77
          IF NOT cl_null(g_apa.apa77) THEN   
              SELECT COUNT(*) INTO l_cnt FROM ama_file
               WHERE ama02 = g_apa.apa77
                IF l_cnt = 0 THEN 
                   IF g_aza.aza26 = '0' THEN              #MOD-A10127 add
                      CALL cl_err("","amd-028",1) 
                      NEXT FIELD apa77                    #TQC-AB0025 add
                   END IF                                 #MOD-A10127 add
                END IF
                IF g_aza.aza21 = 'Y' AND NOT s_chkban(g_apa.apa77) THEN #FUN-990053 mod  #TQC-9A0017
                   CALL cl_err("","mfg7015",1)
                   NEXT FIELD apa77
                END IF
           ELSE
           	  IF g_aza.aza94 = 'Y' THEN
                 CALL cl_err('apa77 is null: ','aap-099',0)
                 NEXT FIELD apa77 
              END IF            
           END IF
      
      AFTER FIELD apa11
          IF g_aptype[1,1] = '1' AND cl_null(g_apa.apa11) THEN
             NEXT FIELD apa11
          END IF
 
          IF g_aptype[1,1] = '1' AND   #MOD-860203 mark  #CHI-930014 mark回復
              g_apa.apa11 IS NOT NULL THEN
            SELECT pma11 INTO g_pma11 FROM pma_file
             WHERE pma01 = g_apa.apa11
            IF STATUS THEN
               CALL cl_err3("sel","pma_file",g_apa.apa11,"",STATUS,"","sel pma:",1)  #No.FUN-660122
               NEXT FIELD apa11
            END IF
 
            IF g_apa.apa00 = '11' OR g_apa.apa00 = '17' OR g_apa.apa00 = '13' THEN  #TQC-B80066 add apa='17' #TQC-BA0050 add 13
               IF g_pma11 MATCHES '[3-8]' THEN
                  CALL cl_err('pma11=3-8 ','aap-273',0)
                  NEXT FIELD apa11
               END IF
            END IF
 
            DISPLAY g_pma11 TO pma11
 
           #IF g_apa_o.apa11 IS NULL OR g_apa_o.apa11<>g_apa.apa11 THEN           #MOD-B50218 mark
           #IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa11 != g_apa_t.apa11) THEN #MOD-B50218 #CHI-B80054 mark
            IF g_apa_t.apa11 IS NULL OR g_apa_t.apa11<>g_apa.apa11 THEN           #CHI-B80054 add
               LET g_errno=''
               IF g_aptype = '13' OR g_aptype = '17' THEN
                  CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apa.apa11,'EMPL')
                       RETURNING l_paydate,g_apa.apa64,g_apa.apa24   #No.+106
               ELSE
                  CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apa.apa11,
                                 g_apa.apa06)
                       RETURNING l_paydate,g_apa.apa64,g_apa.apa24   #No.+106
               END IF
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa11,g_errno,0)
                  LET g_apa.apa11 = g_apa_t.apa11       #MOD-B50218 mod g_apa_o -> g_apa_t
                  DISPLAY BY NAME g_apa.apa11
               END IF
               DISPLAY BY NAME g_apa.apa24
               LET g_apa.apa12 = l_paydate
              #---------------------MOD-C50253----------------------(S)
               CALL s_duedate(g_apa.apa06,g_apa.apa12,g_apa.apa24)
                    RETURNING g_apa.apa64
              #---------------------MOD-C50253----------------------(E)
               DISPLAY BY NAME g_apa.apa12
               DISPLAY BY NAME g_apa.apa64
               #CHI-AB0017 add --start--
               IF g_apa.apa24 < 0 THEN
                  IF NOT cl_confirm('aap-142') THEN NEXT FIELD apa11 END IF
               END IF
               #CHI-AB0017 add --end--
             IF p_cmd='u' THEN
               DELETE FROM apc_file WHERE apc01 =g_apa.apa01
               CALL t110_ins_apc(g_apa.*)
             END IF
            END IF
         END IF
         IF g_apa.apa11 IS NULL THEN LET g_apa.apa11 = ' ' END IF   #MOD-7B0101
         LET g_apa_t.apa11 = g_apa.apa11           #MOD-B50218 mod g_apa_o -> g_apa_t
 
      AFTER FIELD apa12
         IF g_aptype[1,1] = '1' AND   #MOD-860203 mark  #CHI-930014 mark回復
             g_apa.apa12 IS NOT NULL THEN
           #IF g_apa_o.apa12 IS NULL OR g_apa_o.apa12<>g_apa.apa12 THEN           #MOD-B50218 mark
           #IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa12 != g_apa_t.apa12) THEN #MOD-B50218 #CHI-B80054 mark
            IF g_apa_t.apa12 IS NULL OR g_apa_t.apa12<>g_apa.apa12 THEN           #CHI-B80054 add
               IF g_aptype = '13' OR g_aptype = '17' THEN
                  CALL s_paydate('a',g_apa.apa12,g_apa.apa09,g_apa.apa02,g_apa.apa11,'EMPL') #MOD-980148 modify ''改為g_apa.apa12
                     RETURNING l_paydate,g_apa.apa64,g_apa.apa24   #No.+106
               ELSE
                  CALL s_paydate('a',g_apa.apa12,g_apa.apa09,g_apa.apa02,g_apa.apa11,  #MOD-980148 modify ''改為g_apa.apa12
                                 g_apa.apa06)
                     RETURNING l_paydate,g_apa.apa64,g_apa.apa24   #No.+106
               END IF
              #---------------------MOD-C50253----------------------(S)
               CALL s_duedate(g_apa.apa06,g_apa.apa12,g_apa.apa24)
                    RETURNING g_apa.apa64
              #---------------------MOD-C50253----------------------(E)
               DISPLAY BY NAME g_apa.apa24,g_apa.apa64
               #CHI-AB0017 add --start--
               IF g_apa.apa24 < 0 THEN
                  IF NOT cl_confirm('aap-142') THEN NEXT FIELD apa12 END IF
               END IF
               #CHI-AB0017 add --end--
               CALL t110_upd_apc_date()     #MOD-B50218 
            END IF
           #-MOD-B50218-mark-
           #IF g_apa_o.apa12 IS NULL OR g_apa_o.apa12<>g_apa.apa12 THEN
           #   CALL t110_upd_apc_date()   
           #END IF
           #-MOD-B50218-end-
         END IF
         LET g_apa_t.apa12 = g_apa.apa12    #MOD-B50218 mod g_apa_o -> g_apa_t
 
      AFTER FIELD apa64
         IF g_apa.apa64 IS NOT NULL THEN
           #IF g_apa_o.apa64 IS NULL OR g_apa_o.apa64<>g_apa.apa64 THEN           #MOD-B50218 mark
            IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa64 != g_apa_t.apa64) THEN #MOD-B50218
               CALL t110_upd_apc_date()   
            END IF
           #-----------------------CHI-C10043-----------------------------start
           #僅限於類別為轉帳(2)和電匯(C)時才需要檢核假日問題
            SELECT pma11 INTO l_pma11 FROM pma_file
             WHERE pma01 = g_apa.apa11
            IF l_pma11 = '2' OR l_pma11 = 'c' THEN
             #---------------------------MOD-D30004--------------------------(S)
              #若為假日,找尋下一個工作日
               SELECT nph02 INTO g_buf1 FROM nph_file
                WHERE nph01 = g_apa.apa64
               IF STATUS = 0 THEN
                  SELECT MIN(sme01) INTO l_apa64 FROM sme_file
                   WHERE sme01 > g_apa.apa64 AND sme02 = 'Y'
                  IF STATUS = 100 THEN
                     CALL cl_err3("sel","sme_file","","","amr-533","","",1)
                  ELSE
                     CALL cl_err3("sel","sme_file","","","aap-803","","",1)
                     LET g_apa.apa64 = l_apa64
                  END IF
               END IF
             #---------------------------MOD-D30004--------------------------(E)
               LET l_w = WEEKDAY(g_apa.apa64)
              #若為週日
               IF l_w = 0 THEN
                  SELECT sme02 INTO l_sme02 FROM sme_file
                   WHERE sme01 = g_apa.apa64
                  IF cl_null(l_sme02) THEN LET l_sme02 = 'N' END IF
                  IF l_sme02 = 'N' THEN
                     LET g_apa.apa64 = g_apa.apa64 + 1
                     CALL cl_err(g_apa.apa64,'aap-803',0)
                  ELSE
                     IF cl_confirm('aap-353') THEN
                        LET g_apa.apa64 = g_apa.apa64 + 1
                     END IF
                  END IF
                END IF
              #若為週六
               IF l_w = 6 THEN
                  LET l_sme02='N'
                  SELECT sme02 INTO l_sme02 FROM sme_file
                   WHERE sme01 = g_apa.apa64
                  IF cl_null(l_sme02) THEN LET l_sme02 = 'N' END IF
                  IF l_sme02 = 'N' THEN
                     LET g_apa.apa64 = g_apa.apa64 + 2
                     CALL cl_err(g_apa.apa64,'aap-803',0)
                  ELSE
                     IF cl_confirm('aap-353') THEN
                        LET g_apa.apa64 = g_apa.apa64 + 2
                     END IF
                  END IF
               END IF
             #-------------------------------MOD-D30004---------------------------mark
             ##若為假日,找尋下一個工作日
             # SELECT nph02 INTO g_buf1 FROM nph_file   #FUN-C80078 g_buf-->g_buf1
             #  WHERE nph01 = g_apa.apa64
             # IF STATUS = 0 THEN
             #    SELECT MIN(sme01) INTO l_apa64 FROM sme_file
             #     WHERE sme01 > g_apa.apa64 AND sme02 = 'Y'
             #    IF STATUS = 100 THEN
             #       CALL cl_err3("sel","sme_file","","","amr-533","","",1)
             #    ELSE
             #       CALL cl_err3("sel","sme_file","","","aap-803","","",1)
             #       LET g_apa.apa64 = l_apa64
             #    END IF
             # END IF
             #-------------------------------MOD-D30004---------------------------mark
            END IF
            DISPLAY BY NAME g_apa.apa64
           #-----------------------CHI-C10043-------------------------------end
         END IF
 
      AFTER FIELD apa24
         IF g_aptype[1,1] = '1' AND   #MOD-860203 mark  #CHI-930014 mark回復
             g_apa.apa24 IS NOT NULL THEN
           #IF g_apa_o.apa24 IS NULL OR g_apa_o.apa24<>g_apa.apa24 THEN           #MOD-B50218 mark
            IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa24 != g_apa_t.apa24) THEN #MOD-B50218
               #CHI-AB0017 add --start--
               IF g_apa.apa24 < 0 THEN
                  IF NOT cl_confirm('aap-142') THEN NEXT FIELD apa24 END IF
               END IF
               #CHI-AB0017 add --end--
               CALL s_duedate(g_apa.apa06,g_apa.apa12,g_apa.apa24)
                    RETURNING g_apa.apa64
               DISPLAY BY NAME g_apa.apa64
               CALL t110_upd_apc_date()      #No.FUN-680027
            END IF
         END IF
         LET g_apa_t.apa24 = g_apa.apa24     #MOD-B50218 mod g_apa_o -> g_apa_t
 
      AFTER FIELD apa13
         IF NOT cl_null(g_apa.apa13) THEN
            IF g_apa_t.apa13 IS NULL OR g_apa.apa13 != g_apa_t.apa13 THEN
               CALL t110_apa13('a')
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa13,g_errno,0)
                  NEXT FIELD apa13
               END IF
               LET g_apa.apa72 = g_apa.apa14   #No.TQC-7C0094  
            END IF
            LET g_apa_t.apa13 = g_apa.apa13  #MOD-B50218 mod g_apa_o -> g_apa_t
         END IF
         LET g_apa_t.apa13 = g_apa.apa13   #MOD-5B0255
 
      AFTER FIELD apa14
          IF g_apa.apa13 =g_aza.aza17 THEN
             LET g_apa.apa14=1
             DISPLAY BY NAME g_apa.apa14
          END IF
          DISPLAY BY NAME g_apa.apa14   #No.MOD-530247
         IF NOT cl_null(g_apa.apa14) THEN
            IF g_apa.apa14 < 0 THEN
               CALL cl_err('','aec-020',0)
               NEXT FIELD apa14
            END IF
            IF g_apa.apa14 = 0 THEN
               CALL cl_err('apa14 is null ','aap-099',0)
               NEXT FIELD apa14
            END IF
           #IF g_apa.apa14 <> g_apa_o.apa14 THEN                                  #MOD-B50218 mark
            IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa14 != g_apa_t.apa14) THEN #MOD-B50218
               SELECT COUNT(*) INTO g_cnt FROM apb_file
                WHERE apb01=g_apa.apa01
#----------------No.MOD-B70202-------------------------------------------------start
               IF NOT t110_apa14(g_apa.apa01) THEN
                  NEXT FIELD apa14 
               END IF
              #IF g_cnt > 0 THEN
              #   IF NOT cl_confirm('aap-331') THEN
              #      CALL cl_err('','aap-888',1)
              #      LET g_apa.apa14 = g_apa_t.apa14
              #      DISPLAY BY NAME g_apa.apa14
              #      NEXT FIELD apa14
              #   END IF
              #   DECLARE upd_apb_cs CURSOR FOR
              #      SELECT apb23,apb09,apb02,apb24   #MOD-860221 add apb24 
              #        FROM apb_file
              #       WHERE apb01=g_apa.apa01
 
              #   FOREACH upd_apb_cs INTO l_apb23,l_apb09,l_apb02,l_apb24  #MOD-860221 add l_apb24 
              #      LET l_apb08 = l_apb23 * g_apa.apa14
              #      LET l_apb08 = cl_digcut(l_apb08,g_azi03)   #MOD-6B0066
              #      LET l_apb10 = l_apb24 * g_apa.apa14   #MOD-860221
              #      LET l_apb10 = cl_digcut(l_apb10,g_azi04)   #MOD-6B0066
              #      LET l_apb081= l_apb08
              #      LET l_apb101= l_apb10      
 
              #      UPDATE apb_file SET apb08 = l_apb08,
              #                          apb081 = l_apb081,
              #                          apb10  = l_apb10,
              #                          apb101 = l_apb101
              #       WHERE apb01 = g_apa.apa01
              #         AND apb02 = l_apb02
              #      IF STATUS OR SQLCA.SQLCODE THEN
              #         CALL cl_err3("upd","apb_file",g_apa.apa11,l_apb02,SQLCA.sqlcode,"","upd apb:",1)  #No.FUN-660122
              #         LET g_apa.apa14 = g_apa_t.apa14
              #         DISPLAY BY NAME g_apa.apa14
              #         NEXT FIELD apa14
              #         EXIT FOREACH
              #      END IF
              #   END FOREACH
              #   
              #   CALL t110_b_fill(' 1=1')
              #   CALL t110_sum_apa()
              #ELSE
              #   #雜項帳款有可能沒有單身資料
              #   IF g_apa.apa00='12' OR g_apa.apa00='15' OR g_apa.apa00='16' OR   #MOD-640473   #MOD-870215 add 16
              #      g_apa.apa00='21' OR g_apa.apa00='13' OR g_apa.apa00='17' OR   #MOD-590460   #MOD-640473  #No.FUN-690080
              #      g_apa.apa00='22' THEN   #MOD-9B0168 add
              #      LET g_apa.apa31 = g_apa.apa31f * g_apa.apa14
              #      LET g_apa.apa31 = cl_digcut(g_apa.apa31,g_azi04)   #MOD-6B0066
              #      LET g_apa.apa32 = g_apa.apa31 * g_apa.apa16 / 100
              #      LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)   #MOD-6B0066
              #      DISPLAY BY NAME g_apa.apa31
              #      DISPLAY BY NAME g_apa.apa32
              #      CALL t110_apa34f('0')   #TQC-750140
              #      CALL t110_unpay()
              #   END IF
              #END IF
#----------------No.MOD-B70202-----------------------------------------------------end
               CALL t110_apv_diff()    #MOD-A80217
               CALL t110_api_diff()    #MOD-C20206 add
            END IF
            LET g_apa14_t = g_apa_t.apa14  #MOD-BB0144
            LET g_apa_t.apa14 = g_apa.apa14  #MOD-B50218 mod g_apa_o -> g_apa_t
         END IF
 
      AFTER FIELD apa15
         IF NOT cl_null(g_apa.apa15) THEN
           #IF g_apa_o.apa15 IS NULL OR g_apa.apa15 != g_apa_o.apa15 THEN         #MOD-B50218 mark
           #IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa15 != g_apa_t.apa15) THEN #MOD-B50218 #MOD-C40075 mark
            IF p_cmd = 'a' OR (p_cmd = 'u' AND (g_apa.apa15 != g_apa_t.apa15 OR cl_null(g_apa_t.apa15))) THEN #MOD-C40075 add
               CALL t110_apa15('a')
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa15,g_errno,0)
                  NEXT FIELD apa15
               END IF
            END IF
 
            LET g_apa_t.apa15 = g_apa.apa15  #MOD-B50218 mod g_apa_o -> g_apa_t
            IF g_apa.apa08 <> 'MISC' THEN    #MOD-970111 
               IF g_apa.apa16 != g_apa_t.apa16 AND g_apa.apa16 IS NOT NULL AND   #MOD-B50218 mod g_apa_o -> g_apa_t
                  g_apa.apa31f > 0 AND g_gec05 != 'T' AND g_gec05 != 'A' THEN     #No.MOD-530687 #FUN-630068
                  LET g_apa.apa32f = g_apa.apa31f * g_apa.apa16 / 100
                  LET l_apa32f = 0                                        #MOD-CB0097 add
                  IF g_apa.apa32f != '0' THEN                             #MOD-CB0097 add
                     CALL t110_apa32f() RETURNING l_apa32f                          #No.MOD-B80140 add
                  END IF                                                  #MOD-CB0097 add 
                  LET g_apa.apa32f = l_apa32f                                    #No.MOD-B80140 add
                  LET g_apa.apa32f = cl_digcut(g_apa.apa32f,t_azi04)             #MOD-6B0066
                  LET g_apa.apa31 = g_apa.apa31f * g_apa.apa14
                  LET g_apa.apa31 = cl_digcut(g_apa.apa31,g_azi04)               #MOD-6B0066
                  LET g_apa.apa32 = g_apa.apa31 * g_apa.apa16 / 100
                  LET l_apa32 = 0                                         #MOD-CB0097 add
                  IF g_apa.apa32 != '0' THEN                              #MOD-CB0097 add
                     CALL t110_apa32() RETURNING l_apa32                            #No.MOD-B80140 add
                  END IF                                                  #MOD-CB0097 add 
                  LET g_apa.apa32 = l_apa32                                      #No.MOD-B80140 add
                  LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)               #MOD-6B0066
                  DISPLAY BY NAME g_apa.apa31f,g_apa.apa32f,g_apa.apa31,g_apa.apa32     #No:8625
                  CALL t110_apa34f('0')   #TQC-750140
               END IF
            END IF                    #MOD-970111   
            LET g_apa_t.apa16 = g_apa.apa16   #TQC-5B0016 #MOD-B50218 mod g_apa_o -> g_apa_t`
            #FUN-CB0056---add---str
         ELSE
            LET g_apa.apa16 = 0
            LET g_apa_t.apa16 = g_apa.apa16
         #FUN-CB0056---add---end 
         END IF
 
      BEFORE FIELD apa16
         CALL t110_set_entry(p_cmd)
 
      AFTER FIELD apa16
         IF NOT cl_null(g_apa.apa16) THEN
            IF g_apa.apa16 < 0 THEN                                                                                                 
               CALL cl_err('','aec-020',0)                                                                                          
               NEXT FIELD apa16                                                                                                     
            END IF                                                                                                                  
            IF g_apa.apa08 <> 'MISC'  THEN   #MOD-970111 
               IF g_apa.apa16 != g_apa_t.apa16 AND g_apa.apa16 IS NOT NULL AND    #MOD-B50218 mod g_apa_o -> g_apa_t`
                  g_apa.apa31f >0 AND g_gec05 != 'T' AND g_gec05 != 'A' THEN  #NO.
                  LET g_apa.apa32f = g_apa.apa31f * g_apa.apa16 / 100
                  CALL t110_apa32f() RETURNING l_apa32f                   #No.MOD-B80140 add
                  LET g_apa.apa32f = l_apa32f                             #No.MOD-B80140 add
                  LET g_apa.apa32f = cl_digcut(g_apa.apa32f,t_azi04)   #MOD-6B0066
                  LET g_apa.apa31 = g_apa.apa31f * g_apa.apa14
                  LET g_apa.apa31 = cl_digcut(g_apa.apa31,g_azi04)   #MOD-6B0066
                  LET g_apa.apa32 = g_apa.apa31 * g_apa.apa16 / 100
                  CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
                  LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add
                  LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)   #MOD-6B0066
                  DISPLAY BY NAME g_apa.apa31f,g_apa.apa32f,
                                  g_apa.apa31,g_apa.apa32     #No:8625
                  CALL t110_apa34f('0')    #TQC-750140
               END IF
            END IF                #MOD-970111  
         END IF
          CALL t110_set_no_entry(p_cmd)   #No.MOD-530307
 
      AFTER FIELD apa21
         IF NOT cl_null(g_apa.apa21) THEN
           #IF g_apa_o.apa21 IS NULL OR g_apa.apa21 != g_apa_o.apa21 THEN         #MOD-B50218 mark
            IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa21 != g_apa_t.apa21) THEN #MOD-B50218
               CALL t110_apa21('a')
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa21,g_errno,0)
                  NEXT FIELD apa21
               END IF
            END IF
            LET g_apa_t.apa21 = g_apa.apa21  #MOD-B50218 mod g_apa_o -> g_apa_t
         END IF
 
      AFTER FIELD apa22
         IF NOT cl_null(g_apa.apa22) THEN
           #IF g_apa_o.apa22 IS NULL OR g_apa.apa22 != g_apa_o.apa22 THEN         #MOD-B50218 mark
            IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa22 != g_apa_t.apa22) THEN #MOD-B50218
               CALL t110_apa22('a')
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa22,g_errno,0)
                  NEXT FIELD apa22
               ELSE
                  LET g_apa.apa930=s_costcenter(g_apa.apa22)
                  DISPLAY BY NAME g_apa.apa930
                  DISPLAY s_costcenter_desc(g_apa.apa930) TO FORMONLY.gem02b               
               END IF
            END IF
            LET g_apa_t.apa22 = g_apa.apa22  #MOD-B50218 mod g_apa_o -> g_apa_t
 
            LET l_aag05=''   
            SELECT aag05 INTO l_aag05
              FROM aag_file
             WHERE aag01 = g_apa.apa51
               AND aag00 = g_bookno1   
               AND aagacti = 'Y'               #No.MOD-B70280 add
 
            LET g_errno = ' '  
            IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa51) THEN
              #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
               IF g_aaz.aaz90 !='Y' THEN
                  CALL s_chkdept(g_aaz.aaz72,g_apa.apa51,g_apa.apa22,g_bookno1)                
                                RETURNING g_errno
               END IF
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,0)
                  NEXT FIELD apa22
               END IF
            END IF
            LET l_aag05=''   
            SELECT aag05 INTO l_aag05
              FROM aag_file
             WHERE aag01 = g_apa.apa52
               AND aag00 = g_bookno1  
               AND aagacti = 'Y'               #No.MOD-B70280 add 
 
            LET g_errno = ' '  
            IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa52) THEN
              #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
               IF g_aaz.aaz90 !='Y' THEN
                  CALL s_chkdept(g_aaz.aaz72,g_apa.apa52,g_apa.apa22,g_bookno1)                
                                RETURNING g_errno
               END IF
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,0)
                  NEXT FIELD apa22
               END IF
            END IF
            LET l_aag05=''   
            SELECT aag05 INTO l_aag05
              FROM aag_file
             WHERE aag01 = g_apa.apa54
               AND aag00 = g_bookno1  
               AND aagacti = 'Y'               #No.MOD-B70280 add 
 
            LET g_errno = ' '  
            IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa54) THEN
              #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
               IF g_aaz.aaz90 !='Y' THEN
                  CALL s_chkdept(g_aaz.aaz72,g_apa.apa54,g_apa.apa22,g_bookno1)                
                                RETURNING g_errno
               END IF
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,0)
                  NEXT FIELD apa22
               END IF
            END IF
 
           ###會科二###
            IF g_aza.aza63='Y' THEN 
               LET l_aag05=''   
               SELECT aag05 INTO l_aag05
                 FROM aag_file
                WHERE aag01 = g_apa.apa511
                  AND aag00 = g_bookno2  
                  AND aagacti = 'Y'               #No.MOD-B70280 add 
              
               LET g_errno = ' '  
               IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa511) THEN
                 #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                  IF g_aaz.aaz90 !='Y' THEN
                     CALL s_chkdept(g_aaz.aaz72,g_apa.apa511,g_apa.apa22,g_bookno2)                
                                   RETURNING g_errno
                  END IF
                  IF NOT cl_null(g_errno) THEN
                     CALL cl_err('',g_errno,0)
                     NEXT FIELD apa22
                  END IF
               END IF
               LET l_aag05=''   
               SELECT aag05 INTO l_aag05
                 FROM aag_file
                WHERE aag01 = g_apa.apa521
                  AND aag00 = g_bookno2  
                  AND aagacti = 'Y'               #No.MOD-B70280 add 
              
               LET g_errno = ' '  
               IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa521) THEN
                 #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                  IF g_aaz.aaz90 !='Y' THEN
                     CALL s_chkdept(g_aaz.aaz72,g_apa.apa521,g_apa.apa22,g_bookno2)                
                                   RETURNING g_errno
                  END IF
                  IF NOT cl_null(g_errno) THEN
                     CALL cl_err('',g_errno,0)
                     NEXT FIELD apa22
                  END IF
               END IF
               LET l_aag05=''   
               SELECT aag05 INTO l_aag05
                 FROM aag_file
                WHERE aag01 = g_apa.apa541
                  AND aag00 = g_bookno2   
                  AND aagacti = 'Y'               #No.MOD-B70280 add             
 
               LET g_errno = ' '  
               IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa541) THEN
                 #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                  IF g_aaz.aaz90 !='Y' THEN
                     CALL s_chkdept(g_aaz.aaz72,g_apa.apa541,g_apa.apa22,g_bookno2)                
                                   RETURNING g_errno
                  END IF
                  IF NOT cl_null(g_errno) THEN
                     CALL cl_err('',g_errno,0)
                     NEXT FIELD apa22
                  END IF
               END IF
            END IF  
         END IF
 
      AFTER FIELD apa36
         IF NOT cl_null(g_apa.apa36) THEN
            IF p_cmd = 'a' THEN
               CALL t110_apa36('a')
            ELSE
               CALL t110_apa36('u')
            END IF
            IF NOT cl_null(g_errno) THEN
               CALL cl_err(g_apa.apa36,g_errno,0)
               NEXT FIELD apa36
            END IF
           #------------------MOD-CA0147--------------(S)
            IF NOT cl_null(g_apa.apa51) THEN
               IF g_apa.apa00 = '15' AND g_apa.apa51 = 'STOCK' THEN
                  CALL cl_err(g_apa.apa36,'aap-182',0)
                  NEXT FIELD apa36
               END IF
            END IF
           #------------------MOD-CA0147--------------(E)
            LET g_apa_t.apa36 = g_apa.apa36  #MOD-B50218 mod g_apa_o -> g_apa_t
         ELSE
           CALL cl_err('apa36 is null: ','aap-099',0)
           NEXT FIELD apa36
         END IF
 
      AFTER FIELD apa31f
          LET g_apa.apa31f = cl_digcut(g_apa.apa31f,t_azi04)   #No.MOD-530274   #MOD-6B0066
          DISPLAY BY NAME g_apa.apa31f   #No.MOD-530247
         IF g_apa.apa08 != 'MISC' AND cl_null(g_apa.apa31f) THEN
            CALL cl_err('apa31f is null ','aap-099',0)
            NEXT FIELD apa31f
         END IF
         LET l_pmm40t_tot = 0         #MOD-A30059 add 
        #-MOD-A90181-add-
         SELECT pmc913 INTO l_pmc913 FROM pmc_file 
          WHERE pmc01 = g_apa.apa05
        #-MOD-A90181-end-
        #No.MOD-C40102  --Begin
        IF g_aptype <> '11' THEN
              IF (g_apa.apa00='15' AND (g_apz.apz61='1' OR (g_apz.apz61='3' AND l_pmc913='Y'))) OR g_apa.apa00!='15' THEN
                 IF g_apa.apa31f < 0 THEN
                    CALL cl_err('','alm-342',0)
                    NEXT FIELD apa31f
                 END IF
              END IF 
        END IF
        #No.MOD-C40102  --End 
        #IF g_aptype = '15' THEN #MOD-990155                                                       #MOD-A90181       
         IF g_aptype = '15' AND (g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y')) THEN  #MOD-A90181
            DECLARE apb06_cs CURSOR FOR
               SELECT DISTINCT apb06,apb37 FROM apb_file WHERE apb01=g_apa.apa01   #FUN-A60056 add apb37
            FOREACH apb06_cs INTO l_apb06,l_apb37    #FUN-A60056 add apb37
               IF NOT cl_null(l_apb06) THEN #MOD-9A0109    
                 #已立預付原幣金額
                 #LET l_apa31f = 0   #MOD-A30059 mark
                  LET l_apa31f0= 0   #MOD-9B0048 add
                  DECLARE apa_cs0 CURSOR FOR
                     SELECT DISTINCT apb01 FROM apb_file
                      WHERE apb06 =l_apb06 
                        AND apb01!=g_apa.apa01
                  FOREACH apa_cs0 INTO l_apb01
                     LET l_apa31f0 = 0   #MOD-9C0145 add
                     SELECT apa31f INTO l_apa31f0 FROM apa_file
                      WHERE apa01 =l_apb01
                        AND apa00 ='15'
                     IF cl_null(l_apa31f0) THEN LET l_apa31f0 = 0 END IF
                     LET l_apa31f = l_apa31f + l_apa31f0
                  END FOREACH
                  IF cl_null(l_apa31f) THEN LET l_apa31f = 0 END IF
                  #採購單原幣含稅金額
                  LET l_pmm40t = 0
                 #FUN-A60056--mod--str--
                 #SELECT pmm40t INTO l_pmm40t FROM pmm_file
                 # WHERE pmm01=l_apb06
                  LET g_sql = "SELECT pmm40t FROM ",cl_get_target_table(l_apb37,'pmm_file'),
                              " WHERE pmm01='",l_apb06,"'"
                  CALL cl_replace_sqldb(g_sql) RETURNING g_sql
                  CALL cl_parse_qry_sql(g_sql,l_apb37) RETURNING g_sql
                  PREPARE sel_pmm40t FROM g_sql
                  EXECUTE sel_pmm40t INTO l_pmm40t
                 #FUN-A60056--mod--end
                  IF cl_null(l_pmm40t) THEN LET l_pmm40t = 0 END IF
                  LET l_pmm40t_tot = l_pmm40t_tot + l_pmm40t       #MOD-A30059 add
                 #MOD-A30059---mark---start---
                 #IF g_apa.apa31f > l_pmm40t - l_apa31f THEN
                 #   CALL cl_err(g_apa.apa31f,'aap-937',0) 
                 #   NEXT FIELD apa31f
                 #END IF
                 #MOD-A30059---mark---end---
               END IF #MOD-9A0109     
            END FOREACH
           #MOD-A30059---add---start---
            IF g_apa.apa31f > l_pmm40t_tot - l_apa31f THEN
               CALL cl_err(g_apa.apa31f,'aap-937',0) 
               NEXT FIELD apa31f
            END IF
           #MOD-A30059---add---end---
         END IF
 
        #IF g_apa.apa08 != 'MISC' OR g_apa.apa08 IS NULL THEN   #No.TQC-A30079  
         IF g_apa.apa08 != 'MISC' OR g_apa.apa08 IS NULL OR                     
            g_apa.apa08 = 'MISC' AND g_apz.apz08 = '3'   THEN   #No.TQC-A30079
            IF g_apa.apa31f<>g_apa_t.apa31f OR cl_null(g_apa_t.apa31f) THEN
              #SELECT gec05 INTO g_gec05 FROM gec_file                 #No.CHI-B90030 mark
               SELECT gec05,gec07 INTO g_gec05,g_gec07 FROM gec_file   #No.CHI-B90030 add                          
                WHERE gec01=g_apa.apa15 AND gec011='1'                          
              #IF g_gec05 = 'T' OR g_gec05 = 'A' THEN     #FUN-630068                      #No.CHI-B90030 mark
              #IF g_gec05 = 'T' OR g_gec05 = 'A' OR (g_gec05 = '2' AND g_gec07 = 'Y') THEN #No.CHI-B90030 add #MOD-C60190 mark
              #IF l_gec05 = 'T' OR l_gec05 = 'A' OR                                        #MOD-C60190 add #MOD-C60246 mark
              #   ((l_gec05 = '2'  OR  l_gec05 = '5') AND l_gec07 = 'Y') THEN              #MOD-C60190 add #MOD-C60246 mark
               IF g_gec05 = 'T' OR g_gec05 = 'A' OR                                        #MOD-C60246 add
                  ((g_gec05 = '2'  OR  g_gec05 = '5') AND g_gec07 = 'Y') THEN              #MOD-C60246 add
                  IF cl_null(l_apa31f_o) THEN
                     LET l_apa31f_o = 0
                  END IF
                  IF l_apa31f_o != g_apa.apa31f THEN
                     LET l_apa31f_t = g_apa.apa31f
                    #---------------------MOD-C60246----------------------------(S)
                     IF g_gec05 = 'T' OR g_gec05 = 'A' THEN
                        LET g_apa.apa31f = g_apa.apa31f * (1 - g_apa.apa16/100)
                     ELSE
                        LET g_apa.apa31f = g_apa.apa31f / (1 + g_apa.apa16/100)
                     END IF
                    #---------------------MOD-C60246----------------------------(E)
                    #LET g_apa.apa31f = g_apa.apa31f * (1-g_apa.apa16/100)           #TQC-960012 #MOD-C60246 mark
                     LET g_apa.apa31f = cl_digcut(g_apa.apa31f,t_azi04)   #MOD-6B0066
                    #LET g_apa.apa32f = l_apa31f_t  * g_apa.apa16 / 100              #TQC-960012 #MOD-C60190 mark        
                     LET g_apa.apa32f = l_apa31f_t - g_apa.apa31f         #MOD-C60190          
                     CALL t110_apa32f() RETURNING l_apa32f                   #No.MOD-B80140 add
                     LET g_apa.apa32f = l_apa32f                             #No.MOD-B80140 add  
                     LET g_apa.apa32f = cl_digcut(g_apa.apa32f,t_azi04)   #MOD-6B0066
                     LET g_apa.apa31 = g_apa.apa31f * g_apa.apa14
                     LET g_apa.apa31 = cl_digcut(g_apa.apa31,g_azi04)   #MOD-6B0066
                    #LET g_apa.apa32 = (l_apa31f_t*g_apa.apa14)*g_apa.apa16/100                   #TQC-960012 #MOD-C60190 mark 
                     LET g_apa.apa32 = g_apa.apa32f * g_apa.apa14         #MOD-C60190 
                     CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
                     LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add
                     LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)   #MOD-6B0066
                  END IF
               ELSE
                  LET g_apa.apa32f = g_apa.apa31f * g_apa.apa16 / 100
                  LET g_apa.apa32f = cl_digcut(g_apa.apa32f,t_azi04)   #MOD-6B0066
                  CALL t110_apa32f() RETURNING l_apa32f                   #No.MOD-B80140 add
                  LET g_apa.apa32f = l_apa32f                             #No.MOD-B80140 add
                  LET g_apa.apa31 = g_apa.apa31f * g_apa.apa14
                  LET g_apa.apa31 = cl_digcut(g_apa.apa31,g_azi04)   #MOD-6B0066
                 #LET g_apa.apa32 = g_apa.apa31 * g_apa.apa16/100      #No.MOD-530307   #MOD-6C0178 #MOD-C60190 mark
                  LET g_apa.apa32 = g_apa.apa32f * g_apa.apa14         #MOD-C60190 
                  CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
                  LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add
                  LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)          #No.MOD-530307   #MOD-6B0066
               END IF
               DISPLAY BY NAME g_apa.apa31f,g_apa.apa32f,g_apa.apa31,g_apa.apa32
               LET l_apa31f_o = g_apa.apa31f
               IF g_apa.apa32f = 0 THEN
                  LET g_apa.apa52 = ''
                  DISPLAY BY NAME g_apa.apa52                 
               END IF
               IF g_apa.apa32 = 0 THEN
                  LET g_apa.apa521 = ''
                  DISPLAY BY NAME g_apa.apa521
               END IF
               CALL t110_apa15('')     #TQC-A30129                 
               CALL t110_apa34f('0')   #TQC-750140
            END IF
         END IF
 
      AFTER FIELD apa31
          LET g_apa.apa31 = cl_digcut(g_apa.apa31,g_azi04)   #No.MOD-530274   #MOD-6B0066
          DISPLAY BY NAME g_apa.apa31   #No.MOD-530247
         IF g_apa.apa08 != 'MISC' AND cl_null(g_apa.apa31) THEN
            CALL cl_err('apa31 is null ','aap-099',0)
            NEXT FIELD apa31
         END IF
        #IF g_apa.apa08 != 'MISC' OR g_apa.apa08 IS NULL THEN  #No.TQC-A30079   
         IF g_apa.apa08 != 'MISC' OR g_apa.apa08 IS NULL OR                     
            g_apa.apa08 = 'MISC' AND g_apz.apz08 = '3'   THEN  #No.TQC-A30079
           #IF (g_apa.apa31 <>g_apa_t.apa31  OR cl_null(g_apa_t.apa31)) AND     #MOD-8A0177 mod#MOD-C50076 mark
           #   g_gec05 != 'T' AND g_gec05 != 'A' THEN                           #NO.MOD-530687 #MOD-C50076 mark
            IF (g_apa.apa31 <>g_apa_t.apa31  OR cl_null(g_apa_t.apa31))  THEN   #MOD-C50076 add
               IF g_gec05 NOT MATCHES '[TA]' AND                                #MOD-C50076 add
                  NOT (g_gec05 = '2' AND g_gec07 = 'Y') THEN                    #MOD-C50076 add
                  LET g_apa.apa32 = g_apa.apa31 * g_apa.apa16 / 100
                  CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
                  LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add
                  LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)   #MOD-6B0066
                  DISPLAY BY NAME g_apa.apa32
                  CALL t110_apa34f('0')    #TQC-750140
               END IF                                                            #MOD-C50076 add
            END IF
         END IF
 
      AFTER FIELD apa32f
          LET g_apa.apa32f = cl_digcut(g_apa.apa32f,t_azi04)   #No.MOD-530274   #MOD-6B0066
          DISPLAY BY NAME g_apa.apa32f   #No.MOD-530247
          #No.TQC-BB0251  --Begin
          IF NOT cl_null(g_apa.apa32f) THEN
             IF g_apa.apa32f < 0 THEN
                CALL cl_err(g_apa.apa32f,'axr-029',0)
                LET g_apa.apa32f = g_apa_t.apa32f
                NEXT FIELD apa32f
             END IF
          END IF
          #No.TQC-BB0251  --End
         IF g_apa.apa08 != 'MISC' AND cl_null(g_apa.apa32f) THEN
            CALL cl_err('apa32f is null ','aap-099',0)
            NEXT FIELD apa32f
         END IF
          #No.MOD-C40102  --Begin
          SELECT pmc913 INTO l_pmc913 FROM pmc_file
           WHERE pmc01 = g_apa.apa05
          IF g_aptype <> '11' THEN
              IF (g_apa.apa00='15' AND (g_apz.apz61='1' OR (g_apz.apz61='3' AND l_pmc913='Y'))) OR g_apa.apa00!='15' THEN
                 IF g_apa.apa31 < 0 THEN
                    CALL cl_err('','alm-342',0)
                    NEXT FIELD apa31
                 END IF
              END IF
          END IF
          #No.MOD-C40102  --End
         #no.6053 若為零稅率，稅額不可大於零
         IF g_apa.apa32f > 0 AND g_apa.apa16 = 0 THEN
            CALL cl_err('','aap-902',1)
            NEXT FIELD apa32f
         END IF
 #MOD-560240 稅額值=0時,將稅額會科清除
         IF g_apa.apa32f = 0 THEN
            LET g_apa.apa52 = ''
            DISPLAY BY NAME g_apa.apa52
         END IF
         IF g_apa.apa32 = 0 THEN
            LET g_apa.apa521 = ''
            DISPLAY BY NAME g_apa.apa521
         END IF
         CALL t110_apa15('')     #TQC-A30129 
         CALL t110_apa34f('0')    #TQC-750140
 
         IF g_apa.apa08 != 'MISC' OR g_apa.apa08 IS NULL THEN
            IF g_apa.apa32f<>g_apa_t.apa32f OR cl_null(g_apa_t.apa32f) THEN
              #IF g_gec05 NOT MATCHES '[TA]' THEN                               #TQC-960012 #MOD-C50076 mark
               IF g_gec05 NOT MATCHES '[TA]' AND                                #MOD-C50076 add
                  (g_gec05 != '2' AND g_gec07 != 'Y') THEN                      #MOD-C50076 add
                 LET g_apa.apa32 = g_apa.apa31 * g_apa.apa16/100   #MOD-6C0178
                 CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
                 LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add
                 LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)   #MOD-6B0066
                 DISPLAY BY NAME g_apa.apa32
               END IF   #TQC-960012
               CALL t110_apa34f('0')   #TQC-750140
               CALL t110_unpay()
            END IF
         END IF
#---------------------------------No.MOD-B80140--------------------------start 
       # LET l_apa32f = g_apa.apa31f * g_apa.apa16 / 100
       # LET l_apa32f = cl_digcut(l_apa32f,t_azi04)   #MOD-6B0066
       ##從沖帳資料(aapq230)串回aapt150,看當初立預付是否有稅額,
       ##若有的話,l_apa32f應再扣掉aapt150的稅額
       # LET t_apa32f= 0
       # SELECT SUM(apa32f) INTO t_apa32f
       #   FROM apa_file WHERE apa01 IN (
       # SELECT apa08 FROM apv_file,apa_file
       #  WHERE apv01 = g_apa.apa01 AND apa01 = apv03)
       # IF cl_null(t_apa32f) THEN LET t_apa32f= 0 END IF
       # LET l_apa32f= l_apa32f- t_apa32f
       # LET l_apa32f = cl_digcut(l_apa32f,t_azi04)
         CALL t110_apa32f() RETURNING l_apa32f

         SELECT COUNT(*) INTO l_cnt
           FROM apa_file WHERE apa01 IN (
         SELECT apa08 FROM apv_file,apa_file
          WHERE apv01 = g_apa.apa01 AND apa01 = apv03)

         IF l_cnt > 0 THEN
            LET t_apa31 = 0
            SELECT SUM(apa31f) INTO t_apa31f
              FROM apa_file WHERE apa01 IN (
            SELECT apa08 FROM apv_file,apa_file
             WHERE apv01 = g_apa.apa01 AND apa01 = apv03)
            IF cl_null(t_apa31f)  THEN LET t_apa31f = 0 END IF
           #IF g_apa.apa31f >= t_apa31f THEN                                        #MOD-C50017 mark
#----------------------------------No.MOD-B80140---------------------------------end
            SELECT gec05 INTO g_gec05 FROM gec_file
             WHERE gec01=g_apa.apa15 AND gec011='1'
            IF cl_null(g_gec05) THEN LET g_gec05=' ' END IF   #MOD-8B0170 add
              #IF g_apa.apa32f <> l_apa32f AND g_gec05 <> 'T' AND g_gec05 <> 'A' THEN  #NO.MOD-530687 #FUN-630068 #MOD-C50017 mark
               IF g_apa.apa32f <> l_apa32f AND g_gec05 <> 'T' AND                      #MOD-C50017 add
                  g_gec05 <> 'A' AND l_apa32f > 0 THEN                                 #MOD-C50017 add
                  IF g_apa.apa32f < l_apa32f - 2 OR                                    #MOD-5C0080
                     g_apa.apa32f > l_apa32f + 2 THEN                                  #MOD-5C0080
                     CALL cl_err('','aap-210',0)
                     NEXT FIELD apa32f   #No.MOD-530274
                  END IF   #MOD-5C0080
               END IF
        #---------------------------No.MOD-B80140-----------------------start
           #----------------------MOD-C50017----------------------mark
           #ELSE
           #   IF g_apa.apa32f != 0  AND g_gec05 <> 'T' AND g_gec05 <> 'A' THEN
           #         CALL cl_err('','aap-210',0)
           #         NEXT FIELD apa32f
           #   END IF
           #END IF
           #----------------------MOD-C50017----------------------mark
        #---------------------------No.MOD-B80140-------------------------end
            LET g_apa_t.apa32f = g_apa.apa32f   #MOD-5C0080
         END IF                                                            #No.MOD-B80140 add
 
      AFTER FIELD apa32
          LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)   #No.MOD-530274   #MOD-6B0066
          DISPLAY BY NAME g_apa.apa32   #No.MOD-530247
          #No.TQC-BB0251  --Begin
          IF NOT cl_null(g_apa.apa32) THEN
             IF g_apa.apa32 < 0 THEN
                CALL cl_err(g_apa.apa32,'axr-029',0)
                LET g_apa.apa32 = g_apa_t.apa32
                NEXT FIELD apa32
             END IF
          END IF
          #No.TQC-BB0251  --End
#--------------------------------No.MOD-B80140----------------------------start
        # LET l_apa32 = g_apa.apa31 * g_apa.apa16 / 100
        # LET l_apa32 = cl_digcut(l_apa32,g_azi04)   #MOD-6B0066
        ##從沖帳資料(aapq230)串回aapt150,看當初立預付是否有稅額,
        ##若有的話,l_apa32應再扣掉aapt150的稅額
        # LET t_apa32 = 0
        # SELECT SUM(apa32) INTO t_apa32
        #   FROM apa_file WHERE apa01 IN (
        # SELECT apa08 FROM apv_file,apa_file
        #  WHERE apv01 = g_apa.apa01 AND apa01 = apv03)
        # IF cl_null(t_apa32)  THEN LET t_apa32 = 0 END IF
        # LET l_apa32 = l_apa32 - t_apa32
        # LET l_apa32 = cl_digcut(l_apa32,g_azi04)
          CALL t110_apa32() RETURNING l_apa32
          SELECT COUNT(*) INTO l_cnt
            FROM apa_file WHERE apa01 IN (
          SELECT apa08 FROM apv_file,apa_file
           WHERE apv01 = g_apa.apa01 AND apa01 = apv03)
          IF l_cnt > 0 THEN                             
             LET t_apa31 = 0
             SELECT SUM(apa31) INTO t_apa31
               FROM apa_file WHERE apa01 IN (
             SELECT apa08 FROM apv_file,apa_file
              WHERE apv01 = g_apa.apa01 AND apa01 = apv03)
             IF cl_null(t_apa31)  THEN LET t_apa31 = 0 END IF
            #IF g_apa.apa31 >= t_apa31  THEN             #MOD-C50017 mark
#---------------------------------No.MOD-B80140-------------------------------end
                SELECT gec05 INTO g_gec05 FROM gec_file
                 WHERE gec01=g_apa.apa15 AND gec011='1'
                IF cl_null(g_gec05) THEN LET g_gec05=' ' END IF   #MOD-8B0170 add
               #IF g_apa.apa32 <> l_apa32 AND g_gec05 <> 'T' AND g_gec05 <> 'A' THEN #NO.MOD-530687 #FUN-630068 #MOD-C50017 mark
                IF g_apa.apa32 <> l_apa32 AND g_gec05 <> 'T' AND                     #MOD-C50017 add
                   g_gec05 <> 'A' AND l_apa32 > 0 THEN                               #MOD-C50017 add
                   IF g_apa.apa32 < l_apa32 - 2 OR   #MOD-5C0080
                      g_apa.apa32 > l_apa32 + 2 THEN   #MOD-5C0080
                      CALL cl_err('','aap-210',0)
                      NEXT FIELD apa32
                   END IF        #MOD-5C0080
                END IF
         #---------------------------No.MOD-B80140-------------------------start
           #----------------------MOD-C50017----------------------mark
            #ELSE
            #   IF g_apa.apa32 != 0 AND g_gec05 <> 'T' AND g_gec05 <> 'A' THEN
            #      CALL cl_err('','aap-210',0)
            #      NEXT FIELD apa32
            #   END IF
            #END IF
           #----------------------MOD-C50017----------------------mark
          END IF
         #---------------------------No.MOD-B80140-------------------------end
          CALL t110_apa34f('0')    #TQC-750140
          CALL t110_unpay()
 
      AFTER FIELD apa51
         IF (g_apa.apa00!='11' AND g_apa.apa00!='21' AND g_apa.apa00!='12') AND g_apa.apa51='UNAP' THEN   #MOD-7A0040
            CALL cl_err_msg('','aap-934','aapt110,aapt210',1)   #非aapt110,aapt210此欄位不可輸入UNAP   #MOD-7A0040
            NEXT FIELD apa51
         END IF
        #----------------------MOD-C70069----------------------(S)
         IF g_apa.apa00 = '15' OR g_apa.apa00 = '17' THEN
            IF cl_null(g_apa.apa51)  THEN
            CALL cl_err('','mfg9043',0)
            NEXT FIELD apa51
            END IF
         END IF
        #----------------------MOD-C70069----------------------(E)
        #----------------------MOD-BC0102----------------------add
         IF g_apa.apa00='15' AND g_apa.apa51 = 'MISC' THEN
            CALL cl_err('','aap-158',0)
            LET g_apa.apa51=g_apa_t.apa51
            DISPLAY BY NAME g_apa.apa51
            NEXT FIELD apa51
         END IF
        #----------------------MOD-BC0102----------------------end

        #------------------MOD-CA0147--------------(S)
         IF g_apa.apa00 = '15'AND g_apa.apa51 = 'STOCK' THEN
            CALL cl_err('','aap-182',0)
            LET g_apa.apa51 = g_apa_t.apa51
            DISPLAY BY NAME g_apa.apa51
            NEXT FIELD apa51
         END IF
        #------------------MOD-CA0147--------------(E)

        #報銷/還款時借方科目不可為'STOCK'
         IF (g_aptype = '13' OR g_aptype = '17') AND g_apa.apa51 = 'STOCK' THEN
            LET g_apa.apa51=g_apa_t.apa51
            DISPLAY BY NAME g_apa.apa51
            NEXT FIELD apa51
         END IF
 
        #FUN-C70075--mark--str
        #IF g_apa.apa51 ='UNAP' AND g_apa.apa55='2' THEN
        #   CALL cl_err(g_apa.apa51,'aap-029',0)
        #   LET g_apa.apa51=g_apa_t.apa51
        #   DISPLAY BY NAME g_apa.apa51
        #   NEXT FIELD apa51
        #END IF
        #FUN-C70075--mark--end
 
         IF g_apa.apa51 != 'MISC' AND g_apa.apa51 != 'STOCK'
            AND g_apa.apa51 != 'UNAP' AND NOT cl_null(g_apa.apa51) THEN
            IF g_apa.apa31 >=0 AND g_apz.apz02 = 'Y' THEN     #No.TQC-7A0095 modify by chenl add '='
               LET g_pass = 'Y'     #No.FUN-B10050
               CALL s_aapact(g_apz.apz11,g_bookno1,g_apa.apa51) RETURNING g_msg     #No.FUN-730064
               #不可取料件科目
               IF (g_aptype = '13' OR g_aptype = '17') AND cl_null(g_errno) THEN
                  SELECT aag09 INTO l_aag09
                    FROM aag_file
                   WHERE aag01 = g_apa.apa51
                     AND aag00 = g_bookno1           #No.FUN-730064
                     AND aagacti = 'Y'               #No.MOD-B70280 add
                  IF l_aag09 = 'N' THEN
                     CALL cl_err(g_apa.apa51,'agl-214',0)
                     #No.FUN-B10050  --Begin
                     LET g_pass = 'N'
                     #NEXT FIELD apa51
                     #No.FUN-B10050  --End  
                  END IF
               END IF
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('s_aapact',g_errno,0)
                  #No.FUN-B10050  --Begin
                  LET g_pass = 'N'
                  #NEXT FIELD apa51
                  #No.FUN-B10050  --End  
               END IF
               #No.FUN-B10050  --Begin
               IF g_pass = 'N' THEN
                  CALL cl_init_qry_var()
                  LET g_qryparam.form ="q_aag02"
                  LET g_qryparam.construct = 'N'
                  LET g_qryparam.default1 = g_apa.apa51
                  LET g_qryparam.arg1 = g_bookno1
                  LET g_qryparam.where = " aag03 ='2' AND aag01 LIKE '",g_apa.apa51 CLIPPED,"%'"
                  CALL cl_create_qry() RETURNING g_apa.apa51
                  DISPLAY BY NAME g_apa.apa51
                  NEXT FIELD apa51
               END IF
               #No.FUN-B10050  --End  
            END IF
         END IF
 
         IF p_cmd='u' AND g_apa.apa51='MISC' AND
            (g_apa_t.apa51<>'MISC' OR g_apa_t.apa51 IS NULL) THEN
            CALL t110_ccc('1')
         END IF
 
         SELECT aag05,aag02,aag21 INTO l_aag05,g_a51,l_aag21   #FUN-710078 add aag02,g_a51   #MOD-850100 add aag21
           FROM aag_file
          WHERE aag01 = g_apa.apa51
            AND aag00 = g_bookno1     #No.FUN-730064
            AND aagacti = 'Y'               #No.MOD-B70280 add
#MOD-B80165 -- begin --
         IF cl_null(g_apa.apa51) THEN
            LET g_a51 = NULL
         END IF
#MOD-B80165 -- end --
         DISPLAY g_a51 TO FORMONLY.a51          #FUN-710078 add
         IF STATUS OR SQLCA.SQLCODE THEN
            LET l_aag05=''
         END IF
         LET g_errno = ' '   #MOD-5B0255
         IF l_aag05 = 'Y' THEN
           #CALL s_chkdept(g_aaz.aaz72,g_apa.apa51,g_apa.apa22,g_bookno1) RETURNING g_errno      #No.FUN-730064
           #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
            IF g_aaz.aaz90 ='Y' THEN
               IF NOT cl_null(g_apa.apa930) THEN   #FUN-8C0106 add 
                  CALL s_chkdept(g_aaz.aaz72,g_apa.apa51,g_apa.apa930,g_bookno1) RETURNING g_errno      #No.FUN-730064
               END IF                              #FUN-8C0106 add 
            ELSE
               IF NOT cl_null(g_apa.apa22) THEN    #FUN-8C0106 add 
                  CALL s_chkdept(g_aaz.aaz72,g_apa.apa51,g_apa.apa22,g_bookno1) RETURNING g_errno      #No.FUN-730064
               END IF                              #FUN-8C0106 add 
            END IF
         END IF
        #科目有做預算控管,須提示卡關請輸入在單身的訊息
         IF l_aag21 = 'Y' THEN
            CALL cl_err('','aap-116',1)
         END IF
         IF NOT cl_null(g_errno) THEN
            CALL cl_err('',g_errno,0)
            #No.FUN-B10050  --Begin
            CALL cl_init_qry_var()
            LET g_qryparam.form ="q_aag02"
            LET g_qryparam.construct = 'N'
            LET g_qryparam.default1 = g_apa.apa51
            LET g_qryparam.arg1 = g_bookno1
            LET g_qryparam.where = " aag03 ='2' AND aag01 LIKE '",g_apa.apa51 CLIPPED,"%'"
            CALL cl_create_qry() RETURNING g_apa.apa51
            DISPLAY BY NAME g_apa.apa51
            #No.FUN-B10050  --End  
            NEXT FIELD apa51
         END IF
 
      ON CHANGE apa51
         LET l_cnt = 0
         SELECT COUNT(*) INTO l_cnt FROM api_file
           WHERE api01 = g_apa.apa01 AND
                 api02 = '1'
         IF (g_apa.apa51 <> 'MISC' OR g_apa.apa51 IS NULL) AND l_cnt > 0 THEN
            CALL cl_err('','aap-903',0)
            LET g_apa.apa51 = 'MISC'
            NEXT FIELD apa51
         END IF
 
      AFTER FIELD apa52
         IF g_apa.apa16 > 0 THEN
            IF cl_null(g_apa.apa52) THEN
               CALL cl_err(g_apa.apa52,'aap-099',0)
               NEXT FIELD apa52
            END IF
         END IF
 
         IF g_apa.apa32 > 0 AND g_apz.apz02 = 'Y' THEN
            #No.FUN-B10050  --Begin
            #CALL s_aapact(g_apz.apz11,g_bookno1,g_apa.apa52) RETURNING g_msg    #No.FUN-730064
            #IF NOT cl_null(g_errno) THEN
            #   CALL cl_err(g_apa.apa52,g_errno,0)
            #   NEXT FIELD apa52
            #END IF
            IF cl_null(g_apa.apa52) THEN
               CALL cl_err(g_apa.apa52,'aap-099',0)
               NEXT FIELD apa52
            END IF
            #No.FUN-B10050  --End  
         END IF
 
         IF NOT cl_null(g_apa.apa52)  THEN
            LET g_pass = 'Y'      #No.FUN-B10050
            CALL s_aapact(g_apz.apz11,g_bookno1,g_apa.apa52) RETURNING g_msg     #No.FUN-730064
            IF NOT cl_null(g_errno) THEN
               #No.FUN-B10050  --Begin
               LET g_pass = 'N'
               #CALL cl_err(g_apa.apa52,g_errno,0)
               #NEXT FIELD apa52
               #No.FUN-B10050  --End  
            END IF
#MOD-580051   科目有做科目部門管理的才CALL s_chkdept
 
            IF g_pass = 'Y' THEN   #No.FUN-B10050
               SELECT aag05,aag02 INTO l_aag05,g_a52 FROM aag_file   #FUN-710078 add aag02,g_a52
                  WHERE aag01 = g_apa.apa52
                    AND aag00 = g_bookno1         #No.FUN-730064
                    AND aagacti = 'Y'             #No.MOD-B70280 add
               DISPLAY g_a52 TO FORMONLY.a52      #FUN-710078 add
 
               IF STATUS OR SQLCA.SQLCODE THEN
                  LET l_aag05=''
               END IF
               LET g_errno = ' '   #MOD-5B0255
               IF l_aag05 = 'Y' THEN
                 #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                  IF g_aaz.aaz90 ='Y' THEN
                     IF NOT cl_null(g_apa.apa930) THEN   #FUN-8C0106 add 
                        CALL s_chkdept(g_aaz.aaz72,g_apa.apa52,g_apa.apa930,g_bookno1) RETURNING g_errno      #No.FUN-730064
                     END IF                              #FUN-8C0106 add 
                  ELSE
                     IF NOT cl_null(g_apa.apa22) THEN    #FUN-8C0106 add 
                        CALL s_chkdept(g_aaz.aaz72,g_apa.apa52,g_apa.apa22,g_bookno1) RETURNING g_errno      #No.FUN-730064
                     END IF                              #FUN-8C0106 add 
                  END IF
               END IF
            END IF                 #No.FUN-B10050
            IF NOT cl_null(g_errno) THEN
               #No.FUN-B10050  --Begin
               CALL cl_err(g_apa.apa52,g_errno,0)
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"
               LET g_qryparam.construct = 'N'
               LET g_qryparam.default1 = g_apa.apa52
               LET g_qryparam.arg1 = g_bookno1
               LET g_qryparam.where = " aag03 ='2' AND aag01 LIKE '",g_apa.apa52 CLIPPED,"%'"
               CALL cl_create_qry() RETURNING g_apa.apa52
               DISPLAY BY NAME g_apa.apa52
               NEXT FIELD apa52
               #No.FUN-B10050  --End  
            END IF
         END IF
 
 
      AFTER FIELD apa54
         IF NOT cl_null(g_apa.apa54) AND g_apz.apz02 = 'Y' THEN
            LET g_pass = 'Y'     #No.FUN-B10050
            CALL s_aapact(g_apz.apz11,g_bookno1,g_apa.apa54) RETURNING g_msg    #No.FUN-730064
            IF NOT cl_null(g_errno) THEN
               #No.FUN-B10050  --Begin
               #CALL cl_err(g_apa.apa54,g_errno,0)
               #NEXT FIELD apa54
               LET g_pass = 'N'
               #No.FUN-B10050  --End  
            END IF
            IF g_pass = 'Y' THEN    #No.FUN-B10050
               #MOD-580051   科目有做科目部門管理的才CALL s_chkdept
               SELECT aag05 INTO l_aag05 FROM aag_file
                  WHERE aag01 = g_apa.apa54
                    AND aag00 = g_bookno1           #No.FUN-730064
                    AND aagacti = 'Y'               #No.MOD-B70280 add
               IF STATUS OR SQLCA.SQLCODE THEN
                  LET l_aag05=''
               END IF
               LET g_errno = ' '   #MOD-5B0255
               IF l_aag05 = 'Y' THEN
                 #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                  IF g_aaz.aaz90 ='Y' THEN
                     IF NOT cl_null(g_apa.apa930) THEN         #FUN-8C0106 add
                        CALL s_chkdept(g_aaz.aaz72,g_apa.apa54,g_apa.apa930,g_bookno1) RETURNING g_errno      #No.FUN-730064
                     END IF                                    #FUN-8C0106 add
                  ELSE
                     IF NOT cl_null(g_apa.apa22) THEN          #FUN-8C0106 add
                        CALL s_chkdept(g_aaz.aaz72,g_apa.apa54,g_apa.apa22,g_bookno1) RETURNING g_errno      #No.FUN-730064
                     END IF                                    #FUN-8C0106 add
                  END IF
               END IF
            END IF                  #No.FUN-B10050
            IF NOT cl_null(g_errno) THEN
               #No.FUN-B10050  --Begin
               CALL cl_err('',g_errno,0)
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"
               LET g_qryparam.construct = 'N'
               LET g_qryparam.default1 = g_apa.apa54
               LET g_qryparam.arg1 = g_bookno1
               LET g_qryparam.where = " aag03 ='2' AND aag01 LIKE '",g_apa.apa54 CLIPPED,"%'"
               CALL cl_create_qry() RETURNING g_apa.apa54
               DISPLAY BY NAME g_apa.apa54
               NEXT FIELD apa54
               #No.FUN-B10050  --End  
            END IF
            SELECT aag02 INTO g_a54 FROM aag_file  
             WHERE aag01=g_apa.apa54              
               AND aag00=g_bookno1       
               AND aagacti = 'Y'               #No.MOD-B70280 add        
            DISPLAY g_a54 TO FORMONLY.a54       
#MOD-B80165 -- begin --
         ELSE
            IF cl_null(g_apa.apa54) THEN
               LET g_a54 = NULL
            END IF
            DISPLAY g_a54 TO FORMONLY.a54
#MOD-B80165 -- end --
         END IF
 
      AFTER FIELD apa511
        #FUN-C70075--mark-str
        #IF g_apa.apa511 ='UNAP' AND g_apa.apa55='2' THEN
        #   CALL cl_err(g_apa.apa511,'aap-029',0)
        #   LET g_apa.apa511=g_apa_t.apa511
        #   DISPLAY BY NAME g_apa.apa511
        #   NEXT FIELD apa511
        #END IF
        #FUN-C70075--mark-end
         IF g_apa.apa511 != 'MISC' AND g_apa.apa511 != 'STOCK'
            AND g_apa.apa511 != 'UNAP' AND NOT cl_null(g_apa.apa511) THEN
            IF g_apa.apa31 >=0 AND g_apz.apz02 = 'Y' THEN    #No.TQC-7A0095 modify by chenl add '='
               CALL s_aapact(g_apz.apz11,g_bookno2,g_apa.apa511) RETURNING g_msg    #No.FUN-730064
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('s_aapact',g_errno,0)
                  #No.FUN-B10050  --Begin
                  CALL cl_init_qry_var()
                  LET g_qryparam.form ="q_aag02"
                  LET g_qryparam.construct = 'N'
                  LET g_qryparam.default1 = g_apa.apa511
                  LET g_qryparam.arg1 = g_bookno2
                  LET g_qryparam.where = " aag03 ='2' AND aag01 LIKE '",g_apa.apa511 CLIPPED,"%'"
                  CALL cl_create_qry() RETURNING g_apa.apa511
                  DISPLAY BY NAME g_apa.apa511
                  NEXT FIELD apa511
                  #No.FUN-B10050  --End  
               END IF
            END IF
         END IF
 
         IF p_cmd='u' AND g_apa.apa511='MISC' AND
            (g_apa_t.apa511<>'MISC' OR g_apa_t.apa511 IS NULL) THEN
            CALL t110_ccc('1')
         END IF
 
#MOD-580051   科目有做科目部門管理的才CALL s_chkdept
 
         SELECT aag05,aag02,aag21 INTO l_aag05,g_a511,l_aag21 #TQC-960021 Add 
           FROM aag_file
          WHERE aag01 = g_apa.apa511
            AND aag00 = g_bookno2        #No.FUN-730064
            AND aagacti = 'Y'               #No.MOD-B70280 add
#MOD-B80165 -- begin --
         IF cl_null(g_apa.apa511) THEN
            LET g_a511 = NULL
         END IF
#MOD-B80165 -- end --
         DISPLAY g_a511 TO FORMONLY.a511   #FUN-710078 add        
         IF STATUS OR SQLCA.SQLCODE THEN
            LET l_aag05=''
         END IF
         LET g_errno = ' '   #MOD-5B0255
         IF l_aag05 = 'Y' THEN
           #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
            IF g_aaz.aaz90 ='Y' THEN
               IF NOT cl_null(g_apa.apa930) THEN    #FUN-8C0106 add
                  CALL s_chkdept(g_aaz.aaz72,g_apa.apa511,g_apa.apa930,g_bookno2) RETURNING g_errno      #No.FUN-730064
               END IF                               #FUN-8C0106 add                   
            ELSE
               IF NOT cl_null(g_apa.apa22) THEN     #FUN-8C0106 add
                  CALL s_chkdept(g_aaz.aaz72,g_apa.apa511,g_apa.apa22,g_bookno2) RETURNING g_errno      #No.FUN-730064
               END IF                               #FUN-8C0106 add                   
            END IF
         END IF
        #科目有做預算控管,須提示卡關請輸入在單身的訊息
         IF l_aag21 = 'Y' THEN
            CALL cl_err('','aap-116',1)
         END IF
         IF NOT cl_null(g_errno) THEN
            CALL cl_err('',g_errno,0)
            #No.FUN-B10050  --Begin
            CALL cl_init_qry_var()
            LET g_qryparam.form ="q_aag02"
            LET g_qryparam.construct = 'N'
            LET g_qryparam.default1 = g_apa.apa511
            LET g_qryparam.arg1 = g_bookno2
            LET g_qryparam.where = " aag03 ='2' AND aag01 LIKE '",g_apa.apa511 CLIPPED,"%'"
            CALL cl_create_qry() RETURNING g_apa.apa511
            DISPLAY BY NAME g_apa.apa511
            NEXT FIELD apa511
            #No.FUN-B10050  --End  
         END IF
 
      ON CHANGE apa511
         LET l_cnt = 0
         SELECT COUNT(*) INTO l_cnt FROM api_file
           WHERE api01 = g_apa.apa01 AND
                 api02 = '1'
         IF (g_apa.apa511 <> 'MISC' OR g_apa.apa511 IS NULL) AND l_cnt > 0 THEN
            CALL cl_err('','aap-903',0)
            LET g_apa.apa511 = 'MISC'
            NEXT FIELD apa511
         END IF
 
      AFTER FIELD apa521
         IF g_apa.apa16 > 0 THEN
            IF cl_null(g_apa.apa521) THEN
               CALL cl_err(g_apa.apa521,'aap-099',0)
               NEXT FIELD apa521
            END IF
         END IF
 
         IF g_apa.apa32 > 0 AND g_apz.apz02 = 'Y' THEN
            #No.FUN-B10050  --Begin
            #CALL s_aapact(g_apz.apz11,g_bookno2,g_apa.apa521) RETURNING g_msg    #No.FUN-730064
            #IF NOT cl_null(g_errno) THEN
            #   CALL cl_err(g_apa.apa521,g_errno,0)
            #   NEXT FIELD apa521
            #END IF
            IF cl_null(g_apa.apa521) THEN
               CALL cl_err(g_apa.apa521,'aap-099',0)
               NEXT FIELD apa521
            END IF
            #No.FUN-B10050  --End  
         END IF
 
         IF NOT cl_null(g_apa.apa521)  THEN
            LET g_pass = 'Y'     #No.FUN-B10050
            CALL s_aapact(g_apz.apz11,g_bookno2,g_apa.apa521) RETURNING g_msg    #No.FUN-730064
            IF NOT cl_null(g_errno) THEN
               #No.FUN-B10050  --Begin
               LET g_pass = 'N'
               #CALL cl_err(g_apa.apa521,g_errno,0)
               #NEXT FIELD apa521
               #No.FUN-B10050  --End   
            END IF
            IF g_pass = 'Y' THEN #No.FUN-B10050
               #MOD-580051   科目有做科目部門管理的才CALL s_chkdept
               SELECT aag05,aag02 INTO l_aag05,g_a521 FROM aag_file  #FUN-710078 add aag02,g_521
                  WHERE aag01 = g_apa.apa521
                    AND aag00 = g_bookno2              #No.FUN-730064
                    AND aagacti = 'Y'                  #No.MOD-B70280 add
               DISPLAY g_a521 TO FORMONLY.a521         #FUN-710078 add
               IF STATUS OR SQLCA.SQLCODE THEN
                  LET l_aag05=''
               END IF
               LET g_errno = ' '   #MOD-5B0255
               IF l_aag05 = 'Y' THEN
                 #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                  IF g_aaz.aaz90 ='Y' THEN
                     IF NOT cl_null(g_apa.apa930) THEN     #FUN-8C0106 add
                        CALL s_chkdept(g_aaz.aaz72,g_apa.apa521,g_apa.apa930,g_bookno2) RETURNING g_errno      #No.FUN-730064
                     END IF                                #FUN-8C0106 add
                  ELSE
                     IF NOT cl_null(g_apa.apa22) THEN      #FUN-8C0106 add
                        CALL s_chkdept(g_aaz.aaz72,g_apa.apa521,g_apa.apa22,g_bookno2) RETURNING g_errno      #No.FUN-730064
                     END IF                                #FUN-8C0106 add
                  END IF
               END IF
            END IF                #No.FUN-B10050
            IF NOT cl_null(g_errno) THEN
               #No.FUN-B10050  --Begin
               CALL cl_err(g_apa.apa521,g_errno,0)
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"
               LET g_qryparam.construct = 'N'
               LET g_qryparam.default1 = g_apa.apa521
               LET g_qryparam.arg1 = g_bookno2
               LET g_qryparam.where = " aag03 ='2' AND aag01 LIKE '",g_apa.apa521 CLIPPED,"%'"
               CALL cl_create_qry() RETURNING g_apa.apa521
               DISPLAY BY NAME g_apa.apa521
               NEXT FIELD apa521
               #No.FUN-B10050  --End  
            END IF
         END IF
 
      AFTER FIELD apa541
         IF NOT cl_null(g_apa.apa541) AND g_apz.apz02 = 'Y' THEN
            LET g_pass = 'Y'      #No.FUN-B10050
            CALL s_aapact(g_apz.apz11,g_bookno2,g_apa.apa541) RETURNING g_msg    #No.FUN-730064
            IF NOT cl_null(g_errno) THEN
               #No.FUN-B10050  --Begin
               LET g_pass = 'N'
               #CALL cl_err(g_apa.apa541,g_errno,0)
               #NEXT FIELD apa541
               #No.FUN-B10050  --End  
            END IF
            IF g_pass = 'Y' THEN  #No.FUN-B10050
               #MOD-580051   科目有做科目部門管理的才CALL s_chkdept
               SELECT aag05,aag02 INTO l_aag05,g_a541 FROM aag_file  #FUN-710078 add aag02,g_a541
                  WHERE aag01 = g_apa.apa541
                    AND aag00 = g_bookno2              #No.FUN-730064
                    AND aagacti = 'Y'                  #No.MOD-B70280 add
               DISPLAY g_a541 TO FORMONLY.a541         #FUN-710078 add
               IF STATUS OR SQLCA.SQLCODE THEN
                  LET l_aag05=''
               END IF
               LET g_errno = ' '   #MOD-5B0255
               IF l_aag05 = 'Y' THEN
                 #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                  IF g_aaz.aaz90 ='Y' THEN
                     IF NOT cl_null(g_apa.apa930) THEN     #FUN-8C0106 add
                        CALL s_chkdept(g_aaz.aaz72,g_apa.apa541,g_apa.apa930,g_bookno2) RETURNING g_errno      #No.FUN-730064
                     END IF                               #FUN-8C0106 add
                  ELSE
                     IF NOT cl_null(g_apa.apa22) THEN     #FUN-8C0106 add
                        CALL s_chkdept(g_aaz.aaz72,g_apa.apa541,g_apa.apa22,g_bookno2) RETURNING g_errno      #No.FUN-730064
                     END IF                               #FUN-8C0106 add
                  END IF
               END IF
            END IF                #No.FUN-B10050
            IF NOT cl_null(g_errno) THEN
               #No.FUN-B10050  --Begin
               CALL cl_err(g_apa.apa541,g_errno,0)
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"
               LET g_qryparam.construct = 'N'
               LET g_qryparam.default1 = g_apa.apa541
               LET g_qryparam.arg1 = g_bookno2
               LET g_qryparam.where = " aag03 ='2' AND aag01 LIKE '",g_apa.apa541 CLIPPED,"%'"
               CALL cl_create_qry() RETURNING g_apa.apa541
               DISPLAY BY NAME g_apa.apa541
               NEXT FIELD apa541
               #No.FUN-B10050  --End  
            END IF
#MOD-B80165 -- begin --
         ELSE
            IF cl_null(g_apa.apa541) THEN
               LET g_a541 = NULL
            END IF
            DISPLAY g_a541 TO FORMONLY.a541
#MOD-B80165 -- end --
         END IF
 
      AFTER FIELD apa101       #還款銀行
         IF NOT cl_null(g_apa.apa101) THEN
           #IF g_apa_o.apa101 IS NULL OR g_apa.apa101 != g_apa_o.apa101 THEN        #MOD-B50218 mark
            IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa101 != g_apa_t.apa101) THEN #MOD-B50218
               CALL t110_apa101('a')
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa101,g_errno,0)
                  NEXT FIELD apa101
               END IF
            END IF
            LET g_apa_t.apa101 = g_apa.apa101 #MOD-B50218 mod g_apa_o -> g_apa_t
            #FUN-D80071--add--str--
            IF g_aptype='13' THEN
               LET l_apa101_desc=''
               SELECT nma02 INTO l_apa101_desc FROM nma_file WHERE nma01=g_apa.apa101
               DISPLAY l_apa101_desc TO apa101_desc
            END IF
            #FUN-D80071--add--end
         END IF
 
      AFTER FIELD apa102       #還款異動碼
         IF NOT cl_null(g_apa.apa102) THEN
           #IF g_apa_o.apa102 IS NULL OR g_apa.apa102 != g_apa_o.apa102 THEN        #MOD-B50218 mark
            IF p_cmd = 'a' OR (p_cmd = 'u' AND g_apa.apa102 != g_apa_t.apa102) THEN #MOD-B50218
               CALL t110_apa102('a')
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa102,g_errno,0)
                  NEXT FIELD apa102
               END IF
            END IF
            LET g_apa_t.apa102 = g_apa.apa102 #MOD-B50218 mod g_apa_o -> g_apa_t
            #FUN-D80071--add--str--
            IF g_aptype='13' THEN
               LET l_apa102_desc=''
               SELECT nmc02 INTO l_apa102_desc FROM nmc_file WHERE nmc01=g_apa.apa102
               DISPLAY l_apa102_desc TO apa102_desc
            END IF
            #FUN-D80071--add--end
         END IF
 
      AFTER FIELD apa58
         IF (g_aptype='21' AND g_apa.apa58 NOT MATCHES "[23]") OR
            (g_aptype='22' AND g_apa.apa58 NOT MATCHES "[3]") THEN
            CALL cl_err('','aap-315',0)
            NEXT FIELD apa58
         END IF
 
      AFTER FIELD apa66
         IF NOT cl_null(g_apa.apa66) AND g_aza.aza08='Y' THEN
            CALL t110_apa66()
            IF NOT cl_null(g_errno)  THEN
               CALL cl_err(g_apa.apa66,'apj-005',1)
               NEXT FIELD apa66
            END IF
         END IF
 
      BEFORE FIELD apa31f
         IF g_gec05 = 'T' OR g_gec05 = 'A' THEN     #FUN-630068
            CALL cl_err('','aoo-009',0)
         END IF
 
       AFTER FIELD apa100
          IF NOT cl_null(g_apa.apa100) THEN    #MOD-9B0043
             SELECT azp02 INTO g_buf1 FROM azp_file,azw_file  #FUN-C80078 g_buf-->g_buf1
              WHERE azw01 = azp01 AND azw02 = g_legal
             AND azp01 = g_apa.apa100
             IF STATUS THEN
                CALL cl_err3("sel","azw_file",g_apa.apa100,"","agl-171","","select azw",1)  #FUN-990031
                NEXT FIELD apa100
             END IF
             DISPLAY g_buf1 TO FORMONLY.azp02  #TQC-A20061  #FUN-C80078 g_buf-->g_buf1
          END IF #MOD-9B0043
      AFTER FIELD apa930 
         IF NOT s_costcenter_chk(g_apa.apa930) THEN
            LET g_apa.apa930=NULL
            DISPLAY BY NAME g_apa.apa930
            DISPLAY NULL TO FORMONLY.gem02b
            NEXT FIELD apa930
         ELSE
            DISPLAY s_costcenter_desc(g_apa.apa930) TO FORMONLY.gem02b
         END IF
 
         #防止User只修改部門欄位時,未再次檢查會科與允許/拒絕部門關係
          LET l_aag05=''   
          SELECT aag05 INTO l_aag05
            FROM aag_file
           WHERE aag01 = g_apa.apa51
             AND aag00 = g_bookno1  
             AND aagacti = 'Y'               #No.MOD-B70280 add 
 
          LET g_errno = ' '  
          IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa51) THEN
            #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
             IF g_aaz.aaz90 ='Y' THEN
                CALL s_chkdept(g_aaz.aaz72,g_apa.apa51,g_apa.apa930,g_bookno1)                
                              RETURNING g_errno
             END IF
             IF NOT cl_null(g_errno) THEN
                CALL cl_err('',g_errno,0)
                NEXT FIELD apa930
             END IF
          END IF
          LET l_aag05=''   
          SELECT aag05 INTO l_aag05
            FROM aag_file
           WHERE aag01 = g_apa.apa52
             AND aag00 = g_bookno1   
             AND aagacti = 'Y'               #No.MOD-B70280 add 

          LET g_errno = ' '  
          IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa52) THEN
            #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
             IF g_aaz.aaz90 ='Y' THEN
                CALL s_chkdept(g_aaz.aaz72,g_apa.apa52,g_apa.apa930,g_bookno1)                
                              RETURNING g_errno
             END IF
             IF NOT cl_null(g_errno) THEN
                CALL cl_err('',g_errno,0)
                NEXT FIELD apa930
             END IF
          END IF
          LET l_aag05=''   
          SELECT aag05 INTO l_aag05
            FROM aag_file
           WHERE aag01 = g_apa.apa54
             AND aag00 = g_bookno1   
             AND aagacti = 'Y'               #No.MOD-B70280 add  
 
          LET g_errno = ' '  
          IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa54) THEN
            #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
             IF g_aaz.aaz90 ='Y' THEN
                CALL s_chkdept(g_aaz.aaz72,g_apa.apa54,g_apa.apa930,g_bookno1)                
                              RETURNING g_errno
             END IF
             IF NOT cl_null(g_errno) THEN
                CALL cl_err('',g_errno,0)
                NEXT FIELD apa930
             END IF
          END IF
 
         ###會科二###
          IF g_aza.aza63='Y' THEN 
             LET l_aag05=''   
             SELECT aag05 INTO l_aag05
               FROM aag_file
              WHERE aag01 = g_apa.apa511
                AND aag00 = g_bookno2   
                AND aagacti = 'Y'               #No.MOD-B70280 add             
 
             LET g_errno = ' '  
             IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa511) THEN
               #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                IF g_aaz.aaz90 ='Y' THEN
                   CALL s_chkdept(g_aaz.aaz72,g_apa.apa511,g_apa.apa930,g_bookno2)                
                                 RETURNING g_errno
                END IF
                IF NOT cl_null(g_errno) THEN
                   CALL cl_err('',g_errno,0)
                   NEXT FIELD apa930
                END IF
             END IF
             LET l_aag05=''   
             SELECT aag05 INTO l_aag05
               FROM aag_file
              WHERE aag01 = g_apa.apa521
                AND aag00 = g_bookno2   
                AND aagacti = 'Y'               #No.MOD-B70280 add  
            
             LET g_errno = ' '  
             IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa521) THEN
               #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                IF g_aaz.aaz90 ='Y' THEN
                   CALL s_chkdept(g_aaz.aaz72,g_apa.apa521,g_apa.apa930,g_bookno2)                
                                 RETURNING g_errno
                END IF
                IF NOT cl_null(g_errno) THEN
                   CALL cl_err('',g_errno,0)
                   NEXT FIELD apa930
                END IF
             END IF
             LET l_aag05=''   
             SELECT aag05 INTO l_aag05
               FROM aag_file
              WHERE aag01 = g_apa.apa541
                AND aag00 = g_bookno2   
                AND aagacti = 'Y'               #No.MOD-B70280 add            

             LET g_errno = ' '  
             IF l_aag05 = 'Y' AND NOT cl_null(g_apa.apa541) THEN
               #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                IF g_aaz.aaz90 ='Y' THEN
                   CALL s_chkdept(g_aaz.aaz72,g_apa.apa541,g_apa.apa930,g_bookno2)                
                                 RETURNING g_errno
                END IF
                IF NOT cl_null(g_errno) THEN
                   CALL cl_err('',g_errno,0)
                   NEXT FIELD apa930
                END IF
             END IF
          END IF  

      AFTER FIELD apaud01
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apaud02
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apaud03
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apaud04
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apaud05
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apaud06
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apaud07
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apaud08
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apaud09
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apaud10
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apaud11
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apaud12
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apaud13
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apaud14
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apaud15
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER INPUT  #判斷必要欄位之值是否有值,若無則反白顯示,並要求重新輸入
         LET g_apa.apauser = s_get_data_owner("apa_file") #FUN-C10039
         LET g_apa.apagrup = s_get_data_group("apa_file") #FUN-C10039
         LET l_flag='N'
         IF INT_FLAG THEN
           #LET INT_FLAG = 0   #MOD-BB0099 add           #MOD-BC0140 mark
           #MOD-A50152---add---start---
            LET l_cnt = 0
            SELECT COUNT(*) INTO l_cnt FROM apk_file
             WHERE apk01 = g_apa.apa01
            IF g_apa_t.apa08 <> 'MISC' AND l_cnt > 1 THEN
              #-----------------MOD-BC0140-------------start
              #CALL cl_err('','aap-761',1)
              #LET g_apa.apa08 = 'MISC'
              #DISPLAY g_apa.apa08
              #NEXT FIELD apa08
               UPDATE apa_file SET apa08 = 'MISC'
                WHERE apa01 = g_apa.apa01
               LET g_apa_t.apa08 = 'MISC'
              #-----------------MOD-BC0140----------------end
            END IF
           #MOD-A50152---add---end
            SELECT DISTINCT(pmb02) INTO l_pmb02 FROM pmb_file
             WHERE pmb01 = g_apa.apa11
            IF l_pmb02 = 1 OR cl_null(l_pmb02) THEN
               IF p_cmd = 'u' THEN   #MOD-960119 add
                  DELETE FROM apc_file WHERE apc01 = g_apa.apa01
                  CALL t110_ins_apc(g_apa_t.*)
               END IF                #MOD-960119 add
            ELSE
               IF g_apa.apa35 <> g_apa_t.apa35 OR g_apa.apa35f <> g_apa_t.apa35f THEN
                  LET g_sn = 'y'
               END IF
               CALL t110_account_period()
               LET g_sn = 'n'
            END IF
            EXIT INPUT
         END IF
 
         IF g_apa.apa08 != 'MISC' AND NOT cl_null(g_apa.apa08) AND
            g_apa.apa08 != 'UNAP' AND
           ((g_apa_t.apa08 IS NOT NULL AND g_apa.apa08!=g_apa.apa01) OR
            (g_apa_t.apa08 IS NULL)) THEN
            LET l_gec05 = ''
            SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01=g_apa.apa15
           #IF l_gec05 != 'X' THEN                   #No.MOD-B80015 mark
            IF l_gec05 NOT MATCHES '[4X]' THEN       #No.MOD-B80015 add
              #IF g_apa_t.apa08 IS NULL AND NOT t110_chk(g_apa.apa08) THEN     #MOD-A50180 mark
               IF NOT t110_chk(g_apa.apa08) THEN                               #MOD-A50180
                  CALL cl_err(g_apa.apa08,'sub-005',0)
                  NEXT FIELD apa08
               END IF
            END IF   #MOD-8A0213 add
            IF g_apa.apa02 != g_apa.apa09 THEN   #modi by canny(980714)
               LET l_amb01=YEAR(g_apa.apa09)
               LET l_amb02=MONTH(g_apa.apa09)
            ELSE
               LET l_amb01=YEAR(g_apa.apa02)
               LET l_amb02=MONTH(g_apa.apa02)
            END IF
 
            LET l_amb03=g_apa.apa08[1,2]
            LET g_msg = ""   #MOD-9C0356 add
            #CHI-930020--Begin
            SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01 = g_apa.apa15   
           #IF g_apz.apz07 = 'Y' AND (l_gec05 = '2' OR l_gec05 = '3') AND                  #MOD-C70159 mark
            IF g_apz.apz07 = 'Y' AND (l_gec05 MATCHES '[2356]') AND                        #MOD-C70159 add
               g_aza.aza26!= '2' THEN   #MOD-9C0444 add
               CALL s_apkchk(l_amb01,l_amb02,l_amb03,g_apa.apa171)            
                    RETURNING g_errno,g_msg                                   
            END IF            
            #CHI-930020---End                                                
            IF NOT cl_null(g_msg) THEN
               CALL cl_getmsg(g_msg,g_lang) RETURNING g_msg
               ERROR g_msg,' invoice =',g_apa.apa08,' SQLCODE=',g_errno
                IF cl_confirm('aap-766') THEN  #No.MOD-480431
                  IF NOT cl_null(g_errno) THEN
                     NEXT FIELD apa08
                  END IF
               END IF
            END IF
         END IF
         IF g_apa.apa31 <>g_apa_t.apa31 OR g_apa.apa32 <> g_apa_t.apa32
            OR g_apa.apa34 <> g_apa_t.apa34 OR g_apa.apa57 <> g_apa_t.apa57
            OR g_apa.apa57 <> g_apa_t.apa57 OR g_apa.apa73 <> g_apa_t.apa73
            OR g_apa.apa31f <> g_apa_t.apa31f OR g_apa.apa32f <> g_apa_t.apa32f
            OR g_apa.apa34f <> g_apa_t.apa34f OR g_apa.apa57f <> g_apa_t.apa57f THEN
           SELECT DISTINCT(pmb02) INTO l_pmb02 FROM pmb_file
            WHERE pmb01 = g_apa.apa11
           IF l_pmb02 = 1 OR cl_null(l_pmb02) THEN   #MOD-810156
              DELETE FROM apc_file WHERE apc01 = g_apa.apa01
              CALL t110_ins_apc(g_apa.*)
           ELSE
              IF g_apa.apa35 <> g_apa_t.apa35 OR g_apa.apa35f <> g_apa_t.apa35f THEN
                 LET g_sn = 'y'
              END IF
              CALL t110_account_period()
              LET g_sn = 'n'
           END IF
          END IF
         #當匯率為1時,需檢核原幣與本幣的稅額、金額需相同
          IF g_apa.apa14 = 1 AND g_aza.aza17 = g_apa.apa13 THEN   #MOD-880041
             IF g_apa.apa31f!=g_apa.apa31 OR g_apa.apa32f!=g_apa.apa32 OR
                g_apa.apa34f!=g_apa.apa34 THEN
                CALL cl_err('','apm-988',1)
                NEXT FIELD apa31f
             END IF
          END IF
          LET l_cnt = 0
          SELECT COUNT(*) INTO l_cnt FROM api_file
            WHERE api01 = g_apa.apa01
              AND api02 = '1'
          IF (( g_apa.apa51 <>'MISC' OR g_apa.apa51 IS NULL) OR
              ((g_apa.apa511<>'MISC' OR g_apa.apa511 IS NULL) AND g_aza.aza63='Y'))
             AND l_cnt > 0 THEN
             CALL cl_err('','aap-903',0)
             LET g_apa.apa51 = 'MISC'
             LET g_apa.apa511 = 'MISC'
             DISPLAY BY NAME g_apa.apa51,g_apa.apa511
             NEXT FIELD apa51
          END IF
      #FUN-CB0056-----add----str
      #檢查默認還款銀行是否正確
      IF NOT cl_null (g_apa.apa101) THEN
         CALL t110_apa101('a')
         IF NOT cl_null(g_errno) THEN
            CALL cl_err(g_apa.apa101,g_errno,0)
            NEXT FIELD apa101
          END IF
      END IF
      #FUN-CB0056---add----end

      ON ACTION CONTROLP
         CASE
            WHEN INFIELD(apa01) #查詢單据
               LET g_t1=s_get_doc_no(g_apa.apa01)
               CALL q_apy(FALSE,FALSE,g_t1,g_aptype,'AAP') RETURNING g_t1   #TQC-670008
               LET g_apa.apa01=g_t1            #No.FUN-550030
               DISPLAY BY NAME g_apa.apa01
               NEXT FIELD apa01
            WHEN INFIELD(apa05) #PAY TO VENDOR
               #FUN-DA0051--add--str--
               #大陆版且允许客户立账的情况下可以开窗客户+厂商
               IF g_aza.aza26 = '2' AND g_apz.apz74 = 'Y'                                   
                  AND g_prog = 'aapt150' THEN                                               
                  CALL q_occ_pmc(FALSE,TRUE,g_plant) RETURNING g_apa.apa05,l_occ02_pmc03
                  DISPLAY l_occ02_pmc03 TO pmc03
               ELSE
               #FUN-DA0051--add--end
               CALL cl_init_qry_var()
               #FUN-D80031 add ------- begin
               CASE g_prog
                  WHEN 'aapt140'
                     LET g_qryparam.form ="q_occ02"
                  OTHERWISE
                     LET g_qryparam.form ="q_pmc1"
               END CASE
               #FUN-D80031 add ------- end
              #LET g_qryparam.form ="q_pmc1"   #FUN-D80031 mark
               LET g_qryparam.default1 = g_apa.apa05
               CALL cl_create_qry() RETURNING g_apa.apa05
               END IF  #FUN-DA0051
               DISPLAY BY NAME g_apa.apa05
               NEXT FIELD apa05
            WHEN INFIELD(apa06) #PAY TO VENDOR
               #FUN-DA0051--add--str--
               #大陆版且允许客户立账的情况下可以开窗客户+厂商
               IF g_aza.aza26 = '2' AND g_apz.apz74 = 'Y'           
                  AND g_prog = 'aapt150' THEN                       
                  CALL q_occ_pmc(FALSE,TRUE,g_plant) RETURNING g_apa.apa06,g_apa.apa07
                  DISPLAY BY NAME g_apa.apa07
               ELSE
               #FUN-DA0051--add--end
               CALL cl_init_qry_var()
               IF g_aptype = '13' OR g_aptype = '17' OR g_aptype = '25' THEN
                  LET g_qryparam.form ="q_gen"      #No.CHI-780046
               ELSE
                  #FUN-D80031 add ------- begin
                  CASE g_prog
                     WHEN 'aapt140'
                        LET g_qryparam.form ="q_occ02"
                     OTHERWISE
                        LET g_qryparam.form ="q_pmc"
                  END CASE
                  #FUN-D80031 add ------- end
#                 LET g_qryparam.form ="q_pmc"  #MOD-960121    #FUN-D80031 mark
               END IF
               LET g_qryparam.default1 = g_apa.apa06
               CALL cl_create_qry() RETURNING g_apa.apa06
               END IF  #FUN-DA0051
               DISPLAY BY NAME g_apa.apa06
#              CALL t110_apa06('d')           #FUN-D80049 mark
               #FUN-D80049  ------------- add ----------- begin 
               CASE g_prog
                 WHEN 'aapt140'
                    CALL t110_apa06_1('d')
                 WHEN 'aapt150'
                    IF g_aza.aza26 = '2' AND g_apz.apz74 = 'Y' THEN           #FUN-DA0051 add
                       CALL t110_apa06_1('d')
                       IF g_errno = '100' THEN
                          CALL t110_apa06('d')
                       END IF
                    ELSE                                                      #FUN-DA0051 add
                       CALL t110_apa06('d')                                   #FUN-DA0051 add
                    END IF                                                    #FUN-DA0051 add
                 OTHERWISE
                    CALL t110_apa06('d')
               END CASE
               #FUN-D80049  ------------- add ----------- end
            WHEN INFIELD(apa11) # PAY TERM
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_pma"
               LET g_qryparam.default1 = g_apa.apa11
               CALL cl_create_qry() RETURNING g_apa.apa11
               DISPLAY BY NAME g_apa.apa11
            WHEN INFIELD(apa13) # CURRENCY
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_azi"
               LET g_qryparam.default1 = g_apa.apa13
               CALL cl_create_qry() RETURNING g_apa.apa13
               DISPLAY BY NAME g_apa.apa13
            WHEN INFIELD(apa15) # TAX CODE
               CALL cl_init_qry_var()
               IF g_prog = 'aapt160' THEN            #MOD-970220  
                  IF g_aza.aza26 = '2' THEN                #No.TQC-B40051                                                                   
                     LET g_qryparam.form = "q_gec7_1"  #No.TQC-B40051 
                  ELSE                                 #No.TQC-B40051 
                  	 LET g_qryparam.form = "q_gec7"    #MOD-970220   
                  END IF                               #No.TQC-B40051                                                                 
               ELSE 
               	  IF g_aza.aza26 = '2' THEN                #No.TQC-B40051                                                                   
                     LET g_qryparam.form = "q_gec8_1"  #No.TQC-B40051 
                  ELSE                                  #MOD-970220  
                     LET g_qryparam.form ="q_gec8"      #MOD-990132 q_gec-->q_gec8 
                  END IF                               #No.TQC-B40051  
               END IF                                #MOD-970220     
               LET g_qryparam.default1 = g_apa.apa15
               LET g_qryparam.arg1 = '1'
               IF g_prog = 'aapt260' THEN #MOD-970220                        
                  LET g_qryparam.where = " gec05 = 'X' AND gec06 = '2' "  #No.MOD-940297 add gec06
               END IF
               CALL cl_create_qry() RETURNING g_apa.apa15
               DISPLAY BY NAME g_apa.apa15
            WHEN INFIELD(apa77)
               CALL cl_init_qry_var()
               LET g_qryparam.form = "q_ama02"
               LET g_qryparam.default1 = g_apa.apa77
               CALL cl_create_qry() RETURNING g_apa.apa77
               DISPLAY BY NAME g_apa.apa77
            WHEN INFIELD(apa19) # HOLD CODE
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_apo"
               LET g_qryparam.default1 = g_apa.apa19
               CALL cl_create_qry() RETURNING g_apa.apa19
               DISPLAY BY NAME g_apa.apa19
            WHEN INFIELD(apa07) # Employee CODE
              #CALL cl_init_qry_var()                       #MOD-CC0238 mark
              #LET g_qryparam.form ="q_gen"                 #TQC-C70027 mark
              #LET g_qryparam.form ="q_apa11"               #TQC-C70027 add #MOD-CC0238 mark
              #LET g_qryparam.default1 = g_apa.apa07        #MOD-CC0238 mark 
              #CALL cl_create_qry() RETURNING g_apa.apa07   #MOD-CC0238 mark 
              #LET g_apa.apa07[2,9] = g_apa.apa07           #MOD-A60095 mark
              #LET g_apa.apa07[2,11] = g_apa.apa07          #MOD-A60095       #TQC-C70027  mark
              #LET g_apa.apa07[1,1] = '.'                   #TQC-C70027  mark
              #------------MOD-CC0238------------(S)
               CALL cl_init_qry_var()
               IF g_aptype = '12' AND g_apa.apa06='MISC' THEN           
                  LET g_qryparam.form ="q_pmc"                         
                 #LET g_qryparam.where=" pmc14='2'"         #CHI-D10057 mark             
               ELSE
                  LET g_qryparam.form ="q_gen"
               END IF                         
               LET g_qryparam.default1 = g_apa.apa07
               CALL cl_create_qry() RETURNING g_apa.apa07
               LET g_apa.apa07[2,11] = g_apa.apa07         
               LET g_apa.apa07[1,1] = '.'
              #------------MOD-CC0238------------(E)
               DISPLAY BY NAME g_apa.apa07
            WHEN INFIELD(apa21) # Employee CODE
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_gen"
               LET g_qryparam.default1 = g_apa.apa21
               CALL cl_create_qry() RETURNING g_apa.apa21
               DISPLAY BY NAME g_apa.apa21
            WHEN INFIELD(apa22) # Dept CODE
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_gem"
               LET g_qryparam.default1 = g_apa.apa22
               CALL cl_create_qry() RETURNING g_apa.apa22
               DISPLAY BY NAME g_apa.apa22
            WHEN INFIELD(apa36) # Class
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_apr"
               LET g_qryparam.default1 = g_apa.apa36
               CALL cl_create_qry() RETURNING g_apa.apa36
               DISPLAY BY NAME g_apa.apa36
            WHEN INFIELD(apa51) # Account number
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"   #TQC-790133
               LET g_qryparam.default1 = g_apa.apa51
               LET g_qryparam.arg1 = g_bookno1    #No.FUN-730064
               CALL cl_create_qry() RETURNING g_apa.apa51
               DISPLAY BY NAME g_apa.apa51
            WHEN INFIELD(apa52) # Account number
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"   #TQC-790133
               LET g_qryparam.default1 = g_apa.apa52
               LET g_qryparam.arg1 = g_bookno1      #No.FUN-730064
               CALL cl_create_qry() RETURNING g_apa.apa52
               DISPLAY BY NAME g_apa.apa52
            WHEN INFIELD(apa54) # Account number
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"   #TQC-790133
               LET g_qryparam.default1 = g_apa.apa54
               LET g_qryparam.arg1 = g_bookno1      #No.FUN-730064
               CALL cl_create_qry() RETURNING g_apa.apa54
               DISPLAY BY NAME g_apa.apa54
            WHEN INFIELD(apa511) # Account number
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"   #TQC-790133
               LET g_qryparam.default1 = g_apa.apa511
               LET g_qryparam.arg1 = g_bookno2     #No.FUN-730064
               CALL cl_create_qry() RETURNING g_apa.apa511
               DISPLAY BY NAME g_apa.apa511
            WHEN INFIELD(apa521) # Account number
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"   #TQC-790133
               LET g_qryparam.default1 = g_apa.apa521
               LET g_qryparam.arg1 = g_bookno2     #No.FUN-730064
               CALL cl_create_qry() RETURNING g_apa.apa521
               DISPLAY BY NAME g_apa.apa521
            WHEN INFIELD(apa541) # Account number
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"   #TQC-790133
               LET g_qryparam.default1 = g_apa.apa541
               LET g_qryparam.arg1 = g_bookno2       #No.FUN-730064
               CALL cl_create_qry() RETURNING g_apa.apa541
               DISPLAY BY NAME g_apa.apa541
            WHEN INFIELD(apa101)   #還款銀行
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_nma"
               IF g_aptype='13' THEN     
                   LET g_qryparam.where ="nma28 !=1 and nma37 !=0 and nma10='",g_apa.apa13,"'"        #TQC-AB0025 mark
#                  LET g_qryparam.where ="nma28 !='1' and nma37 !='0' and nma10='",g_apa.apa13,"'"    #TQC-AB0025 add   #FUN-C80018 mark
                  #FUN-C80018--ADD---STR
                    IF g_aza.aza26!='2' THEN                
                      LET g_qryparam.where ="nma28 !=1 and nma37 !=0 and nma10='",g_apa.apa13,"'"        #TQC-AB0025 mark
                    ELSE
                      LET g_qryparam.where ="nma37 !=0 and nma10='",g_apa.apa13,"'"
                    END IF
                  #FUN-C80018--ADD---END
               END IF
               CALL cl_create_qry() RETURNING g_apa.apa101
               DISPLAY BY NAME g_apa.apa101
            WHEN INFIELD(apa102)   #還款異動碼
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_nmc"
               IF g_aptype='13' THEN
#                 LET g_qryparam.where =" nmc03=1"     #TQC-AB0025 mark
                  LET g_qryparam.where =" nmc03='1'"   #TQC-AB0025 add
               END IF
               LET g_qryparam.default1 = g_apa.apa102
               CALL cl_create_qry() RETURNING g_apa.apa102
               DISPLAY BY NAME g_apa.apa102
            WHEN INFIELD(apa66) #專案代號
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_pja"
               LET g_qryparam.default1 = g_apa.apa66
               CALL cl_create_qry() RETURNING g_apa.apa66
               DISPLAY BY NAME g_apa.apa66
             WHEN INFIELD(apa14)
                CALL s_rate(g_apa.apa13,g_apa.apa14) RETURNING g_apa.apa14
                DISPLAY BY NAME g_apa.apa14
                NEXT FIELD apa14
               WHEN INFIELD(apa100)
                    CALL cl_init_qry_var()
                    LET g_qryparam.form = "q_azw"
                    LET g_qryparam.where = "azw02 = '",g_legal,"' "
                    LET g_qryparam.default1 = g_apa.apa100
                    CALL cl_create_qry() RETURNING g_apa.apa100
                    DISPLAY BY NAME g_apa.apa100
                    NEXT FIELD apa100
               WHEN INFIELD(apa930)
                  CALL cl_init_qry_var()
                  LET g_qryparam.form ="q_gem4"
                  CALL cl_create_qry() RETURNING g_apa.apa930
                  DISPLAY BY NAME g_apa.apa930
                  NEXT FIELD apa930
            OTHERWISE EXIT CASE
         END CASE
 
      ON ACTION mul_invoice
         IF g_apa.apa08='MISC' THEN
            IF p_cmd != 'a' THEN
               CALL t110_ddd('1')   #MOD-950112 add參數
               DISPLAY BY NAME g_apa.apa07      #TQC-630164 
               CALL t110_show_multi_invoice()   #No.TQC-A30076 
            END IF
         END IF
 
      ON ACTION single_invoice
         #單一發票且使用稅控系統, 發票資料來自單身
         IF g_apa.apa08 !='MISC' AND g_aza.aza26 != '2' THEN
            CALL t110_apa17('a')
            DISPLAY BY NAME g_apa.apa07   #TQC-630164 
            DISPLAY BY NAME g_apa.apa24,g_apa.apa12,g_apa.apa64  #MOD-9C0148 add
         END IF
 
      ON ACTION maintain_misc_vender
         CALL cl_cmdrun('aapi600')
 
      ON ACTION mul_debit
         IF g_apa.apa51='MISC' OR g_apa.apa511 ='MISC' THEN    #No.FUN-680029
            CALL t110_ccc('1')
         #No.TQC-A30133  --Begin                                                
         ELSE                                                                   
            CALL cl_err(g_apa.apa51,'aap-704',0)                                
         #No.TQC-A30133  --End
         END IF
 
      ON ACTION contra_tmp_est
            CALL t110_ppp('2')
 
 
      ON ACTION controlf                  #欄位說明
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name #Add on 040913
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang) #Add on 040913
 
 
 
      ON ACTION CONTROLR
         CALL cl_show_req_fields()
 
      ON ACTION controlg
         CALL cl_cmdask()
 
      ON IDLE g_idle_seconds   #TQC-860021
         CALL cl_on_idle()     #TQC-860021
         CONTINUE INPUT        #TQC-860021
 
      ON ACTION about          #TQC-860021
         CALL cl_about()       #TQC-860021
 
      ON ACTION help           #TQC-860021
         CALL cl_show_help()   #TQC-860021
   END INPUT
 
END FUNCTION
 
FUNCTION t110_chk(p_apa08)
   DEFINE p_apa08 LIKE apa_file.apa08
   DEFINE l_gec05 LIKE gec_file.gec05  #CHI-930020
   
   #大陸版發票輸入時不需檢查字軌
   IF g_aza.aza26 = '2' THEN RETURN 1 END IF  #MOD-9C0444 add

   #CHI-930020---Begin
   IF g_apz.apz07 = 'N' THEN RETURN 1 END IF   #發票輸入時檢查字軌  #MOD-980141 mod
   #發票為2/3聯時檢查                                                           
   SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01 = g_apa.apa15            
  #IF (l_gec05 !='2' OR l_gec05 !='3') THEN     #MOD-A50180 mark
  #IF (l_gec05 !='2' AND l_gec05 !='3') THEN            #MOD-A50180 #MOD-C70159 mark
   IF l_gec05 NOT MATCHES '[2356]' THEN                 #MOD-C70159 add
        RETURN 1   #MOD-980141 mod
     END IF                                                                     
   #CHI-930020---End 
   #台灣版才做下面的檢查
   IF g_aza.aza26 = '0' THEN   #MOD-890213 add
      IF g_apa.apa171!=28 AND g_apa.apa171!=29 THEN   #MOD-B40115 add
         IF p_apa08[1,1] MATCHES '[A-Z]' AND p_apa08[2,2] MATCHES '[A-Z]' AND
            p_apa08[3,3] MATCHES '[0-9]' AND p_apa08[4,4] MATCHES '[0-9]' AND
            p_apa08[5,5] MATCHES '[0-9]' AND p_apa08[6,6] MATCHES '[0-9]' AND
            p_apa08[7,7] MATCHES '[0-9]' AND p_apa08[8,8] MATCHES '[0-9]' AND
            p_apa08[9,9] MATCHES '[0-9]' AND p_apa08[10,10] MATCHES '[0-9]' THEN
            RETURN 1
         ELSE
            RETURN 0
         END IF
     #str MOD-B40115 add
      ELSE
         RETURN 1
      END IF
     #end MOD-B40115 add
   ELSE
      RETURN 1
   END IF
 
END FUNCTION
 
FUNCTION t110_apa66()
   DEFINE l_pjaacti   LIKE pja_file.pjaacti  #FUN-810045 gjaacti->pjaacti
 
   LET g_errno=''
   SELECT pjaacti INTO l_pjaacti FROM pja_file WHERE pja01=g_apa.apa66   #FUN-810045
 
   CASE
      WHEN SQLCA.SQLCODE = 100
         LET g_errno = 'apj-005'
      WHEN l_pjaacti = 'N'
         LET g_errno = '9028'
      WHEN SQLCA.SQLCODE != 0
         LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE
 
END FUNCTION
 
FUNCTION t110_apa05(p_cmd)
   DEFINE p_cmd     LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_pmc03   LIKE pmc_file.pmc03
   DEFINE l_pmc04   LIKE pmc_file.pmc04
   DEFINE l_pmc05   LIKE pmc_file.pmc05
   DEFINE l_pmcacti LIKE pmc_file.pmcacti
   DEFINE l_pmc24   LIKE pmc_file.pmc24
 
   SELECT pmc03,pmc04,pmc05,pmcacti,pmc24
     INTO l_pmc03,l_pmc04,l_pmc05,l_pmcacti,l_pmc24
     FROM pmc_file WHERE pmc01 = g_apa.apa05
 
   LET g_errno = ' '
 
   CASE
      WHEN l_pmcacti = 'N'            LET g_errno = '9028'
      WHEN l_pmcacti MATCHES '[PH]'   LET g_errno = '9038'    #No.FUN-690024
     
      WHEN l_pmc05   = '0'            LET g_errno = 'aap-032'    #MOD-950045        
      WHEN l_pmc05   = '3'            LET g_errno = 'aap-033' 
 
       WHEN STATUS=100 LET g_errno = '100'  #MOD-4B0124
      WHEN SQLCA.SQLCODE != 0
         LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE
 
   DISPLAY l_pmc03 TO pmc03
 
   IF NOT cl_null(g_errno) THEN
      RETURN
   END IF
 
   IF p_cmd='d' THEN
      RETURN
   END IF
 
  #-MOD-C90093-add-
   SELECT pmc03 INTO g_apa.apa07 
     FROM pmc_file
    WHERE pmc01 = l_pmc04 
  #-MOD-C90093-end-
 
   LET g_apa.apa06 = l_pmc04
   LET g_apa.apa18 = l_pmc24
   DISPLAY BY NAME g_apa.apa06
   DISPLAY BY NAME g_apa.apa07    #MOD-C90093
 
END FUNCTION

#FUN-D80031 add ---------- begin
#來源于occ_file
FUNCTION t110_apa05_1(p_cmd)
   DEFINE p_cmd     LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_occacti LIKE occ_file.occacti
   DEFINE l_occ02   LIKE occ_file.occ02
   DEFINE l_occ07   LIKE occ_file.occ07
   DEFINE l_occ11   LIKE occ_file.occ11
   DEFINE l_occ1004 LIKE occ_file.occ1004


   LET g_errno = ' '
   SELECT occ02,occ07,occ11,occ1004,occacti
     INTO l_occ02,l_occ07,l_occ11,l_occ1004,l_occacti
     FROM occ_file
    WHERE occ01 = g_apa.apa05

   CASE
      WHEN l_occacti = 'N'            LET g_errno = '9028'
      WHEN l_occacti MATCHES '[PH]'   LET g_errno = '9038'    #No.FUN-690024

      WHEN l_occ1004   = '0'            LET g_errno = 'atm-073'    #MOD-950045
      WHEN l_occ1004   = '3'            LET g_errno = 'atm-079'

       WHEN STATUS=100 LET g_errno = '100'  #MOD-4B0124
      WHEN SQLCA.SQLCODE != 0
         LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE

   DISPLAY l_occ02 TO pmc03

   IF NOT cl_null(g_errno) THEN
      RETURN
   END IF

   IF p_cmd='d' THEN
      RETURN
   END IF

   IF p_cmd = 'a' THEN
     SELECT occ02 INTO g_apa.apa07
       FROM occ_file
      WHERE occ01 = l_occ07
      LET g_apa.apa06 = l_occ07
   END IF
   LET g_apa.apa18 = l_occ11
   DISPLAY BY NAME g_apa.apa06
   DISPLAY BY NAME g_apa.apa07

END FUNCTION
#FUN-D80031 add ---------- end
 
FUNCTION t110_apa06(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_pmc03 LIKE pmc_file.pmc03
   DEFINE l_pmc04   LIKE pmc_file.pmc04
   DEFINE l_pmc05   LIKE pmc_file.pmc05
   DEFINE l_pmc17   LIKE pmc_file.pmc17
   DEFINE l_pmc22   LIKE pmc_file.pmc22
   DEFINE l_pmc24   LIKE pmc_file.pmc24
   DEFINE l_pmc26   LIKE pmc_file.pmc26
   DEFINE l_pmc47   LIKE pmc_file.pmc47
   DEFINE l_pmc54   LIKE pmc_file.pmc54
   DEFINE l_pmcacti LIKE pmc_file.pmcacti
   DEFINE l_dept    LIKE apa_file.apa22      #FUN-CB0056
 
   LET l_pmc03 = ''
 
   SELECT pmc03,pmc04,pmc05,pmc17,pmc22,pmc24,pmc26,pmc47,pmc54,pmcacti
     INTO l_pmc03,l_pmc04,l_pmc05,l_pmc17,l_pmc22,l_pmc24,
          l_pmc26,l_pmc47,l_pmc54,l_pmcacti
     FROM pmc_file
    WHERE pmc01 = g_apa.apa06
 
   LET g_errno = ' '
 
   CASE
      WHEN SQLCA.SQLCODE = 100        LET g_errno = 'aap-031'
      WHEN l_pmcacti = 'N'            LET g_errno = '9028' 
      WHEN l_pmcacti MATCHES '[PH]'   LET g_errno = '9038'       #FUN-690024 
 
      WHEN l_pmc05   = '0'            LET g_errno = 'aap-032'
      WHEN l_pmc05   = '3'            LET g_errno = 'aap-033'
      WHEN SQLCA.SQLCODE != 0
         LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE
 
   IF NOT cl_null(g_errno) THEN
      RETURN
   END IF
 
   IF p_cmd = 'd' THEN
      RETURN
   END IF
  
   #FUN-CB0056---add---str
   IF g_apz.apz13 = 'N' THEN
      LET l_dept = ' '
   ELSE
      LET l_dept = g_apa.apa22
   END IF
   IF g_prog='aapt150' THEN
      SELECT aps03 INTO l_pmc47 FROM aps_file WHERE aps01=l_dept
   ELSE
      IF g_prog='aapt160' OR g_prog = 'aapt260' THEN
         SELECT aps02 INTO l_pmc47 FROM aps_file WHERE aps01=l_dept
      END IF
   END IF
   #FUN-CB0056---add--end
 
   LET g_apa.apa07 = l_pmc03
 
   IF g_aptype[1,1] = '1' OR g_aptype='21' OR g_aptype='22' OR g_aptype='26' THEN   #MOD-7B0101
      LET g_apa.apa11 = l_pmc17
   END IF
 
   LET g_apa.apa15 = l_pmc47
   LET g_apa_o.apa15 = NULL   #MOD-AA0105 
 
   SELECT gec04 INTO g_apa.apa16 FROM gec_file WHERE gec01=g_apa.apa15 AND gec011='1'  #No:8511 加上gec011
 
   LET g_apa.apa13 = l_pmc22
 
   CALL t110_apa13(p_cmd)   #MOD-7C0203 
   DISPLAY BY NAME g_apa.apa07,g_apa.apa11,g_apa.apa13,
                   g_apa.apa15,g_apa.apa16,g_apa.apa13  
 
END FUNCTION

#FUN-D80031 add ---------- begin
#aapt140來源于occ_file
FUNCTION t110_apa06_1(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1
   DEFINE l_occacti LIKE occ_file.occacti
   DEFINE l_occ02   LIKE occ_file.occ02
   DEFINE l_occ07   LIKE occ_file.occ07
   DEFINE l_occ11   LIKE occ_file.occ11
   DEFINE l_occ41   LIKE occ_file.occ41
   DEFINE l_occ42   LIKE occ_file.occ42
   DEFINE l_occ1004 LIKE occ_file.occ1004


   LET g_errno = ' '
   LET l_occ02 = ''

   LET g_errno = ' '
   SELECT occ02,occ07,occ11,occ1004,occacti,occ41,occ42
     INTO l_occ02,l_occ07,l_occ11,l_occ1004,l_occacti,l_occ41,l_occ42
     FROM occ_file
    WHERE occ01 = g_apa.apa06

   CASE
      WHEN l_occacti = 'N'            LET g_errno = '9028'
      WHEN l_occacti MATCHES '[PH]'   LET g_errno = '9038'    #No.FUN-690024

      WHEN l_occ1004   = '0'            LET g_errno = 'atm-073'    #MOD-950045
      WHEN l_occ1004   = '3'            LET g_errno = 'atm-079'

       WHEN STATUS=100 LET g_errno = '100'  #MOD-4B0124
      WHEN SQLCA.SQLCODE != 0
         LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE


   IF NOT cl_null(g_errno) THEN
      RETURN
   END IF

   IF p_cmd = 'd' THEN
      RETURN
   END IF


   LET g_apa.apa07 = l_occ02


   LET g_apa.apa15 = l_occ41
   LET g_apa_o.apa15 = NULL

   SELECT gec04 INTO g_apa.apa16 FROM gec_file WHERE gec01=g_apa.apa15 AND gec011='1'

   LET g_apa.apa13 = l_occ42

   CALL t110_apa13(p_cmd)
   DISPLAY BY NAME g_apa.apa07,g_apa.apa13,
                   g_apa.apa15,g_apa.apa16,g_apa.apa13

END FUNCTION



#aapt140來源于occ_file
FUNCTION t110_apb26_1(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1
   DEFINE l_occacti LIKE occ_file.occacti
   DEFINE l_occ02   LIKE occ_file.occ02
   DEFINE l_occ07   LIKE occ_file.occ07
   DEFINE l_occ11   LIKE occ_file.occ11
   DEFINE l_occ1004 LIKE occ_file.occ1004


   LET g_errno = ' '
   LET l_occ02 = ''

   LET g_errno = ' '
   SELECT occ02,occ07,occ1004,occacti
     INTO l_occ02,l_occ07,l_occ11,l_occ1004,l_occacti
     FROM occ_file
    WHERE occ01 = g_apb[l_ac].apb26

   CASE
      WHEN l_occacti = 'N'            LET g_errno = '9028'
      WHEN l_occacti MATCHES '[PH]'   LET g_errno = '9038'    #No.FUN-690024

      WHEN l_occ1004   = '0'            LET g_errno = 'atm-073'    #MOD-950045
      WHEN l_occ1004   = '3'            LET g_errno = 'atm-079'
      WHEN l_occ07 <> g_apa.apa06       LET g_errno = 'axr-629'
      WHEN STATUS=100 LET g_errno = '100'  #MOD-4B0124
      WHEN SQLCA.SQLCODE != 0
         LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE


   IF NOT cl_null(g_errno) THEN
      RETURN
   END IF

   IF p_cmd = 'd' THEN
      RETURN
   END IF
   LET g_apb[l_ac].b26 = l_occ02
END FUNCTION
#FUN-D80031 add ---------- end
 
#FUNCTION t110_invoice_chk(p_no,p_tax)   #MOD-770138
#FUNCTION t110_invoice_chk(p_no,p_tax,p_date)    #CHI-820005 #No.TQC-CB0066   Mark
FUNCTION t110_invoice_chk(p_no,p_tax,p_date,p_code)          #No.TQC-CB0066   Add
   DEFINE p_no      LIKE apk_file.apk03 #No:7127
   DEFINE p_tax     LIKE gec_file.gec01 #MOD-770138
   DEFINE l_gec08   LIKE gec_file.gec08 #MOD-770138
   DEFINE l_gec05   LIKE gec_file.gec05 #No.MOD-510036
   DEFINE l_n1,l_n2 LIKE type_file.num5,    #No.FUN-690028 SMALLINT
          l_idx     LIKE type_file.num5     # No.FUN-690028 SMALLINT
         ,l_year    LIKE type_file.num5     #CHI-820005   Add 
   DEFINE p_date    LIKE apa_file.apa09     #CHI-820005 add
   DEFINE p_code    LIKE apa_file.apa46     #No.TQC-CB0066   Add

   LET g_errno = ''
   LET l_year = YEAR(p_date)USING '&&&&'    #CHI-820005   Add

   IF p_no IS NULL THEN
      LET g_errno = 'aap-099'
      RETURN
   END IF
  #-MOD-AA0035-add-
   IF g_apa.apa08 != 'MISC' AND g_apa.apa08 != 'UNAP' THEN
      SELECT gec05,gec08 INTO l_gec05,l_gec08 FROM gec_file
       WHERE gec01 = g_apa.apa15 AND gec011 = '1'
      IF status THEN LET l_gec05='' LET l_gec08='' END IF
   ELSE
      SELECT gec05,gec08 INTO l_gec05,l_gec08 FROM gec_file
       WHERE gec01 = p_tax AND gec011 = '1'
      IF status THEN LET l_gec05='' LET l_gec08='' END IF
   END IF
  #IF l_gec08 = 'XX' THEN RETURN END IF                         #MOD-D30074 mark                
   IF l_gec08 = 'XX' AND g_aza.aza26 <> '2' THEN                #MOD-D30074 add
      RETURN                                                    #MOD-D30074 add
   END IF                                                       #MOD-D30074 add
  #IF l_gec08 = '22' THEN RETURN END IF                         #MOD-870022 add #MOD-C70159 mark
  #IF l_gec05='2' OR l_gec05='3' THEN                                           #MOD-C70159 mark
   IF l_gec05 MATCHES '[2356]' THEN                                             #MOD-C70159 add
      FOR l_idx = 3 TO 10
         IF cl_null(p_no[l_idx,l_idx]) THEN
            LET g_errno='aap-760'
            EXIT FOR
         END IF
      END FOR
   END IF
  #-MOD-AA0035-end-
 
  #IF g_aza.aza26 = '1' THEN                                       #MOD-D30074 mark
   IF cl_null(p_code) THEN                                         #MOD-D30074 add
      SELECT COUNT(*) INTO l_n1 FROM apa_file WHERE apa08 = p_no  
             AND apa05 = g_apa.apa05
             AND YEAR(apa09) = l_year   #CHI-820005
      SELECT COUNT(*) INTO l_n2 FROM apk_file,apa_file WHERE apk03 = p_no
              AND apk171 !='23' AND apk171 != '24'  
              AND apk01 = apa01 AND apa05 = g_apa.apa05 
              AND YEAR(apk05) = l_year                         #CHI-820005   Add
   ELSE
      SELECT COUNT(*) INTO l_n1 FROM apa_file WHERE apa08 = p_no
             AND YEAR(apa09) = l_year   #CHI-820005
             AND apk28 = p_code        #No.TQC-CB0066   Add
      SELECT COUNT(*) INTO l_n2 FROM apk_file WHERE apk03 = p_no
              AND apk171 !='23' AND apk171 != '24'   #MOD-660111
              AND YEAR(apk05) = l_year                         #CHI-820005   Add
              AND apk28 = p_code        #No.TQC-CB0066   Add
   END IF   #CHI-7A0024
 
   IF (l_n1+l_n2) > 0 THEN
      LET g_errno = 'aap-034'
      RETURN
   END IF
 
   IF g_apz.apz07 != 'Y' THEN
      RETURN
   END IF
 
  #-MOD-AA0035-mark-
  #IF g_apa.apa08 != 'MISC' AND g_apa.apa08 != 'UNAP' THEN
  #   SELECT gec05,gec08 INTO l_gec05,l_gec08 FROM gec_file
  #    WHERE gec01 = g_apa.apa15
  #   IF status THEN LET l_gec05='' LET l_gec08='' END IF
  #ELSE
  #   SELECT gec05,gec08 INTO l_gec05,l_gec08 FROM gec_file
  #    WHERE gec01 = p_tax
  #   IF status THEN LET l_gec05='' LET l_gec08='' END IF
  #END IF
  #IF l_gec08 = 'XX' THEN RETURN END IF
  #IF l_gec08 = '22' THEN RETURN END IF   #MOD-870022 add
  #IF l_gec05='2' OR l_gec05='3' THEN
  #   FOR l_idx = 3 TO 10
  #      IF cl_null(p_no[l_idx,l_idx]) THEN
  #         LET g_errno='aap-760'
  #         EXIT FOR
  #      END IF
  #   END FOR
  #END IF
  #-MOD-AA0035-end-
 
   RETURN
 
END FUNCTION
 
FUNCTION t110_apa13(p_cmd)
   DEFINE p_cmd     LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_aziacti LIKE azi_file.aziacti  #MOD-6B0066
   DEFINE l_apb23   LIKE apb_file.apb23,   #MOD-790042
          l_apb24   LIKE apb_file.apb24,   #MOD-860221 add
          l_apb09   LIKE apb_file.apb09,   #MOD-790042
          l_apb02   LIKE apb_file.apb02,   #MOD-790042
          l_apb08   LIKE apb_file.apb08,   #MOD-790042
          l_apb081  LIKE apb_file.apb081,  #MOD-790042
          l_apb10   LIKE apb_file.apb10,   #MOD-790042
          l_apb101  LIKE apb_file.apb101,  #MOD-790042
          l_apa32   LIKE apa_file.apa32    #MOD-B80140 add
 
   SELECT azi03,azi04,azi07,aziacti INTO t_azi03,t_azi04,t_azi07,l_aziacti  #MOD-6B0066
     FROM azi_file  WHERE azi01 = g_apa.apa13  #MOD-6B0066
 
   LET g_errno = ' '
 
   CASE
      WHEN SQLCA.SQLCODE = 100
         LET g_errno = 'aap-002'
      WHEN l_aziacti = 'N'   #MOD-6B0066
         LET g_errno = '9028'
      WHEN SQLCA.SQLCODE != 0
         LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE
 
   CALL s_curr3(g_apa.apa13,g_apa.apa02,g_apz.apz33) RETURNING g_apa.apa14 #FUN-640022
 
   DISPLAY BY NAME g_apa.apa14
 
   IF g_apa.apa13 =g_aza.aza17 THEN
      LET g_apa.apa14=1
      DISPLAY BY NAME g_apa.apa14
   END IF
   DISPLAY BY NAME g_apa.apa14   
   IF g_apa.apa14 <> g_apa_o.apa14 THEN                            
      SELECT COUNT(*) INTO g_cnt FROM apb_file
       WHERE apb01=g_apa.apa01
      IF g_cnt > 0 THEN
         IF NOT cl_confirm('aap-331') THEN
            CALL cl_err('','aap-888',1)
            LET g_apa.apa14 = g_apa_t.apa14
            DISPLAY BY NAME g_apa.apa14
         END IF
 
         DECLARE upd_apb_cs3 CURSOR FOR
            SELECT apb23,apb09,apb02,apb24   #MOD-860221 add apb24
              FROM apb_file
             WHERE apb01=g_apa.apa01
 
        #FOREACH upd_apb_cs INTO l_apb23,l_apb09,l_apb02,l_apb24    #MOD-860221 add l_apb24    #MOD-A40184 mark
         FOREACH upd_apb_cs3 INTO l_apb23,l_apb09,l_apb02,l_apb24   #MOD-860221 add l_apb24   #MOD-A40184 add
            LET l_apb08 = l_apb23 * g_apa.apa14
            LET l_apb08 = cl_digcut(l_apb08,g_azi03)   
            LET l_apb10 = l_apb24 * g_apa.apa14   #MOD-860221
            LET l_apb10 = cl_digcut(l_apb10,g_azi04)   
            LET l_apb081= l_apb08
            LET l_apb101= l_apb10
 
            UPDATE apb_file SET apb08 = l_apb08,
                                apb081 = l_apb081,
                                apb10  = l_apb10,
                                apb101 = l_apb101
             WHERE apb01 = g_apa.apa01
               AND apb02 = l_apb02
            IF STATUS OR SQLCA.SQLCODE THEN
               CALL cl_err3("upd","apb_file",g_apa.apa11,l_apb02,SQLCA.sqlcode,"","upd apb:",1)
               LET g_apa.apa14 = g_apa_t.apa14
               DISPLAY BY NAME g_apa.apa14
               EXIT FOREACH
            END IF
         END FOREACH
         CALL t110_b_fill(' 1=1')
         CALL t110_sum_apa()
      ELSE
         #雜項帳款有可能沒有單身資料
         IF g_apa.apa00='12' OR g_apa.apa00='15' OR g_apa.apa00='16' OR   #MOD-910181 add 16
            g_apa.apa00='21' OR g_apa.apa00='13' OR g_apa.apa00='17' OR   
            g_apa.apa00='22' THEN   #MOD-9B0168 add
            LET g_apa.apa31 = g_apa.apa31f * g_apa.apa14
            LET g_apa.apa31 = cl_digcut(g_apa.apa31,g_azi04)   
            LET g_apa.apa32 = g_apa.apa31 * g_apa.apa16 / 100
            CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
            LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add
            LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)  
            DISPLAY BY NAME g_apa.apa31
            DISPLAY BY NAME g_apa.apa32
            CALL t110_apa34f('0')  
            CALL t110_unpay()
         END IF
      END IF
   END IF
END FUNCTION
 
FUNCTION t110_apa15(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_gec03   LIKE gec_file.gec03
   DEFINE l_gec031  LIKE gec_file.gec031          #No.FUN-680029
   DEFINE l_gec04   LIKE gec_file.gec04
   DEFINE l_gec06   LIKE gec_file.gec06
   DEFINE l_gec08   LIKE gec_file.gec08
   DEFINE l_gecacti LIKE gec_file.gecacti
 
   LET l_sql = "SELECT gec03,gec031,gec04,gec05,gec06,gec08,gecacti ",
               #"  FROM ",li_dbs CLIPPED,"gec_file ",
               "  FROM ",cl_get_target_table(m_plant,'gec_file'), #FUN-A50102
               " WHERE gec01 = '",g_apa.apa15,"' ",
               "   AND gec011='1' "  #進項
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
   CALL cl_parse_qry_sql(l_sql,m_plant) RETURNING l_sql #FUN-A50102            
   PREPARE sel_gec03_cs FROM l_sql
   EXECUTE sel_gec03_cs INTO l_gec03,l_gec031,l_gec04,g_gec05,l_gec06,l_gec08,l_gecacti
 
   LET g_errno = ' '
   CASE WHEN SQLCA.SQLCODE = 100 LET g_errno = 'mfg3044'
        WHEN l_gecacti = 'N'     LET g_errno = '9028'
        WHEN SQLCA.SQLCODE != 0  LET g_errno = SQLCA.SQLCODE USING '-----'
        OTHERWISE 
          IF (g_prog = 'aapt160' OR g_prog = 'aapt260') AND p_cmd='a' THEN 
             CASE                                                                                                                   
                WHEN l_gec06 !='2'       LET g_errno = 'aap-985'                                                                    
                WHEN g_gec05   !='X' OR                                                                                             
                     cl_null(g_gec05)    LET g_errno = 'aap-977'                                                                    
                WHEN l_gec08   !='XX'    LET g_errno = 'aap-008'                                                                    
             END CASE                                                                                                               
          END IF 
   END CASE
 
   IF NOT cl_null(g_errno) THEN
      RETURN
   END IF
 
   LET g_apa.apa16 = l_gec04
   LET g_apa.apa52 = l_gec03
   LET g_apa.apa521= l_gec031    #No.FUN-680029
   LET g_apa.apa171 = l_gec08
   LET g_apa.apa172 = l_gec06
   DISPLAY BY NAME g_apa.apa16,g_apa.apa52,g_apa.apa521   #TQC-A30129 add apa521
 
   IF p_cmd = 'd' THEN
      RETURN
   END IF
 
   DISPLAY BY NAME g_apa.apa52
 
END FUNCTION
 
FUNCTION t110_input_apl(p_no)
   DEFINE p_no  LIKE apl_file.apl01  #FUN-660117
   DEFINE l_apl RECORD LIKE apl_file.*
 
   IF cl_null(p_no) THEN
      RETURN
   END IF
 
   LET g_errno=' '
   SELECT * INTO l_apl.* FROM apl_file WHERE apl01 = p_no
   LET l_apl.apl01 = p_no
 
   IF l_apl.apl02 IS NULL THEN
      LET l_apl.apl02 = g_apa.apa07
   END IF
 
   OPEN WINDOW t110_apl AT 7,24 WITH FORM "aap/42f/aapt110_b"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No.FUN-580092 HCN
 
   CALL cl_ui_locale("aapt110_b")
 
   CALL cl_set_head_visible("","YES")            #No.FUN-6B0033
 
   INPUT BY NAME l_apl.apl01,l_apl.apl02,l_apl.apl03 WITHOUT DEFAULTS
      ON ACTION controlg       #TQC-860021
         CALL cl_cmdask()      #TQC-860021
 
      ON IDLE g_idle_seconds   #TQC-860021
         CALL cl_on_idle()     #TQC-860021
         CONTINUE INPUT        #TQC-860021
 
      ON ACTION about          #TQC-860021
         CALL cl_about()       #TQC-860021
 
      ON ACTION help           #TQC-860021
         CALL cl_show_help()   #TQC-860021
   END INPUT                   #TQC-860021
 
   CLOSE WINDOW t110_apl
 
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      RETURN
   END IF
 
   SELECT count(*) INTO g_cnt FROM apl_file WHERE apl01 = p_no
 
   IF g_cnt > 0 THEN
      UPDATE apl_file SET * = l_apl.* WHERE apl01 = p_no
      IF STATUS OR SQLCA.SQLCODE THEN
         CALL cl_err3("upd","apl_file",p_no,"",SQLCA.sqlcode,"","upd apl:",1)  #No.FUN-660122
      END IF
   ELSE
      INSERT INTO apl_file VALUES (l_apl.*)
      IF STATUS OR SQLCA.SQLCODE THEN
         CALL cl_err3("ins","apl_file",l_apl.apl01,"",SQLCA.sqlcode,"","ins apl:",1)  #No.FUN-660122
      END IF
   END IF
 
END FUNCTION
 
FUNCTION t110_unhold()
 
   IF g_apa.apa01 IS NULL THEN
      RETURN
   END IF
 
   SELECT * INTO g_apa.* FROM apa_file
    WHERE apa01=g_apa.apa01
 
   IF g_apa.apa42 = 'Y' THEN
      CALL cl_err('apa42=Y ','aap-165',0)
      RETURN
   END IF
 
   IF g_apa.apa74 = 'Y' THEN
      CALL cl_err('apa74=Y ','aap-334',0)
      RETURN
   END IF
 
  #-MOD-BB0304-add-
  #IF g_apa.apa63 MATCHES '[Ss1]' THEN   #MOD-C20184 mark
   IF g_apa.apa63 MATCHES '[Ss]' THEN    #MOD-C20184 add
       CALL cl_err('','mfg3557',0)
       RETURN
   END IF
  #-MOD-BB0304-end-
  #yinhy131209  --Begin
  IF cl_null(g_apa.apa19) THEN
  	 RETURN
  END IF
  #yinhy131209  --End
  IF cl_confirm("axm-102") THEN     #yinhy131209

   LET g_apa.apa19 = NULL
   LET g_apa.apa20 = 0
   LET g_apa.apa56 = '0'   #MOD-B70086
 
   UPDATE apa_file SET apa19 = g_apa.apa19,
                       apa20 = g_apa.apa20
                      ,apa56 = g_apa.apa56     #MOD-B70086
    WHERE apa01 = g_apa.apa01
 
   IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
      CALL cl_err3("upd","apa_file",g_apa.apa01,"",STATUS,"","upd apa:",1)
      RETURN
   END IF
 
   LET g_apa_t.apa19 = g_apa.apa19
   LET g_apa_t.apa20 = g_apa.apa20
   LET g_apa_t.apa56 = g_apa.apa56    #MOD-B70086
  
   DISPLAY BY NAME g_apa.apa56        #MOD-B70086 
   CALL t110_apa56()                  #MOD-B70086
 
   DISPLAY '','','0' TO apa19,apo02,apa20
   UPDATE apc_file SET apc16 =0 WHERE apc01 = g_apa.apa01  #No.FUN-680027
 
   LET g_msg = TIME
   INSERT INTO azo_file (azo01,azo02,azo03,azo04,azo05,azo06,azoplant,azolegal)   #MOD-590460 #FUN-980001 add azoplant,azolegal
                 #VALUES('aapt110',g_user,g_today,g_msg,g_apa.apa01,'unhold',g_plant,g_legal) #FUN-980001 add g_plant,g_legal #MOD-AC0328 mark
                  VALUES(g_prog,g_user,g_today,g_msg,g_apa.apa01,'unhold',g_plant,g_legal)    #FUN-980001 add g_plant,g_legal #MOD-AC0328 

  END IF  #yinhy131209
END FUNCTION
 
FUNCTION t110_hold()
DEFINE l_apa20      LIKE apa_file.apa20           #No.FUN-680027
DEFINE l_apc16      LIKE apc_file.apc16           #No.FUN-680027
DEFINE l_apc02      LIKE apc_file.apc02           #No.FUN-680027
DEFINE l_apc08      LIKE apc_file.apc08           #No.FUN-680027
DEFINE l_apc10      LIKE apc_file.apc10           #No.FUN-680027
DEFINE l_pmb05      LIKE pmb_file.pmb05           #No.FUN-680027
DEFINE l_hold_amt   LIKE apa_file.apa20           #No.MOD-780152
DEFINE apc16_tot    LIKE apc_file.apc16           #No.MOD-A30208 add
DEFINE l_flag       LIKE type_file.chr1           #MOD-AA0187
 
   SELECT * INTO g_apa.* FROM apa_file
    WHERE apa01=g_apa.apa01
 
   IF g_apa.apa42 = 'Y' THEN
      CALL cl_err('apa42=Y ','aap-165',0)
      RETURN
   END IF
 
   IF g_apa.apa74 = 'Y' THEN
      CALL cl_err('apa74=Y ','aap-334',0)
      RETURN
   END IF
 
   IF g_apa.apa01 IS NULL THEN
      RETURN
   END IF
 
   IF g_apz.apz27 = 'N' THEN
      IF g_apa.apa34-g_apa.apa35=0 AND g_apa.apa34f-g_apa.apa35f=0 THEN
         RETURN
      END IF
   ELSE
      IF g_apa.apa73 = 0 AND g_apa.apa34f-g_apa.apa35f=0 THEN
         RETURN
      END IF
   END IF

  #-MOD-BB0304-add-
  #IF g_apa.apa63 MATCHES '[Ss1]' THEN     #MOD-C30031 mark
   IF g_apa.apa63 MATCHES '[Ss]' THEN      #MOD-C30031 add
       CALL cl_err('','mfg3557',0)
       RETURN
   END IF
  #-MOD-BB0304-end-

   WHILE TRUE
      LET INT_FLAG = 0  
      CALL cl_getmsg('aap-780',g_lang) RETURNING g_msg
      PROMPT g_msg CLIPPED FOR g_chr
         ON IDLE g_idle_seconds  #TQC-860021
            CALL cl_on_idle()    #TQC-860021
 
         ON ACTION about         #TQC-860021
            CALL cl_about()      #TQC-860021
 
         ON ACTION help          #TQC-860021
            CALL cl_show_help()  #TQC-860021
 
         ON ACTION controlg      #TQC-860021
            CALL cl_cmdask()     #TQC-860021
      END PROMPT                 #TQC-860021
      CALL cl_set_comp_entry("apa20",TRUE)   #TQC-7A0041
      CASE
         WHEN g_chr = '1'
            EXIT WHILE
         WHEN g_chr = '2'
            LET g_hold ='2'
            CALL t110_account_period()
            LET g_hold ='1'
            LET l_hold_amt =0
            SELECT SUM(apc16) INTO l_hold_amt FROM apc_file
             WHERE apc01 =g_apa.apa01
            UPDATE apa_file SET apa20 =l_hold_amt
             WHERE apa01 =g_apa.apa01
            DISPLAY BY NAME g_apa.apa20
            CALL cl_set_comp_entry("apa20",FALSE)
            EXIT WHILE
         WHEN g_chr = '3'
            RETURN
         OTHERWISE #MOD-990200                                                                                                      
             RETURN #MOD-990200      
      END CASE
 
      EXIT WHILE
   END WHILE
 
   IF INT_FLAG THEN
      LET INT_FLAG = 0 RETURN
   END IF
 
 WHILE TRUE
   CALL cl_set_head_visible("","YES")     #No.FUN-6B0033
 
   INPUT BY NAME g_apa.apa19,g_apa.apa20 WITHOUT DEFAULTS
 
      AFTER FIELD apa19
         IF NOT cl_null(g_apa.apa19) THEN
            CALL t110_apa19('a')
            IF NOT cl_null(g_errno) THEN
               CALL cl_err(g_apa.apa19,g_errno,0)
               NEXT FIELD apa19
            END IF
         END IF
 
      AFTER FIELD apa20
         IF NOT cl_null(g_apa.apa20) THEN
            IF g_apa.apa20 > (g_apa.apa34f - g_apa.apa35f) THEN
               CALL cl_err(g_apa.apa20,'aap-150',0)
               NEXT FIELD apa20
            END IF
            SELECT azi04 INTO t_azi04 FROM azi_file 
              WHERE azi01 = g_apa.apa13
            LET g_apa.apa20 = cl_digcut(g_apa.apa20,t_azi04)
            DISPLAY BY NAME g_apa.apa20
         END IF
 
      ON ACTION CONTROLP
         CASE
            WHEN INFIELD(apa19) # Hold code
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_apo"
               LET g_qryparam.default1 = g_apa.apa19
               CALL cl_create_qry() RETURNING g_apa.apa19
               DISPLAY BY NAME g_apa.apa01
               NEXT FIELD apa19
         END CASE
 
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
   END INPUT
 
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      #No.MOD-B90213  -- Mark Begin
      #LET g_apa.apa19 = g_apa_t.apa19
      #DISPLAY BY NAME g_apa.apa19
      #LET g_apa.apa20 = g_apa_t.apa20
      #DISPLAY BY NAME g_apa.apa20
      #No.MOD-B90213  -- Mark End
      RETURN
   END IF
 
   IF cl_null(g_apa.apa19) THEN
      CALL cl_err('','aap-099',1) CONTINUE WHILE
   ELSE EXIT WHILE
   END IF
 END WHILE
 
   LET g_apa_t.apa19 = g_apa.apa19
   LET g_apa_t.apa20 = g_apa.apa20
 
   UPDATE apa_file SET apa19=g_apa.apa19,apa20 = g_apa.apa20
    WHERE apa01 = g_apa.apa01
 
   IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
      CALL cl_err3("upd","apa_file",g_apa.apa01,"",STATUS,"","upd apa:",1)
      RETURN
   END IF
 
   LET l_flag = 'N'            #MOD-AA0187
  #MOD-A30208---add---start---
  #若單頭留置與子帳期留置不相同，將子帳期留置歸零重新計算
   SELECT SUM(apc16) INTO apc16_tot FROM apc_file where apc01 = g_apa.apa01
   IF g_apa.apa20 != apc16_tot THEN
      UPDATE apc_file SET apc16=0 WHERE apc01 = g_apa.apa01
      LET l_flag = 'Y'            #MOD-AA0187
   END IF
   IF l_flag = 'Y' THEN           #MOD-AA0187
     #MOD-A30208---add---end---
      DECLARE t110_apc_hold_cs CURSOR FOR
        SELECT apc02,apc08,apc10,apc16 FROM apc_file WHERE apc01 =g_apa.apa01 ORDER BY apc02
      LET l_apa20 =g_apa.apa20
      FOREACH t110_apc_hold_cs INTO l_apc02,l_apc08,l_apc10,l_apc16
       #MOD-A30208---mark---start---
        #不管apc16有沒有值，一律重新計算
       #IF NOT cl_null(l_apc16) AND l_apc16 !=0 THEN 
       #   CALL cl_err('','aap-920',0)
       #   EXIT FOREACH
       #END IF
       #MOD-A30208---mark---end---
        IF cl_null(l_apc16) THEN 
           LET l_apc16 =0
        END IF
        IF cl_null(g_apa.apa20) THEN 
           LET g_apa.apa20 =0
        END IF
        IF cl_null(g_apa.apa08) THEN 
           LET g_apa.apa08 =0     
        END IF
        IF cl_null(g_apa.apa08) THEN 
           LET g_apa.apa08 =0
        END IF
        IF l_apa20 >=(l_apc08-l_apc10) THEN
           LET l_apc16 =l_apc08-l_apc10
           LET l_apa20 =l_apa20-l_apc16
        ELSE  
           LET l_apc16 =l_apa20
           LET l_apa20 =0
        END IF
        UPDATE apc_file SET apc16 =l_apc16
         WHERE apc01 =g_apa.apa01
           AND apc02 =l_apc02
        IF l_apa20 =0 THEN
           EXIT FOREACH
        END IF           
      END FOREACH
   END IF              #MOD-AA0187
     
 
   LET g_msg = TIME
   INSERT INTO azo_file (azo01,azo02,azo03,azo04,azo05,azo06,azoplant,azolegal)   #MOD-590460 #FUN-980001 add azoplant,azolegal
                 #VALUES('aapt110',g_user,g_today,g_msg,g_apa.apa01,'hold',g_plant,g_legal)  #FUN-980001 add g_plant,g_legal #MOD-AC0328 mark
                  VALUES(g_prog,g_user,g_today,g_msg,g_apa.apa01,'hold',g_plant,g_legal)     #FUN-980001 add g_plant,g_legal #MOD-AC0328 
 
END FUNCTION
#------------------------------------MOD-B70202--------------------------------add
FUNCTION t110_apa14(p_apa01)
 DEFINE l_apb02  LIKE apb_file.apb02,
        l_apb08  LIKE apb_file.apb08,
        l_apb081 LIKE apb_file.apb081,
        l_apb09  LIKE apb_file.apb09,
        l_apb23  LIKE apb_file.apb23,
        l_apb24  LIKE apb_file.apb24,    
        l_apb10  LIKE apb_file.apb10,
        l_apb101 LIKE apb_file.apb101,
        p_apa01  LIKE apa_file.apa01,
        l_apa32  LIKE apa_file.apa32    #No.MOD-B80140 add
 DEFINE g_apk    RECORD LIKE apk_file.*      #MOD-C30916 add

   LET g_apa.apa01=p_apa01

  #str TQC-B80049 add
   LET g_cnt = 0
   SELECT COUNT(*) INTO g_cnt FROM apb_file
    WHERE apb01=g_apa.apa01
   IF cl_null(g_cnt) THEN LET g_cnt=0 END IF
  #end TQC-B80049 add

   IF g_cnt > 0 THEN
      IF NOT cl_confirm('aap-331') THEN
         CALL cl_err('','aap-888',1)
         LET g_apa.apa14 = g_apa_t.apa14
         DISPLAY BY NAME g_apa.apa14
         RETURN FALSE
         END IF
         DECLARE upd_apb_cs CURSOR FOR
            SELECT apb23,apb09,apb02,apb24   #MOD-860221 add apb24
              FROM apb_file
             WHERE apb01=g_apa.apa01
   
         FOREACH upd_apb_cs INTO l_apb23,l_apb09,l_apb02,l_apb24  #MOD-860221 add l_apb24
            LET l_apb08 = l_apb23 * g_apa.apa14
            LET l_apb08 = cl_digcut(l_apb08,g_azi03)   #MOD-6B0066
            LET l_apb10 = l_apb24 * g_apa.apa14   #MOD-860221
            LET l_apb10 = cl_digcut(l_apb10,g_azi04)   #MOD-6B0066
            LET l_apb081= l_apb08
            LET l_apb101= l_apb10
   
            UPDATE apb_file SET apb08 = l_apb08,
                                apb081 = l_apb081,
                                apb10  = l_apb10,
                                apb101 = l_apb101
             WHERE apb01 = g_apa.apa01
               AND apb02 = l_apb02
            IF STATUS OR SQLCA.SQLCODE THEN
               CALL cl_err3("upd","apb_file",g_apa.apa11,l_apb02,SQLCA.sqlcode,"","upd apb:",1)  #No.FU
               LET g_apa.apa14 = g_apa_t.apa14
               DISPLAY BY NAME g_apa.apa14
               RETURN FALSE
               EXIT FOREACH
            END IF
         END FOREACH
        #-------------------------------------MOD-C50228----------------------------(S)
         SELECT SUM(apb24),SUM(apb10) INTO g_amt1f,g_amt1 FROM apb_file
          WHERE apb01 = g_apa.apa01 AND apb29='1'
         IF g_amt1 IS NULL THEN
            LET g_amt1 = 0
            LET g_amt1f = 0
         END IF
         SELECT SUM(apb24),SUM(apb10) INTO g_amt2f,g_amt2 FROM apb_file
          WHERE apb01 = g_apa.apa01 AND apb29 = '3'
         IF g_amt2 IS NULL THEN
            LET g_amt2 = 0
            LET g_amt2f = 0
         END IF
         IF g_aptype MATCHES '1*' AND g_aptype <> '15' AND g_aptype <> '17' THEN
            LET g_apa.apa57 = g_amt1 + g_amt2
            LET g_apa.apa57f = g_amt1f + g_amt2f
         END IF
         IF g_aptype MATCHES '2*' THEN
            LET g_apa.apa57 = g_amt2 + g_amt1
            LET g_apa.apa57f = g_amt2f + g_amt1f
         END IF
         IF g_aptype = '15' OR g_aptype = '17' OR g_aptype = '16' THEN
            SELECT SUM(apb24),SUM(apb10) INTO g_apa.apa57f,g_apa.apa57
             FROM apb_file WHERE apb01 = g_apa.apa01
         END IF
         IF g_apa.apa57f IS NULL THEN
            LET g_apa.apa57f = 0
         END IF
         IF g_apa.apa57  IS NULL THEN
            LET g_apa.apa57 = 0
         END IF
         LET g_apa.apa57f=cl_digcut(g_apa.apa57f,t_azi04)
         LET g_apa.apa57=cl_digcut(g_apa.apa57,g_azi04)
         UPDATE apa_file SET apa57 = g_apa.apa57,
                             apa57f = g_apa.apa57f
          WHERE apa01 = g_apa.apa01
         DISPLAY BY NAME g_apa.apa57
        #-------------------------------------MOD-C50228----------------------------(E)
   
         CALL t110_b_fill(' 1=1')
         CALL t110_sum_apa()
   ELSE
     #雜項帳款有可能沒有單身資料
     IF g_apa.apa00='12' OR g_apa.apa00='15' OR g_apa.apa00='16' OR   #MOD-640473   #MOD-870215 add
        g_apa.apa00='21' OR g_apa.apa00='13' OR g_apa.apa00='17' OR   #MOD-590460   #MOD-640473  #N
        g_apa.apa00='22' OR g_apa.apa00='11' THEN   #MOD-9B0168 add   #yinhy140313 add 11
        LET g_apa.apa31 = g_apa.apa31f * g_apa.apa14
        LET g_apa.apa31 = cl_digcut(g_apa.apa31,g_azi04)   #MOD-6B0066
        LET g_apa.apa32 = g_apa.apa31 * g_apa.apa16 / 100
        CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
        LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add
        LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)   #MOD-6B0066
        DISPLAY BY NAME g_apa.apa31
        DISPLAY BY NAME g_apa.apa32
        CALL t110_apa34f('0')   #TQC-750140
        CALL t110_unpay()
      END IF
   END IF
  #----------------------MOD-C30916-------------------(S)
   DECLARE curr_apk CURSOR FOR
    SELECT * FROM apk_file WHERE apk01 = g_apa.apa01

   FOREACH curr_apk INTO g_apk.*
      LET g_apk.apk13 = g_apa.apa14
      LET g_apk.apk08 = g_apk.apk08f * g_apk.apk13
      LET g_apk.apk07 = g_apk.apk07f * g_apk.apk13
      LET g_apk.apk06 = g_apk.apk07 + g_apk.apk08        #含稅金額

      LET g_apk.apk06 = cl_digcut(g_apk.apk06,g_azi04)
      LET g_apk.apk07 = cl_digcut(g_apk.apk07,g_azi04)
      LET g_apk.apk08 = cl_digcut(g_apk.apk08,g_azi04)

      UPDATE apk_file SET apk13 = g_apa.apa14,
                          apk06 = g_apk.apk06,
                          apk07 = g_apk.apk07,
                          apk08 = g_apk.apk08
       WHERE apk01 = g_apk.apk01
         AND apk02 = g_apk.apk02
         AND apk03 = g_apk.apk03

      IF STATUS OR SQLCA.SQLCODE THEN
         CALL cl_err3("upd","apk_file",g_apk.apk01,g_apk.apk02,SQLCA.sqlcode,"","upd apk",1)
         ROLLBACK WORK
         LET g_apa.* = g_apa_t.*
         RETURN
      END IF
   END FOREACH
  #-------------------------MOD-C30916-----------------------(E)
   RETURN TRUE 
END FUNCTION
#-------------------------------No.MOD-B70202------------------------------------------end 

#----------------------------------------------No.MOD-B80140--------------------------start
FUNCTION t110_apa32()
   DEFINE l_cnt    SMALLINT
   DEFINE t_apa31 LIKE apa_file.apa31
   DEFINE t_apa32 LIKE apa_file.apa32
   DEFINE l_apa32 LIKE apa_file.apa32

   SELECT COUNT(*) INTO l_cnt
     FROM apa_file WHERE apa01 IN (
   SELECT apa08 FROM apv_file,apa_file
    WHERE apv01 = g_apa.apa01 AND apa01 = apv03)
   IF l_cnt > 0 THEN
      LET t_apa31 = 0
      LET t_apa32 = 0
      SELECT SUM(apa31),SUM(apa32) INTO t_apa31,t_apa32
        FROM apa_file WHERE apa01 IN (
      SELECT apa08 FROM apv_file,apa_file
       WHERE apv01 = g_apa.apa01 AND apa01 = apv03 
         AND apa32 > 0)                                    #MOD-C80261 add
      IF cl_null(t_apa31)  THEN LET t_apa31 = 0 END IF
      IF cl_null(t_apa32)  THEN LET t_apa32 = 0 END IF
      LET l_apa32 = g_apa.apa31 * g_apa.apa16 / 100
      LET l_apa32 = cl_digcut(l_apa32,g_azi04)
      #從沖帳資料(aapq230)串回aapt150,看當初立預付是否有稅額,
      #若有的話,l_apa32應再扣掉aapt150的稅額
      IF g_apa.apa31 >= t_apa31  THEN
         LET l_apa32 = l_apa32 - t_apa32
         LET l_apa32 = cl_digcut(l_apa32,g_azi04)
      ELSE
         LET l_apa32 = 0
      END IF
   ELSE
      LET l_apa32 = g_apa.apa32
   END IF
   RETURN l_apa32
END FUNCTION

FUNCTION t110_apa32f()
   DEFINE l_cnt    SMALLINT
   DEFINE t_apa31f LIKE apa_file.apa31f
   DEFINE t_apa32f LIKE apa_file.apa32f
   DEFINE l_apa32f LIKE apa_file.apa32f

   SELECT COUNT(*) INTO l_cnt
     FROM apa_file WHERE apa01 IN (
   SELECT apa08 FROM apv_file,apa_file
    WHERE apv01 = g_apa.apa01 AND apa01 = apv03)

   IF l_cnt > 0 THEN
      LET t_apa31f= 0
      LET t_apa32f= 0
      SELECT SUM(apa31f),SUM(apa32f) INTO t_apa31f,t_apa32f
        FROM apa_file WHERE apa01 IN (
      SELECT apa08 FROM apv_file,apa_file
       WHERE apv01 = g_apa.apa01 AND apa01 = apv03 
         AND apa32f > 0)                                    #MOD-C80261 add
     #IF cl_null(t_apa32f) THEN LET t_apa32f= 0 END IF      #MOD-C80261 mark
      IF cl_null(t_apa31f) THEN LET t_apa31f= 0 END IF      #MOD-C80261 add
      IF cl_null(t_apa32f) THEN LET t_apa32f= 0 END IF
      LET l_apa32f = g_apa.apa31f * g_apa.apa16 / 100
      LET l_apa32f = cl_digcut(l_apa32f,t_azi04)
      #從沖帳資料(aapq230)串回aapt150,看當初立預付是否有稅額,
      #若有的話,l_apa32f應再扣掉aapt150的稅額
      IF g_apa.apa31f >= t_apa31f THEN
         LET l_apa32f= l_apa32f- t_apa32f
         LET l_apa32f = cl_digcut(l_apa32f,t_azi04)
      ELSE
         LET l_apa32f = 0
      END IF
   ELSE
     LET l_apa32f = g_apa.apa32f
   END IF
      RETURN l_apa32f
END FUNCTION
#-----------------------------------No.MOD-B80140------------------------------------end

FUNCTION t110_apa19(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_apo02   LIKE apo_file.apo02
   DEFINE l_apoacti LIKE apo_file.apoacti
 
   LET l_apo02 = ''
   SELECT apo02,apoacti INTO l_apo02,l_apoacti
     FROM apo_file WHERE apo01 = g_apa.apa19
   LET g_errno = ' '
 
   CASE WHEN SQLCA.SQLCODE = 100 LET g_errno = 'aap-003'
        WHEN l_apoacti = 'N'     LET g_errno = '9028'
        WHEN SQLCA.SQLCODE != 0  LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE
 
   DISPLAY l_apo02 TO apo02
 
END FUNCTION
 
FUNCTION t110_apa21(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_gen02   LIKE gen_file.gen02
   DEFINE l_gen03   LIKE gen_file.gen03
   DEFINE l_genacti LIKE gen_file.genacti
 
   LET g_errno = ' '
   SELECT gen02,gen03,genacti INTO l_gen02,l_gen03,l_genacti
     FROM gen_file WHERE gen01 = g_apa.apa21
 
   CASE WHEN SQLCA.SQLCODE = 100 LET g_errno = 'aap-038'
        WHEN l_genacti = 'N'     LET g_errno = '9028'
        WHEN SQLCA.SQLCODE != 0  LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE
 
   DISPLAY l_gen02 TO gen02
   IF p_cmd='d' THEN RETURN END IF
   LET g_apa.apa22 = l_gen03
   DISPLAY BY NAME g_apa.apa22
   IF NOT cl_null(g_errno) THEN RETURN END IF
 
END FUNCTION
 
FUNCTION t110_apa22(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_gem05   LIKE gem_file.gem05
   DEFINE l_gemacti LIKE gem_file.gemacti
   DEFINE l_depno     LIKE apa_file.apa22    #FUN-660117
   DEFINE l_t1        LIKE apy_file.apyslip  # No.FUN-690028 VARCHAR(5)  #FUN-580012
   DEFINE l_d_actno   LIKE apt_file.apt03    #FUN-660117
   DEFINE l_c_actno   LIKE apt_file.apt04    #FUN-660117
   DEFINE l_d_actno1  LIKE apt_file.apt031   #FUN-680029
   DEFINE l_c_actno1  LIKE apt_file.apt041   #FUN-680029
   DEFINE l_gem02     LIKE gem_file.gem02    #FUN-710078 add
   DEFINE l_apt06     LIKE apt_file.apt06    #FUN-9C0041
   DEFINE l_apt061    LIKE apt_file.apt061   #FUN-9C0041 
 
   SELECT gem05,gemacti,gem02 INTO l_gem05,l_gemacti,l_gem02  #FUN-710078 mod
     FROM gem_file WHERE gem01 = g_apa.apa22
 
   LET g_errno = ' '
 
   CASE WHEN SQLCA.SQLCODE = 100 LET g_errno = 'aap-039'
        WHEN l_gemacti = 'N'     LET g_errno = '9028'
        WHEN l_gem05  = 'N'      LET g_errno = 'agl-202'
        WHEN SQLCA.SQLCODE != 0  LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE
 
   DISPLAY l_gem02 TO gem02  #FUN-710078 add
   IF NOT cl_null(g_errno) THEN
      RETURN
   END IF
 
   IF g_apz.apz13 = 'Y' THEN
      LET l_depno = g_apa.apa22
   ELSE
      LET l_depno = ' '
   END IF
 
   SELECT * INTO g_aps.* FROM aps_file WHERE aps01 = l_depno
 
   IF SQLCA.sqlcode THEN
      CALL cl_err3("sel","aps_file",l_depno,"","aap-053","","",1)  #No.FUN-660122
      #FUN-CB0056---add---str
      IF g_apa.apa00 = '15' OR g_apa.apa00 = '16' OR g_apa.apa00 = '26' THEN
         LET g_apa.apa15 = ''
         LET g_apa.apa16 = 0
         DISPLAY  BY NAME g_apa.apa15,g_apa.apa16
      END IF
   ELSE
      IF g_apa.apa00 = '15' THEN
         LET g_apa.apa15 = g_aps.aps03
         SELECT gec04 INTO g_apa.apa16 FROM gec_file
          WHERE gec01 = g_apa.apa15 AND gec011 = '1'
      END IF
      IF g_apa.apa00 = '16' OR g_apa.apa00 = '26' THEN
         LET g_apa.apa15 = g_aps.aps02
         SELECT gec04 INTO g_apa.apa16 FROM gec_file
          WHERE gec01 = g_apa.apa15 AND gec011 = '1'
      END IF
      #FUN-CB0056----add----end
   END IF
   DISPLAY  BY NAME g_apa.apa15,g_apa.apa16     #FUN-CB0056
   LET l_t1 = s_get_doc_no(g_apa.apa01)
   SELECT apydmy6 INTO g_apy.apydmy6 FROM apy_file WHERE apyslip = l_t1
 
   # Genero 修改，若帳款類別還未輸入，先不 default 科目
   IF NOT cl_null(g_apa.apa36) THEN
      SELECT apt03,apt031,apt04,apt041 INTO l_d_actno,l_d_actno1,l_c_actno,l_c_actno1 FROM apt_file          #No.FUN-680029
       WHERE apt01 = g_apa.apa36 AND apt02 = l_depno
      SELECT apt06,apt061 INTO l_apt06,l_apt061 FROM apt_file     #FUN-9C0041
       WHERE apt01 = g_apa.apa36 AND apt02 = l_depno              #FUN-9C0041
      IF SQLCA.sqlcode THEN
         CASE WHEN g_apa.apa00 = '11' LET l_d_actno = g_aps.aps21
                                      LET l_c_actno = g_aps.aps22
                                      LET l_d_actno1= g_aps.aps211          #No.FUN-680029
                                      LET l_c_actno1= g_aps.aps221          #No.FUN-680029
              WHEN g_apa.apa00 = '12' LET l_d_actno = g_aps.aps21
                                      LET l_c_actno = g_aps.aps22
                                      LET l_d_actno1= g_aps.aps211          #No.FUN-680029
                                      LET l_c_actno1= g_aps.aps221          #No.FUN-680029
              WHEN g_apa.apa00 = '15' LET l_d_actno = g_aps.aps12 
                                      LET l_d_actno1= g_aps.aps121          #No.FUN-680029
              WHEN g_apa.apa00 = '21'
                   IF g_aza.aza26='2' AND g_apy.apydmy6='Y' THEN
                      LET l_d_actno = ''
                      LET l_c_actno = ''
                      LET l_d_actno1= ''       #No.FUN-680029
                      LET l_c_actno1= ''       #No.FUN-680029
                   ELSE
                      LET l_d_actno = g_aps.aps41
                      LET l_c_actno = g_aps.aps40
                      LET l_d_actno1= g_aps.aps411      #No.FUN-680029
                      LET l_c_actno1= g_aps.aps401      #No.FUN-680029
                   END IF
              WHEN g_apa.apa00 = '22'
                   IF g_aza.aza26='2' AND g_apy.apydmy6='Y' THEN
                      LET l_d_actno = ''
                      LET l_c_actno = ''
                      LET l_d_actno1= ''       #No.FUN-680029
                      LET l_c_actno1= ''       #No.FUN-680029
                   ELSE
                      LET l_d_actno = g_aps.aps41
                      LET l_c_actno = g_aps.aps40
                      LET l_d_actno1= g_aps.aps411      #No.FUN-680029
                      LET l_c_actno1= g_aps.aps401      #No.FUN-680029
                   END IF
              WHEN g_apa.apa00 = '13' LET l_d_actno = g_aps.aps21
                                      LET l_c_actno = g_aps.aps22
                                      LET l_d_actno1= g_aps.aps211          #No.FUN-680029
                                      LET l_c_actno1= g_aps.aps221          #No.FUN-680029
              WHEN g_apa.apa00 = '17' LET l_d_actno = g_aps.aps12 
                                      LET l_d_actno1= g_aps.aps121          #No.FUN-680029
              OTHERWISE               LET l_d_actno = ''
                                      LET l_c_actno = ''
                                      LET l_d_actno1= ''       #No.FUN-680029
                                      LET l_c_actno1= ''       #No.FUN-680029
         END CASE
      END IF
 
      IF g_aptype[1,1] = '1' OR (g_aza.aza26='2' AND g_apy.apydmy6='Y') THEN  #FUN-580012
         IF g_apa.apa51 IS NULL THEN
            IF g_azw.azw04 = '2' AND (g_apa.apa76 = '2' OR g_apa.apa76 = '3') THEN
              LET g_apa.apa51 = l_apt06
              LET g_apa.apa51 = l_apt061
            ELSE
              LET g_apa.apa51 = l_d_actno
              LET g_apa.apa511= l_d_actno1         #No.FUN-680029
            END IF   #FUN-9C0041
         END IF
         IF g_apa.apa54 IS NULL THEN
            LET g_apa.apa54 = l_c_actno
            LET g_apa.apa541= l_c_actno1         #No.FUN-680029
         END IF
      ELSE
         IF g_apa.apa51 IS NULL THEN
            IF g_azw.azw04 = '2' AND (g_apa.apa76 = '2' OR g_apa.apa76 = '3') THEN
              LET g_apa.apa51 = l_apt06
              LET g_apa.apa51 = l_apt061
            ELSE
              LET g_apa.apa51 = l_c_actno
              LET g_apa.apa511= l_c_actno1         #No.FUN-680029
            END IF   #FUN-9C0041
         END IF
         IF g_apa.apa54 IS NULL THEN
            LET g_apa.apa54 = l_d_actno
            LET g_apa.apa541= l_d_actno1         #No.FUN-680029
         END IF
      END IF
 
      #----- 做預算控管則單頭科目空白, 分錄以單身科目為準
     #IF g_apy.apydmy5='Y' AND g_apa.apa00[1,1]='1' THEN                     #MOD-C70069 mark
      IF g_apy.apydmy5='Y' AND (g_apa.apa00='11' OR g_apa.apa00='12'         #MOD-C70069 add
                            OR g_apa.apa00='13' OR g_apa.apa00='16') THEN    #MOD-C70069 add
         LET g_apa.apa51=' '
         LET g_apa.apa511=' '         #No.FUN-680029
         LET g_a51 = NULL                                                    #MOD-C70069 add
         LET g_a511 = NULL                                                   #MOD-C70069 add
      END IF
   END IF
 
 
   DISPLAY BY NAME g_apa.apa51,g_apa.apa54
   IF g_aza.aza63 ='Y' THEN
      DISPLAY BY NAME g_apa.apa511,g_apa.apa541
   ELSE
      LET g_apa.apa511 =NULL
      LET g_apa.apa541 =NULL
   END IF
 
END FUNCTION
 
FUNCTION t110_apa34f(p_cmd)     #TQC-750140 add p_cmd
   DEFINE p_cmd   LIKE type_file.chr1     #TQC-750140 add
   DEFINE l_cnt   LIKE type_file.num5       #No.FUN-690028 SMALLINT
   DEFINE l_azi04 LIKE azi_file.azi04   #MOD-630089
   DEFINE l_pmb02 LIKE pmb_file.pmb02   #TQC-770027
   DEFINE g_t1    LIKE oay_file.oayslip   #yinhy131213
   DEFINE g_t2    LIKE oay_file.oayslip   #yinhy131213
   DEFINE l_flag  LIKE type_file.chr1     #yinhy131213
   
   #yinhy131213  --Begin
   LET g_t1=s_get_doc_no(g_apa.apa01)
   LET g_t2=g_t1 CLIPPED,'-'
   IF g_t1 = g_apa.apa01 OR g_t2 = g_apa.apa01 THEN
      LET l_flag = 'N'
   ELSE
      LET l_flag = 'Y'
   END IF
   #yinhy131213  --End
   
   SELECT azi04 INTO l_azi04 FROM azi_file WHERE azi01 = g_apa.apa13   #MOD-630089
 
   IF g_aptype MATCHES '1*' THEN
      IF cl_null(g_apa.apa37f) THEN LET g_apa.apa37f = 0 END IF                #No.FUN-690080
      LET g_apa.apa34f= g_apa.apa31f+g_apa.apa32f-g_apa.apa60f-g_apa.apa61f
                                                 -g_apa.apa65f+g_apa.apa37f    #No.FUN-690080
      LET g_apa.apa34f = cl_digcut(g_apa.apa34f,l_azi04)   #MOD-630089
      IF cl_null(g_apa.apa37) THEN LET g_apa.apa37 = 0 END IF                  #No.FUN-690080
      LET g_apa.apa34 = g_apa.apa31 +g_apa.apa32 -g_apa.apa60 -g_apa.apa61
                                                 -g_apa.apa65 +g_apa.apa37     #No.FUN-690080
      LET g_apa.apa34 = cl_digcut(g_apa.apa34,g_azi04)   #MOD-630089   #MOD-6B0066
 
      IF g_apa.apa13 != g_aza.aza17 AND g_apa.apa65 != 0 THEN
         IF cl_null(g_apa.apa37) THEN LET g_apa.apa37 = 0 END IF                  #No.FUN-690080
         LET g_apa.apa31 = g_apa.apa34+g_apa.apa65+g_apa.apa60+g_apa.apa61
                                                  -g_apa.apa32-g_apa.apa37     #No.FUN-690080
         LET g_apa.apa31 = cl_digcut(g_apa.apa31,g_azi04)   #MOD-630089   #MOD-6B0066
         IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
            DISPLAY BY NAME g_apa.apa31
         END IF  #FUN-C80078 add
      END IF
 
   END IF
 
   IF g_aptype MATCHES '2*' THEN
      LET g_apa.apa34f= g_apa.apa31f+g_apa.apa32f
      LET g_apa.apa34f = cl_digcut(g_apa.apa34f,l_azi04)   #MOD-630089
      LET g_apa.apa34 = g_apa.apa31 +g_apa.apa32
      LET g_apa.apa34 = cl_digcut(g_apa.apa34,g_azi04)   #MOD-630089   #MOD-6B0066
   END IF
 
   IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
      DISPLAY BY NAME g_apa.apa34f,g_apa.apa34
   END IF  #FUN-C80078 add
   #IF g_apa.apa00 = '21' OR g_apa.apa00 = '12' OR g_apa.apa00 = '15' OR   #FUN-BC0031 去掉21類型
   IF  g_apa.apa00 = '12' OR g_apa.apa00 = '15' OR                         #FUN-BC003:
      g_apa.apa00 = '16' OR g_apa.apa00 = '13' OR g_apa.apa00 = '17' OR  #No.FUN-690080   #MOD-870215 add 16
      g_apa.apa00 = '26'  THEN                                              #MOD-A10129 add
      LET l_cnt = 0
      SELECT COUNT(*) INTO l_cnt FROM apb_file
        WHERE apb01 = g_apa.apa01
      IF l_cnt = 0 THEN
         LET g_apa.apa57 = g_apa.apa31
         LET g_apa.apa57f = g_apa.apa31f
         IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
            DISPLAY BY NAME g_apa.apa57
         END IF  #FUN-C80078 add
      END IF
   END IF
 
 
   IF g_apa.apa57 > 0 AND (g_apa.apa00 = '11' OR g_apa.apa00 = '21') THEN   #MOD-640549
      IF g_apa.apa56 IS NULL OR g_apa.apa56 <> '5' THEN
         LET g_apa.apa33 = g_apa.apa31 - g_apa.apa57
         LET g_apa.apa33f = g_apa.apa31f - g_apa.apa57f          #No.TQC-7C0049
      END IF
      LET g_apa.apa33 = cl_digcut(g_apa.apa33,g_azi04)   #MOD-630089   #MOD-6B0066
      LET g_apa.apa33f= cl_digcut(g_apa.apa33f,l_azi04)  #No.TQC-7C0049
      IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
         DISPLAY BY NAME g_apa.apa33
      END IF  #FUN-C80078 add
   END IF
  #IF g_apa.apa34f <> g_apa_t.apa34f AND g_apa_t.apa34f > 0 THEN  #CHI-B70013 mark
   IF g_apa.apa34f <> g_apa_t.apa34f THEN                         #CHI-B70013
      CALL t110_unpay()  #MOD-780152 add
      IF p_cmd = '1' THEN  
      	 IF l_flag <> 'N' THEN   #yinhy131213                       
          #重算多帳期資料
            DELETE FROM apc_file
             WHERE apc01 = g_apa.apa01 
            IF SQLCA.sqlcode THEN
               CALL cl_err3("del","apc_file",g_apa.apa01,g_apc_t.apc02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
               RETURN
            END IF
            CALL t110_ins_apc(g_apa.*)
         END IF  #yinhy131213  
      ELSE
        SELECT DISTINCT(pmb02) INTO l_pmb02 FROM pmb_file
         WHERE pmb01 = g_apa.apa11
        IF l_pmb02 = 1 OR cl_null(l_pmb02) THEN   #MOD-810156
        	 IF l_flag <> 'N' THEN   #yinhy131213    
              DELETE FROM apc_file WHERE apc01 = g_apa.apa01
              CALL t110_ins_apc(g_apa.*)
           END IF  #yinhy131213
        ELSE
           IF g_apa.apa35 <> g_apa_t.apa35 OR g_apa.apa35f <> g_apa_t.apa35f THEN
              LET g_sn = 'y'
           END IF
           IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
              CALL t110_account_period()
           END IF  #FUN-C80078 add
           LET g_sn = 'n'
        END IF
      END IF
   END IF
   LET g_apa_t.apa34f = g_apa.apa34f   #CHI-B70013 add
  #--------------------MOD-C50228-----------------(S)
   UPDATE apa_file SET apa33 = g_apa.apa33,
                       apa33f = g_apa.apa33f
    WHERE apa01 = g_apa.apa01
  #--------------------MOD-C50228-----------------(E)
END FUNCTION
 
FUNCTION t110_unpay()
   DEFINE l_unpay1,l_unpay2   LIKE type_file.num20_6     # No.FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_net               LIKE type_file.num20_6     # No.FUN-690028 DEC(20,6)  #FUN-4B0079
 
      LET l_unpay1 = g_apa.apa34f - g_apa.apa35f
      LET l_unpay2 = g_apa.apa34  - g_apa.apa35
      #IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
      #   DISPLAY l_unpay1 TO apa35_uf
      #   DISPLAY l_unpay2 TO apa35_u
      #END IF  #FUN-C80078 add
 
   IF g_apz.apz27 = 'Y' THEN
      SELECT SUM(oox10) INTO l_net FROM oox_file
       WHERE oox00 = 'AP' AND oox03 = g_apa.apa01
      IF cl_null(l_net) THEN
         LET l_net = 0
      END IF
      IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
         DISPLAY l_net TO net
         LET l_unpay2 = l_unpay2 - l_net     #yinhy130729
      END IF  #FUN-C80078 add
   END IF

   IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
      DISPLAY l_unpay1 TO apa35_uf
      DISPLAY l_unpay2 TO apa35_u
   END IF  #FUN-C80078 add
END FUNCTION
 
FUNCTION t110_apa36(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_apr02 LIKE apr_file.apr02
   DEFINE l_apracti   LIKE apr_file.apracti
   DEFINE l_depno     LIKE apa_file.apa22     #FUN-660117
   DEFINE l_d_actno   LIKE apt_file.apt03     #FUN-660117
   DEFINE l_c_actno   LIKE apt_file.apt04     #FUN-660117
   DEFINE l_d_actno1  LIKE apt_file.apt031    #FUN-680029
   DEFINE l_c_actno1  LIKE apt_file.apt041    #FUN-680029
   DEFINE l_apt06     LIKE apt_file.apt06     #FUN-9C0041
   DEFINE l_apt061    LIKE apt_file.apt061    #FUN-9C0041 
   DEFINE l_aptacti   LIKE apt_file.aptacti   #MOD-CC0070 add

   LET g_errno = ' '
   SELECT apr02,apracti INTO l_apr02,l_apracti
     FROM apr_file WHERE apr01 = g_apa.apa36
 
   CASE WHEN SQLCA.SQLCODE = 100 LET g_errno = 'aap-044'
        WHEN l_apracti = 'N' LET g_errno = 'ams-106'
        WHEN SQLCA.SQLCODE != 0  LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE
 
   IF NOT cl_null(g_errno) THEN
      LET l_apr02 = ''
   END IF
 
   DISPLAY l_apr02 TO apr02
 
   IF p_cmd = 'd' THEN
      RETURN
   END IF
 
   IF g_apz.apz13 = 'Y' THEN
      LET l_depno = g_apa.apa22
   ELSE
      LET l_depno = ' '
   END IF
 
   SELECT * INTO g_aps.* FROM aps_file WHERE aps01 = l_depno
   IF SQLCA.sqlcode THEN
     #CALL cl_err3("sel","aps_file",l_depno,"","app-053","","",1)  #No.FUN-660122 #MOD-B30663 mark
      CALL cl_err3("sel","aps_file",l_depno,"","aap-053","","",1)                 #MOD-B30663 
   END IF
 
  #SELECT apt03,apt031,apt04,apt041 INTO l_d_actno,l_d_actno1,l_c_actno,l_c_actno1 FROM apt_file          #No.FUN-680029 #MOD-CC0070 mark 
  #MOD-CC0070 add start -----
   SELECT apt03,apt031,apt04,apt041,apt06,apt061,aptacti 
     INTO l_d_actno,l_d_actno1,l_c_actno,l_c_actno1,l_apt06,l_apt061,l_aptacti
     FROM apt_file
  #MOD-CC0070 add end   -----
    WHERE apt01 = g_apa.apa36 AND apt02 = l_depno
  #-MOD-CC0070-add-
   CASE WHEN SQLCA.SQLCODE = 100 LET g_errno = 'aap-044'
        WHEN l_aptacti = 'N' LET g_errno = 'ams-106'
        WHEN SQLCA.SQLCODE != 0  LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE
  #-MOD-CC0070-end-
  #SELECT apt06,apt061 INTO l_apt06,l_apt061 FROM apt_file     #FUN-9C0041 #MOD-CC0070 mark
  # WHERE apt01 = g_apa.apa36 AND apt02 = l_depno              #FUN-9C0041 #MOD-CC0070 mark
   IF SQLCA.sqlcode THEN
      CASE WHEN g_apa.apa00 = '11' LET l_d_actno = g_aps.aps21
                                   LET l_c_actno = g_aps.aps22
                                   LET l_d_actno1= g_aps.aps211             #No.FUN-680029
                                   LET l_c_actno1= g_aps.aps221             #No.FUN-680029
           WHEN g_apa.apa00 = '12' LET l_d_actno = g_aps.aps21
                                   LET l_c_actno = g_aps.aps22
                                   LET l_d_actno1= g_aps.aps211             #No.FUN-680029      
                                   LET l_c_actno1= g_aps.aps221             #No.FUN-680029
           WHEN g_apa.apa00 = '15' LET l_d_actno = g_aps.aps12
                                   LET l_d_actno1= g_aps.aps121             #No.FUN-680029
           WHEN g_apa.apa00 = '21'
                IF g_aza.aza26='2' AND g_apy.apydmy6='Y' THEN
                   LET l_d_actno = ''
                   LET l_c_actno = ''
                   LET l_d_actno1= ''             #No.FUN-680029
                   LET l_c_actno1= ''             #No.FUN-680029
                ELSE
                   LET l_d_actno = g_aps.aps41
                   LET l_c_actno = g_aps.aps40
                   LET l_d_actno1= g_aps.aps411             #No.FUN-680029
                   LET l_c_actno1= g_aps.aps401             #No.FUN-680029
                END IF
           WHEN g_apa.apa00 = '22'
                IF g_aza.aza26='2' AND g_apy.apydmy6='Y' THEN
                   LET l_d_actno = ''
                   LET l_c_actno = ''
                   LET l_d_actno1= ''             #No.FUN-680029
                   LET l_c_actno1= ''             #No.FUN-680029
                ELSE
                   LET l_d_actno = g_aps.aps41
                   LET l_c_actno = g_aps.aps40
                   LET l_d_actno1= g_aps.aps411             #No.FUN-680029
                   LET l_c_actno1= g_aps.aps401             #No.FUN-680029
                END IF
           WHEN g_apa.apa00 = '13' LET l_d_actno = g_aps.aps21
                                   LET l_c_actno = g_aps.aps22
                                   LET l_d_actno1= g_aps.aps211          #No.FUN-680029
                                   LET l_c_actno1= g_aps.aps221          #No.FUN-680029
           WHEN g_apa.apa00 = '17' LET l_d_actno = g_aps.aps12 
                                   LET l_d_actno1= g_aps.aps121          #No.FUN-680029
           OTHERWISE               LET l_d_actno = ''
                                   LET l_c_actno = ''
                                   LET l_d_actno1= ''             #No.FUN-680029
                                   LET l_c_actno1= ''             #No.FUN-680029
      END CASE
   END IF
 
   #No.+340 010720 by plum 不管是 1*,2* 產生的借貸方均不反轉
   IF g_apa.apa51 IS NULL OR g_apa.apa36 != g_apa_t.apa36
      OR cl_null(g_apa_t.apa36) THEN
      IF g_azw.azw04 = '2' AND (g_apa.apa76 = '2' OR g_apa.apa76 = '3') THEN
         LET g_apa.apa51 = l_apt06
      ELSE
         LET g_apa.apa51 = l_d_actno
      END IF  #FUN-9C0041
   END IF
 
   IF g_apa.apa54 IS NULL OR g_apa.apa36 != g_apa_t.apa36
      OR cl_null(g_apa_t.apa36) THEN
      LET g_apa.apa54 = l_c_actno
   END IF
   IF g_aza.aza63 ='Y' THEN
      IF g_apa.apa511 IS NULL OR g_apa.apa36 != g_apa_t.apa36
         OR cl_null(g_apa_t.apa36) THEN
         IF g_azw.azw04 = '2' AND (g_apa.apa76 = '2' OR g_apa.apa76 = '3') THEN
            LET g_apa.apa511 = l_apt061
         ELSE
            LET g_apa.apa511 = l_d_actno1
         END IF   #FUN-9C0041
      END IF
      IF g_apa.apa541 IS NULL OR g_apa.apa36 != g_apa_t.apa36
         OR cl_null(g_apa_t.apa36) THEN
         LET g_apa.apa541 = l_c_actno1
      END IF
   END IF
   #----- 做預算控管則單頭科目空白, 分錄以單身科目為準
  #IF g_apy.apydmy5='Y' AND g_apa.apa00[1,1]='1' THEN                     #MOD-C70069 mark
   IF g_apy.apydmy5='Y' AND (g_apa.apa00='11' OR g_apa.apa00='12'         #MOD-C70069 add
                         OR g_apa.apa00='13' OR g_apa.apa00='16') THEN    #MOD-C70069 add
      LET g_apa.apa51=' '
      LET g_apa.apa511=' '        #No.FUN-680029
      LET g_a51 = NULL                                                     #MOD-C70069 add
      LET g_a511 = NULL                                                    #MOD-C70069 add
   END IF
   DISPLAY BY NAME g_apa.apa51,g_apa.apa54
   IF g_aza.aza63 ='Y' THEN
      DISPLAY BY NAME g_apa.apa511,g_apa.apa541
   ELSE
      LET g_apa.apa511 =NULL
      LET g_apa.apa541 =NULL
   END IF
  #-------------------------------MOD-C50094----------------------(S)
  #CALL t110_show()   #No.MOD-B40183
   LET g_a51 = NULL
   LET g_a52 = NULL
   LET g_a54 = NULL
   LET g_a511 = NULL
   LET g_a521 = NULL
   LET g_a541 = NULL
   SELECT aag02 INTO g_a51 FROM aag_file
    WHERE aag01 = g_apa.apa51
      AND aag00 = g_bookno1
      AND aagacti = 'Y'
   SELECT aag02 INTO g_a52 FROM aag_file
    WHERE aag01 = g_apa.apa52
      AND aag00 = g_bookno1
      AND aagacti = 'Y'
   SELECT aag02 INTO g_a54 FROM aag_file
    WHERE aag01 = g_apa.apa54
      AND aag00 = g_bookno1
      AND aagacti = 'Y'
   SELECT aag02 INTO g_a511 FROM aag_file
    WHERE aag01 = g_apa.apa511
      AND aag00 = g_bookno2
      AND aagacti = 'Y'
   SELECT aag02 INTO g_a521 FROM aag_file
    WHERE aag01 = g_apa.apa521
      AND aag00 = g_bookno2
      AND aagacti = 'Y'
   SELECT aag02 INTO g_a541 FROM aag_file
    WHERE aag01 = g_apa.apa541
      AND aag00 = g_bookno2
      AND aagacti = 'Y'
   DISPLAY g_a51 TO FORMONLY.a51
   DISPLAY g_a52 TO FORMONLY.a52
   DISPLAY g_a54 TO FORMONLY.a54
   DISPLAY g_a511 TO FORMONLY.a511
   DISPLAY g_a521 TO FORMONLY.a521
   DISPLAY g_a541 TO FORMONLY.a541
  #-------------------------------MOD-C50094----------------------(E)
END FUNCTION
 
FUNCTION t110_apa56()
DEFINE l_msg  LIKE ze_file.ze03     # No.FUN-690028 VARCHAR(30)
 
   IF g_lang != '1' THEN
      CASE WHEN g_apa.apa56 = '0'
              CALL cl_getmsg('aap-282',g_lang) RETURNING l_msg
              DISPLAY l_msg  TO apa56_name
           WHEN g_apa.apa56 = '1'
              CALL cl_getmsg('aap-283',g_lang) RETURNING l_msg
              DISPLAY l_msg  TO apa56_name
           WHEN g_apa.apa56 = '2'
              CALL cl_getmsg('aap-284',g_lang) RETURNING l_msg
              DISPLAY l_msg  TO apa56_name
           WHEN g_apa.apa56 = '3'
              CALL cl_getmsg('aap-285',g_lang) RETURNING l_msg
              DISPLAY l_msg  TO apa56_name
           WHEN g_apa.apa56 = '5'
              CALL cl_getmsg('aap-819',g_lang) RETURNING l_msg
              DISPLAY l_msg  TO apa56_name
           OTHERWISE
              DISPLAY '    ' TO apa56_name
      END CASE
   END IF
 
END FUNCTION
 
FUNCTION t110_q()
 
    LET g_row_count = 0
    LET g_curs_index = 0
    CALL cl_navigator_setting( g_curs_index, g_row_count )
    INITIALIZE g_apa.* TO NULL                  #No.FUN-6A0016
   CALL cl_msg("")                              #FUN-640240
 
   CALL cl_opmsg('q')
   CLEAR FORM
   CALL g_apb.clear()
   CALL g_apk.clear()
   CALL g_apk1.clear()   #MOD-960128 add
   CALL g_api.clear()
   DISPLAY '   ' TO FORMONLY.cnt
 
   CALL t110_cs()
 
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      RETURN
   END IF
 
   CALL cl_msg(" SEARCHING ! ")                              #FUN-640240
 
 
   OPEN t110_cs                            # 從DB產生合乎條件TEMP(0-30秒)
   IF SQLCA.sqlcode THEN
      CALL cl_err('',SQLCA.sqlcode,0)
      INITIALIZE g_apa.* TO NULL
   ELSE
      OPEN t110_count
      FETCH t110_count INTO g_row_count
      DISPLAY g_row_count TO FORMONLY.cnt
      CALL t110_fetch('F')                  # 讀出TEMP第一筆並顯示
      CALL t110_list_fill()   #FUN-CB0080
      #LET g_bp_flag='list'    #FUN-CB0080   #FUN-D60015 mark
   END IF
   CALL cl_msg("")                              #FUN-640240
 
 
END FUNCTION
 
#處理資料的讀取
FUNCTION t110_fetch(p_flag)
DEFINE
   g_t1            LIKE oay_file.oayslip,              #No.FUN-550030  #No.FUN-690028 VARCHAR(05)
   p_flag          LIKE type_file.chr1                  #處理方式  #No.FUN-690028 VARCHAR(1)
#DEFINE   l_sum     LIKE type_file.num10               #FUN-CB0089   #mark by pulf 141226
 DEFINE   l_sum     LIKE type_file.num15_3    #add by pulf 141226
 DEFINE   l_sum1    LIKE type_file.num20_6    #add by lili 170723
 
   CASE p_flag
      WHEN 'N' FETCH NEXT     t110_cs INTO g_apa.apa01
      WHEN 'P' FETCH PREVIOUS t110_cs INTO g_apa.apa01
      WHEN 'F' FETCH FIRST    t110_cs INTO g_apa.apa01
      WHEN 'L' FETCH LAST     t110_cs INTO g_apa.apa01
      WHEN '/'
         IF NOT g_no_ask THEN
            CALL cl_getmsg('fetch',g_lang) RETURNING g_msg
            LET INT_FLAG = 0
            PROMPT g_msg CLIPPED,': ' FOR g_jump
               ON IDLE g_idle_seconds
                  CALL cl_on_idle()
 
               ON ACTION about         #MOD-4C0121
                  CALL cl_about()      #MOD-4C0121
 
               ON ACTION help          #MOD-4C0121
                  CALL cl_show_help()  #MOD-4C0121
 
               ON ACTION controlg      #MOD-4C0121
                  CALL cl_cmdask()     #MOD-4C0121
            END PROMPT
            IF INT_FLAG THEN
               LET INT_FLAG = 0
               EXIT CASE
            END IF
         END IF
         FETCH ABSOLUTE g_jump t110_cs INTO g_apa.apa01
         LET g_no_ask = FALSE
   END CASE
 
   IF SQLCA.sqlcode THEN
      CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)
      INITIALIZE g_apa.* TO NULL  #TQC-6B0105
      RETURN
   ELSE
      CASE p_flag
         WHEN 'F' LET g_curs_index = 1
         WHEN 'P' LET g_curs_index = g_curs_index - 1
         WHEN 'N' LET g_curs_index = g_curs_index + 1
         WHEN 'L' LET g_curs_index = g_row_count
         WHEN '/' LET g_curs_index = g_jump
      END CASE
      DISPLAY g_curs_index TO FORMONLY.idx   #FUN-CB0080 add
      CALL cl_navigator_setting( g_curs_index, g_row_count )
   END IF
   
   #FUN-CB0089---add----str
   IF g_aptype = '11' THEN
      SELECT SUM(apb09) INTO l_sum FROM apb_file WHERE apb01 = g_apa.apa01
      DISPLAY l_sum TO  SUM
      #add by lili 170723 ---s---
      SELECT SUM(apb10) INTO l_sum1 FROM apb_file WHERE apb01 = g_apa.apa01
      DISPLAY l_sum1 TO sum1
      #add by lili 170723 ---e---
   END IF
   #FUN-CB0089---add----end
   SELECT * INTO g_apa.* FROM apa_file WHERE apa01 = g_apa.apa01
   IF SQLCA.sqlcode THEN
      CALL cl_err3("sel","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","",1)  #No.FUN-660122
      INITIALIZE g_apa.* TO NULL
      RETURN
   ELSE                                    #No.FUN-4C0047
      LET g_data_owner = g_apa.apauser     #No.FUN-4C0047
      LET g_data_group = g_apa.apagrup     #No.FUN-4C0047
   END IF
 
   LET g_t1=s_get_doc_no(g_apa.apa01)
 
   SELECT * INTO g_apy.* FROM apy_file WHERE apyslip=g_t1
   CALL t110_bookno()     #No.FUN-730064 
   CALL t110_show()
 
END FUNCTION
 
#將資料顯示在畫面上
FUNCTION t110_show()
   DEFINE l_azp02_1   LIKE azp_file.azp02     #FUN-960141
   DEFINE l_no        LIKE apa_file.apa01     #FUN-D10057 
   DEFINE l_apa101_desc LIKE nma_file.nma02   #FUN-D80071
   DEFINE l_apa102_desc LIKE nmc_file.nmc02   #FUN-D80071

   LET g_apa_t.* = g_apa.*                #保存單頭舊值
 
   IF g_apa.apa00 matches '2*' THEN
      CALL t110_show_ref()
   END IF
     DISPLAY BY NAME g_apa.apaoriu,g_apa.apaorig,
        g_apa.apa01,g_apa.apa02,g_apa.apa05,g_apa.apa06,g_apa.apa07,
        g_apa.apa21,g_apa.apa22,g_apa.apa930,g_apa.apa76,   #g_apa.apaplant, #FUN-960141 add apaplant   #FUN-960141 090824 del apaplant   #FUN-9C0041 add apa76 
        g_apa.apamksg,g_apa.apa42,g_apa.apa41,g_apa.apa79, #FUN-670064             #No.FUN-A40003 add apa79
        g_apa.apa44,g_apa.apa992,g_apa.apa63,g_apa.apa36,g_apa.apa13,g_apa.apa14,  #No.FUN-690090 add apa992
        g_apa.apa08,g_apa.apa77,g_apa.apa15,g_apa.apa16,     #FUN-970108 add apa77
        g_apa.apa11,g_apa.apa12,g_apa.apa24,g_apa.apa64,g_apa.apa55,
        g_apa.apa31f,g_apa.apa32f,g_apa.apa60f,g_apa.apa61f,g_apa.apa65f,g_apa.apa34f,g_apa.apa35f,g_apa.apa37f,   #No.FUN-690080
        g_apa.apa31,g_apa.apa32,g_apa.apa60,g_apa.apa61,g_apa.apa65,g_apa.apa34,g_apa.apa35,g_apa.apa37,   #No.FUN-690080
        g_apa.apa51,g_apa.apa52,g_apa.apa54,g_apa.apa19,g_apa.apa20,
        g_apa.apa56,g_apa.apa33,g_apa.apa66,g_apa.apa25,g_apa.apa100, #FUN-630043
        g_apa.apa101,g_apa.apa102,                                    #No.FUN-690080
        g_apa.apainpd,g_apa.apa99,g_apa.apa57,g_apa.apa511,g_apa.apa521,g_apa.apa541,           #No:8150 add apa99   #No.FUN-680029
        g_apa.apauser,g_apa.apagrup,g_apa.apamodu,g_apa.apadate,g_apa.apaacti,
        g_apa.apaud01,g_apa.apaud02,g_apa.apaud03,g_apa.apaud04,
        g_apa.apaud05,g_apa.apaud06,g_apa.apaud07,g_apa.apaud08,
        g_apa.apaud09,g_apa.apaud10,g_apa.apaud11,g_apa.apaud12,
        g_apa.apaud13,g_apa.apaud14,g_apa.apaud15

#TQC-A30127 --begin-
   IF g_aptype = '23' THEN 
      SELECT apa77 INTO g_apa.apa77 FROM apa_file
       WHERE apa01 = g_apa.apa08 
         AND apa00 = '23'  
      DISPLAY BY NAME g_apa.apa77
   END IF 
#TQC-A30127 --end---

   IF g_aptype = '21' OR g_aptype = '22' OR g_aptype = '26' THEN  #MOD-8C0009
      DISPLAY BY NAME g_apa.apa58
   END IF
 
   SELECT azi03,azi04,azi07 INTO t_azi03,t_azi04,t_azi07     #MOD-6B0066
      FROM azi_file WHERE azi01 = g_apa.apa13   #MOD-6B0066
 
   LET g_pma11 = NULL
   SELECT pma11 INTO g_pma11 FROM pma_file WHERE pma01=g_apa.apa11
   DISPLAY g_pma11 TO pma11
   LET g_msg=NULL
 
# FUN-D80031 ----- mark
#  SELECT pmc03 INTO g_msg FROM pmc_file WHERE pmc01 = g_apa.apa05
#  DISPLAY g_msg TO pmc03
# FUN-D80031 ----- mark
# FUN-D80031 ----- add begin
   # FUN-D80049 add ----------- begin
  #IF g_prog = 'aapq230' OR g_prog = 'aapt150' THEN   #FUN-DA0051 mark
   IF g_aza.aza26 = '2' AND g_apz.apz74 = 'Y' AND                                    #FUN-DA0051  add
      (g_prog = 'aapq230' OR g_prog = 'aapt150' OR g_prog = 'aapq240') THEN          #FUN-DA0051  add
      SELECT occ02 INTO g_msg FROM occ_file WHERE occ01 = g_apa.apa05
      IF cl_null(g_msg) THEN
         SELECT pmc03 INTO g_msg FROM pmc_file WHERE pmc01 = g_apa.apa05
      END IF
   ELSE
   # FUN-D80049 add ----------- end
   IF g_prog = 'aapt140' THEN
      SELECT occ02 INTO g_msg FROM occ_file WHERE occ01 = g_apa.apa05
   ELSE
      SELECT pmc03 INTO g_msg FROM pmc_file WHERE pmc01 = g_apa.apa05
   END IF
   END IF    # FUN-D80049 add
   DISPLAY g_msg TO pmc03
# FUN-D80031 ----- add end
 
   LET g_gem02=NULL
   SELECT gem02 INTO g_gem02  FROM gem_file WHERE gem01 = g_apa.apa22
   DISPLAY g_gem02 TO gem02
 
   LET g_a51=NULL
   LET g_a52=NULL
   LET g_a54=NULL
   LET g_a511 = NULL
   LET g_a521 = NULL
   LET g_a541 = NULL
   SELECT aag02 INTO g_a51 FROM aag_file  WHERE aag01 = g_apa.apa51
                                            AND aag00 = g_bookno1         #No.TQC-770056
                                            AND aagacti = 'Y'             #No.MOD-B70280 add
   SELECT aag02 INTO g_a52 FROM aag_file  WHERE aag01 = g_apa.apa52
                                            AND aag00 = g_bookno1         #No.TQC-770056
                                            AND aagacti = 'Y'             #No.MOD-B70280 add
   SELECT aag02 INTO g_a54 FROM aag_file  WHERE aag01 = g_apa.apa54
                                            AND aag00 = g_bookno1         #No.TQC-770056
                                            AND aagacti = 'Y'             #No.MOD-B70280 add
   SELECT aag02 INTO g_a511 FROM aag_file WHERE aag01 = g_apa.apa511      #No.MOD-7B0009
                                            AND aag00 = g_bookno2         #No.TQC-770056
                                            AND aagacti = 'Y'             #No.MOD-B70280 add
   SELECT aag02 INTO g_a521 FROM aag_file WHERE aag01 = g_apa.apa521      #No.MOD-7B0009
                                            AND aag00 = g_bookno2         #No.TQC-770056
                                            AND aagacti = 'Y'             #No.MOD-B70280 add
   SELECT aag02 INTO g_a541 FROM aag_file WHERE aag01 = g_apa.apa541      #No.MOD-7B0009
                                            AND aag00 = g_bookno2         #No.TQC-770056
                                            AND aagacti = 'Y'             #No.MOD-B70280 add
   DISPLAY g_a51 TO FORMONLY.a51    #No.TQC-770056       
   DISPLAY g_a52 TO FORMONLY.a52    #No.TQC-770056 
   DISPLAY g_a54 TO FORMONLY.a54    #No.TQC-770056 
   DISPLAY g_a511 TO FORMONLY.a511  #No.MOD-7B0009
   DISPLAY g_a521 TO FORMONLY.a521  #No.MOD-7B0009
   DISPLAY g_a541 TO FORMONLY.a541  #No.MOD-7B0009
 
  #FUN-D80071--add--str--
   IF g_aptype='13' THEN
      LET l_apa101_desc=''
      SELECT nma02 INTO l_apa101_desc FROM nma_file WHERE nma01=g_apa.apa101
      DISPLAY l_apa101_desc TO FORMONLY.apa101_desc
      LET l_apa102_desc=''
      SELECT nmc02 INTO l_apa102_desc FROM nmc_file WHERE nmc01=g_apa.apa102
      DISPLAY l_apa102_desc TO FORMONLY.apa102_desc
   END IF
  #FUN-D80071--add--end
   CALL t110_apa19('d')
   CALL t110_apa21('d')
   CALL t110_apa36('d')
   CALL t110_apa56()
   CALL t110_unpay()
   CALL t110_b_fill(g_wc2)
   DISPLAY t110_set_apa930(g_apa.apa930) TO FORMONLY.gem02b #FUN-670064
 
   IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF
   CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,g_apa.apaacti)
   CALL cl_show_fld_cont()                   #No.FUN-550037 hmf
   CALL cl_set_act_visible("entry_sheet,entry_sheet2,
                            T_T_entry_sheet,T_T_entry_sheet2",TRUE)
   IF cl_null(g_apa.apa99) THEN
      CALL cl_set_act_visible("T_T_entry_sheet,T_T_entry_sheet2",FALSE)
      IF g_aza.aza63 = 'N' THEN
         CALL cl_set_act_visible("entry_sheet2",FALSE)  
      END IF
   ELSE
      CALL cl_set_act_visible("entry_sheet,entry_sheet2",FALSE)
      IF g_aza.aza63 = 'N' THEN
         CALL cl_set_act_visible("T_T_entry_sheet2",FALSE)  
      END IF
   END IF  
   #FUN-D10057--add--str--
   IF g_aza.aza26='2' THEN
      LET l_no=' '
      IF g_aptype='15' THEN
         SELECT apa01 INTO l_no FROM apa_file
          WHERE apa00 ='23' AND apa08=g_apa.apa01
      END IF
      IF g_aptype='17' THEN
      SELECT apa01 INTO l_no FROM apa_file
       WHERE apa00 ='25' AND apa08=g_apa.apa01
      END IF
      IF cl_null(l_no) THEN LET l_no=' ' END IF
      DISPLAY l_no TO FORMONLY.no
   END IF
   #FUN-D10057--add--end--
END FUNCTION
 
#--------------------------------------------------------------------#
# Read 相關資料
# modi by canny(980826):apa00 = '2*' 貸抵 ==> 所以就顯示 對應傳票號碼
#                       EX. apa00 = '21' ==> 請款折讓時 apa_file.apa00 = '1*'
#                           折讓單       ==> k.沖帳時   apv_file
#                                        ==> W.抵帳時   apf_file
#                           apa00 = '22' ==> k.沖帳時   apv_file
#                           DM 單        ==> W.抵帳時   apf_file
#                           apa00 = '23' ==> 預付請款時 apa_file.apa00 = '15'
#                           預付單
#                           apa00 = '25' ==> 借款申請時 apa_file.apa00 = '17'     #No.FUN-690080
#                           借款待扺單                                            #No.FUN-690080
#--------------------------------------------------------------------#
FUNCTION t110_show_ref()
   DEFINE f_apa     RECORD LIKE apa_file.*
   DEFINE f_apv     RECORD LIKE apv_file.*
   DEFINE f_apf     RECORD LIKE apf_file.*
   DEFINE f_apg     RECORD LIKE apg_file.*
   DEFINE f_aph     RECORD LIKE aph_file.*
   DEFINE l_sql     STRING                  #MOD-720062  #LIKE type_file.chr1000
   DEFINE l_t1      LIKE apy_file.apyslip   #MOD-8A0212 add
   DEFINE l_apydmy3 LIKE apy_file.apydmy3   #MOD-8A0212 add
 
   LET l_sql = "SELECT * FROM apa_file WHERE apa01 = ? "
   PREPARE show_ref_p1 FROM l_sql
   DECLARE show_ref_c1 CURSOR FOR show_ref_p1
 
   LET l_sql = "SELECT apa_file.* ",
               "  FROM apv_file,apa_file ",
               " WHERE apv03 = ? ",
               "   AND apv01 = apa01 "
 
   PREPARE show_ref_p2   FROM l_sql
   DECLARE show_ref_c2   CURSOR FOR show_ref_p2
 
   LET l_sql = "SELECT apf_file.* ",
               "  FROM apf_file,aph_file ",
               " WHERE aph04 = ? ",
               "   AND apf01 = aph01 "
 
   PREPARE show_ref_p3 FROM l_sql
   DECLARE show_ref_c3 CURSOR FOR show_ref_p3
 
   LET l_t1 = ''   LET l_apydmy3 = ''
   LET l_t1 = s_get_doc_no(g_apa.apa01)
   SELECT apydmy3 INTO l_apydmy3 FROM apy_file WHERE apyslip = l_t1
 
   #折讓處理
   IF g_apa.apa00 = '21' THEN
      IF g_apa.apa58 = '1' THEN                   #請款折讓
         OPEN show_ref_c1 USING g_apa.apa08
         FETCH show_ref_c1 INTO f_apa.*
         IF STATUS THEN
            SLEEP 0
         ELSE
            LET g_apa.apa44 = f_apa.apa44
         END IF
         CLOSE show_ref_c1
      ELSE
         IF l_apydmy3 = 'N' THEN      #yinhy130527
         OPEN show_ref_c2  USING g_apa.apa01
         FETCH show_ref_c2  INTO  f_apa.*
         IF STATUS THEN
            #IF l_apydmy3 = 'N' THEN   #MOD-8A0212 add
               OPEN show_ref_c3  USING g_apa.apa01
               FETCH show_ref_c3  INTO  f_apf.*
               IF STATUS THEN
                  SLEEP 0
               ELSE
                  #no.    若aapt210本身沒有拋轉傳票才 show aapt330所拋的傳票
                  IF cl_null(g_apa.apa44) THEN
                     LET g_apa.apa44 = f_apf.apf44
                  END IF
               END IF
               CLOSE show_ref_c3
           #----------------------MOD-D10087--------------------mark
           #ELSE                               #MOD-8B0164 add
           #   IF cl_null(g_apa.apa44) THEN    #No.MOD-910044
           #      LET g_apa.apa44 = f_apa.apa44   #MOD-8B0164 add
           #   END IF   #No.MOD-910044
           #----------------------MOD-D10087--------------------mark
           # END IF   #MOD-8A0212 add
         ELSE
            IF cl_null(g_apa.apa44) THEN         #No:9383
               LET g_apa.apa44 = f_apa.apa44
            END IF
         END IF
       END IF         #yinhy130527
         CLOSE show_ref_c2
      END IF
   END IF
 
   IF (g_apa.apa00 = '23' OR g_apa.apa00 = '25') THEN     #SE 單 #No.FUN-690080
      OPEN show_ref_c1 USING g_apa.apa08
      FETCH show_ref_c1 INTO f_apa.*
      IF STATUS THEN
         SLEEP 0
      ELSE
         LET g_apa.apa44 = f_apa.apa44
         LET g_apa.apa19 = f_apa.apa19              #TQC-BA0054
         LET g_apa.apa20 = f_apa.apa20              #TQC-BA0054
      END IF
      CLOSE show_ref_c1
   END IF
 
   #IF g_apa.apa00 = '22' THEN                        #DM 單  #yinhy130527
   IF g_apa.apa00 = '22' AND l_apydmy3 = 'N' THEN      #yinhy130527
      OPEN show_ref_c2 USING g_apa.apa01
      FETCH show_ref_c2 INTO f_apa.*
      IF STATUS THEN
         #IF l_apydmy3 = 'N' THEN   #MOD-8A0212 add
            OPEN show_ref_c3 USING g_apa.apa01
            FETCH show_ref_c3 INTO f_apf.*
            IF STATUS THEN
               SLEEP 0
            ELSE
               #no.    若aapt220本身沒有拋轉傳票才 show aapt330所拋的傳票
               IF cl_null(g_apa.apa44) THEN
                  LET g_apa.apa44 = f_apf.apf44
               END IF
            END IF
            CLOSE show_ref_c3
        #----------------------MOD-D10087--------------------mark
        #ELSE                               #MOD-8B0164 add
        #   IF cl_null(g_apa.apa44) THEN  #MOD-920359
        #      LET g_apa.apa44 = f_apa.apa44   #MOD-8B0164 add
        #   END IF   #MOD-920359
        #----------------------MOD-D10087--------------------mark
        # END IF   #MOD-8A0212 add     #yinhy130527 mark
      ELSE 
         IF cl_null(g_apa.apa44) THEN   #MOD-830018
            LET g_apa.apa44 = f_apa.apa44
         END IF   #MOD-830018
      END IF
      CLOSE show_ref_c2
   END IF
   CALL cl_show_fld_cont()                   #No.FUN-550037 hmf
 
END FUNCTION
 
FUNCTION t110_r()
DEFINE l_apv02 LIKE apv_file.apv02,
       l_apv03 LIKE apv_file.apv03,
       l_apv04 LIKE apv_file.apv04,
       l_apv05 LIKE apv_file.apv05,           #No.FUN-680027
       l_apa01 LIKE apa_file.apa01,
       l_apa35 LIKE apa_file.apa35,
       l_apa41 LIKE apa_file.apa41,
       l_apk26 LIKE apk_file.apk26,
       l_apk27 LIKE apk_file.apk27,
       l_n          LIKE type_file.num5,   #No.FUN-690028 SMALLINT
       l_apa14 LIKE apa_file.apa14,   #TQC-6C0044
       l_aph04 LIKE aph_file.aph04,   #TQC-6C0044
       l_aph03 LIKE aph_file.aph03,   #MOD-A20108 add
       l_aph05f LIKE aph_file.aph05f,   #MOD-A20108 add
       l_aph05 LIKE aph_file.aph05    #MOD-A20108 add
DEFINE l_rvv40 LIKE rvv_file.rvv40    #No.TQC-750181
DEFINE only_one   LIKE type_file.chr1  #FUN-CB0054
DEFINE l_wc       STRING               #FUN-CB0054
DEFINE l_apa01_o  LIKE apa_file.apa01  #FUN-CB0054
DEFINE l_flag     LIKE type_file.chr1  #FUN-CB0054
 
   IF s_aapshut(0) THEN
      RETURN
   END IF
 
   IF g_apa.apa01 IS NULL THEN
      CALL cl_err("",-400,0)
      RETURN
   END IF
#FUN-CB0054--add--str--
   LET only_one = '1'
   IF g_aptype='16' OR g_aptype='26' THEN
      OPEN WINDOW t110_r AT 10,11 WITH FORM "aap/42f/aapt110_r"
         ATTRIBUTE (STYLE = g_win_style CLIPPED)
      CALL cl_ui_locale("aapt110_r")

      CALL cl_set_head_visible("","YES")

      INPUT BY NAME only_one WITHOUT DEFAULTS
         AFTER FIELD only_one
            IF NOT cl_null(only_one) THEN
               IF only_one NOT MATCHES "[12]" THEN
                  NEXT FIELD only_one
               END IF
            END IF

         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE INPUT

         ON ACTION about
            CALL cl_about()

         ON ACTION help
            CALL cl_show_help()

         ON ACTION controlg
            CALL cl_cmdask()
      END INPUT

      IF INT_FLAG THEN
         LET INT_FLAG = 0
         CLOSE WINDOW t110_r
         RETURN
      END IF

      IF only_one = '1' THEN
         LET l_wc = " apa01 = '",g_apa.apa01,"' "
      ELSE
         CALL cl_set_head_visible("","YES")
         CONSTRUCT BY NAME l_wc ON apa01,apa02,apa21,apa22,apa06
            BEFORE CONSTRUCT
               CALL cl_qbe_init()
            ON ACTION CONTROLP
               CASE
                  WHEN INFIELD(apa01) #查詢單据
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_apa"
                     LET g_qryparam.arg1 = g_aptype
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa01
                     NEXT FIELD apa01
                  WHEN INFIELD(apa06) #PAY TO VENDOR
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_pmc"
                     LET g_qryparam.default1 = g_apa.apa06
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa06
                     CALL t110_apa06('d')
                  WHEN INFIELD(apa21) # Employee CODE
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_gen"
                     LET g_qryparam.default1 = g_apa.apa21
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa21
                  WHEN INFIELD(apa22) # Dept CODE
                     CALL cl_init_qry_var()
                     LET g_qryparam.state = "c"
                     LET g_qryparam.form ="q_gem"
                     LET g_qryparam.default1 = g_apa.apa22
                     CALL cl_create_qry() RETURNING g_qryparam.multiret
                     DISPLAY g_qryparam.multiret TO apa22
                  OTHERWISE EXIT CASE
               END CASE

            ON IDLE g_idle_seconds
               CALL cl_on_idle()
               CONTINUE CONSTRUCT

            ON ACTION about
               CALL cl_about()

            ON ACTION help
               CALL cl_show_help()

            ON ACTION controlg
               CALL cl_cmdask()

            ON ACTION qbe_select
               CALL cl_qbe_select()

            ON ACTION qbe_save
               CALL cl_qbe_save()
         END CONSTRUCT

         IF INT_FLAG THEN
            LET INT_FLAG=0
            CLOSE WINDOW t110_r
            RETURN
         END IF
      END IF
      CLOSE WINDOW t110_r
   ELSE
      LET l_wc = " apa01 = '",g_apa.apa01,"' "
   END IF
   LET g_success = 'Y'
   CALL s_showmsg_init()
   BEGIN WORK
   CALL t110_lock_cl()
   OPEN t110_cl USING g_apa.apa01
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl r:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF

   FETCH t110_cl INTO g_apa.*               # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
       CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)          #資料被他人LOCK
       RETURN
   END IF

   CALL t110_show()
   LET l_apa01_o=g_apa.apa01
   LET l_flag='N'
   LET g_sql="SELECT * FROM apa_file",
             " WHERE ",l_wc CLIPPED,
             "   AND apa00 = '",g_aptype,"'"
   PREPARE t110_r_pre FROM g_sql
   DECLARE t110_r_cs CURSOR FOR t110_r_pre
   FOREACH t110_r_cs INTO g_apa.*
      IF l_apa01_o=g_apa.apa01 THEN
         LET l_flag='Y'
      END IF
#FUN-CB0054--add--end
  # SELECT * INTO g_apa.* FROM apa_file #FUN-CB0054 mark
  #  WHERE apa01=g_apa.apa01 #FUN-CB0054 mark
 
 
#No.FUN-A40003 --begin
   #FUN-C80078 mod str---
   #IF g_apa.apa79  <> '0'  THEN   #No.FUN-A60024  #No.FUN-A80111
    IF g_apa.apa79 MATCHES '[123]' THEN
   #FUN-C80078 mod end---
       IF only_one='1' THEN   #FUN-CB0054
       CALL cl_err('','aap-829',1) 
       RETURN 
       #FUN-CB0054--add--str--
       ELSE
          CALL s_errmsg('','',g_apa.apa01,'aap-829',1)
          LET g_success='N'
          CONTINUE FOREACH
       END IF
       #FUN-CB0054--add--end
    END IF  
#No.FUN-A40003 --end 

   IF g_apa.apa41 = 'Y' THEN
      IF only_one='1' THEN   #FUN-CB0054
      CALL cl_err('apa41=Y','aap-086',0)
      RETURN
      #FUN-CB0054--add--str--
      ELSE 
         CALL s_errmsg('','',g_apa.apa01,'aap-086',1)
         LET g_success='N'
         CONTINUE FOREACH
      END IF
      #FUN-CB0054--add--end
   END IF
 
   IF g_apa.apa63 matches '[Ss1]' THEN          #FUN-550042
      IF only_one='1' THEN   #FUN-CB0054
       CALL cl_err('','mfg3557',0)
       RETURN
      #FUN-CB0054--add--str--
      ELSE
         CALL s_errmsg('','',g_apa.apa01,'mfg3557',1)
         LET g_success='N'
         CONTINUE FOREACH
      END IF
      #FUN-CB0054--add--end
   END IF

   #add by dengsy 20150914  start
   IF g_apa.apa99  IS NOT NULL  THEN
      IF only_one='1' THEN   #FUN-CB0054
       RETURN
      ELSE
         LET g_success='N'
         CONTINUE FOREACH
    END IF
   END IF 
 #add by dengsy 20150914  end
   IF g_apa.apa42 = 'Y' THEN
      IF only_one='1' THEN   #FUN-CB0054
      CALL cl_err('apa42=Y','aap-165',0)
      RETURN
      #FUN-CB0054--add--str--
      ELSE
         CALL s_errmsg('','',g_apa.apa01,'aap-165',1)
         LET g_success='N'
         CONTINUE FOREACH
      END IF
      #FUN-CB0054--add--end
   END IF
 
   IF g_apa.apa75 = 'Y' THEN
      IF only_one='1' THEN   #FUN-CB0054
      CALL cl_err('apa75=Y','aap-332',0)
      RETURN
      #FUN-CB0054--add--str--
      ELSE
         CALL s_errmsg('','','apa75=Y','aap-332',1)
         LET g_success='N'
         CONTINUE FOREACH
      END IF
      #FUN-CB0054--add--end
   END IF
 
   IF g_apa.apa55 = '1' AND g_apa.apa35 > 0 AND (g_apa.apa34<=g_apa.apa35) THEN
      IF only_one='1' THEN   #FUN-CB0054
      CALL cl_err('unpay<=0','aap-172',0)
      RETURN
      #FUN-CB0054--add--str--
      ELSE
         CALL s_errmsg('','',g_apa.apa01,'aap-172',1)
         LET g_success='N'
         CONTINUE FOREACH
      END IF
      #FUN-CB0054--add--end
   END IF
   IF g_apz.apz27 = 'N' THEN
      IF g_apa.apa55 = '1' AND g_apa.apa35 > 0 AND (g_apa.apa34<=g_apa.apa35) THEN
         IF only_one='1' THEN   #FUN-CB0054
         CALL cl_err('unpay<=0','aap-172',0)
         RETURN
         #FUN-CB0054--add--str--
         ELSE
            CALL s_errmsg('','','unpay<=0','aap-172',1)
            LET g_success='N'
            CONTINUE FOREACH
         END IF
         #FUN-CB0054--add--end
      END IF
   ELSE
      IF g_apa.apa55 = '1' AND g_apa.apa35 > 0 AND (g_apa.apa73<=0) THEN
         IF only_one='1' THEN   #FUN-CB0054
         CALL cl_err('unpay<=0','aap-172',0)
         RETURN
         #FUN-CB0054--add--str--
         ELSE
            CALL s_errmsg('','','unpay<=0','aap-172',1)
            LET g_success='N'
            CONTINUE FOREACH
         END IF
         #FUN-CB0054--add--end
      END IF
   END IF
 
   IF NOT cl_null(g_apa.apa44) THEN   #No.MOD-670056
      IF only_one='1' THEN   #FUN-CB0054 
      #IF NOT s_chkpost(g_apa.apa44,g_apa.apa01) THEN  #FUN-CB0054 mark
      IF NOT s_chkpost(g_apa.apa44,g_apa.apa01,0) THEN #FUN-CB0054 add
         RETURN
      END IF
      #FUN-CB0054--add--str--
      ELSE
         IF NOT s_chkpost(g_apa.apa44,g_apa.apa01,1) THEN
            CONTINUE FOREACH
         END IF
      END IF
      #FUN-CB0054--add--end
   END IF
  #-----TQC-740314--------已有沖暫估資料不可取消確認
   LET l_n=0
   SELECT COUNT(*) INTO l_n FROM api_file
     WHERE api01 = g_apa.apa01 AND api02='2'
    IF l_n > 0 AND g_aptype ='16' THEN
       IF only_one='1' THEN   #FUN-CB0054
       CALL cl_err(g_apa.apa01,'aap-338',0)
       RETURN
       #FUN-CB0054--add--str--
       ELSE
          CALL s_errmsg('','',g_apa.apa01,'aap-338',1)
          LET g_success='N'
          CONTINUE FOREACH
       END IF
       #FUN-CB0054--add--end
    END IF
#FUN-CB0054--mark--str-- 
#   LET g_success = 'Y'
#   BEGIN WORK
#   CALL t110_lock_cl()  #FUN-C80078 add
#   OPEN t110_cl USING g_apa.apa01
#   IF STATUS THEN
#      CALL cl_err("OPEN t110_cl r:", STATUS, 1)
#      CLOSE t110_cl
#      ROLLBACK WORK
#      RETURN
#    END IF
 
#   FETCH t110_cl INTO g_apa.*               # 鎖住將被更改或取消的資料
#   IF SQLCA.sqlcode THEN
#       CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)          #資料被他人LOCK
#       RETURN
#    END IF
 
#    CALL t110_show()

#   IF cl_delh(0,0) THEN                   #確認一下
#       INITIALIZE g_doc.* TO NULL          #No.FUN-9B0098 10/02/24
#       LET g_doc.column1 = "apa01"         #No.FUN-9B0098 10/02/24
#       LET g_doc.value1 = g_apa.apa01      #No.FUN-9B0098 10/02/24
#       CALL cl_del_doc()                #No.FUN-9B0098 10/02/24
#FUN-CB0054--mark--end
#FUN-CB0054--add--str--
   IF g_aptype<>'16' AND g_aptype<>'26' THEN
      IF NOT cl_delh(0,0) THEN RETURN END IF
   END IF
   IF only_one='1' THEN
      INITIALIZE g_doc.* TO NULL
      LET g_doc.column1 = "apa01" 
      LET g_doc.value1 = g_apa.apa01
      CALL cl_del_doc()
   END IF
#FUN-CB0054--add--end
      WHILE TRUE
         MESSAGE 'del apa !'
         IF g_apa.apa00[1,1] = '2' AND g_apa.apa58 = '1' THEN
            DECLARE z10_curs CURSOR FOR
             SELECT apk26,apk27 FROM apk_file
              WHERE apk01 = g_apa.apa01
 
            FOREACH z10_curs INTO l_apk26,l_apk27
               IF l_apk26 IS NULL OR l_apk27 IS NULL THEN
                  IF only_one='1' THEN   #FUN-CB0054
                  CALL cl_err('del apk26:',STATUS,1)
                  #FUN-CB0054--add--str--
                  ELSE
                     CALL s_errmsg('','','del apk26:',STATUS,1)
                  END IF
                  #FUN-CB0054--add--end
                  LET g_success = 'N' EXIT WHILE
               END IF
               UPDATE apb_file SET apb16 = 'N'
                WHERE apb01 = l_apk26 AND apb02 = l_apk27
               IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] = 0 THEN
                  IF only_one='1' THEN   #FUN-CB0054
                  CALL cl_err3("upd","apb_file",l_apk26,l_apk27,SQLCA.sqlcode,"","upd apk16:",1)  #No.FUN-660122
                  #FUN-CB0054--add--str--
                  ELSE
                     LET g_showmsg=l_apk26,'/',l_apk27
                     CALL s_errmsg('apb01,apb02',g_showmsg,'upd apb_file:',SQLCA.sqlcode,1)
                  END IF
                  #FUN-CB0054--add--end
                  LET g_success = 'N' EXIT WHILE
               END IF
            END FOREACH
         END IF
 
         SELECT count(*) into l_n FROM apk_file WHERE apk01 = g_apa.apa01
         IF STATUS THEN
            LET l_n = 0
         END IF
 
         IF l_n IS NULL THEN
            LET l_n = 0
         END IF
 
         IF l_n != 0 THEN
            DELETE FROM apk_file WHERE apk01 = g_apa.apa01
            IF STATUS THEN
               IF only_one='1' THEN   #FUN-CB0054
               CALL cl_err3("del","apk_file",g_apa.apa01,"",SQLCA.sqlcode,"","sel apk:",1)  #No.FUN-660122
               #FUN-CB0054--add--str--
               ELSE
                  CALL s_errmsg('',g_apa.apa01,'del apk:',SQLCA.sqlcode,1)
               END IF
               #FUN-CB0054--add--end
               LET g_success = 'N'
               EXIT WHILE
            END IF
         END IF
 
         ##No.2848 modify 1998/11/24若請款單刪除應Check請款折讓單也應刪除
         IF g_apa.apa00[1,1] = '1' THEN
            SELECT COUNT(*) INTO g_cnt FROM apa_file
             WHERE apa08 = g_apa.apa01
               AND apa58 = '1'
            IF g_cnt > 0 THEN
               DECLARE t110_del_21 CURSOR FOR
                SELECT apa01,apa41 FROM apa_file
                 WHERE apa08 = g_apa.apa01
                   AND apa58 = '1'
 
               FOREACH t110_del_21 INTO l_apa01,l_apa41
                  IF STATUS THEN
                     IF only_one='1' THEN   #FUN-CB0054
                     CALL cl_err('foreach 21',STATUS,0)  
                     #FUN-CB0054--add--str--
                     ELSE
                        CALL s_errmsg('','','foreach 21',STATUS,1)
                     END IF 
                     LET g_success='N'
                     #FUN-CB0054--add--end   
                     EXIT FOREACH
                  END IF
 
                  DELETE FROM apk_file WHERE apk01 = l_apa01
                  IF STATUS OR SQLCA.sqlerrd[3]=0 THEN
                     IF only_one='1' THEN   #FUN-CB0054
                     CALL cl_err3("del","apk_file",l_apa01,"",SQLCA.sqlcode,"","del 2lapk",1)  #No.FUN-660122
                     #FUN-CB0054--add--str--
                     ELSE
                        CALL s_errmsg('',l_apa01,'del 2lapk',SQLCA.sqlcode,1)
                     END IF
                     #FUN-CB0054--add--end
                     LET g_success = 'N'
                     EXIT FOREACH
                  END IF
 
                  DELETE FROM apa_file WHERE apa01 = l_apa01
                  IF STATUS OR SQLCA.sqlerrd[3]=0 THEN
                     IF only_one='1' THEN   #FUN-CB0054
                     CALL cl_err3("del","apa_file",l_apa01,"",SQLCA.sqlcode,"","del 2lapa",1)  #No.FUN-660122
                     #FUN-CB0054--add--str--
                     ELSE
                        CALL s_errmsg('',l_apa01,'del 2lapa',SQLCA.sqlcode,1)
                     END IF
                     #FUN-CB0054--add--end
                     LET g_success = 'N'
                     EXIT FOREACH
                  END IF
 
                  DELETE FROM apc_file WHERE apc01 = l_apa01
                  IF STATUS OR SQLCA.sqlerrd[3]=0 THEN
                     IF only_one='1' THEN   #FUN-CB0054
                     CALL cl_err3("del","apc_file",l_apa01,"",SQLCA.sqlcode,"","del 2lapc",1)  #No.FUN-660122
                     #FUN-CB0054--add--str--
                     ELSE
                        CALL s_errmsg('',l_apa01,'del 2lapc',SQLCA.sqlcode,1)
                     END IF
                     #FUN-CB0054--add--end
                     LET g_success = 'N'
                     EXIT FOREACH
                  END IF
 
                  DELETE FROM apb_file WHERE apb01 = l_apa01
                  IF STATUS OR SQLCA.sqlerrd[3]=0 THEN
                     IF only_one='1' THEN   #FUN-CB0054
                     CALL cl_err3("del","apb_file",l_apa01,"",SQLCA.sqlcode,"","del 2lapb",1)  #No.FUN-660122
                     #FUN-CB0054--add--str--
                     ELSE
                        CALL s_errmsg('',l_apa01,'del 2lapb',SQLCA.sqlcode,1)
                     END IF
                     #FUN-CB0054--add--end
                     LET g_success = 'N'
                     EXIT FOREACH
                  END IF
               END FOREACH
            END IF
         END IF
 
         DELETE FROM apa_file WHERE apa01 = g_apa.apa01
         IF STATUS OR SQLCA.SQLCODE THEN
            IF only_one='1' THEN   #FUN-CB0054
            CALL cl_err3("del","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","del apa:",1)  #No.FUN-660122
            #FUN-CB0054--add--str--
            ELSE
               CALL s_errmsg('',g_apa.apa01,'del apa:',SQLCA.sqlcode,1)
            END IF
            #FUN-CB0054--add--end
            LET g_success = 'N'
            EXIT WHILE
         END IF
 
         MESSAGE 'del npp !'
         DELETE FROM npp_file
          WHERE npp01 = g_apa.apa01
            AND nppsys = 'AP'
            AND npp00 = 1
            AND npp011 = 1
         IF STATUS THEN
            IF only_one='1' THEN   #FUN-CB0054
            CALL cl_err3("del","npp_file",g_apa.apa01,"",STATUS,"","del npp:",1)  #No.FUN-660122
            #FUN-CB0054--add--str--
            ELSE
               CALL s_errmsg('',g_apa.apa01,'del npp:',STATUS,1)
            END IF
            #FUN-CB0054--add--end
            LET g_success = 'N'
            EXIT WHILE
         END IF
 
         MESSAGE 'del npq !'
         DELETE FROM npq_file
          WHERE npq01 = g_apa.apa01
            AND npqsys = 'AP'
            AND npq00 = 1
            AND npq011 = 1
         IF STATUS THEN
            IF only_one='1' THEN   #FUN-CB0054
            CALL cl_err3("del","npq_file",g_apa.apa01,"",STATUS,"","del npq:",1)  #No.FUN-660122
            #FUN-CB0054--add--str--
            ELSE
               CALL s_errmsg('',g_apa.apa01,'del npq:',STATUS,1)
            END IF
            #FUN-CB0054--add--end
            LET g_success = 'N'
            EXIT WHILE
         END IF
 
         #FUN-B40056--add--str--
         DELETE FROM tic_file WHERE tic04 = g_apa.apa01
         #FUN-B40056--add--end--
 
         MESSAGE 'del apd !'
         DELETE FROM apd_file WHERE apd01 = g_apa.apa01
         MESSAGE 'del apc !'
         DELETE FROM apc_file WHERE apc01 = g_apa.apa01
 
         MESSAGE 'del apx !'
         DELETE FROM apx_file WHERE apx01 = g_apa.apa01
 
         MESSAGE 'del api !'
         DELETE FROM api_file WHERE api01 = g_apa.apa01
 
         
         MESSAGE 'del apg !'
         DELETE FROM apg_file WHERE apg01 = g_apa.apa01
         IF STATUS OR SQLCA.SQLCODE THEN
            IF only_one='1' THEN   #FUN-CB0054
            CALL cl_err('del apg:',SQLCA.SQLCODE,1)
            #FUN-CB0054--add--str--
            ELSE
               CALL s_errmsg('','','del apg:',SQLCA.SQLCODE,1)
            END IF
            #FUN-CB0054--add--end
            LET g_success = 'N'
            EXIT WHILE
         END IF

        #No.FUN-CB0048 ---start--- Add
         MESSAGE 'upd rvw !'
         UPDATE rvw_file SET rvw18 = ''
          WHERE rvw18 = g_apa.apa01
        #No.FUN-CB0048 ---end  --- Add 

         DECLARE t110_r_cur CURSOR WITH HOLD FOR
          SELECT apb02,'',apb11,apb29,apb37,apb21,apb22,apb34,'',   #FUN-680110 add '',''  #No.TQC-7B0083   #FUN-9A0093 add apb37
                 apb06,apb07,apb12,apb27, #FUN-630055 add apb31
                #apb09,apb28,apb35,apb36,apb31,'','',apb25,'',apb251,'',apb26,'','','',apb23,apb24,apb08,apb10,apb04,apb05  #MOD-770044   #MOD-7A0124 #TQC-B20109 mark
                #apb09,apb28,apb35,apb36,apb31,'','',apb25,'',apb251,'',apb26,'','','',apb23,apb24,apb08,apb10,  #MOD-770044   #MOD-7A0124  #TQC-B20109 move apb04,apb05
                 apb09,apb28,apb31,'','',apb25,'',apb251,'',apb26,'',apb35,apb36,'','',apb23,apb24,apb08,apb10,  #MOD-C30737 move apb05,apb06
                 apbud01,apbud02,apbud03,apbud04,apbud05,              #TQC-B20109
                 apbud06,apbud07,apbud08,apbud09,apbud10,              #TQC-B20109
                 apbud11,apbud12,apbud13,apbud14,apbud15,apb04,apb05   #TQC-B20109
            FROM apb_file
           WHERE apb01 = g_apa.apa01
           ORDER BY apb02
 
         LET l_ac = 1
         MESSAGE 'foreach apb !'
 
         FOREACH t110_r_cur INTO g_apb[l_ac].*,g_apb04_t,g_apb05_t   #MOD-7A0124
            IF STATUS THEN
               IF only_one='1' THEN   #FUN-CB0054
              CALL cl_err('for apb:',STATUS,1)  
              #FUN-CB0054--add--str--
               ELSE
                  CALL s_errmsg('','','for apb:',STATUS,1)
               END IF
               #FUN-CB0054--add--end 
              LET g_success = 'N'
              EXIT FOREACH
            END IF

            LET g_plant_new = g_apb[l_ac].apb37
            CALL s_gettrandbs()
            LET li_dbs = g_dbs_tra
 
            LET g_apb[l_ac].apb01_unap=t110_set_apb01_unap(g_apb[l_ac].apb21,g_apb[l_ac].apb22,g_apb[l_ac].apb34)
            DISPLAY BY NAME g_apb[l_ac].apb01_unap
 
            MESSAGE 'del apb :',l_ac
           #IF g_apa.apa08 = 'UNAP' THEN                                     #TQC-B70131 mark
            IF g_apa.apa08 = 'UNAP' AND NOT cl_null(g_apb[l_ac].apb21) AND NOT cl_null(g_apb[l_ac].apb22) THEN #TQC-B70131
               #LET l_sql = "UPDATE ",li_dbs CLIPPED,"rvv_file ",
               LET l_sql = "UPDATE ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'), #FUN-A50102
                           "   SET rvv40 = 'N' ",
                           " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
                           "   AND rvv02 = '",g_apb[l_ac].apb22,"' "
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	           CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
               PREPARE upd_rvv40 FROM l_sql
               EXECUTE upd_rvv40 
               IF STATUS THEN
                  IF only_one='1' THEN   #FUN-CB0054
                  CALL cl_err3("upd","rvv_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,STATUS,"","upd rvv40",1)  #No.FUN-660122
                  #FUN-CB0054--add--str--
                  ELSE
                     LET g_showmsg=g_apb[l_ac].apb21,'/',g_apb[l_ac].apb22
                     CALL s_errmsg('apb21,apb22',g_showmsg,'upd rvv40',STATUS,1)
                  END IF
                  #FUN-CB0054--add--end
                  LET g_success='N'
                  EXIT FOREACH
               END IF
            END IF
 
            DELETE FROM apb_file
             WHERE apb01 = g_apa.apa01
               AND apb02 = g_apb[l_ac].apb02
            IF STATUS OR SQLCA.SQLCODE THEN
               IF only_one='1' THEN   #FUN-CB0054
               CALL cl_err3("del","apb_file",g_apa.apa01, g_apb[l_ac].apb02,SQLCA.sqlcode,"","del apb:",1)  #No.FUN-660122
               #FUN-CB0054--add--str--
               ELSE
                  LET g_showmsg=g_apa.apa01,'/',g_apb[l_ac].apb02
                  CALL s_errmsg('apb01,apb02',g_showmsg,'del apb:',SQLCA.sqlcode,1)
               END IF
               #FUN-CB0054--add--end
               LET g_success = 'N'
               EXIT FOREACH
            END IF
            LET g_apb_t.* = g_apb[l_ac].*
 
            MESSAGE 'update body !'
            #CALL t110_bu(0,1) #FUN-CB0054 mark
            #FUN-CB0054--add--str--
            IF only_one='1' THEN
               CALL t110_bu(0,1,0)
            ELSE
               CALL t110_bu(0,1,1)
            END IF
            #FUN-CB0054--add--end
            IF g_success = 'N' THEN
               EXIT FOREACH
            END IF
         END FOREACH
 
         DECLARE t110_r_cur3 CURSOR WITH HOLD FOR
              SELECT aph04,aph03,aph05f,aph05 FROM aph_file WHERE aph01 = g_apa.apa01     #MOD-A20108 add aph03,aph05f,aph05
              AND aph03 IN ('6','7','8','9')   #MOD-740057   #MOD-870194
         MESSAGE 'foreach aph !'
         FOREACH t110_r_cur3 INTO l_aph04,l_aph03,l_aph05f,l_aph05     #MOD-A20108 add l_aph03,l_aph05f,l_aph05
            IF STATUS THEN
               IF only_one='1' THEN   #FUN-CB0054
               CALL cl_err('for aph:',STATUS,1)
               #FUN-CB0054--add--str--
               ELSE
                  CALL s_errmsg('','','for aph:',STATUS,1)
               END IF
               #FUN-CB0054--add--end
               LET g_success = 'N'
               EXIT FOREACH
            END IF
 
            SELECT sum(aph05f),sum(aph05) INTO g_amt1f,g_amt1
              FROM aph_file,apf_file
             WHERE aph04=l_aph04
               AND aph01=apf01
               AND apf41='Y'
               AND aph03 IN ('6','7','8','9')
 
            IF g_amt1f IS NULL THEN
               LET g_amt1f= 0
               LET g_amt1 = 0
            END IF

            #No.MOD-C30061  --Begin #增加退款沖帳金額
            SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
              FROM apg_file,apf_file
             WHERE apg04=l_aph04 AND apg01=apf01 AND apf41='Y'
               #AND apf00='32'                      #MOD-D70039 mark
               AND (apf00='32' OR apf00='36')       #MOD-D70039

            IF g_amt6f IS NULL THEN
               LET g_amt6f = 0
               LET g_amt6 = 0
            END IF
            #No.MOD-C30061  --End
 
            SELECT sum(apv04f),sum(apv04) INTO g_amt2f,g_amt2
              FROM apv_file WHERE apv03=l_aph04
 
            IF g_amt2f IS NULL THEN
               LET g_amt2f= 0
               LET g_amt2 = 0
            END IF
 
            SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
              FROM oob_file,ooa_file
             WHERE oob01 = ooa01
               AND oob06 = l_aph04
               AND oob03 = '2' AND oob04 = '9'
               AND ooaconf = 'Y' #須為已確認
 
            IF cl_null(g_amt3f) THEN
               LET g_amt3f = 0
               LET g_amt3 = 0
            END IF
 
            SELECT SUM(aqb04) INTO g_amt4 FROM aqa_file,aqb_file
             WHERE aqa01 = aqb01 AND aqa04='Y' AND aqaconf = 'Y'
               AND aqb02=l_aph04
            IF cl_null(g_amt4) THEN
               LET g_amt4=0
               LET g_amt4f=0
            END IF
            SELECT apa14 INTO l_apa14 FROM apa_file WHERE apa01=l_aph04
            LET g_amt4f=g_amt4/l_apa14
 
            LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f+g_amt6f  #MOD-C30061 add g_amt6f
            LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt4+g_amt6        #MOD-C30061 add g_amt6
 
            CALL t110_comp_oox(l_aph04) RETURNING g_net
 
            UPDATE apa_file SET apa35f=g_amt1f,
                                apa35 =g_amt1,
                                apa73 =apa34 - g_amt1 + g_net
             WHERE apa01 = l_aph04

           #MOD-A20108---add---start---
           #IF l_aph03 = '8' THEN                               #MOD-A50011 mark
            IF l_aph03 = '6' OR l_aph03 = '7' OR l_aph03 = '8' OR l_aph03 = '9' THEN  #MOD-A50011 add
               IF l_aph05f IS NULL THEN
                  LET l_aph05f= 0
                  LET l_aph05 = 0
               END IF
               UPDATE apc_file SET apc10=apc10-l_aph05f,
                                   apc11=apc11-l_aph05,
                                   apc13=apc13+l_aph05         #MOD-A50011 add
                WHERE apc01=l_aph04
            END IF
           #MOD-A20108---add---end---
 
            IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
               IF only_one='1' THEN   #FUN-CB0054
               CALL cl_err3("upd","apa_file",l_aph04,"",STATUS,"","upd apa:",1)   #MOD-730098
               #FUN-CB0054--add--str--
               ELSE
                   CALL s_errmsg('',l_aph04,'upd apa:',STATUS,1)
               END IF
               #FUN-CB0054--add--end
               LET g_success = 'N'
               EXIT FOREACH
            END IF
         END FOREACH
        #搬到t110_r_cur3後刪除,因為t110_r_cur3會抓aph_file
         MESSAGE 'del aph !'
         DELETE FROM aph_file WHERE aph01 = g_apa.apa01
         IF STATUS OR SQLCA.SQLCODE THEN
            IF only_one='1' THEN   #FUN-CB0054
            CALL cl_err('del aph:',SQLCA.SQLCODE,1)
            #FUN-CB0054--add--str--
            ELSE
                CALL s_errmsg('','','del aph:',SQLCA.SQLCODE,1)
            END IF
            #FUN-CB0054--add--end
            LET g_success = 'N'
            EXIT WHILE
         END IF
 
         DECLARE t110_r_cur2 CURSOR WITH HOLD FOR
              SELECT apv02,apv03,apv04,apv05 FROM apv_file WHERE apv01 = g_apa.apa01    #No.FUN-680027
 
         #MESSAGE 'foreach apv !' #FUN-CB0054 mark
         FOREACH t110_r_cur2 INTO l_apv02,l_apv03,l_apv04,l_apv05      #No.FUN-680027
            IF STATUS THEN
               IF only_one='1' THEN   #FUN-CB0054
               CALL cl_err('for apv:',STATUS,1)  
               #FUN-CB0054--add--str--
               ELSE
                  CALL s_errmsg('','','for apv:',STATUS,1)
               END IF
               #FUN-CB0054--add--end 
               LET g_success = 'N'
               EXIT FOREACH
            END IF
 
            MESSAGE 'del apv !',l_ac
            DELETE FROM apv_file WHERE apv01 = g_apa.apa01 AND apv02 = l_apv02
            IF STATUS OR SQLCA.SQLCODE THEN
               IF only_one='1' THEN   #FUN-CB0054
               CALL cl_err3("del","apv_file",g_apa.apa01,l_apv02,SQLCA.sqlcode,"","del apv:",1)  #No.FUN-660122
               #FUN-CB0054--add--str--
               ELSE
                  LET g_showmsg=g_apa.apa01,'/',l_apv02
                  CALL s_errmsg('apv01,apv02',g_showmsg,'del apv:',SQLCA.sqlcode,1)
               END IF
               #FUN-CB0054--add--end
               LET g_success = 'N' EXIT FOREACH
            END IF
            IF l_apv03 <> 'DIFF' THEN   #MOD-830234
               SELECT sum(aph05f),sum(aph05) INTO g_amt1f,g_amt1
                 FROM aph_file,apf_file
                WHERE aph04=l_apv03
                  AND aph01=apf01
                  AND apf41='Y'
                  AND aph03 IN ('6','7','8','9')
               
               IF g_amt1f IS NULL THEN
                  LET g_amt1f= 0
                  LET g_amt1 = 0
               END IF

               #No.MOD-C30061  --Begin #增加退款沖帳金額
               SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
                 FROM apg_file,apf_file
                WHERE apg04=l_apv03 AND apg01=apf01 AND apf41='Y'
                  #AND apf00='32'                    #MOD-D70039 mark
                  AND (apf00='32' OR apf00='36')     #MOD-D70039

               IF g_amt6f IS NULL THEN
                  LET g_amt6f = 0
                  LET g_amt6 = 0
               END IF
               #No.MOD-C30061  --End
               
               SELECT sum(apv04f),sum(apv04) INTO g_amt2f,g_amt2
                 FROM apv_file WHERE apv03=l_apv03
               
               IF g_amt2f IS NULL THEN
                  LET g_amt2f= 0
                  LET g_amt2 = 0
               END IF
               
               SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                 FROM oob_file,ooa_file
                WHERE oob01 = ooa01
                  AND oob06 = l_apv03
                  AND oob03 = '2' AND oob04 = '9'
                  AND ooaconf = 'Y' #須為已確認
               
               IF cl_null(g_amt3f) THEN
                  LET g_amt3f = 0
                  LET g_amt3 = 0
               END IF
               
               #成本分攤
               SELECT SUM(aqb04) INTO g_amt4 FROM aqa_file,aqb_file
                WHERE aqa01 = aqb01 AND aqa04='Y' AND aqaconf = 'Y'
                  AND aqb02=l_apv03
               IF cl_null(g_amt4) THEN
                  LET g_amt4=0
                  LET g_amt4f=0
               END IF
               SELECT apa14 INTO l_apa14 FROM apa_file WHERE apa01=l_apv03
               LET g_amt4f=g_amt4/l_apa14
               LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f+g_amt6f   #MOD-C30061 add g_amt6
               LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt4+g_amt6         #MOD-C30061 add g_amt6
               
               
               CALL t110_comp_oox(l_apv03) RETURNING g_net
               UPDATE apa_file SET apa35f=g_amt1f,
                                   apa35 =g_amt1,
                                   apa73 =apa34 - g_amt1 + g_net
                WHERE apa01 = l_apv03
               
               IF STATUS OR SQLCA.SQLERRD[3]=0  THEN   #MOD-730098
                  IF only_one='1' THEN   #FUN-CB0054
                  CALL cl_err3("upd","apa_file",l_apv03,"",SQLCA.sqlcode,"","upd apa:",1)  #No.FUN-660122
                  #FUN-CB0054--add--str--
                  ELSE
                     LET g_showmsg=l_apv03
                     CALL s_errmsg('apa01',g_showmsg,'upd apa:',SQLCA.sqlcode,1)
                  END IF
                  #FUN-CB0054--add--end
                  LET g_success = 'N'
                  EXIT FOREACH
               END IF
               SELECT sum(aph05f),sum(aph05) INTO g_amt1f,g_amt1
                 FROM aph_file,apf_file
                WHERE aph04=l_apv03
                  AND aph01=apf01
                  AND apf41='Y'
                  AND aph03 IN ('6','7','8','9')
                  AND aph17 = 1                  #No.TQC-6B0066
               
               IF g_amt1f IS NULL THEN
                  LET g_amt1f= 0
                  LET g_amt1 = 0
               END IF
               #No.MOD-C30061  --Begin #增加退款沖帳金額
               SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
                 FROM apg_file,apf_file
                WHERE apg04=l_apv03 AND apg01=apf01 AND apf41='Y'
                  #AND apf00='32'                    #MOD-D70039
                  AND (apf00='32' OR apf00='36')     #MOD-D70039

               IF g_amt6f IS NULL THEN
                  LET g_amt6f = 0
                  LET g_amt6 = 0
               END IF
               #No.MOD-C30061  --End
               
               SELECT sum(apv04f),sum(apv04) INTO g_amt2f,g_amt2
                 FROM apv_file WHERE apv03=l_apv03
                                 AND apv05 = l_apv05
               
               IF g_amt2f IS NULL THEN
                  LET g_amt2f= 0
                  LET g_amt2 = 0
               END IF
               
               SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                 FROM oob_file,ooa_file
                WHERE oob01 = ooa01
                  AND oob06 = l_apv03
                  AND oob03 = '2' AND oob04 = '9'
                  AND ooaconf = 'Y' #須為已確認
                  AND oob19 = 1               #No.TQC-6B0066
               
               IF cl_null(g_amt3f) THEN
                  LET g_amt3f = 0
                  LET g_amt3 = 0
               END IF
               
               LET g_amt1f = g_amt1f + g_amt3f + g_amt2f+g_amt6f   #MOD-C30061 add g_amt6f
               LET g_amt1  = g_amt1  + g_amt3 + g_amt2+g_amt6      #MOD-C30061 add g_amt6
               CALL t110_comp_oox(l_apv03) RETURNING g_net
               UPDATE apc_file SET apc10 =g_amt1f,
                                   apc11 =g_amt1,
                                   apc13 =apc09 - g_amt1 + g_net
                WHERE apc01 = l_apv03
                  AND apc02 = 1              #No.TQC-6B0066
               
               IF STATUS OR SQLCA.SQLCODE THEN
                  IF only_one='1' THEN   #FUN-CB0054
                  CALL cl_err3("upd","apc_file",l_apv03,"",SQLCA.sqlcode,"","upd apc:",1)
                  #FUN-CB0054--add--str--
                  ELSE
                     LET g_showmsg=l_apv03
                     CALL s_errmsg('apc01',g_showmsg,'upd apc:',SQLCA.sqlcode,1)
                  END IF
                  #FUN-CB0054--add--end
                  LET g_success = 'N'
                  EXIT FOREACH
               END IF
            END IF   #MOD-830234
 
            IF g_success = 'N' THEN
               EXIT FOREACH
            END IF
 
         END FOREACH
         EXIT WHILE
      END WHILE
 #FUN-CB0054--add--str--
      LET g_msg = TIME
      INSERT INTO azo_file (azo01,azo02,azo03,azo04,azo05,azo06,azoplant,azolegal) 
      VALUES(g_prog,g_user,g_today,g_msg,g_apa.apa01,'delete',g_plant,g_legal)
      IF g_success='Y' THEN
         CALL cl_flow_notify(g_apa.apa01,'D')
      END IF
   END FOREACH
   CALL s_showmsg()
#FUN-CB0054--add--end
      IF g_success='Y' THEN
         #LET l_apa01=g_apa.apa01   #MOD-910197 add #FUN-CB0054 mark
         COMMIT WORK                #MOD-D80028
         INITIALIZE g_apa.* TO NULL
         CLEAR FORM
         CALL g_apb.clear()
         CALL g_apk.clear()
         CALL g_api.clear()
        
         OPEN t110_count
         #FUN-B40096 add
         IF STATUS THEN
            CLOSE t110_count
            RETURN
         END IF
         #FUN-B40096 add--end
         FETCH t110_count INTO g_row_count
         #FUN-B40096 add
         IF STATUS THEN
            CLOSE t110_count
            RETURN
         END IF
         #FUN-B40096 add--end
         DISPLAY g_row_count TO FORMONLY.cnt
         OPEN t110_cs
         IF only_one='1' THEN  #FUN-CB0054 add
         IF g_curs_index = g_row_count + 1 THEN
            LET g_jump = g_row_count
            CALL t110_fetch('L')
         ELSE
            LET g_jump = g_curs_index
            LET g_no_ask = TRUE
            CALL t110_fetch('/')
         END IF
         #FUN-CB0054--add--str--
         ELSE
            IF l_flag='Y' THEN
               CALL t110_fetch('F')
            END IF
         END IF
         #FUN-CB0054--add--end
      END IF
#FUN-CB0054--mark--str--  
#   END IF
#   LET g_msg = TIME
#   INSERT INTO azo_file (azo01,azo02,azo03,azo04,azo05,azo06,azoplant,azolegal) #FUN-980001 add azoplant,azolegal
#      #VALUES('aapt110',g_user,g_today,g_msg,l_apa01,'delete',g_plant,g_legal)      #MOD-910197 #FUN-980001 add g_plant,g_legal #MOD-AC0328 mark
#       VALUES(g_prog,g_user,g_today,g_msg,l_apa01,'delete',g_plant,g_legal)      #MOD-910197 #FUN-980001 add g_plant,g_legal    #MOD-AC0328
#FUN-CB0054--mark--end 
   IF g_success = 'Y' THEN
      COMMIT WORK
      #CALL cl_flow_notify(g_apa.apa01,'D') #FUN-CB0054 mark
   ELSE
      ROLLBACK WORK
   END IF
 
   CLOSE t110_cl
 
END FUNCTION
 
FUNCTION t110_b(p_code)
DEFINE p_code          LIKE type_file.chr1,    # No.FUN-690028 VARCHAR(01),
       l_ac_t          LIKE type_file.num5,    #未取消的ARRAY CNT  #No.FUN-690028 SMALLINT
       l_vendor        LIKE rvv_file.rvv06,    #FUN-660117 #CHAR(10)
       l_message       LIKE type_file.chr1000, # No.FUN-690028 VARCHAR(70),
       l_n             LIKE type_file.num5,    #檢查重複用  #No.FUN-690028 SMALLINT
       l_n1            LIKE type_file.num5,    #No.FUN-8A0075
       l_lock_sw       LIKE type_file.chr1,    #單身鎖住否  #No.FUN-690028 VARCHAR(1)
       p_cmd           LIKE type_file.chr1,    #處理狀態  #No.FUN-690028 VARCHAR(1)
       apb10_o         LIKE apb_file.apb10,    #FUN-4B0079
       l_cnt           LIKE type_file.num5,    #No.FUN-690028 SMALLINT
       g_apk           RECORD LIKE apk_file.*,
       g_t1            LIKE oay_file.oayslip,  #No.FUN-550030  #No.FUN-690028 VARCHAR(5)
       l_apa06         LIKE apa_file.apa06,
       l_smy59         LIKE smy_file.smy59,
       l_pmn67         LIKE pmn_file.pmn67,
       l_pmn40         LIKE pmn_file.pmn40,
       l_rvv38         LIKE rvv_file.rvv38,
       l_rvv38t        LIKE rvv_file.rvv38t, #TQC-8A0079 add
       l_qty1          LIKE apb_file.apb09,  #No.MOD-940329
       l_qty2          LIKE apb_file.apb09,  #No.MOD-940329
       l_pmn31t        LIKE pmn_file.pmn31t, #MOD-970049 add
       l_pmn87_pmn31t  LIKE pmn_file.pmn31t, #MOD-9A0032 add
       l_allow_insert  LIKE type_file.num5,  #可新增否  #No.FUN-690028 SMALLINT
       l_allow_delete  LIKE type_file.num5,  #可刪除否  #No.FUN-690028 SMALLINT
       l_azi04         LIKE azi_file.azi04,
       l_aag05         LIKE aag_file.aag05,  #No.MOD-530422
       l_apa63         LIKE apa_file.apa63,  #FUN-550042
       l_rvv32         LIKE rvv_file.rvv32,  #TQC-5B0016
       l_rvv33         LIKE rvv_file.rvv33,  #TQC-5B0016
       l_apb10         LIKE apb_file.apb10,  #No.TQC-7B0083
       l_apb24         LIKE apb_file.apb24,  #No.TQC-7B0083
       l_apk01         LIKE apk_file.apk01,  #MOD-850114 add
       l_pjb09         LIKE pjb_file.pjb09,  #No.FUN-850027 
       l_pjb11         LIKE pjb_file.pjb11,  #No.FUN-850027
       l_exit_sw       LIKE type_file.chr1,  #MOD-860303 add
       l_pmc913        LIKE pmc_file.pmc913, #No.FUN-880094
       l_pmn87         LIKE pmn_file.pmn87,  #No.FUN-880094
       l_pmn31         LIKE pmn_file.pmn31,  #No.FUN-880094
       l_gec04         LIKE gec_file.gec04,  #TQC-8A0079 add
       l_gec07         LIKE gec_file.gec07,  #TQC-8A0079 add
       l_apb24t        LIKE apb_file.apb24,  #MOD-920013 add
       l_pmm43         LIKE pmm_file.pmm43,
       l_apb           DYNAMIC ARRAY OF RECORD
          apb06        LIKE apb_file.apb06,
          apb10        LIKE apb_file.apb10,
          apb24        LIKE apb_file.apb24
                       END RECORD,
       l_gec05         LIKE gec_file.gec05,  #MOD-950138
       l_apa14         LIKE apa_file.apa14,  #MOD-960328 add
       l_apa31f        LIKE apa_file.apa31f, #MOD-980032 add 
       l_pmm40         LIKE pmm_file.pmm40,  #MOD-980032 add 
       l_pmm40t        LIKE pmm_file.pmm40t, #CHI-9C0015 add 
       l_sql           STRING,               #FUN-9A0093 
       l_apb01         LIKE apb_file.apb01,  #MOD-9B0048 add
       l_apa31f0       LIKE apa_file.apa31f, #MOD-9B0048 add 
       l_rvu21         LIKE rvu_file.rvu21,  #FUN-9C0041
       l_apb09_15      LIKE apb_file.apb09,  #CHI-B70013 add
       l_apa32         LIKE apa_file.apa32   #MOD-B80140 add
DEFINE l_aagacti       LIKE aag_file.aagacti #No.TQC-B90213
#No.MOD-A20009 --begin                                                          
DEFINE l_year    LIKE type_file.num5                                            
DEFINE l_month   LIKE type_file.num5                                            
#No.MOD-A20009 --end
DEFINE l_apa32f  LIKE apa_file.apa32f        #MOD-A80052   
DEFINE l_err     STRING,      #MOD-A20113 add
       #-----MOD-A40078---------
       l_rvu99    LIKE rvu_file.rvu99,
       l_rvu99_1  STRING,
       i,j        INTEGER,
       l_poz19    LIKE poz_file.poz19,
       l_poz18    LIKE poz_file.poz18 
       #-----END MOD-A40078-----
DEFINE l_change    LIKE type_file.chr1     #No.MOD-B80053 add 是否有新增、修改、刪除的動作
DEFINE l_flag      LIKE type_file.chr1     #FUN-910088--add--
DEFINE l_diffamt   LIKE api_file.api05     #MOD-C20104
DEFINE l_chkamt    LIKE apa_file.apa34f    #MOD-C20104
DEFINE l_apa73     LIKE apa_file.apa73     #MOD-C20104
DEFINE l_api03     LIKE api_file.api03     #MOD-C20104
DEFINE l_api26     LIKE api_file.api26     #MOD-C20104
DEFINE l_sumapi05f LIKE api_file.api05f    #MOD-C20104
DEFINE l_sumapi05  LIKE api_file.api05     #MOD-C20104
DEFINE l_pmn87_pmn31t_2  LIKE pmn_file.pmn31t  #FUN-BC0017
DEFINE l_apk06     LIKE apk_file.apk06     #MOD-C50035 add
DEFINE l_apk08     LIKE apk_file.apk08     #MOD-C50076 add
DEFINE l_sum_rvv87 LIKE rvv_file.rvv87     #TQC-C60241  add
DEFINE l_sum_apb09 LIKE apb_file.apb09     #TQC-C60241  add
DEFINE l_apb09     LIKE apb_file.apb09     #TQC-C60241  add
#DEFINE l_sum       LIKE type_file.num10    #FUN-CB0089   #mark by pulf 141226
DEFINE l_sum       LIKE type_file.num15_3    #add by pulf 141226
DEFINE l_sum1      LIKE type_file.num20_6  #add by lili 170723
DEFINE l_amt1      LIKE type_file.num20_6  #MOD-CB0133 add
DEFINE l_amt2      LIKE type_file.num20_6  #MOD-CB0133 add

    LET g_action_choice = ""
    IF s_aapshut(0) THEN
       RETURN
    END IF
 
    IF g_apb_sarrno = 0 THEN
       RETURN
    ELSE
#       CALL t110_b_fill(' 1=1')
       CALL t110_b_fill(g_wc2)    #No.MOD-AC0130
    END IF
 
    IF g_apa.apa01 IS NULL THEN
       RETURN
    END IF
#No.FUN-A40003 --begin
    SELECT apa79 INTO g_apa.apa79 FROM apa_file WHERE apa01 =g_apa.apa01
   #FUN-C80078 mod str---
   #IF g_apa.apa79  <> '0'  THEN   #No.FUN-A60024  #No.FUN-A80111
    IF g_apa.apa79 MATCHES '[123]' THEN
   #FUN-C80078 mod end---
       CALL cl_err('','aap-829',1) 
       RETURN 
    END IF  
#No.FUN-A40003 --end 
   #------------------------MOD-C50076---------------------(S)
    SELECT gec05,gec07 INTO l_gec05,l_gec07
      FROM gec_file
     WHERE gec01 = g_apa.apa15
       AND gec011 = '1'
   #------------------------MOD-C50076---------------------(S)
    IF g_apa.apa63 matches '[Ss]' THEN
       SELECT count(*) INTO l_n1 FROM apb_file WHERE apb01=g_apa.apa01
       IF l_n1 = 0 THEN
          RETURN
       END IF
       CALL cl_err(g_apa.apa63,'apm-030',0)  #MOD-BB0304
       RETURN                                #MOD-BB0304
    END IF
 
    SELECT * INTO g_apa.* FROM apa_file WHERE apa01=g_apa.apa01
    LET l_apa63 = g_apa.apa63              #FUN-550042
 
    IF g_apa.apa41 = 'Y' THEN
       CALL cl_err('apa41=Y','aap-086',0)
       RETURN
    END IF
    IF g_apa.apa42 = 'Y' THEN
       CALL cl_err('apa42=Y','aap-165',0)
       RETURN
    END IF

    #add by dengsy 20150914  start
    IF g_apa.apa99  IS NOT NULL  THEN
       RETURN
    END IF
  #add by dengsy 20150914 end
    IF g_apa.apa75 = 'Y' THEN
       CALL cl_err('apa75=Y','aap-333',0)
       RETURN
    END IF
 
    IF g_apz.apz27 = 'N' THEN
       IF g_apa.apa55='1' AND g_apa.apa35>0 AND (g_apa.apa34<=g_apa.apa35) THEN
          CALL cl_err('unpay<=0','aap-172',0)
          RETURN
       END IF
    ELSE
       IF g_apa.apa55='1' AND g_apa.apa35>0 AND (g_apa.apa73<=0) THEN
          CALL cl_err('unpay<=0','aap-172',0)
          RETURN
       END IF
    END IF
 
    IF NOT cl_null(g_apa.apa44) THEN   #No.MOD-670056
       #IF NOT s_chkpost(g_apa.apa44,g_apa.apa01) THEN  #FUN-CB0054 mark
       IF NOT s_chkpost(g_apa.apa44,g_apa.apa01,0) THEN #FUN-CB0054 add
          RETURN
       END IF
    END IF
 
    IF g_apa.apa00='21' THEN
       IF NOT cl_null(g_apa.apa08) THEN
          SELECT COUNT(*) INTO l_n FROM apb_file
           WHERE apb01=g_apa.apa08 AND apb16='Y'
          IF l_n > 0 THEN
             CALL cl_err(g_apa.apa08,'aap-289',0)
             RETURN
          END IF
       END IF
    END IF
   #-MOD-A90181-add-
    SELECT pmc913 INTO l_pmc913 FROM pmc_file 
     WHERE pmc01 = g_apa.apa05
   #-MOD-A90181-end-
 
    CALL cl_opmsg('b')
   
    LET g_forupd_sql = "SELECT apb02,apb33,apb11,apb29,apb37,apb21,apb22,apb34,'',apb06,apb07,",           #FUN-630055 add apb31 #No.FUN-690080  #No.TQC-7B0083   #FUN-9A0093 add apb37
                       #"       apb12,apb27,apb09,apb28,apb35,apb36,apb31,apb32,'',apb25,'',apb251,'',apb26,'',apb930,'',apb23, ",  #FUN-710078 '','',''  #FUN-670064  #No.FUN-680029 #No.FUN-690080  #No.FUN-830161 remove apb30  #FUN-990025 add ''#MOD-C30737 mark--
                       "       apb12,apb27,apb09,apb28,apb31,apb32,'',apb25,'',apb251,'',apb26,'',apb35,apb36,apb930,'',apb23, ", #MOD-C30737 move apb35,apb36
                       "       apb24,apb08,apb10,",
                       "       apbud01,apbud02,apbud03,apbud04,apbud05,",
                       "       apbud06,apbud07,apbud08,apbud09,apbud10,",
                       "       apbud11,apbud12,apbud13,apbud14,apbud15 ",
                       "      ,apb04,apb05",   #MOD-940358 mod
                       "  FROM apb_file",                  
                       " WHERE apb01=? AND apb02=? FOR UPDATE"
    LET g_forupd_sql = cl_forupd_sql(g_forupd_sql)
    DECLARE t110_bcl CURSOR FROM g_forupd_sql      # LOCK CURSOR            
 
    LET g_apa.apamodu=g_user
    LET g_apa.apadate=g_today
    DISPLAY BY NAME g_apa.apamodu,g_apa.apadate
    IF g_apa.apa63 NOT matches '[Ss]' THEN   #No.FUN-8A0075 
       LET l_allow_insert = cl_detail_input_auth("insert")
       LET l_allow_delete = cl_detail_input_auth("delete")
    ELSE
       LET l_allow_insert = FALSE            #No.FUN-8A0075
       LET l_allow_delete = FALSE            #No;FUN-8A0075
    END IF 
    LET l_change = 'N'                       #No.MOD-B80053 add
 
  WHILE TRUE                                       #MOD-550063
    LET l_exit_sw = 'y'   #MOD-860303 add
    INPUT ARRAY g_apb WITHOUT DEFAULTS FROM s_apb.*
          ATTRIBUTE(COUNT=g_rec_b,MAXCOUNT=g_max_rec,UNBUFFERED,
                    INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)
 
        BEFORE INPUT
           IF g_rec_b != 0 THEN
              CALL fgl_set_arr_curr(l_ac)
           END IF
 
           IF NOT (g_aza.aza26 = '2' AND g_aza.aza46 = 'Y') THEN   #No.FUN-580006
              CALL cl_set_act_visible("enter_invoice",FALSE)
           END IF
 
        BEFORE ROW
           LET p_cmd=''
           LET l_ac = ARR_CURR()
           LET l_lock_sw = 'N'            #DEFAULT
           LET l_n  = ARR_COUNT()
           LET g_success = 'Y'
           LET l_sum=0          #FUN-CB0089
           LET l_sum1 = 0    #add by lili 170723
           BEGIN WORK
           CALL t110_lock_cl()  #FUN-C80078 add
           OPEN t110_cl USING g_apa.apa01
           IF STATUS THEN
              CALL cl_err("OPEN t110_cl b:", STATUS, 1)
              CLOSE t110_cl
              ROLLBACK WORK
              RETURN
           END IF
           FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
           IF SQLCA.sqlcode THEN
              CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
              CLOSE t110_cl
              ROLLBACK WORK
              RETURN
           END IF
           IF g_rec_b >= l_ac THEN
              LET p_cmd='u'
              LET g_apb_t.* = g_apb[l_ac].*  #BACKUP
              LET g_apb28_t = g_apb[l_ac].apb28    #FUN-910088--add--
              OPEN t110_bcl USING g_apa.apa01,g_apb_t.apb02
              IF STATUS THEN
                 CALL cl_err("OPEN t110_bcl:", STATUS, 1)
                 LET l_lock_sw = "Y"
              END IF
              FETCH t110_bcl INTO g_apb[l_ac].*,g_apb04,g_apb05
              IF SQLCA.sqlcode THEN
                 CALL cl_err(g_apb_t.apb02,SQLCA.sqlcode,1)
                 LET l_lock_sw = "Y"
              END IF
 
              LET g_plant_new = g_apb[l_ac].apb37
              CALL s_gettrandbs()
              LET li_dbs = g_dbs_tra
              #LET l_sql = "SELECT aag02 FROM ",li_dbs CLIPPED,"aag_file ",
              LET l_sql = "SELECT aag02 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'aag_file'),        #FUN-A50102
                          " WHERE aag01='",g_apb[l_ac].apb25,"' ",
                          "   AND aag00='",g_bookno1,"' ",
                          "   AND aagacti = 'Y'"                                                         #No.MOD-B70280 add
              CALL cl_replace_sqldb(l_sql) RETURNING l_sql                                               #FUN-A50102									
	           CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102                  
              PREPARE sel_aag02_pre1 FROM l_sql
              EXECUTE sel_aag02_pre1 INTO g_apb[l_ac].b25
             
              #LET l_sql = "SELECT aag02 FROM ",li_dbs CLIPPED,"aag_file ",
              LET l_sql = "SELECT aag02 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'aag_file'), #FUN-A50102
                          " WHERE aag01='",g_apb[l_ac].apb251,"' ",
                          "   AND aag00='",g_bookno2,"' ",
                          "   AND aagacti = 'Y'"                                                         #No.MOD-B70280 add
              CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	           CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102                  
              PREPARE sel_aag02_pre2 FROM l_sql 
              EXECUTE sel_aag02_pre2 INTO g_apb[l_ac].b251 
 
              #FUN-D80031 -------- add --------- begin
              IF g_prog = 'aapt140' THEN
                 LET l_sql = "SELECT occ02 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'occ_file'),
                             " WHERE occ01 = '",g_apb[l_ac].apb26,"' "
              ELSE
              #FUN-D80031 -------- add --------- end
              #LET l_sql = "SELECT gem02 FROM ",li_dbs CLIPPED,"gem_file ",
              LET l_sql = "SELECT gem02 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gem_file'), #FUN-A50102
                          " WHERE gem01='",g_apb[l_ac].apb26,"' "
              END IF    #FUN-D80031 add
              CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	           CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102                  
              PREPARE sel_gem02_pre1 FROM l_sql
              EXECUTE sel_gem02_pre1 INTO g_apb[l_ac].b26

#FUN-990025 -------------------------add start-------------------------------------
              LET l_sql = "SELECT gen02 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gen_file'),
                          " WHERE gen01='",g_apb[l_ac].apb32,"' "
              CALL cl_replace_sqldb(l_sql) RETURNING l_sql           
              CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql 
              PREPARE sel_gen02_pre1 FROM l_sql
              EXECUTE sel_gen02_pre1 INTO g_apb[l_ac].b32
#FUN-990025 ------------------------add end-----------------------------------------
 
              LET g_apb[l_ac].apb01_unap=t110_set_apb01_unap(g_apb[l_ac].apb21,g_apb[l_ac].apb22,g_apb[l_ac].apb34)  #No.TQC-7B0083
              LET g_apb[l_ac].gem02c=t110_set_apa930(g_apb[l_ac].apb930) #FUN-670064
              LET g_before_input_done = FALSE
              CALL t110_set_entry_b(p_cmd)
              CALL t110_set_entry_b_1()  #No.FUN-8A0075
              CALL t110_set_no_entry_b(p_cmd)
              CALL t110_set_no_entry_b_1()  #No.FUN-8A0075
              LET g_before_input_done = TRUE
              LET g_apb04_t = g_apb04
              LET g_apb05_t = g_apb05
              CALL cl_show_fld_cont()     #FUN-550037(smin)
           END IF
 
        BEFORE INSERT
           LET l_n = ARR_COUNT()
           LET p_cmd='a'
           INITIALIZE g_apb[l_ac].* TO NULL      #900423
           LET g_apb[l_ac].apb08 = 0
           LET g_apb[l_ac].apb09 = 0
           LET g_apb[l_ac].apb10 = 0
           LET g_apb[l_ac].apb23 = 0
           LET g_apb[l_ac].apb24 = 0
           LET g_apb[l_ac].apb34 = 'N'  #No.TQC-7B0083
           IF NOT cl_null(g_apa.apa100) THEN
              LET g_apb[l_ac].apb37 = g_apa.apa100
           END IF 
           IF g_aptype MATCHES '1*' THEN
              LET g_apb[l_ac].apb29 = '1'
           ELSE
              LET g_apb[l_ac].apb29 = '3'
           END IF
           IF l_ac>1 AND g_apy.apydmy5='Y' AND g_apa.apa00[1,1]='1' THEN
              LET g_apb[l_ac].apb25 = g_apb[l_ac-1].apb25
              LET g_apb[l_ac].apb251= g_apb[l_ac-1].apb251             #No.FUN-680029
              LET g_apb[l_ac].apb26 = g_apb[l_ac-1].apb26
           END IF
           LET g_apb[l_ac].apb930=g_apa.apa930 #FUN-670064
           LET g_apb[l_ac].gem02c=s_costcenter_desc(g_apb[l_ac].apb930) #FUN-670064
 
           IF NOT cl_null(g_apa.apa66) THEN
             LET g_apb[l_ac].apb35 = g_apa.apa66
           END IF
 
           LET g_apb_t.* = g_apb[l_ac].*         #新輸入資料
           LET g_apb04_t = g_apb04
           LET g_apb05_t = g_apb05
           LET g_apb28_t = NULL                  #FUN-910088--add--
           LET g_before_input_done = FALSE
           CALL t110_set_entry_b(p_cmd)
           CALL t110_set_entry_b_1()  #No.FUN-8A0075
           CALL t110_set_no_entry_b(p_cmd)
           CALL t110_set_no_entry_b_1()  #No.FUN-8A0075
           LET g_before_input_done = TRUE
           CALL cl_show_fld_cont()     #FUN-550037(smin)
           NEXT FIELD apb02
 
        AFTER INSERT
           IF INT_FLAG THEN
              CALL cl_err('',9001,0)
              LET INT_FLAG = 0
              CANCEL INSERT
           END IF
           #TQC-C60241--add--str--
            IF g_apa.apa00 = '26' THEN
               IF g_apb[l_ac].apb29 = '3' THEN
                  SELECT SUM(rvv87) INTO l_sum_rvv87
                    FROM rvv_file
                   WHERE rvv01 = g_apb[l_ac].apb21
                     AND rvv02 = g_apb[l_ac].apb22
                  SELECT SUM(apb09) INTO l_sum_apb09
                    FROM apb_file,apa_file
                   WHERE apb21 = g_apb[l_ac].apb21
                     AND apb22 = g_apb[l_ac].apb22
                     AND apa00 = '26'
                     AND apa01 = apb01
                  SELECT apb09 INTO l_apb09
                    FROM apb_file,apa_file
                   WHERE apb21 = g_apb[l_ac].apb21
                     AND apb02 = g_apb[l_ac].apb02
                     AND apa00 = '26'
                     AND apa01 = apb01
                     AND apa01 = g_apa.apa01
                  IF cl_null(l_sum_rvv87) THEN
                     LET l_sum_rvv87 = 0
                  END IF
                  IF cl_null(l_apb09) THEN
                     LET l_apb09 = 0
                  END IF
                  IF cl_null(l_sum_apb09) THEN
                     LET l_sum_apb09 = 0
                  END IF
                  IF l_sum_apb09 + g_apb[l_ac].apb09 - l_apb09 > l_sum_rvv87 THEN
                     CALL cl_err('','aap-240',1)
                     CANCEL INSERT
                  END IF
               END IF
            END IF
            #TQC-C60241--add--end--
           IF g_apb[l_ac].apb06 IS NULL AND
              g_apb[l_ac].apb12 IS NULL AND
              g_apb[l_ac].apb09 = 0 AND
              g_apb[l_ac].apb24 = 0 THEN
              IF g_apb[l_ac].apb29 <> '3' THEN   #No.MOD-910062
                 CALL g_apb.deleteElement(l_ac)
                 NEXT FIELD apb02
                 CANCEL INSERT
              END IF
           END IF
 
           LET l_aag05=''
           #LET l_sql = "SELECT aag05 FROM ",li_dbs CLIPPED,"aag_file ",
           LET l_sql = "SELECT aag05 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'aag_file'), #FUN-A50102
                       " WHERE aag01 = '",g_apb[l_ac].apb25,"' ",
                       "   AND aag00 = '",g_bookno1,"' ",
                       "   AND aagacti = 'Y'"                                                         #No.MOD-B70280 add
           CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	       CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
           PREPARE sel_aag05_pre1 FROM l_sql
           EXECUTE sel_aag05_pre1 INTO l_aag05
           #防止User只修改科目或部門欄位時,未再次檢查會科與允許/拒絕部門關係
           LET g_errno = ' '   
           IF l_aag05 = 'Y' THEN
             #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
              IF g_aaz.aaz90 ='Y' THEN
                 IF NOT cl_null(g_apb[l_ac].apb930) THEN 
                    CALL s_chkdept_dbs(g_aaz.aaz72,g_apb[l_ac].apb25,   #FUN-9A0093
                                       g_apb[l_ac].apb930,g_bookno1,g_apb[l_ac].apb37) #FUN-9A0093 
                                  RETURNING g_errno
                 END IF
              ELSE
                 IF NOT cl_null(g_apb[l_ac].apb26) THEN 
                    CALL s_chkdept_dbs(g_aaz.aaz72,g_apb[l_ac].apb25,g_apb[l_ac].apb26,
                                   g_bookno1,g_apb[l_ac].apb37)
                                  RETURNING g_errno
                 END IF 
              END IF
              IF NOT cl_null(g_errno) THEN
                 CALL cl_err('',g_errno,0)
                 NEXT FIELD apb25
              END IF
           END IF
           IF g_aza.aza63='Y' THEN 
              LET l_aag05=''
              #LET l_sql = "SELECT aag05 FROM ",li_dbs CLIPPED,"aag_file ",
              LET l_sql = "SELECT aag05 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'aag_file'), #FUN-A50102
                          " WHERE aag01 = '",g_apb[l_ac].apb251,"' ",
                          "   AND aag00 = '",g_bookno2,"' ",
                          "   AND aagacti = 'Y'"                                                         #No.MOD-B70280 add
              CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	          CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102               
              PREPARE sel_aag_pre FROM l_sql
              EXECUTE sel_aag_pre INTO l_aag05
              #防止User只修改科目或部門欄位時,未再次檢查會科與允許/拒絕部門關係
              LET g_errno = ' '   
              IF l_aag05 = 'Y' AND NOT cl_null(g_apb[l_ac].apb251) THEN
                 IF g_aaz.aaz90 ='Y' THEN
                    IF NOT cl_null(g_apb[l_ac].apb930) THEN
                       CALL s_chkdept_dbs(g_aaz.aaz72,g_apb[l_ac].apb251,
                                          g_apb[l_ac].apb930,g_bookno2,g_apb[l_ac].apb37)
                                     RETURNING g_errno
                    END IF 
                 ELSE
                    IF NOT cl_null(g_apb[l_ac].apb26) THEN
                       CALL s_chkdept_dbs(g_aaz.aaz72,g_apb[l_ac].apb251,
                                          g_apb[l_ac].apb26,g_bookno2,g_apb[l_ac].apb37)
                                     RETURNING g_errno
                    END IF
                 END IF
                 IF NOT cl_null(g_errno) THEN
                    CALL cl_err('',g_errno,0)
                    NEXT FIELD apb251
                 END IF
              END IF
           END IF
           #TQC-C10017  --Begin
           IF cl_null(g_apb[l_ac].apb25) THEN LET g_apb[l_ac].apb25= ' ' END IF 
           IF cl_null(g_apb[l_ac].apb26) THEN LET g_apb[l_ac].apb26= ' ' END IF
           IF cl_null(g_apb[l_ac].apb27) THEN LET g_apb[l_ac].apb27= ' ' END IF
           IF cl_null(g_apb[l_ac].apb31) THEN LET g_apb[l_ac].apb31= ' ' END IF
           IF cl_null(g_apb[l_ac].apb35) THEN LET g_apb[l_ac].apb35= ' ' END IF
           IF cl_null(g_apb[l_ac].apb36) THEN LET g_apb[l_ac].apb36= ' ' END IF
           IF cl_null(g_apb[l_ac].apb930) THEN LET g_apb[l_ac].apb930= ' ' END IF
           #TQC-C10017  --End
           INSERT INTO apb_file(apb01,apb02,apb11,apb37,apb21,apb31,apb22,apb06,apb07, #FUN-630055 add apb31   #FUN-9A0093 add apb37
                                apb12,apb09,apb25,apb251,apb26,apb930,apb23,apb24,apb08,  #FUN-670064  No.FUN-680029
                                apb10,apb081,apb101,apb27,apb28,apb29,apb04,
                                apb05,apb33,apb32,apb34,apb35,apb36,  #FUN-810045 add apb35/36                                  #No.FUN-690080  #No.TQC-7B0083  #No.FUN-830161  remove apb30
                                apblegal,   #FUN-980001 add apblegal
                                apbud01,apbud02,apbud03,
                                apbud04,apbud05,apbud06,
                                apbud07,apbud08,apbud09,
                                apbud10,apbud11,apbud12,
                                apbud13,apbud14,apbud15)
            VALUES(g_apa.apa01,g_apb[l_ac].apb02,g_apb[l_ac].apb11,g_apb[l_ac].apb37,   #FUN-9A0093 add apb37
                   g_apb[l_ac].apb21,g_apb[l_ac].apb31,g_apb[l_ac].apb22,g_apb[l_ac].apb06, #FUN-630055 add apb31
                   g_apb[l_ac].apb07,g_apb[l_ac].apb12,g_apb[l_ac].apb09,
                   g_apb[l_ac].apb25,g_apb[l_ac].apb251,g_apb[l_ac].apb26,g_apb[l_ac].apb930,g_apb[l_ac].apb23, #FUN-670064   No.FUN-680029
                   g_apb[l_ac].apb24,g_apb[l_ac].apb08,g_apb[l_ac].apb10,
                   g_apb[l_ac].apb08,g_apb[l_ac].apb10,g_apb[l_ac].apb27,
                   g_apb[l_ac].apb28,g_apb[l_ac].apb29,g_apb04,g_apb05,g_apb[l_ac].apb33,g_apb[l_ac].apb32,   #No.FUN-690080  #FUN-810045 g_apb30->g_apb[l_ac].apb30  #No.FUN-830161  remove apb30
                   g_apb[l_ac].apb34,g_apb[l_ac].apb35,g_apb[l_ac].apb36,  #No.TQC-7B0083   #FUN-810045
                   g_legal, #FUN-980001 add
                   g_apb[l_ac].apbud01,g_apb[l_ac].apbud02,
                   g_apb[l_ac].apbud03,g_apb[l_ac].apbud04,
                   g_apb[l_ac].apbud05,g_apb[l_ac].apbud06,
                   g_apb[l_ac].apbud07,g_apb[l_ac].apbud08,
                   g_apb[l_ac].apbud09,g_apb[l_ac].apbud10,
                   g_apb[l_ac].apbud11,g_apb[l_ac].apbud12,
                   g_apb[l_ac].apbud13,g_apb[l_ac].apbud14,
                   g_apb[l_ac].apbud15)
           IF SQLCA.sqlcode THEN
              CALL cl_err3("ins","apb_file",g_apa.apa01,g_apb[l_ac].apb02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
              CANCEL INSERT
           ELSE
              IF g_apa.apa08 = 'UNAP' THEN
                 IF NOT cl_null(g_apb[l_ac].apb21) AND NOT cl_null(g_apb[l_ac].apb22) THEN  #No.MOD-9C0259
                    #LET l_sql = "UPDATE ",li_dbs CLIPPED,"rvv_file ", 
                   LET l_sql = "UPDATE ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'), #FUN-A50102 
                                "   SET rvv40 = 'Y' ",      
                                " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
                                "   AND rvv02 = '",g_apb[l_ac].apb22,"' " 
                    CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
                    PREPARE upd_rvv1 FROM l_sql
                    EXECUTE upd_rvv1 
                    IF STATUS THEN
                       CALL cl_err3("upd","rvv_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,STATUS,"","upd rvv40",1)  #No.FUN-660122
                       LET g_success='N'
                    END IF
                 END IF   #No.MOD-9C0259
              END IF
 
              MESSAGE 'INSERT O.K'
              LET l_apa63 = '0'          #FUN-550042
              LET g_rec_b=g_rec_b+1
              DISPLAY g_rec_b TO FORMONLY.n2
              #若是衝暫估,則自動產生api資料
              IF g_apb[l_ac].apb34 = 'Y' THEN
                 CALL t110_api_unap('a')
              END IF
             #str CHI-B30009 add
              LET g_apb04=''
              LET g_apb05=''
              SELECT apb04,apb05 INTO g_apb04,g_apb05 FROM apb_file
               WHERE apb01=g_apa.apa01 AND apb02=g_apb[l_ac].apb02
             #end CHI-B30009 add
               CALL t110_bu(1,0,0) #FUN-CB0054 add '0'
              #使用稅控系統, 可由單身輸入發票資料
              IF g_aza.aza26 = '2' AND g_aza.aza46 = 'Y' THEN   #No.FUN-580006
                 CALL t110_ddd_c(g_apb[l_ac].apb02)
                 DISPLAY BY NAME g_apa.apa07      #TQC-630164 
                 CALL t110_show_multi_invoice()   #No.TQC-A30076 
              END IF
              IF g_success='Y' THEN
                 LET l_change = 'Y'  #No.MOD-B80053 add
                 COMMIT WORK
              ELSE
                 ROLLBACK WORK
              END IF
           END IF
 
        BEFORE FIELD apb02                        #default 序號
           IF g_apb[l_ac].apb02 IS NULL OR g_apb[l_ac].apb02 = 0 THEN
              SELECT max(apb02)+1 INTO g_apb[l_ac].apb02 FROM apb_file
               WHERE apb01 = g_apa.apa01
              IF g_apb[l_ac].apb02 IS NULL THEN
                 LET g_apb[l_ac].apb02 = 1
              END IF
           END IF
 
        AFTER FIELD apb02                        #check 序號是否重複
           LET l_ac = ARR_CURR()  #No.TQC-740067  
           IF NOT cl_null(g_apb[l_ac].apb02) THEN
              IF g_apb[l_ac].apb02 != g_apb_t.apb02 OR
                 g_apb_t.apb02 IS NULL THEN
                 SELECT count(*) INTO l_n FROM apb_file
                  WHERE apb01 = g_apa.apa01 AND apb02 = g_apb[l_ac].apb02
                 IF l_n > 0 THEN
                    CALL cl_err('',-239,0)
                    LET g_apb[l_ac].apb02 = g_apb_t.apb02
                    NEXT FIELD apb02
                 END IF
              END IF
           END IF
        
        BEFORE FIELD apb37
           IF NOT cl_null(g_apa.apa100) THEN
              LET g_apb[l_ac].apb37 = g_apa.apa100
              LET g_plant_new = g_apb[l_ac].apb37
              CALL s_gettrandbs() 
              LET li_dbs = g_dbs_tra
           END IF

        AFTER FIELD apb37
           IF NOT cl_null(g_apb[l_ac].apb37) THEN
              CALL t110_apb37()
              IF NOT cl_null(g_errno) THEN 
                 CALL cl_err(g_apb[l_ac].apb37,g_errno,1)
                 NEXT FIELD apb37
              END IF 
           ELSE
              CALL cl_err('','alm-809',0)
              NEXT FIELD apb37
           END IF  
        BEFORE FIELD apb21
           CALL t110_set_entry_b(p_cmd)
           CALL t110_set_no_entry_b(p_cmd)  #MOD-5B0005
           IF l_ac > 1 THEN   #MOD-9B0043
              IF g_apb[l_ac].apb37 = g_apb[l_ac-1].apb37 THEN   #MOD-9B0043 
                 IF g_apb[l_ac].apb21 IS NULL AND l_ac > 1 THEN
                    LET g_apb[l_ac].apb21 = g_apb[l_ac-1].apb21
                 END IF
              END IF #MOD-9B0043
           END IF   #MOD-9B0043
 
        AFTER FIELD apb35
          IF NOT cl_null(g_apb[l_ac].apb35) THEN
             #LET l_sql = "SELECT COUNT(*) FROM ",li_dbs CLIPPED," pja_file ",
             LET l_sql = "SELECT COUNT(*) FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pja_file'), #FUN-A50102
                         " WHERE pja01 = '",g_apb[l_ac].apb35,"' ",
                         "   AND pjaacti = 'Y' AND pjaclose = 'N'"
             CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
             PREPARE pja_pre FROM l_sql
             DECLARE pja_cs CURSOR FOR pja_pre
             OPEN pja_cs
             FETCH pja_cs INTO g_cnt
             IF g_cnt = 0 THEN
                CALL cl_err(g_apb[l_ac].apb35,'asf-984',0)
                NEXT FIELD apb35
             END IF
             CALL t110_set_entry_b(p_cmd)
             CALL t110_set_no_entry_b(p_cmd)
          ELSE 
             NEXT FIELD apb31    #IF 專案沒輸入資料，直接跳到費用原因
          END IF
          IF g_aptype[1,1] = '1' THEN
             CALL t110_bud(p_cmd,'3')
             IF NOT cl_null(g_errno) THEN
                NEXT FIELD apb26 
             END IF
          END IF
         
       BEFORE FIELD apb36
         IF cl_null(g_apb[l_ac].apb35) THEN
            NEXT FIELD apb35
         END IF
 
       AFTER FIELD apb36
          LET g_plant_new = g_apb[l_ac].apb37
          CALL s_gettrandbs() 
          LET li_dbs = g_dbs_tra
          IF NOT cl_null(g_apb[l_ac].apb36) THEN
             #LET l_sql = "SELECT COUNT(*) FROM ",li_dbs CLIPPED,"pjb_file ",
             LET l_sql = "SELECT COUNT(*) FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pjb_file'), #FUN-A50102
                         " WHERE pjb01 = '",g_apb[l_ac].apb35,"' ",
                         "   AND pjb02 = '",g_apb[l_ac].apb36,"' ",
                         "   AND pjbacti = 'Y' "
             CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
             PREPARE pjb_pre FROM l_sql
             DECLARE pjb_cs CURSOR FOR pjb_pre
             OPEN pjb_cs
             FETCH pjb_cs INTO g_cnt
             IF g_cnt = 0 THEN
                CALL cl_err(g_apb[l_ac].apb35,'apj-051',0)
                LET g_apb[l_ac].apb36 = g_apb_t.apb36
                NEXT FIELD apb36
             ELSE
                #LET l_sql = "SELECT pjb09,pjb11 FROM ",li_dbs CLIPPED,"pjb_file ",
                LET l_sql = "SELECT pjb09,pjb11 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pjb_file'), #FUN-A50102
                            " WHERE pjb01 ='",g_apb[l_ac].apb35,"' ",
                            "   AND pjb02 ='",g_apb[l_ac].apb36,"' ",
                            "   AND pjbacti = 'Y' "
                CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	           CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
                PREPARE pjb_pre1 FROM l_sql
                DECLARE pjb_cs1 CURSOR FOR pjb_pre1
                OPEN pjb_cs1
                FETCH pjb_cs1 INTO l_pjb09,l_pjb11
                IF l_pjb09 != 'Y' OR l_pjb11 != 'Y' THEN
                   CALL cl_err(g_apb[l_ac].apb35,'apj-090',0)
                   LET g_apb[l_ac].apb36 = g_apb_t.apb36
                   NEXT FIELD apb36
                END IF
             END IF
          END IF
          IF g_aptype[1,1] = '1' THEN
             CALL t110_bud(p_cmd,'3')
             IF NOT cl_null(g_errno) THEN
                NEXT FIELD apb31
             END IF
          END IF
 
        AFTER FIELD apb31
               CALL t110_apb31()
               IF NOT cl_null(g_errno)  THEN
                  CALL cl_err(g_apb[l_ac].apb31,g_errno,1)
                  NEXT FIELD apb31
               END IF
           IF g_aptype[1,1] = '1' THEN
              CALL t110_bud(p_cmd,'3')
              IF NOT cl_null(g_errno) THEN
                 NEXT FIELD apb31
              END IF
           END IF
 
        AFTER FIELD apb21
            LET g_plant_new = g_apb[l_ac].apb37
            CALL s_gettrandbs() 
            LET li_dbs = g_dbs_tra
            IF g_aptype='11' AND cl_null(g_apb[l_ac].apb21) THEN
               NEXT FIELD apb21
            END IF
        
            IF g_aptype='21' AND g_apa.apa58='2' AND g_apb[l_ac].apb21 IS NULL THEN
               NEXT FIELD apb21
            END IF
            IF g_aptype='12' AND g_apb[l_ac].apb21 IS NOT NULL THEN
               LET l_cnt = 0
                  SELECT COUNT(*) INTO l_cnt FROM apa_file
                   WHERE apa01=g_apb[l_ac].apb21
                     AND apa06=g_apa.apa06
                     AND apa07=g_apa.apa07
               IF l_cnt = 0 THEN
                  CALL cl_err('','aap-024',0)   #付款廠商+簡稱和立暫估不同,請留意!
                  NEXT FIELD apb21
               END IF
              #-MOD-A60078-add-
               LET l_cnt = 0
               SELECT COUNT(*) INTO l_cnt 
                 FROM apa_file,apb_file
                WHERE apa00 = '16' AND apa01 = apb01 AND apa41 = 'Y' AND apa42 = 'N'
                  AND apa01=g_apb[l_ac].apb21 AND apb21 IS NOT NULL
               IF l_cnt > 0 THEN
                  CALL cl_err('','aap-610',0)  
                  NEXT FIELD apb21
               END IF
              #-MOD-A60078-add-
            END IF

           #IF g_azw.azw04 = '2' THEN  #業態為零售業                                    #MOD-AC0238
           #IF g_azw.azw04 = '2' AND NOT cl_null(g_apb[l_ac].apb21) THEN  #業態為零售業 #MOD-AC0238 #MOD-B90246 mark
            IF g_azw.azw04 = '2' AND NOT cl_null(g_apb[l_ac].apb21) AND g_apa.apa00 = '11' THEN     #業態為零售業 #MOD-B90246 add apa00 = '11' 
               #LET l_sql = "SELECT rvu21 FROM ",li_dbs CLIPPED,"rvu_file ",
               LET l_sql = "SELECT rvu21 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvu_file'), #FUN-A50102
                           " WHERE rvu01 = '",g_apb[l_ac].apb21,"' "
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	           CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
               PREPARE sel_rvu21_pre FROM l_sql
               EXECUTE sel_rvu21_pre INTO l_rvu21
               IF cl_null(l_rvu21) OR l_rvu21<>g_apa.apa76 THEN
                  CALL cl_err('','aap-890',0)
                  NEXT FIELD apb21
               END IF 
            END IF  
            DISPLAY BY NAME g_apb[l_ac].apb21   #FUN-7A0050 add
            CALL t110_set_no_entry_b(p_cmd)
            IF g_apb[l_ac].apb21 !=g_apb_t.apb21 THEN    #No.MOD-910086
               NEXT FIELD apb22    #No.MOD-910086
            END IF    #No.MOD-910086
            #-----MOD-A40078---------
            IF NOT cl_null(g_apb[l_ac].apb21) THEN
               #LET l_sql = "SELECT rvu99 FROM ",li_dbs CLIPPED,"rvu_file ",
               LET l_sql = "SELECT rvu99 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvu_file'), #FUN-A50102
                           " WHERE rvu01 = '",g_apb[l_ac].apb21,"' "
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	           CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
               PREPARE sel_rvu99_pre FROM l_sql
               EXECUTE sel_rvu99_pre INTO l_rvu99

               LET l_rvu99_1 = l_rvu99
               LET i = l_rvu99_1.getIndexOf('-',1)
               LET j = l_rvu99_1.getIndexOf(' ',1)
               IF i > j THEN 
                  LET l_rvu99 = l_rvu99_1.subString(1,j-1)
               ELSE
                  LET l_rvu99 = l_rvu99_1.subString(1,i-1)
               END IF
              
               SELECT poz19,poz18 INTO l_poz19,l_poz18 FROM poz_file
                 WHERE poz01=l_rvu99
               IF NOT STATUS THEN 
                 IF l_poz19 = 'N' OR (l_poz19 = 'Y' AND g_plant <> l_poz18) THEN
                    CALL cl_err(g_apb[l_ac].apb21,'axr-080',1)
                    NEXT FIELD apb21
                 END IF
               END IF
            END IF
            #-----END MOD-A40078-----
#No.MOD-A20009 --begin                                                          
            IF (p_cmd ='a' OR p_cmd ='u' AND g_apb[l_ac].apb21 <> g_apb_t.apb21)
               AND g_aptype ='11' AND g_aza.aza26 ='2' THEN                     
                  #FUN-A60056--mod--str--
                  #SELECT YEAR(rvu03),MONTH(rvu03) INTO l_year,l_month          
                  #  FROM rvu_file                                              
                  # WHERE rvu01 = g_apb[l_ac].apb21                             
                  LET g_sql = "SELECT YEAR(rvu03),MONTH(rvu03) ",
                              "  FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvu_file'),
                              " WHERE rvu01 = '",g_apb[l_ac].apb21,"'"
                  CALL cl_replace_sqldb(g_sql) RETURNING g_sql
                  CALL cl_parse_qry_sql(g_sql,g_apb[l_ac].apb37) RETURNING g_sql
                  PREPARE sel_rvu03 FROM g_sql
                  EXECUTE sel_rvu03 INTO l_year,l_month
                  #FUN-A60056--mod--end
                   IF l_year <> YEAR(g_apa.apa02) OR                            
                      l_month <> MONTH(g_apa.apa02) THEN                        
                      LET l_n = 0                                               
                      SELECT COUNT(apa01) INTO l_n FROM apb_file,apa_file       
                       WHERE apb21 = g_apb[l_ac].apb21                          
                         AND apb01 = apa01                                      
#                        AND apa00 ='16'                       #TQC-A80101 Mark
                         AND (apa00 ='16' OR apa00 ='26')      #TQC-A80101 Add                                        
                         AND YEAR(apa02) = l_year                               
                         AND MONTH(apa02) = l_month                             
                      IF l_n = 0 THEN                                           
                         CALL cl_err('','gap-145',0)                            
                         LET g_apb[l_ac].apb21 = g_apb_t.apb21                  
                         NEXT FIELD apb21                                       
                      END IF                                                    
                   END IF                                                       
            END IF                                                              
#No.MOD-A20009 --end 
           #-----------------------------MOD-C80066---------------------(S)
            IF g_aptype='16' AND l_ac > 1 THEN
               IF cl_null(g_apb[1].apb21) THEN
                  IF NOT cl_null(g_apb[l_ac].apb21) THEN
                     CALL cl_err('','aap-183',0)
                     LET g_apb[l_ac].apb21 = g_apb_t.apb21
                     NEXT FIELD apb21
                  END IF
               ELSE   
                  IF cl_null(g_apb[l_ac].apb21) THEN
                     CALL cl_err('','aap-183',0)
                     LET g_apb[l_ac].apb21 = g_apb_t.apb21
                     NEXT FIELD apb21
                  END IF
               END IF
            END IF
           #-----------------------------MOD-C80066---------------------(E)
            LET g_apb_t.apb21=g_apb[l_ac].apb21   #MOD-B80277 add
 
        AFTER FIELD apb22
            IF g_aptype='11' AND g_apb[l_ac].apb22 IS NULL AND NOT cl_null(g_apb[l_ac].apb21) THEN  #No.TQC-740067
               NEXT FIELD apb22
            END IF
            IF g_aptype='21' AND g_apa.apa58='2' AND g_apb[l_ac].apb22 IS NULL AND NOT cl_null(g_apb[l_ac].apb21) THEN  #No.TQC-740067
               NEXT FIELD apb22
            END IF
            IF g_apb_t.apb22 IS NULL OR   #MOD-B80277 mod apb21->apb22
               (g_apb[l_ac].apb21 != g_apb_t.apb21 OR
                g_apb[l_ac].apb22 != g_apb_t.apb22) THEN
               LET g_errno = ' '
               IF g_aptype = '11' OR g_aptype='16' THEN     #No.TQC-770056 add 16
                  CALL t110_apb22_11('a')
                  IF g_chr_1 = 'N' THEN NEXT FIELD apb21 END IF   #MOD-950158 #MOD-CB0096 apb22 mod apb21
               END IF
               #檢查是否為 aapt160 費用暫估資料
               IF g_aptype = '12' THEN
                  CALL t110_apb22_12()
                  IF g_chr_2 = 'N' THEN NEXT FIELD apb21 END IF   #MOD-950158 #MOD-CB0096 apb22 mod apb21
               END IF
               IF (g_aptype = '21' AND (g_apa.apa58 = '2' OR g_apa.apa58 = '3')) OR
                   g_aptype = '26' THEN
                  CALL t110_apb22_21('a')
                  IF g_chr_3 = 'N' THEN NEXT FIELD apb21 END IF   #MOD-950158 #MOD-CB0096 apb22 mod apb21
               END IF
               IF g_errno = 'aap-041' OR g_errno = 'aap-042' OR
                  g_errno = 'aap-043' OR g_errno = 'aap-152' THEN   #MOD-970061 mod
                  NEXT FIELD apb21   #MOD-770041 mod
               END IF
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,0)
                  LET g_apb[l_ac].apb21=g_apb_t.apb21
                  LET g_apb[l_ac].apb22=g_apb_t.apb22
                  NEXT FIELD apb22
               END IF
               CALL t110_proj()  #FUN-810045
               CALL t110_set_no_entry_b(p_cmd)  #FUN-810045 add
            END IF
           #MOD-A20113---add---start---
            LET l_cnt = 0
           #--------------------------MOD-C30896------------------(S)
            IF g_apa.apa00 = '26' THEN
               SELECT COUNT(*) INTO l_cnt FROM apa_file,apb_file
                WHERE apb21 = g_apb[l_ac].apb21
                  AND apb22 = g_apb[l_ac].apb22
                  AND apa01 = apb01
                  AND apa42 = 'N'
                  AND apa00 <> '21'
                  AND apb29 = '3'
                  AND apb09 = 0
                  AND apb01 != g_apa.apa01
            ELSE
           #--------------------------MOD-C30896------------------(E)
               SELECT COUNT(*) INTO l_cnt FROM apa_file,apb_file
                WHERE apb21 = g_apb[l_ac].apb21
                  AND apb22 = g_apb[l_ac].apb22
                  AND apa01 = apb01
                  AND apa42 = 'N'
                  AND apa00 <> '26'
                  AND apb29 = '3'      #MOD-A30046 add
                  AND apb09 = 0        #MOD-A30046 add
                  AND apb01 != g_apa.apa01 #MOD-AB0201
            END IF                             #MOD-C30896 add
            IF l_cnt > 0 THEN
               LET l_err = g_apb[l_ac].apb21,"/",g_apb[l_ac].apb22
               CALL cl_err(l_err,'aec-009',0)
              #NEXT FIELD apb21       #No.MOD-B80345 mark
               NEXT FIELD apb21       #No.MOD-B80345 add
            END IF
           #MOD-A20113---add---end---
            IF g_aptype = '11' THEN
               #LET l_sql = "SELECT rvv38 FROM ",li_dbs CLIPPED,"rvv_file ",
               LET l_sql = "SELECT rvv38 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'), #FUN-A50102
                           " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
                           "   AND rvv02 = '",g_apb[l_ac].apb22,"' "
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	           CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
               PREPARE sel_rvv38_cs1 FROM l_sql
               EXECUTE sel_rvv38_cs1 INTO l_rvv38
            END IF
 
            IF cl_null(g_apa.apa58) OR                                 #MOD-850316 add
              (NOT cl_null(g_apa.apa58) AND g_apa.apa58 != '3') THEN   #MOD-850316 add
               #沖暫估否
               LET g_apb[l_ac].apb34=t110_set_rvv34(g_apb[l_ac].apb21,g_apb[l_ac].apb22)
             #FUN-C70075--mark--str
             ##-----------------------MOD-C70057----------------------(S)
             # IF g_apb[l_ac].apb34 = 'Y' AND g_apa.apa55 = '2' THEN
             #    CALL cl_err('','aap-029',0)
             #    NEXT FIELD apb22
             # END IF
             ##----------------------MOD-C70057----------------------(E)
             #FUN-C70075--mark--end
               DISPLAY BY NAME g_apb[l_ac].apb34
               #暫估帳款單號
               LET g_apb[l_ac].apb01_unap=t110_set_apb01_unap(g_apb[l_ac].apb21,g_apb[l_ac].apb22,g_apb[l_ac].apb34)
               DISPLAY BY NAME g_apb[l_ac].apb01_unap
            END IF    #MOD-850316 add
 
        BEFORE FIELD apb06
            CALL t110_set_entry_b(p_cmd)
 
        AFTER FIELD apb06
            IF NOT cl_null(g_apb[l_ac].apb06) AND (g_aptype = '15' OR g_aptype = '17') THEN  #No.FUN-690080
                  #LET l_sql = "SELECT COUNT(*) FROM ",li_dbs CLIPPED,"pmm_file ",
                  LET l_sql = "SELECT COUNT(*) FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmm_file'), #FUN-A50102
                              " WHERE pmm01='",g_apb[l_ac].apb06,"' ",
                              "   AND pmm09='",g_apa.apa05,"' ",
                              "   AND pmm18='Y' "
                  CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	              CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
                  PREPARE sel_cou_pmm FROM l_sql
                  EXECUTE sel_cou_pmm INTO g_cnt
               IF g_cnt = 0 THEN
                  CALL cl_err('','aap-006',0)
                  NEXT FIELD apb06
               END IF
               IF cl_null(g_apb_t.apb06) THEN
                  CALL t110_apb06()
               END IF
             #MOD-A30248---mark---start---
             #不管要不要勾稽，皆不做金額控卡
             #IF g_aptype='15' THEN #MOD-990155   
             # #已立預付原幣金額
             # LET l_apa31f = 0
             # LET l_apa31f0= 0   #MOD-9B0048 add
             # DECLARE apa_cs1 CURSOR FOR
             #    SELECT DISTINCT apb01 FROM apb_file
             #     WHERE apb06 =g_apb[l_ac].apb06
             #       AND apb01!=g_apa.apa01
             # FOREACH apa_cs1 INTO l_apb01
             #    LET l_apa31f0 = 0   #MOD-9C0145 add
             #    SELECT apa31f INTO l_apa31f0 FROM apa_file
             #     WHERE apa01 =l_apb01
             #       AND apa00 ='15'
             #    IF cl_null(l_apa31f0) THEN LET l_apa31f0 = 0 END IF
             #    LET l_apa31f = l_apa31f + l_apa31f0
             # END FOREACH
             # IF cl_null(l_apa31f) THEN LET l_apa31f = 0 END IF
             # #採購單原幣含稅金額
             # LET l_pmm40t = 0
             # #LET l_sql = "SELECT pmm40t FROM ",li_dbs CLIPPED,"pmm_file ",
             # LET l_sql = "SELECT pmm40t FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmm_file'), #FUN-A50102
             #             " WHERE pmm01='",g_apb[l_ac].apb06,"' "
             # CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	     #     CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
             # PREPARE sel_pmm40_cs1 FROM l_sql
             # EXECUTE sel_pmm40_cs1 INTO l_pmm40t
             # IF cl_null(l_pmm40t) THEN LET l_pmm40t = 0 END IF
             # IF g_apa.apa31f > l_pmm40t - l_apa31f THEN
             #    CALL cl_err(g_apa.apa31f,'aap-937',0) 
             #    NEXT FIELD apb06
             # END IF
             #END IF #MOD-990155      
             #MOD-A30248---mark---end---
               CALL t110_set_no_entry_b(p_cmd)
               #No.yinhy130628  --Begin  
               IF NOT cl_null(g_apb[l_ac].apb07) AND ((g_apb_t.apb06 IS NULL OR
                 g_apb[l_ac].apb06 <> g_apb_t.apb06) OR 
                 (g_apb_t.apb07 IS NULL OR g_apb[l_ac].apb07 <> g_apb_t.apb07)) THEN
               	  CALL t110_apb07('a')
                  IF g_errno = 'aap-937' THEN
                     CALL cl_err(g_apb[l_ac].apb06,'aap-937',1)
                     NEXT FIELD apb06
                  END IF
                  IF g_errno = 'aap-041' THEN
                     NEXT FIELD apb06i
                  END IF
                  IF NOT cl_null(g_errno) THEN
                    CALL cl_err('',g_errno,0)
                    NEXT FIELD apb07
                  END IF
                  CALL t110_proj()
                  CALL t110_set_entry_b(p_cmd)
                  CALL t110_set_no_entry_b(p_cmd)
               END IF    
               #No.yinhy130628  --End
            END IF    
            #No.MOD-D70065  --Begin
            #IF g_aptype = '15' AND (g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y')) THEN
            #   IF cl_null(g_apb[l_ac].apb06) THEN
            #      CALL cl_err('','aap-192',0)
            #      NEXT FIELD apb06
            #   END IF
            #END IF
            #No.MOD-D70065  --End
 
        AFTER FIELD apb07
           IF g_aptype = '15' OR g_aptype = '17' THEN   #No.FUN-690080
              IF NOT cl_null(g_apb[l_ac].apb07) AND ((g_apb_t.apb06 IS NULL OR   #MOD-840535
                 g_apb[l_ac].apb06 <> g_apb_t.apb06) OR 
                 (g_apb_t.apb07 IS NULL OR g_apb[l_ac].apb07 <> g_apb_t.apb07)) THEN  #CHI-B80023 add
                 CALL t110_apb07('a')
                 #MOD-A30248---add---start---
                 IF g_errno = 'aap-937' THEN
                    CALL cl_err(g_apb[l_ac].apb06,'aap-937',1)
                    NEXT FIELD apb06
                 END IF
                 #MOD-A30248---add---end---
                 IF g_errno = 'aap-041' THEN
                    NEXT FIELD apb06i
                 END IF
                 IF NOT cl_null(g_errno) THEN
                   CALL cl_err('',g_errno,0)
                   NEXT FIELD apb07
                 END IF
                 CALL t110_proj()        #MOD-910161 add
                 CALL t110_set_entry_b(p_cmd)
                 CALL t110_set_no_entry_b(p_cmd)   #No.FUN-880094
              END IF
           END IF
 
        AFTER FIELD apb11
            IF (g_apa.apa58 = '3' OR g_apa.apa58 = '2') AND g_apa.apa00='21' THEN   #CHI-750020
               IF g_apb[l_ac].apb11 IS NULL OR g_apb[l_ac].apb11=' ' THEN
                  #LET l_sql = "SELECT gec05 FROM ",li_dbs CLIPPED,"gec_file ",
                  LET l_sql = "SELECT gec05 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'), #FUN-A50102
                              " WHERE gec01 = '",g_apa.apa15,"' "
                  CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	              CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
                  PREPARE sel_gec05_cs1 FROM l_sql
                  EXECUTE sel_gec05_cs1 INTO l_gec05
                  IF l_gec05 != 'X' THEN                                                #MOD-950138 add                                                                  
                     CALL cl_err(g_apa.apa01,'mfg-011',0)
                     NEXT FIELD apb11
                  END IF                 #MOD-950138 add   
               END IF    
            END IF
            IF NOT cl_null(g_apb[l_ac].apb11) THEN
                  SELECT COUNT(*) INTO l_n FROM apk_file
                   WHERE apk03 = g_apb[l_ac].apb11
               IF l_n = 0 THEN
                  #LET l_sql = "SELECT COUNT(*) FROM ",li_dbs CLIPPED,"amd_file ",
                  LET l_sql = "SELECT COUNT(*) FROM ",cl_get_target_table(g_apb[l_ac].apb37,'amd_file'), #FUN-A50102
                              " WHERE amd03 = '",g_apb[l_ac].apb11,"' "
                  CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	              CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102               
                  PREPARE sel_cou_amd FROM l_sql
                  EXECUTE sel_cou_amd INTO l_n
                  IF l_n = 0 THEN
                     CALL cl_err('sel apk: ','aap-151',0)
                     NEXT FIELD apb11
                  END IF
               END IF
              #aapt210單身輸入發票(apb11)時,需檢核apa00=1*的apk_file
              #對應的帳款已確認才可輸入
               IF g_apa.apa00='21' THEN
                  LET l_n = 0
                  SELECT COUNT(*) INTO l_n
                    FROM apa_file,apk_file
                   WHERE apa01=apk01
                     AND apk03=g_apb[l_ac].apb11
                     AND apa00 MATCHES '1*'
                     AND apa41='Y'            #已確認
                  IF l_n = 0 THEN
                     #LET l_sql = "SELECT COUNT(*) FROM ",li_dbs CLIPPED,"amd_file",
                     LET l_sql = "SELECT COUNT(*) FROM ",cl_get_target_table(g_apb[l_ac].apb37,'amd_file'), #FUN-A50102
                                 " WHERE amd03='",g_apb[l_ac].apb11,"' ",
                                 "   AND amd30='Y' "     #已確認
                     CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                 CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
                     PREPARE sel_cou1_amd FROM l_sql
                     EXECUTE sel_cou1_amd INTO l_n
                     IF l_n = 0 THEN
                        SELECT apk01 INTO l_apk01
                          FROM apa_file,apk_file
                         WHERE apa01=apk01
                           AND apk03=g_apb[l_ac].apb11
                           AND apa00 MATCHES '1*'
                        SELECT gaq03 INTO l_message FROM gaq_file
                         WHERE gaq01='apa00' and gaq02=g_lang
                        LET l_message=l_message,'=1*,',l_apk01,':'
                        CALL cl_err(l_message,'mfg-043',0)
                        NEXT FIELD apb11
                     END IF   #MOD-870264 add
                  END IF
               END IF
               IF g_apa.apa00 MATCHES '2*' THEN
                  LET l_apa06=''
                  DECLARE chk_c1 CURSOR FOR
                     SELECT apa06
                       FROM apa_file,apk_file
                      WHERE apa01=apk01
                        AND apk03 = g_apb[l_ac].apb11
                        AND apa00 MATCHES '1*'
 
                  OPEN chk_c1
                  FETCH chk_c1  INTO l_apa06
                  IF l_apa06 <> g_apa.apa06 THEN
                     CALL cl_err(l_apa06,'mfg-024',0)
                     NEXT FIELD apb11
                  END IF
               END IF
            END IF
 
        AFTER FIELD apb12
         #LET l_flag = NULL                            #TQC-C20183  #MOD-CC0258 mark 
          IF NOT cl_null(g_apb[l_ac].apb12) THEN
             IF g_apb[l_ac].apb12[1,4] != "MISC" THEN   #TQC-750121
               LET g_plant_new = g_apb[l_ac].apb37
               CALL s_gettrandbs() 
               LET li_dbs = g_dbs_tra
               #LET l_sql = "SELECT COUNT(*) FROM ",li_dbs CLIPPED,"ima_file ",
               LET l_sql = "SELECT COUNT(*) FROM ",cl_get_target_table(g_apb[l_ac].apb37,'ima_file'), #FUN-A50102
                           " WHERE ima01 = '",g_apb[l_ac].apb12,"' "
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	           CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102               
               PREPARE ima_pre FROM l_sql
               DECLARE ima_cs CURSOR FOR ima_pre
               OPEN ima_cs
               FETCH ima_cs INTO l_n
               IF l_n = 0 THEN                                                       
                  CALL cl_err(g_apb[l_ac].apb12,'aap-924',0)                         
                  NEXT FIELD apb12                                                   
               END IF                                   #TQC-750121
             END IF                              
          END IF
         #IF g_aptype='15' OR g_aptype='17' OR g_aptype='12' THEN  #No.FUN-690080   #CHI-990015 add 12                   #MOD-A90022 mark
          IF g_aptype='15' OR g_aptype='17' OR g_aptype='12' OR g_aptype='21' OR g_aptype='16' THEN  #No.FUN-690080   #CHI-990015 add 12  #MOD-A90022 #TQC-BA0155 add 16
             IF NOT cl_null(g_apb[l_ac].apb12) THEN
                LET g_no = g_apb[l_ac].apb12[1,4]
                CALL t110_apb12('a',g_no)
                IF NOT cl_null(g_errno) THEN
                   CALL cl_err(g_apb[l_ac].apb12,g_errno,0)
                   NEXT FIELD apb12
                END IF
            #----------------MOD-CC0258------------------mark
            ##TQC-C20183--add--start--
            #   CALL t110_apb09_check(l_apb24t,l_apa32f,l_pmc913) RETURNING l_flag,l_apb24t,l_apa32f
            #   IF NOT l_flag THEN
            #      LET g_apb28_t = g_apb[l_ac].apb28
            #      NEXT FIELD apb09
            #   END IF
            #   LET g_apb28_t = g_apb[l_ac].apb28
            ##TQC-C20183--add--end--
            #----------------MOD-CC0258------------------mark
             END IF
          END IF
 
        AFTER FIELD apb28    #單位
            LET l_flag = NULL                        #TQC-C20183
            IF NOT cl_null(g_apb[l_ac].apb28) THEN
               CALL t110_unit(g_apb[l_ac].apb28)
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apb[l_ac].apb28,g_errno,0)
                  LET g_apb[l_ac].apb28 = g_apb_t.apb28
                  NEXT FIELD apb28
               END IF
            #TQC-C20183--add--start--
               CALL t110_apb09_check(l_apb24t,l_apa32f,l_pmc913) RETURNING l_flag,l_apb24t,l_apa32f
               IF NOT l_flag THEN
                  LET g_apb28_t = g_apb[l_ac].apb28
                  NEXT FIELD apb09
               END IF
               LET g_apb28_t = g_apb[l_ac].apb28
            #TQC-C20183--add--end--
            END IF
 
        AFTER FIELD apb32    #人員編號
           IF NOT cl_null(g_apb[l_ac].apb32) THEN
              CALL t110_gen(g_apb[l_ac].apb32,'1')       #No.FUN-780046
              IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apb[l_ac].apb32,g_errno,0)
                  LET g_apb[l_ac].apb32 = g_apb_t.apb32
                  NEXT FIELD apb32
               END IF
           END IF
 
        AFTER FIELD apb08
           IF NOT cl_null(g_apb[l_ac].apb08) THEN  #No.TQC-7B0063
              IF g_apb[l_ac].apb08 < 0 THEN
                 CALL cl_err(g_apb[l_ac].apb08,'aap-505',0)
                 LET g_apb[l_ac].apb08 = NULL
                 NEXT FIELD apb08
              END IF
               LET g_apb[l_ac].apb08 = cl_digcut(g_apb[l_ac].apb08,g_azi03)   #No:BUG-530274   #No.MOD-560236   #MOD-6B0066
               DISPLAY BY NAME g_apb[l_ac].apb08   #No.MOD-530247
              IF g_apz.apz15 = 'N' AND g_aptype='11' THEN
                 #LET l_sql = "SELECT rvv38 FROM ",li_dbs CLIPPED,"rvv_file,",
                 #             li_dbs CLIPPED,"rvu_file ",
                 LET l_sql = "SELECT rvv38 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'),",", #FUN-A50102
                                                  cl_get_target_table(g_apb[l_ac].apb37,'rvu_file'),     #FUN-A50102
                             " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
                             "   AND rvv02 = '",g_apb[l_ac].apb22,"' ",
                             "   AND rvuconf='Y' AND rvv01=rvu01"
                 CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	             CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
                 PREPARE sel_rvv38_cs2 FROM l_sql
                 EXECUTE sel_rvv38_cs2 INTO l_rvv38
                 LET g_rvv38_n = l_rvv38 * g_apa.apa14
                  LET g_rvv38_n = cl_digcut(g_rvv38_n,g_azi03)    #No.MOD-510045   #MOD-6B0066
                 IF g_apb[l_ac].apb08 > g_rvv38_n THEN
                    CALL cl_err('','aap-775',0)
                    NEXT FIELD apb08
                 END IF
              END IF
              IF p_cmd='a' OR (p_cmd='u' AND g_apb[l_ac].apb08 <> g_apb_t.apb08) THEN
                 LET g_apb[l_ac].apb10 = g_apb[l_ac].apb24 * g_apa.apa14         #MOD-860221
                 CALL cl_digcut(g_apb[l_ac].apb10,g_azi04) 
                      RETURNING g_apb[l_ac].apb10
              END IF
              IF g_aptype[1,1] = '1' THEN
                 CALL t110_bud(p_cmd,'3')
                 IF NOT cl_null(g_errno) THEN
                    NEXT FIELD apb08 
                 END IF
              END IF
             #當匯率為1時,需檢核原幣與本幣的稅額、金額需相同
              IF g_apa.apa14 = 1 AND g_aza.aza17 = g_apa.apa13 THEN   #MOD-880041
                 IF g_apb[l_ac].apb23!=g_apb[l_ac].apb08 THEN
                    CALL cl_err('','apm-988',1)
                    NEXT FIELD apb08
                 END IF
              END IF
           END IF 
 
        BEFORE FIELD apb09   #數量
            #LET l_sql = "SELECT rvv87,rvv23,rvv88 FROM ",li_dbs CLIPPED,"rvv_file,",
            #             li_dbs CLIPPED,"rvu_file ",
            LET l_sql = "SELECT rvv87,rvv23,rvv88 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'),",", #FUN-A50102
                                                         cl_get_target_table(g_apb[l_ac].apb37,'rvu_file'),     #FUN-A50102
                        " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
                        "   AND rvv02 = '",g_apb[l_ac].apb22,"' ",
                        "   AND rvuconf='Y' AND rvv01=rvu01"
            CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	        CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102                
            PREPARE sel_rvv88_cs FROM l_sql
            EXECUTE sel_rvv88_cs INTO g_qty1,g_qty2,g_qty5
            IF g_qty1 IS NULL THEN
               LET g_qty1 = 0
            END IF
 
            IF g_qty2 IS NULL THEN
               LET g_qty2 = 0
            END IF
            IF g_aptype = '11' THEN
               CALL cl_getmsg('aap-049',g_lang) RETURNING g_msg
            END IF
            IF g_aptype = '21' AND g_apa.apa58 = '2' THEN
               CALL cl_getmsg('aap-089',g_lang) RETURNING g_msg
            END IF
            IF g_aptype = '11' AND g_apb[l_ac].apb29 = '3' AND                  
               g_apb[l_ac].apb34 = 'N' THEN                                     
               LET g_msg[10,25] = g_qty1*-1 USING '---,---,---.---'             
               LET g_msg[35,50] = g_qty2*-1 USING '---,---,---.---'             
               LET g_qty3 = g_qty1 - g_qty2                                     
               IF g_aptype = '11' OR (g_aptype = '21' AND g_apa.apa58 = '2') THEN
                  ERROR g_msg CLIPPED,g_qty3*-1 USING '---,---,---.---'         
               END IF                                                           
            ELSE                                                                
               LET g_msg[10,25] = g_qty1 USING '---,---,---.---'                
               LET g_msg[35,50] = g_qty2 USING '---,---,---.---'                
               LET g_qty3 = g_qty1 - g_qty2                                     
               IF g_aptype = '11' OR (g_aptype = '21' AND g_apa.apa58 = '2') THEN
                  ERROR g_msg CLIPPED,g_qty3 USING '---,---,---.---'            
               END IF                                                           
            END IF                                                              
           #-MOD-B20137-add-
            IF g_aptype = '16' AND cl_null(g_apb[l_ac].apb21) THEN 
               LET g_apb[l_ac].apb09 = 1 
            END IF
           #-MOD-B20137-end-
            #LET g_apb_t.apb09 = g_apb[l_ac].apb09             #MOD-A80093  #TQC-C50191 mark
 
        AFTER FIELD apb09
           #TQC-C60241--add--str--
            IF g_apa.apa00 = '26' THEN
               IF g_apb[l_ac].apb29 = '3' THEN
                  SELECT SUM(rvv87) INTO l_sum_rvv87
                    FROM rvv_file
                   WHERE rvv01 = g_apb[l_ac].apb21
                     AND rvv02 = g_apb[l_ac].apb22
                  SELECT SUM(apb09) INTO l_sum_apb09
                    FROM apb_file,apa_file
                   WHERE apb21 = g_apb[l_ac].apb21
                     AND apb22 = g_apb[l_ac].apb22
                     AND apa00 = '26'
                     AND apa01 = apb01
                  SELECT apb09 INTO l_apb09 
                    FROM apb_file,apa_file
                   WHERE apb21 = g_apb[l_ac].apb21
                     AND apb02 = g_apb[l_ac].apb02
                     AND apa00 = '26'
                     AND apa01 = apb01
                     AND apa01 = g_apa.apa01
                  IF cl_null(l_sum_rvv87) THEN
                     LET l_sum_rvv87 = 0
                  END IF 
                  IF cl_null(l_apb09) THEN
                     LET l_apb09 = 0
                  END IF 
                  IF cl_null(l_sum_apb09) THEN
                     LET l_sum_apb09 = 0
                  END IF
                  IF l_sum_apb09 + g_apb[l_ac].apb09 - l_apb09 > l_sum_rvv87 THEN 
                     CALL cl_err('','aap-240',1)
                     NEXT FIELD apb09    
                  END IF 
               END IF
            END IF
            #TQC-C60241--add--end--
         #FUN-910088-add--start--
            LET l_flag = NULL
            CALL t110_apb09_check(l_apb24t,l_apa32f,l_pmc913) RETURNING l_flag,l_apb24t,l_apa32f
            IF NOT l_flag THEN
               NEXT FIELD apb09
            END IF
         #FUN-910088--add--end--  
    #FUN-910088--mark--start--
    #       IF g_apa.apa00 MATCHES '1*' AND g_apb[l_ac].apb09 = 0 THEN
    #          IF g_apb[l_ac].apb29 = '3' AND g_qty1=0 THEN   #No.MOD-910062
    #          ELSE
    #             NEXT FIELD apb09
    #          END IF
    #       END IF
    #       IF g_apb[l_ac].apb34 = 'N' THEN
    #          IF g_aptype = '11' AND g_apb[l_ac].apb29 = '3' THEN
    #             #若是倉退時,是負數,要不同處理
    #             LET l_qty1 = g_apb[l_ac].apb09 * -1                           
    #             LET l_qty2 = g_apb_t.apb09     * -1                           
    #             # 已請款數量+本次請款數量-本次請款舊值+暫估數量>計價數量      
    #             IF g_qty2 + l_qty1 - l_qty2 + g_qty5 > g_qty1 THEN            
    #                CALL cl_err(g_qty1,'aap-048',1)
    #                LET g_apb[l_ac].apb09 = g_apb_t.apb09   #MOD-C10043
    #                NEXT FIELD apb09
    #             END IF
    #          ELSE
    #             IF g_aptype = '11' OR g_aptype = '21' OR 
    #                g_aptype = '16' OR g_aptype = '26' THEN
    #                IF (g_qty2-g_apb_t.apb09+g_apb[l_ac].apb09+g_qty5) > g_qty1 THEN  #No.TQC-7B0083  add暫估數量
    #                   CALL cl_err(g_qty1,'aap-048',1)
    #                   LET g_apb[l_ac].apb09 = g_apb_t.apb09   #MOD-C10043
    #                   NEXT FIELD apb09
    #                END IF
    #             END IF
    #          END IF
    #       END IF
    #       IF g_apb[l_ac].apb34 = 'Y' THEN
    #          IF g_aptype = '11' AND g_apb[l_ac].apb29 = '3' THEN
    #             IF g_apb_t.apb09 - g_apb[l_ac].apb09  > g_qty5 THEN
    #                CALL cl_err(g_apb[l_ac].apb09,'aap-818',1)
    #                NEXT FIELD apb09
    #             END IF
    #          ELSE
    #             IF g_apb[l_ac].apb09 - g_apb_t.apb09 > g_qty5 THEN
    #                CALL cl_err(g_apb[l_ac].apb09,'aap-818',1)
    #                NEXT FIELD apb09
    #             END IF
    #          END IF
    #       END IF
    #      #str CHI-B70013 add
    #      #IF (g_aptype = '15' OR g_aptype = '17') THEN                                        #MOD-B80278 mark
    #       IF (g_aptype='15' AND (g_apz.apz61='1' OR (g_apz.apz61='3' AND l_pmc913='Y'))) THEN #MOD-B80278
    #          LET l_pmn87=0   LET l_apb09_15=0
    #          #採購數量
    #          LET l_sql = "SELECT pmn87 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'),
    #                      " WHERE pmn01='",g_apb[l_ac].apb06,"' ",
    #                      "   AND pmn02='",g_apb[l_ac].apb07,"' "
    #          CALL cl_replace_sqldb(l_sql) RETURNING l_sql
    #          CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql
    #          PREPARE sel_pmn87_cs4 FROM l_sql
    #          EXECUTE sel_pmn87_cs4 INTO l_pmn87
    #          IF cl_null(l_pmn87) THEN LET l_pmn87=0 END IF

    #          #採購單已立預付數量
    #          SELECT SUM(apb09) INTO l_apb09_15 FROM apb_file,apa_file
    #           WHERE apb01=apa01             AND apa00='15'
    #             AND apb06=g_apb[l_ac].apb06 AND apb07=g_apb[l_ac].apb07
    #             AND apb01!=g_apa.apa01 
    #          IF cl_null(l_apb09_15) THEN LET l_apb09_15=0 END IF
    #          
    #          #當預付數量(之前已經預付+本次預付)>採購數量時,應提示訊息
    #          IF g_apb[l_ac].apb06 IS NOT NULL AND g_apb[l_ac].apb07 IS NOT NULL THEN   #No.MOD-B90115 add
    #             IF l_apb09_15 + g_apb[l_ac].apb09 > l_pmn87 THEN
    #                CALL cl_err(g_apb[l_ac].apb09,'aap-945',1)
    #                LET g_apb[l_ac].apb09 = l_pmn87 - l_apb09_15
    #                LET g_apb[l_ac].apb24 = g_apb[l_ac].apb09 * g_apb[l_ac].apb23
    #                LET g_apb[l_ac].apb10 = g_apb[l_ac].apb09 * g_apb[l_ac].apb08
    #                LET g_apb[l_ac].apb24 =cl_digcut(g_apb[l_ac].apb24,t_azi04)
    #                LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,g_azi04)
    #                DISPLAY BY NAME g_apb[l_ac].apb09,g_apb[l_ac].apb09,g_apb[l_ac].apb10
    #                NEXT FIELD apb09
    #             END IF
    #          END IF                                                                     #No.MOD-B90115 add

    #          #數量不可為負數
    #          IF g_apb[l_ac].apb09 < 0 THEN 
    #             CALL cl_err(g_apb[l_ac].apb09,'mfg1322',1)
    #             LET g_apb[l_ac].apb09 = l_pmn87 - l_apb09_15
    #             LET g_apb[l_ac].apb24 = g_apb[l_ac].apb09 * g_apb[l_ac].apb23
    #             LET g_apb[l_ac].apb10 = g_apb[l_ac].apb09 * g_apb[l_ac].apb08
    #             LET g_apb[l_ac].apb24 =cl_digcut(g_apb[l_ac].apb24,t_azi04)
    #             LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,g_azi04)
    #             DISPLAY BY NAME g_apb[l_ac].apb09,g_apb[l_ac].apb09,g_apb[l_ac].apb10
    #             NEXT FIELD apb09
    #          END IF
    #       END IF 
    #      #end CHI-B70013 add
    #       #單價含稅時,不使用單價*數量=金額,改以含稅金額回推稅率,以避免小數位差的問題
    #       LET l_gec04 = 0   LET l_gec07 = ''
    #       IF g_apb[l_ac].apb06 <> '' OR NOT cl_null(g_apb[l_ac].apb06) THEN   #TQC-8C0031 add 
    #         #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file,",
    #         #             li_dbs CLIPPED,"pmm_file ",
    #         #LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102            #MOD-A80052 mark
    #          LET l_sql = "SELECT gec04,gec05,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102      #MOD-A80052
    #                                                 cl_get_target_table(g_apb[l_ac].apb37,'pmm_file'),     #FUN-A50102
    #                      " WHERE gec01 = pmm21 ",
    #                      "   AND pmm01 = '",g_apb[l_ac].apb06,"' "
    #          CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
    #          CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
    #          PREPARE sel_gec07_pre FROM l_sql
    #         #EXECUTE sel_gec07_pre INTO l_gec04,l_gec07                #MOD-A80052 mark 
    #          EXECUTE sel_gec07_pre INTO l_gec04,l_gec05,l_gec07        #MOD-A80052
    #       ELSE  
    #          IF cl_null(g_apb04) THEN
    #            #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file,",
    #            #             li_dbs CLIPPED,"rva_file ",
    #            #LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102            #MOD-A80052 mark
    #             LET l_sql = "SELECT gec04,gec05,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102      #MOD-A80052 
    #                                                    cl_get_target_table(g_apb[l_ac].apb37,'rva_file'),     #FUN-A50102
    #                         " WHERE gec01 = rva115",
    #                         "   AND rva01 = '",g_apb04,"' ",
    #                         "   AND gec011 = '1' "
    #             CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
    #             CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
    #             PREPARE sel_gec07_pre1 FROM l_sql
    #            #EXECUTE sel_gec07_pre1 INTO l_gec04,l_gec07               #MOD-A80052 mark
    #             EXECUTE sel_gec07_pre1 INTO l_gec04,l_gec05,l_gec07       #MOD-A80052
    #          ELSE
    #             IF (g_apa.apa00 = '21' OR g_apa.apa00 = '26') AND
    #                 NOT cl_null(g_apb[l_ac].apb21) THEN
    #               #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file,",
    #               #             li_dbs CLIPPED,"rvu_file ",
    #               #LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102            #MOD-A80052 mark
    #                LET l_sql = "SELECT gec04,gec05,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102      #MOD-A80052 
    #                                                       cl_get_target_table(g_apb[l_ac].apb37,'rvu_file'),     #FUN-A50102
    #                            " WHERE gec01 = rvu115 AND gec011 = '1' ",
    #                            "   AND rvu01 = '",g_apb[l_ac].apb21,"' "
    #                CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
    #                CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
    #                PREPARE sel_gec07_pre2 FROM l_sql
    #               #EXECUTE sel_gec07_pre2 INTO l_gec04,l_gec07               #MOD-A80052 mark 
    #                EXECUTE sel_gec07_pre2 INTO l_gec04,l_gec05,l_gec07       #MOD-A80052
    #             ELSE
    #               #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file ",
    #               #LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'), #FUN-A50102            #MOD-A80052 mark
    #                LET l_sql = "SELECT gec04,gec05,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'), #FUN-A50102      #MOD-A80052 
    #                            " WHERE gec01 = '",g_apa.apa15,"' ",
    #                            "   AND gec011 = '1' "
    #                CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
    #                CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
    #                PREPARE sel_gec07_pre3 FROM l_sql
    #               #EXECUTE sel_gec07_pre3 INTO l_gec04,l_gec07               #MOD-A80052 mark
    #                EXECUTE sel_gec07_pre3 INTO l_gec04,l_gec05,l_gec07       #MOD-A80052
    #             END IF
    #          END IF
    #       END IF
    #       IF cl_null(l_gec04) THEN 
    #          LET l_gec04=0   
    #       END IF
    #       IF cl_null(l_gec07) THEN 
    #          SELECT gec07                                            #CHI-B90030 add
    #            INTO l_gec07                                          #CHI-B90030 add
    #            FROM gec_file                                         #CHI-B90030 add
    #           WHERE gec01=g_apa.apa15 AND gec011='1'                 #CHI-B90030 add
    #         #LET l_gec07='N'                                         #CHI-B90030 mark
    #       END IF
    #       LET l_rvv38t = 0
    #       IF g_apb[l_ac].apb09 <> g_apb_t.apb09 THEN    #MOD-A80093 
    #          IF l_gec07='Y' AND (g_aptype = '11' OR g_aptype = '16' OR g_aptype='21' OR g_aptype='26') THEN  #No.MOD-940381
    #             #LET l_sql = "SELECT rvv38t FROM ",li_dbs CLIPPED,"rvv_file ",
    #             LET l_sql = "SELECT rvv38t FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'), #FUN-A50102
    #                         " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
    #                         "   AND rvv02 = '",g_apb[l_ac].apb22,"' " 
    #             CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
    #                 CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
    #             PREPARE sel_rvv38t_pre FROM l_sql
    #             EXECUTE sel_rvv38t_pre INTO l_rvv38t
    #             IF cl_null(l_rvv38t) THEN LET l_rvv38t=0 END IF
    #             LET l_apb24t = l_rvv38t*g_apb[l_ac].apb09
    #             LET l_apb24t = cl_digcut(l_apb24t,t_azi04)
    #            #-MOD-A80052-add-
    #             IF l_gec05 = 'T' THEN
    #                LET l_apa32f = l_apb24t * (l_gec04/100)
    #                LET l_apa32f = cl_digcut(l_apa32f , t_azi04)
    #                LET g_apb[l_ac].apb24 = l_apb24t - l_apa32f 
    #             ELSE
    #                LET g_apb[l_ac].apb24 = l_apb24t/(1+l_gec04/100)
    #             END IF  
    #            #-MOD-A80052-end-
    #            #LET g_apb[l_ac].apb24 = l_apb24t/(1+l_gec04/100)           #MOD-A80052
    #          ELSE
    #            #-----------------------------------CHI-B90030------------------------------------------start
    #             IF l_gec07='Y' AND g_aptype = '12' THEN
    #                IF g_apb[l_ac].apb23 <> g_apb_t.apb23 OR
    #                   cl_null(g_apb_t.apb23) THEN
    #                   LET g_apb[l_ac].apb23 = cl_digcut(g_apb[l_ac].apb23/(1+l_gec04/100),t_azi03)
    #                   DISPLAY BY NAME g_apb[l_ac].apb23
    #                END IF
    #             END IF
    #            #-----------------------------------CHI-B90030--------------------------------------------end
    #             IF g_apb[l_ac].apb09>0 THEN
    #                LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09
    #             END IF
    #          END IF
    #          LET g_apb[l_ac].apb24 =cl_digcut(g_apb[l_ac].apb24,t_azi04)   #MOD-6B0066
    #         #-MOD-A90146-add-
    #          IF g_aptype = '12' THEN     #MOD-AB0167
    #             CALL t110_chkapb24()               
    #             IF g_apb[l_ac].apb34 = 'Y' AND g_apb[l_ac].apb24 > g_apb24 THEN
    #                LET g_apb[l_ac].apb09 = g_apb09
    #                CALL cl_err(g_apb[l_ac].apb09,'aap-972',1)
    #                NEXT FIELD apb09
    #             END IF
    #          END IF                      #MOD-AB0167
    #         #-MOD-A90146-end-
    #          DISPLAY BY NAME g_apb[l_ac].apb24
    #          IF g_apb[l_ac].apb34 = 'N' THEN   #MOD-960328 add
    #             LET g_apb[l_ac].apb08 =g_apb[l_ac].apb23 * g_apa.apa14
    #             LET g_apb[l_ac].apb08 =cl_digcut(g_apb[l_ac].apb08,g_azi03)   #No.MOD-510045   #MOD-6B0066
    #             LET g_apb[l_ac].apb10 =g_apb[l_ac].apb24 * g_apa.apa14        #MOD-840632   #MOD-860221 mark回復
    #             LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,g_azi04)   #MOD-6B0066
    #          ELSE
    #             #有沖暫估時,應抓暫估單匯率來計算
    #             LET l_apa14=1
    #             #LET l_sql = "SELECT apa14 FROM ",li_dbs CLIPPED,"apa_file,",
    #             #             li_dbs CLIPPED,"apb_file ",
    #             LET l_sql = "SELECT apa14 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'apa_file'),",", #FUN-A50102
    #                                              cl_get_target_table(g_apb[l_ac].apb37,'apb_file'),     #FUN-A50102
    #                         " WHERE apa01=apb01 AND apa00='16' ",
    #                         "   AND apb21='",g_apb[l_ac].apb21,"' ",
    #                         "   AND apb22='",g_apb[l_ac].apb22,"' "
    #             CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
    #                 CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
    #             PREPARE sel_apa14_pre FROM l_sql
    #             EXECUTE sel_apa14_pre INTO l_apa14
    #             IF cl_null(l_apa14) THEN LET l_apa14=1 END IF
    #             LET g_apb[l_ac].apb08 =g_apb[l_ac].apb23 * l_apa14
    #             LET g_apb[l_ac].apb08 =cl_digcut(g_apb[l_ac].apb08,g_azi03)
    #             LET g_apb[l_ac].apb10 =g_apb[l_ac].apb24 * l_apa14
    #             LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,g_azi04)
    #          END IF
    #          DISPLAY BY NAME g_apb[l_ac].apb08
    #          DISPLAY BY NAME g_apb[l_ac].apb10
    #       END IF                                        #MOD-A80093
    #       IF g_aptype[1,1] = '1' THEN
    #          CALL t110_bud(p_cmd,'3')
    #          IF NOT cl_null(g_errno) THEN
    #             NEXT FIELD apb09 
    #          END IF
    #       END IF
    #FUN-910088--mark--end--
 
      BEFORE FIELD apb25
          IF (g_aptype = '11' OR g_aptype = '21') THEN
             IF g_apa.apa51 = 'STOCK' THEN
                #LET l_sql = "SELECT rvv32,rvv33 FROM ",li_dbs CLIPPED,"rvv_file ",
                LET l_sql = "SELECT rvv32,rvv33 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'), #FUN-A50102
                            " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
                            "   AND rvv02 = '",g_apb[l_ac].apb22,"' " 
                CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	            CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
                PREPARE sel_rvv32_pre FROM l_sql
                EXECUTE sel_rvv32_pre INTO l_rvv32,l_rvv33
                IF g_azw.azw04 = '2' AND (g_apa.apa76 = '2' OR g_apa.apa76 = '3') THEN
                   CALL t110_act_1(g_apb[l_ac].apb12,l_rvv32,l_rvv33,'0')
                        RETURNING g_apb[l_ac].apb25
                ELSE
                   CALL t110_stock_act(g_apb[l_ac].apb12,l_rvv32,l_rvv33,'0',g_apb[l_ac].apb37)    #No.FUN-680029   #FUN-9C0041 add apb37
                     RETURNING g_apb[l_ac].apb25
                END IF    #FUN-9C0041
                DISPLAY BY NAME g_apb[l_ac].apb25
             END IF
          END IF
#         IF g_aptype = '12' AND g_apa.apa51 = 'STOCK' THEN
          IF g_apa.apa51 = 'STOCK' THEN    #No.MOD-A80103
             #LET l_sql = "SELECT ima39 FROM ",li_dbs CLIPPED,"ima_file ",
             LET l_sql = "SELECT ima39 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'ima_file'), #FUN-A50102
                         " WHERE ima01='",g_apb[l_ac].apb12,"' "
             CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
             PREPARE sel_ima39_pre FROM l_sql
             EXECUTE sel_ima39_pre INTO g_apb[l_ac].apb25
          END IF
 
 
        AFTER FIELD apb25
            CALL t110_set_entry_b(p_cmd)
            CALL t110_set_entry_b_1()  #No.FUN-8A0075 
            CALL t110_set_no_entry_b(p_cmd) 
            CALL t110_set_no_entry_b_1()  #No.FUN-8A0075
 
            IF g_apy.apydmy5='Y' AND g_apa.apa00[1,1]='1' AND
               cl_null(g_apb[l_ac].apb25) THEN
               CALL cl_err(g_apb[l_ac].apb25,'mfg0037',0)
               NEXT FIELD apb25
            END IF
            LET g_plant_new = g_apb[l_ac].apb37
            CALL s_gettrandbs() 
            LET li_dbs = g_dbs_tra
            IF NOT cl_null(g_apb[l_ac].apb25) THEN
              #LET l_sql = "SELECT aag02 FROM ",li_dbs CLIPPED,"aag_file ",
              LET l_sql = "SELECT aag02,aagacti FROM ",cl_get_target_table(g_apb[l_ac].apb37,'aag_file'), #FUN-A50102  #No.TQC-B90213
                          " WHERE aag01 = '",g_apb[l_ac].apb25,"' ",
                          "    AND aag00 = '",g_bookno1,"' ",
                          "    AND aag07 !='1' AND aag03 = '2' ",
                          "   AND aagacti = 'Y'"                         #No.MOD-B70280 add
              CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	          CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
              PREPARE aag_pre FROM l_sql
              DECLARE aag_cs CURSOR FOR aag_pre
              OPEN aag_cs
              FETCH aag_cs INTO g_apb[l_ac].b25,l_aagacti               #No.TQC-B90213 
               DISPLAY g_apb[l_ac].b25 to b25        #FUN-710078 add
               IF SQLCA.sqlcode OR l_aagacti <> 'Y' THEN                #No.TQC-B90213
#No.FUN-B20059 --begin
                  CALL cl_err3("sel","aag_file",g_apb[l_ac].apb25,"","mfg1004","","",0)  #No.FUN-660122  #No.B90213
                  CALL q_m_aag(FALSE,FALSE,g_apb[l_ac].apb37,g_apb[l_ac].apb25,'23',g_bookno1)
                       RETURNING g_apb[l_ac].apb25                  
#No.FUN-B20059 --end
                  NEXT FIELD apb25
               END IF
               LET l_aag05=''  #FUN-8C0106 add
               #LET l_sql = "SELECT aag05 FROM ",li_dbs CLIPPED,"aag_file ",
               LET l_sql = "SELECT aag05 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'aag_file'), #FUN-A50102
                           " WHERE aag01 = '",g_apb[l_ac].apb25,"' ",
                           "   AND aag00 = '",g_bookno1,"' ",
                           "   AND aagacti = 'Y'"                        #No.MOD-B70280 add
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	          CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
               PREPARE sel_aag_pre1 FROM l_sql
               EXECUTE sel_aag_pre1 INTO l_aag05 
               #當執行aapt120,若單身科目需做部門管理,單身部門預設帶入單頭部門
               IF g_aptype='12' AND NOT cl_null(g_apb[l_ac].apb25) AND 
                 #l_aag05='Y' THEN                                              #MOD-A70003 mark
                  l_aag05='Y' AND cl_null(g_apb[l_ac].apb26) THEN               #MOD-A70003
                  LET g_apb[l_ac].apb26 = g_apa.apa22
                  DISPLAY g_apb[l_ac].apb26 TO s_apb[l_ac].apb26
               END IF
              #防止User只修改部門欄位時,未再次檢查會科與允許/拒絕部門關係
               LET g_errno = ' '   
               IF l_aag05 = 'Y' THEN
                 #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                  IF g_aaz.aaz90 ='Y' THEN
                     IF NOT cl_null(g_apb[l_ac].apb930) THEN 
                        CALL s_chkdept_dbs(g_aaz.aaz72,g_apb[l_ac].apb25,g_apb[l_ac].apb930,  #FUN-9A0093
                                           g_bookno1,g_apb[l_ac].apb37)                       #FUN-9A0093
                                      RETURNING g_errno
                     END IF
                  ELSE
                     IF NOT cl_null(g_apb[l_ac].apb26) THEN 
                       CALL s_chkdept_dbs(g_aaz.aaz72,g_apb[l_ac].apb25,g_apb[l_ac].apb26,
                                          g_bookno1,g_apb[l_ac].apb37)
                                      RETURNING g_errno
                     END IF 
                  END IF
                  IF NOT cl_null(g_errno) THEN
                     CALL cl_err('',g_errno,0)
                     NEXT FIELD apb26   #MOD-940326 mod apb25->apb26
                  END IF
               END IF
            END IF
            IF NOT cl_null(g_apb[l_ac].apb06) AND NOT cl_null(g_apb[l_ac].apb07) THEN
               LET g_t1 = s_get_doc_no(g_apb[l_ac].apb06)   #MOD-630070
               #LET l_sql = "SELECT smy59 FROM ",li_dbs CLIPPED,"smy_file ",
               LET l_sql = "SELECT smy59 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'smy_file'), #FUN-A50102
                           " WHERE smyslip = '",g_t1,"' "
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	          CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
               PREPARE sel_smy59_cs FROM l_sql
               EXECUTE sel_smy59_cs INTO l_smy59
               #LET l_sql ="SELECT COUNT(*) FROM ",li_dbs CLIPPED,"pmn_file,",
               #            li_dbs CLIPPED,"pmm_file",
               LET l_sql ="SELECT COUNT(*) FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'),",", #FUN-A50102
                                                  cl_get_target_table(g_apb[l_ac].apb37,'pmm_file'),     #FUN-A50102
                          " WHERE pmn01='",g_apb[l_ac].apb06,"' ",
                          "   AND pmn02='",g_apb[l_ac].apb07,"' ",
                          "   AND pmn01=pmm01 AND pmm18='Y' ",
                          "   AND pmm02 = 'SUB' "   #委外
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	          CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102               
               PREPARE sel_pmm_pre1 FROM l_sql
               EXECUTE sel_pmm_pre1 INTO g_cnt
               IF g_cnt > 0 THEN    #委外採購
                  IF g_apy.apydmy5 = 'Y' THEN   #預算控管
                     #LET l_sql = "SELECT pmn40 FROM ",li_dbs CLIPPED,"pmn_file ",
                     LET l_sql = "SELECT pmn40 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'), #FUN-A50102
                                 " WHERE pmn01='",g_apb[l_ac].apb06,"' ",
                                 "   AND pmn02='",g_apb[l_ac].apb07,"' "
                     CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                 CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
                     PREPARE sel_pmm40_pre FROM l_sql
                     EXECUTE sel_pmm40_pre INTO l_pmn40
                     IF l_pmn40!=g_apb[l_ac].apb25 THEN
                        CALL cl_err(g_apb[l_ac].apb25,'apm-311',0)
                        NEXT FIELD apb25
                     END IF
                  END IF
               ELSE
                  IF g_apy.apydmy5 = 'Y' AND l_smy59 = 'Y' THEN   #作預算控管
                     #LET l_sql = "SELECT pmn40 FROM ",li_dbs CLIPPED,"pmn_file ",
                     LET l_sql = "SELECT pmn40 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'), #FUN-A50102
                                 " WHERE pmn01='",g_apb[l_ac].apb06,"' ",
                                 "   AND pmn02='",g_apb[l_ac].apb07,"' "
                     CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                 CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102                
                     PREPARE sel_pmn40_pre2 FROM l_sql
                     EXECUTE sel_pmn40_pre2 INTO l_pmn40
                     IF l_pmn40!=g_apb[l_ac].apb25 THEN
                        CALL cl_err(g_apb[l_ac].apb25,'apm-311',0)
                        NEXT FIELD apb25
                     END IF
                  END IF
               END IF
            END IF
            IF g_aptype[1,1] = '1' THEN
               CALL t110_bud(p_cmd,'1')
               IF NOT cl_null(g_errno) THEN
                  NEXT FIELD apb26            #MOD-A90094 mod apb25 -> apb26
               END IF
            END IF
 
      BEFORE FIELD apb251
          IF (g_aptype = '11' OR g_aptype = '21') THEN
             IF g_apa.apa511 = 'STOCK' THEN
                #LET l_sql = "SELECT rvv32,rvv33 FROM ",li_dbs CLIPPED,"rvv_file ",
                LET l_sql = "SELECT rvv32,rvv33 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'), #FUN-A50102
                            " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
                            "   AND rvv02 = '",g_apb[l_ac].apb22,"' "
                CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	            CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102               
                PREPARE sel_rvv32_cs FROM l_sql
                EXECUTE sel_rvv32_cs INTO l_rvv32,l_rvv33
                IF g_azw.azw04 = '2' AND (g_apa.apa76 = '2' OR g_apa.apa76 = '3') THEN
                   CALL t110_act_1(g_apb[l_ac].apb12,l_rvv32,l_rvv33,'1')
                        RETURNING g_apb[l_ac].apb251
                ELSE
                CALL t110_stock_act(g_apb[l_ac].apb12,l_rvv32,l_rvv33,'1',g_apb[l_ac].apb37)    #No.FUN-680029   #FUN-9C0041 add apb37
                     RETURNING g_apb[l_ac].apb251
                END IF   #FUN-9C0041
                DISPLAY BY NAME g_apb[l_ac].apb251
             END IF
          END IF
 
        AFTER FIELD apb251
            CALL t110_set_entry_b(p_cmd)
            CALL t110_set_entry_b_1()  #No.FUN-8A0075
            CALL t110_set_no_entry_b(p_cmd)
            CALL t110_set_no_entry_b_1()  #No.FUN-8A0075
 
            IF g_apy.apydmy5='Y' AND g_apa.apa00[1,1]='1' AND
               cl_null(g_apb[l_ac].apb251) THEN
               CALL cl_err(g_apb[l_ac].apb251,'mfg0037',0)
               NEXT FIELD apb251
            END IF
            LET g_plant_new = g_apb[l_ac].apb37
            CALL s_gettrandbs() 
            LET li_dbs = g_dbs_tra
            IF NOT cl_null(g_apb[l_ac].apb251) THEN
               #LET l_sql = "SELECT aag02 FROM ",li_dbs CLIPPED,"aag_file ",
               LET l_sql = "SELECT aag02,aagacti FROM ",cl_get_target_table(g_apb[l_ac].apb37,'aag_file'), #FUN-A50102  #No.TQC-B90213
                           " WHERE aag01 = '",g_apb[l_ac].apb251,"' " ,
                           "   AND aag00 = '",g_bookno2,"' ",
                           "   AND aag07 !='1' AND aag03 = '2' ",
                           "   AND aagacti = 'Y'"                         #No.MOD-B70280 add
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	            CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
               PREPARE aag_pre1 FROM l_sql
               DECLARE aag_cs1 CURSOR FOR aag_pre1
               OPEN aag_cs1
               FETCH aag_cs1 INTO g_apb[l_ac].b251,l_aagacti             #No.TQC-B90213
                 
               DISPLAY g_apb[l_ac].b251 to b251        #FUN-710078 add
 
               IF SQLCA.sqlcode OR l_aagacti <> 'Y' THEN                 #No.TQC-B90213
#No.FUN-B20059 --begin
                  CALL cl_err3("sel","aag_file",g_apb[l_ac].apb251,"","mfg1004","","",0)  #No.FUN-660122  #No.TQC-B90213
                  CALL q_m_aag(FALSE,FALSE,g_apb[l_ac].apb37,g_apb[l_ac].apb251,'23',g_bookno2)
                      RETURNING g_apb[l_ac].apb251
#No.FUN-B20059 --end
                  NEXT FIELD apb251
               END IF
               LET l_aag05=''   #FUN-8C0106 add
               #LET l_sql = "SELECT aag05 FROM ",li_dbs CLIPPED,"aag_file ",
               LET l_sql = "SELECT aag05 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'aag_file'), #FUN-A50102
                           " WHERE aag01 = '",g_apb[l_ac].apb251,"' ",
                           "   AND aag00 = '",g_bookno2,"' ",
                           "   AND aagacti = 'Y'"                         #No.MOD-B70280 add 
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	            CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102                 
               PREPARE aag05_cs FROM l_sql
               EXECUTE aag05_cs INTO l_aag05
 
           #防止User只修改部門欄位時,未再次檢查會科與允許/拒絕部門關係
            LET g_errno = ' '   
            IF l_aag05 = 'Y' AND NOT cl_null(g_apb[l_ac].apb251) THEN
               IF g_aaz.aaz90 ='Y' THEN
                  IF NOT cl_null(g_apb[l_ac].apb930) THEN
                     CALL s_chkdept_dbs(g_aaz.aaz72,g_apb[l_ac].apb251,g_apb[l_ac].apb930,
                                        g_bookno2,g_apb[l_ac].apb37)
                                   RETURNING g_errno
                  END IF 
               ELSE
                  IF NOT cl_null(g_apb[l_ac].apb26) THEN
                     CALL s_chkdept_dbs(g_aaz.aaz72,g_apb[l_ac].apb251,g_apb[l_ac].apb26,
                                        g_bookno2,g_apb[l_ac].apb37)
                                   RETURNING g_errno
                  END IF
               END IF
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,0)
                  NEXT FIELD apb26   #MOD-940326 mod apb251->apb26
               END IF
            END IF
 
 
            END IF
            IF NOT cl_null(g_apb[l_ac].apb06) AND NOT cl_null(g_apb[l_ac].apb07) THEN
               LET g_t1 = s_get_doc_no(g_apb[l_ac].apb06)   #MOD-630070
               #LET l_sql = "SELECT smy59 FROM ",li_dbs CLIPPED,"smy_file ",
               LET l_sql = "SELECT smy59 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'smy_file'), #FUN-A50102
                           " WHERE smyslip = '",g_t1,"' "
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	            CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
               PREPARE smy59_cs1 FROM l_sql
               EXECUTE smy59_cs1 INTO l_smy59

               #LET l_sql = "SELECT COUNT(*) FROM ",li_dbs CLIPPED,"pmn_file,",
               #             li_dbs CLIPPED,"pmm_file ",
               LET l_sql = "SELECT COUNT(*) FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'),",", #FUN-A50102
                                                   cl_get_target_table(g_apb[l_ac].apb37,'pmm_file'),     #FUN-A50102
                           " WHERE pmn01='",g_apb[l_ac].apb06,"' ",
                           "   AND pmn02='",g_apb[l_ac].apb07,"' ",
                           "   AND pmn01=pmm01 AND pmm18='Y' AND pmm02 = 'SUB' " #委外
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	            CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
               PREPARE pmn_cou FROM l_sql
               EXECUTE pmn_cou INTO g_cnt
               IF g_cnt > 0 THEN    #委外採購
                  IF g_apy.apydmy5 = 'Y' THEN   #預算控管
                     #LET l_sql = "SELECT pmn401 FROM ",li_dbs CLIPPED,"pmn_file ",
                     LET l_sql = "SELECT pmn401 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'), #FUN-A50102
                                 " WHERE pmn01='",g_apb[l_ac].apb06,"' ",
                                 "   AND pmn02='",g_apb[l_ac].apb07,"' " 
                     CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                 CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
                     PREPARE pmn401_cs1 FROM l_sql
                     EXECUTE pmn401_cs1 INTO l_pmn40
                     IF l_pmn40!=g_apb[l_ac].apb251 THEN
                        CALL cl_err(g_apb[l_ac].apb251,'apm-311',0)
                        NEXT FIELD apb251
                     END IF
                  END IF
               ELSE
                  IF g_apy.apydmy5 = 'Y' AND l_smy59 = 'Y' THEN   #作預算控管
                     #LET l_sql = "SELECT pmn401 FROM ",li_dbs CLIPPED,"pmn_file ",
                     LET l_sql = "SELECT pmn401 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'), #FUN-A50102
                                 " WHERE pmn01='",g_apb[l_ac].apb06,"' ",
                                 "   AND pmn02='",g_apb[l_ac].apb07,"' "
                     CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                 CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
                     PREPARE sel_pmn401_cs1 FROM l_sql                             
                     EXECUTE sel_pmn401_cs1 INTO l_pmn40
                     IF l_pmn40!=g_apb[l_ac].apb251 THEN
                        CALL cl_err(g_apb[l_ac].apb251,'apm-311',0)
                        NEXT FIELD apb251
                     END IF
                  END IF
               END IF
            END IF
            IF g_aptype[1,1] = '1' THEN
               CALL t110_bud(p_cmd,'2')
               IF NOT cl_null(g_errno) THEN
                  NEXT FIELD apb251
               END IF
            END IF
 
        AFTER FIELD apb26
            #FUN-D80031 add ----------- begin
            IF g_prog = 'aapt140' THEN
               CALL t110_apb26_1('a')
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,0)
                  LET g_apb[l_ac].apb26 = g_apb_t.apb26
                  NEXT FIELD apb26
               END IF
            ELSE
            #FUN-D80031 add ----------- end
               IF cl_null(g_apb[l_ac].apb25) THEN
                  LET l_aag05 = 'N'
               ELSE
                  #LET l_sql = "SELECT aag05 FROM ",li_dbs CLIPPED,"aag_file ",
                  LET l_sql = "SELECT aag05 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'aag_file'), #FUN-A50102
                              " WHERE aag01 = '",g_apb[l_ac].apb25,"' ",
                              "   AND aag00 = '",g_bookno1,"' ",
                              "   AND aagacti = 'Y'"                        #No.MOD-B70280 add
                  CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	            CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
                  PREPARE aag05_cs2 FROM l_sql
                  EXECUTE aag05_cs2 INTO l_aag05
               END IF
               IF  l_aag05 = 'Y'                         #No.MOD-530422
                  AND g_apa.apa00[1,1]='1' AND cl_null(g_apb[l_ac].apb26) THEN
                  CALL cl_err(g_apb[l_ac].apb26,'mfg0037',0)
                  NEXT FIELD apb26
               END IF
               LET g_plant_new = g_apb[l_ac].apb37
               CALL s_gettrandbs() 
               LET li_dbs = g_dbs_tra
               IF NOT cl_null(g_apb[l_ac].apb26) THEN
                  #LET l_sql = "SELECT gem02 FROM ",li_dbs CLIPPED,"gem_file ",
                  LET l_sql = "SELECT gem02 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gem_file'), #FUN-A50102
                              " WHERE gem01 ='", g_apb[l_ac].apb26,"' ",
                              "   AND gem05 = 'Y' AND gemacti='Y' " 
                  CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
   	           CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
                  PREPARE gem_pre FROM l_sql
                  DECLARE gem_cs CURSOR FOR gem_pre
                  OPEN gem_cs
                  FETCH gem_cs INTO g_apb[l_ac].b26
 
                  IF SQLCA.sqlcode THEN
                    #CALL cl_err3("sel","gem_file",g_apb[l_ac].apb26,"","agl-003","","",1)  #No.FUN-660122 #MOD-CC0067 mark
                     CALL cl_err3("sel","gem_file",g_apb[l_ac].apb26,"","agl-202","","",1)  #MOD-CC0067 add
                     NEXT FIELD apb26
                  END IF
 
               END IF
 
               DISPLAY g_apb[l_ac].b26 to b26         #FUN-710078 mod
 
               IF NOT cl_null(g_apb[l_ac].apb06) AND
                  NOT cl_null(g_apb[l_ac].apb07) THEN
                  LET g_t1 = s_get_doc_no(g_apb[l_ac].apb06)   #MOD-630070
                  #LET l_sql = "SELECT smy59 FROM ",li_dbs CLIPPED,"smy_file ",
                  LET l_sql = "SELECT smy59 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'smy_file'), #FUN-A50102
                              " WHERE smyslip = '",g_t1,"' "
                  CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	              CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
                  PREPARE sel_smy59 FROM l_sql
                  EXECUTE sel_smy59 INTO l_smy59

                  #LET l_sql = "SELECT COUNT(*) FROM ",li_dbs CLIPPED,"pmn_file,",
                  #             li_dbs CLIPPED,"pmm_file",
                  LET l_sql = "SELECT COUNT(*) FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'),",", #FUN-A50102
                                                      cl_get_target_table(g_apb[l_ac].apb37,'pmm_file'),     #FUN-A50102
                              " WHERE pmn01='",g_apb[l_ac].apb06,"' ",
                              "   AND pmn02='",g_apb[l_ac].apb07,"' ",
                              "   AND pmn01=pmm01 AND pmm18='Y' AND pmm02 = 'SUB'" #委外
                  CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	           CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
                  PREPARE sel_pmn_cou1 FROM l_sql
                  EXECUTE sel_pmn_cou1 INTO g_cnt
                  IF g_cnt > 0 THEN    #委外採購
                     IF g_apy.apydmy5 = 'Y' THEN   #預算控管
                        #LET l_sql = "SELECT pmn67 FROM ",li_dbs CLIPPED,"pmn_file",
                        LET l_sql = "SELECT pmn67 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'), #FUN-A50102
                                    " WHERE pmn01='",g_apb[l_ac].apb06,"' ",
                                    "   AND pmn02='",g_apb[l_ac].apb07,"' "
                        CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                    CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
                        PREPARE sel_pmn67_cs1 FROM l_sql
                        EXECUTE sel_pmn67_cs1 INTO l_pmn67
                        IF l_pmn67!=g_apb[l_ac].apb26 THEN
                           CALL cl_err(g_apb[l_ac].apb26,'apm-311',0)
                           NEXT FIELD apb26
                        END IF
                     END IF
                  ELSE
                     IF g_apy.apydmy5 = 'Y' AND l_smy59 = 'Y' THEN   #作預算控管
                        #LET l_sql = "SELECT pmn67 FROM ",li_dbs CLIPPED,"pmn_file",
                        LET l_sql = "SELECT pmn67 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'), #FUN-A50102
                                    " WHERE pmn01='",g_apb[l_ac].apb06,"' ",
                                    "   AND pmn02='",g_apb[l_ac].apb07,"' "
                        CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                 CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102               
                        PREPARE sel_pmn67_cs2 FROM l_sql
                        EXECUTE sel_pmn67_cs2 INTO l_pmn67
                        IF l_pmn67!=g_apb[l_ac].apb26 THEN
                           CALL cl_err(g_apb[l_ac].apb26,'apm-311',0)
                           NEXT FIELD apb26
                        END IF
                     END IF
                  END IF
               END IF
#MOD-590301 防止User只修改部門欄位時,未再次檢查會科與允許/拒絕部門關係
   
               LET l_aag05=''   
               #LET l_sql = "SELECT aag05 FROM ",li_dbs CLIPPED,"aag_file ",
               LET l_sql = "SELECT aag05 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'aag_file'), #FUN-A50102
                           " WHERE aag01 = '",g_apb[l_ac].apb25,"' ",
                           "   AND aag00 = '",g_bookno1,"' ",
                           "   AND aagacti = 'Y'"                        #No.MOD-B70280 add
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	        CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
               PREPARE aag05_cs1 FROM l_sql
               EXECUTE aag05_cs1 INTO l_aag05
 
               LET g_errno = ' '   #MOD-5B0255
               IF l_aag05 = 'Y' AND NOT cl_null(g_apb[l_ac].apb25) THEN
                  IF g_aaz.aaz90 !='Y' THEN    #FUN-8C0106 add
                     CALL s_chkdept_dbs(g_aaz.aaz72,g_apb[l_ac].apb25,g_apb[l_ac].apb26,
                                     g_bookno1,g_apb[l_ac].apb37)
                                RETURNING g_errno
                  END IF
                  IF NOT cl_null(g_errno) THEN
                     CALL cl_err('',g_errno,0)
                     NEXT FIELD apb25   #MOD-940326 mod apb26->apb25
                  END IF
               END IF
               IF g_aza.aza63='Y' THEN 
                  LET l_aag05=''   
                  #LET l_sql = "SELECT aag05 FROM ",li_dbs CLIPPED,"aag_file ",
                  LET l_sql = "SELECT aag05 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'aag_file'), #FUN-A50102
                              " WHERE aag01 = '",g_apb[l_ac].apb251,"' ",
                              "   AND aag00 = '",g_bookno2,"' ",
                              "   AND aagacti = 'Y'"                        #No.MOD-B70280 add
                  CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	           CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
                  PREPARE sel_aag05_cs6 FROM l_sql
                  EXECUTE sel_aag05_cs6 INTO l_aag05
                  LET g_errno = ' '   #MOD-5B0255
                  IF l_aag05 = 'Y' AND NOT cl_null(g_apb[l_ac].apb251) THEN
                     IF g_aaz.aaz90 !='Y' THEN   #FUN-8C0106 add
                        CALL s_chkdept_dbs(g_aaz.aaz72,g_apb[l_ac].apb251,g_apb[l_ac].apb26,
                                        g_bookno2,g_apb[l_ac].apb37)
                                      RETURNING g_errno
                     END IF
                     IF NOT cl_null(g_errno) THEN
                        CALL cl_err('',g_errno,0)
                        NEXT FIELD apb251   #MOD-940326 mod apb26->apb251
                     END IF
                  END IF
               END IF  #FUN-8C0106 add
               IF g_aptype[1,1] = '1' THEN
                  CALL t110_bud(p_cmd,'3')
                  IF NOT cl_null(g_errno) THEN
                     NEXT FIELD apb26 
                  END IF
               END IF
            END IF      #FUN-D80031 add
 
        AFTER FIELD apb23
           IF NOT cl_null(g_apb[l_ac].apb23) THEN #No.TQC-7B0063
              IF g_apb[l_ac].apb23 < 0 THEN
                 CALL cl_err(g_apb[l_ac].apb23,'aap-505',0)
                 LET g_apb[l_ac].apb23 = NULL
                 NEXT FIELD apb23
              END IF
              LET g_apb[l_ac].apb23 = cl_digcut(g_apb[l_ac].apb23,t_azi03)   #No:BUG-530274   #No.MOD-560236   #MOD-6B0066
              DISPLAY BY NAME g_apb[l_ac].apb23   #No.MOD-530247
              IF g_aptype = '26' THEN
                #倉退暫估單apa00='26'
                #若單身有輸入採購單(apb06,apb07),則回採購單抓未稅單價(pmn31)
                 IF NOT cl_null(g_apb[l_ac].apb06) AND
                    NOT cl_null(g_apb[l_ac].apb07) THEN
                    LET l_pmn31=0
                    #LET l_sql = "SELECT pmn31 FROM ",li_dbs CLIPPED,"pmn_file ",
                    LET l_sql = "SELECT pmn31 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'), #FUN-A50102
                                " WHERE pmn01='",g_apb[l_ac].apb06,"' ",
                                "   AND pmn02='",g_apb[l_ac].apb07,"' "
                    CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
                    PREPARE sel_pmn31_cs5 FROM l_sql
                    EXECUTE sel_pmn31_cs5 INTO l_pmn31
                    IF g_apb[l_ac].apb23 > l_pmn31  THEN
                       CALL cl_err('','aap-939',1)   #單價不可大於採購單價
                       NEXT FIELD apb23
                    END IF
                 ELSE
                    IF NOT cl_null(g_apb04) AND NOT cl_null(g_apb05) THEN
                       LET l_pmn31=0
                       #LET l_sql = "SELECT rvb10 FROM ",li_dbs CLIPPED,"rvb_file",
                       LET l_sql = "SELECT rvb10 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvb_file'), #FUN-A50102
                                   " WHERE rvb01='",g_apb04,"' ",
                                   "   AND rvb02='",g_apb05,"' "
                       CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                   CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
                       PREPARE sel_rvb10_cs5 FROM l_sql
                       EXECUTE sel_rvb10_cs5 INTO l_pmn31
                       IF g_apb[l_ac].apb23 > l_pmn31  THEN
                          CALL cl_err('','aap-908',1)
                          NEXT FIELD apb23
                       END IF
                    ELSE
                       IF NOT cl_null(g_apb[l_ac].apb21) AND NOT cl_null(g_apb[l_ac].apb22) THEN
                          LET l_pmn31=0
                          #LET l_sql = "SELECT rvv38 FROM ",li_dbs CLIPPED,"rvb_file",
                         #LET l_sql = "SELECT rvv38 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvb_file'), #FUN-A50102 #MOD-BB0175 mark
                          LET l_sql = "SELECT rvv38 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'), #MOD-BB0175 add
                                      " WHERE rvv01='",g_apb[l_ac].apb21,"' ",
                                      "   AND rvv02='",g_apb[l_ac].apb22,"' "
                          CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                      CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
                          PREPARE sel_rvv38_cs6 FROM l_sql
                          EXECUTE sel_rvv38_cs6 INTO l_pmn31
                          IF g_apb[l_ac].apb23 > l_pmn31  THEN
                            #CALL cl_err('','aap-976',1)          #MOD-C20032 mark
                             CALL cl_err('','aap-976',0)          #MOD-C20032 add
                             NEXT FIELD apb23
                          END IF
                       END IF
                    END IF
                 END IF
              END IF
              IF g_aptype = '11' THEN
                 IF g_apb[l_ac].apb23 > l_rvv38  THEN
                   #CALL cl_err('','aap-976',1)                   #MOD-C20032 mark
                    CALL cl_err('','aap-976',0)                   #MOD-C20032 add
                    NEXT FIELD apb23
                 END IF
              END IF
              LET g_apb[l_ac].apb08 = g_apb[l_ac].apb23 * g_apa.apa14
              LET g_apb[l_ac].apb08 =cl_digcut(g_apb[l_ac].apb08,g_azi03)     #No.MOD-510045   #MOD-6B0066
              DISPLAY BY NAME g_apb[l_ac].apb08
              #單價含稅時,不使用單價*數量=金額,改以含稅金額回推稅率,以避免小數位差的問題
              LET l_gec04 = 0   LET l_gec07 = ''
              IF g_apb[l_ac].apb06 <> '' OR NOT cl_null(g_apb[l_ac].apb06) THEN  #TQC-8C0031 add
                #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file,",
                #             li_dbs CLIPPED,"pmm_file",
                #LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102            #MOD-A80052 mark
                 LET l_sql = "SELECT gec04,gec05,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102      #MOD-A80052
                                                        cl_get_target_table(g_apb[l_ac].apb37,'pmm_file'),     #FUN-A50102
                             " WHERE gec01 = pmm21",
                             "   AND pmm01 = '",g_apb[l_ac].apb06,"' "
                 CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	             CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
                 PREPARE gec04_cs1 FROM l_sql
                #EXECUTE gec04_cs1 INTO l_gec04,l_gec07                    #MOD-A80052 mark
                 EXECUTE gec04_cs1 INTO l_gec04,l_gec05,l_gec07            #MOD-A80052
              ELSE
                 IF NOT cl_null(g_apb04) THEN
                   #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file,",
                   #             li_dbs CLIPPED,"rva_file ",
                   #LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102           #MOD-A80052 mark
                    LET l_sql = "SELECT gec04,gec05,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102     #MOD-A80052 
                                                           cl_get_target_table(g_apb[l_ac].apb37,'rva_file'),     #FUN-A50102
                                " WHERE gec01 = rva115 AND gec011 = '1'",
                                "   AND rva01 = '",g_apb04,"' "
                    CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
                    PREPARE sel_gec04_cs6 FROM l_sql
                   #EXECUTE sel_gec04_cs6 INTO l_gec04,l_gec07                #MOD-A80052 mark
                    EXECUTE sel_gec04_cs6 INTO l_gec04,l_gec05,l_gec07        #MOD-A80052
                 ELSE
                    IF (g_apa.apa00 = '21' OR g_apa.apa00 = '26') AND
                       NOT cl_null(g_apb[l_ac].apb21) THEN
                      #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file,",
                      #             li_dbs CLIPPED,"rvu_file",
                      #LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102           #MOD-A80052 mark
                       LET l_sql = "SELECT gec04,gec05,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102     #MOD-A80052
                                                              cl_get_target_table(g_apb[l_ac].apb37,'rvu_file'),     #FUN-A50102
                                   " WHERE gec01 = rvu115 AND gec011 = '1' ",
                                   "   AND rvu01 = '",g_apb[l_ac].apb21,"' "
                       CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                   CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102               
                       PREPARE sel_gec04_cs7 FROM l_sql
                      #EXECUTE sel_gec04_cs7 INTO l_gec04,l_gec07                #MOD-A80052 mark
                       EXECUTE sel_gec04_cs7 INTO l_gec04,l_gec05,l_gec07        #MOD-A80052
                    ELSE
                      #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file",
                      #LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'), #FUN-A50102           #MOD-A80052 mark
                       LET l_sql = "SELECT gec04,gec05,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'), #FUN-A50102     #MOD-A80052
                                   " WHERE gec01 = '",g_apa.apa15,"' ",
                                   "   AND gec011 = '1' "
                       CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                   CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
                       PREPARE sel_gec04_cs8 FROM l_sql
                      #EXECUTE sel_gec04_cs8 INTO l_gec04,l_gec07                #MOD-A80052 mark
                       EXECUTE sel_gec04_cs8 INTO l_gec04,l_gec05,l_gec07        #MOD-A80052
                    END IF
                 END IF
              END IF 
              IF cl_null(l_gec04) THEN 
                 LET l_gec04=0   
              END IF
              IF cl_null(l_gec07) THEN 
                 SELECT gec07                                            #CHI-B90030 add
                   INTO l_gec07                                          #CHI-B90030 add
                   FROM gec_file                                         #CHI-B90030 add
                  WHERE gec01=g_apa.apa15 AND gec011='1'                 #CHI-B90030 add
                #LET l_gec07='N'                                         #CHI-B90030 mark
              END IF
              LET l_rvv38t = 0
             #--------------------------------CHI-B90030-------------------------------------start
             #IF l_gec07='Y' AND
             #   (g_aptype='11' OR g_aptype='16' OR     #MOD-960095 add
             #    g_aptype='21' OR g_aptype='26') THEN  #MOD-960095 add
              IF l_gec07='Y' THEN
                 CASE
                   WHEN (g_aptype='11' OR g_aptype='16' OR g_aptype='21' OR g_aptype='26')
             #--------------------------------CHI-B90030-------------------------------------end
                    #LET l_sql = "SELECT rvv38t FROM ",li_dbs CLIPPED,"rvv_file",
                     LET l_sql = "SELECT rvv38t FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'), #FUN-A50102
                                 " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
                                 "   AND rvv02 = '",g_apb[l_ac].apb22,"' "
                     CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	             CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102               
                     PREPARE sel_rvv38t_cs3 FROM l_sql
                     EXECUTE sel_rvv38t_cs3 INTO l_rvv38t
                     IF cl_null(l_rvv38t) THEN LET l_rvv38t=0 END IF
                     LET l_apb24t = l_rvv38t*g_apb[l_ac].apb09
                     LET l_apb24t = cl_digcut(l_apb24t,t_azi04)
        #          WHEN (g_aptype='12')                                      #CHI-B90030 add #FUN-D80031 mark
                   WHEN (g_aptype='12' OR g_aptype ='14') ##FUN-D80031 ADD 修改税别为含税单价时候，过单价栏位清空金额栏
                     LET l_apb24t = g_apb[l_ac].apb23 * g_apb[l_ac].apb09    #CHI-B90030 add
                   #--------------------------------MOD-CA0194---------------(S)
                   WHEN (g_apa.apa00='15' AND (g_apz.apz61='1' OR (g_apz.apz61='3' AND l_pmc913='Y')))
                     LET l_sql = "SELECT pmn31t FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'),
                                 " WHERE pmn01 = '",g_apb[l_ac].apb06,"' ",
                                 "   AND pmn02 = '",g_apb[l_ac].apb07,"' "
                     CALL cl_replace_sqldb(l_sql) RETURNING l_sql
                     CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql
                     PREPARE sel_rvv38t_cs4 FROM l_sql
                     EXECUTE sel_rvv38t_cs4 INTO l_rvv38t
                     IF cl_null(l_rvv38t) THEN LET l_rvv38t = 0 END IF
                     LET l_apb24t = l_rvv38t * g_apb[l_ac].apb09
                   #--------------------------------MOD-CA0194---------------(E)
                 END CASE                                                    #CHI-B90030 add
                #-MOD-A80052-add-
                #IF l_gec05 = 'T' THEN                                        #CHI-B90030 mark
                #IF l_gec05 = 'T' OR (l_gec05 = '2' AND l_gec07 = 'Y') THEN   #CHI-B90030 add #MOD-C50076 mark
                #IF l_gec05 = 'T' OR l_gec05 = 'A' OR (l_gec05 = '2' AND l_gec07 = 'Y') THEN  #MOD-C50076 add
                #IF l_gec05 = 'T' OR l_gec05 = 'A' OR                                         #TQC-CA0008 mark #MOD-C60190 add
                #   ((l_gec05 = '2'  OR  l_gec05 = '5') AND l_gec07 = 'Y') THEN               #TQC-CA0008 mark #MOD-C60190 add
                 IF l_gec05 = 'T' OR l_gec05 = 'A' THEN                                       #TQC-CA0008
                       LET l_apa32f = l_apb24t * (l_gec04/100)
                       LET l_apa32f = cl_digcut(l_apa32f , t_azi04)
                       LET g_apb[l_ac].apb24 = l_apb24t - l_apa32f 
                 ELSE
                   #LET g_apb[l_ac].apb24 = l_apb24t/(1+l_gec04/100)                           #MOD-CA0167 mark
                    LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09              #MOD-CA0167 add
                 END IF  
                #-MOD-A80052-end-
                #LET g_apb[l_ac].apb24 = l_apb24t/(1+l_gec04/100)     #MOD-A80052 mark
              ELSE
                 LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09
              END IF
              LET g_apb[l_ac].apb24 =cl_digcut(g_apb[l_ac].apb24,t_azi04)   #MOD-6B0066
             #-MOD-A90146-add-
              IF g_aptype = '12' THEN     #MOD-AB0167
                 CALL t110_chkapb24()               
                 IF g_apb[l_ac].apb34 = 'Y' AND g_apb[l_ac].apb24 > g_apb24 THEN
                    LET g_apb[l_ac].apb24 = g_apb24
                    CALL cl_err(g_apb[l_ac].apb23,'aap-972',1)
                    NEXT FIELD apb23
                 END IF
              END IF                      #MOD-AB0167
             #-MOD-A90146-end-
             #-------------------MOD-CB0133--------------(S)
              IF g_aptype = '21' AND NOT cl_null(g_apb[l_ac].apb11) THEN
                 IF NOT t110_chkapb24_21(g_apb[l_ac].apb02,g_apb[l_ac].apb11,g_apb[l_ac].apb24,l_gec05) THEN
                    LET g_apb[l_ac].apb23 = g_apb_t.apb23
                    LET g_apb[l_ac].apb24 = g_apb_t.apb24
                    CALL cl_err(g_apb[l_ac].apb11,'aap-052',1)
                    NEXT FIELD apb23
                 END IF
              END IF
             #-------------------MOD-CB0133--------------(E)
              DISPLAY BY NAME g_apb[l_ac].apb24
              LET g_apb[l_ac].apb08 = g_apb[l_ac].apb23 * g_apa.apa14        #MOD-9A0201 add
              LET g_apb[l_ac].apb08 =cl_digcut(g_apb[l_ac].apb08,g_azi03)    #MOD-9A0201 add
              LET g_apb[l_ac].apb10 =g_apb[l_ac].apb24 * g_apa.apa14        #MOD-840632   #MOD-860221 mark回復
              LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,g_azi04)   #MOD-6B0066
              DISPLAY BY NAME g_apb[l_ac].apb08
              DISPLAY BY NAME g_apb[l_ac].apb10
              IF g_aptype[1,1] = '1' THEN
                 CALL t110_bud(p_cmd,'3')
                 IF NOT cl_null(g_errno) THEN
                    NEXT FIELD apb23 
                 END IF
              END IF
           END IF    #No.TQC-7B0063
 
        AFTER FIELD apb24
           IF cl_null(g_apb[l_ac].apb24) OR g_apb[l_ac].apb24 = ' ' THEN
              CALL cl_err('','aap-201',0)
              NEXT FIELD apb24
           END IF
 
#MOD-580051 金額不可為0
           IF g_aptype <> '11' THEN   #TQC-630188
              IF (g_apa.apa00='15' AND (g_apz.apz61='1' OR (g_apz.apz61='3' AND l_pmc913='Y'))) OR g_apa.apa00!='15' THEN #MOD-9A0135
                 IF g_apb[l_ac].apb24 <= 0 THEN
                    CALL cl_err('','aap-201',0)
                    NEXT FIELD apb24
                 END IF
              END IF  #MOD-9A0135         
           ELSE
              IF g_apb[l_ac].apb24 = 0 THEN
                 CALL cl_err('','aap-201',0)
                #NEXT FIELD apb24   #MOD-B30183 mark
              END IF
           END IF
          #IF g_aptype = '15' THEN                                                                   #MOD-A90181 mark
           IF g_aptype = '15' AND (g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y')) THEN  #MOD-A90181
              IF NOT cl_null(g_apb[l_ac].apb06) THEN   #MOD-9C0457 add
                 IF NOT cl_null(g_apb[l_ac].apb07) THEN           #MOD-9A0032 add
                   #已預付金額
                    LET l_apb24 = 0
                    SELECT SUM(apb24) INTO l_apb24 FROM apb_file,apa_file
                     WHERE apa01 =apb01 AND apa00 ='15'
                       AND apb06 =g_apb[l_ac].apb06
                       AND apb07 =g_apb[l_ac].apb07
                       AND (apb01!=g_apa.apa01 OR (apb01=g_apa.apa01 AND apb02!=g_apb[l_ac].apb02))
                    IF cl_null(l_apb24) THEN LET l_apb24 = 0 END IF
                    #LET l_sql = "SELECT pmn87,pmn31,pmn31t FROM ",li_dbs CLIPPED,"pmn_file",
                    LET l_sql = "SELECT pmn87,pmn31,pmn31t FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'), #FUN-A50102
                                " WHERE pmn01='",g_apb[l_ac].apb06,"' ",
                                "   AND pmn02='",g_apb[l_ac].apb07,"' "
                    CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102                
                    PREPARE sel_pmn87_cs2 FROM l_sql
                    EXECUTE sel_pmn87_cs2 INTO l_pmn87,l_pmn31,l_pmn31t 
                    #No.FUN-BC0017  --Begin
                    #抓取採購單稅率,稅別是否含稅
#                    LET l_pmm40t = 0  LET l_pmm43 = 0  LET l_gec07=''
#                    LET l_sql = "SELECT pmm43,gec07 ",
#                                #"  FROM ",li_dbs CLIPPED,"pmm_file,",
#                                #          li_dbs CLIPPED,"gec_file ",
#                                "  FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmm_file'),",", #FUN-A50102
#                                          cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),     #FUN-A50102
#                                " WHERE pmm01='",g_apb[l_ac].apb06,"' ",
#                                "   AND pmm21=gec01 AND gec011='1'"    #進項
#                    CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
#	                CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102                
#                    PREPARE sel_pmn87_cs3 FROM l_sql
#                    EXECUTE sel_pmn87_cs3 INTO l_pmm43,l_gec07
                    #若稅別是含稅,則含稅金額=數量*含稅單價
                    #若稅別不含稅,則含稅金額=數量*未稅單價*(1+稅率/100)
#                    IF l_gec07 = 'Y' THEN
#                       LET l_pmm40t = l_pmn87*l_pmn31t
#                    ELSE 
#                       LET l_pmm40t = (l_pmn87*l_pmn31)*(1+l_pmm43/100)
#                    END IF                  
                  #MOD-C50008---S---

                   #MOD-D40013 add begin---
                    LET l_pmm40t = 0
                    LET l_sql = "SELECT SUM(pmn88t) FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'),
                                " WHERE pmn01='",g_apb[l_ac].apb06,"' ",
                                "   AND pmn02='",g_apb[l_ac].apb07,"' "
                    CALL cl_replace_sqldb(l_sql) RETURNING l_sql
                    CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql
                    PREPARE sel_sum87_3 FROM l_sql
                    EXECUTE sel_sum87_3 INTO l_pmm40t

                    IF cl_null(l_pmm40t) THEN LET l_pmm40t = 0 END IF

                    IF g_apb[l_ac].apb24 > cl_digcut(l_pmm40t,t_azi04)-l_apb24 THEN
                       CALL cl_err(g_apb[l_ac].apb24,'aap-937',0)
                       NEXT FIELD apb24
                    END IF
                   #MOD-D40013 add end----- 

                   #LET l_pmn87_pmn31t = 0      #MOD-D30159 mark    
                    LET l_pmn87_pmn31t_2 = 0    #MOD-D30159    
                    LET l_sql = "SELECT SUM(pmn88t) FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'), 
                                " WHERE pmn01='",g_apb[l_ac].apb06,"' "
                    CALL cl_replace_sqldb(l_sql) RETURNING l_sql             
                        CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql 
                    PREPARE sel_sum87_2 FROM l_sql
                    EXECUTE sel_sum87_2 INTO l_pmn87_pmn31t_2
                    
                   #IF cl_null(l_pmm40t) THEN LET l_pmm40t=0 END IF                  #MOD-C50008 mark
                   #IF g_apb[l_ac].apb24 > cl_digcut(l_pmm40t,t_azi04)-l_apb24 THEN  #MOD-9A0113 #CHI-9C0015  #MOD-C50008 mark

                   #IF cl_null(l_pmn87_pmn31t_2) THEN LET l_pmn87_pmn31t = 0 END IF           #MOD-C50008 #MOD-D30159 mark
                    IF cl_null(l_pmn87_pmn31t_2) THEN LET l_pmn87_pmn31t_2 = 0 END IF         #MOD-D30159 add
                    IF g_apb[l_ac].apb24 > cl_digcut(l_pmn87_pmn31t_2,t_azi04)-l_apb24 THEN  #MOD-C50008
                       CALL cl_err(g_apb[l_ac].apb24,'aap-937',0) 
                       NEXT FIELD apb24
                    END IF

                   #LET l_pmm40t = l_pmn87*l_pmn31 
                   #IF cl_null(l_pmm40t) THEN LET l_pmm40t=0 END IF
                   #IF g_apb[l_ac].apb24 > cl_digcut(l_pmm40t,t_azi04)-l_apb24 THEN  #MOD-9A0113          #CHI-9C0015
                   #   CALL cl_err(g_apb[l_ac].apb24,'aap-937',0) 
                   #   NEXT FIELD apb24
                   #END IF
                   #No.FUN-BC0017  --End 
                  #MOD-C50008---E---
                 ELSE
                   #已預付金額
                    LET l_apb24 = 0
                    SELECT SUM(apb24) INTO l_apb24 FROM apb_file,apa_file
                     WHERE apa01 =apb01 AND apa00 ='15'
                       AND apb06 =g_apb[l_ac].apb06
                       AND (apb01!=g_apa.apa01 OR (apb01=g_apa.apa01 AND apb02!=g_apb[l_ac].apb02))
                    IF cl_null(l_apb24) THEN LET l_apb24 = 0 END IF
                    LET l_pmn87_pmn31t = 0   #MOD-9C0145 add
                    #LET l_sql = "SELECT SUM(pmn88t) FROM ",li_dbs CLIPPED,"pmn_file ",        #CHI-9C0015
                    LET l_sql = "SELECT SUM(pmn88t) FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'), #FUN-A50102
                                " WHERE pmn01='",g_apb[l_ac].apb06,"' "
                    CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102                
                    PREPARE sel_sum87 FROM l_sql
                    EXECUTE sel_sum87 INTO l_pmn87_pmn31t
                    IF cl_null(l_pmn87_pmn31t) THEN LET l_pmn87_pmn31t = 0 END IF  #MOD-9C0145 add
                    IF g_apb[l_ac].apb24 > cl_digcut(l_pmn87_pmn31t,t_azi04)-l_apb24 THEN #MOD-9A0113
                       CALL cl_err(g_apb[l_ac].apb24,'aap-937',0)
                       NEXT FIELD apb24
                    END IF
                 END IF
              END IF   #MOD-9C0457 add
           END IF
           LET g_apb[l_ac].apb24 = cl_digcut(g_apb[l_ac].apb24,t_azi04)  #No.MOD-530274   #MOD-6B0066
          #-MOD-A90146-add-
           IF g_aptype = '12' THEN     #MOD-AB0167
              CALL t110_chkapb24()               
              IF g_apb[l_ac].apb34 = 'Y' AND g_apb[l_ac].apb24 > g_apb24 THEN
                 LET g_apb[l_ac].apb24 = g_apb24
                 CALL cl_err(g_apb[l_ac].apb24,'aap-972',1)
                 NEXT FIELD apb24
              END IF
           END IF                      #MOD-AB0167
          #-MOD-A90146-end-
          #-------------------MOD-CB0133--------------(S)
           IF g_aptype = '21' AND NOT cl_null(g_apb[l_ac].apb11) THEN
              IF NOT t110_chkapb24_21(g_apb[l_ac].apb02,g_apb[l_ac].apb11,g_apb[l_ac].apb24,l_gec05) THEN
                 LET g_apb[l_ac].apb24 = g_apb_t.apb24
                 CALL cl_err(g_apb[l_ac].apb11,'aap-052',1)
                 NEXT FIELD apb24
              END IF
           END IF
          #-------------------MOD-CB0133--------------(E)
           DISPLAY BY NAME g_apb[l_ac].apb24   #No.MOD-530247
           LET g_apb[l_ac].apb10 =g_apb[l_ac].apb24 * g_apa.apa14        #MOD-840632   #MOD-860221 mark回復
           LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,g_azi04)   #MOD-6B0066
           DISPLAY BY NAME g_apb[l_ac].apb10
           IF g_aptype[1,1] = '1' THEN
              CALL t110_bud(p_cmd,'3')
              IF NOT cl_null(g_errno) THEN
                 NEXT FIELD apb24 
              END IF
           END IF
         #-MOD-C20206-mark-
         ##-MOD-C20104-add-
         # IF g_apb[l_ac].apb34 = 'Y' THEN  
         #    LET l_cnt = 0
         #    SELECT COUNT(*) INTO l_cnt
         #      FROM api_file
         #     WHERE api01 = g_apa.apa01
         #       AND api02 = '2'
         #       AND api03 = g_apb[l_ac].apb02
         #    IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
         #    IF l_cnt > 0 THEN 
         #       UPDATE api_file set api05 = g_apb[l_ac].apb10
         #        WHERE api01 = g_apa.apa01
         #          AND api02 = '2'
         #          AND api03 = g_apb[l_ac].apb02
         #    END IF 
         # END IF 
         ##-MOD-C20104-end-
         #-MOD-C20206-mark-     
         #No.yinhy130808  --Mark Begin
         ##-------------------MOD-CA0049------------------------(S)
         # IF g_apb[l_ac].apb34 = 'Y' AND g_apa.apa14 = 1 THEN
         #    LET l_cnt = 0
         #    SELECT COUNT(*) INTO l_cnt
         #      FROM api_file
         #     WHERE api01 = g_apa.apa01
         #       AND api02 = '2'
         #       AND api03 = g_apb[l_ac].apb02
         #    IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
         #    IF l_cnt > 0 THEN
         #       UPDATE api_file SET api05 = g_apb[l_ac].apb10,
         #                           api05f =g_apb[l_ac].apb24
         #        WHERE api01 = g_apa.apa01
         #          AND api02 = '2'
         #          AND api03 = g_apb[l_ac].apb02
         #    END IF
         # END IF
         ##-------------------MOD-CA0049------------------------(E) 
         #No.yinhy130808  --Mark End
 
        AFTER FIELD apb10
           IF NOT cl_null(g_apb[l_ac].apb10) THEN
              #MOD-580051 金額不可為0
              IF g_aptype <> '11' THEN   #TQC-630188
                 IF g_apb[l_ac].apb10 <= 0 THEN
                    CALL cl_err('','aap-201',0)
                    NEXT FIELD apb10
                 END IF
              ELSE
                 IF g_apb[l_ac].apb10 = 0 THEN
                    CALL cl_err('','aap-201',0)
                   #NEXT FIELD apb10   #MOD-B30183 mark
                 END IF
              END IF
             #當匯率為1時,需檢核原幣與本幣的稅額、金額需相同
              IF g_apa.apa14 = 1 AND g_aza.aza17 = g_apa.apa13 THEN   #MOD-880041
                 IF g_apb[l_ac].apb24!=g_apb[l_ac].apb10 THEN
                    CALL cl_err('','apm-988',1)
                    NEXT FIELD apb10
                 END IF
              END IF
             #-MOD-A90146-add-
             IF g_aptype = '12' THEN     #MOD-AB0167
                CALL t110_chkapb24()               
                IF g_apb[l_ac].apb34 = 'Y' AND g_apb[l_ac].apb10 > g_apb10 THEN
                   LET g_apb[l_ac].apb10 = g_apb10
                   CALL cl_err(g_apb[l_ac].apb10,'aap-971',1)
                   NEXT FIELD apb10
                END IF
             END IF                      #MOD-AB0167
             #-MOD-A90146-end-
              IF g_aptype = '15' THEN
              IF g_apb[l_ac].apb10 > cl_digcut(g_apb[l_ac].apb24 * g_apa.apa14,g_azi04) THEN  #No.MOD-930266 
                 CALL cl_err(g_apb[l_ac].apb10,'aap-938',0)
                 NEXT FIELD apb10
              END IF
              END IF
               LET g_apb[l_ac].apb10 = cl_digcut(g_apb[l_ac].apb10,g_azi04)   #No.MOD-530274   #MOD-6B0066
               DISPLAY BY NAME g_apb[l_ac].apb10   #No.MOD-530247
               IF g_apa.apa00 = '11' THEN   #MOD-660132
                 CALL t110_compute_apa33()
               END IF   #MOD-580079
               IF g_aptype[1,1] = '1' THEN
                  CALL t110_bud(p_cmd,'3')
                  IF NOT cl_null(g_errno) THEN
                     NEXT FIELD apb26 
                  END IF
               END IF
           END IF
 
        AFTER FIELD apb930 
           IF g_aaz.aaz90 ='Y' AND
              (l_aag05 = 'Y' OR g_apy.apydmy5='Y')
              AND g_apa.apa00[1,1]='1' AND cl_null(g_apb[l_ac].apb930) THEN
              CALL cl_err(g_apb[l_ac].apb930,'mfg0037',0)
              NEXT FIELD apb930
           END IF
           IF g_aptype[1,1] = '1' THEN
              CALL t110_bud(p_cmd,'3')
              IF NOT cl_null(g_errno) THEN
                 NEXT FIELD apb930
              END IF
           END IF
           IF NOT s_costcenter_chk(g_apb[l_ac].apb930) THEN
              LET g_apb[l_ac].apb930=g_apb_t.apb930
              LET g_apb[l_ac].gem02c=g_apb_t.gem02c
              DISPLAY BY NAME g_apb[l_ac].apb930,g_apb[l_ac].gem02c
              NEXT FIELD apb930
           ELSE
              LET g_apb[l_ac].gem02c=s_costcenter_desc(g_apb[l_ac].apb930)
              DISPLAY BY NAME g_apb[l_ac].gem02c
           END IF
 
           #防止User只修改部門欄位時,未再次檢查會科與允許/拒絕部門關係
            LET l_aag05='' 
            #LET l_sql = "SELECT aag05 FROM ",li_dbs CLIPPED,"aag_file",
            LET l_sql = "SELECT aag05 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'aag_file'), #FUN-A50102
                        " WHERE aag01 = '",g_apb[l_ac].apb25,"' ",
                        "   AND aag00 = '",g_bookno1,"' ",
                        "   AND aagacti = 'Y'"                        #No.MOD-B70280 add
            CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	        CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
            PREPARE sel_aag05_cs2 FROM l_sql
            EXECUTE sel_aag05_cs2 INTO l_aag05
 
            LET g_errno = ' '   
            IF l_aag05 = 'Y' AND NOT cl_null(g_apb[l_ac].apb25) THEN
              #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
               IF g_aaz.aaz90 ='Y' THEN
                  CALL s_chkdept_dbs(g_aaz.aaz72,g_apb[l_ac].apb25,g_apb[l_ac].apb930,
                                     g_bookno1,g_apb[l_ac].apb37)
                                RETURNING g_errno
               END IF
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,0)
                  NEXT FIELD apb25    #MOD-940326 mod apb930->apb25
               END IF
            END IF
 
           #會科二
            IF g_aza.aza63='Y' THEN
               LET l_aag05=''  
               #LET l_sql = "SELECT aag05 FROM ",li_dbs CLIPPED,"aag_file",
               LET l_sql = "SELECT aag05 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'aag_file'), #FUN-A50102
                           " WHERE aag01 = '",g_apb[l_ac].apb251,"' ",
                           "   AND aag00 = '",g_bookno2,"' ",
                           "   AND aagacti = 'Y'"                        #No.MOD-B70280 add
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	           CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
               PREPARE sel_aag05_cs3 FROM l_sql
               EXECUTE sel_aag05_cs3 INTO l_aag05
               LET g_errno = ' '   
               IF l_aag05 = 'Y' AND NOT cl_null(g_apb[l_ac].apb251) THEN
                  IF g_aaz.aaz90 ='Y' THEN
                     CALL s_chkdept_dbs(g_aaz.aaz72,g_apb[l_ac].apb251,g_apb[l_ac].apb930,
                                        g_bookno2,g_apb[l_ac].apb37)
                                   RETURNING g_errno
                  END IF
                  IF NOT cl_null(g_errno) THEN
                     CALL cl_err('',g_errno,0)
                     NEXT FIELD apb251   #MOD-940326 mod apb930->apb251
                  END IF
               END IF
            END IF
 
      AFTER FIELD apbud01
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apbud02
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apbud03
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apbud04
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apbud05
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apbud06
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apbud07
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apbud08
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apbud09
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apbud10
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apbud11
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apbud12
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apbud13
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apbud14
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER FIELD apbud15
         IF NOT cl_validate() THEN NEXT FIELD CURRENT END IF
 
      AFTER INPUT
         IF l_ac <= g_apb.getLength() THEN   #MOD-B80127 add
#No.MOD-B40261 --begin   #CHI-B80023 mark
           #IF g_apz.apz61='1' AND g_aptype ='15' THEN
           #   IF cl_null(g_apb[l_ac].apb06) THEN
           #      NEXT FIELD apb06
           #   END IF
           #   IF cl_null(g_apb[l_ac].apb07) THEN
           #      NEXT FIELD apb07
           #   END IF
           #END IF
#No.MOD-B40261 --end     #CHI-B80023 mark
            IF NOT cl_null(g_apb[l_ac].apb02) THEN #CHI-750003
                IF cl_null(g_apb[l_ac].apb24) OR g_apb[l_ac].apb24 = ' ' THEN
                   CALL cl_err('','aap-201',0)
                   NEXT FIELD apb24
                END IF
                IF g_aptype <> '11' THEN   
                   IF (g_apa.apa00='15' AND (g_apz.apz61='1' OR (g_apz.apz61='3' AND l_pmc913='Y'))) OR g_apa.apa00!='15' THEN #MOD-9A0135
                      IF g_apb[l_ac].apb24 <= 0 THEN
                         CALL cl_err('','aap-201',0)
                         NEXT FIELD apb24
                      END IF
                   END IF #MOD-9A0135    
                ELSE
                   IF g_apb[l_ac].apb24 = 0 THEN
                      CALL cl_err('','aap-201',0)
                      NEXT FIELD apb24
                   END IF
                END IF
               #-MOD-A90146-add-
                IF g_aptype = '12' THEN   
                   CALL t110_chkapb24()               
                   IF g_apb[l_ac].apb34 = 'Y' AND g_apb[l_ac].apb24 > g_apb24 THEN
                      LET g_apb[l_ac].apb24 = g_apb24
                      CALL cl_err(g_apb[l_ac].apb24,'aap-972',1)
                      NEXT FIELD apb24
                   END IF
                   IF g_apb[l_ac].apb34 = 'Y' AND g_apb[l_ac].apb10 > g_apb10 THEN
                      LET g_apb[l_ac].apb10 = g_apb10
                      CALL cl_err(g_apb[l_ac].apb10,'aap-971',1)
                      NEXT FIELD apb10
                   END IF
                END IF
               #-MOD-A90146-end-
            END IF
           #----------------------------MOD-C70069-------------------(S)
            IF g_aptype = '15' AND cl_null(g_apa.apa51) THEN
               LET l_cnt = 0
               SELECT COUNT(*) INTO l_cnt
                 FROM apb_file
                WHERE apb01 = g_apa.apa01
                  AND apb25 = g_apb[l_ac].apb25
               IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
               IF g_apb.getlength() <> l_cnt THEN
                  CALL cl_err(g_apb[l_ac].apb25,'mfg-040',1)
                  NEXT FIELD apb25
               END IF
            END IF
           #----------------------------MOD-C70069-------------------(E)
         END IF   #MOD-B80127 add
         LET l_apb10 = 0    LET l_apb24 = 0
         SELECT SUM(apb10),SUM(apb24) INTO l_apb10,l_apb24
           FROM apb_file
          WHERE apb01 = g_apa.apa01
         IF cl_null(l_apb10) THEN LET l_apb10 = 0 END IF
         IF cl_null(l_apb24) THEN LET l_apb24 = 0 END IF
         IF l_apb10 < 0 OR l_apb24 < 0 THEN
            CALL cl_err(l_apb10,'axr-029',1)
            NEXT FIELD apb10
         END IF
       
        #MOD-C50035---S---
        #SELECT SUM(apb10),SUM(apk06) INTO l_apb10,l_apk06    #MOD-C50076 mark
        #SELECT SUM(apb10),SUM(apk06),SUM(apk08)              #MOD-C50076 add #MOD-C60039 mark
        #  INTO l_apb10,l_apk06,l_apk08                       #MOD-C50076 add #MOD-C60039 mark
        #----------------------------MOD-D10009--------------------------------mark
        #IF g_apa.apa00 = '12' THEN  #MOD-C60107
        #   SELECT SUM(apb10)                                    #MOD-C60039 add
        #     INTO l_apb10                                       #MOD-C60039 add
        #    #FROM apb_file,apk_file
        #     FROM apb_file                                      #CHI-C80043 mod
        #    #WHERE apk01 = g_apa.apa01                          #CHI-C80043 mark
        #     WHERE apb01 = g_apa.apa01                          #CHI-C80043 mod
        #      AND apb29 = '1'                                   #CHI-C80043 add
        #  #----------------MOD-C60039-------------------(S)
        #   SELECT SUM(apk06),SUM(apk08)
        #     INTO l_apk06,l_apk08
        #    #FROM apb_file,apk_file
        #     FROM apk_file                                      #CHI-C80043 mod
        #    WHERE apk01 = g_apa.apa01
        #      #AND apb01 = g_apa.apa01                          #CHI-C80043 mark  
        #      #AND apb29 = '1'                                  #CHI-C80043 mark
        #       AND apk171 <> '28'                               #MOD-CA0079 add
        #  #----------------MOD-C60039-------------------(E)
        #   DISPLAY  l_gec05,l_gec07
        #  #-----------------------------MOD-C50076----------------------(S)
        #  #IF l_gec05 = 'T' OR l_gec05 = 'A' OR l_gec07 = 'N' OR                        #MOD-C60190 mark
        #  #   (l_gec05 = '2' AND l_gec07 = 'Y') THEN                                    #MOD-C60190 mark
        #  #TQC-CA0008--Begin Mark--
        #  #   IF l_gec05 = 'T' OR l_gec05 = 'A' OR l_gec07 = 'N' OR                     #MOD-C60190 add
        #  #      ((l_gec05 = '2'  OR  l_gec05 = '5') AND l_gec07 = 'Y') THEN            #MOD-C60190 add
        #  #TQC-CA0008---End Mark---
        #   IF l_apb10 > l_apk08 THEN
        #      CALL cl_err('','aap-051',1)
　　　　# 　   NEXT FIELD apb10
        #   ELSE
        #      IF l_apb10 < l_apk08 THEN
        #         CALL cl_err('','tis-002',1)
        #         NEXT FIELD apb10
        #      END IF
        #   END IF
        #  #TQC-CA0008--Begin Mark--
        #  #ELSE
        #  #-----------------------------MOD-C50076----------------------(E)
        #  #   IF l_apb10 > l_apk06 THEN
        #  #      CALL cl_err('','aap-051',1)
　　　  #  #　　　NEXT FIELD apb10
        #  #   ELSE
        #  #      IF l_apb10 < l_apk06 THEN
        #  #         CALL cl_err('','tis-002',1)
        #  #         NEXT FIELD apb10
        #  #      END IF
        #  #   END IF                                         #MOD-C50076 add
        #  # END IF
        #  #TQC-CA0008---End Mark---
        #END IF   #MOD-C60107
        #----------------------------MOD-D10009--------------------------------mark
        #MOD-C50035---E---
         #CHI-A40005 add --start--
         LET l_cnt = 0
         SELECT COUNT(*) INTO l_cnt FROM apk_file WHERE apk01 = g_apa.apa01
         IF (g_apa.apa00= '21' AND  g_apa.apa58 = '3') OR 
            (g_apa.apa00= '21' AND  g_apa.apa58 = '2' AND 
            #g_apa.apa08 <> 'UNAP' AND l_cnt = 0 ) THEN          #No.MOD-B80053 mark
             g_apa.apa08 <> 'UNAP' AND l_change = 'Y' ) THEN     #No.MOD-B80053 add
            SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01 = g_apa.apa15                                                     
            IF l_gec05 != 'X' AND g_aza.aza26 <> '2' THEN     
               CALL t110_21_ins2(g_apa.*)
               IF g_success='N' THEN
                  LET g_success = 'N'
                  CALL cl_err(g_apa.apa01,'aap-013',1)
                  NEXT FIELD apb02
               END IF
            END IF 
         END IF
         #CHI-A40005 add --end--
        #-MOD-B80193-add-
        #IF g_aptype = '15' AND (g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y')) THEN         #MOD-D30102 mark
         IF (g_aptype = '15' AND (g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y'))) OR         #MOD-D30102 add
            (g_aptype = '16' AND g_rec_b > 0) THEN                                                        #MOD-D30102 add 
            SELECT SUM(apb24),SUM(apb10) INTO g_apa.apa57f,g_apa.apa57
              FROM apb_file 
             WHERE apb01=g_apa.apa01
            IF g_apa.apa57f IS NULL THEN
               LET g_apa.apa57f= 0
            END IF
            IF g_apa.apa57  IS NULL THEN
               LET g_apa.apa57 = 0
            END IF
            LET g_apa.apa57f=cl_digcut(g_apa.apa57f,t_azi04)   
            LET g_apa.apa57=cl_digcut(g_apa.apa57,g_azi04)   
            LET g_apa.apa31f= g_apa.apa57f   
            LET g_apa.apa31 = g_apa.apa57   
            LET g_apa.apa32 = g_apa.apa57*g_apa.apa16/100   
            CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
            LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add 
            LET g_apa.apa32f = g_apa.apa57f*g_apa.apa16/100 
            CALL t110_apa32f() RETURNING l_apa32f                   #No.MOD-B80140 add
            LET g_apa.apa32f = l_apa32f                             #No.MOD-B80140 add
            LET g_apa.apa32f = cl_digcut(g_apa.apa32f,t_azi04)
            LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)
            UPDATE apa_file SET apa31f = g_apa.apa57f,apa31 = g_apa.apa57,
                                apa32f = g_apa.apa32f,apa32 = g_apa.apa52,
                                apa57f = g_apa.apa57f,apa57 = g_apa.apa57
              WHERE apa01=g_apa.apa01
            DISPLAY BY NAME g_apa.apa31,g_apa.apa31f,g_apa.apa32,g_apa.apa32f  
         END IF
        #-MOD-B80193-end-

        BEFORE DELETE                            #是否取消單身
           IF g_apb_t.apb02 > 0 AND g_apb_t.apb02 IS NOT NULL THEN
              IF NOT cl_delb(0,0) THEN
                 CANCEL DELETE
              END IF
              #正常請款,但是對應入庫/倉退單有做過衝暫估,則不能刪除
              IF cl_null(g_apb[l_ac].apb34) OR g_apb[l_ac].apb34 = 'N' THEN
                 IF g_apa.apa00 <> '22' THEN                    #MOD-AA0061
                    LET l_cnt = 0
                    SELECT COUNT(*) INTO l_cnt FROM apb_file
                     WHERE apb21 = g_apb_t.apb21
                       AND apb22 = g_apb_t.apb22
                       AND apb34 = 'Y'
                    IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
                    IF l_cnt > 0 THEN
                       CALL cl_err(g_apb_t.apb21,'aap-816',1)
                       CANCEL DELETE
                    END IF
                 END IF                                        #MOD-AA0061
              END IF
              IF (g_apa.apa00[1,1] = '2' AND g_apa.apa58 <> '1') OR
                 (g_aza.aza26 = '2' AND g_aza.aza46 = 'Y') THEN  #No.FUN-580006
                IF l_lock_sw = "Y" THEN
                   CALL cl_err("", -263, 1)
                   CANCEL DELETE
                END IF
                 DELETE FROM apk_file
                  WHERE apk01 = g_apa.apa01 AND apk02 =g_apb_t.apb02
                 IF SQLCA.sqlcode THEN
                    CALL cl_err3("del","apk_file",g_apa.apa01,g_apb_t.apb02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
                    ROLLBACK WORK
                    CANCEL DELETE
                 END IF
              END IF
              DELETE FROM apb_file
               WHERE apb01 = g_apa.apa01 AND apb02 = g_apb_t.apb02
              IF SQLCA.sqlcode THEN
                 CALL cl_err3("del","apb_file",g_apa.apa01,g_apb_t.apb02,SQLCA.sqlcode,"","",1)   #No.FUN-660122
                 ROLLBACK WORK
                 CANCEL DELETE
              ELSE
                 IF g_apa.apa08 = 'UNAP' THEN
                    IF NOT cl_null(g_apb_t.apb21) AND    #MOD-870109 add
                       NOT cl_null(g_apb_t.apb22) THEN   #MOD-870109 add
                       #LET l_sql = "UPDATE ",li_dbs CLIPPED,"rvv_file ",
                       LET l_sql = "UPDATE ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'), #FUN-A50102
                                   "   SET rvv40 = 'N' ",
                                   " WHERE rvv01 = '",g_apb_t.apb21,"' ",
                                   "   AND rvv02 = '",g_apb_t.apb22,"' "
                       CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
                       CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
                       PREPARE upd_rvv FROM l_sql
                       EXECUTE upd_rvv 
                       IF STATUS OR SQLCA.SQLERRD[3] = 0 THEN
                          CALL cl_err3("upd","rvv_file",g_apb_t.apb21,g_apb_t.apb22,STATUS,"","upd rvv40",1)  
                          ROLLBACK WORK
                          CANCEL DELETE
                       END IF
                    END IF                               #MOD-870109 add
                 END IF
              END IF
              LET g_rec_b=g_rec_b-1
              DISPLAY g_rec_b TO FORMONLY.n2
              #若是衝暫估,則自動產生api資料
              IF g_apb_t.apb34 = 'Y' THEN
                 CALL t110_api_unap('d')
              END IF
              LET g_apb[l_ac].apb29 = g_apb_t.apb29  #t110_bu中用l_ac在判斷
             #str CHI-B30009 add
              LET g_apb04_t=''
              LET g_apb05_t=''
              SELECT apb04,apb05 INTO g_apb04_t,g_apb05_t FROM apb_file
               WHERE apb01=g_apa.apa01 AND apb02=g_apb_t.apb02
             #end CHI-B30009 add
              CALL t110_bu(0,1,0)  #FUN-CB0054 add '0'
              IF g_success='Y' THEN
                 LET l_apa63 = '0'          #FUN-550042
                 LET l_change = 'Y'         #No.MOD-B80053 add
                 COMMIT WORK
              ELSE
                 ROLLBACK WORK
              END IF
              #FUN-CB0089----add--str
           IF g_aptype = '11'  THEN
              SELECT SUM(apb09) INTO l_sum FROM apb_file WHERE apb01 = g_apa.apa01
              DISPLAY l_sum TO SUM
              #add by lili 170723 ---s---
              SELECT SUM(apb10) INTO l_sum1 FROM apb_file WHERE apb01 = g_apa.apa01
              DISPLAY l_sum1 TO sum1
              #add by lili 170723 ---e---
           END IF
           #FUN-CB0089-----add--end
           END IF
 
        ON ROW CHANGE
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               LET g_apb[l_ac].* = g_apb_t.*
               CLOSE t110_bcl
               ROLLBACK WORK
               EXIT INPUT
            END IF
            #TQC-C60241--add--str--
            IF g_apa.apa00 = '26' THEN
               IF g_apb[l_ac].apb29 = '3' THEN
                  SELECT SUM(rvv87) INTO l_sum_rvv87
                    FROM rvv_file
                   WHERE rvv01 = g_apb[l_ac].apb21
                     AND rvv02 = g_apb[l_ac].apb22
                  SELECT SUM(apb09) INTO l_sum_apb09
                    FROM apb_file,apa_file
                   WHERE apb21 = g_apb[l_ac].apb21
                     AND apb22 = g_apb[l_ac].apb22
                     AND apa00 = '26'
                     AND apa01 = apb01
                  SELECT apb09 INTO l_apb09
                    FROM apb_file,apa_file
                   WHERE apb21 = g_apb[l_ac].apb21
                     AND apb02 = g_apb[l_ac].apb02
                     AND apa00 = '26'
                     AND apa01 = apb01
                     AND apa01 = g_apa.apa01
                  IF cl_null(l_sum_rvv87) THEN
                     LET l_sum_rvv87 = 0
                  END IF
                  IF cl_null(l_apb09) THEN
                     LET l_apb09 = 0
                  END IF
                  IF cl_null(l_sum_apb09) THEN
                     LET l_sum_apb09 = 0
                  END IF
                  IF l_sum_apb09 + g_apb[l_ac].apb09 - l_apb09 > l_sum_rvv87 THEN
                     CALL cl_err('','aap-240',1)
                     NEXT FIELD apb09
                  END IF
               END IF
            END IF
            #TQC-C60241--add--end--
            IF l_lock_sw = 'Y' THEN
               CALL cl_err(g_apb[l_ac].apb02,-263,1)
               LET g_apb[l_ac].* = g_apb_t.*
            ELSE
               IF g_apy.apydmy5='Y' AND g_apa.apa00[1,1]='1' AND
                  g_apb[l_ac].apb09 != 0 THEN
               END IF
               LET l_aag05=''
               #LET l_sql = "SELECT aag05 FROM ",li_dbs CLIPPED,"aag_file",
               LET l_sql = "SELECT aag05 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'aag_file'), #FUN-A50102
                           " WHERE aag01 = '",g_apb[l_ac].apb25,"' ",
                           "   AND aag00 = '",g_bookno1,"' ",
                           "   AND aagacti = 'Y'"                        #No.MOD-B70280 add
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	           CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
               PREPARE sel_aag05_cs4 FROM l_sql
               EXECUTE sel_aag05_cs4 INTO l_aag05
               #防止User只修改科目或部門欄位時,未再次檢查會科與允許/拒絕部門關係
               LET g_errno = ' '   
               IF l_aag05 = 'Y' THEN
                 #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                  IF g_aaz.aaz90 ='Y' THEN
                     IF NOT cl_null(g_apb[l_ac].apb930) THEN 
                        CALL s_chkdept_dbs(g_aaz.aaz72,g_apb[l_ac].apb25,g_apb[l_ac].apb930,
                                           g_bookno1,g_apb[l_ac].apb37)
                                      RETURNING g_errno
                     END IF
                  ELSE
                     IF NOT cl_null(g_apb[l_ac].apb26) THEN 
                        CALL s_chkdept_dbs(g_aaz.aaz72,g_apb[l_ac].apb25,g_apb[l_ac].apb26,
                                           g_bookno1,g_apb[l_ac].apb37)
                                      RETURNING g_errno
                     END IF 
                  END IF
                  IF NOT cl_null(g_errno) THEN
                     CALL cl_err('',g_errno,0)
                     NEXT FIELD apb25
                  END IF
               END IF
               IF g_aza.aza63='Y' THEN 
                  LET l_aag05=''
                  #LET l_sql = "SELECT aag05 FROM ",li_dbs CLIPPED,"aag_file ",
                  LET l_sql = "SELECT aag05 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'aag_file'), #FUN-A50102
                              " WHERE aag01 = '",g_apb[l_ac].apb251,"' ",
                              "   AND aag00 = '",g_bookno2,"' ",
                              "   AND aagacti = 'Y'"                        #No.MOD-B70280 add
                  CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	              CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
                  PREPARE sel_aag05_cs5 FROM l_sql
                  EXECUTE sel_aag05_cs5 INTO l_aag05
                  #防止User只修改科目或部門欄位時,未再次檢查會科與允許/拒絕部門關係
                  LET g_errno = ' '   
                  IF l_aag05 = 'Y' AND NOT cl_null(g_apb[l_ac].apb251) THEN
                     IF g_aaz.aaz90 ='Y' THEN
                        IF NOT cl_null(g_apb[l_ac].apb930) THEN
                           CALL s_chkdept_dbs(g_aaz.aaz72,g_apb[l_ac].apb251,g_apb[l_ac].apb930,
                                              g_bookno2,g_apb[l_ac].apb37)
                                         RETURNING g_errno
                        END IF 
                     ELSE
                        IF NOT cl_null(g_apb[l_ac].apb26) THEN
                           CALL s_chkdept_dbs(g_aaz.aaz72,g_apb[l_ac].apb251,g_apb[l_ac].apb26,
                                              g_bookno2,g_apb[l_ac].apb37)
                                         RETURNING g_errno
                        END IF
                     END IF
                     IF NOT cl_null(g_errno) THEN
                        CALL cl_err('',g_errno,0)
                        NEXT FIELD apb251
                     END IF
                  END IF
               END IF
               UPDATE apb_file SET apb02 = g_apb[l_ac].apb02,
                                   apb11 = g_apb[l_ac].apb11,
                                   apb37 = g_apb[l_ac].apb37,   #FUN-9A0093 
                                   apb21 = g_apb[l_ac].apb21,
                                   apb31 = g_apb[l_ac].apb31, #FUN-630055
                                   apb22 = g_apb[l_ac].apb22,
                                   apb06 = g_apb[l_ac].apb06,
                                   apb07 = g_apb[l_ac].apb07,
                                   apb12 = g_apb[l_ac].apb12,
                                   apb09 = g_apb[l_ac].apb09,
                                   apb25 = g_apb[l_ac].apb25,
                                   apb251= g_apb[l_ac].apb251,    #No.FUN-680029
                                   apb26 = g_apb[l_ac].apb26,
                                   apb930= g_apb[l_ac].apb930, #FUN-670064
                                   apb23 = g_apb[l_ac].apb23,
                                   apb24 = g_apb[l_ac].apb24,
                                   apb08 = g_apb[l_ac].apb08,
                                   apb10 = g_apb[l_ac].apb10,
                                   apb081= g_apb[l_ac].apb08,
                                   apb101= g_apb[l_ac].apb10,
                                   apb27 = g_apb[l_ac].apb27,
                                   apb28 = g_apb[l_ac].apb28,
                                   apb35 = g_apb[l_ac].apb35,  #FUN-810045 add
                                   apb36 = g_apb[l_ac].apb36,  #FUN-810045 add
                                   apb29 = g_apb[l_ac].apb29,
                                   apb04 = g_apb04,
                                   apb05 = g_apb05,
                                   apb33 = g_apb[l_ac].apb33,  #No.FUN-690080
                                   apb32 = g_apb[l_ac].apb32,  #No.FUN-690080
                                   apb34 = g_apb[l_ac].apb34,  #No.TQC-7B0083
                                   apbud01 = g_apb[l_ac].apbud01,
                                   apbud02 = g_apb[l_ac].apbud02,
                                   apbud03 = g_apb[l_ac].apbud03,
                                   apbud04 = g_apb[l_ac].apbud04,
                                   apbud05 = g_apb[l_ac].apbud05,
                                   apbud06 = g_apb[l_ac].apbud06,
                                   apbud07 = g_apb[l_ac].apbud07,
                                   apbud08 = g_apb[l_ac].apbud08,
                                   apbud09 = g_apb[l_ac].apbud09,
                                   apbud10 = g_apb[l_ac].apbud10,
                                   apbud11 = g_apb[l_ac].apbud11,
                                   apbud12 = g_apb[l_ac].apbud12,
                                   apbud13 = g_apb[l_ac].apbud13,
                                   apbud14 = g_apb[l_ac].apbud14,
                                   apbud15 = g_apb[l_ac].apbud15
                WHERE apb01=g_apa.apa01 AND apb02=g_apb_t.apb02
               IF SQLCA.sqlcode THEN
                  CALL cl_err3("upd","apb_file",g_apa.apa01,g_apb_t.apb02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
                  LET g_apb[l_ac].* = g_apb_t.*
               ELSE
                  SELECT COUNT(*) INTO l_n FROM apk_file
                   WHERE apk03 = g_apb[l_ac].apb11
                  IF l_n > 0 THEN
                     #因為大陸版同一單身可能對應多張發票
                     IF g_aza.aza26 != '2' AND
                        g_apa.apa00[1,1] = '2' AND g_apa.apa58 = '1' THEN   #MOD-780009
                        #稅額
                        LET g_apk.apk07=g_apb[l_ac].apb10*g_apa.apa16/100
                        LET g_apk.apk08=g_apb[l_ac].apb10  #未稅金額
                        #含稅金額
                        LET g_apk.apk06=g_apk.apk07+g_apk.apk08
                        #no.A010依幣別取位
                        LET g_apk.apk06 = cl_digcut(g_apk.apk06,g_azi04)
                        LET g_apk.apk07 = cl_digcut(g_apk.apk07,g_azi04)
                        LET g_apk.apk08 = cl_digcut(g_apk.apk08,g_azi04)
                        SELECT azi04 INTO l_azi04 FROM azi_file WHERE azi01 = g_apk.apk12
                        LET g_apk.apk07f = g_apb[l_ac].apb24 * g_apk.apk29 / 100
                        LET g_apk.apk08f = g_apb[l_ac].apb24
                        LET g_apk.apk06f = g_apk.apk07f + g_apk.apk08f
                        LET g_apk.apk06f = cl_digcut(g_apk.apk06f,l_azi04)
                        LET g_apk.apk07f = cl_digcut(g_apk.apk07f,l_azi04)
                        LET g_apk.apk08f = cl_digcut(g_apk.apk08f,l_azi04)
                        UPDATE apk_file SET apk06 = g_apk.apk06,
                                            apk07 = g_apk.apk07,
                                            apk08 = g_apk.apk08,
                                            apk06f = g_apk.apk06f,
                                            apk07f = g_apk.apk07f,
                                            apk08f = g_apk.apk08f,
                                            apk32  = g_apk.apk32    #FUN-970108 add
                         WHERE apk01 = g_apa.apa01
                           AND apk02 = g_apb_t.apb02
                         IF SQLCA.sqlcode OR SQLCA.SQLERRD[3] = 0 THEN
                            CALL cl_err3("upd","apk_file",g_apa.apa01,g_apb_t.apb02,'aap-810',"","upd apk",1)  #No.FUN-660122   #MOD-6A0124
                            ROLLBACK WORK
                         END IF
                     ELSE
                       IF g_apb[l_ac].apb02 != g_apb_t.apb02 THEN
                          UPDATE apk_file SET apk02 = g_apb[l_ac].apb02
                           WHERE apk01 = g_apa.apa01
                             AND apk02 = g_apb_t.apb02
                          IF SQLCA.sqlcode THEN
                             CALL cl_err3("upd","apk_file",g_apa.apa01,g_apb_t.apb02,SQLCA.sqlcode,"","upd apk",1)  #No.FUN-660122
                             ROLLBACK WORK
                          END IF
                       END IF
                     END IF
                      IF g_apb_t.apb11 IS NOT NULL OR   #No.MOD-480387
                        g_apb[l_ac].apb11 != g_apb_t.apb11 THEN
                        SELECT COUNT(*) INTO g_cnt
                          FROM apk_file
                         WHERE apk01 = g_apa.apa01
                           AND apk02 = g_apb_t.apb02
                        IF g_aza.aza26 != '2' AND g_cnt > 0 THEN
                           UPDATE apk_file SET apk03 = g_apb[l_ac].apb11
                            WHERE apk01 = g_apa.apa01
                              AND apk02 = g_apb_t.apb02
                           IF STATUS OR SQLCA.sqlerrd[3] =0 THEN
                              CALL cl_err3("upd","apk_file",g_apa.apa01,g_apb_t.apb02,SQLCA.sqlcode,"","upd apk",1)  #No.FUN-660122
                              ROLLBACK WORK
                           END IF
                        END IF
                     END IF
                  END IF   #FUN-680003 
                  MESSAGE 'UPDATE O.K'
                  #若是衝暫估,則自動產生api資料
                  IF g_apb[l_ac].apb34 = 'Y' OR g_apb_t.apb34 = 'Y' THEN
                     IF g_apb[l_ac].apb21 <> g_apb_t.apb21 OR 
                        g_apb[l_ac].apb22 <> g_apb_t.apb22 OR
                        g_apb[l_ac].apb09 <> g_apb_t.apb09 OR  
                        g_apb[l_ac].apb08 <> g_apb_t.apb08 OR  #單價
                        g_apb[l_ac].apb23 <> g_apb_t.apb23 OR  #單價
                        g_apb[l_ac].apb10 <> g_apb_t.apb10 OR  #金額
                        g_apb[l_ac].apb24 <> g_apb_t.apb24 OR  #金額
                        g_apb[l_ac].apb02 <> g_apb_t.apb02 THEN
                        CALL t110_api_unap('u')
                     END IF
                  END IF
                 #str CHI-B30009 add
                  LET g_apb04=''
                  LET g_apb05=''
                  SELECT apb04,apb05 INTO g_apb04,g_apb05 FROM apb_file
                   WHERE apb01=g_apa.apa01 AND apb02=g_apb[l_ac].apb02

                  LET g_apb04_t=''
                  LET g_apb05_t=''
                  SELECT apb04,apb05 INTO g_apb04_t,g_apb05_t FROM apb_file
                   WHERE apb01=g_apa.apa01 AND apb02=g_apb_t.apb02
                 #end CHI-B30009 add
                   CALL t110_bu(1,1,0)  #FUN-CB0054 add '0'
                  IF g_success='Y' THEN
                     IF g_apa.apa63 NOT matches '[Ss]' THEN    #No.FUN-8A0075
                        LET l_apa63 = '0'          #FUN-550042
                     END IF                                    #No.FUN-8A0075
                     LET l_change = 'Y'                        #No.MOD-B80053 add
                     COMMIT WORK
                  ELSE
                     ROLLBACK WORK
                  END IF
               END IF
            END IF
 
        AFTER ROW
            LET l_ac = ARR_CURR()
            #LET l_ac_t = l_ac  #FUN-D30032
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               IF p_cmd = 'u' THEN
                  LET g_apb[l_ac].* = g_apb_t.*
               #FUN-D30032--add--str--
               ELSE
                  CALL g_apb.deleteElement(l_ac)
                  IF g_rec_b != 0 THEN
                     LET g_action_choice = "detail"
                     LET l_ac = l_ac_t
                  END IF
               #FUN-D30032--add--end--
               END IF
               CLOSE t110_bcl
               ROLLBACK WORK
               EXIT INPUT
            END IF
            LET l_ac_t = l_ac  #FUN-D30032

            IF l_ac <= g_apb.getLength() THEN   #MOD-B80127 add
#No.MOD-B40261 --begin  #CHI-B80023 mark
              #IF g_apz.apz61='1' AND g_aptype ='15' THEN
              #   IF cl_null(g_apb[l_ac].apb06) THEN
              #      NEXT FIELD apb06
              #   END IF
              #   IF cl_null(g_apb[l_ac].apb07) THEN
              #      NEXT FIELD apb07
              #   END IF
              #END IF
#No.MOD-B40261 --end  #CHI-B80023 mark
               CLOSE t110_bcl
               SELECT COUNT(*) INTO l_cnt FROM apb_file
                WHERE apb01=g_apa.apa01
              #IF l_cnt > 0 THEN                                                #MOD-A30248 mark
               IF (l_cnt > 0) OR g_apz.apz61='1' OR (g_apz.apz61='3'AND l_pmc913 ='Y') THEN      #MOD-A30248 add
                  SELECT SUM(apb24),SUM(apb10) INTO g_amt1f,g_amt1 FROM apb_file
                   WHERE apb01 = g_apa.apa01 AND apb29='1'
                  IF g_amt1 IS NULL THEN
                     LET g_amt1f= 0
                     LET g_amt1 = 0
                  END IF
                  SELECT SUM(apb24),SUM(apb10) INTO g_amt2f,g_amt2 FROM apb_file
                   WHERE apb01 = g_apa.apa01 AND apb29='3'
                  IF g_amt2 IS NULL THEN
                     LET g_amt2f= 0
                     LET g_amt2 = 0
                  END IF
                  IF g_aptype MATCHES '1*' AND g_aptype <> '15' AND g_aptype <> '17' THEN  #No.FUN-690080
                     LET g_apa.apa57f= g_amt1f + g_amt2f   #MOD-6A0025
                     LET g_apa.apa57 = g_amt1 + g_amt2   #MOD-6A0025
                  END IF
                  IF g_aptype MATCHES '2*' THEN
                     LET g_apa.apa57f= g_amt2f + g_amt1f   #MOD-6A0025
                     LET g_apa.apa57 = g_amt2 + g_amt1   #MOD-6A0025
                  END IF
                  IF g_aptype = '15' OR g_aptype = '17' OR g_aptype = '16' THEN   #No.FUN-690080 #MOD-970173 add g_aptype='16'
                     SELECT SUM(apb24),SUM(apb10) INTO g_apa.apa57f,g_apa.apa57
                      FROM apb_file WHERE apb01=g_apa.apa01
                  END IF
                  IF g_apa.apa57f IS NULL THEN
                     LET g_apa.apa57f= 0
                  END IF
                  IF g_apa.apa57  IS NULL THEN
                     LET g_apa.apa57 = 0
                  END IF
                  LET g_apa.apa57f=cl_digcut(g_apa.apa57f,t_azi04)   #MOD-6B0066
                  LET g_apa.apa57=cl_digcut(g_apa.apa57,g_azi04)   #MOD-6B0066
                 #IF l_cnt > 0 THEN                                       #MOD-A30248      #MOD-AA0190 mark 
                  IF l_cnt > 0 AND g_aptype='11' THEN                     #MOD-A30248      #MOD-AA0190
                     LET g_apa.apa33=g_apa.apa31-g_apa.apa57              #No.TQC-A30161
                     LET g_apa.apa33f=g_apa.apa31f-g_apa.apa57f           #No.TQC-A30161
                  ELSE                                                    #MOD-A30248
                     LET g_apa.apa33=0                                    #MOD-A30248
                     LET g_apa.apa33f=0                                   #MOD-A30248
                  END IF                                                  #MOD-A30248
                  UPDATE apa_file SET apa57=g_apa.apa57,apa57f=g_apa.apa57f,
                                      apa33=g_apa.apa33,apa33f=g_apa.apa33f        #No.TQC-A30161
                    WHERE apa01=g_apa.apa01
                  IF SQLCA.sqlcode OR SQLCA.SQLERRD[3] = 0 THEN
                     CALL cl_err3("upd","apa_file",g_apa.apa01,"",STATUS,"","upd apa:",1)
                     ROLLBACK WORK
                  END IF
                  DISPLAY BY NAME g_apa.apa57
                  IF g_aptype = '15' THEN
                   #LET l_sql = "SELECT pmc913 FROM ",li_dbs CLIPPED,"pmc_file ",
                   LET l_sql = "SELECT pmc913 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmc_file'), #FUN-A50102
                               " WHERE pmc01 = '",g_apa.apa05,"' "
                   CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	           CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
                   PREPARE sel_pmc913_cs1 FROM l_sql
                   EXECUTE sel_pmc913_cs1 INTO l_pmc913
                   IF g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y') THEN 
                      CALL t110_sum_apa()
                   END IF 
                  END IF
               ELSE
                  #IF g_aptype !='11' THEN   #MOD-890177 add    #FUN-BC0031 mark
                  IF g_aptype <> '11' AND g_aptype <> '21' THEN #FUN-BC0031 
                     LET g_apa.apa57 = g_apa.apa31
                     LET g_apa.apa57f = g_apa.apa31f
                     DISPLAY BY NAME g_apa.apa57
                  END IF                    #MOD-890177 add
               END IF
            END IF   #MOD-B80127
            #FUN-CB0089---add----str
            IF g_aptype = '11' THEN
               SELECT SUM(apb09) INTO l_sum FROM apb_file WHERE apb01=g_apa.apa01
               DISPLAY l_sum TO SUM
               #add by lili 170723 ---s---
               SELECT SUM(apb10) INTO l_sum1 FROM apb_file WHERE apb01 = g_apa.apa01
               DISPLAY l_sum1 TO sum1
               #add by lili 170723 ---e---
            END IF
            #FUN-CB0089--add-----end

       #-MOD-A60004-add-
        ON ACTION cancel
           #FUN-B40096 add
           IF INT_FLAG THEN
              CALL cl_err('',9001,0)
              LET INT_FLAG = 0
              #TQC-D40025----add----str
              IF p_cmd = 'u' THEN
                 LET g_apb[l_ac].* = g_apb_t.*
              ELSE
                 CALL g_apb.deleteElement(l_ac)
                 IF g_rec_b != 0 THEN
                    LET g_action_choice = "detail"
                    LET l_ac = l_ac_t
                 END IF
              END IF
              #TQC-D40025----add----end 
           END IF
           #FUN-B40096 add--end
           IF g_aptype = '15' AND   (g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y')) THEN 
              SELECT SUM(apb24),SUM(apb10) INTO g_apa.apa57f,g_apa.apa57
                FROM apb_file 
               WHERE apb01=g_apa.apa01
              IF g_apa.apa57f IS NULL THEN
                 LET g_apa.apa57f= 0
              END IF
              IF g_apa.apa57  IS NULL THEN
                 LET g_apa.apa57 = 0
              END IF
              LET g_apa.apa57f=cl_digcut(g_apa.apa57f,t_azi04)   
              LET g_apa.apa57=cl_digcut(g_apa.apa57,g_azi04)   
              LET g_apa.apa31f= g_apa.apa57f   
              LET g_apa.apa31 = g_apa.apa57   
             #-MOD-B80193-add-
              LET g_apa.apa32 = g_apa.apa57*g_apa.apa16/100    
              CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
              LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add
              LET g_apa.apa32f = g_apa.apa57f*g_apa.apa16/100 
              CALL t110_apa32f() RETURNING l_apa32f                   #No.MOD-B80140 add
              LET g_apa.apa32f = l_apa32f                             #No.MOD-B80140 add
              LET g_apa.apa32f = cl_digcut(g_apa.apa32f,t_azi04)
              LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)
             #-MOD-B80193-end-
              UPDATE apa_file SET apa31f = g_apa.apa57f,apa31 = g_apa.apa57,
                                  apa32f = g_apa.apa32f,apa32 = g_apa.apa52,  #MOD-B80193
                                  apa57f = g_apa.apa57f,apa57 = g_apa.apa57
                WHERE apa01=g_apa.apa01
              DISPLAY BY NAME g_apa.apa31f
              DISPLAY BY NAME g_apa.apa31
              DISPLAY BY NAME g_apa.apa32,g_apa.apa32f  #MOD-B80193
              EXIT INPUT
           ELSE                #MOD-A60115 
              EXIT INPUT       #MOD-A60115
           END IF
       #-MOD-A60004-end-

        ON ACTION CONTROLP
           CASE
	        WHEN INFIELD(apb11)
                      CALL cl_init_qry_var()
                      LET g_qryparam.form ="q_apk03"
                      LET g_qryparam.arg1 = g_apa.apa15
                      CALL cl_create_qry() RETURNING g_apb[l_ac].apb11
                      DISPLAY g_apb[l_ac].apb11 TO apb11

              WHEN INFIELD(apb37)     #门店编号
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_azw"
                 LET g_qryparam.default1 = g_apb[l_ac].apb37
                 LET g_qryparam.where = "azw02 = '",g_legal,"' "
                 CALL cl_create_qry() RETURNING g_apb[l_ac].apb37
                 DISPLAY g_apb[l_ac].apb37 TO apb37
                 NEXT FIELD apb37

              WHEN INFIELD(apb31)
                    CALL cl_init_qry_var()
                  CALL q_m_azf(FALSE,TRUE,g_apb[l_ac].apb31,'2','7',g_apb[l_ac].apb37)
                      RETURNING g_apb[l_ac].apb31
                    DISPLAY g_apb[l_ac].apb31 TO apb31      #No.MOD-490344
 
                WHEN INFIELD(apb35) #專案
                  CALL cl_init_qry_var()
                  CALL q_pja(FALSE,TRUE,g_apb[l_ac].apb35,g_apb[l_ac].apb37)
                       RETURNING g_apb[l_ac].apb35
                  DISPLAY BY NAME g_apb[l_ac].apb35
                  NEXT FIELD apb35
                WHEN INFIELD(apb36)  #WBS
                  CALL cl_init_qry_var()
                  CALL q_pjb(FALSE,TRUE,g_apb[l_ac].apb36,g_apb[l_ac].apb35,g_apb[l_ac].apb37)
                       RETURNING g_apb[l_ac].apb36
                  DISPLAY BY NAME g_apb[l_ac].apb36
                  NEXT FIELD apb36
              WHEN INFIELD(apb21) OR INFIELD(apb22)
 
                    IF g_apa.apa00 MATCHES '1*' THEN
                      #aapt120單身apb21(暫估單號),apb22(暫估項次)開窗查aapt160費用暫估資料
                       IF g_apa.apa00 = '12' THEN
                          CALL q_m_apb(FALSE,TRUE,g_apb[l_ac].apb21,g_apb[l_ac].apb22,
                                    g_apa.apa06,g_apa.apa07,g_apb[l_ac].apb37)
                               RETURNING g_apb[l_ac].apb21,g_apb[l_ac].apb22
                       ELSE
                         #str MOD-B40070 mod
                         #CALL q_rvv(FALSE,TRUE,g_apa.apa05,g_apb[l_ac].apb21,
                         #           g_apb[l_ac].apb22)
                         #RETURNING g_apb[l_ac].apb21,g_apb[l_ac].apb22
                          CALL q_rvv2(FALSE,TRUE,g_apa.apa05,
                                      g_apb[l_ac].apb21,g_apb[l_ac].apb22,g_apb[l_ac].apb29,g_apb[1].apb37)
                          RETURNING g_apb[l_ac].apb21,g_apb[l_ac].apb22
                         #end MOD-B40070 mod
                       END IF   #FUN-7A0050 add
                       DISPLAY g_apb[l_ac].apb22 TO apb22         #No.MOD-490344
                    ELSE
                      #aapt210單身apb21(暫估單號),apb22(暫估項次)開窗查aapt260扣款折讓暫估資料
                       IF g_apa.apa00 = '21' THEN      #MOD-BA0125     #MOD-D20144 remark
                      #IF g_apa.apa00 = '22' THEN      #MOD-BA0125 mod #MOD-D20144 mark
                          CALL cl_init_qry_var()
                          CALL q_m_apb1(FALSE,TRUE,g_apb[l_ac].apb21,
                                       g_apb[l_ac].apb22,g_apb[l_ac].apb37)
                               RETURNING g_apb[l_ac].apb21,g_apb[l_ac].apb22
                       ELSE
                          CALL q_rvv2(FALSE,TRUE,g_apa.apa05,
                                  g_apb[l_ac].apb21,g_apb[l_ac].apb22,'3',g_apb[l_ac].apb37)   #FUN-9A0093
                            RETURNING g_apb[l_ac].apb21,g_apb[l_ac].apb22
                       END IF   #FUN-7A0050 add
                       DISPLAY g_apb[l_ac].apb21 TO apb21          #No.MOD-490344
                       DISPLAY g_apb[l_ac].apb22 TO apb22          #No.MOD-490344
                    END IF
              WHEN INFIELD(apb25) # Account number
 
                CALL q_m_aag(FALSE,TRUE,g_apb[l_ac].apb37,g_apb[l_ac].apb25,'23',g_bookno1)
                     RETURNING g_apb[l_ac].apb25
              WHEN INFIELD(apb251) # Account number
                CALL q_m_aag(FALSE,TRUE,g_apb[l_ac].apb37,g_apb[l_ac].apb251,'23',g_bookno2)
                     RETURNING g_apb[l_ac].apb251
              WHEN INFIELD(apb26) # Dept CODE
                 CALL cl_init_qry_var()
                #----------------------MOD-C40040------------------------------(S)
                #CALL q_m_gem(FALSE,TRUE,g_apb[l_ac].apb26,g_apb[l_ac].apb37)   #MOD-C40040 mark
                #     RETURNING g_apb[l_ac].apb26                               #MOD-C40040 mark
                #DISPLAY g_apb[l_ac].apb26 TO apb26                             #MOD-C40040 mark
#                 LET g_qryparam.form ="q_gem"   #FUN-D80031 mark
                  #FUN-D80031 add ----------- begin
                  IF g_prog = 'aapt140' THEN
                     LET g_qryparam.form ="q_occ02"
                     LET g_qryparam.where = " occ07= '",g_apa.apa06 CLIPPED,"'"
                  ELSE
                     LET g_qryparam.form ="q_gem"
                  END IF
                  #FUN-D80031 add ----------- end
                  LET g_qryparam.default1 = g_apb[l_ac].apb26
                  CALL cl_create_qry() RETURNING g_apb[l_ac].apb26
                  DISPLAY BY NAME g_apb[l_ac].apb26
                #----------------------MOD-C40040------------------------------(E)
 
              WHEN INFIELD(apb06)
                 LET g_fac_type = "  AND pmm09 = '",g_apa.apa05,"'",
                                  "  AND pmm22 = '",g_apa.apa13,"'"
                 CALL q_pmm902(FALSE,TRUE,g_apb[l_ac].apb06,g_fac_type,g_apb[l_ac].apb37,g_apa.apa01)   #FUN-9A0093  #MOD-C80172 add apa01
                 RETURNING g_apb[l_ac].apb06,g_apb[l_ac].apb07   #MOD-8A0139 add apb07
                 DISPLAY g_apb[l_ac].apb06 TO apb06
                 DISPLAY g_apb[l_ac].apb07 TO apb07   #MOD-8A0139 add
              WHEN INFIELD(apb12) #料件編號
                 CALL q_ima(FALSE,TRUE,g_apb[l_ac].apb37)
                      RETURNING g_apb[l_ac].apb12
                 DISPLAY g_apb[l_ac].apb12 TO apb12
                 NEXT FIELD apb12
              WHEN INFIELD(apb28) #採購單位
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_gfe"
                 LET g_qryparam.default1 = g_apb[l_ac].apb28
                 CALL cl_create_qry() RETURNING g_apb[l_ac].apb28
                 DISPLAY g_apb[l_ac].apb28 TO apb28
                 NEXT FIELD apb28
              WHEN INFIELD(apb32) #人員編號
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_gen"      #No.CHI-780046 
                 LET g_qryparam.default1 = g_apb[l_ac].apb32
                 CALL cl_create_qry() RETURNING g_apb[l_ac].apb32
                 DISPLAY g_apb[l_ac].apb32 TO apb32
                 NEXT FIELD apb32
               WHEN INFIELD(apb930)
                  CALL cl_init_qry_var()
                  LET g_qryparam.form ="q_gem4"
                  CALL cl_create_qry() RETURNING g_apb[l_ac].apb930
                  DISPLAY BY NAME g_apb[l_ac].apb930
                  NEXT FIELD apb930
              OTHERWISE
                 EXIT CASE
        END CASE
 
        #使用稅控系統, 可由單身維護發票資料
        ON ACTION enter_invoice
           IF INFIELD(apb02) THEN
              IF g_aza.aza26 = '2' AND g_aza.aza46 = 'Y' THEN   #No.FUN-580006
                 CALL t110_ddd_c(g_apb[l_ac].apb02)
                 DISPLAY BY NAME g_apa.apa07      #TQC-630164 
                 CALL t110_show_multi_invoice()   #No.TQC-A30076 
              END IF
           END IF
 
 
        ON ACTION CONTROLO                        #沿用所有欄位
           IF INFIELD(apb02) AND l_ac > 1 THEN
              LET g_apb[l_ac].* = g_apb[l_ac-1].*
              LET g_apb[l_ac].apb02 = NULL   #TQC-620018
              DISPLAY g_apb[l_ac].* TO s_apb[l_ac].*           #MOD-B10011
              NEXT FIELD apb02
           END IF
 
        ON ACTION CONTROLR
           CALL cl_show_req_fields()
 
        ON ACTION CONTROLG
           CALL cl_cmdask()
 
        ON ACTION CONTROLF
         CALL cl_set_focus_form(ui.Interface.getRootNode()) RETURNING g_fld_name,g_frm_name #Add on 040913
         CALL cl_fldhelp(g_frm_name,g_fld_name,g_lang) #Add on 040913
 
       ON IDLE g_idle_seconds
          CALL cl_on_idle()
          CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
 
    END INPUT

    CALL t110_b_fill(' 1=1')   #MOD-B80127 add
 
    LET g_apa.apamodu = g_user
    LET g_apa.apadate = g_today
    UPDATE apa_file SET apamodu = g_apa.apamodu,
                        apadate = g_apa.apadate,
                        apa63   = l_apa63
     WHERE apa01 = g_apa.apa01
    LET g_apa.apa63 = l_apa63
    DISPLAY BY NAME g_apa.apa63
    DISPLAY BY NAME g_apa.apamodu,g_apa.apadate   #FUN-5B0135
    IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF
    CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,g_apa.apaacti)
 
    SELECT COUNT(*) INTO l_cnt FROM apb_file
     WHERE apb01=g_apa.apa01
    IF l_cnt > 0 THEN
      #SELECT SUM(apb24),SUM(apb10) INTO g_amt1f,g_amt1 FROM apb_file     #MOD-A70214 mark
      # WHERE apb01 = g_apa.apa01 AND apb29='1'                           #MOD-A70214 mark
      #-MOD-A70214-add-
       IF g_aptype = '12' THEN
          SELECT SUM(apb24),SUM(apb10) INTO g_amt1f,g_amt1 FROM apb_file
           WHERE apb01 = g_apa.apa01 
       ELSE 
          SELECT SUM(apb24),SUM(apb10) INTO g_amt1f,g_amt1 FROM apb_file
           WHERE apb01 = g_apa.apa01 AND apb29='1'
       END IF
      #-MOD-A70214-end-
       IF g_amt1 IS NULL THEN
          LET g_amt1f= 0
          LET g_amt1 = 0
       END IF
       SELECT SUM(apb24),SUM(apb10) INTO g_amt2f,g_amt2 FROM apb_file
        WHERE apb01 = g_apa.apa01 AND apb29='3'
       IF g_amt2 IS NULL THEN
          LET g_amt2f= 0
          LET g_amt2 = 0
       END IF
       IF g_aptype MATCHES '1*' AND g_aptype <> '15' AND g_aptype <> '17' AND g_aptype <> '16' THEN  #MOD-970173 add
          LET g_apa.apa57f= g_amt1f + g_amt2f   #MOD-6A0025
          LET g_apa.apa57 = g_amt1 + g_amt2   #MOD-6A0025
       END IF
       IF g_aptype MATCHES '2*' THEN
          LET g_apa.apa57f= g_amt2f + g_amt1f   #MOD-6A0025
          LET g_apa.apa57 = g_amt2 + g_amt1   #MOD-6A0025
       END IF
       IF g_apa.apa57f IS NULL THEN
          LET g_apa.apa57f= 0
       END IF
       IF g_apa.apa57  IS NULL THEN
          LET g_apa.apa57 = 0
       END IF
       LET g_apa.apa57f=cl_digcut(g_apa.apa57f,t_azi04)   #MOD-6B0066
       LET g_apa.apa57=cl_digcut(g_apa.apa57,g_azi04)   #MOD-6B0066
     #-MOD-AA0190-add-
       IF g_aptype='11' THEN                                 
          LET g_apa.apa33=g_apa.apa31-g_apa.apa57              #No.TQC-A30161
          LET g_apa.apa33f=g_apa.apa31f-g_apa.apa57f           #No.TQC-A30161
       ELSE                                             
          LET g_apa.apa33=0                            
          LET g_apa.apa33f=0                        
       END IF                                 
       DISPLAY BY NAME g_apa.apa33                     
     #-MOD-AA0190-end-
       DISPLAY BY NAME g_apa.apa57
       IF (g_aptype='12' OR g_aptype='22') AND g_apa.apa31=0 THEN  #MOD-9B0168
          LET g_apa.apa31 = g_apa.apa57
          LET g_apa.apa31f = g_apa.apa57f
          LET g_apa.apa32 = g_apa.apa57*g_apa.apa16/100    #No.TQC-740167
          CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
          LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add
          LET g_apa.apa32f = g_apa.apa57f*g_apa.apa16/100  #No.TQC-740167
          CALL t110_apa32f() RETURNING l_apa32f                   #No.MOD-B80140 add
          LET g_apa.apa32f = l_apa32f                             #No.MOD-B80140 add
          LET g_apa.apa32f = cl_digcut(g_apa.apa32f,t_azi04)
          LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)
          DISPLAY BY NAME g_apa.apa31,g_apa.apa31f,g_apa.apa32,g_apa.apa32f  #No.TQC-740167 add apa32,apa32f
       END IF
    ELSE
       #IF g_aptype !='11' THEN   #MOD-890177 add
       IF g_aptype <> '11' AND g_aptype <> '21' THEN #FUN-BC0031 
          LET g_apa.apa57 = g_apa.apa31
          LET g_apa.apa57f = g_apa.apa31f
          DISPLAY BY NAME g_apa.apa57
       END IF                    #MOD-890177 add
    END IF
 
 
    #IF g_aptype = '11' AND g_apa.apa57f > g_apa.apa31f AND g_apz.apz15 = 'N' THEN
    IF (g_aptype = '11' OR g_aptype = '21') AND g_apa.apa57f > g_apa.apa31f AND g_apz.apz15 = 'N' THEN  #FUN-BC0031
       CALL cl_err('apa57f >apa31f: ','aap-051',1)
    END IF
 
    CALL t110_diff_rtn('0') ##TQC-750140
 
    IF g_apa.apa56 = '5' THEN
       CALL t110_ppp('2')
    END IF

   #-MOD-C20104-add-
    IF g_apz.apz27 = 'Y' AND g_aza.aza17 != g_apa.apa13 THEN
       LET l_sumapi05f = 0
       LET l_sumapi05 = 0
       LET l_chkamt = 0
       LET l_diffamt = 0
       LET l_apa73 = 0
       LET g_sql = "SELECT api26,SUM(api05f),SUM(api05) ",
                   "  FROM api_file ",
                   " WHERE api01 = '",g_apa.apa01,"'",
                   "   AND api02 = '2'",
                   " GROUP BY api26 ",
                   " ORDER BY api26 "
       PREPARE sel_api_pre FROM g_sql
       DECLARE sel_api_cur CURSOR FOR sel_api_pre
       FOREACH sel_api_cur INTO l_api26,l_sumapi05f,l_sumapi05
          IF cl_null(l_sumapi05f) THEN LET l_sumapi05f = 0 END IF
          IF cl_null(l_sumapi05) THEN LET l_sumapi05 = 0 END IF
          SELECT apa34f-apa35f,apa73 INTO l_chkamt,l_apa73
            FROM apa_file
           WHERE apa01 = l_api26
          IF cl_null(l_chkamt) THEN LET l_chkamt = 0 END IF
          IF cl_null(l_apa73) THEN LET l_apa73 = 0 END IF
          IF l_chkamt = l_sumapi05f AND l_apa73 <> l_sumapi05 THEN
             LET l_diffamt = l_apa73 - l_sumapi05 
             LET g_sql=" SELECT api03 ",
                       "   FROM api_file ",
                       "  WHERE api01 = '",g_apa.apa01,"'",
                       "    AND api26 = '",l_api26,"'",
                       "    AND api02 = '2'",
                       "  ORDER BY api05 DESC "
             PREPARE p110_max_p FROM g_sql
             DECLARE p110_max_c SCROLL CURSOR FOR p110_max_p
             OPEN p110_max_c
             FETCH FIRST p110_max_c INTO l_api03
             UPDATE api_file SET api05 = api05 + l_diffamt
              WHERE api01 = g_apa.apa01
                AND api02 = '2'   
                AND api03 = l_api03
          END IF
       END FOREACH 
    END IF
   #-MOD-C20104-end-

   #CALL t110_api_diff()   #MOD-970115   #MOD-C60107 mark 
    IF g_aptype='11' AND g_apa.apa56='0' AND (g_apa.apa31!=g_apa.apa57)
       THEN CONTINUE WHILE
    END IF
 
    #No.+111 010510 by plym add 調整apk折讓單稅額和單頭有無誤差
    IF g_apa.apa00='21' AND g_apa.apa58 <> '1' THEN
       CALL t110_chkapk(g_apa.apa01,g_apa.apa01,'1')
    END IF
 
    IF g_apa.apa08 != 'MISC' AND g_apa.apa08 != g_apa.apa01 AND
       NOT cl_null(g_apa.apa08) AND g_apa.apa08 !='UNAP' AND
       g_apa.apa00 != '21' THEN
       CALL t110_ddd1('u')
    END IF
 
        #LET l_sql = "SELECT pmc913  FROM ",li_dbs CLIPPED,"pmc_file ",
        LET l_sql = "SELECT pmc913  FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmc_file'), #FUN-A50102
                    " WHERE pmc01 = '",g_apa.apa05,"' "
        CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	    CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
        PREPARE sel_pmc913_cs2 FROM l_sql
        EXECUTE sel_pmc913_cs2 INTO l_pmc913
        IF g_aptype = '15' AND g_aza.aza26 != '2' AND 
        (g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y')) THEN             
       LET l_cnt = 0
       SELECT COUNT(*) INTO l_cnt FROM apb_file WHERE apb06 IS NOT NULL
                                                  AND apb01=g_apa.apa01
       IF l_cnt > 0 THEN
          DECLARE apa_c CURSOR FOR
           SELECT apb06,apb10,apb24
             FROM apb_file
            WHERE apb01 = g_apa.apa01
          LET g_cnt = 1
          LET l_apb10 = 0
          LET l_apb24 = 0
          CALL l_apb.clear()
          FOREACH apa_c INTO l_apb[g_cnt].*
             IF SQLCA.sqlcode THEN
                CALL cl_err('foreach:',SQLCA.sqlcode,1)
                EXIT FOREACH
             END IF
             IF NOT cl_null(l_apb[g_cnt].apb06) THEN
                #LET l_sql = "SELECT pmm43 FROM ",li_dbs CLIPPED,"pmm_file ",
                LET l_sql = "SELECT pmm43 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmm_file'), #FUN-A50102
                            " WHERE pmm01 = '",l_apb[g_cnt].apb06,"' "
                CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	            CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
                PREPARE sel_pmm43_cs FROM l_sql
                EXECUTE sel_pmm43_cs INTO l_pmm43
                IF cl_null(l_pmm43) THEN LET l_pmm43 = 0 END IF
                LET l_apb10 = l_apb10 + l_apb[g_cnt].apb10 * (1 + l_pmm43/100)
                LET l_apb24 = l_apb24 + l_apb[g_cnt].apb24 * (1 + l_pmm43/100)
             ELSE
                LET l_apb10 = l_apb10 + l_apb[g_cnt].apb10
                LET l_apb24 = l_apb24 + l_apb[g_cnt].apb24
             END IF
 
             LET g_cnt = g_cnt + 1
          END FOREACH
          IF cl_null(l_apb24) THEN LET l_apb24 = 0 END IF
          IF cl_null(l_apb10) THEN LET l_apb10 = 0 END IF
          IF g_apa.apa31f > l_apb24 OR g_apa.apa31 > l_apb10 THEN
             #單頭金額大於單身合計金額, (1)修改單頭 (2)修改單身:
             CALL cl_getmsg('aap-117',g_lang) RETURNING g_msg
             WHILE TRUE
                LET g_chr=' '
                LET INT_FLAG = 0  ######add for prompt bug
                PROMPT g_msg CLIPPED FOR CHAR g_chr
                   ON IDLE g_idle_seconds
                      CALL cl_on_idle()
 
                   ON ACTION about         #MOD-4C0121
                      CALL cl_about()      #MOD-4C0121
 
                   ON ACTION help          #MOD-4C0121
                      CALL cl_show_help()  #MOD-4C0121
 
                   ON ACTION controlg      #MOD-4C0121
                      CALL cl_cmdask()     #MOD-4C0121
                END PROMPT
                IF INT_FLAG THEN LET INT_FLAG = 0 END IF
                IF g_chr MATCHES "[12]" THEN EXIT WHILE END IF
             END WHILE
             IF g_chr = '2' THEN LET l_exit_sw = 'n' END IF
             IF g_chr = '1' THEN CALL t110_i("u") END IF
          END IF
       END IF
    END IF
 
   #CALL t110_gen_gl()  #MOD-490323  #MOD-CB0128 mark
 
    IF l_exit_sw = 'y' THEN
       EXIT WHILE
    ELSE
       CONTINUE WHILE
    END IF
  END WHILE                        #MOD-550063
 
  CLOSE t110_bcl
  CALL t110_delHeader()     #CHI-C30002 add
  COMMIT WORK
  CALL t110_list_fill()  #FUN-CB0080 add  
 
END FUNCTION
 
#CHI-C30002 -------- add -------- begin
FUNCTION t110_delHeader()
   DEFINE l_action_choice    STRING               #CHI-C80041
   DEFINE l_cho              LIKE type_file.num5  #CHI-C80041
   DEFINE l_num              LIKE type_file.num5  #CHI-C80041
   DEFINE l_slip             LIKE type_file.chr5  #CHI-C80041
   DEFINE l_sql              STRING               #CHI-C80041
   DEFINE l_cnt              LIKE type_file.num5  #CHI-C80041
   
   IF g_rec_b = 0 THEN
      #CHI-C80041---begin
      CALL s_get_doc_no(g_apa.apa01) RETURNING l_slip
      LET l_sql = " SELECT COUNT(*) FROM apa_file ",
                  "  WHERE apa01 LIKE '",l_slip,"%' ",
                  "    AND apa01 > '",g_apa.apa01,"'"
      PREPARE t110_pb1 FROM l_sql 
      EXECUTE t110_pb1 INTO l_cnt    
      
      LET l_action_choice = g_action_choice
      LET g_action_choice = 'delete'
      IF cl_chk_act_auth() AND l_cnt = 0 THEN
         CALL cl_getmsg('aec-130',g_lang) RETURNING g_msg
         LET l_num = 3
      ELSE
         CALL cl_getmsg('aec-131',g_lang) RETURNING g_msg
         LET l_num = 2
      END IF 
      LET g_action_choice = l_action_choice
      PROMPT g_msg CLIPPED,': ' FOR l_cho
         ON IDLE g_idle_seconds
            CALL cl_on_idle()

         ON ACTION about     
            CALL cl_about()

         ON ACTION help         
            CALL cl_show_help()

         ON ACTION controlg   
            CALL cl_cmdask() 
      END PROMPT
      IF l_cho > l_num THEN LET l_cho = 1 END IF 
      IF l_cho = 2 THEN 
         #CALL t110_c()               #FUN-D20035
         CALL t110_c(1)               #FUN-D20035
         IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF   
         CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,"") 
      END IF 
      
      IF l_cho = 3 THEN 
      #CHI-C80041---end
      #IF cl_confirm("9042") THEN  #CHI-C80041
         DELETE FROM apa_file WHERE apa01 = g_apa.apa01
         DELETE FROM apc_file WHERE apc01 = g_apa.apa01  #MOD-C60168 add
         DELETE FROM apk_file WHERE apk01 = g_apa.apa01
         DELETE FROM npp_file
          WHERE npp01 = g_apa.apa01
            AND nppsys = 'AP'
            AND npp00 = 1
            AND npp011 = 1
         DELETE FROM npq_file
          WHERE npq01 = g_apa.apa01
            AND npqsys = 'AP'
            AND npq00 = 1
            AND npq011 = 1
         DELETE FROM tic_file WHERE tic04 = g_apa.apa01
         DELETE FROM apd_file WHERE apd01 = g_apa.apa01
         DELETE FROM apx_file WHERE apx01 = g_apa.apa01
         DELETE FROM api_file WHERE api01 = g_apa.apa01
         DELETE FROM apg_file WHERE apg01 = g_apa.apa01
         DELETE FROM aph_file WHERE aph01 = g_apa.apa01
         DELETE FROM apv_file WHERE apv01 = g_apa.apa01
         INITIALIZE g_apa.* TO NULL
         CLEAR FORM
      END IF
   END IF
END FUNCTION
#CHI-C30002 -------- add -------- end

FUNCTION t110_apb25()

  LET g_errno = '' 
  IF g_apy.apydmy5='Y' AND g_apa.apa00[1,1]='1' AND
     g_apb[l_ac].apb09 != 0 THEN
     DISPLAY 'INTO t110_apb25'
     IF g_aza.aza63 = 'Y' THEN   #MOD-7B0257
        IF cl_null(g_apb[l_ac].apb251) THEN
           LET g_errno = 'apb251'
           RETURN
        END IF
     END IF   #MOD-7B0257
     IF cl_null(g_apb[l_ac].apb26) THEN
        LET g_errno = 'apb26'
        RETURN
     END IF
        IF cl_null(g_apb[l_ac].apb25) THEN
           LET g_errno = 'apb25'
           RETURN
        END IF
  END IF
  DISPLAY 'RETURN TRUE'
END FUNCTION
 
FUNCTION t110_compute_apa33()
 
 DEFINE l_amt        LIKE apb_file.apb10  #No:8014 DECIMAL(12,0)
 DEFINE l_diff_amt   LIKE apa_file.apa33, #No:8014 DECIMAL(12,0),
        i            LIKE type_file.num5    #No.FUN-690028 SMALLINT
 
    LET l_amt =    0
 
     FOR i = 1 TO g_apb.getLength()    #No.MOD-480131
       IF (g_aptype='12' OR g_aptype='15' OR g_aptype='13' OR g_aptype='17') THEN   #No.FUN-690080
         IF g_apb[i].apb31 IS NULL OR g_apb[i].apb31 = ' ' THEN
            CONTINUE FOR END IF
       ELSE
         IF g_apb[i].apb21 IS NULL OR g_apb[i].apb21 = ' ' THEN
            CONTINUE FOR END IF
       END IF
 
       LET l_amt = l_amt + g_apb[i].apb10
    END FOR
 
    LET g_apa.apa31 = cl_digcut(g_apa.apa31,g_azi04)   #MOD-6B0066
    LET l_diff_amt = g_apa.apa31 - l_amt
 
    LET g_apa.apa33 = l_diff_amt
 
    DISPLAY BY NAME g_apa.apa33
 
END FUNCTION
 
FUNCTION t110_diff_rtn(p_cmd) ##TQC-750140
 DEFINE  p_cmd    LIKE type_file.chr1   #TQC-750140
 DEFINE  l_apa01  LIKE apa_file.apa01,
         l_apa    RECORD LIKE apa_file.*,
         l_sql    STRING,   #MOD-720062
         g_t1     LIKE oay_file.oayslip,  #MOD-8C0221 add
         l_cnt    LIKE type_file.num5,    #MOD-980030 add
         l_apa32  LIKE apa_file.apa32,    #MOD-B80140 add
         l_apa32f LIKE apa_file.apa32f    #MOD-B80140 add
 
   IF g_apa.apa41 = 'Y' THEN
      CALL cl_err("apa41=Y",'aap-086',0)
      RETURN
   END IF
   IF g_action_choice != "contra" AND g_action_choice != "modify" THEN      #FUN-8A0075
  #IF g_apa.apa63 MATCHES '[Ss1]' THEN      #FUN-540045 #FUN-550042 #MOD-C90206 mark
   IF g_apa.apa63 MATCHES '[Ss]' THEN       #MOD-C90206 add
      CALL cl_err('','mfg3557',0)
      RETURN
   END IF
   END IF                                   #FUN-8A0075
 
   IF g_apa.apa42 = 'Y' THEN
      CALL cl_err("apa42=Y",'aap-165',0)
      RETURN
   END IF
 
   IF g_apa.apa74 = 'Y' THEN
      CALL cl_err("apa74=Y",'aap-334',0)
      RETURN
   END IF
 
   IF g_aptype = '16' OR g_aptype = '26' THEN
      IF g_apa.apa57f <> g_apa.apa31f OR g_apa.apa57 <> g_apa.apa31 THEN
         LET g_apa.apa31f = g_apa.apa57f
         LET g_apa.apa31  = g_apa.apa57 
         LET g_apa.apa32f = 0
         LET g_apa.apa32  = 0
         LET g_apa.apa33f = 0
         LET g_apa.apa33  = 0
         LET g_apa.apa34f = g_apa.apa57f
         LET g_apa.apa34  = g_apa.apa57 
         LET g_apa.apa35f = 0
         LET g_apa.apa35  = 0
         LET g_apa.apa73  = g_apa.apa57
         LET p_cmd = '1'
      END IF
   END IF
 
   #IF g_aptype = '11' THEN     #MOD-640549       #FUN-BC0031 mark
   IF g_aptype = '11' OR g_aptype = '21' THEN     #FUN-BC0031
      IF g_apa.apa57f != g_apa.apa31f OR g_apa.apa57 != g_apa.apa31 THEN
         IF g_apa.apa56 = '5' AND g_apa.apa33 = 0 THEN   #5.沖期初開帳的暫估
            RETURN
         END IF
         CALL t110_diff()
         IF g_apa.apa56 = '0' THEN
            RETURN
         END IF
      ELSE
        #-MOD-AA0120-add-
         IF g_apa.apa56 = '1' THEN
            LET g_apa.apa56 = '0'   #差異處理(正常)   
         END IF
        #-MOD-AA0120-end-
        #LET g_apa.apa56 = '0'   #差異處理(正常)     #MOD-A80069
         LET g_apa.apa33f= 0
         LET g_apa.apa33 = 0
         LET g_apa.apa60f= 0
         LET g_apa.apa61f= 0
         LET g_apa.apa60 = 0
         LET g_apa.apa61 = 0
         DISPLAY BY NAME g_apa.apa56,g_apa.apa33,g_apa.apa60f,g_apa.apa60,
                         g_apa.apa61f,g_apa.apa61
         UPDATE apb_file SET apb15 = 0,
                             apb13f= 0,
                             apb13 = 0,
                             apb14f= 0,
                             apb14 = 0
          WHERE apb01=g_apa.apa01
      END IF
 
      IF g_apa.apa57f=(g_apa.apa31f+g_apa.apa33f) AND g_apa.apa19=g_apz.apz12 THEN
         LET g_apa.apa19 = NULL
         LET g_apa.apa20 = 0
         UPDATE apc_file SET apc16=0 WHERE apc01=g_apa.apa01          #MOD-A70116 add
         DISPLAY BY NAME g_apa.apa19,g_apa.apa20
         DISPLAY '' TO apo02
      END IF
   END IF
 
   #IF g_aptype='12' OR g_aptype='13' OR g_aptype='21' OR g_aptype='17' THEN  #No.FUN-690080  #MOD-A10133 add 21 #TQC-A40107 add 17
   IF g_aptype='12' OR g_aptype='13' OR g_aptype='17' THEN  #No.FUN-BC0031
      IF g_apa.apa57f != g_apa.apa31f OR g_apa.apa57 != g_apa.apa31 THEN
        #詢問aap-336前,增加判斷單身是否有沖暫估資料,若有則不更新單頭金額
         LET l_cnt = 0
         SELECT COUNT(*) INTO l_cnt FROM apb_file
          WHERE apb01=g_apa.apa01 AND apb34='Y'
         IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
         IF l_cnt = 0 THEN
            IF cl_confirm('aap-336') THEN
               CALL t110_b('')
            ELSE                          #CHI-910032                                                                                  
               CALL t110_sum_apa()        #CHI-910032 
            END IF
         END IF   #MOD-980030 add
      END IF
   END IF
 
      LET l_cnt = 0                                                   #MOD-BC0194 add
      SELECT COUNT(*) INTO l_cnt FROM apk_file                        #MOD-BC0194 add
       WHERE apk01 = g_apa.apa01                                      #MOD-BC0194 add
      IF cl_null(l_cnt) THEN LET l_cnt = 0  END IF                    #MOD-BC0194 add
     #IF g_aptype <> '12' AND g_aptype <> '22' THEN                   #MOD-680012 #MOD-9B0168 #MOD-BC0194 mark
      IF g_aptype <> '12' AND g_aptype <> '22' AND l_cnt = 0 THEN     #MOD-BC0194 add
         IF g_apa.apa31f<>g_apa_t.apa31f AND g_apa_t.apa31f > 0 THEN
            LET g_apa.apa32f = g_apa.apa31f * g_apa.apa16 / 100
            CALL t110_apa32f() RETURNING l_apa32f                   #No.MOD-B80140 add
            LET g_apa.apa32f = l_apa32f                             #No.MOD-B80140 add
            LET g_apa.apa32f = cl_digcut(g_apa.apa32f,t_azi04)   #MOD-6B0066
         END IF
         
         IF g_apa.apa31 <>g_apa_t.apa31 AND g_apa_t.apa31 > 0 THEN
            LET g_apa.apa32  = g_apa.apa31 * g_apa.apa16 / 100
            CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
            LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add
            LET g_apa.apa32  = cl_digcut(g_apa.apa32 ,g_azi04)   #MOD-6B0066
         END IF
         
         DISPLAY BY NAME g_apa.apa31f,g_apa.apa31,g_apa.apa32f,g_apa.apa32
      END IF   #MOD-680012
 
   CALL t110_apa34f(p_cmd)   #TQC-750140
   CALL t110_unpay()
 
   LET g_apa.apa72=g_apa.apa14
   CALL t110_comp_oox(g_apa.apa01) RETURNING g_net  #CHI-890017 add
   LET g_apa.apa73=g_apa.apa34-g_apa.apa35+g_net    #CHI-890017
 
   UPDATE apa_file set * = g_apa.* WHERE apa01 = g_apa.apa01
   IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
      LET g_success = 'N'
      CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","up_apa",1)  #No.FUN-660122
      RETURN
   END IF
   IF g_apa.apa08 != 'MISC' AND g_apa.apa08 != g_apa.apa01 AND
      NOT cl_null(g_apa.apa08) AND g_apa.apa08 != 'UNAP' AND 
      g_apa.apa00 != '21' THEN                                                                                                    
      CALL t110_ddd1('u')                                                                                                           
   END IF                 
 
   CALL t110_apa56()
   IF g_apa.apa56 <> '5' THEN   #yinhy131012
      CALL t110_api_diff()  #MOD-C60107
   END IF                       #yinhy131012
   DISPLAY BY NAME g_apa.apa56
 
   LET g_t1=g_apa.apa01[1,g_doc_len]
   SELECT apydmy3 INTO g_apy.apydmy3 FROM apy_file WHERE apyslip=g_t1
   IF g_apy.apydmy3 = 'Y' AND g_apa.apa56 != 0 THEN    #No.MOD-920052
      #IF cl_confirm('axr-309') THEN   #MOD-C30689 MARK
         CALL t110_g_gl(g_apa.apa00,g_apa.apa01,'0','')     #FUN-9C0001 add ''
         IF g_aza.aza63 ='Y' THEN
            CALL t110_g_gl(g_apa.apa00,g_apa.apa01,'1','')  #FUN-9C0001 add '' 
         END IF
      #END IF                  #MOD-C30689 MARK
   END IF   #MOD-8C0221 add
 
END FUNCTION
 
FUNCTION t110_apb12(p_cmd,p_no)  #料件編號
    DEFINE l_ima02 LIKE ima_file.ima02,
           l_ima021 LIKE ima_file.ima021,
           l_ima39 LIKE ima_file.ima39,
           l_ima44 LIKE ima_file.ima44,
           l_imaacti LIKE ima_file.imaacti,
           p_no      LIKE type_file.chr4,        # No.FUN-690028 VARCHAR(04),
           p_cmd     LIKE type_file.chr1,   #No.FUN-690028 VARCHAR(1)
           l_ima01   LIKE ima_file.ima01,        #CHI-990015 add
           l_aag05   LIKE aag_file.aag05,        #CHI-990015 add
           l_cnt     LIKE type_file.num5,         #MOD-A70048 
           l_ima391  LIKE ima_file.ima391    #TQC-B80082  add ima391
 
   LET g_errno = " "
  #-MOD-A70048-add-
   LET l_cnt = 0
   SELECT count(*) INTO l_cnt
     FROM ima_file
    WHERE ima01 = g_apb[l_ac].apb12
  #-MOD-A70048-add-
  #IF p_no = 'MISC' THEN                   #MOD-A70048 mark
   IF p_no = 'MISC' AND l_cnt = 0 THEN     #MOD-A70048
      LET l_ima01 = p_no
   ELSE
      LET l_ima01 = g_apb[l_ac].apb12
   END IF
  # LET l_sql = "SELECT ima02,ima021,ima39,ima44,imaacti", #TQC-B80082 mark
   LET l_sql = "SELECT ima02,ima021,ima39,ima391,ima44,imaacti",  #TQC-B80082 add
               #"  FROM ",li_dbs CLIPPED,"ima_file ",
               "  FROM ",cl_get_target_table(g_apb[l_ac].apb37,'ima_file'), #FUN-A50102
               " WHERE ima01 = '",l_ima01,"' "
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
   CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
   PREPARE sel_ima_cs FROM l_sql
   EXECUTE sel_ima_cs INTO l_ima02,l_ima021,l_ima39,l_ima391,l_ima44,l_imaacti   #TQC-B80082 add ima391
   CASE
      WHEN SQLCA.SQLCODE = 100
         LET g_errno = 'mfg0002'
         LET l_ima02 = NULL
         LET l_imaacti = NULL
         LET l_ima021=NULl
      WHEN l_imaacti='N'
         LET g_errno = '9028'
      WHEN l_imaacti MATCHES '[PH]'       
         LET g_errno = '9038'         #No.FUN-690022
      OTHERWISE
         LET g_errno = SQLCA.SQLCODE USING '-------'
   END CASE
 
   IF g_apb[l_ac].apb27 IS NULL OR p_no != 'MISC' THEN
      LET g_apb[l_ac].apb27= l_ima02
      DISPLAY BY NAME g_apb[l_ac].apb27
   END IF
 
   IF g_apb[l_ac].apb25 IS NULL AND (
      ((g_aptype='15' OR g_aptype='17') AND g_apb[l_ac].apb12 <> 'MISC') OR
      ( g_aptype='12' AND p_no='MISC')) THEN
      LET g_apb[l_ac].apb25 = l_ima39
      LET g_apb[l_ac].apb251 = l_ima391   #TQC-B80082 add
      DISPLAY g_apb[l_ac].apb25 TO s_apb[l_ac].apb25
      DISPLAY g_apb[l_ac].apb251 TO s_apb[l_ac].apb251  #TQC-B80082  add
   END IF
 
   IF g_apb[l_ac].apb12 <> 'MISC' AND cl_null(g_apb[l_ac].apb28) THEN
      LET g_apb[l_ac].apb28 = l_ima44
      DISPLAY g_apb[l_ac].apb28 TO s_apb[l_ac].apb28
   END IF
 
   #當執行aapt120,若單身科目需做部門管理,單身部門預設帶入單頭部門
   IF g_aptype='12' AND NOT cl_null(g_apb[l_ac].apb25) THEN
      #LET l_sql = "SELECT aag05 FROM ",li_dbs CLIPPED,"aag_file ",
      LET l_sql = "SELECT aag05 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'aag_file'), #FUN-A50102
                  " WHERE aag01='",g_apb[l_ac].apb25,"' ",
                  "   AND aag00='",g_bookno1,"' ",
                  "   AND aagacti = 'Y'"                        #No.MOD-B70280 add
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
      CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102               
      PREPARE sel_aag05_cs1 FROM l_sql
      EXECUTE sel_aag05_cs1 INTO l_aag05
     #IF l_aag05='Y' THEN                                     #MOD-A70003 mark
      IF l_aag05='Y' AND cl_null(g_apb[l_ac].apb26) THEN      #MOD-A70003
         LET g_apb[l_ac].apb26 = g_apa.apa22
         DISPLAY g_apb[l_ac].apb26 TO s_apb[l_ac].apb26
      END IF 
   END IF
 
END FUNCTION
 
FUNCTION t110_unit(p_unit)  #單位
   DEFINE p_unit    LIKE gfe_file.gfe01,
          l_gfeacti LIKE gfe_file.gfeacti
 
   LET g_errno = ' '
   #LET l_sql = "SELECT gfeacti FROM ",li_dbs CLIPPED,"gfe_file ",
   LET l_sql = "SELECT gfeacti FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gfe_file'), #FUN-A50102
               " WHERE gfe01 = '",p_unit,"' "
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
   CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
   PREPARE sel_gfeacti_cs FROM l_sql
   EXECUTE sel_gfeacti_cs INTO l_gfeacti
 
   CASE
      WHEN SQLCA.SQLCODE = 100
         LET g_errno = 'mfg2605'
         LET l_gfeacti = NULL
      WHEN l_gfeacti='N'
         LET g_errno = '9028'
      OTHERWISE
         LET g_errno = SQLCA.SQLCODE USING '-------'
   END CASE
 
END FUNCTION
 
FUNCTION t110_diff()
   DEFINE l_aag02     LIKE aag_file.aag02,
          l_cnt       LIKE type_file.num5    #No.FUN-690028 SMALLINT
   DEFINE l_apa20     LIKE apa_file.apa20
   DEFINE l_apc16     LIKE apc_file.apc16
   DEFINE l_apc02     LIKE apc_file.apc02
 
   IF g_aptype = '11' THEN    #FUN-BC0031 
      OPEN WINDOW t110_diff_w AT 6,03 WITH FORM "aap/42f/aapt110_8"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No.FUN-580092 HCN
      CALL cl_ui_locale("aapt110_8")
   END IF                     #FUN-BC0031
   #No.FUN-BC0031  --Begin
   IF g_aptype = '21' THEN
      OPEN WINDOW t110_diff_w AT 6,03 WITH FORM "aap/42f/aapt110_10"
         ATTRIBUTE (STYLE = g_win_style CLIPPED)
      CALL cl_ui_locale("aapt110_10")
   END IF
   #No.FUN-BC0031  --End

 
    #FUN-A50102--add--str--
    IF NOT cl_null(g_apa.apa100) THEN
       LET m_plant = g_apa.apa100
    ELSE
       LET m_plant = g_plant
    END IF 
    #FUN-A50102--add--end
    IF g_aza.aza63 ='N' THEN
       CALL cl_set_comp_visible("apa531,aag021",FALSE)
    END IF
   #LET l_sql = "SELECT aag02 FROM ",li_dbs CLIPPED,"aag_file ",
   LET l_sql = "SELECT aag02 FROM ",cl_get_target_table(m_plant,'aag_file'), #FUN-A50102
               " WHERE aag01='",g_apa.apa531,"' ",
               "   AND aag00='",g_bookno2,"' ",
               "   AND aagacti = 'Y'"                        #No.MOD-B70280 add
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
   CALL cl_parse_qry_sql(l_sql,m_plant) RETURNING l_sql #FUN-A50102             
   PREPARE sel_aag02_cs3 FROM l_sql
   EXECUTE sel_aag02_cs3 INTO l_aag02
 
   DISPLAY l_aag02 TO aag021
   #LET l_sql = "SELECT aag02 FROM ",li_dbs CLIPPED,"aag_file ",
   LET l_sql = "SELECT aag02 FROM ",cl_get_target_table(m_plant,'aag_file'), #FUN-A50102
               " WHERE aag01='",g_apa.apa53,"' ",
               "   AND aag00='",g_bookno1,"' ",
               "   AND aagacti = 'Y'"                        #No.MOD-B70280 add
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
   CALL cl_parse_qry_sql(l_sql,m_plant) RETURNING l_sql #FUN-A50102               
   PREPARE sel_aag02_cs4 FROM l_sql
   EXECUTE sel_aag02_cs4 INTO l_aag02
 
   DISPLAY l_aag02 TO aag02
 
   CALL cl_set_act_visible("cancel", FALSE)  #MOD-490323
   CALL cl_set_head_visible("","YES")        #No.FUN-6B0033
 
   INPUT BY NAME g_apa.apa56,g_apa.apa53,g_apa.apa531 WITHOUT DEFAULTS    #No.FUN-680029
 
      AFTER FIELD apa56
         IF NOT cl_null(g_apa.apa56) THEN
            IF g_apa.apa56 = '3' AND g_apa.apa57f > g_apa.apa31f THEN
               CALL cl_err('apa57f>apa31f: ','aap-153',0)
               NEXT FIELD apa56
            END IF
            IF g_apa.apa56 NOT MATCHES "[0123456]" THEN  #No.TQC-7B0083   #No.TQC-860014 add 6
               NEXT FIELD apa56
            END IF
            IF g_apa.apa56 MATCHES "[01]" THEN
               EXIT INPUT
            END IF
            INITIALIZE g_aps.* TO NULL
            IF g_apa.apa53 IS NULL THEN
               IF g_apz.apz13 = 'Y' THEN
                  SELECT * INTO g_aps.* FROM aps_file WHERE aps01 = g_apa.apa22
               ELSE
                  SELECT * INTO g_aps.* FROM aps_file WHERE (aps01 = ' ' OR aps01 IS NULL)
               END IF
               IF g_apa.apa56 = '2' THEN
                  LET g_apa.apa53 = g_aps.aps44
                  DISPLAY BY NAME g_apa.apa53
               END IF
            END IF
            IF g_apa.apa531 IS NULL AND g_aza.aza63 ='Y' THEN
               IF g_apz.apz13 = 'Y' THEN
                  SELECT * INTO g_aps.* FROM aps_file WHERE aps01 = g_apa.apa22
               ELSE
                  SELECT * INTO g_aps.* FROM aps_file WHERE (aps01 = ' ' OR aps01 IS NULL)
               END IF
               IF g_apa.apa56 = '2' THEN
                  LET g_apa.apa531 = g_aps.aps441
                  DISPLAY BY NAME g_apa.apa531
               END IF
            END IF
         END IF
 
      AFTER FIELD apa53
         IF g_apz.apz02 = 'Y' AND g_apa.apa56 = '2' THEN
            CALL s_aapact(g_apz.apz11,g_bookno1,g_apa.apa53) RETURNING g_msg    #No.FUN-730064
            IF NOT cl_null(g_errno) THEN
               CALL cl_err(g_apa.apa53,g_errno,0)
               #No.FUN-B10050  --Begin
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"
               LET g_qryparam.construct = 'N'
               LET g_qryparam.default1 = g_apa.apa53
               LET g_qryparam.arg1 = g_bookno1
               LET g_qryparam.where = " aag03 ='2' AND aag01 LIKE '",g_apa.apa53 CLIPPED,"%'"
               CALL cl_create_qry() RETURNING g_apa.apa53
               DISPLAY BY NAME g_apa.apa53
               #No.FUN-B10050  --End  
               NEXT FIELD apa53
            END IF
            DISPLAY g_msg TO l_aag02
         END IF
      AFTER FIELD apa531
         IF g_apz.apz02 = 'Y' AND g_apa.apa56 = '2' THEN
            CALL s_aapact(g_apz.apz11,g_bookno2,g_apa.apa531) RETURNING g_msg    #No.FUN-730064
            IF NOT cl_null(g_errno) THEN
               CALL cl_err(g_apa.apa531,g_errno,0)
               #No.FUN-B10050  --Begin
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"
               LET g_qryparam.construct = 'N'
               LET g_qryparam.default1 = g_apa.apa531
               LET g_qryparam.arg1 = g_bookno2
               LET g_qryparam.where = " aag03 ='2' AND aag01 LIKE '",g_apa.apa531 CLIPPED,"%'"
               CALL cl_create_qry() RETURNING g_apa.apa531
               DISPLAY BY NAME g_apa.apa531
               #No.FUN-B10050  --End  
               NEXT FIELD apa531
            END IF
            DISPLAY g_msg TO aag021
         END IF
 
      ON ACTION CONTROLP
         CASE
            WHEN INFIELD(apa53) # Account number
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"   #TQC-790133
               LET g_qryparam.default1 = g_apa.apa53
               LET g_qryparam.arg1 = g_bookno1      #No.FUN-730064
               CALL cl_create_qry() RETURNING g_apa.apa53
               DISPLAY BY NAME g_apa.apa53
            WHEN INFIELD(apa531) # Account number
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"   #TQC-790133
               LET g_qryparam.default1 = g_apa.apa531
               LET g_qryparam.arg1 = g_bookno2      #No.FUN-730064
               CALL cl_create_qry() RETURNING g_apa.apa531
               DISPLAY BY NAME g_apa.apa531
         END CASE
 
      AFTER INPUT
         IF g_apa.apa56 = '3' AND g_apa.apa57f > g_apa.apa31f THEN
            CALL cl_err('apa57f>apa31f: ','aap-153',0)
            LET g_apa.apa56 = '0'
         END IF
        #----------------------MOD-C70161-------------------(S)
         IF cl_null(g_apa.apa56) AND g_apa.apa33 <> 0 THEN
            LET g_apa.apa56 = '1'
         END IF
        #----------------------MOD-C70161-------------------(E)
 
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
   END INPUT
 
    CALL cl_set_act_visible("cancel", TRUE)  #MOD-490323
 
   CLOSE WINDOW t110_diff_w
 
   IF INT_FLAG THEN 
      LET INT_FLAG = 0
      LET g_apa.apa56 = 1
   END IF
 
   DISPLAY BY NAME g_apa.apa56,g_apa.apa53
   IF g_aza.aza63 ='Y' THEN
      DISPLAY BY NAME g_apa.apa531
   END IF
 
   CALL t110_apa56()
 
   BEGIN WORK              #MOD-A70153  

   CASE WHEN g_apa.apa56 = '1' #留置
             LET g_apa.apa19 = g_apz.apz12
             LET g_apa.apa20 = g_apa.apa34f
             DISPLAY BY NAME g_apa.apa19,g_apa.apa20
             DECLARE t110_apc_cs1 CURSOR FOR
             SELECT apc02,apc08-apc10 FROM apc_file WHERE apc01 =g_apa.apa01 ORDER BY apc02   #TQC-750129
 
 
             SELECT count(*) INTO g_cnt FROM apc_file    #MOD-7A0049
              WHERE apc01 = g_apa.apa01
             IF g_cnt >0 THEN
                LET l_apa20  =g_apa.apa20
                FOREACH t110_apc_cs1 INTO l_apc02,l_apc16
                    IF l_apc16 >=l_apa20 THEN
                       LET l_apc16 = l_apa20
                       LET l_apa20 = 0
                    ELSE
                       LET l_apa20 = l_apa20 - l_apc16
                       LET l_apc16 = l_apc16
                    END IF
                    UPDATE apc_file set apc16 =l_apc16
                     WHERE apc01 = g_apa.apa01
                       AND apc02 = l_apc02
                    IF l_apa20 =0 THEN
                       EXIT FOREACH
                    END IF
                END FOREACH
             END IF
             CALL t110_apa19('d')
        WHEN g_apa.apa56 = '2' #價差
             LET g_apa.apa33f= g_apa.apa31f- g_apa.apa57f
             CALL t110_apa34f('0')  #TQC-750140 add 參數0
             CALL t110_unpay()
             LET g_apa.apa19 = ''
             LET g_apa.apa20 = 0
             UPDATE apc_file set apc16 = g_apa.apa20 WHERE apc01 = g_apa.apa01         #MOD-A30084 add
             DISPLAY g_apa.apa19,g_apa.apa20,'' TO apa19,apa20,apo02
        WHEN g_apa.apa56 = '3' #折讓扣除帳款
             LET g_apa.apa33f= g_apa.apa31f- g_apa.apa57f
             LET g_apa.apa33 = g_apa.apa31 - g_apa.apa57
             CALL t110_j()
             CALL t110_apa34f('0')      #TQC-750140
             CALL t110_unpay()
             LET g_apa.apa19 = ''
             LET g_apa.apa20 = 0
             UPDATE apc_file set apc16 = g_apa.apa20 WHERE apc01 = g_apa.apa01         #MOD-A30084 add
             DISPLAY g_apa.apa19,g_apa.apa20,'' TO apa19,apa20,apo02
        WHEN g_apa.apa56 = '4' #單價分攤
             CALL t110_share()
             LET g_apa.apa33f= g_apa.apa31f- g_apa.apa57f
             LET g_apa.apa33 = g_apa.apa31 - g_apa.apa57
             CALL t110_apa34f('0')   #TQC-750140
             CALL t110_unpay()
             LET g_apa.apa19 = ''
             LET g_apa.apa20 = 0
             UPDATE apc_file set apc16 = g_apa.apa20 WHERE apc01 = g_apa.apa01         #MOD-A30084 add
             DISPLAY g_apa.apa19,g_apa.apa20,'' TO apa19,apa20,apo02
        WHEN g_apa.apa56 = '5' #處理暫估開帳
             LET g_apa.apa33 = 0
             LET g_apa.apa33f= 0
        WHEN g_apa.apa56 = '6'
             CALL  t110_share2()
             IF INT_FLAG THEN 
                LET INT_FLAG = 0
                LET g_apa.apa56 = 0
                RETURN 
             END IF 
             LET g_apa.apa33f= g_apa.apa31f- g_apa.apa57f
             LET g_apa.apa33 = g_apa.apa31 - g_apa.apa57
             CALL t110_apa34f('0')   
             CALL t110_unpay()
             LET g_apa.apa19 = ''
             LET g_apa.apa20 = 0
             UPDATE apc_file set apc16 = g_apa.apa20 WHERE apc01 = g_apa.apa01         #MOD-A30084 add
             DISPLAY g_apa.apa19,g_apa.apa20,'' TO apa19,apa20,apo02
   END CASE
   SELECT COUNT(*) INTO l_cnt FROM apb_file
    WHERE apb01=g_apa.apa01
   IF l_cnt = 0 THEN
      #IF g_aptype !='11' THEN   #MOD-890177 add
      IF g_aptype <> '11' AND g_aptype <> '21' THEN #FUN-BC0031 
         LET g_apa.apa57 = g_apa.apa31
         LET g_apa.apa57f = g_apa.apa31f
         DISPLAY BY NAME g_apa.apa57
      END IF                    #MOD-890177 add
   END IF
 
   IF g_apa.apa56 != '3' THEN
      UPDATE apb_file SET apb15 = 0,
                          apb13f = 0,
                          apb13 = 0,
                          apb14f = 0,
                          apb14 = 0
       WHERE apb01=g_apa.apa01
 
      LET g_apa.apa60f= 0
      LET g_apa.apa61f= 0
      LET g_apa.apa60 = 0
      LET g_apa.apa61 = 0
      DISPLAY BY NAME g_apa.apa60f,g_apa.apa60,g_apa.apa61f,g_apa.apa61
   ELSE
      IF g_apa.apa60 = g_apa.apa33 AND g_apa.apa20 = g_apa.apa60 THEN
         LET g_apa.apa19 = NULL
         LET g_apa.apa20 = 0
 
         UPDATE apa_file SET apa19 = g_apa.apa19,
                             apa20 = g_apa.apa20
          WHERE apa01=g_apa.apa01
 
         DISPLAY BY NAME g_apa.apa19,g_apa.apa20
         DISPLAY '' TO apo02
      END IF
   END IF

   COMMIT WORK             #MOD-A70153 
 
END FUNCTION
 
FUNCTION t110_share()
   DEFINE l_amt,l_amt2               LIKE type_file.num20_6     # No.FUN-690028  DEC(20,6)  #FUN-4B0079
   DEFINE l_amtf,l_amt2f,lamt,lamt1  LIKE type_file.num20_6     # No.FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_diffamt                   LIKE type_file.num20_6     #MOD-B70119
   DEFINE apb       RECORD LIKE apb_file.*
   DEFINE l_apb10          LIKE apb_file.apb10
   DEFINE l_apb24          LIKE apb_file.apb24
   DEFINE l_chkamt         LIKE apb_file.apb10     #MOD-B70119
   DEFINE l_apb02          LIKE apb_file.apb02
   DEFINE l_sql            STRING  #No.TQC-7B0083
   DEFINE sum_apb10        LIKE apb_file.apb10     #No.MOD-930072
   DEFINE sum_apb24        LIKE apb_file.apb24     #No.MOD-930072
   DEFINE l_cnt            LIKE apb_file.apb02     #MOD-B70119
   DEFINE l_diff           LIKE type_file.num5     #MOD-B70119
   DEFINE l_chkdiff        LIKE type_file.num5     #MOD-B70119
 
   LET l_apb02 = 0
   LET l_apb10 = 0
   DECLARE t110_share_c CURSOR FOR
    SELECT * FROM apb_file
     WHERE apb01=g_apa.apa01
       AND (apb34='N' OR apb34 IS NULL)
     ORDER BY apb02
 
   SELECT sum(apb10),sum(apb24) INTO sum_apb10,sum_apb24
     FROM apb_file
    WHERE apb01=g_apa.apa01
      AND (apb34='N' OR apb34 IS NULL)
 
   FOREACH t110_share_c INTO apb.*
      LET apb.apb10 = apb.apb10+(g_apa.apa31-g_apa.apa57)*apb.apb10/sum_apb10 #No.MOD-930072
      LET apb.apb10 = cl_digcut(apb.apb10,g_azi04)   #MOD-6B0066
      LET apb.apb24 = apb.apb24+(g_apa.apa31f-g_apa.apa57f)*apb.apb24/sum_apb24 #No.MOD-930072
      LET apb.apb24 = cl_digcut(apb.apb24,t_azi04)   #MOD-6B0066
      LET apb.apb08 = apb.apb10/apb.apb09
      LET apb.apb23 = apb.apb24/apb.apb09
      LET apb.apb08 = cl_digcut(apb.apb08,g_azi03)   #MOD-6B0066
      LET apb.apb23 = cl_digcut(apb.apb23,t_azi03)   #MOD-6B0066
 
      IF l_apb10 < apb.apb10 THEN
         LET l_apb02 = apb.apb02
         LET l_apb10 = apb.apb10
      END IF
 
      LET apb.apb081 = apb.apb08
      LET apb.apb101 = apb.apb10
 
      UPDATE apb_file SET apb08  = apb.apb08,
                          apb081 = apb.apb081,
                          apb10  = apb.apb10,
                          apb101 = apb.apb101,
                          apb23  = apb.apb23,
                          apb24  = apb.apb24
       WHERE apb01=apb.apb01 AND apb02=apb.apb02
 
   END FOREACH
 
   SELECT SUM(apb10),SUM(apb24) INTO l_amt,l_amtf FROM apb_file
    WHERE apb01 = g_apa.apa01 AND apb29='1'
 
   IF l_amt IS NULL THEN
      LET l_amt = 0
   END IF
 
   IF l_amtf IS NULL THEN
      LET l_amtf = 0
   END IF
 
   SELECT SUM(apb10),SUM(apb24) INTO l_amt2,l_amt2f FROM apb_file
    WHERE apb01 = g_apa.apa01 AND apb29='3'
 
   IF l_amt2 IS NULL THEN
      LET l_amt2 = 0
   END IF
 
   IF l_amt2f IS NULL THEN
      LET l_amt2f = 0
   END IF
 
   IF g_aptype MATCHES '1*' THEN
      LET g_apa.apa57f= l_amtf+ l_amt2f   #MOD-780281
      LET g_apa.apa57 = l_amt + l_amt2    #MOD-780281
   ELSE
      LET g_apa.apa57f= l_amt2f- l_amtf
      LET g_apa.apa57 = l_amt2 - l_amt
   END IF
 
   IF g_apa.apa57 IS NULL THEN
      LET g_apa.apa57=0
   END IF
 
   LET g_apa.apa57f=cl_digcut(g_apa.apa57f,t_azi04)   #MOD-6B0066
   LET g_apa.apa57=cl_digcut(g_apa.apa57,g_azi04)   #MOD-6B0066
 
   DISPLAY BY NAME g_apa.apa57
 
   UPDATE apa_file SET apa57=g_apa.apa57 WHERE apa01=g_apa.apa01
 
   IF g_apa.apa57 != g_apa.apa31 OR g_apa.apa57f != g_apa.apa31f THEN
      LET lamt = g_apa.apa57 - g_apa.apa31
      LET lamt1= g_apa.apa57f- g_apa.apa31f
      IF lamt != 0 THEN
         LET lamt = lamt * -1
 
      #-MOD-B70119-mark-
       #UPDATE apb_file SET apb10 = apb10+lamt,
       #                    apb101 = apb101+lamt
       # WHERE apb01=g_apa.apa01 AND apb02=l_apb02
      #-MOD-B70119-add-
        LET l_chkamt = 0
        CALL s_abs(lamt) RETURNING l_diffamt
        #抓取金額最大筆的項次
        SELECT MIN(apb02) INTO l_apb02
          FROM apb_file
         WHERE apb01 = g_apa.apa01
          #AND apb10 = (SELECT MAX(apb10) FROM apb_file WHERE apb01 = g_apa.apa01)                                       #MOD-D20112 mark
           AND apb10 = (SELECT MAX(apb10) FROM apb_file WHERE apb01 = g_apa.apa01 AND (apb34 = 'N' OR apb34 IS NULL))    #MOD-D20112 add
           AND (apb34 = 'N' OR apb34 IS NULL)                                                                            #MOD-D20112 add
        SELECT apb10 INTO l_chkamt
          FROM apb_file
         WHERE apb01 = g_apa.apa01 AND apb02 = l_apb02
        IF cl_null(l_chkamt) THEN LET l_chkamt = 0 END IF
        IF l_chkamt > l_diffamt THEN
       #調整至金額最大筆
           UPDATE apb_file SET apb10 = apb10+lamt,
                               apb101 = apb101+lamt
            WHERE apb01=g_apa.apa01 AND apb02=l_apb02
        END IF
        IF l_chkamt < l_diffamt THEN
          #逐筆分攤1至每筆單身
           LET l_cnt = 0
           LET l_chkdiff = 0
           IF lamt > 0 THEN LET l_diff = 1 END IF
           IF lamt < 0 THEN LET l_diff = -1 END IF
           DECLARE t110_share_c2 CURSOR FOR
            SELECT apb02 FROM apb_file
             WHERE apb01=g_apa.apa01
               AND (apb34='N' OR apb34 IS NULL)
             ORDER BY apb02
           FOREACH t110_share_c2 INTO apb.apb02
              LET l_cnt = l_cnt + 1
              IF l_diffamt < l_cnt THEN
                 IF lamt > 0 THEN LET l_diff = l_cnt - l_diffamt END IF
                 IF lamt < 0 THEN LET l_diff = l_diffamt - l_cnt END IF
              END IF
              UPDATE apb_file SET apb10 = apb10+l_diff,
                                  apb101 = apb101+l_diff
               WHERE apb01=g_apa.apa01 AND apb02=apb.apb02
              CALL s_abs(l_diff) RETURNING l_chkdiff
              IF l_cnt - l_diffamt = 0 OR l_chkdiff <> 1 THEN
                 EXIT FOREACH
              END IF
           END FOREACH
        END IF
       #-MOD-B70119-end-

         UPDATE apa_file SET apa57=g_apa.apa31 WHERE apa01=g_apa.apa01
 
         LET g_apa.apa57 = g_apa.apa31
      END IF
 
      IF lamt1 != 0 THEN
         LET lamt1 = lamt1 * -1

       #-MOD-B70119-mark-
        #UPDATE apb_file SET apb24=apb24+lamt1
        # WHERE apb01=g_apa.apa01 AND apb02=l_apb02
       #-MOD-B70119-add-
        LET l_chkamt = 0
        CALL s_abs(lamt1) RETURNING l_diffamt
        SELECT apb24 INTO l_chkamt
          FROM apb_file
         WHERE apb01 = g_apa.apa01 AND apb02 = l_apb02
        IF cl_null(l_chkamt) THEN LET l_chkamt = 0 END IF
        IF l_chkamt > l_diffamt THEN
       #調整至金額最大筆
           UPDATE apb_file SET apb24 = apb24+lamt1
            WHERE apb01=g_apa.apa01 AND apb02=l_apb02
        END IF
        IF l_chkamt < l_diffamt THEN
          #逐筆分攤1至每筆單身
           LET l_cnt = 0
           LET l_chkdiff = 0
           IF lamt1 > 0 THEN LET l_diff = 1 END IF
           IF lamt1 < 0 THEN LET l_diff = -1 END IF
           DECLARE t110_share_c3 CURSOR FOR
            SELECT apb02 FROM apb_file
             WHERE apb01=g_apa.apa01
               AND (apb34='N' OR apb34 IS NULL)
             ORDER BY apb02
           FOREACH t110_share_c3 INTO apb.apb02
              LET l_cnt = l_cnt + 1
              IF l_diffamt < l_cnt THEN
                 IF lamt > 0 THEN LET l_diff = l_cnt - l_diffamt END IF
                 IF lamt < 0 THEN LET l_diff = l_diffamt - l_cnt END IF
              END IF
              UPDATE apb_file SET apb24 = apb24+l_diff
               WHERE apb01=g_apa.apa01 AND apb02=apb.apb02
              CALL s_abs(l_diff) RETURNING l_chkdiff
              IF l_cnt - l_diffamt = 0 OR l_chkdiff <> 1 THEN
                 EXIT FOREACH
              END IF
           END FOREACH
        END IF
       #-MOD-B70119-end-

         UPDATE apa_file SET apa57f=g_apa.apa31f WHERE apa01=g_apa.apa01
 
         LET g_apa.apa57f=g_apa.apa31f
      END IF
   END IF
 
   DISPLAY BY NAME g_apa.apa57
 
   IF g_apb_sarrno > 0 THEN
      CALL t110_b_fill(' 1=1')
   END IF
 
END FUNCTION
 
FUNCTION t110_apb21()
   DEFINE l_cnt LIKE type_file.num5    #No.FUN-690028 SMALLINT
 
   LET l_cnt=0
   LET g_errno=''
 
   SELECT COUNT(*) INTO l_cnt  FROM azf_file
    WHERE azf01=g_apb[l_ac].apb31 AND azf02='2' AND azfacti='Y'
 
   CASE
      WHEN l_cnt=0
         LET g_errno = 'aap-301'
      WHEN SQLCA.SQLCODE != 0
         LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE
END FUNCTION
 
FUNCTION t110_apb31()
   DEFINE l_cnt LIKE type_file.num5    #No.FUN-690028 SMALLINT
   DEFINE l_azf09   LIKE azf_file.azf09   #FUN-920186
   DEFINE l_sql     STRING                #FUN-9A0093 
   DEFINE l_azf141  LIKE azf_file.azf141  #FUN-B80058

   LET l_cnt=0
   LET g_errno=''
 
   LET g_plant_new = g_apb[l_ac].apb37
   CALL s_gettrandbs() 
   LET li_dbs = g_dbs_tra
#CHI-AA0028 mark --start--
#  IF cl_null(g_apb[l_ac].apb31) THEN
#    IF g_apy.apydmy5 = 'Y' THEN
#      LET g_errno = 'apj-201'
#      RETURN
#    END IF
#  END IF
#CHI-AA0028 mark --end--
  IF NOT cl_null(g_apb[l_ac].apb31) THEN
     #LET l_sql = "SELECT azf09 FROM ",li_dbs CLIPPED,"azf_file ",
     LET l_sql = "SELECT azf09 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'azf_file'), #FUN-A50102
                 " WHERE azf01='",g_apb[l_ac].apb31,"' ",
                 "   AND azf02='2' AND azfacti='Y' "
     CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
     CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102               
     PREPARE azf_pre FROM l_sql
     DECLARE azf_cs CURSOR FOR azf_pre
     OPEN azf_cs
     FETCH azf_cs INTO l_azf09
     IF l_azf09 != '7' THEN
        LET g_errno = 'aoo-406'
        RETURN
     END IF
  END IF
 
  IF cl_null(g_apb[l_ac].apb31) THEN RETURN END IF  #No.MOD-840611
   #LET l_sql = "SELECT COUNT(*) FROM ",li_dbs CLIPPED," azf_file ",
   LET l_sql = "SELECT COUNT(*) FROM ",cl_get_target_table(g_apb[l_ac].apb37,'azf_file'), #FUN-A50102
               " WHERE azf01='",g_apb[l_ac].apb31,"' ",
               "   AND azf02='2' AND azfacti='Y' "
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
   CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
   PREPARE azf_cou_pre FROM l_sql
   DECLARE azf_cou_cs CURSOR FOR azf_cou_pre
   OPEN azf_cou_cs
   FETCH azf_cou_cs INTO l_cnt
 
   CASE
      WHEN l_cnt=0
         IF g_aza.aza08 = 'Y' THEN
            LET g_errno = 'aap-301'
         ELSE
            LET g_errno = 'mfg5108'
         END IF
      WHEN SQLCA.SQLCODE != 0
         LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE
 
  IF cl_null(g_errno) THEN
     IF cl_null(g_apb[l_ac].apb25) THEN
        LET l_azf141 = ''    #FUN-B80058
        #LET l_sql = "SELECT azf14 FROM ",li_dbs CLIPPED," azf_file ",
        #LET l_sql = "SELECT azf14 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'azf_file'), #FUN-A50102
        LET l_sql = "SELECT azf14,azf141 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'azf_file'), #FUN-B80058
                    " WHERE azf01='",g_apb[l_ac].apb31,"' ",
                    "   AND azf02='2' AND azfacti='Y' "
        CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
        CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
        PREPARE azf14_pre FROM l_sql
        DECLARE azf14_cs CURSOR FOR azf14_pre
        OPEN azf14_cs
        #FETCH azf14_cs INTO g_apb[l_ac].apb25
        FETCH azf14_cs INTO g_apb[l_ac].apb25,l_azf141   #FUN-B80058
     END IF
     IF g_aza.aza63='Y' AND cl_null(g_apb[l_ac].apb251) THEN
        #LET g_apb[l_ac].apb251 = g_apb[l_ac].apb25
        LET g_apb[l_ac].apb251 = l_azf141          #FUN-B80058
     END IF
     DISPLAY BY NAME g_apb[l_ac].apb25,g_apb[l_ac].apb251
  END IF
 
END FUNCTION
 
FUNCTION t110_apb22_11(p_cmd)
   DEFINE p_cmd           LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_rvv03         LIKE rvv_file.rvv03
   DEFINE l_rvv04         LIKE rvv_file.rvv04
   DEFINE l_rvv05         LIKE rvv_file.rvv05
   DEFINE l_rvv09         LIKE type_file.dat         # No.FUN-690028 DATE
   DEFINE l_vendor        LIKE rvv_file.rvv06   #FUN-660117
   DEFINE l_rvv36         LIKE rvv_file.rvv36
   DEFINE l_rvv37         LIKE rvv_file.rvv37
   DEFINE l_rvv23         LIKE rvv_file.rvv23
   DEFINE l_rvv25         LIKE rvv_file.rvv25
   DEFINE l_rvv17         LIKE rvv_file.rvv17   #FUN-560070
   DEFINE l_rvv87         LIKE rvv_file.rvv87   #FUN-560070
   DEFINE l_pmm02         LIKE pmm_file.pmm02
   DEFINE l_pmn122        LIKE pmn_file.pmn122
   DEFINE l_pmm20         LIKE pmm_file.pmm20
   DEFINE l_pmm21         LIKE pmm_file.pmm21
   DEFINE l_pmm22         LIKE pmm_file.pmm22
   DEFINE l_pmn041        LIKE pmn_file.pmn041
   DEFINE l_pmn07         LIKE pmn_file.pmn07
   DEFINE l_pmn86         LIKE pmn_file.pmn86     #FUN-560070
   DEFINE l_pmn40         LIKE pmn_file.pmn40
   DEFINE l_pmn67         LIKE pmn_file.pmn67
   DEFINE l_rvv31         LIKE rvv_file.rvv31    #NO.MOD-490217
   DEFINE l_rvv38         LIKE rvv_file.rvv38
   DEFINE l_rvv38t        LIKE rvv_file.rvv38t   #TQC-8A0079 add
   DEFINE l_rvv930        LIKE rvv_file.rvv930   #FUN-670064
   DEFINE l_aag02         LIKE aag_file.aag02    #No.TQC-770056
   DEFINE l_gem02         LIKE gem_file.gem02    #No.TQC-770056
   DEFINE l_rvv88         LIKE rvv_file.rvv88    #No.TQC-7B0083
   DEFINE l_gec04         LIKE gec_file.gec04    #TQC-8A0079 add
   DEFINE l_gec05         LIKE gec_file.gec05    #MOD-A80052
   DEFINE l_gec07         LIKE gec_file.gec07    #TQC-8A0079 add
   DEFINE t_gec04         LIKE gec_file.gec04    #MOD-8C0020 add 
   DEFINE l_apb24t        LIKE apb_file.apb24    #MOD-920013 add  
   DEFINE l_apa32f        LIKE apa_file.apa32f   #MOD-A80052   
   DEFINE l_cnt           LIKE type_file.num5    #MOD-950158 
   DEFINE l_pmk13         LIKE pmk_file.pmk13    #FUN-930165 add 
   DEFINE l_rvvplant      LIKE rvv_file.rvvplant #FUN-960141 add 
   DEFINE l_rvu27         LIKE rvu_file.rvu27    #FUN-BB0001 add
   DEFINE l_apb09         LIKE apb_file.apb09    #MOD-C50241 add
          
   LET g_errno = ' '
 
  #aapt160單身"入庫單號"(apb21),"入庫項次"(apb22)可不輸入
   IF g_aptype='16' AND 
      cl_null(g_apb[l_ac].apb21) AND cl_null(g_apb[l_ac].apb22) THEN 
      RETURN 
   END IF
 
   LET l_cnt = 0                                                                                                         
   LET g_chr_1 = 'Y'
   SELECT COUNT(*) INTO l_cnt FROM apb_file,apa_file                                                                     
    WHERE apb21 = g_apb[l_ac].apb21                                                                                            
      AND apb22 = g_apb[l_ac].apb22                                                                                            
      AND apa01 = apb01                                                                                                  
      AND (apa00 = '16' OR apa00 = '26')
      AND apa41 !='Y'                                                                                
      AND apa42 = 'N'                                                                
   IF l_cnt > 0 THEN                                                                                                     
      LET g_chr_1 = 'N'
      CALL s_errmsg('','','','aap-118',1)                                                                
      RETURN                                                                                   
   END IF                                                                                        
 
   #若入庫單對應的收貨單已有發票不可再產生暫估單
   IF g_aptype='16' THEN
      LET l_cnt = 0
      IF g_aza.aza26 = '2' THEN
         #LET l_sql = "SELECT COUNT(*) FROM ",li_dbs CLIPPED," rvw_file ",
         LET l_sql = "SELECT COUNT(*) FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvw_file'), #FUN-A50102
                     " WHERE rvw08 = '",g_apb[l_ac].apb21,"' ",
                     "   AND rvw09 = '",g_apb[l_ac].apb22,"' "
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
         PREPARE rvw_cou_pre FROM l_sql
         DECLARE rvw_cou_cs CURSOR FOR rvw_cou_pre
         OPEN  rvw_cou_cs
         FETCH rvw_cou_cs INTO l_cnt
      ELSE
        #LET l_sql = "SELECT COUNT(*) FROM ",li_dbs CLIPPED," rvv_file ,",
        #             li_dbs CLIPPED," rvb_file ",
      #FUN-BB0001 add START
        SELECT rvu27 INTO l_rvu27 FROM rvu_file WHERE rvu01 = g_apb[l_ac].apb21
        IF cl_null(l_rvu27) THEN
           LET l_rvu27 = '1'
        END IF
        IF l_rvu27 = '2' OR l_rvu27 = '3' OR l_rvu27 = '4' THEN
           LET l_sql = "SELECT COUNT(*) FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'),",", #FUN-A50102
                       " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
                       "  AND rvv02 = '",g_apb[l_ac].apb22,"' ",
                       "  AND rvv22 IS NOT NULL AND rvv22 != ' ' "
        ELSE
      #FUN-BB0001 add END
           LET l_sql = "SELECT COUNT(*) FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'),",", #FUN-A50102
                                               cl_get_target_table(g_apb[l_ac].apb37,'rvb_file'),     #FUN-A50102
                       " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
                       "  AND rvv02 = '",g_apb[l_ac].apb22,"' ",
                       "  AND rvv04 = rvb01 AND rvv05 = rvb02 ",
                       "  AND rvb22 IS NOT NULL AND rvb22 != ' ' "
        END IF         #FUN-BB0001 add
        CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
        PREPARE rvv_cou_pre FROM l_sql
        DECLARE rvv_cou_cs CURSOR FOR rvv_cou_pre
        OPEN rvv_cou_cs
        FETCH rvv_cou_cs INTO l_cnt
      END IF
      IF l_cnt > 0 THEN
         CALL s_errmsg('','','','aap-152',1)
         LET g_errno = 'aap-152'
         RETURN
      END IF
   END IF
 
   LET l_sql = "SELECT rvv03,rvv04,rvv05,rvv09,rvv06,rvv36,rvv37,rvv23,",
               "       rvv87,rvv38,rvv38t,rvv31,",
               "       rvv25,rvv930,rvv88,rvvplant ",
               #"  FROM ",li_dbs CLIPPED,"rvv_file ,",li_dbs CLIPPED,"rvu_file ",
               "  FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'),",", #FUN-A50102
                         cl_get_target_table(g_apb[l_ac].apb37,'rvu_file'),     #FUN-A50102
               " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
               "   AND rvv02 = '",g_apb[l_ac].apb22,"' ",
               "   AND rvu01 = rvv01 AND rvuconf = 'Y' ",
               "   AND rvv89 <> 'Y'"
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
   CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
   PREPARE rvv_sel_pre FROM l_sql
   DECLARE rvv_sel_cs CURSOR FOR rvv_sel_pre
   OPEN rvv_sel_cs
   FETCH rvv_sel_cs INTO  l_rvv03,l_rvv04,l_rvv05,l_rvv09,l_vendor,l_rvv36,l_rvv37,l_rvv23,
                          l_rvv87,l_rvv38,l_rvv38t,
                          l_rvv31,l_rvv25,l_rvv930,l_rvv88,l_rvvplant 
   CASE WHEN SQLCA.SQLCODE = 100  LET g_errno = 'aap-091'
        WHEN l_vendor != g_apa.apa05 LET g_errno = 'aap-040'
        WHEN YEAR(l_rvv09)  != YEAR(g_apa.apa02)  OR
             (YEAR(l_rvv09)   = YEAR(g_apa.apa02)  AND
             MONTH(l_rvv09) != MONTH(g_apa.apa02) )
             LET g_errno = 'aap-316'
        WHEN l_rvv09  > g_apa.apa02 LET g_errno = 'aap-317'
        OTHERWISE          LET g_errno = SQLCA.SQLCODE USING '-------'
   END CASE
  #------------------------------------MOD-C10083---------------------------start
  #衝暫估可以跨月
   IF g_errno = 'aap-316' THEN
      IF t110_set_rvv34(g_apb[l_ac].apb21,g_apb[l_ac].apb22) = 'Y' THEN
         LET g_errno = ''
      END IF
   END IF
  #------------------------------------MOD-C10083-----------------------------end
   IF NOT cl_null(g_errno) THEN RETURN END IF   #MOD-B80277 add
   IF NOT cl_null(l_rvv36) AND NOT cl_null(l_rvv37) THEN
        LET l_sql = "SELECT pmm20,pmm21,pmm22,pmm02,pmn041,pmn86,pmn40,pmn122,pmn67 ",
                    #"  FROM ",li_dbs CLIPPED,"pmm_file,",li_dbs CLIPPED,"pmn_file ",
                    "  FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmm_file'),",", #FUN-A50102
                              cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'),     #FUN-A50102
                    " WHERE pmn01 = '",l_rvv36,"' ",
                    "   AND pmn02 = '",l_rvv37,"' ",
                    "   AND pmm01 = pmn01 AND (pmm25 = '2' OR pmm25 = '6')"
        CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
       CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102               
        PREPARE pmm_sel_pre FROM l_sql
        DECLARE pmm_sel_cs CURSOR FOR pmm_sel_pre
        OPEN pmm_sel_cs
        FETCH pmm_sel_cs INTO l_pmm20,l_pmm21,l_pmm22,l_pmm02,l_pmn041,l_pmn86,l_pmn40,
                              l_pmn122,l_pmn67
   ELSE
      IF NOT cl_null(l_rvv04) AND NOT cl_null(l_rvv05) THEN
         LET l_sql = "SELECT rva111,rva115,rva113,rva10,rvb051,rvb86,'','' ",
                     #"  FROM ",li_dbs CLIPPED,"rva_file,",li_dbs CLIPPED,"rvb_file ",
                     "  FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rva_file'),",", #FUN-A50102
                               cl_get_target_table(g_apb[l_ac].apb37,'rvb_file'),     #FUN-A50102
                     " WHERE rvb01 = '",l_rvv04,"' ",
                     "   AND rvb02 = '",l_rvv05,"' ",
                     "   AND rva01 = rvb01"
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
         PREPARE rva_sel_pre FROM l_sql
         DECLARE rva_sel_cs CURSOR FOR rva_sel_pre
         OPEN rva_sel_cs
         FETCH rva_sel_cs INTO l_pmm20,l_pmm21,l_pmm22,l_pmm02,l_pmn041,l_pmn86,l_pmn122,l_pmn67
         
         #LET l_sql = "SELECT ima39 FROM ",li_dbs CLIPPED,"ima_file ",
         LET l_sql = "SELECT ima39 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'ima_file'), #FUN-A50102
                     " WHERE ima01 = '",l_rvv31,"' "
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
         PREPARE sel_ima39_pre1 FROM l_sql
         EXECUTE sel_ima39_pre1 INTO  l_pmn40

      ELSE
      LET l_pmm20 = g_apa.apa11
      LET l_pmm21 = g_apa.apa15
      LET l_pmm22 = g_apa.apa13
      LET l_pmm02 = NULL
      LET l_pmn122 = NULL
      LET l_pmn67 = NULL
      #LET l_sql = "SELECT ima02,ima39 FROM ",li_dbs CLIPPED,"ima_file ",
      LET l_sql = "SELECT ima02,ima39 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'ima_file'), #FUN-A50102
                  " WHERE ima01 = '",l_rvv31,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
      CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
      PREPARE sel_ima02_pre2 FROM l_sql
      DECLARE sel_ima02_cs2 CURSOR FOR sel_ima02_pre2
      OPEN sel_ima02_cs2
      FETCH sel_ima02_cs2 INTO l_pmn041,l_pmn40
      #LET l_sql = "SELECT rvv86 FROM ",li_dbs CLIPPED,"rvv_file ",
      LET l_sql = "SELECT rvv86 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'), #FUN-A50102
                  " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
                  "   AND rvv02 = '",g_apb[l_ac].apb22,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
      CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
      PREPARE sel_rvv86_pre FROM l_sql
      DECLARE sel_rvv86_cs CURSOR FOR sel_rvv86_pre
      OPEN sel_rvv86_cs
      FETCH sel_rvv86_cs INTO l_pmn86
      END IF                 #No.FUN-940083 add
   END IF
 
   IF l_pmn122 !=g_apa.apa66 THEN
      LET g_errno='aap-300'
      RETURN
   END IF
 
   IF l_rvv03 = '2' THEN
      LET g_errno='aap-093'
      RETURN
   END IF
 
   IF l_rvv03 = '3' THEN
      CALL t110_apb22_21(p_cmd)
      RETURN
   END IF
 
   IF g_qty1 IS NULL THEN
      LET g_qty1 = 0
   END IF
 
   IF l_rvv38 IS NULL THEN
      LET l_rvv38 = 0
   END IF
 
   IF l_rvv38t IS NULL THEN
      LET l_rvv38t = 0
   END IF
 
   IF l_rvv23 IS NULL THEN
      LET l_rvv23 = 0
   END IF
   IF l_rvv87 IS NULL THEN
      LET l_rvv87 = 0
   END IF
   IF l_rvv88 IS NULL THEN
      LET l_rvv88 = 0 
   END IF
   IF l_rvv03 = '3' AND l_rvv17 = 0 THEN   #No.MOD-910062
   ELSE
      IF l_rvv87-l_rvv23 <=0 THEN          #MOD-920252
         LET g_errno='aap-782'
         RETURN
      END IF
   END IF
  #------------------------------------MOD-C10083---------------mark--移至13661行
  ##衝暫估可以跨月
  #IF g_errno = 'aap-316' THEN
  #   IF t110_set_rvv34(g_apb[l_ac].apb21,g_apb[l_ac].apb22) = 'Y' THEN
  #      LET g_errno = ''
  #   END IF
  #END IF
  #------------------------------------MOD-C10083---------------mark--移至13661行
   #重要信息:衝暫估前,一定要check部分請款,部分暫估現象時,請款已經做過了
   IF g_aptype='11' THEN
      IF l_rvv87 - l_rvv23 > 0 THEN                #部分請款或有做過暫估
         IF l_rvv88 > 0 THEN                       #有暫估資料沒有衝
            IF l_rvv87 - l_rvv23 <> l_rvv88 THEN   #部分請款
               LET g_errno = 'aap-817'
            END IF
         END IF
      END IF
   END IF
 
  #表示此入庫單+項次已有立過暫估,不可再輸入
   IF g_aptype = '16' AND l_rvv87-l_rvv88 <= 0 THEN
      LET g_errno = 'aap-813'
   END IF
 
   IF NOT cl_null(g_errno) THEN
      RETURN
   END IF
 
   IF g_apa.apa11 IS NULL THEN
      LET g_apa.apa11 = l_pmm20
   END IF
 
   IF g_apa.apa13 IS NULL THEN
      LET g_apa.apa13 = l_pmm22
   END IF
 
   IF g_apa.apa15 IS NULL THEN
      LET g_apa.apa15 = l_pmm21
   END IF
 
   IF l_pmm20 != g_apa.apa11 THEN                              # 付款條件不符
      CALL cl_getmsg('aap-042',g_lang) RETURNING g_msg
      LET g_buf1=g_msg[1,8],':',l_pmm20 ERROR g_buf1    #FUN-C80078 g_buf-->g_buf1
      WHILE TRUE
            LET INT_FLAG = 0  ######add for prompt bug
         PROMPT g_msg CLIPPED FOR g_chr
            ON IDLE g_idle_seconds  #TQC-860021
               CALL cl_on_idle()    #TQC-860021
 
            ON ACTION about         #TQC-860021
               CALL cl_about()      #TQC-860021
 
            ON ACTION help          #TQC-860021
               CALL cl_show_help()  #TQC-860021
 
            ON ACTION controlg      #TQC-860021
               CALL cl_cmdask()     #TQC-860021
         END PROMPT                 #TQC-860021
 
         CASE
            WHEN g_chr = '1'
               LET g_errno = 'aap-042'
               RETURN
            WHEN g_chr = '2'
               LET g_apa.apa11 = l_pmm20
               DISPLAY BY NAME g_apa.apa11
               UPDATE apa_file SET apa11 = g_apa.apa11
                WHERE apa01 = g_apa.apa01
         END CASE
 
         IF g_chr MATCHES "[123]" THEN
            EXIT WHILE
         END IF
      END WHILE
   END IF
 
   IF l_pmm22 != g_apa.apa13 THEN                              # 幣別不符
      LET g_errno = 'aap-041'
      CALL cl_err(l_pmm22,'aap-041',0)
      IF NOT cl_null(g_errno) THEN #MOD-9A0143                                                                                      
         RETURN                    #MOD-9A0143                                                                                      
      END IF                       #MOD-9A0143  
   END IF
   LET t_gec04 = 0                                                                                                                  
   IF g_aptype = '16' OR g_aptype = '26' THEN                                                                                       
     #LET l_sql = "SELECT gec04 FROM ",li_dbs CLIPPED,"gec_file ",
      LET l_sql = "SELECT gec04 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'), #FUN-A50102
                  " WHERE gec01 = '",g_apa.apa15,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
      CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
      PREPARE sel_gec04_cs10 FROM l_sql
      EXECUTE sel_gec04_cs10 INTO t_gec04
      IF t_gec04 <> 0 THEN                                                                                                          
         LET g_errno='aap-887'                                                                                                      
      END IF                                                                                                                        
   ELSE                                                                                                                             
   IF l_pmm21 != g_apa.apa15 THEN                              # 稅別不符
      CALL cl_getmsg('aap-043',g_lang) RETURNING g_msg
      LET g_buf1=g_msg[1,4],':',l_pmm22 ERROR g_buf1   #FUN-C80078 g_buf-->g_buf1
      WHILE TRUE
            LET INT_FLAG = 0  ######add for prompt bug
         PROMPT g_msg CLIPPED FOR g_chr
            ON IDLE g_idle_seconds
               CALL cl_on_idle()
 
            ON ACTION about         #MOD-4C0121
               CALL cl_about()      #MOD-4C0121
 
            ON ACTION help          #MOD-4C0121
               CALL cl_show_help()  #MOD-4C0121
 
            ON ACTION controlg      #MOD-4C0121
               CALL cl_cmdask()     #MOD-4C0121
         END PROMPT
 
         CASE
            WHEN g_chr = '1'
               LET g_errno = 'aap-043'
               RETURN
            WHEN g_chr = '2'
               LET g_apa.apa15 = l_pmm21
               DISPLAY BY NAME g_apa.apa15
               CALL t110_apa15('a')
               UPDATE apa_file SET apa15 = g_apa.apa15
                WHERE apa01 = g_apa.apa01
         END CASE
 
         IF g_chr MATCHES "[123]" THEN
            EXIT WHILE
         END IF
      END WHILE
     END IF  #MOD-8C0020
   END IF
 
   LET g_apb04 = l_rvv04
   LET g_apb05 = l_rvv05
   LET g_apb[l_ac].apb06 = l_rvv36
   LET g_apb[l_ac].apb07 = l_rvv37
   LET g_apb[l_ac].apb12 = l_rvv31
   LET g_apb[l_ac].apb25 = l_pmn40
   LET g_apb[l_ac].apb34 = t110_set_rvv34(g_apb[l_ac].apb21,g_apb[l_ac].apb22)   #MOD-850302 add
   DISPLAY BY NAME g_apb[l_ac].apb06
   DISPLAY BY NAME g_apb[l_ac].apb07
   DISPLAY BY NAME g_apb[l_ac].apb12
   DISPLAY BY NAME g_apb[l_ac].apb25
   DISPLAY BY NAME g_apb[l_ac].apb34   #MOD-850302 add
   IF NOT cl_null(l_pmn40) THEN
      #LET l_sql = "SELECT aag02 FROM ",li_dbs CLIPPED,"aag_file ",
      LET l_sql = "SELECT aag02 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'aag_file'), #FUN-A50102
                  " WHERE aag01='",l_pmn40,"' ",
                  "   AND aag00='",g_bookno1,"' ",
                  "   AND aagacti = 'Y'"                        #No.MOD-B70280 add
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
      CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
      PREPARE sel_aag02_cs1 FROM l_sql
      EXECUTE sel_aag02_cs1 INTO g_apb[l_ac].b25
      IF SQLCA.sqlcode THEN
         LET g_apb[l_ac].b25 = NULL 
      END IF
      DISPLAY BY NAME g_apb[l_ac].b25
   END IF 
      
 
    IF g_apb[l_ac].apb12[1,4]='MISC' THEN    #MOD-950177
       IF NOT cl_null(l_rvv36) AND NOT cl_null(l_rvv37) THEN #No.FUN-940083 add
       #LET l_sql = "SELECT pmk13 FROM ",li_dbs CLIPPED,"pmk_file ",
       #            " WHERE pmk01 IN (SELECT pmn24 FROM ",li_dbs CLIPPED,"pmn_file ",
       LET l_sql = "SELECT pmk13 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmk_file'), #FUN-A50102
                   " WHERE pmk01 IN (SELECT pmn24 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'), #FUN-A50102
                   "                  WHERE pmn01='",l_rvv36,"' ",
                   "                    AND pmn02='",l_rvv37,"')"
       CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
       CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102                
       PREPARE sel_pmk13 FROM l_sql
       EXECUTE sel_pmk13 INTO l_pmk13
       IF NOT cl_null(l_pmk13) THEN 
          LET l_pmn67=l_pmk13 
       END IF
       END IF                                                #No.FUN-940083 add
    END IF 
   #IF g_apy.apydmy5='Y' AND g_apa.apa00[1,1]='1' THEN  #MOD-C80183 mark
   IF g_apa.apa00[1,1]='1' THEN            #MOD-C80183
      IF NOT cl_null(l_pmn67) THEN         #MOD-C80183
         LET g_apb[l_ac].apb26 = l_pmn67
      ELSE
         LET g_apb[l_ac].apb26 = g_apa.apa22
         DISPLAY BY NAME g_apb[l_ac].apb26
      END IF
   END IF                                  #MOD-C80183
 
   IF NOT cl_null(g_apb[l_ac].apb26) THEN
      #LET l_sql = "SELECT gem02 FROM ",li_dbs CLIPPED,"gem_file ",
      LET l_sql = "SELECT gem02 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gem_file'), #FUN-A50102
                  " WHERE gem01 = '",g_apb[l_ac].apb26,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
       CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
      PREPARE sel_gem02_pre FROM l_sql
      DECLARE sel_gem02_cs CURSOR FOR sel_gem02_pre
      OPEN sel_gem02_cs
      FETCH sel_gem02_cs INTO g_apb[l_ac].b26
      IF SQLCA.sqlcode THEN
         #LET g_apb[l_ac].apb26 = NULL #MOD-BC0218
         LET g_apb[l_ac].apb26 = ''    #MOD-BC0218
      END IF 
      DISPLAY BY NAME g_apb[l_ac].b26 
   END IF
 
   LET g_apb[l_ac].apb27 = l_pmn041
   LET g_apb[l_ac].apb28 = l_pmn86   #FUN-560070
   LET g_apb[l_ac].apb29 = l_rvv03
   DISPLAY BY NAME g_apb[l_ac].apb27
   DISPLAY BY NAME g_apb[l_ac].apb28
   DISPLAY BY NAME g_apb[l_ac].apb29
 
   IF l_rvv25='Y' THEN             #樣品單價為0
      LET g_apb[l_ac].apb23 = 0
      LET l_rvv38t = 0    #TQC-8A0079 add
   ELSE
      LET g_apb[l_ac].apb23 = l_rvv38
      DISPLAY BY NAME g_apb[l_ac].apb23
   END IF
 
   LET g_apb[l_ac].apb08 = g_apb[l_ac].apb23 * g_apa.apa14
   LET g_apb[l_ac].apb08 = cl_digcut(g_apb[l_ac].apb08,g_azi03)    #No.MOD-510045   #MOD-6B0066
   DISPLAY BY NAME g_apb[l_ac].apb08
 
   IF g_apb[l_ac].apb09 = 0 THEN
      LET g_apb[l_ac].apb09 = l_rvv87 - l_rvv23   #FUN-560070
      LET g_apb[l_ac].apb09 = s_digqty(g_apb[l_ac].apb09,g_apb[l_ac].apb28)   #FUN-910088--add--
      DISPLAY BY NAME g_apb[l_ac].apb09
   END IF
 
   #單價含稅時,不使用單價*數量=金額,改以含稅金額回推稅率,以避免小數位差的問題
   LET l_gec04 = 0   LET l_gec07 = ''
   IF g_apb[l_ac].apb06 <> '' OR NOT cl_null(g_apb[l_ac].apb06) THEN  #TQC-8C0031 add
     #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file,",
     #             li_dbs CLIPPED,"pmm_file ",
     #LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102           #MOD-A80052 mark
      LET l_sql = "SELECT gec04,gec05,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102     #MOD-A80052 
                                             cl_get_target_table(g_apb[l_ac].apb37,'pmm_file'),     #FUN-A50102
                  " WHERE gec01 = pmm21 AND pmm01='",g_apb[l_ac].apb06,"' " 
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
      CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102                
      PREPARE sel_gec04_pre1 FROM l_sql
      DECLARE sel_gec04_cs1 CURSOR FOR sel_gec04_pre1
      OPEN sel_gec04_cs1
     #FETCH sel_gec04_cs1 INTO l_gec04,l_gec07                  #MOD-A80052 mark
      FETCH sel_gec04_cs1 INTO l_gec04,l_gec05,l_gec07          #MOD-A80052
   ELSE
      IF NOT cl_null(g_apb04) THEN
        #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file,",
        #             li_dbs CLIPPED,"rva_file",
        #LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102           #MOD-A80052 mark
         LET l_sql = "SELECT gec04,gec05,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102     #MOD-A80052
                                                cl_get_target_table(g_apb[l_ac].apb37,'rva_file'),     #FUN-A50102
                     " WHERE gec01 = rva115 AND rva01=g_apb04 ",
                     "   AND gec011 = '1'"
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
         PREPARE sel_gec04_pre2 FROM l_sql
         DECLARE sel_gec04_cs2 CURSOR FOR sel_gec04_pre2
         OPEN sel_gec04_cs2
        #FETCH sel_gec04_cs2 INTO l_gec04,l_gec07                  #MOD-A80052 mark
         FETCH sel_gec04_cs2 INTO l_gec04,l_gec05,l_gec07          #MOD-A80052
      ELSE
         IF (g_apa.apa00 = '21' OR g_apa.apa00 = '26') AND
            NOT cl_null(g_apb[l_ac].apb21) THEN
           #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file,",
           #             li_dbs CLIPPED,"rvu_file ",
           #LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102           #MOD-A80052 mark
            LET l_sql = "SELECT gec04,gec05,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102     #MOD-A80052
                                                   cl_get_target_table(g_apb[l_ac].apb37,'rvu_file'),     #FUN-A50102
                        " WHERE gec01 = rvu115 AND rvu01='",g_apb[l_ac].apb21,"' ",
                        "   AND gec011 = '1'"
            CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
            CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
            PREPARE sel_gec04_pre3 FROM l_sql
            DECLARE sel_gec04_cs3 CURSOR FOR sel_gec04_pre3
            OPEN sel_gec04_cs3
           #FETCH sel_gec04_cs3 INTO l_gec04,l_gec07                  #MOD-A80052 mark
            FETCH sel_gec04_cs3 INTO l_gec04,l_gec05,l_gec07          #MOD-A80052
         ELSE
           #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file ",
           #LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'), #FUN-A50102           #MOD-A80052 mark
            LET l_sql = "SELECT gec04,gec05,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'), #FUN-A50102     #MOD-A80052
                        " WHERE gec01 = '",g_apa.apa15,"' ",
                        "   AND gec011 = '1'"
            CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
            CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
            PREPARE sel_gec04_pre4 FROM l_sql
           #EXECUTE sel_gec04_pre4 INTO l_gec04,l_gec07               #MOD-A80052 mark
            EXECUTE sel_gec04_pre4 INTO l_gec04,l_gec05,l_gec07       #MOD-A80052
         END IF
      END IF
   END IF
   IF cl_null(l_gec04) THEN LET l_gec04=0   END IF
   IF cl_null(l_gec07) THEN LET l_gec07='N' END IF
  #-MOD-A80093-add-
  #IF g_aza.aza26 = '2' THEN                     #MOD-B30578 mark
   IF g_aza.aza26 = '2' AND g_aptype='11' THEN   #MOD-B30578
      LET l_sql = "SELECT SUM(rvw05f),SUM(rvw05) FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvw_file'), 
                  " WHERE rvw08 = '",g_apb[l_ac].apb21,"' ",
                  "   AND rvw09 = '",g_apb[l_ac].apb22,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql 
      CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql 
      PREPARE rvw_rvw05_pre FROM l_sql
      DECLARE rvw_rvw05_cs CURSOR FOR rvw_rvw05_pre 
      OPEN  rvw_rvw05_cs
      FETCH rvw_rvw05_cs INTO g_apb[l_ac].apb24,g_apb[l_ac].apb10 
   ELSE
      IF l_gec07='Y' THEN        #含稅單價*數量=含稅金額     
         LET l_apb24t= l_rvv38t*g_apb[l_ac].apb09
         LET l_apb24t= cl_digcut(l_apb24t,t_azi04) 
        #-MOD-A80052-add-
         IF l_gec05 = 'T' THEN
            LET l_apa32f = l_apb24t * (l_gec04/100)
            LET l_apa32f = cl_digcut(l_apa32f , t_azi04)
            LET g_apb[l_ac].apb24 = l_apb24t - l_apa32f 
         ELSE
            LET g_apb[l_ac].apb24 = l_apb24t/(1+l_gec04/100)
         END IF  
        #-MOD-A80052-end-
        #LET g_apb[l_ac].apb24 = l_apb24t/(1+l_gec04/100)          #MOD-A80052 mark
      ELSE
         IF g_apb[l_ac].apb09>0 THEN
            LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09
         END IF
      END IF
   END IF 
  #-MOD-A80093-end-
   LET g_apb[l_ac].apb24 = cl_digcut(g_apb[l_ac].apb24,t_azi04)   #MOD-6B0066
   DISPLAY BY NAME g_apb[l_ac].apb24
 
  #IF g_aza.aza26 <> '2' THEN                                         #MOD-A80093 #MOD-CA0043 mark
   IF g_aza.aza26 <> '2' OR g_apa.apa00 = '16' THEN                   #MOD-CA0043 add
      LET g_apb[l_ac].apb10 = g_apb[l_ac].apb24 * g_apa.apa14         #MOD-860221
   END IF                                                             #MOD-A80093 
   LET g_apb[l_ac].apb10 = cl_digcut(g_apb[l_ac].apb10,g_azi04)   #MOD-6B0066
   DISPLAY BY NAME g_apb[l_ac].apb10
  #----------------------------MOD-C50241----------------------(S)
   SELECT apb09 INTO l_apb09
     FROM apb_file,apa_file
    WHERE apb21 = g_apb[l_ac].apb21
      AND apb22 = g_apb[l_ac].apb22
      AND apa01 = apb01
      AND apa00 = '16'
      AND apa41 ='Y'
      AND apa42 ='N'
   IF l_apb09 = g_apb[l_ac].apb09 THEN
  #----------------------------MOD-C50241----------------------(E)
     #當apb34='Y'時,表示此入庫單已有立暫估,單價,金額等欄位(apb23,apb24,apb08,apb10)
     #應直接抓取aapt160,不應重新計算
     #IF g_apb[l_ac].apb34='Y' THEN                        #MOD-C20104 mark
      IF g_apb[l_ac].apb34='Y' AND g_apz.apz27 = 'N' THEN  #MOD-C20104
         LET l_sql = "SELECT apb23,apb24,apb08,apb10 ",
                     #"  FROM ",li_dbs CLIPPED,"apa_file ,",li_dbs CLIPPED,"apb_file",
                     "  FROM ",cl_get_target_table(g_apb[l_ac].apb37,'apa_file'),",", #FUN-A50102
                               cl_get_target_table(g_apb[l_ac].apb37,'apb_file'),     #FUN-A50102
                     " WHERE apa01 = apb01 AND apa00 = '16' ",
                     "   AND apb21 = '",g_apb[l_ac].apb21,"' ",
                     "   AND apb22 = '",g_apb[l_ac].apb22,"' "
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
         PREPARE sel_apb23_pre FROM l_sql
         DECLARE sel_apb23_cs CURSOR FOR sel_apb23_pre
         OPEN sel_apb23_cs
         FETCH sel_apb23_cs INTO g_apb[l_ac].apb23,g_apb[l_ac].apb24,
                                 g_apb[l_ac].apb08,g_apb[l_ac].apb10
         DISPLAY BY NAME g_apb[l_ac].apb23
         DISPLAY BY NAME g_apb[l_ac].apb24
         DISPLAY BY NAME g_apb[l_ac].apb08
         DISPLAY BY NAME g_apb[l_ac].apb10
      END IF
   END IF                                      #MOD-C50241 add
 
   LET g_apb[l_ac].apb930=l_rvv930
   LET g_apb[l_ac].gem02c=s_costcenter_desc(g_apb[l_ac].apb930)
   DISPLAY BY NAME g_apb[l_ac].apb930,g_apb[l_ac].gem02c
END FUNCTION
 
FUNCTION t110_apb22_12()
   DEFINE l_apb         RECORD LIKE apb_file.*
   DEFINE l_gec04       LIKE gec_file.gec04    #TQC-8A0079 add
   DEFINE l_gec07       LIKE gec_file.gec07    #TQC-8A0079 add
   DEFINE l_rvv38t      LIKE rvv_file.rvv38t   #TQC-8A0079 add
   DEFINE l_apb24t      LIKE apb_file.apb24    #MOD-920013 add
   DEFINE l_apb09       LIKE apb_file.apb09
   DEFINE l_apb10       LIKE apb_file.apb10
   DEFINE l_apb24       LIKE apb_file.apb24
   DEFINE l_apb09_b     LIKE apb_file.apb09
   DEFINE l_apb10_b     LIKE apb_file.apb09
   DEFINE l_apb24_b     LIKE apb_file.apb09      
   DEFINE l_apb09_t160  LIKE apb_file.apb09
   DEFINE l_apb10_t160  LIKE apb_file.apb09
   DEFINE l_apb24_t160  LIKE apb_file.apb09    
   DEFINE l_cnt         LIKE type_file.num5    #MOD-950158
   DEFINE l_apa14       LIKE apa_file.apa14    #MOD-960328 add
   
   LET g_errno = ' '
 
   IF cl_null(g_apb[l_ac].apb21) AND cl_null(g_apb[l_ac].apb22) THEN
      RETURN
   END IF
 
   LET l_cnt = 0                                                                                                         
   LET g_chr_2 = 'Y'
   SELECT COUNT(*) INTO l_cnt FROM apb_file,apa_file                                                                     
    WHERE apb21 = g_apb[l_ac].apb21                                                                                            
      AND apb22 = g_apb[l_ac].apb22                                                                                            
      AND apa01 = apb01                                                                                                  
      AND (apa00 = '16' OR apa00 = '26')
      AND apa41 !='Y'                                                                                
      AND apa42 = 'N'                                                                
   IF l_cnt > 0 THEN
      LET g_chr_2 = 'N'                                                                                                     
      CALL s_errmsg('','','','aap-118',1)                                                                
      RETURN                                                                                   
   END IF                                                                                        
 
  #-MOD-B90056-add-
   #檢查單身費用暫估資料是否重覆
   LET l_cnt = 0                                                                                                         
   SELECT COUNT(*) INTO l_cnt 
     FROM apa_file,apb_file
    WHERE apb01 = g_apa.apa01 
      AND apb21 = g_apb[l_ac].apb21
      AND apb22 = g_apb[l_ac].apb22
   IF l_cnt > 0 THEN
      LET g_chr_2 = 'N'                                                                                                     
      CALL s_errmsg('','','','atm-310',1)                                                                
      RETURN                                                                                   
   END IF                                                                                        
  #-MOD-B90056-end-

   #檢查是否為 aapt160 費用暫估資料
   SELECT apb_file.* INTO l_apb.* FROM apb_file,apa_file
    WHERE apa01=apb01
      AND apa00='16' 
      AND apb01=g_apb[l_ac].apb21
      AND apb02=g_apb[l_ac].apb22
   CASE WHEN SQLCA.SQLCODE = 100 LET g_errno = 'aap-091'
        OTHERWISE                LET g_errno = SQLCA.SQLCODE USING '-------'
   END CASE
 
   IF NOT cl_null(g_errno) THEN
      RETURN
   END IF
 
   LET g_apb[l_ac].apb12 = l_apb.apb12
   LET g_apb[l_ac].apb25 = l_apb.apb25
 
   IF NOT cl_null(l_apb.apb25) THEN
      #LET l_sql = "SELECT aag02 FROM ",li_dbs CLIPPED,"aag_file ",
      LET l_sql = "SELECT aag02 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'aag_file'), #FUN-A50102
                  " WHERE aag01='",l_apb.apb25,"' ",
                  "   AND aag00='",g_bookno1,"' ",
                  "   AND aagacti = 'Y'"                        #No.MOD-B70280 add
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
      CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
      PREPARE sel_aag02_cs2 FROM l_sql
      EXECUTE sel_aag02_cs2 INTO g_apb[l_ac].b25
      IF SQLCA.sqlcode THEN
         LET g_apb[l_ac].b25 = NULL 
      END IF
   END IF
      
   IF cl_null(g_apb[l_ac].apb26) THEN                        #MOD-A70003  
     #IF g_apy.apydmy5='Y' AND g_apa.apa00[1,1]='1' THEN                               #MOD-B50255 mark
      IF (g_apy.apydmy5='Y' OR NOT cl_null(l_apb.apb26)) AND g_apa.apa00[1,1]='1' THEN #MOD-B50255
         LET g_apb[l_ac].apb26 = l_apb.apb26
      ELSE
         LET g_apb[l_ac].apb26 = g_apa.apa22
      END IF
   END IF                                                    #MOD-A70003
 
   IF NOT cl_null(g_apb[l_ac].apb26) THEN
      #LET l_sql = "SELECT gem02 FROM ",li_dbs CLIPPED,"gem_file ",
      LET l_sql = "SELECT gem02 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gem_file'), #FUN-A50102
                  " WHERE gem01 = '",g_apb[l_ac].apb26,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
      CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
      PREPARE sel_gem02_cs1 FROM l_sql
      EXECUTE sel_gem02_cs1 INTO g_apb[l_ac].b26
      IF SQLCA.sqlcode THEN
         #LET g_apb[l_ac].apb26 = NULL       #MOD-BC0218
         LET g_apb[l_ac].apb26 = ''          #MOD-BC0218
      END IF 
   END IF
 
   LET g_apb[l_ac].apb27 = l_apb.apb27
   LET g_apb[l_ac].apb28 = l_apb.apb28
   LET g_apb[l_ac].apb29 = l_apb.apb29
 
   LET g_apb[l_ac].apb23 = l_apb.apb23
 
   LET g_apb[l_ac].apb08 = g_apb[l_ac].apb23 * g_apa.apa14
   LET g_apb[l_ac].apb08 = cl_digcut(g_apb[l_ac].apb08,g_azi03)    #No.MOD-510045   #MOD-6B0066
 
  IF g_aptype = '12' THEN     #MOD-AB0167
     CALL t110_chkapb24()                       #MOD-A90146
  END IF                      #MOD-AB0167
 #-MOD-A90146-mark-
 #SELECT SUM(apb09),SUM(apb10),SUM(apb24)
 #  INTO l_apb09,l_apb10,l_apb24
 #  FROM apa_file,apb_file
 # WHERE apb21 = g_apb[l_ac].apb21
 #   AND apb22 = g_apb[l_ac].apb22
 #   AND apa00 = '12'
 #   AND apa01 = apb01
 #   AND apa41 = 'Y'
 #IF cl_null(l_apb09) THEN LET l_apb09 = 0 END IF     
 #IF cl_null(l_apb10) THEN LET l_apb10 = 0 END IF     
 #IF cl_null(l_apb24) THEN LET l_apb24 = 0 END IF     
 #  
 ##aapt120未確認沖費用暫估
 #SELECT SUM(apb09),SUM(apb10),SUM(apb24)
 #  INTO l_apb09_b,l_apb10_b,l_apb24_b
 #  FROM apa_file,apb_file
 # WHERE apb01 = g_apa.apa01 
 #   AND apb21 = g_apb[l_ac].apb21
 #   AND apb22 = g_apb[l_ac].apb22
 #   AND apa00 = '12'
 #   AND apa01 = apb01
 #   AND apa41!= 'Y'
 #IF cl_null(l_apb09_b) THEN LET l_apb09_b = 0 END IF        
 #IF cl_null(l_apb10_b) THEN LET l_apb10_b = 0 END IF        
 #IF cl_null(l_apb24_b) THEN LET l_apb24_b = 0 END IF          
 #
 ##aapt160費用暫估
 #SELECT apb09,apb10,apb24
 #  INTO l_apb09_t160,l_apb10_t160,l_apb24_t160
 #  FROM apa_file,apb_file
 # WHERE apb01 = g_apb[l_ac].apb21
 #   AND apb02 = g_apb[l_ac].apb22
 #   AND apa00 = '16'
 #   AND apa01 = apb01
 #IF cl_null(l_apb09_t160) THEN LET l_apb09_t160 = 0 END IF      
 #IF cl_null(l_apb10_t160) THEN LET l_apb10_t160 = 0 END IF     
 #IF cl_null(l_apb24_t160) THEN LET l_apb24_t160 = 0 END IF          
 #-MOD-A90146-end-
 
  #aapt160的數量、金額-aapt120已確認的數量、金額-aapt120未確認的數量、金額
 #LET g_apb[l_ac].apb09 = l_apb09_t160 - l_apb09 - l_apb09_b   #MOD-A90146 mark 
  LET g_apb[l_ac].apb09 = g_apb09                              #MOD-A90146
 #LET g_apb[l_ac].apb24 = l_apb24_t160 - l_apb24 - l_apb24_b   #MOD-A90146 mark 
  LET g_apb[l_ac].apb24 = g_apb24                              #MOD-A90146
  LET g_apb[l_ac].apb10 = g_apb[l_ac].apb24 * g_apa.apa14      #MOD-960328
  IF cl_null(g_apb[l_ac].apb09) OR g_apb[l_ac].apb09=0 THEN
     LET g_apb[l_ac].apb09=1
  END IF
  LET g_apb[l_ac].apb24 = cl_digcut(g_apb[l_ac].apb24,t_azi04)
  LET g_apb[l_ac].apb10 = cl_digcut(g_apb[l_ac].apb10,g_azi04)
  DISPLAY BY NAME g_apb[l_ac].apb09,g_apb[l_ac].apb10,g_apb[l_ac].apb24
  LET g_apb[l_ac].apb23 = g_apb[l_ac].apb24 / g_apb[l_ac].apb09
  LET g_apb[l_ac].apb08 = g_apb[l_ac].apb10 / g_apb[l_ac].apb09
  DISPLAY BY NAME g_apb[l_ac].apb08,g_apb[l_ac].apb23
 
IF g_apb[l_ac].apb09 != 0 AND g_apb[l_ac].apb09 IS NOT NULL THEN     #MOD-940416  
   #單價含稅時,不使用單價*數量=金額,改以含稅金額回推稅率,以避免小數位差的問題
   LET l_gec04 = 0   LET l_gec07 = ''
   IF g_apb[l_ac].apb06 <> '' OR NOT cl_null(g_apb[l_ac].apb06) THEN  #TQC-8C0031 add
      #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file,",
      #             li_dbs CLIPPED,"pmm_file ",
      LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102 
                                             cl_get_target_table(g_apb[l_ac].apb37,'pmm_file'),     #FUN-A50102
                  " WHERE gec01 = pmm21 ",
                  "   AND pmm01 = '",g_apb[l_ac].apb06,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
      CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
      PREPARE sel_gec04_cs4 FROM l_sql
      EXECUTE sel_gec04_cs4 INTO l_gec04,l_gec07 
   ELSE
      IF NOT cl_null(g_apb04) THEN
         #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file,",
         #             li_dbs CLIPPED,"rva_file ",
         LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102 
                                                cl_get_target_table(g_apb[l_ac].apb37,'rva_file'),     #FUN-A50102
                     " WHERE gec01 = rva115 ",
                     "   AND rva01 = '",g_apb04,"' ",
                     "   AND gec011 = '1' "
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
         PREPARE sel_gec04_cs5 FROM l_sql
         EXECUTE sel_gec04_cs5 INTO l_gec04,l_gec07
      ELSE
         IF (g_apa.apa00 = '21' OR g_apa.apa00 = '26') AND
            NOT cl_null(g_apb[l_ac].apb21) THEN
            #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file,",
            #             li_dbs CLIPPED,"rvu_file ",
            LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102 
                                                   cl_get_target_table(g_apb[l_ac].apb37,'rvu_file'),     #FUN-A50102
                        " WHERE gec01 = rvu115 ",
                        "   AND rvu01 = '",g_apb[l_ac].apb21,"' ",
                        "   AND gec011 = '1' "
            CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
            CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
            PREPARE gec04_cs6 FROM l_sql
            EXECUTE gec04_cs6 INTO l_gec04,l_gec07
         ELSE
            #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file ",
            LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'), #FUN-A50102
                        " WHERE gec01 = '",g_apa.apa15,"' ",
                        "   AND gec011 = '1' "
            CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
            CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
            PREPARE gec04_cs7 FROM l_sql
            EXECUTE gec04_cs7 INTO l_gec04,l_gec07
         END IF
      END IF
   END IF
   IF cl_null(l_gec04) THEN LET l_gec04=0   END IF
   IF cl_null(l_gec07) THEN LET l_gec07='N' END IF
   LET l_rvv38t = 0
   IF l_gec07='Y' THEN
      IF NOT cl_null(g_apb[l_ac].apb21) AND NOT cl_null(g_apb[l_ac].apb22) THEN   #MOD-9A0201 add
         #LET l_sql = "SELECT rvv38t FROM ",li_dbs CLIPPED,"rvv_file ",
         LET l_sql = "SELECT rvv38t FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'), #FUN-A50102
                     " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
                     "   AND rvv02 = '",g_apb[l_ac].apb22,"' "
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
         PREPARE sel_rvv38t_cs5 FROM l_sql
         EXECUTE sel_rvv38t_cs5 INTO l_rvv38t
         IF cl_null(l_rvv38t) THEN LET l_rvv38t=0 END IF
         LET l_apb24t = l_rvv38t*g_apb[l_ac].apb09
         LET l_apb24t = cl_digcut(l_apb24t,t_azi04) 
         LET g_apb[l_ac].apb24 = l_apb24t/(1+l_gec04/100)
      #------------------------------------CHI-B90030-----------------------------------start
      ELSE
       #aapt120雜項輸入時,稅別若為內含,輸入原幣單價後應為含稅單價,
       #需回推為未稅單價
        IF g_apb[l_ac].apb23 <> g_apb_t.apb23 OR
           cl_null(g_apb_t.apb23) THEN
           LET g_apb[l_ac].apb23 = cl_digcut(g_apb[l_ac].apb23/(1+l_gec04/100),t_azi03)
           DISPLAY BY NAME g_apb[l_ac].apb23
           LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09
        END IF
      #------------------------------------CHI-B90030-----------------------------------end
      END IF   #TQC-A10146 
   ELSE
      IF g_apb[l_ac].apb09 > 0 THEN
         LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09
      END IF
   END IF
END IF                  #MOD-940416    
   LET g_apb[l_ac].apb24 = cl_digcut(g_apb[l_ac].apb24,t_azi04)   #MOD-6B0066
 
   LET g_apb[l_ac].apb10 = g_apb[l_ac].apb24 * g_apa.apa14         #MOD-860221
   LET g_apb[l_ac].apb10 = cl_digcut(g_apb[l_ac].apb10,g_azi04)   #MOD-6B0066
 
   LET g_apb[l_ac].apb930=l_apb.apb930
   LET g_apb[l_ac].gem02c=s_costcenter_desc(g_apb[l_ac].apb930)
 
   DISPLAY BY NAME g_apb[l_ac].*
 
END FUNCTION
 
#-MOD-A90146-add-
FUNCTION t110_chkapb24()
   DEFINE l_apb09       LIKE apb_file.apb09
   DEFINE l_apb10       LIKE apb_file.apb10
   DEFINE l_apb24       LIKE apb_file.apb24
   DEFINE l_apb09_b     LIKE apb_file.apb09
   DEFINE l_apb10_b     LIKE apb_file.apb09
   DEFINE l_apb24_b     LIKE apb_file.apb09      
   DEFINE l_apb09_t160  LIKE apb_file.apb09
   DEFINE l_apb10_t160  LIKE apb_file.apb09
   DEFINE l_apb24_t160  LIKE apb_file.apb09    

  #aapt120已確認沖費用暫估
  SELECT SUM(apb09),SUM(apb10),SUM(apb24)
    INTO l_apb09,l_apb10,l_apb24
    FROM apa_file,apb_file
   WHERE apb21 = g_apb[l_ac].apb21
     AND apb22 = g_apb[l_ac].apb22
     AND apa00 = '12'
     AND apa01 = apb01
     AND apa41 = 'Y'
  IF cl_null(l_apb09) THEN LET l_apb09 = 0 END IF     
  IF cl_null(l_apb10) THEN LET l_apb10 = 0 END IF     
  IF cl_null(l_apb24) THEN LET l_apb24 = 0 END IF     
    
  #aapt120未確認沖費用暫估
  SELECT SUM(apb09),SUM(apb10),SUM(apb24)
    INTO l_apb09_b,l_apb10_b,l_apb24_b
    FROM apa_file,apb_file
   WHERE apb01 <> g_apa.apa01 
     AND apb21 = g_apb[l_ac].apb21
     AND apb22 = g_apb[l_ac].apb22
     AND apa00 = '12'
     AND apa01 = apb01
     AND apa41!= 'Y'
  IF cl_null(l_apb09_b) THEN LET l_apb09_b = 0 END IF        
  IF cl_null(l_apb10_b) THEN LET l_apb10_b = 0 END IF        
  IF cl_null(l_apb24_b) THEN LET l_apb24_b = 0 END IF          
  
  #aapt160費用暫估
  SELECT apb09,apb10,apb24
    INTO l_apb09_t160,l_apb10_t160,l_apb24_t160
    FROM apa_file,apb_file
   WHERE apb01 = g_apb[l_ac].apb21     
     AND apb02 = g_apb[l_ac].apb22
     AND apa00 = '16'
     AND apa01 = apb01
  IF cl_null(l_apb09_t160) THEN LET l_apb09_t160 = 0 END IF      
  IF cl_null(l_apb10_t160) THEN LET l_apb10_t160 = 0 END IF     
  IF cl_null(l_apb24_t160) THEN LET l_apb24_t160 = 0 END IF          

  #aapt160的數量、金額-aapt120已確認的數量、金額-aapt120未確認的數量、金額
 #LET g_apb09 = l_apb09_t160 - l_apb09 - l_apb09_b #MOD-B20137 mark 
  LET g_apb09 = 1                                  #MOD-B20137
  LET g_apb24 = l_apb24_t160 - l_apb24 - l_apb24_b           
  LET g_apb10 = g_apb24 * g_apa.apa14     
  LET g_apb24 = cl_digcut(g_apb24,t_azi04)
  LET g_apb10 = cl_digcut(g_apb10,g_azi04)
END FUNCTION
#-MOD-A90146-end-
#----------------------MOD-CB0133--------------------(S)
FUNCTION t110_chkapb24_21(p_apk02,p_apb11,p_apb24,p_gec05)
   DEFINE p_apk02   LIKE apk_file.apk02
   DEFINE p_apb11   LIKE apb_file.apb11
   DEFINE p_apb24   LIKE apb_file.apb24
   DEFINE p_gec05   LIKE gec_file.gec05
   DEFINE l_amt1    LIKE type_file.num20_6
   DEFINE l_amt2    LIKE type_file.num20_6
   DEFINE l_amt3    LIKE type_file.num20_6
   DEFINE l_amt4    LIKE type_file.num20_6
   DEFINE l_cnt     LIKE type_file.num5


   SELECT SUM(apk07+apk08)
     INTO l_amt1
     FROM apk_file
    WHERE apk03 = p_apb11
      AND apk01 = g_apa.apa01
      AND apk02 <> p_apk02
      AND apk171 IN ('23','24','29')
   IF STATUS <> 0 OR l_amt1 IS NULL THEN
      LET l_amt1 = 0
   END IF

   SELECT SUM(apk07+apk08)
     INTO l_amt3
     FROM apk_file,apa_file
    WHERE apk03 = p_apb11
      AND apk01 = g_apa.apa01
      AND apk02 <> p_apk02
      AND apk171 = 'XX'
      AND apk01 = apa01
      AND apa00 MATCHES "2*"
   IF STATUS <> 0 OR l_amt3 IS NULL THEN
      LET l_amt3 = 0
   END IF

   LET l_amt1 = l_amt1 + l_amt3 + p_apb24

   SELECT COUNT(*) INTO l_cnt
     FROM apk_file
    WHERE apk03 = p_apb11
      AND apk171 IN ('21','22','25','28','XX')
   IF l_cnt > 0 THEN
     ##原發票金額
      SELECT SUM(apk07+apk08)
        INTO l_amt2
        FROM apk_file
       WHERE apk03 = p_apb11
         AND apk171 IN ('21','22','25','28')
      IF STATUS <> 0 OR l_amt2 IS NULL THEN
         LET l_amt2 = 0
      END IF

      SELECT SUM(apk07+apk08)
        INTO l_amt4
        FROM apk_file,apa_file
       WHERE apk03 = p_apb11
         AND apk171 = 'XX'
         AND apk01 = apa01
         AND apa00 MATCHES "1*"
      IF STATUS <> 0 OR l_amt4 IS NULL THEN
         LET l_amt4 = 0
      END IF

      LET l_amt2 = l_amt2 + l_amt4
   ELSE
      SELECT SUM(amd07+amd08)
        INTO l_amt2
        FROM amd_file
       WHERE amd03 = p_apb11
         AND amd171 IN ('21','22','25','28')
      IF STATUS <> 0 OR l_amt2 IS NULL THEN
         LET l_amt2 = 0
      END IF
   END IF
   IF g_aza.aza26 <> '2' THEN
      IF l_amt1 > l_amt2 THEN
         IF p_gec05 <> 'X' THEN
            RETURN 0
         ELSE
            LET l_cnt = 0
            SELECT COUNT(*) INTO l_cnt FROM apa_file,apb_file
            WHERE apa01 = apb01 AND apa01 = g_apa.apa01
              AND apb06 IS NOT NULL
            IF l_cnt = 0 THEN
               RETURN 0
            END IF
         END IF
      END IF
   END IF
   RETURN 1
END FUNCTION
#----------------------MOD-CB0133--------------------(E)

FUNCTION t110_apb06()
 
   LET g_apb[l_ac].apb12 = ''
   LET g_apb[l_ac].apb27 = ''
   LET g_apb[l_ac].apb09 = 0
   LET g_apb[l_ac].apb25 = ''
   LET g_apb[l_ac].apb28 = ''
   LET g_apb[l_ac].apb26 = ''
   LET g_apb[l_ac].apb23 = 0
   LET g_apb[l_ac].apb08 = 0
   LET g_apb[l_ac].apb24 = 0
   LET g_apb[l_ac].apb10 = 0
   DISPLAY BY NAME g_apb[l_ac].apb12
   DISPLAY BY NAME g_apb[l_ac].apb27
   DISPLAY BY NAME g_apb[l_ac].apb09
   DISPLAY BY NAME g_apb[l_ac].apb25
   DISPLAY BY NAME g_apb[l_ac].apb28
   DISPLAY BY NAME g_apb[l_ac].apb26
   DISPLAY BY NAME g_apb[l_ac].apb23
   DISPLAY BY NAME g_apb[l_ac].apb08
   DISPLAY BY NAME g_apb[l_ac].apb24
   DISPLAY BY NAME g_apb[l_ac].apb10
 
END FUNCTION
 
FUNCTION  t110_apb22_21(p_cmd)
   DEFINE p_cmd           LIKE type_file.chr1      #No.FUN-690028 VARCHAR(1)
   DEFINE l_sql           STRING                   #MOD-720062
   DEFINE l_rvu04         LIKE rvu_file.rvu04
   DEFINE l_rvu02         LIKE rvu_file.rvu02
   DEFINE l_rvv03         LIKE rvv_file.rvv03
   DEFINE l_rvv04         LIKE rvv_file.rvv04
   DEFINE l_rvv05         LIKE rvv_file.rvv05
   DEFINE l_rvv38         LIKE rvv_file.rvv38
   DEFINE l_rvv38t        LIKE rvv_file.rvv38t     #TQC-8A0079 add
   DEFINE l_rvv39         LIKE rvv_file.rvv39
   DEFINE l_rvv39t        LIKE rvv_file.rvv39t     #TQC-8A0079 add
   DEFINE l_rvv17         LIKE rvv_file.rvv17      #FUN-560070
   DEFINE l_rvv87         LIKE rvv_file.rvv87      #FUN-560070
   DEFINE l_rvv23         LIKE rvv_file.rvv23
   DEFINE l_rvv25         LIKE rvv_file.rvv25
   DEFINE l_rvv36         LIKE rvv_file.rvv36
   DEFINE l_rvv37         LIKE rvv_file.rvv37
   DEFINE l_pmm22         LIKE pmm_file.pmm22
   DEFINE l_pmn07         LIKE pmn_file.pmn07
   DEFINE l_pmn86         LIKE pmn_file.pmn86      #FUN-560070
   DEFINE l_pmn40         LIKE pmn_file.pmn40
   DEFINE l_pmn041        LIKE pmn_file.pmn041
   DEFINE l_rvv31         LIKE rvv_file.rvv31
   DEFINE l_invoice       LIKE apa_file.apa08
   DEFINE l_pmn122        LIKE pmn_file.pmn122
   DEFINE l_iqc_no        LIKE rvu_file.rvu02      #FUN-660117 #CHAR(10)
   DEFINE l_iqc_seq       LIKE type_file.num5      #No.FUN-690028 SMALLINT
   DEFINE l_rvv930        LIKE rvv_file.rvv930     #FUN-670064
   DEFINE l_rvv88         LIKE rvv_file.rvv88      #No.TQC-7B0083
   DEFINE l_apb           RECORD LIKE apb_file.*   #MOD-850316 add
   DEFINE l_gec04         LIKE gec_file.gec04      #TQC-8A0079 add
   DEFINE l_gec07         LIKE gec_file.gec07      #TQC-8A0079 add
   DEFINE l_rvv09         LIKE rvv_file.rvv09      #MOD-8C0005 add
   DEFINE l_apb24t        LIKE apb_file.apb24      #MOD-920013 add
   DEFINE l_cnt           LIKE type_file.num5      #MOD-950158 
   DEFINE l_type          LIKE type_file.chr1      #MOD-9A0085          
   DEFINE l_rvv01         LIKE rvv_file.rvv01      #FUN-9A0093
   DEFINE l_rvu27         LIKE rvu_file.rvu27      #FUN-BB0001 add
   LET g_errno = ' '
 
  #CHI-A30023---add---start---
   IF g_aptype='26' THEN
      IF cl_null(g_apb[l_ac].apb21) AND cl_null(g_apb[l_ac].apb22) THEN
         RETURN
      END IF
   END IF
  #MOD-A30023---add---end--- 
   LET l_cnt = 0                                                                                                         
   LET g_chr_3 = 'Y'
   SELECT COUNT(*) INTO l_cnt FROM apb_file,apa_file                                                                     
    WHERE apb21 = g_apb[l_ac].apb21                                                                                            
      AND apb22 = g_apb[l_ac].apb22                                                                                            
      AND apa01 = apb01                                                                                                  
      AND (apa00 = '16' OR apa00 = '26')
      AND apa41 !='Y'                                                                                
      AND apa42 = 'N'                                                                
   IF l_cnt > 0 THEN
      LET g_chr_3 = 'N'                                                                                                     
      CALL s_errmsg('','','','aap-118',1)                                                                
      RETURN                                                                                   
   END IF                                                                                        
 
   #若倉退單對應的收貨單已有發票不可再產生暫估單
   IF g_aptype='26' THEN
      LET l_cnt = 0
      IF g_aza.aza26 = '2' THEN
         #LET l_sql = "SELECT COUNT(*) FROM ",li_dbs CLIPPED,"rvw_file ",
         LET l_sql = "SELECT COUNT(*) FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvw_file'), #FUN-A50102
                     " WHERE rvw08 = '",g_apb[l_ac].apb21,"' ",
                     "   AND rvw09 = '",g_apb[l_ac].apb22,"' "
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
         PREPARE rvw_cou_pre1 FROM l_sql
         EXECUTE rvw_cou_pre1 INTO l_cnt
      ELSE
         #LET l_sql = "SELECT COUNT(*) FROM ",li_dbs CLIPPED,"rvv_file, ",
         #             li_dbs CLIPPED,"rvb_file ",
      #FUN-BB0001 add START
         SELECT rvu27 INTO l_rvu27 FROM rvu_file WHERE rvu01 = g_apb[l_ac].apb21
         IF l_rvu27 = '2' OR l_rvu27 = '3' OR l_rvu27 = '4' THEN
            LET l_sql = "SELECT COUNT(*) FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'),",", #FUN-A50102
                        " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
                        "  AND rvv02 = '",g_apb[l_ac].apb22,"' ",
                        "  AND rvv22 IS NOT NULL AND rvv22 != ' ' "
         ELSE
      #FUN-BB0001 add END
            LET l_sql = "SELECT COUNT(*) FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'),",", #FUN-A50102
                                                cl_get_target_table(g_apb[l_ac].apb37,'rvb_file'),     #FUN-A50102
                        " WHERE rvv01 ='",g_apb[l_ac].apb21,"' ",
                        "   AND rvv02 ='",g_apb[l_ac].apb22,"' ",
                        "   AND rvv04 = rvb01 AND rvv05 = rvb02",
                        "   AND rvb22 IS NOT NULL AND rvb22 != ' ' "
         END IF       #FUN-BB0001 add
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
         PREPARE sel_cou_rvv FROM l_sql
         EXECUTE sel_cou_rvv INTO l_cnt
      END IF
      IF l_cnt > 0 THEN
         CALL s_errmsg('','','','aap-152',1)
         LET g_errno = 'aap-152'
         RETURN
      END IF
   END IF

   LET l_rvv17 = NULL   #MOD-D40097 add

   #LET l_sql = "SELECT rvv01 FROM ",li_dbs CLIPPED,"rvv_file,",
   #             li_dbs CLIPPED,"rvu_file ",
   LET l_sql = "SELECT rvv01,rvv17 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'),",", #FUN-A50102     #MOD-D40097 add rvv17
                                          cl_get_target_table(g_apb[l_ac].apb37,'rvu_file'),     #FUN-A50102
               " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
               "   AND rvv02 = '",g_apb[l_ac].apb22,"' ",
               "   AND rvu01 = rvv01 AND rvuconf='Y' ",
               "   AND rvu00 = '3'"
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql                     #FUN-A50102									
   CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql   #FUN-A50102                
   PREPARE sel_rvv01_pre FROM l_sql
   EXECUTE sel_rvv01_pre INTO l_rvv01,l_rvv17                       #MOD-D40097 add l_rvv17 
   IF SQLCA.SQLCODE = 100 THEN                                                                                                      
      LET l_type='1'
   ELSE                                                                                                                             
      LET l_type='2'                                                                                                                
   END IF                                                                                                                           
 
   IF g_aptype = '21' AND g_apa.apa58 = '3' AND l_type='1' THEN #MOD-9A0085 add l_type    
      #當判斷apb21(退貨單號/費用類暫估單號)欄位有輸入時,才需檢查是否存在aapt260
      IF NOT cl_null(g_apb[l_ac].apb21) THEN   #MOD-880181 add
         #檢查是否為 aapt260 扣款折讓暫估資料
         SELECT apb_file.* INTO l_apb.* FROM apb_file,apa_file
          WHERE apa01=apb01
            AND apa00='26' 
            AND apb01=g_apb[l_ac].apb21
            AND apb02=g_apb[l_ac].apb22
         IF SQLCA.SQLCODE = 100 THEN
            LET g_errno='aap-091'
            RETURN
         ELSE
            LET g_apb[l_ac].apb06 = l_apb.apb06
            LET g_apb[l_ac].apb07 = l_apb.apb07
            LET g_apb[l_ac].apb12 = l_apb.apb12
            LET g_apb[l_ac].apb25 = l_apb.apb25
            LET g_apb[l_ac].apb26 = l_apb.apb26
            LET g_apb[l_ac].apb27 = l_apb.apb27
            LET g_apb[l_ac].apb28 = l_apb.apb28
            LET g_apb[l_ac].apb29 = l_apb.apb29
            LET g_apb[l_ac].apb23 = l_apb.apb23
            LET g_apb[l_ac].apb08 = g_apb[l_ac].apb23 * g_apa.apa14
            LET g_apb[l_ac].apb08 =cl_digcut(g_apb[l_ac].apb08,g_azi03)
            LET g_apb[l_ac].apb09 = l_apb.apb09
            #單價含稅時,不使用單價*數量=金額,改以含稅金額回推稅率,以避免小數位差的問題
            LET l_gec04 = 0   LET l_gec07 = ''
            IF g_apb[l_ac].apb06 <> '' OR NOT cl_null(g_apb[l_ac].apb06) THEN  #TQC-8C0031      
               #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file,",
               #             li_dbs CLIPPED,"pmm_file ",
               LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102
                                                      cl_get_target_table(g_apb[l_ac].apb37,'pmm_file'),     #FUN-A50102
                           " WHERE gec01 = pmm21 ",
                           "   AND pmm01 = '",g_apb[l_ac].apb06,"' "
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
               CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
               PREPARE sel_gec07_pre4 FROM l_sql
               EXECUTE sel_gec07_pre4 INTO l_gec04,l_gec07
            ELSE 
               IF NOT cl_null(g_apb04) THEN
                  #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED," gec_file,",
                  #             li_dbs CLIPPED,"rva_file ",
                  LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102
                                                         cl_get_target_table(g_apb[l_ac].apb37,'rva_file'),     #FUN-A50102
                              " WHERE gec01 = rva115 ",
                              "   AND rva01 = '",g_apb04,"' ",
                              "   AND gec011 = '1'"
                  CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
                  CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
                  PREPARE sel_gec07_pre5 FROM l_sql
                  EXECUTE sel_gec07_pre5 INTO l_gec04,l_gec07
               ELSE
                  IF (g_apa.apa00 = '21' OR g_apa.apa00 = '26') AND
                     NOT cl_null(g_apb[l_ac].apb21) THEN
                     #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file,",
                     #             li_dbs CLIPPED,"rvu_file",
                     LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102
                                                            cl_get_target_table(g_apb[l_ac].apb37,'rvu_file'),     #FUN-A50102
                                 " WHERE rvu01='",g_apb[l_ac].apb21,"' ",
                                 "   AND gec01 = rvu115 AND gec011 = '1' "
                     CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
                     CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102               
                     PREPARE sel_gec07_pre6 FROM l_sql
                     EXECUTE sel_gec07_pre6 INTO l_gec04,l_gec07
                  ELSE 
                     #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file ",
                     LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'), #FUN-A50102
                                 " WHERE gec01 = '",g_apa.apa15,"' ",
                                 "   AND gec011 = '1' "
                     CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
                     CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
                     PREPARE sel_gec07_pre7 FROM l_sql
                     EXECUTE sel_gec07_pre7 INTO l_gec04,l_gec07
                  END IF
               END IF
            END IF
            IF cl_null(l_gec04) THEN LET l_gec04=0   END IF
            IF cl_null(l_gec07) THEN LET l_gec07='N' END IF
            LET l_rvv38t = 0
            IF l_gec07='Y' THEN        #含稅單價*數量=含稅金額     
               #LET l_sql = "SELECT rvv38t FROM ",li_dbs CLIPPED,"rvv_file ",
               LET l_sql = "SELECT rvv38t FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'), #FUN-A50102
                           " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
                           "   AND rvv02 = '",g_apb[l_ac].apb22,"' "
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
               CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102                 
               PREPARE sel_rvv38t_pre1 FROM l_sql
               EXECUTE sel_rvv38t_pre1 INTO l_rvv38t
               IF cl_null(l_rvv38t) THEN LET l_rvv38t=0 END IF
               LET l_apb24t = l_rvv38t*g_apb[l_ac].apb09
               LET l_apb24t = cl_digcut(l_apb24t,t_azi04) 
               LET g_apb[l_ac].apb24 = l_apb24t/(1+l_gec04/100)
            ELSE
               IF g_apb[l_ac].apb09>0 THEN
                  LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09
               ELSE
                  LET g_apb[l_ac].apb24 = 0
               END IF
            END IF
            LET g_apb[l_ac].apb24 =cl_digcut(g_apb[l_ac].apb24,t_azi04)
            LET g_apb[l_ac].apb10 =g_apb[l_ac].apb24 * g_apa.apa14         #MOD-860221
            LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,g_azi04)
            LET g_apb[l_ac].apb34 ='Y'
            LET g_apb[l_ac].apb01_unap =g_apb[l_ac].apb21
            LET g_apb[l_ac].apb930=l_apb.apb930
            LET g_apb[l_ac].gem02c=s_costcenter_desc(g_apb[l_ac].apb930)
            DISPLAY BY NAME g_apb[l_ac].*
         END IF
      END IF   #MOD-880181 add
   ELSE
      IF (g_aptype = '21' AND (g_apa.apa58 = '2' OR (g_apa.apa58='3' AND l_type='2'))) OR g_aptype = '26' OR g_aptype = '11' THEN  #MOD-9A0085    
         #MOD-D40097 add begin---
         IF g_apa.apa58='3' AND l_rvv17 > 0 THEN
            LET g_chr_3 = 'N'
            CALL s_errmsg('','','','aap1011',1)
            RETURN
         END IF 
         #MOD-D40097 add end-----
         LET l_sql = 
            "SELECT rvu04,rvv03,rvv04,rvv05,rvv38,rvv39,rvv23,rvv87,pmm22,rvu02,rvv05,",   #FUN-560070
            "       rvv31,pmn86,pmn40,pmn041,rvv25,rvv36,rvv37,pmn122,",                   #FUN-560070
            "       rvv930,rvv88,rvv39t",                                                  #FUN-670064  #No.TQC-7B0083   #TQC-8A0079 add rvv39t
            "       ,rvv09",                                                               #MOD-8C0005 add rvv09         
            #"  FROM ",li_dbs CLIPPED,"rvu_file, ",li_dbs CLIPPED,"rvv_file LEFT OUTER JOIN ",li_dbs CLIPPED,"rvb_file ON rvv04=rvb01 AND rvv05=rvb02 LEFT OUTER JOIN ", #FUN-9A0093
            "  FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvu_file'),",", #FUN-A50102
                      cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'),     #FUN-A50102
            " LEFT OUTER JOIN ",cl_get_target_table(g_apb[l_ac].apb37,'rvb_file'), #FUN-A50102
            " ON rvv04=rvb01 AND rvv05=rvb02 LEFT OUTER JOIN ",
            "   (SELECT pmn01,pmn02,pmm22,pmn86,pmn40,pmn041,pmn122 ",
            #"     FROM ",li_dbs CLIPPED,"pmm_file,",li_dbs CLIPPED,"pmn_file ",    #FUN-9A0093
            "     FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmm_file'),",", #FUN-A50102
                         cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'),     #FUN-A50102 
            "    WHERE pmn01 = pmm01) tmp ",
            "     ON rvv_file.rvv36 = tmp.pmn01 AND rvv_file.rvv37 = tmp.pmn02 ",  #MOD-9A0075
            "  WHERE rvv01 = '",g_apb[l_ac].apb21,"'",
            "    AND rvv02 =  ",g_apb[l_ac].apb22,
            "    AND rvu01 = rvv01 ",
            "    AND rvuconf='Y'   AND rvu00 = '3' "
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102          
         PREPARE apb22_21_pre FROM l_sql
         DECLARE apb22_21_cs CURSOR FOR apb22_21_pre
         OPEN apb22_21_cs
         FETCH apb22_21_cs
            INTO l_rvu04,l_rvv03,l_rvv04,l_rvv05,l_rvv38,l_rvv39,l_rvv23,l_rvv87,   #FUN-560070
                 l_pmm22,l_iqc_no,l_iqc_seq,l_rvv31,l_pmn86,l_pmn40,l_pmn041,   #FUN-560070
                 l_rvv25,l_rvv36,l_rvv37,l_pmn122,
                 l_rvv930,l_rvv88,l_rvv39t   #FUN-670064  #No.TQC-7B0083  #TQC-8A0079 add l_rvv39t
                 ,l_rvv09      #MOD-8C0005 add l_rvv09 
            LET l_sql = "SELECT rvu04,rvv03,rvv04,rvv05,rvv38,rvv39,rvv23,rvv87,'',rvu02,rvv05,",
                        "       rvv31,'','','',rvv25,rvv36,rvv37,'',",
                        "       rvv930,rvv88,rvv39t,rvv09",
                        #"  FROM ",li_dbs CLIPPED,"rvv_file,",li_dbs CLIPPED,"rvu_file",
                        "  FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'),",", #FUN-A50102
                                  cl_get_target_table(g_apb[l_ac].apb37,'rvu_file'),     #FUN-A50102 
                        " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
                        "   AND rvv02 = '",g_apb[l_ac].apb22,"' ",
                        "   AND rvu01 = rvv01 AND rvuconf='Y' ",
                        "   AND rvu00 = '3' AND rvv89 <> 'Y' "
            CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
            CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
            PREPARE sel_rvvu_pre  FROM l_sql
            EXECUTE sel_rvvu_pre INTO l_rvu04,l_rvv03,l_rvv04,l_rvv05,l_rvv38,l_rvv39,l_rvv23,l_rvv87,
                                      l_pmm22,l_iqc_no,l_iqc_seq,l_rvv31,l_pmn86,l_pmn40,l_pmn041,
                                      l_rvv25,l_rvv36,l_rvv37,l_pmn122,
                                      l_rvv930,l_rvv88,l_rvv39t,l_rvv09
            IF NOT cl_null(l_rvv36) AND NOT cl_null(l_rvv37) THEN
               LET l_sql = "SELECT pmm22,pmn86,pmn40,pmn041,pmn122 ",
                           #"  FROM ",li_dbs CLIPPED,"pmm_file,",li_dbs CLIPPED,"pmn_file ",
                           "  FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmm_file'),",", #FUN-A50102
                                     cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'),     #FUN-A50102 
                           " WHERE pmn01 = '",l_rvv36,"' ",
                           "   AND pmn02 = '",l_rvv37,"' ",
                           "   AND pmm01 = pmn01"
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
               CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
               PREPARE sel_pmm22_pre FROM l_sql
               EXECUTE sel_pmm22_pre INTO l_pmm22,l_pmn86,l_pmn40,l_pmn041,l_pmn122   #TQC-AB0200 add pmn041 
            ELSE
               IF NOT cl_null(l_rvv04) AND NOT cl_null(l_rvv05) THEN
                 LET l_sql = "SELECT rva113,rvb051,rvb86,'' ",
                             #"  FROM ",li_dbs CLIPPED,"rva_file,",li_dbs CLIPPED,"rvb_file",
                             "  FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rva_file'),",", #FUN-A50102
                                       cl_get_target_table(g_apb[l_ac].apb37,'rvb_file'),     #FUN-A50102 
                             " WHERE rvb01 = '",l_iqc_no,"' ",
                             "   AND rvb02 = '",l_rvv05,"' ",
                             "   AND rva01 = rvb01"
                 CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
                 CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
                 PREPARE sel_rva113_pre FROM l_sql
                 EXECUTE sel_rva113_pre INTO l_pmm22,l_pmn041,l_pmn86,l_pmn122 
                 #LET l_sql = "SELECT ima39 FROM ",li_dbs CLIPPED,"ima_file ",
                 LET l_sql = "SELECT ima39 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'ima_file'), #FUN-A50102
                             " WHERE ima01 = '",l_rvv31,"' "
                 CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
                  CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
                 PREPARE sel_ima39 FROM l_sql
                 EXECUTE sel_ima39 INTO l_pmn40
               ELSE
                  LET l_pmm22 = g_apa.apa13
                  LET l_pmn122 = NULL
                  #LET l_sql = "SELECT ima02,ima39 FROM ",li_dbs CLIPPED,"ima_file ",
                  LET l_sql = "SELECT ima02,ima39 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'ima_file'), #FUN-A50102
                              " WHERE ima01 ='", l_rvv31,"' "
                  CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
                  CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
                  PREPARE sel_ima02_pre FROM l_sql
                  EXECUTE sel_ima02_pre INTO l_pmn041,l_pmn40
                  #LET l_sql = "SELECT rvv86 FROM ",li_dbs CLIPPED,"rvv_file ",
                  LET l_sql = "SELECT rvv86 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'), #FUN-A50102
                              " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
                              "   AND rvv02 = '",g_apb[l_ac].apb22,"' "
                  CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
                  CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
                  PREPARE sel_rvv86_pre5 FROM l_sql
                  EXECUTE sel_rvv86_pre5 INTO l_pmn86
               END IF
            END IF
            IF g_qty1 IS NULL THEN
               LET g_qty1 = 0
            END IF
            IF l_rvv87 IS NULL THEN
               LET l_rvv87 = 0
            END IF
    
            IF l_rvv23 IS NULL THEN
               LET l_rvv23 = 0
            END IF
    
            IF l_pmn122 !=g_apa.apa66 THEN
               LET g_errno='aap-300'
               RETURN
            END IF
    
            IF l_rvv03 MATCHES '[12]' THEN
               LET g_errno='aap-093'
               RETURN
            END IF
    
            CASE WHEN SQLCA.SQLCODE = 100  LET g_errno = 'aap-092'
                 WHEN l_rvu04 != g_apa.apa05 LET g_errno = 'aap-040'
                 WHEN l_rvv87 <= l_rvv23 AND l_rvv23 > 0  LET g_errno = 'aap-774'   #FUN-560070   #No.MOD-910062
                 WHEN YEAR(l_rvv09)  != YEAR(g_apa.apa02)  OR                                                                                
                      (YEAR(l_rvv09)   = YEAR(g_apa.apa02)  AND                                                                              
                      MONTH(l_rvv09) != MONTH(g_apa.apa02) )                                                                                 
                      LET g_errno = 'aap-316'                                                                                                
                 WHEN l_rvv09  > g_apa.apa02 LET g_errno = 'aap-317'   
                 OTHERWISE          LET g_errno = SQLCA.SQLCODE USING '-------'
            END CASE
        #IF NOT cl_null(g_errno) THEN RETURN END IF   #MOD-B80277 add  #MOD-C10083 移至14882行    
         #衝暫估可以跨月
         IF g_errno = 'aap-316' THEN
            IF t110_set_rvv34(g_apb[l_ac].apb21,g_apb[l_ac].apb22) = 'Y' THEN
               LET g_errno = ''
            END IF
         END IF
         IF NOT cl_null(g_errno) THEN RETURN END IF   #MOD-C10083 add
         #重要信息:衝暫估前,一定要check部分請款,部分暫估現象時,請款已經做過了
         IF g_aptype='11' THEN
            IF l_rvv87 - l_rvv23 > 0 THEN                #部分請款或有做過暫估
               IF l_rvv88 > 0 THEN                       #有暫估資料沒有衝
                  IF l_rvv88 - l_rvv23 <> l_rvv88 THEN   #部分請款
                     LET g_errno = 'aap-817'
                  END IF
               END IF
            END IF
         END IF
    
         IF NOT cl_null(g_errno) THEN
            RETURN
         END IF
    
         IF cl_null(l_pmn041) THEN
            #LET l_sql = "SELECT ima02 FROM ",li_dbs CLIPPED,"ima_file ",
            LET l_sql = "SELECT ima02 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'ima_file'), #FUN-A50102
                        " WHERE ima01 = '",l_rvv31,"' "
            CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
            CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
            PREPARE sel_ima02_pre1 FROM l_sql
            EXECUTE sel_ima02_pre1 INTO l_pmn041
         END IF
    
         IF cl_null(l_pmn40) THEN
            #LET l_sql = "SELECT ima39 FROM ",li_dbs CLIPPED,"ima_file ",
            LET l_sql = "SELECT ima39 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'ima_file'), #FUN-A50102
                        " WHERE ima01 = '",l_rvv31,"' "
            CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
            CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
            PREPARE sel_ima39_pre2 FROM l_sql
            EXECUTE sel_ima39_pre2 INTO l_pmn40
         END IF
    
         IF cl_null(l_pmn86) THEN
            #LET l_sql = "SELECT rvv86 FROM ",li_dbs CLIPPED,"rvv_file ",
            LET l_sql = "SELECT rvv86 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'), #FUN-A50102
                        " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
                        "   AND rvv02 = '",g_apb[l_ac].apb22,"' "
            CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
            CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
            PREPARE sel_rvv86_pre1 FROM l_sql
            EXECUTE sel_rvv86_pre1 INTO l_pmn86
         END IF
    
         IF g_apa.apa13 IS NULL THEN
            LET g_apa.apa13 = l_pmm22
         END IF
    
         IF l_pmm22 != g_apa.apa13 THEN                              # 幣別不符
            LET g_errno = 'aap-041'
            CALL cl_err(l_pmm22,'aap-041',0)
            IF NOT cl_null(g_errno) THEN #MOD-9A0143                                                                                      
               RETURN                    #MOD-9A0143                                                                                      
            END IF                       #MOD-9A0143  
         END IF
         IF g_aza.aza26 = 2 THEN
            #LET g_sql = "SELECT rvw01 FROM ",li_dbs CLIPPED,"rvw_file ",    #FUN-9A0093
            LET g_sql = "SELECT rvw01 FROM ",cl_get_target_table(g_plant_new,'rvw_file'), #FUN-A50102
                        " WHERE rvw08 = '",g_apb[l_ac].apb21,"'",
                        " AND rvw09 = '",g_apb[l_ac].apb22,"'"
            CALL cl_replace_sqldb(g_sql) RETURNING g_sql              #FUN-A50102									
            CALL cl_parse_qry_sql(g_sql,g_apb[l_ac].apb37) RETURNING g_sql #FUN-A50102             
         ELSE
            LET g_sql = "SELECT apa08 FROM apa_file,apb_file ",  
                        " WHERE apa01 = apb01 AND apa00 = '11' ",
                        " AND apb04 = '",l_iqc_no,"' AND apb05 = '",l_iqc_seq,"'",
                        " ORDER BY apa08 DESC "
         END IF         
         PREPARE t110_preinvoice FROM g_sql
         DECLARE t110_invoice CURSOR FOR t110_preinvoice
         LET l_invoice = NULL
    
         FOREACH t110_invoice INTO l_invoice
            IF STATUS THEN
               EXIT FOREACH
            END IF
         END FOREACH
    
         IF g_apb[l_ac].apb11 IS NULL THEN
            LET g_apb[l_ac].apb11 = l_invoice
            DISPLAY BY NAME g_apb[l_ac].apb11
         END IF
    
         LET g_apb04 = l_rvv04
         LET g_apb05 = l_rvv05
         LET g_apb[l_ac].apb06 = l_rvv36
         LET g_apb[l_ac].apb07 = l_rvv37
         LET g_apb[l_ac].apb12 = l_rvv31
         LET g_apb[l_ac].apb25 = l_pmn40
         LET g_apb[l_ac].apb26 = g_apa.apa22
         LET g_apb[l_ac].apb27 = l_pmn041
         LET g_apb[l_ac].apb28 = l_pmn86   #FUN-560070
         LET g_apb[l_ac].apb29 = l_rvv03
    
         IF l_rvv25='Y' THEN             #樣品單價為0
            LET g_apb[l_ac].apb23 = 0
         ELSE
            LET g_apb[l_ac].apb23 = l_rvv38
         END IF
         DISPLAY BY NAME g_apb[l_ac].apb23
    
         LET g_apb[l_ac].apb08 = g_apb[l_ac].apb23 * g_apa.apa14
         LET g_apb[l_ac].apb08 =cl_digcut(g_apb[l_ac].apb08,g_azi03)       #No.MOD-510045   #MOD-6B0066
         DISPLAY BY NAME g_apb[l_ac].apb08
    
         IF g_apb[l_ac].apb09 = 0 THEN
            LET g_apb[l_ac].apb09 = l_rvv87 - l_rvv23   #FUN-560070
            LET g_apb[l_ac].apb09 = s_digqty(g_apb[l_ac].apb09,g_apb[l_ac].apb28)   #FUN-910088--add--
            DISPLAY BY NAME g_apb[l_ac].apb09
         END IF
    
         #單價含稅時,不使用單價*數量=金額,改以含稅金額回推稅率,以避免小數位差的問題
         LET l_gec04 = 0   LET l_gec07 = ''
         IF g_apb[l_ac].apb06 <> '' OR NOT cl_null(g_apb[l_ac].apb06) THEN   #TQC-8C0031
            #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file,",
            #             li_dbs CLIPPED,"pmm_file ",
            LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102
                                                   cl_get_target_table(g_apb[l_ac].apb37,'pmm_file'),     #FUN-A50102
                        " WHERE gec01 = pmm21",
                        "   AND pmm01 = '",g_apb[l_ac].apb06,"' "
            CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
            CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102               
            PREPARE sel_gec04 FROM l_sql
            EXECUTE sel_gec04 INTO l_gec04,l_gec07
         ELSE
            IF NOT cl_null(g_apb04) THEN
               #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file,",
               #             li_dbs CLIPPED,"rva_file ",
               LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102
                                                      cl_get_target_table(g_apb[l_ac].apb37,'rva_file'),     #FUN-A50102
                           " WHERE gec01 = rva115 AND gec011 = '1' ",
                           "   AND rva01 = '",g_apb04,"' "
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
               CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
               PREPARE gec04_cs2 FROM l_sql
               EXECUTE gec04_cs2 INTO l_gec04,l_gec07
            ELSE  
               IF (g_apa.apa00 = '21' OR g_apa.apa00 = '26') AND
                  NOT cl_null(g_apb[l_ac].apb21) THEN
                  #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file,",
                  #             li_dbs CLIPPED,"rvu_file ",
                  LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", #FUN-A50102
                                                         cl_get_target_table(g_apb[l_ac].apb37,'rvu_file'),     #FUN-A50102
                              " WHERE gec01 = rvu115 AND gec011 = '1' ",
                              "   AND rvu01 = '",g_apb[l_ac].apb21,"' "
                  CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
                  CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
                  PREPARE sel_gec04_cs9 FROM l_sql
                  EXECUTE sel_gec04_cs9 INTO l_gec04,l_gec07
               ELSE 
                  #LET l_sql = "SELECT gec04,gec07 FROM ",li_dbs CLIPPED,"gec_file",
                  LET l_sql = "SELECT gec04,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'), #FUN-A50102
                              " WHERE gec01 = '",g_apa.apa15,"' ",
                              "   AND gec011 = '1'"
                  CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
                  CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
                  PREPARE sel_gec04_cs13 FROM l_sql
                  EXECUTE sel_gec04_cs13 INTO l_gec04,l_gec07
               END IF
            END IF
         END IF                
         IF cl_null(l_gec04) THEN LET l_gec04=0   END IF
         IF cl_null(l_gec07) THEN LET l_gec07='N' END IF
         LET l_rvv38t = 0
         IF l_gec07='Y' THEN
            IF g_apb[l_ac].apb09>0 THEN
               #LET l_sql = "SELECT rvv38t FROM ",li_dbs CLIPPED,"rvv_file ",
               LET l_sql = "SELECT rvv38t FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'), #FUN-A50102
                           " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
                           "   AND rvv02 = '",g_apb[l_ac].apb22,"' "
               CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
               CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102                
               PREPARE sel_rvv38t_cs1 FROM l_sql
               EXECUTE sel_rvv38t_cs1 INTO l_rvv38t 
               IF cl_null(l_rvv38t) THEN LET l_rvv38t=0 END IF
               LET l_apb24t = l_rvv38t*g_apb[l_ac].apb09
               LET l_apb24t = cl_digcut(l_apb24t,t_azi04)
               LET g_apb[l_ac].apb24 = l_apb24t/(1+l_gec04/100)  
            ELSE
               IF cl_null(l_rvv39t) THEN LET l_rvv39t=0 END IF
               LET l_rvv39t = cl_digcut(l_rvv39t,t_azi04)   #MOD-920013 
               LET g_apb[l_ac].apb24 = l_rvv39t/(1+l_gec04/100)
            END IF
         ELSE
            IF g_apb[l_ac].apb09>0 THEN
               LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09
            ELSE
               IF g_apb[l_ac].apb24 = 0 THEN
                  LET g_apb[l_ac].apb24 = l_rvv39
               END IF
            END IF
         END IF
 
         IF g_apb[l_ac].apb09 = 0 THEN
            LET g_apb[l_ac].apb24 = l_rvv39
         END IF
    
         LET g_apb[l_ac].apb24 =cl_digcut(g_apb[l_ac].apb24,t_azi04)   #MOD-6B0066
         LET g_apb[l_ac].apb10 =g_apb[l_ac].apb24 * g_apa.apa14        #MOD-840632   #MOD-860221 mark回復
         LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,g_azi04)   #MOD-6B0066
         DISPLAY BY NAME g_apb[l_ac].apb24
         DISPLAY BY NAME g_apb[l_ac].apb10
         IF g_apb[l_ac].apb29 = '3' AND g_aptype = '11' THEN
            LET g_apb[l_ac].apb24 = g_apb[l_ac].apb24 * -1
            LET g_apb[l_ac].apb10 = g_apb[l_ac].apb10 * -1
            LET g_apb[l_ac].apb09 = g_apb[l_ac].apb09 * -1    #No.TQC-7B0063 add
            DISPLAY BY NAME g_apb[l_ac].apb24,g_apb[l_ac].apb09,g_apb[l_ac].apb10      #No.TQC-7B0063
         END IF
         LET g_apb[l_ac].apb930=l_rvv930
         LET g_apb[l_ac].gem02c=s_costcenter_desc(g_apb[l_ac].apb930)
         DISPLAY BY NAME g_apb[l_ac].apb930,g_apb[l_ac].gem02c
      END IF   #MOD-850316 add
   END IF   #MOD-850316 add
END FUNCTION
 
FUNCTION t110_apb07(p_cmd)
   DEFINE p_cmd           LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_pmm22         LIKE pmm_file.pmm22
   DEFINE l_pmn07         LIKE pmn_file.pmn07
   DEFINE l_pmn86         LIKE pmn_file.pmn86   #FUN-560070
   DEFINE l_pmn40         LIKE pmn_file.pmn40
   DEFINE l_pmn041        LIKE pmn_file.pmn041
   DEFINE l_pmn930        LIKE pmn_file.pmn930  #FUN-670064
   DEFINE l_pmn16         LIKE pmn_file.pmn16   #MOD-8A0051
   DEFINE l_aag21         LIKE aag_file.aag21   #MOD-A40102 add
   DEFINE l_aag211        LIKE aag_file.aag21   #MOD-A40102 add
   DEFINE l_apb24         LIKE apb_file.apb24   #MOD-A30248 add
   DEFINE l_pmc913        LIKE pmc_file.pmc913  #MOD-A30248 add
   DEFINE l_apb24_1       LIKE apb_file.apb24   #FUN-BC0017 add
   DEFINE l_pmn31t        LIKE pmn_file.pmn31t  #yinhy140210
   DEFINE l_pmn87         LIKE pmn_file.pmn87   #yinhy140210
 
   LET g_errno = ' '
 
    LET l_sql = "SELECT pmn04,pmn041,pmn87,pmn86,pmn31,pmn87*pmn31,pmm22,",  
                "       pmn930,pmn16,pmn31t,pmn87",            #yinhy140210 add pmn31t,pmn87   
                #"  FROM ",li_dbs CLIPPED,"pmn_file,",li_dbs CLIPPED,"pmm_file",
                "  FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'),",", #FUN-A50102
                          cl_get_target_table(g_apb[l_ac].apb37,'pmm_file'),     #FUN-A50102
                " WHERE pmn01='",g_apb[l_ac].apb06,"' ",
#               "   AND pmn02='",g_apb[l_ac].apb07,"' ",    #TQC-AB0025 mark
                "   AND pmn02= ",g_apb[l_ac].apb07,         #TQC-AB0025 add
                "   AND pmm01=pmn01"
    CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
    CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
    PREPARE sel_pmn86_cs FROM l_sql
    EXECUTE sel_pmn86_cs INTO g_apb[l_ac].apb12,g_apb[l_ac].apb27,g_apb[l_ac].apb09,
                              g_apb[l_ac].apb28,g_apb[l_ac].apb23,g_apb[l_ac].apb24,
                              l_pmm22,g_apb[l_ac].apb930,l_pmn16,l_pmn31t,l_pmn87   #yinhy140210 add pmn31t

   CASE
      WHEN SQLCA.SQLCODE = 100
         LET g_errno = 'aap-092'
      WHEN l_pmn16 !='2'           #MOD-8A0051
         LET g_errno = 'aap-510'   #MOD-8A0051
      OTHERWISE
         LET g_errno = SQLCA.SQLCODE USING '-------'
   END CASE
  
  #No.yinhy140210  --Begin
  IF g_aptype = '15' THEN
  	 LET g_apb[l_ac].apb23 = l_pmn31t
  	 LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * l_pmn87
  END IF 
  #No.yinhy140210  --End
   
  #MOD-A30248---add---start---
   SELECT pmc913 INTO l_pmc913 FROM pmc_file 
    WHERE pmc01 = g_apa.apa05
   IF g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y') THEN
      SELECT SUM(apb24) INTO l_apb24 FROM apb_file,apa_file
       WHERE apa01=apb01
         AND apb01!=g_apa.apa01 AND apa42='N'
         AND apb06=g_apb[l_ac].apb06 AND apb07=g_apb[l_ac].apb07 
         AND apa00 = '15'                                         #No.MOD-B90194 add
      IF cl_null(l_apb24) THEN
         LET l_apb24=0
      END IF
      IF g_apb[l_ac].apb24 > l_apb24 THEN
         LET g_apb[l_ac].apb24 = g_apb[l_ac].apb24 - l_apb24
      ELSE
         LET g_apb[l_ac].apb24 = 0
         LET g_errno = 'aap-937'
         RETURN 
      END IF
     #qiull140806---mark---begin---
     ##No.FUN-BC0017  --Begin
     #SELECT SUM(apb24) INTO l_apb24_1 FROM apb_file,apa_file
     # WHERE apa01=apb01
     #   AND apb01!=g_apa.apa01            
     #   AND apa42='N'                                           
     #   AND apb06=g_apb[l_ac].apb06 
     #   AND apb07=g_apb[l_ac].apb07                
     #   AND apa00<>'16'                   
     #   AND apb29 = '1'                   
     #IF cl_null(l_apb24_1) THEN           
     #   LET l_apb24_1 = 0                
     #END IF                               
     #IF g_apb[l_ac].apb24 > l_apb24_1 THEN 
     #   LET g_apb[l_ac].apb24 = g_apb[l_ac].apb24 - l_apb24_1
     #ELSE
     #	 LET g_apb[l_ac].apb24 = 0
     #   LET g_errno = 'aap-170'
     #   RETURN
     #END IF
     ##No.FUN-BC0017  --End
     #qiull140806---mark---end----
   END IF
  #MOD-A30248---add---end---
 
   IF NOT cl_null(g_errno) THEN
      RETURN
   END IF
 
   IF g_apa.apa13 IS NULL THEN
      LET g_apa.apa13 = l_pmm22
   END IF
 
   IF l_pmm22 != g_apa.apa13 THEN                              # 幣別不符
      LET g_errno = 'aap-041' 
      CALL cl_err(l_pmm22,'aap-041',0)
      IF NOT cl_null(g_errno) THEN #MOD-9A0143                                                                                      
         RETURN                    #MOD-9A0143                                                                                      
      END IF                       #MOD-9A0143  
   END IF
 
   LET g_apb[l_ac].apb23 =cl_digcut(g_apb[l_ac].apb23,t_azi03)   #MOD-8B0266 add
   LET g_apb[l_ac].apb24 =cl_digcut(g_apb[l_ac].apb24,t_azi04)   #MOD-8B0266 add
   LET g_apb[l_ac].apb08 =g_apb[l_ac].apb23 * g_apa.apa14
   LET g_apb[l_ac].apb08 =cl_digcut(g_apb[l_ac].apb08,g_azi03)   #MOD-6B0066
   LET g_apb[l_ac].apb10 =g_apb[l_ac].apb24 * g_apa.apa14        #MOD-840632   #MOD-860221 mark回復
   LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,g_azi04)   #MOD-6B0066
   DISPLAY BY NAME g_apb[l_ac].apb23   #MOD-8B0266 add
   DISPLAY BY NAME g_apb[l_ac].apb24   #MOD-8B0266 add
   DISPLAY BY NAME g_apb[l_ac].apb08   #No.MOD-5A0095
   DISPLAY BY NAME g_apb[l_ac].apb10   #No.MOD-5A0095
   LET g_apb[l_ac].gem02c=s_costcenter_desc(g_apb[l_ac].apb930)
   DISPLAY BY NAME g_apb[l_ac].apb930,g_apb[l_ac].gem02c
  #MOD-A40102---add---start---
   SELECT aag21 INTO l_aag21 FROM aag_file
    WHERE aag01 = g_apa.apa51
      AND aag00 = g_bookno1  
      AND aagacti = 'Y'                         #No.MOD-B70280 add
   SELECT aag21 INTO l_aag211 FROM aag_file
    WHERE aag01 = g_apa.apa511
     #AND aag00 = g_bookno1                     #MOD-BC0239 mark
      AND aag00 = g_bookno2                     #MOD-BC0239 add
      AND aagacti = 'Y'                         #No.MOD-B70280 add
  #MOD-A40102---add---end---
  #IF l_aag21 = 'Y' THEN                                   #MOD-A40102 add #MOD-C70069 mark
   IF l_aag21 = 'Y' AND NOT cl_null(g_apa.apa51) THEN      #MOD-C70069 add
      LET g_apb[l_ac].apb25=g_apa.apa51                    #MOD-920170 add
      DISPLAY BY NAME g_apb[l_ac].apb25                    #MOD-920170 add
      LET g_apa.apa51=' '                                  #MOD-C70069 add
      LET g_a51 = NULL                                     #MOD-C70069 add
      DISPLAY BY NAME g_apa.apa51                          #MOD-C70069 add
      DISPLAY g_a51 TO FORMONLY.a51                        #MOD-C70069 add
   END IF                                                  #MOD-A40102 add 
  #IF l_aag211 = 'Y' THEN                                  #MOD-A40102 add #MOD-C70069 mark
   IF l_aag211 = 'Y' AND NOT cl_null(g_apa.apa511) THEN    #MOD-C70069 add
      LET g_apb[l_ac].apb251=g_apa.apa511
      DISPLAY BY NAME g_apb[l_ac].apb251
      LET g_apa.apa511=' '                                 #MOD-C70069 add
      LET g_a511 = NULL                                    #MOD-C70069 add
      DISPLAY BY NAME g_apa.apa51                          #MOD-C70069 add
      DISPLAY g_a51 TO FORMONLY.a511                       #MOD-C70069 add
   END IF                                                  #MOD-A40102 add 
END FUNCTION
 
FUNCTION t110_b_askkey()
DEFINE
    l_wc2           STRING   #MOD-720062
 
   IF g_apb_sarrno = 0 THEN
      RETURN
   END IF
 
   #CONSTRUCT l_wc2 ON apb02,apb21,apb35,apb36,apb31,apb22,apb34,apb06,apb07,   #FUN-630055 add apb31  #No.TQC-7B0083   #FUN-810045 add apb35/36 #MOD-C30737 mark--
   CONSTRUCT l_wc2 ON apb02,apb21,apb22,apb34,apb06,apb07,   #MOD-C30737 
                      apb12,apb27,   #CHI-B50012 add
                      apb09,apb31,apb25,apb26,apb35,apb36,apb23,apb24,apb08,apb10  #MOD-C30737 move apb31,apb35,apb36
                     ,apbud01,apbud02,apbud03,apbud04,apbud05
                     ,apbud06,apbud07,apbud08,apbud09,apbud10
                     ,apbud11,apbud12,apbud13,apbud14,apbud15
           FROM s_apb[1].apb02,s_apb[1].apb21,
                #s_apb[1].apb35,s_apb[1].apb36,  #FUN-810045 add  #MOD-C30737 mark--
                #s_apb[1].apb31,s_apb[1].apb22, #FUN-630055 add apb31 #MOD-C30737 mark--
                s_apb[1].apb22,    #MOD-C30737 move apb31
                s_apb[1].apb34,   #No.TQC-7B0083
                s_apb[1].apb06,s_apb[1].apb07,
                s_apb[1].apb12,s_apb[1].apb27,   #CHI-B50012 add
                s_apb[1].apb09,
                s_apb[1].apb31,   #MOD-C30737 move apb31
                s_apb[1].apb25,s_apb[1].apb26,s_apb[1].apb35,s_apb[1].apb36,s_apb[1].apb23,  #MOD-C30737 move apb35,apb36
                s_apb[1].apb24,s_apb[1].apb08,s_apb[1].apb10
               ,s_apb[1].apbud01,s_apb[1].apbud02,s_apb[1].apbud03
    	       ,s_apb[1].apbud04,s_apb[1].apbud05,s_apb[1].apbud06
               ,s_apb[1].apbud07,s_apb[1].apbud08,s_apb[1].apbud09
	       ,s_apb[1].apbud10,s_apb[1].apbud11,s_apb[1].apbud12
               ,s_apb[1].apbud13,s_apb[1].apbud14,s_apb[1].apbud15
 
              BEFORE CONSTRUCT
                 CALL cl_qbe_init()
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE CONSTRUCT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
 
                 ON ACTION qbe_select
         	   CALL cl_qbe_select()
                 ON ACTION qbe_save
		   CALL cl_qbe_save()
   END CONSTRUCT
 
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      RETURN
   END IF
   CALL t110_b_fill(l_wc2)
 
END FUNCTION
 
FUNCTION t110_b_fill(p_wc2)              #BODY FILL UP
DEFINE
   p_wc2           STRING     #MOD-720062
#DEFINE l_sum       LIKE type_file.num10       #FUN-CB0089   #mark by pulf 141226
 DEFINE l_sum       LIKE type_file.num15_3       #add by pulf 141226
 DEFINE l_sum1      LIKE type_file.num20_6       #add by lili 170723
 
   IF (g_aptype = '12' OR g_aptype = '13') AND l_apz59='N' THEN  #TQC-A40106 change g_apz.apz59->l_apz59
      CALL t110_misc_display() RETURN
   END IF
 
   IF g_apb_sarrno = 0 THEN
      RETURN
   END IF
 
   IF cl_null(p_wc2) THEN
      LET p_wc2='1=1'
   END IF
 
   LET g_sql = "SELECT apb02,apb33,apb11,apb29,apb37,apb21,apb22,apb34,'',",                           #FUN-680110 add '','' #No.FUN-690080  #No.TQC-7B0083  #FUN-9A0093 add apb37
               "       apb06,apb07,apb12,apb27,",  #FUN-630055 add apb31
               #"       apb09,apb28,apb35,apb36,apb31,apb32,'',apb25,'',apb251,'',apb26,'',apb930,'',apb23,apb24,apb08,apb10,",  #FUN-710078 add '','','' #FUN-670064   #No.FUN-680029 #No.FUN-690080  #No.FUN-830161 remove apb30  #FUN-990025 add '' #MOD-C30737 mark--
               "       apb09,apb28,apb31,apb32,'',apb25,'',apb251,'',apb26,'',apb35,apb36,apb930,'',apb23,apb24,apb08,apb10,", #MOD-C30737 move apb35,apb36 
               "       apbud01,apbud02,apbud03,apbud04,apbud05,",
               "       apbud06,apbud07,apbud08,apbud09,apbud10,",
               "       apbud11,apbud12,apbud13,apbud14,apbud15 ",
               " FROM apb_file",                                      
               " WHERE apb01 ='",g_apa.apa01,"' AND ", p_wc2 CLIPPED, 
               " ORDER BY apb02"
 
   PREPARE t110_pb FROM g_sql
   DECLARE apb_curs CURSOR FOR t110_pb
 
   CALL g_apb.clear()
   LET g_cnt = 1
   LET l_sum = 0     #FUN-CB0089
   LET l_sum1 = 0    #add by lili 170723
   FOREACH apb_curs INTO g_apb[g_cnt].*   #單身 ARRAY 填充
      IF SQLCA.sqlcode THEN
         CALL cl_err('foreach:',SQLCA.sqlcode,1)
         EXIT FOREACH
      END IF
      #單身數量合計
      LET l_sum = l_sum + g_apb[g_cnt].apb09   #FUN-CB0089
      LET l_sum1 = l_sum1 + g_apb[g_cnt].apb10  #add by lili 170723 金额合计
      SELECT aag02 INTO g_apb[g_cnt].b25 
        FROM aag_file 
       WHERE aag01=g_apb[g_cnt].apb25 
         AND aag00=g_bookno1   #MOD-840649
         AND aagacti = 'Y'                         #No.MOD-B70280 add
 
      SELECT aag02 INTO g_apb[g_cnt].b251 
        FROM aag_file 
       WHERE aag01=g_apb[g_cnt].apb251 
         AND aag00=g_bookno2   #MOD-840649
         AND aagacti = 'Y'                         #No.MOD-B70280 add
 
#FUN-D80031 --------- mark  ------ begin
#     SELECT gem02 INTO g_apb[g_cnt].b26
#       FROM gem_file
#      WHERE gem01=g_apb[g_cnt].apb26
#FUN-D80031 --------- mark  ------ end
#FUN-D80031 --------- add --------- begin
     IF g_prog = 'aapt140' THEN
        SELECT occ02 INTO g_apb[g_cnt].b26
          FROM occ_file
         WHERE occ01 = g_apb[g_cnt].apb26
     ELSE
        SELECT gem02 INTO g_apb[g_cnt].b26
          FROM gem_file
         WHERE gem01=g_apb[g_cnt].apb26
     END IF
#FUN-D80031 --------- add --------- end

#FUN-990025 --------------------add start---------------------------
      SELECT gen02 INTO g_apb[g_cnt].b32                                         
       FROM gen_file                                                            
      WHERE gen01=g_apb[g_cnt].apb32 
#FUN-990025 -------------------add end-----------------------------     
 
      #暫估帳款單號
      LET g_apb[g_cnt].apb01_unap=t110_set_apb01_unap(g_apb[g_cnt].apb21,g_apb[g_cnt].apb22,g_apb[g_cnt].apb34)
      LET g_apb[g_cnt].gem02c=t110_set_apa930(g_apb[g_cnt].apb930) #FUN-670064
      LET g_cnt = g_cnt + 1
      IF g_cnt > g_max_rec THEN
         CALL cl_err( '', 9035, 0 )
         EXIT FOREACH
      END IF
   END FOREACH
   CALL g_apb.deleteElement(g_cnt)
 
   LET g_rec_b = g_cnt - 1
   DISPLAY g_rec_b TO FORMONLY.n2
   #FUN-CB0089---add--str
   IF g_apa.apa00 = '11' THEN     
      DISPLAY l_sum TO SUM
      DISPLAY l_sum1 TO sum1   #add by lili 170723     
   END IF   
   #FUN-CB0089---add--end
END FUNCTION
 
FUNCTION t110_bp(p_ud)
   DEFINE   p_ud   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
 
   IF p_ud <> "G" OR g_action_choice = "detail" THEN
      RETURN
   END IF
 
   LET g_action_choice = " "
   IF g_aptype <> '16' THEN   #TQC-7B0117
      CALL cl_set_act_visible("qry_contra_tmp_est",FALSE)
   END IF
 
   CALL cl_set_act_visible("maintain_misc_vender",FALSE)
   IF g_aza.aza63 ='N' THEN
      CALL cl_set_act_visible("entry_sheet2,T_T_entry_sheet2",FALSE)   #FUN-830091
   END IF
 
   IF                    g_aptype = '15' OR g_aptype = '17' THEN  #No.FUN-690080
      CALL cl_set_act_visible("contra_tmp_est",FALSE)
   END IF
 
   IF g_aptype = '11' THEN                                       #No.FUN-860004
      CALL cl_set_act_visible("reproduce",FALSE)
   END IF
 
   IF g_aptype = '13' THEN
      CALL cl_set_act_visible("contra_tmp_est,qry_bill_allowance",FALSE)
   ELSE
      CALL cl_set_act_visible("revert,revert_query",FALSE)
   END IF
  #No.FUN-D70028 ---Add--- Start
   IF g_aptype <> '14' THEN
      CALL cl_set_act_visible("expenses",FALSE)
   END IF
  #No.FUN-D70028 ---Add--- End
   IF g_aptype = '17' THEN
      CALL cl_set_act_visible("contra_tmp_est,var_process,qry_contra_tmp_est,qry_bill_allowance",FALSE)
   END IF
 
   CALL cl_set_act_visible("revert",FALSE) #No.TQC-7C0134
 
   CALL cl_set_act_visible("accept,cancel", FALSE)
  CALL cl_set_act_visible("var_process",true)
 
   DISPLAY ARRAY g_apb TO s_apb.* ATTRIBUTE(COUNT=g_rec_b,UNBUFFERED)
 
      BEFORE DISPLAY
         CALL cl_navigator_setting( g_curs_index, g_row_count )
 
         IF (g_aptype = '12' OR g_aptype ='13') AND l_apz59='N' THEN  #TQC-A40106 change g_apz.apz59->l_apz59
            CALL cl_reset_local_action("detail",FALSE)
         END IF
         IF g_aptype = '15' OR                      #FUN-7A0050
            g_aptype = '13' OR g_aptype = '17' THEN
            CALL cl_set_comp_visible("apb21",FALSE)
         END IF
 
         IF g_aptype = '13' OR g_aptype = '17' THEN
            CALL cl_set_comp_visible("apb11,apb29,apb21,apb22,apb06,apb07,apb12,apb27,apb09,apb28,apb23,apb08",FALSE)
            IF g_aptype = '17' THEN
               CALL cl_set_comp_visible("apb33",true) # add by quan 0613
               
            END IF
         ELSE
            CALL cl_set_comp_visible("apb33,apb32,b32",FALSE)        #FUN-810045   #FUN-990025 add b32
         END IF
         CALL cl_set_comp_visible("apb051,apb251",g_aza.aza63='Y')
 
      BEFORE ROW
         LET l_ac = ARR_CURR()
         CALL cl_show_fld_cont()
      #FUN-CB0080--add--str--
      ON ACTION item_list
         LET g_bp_flag = 'list'      #FUN-D60015 add
         LET g_action_choice = "" 
         CALL t110_b_menu()
         CALL cl_set_act_visible("accept,cancel", FALSE)
         LET g_action_choice = "" 
      #FUN-CB0080--add--end   
         
      ON ACTION locale
         CALL cl_dynamic_locale()
         CALL cl_show_fld_cont()   #FUN-550037(smin)
         CALL t110_misc_clear()   #MOD-750064
         IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF
         CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,g_apa.apaacti)
         LET g_action_choice = 'locale'
         EXIT DISPLAY
      ON ACTION insert
         LET g_action_choice="insert"
         EXIT DISPLAY
      ON ACTION query
         LET g_action_choice="query"
         EXIT DISPLAY
      ON ACTION delete
         LET g_action_choice="delete"
         EXIT DISPLAY
      ON ACTION modify
         LET g_action_choice="modify"
         EXIT DISPLAY
      ON ACTION account_period
         LET g_action_choice="account_period"
         EXIT DISPLAY
 
      ON ACTION first
         CALL t110_fetch('F')
         CALL cl_navigator_setting(g_curs_index, g_row_count)
         IF g_rec_b != 0 THEN
             CALL fgl_set_arr_curr(1)
         END IF
         ACCEPT DISPLAY    #FUN-550037(smin)
 
      ON ACTION previous
         LET g_action_choice="previous"
          CALL t110_fetch('P')     #MOD-490490
         CALL cl_navigator_setting(g_curs_index, g_row_count)
         IF g_rec_b != 0 THEN
             CALL fgl_set_arr_curr(1)
         END IF
         ACCEPT DISPLAY    #FUN-550037(smin)
 
      ON ACTION jump
         LET g_action_choice="jump"
         CALL t110_fetch('/')
         CALL cl_navigator_setting(g_curs_index, g_row_count)
         IF g_rec_b != 0 THEN
             CALL fgl_set_arr_curr(1)
         END IF
         ACCEPT DISPLAY    #FUN-550037(smin)
 
      ON ACTION next
         LET g_action_choice="next"
         CALL t110_fetch('N')
         CALL cl_navigator_setting(g_curs_index, g_row_count)
         IF g_rec_b != 0 THEN
             CALL fgl_set_arr_curr(1)
         END IF
         ACCEPT DISPLAY    #FUN-550037(smin)
 
      ON ACTION last
         LET g_action_choice="last"
         CALL t110_fetch('L')
         CALL cl_navigator_setting(g_curs_index, g_row_count)
         IF g_rec_b != 0 THEN
             CALL fgl_set_arr_curr(1)
         END IF
         ACCEPT DISPLAY    #FUN-550037(smin)
 
      ON ACTION reproduce
         LET g_action_choice="reproduce"
         EXIT DISPLAY
      ON ACTION detail
         LET g_action_choice="detail"
         LET l_ac = 1
         EXIT DISPLAY
      ON ACTION output
         LET g_action_choice="output"
         EXIT DISPLAY
      ON ACTION help
         LET g_action_choice="help"
         EXIT DISPLAY
      ON ACTION exit
         LET g_action_choice="exit"
         EXIT DISPLAY
      ON ACTION controlg
         LET g_action_choice="controlg"
         EXIT DISPLAY
      ON ACTION accept
         LET g_action_choice="detail"
         LET l_ac = ARR_CURR()
         EXIT DISPLAY
      ON ACTION cancel
         LET INT_FLAG=FALSE 		#MOD-570244	mars
         LET g_action_choice="exit"
         EXIT DISPLAY
 
      ON ACTION on_hold      #留置
         LET g_action_choice="on_hold"
         EXIT DISPLAY
 
      ON ACTION undo_on_hold #取消留置
         LET g_action_choice="undo_on_hold"
         EXIT DISPLAY
 
      ON ACTION mul_invoice  #多發票
         LET g_action_choice="mul_invoice"
         EXIT DISPLAY
 
      ON ACTION single_invoice
         LET g_action_choice="single_invoice"
         EXIT DISPLAY
 
      ON ACTION mul_debit #多借方
         LET g_action_choice="mul_debit"
         EXIT DISPLAY
 
      ON ACTION contra_tmp_est #沖暫估
         LET g_action_choice="contra_tmp_est"
         EXIT DISPLAY
 
      ON ACTION memo #備註
         LET g_action_choice="memo"
         EXIT DISPLAY
 
      ON ACTION var_process #差異處理
         LET g_action_choice="var_process"
         EXIT DISPLAY
 
      ON ACTION contra #沖帳
         LET g_action_choice="contra"
         EXIT DISPLAY

     #No.FUN-D70028 ---Add--- Start
      ON ACTION expenses #沖賬扣費用
         LET g_action_choice="expenses"
         EXIT DISPLAY
     #No.FUN-D70028 ---Add--- End

     #No.FUN-D80031 add ------ begin
      ON ACTION to_be_accounted  #生成待抵帳扣費用單
         LET g_action_choice="to_be_accounted"
         EXIT DISPLAY
     #No.FUN-D80031 add ------ end
 
      ON ACTION revert #還款
         LET g_action_choice="revert"
         EXIT DISPLAY
 
      ON ACTION revert_query #還款查詢
         LET g_action_choice="revert_query"
         EXIT DISPLAY
 
      ON ACTION modify_date #日期修正
         LET g_action_choice="modify_date"
         EXIT DISPLAY

      ON ACTION pay_direct #直接付款
         LET g_action_choice="pay_direct"
         EXIT DISPLAY
 
      ON ACTION gen_entry #會計分錄產生
         LET g_action_choice="gen_entry"
         EXIT DISPLAY
 
      ON ACTION entry_sheet #分錄底稿
         LET g_action_choice="entry_sheet"
         EXIT DISPLAY
 
      ON ACTION entry_sheet2 #分錄底稿
         LET g_action_choice="entry_sheet2"
         EXIT DISPLAY
 
      ON ACTION T_T_entry_sheet #分錄底稿
         LET g_action_choice="T_T_entry_sheet"
         EXIT DISPLAY
 
      ON ACTION T_T_entry_sheet2 #分錄底稿2
         LET g_action_choice="T_T_entry_sheet2"
         EXIT DISPLAY
 
      ON ACTION carry_voucher #傳票拋轉  
         LET g_action_choice="carry_voucher"  
         EXIT DISPLAY
 
      ON ACTION undo_carry_voucher #傳票拋轉還原 
         LET g_action_choice="undo_carry_voucher" 
         EXIT DISPLAY
 
      ON ACTION appor_expense
         LET g_action_choice="appor_expense"
         EXIT DISPLAY
 
      ON ACTION qry_contra_tmp_est
         LET g_action_choice="qry_contra_tmp_est"
         EXIT DISPLAY
 
      ON ACTION qry_bill_allowance
         LET g_action_choice="qry_bill_allowance"
         EXIT DISPLAY
 
      ON ACTION qry_contra #沖帳查詢
         LET g_action_choice="qry_contra"
         EXIT DISPLAY
 
     ON ACTION easyflow_approval         #FUN-550042
       LET g_action_choice = "easyflow_approval"
       EXIT DISPLAY
 
      ON ACTION confirm #確認
         LET g_action_choice="confirm"
         EXIT DISPLAY
 
      ON ACTION undo_confirm #取消確認
         LET g_action_choice="undo_confirm"
         EXIT DISPLAY
 
      ON ACTION void #作廢
         LET g_action_choice="void"
         EXIT DISPLAY
      
      #FUN-D20035---add---str
      ON ACTION undo_void #取消作廢
         LET g_action_choice="undo_void"
         EXIT DISPLAY 
      #FUN-D20035---add---end 
 
      ON ACTION maintain_misc_vender
         LET g_action_choice="qry_vender"
         EXIT DISPLAY
 
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE DISPLAY
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION exporttoexcel
         LET g_action_choice = 'exporttoexcel'
         EXIT DISPLAY
 
      ON ACTION agree
         LET g_action_choice = 'agree'
         EXIT DISPLAY
 
      ON ACTION deny
         LET g_action_choice = 'deny'
         EXIT DISPLAY
 
      ON ACTION modify_flow
         LET g_action_choice = 'modify_flow'
         EXIT DISPLAY
 
      ON ACTION withdraw
         LET g_action_choice = 'withdraw'
         EXIT DISPLAY
 
      ON ACTION org_withdraw
         LET g_action_choice = 'org_withdraw'
         EXIT DISPLAY
 
      ON ACTION phrase
         LET g_action_choice = 'phrase'
         EXIT DISPLAY
 
       ON ACTION approval_status     #MOD-4C0041
         LET g_action_choice="approval_status"
         EXIT DISPLAY
 
      ON ACTION related_document                #No.FUN-6A0016  相關文件
         LET g_action_choice="related_document"          
         EXIT DISPLAY
 
      AFTER DISPLAY
        CONTINUE DISPLAY
      
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
 
      &include "qry_string.4gl"
#No.FUN-A30106 --begin                                                          
      ON ACTION drill_down                                                      
         LET g_action_choice="drill_down"                                       
         EXIT DISPLAY                                                           
#No.FUN-A30106 --end 
 
   END DISPLAY
   CALL cl_set_act_visible("accept,cancel", TRUE)
 
END FUNCTION
 
FUNCTION t210_bp(p_ud)
 
   DEFINE   p_ud   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
 
   IF p_ud <> "G" OR g_action_choice = "detail" THEN
      RETURN
   END IF
 
   LET g_action_choice = " "
 
   CALL cl_set_act_visible("accept,cancel", FALSE)
   IF g_aza.aza23 matches '[ Nn]' THEN
     CALL cl_set_act_visible("easyflow_approval,approval_status",FALSE)
   END IF
 
   #CALL cl_set_act_visible("mul_invoice", FALSE)   #MOD-790057 #CHI-A40005 mark
   IF g_aza.aza63 ='N' THEN
      CALL cl_set_act_visible("entry_sheet2,T_T_entry_sheet2",FALSE)   #FUN-830091
   END IF
   DISPLAY ARRAY g_apb TO s_apb.* ATTRIBUTE(COUNT=g_rec_b)
 
      BEFORE DISPLAY
         CALL cl_navigator_setting( g_curs_index, g_row_count )
 
         IF g_aptype = '15' OR                      #FUN-7A0050
            g_aptype = '13' OR g_aptype = '17' THEN
            CALL cl_set_comp_visible("apb21",FALSE)
         END IF
 
 
      BEFORE ROW
         LET l_ac = ARR_CURR()
         CALL cl_show_fld_cont()     #FUN-550037(smin)
      #FUN-CB0080--add--str--
      ON ACTION item_list
         LET g_bp_flag = 'list'      #FUN-D60015 add
         LET g_action_choice = ""
         CALL t210_b_menu()
         CALL cl_set_act_visible("accept,cancel", FALSE)
         LET g_action_choice = ""
      #FUN-CB0080--add--end 
      ON ACTION locale
         CALL cl_dynamic_locale()
         CALL cl_show_fld_cont()   #FUN-550037(smin)
         LET g_chr2= 'N'
         CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,g_apa.apaacti)
         LET g_action_choice = 'locale'
         EXIT DISPLAY
      ON ACTION insert
         LET g_action_choice="insert"
         EXIT DISPLAY
      ON ACTION query
         LET g_action_choice="query"
         EXIT DISPLAY
      ON ACTION delete
         LET g_action_choice="delete"
         EXIT DISPLAY
      ON ACTION modify
         LET g_action_choice="modify"
         EXIT DISPLAY
      ON ACTION first
         LET g_action_choice="first"
         EXIT DISPLAY
         ACCEPT DISPLAY    #FUN-550037(smin)
      ON ACTION previous
         LET g_action_choice="previous"
         EXIT DISPLAY
         ACCEPT DISPLAY    #FUN-550037(smin)
      ON ACTION jump
         LET g_action_choice="jump"
         EXIT DISPLAY
         ACCEPT DISPLAY    #FUN-550037(smin)
      ON ACTION next
         LET g_action_choice="next"
         EXIT DISPLAY
         ACCEPT DISPLAY    #FUN-550037(smin)
      ON ACTION last
         LET g_action_choice="last"
         EXIT DISPLAY
         ACCEPT DISPLAY    #FUN-550037(smin)
      ON ACTION detail
         LET g_action_choice="detail"
         LET l_ac = 1
         EXIT DISPLAY
      ON ACTION help
         LET g_action_choice="help"
         EXIT DISPLAY
      ON ACTION exit
         LET g_action_choice="exit"
         EXIT DISPLAY
      ON ACTION account_period
         LET g_action_choice="account_period"
         EXIT DISPLAY
      ON ACTION output
         LET g_action_choice="output"
         EXIT DISPLAY
 
      ON ACTION controlg
         LET g_action_choice="controlg"
         EXIT DISPLAY
 
      ON ACTION contra_tmp_est #沖暫估
         LET g_action_choice="contra_tmp_est"
         EXIT DISPLAY
 
      ON ACTION gen_entry #會計分錄產生
         LET g_action_choice="gen_entry"
         EXIT DISPLAY
 
      ON ACTION entry_sheet #分錄底稿
         LET g_action_choice="entry_sheet"
         EXIT DISPLAY
 
      ON ACTION entry_sheet2 #分錄底稿
         LET g_action_choice="entry_sheet2"
         EXIT DISPLAY
 
      ON ACTION T_T_entry_sheet #分錄底稿
         LET g_action_choice="T_T_entry_sheet"
         EXIT DISPLAY
 
      ON ACTION T_T_entry_sheet2 #分錄底稿2
         LET g_action_choice="T_T_entry_sheet2"
         EXIT DISPLAY
 
      ON ACTION carry_voucher #傳票拋轉  
         LET g_action_choice="carry_voucher"  
         EXIT DISPLAY
 
      ON ACTION undo_carry_voucher #傳票拋轉還原 
         LET g_action_choice="undo_carry_voucher" 
         EXIT DISPLAY
 
      ON ACTION void #作廢
         LET g_action_choice="void"
         EXIT DISPLAY
    
      #FUN-D20035---add---str
      ON ACTION undo_void #取消作廢 
         LET g_action_choice="undo_void"
         EXIT DISPLAY
      #FUN-D20035---add---end
 
      ON ACTION on_hold #留置
         LET g_action_choice="on_hold"
         EXIT DISPLAY
 
      ON ACTION undo_on_hold #取消留置
         LET g_action_choice="undo_on_hold"
         EXIT DISPLAY
 
      ON ACTION mul_invoice #多發票
         LET g_action_choice="mul_invoice"
         EXIT DISPLAY
 
     ON ACTION invoice_detail  #發票明細
        LET g_action_choice="invoice_detail"
        EXIT DISPLAY

     #MOD-9C0437---add---start---
      ON ACTION single_invoice
         LET g_action_choice="single_invoice"
         EXIT DISPLAY
     #MOD-9C0437---add---end---
 
      ON ACTION qry_contra #沖帳查詢
         LET g_action_choice="qry_contra"
         EXIT DISPLAY
 
      ON ACTION memo #備註
         LET g_action_choice="memo"
         EXIT DISPLAY
      #FUN-BC0031  --Begin
      ON ACTION var_process #差異處理
         LET g_action_choice="var_process"
         EXIT DISPLAY
      #FUN-BC0031  --Begin
      ON ACTION easyflow_approval         #FUN-550042
         LET g_action_choice = "easyflow_approval"
         EXIT DISPLAY
 
      ON ACTION confirm #確認
         LET g_action_choice="confirm"
         EXIT DISPLAY
 
      ON ACTION undo_confirm #取消確認
         LET g_action_choice="undo_confirm"
         EXIT DISPLAY
 
      ON ACTION accept
         LET g_action_choice="detail"
         LET l_ac = ARR_CURR()
         EXIT DISPLAY
 
      ON ACTION cancel
             LET INT_FLAG=FALSE 		#MOD-570244	mars
         LET g_action_choice="exit"
         EXIT DISPLAY
 
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE DISPLAY
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION exporttoexcel
         LET g_action_choice = 'exporttoexcel'
         EXIT DISPLAY
 
      ON ACTION agree
         LET g_action_choice = 'agree'
         EXIT DISPLAY
 
      ON ACTION deny
         LET g_action_choice = 'deny'
         EXIT DISPLAY
 
      ON ACTION modify_flow
         LET g_action_choice = 'modify_flow'
         EXIT DISPLAY
 
      ON ACTION withdraw
         LET g_action_choice = 'withdraw'
         EXIT DISPLAY
 
      ON ACTION org_withdraw
         LET g_action_choice = 'org_withdraw'
         EXIT DISPLAY
 
      ON ACTION phrase
         LET g_action_choice = 'phrase'
         EXIT DISPLAY
 
       ON ACTION approval_status     #MOD-4C0041
         LET g_action_choice="approval_status"
         EXIT DISPLAY
 
      ON ACTION related_document                #No.FUN-6A0016  相關文件
         LET g_action_choice="related_document"          
         EXIT DISPLAY
 
      AFTER DISPLAY
        CONTINUE DISPLAY
      
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
 
      &include "qry_string.4gl"
#No.FUN-A30106 --begin                                                          
      ON ACTION drill_down                                                      
         LET g_action_choice="drill_down"                                       
         EXIT DISPLAY                                                           
#No.FUN-A30106 --end 
      
   END DISPLAY
   CALL cl_set_act_visible("accept,cancel", TRUE)
END FUNCTION
 
 
FUNCTION t110_copy()
DEFINE   li_result   LIKE type_file.num5    #No.FUN-690028 SMALLINT
DEFINE
   l_apa        RECORD LIKE apa_file.*,
   l_apb        RECORD LIKE apb_file.*,
   l_t1            LIKE apa_file.apa01,
   l_oldno,l_newno LIKE aba_file.aba01,
   l_date          LIKE apa_file.apa02,
   l_apb02         LIKE apb_file.apb02      #No.FUN-860004
DEFINE   l_sql     String                   #No.TQC-7B0098
DEFINE   l_apc     RECORD LIKE apc_file.*   #No.TQC-7B0098
DEFINE   g_t1      LIKE oay_file.oayslip    #FUN-990014 add
DEFINE   l_apa02   LIKE apa_file.apa02      #MOD-A50098
DEFINE   l_paydate LIKE type_file.dat       #MOD-A50098
DEFINE   l_apb23   LIKE apb_file.apb23      #MOD-AB0069
DEFINE   l_apb24   LIKE apb_file.apb24      #MOD-AB0069
DEFINE   l_apb08   LIKE apb_file.apb08      #MOD-AB0069
DEFINE   l_apb081  LIKE apb_file.apb081     #MOD-AB0069
DEFINE   l_apb10   LIKE apb_file.apb10      #MOD-AB0069
DEFINE   l_apb101  LIKE apb_file.apb101     #MOD-AB0069
 
   IF s_aapshut(0) THEN
      RETURN
   END IF
 
   IF cl_null(g_apa.apa01)  THEN
       CALL cl_err('',-400,0)
       RETURN
   END IF
 
   LET l_apa.* = g_apa.*
   LET g_apa_t.* = g_apa.*       #BACKUP  #MOD-B40036  
   INITIALIZE g_apa_o.* TO NULL      #MOD-AB0069
   LET g_apa_o.apa14 = g_apa.apa14   #MOD-AB0069 
   LET l_apa.apa173 = ''             #MOD-B90110
   LET l_apa.apa174 = ''             #MOD-B90110
   LET l_apa.apa175 = ''             #MOD-B90110 
   BEGIN WORK                        #MOD-BC0238 add
   LET g_before_input_done = FALSE   #FUN-570158
   CALL t110_set_entry('a')          #FUN-570158
   CALL t110_set_entry_1()     #No.FUN-8A0075
   LET g_before_input_done = TRUE    #FUN-570158

WHILE TRUE                           #MOD-BC0238 add
   CALL cl_set_head_visible("","YES")#No.FUN-6B0033
  #INPUT l_date,l_newno FROM apa02,apa01            #MOD-BC0238 mark
   INPUT l_newno,l_date FROM apa01,apa02            #MOD-BC0238 add
       BEFORE INPUT
          CALL cl_set_docno_format("apa01")
       #modi 01/08/10 (先輸入日期，以輸入日期取單號)
       BEFORE FIELD apa02
          LET l_date = g_today
          DISPLAY l_date TO apa02
 
       AFTER FIELD apa02
          IF NOT cl_null(l_date) THEN
             CALL t110_bookno()     #No.FUN-730064
             #FUN-B50090 add begin-------------------------
             #重新抓取關帳日期
             SELECT apz57 INTO g_apz.apz57 FROM apz_file WHERE apz00='0'
             #FUN-B50090 add -end--------------------------
             IF l_date <= g_apz.apz57 THEN   #立帳日期不可小於關帳日期
                CALL cl_err('','aap-176',1) NEXT FIELD apa02
             END IF
         #END IF    #MOD-A50098 mark
         #-MOD-A50098-add-
             LET l_apa.apa09 = l_date 
             LET g_apa.apa09 = l_date 
             
             IF g_aptype[1,1] = '1' AND   
                 g_apa.apa11 IS NOT NULL AND
                 l_date != l_apa02 AND l_apa02 IS NOT NULL THEN       
                IF g_aptype = '13' OR g_aptype = '17' THEN
                   CALL s_paydate('a','',g_apa.apa09,l_date,g_apa.apa11,'EMPL')
                        RETURNING l_paydate,l_apa.apa64,l_apa.apa24
                ELSE
                   CALL s_paydate('a','',g_apa.apa09,l_date,g_apa.apa11,g_apa.apa06)
                        RETURNING l_paydate,l_apa.apa64,l_apa.apa24
                END IF
                IF NOT cl_null(g_errno) THEN
                   CALL cl_err(g_apa.apa01,g_errno,0)
                  #LET l_apa.apa64 = g_apa_t.apa64            #MOD-C50253 mark
                  #LET l_apa.apa24 = g_apa_t.apa24            #MOD-C50253 mark
                   LET g_apa.apa64 = g_apa_t.apa64            #MOD-C50253 add
                   LET g_apa.apa24 = g_apa_t.apa24            #MOD-C50253 add
                ELSE
                  #LET l_apa.apa12 = l_paydate                #MOD-C50253 mark
                   LET g_apa.apa12 = l_paydate                #MOD-C50253 add
                END IF
               #---------------------MOD-C50253----------------------(S)
                CALL s_duedate(g_apa.apa06,g_apa.apa12,g_apa.apa24)
                     RETURNING g_apa.apa64
               #---------------------MOD-C50253----------------------(E)
                DISPLAY BY NAME g_apa.apa24,g_apa.apa12,g_apa.apa64
               #CHI-AB0017 add --start--
               IF g_apa.apa24 < 0 THEN
                  IF NOT cl_confirm('aap-142') THEN NEXT FIELD apa02 END IF
               END IF
               #CHI-AB0017 add --end--
             END IF
             IF l_date != l_apa02 THEN     
               #LET g_apa.apa02 = l_date        #MOD-AB0038                        #MOD-AB0069 mark 
               #CALL t110_apa13('u')                                               #MOD-AB0069 mark 
                CALL s_curr3(l_apa.apa13,l_date,g_apz.apz33) RETURNING g_apa.apa14 #MOD-AB0069  
                LET l_apa.apa14 = g_apa.apa14   #MOD-AB0038 
                DISPLAY BY NAME g_apa.apa14                                        #MOD-AB0069
#----------------No.MOD-B70202-------------------------------------------------start
                IF l_apa.apa14 != g_apa_t.apa14 THEN
                   IF NOT t110_apa14(g_apa.apa01) THEN
                      NEXT FIELD apa02 
                   END IF
                END IF
#----------------No.MOD-B70202-------------------------------------------------end
             END IF
          END IF
          LET l_apa02 = l_date 
         #-MOD-A50098-end-
 
      #NO.FUN-CB0019  --Begin
      BEFORE FIELD apa01
         IF cl_null(l_newno) THEN
            CALL s_get_slip('aap','apy_file','apyslip','apykind','apyacti',g_aptype,'')
                 RETURNING l_newno
            DISPLAY l_newno TO apa01
         END IF
      #NO.FUN-CB0019  --End

       AFTER FIELD apa01
          IF NOT cl_null(l_newno) THEN
            LET l_t1=l_newno[1,g_doc_len]
            #-->讀取單據性質資料
            SELECT * INTO g_apy.* FROM apy_file
             WHERE apyslip=l_t1 AND apyacti = 'Y' AND apykind=g_apa.apa00
            IF SQLCA.sqlcode THEN
               CALL cl_err3("sel","apy_file",l_t1,"","agl-035","","",1)  #No.FUN-660122
               NEXT FIELD apa01
            END IF
#------------------------MOD-BC0238-------------------------------------------------mark
           #IF g_apy.apyauno='Y' THEN
           #   BEGIN WORK
           #   CALL s_auto_assign_no("aap",l_t1,l_date,g_apa.apa00,"apa_file","apa01","","","")
           #     RETURNING li_result,l_newno
           #   IF NOT li_result THEN
           #      LET INT_FLAG = 1
           #      EXIT INPUT
           #   END IF
           #END IF
#------------------------MOD-BC0238-------------------------------------------------mark
            SELECT count(*) INTO g_cnt FROM apa_file WHERE apa01 = l_newno
            IF g_cnt > 0 THEN
               CALL cl_err(l_newno,-239,0)
               NEXT FIELD apa01
            END IF
           #---------------------MOD-CA0106---------------(S)
            CALL s_check_no("aap",l_newno,'',g_aptype,"apa_file","apa01","")
            RETURNING li_result,l_newno
            IF (NOT li_result) THEN
               NEXT FIELD apa01
            END IF
           #---------------------MOD-CA0106---------------(E)
          END IF
 
       ON ACTION CONTROLP
          CASE
             WHEN INFIELD(apa01) #查詢單据
                LET l_t1=s_get_doc_no(l_newno)
                CALL q_apy(FALSE,FALSE,l_t1,g_aptype,'AAP') RETURNING l_t1    #TQC-670008
                LET l_newno=l_t1
                DISPLAY l_newno TO apa01
                NEXT FIELD apa01
           END CASE
 
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
 
      AFTER INPUT
      IF INT_FLAG THEN
         LET INT_FLAG = 0
         DISPLAY BY NAME g_apa.apa01
         ROLLBACK WORK
         LET g_apa.* = g_apa_t.*       #MOD-B40036
         RETURN
      END IF
      IF cl_null(l_newno) THEN
         NEXT FIELD apa01
      END IF
   END INPUT
 
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      DISPLAY BY NAME g_apa.apa01
      ROLLBACK WORK
      LET g_apa.* = g_apa_t.*       #MOD-B40036
      RETURN
   END IF
#------------------------MOD-BC0238-------------------------------------------------start
   IF g_apy.apyauno='Y' THEN
      CALL s_auto_assign_no("aap",l_t1,l_date,g_apa.apa00,"apa_file","apa01","","","")
           RETURNING li_result,l_newno
      IF NOT li_result THEN
         CONTINUE WHILE
      END IF
      DISPLAY l_newno TO apa01
     #EXIT WHILE                          #MOD-CA0106 mark
   END IF
   EXIT WHILE                             #MOD-CA0106 add
END WHILE
#------------------------MOD-BC0238---------------------------------------------------end 

   LET l_apa.apa01  =l_newno   #新的鍵值
   IF cl_null(l_apa.apa01) THEN
      RETURN
   END IF
   LET l_apa.apa02  =l_date
   IF g_aptype!='16' THEN   #MOD-940158 add
      LET l_apa.apa08 = ''
      LET l_apa.apa09 = ''  #MOD-970221     
   END IF                   #MOD-940158 add
  #-MOD-AB0069-add-
   IF g_apa_o.apa14 <> l_apa.apa14 THEN     
      LET l_apa.apa31 = l_apa.apa31f * l_apa.apa14
      LET l_apa.apa31 = cl_digcut(l_apa.apa31,g_azi04)   
      LET l_apa.apa32 = l_apa.apa31 * l_apa.apa16 / 100
      LET l_apa.apa32 = cl_digcut(l_apa.apa32,g_azi04)  
      LET l_apa.apa34 = l_apa.apa31 + l_apa.apa32 - l_apa.apa60 - l_apa.apa61
                                                  - l_apa.apa65 + l_apa.apa37
      LET l_apa.apa34 = cl_digcut(l_apa.apa34,g_azi04)   
   END IF
  #-MOD-AB0069-end-
   LET l_apa.apa12 = g_apa.apa12               #MOD-CB0104 add
   LET l_apa.apa24 = g_apa.apa24               #MOD-CB0104 add
   LET l_apa.apa19  = ' '
   LET l_apa.apa20  = 0
   LET l_apa.apa35f = 0
   LET l_apa.apa35  = 0
  #-MOD-AB0069-add-
   LET l_apa.apa57 = l_apa.apa31
   LET l_apa.apa57f = l_apa.apa31f
   LET g_apa.apa57 = l_apa.apa57
   DISPLAY BY NAME g_apa.apa57
  #-MOD-AB0069-end-
   LET l_apa.apa60  = 0
   LET l_apa.apa61  = 0
   LET l_apa.apa60f = 0
   LET l_apa.apa64 = g_apa.apa64               #MOD-CB0104 add
   LET l_apa.apa61f = 0
   LET l_apa.apa65  = 0
   LET l_apa.apa65f = 0
   LET l_apa.apa55  = '1'
  #LET l_apa.apainpd=g_user       #MOD-A50086 mark
   LET l_apa.apainpd=g_today      #MOD-A50086 add
   LET l_apa.apa43  = NULL
   LET l_apa.apa44  = NULL
   LET l_apa.apa56  = 0
   LET l_apa.apa58  = NULL
   LET l_apa.apa59  = NULL
   LET l_apa.apa41  = 'N'
   LET l_apa.apa42  = 'N'
   LET l_apa.apa74  = 'N'
   LET l_apa.apa75 = 'N'
   LET l_apa.apaprno= 0        #列印次數
   LET l_apa.apauser=g_user    #資料所有者
   LET l_apa.apagrup=g_grup    #資料所有者所屬群
   LET l_apa.apamodu=NULL      #資料修改日期
   LET l_apa.apadate=g_today   #資料建立日期
   LET l_apa.apaacti='Y'       #有效資料
   LET l_apa.apa72=l_apa.apa14
   LET l_apa.apa73=l_apa.apa34-l_apa.apa35
   LET l_apa.apa77=g_apa.apa77  #FUN-970108 add
     LET l_apa.apa63 = '0'
     LET l_apa.apamksg = g_apy.apyapr
   LET l_apa.apa100 = g_plant     #FUN-960141 090824 add
   LET l_apa.apalegal=g_legal    #FUN-980001 add
   LET l_apa.apaoriu = g_user   #TQC-A10060 add
   LET l_apa.apaorig = g_grup   #TQC-A10060 add
   LET l_apa.apa79 ='0'         #No.FUN-A40003   #No.FUN-A60024
   IF g_aptype = '16' THEN                                                                                                          
      LET l_apa.apa57f = 0                                                                                                          
      LET l_apa.apa57 = 0                                                                                                           
      SELECT SUM(apb24),SUM(apb10) INTO l_apa.apa57f,l_apa.apa57                                                                    
        FROM apb_file                                                                                                               
       WHERE apb01=g_apa.apa01                                                                                                      
         AND apb21 IS NULL                                                                                                          
      IF cl_null(l_apa.apa57f) THEN                                                                                                 
         LET l_apa.apa57f = 0                                                                                                       
      END IF                                                                                                                        
      IF cl_null(l_apa.apa57) THEN                                                                                                  
         LET l_apa.apa57 = 0                                                                                                        
      END IF                                                                                                                        
   END IF                                                                                                                           
   CALL s_get_doc_no(l_apa.apa01) RETURNING g_t1
   SELECT apyvcode INTO l_apa.apa77  FROM apy_file WHERE apyslip = g_t1   
     IF cl_null(l_apa.apa77) THEN 
        LET l_apa.apa77 = g_apz.apz63  #FUN-970108 add
     END IF     
   LET l_apa.apaoriu = g_user      #No.FUN-980030 10/01/04
   LET l_apa.apaorig = g_grup      #No.FUN-980030 10/01/04
   INSERT INTO apa_file VALUES (l_apa.*)
   IF SQLCA.sqlcode THEN
      CALL cl_err3("ins","apa_file",l_apa.apa01,"",SQLCA.sqlcode,"","ins apa:",1)  #No.FUN-660122
      ROLLBACK WORK
      LET g_apa.* = g_apa_t.*       #MOD-B40036
      RETURN
   ELSE
      LET l_sql = "SELECT * FROM apc_file",
                  " WHERE apc01 = '",g_apa.apa01,"'"
      PREPARE t110_apc_p1 FROM l_sql
      DECLARE t110_apc_c1 CURSOR FOR t110_apc_p1
      OPEN t110_apc_c1
      FOREACH t110_apc_c1 INTO l_apc.*
         IF STATUS THEN
            CALL cl_err('foreach:',STATUS,1)
            ROLLBACK WORK
            LET g_apa.* = g_apa_t.*       #MOD-B40036
            RETURN
         END IF
         LET l_apc.apc01 = l_apa.apa01
         LET l_apc.apc10 = 0
         LET l_apc.apc11 = 0 
         LET l_apc.apc12 = ''
         LET l_apc.apc13 = l_apc.apc09 - l_apc.apc11
         LET l_apc.apc14 = 0
         LET l_apc.apc15 = 0 
         LET l_apc.apc16 = 0
         LET l_apc.apclegal = g_legal #FUN-980001 add
         INSERT INTO apc_file VALUES (l_apc.*)
         IF SQLCA.sqlcode THEN
            CALL cl_err3("ins","apc_file",l_apc.apc01,"",SQLCA.sqlcode,"","ins apc:",1)
            ROLLBACK WORK
            LET g_apa.* = g_apa_t.*       #MOD-B40036
            RETURN
         END IF
      END FOREACH
      COMMIT WORK
   END IF
 
   DROP TABLE x
 
   IF g_aptype = '16' THEN
      SELECT * FROM apb_file
       WHERE apb01=g_apa.apa01
         AND apb21 IS NULL
        INTO TEMP x
   ELSE
      SELECT * FROM apb_file 
       WHERE apb01=g_apa.apa01
        INTO TEMP x
   END IF 
 
   IF SQLCA.sqlcode THEN
      CALL cl_err3("ins","x","","",SQLCA.sqlcode,"","",1)        #No.FUN-660122
      RETURN
   END IF
 
   UPDATE x SET apb01=l_newno
 
  #-MOD-AB0069-mark- 
  #IF g_aptype = '16' THEN
  #LET i =1
  #LET l_sql ="SELECT apb02 FROM x WHERE apb01=l_newno ORDER BY apb02 "
  #PREPARE t110_apb_pb1 FROM l_sql                                                                                                       
  #DECLARE apb_curs1 CURSOR FOR t110_apb_pb1
  #FOREACH apb_curs1 INTO l_apb02
  #        UPDATE x SET apb02 = i WHERE apb02 = l_apb02
  #        LET i = i+1
  #END FOREACH  
  #END IF      
  #-MOD-AB0069-end- 
 
   INSERT INTO apb_file SELECT * FROM x
   IF SQLCA.sqlcode THEN
      CALL cl_err3("ins","apb_file",l_newno,"",SQLCA.sqlcode,"","ins apb:",1)  #No.FUN-660122
      RETURN
   END IF
 
   LET g_cnt=SQLCA.SQLERRD[3]
   MESSAGE '(',g_cnt USING '##&',') ROW of (',l_newno,') O.K'
  #-MOD-AB0069-add- 
   IF g_aptype = '16' OR (g_apa_o.apa14 <> l_apa.apa14) THEN 
      LET i =1
      LET l_sql ="SELECT apb02,apb23,apb24 FROM apb_file WHERE apb01='",l_newno,"' ORDER BY apb02 "  
      PREPARE t110_apb_pb2 FROM l_sql                                                                                                       
      DECLARE apb_curs2 CURSOR FOR t110_apb_pb2
      FOREACH apb_curs2 INTO l_apb02,l_apb23,l_apb24 
         LET l_apb08 = l_apb23 * l_apa.apa14
         LET l_apb08 = cl_digcut(l_apb08,g_azi03)   
         LET l_apb10 = l_apb24 * l_apa.apa14   
         LET l_apb10 = cl_digcut(l_apb10,g_azi04)   
         LET l_apb081= l_apb08
         LET l_apb101= l_apb10
         UPDATE apb_file SET apb02 = i,apb08 = l_apb08,apb10 = l_apb10,apb081 = l_apb08,apb101 = l_apb10
          WHERE apb01 = l_newno 
            AND apb02 = l_apb02 
         LET i = i+1
      END FOREACH  
   END IF      
  #-MOD-AB0069-end- 
 
   DROP TABLE y
 
   SELECT * FROM api_file         #多借方複製
    WHERE api01=g_apa.apa01
     INTO TEMP y
   IF SQLCA.sqlcode THEN
      CALL cl_err3("ins","y","","",SQLCA.sqlcode,"","",1)  #No.FUN-660122
      RETURN
   END IF
 
   UPDATE y SET api01=l_newno
 
   INSERT INTO api_file SELECT * FROM y
   IF SQLCA.sqlcode THEN
      CALL cl_err3("ins","api_file",l_newno,"",SQLCA.sqlcode,"","ins api:",1)  #No.FUN-660122
      RETURN
   END IF
 
   LET g_cnt=SQLCA.SQLERRD[3]
   MESSAGE '(',g_cnt USING '##&',') ROW of (',l_newno,') O.K'
 
   LET l_oldno = g_apa.apa01
 
   SELECT apa_file.* INTO g_apa.* FROM apa_file
    WHERE apa01 = l_newno
 
   CALL t110_u()
 
   #SELECT apa_file.* INTO g_apa.* FROM apa_file #FUN-C30027
   # WHERE apa01 = l_oldno                       #FUN-C30027
 
   CALL t110_show()
 
END FUNCTION
 
 
FUNCTION t110_misc_clear()
   DEFINE i,j,k     LIKE type_file.num5    #No.FUN-690028 SMALLINT
 
   IF (g_aptype = '12' OR g_aptype = '13') AND l_apz59='N' THEN  #No.FUN-690080  #TQC-A40106 change g_apz.apz59->l_apz59
      CALL t110_set_attr()
   END IF
 
END FUNCTION
 
 
 
FUNCTION t110_misc_display()
  DEFINE l_apk     RECORD LIKE apk_file.*
  DEFINE l_api     RECORD LIKE api_file.*
  DEFINE l_str     ARRAY[40] OF LIKE type_file.chr1000     # No.FUN-690028 VARCHAR(77)
  DEFINE i,j,k     LIKE type_file.num5    #No.FUN-690028 SMALLINT
 
  CALL g_apb.clear()
  LET i=1
  DECLARE m1_c CURSOR FOR
   SELECT apk03,apk04,apk08,apk171 FROM apk_file WHERE apk01=g_apa.apa01
  FOREACH m1_c INTO g_apb[i].apb12,
                    g_apb[i].apb27,
                    g_apb[i].apb09,
                    g_apb[i].apb28
     LET g_apb[i].apb02=i
     LET i=i+1
     LET g_apb[i].apb09 = s_digqty(g_apb[i].apb09,g_apb[i].apb28)   #FUN-910088--add--
  END FOREACH
  LET i=1
  DECLARE m2_c CURSOR FOR
   SELECT api04[1,20],api07,api05 FROM api_file
    WHERE api01=g_apa.apa01
      AND api02='1'
  FOREACH m2_c INTO g_apb[i].apb25,
                    g_apb[i].apb26,
                    g_apb[i].apb23
     LET g_apb[i].apb02=i
     LET i=i+1
  END FOREACH
 #LET g_rec_b=g_apb.getLength()          #MOD-A50098 mark
  LET g_rec_b=g_apb.getLength() - 1      #MOD-A50098
  DISPLAY g_rec_b TO FORMONLY.n2
  DISPLAY ' '     TO apa57
END FUNCTION
 
FUNCTION t110_out(p_cmd)
   DEFINE l_cmd              LIKE type_file.chr1000, #No.FUN-690028 VARCHAR(400)
          l_wc    STRING, #MOD-720062
          l_wc2   LIKE type_file.chr1000,   #MOD-720062
          l_prtway      LIKE zz_file.zz22,
          p_cmd         LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
 
   CALL cl_wait()
   LET p_cmd= 'a'
   IF p_cmd= 'a'
   THEN LET l_wc = 'apa01="',g_apa.apa01,'"'           # "新增"則印單張
   ELSE LET l_wc = g_wc CLIPPED,                         # 其他則印多張
                   '   AND apa00 = "',g_aptype,'"'
        IF g_wc IS NULL THEN
           CALL cl_err('','9057',0) END IF
   END IF
   SELECT zz22 INTO l_prtway FROM zz_file WHERE zz01 = g_prog
   IF SQLCA.sqlcode OR l_wc2 IS NULL OR l_wc = ' ' THEN
      IF g_apa.apa00='11' THEN
         LET l_wc2 = " 'Y' 'N' 'N' 'N' 'N' '1' '3'"
      END IF
      IF g_apa.apa00='12' THEN
         LET l_wc2 = " 'Y' 'N' 'N' 'N' 'N' '2' '3'"
      END IF
      IF g_apa.apa00='15' THEN
         LET l_wc2 = " 'Y' 'N' 'N' 'N' 'Y' '3' '3'"  #MOD-550108
      END IF
      IF g_apa.apa00='13' THEN
         LET l_wc2 = " 'Y' 'N' 'N' 'N' 'Y' '5' '3'"  #MOD-550108   #MOD-7C0201
      END IF
      IF g_apa.apa00='17' THEN
         LET l_wc2 = " 'Y' 'N' 'N' 'N' 'Y' '4' '3'"  #MOD-550108   #MOD-7C0201
      END IF
   END IF
   IF g_apa.apa08 = 'MISC' THEN
      LET l_wc2 = l_wc2[1,5],"'Y'",l_wc2[9,28]
   END IF
   LET l_cmd = "aapr111 ",
               " '",g_today CLIPPED,"' ''",
               " '",g_lang CLIPPED,"' 'Y' '",l_prtway,"' '1'",   #MOD-670075
               " '",l_wc CLIPPED,"'",l_wc2 clipped   #NO.MOD-5B0135   #MOD-670075
 
   CALL cl_cmdrun(l_cmd)
   ERROR ' '
END FUNCTION

#FUNCTION t110_bu(u_sw,r_sw) #FUN-CB0054 mark
FUNCTION t110_bu(u_sw,r_sw,p_type) #FUN-CB0054 add #p_type=0單獨報錯,p_type=1匯總報錯
   DEFINE u_sw,r_sw           LIKE type_file.num5        # No.FUN-690028 SMALLINT
   DEFINE p_type              LIKE type_file.chr1  #FUN-CB0054
   
   IF g_aptype='11' THEN CALL t110_bu_11(u_sw,r_sw,p_type) END IF  #FUN-CB0054 add p_type
  #IF g_aptype='21' AND g_apa.apa58='2' THEN CALL t110_bu_21(u_sw,r_sw) END IF #MOD-AA0116 mark
   IF g_aptype='21' THEN CALL t110_bu_21(u_sw,r_sw,p_type) END IF  #MOD-AA0116 #FUN-CB0054 add p_type
   IF g_aptype='16' THEN CALL t110_bu_11(u_sw,r_sw,p_type) END IF  #FUN-CB0054 add p_type
  #IF g_aptype='26' AND g_apa.apa58='2' THEN CALL t110_bu_21(u_sw,r_sw) END IF #MOD-AA0116 mark
   IF g_aptype='26' THEN CALL t110_bu_21(u_sw,r_sw,p_type) END IF   #MOD-AA0116 #FUN-CB0054 add p_type
 
END FUNCTION
 
FUNCTION t110_bu_11(u_sw,r_sw,p_type)  #FUN-CB0054 add p_type
   DEFINE l_rvv03                 LIKE rvv_file.rvv03 #FUN-660117
   DEFINE u_sw,r_sw               LIKE type_file.num5        # No.FUN-690028 SMALLINT
#  DEFINE l_qty,l_qty2            LIKE ima_file.ima26      # No.FUN-690028 DEC(15,3)  #FUN-4B0079
   DEFINE l_qty,l_qty2            LIKE type_file.num15_3   #No.FUN-A20044
   DEFINE l_qty_rvv88             LIKE rvv_file.rvv23      #No.TQC-7B0083
   DEFINE l_qty_rvv23_rvv88       LIKE rvv_file.rvv23      #No.TQC-7B0083
   DEFINE l_rvv40                 LIKE rvv_file.rvv40      #No.TQC-750181
   DEFINE l_apb09                 LIKE apb_file.apb09      #No.TQC-750181
   DEFINE l_n                     LIKE type_file.num5      #No.TQC-750181
   DEFINE l_qty3                  LIKE rvv_file.rvv23      #No.TQC-7B0083
   DEFINE l_qty_rvv88_3           LIKE rvv_file.rvv23      #No.TQC-7B0083
   DEFINE l_qty_rvv23_rvv88_3     LIKE rvv_file.rvv23      #No.TQC-7B0083
   DEFINE l_qty4                  LIKE rvv_file.rvv23      #FUN-9A0093
   DEFINE l_qty5                  LIKE rvv_file.rvv23      #FUN-9A0093
   DEFINE l_qty6                  LIKE rvv_file.rvv23      #FUN-9A0093
   DEFINE l_qty7                  LIKE rvv_file.rvv23      #FUN-9A0093
   DEFINE p_type                  LIKE type_file.chr1      #FUN-CB0054
   
   IF u_sw = 1 AND r_sw = 1 AND g_apb_t.apb21 = g_apb[l_ac].apb21
      AND g_apb_t.apb22 = g_apb[l_ac].apb22 THEN
      LET u_sw = 1
      LET r_sw = 0
   END IF
 
   IF u_sw = 1 THEN
     #-MOD-B10211-add-
     #FUN-B50019 --begin
     #IF cl_null(g_apb04) OR cl_null(g_apb[l_ac].apb21) THEN
     #   RETURN
     #END IF
     #FUN-B50019 --end
     #-MOD-B10211-end-
      LET l_qty=0 LET l_qty2=0
      IF NOT cl_null(g_apb04) AND NOT cl_null(g_apb05) THEN #FUN-B50019
         SELECT SUM(apb09) INTO l_qty FROM apb_file,apa_file
          WHERE apb04 = g_apb04 AND apb05 = g_apb05
            AND apb01 = apa01 AND apa00 = '11'
            AND apa42 = 'N'
            AND apb29 = '1'  #TQC-7B0083
         IF STATUS THEN
            IF p_type='0' THEN  #FUN-CB0054
            CALL cl_err3("sel","apb_file,apa_file",g_apb04,g_apb05,STATUS,"","sum(apb09)",1)  #No.FUN-660122
            #FUN-CB0054--add--str--
            ELSE
               LET g_showmsg=g_apb04,'/',g_apb05 
               CALL s_errmsg('apb04,apb05',g_showmsg,'sum(apb09)',STATUS,1) 
            END IF
            #FUN-CB0054--add--end
            LET g_success='N'
         END IF
 
         IF l_qty IS NULL THEN
            LET l_qty = 0
         END IF
 
         CALL t110_rvb06_1(g_apb04,g_apb05) 
              RETURNING l_qty_rvv88,l_qty_rvv23_rvv88
 
         LET l_qty4 = l_qty+l_qty_rvv88-l_qty_rvv23_rvv88
         #LET l_sql = "UPDATE ",li_dbs CLIPPED,"rvb_file ",
        LET l_sql = "UPDATE ",cl_get_target_table(g_apb[l_ac].apb37,'rvb_file'), #FUN-A50102
                     "   SET rvb06 ='", l_qty4,"' ",
                     " WHERE rvb01 ='", g_apb04,"' ",
                     "   AND rvb02 ='", g_apb05,"' "
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
         PREPARE upd_rvb_pre FROM l_sql
         EXECUTE upd_rvb_pre
         IF STATUS OR SQLCA.SQLCODE THEN
            IF p_type='0' THEN  #FUN-CB0054
            CALL cl_err3("upd","rvb_file",g_apb04,g_apb05,SQLCA.sqlcode,"","upd rvb06",1)  #No.FUN-660122
            #FUN-CB0054--add--str--
            ELSE
               LET g_showmsg=g_apb04,'/',g_apb05
               CALL s_errmsg('rvb01,rvb02',g_showmsg,'upd rvb06',SQLCA.sqlcode,1) 
            END IF
            #FUN-CB0054--add--end
            LET g_success='N'
         END IF
      END IF #FUN-B50019
 
      LET l_qty=0
 
      IF NOT cl_null(g_apb[l_ac].apb21) AND NOT cl_null(g_apb[l_ac].apb22) THEN #FUN-B50019
         SELECT SUM(apb09) INTO l_qty FROM apb_file,apa_file
          WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
            AND apb01 = apa01 AND apa00 = '11'
            AND apa42 = 'N'
         IF STATUS THEN
            IF p_type='0' THEN  #FUN-CB0054
            CALL cl_err3("sel","apb_file,apa_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,STATUS,"","sum(apb09)",1)  #No.FUN-660122
            #FUN-CB0054--add--str--
            ELSE
               LET g_showmsg=g_apb[l_ac].apb21,'/',g_apb[l_ac].apb22
               CALL s_errmsg('apb21,apb22',g_showmsg,'sum(apb09)',STATUS,1)
            END IF
            #FUN-CB0054--add--end
            LET g_success='N'
         END IF
 
         IF l_qty IS NULL THEN
            LET l_qty = 0
         END IF
 
         IF l_qty < 0 THEN
            LET l_qty = l_qty * -1
         END IF
 
         #若性質apb29='3'的倉退作業,則要額外select 21
         LET l_qty3 = 0
         SELECT SUM(apb09) INTO l_qty3 FROM apb_file,apa_file
          WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
            AND apb01 = apa01 AND apa00 = '21'
            AND apa42 = 'N'
         IF STATUS THEN
            IF p_type='0' THEN  #FUN-CB0054
            CALL cl_err3("sel","apb_file,apa_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,STATUS,"","sum(apb09)",1)  #No.FUN-660122
            #FUN-CB0054--add--str--
            ELSE
               LET g_showmsg=g_apb[l_ac].apb21,'/',g_apb[l_ac].apb22
               CALL s_errmsg('apb21,apb22',g_showmsg,'sum(apb09)',STATUS,1)
            END IF
            #FUN-CB0054--add--end
            LET g_success='N'
         END IF
 
         IF l_qty3 IS NULL THEN
            LET l_qty3 = 0
         END IF
 
         LET l_qty = l_qty + l_qty3
         #LET l_sql = "SELECT SUM(ale06) FROM ",li_dbs CLIPPED,"ale_file ",
         LET l_sql = "SELECT SUM(ale06) FROM ",cl_get_target_table(g_apb[l_ac].apb37,'ale_file'), #FUN-A50102
                     " WHERE ale16 = '",g_apb[l_ac].apb21,"' ",
                     "   AND ale17 = '",g_apb[l_ac].apb22,"' "
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
         PREPARE sel_ale06_pre FROM l_sql
         EXECUTE sel_ale06_pre INTO l_qty2 
         IF STATUS THEN
            IF p_type='0' THEN  #FUN-CB0054
            CALL cl_err3("sel","ale_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,STATUS,"","sum(ale06)",1)  #No.FUN-660122
            #FUN-CB0054--add--str--
            ELSE
               LET g_showmsg=g_apb[l_ac].apb21,'/',g_apb[l_ac].apb22
               CALL s_errmsg('ale16,ale17',g_showmsg,'sum(ale06)',STATUS,1)
            END IF
            #FUN-CB0054--add--end 
            LET g_success='N'
         END IF
 
         IF l_qty2 IS NULL THEN
            LET l_qty2 = 0
         END IF
 
         LET l_qty=l_qty+l_qty2
 
         CALL t110_rvv23_rvv88(g_apb[l_ac].apb21,g_apb[l_ac].apb22,'11','16')
              RETURNING l_qty_rvv88,l_qty_rvv23_rvv88
         CALL t110_rvv23_rvv88(g_apb[l_ac].apb21,g_apb[l_ac].apb22,'21','26')
              RETURNING l_qty_rvv88_3,l_qty_rvv23_rvv88_3
         LET l_qty_rvv88 = l_qty_rvv88 + l_qty_rvv88_3
         LET l_qty_rvv23_rvv88 = l_qty_rvv23_rvv88 + l_qty_rvv23_rvv88_3

         LET l_qty5 = l_qty_rvv88 - l_qty_rvv23_rvv88 

         #费用UNAP时,入库单为空,则不能更新rvv_file
         IF (cl_null(g_apb[l_ac].apb21) OR cl_null(g_apb[l_ac].apb22)) AND g_apa.apa08 = 'UNAP' THEN         #No.MOD-9C0207
         ELSE           #No.MOD-9C0207
            #LET l_sql = "UPDATE ",li_dbs CLIPPED," rvv_file ",
            LET l_sql = "UPDATE ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'), #FUN-A50102
                        "   SET rvv23 = '",l_qty,"' ,",
                        "       rvv88 = '",l_qty5,"' ",
                        " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
                        "   AND rvv02 =  ",g_apb[l_ac].apb22         #No.MOD-9C0207
         END IF         #No.MOD-9C0207
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102
         PREPARE upd_rvv_pre FROM l_sql
         EXECUTE upd_rvv_pre
         IF STATUS OR SQLCA.SQLCODE THEN
            IF p_type='0' THEN  #FUN-CB0054
            CALL cl_err3("upd","rvv_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,SQLCA.sqlcode,"","upd rvv23",1)  #No.FUN-660122
            #FUN-CB0054--add--str--
            ELSE
               LET g_showmsg=g_apb[l_ac].apb21,'/',g_apb[l_ac].apb22
               CALL s_errmsg('rvv01,rvv02',g_showmsg,'upd rvv23',SQLCA.sqlcode,1)
            END IF
            #FUN-CB0054--add--end
            LET g_success='N'
         END IF
      END IF #FUN-B50019
   END IF
 
   IF r_sw = 1 THEN
     #-MOD-B10211-add-
     #FUN-B50019 --begin
     #IF cl_null(g_apb04_t) OR cl_null(g_apb_t.apb21) THEN
     #   RETURN
     #END IF
     #FUN-B50019 --end
     #-MOD-B10211-end-
      LET l_qty=0 LET l_qty2=0
      IF NOT cl_null(g_apb04_t) AND NOT cl_null(g_apb05_t) THEN #FUN-B50019
         SELECT SUM(apb09) INTO l_qty FROM apb_file,apa_file
          WHERE apb04 = g_apb04_t AND apb05 = g_apb05_t
            AND apb01 = apa01 AND apa00 = '11'
            AND apa42 = 'N'
            AND apb29 = '1'   #No.TQC-7B0083
         IF STATUS THEN
            IF p_type='0' THEN  #FUN-CB0054
            CALL cl_err3("sel","apb_file,apa_file",g_apb04_t,g_apb05_t,STATUS,"","sum(apb09)",1)  #No.FUN-660122
            #FUN-CB0054--add--str--
            ELSE
               LET g_showmsg=g_apb04_t,'/',g_apb05_t
               CALL s_errmsg('apb04,apb05',g_showmsg,'sum(apb09)',STATUS,1)
            END IF
            #FUN-CB0054--add--end
            LET g_success='N'
         END IF
 
         IF l_qty IS NULL THEN
            LET l_qty = 0
         END IF
 
         CALL t110_rvb06_1(g_apb04_t,g_apb05_t)
              RETURNING l_qty_rvv88,l_qty_rvv23_rvv88
 
         LET l_qty6 = l_qty + l_qty_rvv88 - l_qty_rvv23_rvv88
         #LET l_sql = "UPDATE ",li_dbs CLIPPED,"rvb_file ",
         LET l_sql = "UPDATE ",cl_get_target_table(g_apb[l_ac].apb37,'rvb_file'), #FUN-A50102
                     "   SET rvb06 = '",l_qty6,"' ",
                     " WHERE rvb01 = '",g_apb04_t,"' ",
                     "   AND rvb02 =  ",g_apb05_t         #No.MOD-9C0207
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
         PREPARE upd_rvb_pre1 FROM l_sql
         EXECUTE upd_rvb_pre1 
         IF STATUS OR SQLCA.SQLCODE THEN
            IF p_type='0' THEN  #FUN-CB0054
            CALL cl_err3("upd","rvb_file",g_apb04_t,g_apb05_t,SQLCA.sqlcode,"","upd rvb06",1)  #No.FUN-660122
            #FUN-CB0054--add--str--
            ELSE
               LET g_showmsg=g_apb04_t,'/',g_apb05_t      
               CALL s_errmsg('rvb01,rvb02',g_showmsg,'upd rvb06',SQLCA.sqlcode,1)
            END IF
            #FUN-CB0054--add--end
            LET g_success='N'
         END IF
      END IF  #FUN-B50019
 
      LET l_qty=0
 
      IF NOT cl_null(g_apb_t.apb21) AND NOT cl_null(g_apb_t.apb22) THEN #FUN-B50019
         SELECT SUM(apb09) INTO l_qty FROM apb_file,apa_file
          WHERE apb21 = g_apb_t.apb21 AND apb22 = g_apb_t.apb22
            AND apb01 = apa01 AND apa00 = '11'
            AND apa42 = 'N'
         IF STATUS THEN
            IF p_type='0' THEN  #FUN-CB0054
            CALL cl_err3("sel","apb_file,apa_file",g_apb_t.apb21,g_apb_t.apb22,STATUS,"","sum(apb09)",1)  #No.FUN-660122
            #FUN-CB0054--add--str--
            ELSE
               LET g_showmsg=g_apb_t.apb21,'/',g_apb_t.apb22
               CALL s_errmsg('apb21,apb22',g_showmsg,'sum(apb09)',STATUS,1)
            END IF
            #FUN-CB0054--add--end
            LET g_success='N'
         END IF
 
         IF l_qty IS NULL THEN
            LET l_qty = 0
         END IF
 
         IF l_qty < 0 THEN
            LET l_qty = l_qty * -1
         END IF
 
         #倉退,要額外select 21
         LET l_qty3=0
 
         SELECT SUM(apb09) INTO l_qty3 FROM apb_file,apa_file
          WHERE apb21 = g_apb_t.apb21 AND apb22 = g_apb_t.apb22
            AND apb01 = apa01 AND apa00 = '21'
            AND apa42 = 'N'
         IF STATUS THEN
            IF p_type='0' THEN  #FUN-CB0054
            CALL cl_err3("sel","apb_file,apa_file",g_apb_t.apb21,g_apb_t.apb22,STATUS,"","sum(apb09)",1)  #No.FUN-660122
            #FUN-CB0054--add--str--
            ELSE
               LET g_showmsg=g_apb_t.apb21,'/',g_apb_t.apb22
               CALL s_errmsg('apb21,apb22',g_showmsg,'sum(apb09)',STATUS,1)
            END IF
            #FUN-CB0054--add--end
            LET g_success='N'
         END IF
 
         IF l_qty3 IS NULL THEN
            LET l_qty3 = 0
         END IF
        
         LET l_qty = l_qty + l_qty3
 
         #LET l_sql = "SELECT SUM(ale06) FROM ",li_dbs CLIPPED,"ale_file,",
         #             li_dbs CLIPPED,"alk_file",
         LET l_sql = "SELECT SUM(ale06) FROM ",cl_get_target_table(g_apb[l_ac].apb37,'ale_file'),",", #FUN-A50102
                                               cl_get_target_table(g_apb[l_ac].apb37,'alk_file'),     #FUN-A50102
                     " WHERE alk01 = ale01 AND ale16 = '",g_apb_t.apb21,"' ",
                     "   AND ale17 = '",g_apb_t.apb22,"' ",
                     "   AND alkfirm = 'Y' "
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
         PREPARE sel_ale06_pre2 FROM l_sql
         EXECUTE sel_ale06_pre2 INTO l_qty2
         IF STATUS THEN
            IF p_type='0' THEN  #FUN-CB0054
            CALL cl_err3("sel","ale_file,alk_file",g_apb_t.apb21,g_apb_t.apb22,STATUS,"","sum(ale06)",1)  #No.FUN-660122
            #FUN-CB0054--add--str--
            ELSE
               LET g_showmsg=g_apb_t.apb21,'/',g_apb_t.apb22
               CALL s_errmsg('ale16,ale17',g_showmsg,'sum(ale06)',STATUS,1)
            END IF
            #FUN-CB0054--add--end
            LET g_success='N'
         END IF
 
         IF l_qty2 IS NULL THEN
            LET l_qty2 = 0
         END IF
 
         LET l_qty=l_qty+l_qty2
 
         CALL t110_rvv23_rvv88(g_apb_t.apb21,g_apb_t.apb22,'11','16')
              RETURNING l_qty_rvv88,l_qty_rvv23_rvv88
         CALL t110_rvv23_rvv88(g_apb_t.apb21,g_apb_t.apb22,'21','26')
              RETURNING l_qty_rvv88_3,l_qty_rvv23_rvv88_3
         LET l_qty_rvv88 = l_qty_rvv88 + l_qty_rvv88_3
         LET l_qty_rvv23_rvv88 = l_qty_rvv23_rvv88 + l_qty_rvv23_rvv88_3
 
         LET l_qty7 = l_qty_rvv88 - l_qty_rvv23_rvv88
         #LET l_sql = "UPDATE ",li_dbs CLIPPED,"rvv_file ",
         LET l_sql = "UPDATE ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'), #FUN-A50102
                     "   SET rvv23 = '",l_qty,"' ,",
                     "       rvv88 = '",l_qty7,"' ", 
                     " WHERE rvv01 = '",g_apb_t.apb21,"' ",
                     "   AND rvv02 =  ",g_apb_t.apb22         #No.MOD-9C0207
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102               
         PREPARE upd_rvv_pre4 FROM l_sql
         EXECUTE upd_rvv_pre4 
         IF STATUS OR SQLCA.SQLCODE THEN
            IF p_type='0' THEN  #FUN-CB0054
            CALL cl_err3("upd","rvv_file",g_apb_t.apb21,g_apb_t.apb22,SQLCA.sqlcode,"","upd rvv23",1)  #No.FUN-660122
            #FUN-CB0054--add--str--
            ELSE
               LET g_showmsg=g_apb_t.apb21,'/',g_apb_t.apb22
               CALL s_errmsg('rvv01,rvv02',g_showmsg,'upd rvv23',STATUS,1)
            END IF
            #FUN-CB0054--add--end
            LET g_success='N'
         END IF
      END IF  #FUN-B50019
 
   END IF
 
END FUNCTION
 
FUNCTION t110_bu_21(u_sw,r_sw,p_type)  #FUN-CB0054 add p_type
   DEFINE u_sw,r_sw            LIKE type_file.num5        # No.FUN-690028 SMALLINT
#  DEFINE l_qty                LIKE ima_file.ima26      # No.FUN-690028 DEC(15,3)  #FUN-4B0079 #FUN-A20044
   DEFINE l_qty                LIKE type_file.num15_3     #No.FUN-A20044
   DEFINE l_qty_rvv88          LIKE rvv_file.rvv23        #No.TQC-7B0083
   DEFINE l_qty_rvv23_rvv88    LIKE rvv_file.rvv23        #No.TQC-7B0083
   DEFINE l_qty1               LIKE rvv_file.rvv23        #FUN-9A0093
   DEFINE l_qty2               LIKE rvv_file.rvv23        #FUN-9A0093 
   DEFINE p_type               LIKE type_file.chr1        #FUN-CB0054
   
   IF u_sw = 1 AND r_sw = 1 AND g_apb_t.apb21 = g_apb[l_ac].apb21 AND
      g_apb_t.apb22 = g_apb[l_ac].apb22 THEN
      LET u_sw = 1
      LET r_sw = 0
   END IF
      
   IF u_sw = 1 THEN
      IF NOT cl_null(g_apb[l_ac].apb21) AND NOT cl_null(g_apb[l_ac].apb22) THEN   #CHI-B30009 add
         SELECT SUM(apb09) INTO l_qty FROM apb_file,apa_file
          WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
            #AND apb01 = apa01 AND apa00 = '21'                  #MOD-BC0054
            AND apb01 = apa01 AND (apa00 = '21' OR apa00='11')   #MOD-BC0054
            AND apa42 = 'N' #no.4182
         IF STATUS THEN
            IF p_type='0' THEN  #FUN-CB0054
            CALL cl_err3("sel","apb_file,apa_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,STATUS,"","sum(apb09)",1)  #No.FUN-660122
            #FUN-CB0054--add--str--
            ELSE
               LET g_showmsg=g_apb[l_ac].apb21,'/',g_apb[l_ac].apb22
               CALL s_errmsg('apb21,apb22',g_showmsg,'sum(apb09)',STATUS,1)
            END IF
            #FUN-CB0054--add--end
            LET g_success='N'
         END IF
 
         IF l_qty IS NULL THEN
            LET l_qty = 0
         END IF
 
         CALL t110_rvv23_rvv88(g_apb[l_ac].apb21,g_apb[l_ac].apb22,'21','26')
              RETURNING l_qty_rvv88,l_qty_rvv23_rvv88
 
         LET l_qty1 = l_qty_rvv88 - l_qty_rvv23_rvv88
        #LET l_sql = "UPDATE ",li_dbs CLIPPED,"rvv_file ",
         LET l_sql = "UPDATE ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'), #FUN-A50102
                     "   SET rvv23 = '",l_qty,"' ,",
                     "       rvv88 = '",l_qty1,"' ",
                     " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
                     "   AND rvv02 = '",g_apb[l_ac].apb22,"' " 
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102              
         PREPARE upd_rvv_pre5 FROM l_sql
         EXECUTE upd_rvv_pre5  
         IF STATUS OR SQLCA.SQLCODE THEN
            IF p_type='0' THEN  #FUN-CB0054
            CALL cl_err3("upd","rvv_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,SQLCA.sqlcode,"","upd rvv23",1)  #No.FUN-660122
            #FUN-CB0054--add--str--
            ELSE
               LET g_showmsg=g_apb[l_ac].apb21,'/',g_apb[l_ac].apb22
               CALL s_errmsg('rvv01,rvv02',g_showmsg,'upd rvv23',SQLCA.sqlcode,1)
            END IF
            #FUN-CB0054--add--end
            LET g_success='N'
         END IF
      END IF   #CHI-B30009 add
   END IF
 
   IF r_sw = 1 THEN
      IF NOT cl_null(g_apb_t.apb21) AND NOT cl_null(g_apb_t.apb22) THEN   #CHI-B30009 add
         SELECT SUM(apb09) INTO l_qty FROM apb_file,apa_file
          WHERE apb21 = g_apb_t.apb21 AND apb22 = g_apb_t.apb22
            #AND apb01 = apa01 AND apa00 = '21'                  #MOD-BC0054
            AND apb01 = apa01 AND (apa00 = '21' OR apa00='11')   #MOD-BC0054
            AND apa42 = 'N'
         IF STATUS THEN
            IF p_type='0' THEN  #FUN-CB0054
            CALL cl_err3("sel","apb_file,apa_file",g_apb_t.apb21,g_apb_t.apb22,STATUS,"","sum(apb09)",1)  #No.FUN-660122
            #FUN-CB0054--add--str--
            ELSE
               LET g_showmsg=g_apb_t.apb21,'/',g_apb_t.apb22
               CALL s_errmsg('apb21,apb22',g_showmsg,'sum(apb09)',STATUS,1)
            END IF
            #FUN-CB0054--add--end
            LET g_success='N'
         END IF
 
         IF l_qty IS NULL THEN
            LET l_qty = 0
         END IF
 
         IF l_qty < 0 THEN
            LET l_qty = l_qty * -1
         END IF
 
         CALL t110_rvv23_rvv88(g_apb_t.apb21,g_apb_t.apb22,'21','26')
              RETURNING l_qty_rvv88,l_qty_rvv23_rvv88
 
         LET l_qty2 = l_qty_rvv88 - l_qty_rvv23_rvv88
         #LET l_sql = "UPDATE ",li_dbs CLIPPED,"rvv_file ",
         LET l_sql = "UPDATE ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'), #FUN-A50102
                     "   SET rvv23 = '",l_qty,"' ,",
                     "       rvv88 = '",l_qty2,"' ", 
                     " WHERE rvv01 = '",g_apb_t.apb21,"' ",
                     "   AND rvv02 = '",g_apb_t.apb22,"' " 
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102               
         PREPARE upd_rvv88_pre FROM l_sql      #FUN-9C0140
         EXECUTE upd_rvv88_pre                 #FUN-9C0140
         IF STATUS OR SQLCA.SQLCODE THEN
            IF p_type='0' THEN  #FUN-CB0054
            CALL cl_err3("upd","rvv_file",g_apb_t.apb21,g_apb_t.apb22,SQLCA.sqlcode,"","UPD RVV23",1)  #No.FUN-660122
            #FUN-CB0054--add--str--
            ELSE
               LET g_showmsg=g_apb_t.apb21,'/',g_apb_t.apb22
               CALL s_errmsg('rvv01,rvv02',g_showmsg,'upd rvv23',SQLCA.sqlcode,1)
            END IF
            #FUN-CB0054--add--end
            LET g_success='N'
         END IF
      END IF   #CHI-B30009 add
   END IF
END FUNCTION
 
FUNCTION t110_m()
   DEFINE i,j          LIKE type_file.num5    #No.FUN-690028 SMALLINT
   DEFINE g_apd     DYNAMIC ARRAY OF RECORD
                    apd02          LIKE apd_file.apd02,
                    apd03          LIKE apd_file.apd03
                    END RECORD,
   l_allow_insert  LIKE type_file.num5,                #可新增否  #No.FUN-690028 SMALLINT
   l_allow_delete  LIKE type_file.num5                 #可刪除否  #No.FUN-690028 SMALLINT
 
   IF g_apa.apa01 IS NULL THEN
      RETURN
   END IF
 
  #-MOD-BB0304-add-
   IF g_apa.apa63 MATCHES '[Ss1]' THEN 
      CALL cl_err('','mfg3557',0)
      RETURN
   END IF
  #-MOD-BB0304-end-

   OPEN WINDOW t110_m_w AT 7,29 WITH FORM "aap/42f/aapt110_3"
      ATTRIBUTE (STYLE = g_win_style CLIPPED) #No.FUN-580092 HCN
 
    CALL cl_ui_locale("aapt110_3")
 
 
   DECLARE t110_m_c CURSOR FOR
    SELECT apd02,apd03 FROM apd_file
     WHERE apd01 = g_apa.apa01
 
   LET i = 1
 
   FOREACH t110_m_c INTO g_apd[i].*
      LET i = i + 1
      IF i > 100 THEN
         EXIT FOREACH
      END IF
   END FOREACH
   LET i = i - 1
 
   LET l_allow_insert = cl_detail_input_auth("insert")
   LET l_allow_delete = cl_detail_input_auth("delete")
 
   INPUT ARRAY g_apd WITHOUT DEFAULTS FROM s_apd.*
         ATTRIBUTE(COUNT=i,MAXCOUNT=g_max_rec,UNBUFFERED,
                   INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)
 
   CLOSE WINDOW t110_m_w
 
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      RETURN
   END IF
 
   LET j = ARR_COUNT()
   BEGIN WORK
   LET g_success = 'Y'
 
   WHILE TRUE
      DELETE FROM apd_file
       WHERE apd01 = g_apa.apa01
      IF SQLCA.sqlcode THEN
         LET g_success = 'N'
         CALL cl_err3("del","apd_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_m(ckp#1):",1)  #No.FUN-660122
         EXIT WHILE
      END IF
 
      FOR i = 1 TO j
         IF g_apd[i].apd03 IS NULL THEN
            CONTINUE FOR
         END IF
 
         INSERT INTO apd_file (apd01,apd02,apd03,apdlegal) #FUN-980001 add apdlegal
              VALUES(g_apa.apa01,g_apd[i].apd02,g_apd[i].apd03,g_legal) #FUN-980001 add g_legal
         IF SQLCA.sqlcode THEN
            LET g_success = 'N'
            CALL cl_err3("ins","apd_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_m(ckp#2):",1)  #No.FUN-660122
            EXIT WHILE
         END IF
      END FOR
      EXIT WHILE
   END WHILE
 
   IF g_success = 'Y' THEN
      COMMIT WORK
   ELSE
      ROLLBACK WORK
   END IF
 
END FUNCTION
 
FUNCTION t110_ccc(p_cmd)
   DEFINE p_cmd          LIKE type_file.chr1            # 1.借方MISC明細  #No.FUN-690028 VARCHAR(1)
   DEFINE l_exit_sw      LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_depno        LIKE apa_file.apa22  #FUN-660117
   DEFINE l_amt          LIKE api_file.api05
   DEFINE l_amtf         LIKE api_file.api05f
   DEFINE l_tot          LIKE api_file.api05
   DEFINE l_totf         LIKE api_file.api05
   DEFINE i,j,k          LIKE type_file.num5    #No.FUN-690028 SMALLINT
   DEFINE l_apt          RECORD LIKE apt_file.*
   DEFINE m_aag05        LIKE aag_file.aag05
   DEFINE m_aag21        LIKE aag_file.aag21
   DEFINE m_aag23        LIKE aag_file.aag23
   DEFINE m_aag151       LIKE aag_file.aag151
   DEFINE m_aag161       LIKE aag_file.aag161
   DEFINE m_aag171       LIKE aag_file.aag171
   DEFINE m_aag181       LIKE aag_file.aag181
   DEFINE m_aag311       LIKE aag_file.aag311   #FUN-5C0015 BY TSD.GILL
   DEFINE m_aag321       LIKE aag_file.aag321   #FUN-5C0015 BY TSD.GILL
   DEFINE m_aag331       LIKE aag_file.aag331   #FUN-5C0015 BY TSD.GILL
   DEFINE m_aag341       LIKE aag_file.aag341   #FUN-5C0015 BY TSD.GILL
   DEFINE m_aag351       LIKE aag_file.aag351   #FUN-5C0015 BY TSD.GILL
   DEFINE m_aag361       LIKE aag_file.aag361   #FUN-5C0015 BY TSD.GILL
   DEFINE m_aag371       LIKE aag_file.aag371   #FUN-5C0015 BY TSD.GILL
   DEFINE m_aag05_1      LIKE aag_file.aag05    #CHI-8C0005 add
   DEFINE m_aag21_1      LIKE aag_file.aag21    #CHI-8C0005 add
   DEFINE m_aag23_1      LIKE aag_file.aag23    #CHI-8C0005 add
   DEFINE m_aag151_1     LIKE aag_file.aag151   #CHI-8C0005 add
   DEFINE m_aag161_1     LIKE aag_file.aag161   #CHI-8C0005 add
   DEFINE m_aag171_1     LIKE aag_file.aag171   #CHI-8C0005 add
   DEFINE m_aag181_1     LIKE aag_file.aag181   #CHI-8C0005 add
   DEFINE m_aag311_1     LIKE aag_file.aag311   #CHI-8C0005 add
   DEFINE m_aag321_1     LIKE aag_file.aag321   #CHI-8C0005 add
   DEFINE m_aag331_1     LIKE aag_file.aag331   #CHI-8C0005 add
   DEFINE m_aag341_1     LIKE aag_file.aag341   #CHI-8C0005 add
   DEFINE m_aag351_1     LIKE aag_file.aag351   #CHI-8C0005 add
   DEFINE m_aag361_1     LIKE aag_file.aag361   #CHI-8C0005 add
   DEFINE m_aag371_1     LIKE aag_file.aag371   #CHI-8C0005 add
   DEFINE l_plant_new    LIKE azp_file.azp01   #FUN-660117
   DEFINE l_dbs_new      LIKE type_file.chr21       # No.FUN-690028 VARCHAR(21)
   DEFINE l_sql          STRING  #MOD-720062
   DEFINE g_aaz72        LIKE aaz_file.aaz72,   #總帳參數部門為1.拒絕或2.允許
          l_allow_insert LIKE type_file.num5,                #可新增否  #No.FUN-690028 SMALLINT
          l_allow_delete LIKE type_file.num5                 #可刪除否  #No.FUN-690028 SMALLINT
   DEFINE m_api04        LIKE api_file.api04
   DEFINE m_api041       LIKE api_file.api041   #No.FUN-680029
   DEFINE l_aag05        LIKE aag_file.aag05   #MOD-580051
 
   IF g_apa.apa51 != 'MISC' AND g_apa.apa511 != 'MISC' THEN   #No.FUN-680029
      RETURN
   END IF
 
 # IF cl_null(g_apa.apa01) OR cl_null(s_get_serial_no(g_apa.apa01,'','')) THEN   #FUN-960081  #No.TQC-A30134
   IF cl_null(g_apa.apa01) OR cl_null(s_get_serial_no('AAP',g_apa.apa01,'')) THEN   #FUN-960081  #No.TQC-A30134
      RETURN
   END IF
 
  #-MOD-BB0304-add-
  #IF g_apa.apa63 MATCHES '[Ss1]' THEN   #MOD-C80191 mark
   IF g_apa.apa63 MATCHES '[Ss]' THEN    #MOD-C80191 
      CALL cl_err('','mfg3557',0)
      RETURN
   END IF
  #-MOD-BB0304-end-

   LET l_amt  = g_apa.apa31
   LET l_amtf = g_apa.apa31f
 
   CALL cl_set_comp_visible("api930",g_aaz.aaz90='Y')  #CHI-8C0005 add
 
   SELECT pmc903 INTO g_pmc903  FROM pmc_file          #FUN-950053 add
    WHERE pmc01 = g_apa.apa05                          #FUN-950053 add 
 
   OPEN WINDOW t110_ccc_w AT 3,3
     WITH FORM "aap/42f/aapt110_c"  ATTRIBUTE (STYLE = g_win_style CLIPPED) #No.FUN-580092 HCN
 
   CALL cl_ui_locale("aapt110_c")
 
   CALL cl_set_comp_entry("api04,api041",FALSE)
   IF g_apa.apa51 ='MISC' THEN
         CALL cl_set_comp_entry("api04",TRUE)
   END IF
   IF g_apa.apa511='MISC' THEN
         CALL cl_set_comp_entry("api041",TRUE)
   END IF
   CALL t110_ccc_show_field()  #FUN-5C0015 BY GILL
 
   DISPLAY g_apa.apa01,l_amt,l_amtf TO api01,amt,amtf   #MOD-810207
 
   DECLARE t110_ccc_c CURSOR FOR 
      SELECT DISTINCT api04,'',api041,'',api07,api930,api06,api05f,api05,   #No.TQC-7A0095   #CHI-8C0005 add api930
             api21,api22,api23,api24,
 
            api31,api32,api33,api34,api37,
            api26,api35,api36,api03        #No.FUN-830161
 
        FROM api_file   #No.TQC-7A0095
       WHERE api01 = g_apa.apa01
         AND api02 = p_cmd
       ORDER BY api03,api04,api041  #No.FUN-680029
 
   WHILE TRUE
      LET l_exit_sw = 'Y'
      CALL g_api.clear()
      LET k = 1
      LET l_tot = 0
      LET l_totf= 0
 
      FOREACH t110_ccc_c INTO g_api[k].*,j
         IF SQLCA.sqlcode THEN
            CALL cl_err('t110_ccc_c',SQLCA.sqlcode,0)
            EXIT FOREACH
         END IF
     
         IF NOT cl_null(g_api[k].api04) THEN
            SELECT aag02 INTO g_api[k].aag02 FROM aag_file 
             WHERE aag01 = g_api[k].api04
               AND aag00 = g_bookno1
               AND aagacti = 'Y'                         #No.MOD-B70280 add
         END IF
         IF NOT cl_null(g_api[k].api041) THEN
            SELECT aag02 INTO g_api[k].aag021 FROM aag_file
             WHERE aag01 = g_api[k].api041
               AND aag00 = g_bookno2
               AND aagacti = 'Y'                         #No.MOD-B70280 add
         END IF
 
         LET l_totf = l_totf + g_api[k].api05f
         LET l_tot  = l_tot + g_api[k].api05
         LET k = k + 1
 
          IF k > g_max_rec THEN          #No.MOD-480131
            EXIT FOREACH
         END IF
      END FOREACH
 
      CALL g_api.deleteElement(k)
      LET g_rec_b = k - 1
 
      DISPLAY l_totf TO FORMONLY.api05_ft
      DISPLAY l_tot TO FORMONLY.api05_t
 
      IF k = 1 THEN
         IF g_apz.apz13 = 'Y' THEN
            LET l_depno = g_apa.apa22
         ELSE
            LET l_depno = ' '
         END IF
 
         SELECT * INTO l_apt.* FROM apt_file
          WHERE apt01 = g_apa.apa36
            AND apt02 = l_depno
         IF SQLCA.sqlcode THEN
            INITIALIZE l_apt.* TO NULL
         END IF
 
         LET g_api[1].api04 = l_apt.apt032          #No.FUN-680029
         LET g_api[2].api04 = l_apt.apt032
         LET g_api[3].api04 = l_apt.apt033
         LET g_api[4].api04 = l_apt.apt034
         LET g_api[5].api04 = l_apt.apt035
         LET g_api[6].api04 = l_apt.apt036
         LET g_api[7].api04 = l_apt.apt037
         LET g_api[8].api04 = l_apt.apt038
         LET g_api[9].api04 = l_apt.apt039
         IF g_aza.aza63 ='Y' THEN
            LET g_api[1].api041 = l_apt.apt032
            LET g_api[2].api041 = l_apt.apt032
            LET g_api[3].api041 = l_apt.apt033
            LET g_api[4].api041 = l_apt.apt034
            LET g_api[5].api041 = l_apt.apt035
            LET g_api[6].api041 = l_apt.apt036
            LET g_api[7].api041 = l_apt.apt037
            LET g_api[8].api041 = l_apt.apt038
            LET g_api[9].api041 = l_apt.apt039
         END IF
      END IF
 
      IF g_apa.apa41 = 'Y' THEN
         CALL cl_set_act_visible("accept,cancel", FALSE)
         DISPLAY ARRAY g_api TO s_api.* ATTRIBUTE(COUNT=g_rec_b)
 
            AFTER DISPLAY
               LET l_exit_sw = 'Y'   #MOD-840040
 
            ON ACTION exit
               LET l_exit_sw = 'Y'
               EXIT DISPLAY
 
            ON IDLE g_idle_seconds
               CALL cl_on_idle()
               CONTINUE DISPLAY
 
             ON ACTION about         #MOD-4C0121
                CALL cl_about()      #MOD-4C0121
 
             ON ACTION help          #MOD-4C0121
                CALL cl_show_help()  #MOD-4C0121
 
             ON ACTION controlg      #MOD-4C0121
                CALL cl_cmdask()     #MOD-4C0121
 
             ON ACTION controls                       #No.FUN-6B0033                                                                       
                CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
 
         END DISPLAY
      ELSE
         CALL cl_set_act_visible("accept,cancel", FALSE)
         DISPLAY ARRAY g_api TO s_api.* ATTRIBUTE(COUNT=g_rec_b)
            BEFORE DISPLAY
               EXIT DISPLAY
         END DISPLAY
 
         CALL cl_set_act_visible("accept,cancel", TRUE)
         INPUT l_amtf,l_amt WITHOUT DEFAULTS FROM amtf,amt
 
            AFTER INPUT
               IF INT_FLAG THEN
                  LET INT_FLAG= 0
                  LET l_amt = g_apa.apa31
                  LET l_amtf = g_apa.apa31f
                  DISPLAY l_amt,l_amtf TO amt,amtf
                  EXIT INPUT
               END IF
               IF g_apa.apa31f <> l_amtf OR
                  g_apa.apa31  <> l_amt  THEN
                  IF l_amtf <> 0 OR
                     l_amt  <> 0 THEN
                     CALL cl_err('','aap-292',0)
                     NEXT FIELD amtf
                  END IF
               END IF
 
            ON ACTION controlg       #TQC-860021
               CALL cl_cmdask()      #TQC-860021
 
            ON IDLE g_idle_seconds   #TQC-860021
               CALL cl_on_idle()     #TQC-860021
               CONTINUE INPUT        #TQC-860021
 
            ON ACTION about          #TQC-860021
               CALL cl_about()       #TQC-860021
 
            ON ACTION help           #TQC-860021
               CALL cl_show_help()   #TQC-860021
         END INPUT
 
         LET m_aag05  = ' '
         LET m_aag21  = ' '
         LET m_aag23  = ' '
         LET m_aag151 = ' '
         LET m_aag161 = ' '
         LET m_aag171 = ' '
         LET m_aag181 = ' '
         LET m_aag311 = ' '
         LET m_aag321 = ' '
         LET m_aag331 = ' '
         LET m_aag341 = ' '
         LET m_aag351 = ' '
         LET m_aag361 = ' '
         LET m_aag371 = ' '
         LET m_aag05_1= ' '
         LET m_aag21_1= ' '
         LET m_aag23_1= ' '
         LET m_aag151_1= ' '
         LET m_aag161_1= ' '
         LET m_aag171_1= ' '
         LET m_aag181_1= ' '
         LET m_aag311_1= ' '
         LET m_aag321_1= ' '
         LET m_aag331_1= ' '
         LET m_aag341_1= ' '
         LET m_aag351_1= ' '
         LET m_aag361_1= ' '
         LET m_aag371_1= ' '
         LET l_allow_insert = cl_detail_input_auth("insert")
         LET l_allow_delete = cl_detail_input_auth("delete")
 
         INPUT ARRAY g_api WITHOUT DEFAULTS FROM s_api.*
               ATTRIBUTE(COUNT=g_rec_b,MAXCOUNT=g_max_rec,UNBUFFERED,
                         INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)
 
            BEFORE INPUT
               CALL fgl_set_arr_curr(i)
               LET g_before_input_done = FALSE
               CALL t110_set_entry_api(p_cmd)
               CALL t110_set_no_entry_api(m_aag05,m_aag21,m_aag23,m_aag151,
                    m_aag161,m_aag171,m_aag181,
 
                    m_aag311,m_aag321,m_aag331,m_aag341,m_aag351,m_aag361,
                    m_aag371
 
                    )
               LET g_before_input_done = TRUE
 
            BEFORE ROW
               LET i = ARR_CURR()
               LET j = SCR_LINE()
               LET l_totf = 0
               LET l_tot = 0
               FOR k = 1 TO g_api.getLength()  #No.MOD-4A0348
                  #-MOD-CC0194-add-
                   SELECT aag05,aag21,aag23,aag151,aag161,aag171,aag181,
                          aag311,aag321,aag331,aag341,aag351,aag361,aag371
                     INTO m_aag05,m_aag21,m_aag23,m_aag151,m_aag161,m_aag171,m_aag181,
                          m_aag311,m_aag321,m_aag331,m_aag341,m_aag351,
                          m_aag361,m_aag371
                     FROM aag_file
                    WHERE aag01 = g_api[k].api04
                      AND aag00 = g_bookno1
                      AND aagacti = 'Y'
                   IF SQLCA.sqlcode THEN
                      LET m_aag05 = ' '
                      LET m_aag21 = ' '
                      LET m_aag23 = ' '
                      LET m_aag151 = ' '
                      LET m_aag161 = ' '
                      LET m_aag171 = ' '
                      LET m_aag181 = ' '
                      LET m_aag311 = ' '
                      LET m_aag321 = ' '
                      LET m_aag331 = ' '
                      LET m_aag341 = ' '
                      LET m_aag351 = ' '
                      LET m_aag361 = ' '
                      LET m_aag371 = ' '
                   END IF
                   CALL t110_set_entry_api(p_cmd)
                   CALL t110_set_no_entry_api(m_aag05,m_aag21,m_aag23,m_aag151,m_aag161,
                                              m_aag171,m_aag181,m_aag311,m_aag321,m_aag331,
                                              m_aag341,m_aag351,m_aag361,m_aag371)
                  #-MOD-CC0194-end-
                  IF g_api[k].api05 IS NULL THEN
                     CONTINUE FOR
                  END IF
                  LET l_totf = l_totf + g_api[k].api05f
                  LET l_tot = l_tot + g_api[k].api05
               END FOR
               DISPLAY l_totf TO FORMONLY.api05_ft
               DISPLAY l_tot TO FORMONLY.api05_t
               CALL cl_show_fld_cont()     #FUN-550037(smin)
 
            BEFORE FIELD api04
               CALL t110_set_entry_api(p_cmd)
 
            AFTER FIELD api04
#MOD-590460將變數值清空
                  LET m_aag21  = ' '
                  LET m_aag151 = ' '
                  LET m_aag161 = ' '
                  LET m_aag171 = ' '
                  LET m_aag181 = ' '
 
                  LET m_aag311 = ' '
                  LET m_aag321 = ' '
                  LET m_aag331 = ' '
                  LET m_aag341 = ' '
                  LET m_aag351 = ' '
                  LET m_aag361 = ' '
                  LET m_aag371 = ' '
 
               IF NOT cl_null(g_api[i].api04) THEN
                  CALL s_aapact(g_apz.apz11,g_bookno1,g_api[i].api04) RETURNING g_api[i].aag02     #No.FUN-730064
                  IF g_apz.apz02 = 'Y' AND NOT cl_null(g_errno) THEN
                     CALL cl_err(g_api[i].api04,g_errno,0)
                     #No.FUN-B10050  --Begin
                     CALL cl_init_qry_var()
                     LET g_qryparam.form ="q_aag02"
                     LET g_qryparam.construct = 'N'
                     LET g_qryparam.default1 = g_api[i].api04
                     LET g_qryparam.arg1 = g_bookno1
                     LET g_qryparam.where = " aag03 ='2' AND aag01 LIKE '",g_api[i].api04 CLIPPED,"%'"
                     CALL cl_create_qry() RETURNING g_api[i].api04
                     DISPLAY BY NAME g_api[i].api04
                     #No.FUN-B10050  --End  
                     NEXT FIELD api04
                  END IF
 
                  SELECT aag05,aag21,aag23,aag151,aag161,aag171,aag181,
 
                  aag311,aag321,aag331,aag341,aag351,aag361,aag371
 
                    INTO m_aag05,m_aag21,m_aag23,m_aag151,m_aag161,m_aag171,m_aag181,
 
                         m_aag311,m_aag321,m_aag331,m_aag341,m_aag351,
                         m_aag361,m_aag371
                    FROM aag_file
                   WHERE aag01 = g_api[i].api04
                     AND aag00 = g_bookno1     #No.FUN-730064
                     AND aagacti = 'Y'                         #No.MOD-B70280 add

                  IF SQLCA.sqlcode THEN
                     LET m_aag05 = ' '   #CHI-8C0005 add
                     LET m_aag21 = ' '
                     LET m_aag23 = ' '   #CHI-8C0005 add
                     LET m_aag151 = ' '
                     LET m_aag161 = ' '
                     LET m_aag171 = ' '
                     LET m_aag181 = ' '
 
                     LET m_aag311 = ' '
                     LET m_aag321 = ' '
                     LET m_aag331 = ' '
                     LET m_aag341 = ' '
                     LET m_aag351 = ' '
                     LET m_aag361 = ' '
                     LET m_aag371 = ' '
 
                  END IF
 
                  IF m_aag05 !='Y' THEN    #CHI-8C0005
                     LET g_api[i].api07 = ' '
                  END IF
 
                 #防止User只修改部門欄位時,未再次檢查會科與允許/拒絕部門關係
                  LET g_errno = ' '   
                  IF m_aag05 = 'Y' THEN
                     IF g_aaz.aaz90 ='Y' THEN
                        IF NOT cl_null(g_api[i].api930) THEN
                           CALL s_chkdept(g_aaz.aaz72,g_api[i].api04,g_api[i].api930,g_bookno1)
                                         RETURNING g_errno
                        END IF
                     ELSE
                        IF NOT cl_null(g_api[i].api07) THEN
                           CALL s_chkdept(g_aaz.aaz72,g_api[i].api04,g_api[i].api07,g_bookno1)
                                         RETURNING g_errno
                        END IF
                     END IF
                     IF NOT cl_null(g_errno) THEN
                        CALL cl_err('',g_errno,0)
                       #No.FUN-B10050  --Begin
                        CALL cl_init_qry_var()
                        LET g_qryparam.form ="q_aag02"
                        LET g_qryparam.construct = 'N'
                        LET g_qryparam.default1 = g_api[i].api04
                        LET g_qryparam.arg1 = g_bookno1
                        LET g_qryparam.where = " aag03 ='2' AND aag01 LIKE '",g_api[i].api04 CLIPPED,"%'"
                        CALL cl_create_qry() RETURNING g_api[i].api04
                        DISPLAY BY NAME g_api[i].api04
                       #No.FUN-B10050  --End  
                       #NEXT FIELD api04                               #MOD-C20088 mark
                        NEXT FIELD api07                               #MOD-C20088 add
                     END IF
                  END IF
 
               END IF
               CALL t110_set_no_entry_api(m_aag05,m_aag21,m_aag23,m_aag151,
                    m_aag161,m_aag171,m_aag181,
 
                    m_aag311,m_aag321,m_aag331,m_aag341,m_aag351,
                    m_aag361,m_aag371
                    )
 
               CALL t110_set_no_required()
               CALL t110_set_required(m_aag151,m_aag161,m_aag171,m_aag181,
                                      m_aag311,m_aag321,m_aag331,m_aag341,
                                      m_aag351,m_aag361,m_aag371,m_aag05,    #TQC-750121
                                      m_aag21,m_aag23)                       #MOD-B10093 
            BEFORE FIELD api041
               CALL t110_set_entry_api(p_cmd)
 
            AFTER FIELD api041
#MOD-590460將變數值清空
               LET m_aag05_1= ' '
               LET m_aag21_1= ' '
               LET m_aag23_1= ' '
               LET m_aag151_1= ' '
               LET m_aag161_1= ' '
               LET m_aag171_1= ' '
               LET m_aag181_1= ' '
               LET m_aag311_1= ' '   #FUN-5C0015 BY GILL
               LET m_aag321_1= ' '   #FUN-5C0015 BY GILL
               LET m_aag331_1= ' '   #FUN-5C0015 BY GILL
               LET m_aag341_1= ' '   #FUN-5C0015 BY GILL
               LET m_aag351_1= ' '   #FUN-5C0015 BY GILL
               LET m_aag361_1= ' '   #FUN-5C0015 BY GILL
               LET m_aag371_1= ' '   #FUN-5C0015 BY GILL
               IF NOT cl_null(g_api[i].api041) THEN
                  CALL s_aapact(g_apz.apz11,g_bookno2,g_api[i].api041) RETURNING g_api[i].aag021     #No.FUN-730064
                  IF g_apz.apz02 = 'Y' AND NOT cl_null(g_errno) THEN
                     CALL cl_err(g_api[i].api041,g_errno,0)
                     #No.FUN-B10050  --Begin
                     CALL cl_init_qry_var()
                     LET g_qryparam.form ="q_aag02"
                     LET g_qryparam.construct = 'N'
                     LET g_qryparam.default1 = g_api[i].api041
                     LET g_qryparam.arg1 = g_bookno2
                     LET g_qryparam.where = " aag03 ='2' AND aag01 LIKE '",g_api[i].api041 CLIPPED,"%'"
                     CALL cl_create_qry() RETURNING g_api[i].api041
                     DISPLAY BY NAME g_api[i].api041
                     #No.FUN-B10050  --End  
                     NEXT FIELD api041
                  END IF
 
                  SELECT aag05,aag21,aag23,aag151,aag161,aag171,aag181,
                         aag311,aag321,aag331,aag341,aag351,aag361,aag371
                    INTO m_aag05_1,m_aag21_1,m_aag23_1,m_aag151_1,m_aag161_1,m_aag171_1,m_aag181_1,
                         m_aag311_1,m_aag321_1,m_aag331_1,m_aag341_1,m_aag351_1,
                         m_aag361_1,m_aag371_1
                    FROM aag_file
                   WHERE aag01 = g_api[i].api041
                     AND aag00 = g_bookno2      #No.FUN-730064
                     AND aagacti = 'Y'          #No.MOD-B70280 add
                  IF SQLCA.sqlcode THEN
                     LET m_aag05_1= ' '
                     LET m_aag21_1= ' '
                     LET m_aag23_1= ' '
                     LET m_aag151_1= ' '
                     LET m_aag161_1= ' '
                     LET m_aag171_1= ' '
                     LET m_aag181_1= ' '
                     LET m_aag311_1= ' '   #FUN-5C0015 BY GILL
                     LET m_aag321_1= ' '   #FUN-5C0015 BY GILL
                     LET m_aag331_1= ' '   #FUN-5C0015 BY GILL
                     LET m_aag341_1= ' '   #FUN-5C0015 BY GILL
                     LET m_aag351_1= ' '   #FUN-5C0015 BY GILL
                     LET m_aag361_1= ' '   #FUN-5C0015 BY GILL
                     LET m_aag371_1= ' '   #FUN-5C0015 BY GILL
                  END IF
 
                  IF m_aag05 != 'Y'AND m_aag05_1 !='Y' THEN   #CHI-8C0005
                     LET g_api[i].api07 = ' '
                  END IF
 
                 #防止User只修改部門欄位時,未再次檢查會科與允許/拒絕部門關係
                  LET g_errno = ' '   
                  IF m_aag05_1 = 'Y' THEN
                     IF g_aaz.aaz90 ='Y' THEN
                        IF NOT cl_null(g_api[i].api930) THEN
                           CALL s_chkdept(g_aaz.aaz72,g_api[i].api041,g_api[i].api930,g_bookno2)
                                         RETURNING g_errno
                        END IF
                     ELSE
                        IF NOT cl_null(g_api[i].api07) THEN
                           CALL s_chkdept(g_aaz.aaz72,g_api[i].api041,g_api[i].api07,g_bookno2)
                                         RETURNING g_errno
                        END IF
                     END IF
                     IF NOT cl_null(g_errno) THEN
                        CALL cl_err('',g_errno,0)
                        #No.FUN-B10050  --Begin
                        CALL cl_init_qry_var()
                        LET g_qryparam.form ="q_aag02"
                        LET g_qryparam.construct = 'N'
                        LET g_qryparam.default1 = g_api[i].api041
                        LET g_qryparam.arg1 = g_bookno2
                        LET g_qryparam.where = " aag03 ='2' AND aag01 LIKE '",g_api[i].api041 CLIPPED,"%'"
                        CALL cl_create_qry() RETURNING g_api[i].api041
                        DISPLAY BY NAME g_api[i].api041
                        #No.FUN-B10050  --End  
                        NEXT FIELD api041
                     END IF
                  END IF
 
               END IF
               CALL t110_set_no_entry_api(m_aag05_1,m_aag21_1,m_aag23_1,m_aag151_1,
                    m_aag161_1,m_aag171_1,m_aag181_1,
                    m_aag311_1,m_aag321_1,m_aag331_1,m_aag341_1,m_aag351_1,
                    m_aag361_1,m_aag371_1
                    )
 
               CALL t110_set_no_required()
               CALL t110_set_required(m_aag151_1,m_aag161_1,m_aag171_1,m_aag181_1,
                                      m_aag311_1,m_aag321_1,m_aag331_1,m_aag341_1,
                                      m_aag351_1,m_aag361_1,m_aag371_1,m_aag05_1,   #TQC-750121 add aag05
                                      m_aag21_1,m_aag23_1)                          #MOD-B10093 
 
            AFTER FIELD api07
               SELECT aag05 INTO m_aag05 FROM aag_file
                      WHERE aag01=g_api[i].api04
                        AND aag00=g_bookno1      #No.FUN-730064
                        AND aagacti = 'Y'                         #No.MOD-B70280 add
               IF STATUS OR SQLCA.SQLCODE THEN
                  LET m_aag05=''
               END IF
               IF g_aza.aza63 ='Y' THEN   #CHI-8C0005 add
                  SELECT aag05 INTO m_aag05_1 FROM aag_file   #CHI-8C0005 mod
                   WHERE aag01=g_api[i].api041
                     AND aag00=g_bookno2      #No.FUN-730064
                     AND aagacti = 'Y'                         #No.MOD-B70280 add

                  IF STATUS OR SQLCA.SQLCODE THEN
                     LET m_aag05_1=''   #CHI-8C0005 mod
                  END IF
               END IF   #CHI-8C0005 add
               IF cl_null(g_api[i].api07) THEN
                  IF m_aag05 = "Y" OR m_aag05_1 = "Y" THEN   #CHI-8C0005
                     CALL cl_err(g_api[i].api07,'mfg0037',0)
                     NEXT FIELD api07
                  END IF
               ELSE
                  LET g_api[i].api930=s_costcenter(g_api[i].api07)  #CHI-8C0005 add
                  DISPLAY BY NAME g_api[i].api930                   #CHI-8C0005 add
                  LET g_errno = ' '   #MOD-5B0255
                  IF m_aag05 = "Y" THEN
                    #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                     IF g_aaz.aaz90 !='Y' THEN
                        IF NOT cl_null(g_api[i].api04) THEN  #FUN-8C0106 add
                           CALL s_chkdept(g_aaz.aaz72,g_api[i].api04,g_api[i].api07,g_bookno1)
                                RETURNING g_errno    #No.FUN-680029 #No.FUN-730064
                        END IF                               #FUN-8C0106 add
                     END IF
 
                     IF NOT cl_null(g_errno) THEN
                        CALL cl_err('',g_errno,0)
                       #NEXT FIELD api07             #No.FUN-5B0081 #MOD-C20088 mark
                        NEXT FIELD api04             #MOD-C20088 add
                     END IF
                  END IF
                  IF m_aag05_1 = "Y" THEN
                    #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                     IF g_aza.aza63 ='Y' THEN
                        IF g_aaz.aaz90 !='Y' THEN
                           IF NOT cl_null(g_api[i].api041) THEN     #FUN-8C0106 add
                              CALL s_chkdept(g_aaz.aaz72,g_api[i].api041,g_api[i].api07,g_bookno2)
                                   RETURNING g_errno    #No.FUN-680029 #No.FUN-730064
                           END IF                                   #FUN-8C0106 add 
                        END IF
                     END IF
                     IF NOT cl_null(g_errno) THEN
                        CALL cl_err('',g_errno,0)
                        NEXT FIELD api07
                     END IF
                  END IF
 
                  SELECT gem02 FROM gem_file
                   WHERE gem01 = g_api[i].api07
                     AND gem05 = 'Y'
                     AND gemacti = 'Y'
 
                  IF SQLCA.sqlcode THEN
                     CALL cl_err3("sel","gem_file",g_api[i].api07,"","aap-039","","",1)  #No.FUN-660122
                     NEXT FIELD api07
                  END IF
 
                  IF g_apz.apz02='Y' THEN
                     LET l_plant_new = g_apz.apz02p
 
                     IF l_plant_new = g_plant THEN
                        LET l_dbs_new = NULL
                     ELSE
                        SELECT azp03 INTO l_dbs_new FROM azp_file
                         WHERE azp01=l_plant_new
                        IF STATUS THEN
                           LET l_dbs_new = NULL
                        ELSE
                          #LET l_dbs_new = l_dbs_new CLIPPED,s_dbstring(l_dbs_new clipped)  #No.MOD-B80060 mark
                           LET l_dbs_new = s_dbstring(l_dbs_new CLIPPED)                    #No.MOD-B80060 add
                        END IF
                     END IF
 
                     #FUN-A50102--add--str--
                     IF NOT cl_null(g_apa.apa100) THEN
                        LET m_plant = g_apa.apa100
                     ELSE
                        LET m_plant = g_plant
                     END IF 
                     #FUN-A50102--add--end
                     #LET l_sql = "SELECT aaz72  FROM ",l_dbs_new,"aaz_file ",
                     LET l_sql = "SELECT aaz72  FROM ",cl_get_target_table(m_plant,'aaz_file'), #FUN-A50102
                                 " WHERE aaz00 = '0' "
 	                 CALL cl_replace_sqldb(l_sql) RETURNING l_sql        #FUN-920032
                     CALL cl_parse_qry_sql(l_sql,m_plant) RETURNING l_sql #FUN-A50102
                     PREPARE t110_aab_p FROM l_sql
                     DECLARE t110_aab_c CURSOR FOR t110_aab_p
                     OPEN t110_aab_c
                     FETCH t110_aab_c INTO g_aaz72
                     IF SQLCA.sqlcode THEN
                        LET g_aaz72 = '1'
                     END IF
 
                     IF cl_null(g_api[i].api04) THEN
                        IF g_apa.apa51 ='MISC' THEN   #MOD-8A0016 add
                           CALL cl_err(g_api[i].api04,'aap-099',0)
                           NEXT FIELD api04
                        END IF                        #MOD-8A0016 add
                     ELSE
                       #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                        IF g_aaz.aaz90 !='Y' THEN
                           CALL s_chkdept_dbs(g_aaz72,g_api[i].api04,
                                             #g_api[i].api07,g_bookno1,l_dbs_new)  #TQC-9C0099
                                              g_api[i].api07,g_bookno1,l_plant_new)#TQC-9C0099
                                RETURNING g_errno    #No.FUN-680029 #No.FUN-730064
                        END IF
                        IF NOT cl_null(g_errno) THEN
                           CALL cl_err('',g_errno,0)
                           NEXT FIELD api07
                        END IF
                     END IF   #MOD-890220 add
 
                     IF g_aza.aza63 ='Y' THEN
                        IF cl_null(g_api[i].api041) THEN
                           IF g_apa.apa511 ='MISC' THEN   #MOD-8A0016 add
                              CALL cl_err(g_api[i].api041,'aap-099',0)
                              NEXT FIELD api041
                           END IF                         #MOD-8A0016 add
                        ELSE
                          #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                           IF g_aaz.aaz90 !='Y' THEN
                              CALL s_chkdept_dbs(g_aaz72,g_api[i].api041,
                                                 g_api[i].api07,g_bookno2,l_plant_new)   #FUN-980020
                                   RETURNING g_errno    #No.FUN-680029 #No.FUN-730064
                           END IF
                           IF NOT cl_null(g_errno) THEN
                              CALL cl_err('',g_errno,0)
                              NEXT FIELD api07
                           END IF
                        END IF   #MOD-890220 add
                     END IF
                  END IF
               END IF
 
            AFTER FIELD api930
               IF g_aaz.aaz90 ='Y' THEN
                  IF NOT s_costcenter_chk(g_api[i].api930) THEN
                     NEXT FIELD apb930
                  ELSE
                     LET m_aag05=''
                     SELECT aag05 INTO m_aag05 FROM aag_file
                      WHERE aag01=g_api[i].api04
                        AND aag00=g_bookno1
                        AND aagacti = 'Y'                         #No.MOD-B70280 add
                     IF STATUS OR SQLCA.SQLCODE THEN
                        LET m_aag05=''
                     END IF
                     IF g_aza.aza63 ='Y' THEN
                        SELECT aag05 INTO m_aag05_1 FROM aag_file
                         WHERE aag01=g_api[i].api041
                           AND aag00=g_bookno2
                           AND aagacti = 'Y'                         #No.MOD-B70280 add
                        IF STATUS OR SQLCA.SQLCODE THEN
                           LET m_aag05_1=''
                        END IF
                     END IF
                     IF m_aag05 = 'Y' THEN
                        IF cl_null(g_api[i].api930) THEN
                           CALL cl_err(g_api[i].api930,'mfg0037',0)
                           NEXT FIELD api930
                        ELSE
                           SELECT gem02 FROM gem_file
                            WHERE gem01 = g_api[i].api930
                              AND gem05 = 'Y'
                              AND gemacti = 'Y'
                           IF SQLCA.sqlcode THEN
                              CALL cl_err3("sel","gem_file",g_api[i].api930,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                              NEXT FIELD api930
                           END IF
                           LET g_errno = ' '   #MOD-5B0255
                           #科目有做科目部門管理的才CALL s_chkdept
                           #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                           IF g_aaz.aaz90 ='Y' AND NOT cl_null(g_api[i].api04) THEN  #FUN-8C0106 mod
                              CALL s_chkdept(g_aaz.aaz72,g_api[i].api04,g_api[i].api930,g_bookno1) RETURNING g_errno
                              IF NOT cl_null(g_errno) THEN
                                 CALL cl_err('',g_errno,0)
                                 NEXT FIELD api930
                              END IF
                           END IF    #FUN-8C0106 add
                        END IF
                     ELSE
                        IF NOT cl_null(g_api[i].api930) THEN
                           SELECT gem02 FROM gem_file
                            WHERE gem01 = g_api[i].api930
                              AND gem05 = 'Y'
                              AND gemacti = 'Y'
                           IF SQLCA.sqlcode THEN
                              CALL cl_err3("sel","gem_file",g_api[i].api930,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                              NEXT FIELD api930
                           END IF
                        END IF
                     END IF
                     IF m_aag05_1 = 'Y' THEN
                        IF cl_null(g_api[i].api930) THEN
                           CALL cl_err(g_api[i].api930,'mfg0037',0)
                           NEXT FIELD api930
                        ELSE
                           SELECT gem02 FROM gem_file
                            WHERE gem01 = g_api[i].api930
                              AND gem05 = 'Y'
                              AND gemacti = 'Y'
                           IF SQLCA.sqlcode THEN
                              CALL cl_err3("sel","gem_file",g_api[i].api930,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                              NEXT FIELD api930
                           END IF
                           LET g_errno = ' '   #MOD-5B0255
                           #科目有做科目部門管理的才CALL s_chkdept
                           #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                           IF g_aaz.aaz90 ='Y' AND g_aza.aza63='Y' AND NOT cl_null(g_api[i].api041) THEN  #FUN-8C0106 mod
                              CALL s_chkdept(g_aaz.aaz72,g_api[i].api041,g_api[i].api930,g_bookno2) RETURNING g_errno
                           END IF
                           IF NOT cl_null(g_errno) THEN
                              CALL cl_err('',g_errno,0)
                              NEXT FIELD api930
                           END IF
                        END IF
                     ELSE
                        IF NOT cl_null(g_api[i].api930) THEN
                           SELECT gem02 FROM gem_file
                            WHERE gem01 = g_api[i].api930
                              AND gem05 = 'Y'
                              AND gemacti = 'Y'
                           IF SQLCA.sqlcode THEN
                              CALL cl_err3("sel","gem_file",g_api[i].api930,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                              NEXT FIELD api930
                           END IF
                        END IF
                     END IF
                  END IF
               END IF
 
            AFTER FIELD api05f
               IF NOT cl_null(g_api[i].api05f) THEN
                  LET g_api[i].api05 = g_api[i].api05f * g_apa.apa14
                  LET g_api[i].api05 = cl_digcut(g_api[i].api05,g_azi04)   #MOD-6B0066
               END IF
 
            AFTER FIELD api05
               IF NOT cl_null(g_api[i].api05) THEN
                  LET g_api[i].api05 = cl_digcut(g_api[i].api05,g_azi04)   #MOD-6B0066
               END IF
 
            AFTER FIELD api26
               IF NOT cl_null(g_api[i].api26) THEN
                  CALL t110_api26(p_cmd,g_api[i].api26)
                  IF NOT cl_null(g_errno) THEN
                     CALL cl_err('',g_errno,0)
                     NEXT FIELD api26
                  END IF
               END IF
 
            AFTER FIELD api21
               CALL s_chk_aee(g_api[i].api04,'1',g_api[i].api21,g_bookno1)   #No.FUN-730064 
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,1)
                  NEXT FIELD api21
               END IF
 
            AFTER FIELD api22
               CALL s_chk_aee(g_api[i].api04,'2',g_api[i].api22,g_bookno1)    #No.FUN-730064
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,1)
                  NEXT FIELD api22
               END IF
 
            AFTER FIELD api23
               CALL s_chk_aee(g_api[i].api04,'3',g_api[i].api23,g_bookno1)    #No.FUN-730064
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,1)
                  NEXT FIELD api23
               END IF
 
            AFTER FIELD api24
               CALL s_chk_aee(g_api[i].api04,'4',g_api[i].api24,g_bookno1)    #No.FUN-730064
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,1)
                  NEXT FIELD api24
               END IF
 
            AFTER FIELD api31
               CALL s_chk_aee(g_api[i].api04,'5',g_api[i].api31,g_bookno1)    #No.FUN-730064
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,1)
                  NEXT FIELD api31
               END IF
 
            AFTER FIELD api32
               CALL s_chk_aee(g_api[i].api04,'6',g_api[i].api32,g_bookno1)    #No.FUN-730064
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,1)
                  NEXT FIELD api32
               END IF
 
            AFTER FIELD api33
               CALL s_chk_aee(g_api[i].api04,'7',g_api[i].api33,g_bookno1)     #No.FUN-730064
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,1)
                  NEXT FIELD api33
               END IF
 
            AFTER FIELD api34
               CALL s_chk_aee(g_api[i].api04,'8',g_api[i].api34,g_bookno1)     #No.FUN-730064
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,1)
                  NEXT FIELD api34
               END IF
 
            AFTER FIELD api35
               CALL s_chk_aee(g_api[i].api04,'9',g_api[i].api35,g_bookno1)     #No.FUN-730064
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,1)
                  NEXT FIELD api35
               END IF
 
            AFTER FIELD api36
               CALL s_chk_aee(g_api[i].api04,'10',g_api[i].api36,g_bookno1)      #No.FUN-730064
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,1)
                  NEXT FIELD api36
               END IF
 
            AFTER FIELD api37
               CALL s_chk_aee(g_api[i].api04,'99',g_api[i].api37,g_bookno1)     #No.FUN-730064
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,1)
                  NEXT FIELD api37
               END IF
 
            AFTER FIELD api06
               LET g_msg = g_api[i].api06
               IF g_msg[1,1] = '.' THEN
                  LET g_msg = g_msg[2,10]
                  SELECT aad02 INTO g_api[i].api06 FROM aad_file
                   WHERE aad01 = g_msg
                     AND aadacti = 'Y'
                  NEXT FIELD api06
               END IF
 
            AFTER ROW
               IF INT_FLAG THEN
                  EXIT INPUT
               END IF
               IF cl_null(g_api[i].api05) OR g_api[i].api05f = 0 THEN
                  INITIALIZE g_api[i].* TO NULL
               END IF
 
            AFTER INPUT
               IF INT_FLAG THEN
                  EXIT INPUT
               END IF
               LET l_tot = 0
 
               FOR k = 1 TO 300
                  IF g_api[k].api05 IS NULL THEN
                     CONTINUE FOR
                  END IF
                  LET l_tot = l_tot + g_api[k].api05
               END FOR
 
               IF l_tot != l_amt THEN
                  CALL cl_err('','aap-177',0)
                  NEXT FIELD api05
               END IF
 
            ON ACTION apportion
               CALL t110_ins_api(p_cmd)
               LET g_aba.aba13 = g_apa.apa31 - l_tot
               CALL t110_xw()
               LET l_exit_sw = 'N'
               EXIT INPUT
 
            ON ACTION CONTROLP
               CASE
                  WHEN INFIELD(api04) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     LET g_qryparam.default1 = g_api[i].api04
                     LET g_qryparam.arg1 = g_bookno1      #No.FUN-730064
                     CALL cl_create_qry() RETURNING g_api[i].api04
                     DISPLAY g_api[i].api04 TO api04
                  WHEN INFIELD(api041) # Account number
                     CALL cl_init_qry_var()
                     LET g_qryparam.form ="q_aag02"   #TQC-790133
                     LET g_qryparam.arg1 = g_bookno2  #TQC-790133
                     LET g_qryparam.default1 = g_api[i].api041
                     CALL cl_create_qry() RETURNING g_api[i].api041
                     DISPLAY g_api[i].api041 TO api041
                  WHEN INFIELD(api07)      #部門代號
                     CALL cl_init_qry_var()
                     LET g_qryparam.form ="q_gem"
                     LET g_qryparam.default1 = g_api[i].api07
                     CALL cl_create_qry() RETURNING g_api[i].api07
                     DISPLAY g_api[i].api07 TO api07
                  WHEN INFIELD(api930)     #成本中心
                     CALL cl_init_qry_var()
                     LET g_qryparam.form ="q_gem4"
                     LET g_qryparam.default1 = g_api[i].api930
                     CALL cl_create_qry() RETURNING g_api[i].api930
                     DISPLAY g_api[i].api930 TO api930
                  WHEN INFIELD(api06)     #查詢常用摘要
                     CALL q_aad(FALSE,TRUE,g_api[i].api06) RETURNING g_api[i].api06
                     DISPLAY g_api[i].api06 TO api06
 
                  WHEN INFIELD(api21)    #查詢異動碼-1
                       CALL s_ahe_qry(g_api[i].api04,'1','i',g_api[i].api21,g_bookno1)  
                         RETURNING g_api[i].api21
                       DISPLAY g_api[i].api21 TO api21
                       NEXT FIELD api21
                  
                  WHEN INFIELD(api22)    #查詢異動碼-2
                       CALL s_ahe_qry(g_api[i].api04,'2','i',g_api[i].api22,g_bookno1)  
                         RETURNING g_api[i].api22
                       DISPLAY g_api[i].api22 TO api22
                       NEXT FIELD api22
                  
                  WHEN INFIELD(api23)    #查詢異動碼-3
                       CALL s_ahe_qry(g_api[i].api04,'3','i',g_api[i].api23,g_bookno1)  
                         RETURNING g_api[i].api23
                       DISPLAY g_api[i].api23 TO api23
                       NEXT FIELD api23
                  
                  WHEN INFIELD(api24)    #查詢異動碼-4
                       CALL s_ahe_qry(g_api[i].api04,'4','i',g_api[i].api24,g_bookno1)  
                         RETURNING g_api[i].api24
                       DISPLAY g_api[i].api24 TO api24
                       NEXT FIELD api24
                  
                  WHEN INFIELD(api31)    #查詢異動碼-5
                       CALL s_ahe_qry(g_api[i].api04,'5','i',g_api[i].api31,g_bookno1)  
                         RETURNING g_api[i].api31
                       DISPLAY g_api[i].api31 TO api31
                       NEXT FIELD api31
                  
                  WHEN INFIELD(api32)    #查詢異動碼-6
                       CALL s_ahe_qry(g_api[i].api04,'6','i',g_api[i].api32,g_bookno1)  
                         RETURNING g_api[i].api32
                       DISPLAY g_api[i].api32 TO api32
                       NEXT FIELD api32
                  
                  WHEN INFIELD(api33)    #查詢異動碼-7
                       CALL s_ahe_qry(g_api[i].api04,'7','i',g_api[i].api33,g_bookno1)  
                         RETURNING g_api[i].api33
                       DISPLAY g_api[i].api33 TO api33
                       NEXT FIELD api33
                  
                  WHEN INFIELD(api34)    #查詢異動碼-8
                       CALL s_ahe_qry(g_api[i].api04,'8','i',g_api[i].api34,g_bookno1)  
                         RETURNING g_api[i].api34
                       DISPLAY g_api[i].api34 TO api34
                       NEXT FIELD api34
                  
                  WHEN INFIELD(api26)    #專案
                    CALL cl_init_qry_var()
                    LET g_qryparam.form ="q_pja2"  
                    CALL cl_create_qry() RETURNING g_api[i].api26 
                    DISPLAY BY NAME g_api[i].api26
                    NEXT FIELD api26
                  
                  WHEN INFIELD(api35)    #查詢異動碼-9(WBS)
                     CALL cl_init_qry_var()
                     LET g_qryparam.form ="q_pjb4"
                     LET g_qryparam.arg1 = g_api[i].api26  
                     CALL cl_create_qry() RETURNING g_api[i].api35 
                     DISPLAY BY NAME g_api[i].api35
                       NEXT FIELD api35
                  
                  WHEN INFIELD(api36)    #查詢異動碼-10(費用原因)
                    CALL cl_init_qry_var()
                    #No.TQC-B50067  --Begin
                    #LET g_qryparam.form ="q_azf"
                    #LET g_qryparam.arg1 = '2'
                    LET g_qryparam.form ="q_azf01a"
                    LET g_qryparam.arg1 = '7'
                    #No.TQC-B50067  --End
                    CALL cl_create_qry() RETURNING g_api[i].api36
                    DISPLAY g_api[i].api36 TO api36
                    NEXT FIELD api36
  
                  WHEN INFIELD(api37)    #關係人
                       CALL s_ahe_qry(g_api[i].api04,'99','i',g_api[i].api37,g_bookno1) 
                         RETURNING g_api[i].api37
                       DISPLAY g_api[i].api37 TO api37
                       NEXT FIELD api37
               
 
                  OTHERWISE EXIT CASE
               END CASE
 
            ON ACTION CONTROLO
               IF INFIELD(api04) AND i > 1 THEN
                  LET g_api[i].* = g_api[i-1].*
                  DISPLAY g_api[i].* TO s_api[i].*           #MOD-B10011
               END IF
               IF INFIELD(api06) AND i > 1 THEN
                  LET g_api[i].api06 = g_api[i-1].api06
               END IF
 
            ON IDLE g_idle_seconds
               CALL cl_on_idle()
               CONTINUE INPUT
 
             ON ACTION about         #MOD-4C0121
                CALL cl_about()      #MOD-4C0121
 
             ON ACTION help          #MOD-4C0121
                CALL cl_show_help()  #MOD-4C0121
 
             ON ACTION controlg      #MOD-4C0121
                CALL cl_cmdask()     #MOD-4C0121
 
             ON ACTION controls                       #No.FUN-6B0033                                                                       
                CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
 
         END INPUT
      END IF
 
      IF l_exit_sw = 'Y' THEN
         EXIT WHILE
      END IF
   END WHILE
 
 
   CLOSE WINDOW t110_ccc_w
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      RETURN
   END IF
 
   CALL t110_ins_api(p_cmd)  
 
END FUNCTION
 
FUNCTION t110_api26(p_cmd,p_api26)
 DEFINE p_cmd      LIKE type_file.chr1,    #No.FUN-690028 VARCHAR(1)
        p_api26    LIKE api_file.api26,
        l_pjaacti  LIKE pja_file.pjaacti  #FUN-810045 
       ,l_pjaclose LIKE pja_file.pjaclose #FUN-960038
 
   LET g_errno = ' '
   SELECT pjaacti,pjaclose INTO l_pjaacti,l_pjaclose #No.FUN-960038 add pjaclose
     FROM pja_file WHERE pja01 = p_api26
   CASE WHEN STATUS=100          LET g_errno = 'agl-007'  #7926 
        WHEN l_pjaclose = 'Y'    LET g_errno = 'abg-503'  #FUN-960038
        WHEN l_pjaacti = 'N'     LET g_errno = '9028'           #FUN-810045 gjaacti->pjaacti
        OTHERWISE           LET g_errno = SQLCA.sqlcode USING '----------'
   END CASE
END FUNCTION
 
FUNCTION t110_api21(p_cmd,p_seq,p_key,p_aee01)
 DEFINE p_cmd    LIKE aag_file.aag151,    # 檢查否
        p_seq        LIKE aee_file.aee02, # 項         #FUN-660117
        p_key        LIKE aee_file.aee03, # 異動碼     #FUN-660117
        p_aee01      LIKE aee_file.aee01,
        l_aeeacti  LIKE aee_file.aeeacti,
        l_aee04    LIKE aee_file.aee04
 
   LET g_errno = ' '
   SELECT aee04,aeeacti INTO l_aee04,l_aeeacti FROM aee_file
    WHERE aee01 = p_aee01
      AND aee02 = p_seq
      AND aee03 = p_key
   CASE p_cmd
      WHEN '2'   #異動碼必須輸入不檢查
         IF p_key IS NULL OR p_key = ' ' THEN
            LET g_errno = 'agl-154'
         END IF
      WHEN '3'   #異動碼必須輸入要檢查
         CASE
            WHEN p_key IS NULL OR p_key = ' '
               LET g_errno = 'agl-154'
            WHEN l_aeeacti = 'N'
               LET g_errno = '9027'
            WHEN SQLCA.sqlcode = 100
               LET g_errno = 'agl-153'
            OTHERWISE
               LET g_errno = SQLCA.sqlcode USING'-------'
         END CASE
      OTHERWISE EXIT CASE
   END CASE
END FUNCTION
 
FUNCTION t110_ins_api(p_cmd)
   DEFINE p_cmd LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE i,j,k LIKE type_file.num5    #No.FUN-690028 SMALLINT
   LET j = ARR_COUNT()
   DELETE FROM api_file
    WHERE api01 = g_apa.apa01 AND api02 = p_cmd
   IF SQLCA.sqlcode THEN
      LET g_success = 'N'
      CALL cl_err3("del","api_file", g_apa.apa01,p_cmd,SQLCA.sqlcode,"","t110_ccc(ckp#1):",1)  #No.FUN-660122
      RETURN
   END IF
    FOR i = 1 TO g_api.getLength() #No.MOD-480131
      IF cl_null(g_api[i].api04) AND cl_null(g_api[i].api041) THEN    #No.TQC-7A0095 
         CONTINUE FOR 
      END IF
      IF g_api[i].api05f = 0 THEN CONTINUE FOR END IF
      LET g_api[i].api05 = cl_digcut(g_api[i].api05 ,g_azi04)   
      LET g_api[i].api05f= cl_digcut(g_api[i].api05f,t_azi04)   
      INSERT INTO api_file(api01,api02,api03,api04,api041,api07,api06,api05f,api05,      #No.FUN-680029
                           api26,api21,api22,api23,api24,        #No.FUN-830161
 
                           api31,api32,api33,api34,api35,api36,api37
                          ,api930   #CHI-8C0005 add
                          ,apilegal  #FUN-980001 add apilegal
                           )
           VALUES(g_apa.apa01,p_cmd,i,g_api[i].api04,g_api[i].api041,g_api[i].api07,       #No.FUN-680029
                  g_api[i].api06,g_api[i].api05f,g_api[i].api05,
                  g_api[i].api26,g_api[i].api21,                 #No.FUN-830161
                  g_api[i].api22,g_api[i].api23,g_api[i].api24,
 
                  g_api[i].api31,g_api[i].api32,g_api[i].api33,g_api[i].api34,
                  g_api[i].api35,g_api[i].api36,g_api[i].api37
                 ,g_api[i].api930   #CHI-8C0005 add 
                 ,g_legal   #FUN-980001 add g_legal
                  )
      IF SQLCA.sqlcode THEN
         CALL cl_err3("ins","api_file",g_apa.apa01,p_cmd,SQLCA.sqlcode,"","t110_ccc(ckp#2):",1)  #No.FUN-660122
      END IF
   END FOR
END FUNCTION
 
FUNCTION t110_ins_api_12()
   DEFINE p_apa            RECORD LIKE apa_file.*
   DEFINE p_apb            RECORD LIKE apb_file.*
   DEFINE p_api            RECORD LIKE api_file.*
   DEFINE l_api            RECORD LIKE api_file.*
   DEFINE l_apc            RECORD LIKE apc_file.*
   DEFINE l_diff_api03     LIKE api_file.api03
   DEFINE l_diff_api05f    LIKE api_file.api05f
   DEFINE l_diff_api05     LIKE api_file.api05
   DEFINE l_apa00          LIKE apa_file.apa00
   DEFINE l_apa13          LIKE apa_file.apa13
   DEFINE l_apa72          LIKE apa_file.apa72
   DEFINE l_apa73          LIKE apa_file.apa73
   DEFINE l_apa541         LIKE apa_file.apa541
   DEFINE l_apc13          LIKE apc_file.apc13
   DEFINE l_api05          LIKE api_file.api05
   DEFINE l_api05f         LIKE api_file.api05f
   DEFINE l_apa14          LIKE apa_file.apa14
 
   LET g_success = 'Y'
   LET g_sql = "SELECT apa_file.*,apb_file.* FROM apa_file,apb_file ",
               " WHERE apa01 = apb01 ",
               "   AND apa00 = '12'",
               "   AND apa01 = '",g_apa.apa01,"'",
               " ORDER BY apa01,apb02 "
 
   PREPARE t110_preapi  FROM g_sql
   IF STATUS THEN
      CALL s_errmsg("apa01",g_apb[l_ac].apb21,"prepare",STATUS,0)
      RETURN
   END IF
 
   DECLARE t110_csapi CURSOR WITH HOLD FOR t110_preapi
 
   LET p_api.api02 = '2'
 
   FOREACH t110_csapi INTO p_apa.*,p_apb.*
      LET p_api.api01 = p_apa.apa01
      #尋找該筆資料存在, 何筆暫估中. 
      LET p_api.api26 = NULL
      LET p_api.api05f= NULL
      LET p_api.api05 = NULL
      LET p_api.api07 = NULL
      LET p_api.api04 = NULL
 
      LET g_sql = "SELECT apa00,apb01,apb24,apb10,apa22,apa54,apa541",
                  "  FROM apb_file,apa_file ",
                  "WHERE apb01 = '",p_apb.apb21,"'",
                  "  AND apb02 = '",p_apb.apb22,"'",
                  "  AND apb01 = apa01",
                  "  AND apa08 = 'UNAP'",
                  "  AND apa00 = '16'"
      PREPARE t110_preapb00  FROM g_sql                                                                                             
      IF STATUS THEN                                                                                                                
         LET g_showmsg=p_apb.apb21,"/",p_apb.apb22,"/","UNAP"
         CALL s_errmsg("apb21,apb22,apa08",g_showmsg,"prepare:",STATUS,0)
         CONTINUE FOREACH
      END IF                                                                                                                        
      DECLARE t110_csapb00 CURSOR WITH HOLD FOR t110_preapb00                                                                       
                                                                                                                                    
      FOREACH t110_csapb00 INTO l_apa00,p_api.api26,p_api.api05f,p_api.api05,p_api.api07,p_api.api04,l_apa541 #No.FUN-680029 新增l_apa541
         IF STATUS THEN
            LET g_success = 'N' 
            EXIT FOREACH 
         END IF 
 
         IF p_api.api26 IS NOT NULL AND p_api.api26 <> 'DIFF' THEN
            SELECT apa13,apa72,apa73,apa14          #TQC-940171 add apa14
              INTO l_apa13,l_apa72,l_apa73,l_apa14  #TQC-940171 add apa14
              FROM apa_file
             WHERE apa01=p_api.api26 AND apa41='Y' AND apa42='N'
            IF g_apz.apz27 = 'Y' AND g_aza.aza17 != l_apa13 THEN
               LET p_api.api05=p_api.api05f*l_apa72
               LET p_api.api05= cl_digcut(p_api.api05,g_azi04)
            END IF                                                                                                                     
            IF g_apz.apz27!= 'Y' AND g_aza.aza17 != l_apa13 THEN
               LET p_api.api05=p_api.api05f*l_apa14
               LET p_api.api05=cl_digcut(p_api.api05,g_azi04)
            END IF                                                                                                                     
         END IF                                                                                                                        
         IF p_api.api05f IS NULL THEN 
            LET p_api.api05f = 0 
         END IF 
         IF p_api.api05 IS NULL THEN
            LET p_api.api05 = 0 
         END IF 
 
         DECLARE t110_csapc CURSOR FOR
            SELECT apc_file.*,apa14 FROM apc_file,apa_file 
             WHERE apc01=apa01 AND apa01=p_api.api26
         FOREACH t110_csapc INTO l_apc.*,l_apa14
            IF p_api.api05 = 0 THEN
               EXIT FOREACH
            END IF
            IF l_apc.apc13=0 THEN
               CONTINUE FOREACH
            END IF
            IF l_apc.apc13>0 THEN
               IF p_api.api05 >= l_apc.apc13 THEN
                  LET l_api05 = l_apc.apc13
               ELSE
                  LET l_api05 = p_api.api05
               END IF
               SELECT * INTO l_api.* FROM api_file 
                WHERE api01=p_api.api01 AND api40=l_apc.apc02
                  AND api02=p_api.api02 AND api04=p_api.api04
                  AND api26=p_api.api26
               IF SQLCA.sqlcode = 100 THEN
                  LET l_api.* = p_api.*
                  SELECT MAX(api03)+1 INTO l_api.api03 FROM api_file
                   WHERE api01 = l_api.api01
                  IF cl_null(l_api.api03) THEN   #No.TQC-760006
                     LET l_api.api03 = 1
                  END IF 
                  LET l_api.api06 = 'UNAP:',l_api.api26
                  LET l_api.api05 = l_api05             #本幣
                  LET l_api.api05f= l_api05/l_apa14     #原幣=本幣/匯率   #TQC-6B0156
                  LET l_api.api40 = l_apc.apc02
                  LET l_api.api05 = cl_digcut(l_api.api05 ,g_azi04)   
                  LET l_api.api05f= cl_digcut(l_api.api05f,t_azi04)   
                  LET l_api.api35 = p_apb.apb36
                  LET l_api.api36 = p_apb.apb31
                  LET l_api.apilegal = g_legal #FUN-980001 add
                  INSERT INTO api_file VALUES (l_api.*)
                  IF SQLCA.sqlcode THEN
                     LET g_success = 'N'
                     LET g_showmsg=l_api.api01,"/",l_api.api02,"/",l_api.api03
                     CALL s_errmsg("api01,api02,api03",g_showmsg,"ins api_file",SQLCA.sqlcode,1)
                     CONTINUE FOREACH
                  ELSE 
                     LET p_api.api05 =  p_api.api05-l_api05
                  END IF
               ELSE   #No.TQC-760006
                  IF SQLCA.sqlcode = 0 THEN
                     IF l_api.api05+l_api05 <= l_apc.apc13 THEN
                        LET l_api.api05  =  l_api05+l_api.api05
                        LET l_api.api05f =  l_api.api05f + l_api05*l_apa14
                        UPDATE api_file SET api05  = l_api.api05,
                                            api05f = l_api.api05f
                         WHERE api01 = l_api.api01 AND  api40 = l_api.api40
                        IF SQLCA.sqlcode THEN
                           LET g_success='N'
                           LET g_showmsg=l_api.api01,"/",l_api.api40
                           CALL s_errmsg("api01,api40",g_showmsg,"upd api_file",SQLCA.sqlcode,1)
                           CONTINUE FOREACH
                        ELSE 
                           LET p_api.api05 =  p_api.api05-l_api05
                        END IF
                     ELSE
                        CONTINUE FOREACH
                     END IF
                  END IF
               END IF
            END IF 
         END FOREACH
      END FOREACH   #MOD-790033
   END FOREACH   #MOD-790033
 
   #有匯差的情況                                                                                         
   SELECT MAX(api03)+1,SUM(api05f),SUM(api05)                                                                                    
     INTO l_diff_api03,l_diff_api05f,l_diff_api05                                                                                
     FROM api_file WHERE api01 = p_api.api01                                                                                     
   IF l_diff_api05 != l_diff_api05f*g_apa.apa14 THEN                                                                             
      LET l_diff_api05 = l_diff_api05f*g_apa.apa14 - l_diff_api05                                                                
      LET l_diff_api05= cl_digcut(l_diff_api05,g_azi04)
      LET p_api.api03=l_diff_api03                                                                                               
      LET p_api.api04=''                                                                                                         
      LET p_api.api05f=0                                                                                                         
      LET p_api.api05=l_diff_api05                                                                                               
      LET p_api.api06=''                                                                                                         
      LET p_api.api26='DIFF'                                                                                                     
      LET p_api.api40=NULL
      LET p_api.api35 = ' '
      LET p_api.api36 = ' '
 
      LET p_api.apilegal = g_legal #FUN-980001 add
      INSERT INTO api_file VALUES(p_api.*)                                                                                       
      IF SQLCA.sqlcode THEN                                                                                                      
         IF cl_sql_dup_value(SQLCA.SQLCODE) THEN 
            UPDATE api_file SET api05 = l_diff_api05                                                                             
             WHERE api01=p_api.api01                                                                                             
               AND api26='DIFF'                                                                                                  
            IF SQLCA.sqlcode THEN                                                                                                
               LET g_success = 'N'                                                                                               
               LET g_showmsg=p_api.api01,"/","DIFF"
               CALL s_errmsg("api01,api26",g_showmsg,"",SQLCA.sqlcode,1)
            END IF                                                                                                               
         ELSE
            LET g_success = 'N'                                                                                                  
            LET g_showmsg=p_api.api01,"/",p_api.api02,"/",p_api.api03
            CALL s_errmsg("api01,api02,api03",g_showmsg,"insert api diff",SQLCA.sqlcode,1)
         END IF                                                                                                                  
      END IF                                                                                                                     
   END IF                                                                                                                        
END FUNCTION
 
FUNCTION t110_xw()
DEFINE  g_aba14_t  LIKE aba_file.aba14    #No.TQC-950004 
DEFINE  chk_aba00  LIKE type_file.num5    #MOD-C40155 add
DEFINE l_cnt       LIKE type_file.num5    #MOD-C40155 add
 
   OPEN WINDOW t110_xw2 AT 2,18 WITH FORM "agl/42f/aglt1101"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No.FUN-580092 HCN
 
   CALL cl_ui_locale("aglt1101")
 
   CALL cl_set_head_visible("","YES")            #No.FUN-6B0033
 
   LET g_aba.aba00 = g_apz.apz02b                                                  #MOD-C40155 add
   DISPLAY BY NAME g_aba.aba00                                                     #MOD-C40155 add
  #INPUT BY NAME g_aba.aba13,g_aba.aba14,g_aba.aba15 WITHOUT DEFAULTS              #MOD-C40155 mark
   INPUT BY NAME g_aba.aba13,g_aba.aba14,g_aba.aba15,g_aba.aba00 WITHOUT DEFAULTS  #MOD-C40155 add
      AFTER FIELD aba14
         IF g_aba.aba14 = '0' THEN
            LET INT_FLAG=1
            EXIT INPUT
         END IF
         IF g_aba.aba14 NOT MATCHES "[123]" THEN
            NEXT FIELD aba14
         END IF
         IF NOT cl_null(g_aba14_t) AND g_aba.aba14 <> g_aba14_t THEN            
            LET g_aba.aba15 =NULL                                               
         END IF                                                                 
         LET g_aba14_t =g_aba.aba14                                             
 
      AFTER FIELD aba15
         IF NOT cl_null(g_aba.aba15) THEN    #No.TQC-950004  
         SELECT aha01 FROM aha_file
          WHERE aha000 = g_aba.aba14 AND aha01 = g_aba.aba15
            AND aha00 = g_bookno1    #TQC-750121
         IF STATUS THEN
            CALL cl_err3("sel","aha_file",g_aba.aba14,g_aba.aba15,SQLCA.sqlcode,"","",1)  #No.FUN-660122
            NEXT FIELD aba15
         END IF
         END IF                 #No.TQC-950004
 
     #------------------------MOD-C40155----------------------(S)
      AFTER FIELD aba00
         IF NOT cl_null(g_aba.aba00) THEN
            SELECT COUNT(*) INTO l_cnt FROM aha_file
             WHERE aha00 = g_aba.aba00
               AND aha01 = g_aba.aba15
            IF l_cnt = 0 THEN
               CALL cl_err('','agl-090',0)
               NEXT FIELD  aba00
            END IF
          END IF
     #------------------------MOD-C40155----------------------(E)

      ON ACTION CONTROLP
        #IF INFIELD(aba15) THEN                                                 #MOD-C40155 mark
         CASE                                                                   #MOD-C40155 add
            WHEN INFIELD(aba15)                                                 #MOD-C40155 add
                 CALL q_aha(FALSE,TRUE,g_aba.aba15,g_apz.apz02b,g_aba.aba14)
                 RETURNING g_aba.aba15
                 DISPLAY BY NAME g_aba.aba15
        #END IF                                                                 #MOD-C40155 mark
        #------------------------MOD-C40155----------------------(S)
            WHEN INFIELD(aba00)
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_aaa"
                 CALL cl_create_qry() RETURNING g_aba.aba00
                 DISPLAY BY NAME g_aba.aba00
         END CASE
        #------------------------MOD-C40155----------------------(E)
 
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
 
   END INPUT
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      CLOSE WINDOW t110_xw2
      RETURN
   END IF
   DECLARE t110_c5 CURSOR FOR
      SELECT * FROM ahb_file
       WHERE ahb000 = g_aba.aba14 
         AND ahb01 = g_aba.aba15 
         AND ahb06 = '1'
         AND ahb00 = g_aba.aba00               #MOD-C40155 add
   CASE WHEN g_aba.aba14 = '1' CALL t110_xw1()     # 固定金額
        WHEN g_aba.aba14 = '2' CALL t110_xw2()     # 固定比率
        WHEN g_aba.aba14 = '3' CALL t110_xw3()     # 變動比率
   END CASE
   CLOSE WINDOW t110_xw2
END FUNCTION
 
FUNCTION t110_xw1()
   DEFINE l_ahb         RECORD LIKE ahb_file.*
   DEFINE l_amt         LIKE type_file.num20_6     # No.FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_amt2        LIKE type_file.num20_6     #MOD-6B0067
   DEFINE l_tot1,l_tot2 LIKE type_file.num20_6     # No.FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_seq         LIKE type_file.num5        # No.FUN-690028 SMALLINT
   DEFINE l_seq1,l_seq2 LIKE type_file.num5        # No.FUN-690028 SMALLINT
   DEFINE l_api06       LIKE api_file.api06        #CHI-910036 
 
   LET l_api06 = ''  #CHI-910036 
   LET l_seq = 0
   SELECT MAX(api03) INTO l_seq FROM api_file WHERE api01=g_apa.apa01
   IF l_seq IS NULL THEN LET l_seq=0 END IF
   LET l_tot1 = 0 LET l_tot2 = 0
   LET g_success = 'Y'
   BEGIN WORK
   CALL t110_lock_cl()  #FUN-C80078 add
   OPEN t110_cl USING g_apa.apa01
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl xw1:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF
   FOREACH t110_c5 INTO l_ahb.*
      LET l_amt = l_ahb.ahb07
      LET l_amt = cl_digcut(l_amt,g_azi04)   #MOD-6B0067
      IF l_amt = 0 THEN CONTINUE FOREACH END IF #no.5577
      LET l_amt2 = cl_digcut(l_amt/g_apa.apa14,t_azi04)   #MOD-6B0067
      LET l_seq = l_seq + 1
      IF cl_null(l_ahb.ahb04) THEN                                                                                                  
         LET l_api06 = g_apa.apa25                                                                                                  
      ELSE                                                                                                                          
         LET l_api06 = l_ahb.ahb04                                                                                                  
      END IF                                                                                                                        
      MESSAGE " SEQ:",l_seq USING '###', " AMT:",l_amt
       INSERT INTO api_file(api01,api02,api03,api04,api05f,api05,api06,api061,  #No.MOD-470041
                           api062,api07,api21,api22,api23,api24,
 
                           api31,api32,api33,api34,api35,api36,api37,
 
                           api26,api930,apilegal) #No.FUN-830161   #CHI-8C0005 add api930 #FUN-980001 add apilegal
              VALUES (g_apa.apa01,'1',l_seq,l_ahb.ahb03,l_amt2,l_amt,l_api06,    #CHI-910036  
                     '','',l_ahb.ahb05,l_ahb.ahb11,l_ahb.ahb12,l_ahb.ahb13,
                     l_ahb.ahb14,
 
                     l_ahb.ahb31,l_ahb.ahb32,l_ahb.ahb33,l_ahb.ahb34,
                     l_ahb.ahb35,l_ahb.ahb36,l_ahb.ahb37,
 
                     l_ahb.ahb08,g_apa.apa930,g_legal) #No.FUN-830161  #CHI-8C0005 add apa930 #FUN-980001 add g_legal
      IF STATUS OR SQLCA.SQLCODE THEN
         CALL cl_err3("ins","api_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_xw(ckp#4)",1)  #No.FUN-660122
         LET g_success = 'N'
         EXIT FOREACH
      END IF
   END FOREACH
   MESSAGE ''
   IF g_success = 'Y' THEN
      COMMIT WORK
   ELSE
      ROLLBACK WORK
   END IF
END FUNCTION
 
FUNCTION t110_xw2()
   DEFINE l_ahb         RECORD LIKE ahb_file.*
   DEFINE l_amt         LIKE type_file.num20_6     # No.FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_amt2        LIKE type_file.num20_6     #MOD-6B0067
   DEFINE l_tot1,l_tot2 LIKE type_file.num20_6     # No.FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_seq         LIKE type_file.num5        # No.FUN-690028 SMALLINT
   DEFINE l_seq1,l_seq2 LIKE type_file.num5        # No.FUN-690028 SMALLINT
   DEFINE l_api06       LIKE api_file.api06        #CHI-910036 
 
   LET l_api06 ='' #CHI-910036 
   LET l_seq = 0
   SELECT MAX(api03) INTO l_seq FROM api_file WHERE api01=g_apa.apa01
   IF l_seq IS NULL THEN LET l_seq=0 END IF
   LET l_tot1 = 0 LET l_tot2 = 0
   LET g_success = 'Y'
   BEGIN WORK
   CALL t110_lock_cl()  #FUN-C80078 add 
   OPEN t110_cl USING g_apa.apa01
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl xw2:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF
   FOREACH t110_c5 INTO l_ahb.*
      LET l_amt = g_aba.aba13 * l_ahb.ahb07 / 100
      LET l_amt = cl_digcut(l_amt,g_azi04)   #MOD-6B0067
      IF l_amt = 0 THEN CONTINUE FOREACH END IF
      LET l_amt2 = cl_digcut(l_amt/g_apa.apa14,t_azi04)   #MOD-6B0067
      LET l_seq = l_seq + 1
      IF l_ahb.ahb06 = '1' THEN
         LET l_tot1 = l_tot1 + l_amt
         LET l_seq1 = l_seq
      ELSE
         LET l_tot2 = l_tot2 + l_amt
         LET l_seq2 = l_seq
      END IF
      IF cl_null(l_ahb.ahb04) THEN                                                                                                  
         LET l_api06 = g_apa.apa25                                                                                                  
      ELSE                                                                                                                          
         LET l_api06 = l_ahb.ahb04                                                                                                  
      END IF                                                                                                                        
      MESSAGE " SEQ:",l_seq USING '###', " AMT:",l_amt
       INSERT INTO api_file(api01,api02,api03,api04,api05f,api05,api06,api061,  #No.MOD-470041
                           api062,api07,api21,api22,api23,api24,
 
                           api31,api32,api33,api34,api35,api36,api37,
 
                           api26,api930,apilegal) #No.FUN-830161   #CHI-8C0005 add api930 #FUN-980001 add apilegal
             VALUES (g_apa.apa01,'1',l_seq,l_ahb.ahb03,l_amt2,l_amt,   #MOD-6B0067
                    l_api06,'','',l_ahb.ahb05,l_ahb.ahb11,l_ahb.ahb12,    #CHI-910036  
                     l_ahb.ahb13,l_ahb.ahb14,
 
                     l_ahb.ahb31,l_ahb.ahb32,l_ahb.ahb33,l_ahb.ahb34,
                     l_ahb.ahb35,l_ahb.ahb36,l_ahb.ahb37,
 
                     l_ahb.ahb08,g_apa.apa930,g_legal) #No.FUN-830161   #CHI-8C0005 add apa930 #FUN-980001 add g_legal
      IF STATUS OR SQLCA.SQLCODE THEN
         CALL cl_err3("ins","api_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_xw(ckp#4)",1)  #No.FUN-660122
         LET g_success = 'N'
         EXIT FOREACH
      END IF
   END FOREACH
   IF l_tot1 != g_aba.aba13 AND g_success = 'Y' THEN     # Debit 差異調整
      LET l_amt = g_aba.aba13 - l_tot1
      UPDATE api_file SET api05 = api05 + l_amt,
                          api05f=api05f + l_amt
       WHERE api01 = g_apa.apa01
         AND api02 = '1'
         AND api03 = l_seq1
   END IF
   MESSAGE ''
   IF g_success = 'Y' THEN
      COMMIT WORK
   ELSE
      ROLLBACK WORK
   END IF
END FUNCTION
 
FUNCTION t110_xw3()
   DEFINE l_ahb            RECORD LIKE ahb_file.*
   DEFINE l_amt            LIKE type_file.num20_6             #No.FUN-690028 DEC(20,6)#FUN-4B0079
   DEFINE l_amt2           LIKE type_file.num20_6             #MOD-6B0067
   DEFINE l_tot1,l_tot2    LIKE type_file.num20_6             #No.FUN-690028 DEC(20,6)#FUN-4B0079
   DEFINE l_seq            LIKE type_file.num5                #No.FUN-690028 SMALLINT
   DEFINE l_seq1,l_seq2    LIKE type_file.num5                #No.FUN-690028 SMALLINT
  #DEFINE l_amtarr ARRAY[50] OF LIKE type_file.num20_6        #No.FUN-690028 DEC(20,6)#FUN-4B0079 #MOD-D30142 mark
   DEFINE l_amtarr DYNAMIC ARRAY OF LIKE type_file.num20_6    #MOD-D30142 add 
   DEFINE l_amt_debit,l_amt_credit LIKE type_file.num20_6     #No.FUN-690028 DEC(20,6)#FUN-4B0079
   DEFINE l_rate        LIKE type_file.num20_6                #No.FUN-690028 DEC(20,6)#FUN-4B0079
   DEFINE l_aag04       LIKE aag_file.aag04                   #FUN-660117
   DEFINE l_api06       LIKE api_file.api06                   #CHI-910036  
 
   LET l_api06 = ''  #CHI-910036 
   LET g_success = 'Y'
   BEGIN WORK
   CALL t110_lock_cl()  #FUN-C80078 add
   OPEN t110_cl USING g_apa.apa01
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl xw3:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF
   LET l_seq = 0
   SELECT MAX(api03) INTO l_seq FROM api_file WHERE api01=g_apa.apa01
   IF l_seq IS NULL THEN LET l_seq=0 END IF
   LET l_amt_debit  = 0 LET l_amt_credit = 0
   CALL l_amtarr.clear()     #MOD-D30142
   FOREACH t110_c5 INTO l_ahb.*          # 先得基礎科目餘額
      SELECT aag04 INTO l_aag04 FROM aag_file WHERE aag01 = l_ahb.ahb16
                                                AND aag00 = g_bookno1      #No.FUN-730064
                                                AND aagacti = 'Y'          #No.MOD-B70280 add
      IF l_ahb.ahb05 IS NOT NULL THEN
         IF l_aag04 = '1' THEN  #資產類
            SELECT SUM(aao05-aao06) INTO l_amt FROM aao_file
                                    WHERE aao00 = g_apz.apz02b AND
                                    aao01 = l_ahb.ahb16 AND
                                    aao02 = l_ahb.ahb05 AND
                                    aao03 = YEAR(g_apa.apa02) AND
                                    aao04 <= MONTH(g_apa.apa02)
         ELSE  #損益類
            SELECT SUM(aao05-aao06) INTO l_amt FROM aao_file
                                   WHERE aao00 = g_apz.apz02b AND
                                         aao01 = l_ahb.ahb16 AND
                                         aao02 = l_ahb.ahb05 AND
                                         aao03 = YEAR(g_apa.apa02) AND
                                         aao04 = MONTH(g_apa.apa02)
         END IF
      ELSE
         IF l_aag04 = '1' THEN
            SELECT SUM(aah04-aah05) INTO l_amt FROM aah_file
             WHERE aah00 = g_apz.apz02b
               AND aah01 = l_ahb.ahb16
               AND aah02 = YEAR(g_apa.apa02)
               AND aah03 <= MONTH(g_apa.apa02)
         END IF
         IF l_aag04 = '2' THEN
            SELECT SUM(aah04-aah05) INTO l_amt FROM aah_file
             WHERE aah00 = g_apz.apz02b
               AND aah01 = l_ahb.ahb16
               AND aah02 = YEAR(g_apa.apa02)
               AND aah03 = MONTH(g_apa.apa02)
         END IF
      END IF   #MOD-660104
      IF SQLCA.sqlcode OR l_amt IS NULL THEN LET l_amt = 0 END IF   #MOD-660104
      LET l_seq = l_seq + 1
      LET l_amtarr[l_seq] = l_amt
      IF l_ahb.ahb06 = '1' THEN
         LET l_amt_debit  = l_amt_debit  + l_amt
      ELSE
         LET l_amt_credit = l_amt_credit + l_amt
      END IF
   END FOREACH
   LET l_seq = 0
   SELECT MAX(api03) INTO l_seq FROM api_file WHERE api01=g_apa.apa01
   IF l_seq IS NULL THEN LET l_seq=0 END IF
   LET l_tot1 = 0 LET l_tot2 = 0
   FOREACH t110_c5 INTO l_ahb.*                         # 再算分攤比率
      LET l_seq = l_seq + 1
      IF l_ahb.ahb06 = '1' THEN
         LET l_rate = l_amtarr[l_seq] / l_amt_debit
      ELSE
         LET l_rate = l_amtarr[l_seq] / l_amt_credit
      END IF
      LET l_amt = g_aba.aba13 * l_rate
      LET l_amt = cl_digcut(l_amt,g_azi04)   #MOD-6B0067
      IF l_amt = 0 THEN CONTINUE FOREACH END IF
      LET l_amt2 = cl_digcut(l_amt/g_apa.apa14,t_azi04)   #MOD-6B0067
      IF l_ahb.ahb06 = '1' THEN
         LET l_tot1 = l_tot1 + l_amt
         LET l_seq1 = l_seq
      ELSE
         LET l_tot2 = l_tot2 + l_amt
         LET l_seq2 = l_seq
      END IF
      IF cl_null(l_ahb.ahb04) THEN                                                                                                  
         LET l_api06 = g_apa.apa25                                                                                                  
      ELSE                                                                                                                          
         LET l_api06 = l_ahb.ahb04                                                                                                  
      END IF                                                                                                                        
      MESSAGE " SEQ:",l_seq USING '###'," AMT:",l_amt
       INSERT INTO api_file(api01,api02,api03,api04,api05f,api05,api06,api061,  #No.MOD-470041
                           api062,api07,api21,api22,api23,api24,
 
                           api31,api32,api33,api34,api35,api36,api37,
 
                           api26,api930,apilegal) #No.FUN-830161   #CHI-8C0005 add api930 #FUN-980001 add apilegal
             VALUES (g_apa.apa01,'1',l_seq,l_ahb.ahb03,l_amt2,l_amt,   #MOD-6B0067
                     l_api06,'','',l_ahb.ahb05,                   #CHI-910036   
                     l_ahb.ahb11, l_ahb.ahb12, l_ahb.ahb13, l_ahb.ahb14,
 
                     l_ahb.ahb31,l_ahb.ahb32,l_ahb.ahb33,l_ahb.ahb34,
                     l_ahb.ahb35,l_ahb.ahb36,l_ahb.ahb37,
 
                     l_ahb.ahb08,g_apa.apa930,g_legal) #No.FUN-830161   #CHI-8C0005 add apa930 #FUN-980001 add g_legal
      IF STATUS OR SQLCA.SQLCODE THEN
         CALL cl_err3("ins","api_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_xw(ckp#4)",1)  #No.FUN-660122
         LET g_success = 'N'
         EXIT FOREACH
      END IF
   END FOREACH
   IF l_tot1 != g_aba.aba13 AND g_success = 'Y' THEN     # Debit 差異調整
      LET l_amt = g_aba.aba13 - l_tot1
      UPDATE api_file SET api05 = api05 + l_amt,
                          api05f= api05f + l_amt
       WHERE api01 = g_apa.apa01 AND api02 = '1'
         AND api03 = l_seq1
   END IF
   MESSAGE ''
   IF g_success = 'Y' THEN
      COMMIT WORK
   ELSE
      ROLLBACK WORK
   END IF
END FUNCTION
 
#重要信息:t110_ppp中可以看得到三類資料
#1.和請款單身對應的暫估資料  正常產生方式:在請款單身錄入時,自動生成
#                            此類資料,不得在ppp()中做刪除
#                                     單號不得修改
#2.DIFF 有差異時,可以錄入的內容
#3.期初暫估資料  由于客戶上線時,會錄入一些期初暫估資料,這些暫估資料
#                是無法對應具體入庫單,所以無法在t110的單身中來做暫估衝帳
#                故只能在ppp()中自行來挑選,對于此類暫估單,由于和apb無直接對應
#                關系,所以可以INSERT/DELETE/UPDATE
#還有一個重要信息: 因為apb單身中,對于同一筆暫估單,衝多次都沒有關系
#                  但是也要和api中一一對應,故目api中的項次直接存放apb02
#                  這樣子,才可以在apb操作時,根據對應apb的具體操作來
#                  INSERT/DELETE/UPDATE api_file中對應衝暫估資料
FUNCTION t110_ppp(p_api02)
   DEFINE p_api02        LIKE api_file.api02 # 2.沖暫估AP (UNAP)#FUN-660117
   DEFINE b_api          RECORD LIKE api_file.*
   DEFINE l_api          DYNAMIC ARRAY OF RECORD
                          api26          LIKE api_file.api26,
                          api40          LIKE api_file.api40,      #No.FUN-680027
                          api04          LIKE api_file.api04,
                          api041         LIKE api_file.api041,     #No.FUN-680029
                          api07          LIKE api_file.api07,
                          api930         LIKE api_file.api930,  #CHI-8C0005 add
                          api05f         LIKE api_file.api05f,
                          api05          LIKE api_file.api05
                         END RECORD
   DEFINE l_api03_a      DYNAMIC ARRAY OF RECORD
                          api03          LIKE api_file.api03
                         END RECORD
   DEFINE l_apa33        LIKE apa_file.apa33
   DEFINE l_apa33f       LIKE apa_file.apa33f
   DEFINE l_amt          LIKE api_file.api05
   DEFINE l_amtf         LIKE api_file.api05f
   DEFINE l_tot          LIKE api_file.api05
   DEFINE l_totf         LIKE api_file.api05
   DEFINE l_apa54        LIKE apa_file.apa54
   DEFINE l_apa541       LIKE apa_file.apa541   #No.FUN-680029
   DEFINE l_apa22        LIKE apa_file.apa22
   DEFINE l_apa34f       LIKE apa_file.apa34f
   DEFINE l_apa34        LIKE apa_file.apa34
   DEFINE l_apa14        LIKE apa_file.apa14
   DEFINE l_apa08        LIKE apa_file.apa08
   DEFINE l_apa06        LIKE apa_file.apa06
   DEFINE l_apa07        LIKE apa_file.apa07
   DEFINE api26_o        LIKE api_file.api26
   DEFINE api40_o        LIKE api_file.api40
   DEFINE api05f_o       LIKE api_file.api05f
   DEFINE l_apa60f       LIKE apa_file.apa60f
   DEFINE l_apa60        LIKE apa_file.apa60
   DEFINE l_apa00        LIKE apa_file.apa00    #No.FUN-5B0081  區分是入庫暫估還是退貨暫估
   DEFINE l_apa13        LIKE apa_file.apa13
   DEFINE l_apa72        LIKE apa_file.apa72
   DEFINE l_apa73        LIKE apa_file.apa73
   DEFINE i,j,k,m        LIKE type_file.num5,   #No.FUN-690028 SMALLINT   #MOD-870011 add m
          l_allow_insert LIKE type_file.num5,   #可新增否  #No.FUN-690028 SMALLINT
          l_allow_delete LIKE type_file.num5    #可刪除否  #No.FUN-690028 SMALLINT
   DEFINE l_api05        LIKE api_file.api05    #MOD-640329
   DEFINE l_api05f       LIKE api_file.api05f   #MOD-640329
   DEFINE l_apb10        LIKE apb_file.apb10    #No.FUN-680010
   DEFINE l_apb24        LIKE apb_file.apb24    #No.FUN-680010
   DEFINE l_cnt          LIKE type_file.num5    #No.TQC-7B0083
   DEFINE l_apb21        LIKE apb_file.apb21    #No.TQC-7B0083
   DEFINE l_apb22        LIKE apb_file.apb22    #No.TQC-7B0083
   DEFINE l_flag         LIKE type_file.chr1    #No.TQC-7B0083
   DEFINE m_aag05        LIKE aag_file.aag05    #MOD-890084 add
   DEFINE m_aag05_1      LIKE aag_file.aag05    #CHI-8C0005 add
 
      IF g_apa.apa56 != '5' THEN   #5.沖期初開帳的暫估   #CHI-930001 add
         LET l_cnt = 0 
         SELECT COUNT(*) INTO l_cnt FROM apb_file
          WHERE apb01 = g_apa.apa01
            AND apb34 = 'Y'
         IF l_cnt = 0 THEN 
            CALL cl_err(g_apa.apa01,'aap-134',1)   #MOD-920382 add
            RETURN
         END IF
      END IF   #CHI-930001 add
 
#  IF cl_null(g_apa.apa01) OR cl_null(s_get_serial_no(g_apa.apa01,'','')) THEN  #FUN-960081     #No.TQC-A30134
   IF cl_null(g_apa.apa01) OR cl_null(s_get_serial_no('AAP',g_apa.apa01,'')) THEN   #FUN-960081  #No.TQC-A30134
      RETURN
   END IF

  #-MOD-BB0304-add-
  #IF g_apa.apa63 MATCHES '[Ss1]' THEN  #MOD-C30708 MARK 
   IF g_apa.apa63 MATCHES '[Ss]' THEN   #MOD-C30708 ADD
      CALL cl_err('','mfg3557',0)
      RETURN
   END IF
  #-MOD-BB0304-end-

   #No.MOD-B80270  --Begin
   IF g_apz.apz13 = 'Y' THEN
      SELECT * INTO g_aps.* FROM aps_file WHERE aps01 = g_apa.apa22
   ELSE
      SELECT * INTO g_aps.* FROM aps_file WHERE (aps01 = ' ' OR aps01 IS NULL)
   END IF
   #No.MOD-B80270  --Begin 
   #no.5916 必須扣除折讓金額
   SELECT apa60f,apa60,apa33,apa33f INTO l_apa60f,l_apa60,l_apa33,l_apa33f
     FROM apa_file WHERE apa01 = g_apa.apa01
 
   IF cl_null(l_apa60f) THEN
      LET l_apa60f = 0
   END IF
 
   IF cl_null(l_apa60)  THEN
      LET l_apa60 = 0
   END IF
   IF cl_null(l_apa33) THEN
      LET l_apa33 = 0
   END IF
   IF cl_null(l_apa33f) THEN
      LET l_apa33f = 0
   END IF
   LET l_apb10=0
   LET l_apb24=0
   SELECT SUM(apb10),SUM(apb24) INTO l_apb10,l_apb24 FROM apb_file
    WHERE apb01=g_apa.apa01
      AND apb34='N'
   IF cl_null(l_apb10) THEN LET l_apb10=0 END IF
   IF cl_null(l_apb24) THEN LET l_apb24=0 END IF
 
  #計算沖暫估單頭的金額時,不需扣掉折讓金額
   LET l_amt  = g_apa.apa31  - l_apb10 - l_apa33
   LET l_amtf = g_apa.apa31f - l_apb24 - l_apa33f
 
   CALL cl_set_comp_visible("api930",g_aaz.aaz90='Y')  #CHI-8C0005 add
 
   OPEN WINDOW t110_ppp_w AT 11,9 WITH FORM "aap/42f/aapt110_p"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No.FUN-580092 HCN
 
    CALL cl_ui_locale("aapt110_p")
 
    IF g_aza.aza63 ='N' THEN
       CALL cl_set_comp_visible("api041",FALSE)
    END IF
    CALL cl_set_comp_entry("api40",FALSE)    #No.TQC-7B0083
 
   DISPLAY g_apa.apa01,l_amt,l_amtf TO api01,l_amt,l_amtf
   DECLARE t110_ppp_c CURSOR FOR
      SELECT api26,api40,api04,api041,api07,api930,api05f,api05,api03        #No.FUN-680027 No.FUN-680029  #No.TQC-7B0083   #CHI-8C0005 add api930
        FROM api_file
       WHERE api01 = g_apa.apa01 AND api02 = p_api02
       ORDER BY api26
   LET k = 1
   LET l_tot = 0
   LET l_totf= 0
 
   FOREACH t110_ppp_c INTO l_api[k].*,l_api03_a[k].api03      #No.TQC-7B0083
      IF STATUS THEN CALL cl_err('t110_ppp_c',STATUS,0) EXIT FOREACH END IF
     #-MOD-C20104-mark-
     #IF g_apz.apz27 = 'Y' AND g_aza.aza17 != g_apa.apa13 THEN
     #  #應抓取暫估單aapt160的重評價匯率，而非沖暫估單aapt120的重評價匯率
     #   IF l_api[k].api26 != 'DIFF' THEN
     #      SELECT apa72 INTO l_apa72 FROM apa_file WHERE apa01=l_api[k].api26
     #      IF cl_null(l_apa72) THEN LET l_apa72=1 END IF
     #      LET l_api[k].api05=l_api[k].api05f*l_apa72
     #   END IF
     #   LET l_api[k].api05=cl_digcut(l_api[k].api05,g_azi04)
     #END IF
     #-MOD-C20104-end-
      LET l_totf = l_totf+ l_api[k].api05f
      LET l_tot  = l_tot + l_api[k].api05
 
      LET k = k + 1
      IF k > g_max_rec THEN EXIT FOREACH END IF     #No.MOD-480131
   END FOREACH
   CALL l_api.deleteElement(k)
 
   LET k=k-1
   DISPLAY l_totf TO FORMONLY.api05_ft
   DISPLAY l_tot TO FORMONLY.api05_t
 
   IF g_apa.apa41 ='Y' THEN
      CALL cl_set_act_visible("accept,cancel", FALSE)
      DISPLAY ARRAY l_api TO s_api.* ATTRIBUTE(COUNT=k)
         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE DISPLAY
 
         ON ACTION about         #MOD-4C0121
            CALL cl_about()      #MOD-4C0121
 
         ON ACTION help          #MOD-4C0121
            CALL cl_show_help()  #MOD-4C0121
 
         ON ACTION controlg      #MOD-4C0121
            CALL cl_cmdask()     #MOD-4C0121
 
         ON ACTION controls                       #No.FUN-6B0033                                                                       
            CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
 
      END DISPLAY
      CLOSE WINDOW t110_ppp_w
      RETURN
   END IF
 
   IF g_apa.apa42 = 'Y' THEN
      CALL cl_err('','aap-165',0)
      CLOSE WINDOW t110_ppp_w
      RETURN
   END IF
 
   INPUT ARRAY l_api WITHOUT DEFAULTS FROM s_api.*
         ATTRIBUTE(COUNT=k,MAXCOUNT=g_max_rec,UNBUFFERED,
                   INSERT ROW=FALSE,         DELETE ROW=TRUE          ,APPEND ROW=TRUE          )  #No.TQC-7B0083
 
      BEFORE ROW
         LET i = ARR_CURR()
         LET j = SCR_LINE()
         LET l_totf = 0
         LET l_tot = 0
          FOR k = 1 TO l_api.getLength()    #No.MOD-480131
            IF l_api[k].api26 IS NULL THEN
               CONTINUE FOR
            END IF
            IF l_api[k].api05 IS NULL THEN
               CONTINUE FOR
            END IF
            LET l_totf= l_totf+ l_api[k].api05f
            LET l_tot = l_tot + l_api[k].api05
         END FOR
         DISPLAY l_totf TO FORMONLY.api05_ft
         DISPLAY l_tot TO FORMONLY.api05_t
         CALL cl_show_fld_cont()     #FUN-550037(smin)
         LET api26_o=l_api[i].api26  #No.TQC-7B0083
         NEXT FIELD api26
 
      BEFORE INSERT
         LET i = ARR_CURR()
         LET j = SCR_LINE()
         NEXT FIELD api26
 
      BEFORE FIELD api26
         IF l_api[i].api26 = 'DIFF' THEN
            IF l_api[i].api05 IS NULL AND l_api[i].api05f IS NULL THEN   #MOD-890038 add
               LET l_totf = 0
               LET l_tot = 0
               FOR k = 1 TO l_api.getLength()    #No.MOD-480131
                  IF l_api[k].api26 IS NULL THEN
                     CONTINUE FOR
                  END IF
                  IF l_api[k].api05 IS NULL THEN
                     CONTINUE FOR
                  END IF
                  LET l_totf = l_totf + l_api[k].api05f
                  LET l_tot = l_tot + l_api[k].api05
               END FOR
               LET l_api[i].api05f= l_amtf-l_totf
               LET l_api[i].api05 = l_amt -l_tot
               DISPLAY BY NAME l_api[i].api05f   #MOD-870011 add
               DISPLAY BY NAME l_api[i].api05    #MOD-870011 add
               LET l_totf=l_totf+l_api[i].api05f
               LET l_tot =l_tot +l_api[i].api05
               DISPLAY l_totf TO FORMONLY.api05_ft
               DISPLAY l_tot TO FORMONLY.api05_t
            END IF   #MOD-890038 add
         END IF
        #MOD-A70122---add---start---
         LET l_cnt = 0
         SELECT COUNT(*) INTO l_cnt FROM apa_file,apb_file,api_file
          WHERE apa01 = api01 AND api01 = g_apa.apa01
            AND apb01 = l_api[i].api26
         IF l_cnt > 0 THEN
            CALL cl_set_comp_entry("api05f,api05",FALSE)
         ELSE
            CALL cl_set_comp_entry("api05f,api05",TRUE)
         END IF
        #MOD-A70122---add---end---
 
      AFTER FIELD api26
         IF l_api[i].api26=g_apa.apa01 THEN
            LET l_api[i].api26=NULL
            NEXT FIELD api26
         END IF
         #單號不能隨便修改,因為項次和apb項次對應
         IF api26_o IS NOT NULL THEN
            IF api26_o <> l_api[i].api26 OR l_api[i].api26 IS NULL THEN
               LET l_api[i].api26 = api26_o
               NEXT FIELD api26
            END IF
         END IF
        
         IF l_api[i].api26 IS NOT NULL AND l_api[i].api26 <> 'DIFF' THEN
            DECLARE t110_find_stock CURSOR FOR 
             SELECT apb21,apb22 FROM apb_file
              WHERE apb01 = l_api[i].api26
            LET l_flag = 'N'
            FOREACH t110_find_stock INTO l_apb21,l_apb22
               LET l_cnt = 0
               SELECT COUNT(*) INTO l_cnt FROM apb_file
                WHERE apb21 = l_apb21 AND apb22 = l_apb22
                  AND apb01 = g_apa.apa01
                  AND apb34 = 'Y'
                  AND apb02 = l_api03_a[i].api03 #MOD-9C0252
               IF l_cnt > 0 THEN
                  LET l_flag = 'Y'
               END IF
            END FOREACH
            IF l_flag = 'N' THEN
               IF g_aptype = '12' OR
                 (g_aptype='21' AND g_apa.apa58='3') THEN   #MOD-850316 add
                  SELECT COUNT(*) INTO l_cnt FROM apb_file
                   WHERE apb21 = l_api[i].api26
                     AND apb01 = g_apa.apa01
                     AND apb34 = 'Y'
                     AND apb02 = l_api03_a[i].api03 #MOD-9C0252
                  IF l_cnt > 0 THEN
                     LET l_flag = 'Y'
                  END IF
               END IF
            END IF
            IF l_flag = 'N' THEN
               LET l_cnt = 0
               SELECT COUNT(*) INTO l_cnt FROM apb_file
                WHERE apb01 = l_api[i].api26
               IF l_cnt = 0 THEN
                  LET l_flag = 'Y'
               END IF
            END IF
            IF l_flag = 'N' THEN
               CALL cl_err(l_api[i].api26,'aap-814',1)
               NEXT FIELD api26   
            END IF
            SELECT apa34f-apa35f,apa34-apa35,apa54,apa541,apa22,apa14,apa08,apa06,
                   apa07,apa13,apa72,apa73,apa00
              INTO l_apa34f,l_apa34,l_apa54,l_apa541,l_apa22,l_apa14,l_apa08,l_apa06,
                   l_apa07,l_apa13,l_apa72,l_apa73,l_apa00
              FROM apa_file
             WHERE apa01=l_api[i].api26 AND apa41='Y' AND apa42='N'
            IF STATUS THEN
               CALL cl_err3("sel","apa_file",l_api[i].api26,"",STATUS,"","sel apa:",1)  #No.FUN-660122
               NEXT FIELD api26
            END IF
            IF l_apa08 !='UNAP' THEN
               CALL cl_err(l_apa08,'aap-023',0)
               NEXT FIELD api26
            END IF
                        
            #No.FUN-BC0031  --Begin
            IF (g_aptype ='11' AND l_apa00 = '26') OR (g_aptype ='21' AND l_apa00 = '16') THEN
               	 CALL cl_err(l_apa00,'axr-186',0)
                  NEXT FIELD api26
            END IF
            #No.FUN-BC0031  --End
            IF g_apz.apz27 = 'Y' AND g_aza.aza17 != l_apa13 THEN
               LET l_apa34 = l_apa73
               LET l_apa14 = l_apa72
            END IF
            #付款廠商,簡稱和當初立暫估的不同,秀警告訊息告知!
            IF l_apa06 !=g_apa.apa06 OR l_apa07 !=g_apa.apa07 THEN
               CALL cl_err(l_apa06,'aap-024',0)
            END IF
            SELECT SUM(api05),SUM(api05f) INTO l_api05,l_api05f 
              FROM api_file,apa_file
               WHERE api01=apa01 AND api26 = l_api[i].api26 AND 
                     api01 <> g_apa.apa01 AND apa41 = 'N' AND apa42 = 'N'  #No.MOD-710006  
           #MOD-C40218---S---
           #IF cl_null(l_api05) THEN LET l_api05 = 0 END IF
           #IF cl_null(l_api05f) THEN LET l_api05f = 0 END IF
           #MOD-C40218---E---
            IF g_aptype!='21' THEN    #MOD-850316 add
               IF l_apa00 = '26' THEN
                 #MOD-C40218---S---                                              
                 #LET l_api05 = l_api05 * -1                                       
                 #LET l_api05f = l_api05f * -1                                     
                 #MOD-C40218---E---
               END IF                                   
            END IF                    #MOD-850316 add                           
            IF l_api[i].api05 IS NULL OR l_api[i].api05 = 0 OR
               api26_o <> l_api[i].api26 OR cl_null(api26_o) THEN  #No.TQC-7B0083
               LET l_api[i].api04 = l_apa54
               IF g_aza.aza63 THEN                                              
                  LET l_api[i].api041 = l_apa541                                
               END IF                                                           
               LET l_api[i].api07 = l_apa22
              #MOD-C40218---S---
              #LET l_api[i].api05f= l_apa34f - l_api05f
              #LET l_api[i].api05 = l_apa34 - l_api05
              #MOD-C40218---E---
            END IF
            IF g_aptype!='21' THEN    #MOD-850316 add
               IF l_apa00 = '26' THEN    #MOD-750056
                 #MOD-C40218---S---
                 #IF l_api[i].api05f>0 THEN
                 #  LET l_api[i].api05f= l_api[i].api05f*(-1)
                 #END IF
                 #IF l_api[i].api05 >0 THEN
                 #  LET l_api[i].api05 = l_api[i].api05 *(-1) 
                 #END IF
                 #MOD-C40218---E---
               END IF
            END IF                    #MOD-850316 add
        #MOD-C40218---S---
        #LET l_api[i].api05 = cl_digcut(l_api[i].api05 ,g_azi04)  #No.MOD-830006
        #LET l_api[i].api05f= cl_digcut(l_api[i].api05f,t_azi04)  #No.MOD-830006
        #MOD-C40218---E---
         END IF
         IF l_api[i].api26 = 'DIFF' THEN
            IF l_api[i].api05 IS NULL AND l_api[i].api05f IS NULL THEN   #MOD-890038 add
               LET l_totf = 0
               LET l_tot = 0
               FOR k = 1 TO l_api.getLength()    #No.MOD-480131
                  IF l_api[k].api26 IS NULL THEN
                     CONTINUE FOR
                  END IF
                  IF l_api[k].api05 IS NULL THEN
                     CONTINUE FOR
                  END IF
                  LET l_totf = l_totf + l_api[k].api05f
                  LET l_tot = l_tot + l_api[k].api05
               END FOR
              #MOD-C40218---S---
              #LET l_api[i].api05f= l_amtf-l_totf
              #LET l_api[i].api05 = l_amt -l_tot
              #DISPLAY BY NAME l_api[i].api05f   #MOD-870011 add
              #DISPLAY BY NAME l_api[i].api05    #MOD-870011 add
              #LET l_totf=l_totf+l_api[i].api05f
              #LET l_tot =l_tot +l_api[i].api05
              #DISPLAY l_totf TO FORMONLY.api05_ft
              #DISPLAY l_tot TO FORMONLY.api05_t
              #MOD-C40218---S---
            END IF   #MOD-890038 add
            #No.MOD-B80270  --Begin
            IF cl_null(l_api[i].api04) THEN
               LET l_api[i].api04  = g_aps.aps44
            END IF
            IF cl_null(l_api[i].api041) THEN
               LET l_api[i].api041 = g_aps.aps441
            END IF
            DISPLAY BY NAME l_api[i].api04
            DISPLAY BY NAME l_api[i].api041
            #No.MOD-B80270  --End
         END IF
 
 
      AFTER FIELD api04
         IF NOT cl_null(l_api[i].api04) THEN
            CALL s_aapact(g_apz.apz11,g_bookno1,l_api[i].api04) RETURNING g_msg    #No.FUN-730064
            IF g_apz.apz02 = 'Y' AND NOT cl_null(g_errno) THEN
               CALL cl_err('sel aag:',g_errno,0)
               #No.FUN-B10050  --Begin
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"
               LET g_qryparam.construct = 'N'
               LET g_qryparam.default1 = g_api[i].api04
               LET g_qryparam.arg1 = g_bookno1
               LET g_qryparam.where = " aag03 ='2' AND aag01 LIKE '",g_api[i].api04 CLIPPED,"%'"
               CALL cl_create_qry() RETURNING g_api[i].api04
               DISPLAY BY NAME g_api[i].api04
               #No.FUN-B10050  --End
               NEXT FIELD api04
            END IF
            LET m_aag05=''
            SELECT aag05 INTO m_aag05 FROM aag_file
             WHERE aag01=l_api[i].api04
               AND aag00=g_bookno1
               AND aagacti = 'Y'                         #No.MOD-B70280 add
            IF STATUS OR SQLCA.SQLCODE THEN
               LET m_aag05=''
            END IF
            IF m_aag05 = 'Y' THEN
               CALL cl_set_comp_required("api07",TRUE)
            ELSE                                       #No.MOD-960152 add
               CALL cl_set_comp_required("api07",FALSE)#No.MOD-960152 add
            END IF
         END IF
 
      AFTER FIELD api041
         IF NOT cl_null(l_api[i].api041) THEN
            CALL s_aapact(g_apz.apz11,g_bookno2,l_api[i].api041) RETURNING g_msg      #No.FUN-730064
            IF g_apz.apz02 = 'Y' AND NOT cl_null(g_errno) THEN
               CALL cl_err('sel aag:',g_errno,0)
               #No.FUN-B10050  --Begin
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_aag02"
               LET g_qryparam.construct = 'N'
               LET g_qryparam.default1 = g_api[i].api041
               LET g_qryparam.arg1 = g_bookno2
               LET g_qryparam.where = " aag03 ='2' AND aag01 LIKE '",g_api[i].api041 CLIPPED,"%'"
               CALL cl_create_qry() RETURNING g_api[i].api041
               DISPLAY BY NAME g_api[i].api041
               #No.FUN-B10050  --End
               NEXT FIELD api041
            END IF
            LET m_aag05_1=''   #CHI-8C0005 mod
            SELECT aag05 INTO m_aag05_1 FROM aag_file   #CHI-8C0005 mod
             WHERE aag01=l_api[i].api041
               AND aag00=g_bookno2
               AND aagacti = 'Y'                         #No.MOD-B70280 add
            IF STATUS OR SQLCA.SQLCODE THEN
               LET m_aag05_1=''   #CHI-8C0005 mod
            END IF
            IF m_aag05_1 = 'Y' THEN   #CHI-8C0005 mod
               CALL cl_set_comp_required("api07",TRUE)
            END IF
         END IF
 
      AFTER FIELD api07
         LET m_aag05=''
         SELECT aag05 INTO m_aag05 FROM aag_file
          WHERE aag01=l_api[i].api04
            AND aag00=g_bookno1
            AND aagacti = 'Y'                         #No.MOD-B70280 add
         IF STATUS OR SQLCA.SQLCODE THEN
            LET m_aag05=''
         END IF
         IF g_aza.aza63 ='Y' THEN
            SELECT aag05 INTO m_aag05_1 FROM aag_file   #CHI-8C0005 mod
             WHERE aag01=l_api[i].api041
               AND aag00=g_bookno2
               AND aagacti = 'Y'                         #No.MOD-B70280 add
            IF STATUS OR SQLCA.SQLCODE THEN
               LET m_aag05_1=''   #CHI-8C0005 mod
            END IF
         END IF
         IF m_aag05 = 'Y' THEN
            IF cl_null(l_api[i].api07) THEN
               CALL cl_err(l_api[i].api07,'mfg0037',0)
               NEXT FIELD api07
            ELSE
               LET g_api[i].api930=s_costcenter(g_api[i].api07)  #CHI-8C0005 add
               DISPLAY BY NAME g_api[i].api930                   #CHI-8C0005 add
               SELECT gem02 FROM gem_file
                WHERE gem01 = l_api[i].api07
                  AND gem05 = 'Y'
                  AND gemacti = 'Y'
               IF SQLCA.sqlcode THEN
                  CALL cl_err3("sel","gem_file",l_api[i].api07,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                  NEXT FIELD api07
               END IF
               LET g_errno = ' '   #MOD-5B0255
               #科目有做科目部門管理的才CALL s_chkdept
              #CALL s_chkdept(g_aaz.aaz72,l_api[i].api04,l_api[i].api07,g_bookno1) RETURNING g_errno
              #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
               IF g_aaz.aaz90 !='Y' THEN
                  CALL s_chkdept(g_aaz.aaz72,l_api[i].api04,l_api[i].api07,g_bookno1) RETURNING g_errno
               END IF
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,0)
                  NEXT FIELD api07
               END IF
            END IF
         ELSE
            IF NOT cl_null(l_api[i].api07) THEN
               SELECT gem02 FROM gem_file
                WHERE gem01 = l_api[i].api07
                  AND gem05 = 'Y'
                  AND gemacti = 'Y'
               IF SQLCA.sqlcode THEN
                  CALL cl_err3("sel","gem_file",l_api[i].api07,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                  NEXT FIELD api07
               END IF
            END IF
         END IF   #MOD-890084 add
         IF m_aag05_1 = 'Y' THEN
            IF cl_null(l_api[i].api07) THEN
               CALL cl_err(l_api[i].api07,'mfg0037',0)
               NEXT FIELD api07
            ELSE
               LET g_api[i].api930=s_costcenter(g_api[i].api07)  #CHI-8C0005 add
               DISPLAY BY NAME g_api[i].api930                   #CHI-8C0005 add
               SELECT gem02 FROM gem_file
                WHERE gem01 = l_api[i].api07
                  AND gem05 = 'Y'
                  AND gemacti = 'Y'
               IF SQLCA.sqlcode THEN
                  CALL cl_err3("sel","gem_file",l_api[i].api07,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                  NEXT FIELD api07
               END IF
               LET g_errno = ' '   #MOD-5B0255
               #科目有做科目部門管理的才CALL s_chkdept
               IF g_aza.aza63 ='Y' THEN
                 #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                  IF g_aaz.aaz90 !='Y' THEN
                     CALL s_chkdept(g_aaz.aaz72,l_api[i].api041,l_api[i].api07,g_bookno2) RETURNING g_errno
                  END IF
               END IF
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,0)
                  NEXT FIELD api07
               END IF
            END IF
         ELSE
            IF NOT cl_null(l_api[i].api07) THEN
               SELECT gem02 FROM gem_file
                WHERE gem01 = l_api[i].api07
                  AND gem05 = 'Y'
                  AND gemacti = 'Y'
               IF SQLCA.sqlcode THEN
                  CALL cl_err3("sel","gem_file",l_api[i].api07,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                  NEXT FIELD api07
               END IF
            END IF
         END IF
 
      AFTER FIELD api930
         IF g_aaz.aaz90 ='Y' THEN
            IF NOT s_costcenter_chk(l_api[i].api930) THEN
               NEXT FIELD apb930
            ELSE
               LET m_aag05=''
               SELECT aag05 INTO m_aag05 FROM aag_file
                WHERE aag01=l_api[i].api04
                  AND aag00=g_bookno1
                  AND aagacti = 'Y'                         #No.MOD-B70280 add
               IF STATUS OR SQLCA.SQLCODE THEN
                  LET m_aag05=''
               END IF
               IF g_aza.aza63 ='Y' THEN
                  SELECT aag05 INTO m_aag05_1 FROM aag_file
                   WHERE aag01=l_api[i].api041
                     AND aag00=g_bookno2
                     AND aagacti = 'Y'                         #No.MOD-B70280 add
                  IF STATUS OR SQLCA.SQLCODE THEN
                     LET m_aag05_1=''
                  END IF
               END IF
               IF m_aag05 = 'Y' THEN
                  IF cl_null(l_api[i].api930) THEN
                     CALL cl_err(l_api[i].api930,'mfg0037',0)
                     NEXT FIELD api930
                  ELSE
                     SELECT gem02 FROM gem_file
                      WHERE gem01 = l_api[i].api930
                        AND gem05 = 'Y'
                        AND gemacti = 'Y'
                     IF SQLCA.sqlcode THEN
                        CALL cl_err3("sel","gem_file",l_api[i].api930,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                        NEXT FIELD api930
                     END IF
                     LET g_errno = ' '   #MOD-5B0255
                     #科目有做科目部門管理的才CALL s_chkdept
                     #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                     CALL s_chkdept(g_aaz.aaz72,l_api[i].api04,l_api[i].api930,g_bookno1) RETURNING g_errno
                     IF NOT cl_null(g_errno) THEN
                        CALL cl_err('',g_errno,0)
                        NEXT FIELD api930
                     END IF
                  END IF
               ELSE
                  IF NOT cl_null(l_api[i].api930) THEN
                     SELECT gem02 FROM gem_file
                      WHERE gem01 = l_api[i].api930
                        AND gem05 = 'Y'
                        AND gemacti = 'Y'
                     IF SQLCA.sqlcode THEN
                        CALL cl_err3("sel","gem_file",l_api[i].api930,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                        NEXT FIELD api930
                     END IF
                  END IF
               END IF
               IF m_aag05_1 = 'Y' THEN
                  IF cl_null(l_api[i].api930) THEN
                     CALL cl_err(l_api[i].api930,'mfg0037',0)
                     NEXT FIELD api930
                  ELSE
                     SELECT gem02 FROM gem_file
                      WHERE gem01 = l_api[i].api930
                        AND gem05 = 'Y'
                        AND gemacti = 'Y'
                     IF SQLCA.sqlcode THEN
                        CALL cl_err3("sel","gem_file",l_api[i].api930,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                        NEXT FIELD api930
                     END IF
                     LET g_errno = ' '   #MOD-5B0255
                     #科目有做科目部門管理的才CALL s_chkdept
                     #當使用利潤中心時(aaz90=Y),允許/拒絕部門的判斷請改用會科+成本中心
                     IF g_aza.aza63 ='Y' THEN
                        CALL s_chkdept(g_aaz.aaz72,l_api[i].api041,l_api[i].api930,g_bookno2) RETURNING g_errno
                     END IF
                     IF NOT cl_null(g_errno) THEN
                        CALL cl_err('',g_errno,0)
                        NEXT FIELD api930
                     END IF
                  END IF
               ELSE
                  IF NOT cl_null(l_api[i].api930) THEN
                     SELECT gem02 FROM gem_file
                      WHERE gem01 = l_api[i].api930
                        AND gem05 = 'Y'
                        AND gemacti = 'Y'
                     IF SQLCA.sqlcode THEN
                        CALL cl_err3("sel","gem_file",l_api[i].api930,"",STATUS,"","sel gem:",1)  #No.FUN-660122
                        NEXT FIELD api930
                     END IF
                  END IF
               END IF
            END IF
         END IF
 
      BEFORE FIELD api05f
         LET api05f_o=l_api[i].api05f
 
      AFTER FIELD api05f
         IF NOT cl_null(l_api[i].api05f) THEN
            IF l_api[i].api26 IS NOT NULL AND l_api[i].api26 <> 'DIFF' THEN
               SELECT apa34f-apa35f,apa34-apa35,apa54,apa22,apa14,
                      apa13,apa72,apa73
                 INTO l_apa34f,l_apa34,l_apa54,l_apa22,l_apa14,
                      l_apa13,l_apa72,l_apa73
                 FROM apa_file
                WHERE apa01=l_api[i].api26 AND apa41='Y' AND apa42='N'
               IF g_apz.apz27 = 'Y' AND g_aza.aza17 != l_apa13 THEN
                  LET l_apa34 = l_apa73
                  LET l_apa14 = l_apa72
               END IF
               IF cl_null(l_apa34f) THEN
                  LET l_apa34f = 0
               END IF
               IF cl_null(l_apa34) THEN
                  LET l_apa34 = 0
               END IF
               SELECT SUM(api05),SUM(api05f) INTO l_api05,l_api05f 
                 FROM api_file,apa_file
                  WHERE api01=apa01 AND api26 = l_api[i].api26 AND 
                        api01 <> g_apa.apa01 AND apa41 = 'N' AND apa42 = 'N'   #MOD-710006
               IF cl_null(l_api05) THEN LET l_api05 = 0 END IF
               IF cl_null(l_api05f) THEN LET l_api05f = 0 END IF
 
               IF s_abs(l_api[i].api05f) > l_apa34f - l_api05f THEN   #No.MOD-910069
                  CALL cl_err(l_apa34f,'mfg-025',0)
                  NEXT FIELD api05f
               END IF
               IF g_aptype!='21' THEN    #MOD-850316 add
                  IF l_apa00 = '26' THEN                                                                                                  
                     IF l_api[i].api05f>0 THEN                                                                                            
                       LET l_api[i].api05f= l_api[i].api05f*(-1)                                                                          
                     END IF                                                                                                               
                  END IF                                    
               END IF                    #MOD-850316 add                                                                              
            END IF
            IF l_api[i].api05 IS NULL OR l_api[i].api05 = 0 OR
               api05f_o <> l_api[i].api05f THEN
               LET l_api[i].api05 = l_api[i].api05f * l_apa14
            END IF
            LET l_api[i].api05f = cl_digcut(l_api[i].api05f,t_azi04) #No.MOD-830006
         END IF
 
      AFTER FIELD api05
         IF NOT cl_null(l_api[i].api05) THEN
            IF l_api[i].api26 IS NOT NULL AND l_api[i].api26 <> 'DIFF' THEN
               SELECT apa34f-apa35f,apa34-apa35,apa54,apa22,apa14,
                      apa13,apa72,apa73
                 INTO l_apa34f,l_apa34,l_apa54,l_apa22,l_apa14,
                      l_apa13,l_apa72,l_apa73
                 FROM apa_file
                WHERE apa01=l_api[i].api26 AND apa41='Y' AND apa42='N'
               IF g_apz.apz27 = 'Y' AND g_aza.aza17 != l_apa13 THEN
                   LET l_apa34 = l_apa73
                   LET l_apa14 = l_apa72
               END IF
               IF cl_null(l_apa34f) THEN
                  LET l_apa34f = 0
               END IF
               IF cl_null(l_apa34) THEN
                  LET l_apa34 = 0
               END IF
               SELECT SUM(api05),SUM(api05f) INTO l_api05,l_api05f 
                 FROM api_file,apa_file
                  WHERE api01=apa01 AND api26 = l_api[i].api26 AND 
                        api01 <> g_apa.apa01 AND apa41 = 'N' AND apa42 = 'N'  #MOD-710006
               IF cl_null(l_api05) THEN LET l_api05 = 0 END IF
               IF cl_null(l_api05f) THEN LET l_api05f = 0 END IF
 
               IF l_api[i].api05 > l_apa34 - l_api05 THEN
                  CALL cl_err(l_apa34,'mfg-025',0)
                  NEXT FIELD api05
               END IF
               IF g_aptype!='21' THEN    #MOD-850316 add
                  IF l_apa00 = '26' THEN                                                                                                  
                     IF l_api[i].api05 >0 THEN                                                                                            
                       LET l_api[i].api05 = l_api[i].api05 *(-1)                                                                          
                     END IF                                                                                                               
                  END IF                                   
               END IF                    #MOD-850316 add                                                                               
            END IF
            LET l_api[i].api05 = cl_digcut(l_api[i].api05,g_azi04) #No.MOD-830006
         END IF                                                                                                                     
 
      BEFORE DELETE
         #請款單身有衝暫估資料,不能刪除,否則造成不一致
         IF l_api[i].api26 IS NOT NULL AND l_api[i].api26 <> 'DIFF' THEN
            DECLARE t110_find_stock1 CURSOR FOR 
             SELECT apb21,apb22 FROM apb_file
              WHERE apb01 = l_api[i].api26
            LET l_flag = 'N'
            FOREACH t110_find_stock1 INTO l_apb21,l_apb22
               LET l_cnt = 0
               SELECT COUNT(*) INTO l_cnt FROM apb_file
                WHERE apb21 = l_apb21 AND apb22 = l_apb22
                  AND apb01 = g_apa.apa01
                  AND apb02 = l_api03_a[i].api03 #MOD-9C0252
                  AND apb34 = 'Y'
               IF l_cnt > 0 THEN
                  LET l_flag = 'Y'
               END IF
            END FOREACH
            IF l_flag = 'Y' THEN
               CALL cl_err(l_api[i].api26,'aap-338',1)
               CANCEL DELETE
            END IF
         END IF
         CALL l_api03_a.deleteElement(i)
 
      AFTER ROW
         IF INT_FLAG THEN EXIT INPUT  END IF
         IF cl_null(l_api[i].api05) OR cl_null(l_api[i].api05f) THEN
            INITIALIZE l_api[i].* TO NULL
         END IF
 
      AFTER INPUT
         LET l_tot = 0
         FOR k = 1 TO l_api.getLength()    #No.MOD-480131
            IF l_api[k].api26 IS NULL THEN
               CONTINUE FOR
            END IF
            IF l_api[k].api05 IS NULL THEN
               CONTINUE FOR
            END IF
            LET l_tot = l_tot + l_api[k].api05
         END FOR
         IF l_tot != l_amt THEN
            CALL cl_err('','aap-177',0)
            NEXT FIELD api26
         END IF
         IF INT_FLAG THEN
            EXIT INPUT
         END IF
 
        ON ACTION CONTROLP
           CASE
              WHEN INFIELD(api26)
                 IF api26_o IS NULL THEN
                    CALL q_apa3(FALSE,TRUE,l_api[i].api26,g_apa.apa06,g_apa.apa07,g_apa.apa01)   #MOD-640329   #MOD-750056
                    RETURNING l_api[i].api26,l_api[i].api40,l_api[i].api04,l_api[i].api041,    #No.FUN-680027
                              l_api[i].api07,l_api[i].api05f,l_api[i].api05
                    #No.FUN-BC0031  --Begin
                    DISPLAY l_api[i].api26 TO api26
                    DISPLAY l_api[i].api40 TO api40
                    DISPLAY l_api[i].api04 TO api04
                    DISPLAY l_api[i].api041 TO api041                           
                    DISPLAY l_api[i].api05f TO api05f
                    DISPLAY l_api[i].api05 TO api05
                    #No.FUN-BC0031  --End
                 END IF
              WHEN INFIELD(api041)
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_aag02"   #TQC-790133
                 LET g_qryparam.arg1 = g_bookno2  #TQC-790133
                 LET g_qryparam.default1 =l_api[i].api041
                 CALL cl_create_qry() RETURNING l_api[i].api041
                 DISPLAY l_api[i].api041 TO api041
              WHEN INFIELD(api04)
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_aag02"    #TQC-790133
                 LET g_qryparam.default1 =l_api[i].api04
                 LET g_qryparam.arg1 = g_bookno1      #No.FUN-730064
                 CALL cl_create_qry() RETURNING l_api[i].api04
                 DISPLAY l_api[i].api04 TO api04
              WHEN INFIELD(api07) # Dept CODE
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_gem"
                 LET g_qryparam.default1 =l_api[i].api07
                 CALL cl_create_qry() RETURNING l_api[i].api07
                 DISPLAY l_api[i].api07 TO api07
              WHEN INFIELD(api930)     #成本中心
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_gem4"
                 LET g_qryparam.default1 = l_api[i].api930
                 CALL cl_create_qry() RETURNING l_api[i].api930
                 DISPLAY l_api[i].api930 TO api930
            END CASE
 
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
      
   END INPUT
   CLOSE WINDOW t110_ppp_w
 
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      RETURN
   END IF
 
   BEGIN WORK              #No.MOD-480131
   CALL t110_lock_cl()  #FUN-C80078 add
   OPEN t110_cl USING g_apa.apa01
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl ppp:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF
 
   FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
       CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
       CLOSE t110_cl ROLLBACK WORK RETURN
   END IF
 
   LET g_success='Y'
   DELETE FROM api_file WHERE api01 = g_apa.apa01 AND api02 = p_api02
   IF STATUS THEN
      CALL cl_err3("del","api_file",g_apa.apa01,p_api02,STATUS,"","del api",1)  #No.FUN-660122
      LET g_success='N'
   END IF
 
    FOR k = 1 TO l_api.getLength()    #No.MOD-480131
      IF l_api[k].api26 IS NULL THEN
         CONTINUE FOR
      END IF
 
      IF l_api[k].api05 IS NULL THEN
         CONTINUE FOR
      END IF
 
      IF l_api[k].api05 = 0 THEN
         CONTINUE FOR
      END IF
 
      LET b_api.api01 =g_apa.apa01
      LET b_api.api02 =p_api02
      LET b_api.api03 =l_api03_a[k].api03
      LET b_api.api04 =l_api[k].api04
      LET b_api.api041=l_api[k].api041                 #No.FUN-680029
      LET b_api.api05f=l_api[k].api05f
      LET b_api.api05 =l_api[k].api05
      LET b_api.api07 =l_api[k].api07
      LET b_api.api930=l_api[k].api930   #CHI-8C0005 add
      LET b_api.api26 =l_api[k].api26
      IF b_api.api26 ='DIFF' THEN
         LET b_api.api40 =NULL
      ELSE
        # LET b_api.api40 =1                 #MOD-F30090 mark
          LET b_api.api40 = l_api[k].api40   #MOD-F30090 add  
      END IF
      IF cl_null(b_api.api03) THEN
         SELECT MAX(api03) INTO b_api.api03 FROM api_file
          WHERE api01 = g_apa.apa01   #CHI-930001 mod
            AND api02 = p_api02
         IF cl_null(b_api.api03) THEN LET b_api.api03 = 1 END IF
      END IF
      LET b_api.api05 = cl_digcut(b_api.api05 ,g_azi04)   
      LET b_api.api05f= cl_digcut(b_api.api05f,t_azi04)   
      LET b_api.apilegal= g_legal #FUN-980001 add
      INSERT INTO api_file VALUES(b_api.*)
      IF STATUS OR SQLCA.SQLCODE THEN
         CALL cl_err3("ins","api_file",b_api.api01,b_api.api02,SQLCA.sqlcode,"","ins api",1)  #No.FUN-660122
         LET g_success='N'
      END IF
   END FOR
 
   IF g_success='Y' THEN
      COMMIT WORK
   ELSE
      ROLLBACK WORK
   END IF
 
END FUNCTION
 
FUNCTION t110_ddd(l_cmd)   #MOD-950112 add參數
   DEFINE l_cmd                   LIKE type_file.chr1     #MOD-950112 add
   DEFINE l_depno                 LIKE apa_file.apa22,    #No.FUN-690028 VARCHAR(10),
          l_rec_b                 LIKE type_file.num5,    #No.FUN-690028 SMALLINT
          l_tot1,l_tot2,l_tot3    LIKE apa_file.apa31,
          l_totf1,l_totf2,l_totf3 LIKE apa_file.apa31f,
          l_tot28,l_tot28f        LIKE apk_file.apk28,
          i,j,k,u_sign            LIKE type_file.num5,    #No.FUN-690028 SMALLINT,
          l_n,l_nochk             LIKE type_file.num5,    #No.FUN-690028 SMALLINT,
          apk03_t                 LIKE apk_file.apk03,
          l_tax                   LIKE type_file.num20_6, #No.FUN-690028 DEC(20,6),  #FUN-4B0079
          l_flag1,l_flag          LIKE type_file.chr1,    #No.FUN-690028 VARCHAR(1)
          l_flag2                 LIKE type_file.chr1,    #MOD-620048  #No.FUN-690028 VARCHAR(1)
          l_del                   LIKE type_file.chr1,    #No.FUN-690028 VARCHAR(01),
          l_amb01,l_amb02         LIKE type_file.num5,    #No.FUN-690028 SMALLINT,
          l_amb03                 LIKE amb_file.amb03,    #No.FUN-690028 VARCHAR(02),
          l_chk                   LIKE type_file.chr1,    #No.FUN-690028 VARCHAR(1),
          l_ans                   LIKE type_file.chr1,    #No.FUN-690028 VARCHAR(01),
          l_ans1,l_opensw         LIKE type_file.chr1,    #No.FUN-690028 VARCHAR(01),           #85-09-23
          l_apa31                 LIKE apa_file.apa31,
          l_apa31f                LIKE apa_file.apa31f,
          l_apa32                 LIKE apa_file.apa32,
          l_apa32f                LIKE apa_file.apa32f,
          l_apa34f                LIKE apa_file.apa34f,
          l_apa34                 LIKE apa_file.apa34,
          l_apk02                 LIKE apk_file.apk02,    #MOD-950226 add
          l_apk29                 LIKE apk_file.apk29,
          l_azi04                 LIKE azi_file.azi04,
          apk11_t                 LIKE apk_file.apk11,
          apk08_t                 LIKE apk_file.apk08,
          apk08f_t                LIKE apk_file.apk08f,
          l_allow_insert          LIKE type_file.num5,    #可新增否  #No.FUN-690028 SMALLINT
          l_allow_delete          LIKE type_file.num5,    #可刪除否  #No.FUN-690028 SMALLINT
          l_gec07                 LIKE gec_file.gec07     #MOD-7C0053
   DEFINE apk13_t                 LIKE apk_file.apk13     #MOD-830075
   DEFINE p_cmd                   LIKE type_file.chr1     #CHI-940018
   DEFINE l_lock_sw               LIKE type_file.chr1     #CHI-940018
   DEFINE t_tot1,t_tot2,t_tot3    LIKE apa_file.apa31     #MOD-960106                                                               
   DEFINE t_tot28                 LIKE apk_file.apk28     #MOD-960106  
   DEFINE l_gec05                 LIKE gec_file.gec05     #CHI-930020 
   DEFINE g_t1                    LIKE oay_file.oayslip   #FUN-990014 add
   DEFINE l_apa171                LIKE apa_file.apa171    #MOD-B40115 add
   DEFINE l_gec04                 LIKE gec_file.gec04     #MOD-C90177 add
    
   IF g_aza.aza26 = '2' THEN   #大陸版功能
      CALL t110_ddd_c('')
      DISPLAY BY NAME g_apa.apa07      #TQC-630164 
      CALL t110_show_multi_invoice()   #No.TQC-A30076 
      RETURN
   END IF
 
   IF g_apa.apa42='Y' THEN
      RETURN
   END IF
 
   IF g_aptype != '21' THEN #No.CHI-A40005 add
      IF g_apa.apa08 != 'MISC' OR cl_null(g_apa.apa08) THEN
         RETURN
      END IF
   END IF                   #No.CHI-A40005 add
  #-MOD-B10013-add-
   BEGIN WORK
   IF g_apa.apa41 = 'Y' THEN       #MOD-C20048 add
      LET l_cmd = '1'              #MOD-C20048 add
   END IF                          #MOD-C20048 add
   IF l_cmd = '2' THEN
      CALL t110_lock_cl()  #FUN-C80078 add
      OPEN t110_cl USING g_apa.apa01
      IF STATUS THEN
         CALL cl_err("OPEN t110_cl b:", STATUS, 1)
         CLOSE t110_cl
         ROLLBACK WORK
         RETURN
      END IF
      FETCH t110_cl INTO g_apa_t.*    # 鎖住將被更改或取消的資料   
      IF SQLCA.sqlcode THEN
         CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
         CLOSE t110_cl
         ROLLBACK WORK
         RETURN
      END IF       
   END IF
  #-MOD-B10013-end-
   OPEN WINDOW t110_ddd_w AT 7,2
     WITH FORM "aap/42f/aapt110_d"  ATTRIBUTE (STYLE = g_win_style CLIPPED) #No.FUN-580092 HCN
 
   CALL cl_ui_locale("aapt110_d")
  #FUN-950094 ----------------------mark start---------------------------
  #IF g_aptype = '13' THEN
  #   CALL cl_set_comp_visible("apk07,apk07f",FALSE)
  #END IF
  #FUN-950094 ----------------------mark end----------------------------- 
 
   DECLARE t110_ddd_c CURSOR FOR
      SELECT apk02,apk11,apk171,apk17,apk172,
             apk05,apk03,apk04,apk12,apk13,   #No:8511為配合字軌檢查apk05要往前輸入 #No:8654
             apk08f,apk07f,apk06f,apk08,apk07,apk06,apk32    #FUN-970108 add apk32
        FROM apk_file
       WHERE apk01 = g_apa.apa01
       ORDER BY apk02
 
   CALL g_apk.clear()     #MOD-5B0340
   LET k = 1
   LET l_tot1 = 0
   LET l_tot2 = 0
   LET l_tot3 = 0
   LET t_tot1 = 0   #MOD-960106                                                                                                     
   LET t_tot2 = 0   #MOD-960106                                                                                                     
   LET t_tot3 = 0   #MOD-960106                                                                                                     
   LET t_tot28 = 0  #MOD-960106 
   LET i = 1
   LET l_tot28 = 0
   LET l_opensw = 'N'
 
   FOREACH t110_ddd_c INTO g_apk[k].*   #CHI-940018 i->l_ac       #MOD-950226
      IF g_apk[k].apk171 = '23' THEN
         LET u_sign = -1
      ELSE
         LET u_sign = 1
      END IF
 
      IF g_apk[k].apk171 = '28' OR g_apk[k].apk171 = '29' THEN
         LET l_tot28 = l_tot28 + g_apk[k].apk08 * u_sign
         LET l_tot2 = l_tot2 + g_apk[k].apk07 * u_sign
      ELSE
         LET l_tot1 = l_tot1 + g_apk[k].apk08 * u_sign
         LET l_tot2 = l_tot2 + g_apk[k].apk07 * u_sign
         LET l_tot3 = (l_tot1 + l_tot2)  #MOD-640457
      END IF
 
      IF cl_null(g_apk[k].apk03) THEN
         LET g_apk[k].apk03 = ' '
      END IF   #No:8511
 
      LET k = k + 1
 
       IF k > g_max_rec THEN    #No.MOD-480131
         EXIT FOREACH
      END IF
   END FOREACH
 
   CALL g_apk.deleteElement(k)
   LET l_rec_b  = k - 1
   LET t_tot1 = l_tot1 #MOD-960106                                                                                                  
   LET t_tot2 = l_tot2 #MOD-960106                                                                                                  
   LET t_tot3 = l_tot3 #MOD-960106                                                                                                  
   LET t_tot28 = l_tot28 #MOD-960106   
   DISPLAY BY NAME l_tot28,l_tot1,l_tot2,l_tot3
 
   IF g_apa.apa41 = 'Y' OR g_apa.apa63 MATCHES '[Ss1]' THEN  #MOD-BB0304 add apa63
      CALL cl_set_act_visible("accept,cancel", FALSE)
      DISPLAY ARRAY g_apk TO s_apk.*  ATTRIBUTE(COUNT=l_rec_b)
         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE DISPLAY
 
         ON ACTION about         #MOD-4C0121
            CALL cl_about()      #MOD-4C0121
 
         ON ACTION help          #MOD-4C0121
            CALL cl_show_help()  #MOD-4C0121
 
         ON ACTION controlg      #MOD-4C0121
            CALL cl_cmdask()     #MOD-4C0121
 
         ON ACTION controls                       #No.FUN-6B0033                                                                       
            CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
      END DISPLAY
      IF INT_FLAG THEN   #MOD-6B0035
         LET INT_FLAG = 0   #MOD-6B0035
         CLOSE WINDOW t110_ddd_w
         RETURN
      END IF   #MOD-6B0035
   ELSE
      LET g_forupd_sql = "SELECT apk02,apk11,apk171,apk17,apk172,",  #MOD-950226 add apk02
                         "       apk05,apk03,apk04,apk12,apk13,",
                         "       apk08f,apk07f,apk06f,apk08,apk07,apk06,apk32",  #FUN-970108 add apk32
                         "  FROM apk_file ",
                         " WHERE apk01 = '",g_apa.apa01,"'",                        
                         "   AND apk02 = ?",   #MOD-950226 add
                         "   AND apk03 = ?  FOR UPDATE"    #MOD-970145                                               
     LET g_forupd_sql = cl_forupd_sql(g_forupd_sql)
     DECLARE ddd_bcl CURSOR FROM g_forupd_sql      # LOCK CURSOR          
 
      #CHI-A40005 mod---start---
      #LET l_allow_insert = cl_detail_input_auth("insert")
      #LET l_allow_delete = cl_detail_input_auth("delete")
      IF  g_prog = 'aapt210' THEN
         LET l_allow_insert = FALSE 
         LET l_allow_delete = FALSE
       ELSE 
         LET l_allow_insert = cl_detail_input_auth("insert")
         LET l_allow_delete = cl_detail_input_auth("delete")
      END IF
      #CHI-A40005 ---end---

      INPUT ARRAY g_apk WITHOUT DEFAULTS FROM s_apk.*
            ATTRIBUTE(COUNT=l_rec_b,MAXCOUNT=g_max_rec,UNBUFFERED,
                      INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)
 
         BEFORE INPUT
            IF l_rec_b != 0 THEN             #CHI-940018  
               CALL fgl_set_arr_curr(i)      #CHI-940018  l_ac->i
            END IF                           #CHI-940018  
            LET l_del='N'
 
        #-MOD-B40086-add- 
         AFTER INPUT
           CALL t110_sum_apa32_1() RETURNING l_apa32,l_apa32f 
           IF (l_apa32 != g_apa.apa32 OR
             #l_apa32f != g_apa.apa32f) AND g_aptype = '21' THEN #MOD-B60016 mark
              l_apa32f != g_apa.apa32f) AND g_aptype = '21' AND g_aza.aza26 <> '2' THEN #MOD-B60016 
              CALL cl_err('','aap-212',1)
              NEXT FIELD apk07f 
           END IF    
        #-MOD-B40086-end- 

         BEFORE ROW
            LET i = ARR_CURR()
            LET j = SCR_LINE()
           LET p_cmd = ''
           LET l_opensw = 'N'
           LET g_success = 'Y'        
           BEGIN WORK      #MOD-B10013 mark #MOD-B10061 remark 
           INITIALIZE g_apk_t.* TO NULL          
          #-MOD-B10013-mark-
          #IF l_cmd = '2' THEN   #MOD-950112 add
          #   OPEN t110_cl USING g_apa.apa01
          #   IF STATUS THEN
          #      CALL cl_err("OPEN t110_cl b:", STATUS, 1)
          #      CLOSE t110_cl
          #      ROLLBACK WORK
          #      CLOSE WINDOW t110_ddd_w
          #      RETURN
          #   END IF
          #   FETCH t110_cl INTO g_apa_t.*    # 鎖住將被更改或取消的資料   #MOD-9A0070 mod
          #   IF SQLCA.sqlcode THEN
          #      CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
          #      CLOSE t110_cl
          #      ROLLBACK WORK
          #      CLOSE WINDOW t110_ddd_w
          #      RETURN
          #   END IF       
          #END IF   #MOD-950112 add
          #-MOD-B10013-end-
           LET apk03_t = g_apk[i].apk03
           LET apk11_t = g_apk[i].apk11
 
           #No.5945 稅率用多發票apk29的稅率不用apa16
           SELECT apk29 INTO l_apk29 FROM apk_file
            WHERE apk01 = g_apa.apa01
              AND apk02 = g_apk[i].apk02   #MOD-950226
              AND apk03 = g_apk[i].apk03
           IF cl_null(l_apk29) THEN LET l_apk29 = 0 END IF
           LET l_gec05 = ''                               #MOD-D20029 add
          #--------------MOD-C90177------------(S)
           SELECT gec04,gec05 INTO l_gec04,l_gec05        #MOD-D20029 add gec05
             FROM gec_file
            WHERE gec01 = g_apk[i].apk11
              AND gec011 = '1'
              AND gecacti = 'Y'
            IF cl_null(l_gec04)THEN LET l_gec04 = 0 END IF
            IF l_apk29 <> l_gec04 THEN
               LET l_apk29 = l_gec04
            END IF
          #--------------MOD-C90177------------(E)
        
          #FUN-950094 --------------------mark start---------------------- 
          ##當執行aapt121(g_aptype='13')時,不管選什麼稅別,都不算稅額,
          # IF g_aptype = '13' THEN LET l_apk29 = 0 END IF
          #FUN-950094 --------------------mark end-------------------------  

            SELECT azi04 INTO l_azi04 FROM azi_file
             WHERE azi01 = g_apk[i].apk12
               AND aziacti = 'Y'
 
            IF cl_null(l_azi04) THEN
               LET l_azi04 = 0
            END IF
 
            IF l_del = 'Y' THEN
               LET l_del = 'N'
               CALL cl_show_fld_cont()     #FUN-550037(smin)
            END IF
 
            IF g_apk[i].apk02 IS NULL THEN  #MOD-950226 mod apk11->apk02
               CALL cl_show_fld_cont()     #FUN-550037(smin)
               NEXT FIELD apk02   #MOD-950226 mod apk11->apk02
            END IF
         IF l_rec_b >= i THEN
              LET p_cmd='u'
              LET g_apk_t.* = g_apk[i].*  #BACKUP
              OPEN ddd_bcl USING g_apk_t.apk02,g_apk_t.apk03  #MOD-950226
              IF STATUS THEN
                 CALL cl_err("OPEN ddd_bcl:", STATUS, 1)
                 LET l_opensw = "Y"
              END IF
              FETCH ddd_bcl INTO g_apk[i].*
              IF SQLCA.sqlcode THEN
                 CALL cl_err(g_apk_t.apk03,SQLCA.sqlcode,1)
                 LET l_opensw = "Y"
              END IF
              LET g_before_input_done = FALSE
              CALL t110_set_entry_apk_120(p_cmd)
              CALL t110_set_no_entry_apk_120(p_cmd)
              LET g_before_input_done = TRUE
           END IF
           CALL t110_set_no_apk_required()  #FUN-970108 
           CALL t110_set_apk_required()     #FUN-970108
 
      BEFORE INSERT
           LET p_cmd='a'
           INITIALIZE g_apk[i].* TO NULL          
           LET g_apk_t.* = g_apk[i].*         #新輸入資料
           LET apk03_t = ''   #MOD-950226 add
           LET apk11_t = ''   #MOD-950226 add
           LET g_before_input_done = FALSE
           CALL t110_set_entry_apk_120(p_cmd)
           IF g_apk[i].apk171 = '28' OR g_apk[i].apk171 = '29' THEN
              LET g_apk[i].apk12 = g_aza.aza17
              LET g_apk[i].apk13 = 1
              CALL t110_set_no_entry_apk_120(p_cmd)
           END IF           
           #No.TQC-A30072  --Begin                                              
           IF NOT cl_null(g_apa.apa77) THEN                                     
              LET g_apk[i].apk32 = g_apa.apa77                                  
           ELSE                                                                 
              CALL s_get_doc_no(g_apa.apa01) RETURNING g_t1                     
              SELECT apyvcode INTO g_apk[i].apk32  FROM apy_file WHERE apyslip = g_t1
              IF cl_null(g_apk[i].apk32) THEN                                   
                 LET g_apk[i].apk32 = g_apz.apz63                               
              END IF                                                            
           END IF                                                               
           #No.TQC-A30072  --End         
           LET g_before_input_done = TRUE
           CALL cl_show_fld_cont()     
           NEXT FIELD apk02   #MOD-950226 mod apk11->apk02
           
        AFTER INSERT
            IF INT_FLAG THEN
              CALL cl_err('',9001,0)
              LET INT_FLAG = 0
              CANCEL INSERT
            END IF
            IF g_apk[i].apk06 IS NULL OR g_apk[i].apk06 = 0 THEN
               CALL g_apk.deleteElement(i)   #MOD-950226 add
               LET INT_FLAG = 0
               CANCEL INSERT 
            END IF              
            SELECT gec04 INTO l_apk29 FROM gec_file
             WHERE gec01 = g_apk[i].apk11 AND gec011='1'      
            LET g_apk[i].apk06 = cl_digcut(g_apk[i].apk06,g_azi04)
            LET g_apk[i].apk07 = cl_digcut(g_apk[i].apk07,g_azi04)
            LET g_apk[i].apk08 = cl_digcut(g_apk[i].apk08,g_azi04)
            LET g_apk[i].apk06f= cl_digcut(g_apk[i].apk06f,l_azi04)
            LET g_apk[i].apk07f= cl_digcut(g_apk[i].apk07f,l_azi04)
            LET g_apk[i].apk08f= cl_digcut(g_apk[i].apk08f,l_azi04)
            IF cl_null(g_apk[i].apk03) THEN LET g_apk[i].apk03=' ' END IF               
            #No.TQC-A30072  --Begin 
            #IF NOT cl_null(g_apa.apa77) THEN 
            #   LET g_apk[i].apk32 = g_apa.apa77
            #ELSE
            #   CALL s_get_doc_no(g_apa.apa01) RETURNING g_t1
            #   SELECT apyvcode INTO g_apk[i].apk32  FROM apy_file WHERE apyslip = g_t1   
            #   IF cl_null(g_apk[i].apk32) THEN 
            #      LET g_apk[i].apk32 = g_apz.apz63  
            #   END IF     
            #END IF
            #No.TQC-A30072  --End   
             INSERT INTO apk_file (apk01,apk02,apk03,apk04,apk05,apk06,apk06f,
                                   apk07,apk07f,apk08,apk08f,apk11,apk12,apk13,
                                   apk17,apk171,apk172,apk173,apk174,
                                   apk22,apk25,apk29,apk32,              #FUN-970108 add apk32
                                   apkacti,apkgrup,apkuser,apkdate,apklegal,apkoriu,apkorig)  #FUN-980001 add apklegal #TQC-A10060 add apkoriu,apkorig 
             VALUES(g_apa.apa01,g_apk[i].apk02,g_apk[i].apk03,  #MOD-950226
                    g_apk[i].apk04,g_apk[i].apk05,
                    g_apk[i].apk06,g_apk[i].apk06f,
                    g_apk[i].apk07,g_apk[i].apk07f,
                    g_apk[i].apk08,g_apk[i].apk08f,
                    g_apk[i].apk11,g_apk[i].apk12,g_apk[i].apk13,
                    g_apk[i].apk17,g_apk[i].apk171,g_apk[i].apk172,
                    g_apa.apa173,g_apa.apa174,g_apa.apa22,g_apa.apa25,l_apk29,
                    g_apk[i].apk32,'Y',g_grup,g_user,g_today,g_legal, g_user, g_grup) #TQC-A10060 add  g_user, g_grup  #FUN-980001 add g_legal  #FUN-970108 add apk32      #No.FUN-980030 10/01/04  insert columns oriu, orig
           IF SQLCA.sqlcode THEN
              CALL cl_err3("ins","apk_file",g_apa.apa01,g_apk[i].apk03,SQLCA.sqlcode,"","",1)  
              CANCEL INSERT
           ELSE
              MESSAGE 'INSERT O.K'            
              LET l_rec_b=l_rec_b+1
              IF g_success='Y' THEN
                 COMMIT WORK
              ELSE
                 ROLLBACK WORK
              END IF
           END IF           
 
         BEFORE FIELD apk02
           IF g_apk[i].apk06 IS NULL THEN
              INITIALIZE g_apk[i].* TO NULL
              IF g_apk[i].apk02 IS NULL OR g_apk[i].apk02 = 0 THEN
                 SELECT MAX(apk02)+1 INTO g_apk[i].apk02 FROM apk_file
                  WHERE apk01 = g_apa.apa01
                 IF g_apk[i].apk02 IS NULL THEN
                    LET g_apk[i].apk02 = 1
                 END IF
              END IF
              IF i = 1 THEN
                 LET g_apk[i].apk04 = g_apa.apa18
                 LET g_apk[i].apk11 = g_apa.apa15
                 LET g_apk[i].apk12 = g_apa.apa13
                 LET g_apk[i].apk13 = g_apa.apa14
                 LET g_apk[i].apk06f= 0
                 LET g_apk[i].apk07f= 0
                 LET g_apk[i].apk08f= 0
                 LET g_apk[i].apk06 = 0
                 LET g_apk[i].apk07 = 0
                 LET g_apk[i].apk08 = 0
                 IF NOT cl_null(g_apa.apa77) THEN 
                    LET g_apk[i].apk32 = g_apa.apa77
                 ELSE
                    CALL s_get_doc_no(g_apa.apa01) RETURNING g_t1
                    SELECT apyvcode INTO g_apk[i].apk32  FROM apy_file WHERE apyslip = g_t1   
                    IF cl_null(g_apk[i].apk32) THEN 
                        LET g_apk[i].apk32 = g_apz.apz63  
                    END IF     
                 END IF
              END IF
              IF i > 1 THEN
                 LET g_apk[i].apk04  = g_apk[i-1].apk04
                 LET g_apk[i].apk05  = g_apk[i-1].apk05
                 LET g_apk[i].apk11  = g_apk[i-1].apk11
                 LET g_apk[i].apk12  = g_apk[i-1].apk12
                 LET g_apk[i].apk13  = g_apk[i-1].apk13
                 LET g_apk[i].apk171 = g_apk[i-1].apk171
                 LET g_apk[i].apk17  = g_apk[i-1].apk17
                 LET g_apk[i].apk172 = g_apk[i-1].apk172
                 LET g_apk[i].apk32  = g_apk[i-1].apk32   #FUN-970108 add
                 LET g_apk[i].apk06f = 0
                 LET g_apk[i].apk07f = 0
                 LET g_apk[i].apk08f = 0
                 LET g_apk[i].apk06  = 0
                 LET g_apk[i].apk07  = 0
                 LET g_apk[i].apk08  = 0
              END IF
              IF g_apk[i].apk171 = 'XX' THEN
                 LET g_apk[i].apk03 = ' '
              END IF
           END IF
 
         AFTER FIELD apk02
           IF cl_null(g_apk[i].apk02) THEN 
              CALL cl_err('','aqc-052',0)          
              NEXT FIELD apk02
           ELSE
              IF g_apk[i].apk02 != g_apk_t.apk02 OR
                 g_apk_t.apk02 IS NULL THEN
                 #檢查項次是否存在
                 LET l_n = 0
                 SELECT COUNT(*) INTO l_n FROM apk_file 
                  WHERE apk01 = g_apa.apa01 
                    AND apk02 = g_apk[i].apk02
                 IF l_n > 0 THEN 
                    CALL cl_err(g_apk[i].apk02,'asf-406',0)
                    NEXT FIELD apk02
                 END IF 
              END IF 
           END IF 
 
         AFTER FIELD apk11
            IF NOT cl_null(g_apk[i].apk11) THEN
               IF cl_null(apk11_t) OR g_apk[i].apk11 != apk11_t THEN
                  LET l_gec05 = ''                                                  #MOD-D20029 add
                  SELECT gec04,gec05,gec06,gec08                                    #MOD-D20029 add gec05
                    INTO l_apk29,l_gec05,g_apk[i].apk172,g_apk[i].apk171            #MOD-D20029 add gec05
                    FROM gec_file
                   WHERE gec01 = g_apk[i].apk11 AND gec011='1'  #進項
                     AND gecacti = 'Y'
                  IF STATUS THEN
                     CALL cl_err3("sel","gec_file", g_apk[i].apk11,"","mfg3044","","",1)  #No.FUN-660122
                     NEXT FIELD apk11
                  END IF
                  DISPLAY g_apk[i].apk171,g_apk[i].apk172 TO apk171,apk172   #MOD-950226 add
                 #當執行aapt121(g_aptype='13')時,不管選什麼稅別,都不算稅額,
                 #所以LET l_apk29=0
                 #IF g_aptype = '13' THEN LET l_apk29 = 0 END IF           #FUN-950094 mark
                  IF NOT cl_null(g_apk[i].apk08f) THEN
                     LET g_apk[i].apk08f = cl_digcut(g_apk[i].apk08f,l_azi04)
                     LET g_apk[i].apk07f = g_apk[i].apk08f * l_apk29 / 100
                     LET g_apk[i].apk07f = cl_digcut(g_apk[i].apk07f,l_azi04)
                     LET g_apk[i].apk06f = g_apk[i].apk08f + g_apk[i].apk07f
                     LET g_apk[i].apk06f = cl_digcut(g_apk[i].apk06f,l_azi04)
                     LET g_apk[i].apk08  = g_apk[i].apk08f * g_apk[i].apk13
                     LET g_apk[i].apk08  = cl_digcut(g_apk[i].apk08,g_azi04)
                     LET g_apk[i].apk07  = g_apk[i].apk07f * g_apk[i].apk13
                     LET g_apk[i].apk07  = cl_digcut(g_apk[i].apk07,g_azi04)
                     LET g_apk[i].apk06  = g_apk[i].apk08 + g_apk[i].apk07
                     LET g_apk[i].apk06  = cl_digcut(g_apk[i].apk06,g_azi04)
                  END IF
                  LET apk11_t = g_apk[i].apk11     #MOD-D40014  add
               END IF
             END IF
             CALL t110_set_entry_apk_120(p_cmd)   #CHI-940018
             IF g_apk[i].apk171 = '28' OR g_apk[i].apk171 = '29' THEN
                LET g_apk[i].apk12 = g_aza.aza17
                LET g_apk[i].apk13 = 1
                CALL t110_set_no_entry_apk_120(p_cmd)    #CHI-940018
             END IF
             #MOD-B30214--add--str--
             IF g_apk[i].apk171 <> 'XX' THEN
                LET g_apk[i].apk17 = '1'
             END IF
             #MOD-B30214--add--end--
 
         #--MOD-BB0022 add
         AFTER FIELD apk05
           #LET l_gec05 = ''                                                     #MOD-D20029 mark
           #SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01=g_apk[i].apk11   #MOD-D20029 mark
            IF l_gec05 NOT MATCHES '[4X]' AND cl_null(g_apk[i].apk05) THEN
               CALL cl_err('','aap-099',0)
               NEXT FIELD apk05
            END IF
         #--MOD-BB0022 add
 
         AFTER FIELD apk03
            IF NOT cl_null(g_apk[i].apk03) AND
               (apk03_t IS NULL OR g_apk[i].apk03 != apk03_t) THEN
#MOD-580051  僅針對帳款性質11,12做t110_invoice_chk()的處理
               LET g_errno = ''   #MOD-5C0088
               IF g_apa.apa00='11' OR g_apa.apa00='12' OR 
                  g_apa.apa00='13' OR g_apa.apa00='15' THEN  #No.FUN-690080  #MOD-9B0190 add 15
                  #CALL t110_invoice_chk(g_apk[i].apk03,g_apk[i].apk11)   #MOD-770138
                 #CALL t110_invoice_chk(g_apk[i].apk03,g_apk[i].apk11,g_apk[i].apk05)   #CHI-820005   #No.TQC-CB0066 Mark
                  CALL t110_invoice_chk(g_apk[i].apk03,g_apk[i].apk11,g_apk[i].apk05,'')              #No.TQC-CB0066 Add
               END IF
 
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('',g_errno,0)
                  NEXT FIELD apk03
               END IF
               LET g_errno = ''
               IF i > 1 THEN
                  CALL t110_duplicate(' ',g_apk[i].apk03,i-1)
               END IF
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('duplicate:',g_errno,0)
                  INITIALIZE g_apk[i].* TO NULL
                  NEXT FIELD apk03
               END IF
               LET l_nochk = LENGTH(g_apk[i].apk03)
               IF g_apk[i].apk171 = '28' OR g_apk[i].apk171 = '29' THEN
                  IF l_nochk != 14 THEN
                     CALL cl_err(g_apk[i].apk03,'amd-009',0)
                     NEXT FIELD apk03
                  END IF
                  LET l_chk = 'N'
               ELSE
                  IF NOT cl_null(g_apk[i].apk03) THEN
                     IF g_aza.aza26<>'2' THEN   #No.MOD-7B0128
                        IF g_apk[i].apk171 != 'XX' AND g_apk[i].apk171 != '22' THEN   #TQC-630082
                           IF l_nochk != 10 THEN
                              CALL cl_err(g_apk[i].apk03,'amd-010',0)
                              NEXT FIELD apk03
                           END IF
                        ELSE
                           #稅別格式若為22時,提示警訊即可,不控卡
                           IF g_apk[i].apk171='22' THEN
                              CALL cl_err(g_apk[i].apk03,'amd-010',0)
                           END IF
                        END IF
                     END IF
                  END IF
               END IF
               #MOD-B30214--add--str--
               IF g_apk[i].apk03 != 'MISC' AND g_apk[i].apk03 != 'UNAP' THEN
                 #LET l_gec05 = ''                                                         #MOD-D20029 mark
                 #SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01=g_apk[i].apk11       #MOD-D20029 mark
                 #IF l_gec05 != 'X' THEN                                                   #No.MOD-B80015 mark
                  IF l_gec05 NOT MATCHES '[4X]' THEN                                       #No.MOD-B80015 add
                     LET l_apa171=g_apa.apa171                                             #MOD-B40115 add
                     LET g_apa.apa171=g_apk[i].apk171                                      #MOD-B40115 add
                     IF NOT t110_chk(g_apk[i].apk03) THEN       
                        CALL cl_err(g_apk[i].apk03,'sub-005',0)
                        NEXT FIELD apk03
                     END IF
                     LET g_apa.apa171=l_apa171          #MOD-B40115 add
                  END IF
               END IF 
               #MOD-B30214--add--end--
            ELSE
              #-MOD-AC0101-add-
              #當發票聯數(gec05)不為4或X時,aapt120的發票欄位(apk03)為必輸
               IF g_aptype ='12' OR g_aptype ='13' OR g_aptype ='15' THEN   #MOD-B30179 add 15 #MOD-B40108 add 13
                 #LET l_gec05 = ''                                                        #MOD-D20029 mark
                 #SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01=g_apk[i].apk11      #MOD-D20029 mark
                  IF l_gec05 NOT MATCHES '[4X]' AND cl_null(g_apk[i].apk03) THEN
                     CALL cl_err('apk03 is null: ','aap-099',0)
                     NEXT FIELD apk03
                  ELSE
                     IF cl_null(g_apk[i].apk03) THEN   #MOD-B10070  
                        LET g_apk[i].apk03 = ' '     
                     END IF                            #MOD-B10070
                  END IF
               END IF
              #-MOD-AC0101-end-
              #IF g_apk[i].apk171 = 'XX' THEN   #MOD-AA0035 mark
               IF g_apk[i].apk171 = 'XX' AND cl_null(g_apk[i].apk03) THEN   #MOD-C10062 add
                  LET g_apk[i].apk03 = ' '                                  #MOD-AA0035 mark #MOD-C10062 remark
               END IF                                                       #MOD-AA0035 mark #MOD-C10062 remark
              #稅別格式若為22時,提示警訊即可,不控卡
               IF g_apk[i].apk171='22' THEN
                  CALL cl_err(g_apk[i].apk03,'amd-010',0)
               END IF
            END IF
 
            IF l_flag1='Y' THEN
               LET l_amb01=YEAR(g_apk[i].apk05)
               LET l_amb02=MONTH(g_apk[i].apk05)
               LET l_amb03=g_apk[i].apk03[1,2]
               LET g_msg = ""   #MOD-9C0356 add
               #CHI-930020--Begin
              #SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01 = g_apa.apa15              #MOD-D20029 mark
              #IF g_apz.apz07 = 'Y' AND (l_gec05 = '2' OR l_gec05 = '3') AND                  #MOD-C70159 mark
               IF g_apz.apz07 = 'Y' AND (l_gec05 MATCHES '[2356]') AND                        #MOD-C70159 add
                  g_aza.aza26!= '2' THEN   #MOD-9C0444 add
                  CALL s_apkchk(l_amb01,l_amb02,l_amb03,g_apk[i].apk171)
                       RETURNING g_errno,g_msg                                   
               END IF            
               #CHI-930020---End                                                
               IF NOT cl_null(g_msg) THEN
                  CALL cl_getmsg(g_msg,g_lang) RETURNING g_msg
                  ERROR g_msg,' invoice =',g_apk[i].apk03,
                              ' SQLCODE=',g_errno
                   IF cl_confirm('aap-766') THEN   #No.MOD-480431
                     IF g_errno='1' OR g_errno='2'  THEN
                        NEXT FIELD apk05
                     ELSE
                        IF g_errno='3'  THEN
                           NEXT FIELD apk03
                        ELSE
                           NEXT FIELD apk171
                        END IF
                     END IF
                  END IF
               END IF
            END IF
 
         AFTER FIELD apk171
               IF g_apk[i].apk171 != '21' AND g_apk[i].apk171 != '22' AND
                  g_apk[i].apk171 != '23' AND g_apk[i].apk171 != '24' AND
                  g_apk[i].apk171 != '25' AND g_apk[i].apk171 != 'XX' AND
                  g_apk[i].apk171 != '26' AND g_apk[i].apk171 != '27' AND
                  g_apk[i].apk171 != '28' AND g_apk[i].apk171 != '29' THEN
                  CALL cl_err(g_apk[i].apk171,'amd-006',0)
                  NEXT FIELD apk171
               END IF
               LET l_chk = 'Y'
               IF g_apk[i].apk171 = '22' AND cl_null(g_apk[i].apk03) THEN
                  LET l_chk = 'N'
               END IF
               IF g_apk[i].apk171 = 'XX' THEN
                  LET l_chk = 'N'
               #MOD-B30214--add--str--
                  CALL cl_set_comp_required("apk04",FALSE)
               ELSE
                  CALL cl_set_comp_required("apk04",TRUE)
               #MOD-B30214--add--end--
               END IF
 
               IF g_apk[i].apk171 = '28' OR g_apk[i].apk171 ='29' THEN
                  LET g_apk[i].apk12 = g_aza.aza17
                  LET g_apk[i].apk13 = 1
               END IF
 
         AFTER FIELD apk17
            IF NOT cl_null(g_apk[i].apk17) THEN
               IF g_apk[i].apk17 <>' ' AND g_apk[i].apk17 NOT MATCHES '[1234]' THEN   #No.FUN-4C0091
                  NEXT FIELD apk17
               END IF
               IF g_apk[i].apk17 MATCHES '[1234]'  THEN            #No.FUN-4C0091
                  LET l_flag1='Y'
                 #IF g_apk[i].apk171='22' THEN                                      #MOD-C70159 mark
                  IF g_apk[i].apk171='22' AND NOT cl_null(g_apk[i].apk03)  THEN     #MOD-C70159 add
                    #IF (g_apk[i].apk03 IS NULL OR g_apk[i].apk03=' ' ) THEN        #MOD-C70159 mark
                    #   LET l_flag1='N'                                             #MOD-C70159 mark
                    #ELSE                                                           #MOD-C70159 mark
                     IF g_apk[i].apk03[1,1] MATCHES '[A-Z]' AND
                        g_apk[i].apk03[2,2] MATCHES '[A-Z]' AND
                        g_apk[i].apk03[3,3] MATCHES '[0-9]' AND
                        g_apk[i].apk03[4,4] MATCHES '[0-9]' AND
                        g_apk[i].apk03[10,10] MATCHES '[0-9]' THEN
                        LET l_flag1='Y'
                      #ELSE                                                          #MOD-C70159 mark
                      #   LET l_flag1='N'                                            #MOD-C70159 mark
                     END IF
                    #END IF                                                          #MOD-C70159 mark
                  END IF
                  #BUGNO4197不檢查字軌,no:7393
                  IF g_apk[i].apk171 = '28' OR g_apk[i].apk171='29' THEN
                     LET l_flag1='N'
                  END IF
                  IF g_apk[i].apk171 = 'XX' THEN
                     LET l_flag1='N'
                  END IF
                 #------------------------------MOD-C70159---------------------(S)
                 #SELECT gec05 INTO l_gec05                   #MOD-D20029 mark
                 #  FROM gec_file                             #MOD-D20029 mark
                 # WHERE gec01=g_apk[i].apk11                 #MOD-D20029 mark
                  IF l_gec05 MATCHES NOT '[2356]' THEN
                     LET l_flag1='N'
                  END IF
                 #------------------------------MOD-C70159---------------------(E)
               END IF
 
            END IF
 
         AFTER FIELD apk172
            IF NOT cl_null(g_apk[i].apk172) THEN
               IF g_apk[i].apk172 NOT MATCHES '[123]' THEN
                  CALL cl_err(g_apk[i].apk172,'amd-007',0)
                  NEXT FIELD apk172
               END IF
              #IF g_apk[i].apk172='1' THEN                                                   #MOD-C30828 mark
               SELECT gec04 INTO l_apk29        #No:8593 順便改
                 FROM gec_file
                WHERE gec01 = g_apk[i].apk11 AND gec011='1'  #進項
                  AND gecacti = 'Y'
              #當執行aapt121(g_aptype='13')時,不管選什麼稅別,都不算稅額,
              #所以LET l_apk29=0
              #IF g_aptype = '13' THEN LET l_apk29 = 0 END IF   #FUN-950094 mark
              #IF l_gec05 = 'T' OR l_gec05 = 'A' OR (l_gec05 = '2' AND l_gec07 = 'Y') THEN   #MOD-C30828 add #MOD-C60190 mark
                  LET l_tax = g_apk[i].apk08 * (l_apk29/100)
              #ELSE                                             #MOD-C30828 add #MOD-C60190 mark
              #   LET l_tax = g_apk[i].apk08f * (l_apk29/100)   #MOD-C30828 add #MOD-C60190 mark
              #END IF                                           #MOD-C30828 add #MOD-C60190 mark
              #LET l_tax = cl_digcut(l_tax,l_azi04)     #No:8511 要先取位才對   #No.TQC-CC0035   Mark
               LET l_tax = cl_digcut(l_tax,g_azi04)                             #No.TQC-CC0035   Add
               IF g_apk[i].apk07 !=l_tax THEN
                  CALL cl_err(g_apk[i].apk171,'aap-757',0)
                  IF (g_apk[i].apk07 > l_tax+2) OR (g_apk[i].apk07<l_tax-2)  THEN
                     CALL cl_err(g_apk[i].apk171,'mfg-033',0)
                    #NEXT FIELD apk08      #No.TQC-CC0035   Mark
                     NEXT FIELD apk172     #No.TQC-CC0035   Add
                  END IF
               END IF
              #LET l_tax=cl_digcut(l_tax,l_azi04)                                             #MOD-C30828 mark
              #ELSE                                                                           #MOD-C30828 mark
              #   LET l_tax=0                                                                 #MOD-C30828 mark
              #END IF                                                                         #MOD-C30828 mark
            END IF
 
         AFTER FIELD apk04
           IF NOT cl_null(g_apk[i].apk04) THEN
              IF (g_apz.apz14 = 'Y' OR g_aza.aza21 = 'Y') AND   #FUN-990053 mod #TQC-9A0017 add (  #TQC-9A0119 mod ()
                 NOT s_chkban(g_apk[i].apk04) THEN #MOD-9A0145 g_apk[i].apk04-->l_apa.apa18  #TQC-9A0119 mod
                 CALL cl_err('','aoo-080',0) NEXT FIELD apk04
              END IF
              IF g_apa.apa06='MISC' THEN
                 CALL t110_input_apl(g_apk[i].apk04)
              END IF
           ELSE
             #LET l_gec05 = ''                                                   #MOD-B50183  #MOD-D20029 mark
             #SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01=g_apk[i].apk11 #MOD-B50183  #MOD-D20029 mark
             #str MOD-B30214 add
             #IF g_apk[i].apk171!='XX' THEN  #MOD-B50183 mark
              IF g_apk[i].apk171 != 'XX' AND g_apk[i].apk171 != '28' AND g_apk[i].apk171 != '29'  #MOD-B50183 
                 AND l_gec05 NOT MATCHES '[4X]' THEN #MOD-B50183
                 CALL cl_err('apk04 is null: ','aap-099',0)
                 NEXT FIELD apk04
              END IF
             #end MOD-B30214 add
             #IF g_apa.apa06='MISC' AND g_apk[i].apk171!='XX' AND g_apk[i].apk171!='28' THEN   #MOD-880044   #MOD-880173     #MOD-B50183 mark
              IF g_apa.apa06='MISC' AND g_apk[i].apk171 != 'XX' AND g_apk[i].apk171 != '28'  #MOD-B50183
                 AND g_apk[i].apk171 != '29' AND l_gec05 NOT MATCHES '[4X]'  THEN            #MOD-B50183
                 NEXT FIELD apk04
              END IF
           END IF
 
         AFTER FIELD apk12
            IF NOT cl_null(g_apk[i].apk12) THEN
               SELECT azi04 INTO l_azi04 FROM azi_file
                WHERE azi01 = g_apk[i].apk12 AND aziacti = 'Y'
               IF STATUS THEN
                  CALL cl_err3("sel","azi_file",g_apk[i].apk12,"","aap-002","","",1)  #No.FUN-660122
                  NEXT FIELD apk12
               ELSE
                  CALL s_curr3(g_apk[i].apk12,g_apa.apa02,g_apz.apz33) #FUN-640022
                       RETURNING g_apk[i].apk13
                  IF g_apk[i].apk12 = g_aza.aza17 THEN
                     LET g_apk[i].apk13 = 1
                  END IF
               END IF
               IF g_apk[i].apk171 = '28' OR g_apk[i].apk171='29' THEN
                  IF g_apk[i].apk12 <> g_aza.aza17 THEN
                     CALL cl_err('','aap-905',1)
                     NEXT FIELD apk12
                  END IF
                  LET g_apk[i].apk12 = g_aza.aza17
                  LET g_apk[i].apk13 = 1
               END IF
            END IF
 
         BEFORE FIELD apk13
            LET apk13_t = g_apk[i].apk13
 
         AFTER FIELD apk13
            IF apk13_t IS NULL OR apk13_t <> g_apk[i].apk13 THEN
               LET g_apk[i].apk08  = g_apk[i].apk08f * g_apk[i].apk13
               LET g_apk[i].apk07  = g_apk[i].apk07f * g_apk[i].apk13
               LET g_apk[i].apk06  = g_apk[i].apk08  + g_apk[i].apk07
               LET g_apk[i].apk08  = cl_digcut(g_apk[i].apk08,g_azi04)
               LET g_apk[i].apk07  = cl_digcut(g_apk[i].apk07,g_azi04)
               LET g_apk[i].apk06  = cl_digcut(g_apk[i].apk06,g_azi04)
               DISPLAY BY NAME g_apk[i].apk06,g_apk[i].apk07,g_apk[i].apk08               #MOD-9A0051 add
            END IF
 
        #TQC-AB0266--------add--------------str------------
        AFTER FIELD apk06f 
           IF g_apk[i].apk06f <= 0 THEN
             #NEXT FIELD apk06f                #TQC-B90062 mark
              IF NOT cl_confirm('aap-249') THEN    #TQC-B90062 
                 NEXT FIELD apk06f                 #TQC-B90062
              END IF
           END IF
        #TQC-AB0266--------add--------------end------------
         BEFORE FIELD apk08f
            LET apk08f_t = g_apk[i].apk08f
 
         AFTER FIELD apk08f
            IF NOT cl_null(g_apk[i].apk08f) THEN
               IF g_apk[i].apk08f <= 0 THEN
                 #NEXT FIELD apk08f                #TQC-B90062 mark
                  IF NOT cl_confirm('aap-249') THEN    #TQC-B90062 
                     NEXT FIELD apk08f                 #TQC-B90062
                  END IF
               END IF
               IF apk08f_t IS NULL OR apk08f_t<>g_apk[i].apk08f THEN   #MOD-7C0053
                 #-------------------------MOD-C30828-----------------(S)
                 #---MOD-C30828 mark
                 #IF g_apk[i].apk172='1' THEN
                 #   LET l_gec07 = ''
                 #   SELECT gec07 INTO l_gec07 FROM gec_file
                 #     WHERE gec01 = g_apk[i].apk11
                 #   IF l_gec07 = 'N' THEN
                 #      LET l_tax = g_apk[i].apk08f * (l_apk29/100)
                 #   ELSE
                 #      LET g_apk[i].apk08f = g_apk[i].apk08f / (1+l_apk29/100)
                 #      LET l_tax = g_apk[i].apk08f * (l_apk29/100)
                 #   END IF
                 #ELSE
                 #   LET l_tax = 0
                 #END IF
                 #LET g_apk[i].apk07f = cl_digcut(l_tax,l_azi04)
                 #---MOD-C30828 mark
                 #SELECT gec07 INTO l_gec07 FROM gec_file         #MOD-C60190 mark 
                  SELECT gec07,gec05 INTO l_gec07,l_gec05         #MOD-C60190 add
                    FROM gec_file
                   WHERE gec01 = g_apk[i].apk11
                 #IF l_gec05 = 'T' OR l_gec05 = 'A' OR (l_gec05 = '2' AND l_gec07 = 'Y') THEN   #MOD-C60190 mark
                  IF l_gec05 = 'T' OR l_gec05 = 'A' OR                                          #MOD-C60190 add
                     ((l_gec05 = '2'  OR  l_gec05 = '5') AND l_gec07 = 'Y') THEN                #MOD-C60190 add
                     LET apk08f_t = g_apk[i].apk08f
                    #--------------------MOD-C60190-------------------------(S)
                    #MOD-C60190--mark
                    #LET g_apk[i].apk07f = g_apk[i].apk08f * (l_apk29/100)
                    #LET g_apk[i].apk07f = cl_digcut(g_apk[i].apk07f , t_azi04)
                    #LET g_apk[i].apk08f = g_apk[i].apk08f - g_apk[i].apk07f
                    #MOD-C60190--mark
                    #---------------------MOD-C60246----------------------------(S)
                     IF l_gec05 = 'T' OR l_gec05 = 'A' THEN
                        LET g_apk[i].apk08f = g_apk[i].apk08f * (1 - l_apk29/100)
                     ELSE
                        LET g_apk[i].apk08f = g_apk[i].apk08f / (1 + l_apk29/100)
                     END IF
                    #---------------------MOD-C60246----------------------------(E)
                    #LET g_apk[i].apk08f = g_apk[i].apk08f / (1+l_apk29/100)           #MOD-C60246 mark
                     LET g_apk[i].apk08f = cl_digcut(g_apk[i].apk08f , t_azi04)
                    #LET g_apk[i].apk07f = g_apk[i].apk08f * (l_apk29/100)   #MOD-C60190 mark
                     LET g_apk[i].apk07f = apk08f_t - g_apk[i].apk08f        #MOD-C60190 
                     LET g_apk[i].apk07f = cl_digcut(g_apk[i].apk07f , t_azi04)
                    #--------------------MOD-C60190-------------------------(E)
                  ELSE
                    #LET g_apk[i].apk08f = g_apk[i].apk08f / (1+l_apk29/100)    #MOD-C60190 mark
                     LET g_apk[i].apk07f = g_apk[i].apk08f * (l_apk29/100)      #MOD-C60190 add
                     LET g_apk[i].apk07f = cl_digcut(g_apk[i].apk07f,t_azi04)   #MOD-D30020 add
                  END IF
                 #-------------------------MOD-C30828-----------------(E)
                  LET g_apk[i].apk08  = g_apk[i].apk08f * g_apk[i].apk13
                  LET g_apk[i].apk07  = g_apk[i].apk07f * g_apk[i].apk13
                  LET g_apk[i].apk06  = g_apk[i].apk08  + g_apk[i].apk07
                  LET g_apk[i].apk08  = cl_digcut(g_apk[i].apk08,g_azi04)
                  LET g_apk[i].apk07  = cl_digcut(g_apk[i].apk07,g_azi04)
                  LET g_apk[i].apk06  = cl_digcut(g_apk[i].apk06,g_azi04)
                  LET g_apk[i].apk06f = g_apk[i].apk08f + g_apk[i].apk07f
                  LET g_apk[i].apk06f = cl_digcut(g_apk[i].apk06f,l_azi04)
                  LET g_apk[i].apk08f = cl_digcut(g_apk[i].apk08f,l_azi04)
               END IF    #MOD-7C0053
            END IF
 
         AFTER FIELD apk07f
            IF NOT cl_null(g_apk[i].apk07f) THEN
              #-------------------------MOD-C30828-----------------(S)
              #IF g_apk[i].apk172='1' THEN                   #MOD-C30828 mark
              #   LET l_tax=g_apk[i].apk08*l_apk29/100       #MOD-C30828 mark
              #   LET l_tax=cl_digcut(l_tax,l_azi04)         #MOD-C30828 mark
              #IF l_gec05 = 'T' OR l_gec05 = 'A' OR (l_gec05 = '2' AND l_gec07 = 'Y') THEN       #MOD-C60190 mark
              #-MOD-C60190-mark-
              #IF l_gec05 = 'T' OR l_gec05 = 'A' OR                                              #MOD-C60190 add
              #   ((l_gec05 = '2'  OR  l_gec05 = '5') AND l_gec07 = 'Y') THEN                    #MOD-C60190 add
              #   LET l_tax = apk08f_t * (l_apk29/100)
              #ELSE
              #-MOD-C60190-end-
                  LET l_tax = g_apk[i].apk08f*l_apk29/100
              #END IF  #MOD-C60190
               LET l_tax = cl_digcut(l_tax,l_azi04)
              #-------------------------MOD-C30828-----------------(E)
               IF g_apk[i].apk07f !=l_tax THEN
                  CALL cl_err(g_apk[i].apk171,'aap-757',0)
                  IF (g_apk[i].apk07f > l_tax+2) OR (g_apk[i].apk07f<l_tax-2) THEN
                     CALL cl_err(g_apk[i].apk171,'mfg-033',0)
                     NEXT FIELD apk07f
                  END IF
               END IF
              #END IF                                              #MOD-C30828 mark
               IF g_apk[i].apk07f > 0 AND l_apk29 = 0 THEN
                  CALL cl_err('','aap-902',1)
                  NEXT FIELD apk07f
               END IF
               LET g_apk[i].apk06f = g_apk[i].apk08f + g_apk[i].apk07f
               LET g_apk[i].apk06f = cl_digcut(g_apk[i].apk06f,l_azi04)
               LET g_apk[i].apk07f = cl_digcut(g_apk[i].apk07f,l_azi04)
               LET g_apk[i].apk07  = g_apk[i].apk07f * g_apk[i].apk13
               LET g_apk[i].apk06  = g_apk[i].apk08  + g_apk[i].apk07
               LET g_apk[i].apk07  = cl_digcut(g_apk[i].apk07,g_azi04)
               LET g_apk[i].apk06  = cl_digcut(g_apk[i].apk06,g_azi04)
               DISPLAY g_apk[i].apk07 TO apk07                              #MOD-D10210 add
            END IF
 
         BEFORE FIELD apk08
            LET apk08_t = g_apk[i].apk08
 
         AFTER FIELD apk08
            IF NOT cl_null(g_apk[i].apk08) THEN
               IF g_apk[i].apk08 <= 0 THEN
                  #CALL cl_err('','agl-006',0)  #MOD-4A0001 #TQC-B90062 mark
                  #NEXT FIELD apk08                         #TQC-B90062 mark
                   IF NOT cl_confirm('aap-249') THEN            #TQC-B90062 
                      NEXT FIELD apk08                          #TQC-B90062 
                   END IF
               END IF
               IF apk08_t IS NULL OR apk08_t<>g_apk[i].apk08 THEN   #MOD-7C0053
                  IF g_apk[i].apk172='1' THEN
                     LET l_gec07 = ''
                     SELECT gec07 INTO l_gec07 FROM gec_file 
                       WHERE gec01 = g_apk[i].apk11
                     IF l_gec07 = 'N' THEN                 
                        LET l_tax = g_apk[i].apk08 * (l_apk29/100)
                     ELSE
                        LET g_apk[i].apk08 = g_apk[i].apk08 / (1+l_apk29/100)
                        LET l_tax = g_apk[i].apk08 * (l_apk29/100)      
                     END IF
                  ELSE
                     LET l_tax = 0
                  END IF
                  LET g_apk[i].apk07 = cl_digcut(l_tax,g_azi04)   #MOD-6B0066
                  LET g_apk[i].apk06 = g_apk[i].apk08 + g_apk[i].apk07
                  LET g_apk[i].apk06 = cl_digcut(g_apk[i].apk06,g_azi04)
                  LET g_apk[i].apk08 = cl_digcut(g_apk[i].apk08,g_azi04)
               END IF   #MOD-7C0053
            END IF
 
         AFTER FIELD apk07
            IF NOT cl_null(g_apk[i].apk07) THEN
               IF g_apk[i].apk07 < 0 THEN
                 #NEXT FIELD apk07                 #TQC-B90062 mark
                  IF NOT cl_confirm('aap-249') THEN    #TQC-B90062 
                     NEXT FIELD apk07                  #TQC-B90062
                  END IF
               END IF
               IF g_apk[i].apk07 > 0 AND l_apk29 = 0 THEN
                  CALL cl_err('','aap-902',1)
                  NEXT FIELD apk07
               END IF
              #-------------------------MOD-C30828-----------------(S)
              #IF g_apk[i].apk172='1' THEN
              #   LET l_tax=g_apk[i].apk08*l_apk29/100
              #   LET l_tax=cl_digcut(l_tax,l_azi04)
              #-MOD-C60190-mark-
              #IF l_gec05 = 'T' OR l_gec05 = 'A' OR (l_gec05 = '2' AND l_gec07 = 'Y') THEN 
              #   LET l_tax = apk08f_t * (l_apk29/100)
              #ELSE
              #   LET l_tax = g_apk[i].apk08f*l_apk29/100
              #END IF
              #-MOD-C60190-end-
               LET l_tax = g_apk[i].apk08*l_apk29/100  #MOD-C60190
              #LET l_tax = cl_digcut(l_tax,l_azi04)   #No.TQC-CC0035   Mark
               LET l_tax = cl_digcut(l_tax,g_azi04)   #No.TQC-CC0035   Add
              #-------------------------MOD-C30828-----------------(E)
               IF g_apk[i].apk07 !=l_tax THEN
                  CALL cl_err(g_apk[i].apk171,'aap-757',0)
                  IF (g_apk[i].apk07 > l_tax+2) OR (g_apk[i].apk07<l_tax-2)  THEN
                     CALL cl_err(g_apk[i].apk171,'mfg-033',0)
                     NEXT FIELD apk07
                  END IF
               END IF
              #END IF                                #MOD-C30828 mark
               LET g_apk[i].apk06 = g_apk[i].apk08 + g_apk[i].apk07
               LET g_apk[i].apk06 = cl_digcut(g_apk[i].apk06,g_azi04)
               LET g_apk[i].apk07 = cl_digcut(g_apk[i].apk07,g_azi04)
            END IF
         
         AFTER FIELD apk32
            IF NOT cl_null(g_apk[i].apk32) THEN   
              SELECT COUNT(*) INTO g_cnt FROM ama_file
               WHERE ama02 = g_apk[i].apk32
                IF g_cnt = 0 THEN 
                   IF g_aza.aza26 = '0' THEN              #MOD-A10127 add
                      CALL cl_err("","amd-028",1) 
                   END IF                                 #MOD-A10127 add
                END IF
                IF g_aza.aza21 = 'Y' AND NOT s_chkban(g_apk[i].apk32) THEN #FUN-990053 mod  #TQC-9A0017
                   CALL cl_err("","mfg7015",1)
                   NEXT FIELD apk32
                END IF 
            ELSE
               IF g_aza.aza94 = 'Y' THEN
                   CALL cl_err('apk32 is null: ','aap-099',0)  
                   NEXT FIELD apk32 
               END IF
            END IF       
         
         BEFORE DELETE                            #是否取消單身
            DELETE FROM apk_file
             WHERE apk03 = g_apk[i].apk03
               AND apk01 = g_apa.apa01
               AND apk02 = g_apk[i].apk02    #MOD-950226 add
            LET l_flag2 = 'Y'   #MOD-620048
            IF SQLCA.sqlcode THEN
               CALL cl_err3("del","apk_file",g_apk[i].apk03,g_apa.apa01,SQLCA.sqlcode,"","",1)  #No.FUN-660122
               LET g_success = 'N'
               ROLLBACK WORK
               CANCEL DELETE
            ELSE                             #CHI-940018
               COMMIT WORK                   #MOD-950226 add
               LET l_rec_b = l_rec_b - 1     #CHI-940018                       
            END IF
            LET l_del ='Y'  #MOD-4B0243
 
        ON ROW CHANGE
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               LET g_apk[i].* = g_apk_t.*
               CLOSE ddd_bcl
               ROLLBACK WORK
               EXIT INPUT
            END IF
            #CHI-A40005 add --start--
           #-MOD-B40086-mark-
           #CALL t110_sum_apa32() RETURNING l_apa32,l_apa32f 
           #IF (l_apa32 != g_apa.apa32 OR
           #   l_apa32f != g_apa.apa32f) AND g_aptype = '21' THEN       #MOD-A50005 add g_aptype='21'
           #   CALL cl_err('','aap-212',1)
           #   NEXT FIELD apk07f 
           #END IF    
           #-MOD-B40086-end-
            #CHI-A40005 add --end--              

            IF l_opensw = 'Y' THEN
               CALL cl_err(g_apk[i].apk03,-263,1)
               LET g_apk[i].* = g_apk_t.*
            ELSE
               IF g_apk[i].apk06 IS NOT NULL AND g_apk[i].apk06 != 0 THEN 
                  SELECT gec04 INTO l_apk29 FROM gec_file
                   WHERE gec01 = g_apk[i].apk11 AND gec011='1'      
                  LET g_apk[i].apk06 = cl_digcut(g_apk[i].apk06,g_azi04)
                  LET g_apk[i].apk07 = cl_digcut(g_apk[i].apk07,g_azi04)
                  LET g_apk[i].apk08 = cl_digcut(g_apk[i].apk08,g_azi04)
                  LET g_apk[i].apk06f= cl_digcut(g_apk[i].apk06f,l_azi04)
                  LET g_apk[i].apk07f= cl_digcut(g_apk[i].apk07f,l_azi04)
                  LET g_apk[i].apk08f= cl_digcut(g_apk[i].apk08f,l_azi04)
     
                  IF cl_null(g_apk[i].apk03) THEN LET g_apk[i].apk03=' ' END IF             	 
                  UPDATE apk_file SET apk03 = g_apk[i].apk03,
                                      apk04 = g_apk[i].apk04,
                                      apk05 = g_apk[i].apk05,
                                      apk08f = g_apk[i].apk08f,
                                      apk08 = g_apk[i].apk08,
                                      apk07f = g_apk[i].apk07f,
                                      apk07 = g_apk[i].apk07,
                                      apk06f = g_apk[i].apk06f,
                                      apk06 = g_apk[i].apk06,
                                      apk11 = g_apk[i].apk11,
                                      apk12 = g_apk[i].apk12,
                                      apk13 = g_apk[i].apk13,
                                      apk17 = g_apk[i].apk17,          	                                  	                                  	                        
                                      apk171 = g_apk[i].apk171,          	                        
                                      apk172 = g_apk[i].apk172,
                                      apk32 = g_apk[i].apk32,    #FUN-970108 add
                                      apk29 = l_apk29            #MOD-C90177 add
                   WHERE apk01 = g_apa.apa01
                     AND apk02 = g_apk_t.apk02   #MOD-950226 add
                     AND apk03 = g_apk_t.apk03
                  IF SQLCA.sqlcode OR SQLCA.sqlerrd[3]=0 THEN
                     CALL cl_err3("upd","apk_file",g_apa.apa01,i ,SQLCA.sqlcode,"","t110_ddd(ckp#2):",1) 
                     LET g_apk[i].* = g_apk_t.*
                  ELSE
                     MESSAGE "UPDATE OK"             	  
                     #COMMIT WORK   #No.CHI-A40005 mark 
                  END IF                              	         
               END IF 
            END IF                        
 
         AFTER ROW
          #CHI-A40005 add --start--
          IF INT_FLAG AND g_aptype = '21' THEN     #MOD-A50005 g_aptype='21' add                                                                                                         
               IF l_apa32 != g_apa.apa32 OR l_apa32f != g_apa.apa32f THEN
               ELSE
                 CALL cl_err('',9001,0)                                                                                                
                 LET INT_FLAG = 0                                                                                                                    
                 IF p_cmd = 'u' THEN                                                                                                   
                    LET g_apk[i].* = g_apk_t.*                                                                                      
                 #FUN-D30032--add--str--
                 ELSE
                    CALL g_apk.deleteElement(l_ac)
                 #FUN-D30032--add--end--
                 END IF                                                                                                                
                 CLOSE ddd_bcl                                                                                                        
                 ROLLBACK WORK        
                 LET g_success  = 'N'                         
                 EXIT INPUT         #MOD-A50005 add                                                                        
              END IF
          END IF
          #CHI-A40005 add --end--                                                                                                                   
            LET i = ARR_CURR()   #MOD-950226 mod
            IF INT_FLAG = 0 THEN
               IF cl_null(g_apk[i].apk17) AND g_apk[i].apk171 <> 'XX' THEN 
                     NEXT FIELD apk17
               END IF
            END IF
            IF (g_apk[i].apk07f=0 AND g_apk[i].apk08f=0) OR 
               (cl_null(g_apk[i].apk07f) AND cl_null(g_apk[i].apk08f)) THEN   #MOD-950226 add
               INITIALIZE g_apk[i].* TO NULL
            END IF
            IF g_apk[i].apk17 MATCHES '[1234]' THEN      #No.FUN-4C0091
               LET l_flag1= 'Y'
               IF g_apk[i].apk171='22' THEN
                  IF g_apk[i].apk03 IS NULL OR g_apk[i].apk03 = ' ' THEN
                     LET l_flag1='N'
                  ELSE
                     IF g_apk[i].apk03[1,1] MATCHES '[A-Z]' AND
                        g_apk[i].apk03[2,2] MATCHES '[A-Z]' AND
                        g_apk[i].apk03[3,3] MATCHES '[0-9]' AND
                        g_apk[i].apk03[4,4] MATCHES '[0-9]' AND
                        g_apk[i].apk03[10,10] MATCHES '[0-9]' THEN
                        LET l_flag1='Y'
                     ELSE
                        LET l_flag1='N'
                     END IF
                  END IF
               END IF
               IF g_apk[i].apk171 = '28' OR g_apk[i].apk171='29' THEN
                  LET l_flag1='N'
               END IF
               IF g_apk[i].apk171 ='XX' THEN LET l_flag1='N' END IF
               IF l_flag1='Y' THEN
                  LET l_amb01=YEAR(g_apk[i].apk05)
                  LET l_amb02=MONTH(g_apk[i].apk05)
                  LET l_amb03=g_apk[i].apk03[1,2]
                  LET g_msg = ""   #MOD-9C0356 add
                  #CHI-930020--Begin
                 #SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01 = g_apa.apa15              #MOD-D20029 mark
                 #IF g_apz.apz07 = 'Y' AND (l_gec05 = '2' OR l_gec05 = '3') AND                  #MOD-C70159 mark
                  IF g_apz.apz07 = 'Y' AND (l_gec05 MATCHES '[2356]') AND                        #MOD-C70159 add
                     g_aza.aza26!= '2' THEN   #MOD-9C0444 add
                     CALL s_apkchk(l_amb01,l_amb02,l_amb03,g_apk[i].apk171)
                          RETURNING g_errno,g_msg                                   
                  END IF            
                  #CHI-930020---End                                                
                  IF g_prog <> 'aapt210' THEN  #CHI-A40005 add 
                     IF NOT cl_null(g_msg) THEN
                        CALL cl_getmsg(g_msg,g_lang) RETURNING g_msg
                        ERROR g_msg,' invoice =',g_apk[i].apk03,' SQLCODE=',g_errno
                         IF cl_confirm('aap-766') THEN #No.MOD-480431
                           IF g_errno='1' OR g_errno='2'  THEN
                              NEXT FIELD apk05
                           ELSE
                              IF g_errno='3'  THEN
                                 NEXT FIELD apk03
                              ELSE
                                 NEXT FIELD apk171
                              END IF
                           END IF
                        END IF
                     END IF
                  END IF                      #CHI-A40005 add
               END IF
            END IF
           #當匯率為1時,需檢核原幣與本幣的稅額、金額需相同
            IF g_apk[i].apk13 = 1 AND g_aza.aza17 = g_apk[i].apk12 THEN   #MOD-880041
               IF g_apk[i].apk08f!=g_apk[i].apk08 OR 
                  g_apk[i].apk07f!=g_apk[i].apk07 OR
                  g_apk[i].apk06f!=g_apk[i].apk06 THEN
                  CALL cl_err('','apm-988',1)
                  NEXT FIELD apk08f
               END IF
            END IF
            IF g_apk[i].apk06 IS NULL OR g_apk[i].apk06 = 0 THEN
               CALL g_apk.deleteElement(i)
            END IF
            LET l_tot1 = 0 LET l_tot2 = 0 LET l_tot3 = 0
            LET l_tot28 = 0
            FOR k = 1 TO g_apk.getLength()    #No.MOD-480131
               IF g_apk[k].apk06 IS NULL OR g_apk[k].apk06=0 THEN
                  CONTINUE FOR
               END IF
               IF g_apk[k].apk171='23' THEN
                  LET u_sign = -1
               ELSE
                  LET u_sign = 1
               END IF
               IF g_apk[k].apk171='28'  OR g_apk[k].apk171='29' THEN
                  LET l_tot2 = l_tot2 + g_apk[k].apk07*u_sign    #稅
                  LET l_tot28= l_tot28+ g_apk[k].apk08*u_sign    #營業稅稅基
                  LET l_tot3 = (l_tot1+l_tot2 )   #MOD-640457
                  LET l_opensw = 'Y'
               ELSE
                  LET l_tot1 = l_tot1 + g_apk[k].apk08*u_sign    #未稅
                  LET l_tot2 = l_tot2 + g_apk[k].apk07*u_sign    #稅
                  LET l_tot3 = (l_tot1+l_tot2 )           #020528add   #MOD-640457
               END IF
            END FOR
            DISPLAY BY NAME l_tot28,l_tot1,l_tot2,l_tot3
            IF INT_FLAG THEN                                                                                                         
               CALL cl_err('',9001,0)                                                                                                
               LET INT_FLAG = 0                                                                                                                    
               IF p_cmd = 'u' THEN                                                                                                   
                  LET g_apk[i].* = g_apk_t.*                                                                                      
               END IF                                                                                                                
               CLOSE ddd_bcl                                                                                                        
               ROLLBACK WORK        
               LET g_success  = 'N'                                                                                                 
               EXIT INPUT                                                                                                            
            END IF                                                                                                                   
            CLOSE ddd_bcl                                                                                                           
            COMMIT WORK            

          ON ACTION CONTROLP
             IF INFIELD(apk11) THEN
                CALL cl_init_qry_var()
                LET g_qryparam.form     = "q_gec"
                LET g_qryparam.default1 = g_apk[i].apk11
                LEt g_qryparam.arg1     = '1'
                CALL cl_create_qry() RETURNING g_apk[i].apk11
                 DISPLAY g_apk[i].apk11 TO apk11          #No.MOD-490344
             END IF
             IF INFIELD(apk13) THEN
                   CALL s_rate(g_apk[i].apk12,g_apk[i].apk13)
                   RETURNING g_apk[i].apk13
                   DISPLAY BY NAME g_apk[i].apk13
                   NEXT FIELD apk13
             END IF
             IF INFIELD(apk32) THEN
                CALL cl_init_qry_var()
                LET g_qryparam.form     = "q_ama02"
                LET g_qryparam.default1 = g_apk[i].apk32
                CALL cl_create_qry() RETURNING g_apk[i].apk32
                 DISPLAY g_apk[i].apk32 TO apk32 
             END IF
         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
 
      END INPUT
   END IF
 
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      CLOSE WINDOW t110_ddd_w
      RETURN
   END IF
 
   LET j = ARR_COUNT()
   CLOSE ddd_bcl               #CHI-940018
   COMMIT WORK                #CHI-940018
   CLOSE WINDOW t110_ddd_w    #MOD-4A0001
  IF (t_tot1 != l_tot1 OR t_tot2 != l_tot2 OR t_tot3 != l_tot3 OR t_tot28 != l_tot28 OR g_apz.apz08='2') THEN #MOD-990177 add OR g_apz.apz08='2'                                            
     #CHI-A40005 mod start---
     #CALL t110_apz08('')
     IF g_prog <> 'aapt210' AND g_apa.apa63 NOT MATCHES '[Ss1]' THEN #MOD-BB0304 add apa63 
        CALL t110_apz08('')
     END IF
     #CHI-A40005 mod end---
  END IF                      #CHI-940018
END FUNCTION
 
FUNCTION t110_inv()
 DEFINE  l_rec_b                 LIKE type_file.num5,    #No.FUN-690028 SMALLINT
         l_tot1,l_tot2,l_tot3    LIKE apa_file.apa31,
         l_totf1,l_totf2,l_totf3 LIKE apa_file.apa31f,
         l_tot28                 LIKE apk_file.apk28,
         i,k                    LIKE type_file.num5,        # No.FUN-690028 SMALLINT,
         apk08_t                 LIKE apk_file.apk08,
         apk08f_t                LIKE apk_file.apk08f,
         l_apb11                 DYNAMIC ARRAY OF LIKE apb_file.apb11
 
 
  OPEN WINDOW t110_inv_w AT 7,2
    WITH FORM "aap/42f/aapt110_i" ATTRIBUTE (STYLE = g_win_style)
 
  CALL cl_ui_locale("aapt110_i")
 
  DECLARE t110_inv_c CURSOR FOR SELECT DISTINCT apb11 FROM apa_file,apb_file
                                   WHERE apa01 = g_apa.apa01 AND
                                         apa01 = apb01
  LET i = 1
  LET k = 1
  LET l_tot1 = 0
  LET l_tot2 = 0
  LET l_tot3 = 0
  LET l_tot28 = 0
  CALL g_apk1.clear()   #MOD-960128 mod g_apk->g_pak1
  FOREACH t110_inv_c INTO l_apb11[i]
 
     DECLARE t110_inv_c2 CURSOR FOR SELECT apk11,apk171,apk17,apk172,apk05,
                                          apk03,apk04,apk12,apk13,apk08f,
                                          apk07f,apk06f,apk08,apk07,apk06,apk32    #FUN-970108
                                    FROM apk_file
                                    WHERE apk03 = l_apb11[i] AND 
                                        (apk171='23' OR apk171='24' OR apk171='29' OR apk171='XX') AND   #MOD-750014
                                        apk01 = g_apa.apa01   #MOD-750014
 
     FOREACH t110_inv_c2 INTO g_apk1[k].*
 
        IF g_apk1[k].apk171 = '28' OR g_apk1[k].apk171 = '29' THEN
           LET l_tot28 = l_tot28 + g_apk1[k].apk08
           LET l_tot2 = l_tot2 + g_apk1[k].apk07
        ELSE
           LET l_tot1 = l_tot1 + g_apk1[k].apk08
           LET l_tot2 = l_tot2 + g_apk1[k].apk07
           LET l_tot3 = (l_tot1 + l_tot2)
        END IF
 
        IF cl_null(g_apk1[k].apk03) THEN
           LET g_apk1[k].apk03 = ' '
        END IF
 
        LET k = k + 1
     END FOREACH
     LET i = i + 1
  END FOREACH
 
  LET l_rec_b  = k - 1
 
  DISPLAY BY NAME l_tot28,l_tot1,l_tot2,l_tot3
 
  CALL cl_set_act_visible("accept,cancel", FALSE)
 
  DISPLAY ARRAY g_apk1 TO s_apk.*  ATTRIBUTE(COUNT=l_rec_b)  #MOD-960128 mod g_apk->g_pak1
 
        ON IDLE g_idle_seconds
           CALL cl_on_idle()
 
        ON ACTION about
           CALL cl_about()
 
        ON ACTION help
           CALL cl_show_help()
 
        ON ACTION controlg
           CALL cl_cmdask()
 
        ON ACTION controls                       #No.FUN-6B0033                                                                       
           CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033

        #No.TQC-B90242  --Begin
        ON ACTION cancel
           LET INT_FLAG=FALSE
           LET g_action_choice="exit"
           EXIT DISPLAY
        ON ACTION exit
         LET g_action_choice="exit"
         EXIT DISPLAY
        #No.TQC-B90242  --End
 
  END DISPLAY
 
     CLOSE WINDOW t110_inv_w
     RETURN
END FUNCTION
 
 
FUNCTION t110_sum(p_apk02,p_apk03,p_apk06,p_apk07,p_apk08,p_apk171)
DEFINE p_i        LIKE type_file.num5      #SMALLINT
DEFINE l_tot1     LIKE type_file.num20_6     # No.FUN-690028 DEC(20,6)  #FUN-4B0079
DEFINE l_tot2     LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
DEFINE l_tot3     LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
DEFINE l_tot28    LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
DEFINE l_totl1    LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
DEFINE l_totl2    LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
DEFINE l_totl3    LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
DEFINE l_totl11   LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
DEFINE l_totl21   LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
DEFINE l_totl31   LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
DEFINE l_totl28   LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
DEFINE l_apk08     LIKE apk_file.apk08
DEFINE l_t028     LIKE apk_file.apk08
DEFINE l_apk07     LIKE apk_file.apk07
DEFINE l_apk06     LIKE apk_file.apk06
DEFINE p_apk02  LIKE apk_file.apk02
DEFINE p_apk03  LIKE apk_file.apk03
DEFINE p_apk06  LIKE apk_file.apk06
DEFINE p_apk07  LIKE apk_file.apk07
DEFINE p_apk08  LIKE apk_file.apk08
DEFINE p_apk171 LIKE apk_file.apk171
 
   SELECT SUM(apk08),SUM(apk07),SUM(apk06) INTO l_totl1,l_totl2,l_totl3
     FROM apk_file
    WHERE apk01=g_apa.apa01 AND apk171 NOT IN ('23','24')
 
   IF cl_null(l_totl1) THEN
      LET l_totl1 = 0
   END IF
 
   IF cl_null(l_totl2) THEN
      LET l_totl2 = 0
   END IF
 
   IF cl_null(l_totl3) THEN
      LET l_totl3 = 0
   END IF
 
   SELECT SUM(apk08),SUM(apk07),SUM(apk06) INTO l_totl11,l_totl21,l_totl31
     FROM apk_file
    WHERE apk01=g_apa.apa01 AND apk171 IN ('23','24')
 
   IF cl_null(l_totl11) THEN
      LET l_totl11 = 0
   END IF
 
   IF cl_null(l_totl21) THEN
      LET l_totl21 = 0
   END IF
 
   IF cl_null(l_totl31) THEN
      LET l_totl31 = 0
   END IF
 
   IF g_aptype MATCHES '1*' THEN
      LET l_totl1 = l_totl1 - l_totl11
      LET l_totl2 = l_totl2 - l_totl21
      LET l_totl3 = l_totl3 - l_totl31
   ELSE
      LET l_totl1 = l_totl11
      LET l_totl2 = l_totl21
      LET l_totl3 = l_totl31
   END IF
 
   IF p_apk08 < 0 THEN
      LET p_apk08 = p_apk08 * -1
      LET p_apk07 = p_apk07 * -1
      LET p_apk06 = p_apk06 * -1
   END IF
 
   IF cl_null(p_apk02) THEN
      SELECT apk08,apk07,apk06 INTO l_apk08,l_apk07,l_apk06 FROM apk_file
       WHERE apk01=g_apa.apa01
         AND apk03=p_apk03
   ELSE
      SELECT apk08,apk07,apk06 INTO l_apk08,l_apk07,l_apk06 FROM apk_file
       WHERE apk01=g_apa.apa01
         AND apk02=p_apk02
         AND apk03=p_apk03
   END IF
 
   IF SQLCA.SQLCODE=100 THEN
      LET l_apk08=p_apk08
      LET l_apk07=p_apk07
      LET l_apk06=p_apk06
      LET l_totl1=l_totl1+l_apk08
      LET l_totl2=l_totl2+l_apk07
      LET l_totl3=l_totl3+l_apk06
   ELSE
      LET l_totl1=l_totl1-l_apk08
      LET l_totl2=l_totl2-l_apk07
      LET l_totl3=l_totl3-l_apk06
      LET l_totl1=l_totl1+p_apk08
      LET l_totl2=l_totl2+p_apk07
      LET l_totl3=l_totl3+p_apk06
   END IF
 
   LET l_tot1=l_totl1
   LET l_tot2=l_totl2
   LET l_tot3=(l_totl1+l_totl2)
 
   IF g_aptype MATCHES '2*' THEN
      LET l_tot1=l_totl1 * -1
      LET l_tot2=l_totl2 * -1
      LET l_tot3=(l_totl1+l_totl2) * -1
   END IF
 
   SELECT SUM(apk08) INTO l_totl28 FROM apk_file
    WHERE apk01=g_apa.apa01
      AND (apk171='28' OR apk171='29')
 
   IF cl_null(l_totl28) THEN
      LET l_totl28 = 0
   END IF
 
   IF p_apk171='28' OR p_apk171='29' THEN
      SELECT apk08 INTO l_t028 FROM apk_file
       WHERE apk01=g_apa.apa01
         AND apk03=p_apk03
         AND (apk171='28' OR apk171='29')
       IF SQLCA.SQLCODE=100 THEN
          LET l_t028=p_apk08
          LET l_totl28=l_totl1+l_t028
       ELSE
          LET l_totl28=l_totl28-l_t028
          LET l_totl28=l_totl28+p_apk08
       END IF
   END IF
 
   LET l_tot28=l_totl28
   IF g_aza.aza26 = '2' THEN
      DISPLAY BY NAME l_tot1,l_tot2,l_tot3
   ELSE
      DISPLAY BY NAME l_tot1,l_tot2,l_tot3,l_tot28
   END IF
 
END FUNCTION
 
FUNCTION t110_k()
   DEFINE l_totf,l_amtf    LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_tot,l_amt      LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_apv04          LIKE apv_file.apv04      #FUN-4B0079
   DEFINE cnt1,cnt2        LIKE type_file.num5      # No.FUN-690028 SMALLINT
   DEFINE i,j,k            LIKE type_file.num5      #No.FUN-690028 SMALLINT
   DEFINE l_sql            STRING                   #MOD-720062
   DEFINE p_cmd            LIKE type_file.chr1      #No.FUN-690028 VARCHAR(1)
   DEFINE g_apv            DYNAMIC ARRAY OF RECORD
                            apv02     LIKE apv_file.apv02,
                            apv03     LIKE apv_file.apv03,
                            apa07     LIKE apa_file.apa07,
                            apv05     LIKE apv_file.apv05,         #No.FUN-680027
                            apa08     LIKE apa_file.apa08,
                            apa14     LIKE apa_file.apa14,
                            apc08     LIKE apc_file.apc08,
                            apc09     LIKE apc_file.apc09,
                            un_payf   LIKE apv_file.apv04,
                            un_pay    LIKE apv_file.apv04,
                            apv04f    LIKE apv_file.apv04,
                            apv04     LIKE apv_file.apv04
                           END RECORD
   DEFINE g_apv_t          RECORD
                            apv02     LIKE apv_file.apv02,
                            apv03     LIKE apv_file.apv03,
                            apa07     LIKE apa_file.apa07,
                            apv05     LIKE apv_file.apv05,         #No.FUN-680027
                            apa08     LIKE apa_file.apa08,
                            apa14     LIKE apa_file.apa14,
                            apc08     LIKE apc_file.apc08,
                            apc09     LIKE apc_file.apc09,
                            un_payf   LIKE apv_file.apv04,
                            un_pay    LIKE apv_file.apv04,
                            apv04f    LIKE apv_file.apv04,
                            apv04     LIKE apv_file.apv04
                           END RECORD
   DEFINE m_apa            DYNAMIC ARRAY OF RECORD
                            apa13     LIKE apa_file.apa13,
                            apa72     LIKE apa_file.apa72,
                            apa73     LIKE apa_file.apa73
                           END RECORD
   DEFINE m_apa_t          RECORD
                            apa13     LIKE apa_file.apa13,
                            apa72     LIKE apa_file.apa72,
                            apa73     LIKE apa_file.apa73
                           END RECORD
   DEFINE m_apa34f         LIKE apa_file.apa34f
   DEFINE m_apa34          LIKE apa_file.apa34    #No.MOD-590312
   DEFINE m_apa73          LIKE apa_file.apa73
   DEFINE m_amt            LIKE type_file.num20_6 # No.FUN-690028 DEC(20,6)
   DEFINE l_apa            RECORD LIKE apa_file.*
   DEFINE l_net            LIKE apv_file.apv04
   DEFINE l_apa14          LIKE apa_file.apa14
   DEFINE l_apv02          LIKE apv_file.apv02
   DEFINE l_i              LIKE type_file.num5    #No.FUN-690028 SMALLINT
   DEFINE l_apa13          LIKE apa_file.apa13
   DEFINE l_apa41          LIKE apa_file.apa41
   DEFINE l_apv04f         LIKE apv_file.apv04f
   DEFINE l_apa35f,l_apa35 LIKE apa_file.apa35
   DEFINE l_difff,l_diff   LIKE apa_file.apa34
   DEFINE l_sumf,l_sum     LIKE apa_file.apa34
   DEFINE l_sumf_h,l_sum_h LIKE apa_file.apa34
   DEFINE l_total          LIKE apa_file.apa34
   DEFINE l_lock_sw        LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_modify_flag    LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_k,l_over       LIKE type_file.num5,   # No.FUN-690028 SMALLINT,
   l_allow_insert          LIKE type_file.num5,   #可新增否  #No.FUN-690028 SMALLINT
   l_allow_delete          LIKE type_file.num5    #可刪除否  #No.FUN-690028 SMALLINT
   DEFINE ls_rec_b         LIKE type_file.num10   # No.FUN-690028 INTEGER
   DEFINE l_apa06          LIKE apa_file.apa06    #MOD-580079
   DEFINE l_apc            RECORD LIKE apc_file.* #No.FUN-680027
   DEFINE m_apc13          LIKE apc_file.apc13    #No.FUN-680027
   DEFINE l_apa65          LIKE apa_file.apa65  
   DEFINE l_apa65f         LIKE apa_file.apa65f 
   DEFINE l_apc02          LIKE apc_file.apc02  
   DEFINE l_apc14          LIKE apc_file.apc14  
   DEFINE l_apc15          LIKE apc_file.apc15  
   DEFINE l_apc08          LIKE apc_file.apc08  
   DEFINE l_apc09          LIKE apc_file.apc09 
   DEFINE l_apc13          LIKE apc_file.apc13    #MOD-960280 add 
   DEFINE l_apv            RECORD
                            apv02     LIKE apv_file.apv02,
                            apv03     LIKE apv_file.apv03,
                            apa07     LIKE apa_file.apa07,
                            apv05     LIKE apv_file.apv05,        
                            apa08     LIKE apa_file.apa08,
                            apa14     LIKE apa_file.apa14,
                            apc08     LIKE apc_file.apc08,
                            apc09     LIKE apc_file.apc09,
                            un_payf   LIKE apv_file.apv04,
                            un_pay    LIKE apv_file.apv04,
                            apv04f    LIKE apv_file.apv04,
                            apv04     LIKE apv_file.apv04
                           END RECORD
   DEFINE l_apa1           RECORD
                            apa13     LIKE apa_file.apa13,
                            apa72     LIKE apa_file.apa72,
                            apa73     LIKE apa_file.apa73
                           END RECORD
   DEFINE l_pmb02          LIKE pmb_file.pmb02    #TQC-770027
   DEFINE l_cnt            LIKE type_file.num5    #CHI-840021
   DEFINE apv04f_sum       LIKE apv_file.apv04f   #CHI-840021
   DEFINE apv04_sum        LIKE apv_file.apv04    #CHI-840021
   DEFINE l_apa00          LIKE apa_file.apa00    #No.TQC-950113   
   DEFINE t_amtf1,t_amt1   LIKE type_file.num20_6  #MOD-BB0020
   DEFINE t_amtf2,t_amt2   LIKE type_file.num20_6  #MOD-BB0020
   DEFINE l_apc06          LIKE apc_file.apc06     #MOD-C80076
   DEFINE l_apc07          LIKE apc_file.apc07     #MOD-C80076
    
   SELECT * INTO g_apa.* FROM apa_file
    WHERE apa01=g_apa.apa01
 
   IF g_apa.apa00[1,1] = '2' THEN
      RETURN
   END IF
   IF g_apa.apa41 = 'Y' THEN
      CALL cl_err(g_apa.apa01,'aap-005',0)
      RETURN
   END IF
  #IF g_apa.apa63 MATCHES '[1]' THEN      #FUN-FUN-8A0075 #MOD-BB0304 mark 
   IF g_apa.apa63 MATCHES '[Ss1]' THEN    #MOD-BB0304 
      CALL cl_err('','mfg3557',0)
      RETURN
   END IF
 
   LET g_success='Y'
   LET g_apa_t.* = g_apa.*
   BEGIN WORK
   CALL t110_lock_cl()  #FUN-C80078 add
   OPEN t110_cl USING g_apa.apa01
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl k:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF
   FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
       CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
       CLOSE t110_cl
       ROLLBACK WORK
       RETURN
   END IF
 
   OPEN WINDOW t110_kkk_w AT 12,2 WITH FORM "aap/42f/aapt110_e"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No.FUN-580092 HCN
 
    CALL cl_ui_locale("aapt110_e")
 
   SELECT azi04 INTO t_azi04 FROM azi_file
      WHERE azi01 = g_apa.apa13
 
   SELECT COUNT(*) INTO cnt1 FROM apv_file WHERE apv01 = g_apa.apa01
 
   IF cnt1 = 0 THEN
      DECLARE t110_kkk_c0 CURSOR FOR
 
        SELECT apc01,apa07,apa08,apc06,    #No.TQC-6B0066
               apc08,(apc08-apc10),0, 
               apc09,(apc09-apc11),0,apa13,apc07,apc13   #No.MOD-580365
          FROM apa_file,apc_file 
         WHERE apa06 = g_apa.apa06
           AND apa07 = g_apa.apa07
           AND apa00 MATCHES '2*' 
           AND apa00 !='25'                 #No.FUN-690080
           AND (apa08 !='UNAP' OR apa08 IS NULL)   #MOD-820129
           AND apa13 = g_apa.apa13          # 幣別必須相同
           #AND apa08 != g_apa.apa01         # 不可沖自已產生的預付   #yinhy140217
           AND (apa08 != g_apa.apa01 OR apa08 IS NULL)                #yinhy140217
           AND apa41 = 'Y' AND apa42 != 'Y' 
           AND (apa58 = '2' OR apa58 ='3' OR apa58 IS NULL) 
           AND apa34 > apa35 
           AND apa01 =apc01 
          #AND apa02 < g_apa.apa02                              #MOD-BB0056 add #MOD-C60195 mark
           AND apa02 <= g_apa.apa02                             #MOD-C60195 add
 
      CALL g_apv.clear()
      LET i = 1
      FOREACH t110_kkk_c0 INTO g_apv[i].apv03,g_apv[i].apa07,g_apv[i].apa08,    #No.FUN-680027 #No.FUN-690080
                               g_apv[i].apa14,g_apv[i].apc08,    #No.FUN-680027 #No.FUN-690080
                               g_apv[i].un_payf,g_apv[i].apv04f, #No.FUN-690080
                               g_apv[i].apc09,g_apv[i].un_pay,g_apv[i].apv04,   #No.FUN-680027
                               #No.MOD-580365  --begin
                               m_apa[i].apa13,m_apa[i].apa72,m_apa[i].apa73
                               #No.MOD-580365  --end
 
         IF g_apz.apz27 = 'Y' AND m_apa[i].apa13 !=g_aza.aza17 THEN
             LET g_apv[i].un_pay = m_apa[i].apa73
             LET g_apv[i].apa14  = m_apa[i].apa72
         END IF
         IF cl_null(g_apv[i].apv03) THEN
            EXIT FOREACH
         END IF
         IF g_apa.apa00='11' THEN
            DROP TABLE x
 
            SELECT apa08 INTO g_msg FROM apa_file WHERE apa01=g_apv[i].apv03
 
            SELECT apb06 po_no FROM apb_file,apa_file
             WHERE apa01=g_msg AND apa01=apb01 AND apa41='Y' AND apa42!='Y'
              INTO TEMP x
 
            SELECT COUNT(*) INTO g_cnt FROM x     # 如果原預付有指定 P/O No
 
            IF g_cnt > 0 THEN
               SELECT MAX(po_no) INTO g_msg FROM x
               SELECT COUNT(*) INTO g_cnt FROM apb_file, x
                WHERE apb01=g_apa.apa01 AND apb06=po_no
               IF g_cnt=0 THEN
                  INITIALIZE g_apv[i].* TO NULL CONTINUE FOREACH
               END IF
            END IF
         END IF
 
         DECLARE t110_sel_apc02 CURSOR FOR
             #SELECT apc02 FROM apc_file WHERE apc01 =g_apa.apa01  #No.MOD-A10055 mark 
             SELECT apc02 FROM apc_file WHERE apc01 =g_apv[i].apv03   #No.MOD-A10055 mod
                                          AND apc08 >(apc10+apc14)
         LET j=0
         LET l_apv.apv03    = g_apv[i].apv03  
         LET l_apv.apa07    = g_apv[i].apa07  
         LET l_apv.apa08    = g_apv[i].apa08  
         LET l_apv.apa14    = g_apv[i].apa14  
         LET l_apv.apc08    = g_apv[i].apc08  
         LET l_apv.un_payf  = g_apv[i].un_payf
         LET l_apv.apv04f   = g_apv[i].apv04f 
         LET l_apv.apc09    = g_apv[i].apc09  
         LET l_apv.un_pay   = g_apv[i].un_pay 
         LET l_apv.apv04    = g_apv[i].apv04  
         LET l_apa1.apa13   = m_apa[i].apa13  
         LET l_apa1.apa72   = m_apa[i].apa72  
         LET l_apa1.apa73   = m_apa[i].apa73 
         FOREACH t110_sel_apc02 INTO l_apc02
            LET g_apv[i].apv02    = i
            LET g_apv[i].apv05    = l_apc02
            LET g_apv[i].apv03    = l_apv.apv03  
            LET g_apv[i].apa07    = l_apv.apa07  
            LET g_apv[i].apa08    = l_apv.apa08  
            LET g_apv[i].apa14    = l_apv.apa14  
            LET g_apv[i].apc08    = l_apv.apc08  
            LET g_apv[i].un_payf  = l_apv.un_payf
            LET g_apv[i].apv04f   = l_apv.apv04f 
            LET g_apv[i].apc09    = l_apv.apc09  
            LET g_apv[i].un_pay   = l_apv.un_pay 
            LET g_apv[i].apv04    = l_apv.apv04  
            LET m_apa[i].apa13    = l_apa1.apa13  
            LET m_apa[i].apa72    = l_apa1.apa72  
            LET m_apa[i].apa73    = l_apa1.apa73 
            INSERT INTO apv_file(apv01,apv02,apv03,apv04f,apv04,apv05,apvlegal)     #No.FUN-680027 #FUN-980001 add apvlegal
              VALUES (g_apa.apa01,i,g_apv[i].apv03,0,0,g_apv[i].apv05,g_legal)     #No.FUN-680027 #FUN-980001 add g_legal
            LET j=1 
            LET i = i + 1
            IF i > g_max_rec THEN     #No.MOD-480131
               EXIT FOREACH
            END IF
         END FOREACH
         LET i=i-j
         LET i = i + 1
         IF i > g_max_rec THEN     #No.MOD-480131
            EXIT FOREACH
         END IF
      END FOREACH
      CALL g_apv.deleteElement(i)
      LET ls_rec_b = i - 1
   END IF
 
   IF cnt1 > 0 THEN
     #-MOD-A70095-add-
    #-MOD-A80217-mark-
    # LET l_cnt = 0
    # SELECT count(*) INTO l_cnt
    #   FROM apv_file
    #  WHERE apv01 = g_apa.apa01 AND apv03 = 'DIFF'
    ##若有DIFF既代表此筆AP帳款已用全額沖帳方式處理,如有匯率異動時則會計算出apa34差異金額
    # IF l_cnt > 0 THEN    
    #    UPDATE apv_file SET apv04 = apv04 + g_apa.apa34
    #     WHERE apv01 = g_apa.apa01 AND apv03 = 'DIFF'
    #    IF SQLCA.sqlcode OR SQLCA.SQLERRD[3]=0 THEN  
    #       CALL cl_err3("upd","apv_file", g_apa.apa01,"",SQLCA.sqlcode,"","upd apv04:",1)  
    #    END IF
    #    LET g_apa.apa65  = g_apa.apa65  + g_apa.apa34
    # END IF
    #-MOD-A80217-end-
     #-MOD-A70095-end-
      DECLARE t110_kkk_c CURSOR FOR
         SELECT apv02,apv03,apa07,apv05,apa08,apc06,                #No.TQC-6B0066
            apc08,apc09,(apc08-apc10),(apc09-apc11),apv04f,apv04,#MOD-4A0288
            apa13,apc07,apc13  #No.MOD-580365
           FROM apv_file,OUTER apc_file,OUTER apa_file
          WHERE apv01 = g_apa.apa01 AND apv_file.apv03 = apa_file.apa01
            AND  apc_file.apc01 =apv_file.apv03
            AND  apa_file.apa01 =apv03           #No.TQC-850001
            AND  apc_file.apc02 =1        #No.TQC-6B0066
          ORDER BY apv02
 
      CALL g_apv.clear()
      LET k = 1
 
      FOREACH t110_kkk_c INTO g_apv[k].*,m_apa[k].* #No.MOD-580365
         LET k = k + 1
         IF k > g_max_rec THEN         #No.MOD-480131
            EXIT FOREACH
         END IF
      END FOREACH
      CALL g_apv.deleteElement(k)
     #重新計算沖帳視窗中的匯差
     #-MOD-A70095-mark-
     #LET l_net = 0
     #FOR l_i = 1 TO g_apv.getLength()
     #    IF cl_null(g_apv[l_i].apv03) THEN CONTINUE FOR END IF
     #    IF g_apv[l_i].apv03 = 'DIFF' THEN CONTINUE FOR END IF
     #    SELECT apa14 INTO l_apa14 FROM apa_file
     #     WHERE apa01=g_apv[l_i].apv03
     #    IF l_apa14 <> g_apv[l_i].apa14 THEN
     #       LET l_amt=cl_digcut(g_apv[l_i].apv04f*g_apa.apa14,g_azi04)
     #                -g_apv[l_i].apv04
     #       IF cl_null(l_amt) THEN LET l_amt=0 END IF
     #       LET l_net = l_net + l_amt
     #       LET l_net = cl_digcut(l_net,g_azi04)
     #    ELSE
     #       IF g_apv[l_i].apa14 <> g_apa.apa14 THEN
     #          LET l_amt=cl_digcut(g_apv[l_i].apv04f*g_apa.apa14,g_azi04)
     #                   -g_apv[l_i].apv04
     #          IF cl_null(l_amt) THEN LET l_amt=0 END IF
     #          LET l_net = l_net + l_amt
     #          LET l_net = cl_digcut(l_net,g_azi04)
     #       END IF
     #    END IF
     #END FOR
     #DELETE FROM apv_file WHERE apv01=g_apa.apa01 AND apv03='DIFF'
     #IF SQLCA.sqlcode THEN
     #   CALL cl_err3("del","apv_file", g_apa.apa01,"",SQLCA.sqlcode,"","delete diff",1)
     #END IF
     #LET l_cnt = 0
     #SELECT COUNT(*) INTO l_cnt FROM apv_file WHERE apv01=g_apa.apa01
     #IF l_cnt > 0 THEN
     #   SELECT SUM(apv04f),SUM(apv04) INTO apv04f_sum,apv04_sum
     #     FROM apv_file WHERE apv01 = g_apa.apa01
     #   IF cl_null(apv04f_sum) THEN LET apv04f_sum = 0 END IF
     #   IF cl_null(apv04_sum) THEN LET apv04_sum = 0 END IF
     #   IF apv04f_sum = g_apa.apa31f THEN
     #      LET l_net = g_apa.apa31-apv04_sum
     #   END IF
     #END IF
     #IF l_net <> 0 THEN
     #   SELECT MAX(apv02)+1 INTO l_apv02 FROM apv_file
     #    WHERE apv01 = g_apa.apa01
     #   IF cl_null(l_apv02)  THEN
     #      LET l_apv02 = 1
     #   END IF
     #   INSERT INTO apv_file (apv01,apv02,apv03,apv04f,apv04,apvlegal) #FUN-980001 add apvlegal
     #                 VALUES (g_apa.apa01,l_apv02,'DIFF',0,l_net,g_legal) #FUN-980001 add g_legal
     #   IF SQLCA.sqlcode THEN
     #      CALL cl_err3("ins","apv_file",g_apa.apa01,l_apv02,SQLCA.sqlcode,"","insert diff",1)
     #   END IF
     #END IF
 
     #CALL g_apv.clear()
     #LET k = 1
     #LET g_apa.apa65f = 0
     #LET g_apa.apa65 = 0
 
     #FOREACH t110_kkk_c INTO g_apv[k].*,m_apa[k].*
     #   LET g_apa.apa65f = g_apa.apa65f + g_apv[k].apv04f
     #   LET g_apa.apa65  = g_apa.apa65  + g_apv[k].apv04
     #   LET k = k + 1
     #   IF k > g_max_rec THEN
     #      EXIT FOREACH
     #   END IF
     #END FOREACH
     #CALL g_apv.deleteElement(k)
     #-MOD-A70095-end-
     #end MOD-860251 add
      LET ls_rec_b = k - 1
   END IF
 
   LET l_sumf_h = g_apa.apa65f
   LET l_sum_h  = g_apa.apa65
 
   DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
 
   LET l_allow_insert = cl_detail_input_auth("insert")
   LET l_allow_delete = cl_detail_input_auth("delete")
 
   LET i = 1
   INPUT ARRAY g_apv WITHOUT DEFAULTS FROM s_apv.*
         ATTRIBUTE(COUNT=ls_rec_b,MAXCOUNT=g_max_rec,UNBUFFERED,
                   INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)
 
      BEFORE INSERT
         LET i = ARR_CURR()
         LET p_cmd='a'
         INITIALIZE g_apv[i].* TO NULL
         LET g_apv_t.* = g_apv[i].*
         NEXT FIELD apv02
 
      AFTER INSERT
         IF INT_FLAG THEN
            CALL cl_err('',9001,0)
            LET INT_FLAG = 0
            CANCEL INSERT
         END IF
         IF g_apv[i].apv03 IS NULL THEN
            CALL g_apv.deleteElement(i)
            NEXT FIELD apv02
            CANCEL INSERT
         END IF
         INSERT INTO apv_file(apv01,apv02,apv03,apv04f,apv04,apv05,apvlegal)      #No.FUN-680027 #FUN-980001 add apvlegal
          VALUES(g_apa.apa01,g_apv[i].apv02,g_apv[i].apv03,
                 g_apv[i].apv04f,g_apv[i].apv04,g_apv[i].apv05,g_legal)          #No.FUN-680027 #FUN-980001 add g_legal
         IF SQLCA.sqlcode THEN
            CALL cl_err3("ins","apv_file",g_apa.apa01,g_apv[i].apv02,SQLCA.sqlcode,"","ins apv:",1)  #No.FUN-660122
            LET g_success = 'N'
            CANCEL INSERT
         ELSE
            LET ls_rec_b = ls_rec_b + 1
            MESSAGE "insert ok"
            IF g_success = 'Y' AND g_apv[i].apv03 <> 'DIFF' THEN   #MOD-830234
               SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa65f,g_apa.apa65
                 FROM apv_file WHERE apv01=g_apa.apa01
 
               IF cl_null(g_apa.apa65f) THEN
                  LET g_apa.apa65f = 0
               END IF
 
               IF cl_null(g_apa.apa65 ) THEN
                  LET g_apa.apa65 = 0
               END IF
 
               DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
 
               UPDATE apa_file SET apa65f=g_apa.apa65f,apa65=g_apa.apa65
                WHERE apa01 = g_apa.apa01
               IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
                  CALL cl_err3("upd","apa_file", g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                  LET g_success='N'
                  IF p_cmd = 'u' THEN
                     LET g_apv[i].*=g_apv_t.*
                  END IF
               END IF
 
             #回寫待抵帳款的已付金額的時機,改於確認段再回寫,所以這段mark掉
              SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                FROM aph_file,apf_file
               WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                 AND aph03 IN ('6','7','8','9')
             
              IF g_amt1f IS NULL THEN
                 LET g_amt1f = 0
                 LET g_amt1 = 0
              END IF

               #No.MOD-C30061  --Begin #增加退款沖帳金額
               SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
                 FROM apg_file,apf_file
                WHERE apg04=g_apv[i].apv03 AND apg01=apf01 AND apf41='Y'
                  #AND apf00='32'
                  AND (apf00='32' OR apf00='36')     #MOD-D70039

               IF g_amt6f IS NULL THEN
                  LET g_amt6f = 0
                  LET g_amt6 = 0
               END IF
               #No.MOD-C30061  --End
             
              SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                FROM apv_file Where apv03=g_apv[i].apv03
             
              IF g_amt2f IS NULL THEN
                 LET g_amt2f = 0
                 LET g_amt2 = 0
              END IF
             
              SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                FROM oob_file,ooa_file
               WHERE oob01 = ooa01
                 AND oob06 = g_apv[i].apv03
                 AND oob03 = '2' AND oob04 = '9'
                 AND ooaconf = 'Y' #須為已確認
             
              IF cl_null(g_amt3f) THEN
                 LET g_amt3f = 0
                 LET g_amt3 = 0
              END IF
             
              #成本分攤
              SELECT SUM(aqb04) INTO g_amt4 FROM aqa_file,aqb_file
               WHERE aqa01 = aqb01 AND aqa04='Y' AND aqaconf = 'Y'
                 AND aqb02=g_apv[i].apv03
              IF cl_null(g_amt4) THEN
                 LET g_amt4=0
                 LET g_amt4f=0
              END IF
              LET g_amt4f=g_amt4/g_apv[i].apa14
             
              LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f+g_amt6f  #MOD-C3006 add g_amt6f
              LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt4+g_amt6        #MOD-C3006 add g_amt6
             
              SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
              CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
              LET l_apa.apa73 = l_apa.apa34 - g_amt1 + g_net
             
              UPDATE apa_file SET apa35f= g_amt1f,
                                  apa35 = g_amt1,
                                  apa73 = l_apa.apa73  #No.MOD-640537
               WHERE apa01 = g_apv[i].apv03
              IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
                 CALL cl_err3("upd","apa_file",g_apv[i].apv03,"",STATUS,"","upd apa",1)
                 LET g_success='N'
                 IF p_cmd = 'u' THEN
                    LET g_apv[i].*=g_apv_t.*
                 END IF
              END IF
              SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                FROM aph_file,apf_file
               WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                 AND aph03 IN ('6','7','8','9')
                 AND aph17 = 1                          #No.TQC-6B0066
                  
              IF g_amt1f IS NULL THEN
                 LET g_amt1f = 0
                 LET g_amt1 = 0
              END IF
               #No.MOD-C30061  --Begin #增加退款沖帳金額
               SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
                 FROM apg_file,apf_file
                WHERE apg04=g_apv[i].apv03 AND apg01=apf01 AND apf41='Y'
                  #AND apf00='32'
                  AND (apf00='32' OR apf00='36')     #MOD-D70039
      
               IF g_amt6f IS NULL THEN
                  LET g_amt6f = 0
                  LET g_amt6 = 0
               END IF
               #No.MOD-C30061  --End
              
              SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                FROM apv_file Where apv03 =g_apv[i].apv03
              
              IF g_amt2f IS NULL THEN
                 LET g_amt2f = 0
                 LET g_amt2 = 0
              END IF
              
              SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                FROM oob_file,ooa_file
               WHERE oob01 = ooa01
                 AND oob06 = g_apv[i].apv03
                 AND oob03 = '2' AND oob04 = '9'
                 AND ooaconf = 'Y' #須為已確認
                 AND oob19 = 1                          #No.TQC-6B0066
              
              IF cl_null(g_amt3f) THEN
                 LET g_amt3f = 0
                 LET g_amt3 = 0
              END IF

             #---------------------MOD-C70137----------------------(S)
             #成本分攤
              SELECT SUM(aqb04) INTO g_amt4
                FROM aqa_file,aqb_file
               WHERE aqa01 = aqb01
                 AND aqa04 ='Y'
                 AND aqaconf = 'Y'
                 AND aqb02 = g_apv[i].apv03
              IF cl_null(g_amt4) THEN
                 LET g_amt4 = 0
                 LET g_amt4f = 0
              END IF
              LET g_amt4f = g_amt4/g_apv[i].apa14
             #---------------------MOD-C70137----------------------(E)
              
             #LET g_amt1f = g_amt1f + g_amt2f + g_amt3f + g_amt6f            #MOD-C30061 add g_amt6f #MOD-C70137 mark
              LET g_amt1f = g_amt1f + g_amt2f + g_amt3f + g_amt4f + g_amt6f  #MOD-C70137 add
             #LET g_amt1 = g_amt1 + g_amt2 + g_amt3 + g_amt6                 #MOD-C30061 add g_amt6 #MOD-C70137 mark
              LET g_amt1 = g_amt1 + g_amt2 + g_amt3 + g_amt4 + g_amt6        #MOD-C70137 add
              SELECT * INTO l_apc.* FROM apc_file WHERE apc01=g_apv[i].apv03 AND apc02 =1   #No.TQC-6B0066
              CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
              LET l_apc.apc13 = l_apc.apc09 - g_amt1 + g_net
              UPDATE apc_file set apc10 = g_amt1f,
                                  apc11 = g_amt1,
                                  apc13 = l_apc.apc13
               WHERE apc01 =g_apv[i].apv03
                 AND apc02 =1               #No.TQC-6B0066
                SELECT SUM(apv04),SUM(apv04f) INTO l_apv04,l_apv04f FROM apv_file
                 WHERE apv03 =g_apv[i].apv03
                FOR j=1 TO g_apv.getLength()
                    IF g_apv[j].apv03 =g_apv[i].apv03 THEN
                       LET g_apv[j].un_pay  =g_apv[j].apc09-l_apv04
                    END IF
                END FOR
                
                IF cl_null(g_apv_t.apv04f) THEN
                   LET g_apv_t.apv04f = 0
                END IF
                IF cl_null(g_apv[i].apv04f) THEN
                   LET g_apv[i].apv04f =0
                END IF
                FOR j=1 TO g_apv.getLength()
                    IF g_apv[j].apv03 =g_apv[i].apv03 THEN
                       LET g_apv[j].un_payf =g_apv[j].apc08-l_apv04f
                    END IF
                END FOR
            END IF
         END IF
 
      BEFORE INPUT
         IF ls_rec_b != 0 THEN
            CALL fgl_set_arr_curr(i)
         END IF
         LET g_before_input_done = FALSE
         CALL t110_set_entry_apv('a')
         CALL t110_set_no_entry_apv('a')
         LET g_before_input_done = TRUE
 
      BEFORE ROW
         LET p_cmd = ''
         LET i = ARR_CURR()
         LET l_lock_sw = 'N'
         IF ls_rec_b >= i THEN
            LET p_cmd='u'
            LET g_apv_t.* = g_apv[i].*
            #-->鎖住待抵沖帳資料
            IF g_apv_t.apv03 <> 'DIFF' THEN
               LET g_forupd_sql = "SELECT apa07,apc12,apc06,apc08,(apc08-apc10),",      #No.FUN-680027
                                  "       apc09,(apc09-apc11),apa13,apc07,apc13",      #No.FUN-680027
                                  "  FROM apa_file,apc_file ",       #No.FUN-680027
                                  " WHERE apa01 =apc01 ",           #No.FUN-680027
                                  "   AND apa01=?           "       #No.FUN-680027   #No.TQC-850001
               DECLARE t110_loc_cr CURSOR FROM g_forupd_sql
 
               OPEN t110_loc_cr USING g_apv_t.apv03
               IF STATUS THEN
                  CALL cl_err("OPEN t110_loc_cr:", STATUS, 1)
                  LET l_lock_sw = "Y"
               END IF
 
               FETCH t110_loc_cr INTO g_apv[i].apa07,g_apv[i].apa08,g_apv[i].apa14,
                                      g_apv[i].apc08,g_apv[i].un_payf,      #No.FUN-680027
                                      g_apv[i].apc09,g_apv[i].un_pay,       #No.FUN-680027
                                      m_apa[i].*  #No.MOD-580365
               IF SQLCA.sqlcode THEN
                  CALL cl_err(g_apv_t.apv02,SQLCA.sqlcode,1)
                  LET l_lock_sw = "Y"
               END IF
               IF g_apz.apz27 = 'Y' AND g_aza.aza17 ! = m_apa[i].apa13 THEN
                  LET g_apv[i].un_pay = m_apa[i].apa73
                  LET g_apv[i].apa14  = m_apa[i].apa72
               END IF
            END IF
            CALL cl_show_fld_cont()     #FUN-550037(smin)
         END IF
         CALL t110_set_entry_apv('D')
         IF g_apv[i].apv03='DIFF' THEN
            CALL t110_set_no_entry_apv('D')
         END IF
 
      BEFORE FIELD apv02
         IF cl_null(g_apv[i].apv02) OR g_apv[i].apv02 = 0 THEN
            SELECT MAX(apv02)+1 INTO g_apv[i].apv02 FROM apv_file
             WHERE apv01 = g_apa.apa01
            IF cl_null(g_apv[i].apv02)  THEN
               LET g_apv[i].apv02 = 1
            END IF
            LET g_apv[i].apv04f= 0
            LET g_apv[i].apv04 = 0
         END IF
          CALL t110_set_entry_apv(p_cmd)  #MOD-4A0288
 
      AFTER FIELD apv02
         IF g_apv_t.apv02 IS NULL OR
            g_apv_t.apv02 != g_apv[i].apv02 THEN
            SELECT COUNT(*) INTO k FROM apv_file
                WHERE apv01 = g_apa.apa01 AND apv02 = g_apv[i].apv02
            IF k > 0 THEN
               CALL cl_err('',-239,0)
               NEXT FIELD apv02
            END IF
         END IF
          CALL t110_set_no_entry_apv(p_cmd)  #MOD-4A0288
 
 
      AFTER FIELD apv03
         IF NOT cl_null(g_apv[i].apv03) AND g_apv[i].apv03 <> 'DIFF' THEN
            CALL t110_set_entry_apv('F')
           #-MOD-AA0027-add-
            IF g_apv[i].apv03 = g_apa.apa01 THEN
               CALL cl_err(g_apv[i].apv03,'aap-128',0)
               NEXT FIELD apv03
            END IF
           #-MOD-AA0027-end-
#No.TQC-6B0066--begin(原先apv05表示待扺帳款的子帳期，所以把判斷移到apv05之后，
#                     現在apv05表示本單據的子帳期，因此判斷放回apv03)
            #MOD-A30008---modify---start---
            #LET g_forupd_sql = "SELECT apa07,apa08,apa13,apc06,apc08,",
            #                   "       (apc08-apc10),apc09,(apc09-apc11),",
            #                   "       apa41,apa13,apc07,apc13 FROM apa_file,apc_file",
            #                   " WHERE apa01 = ? AND apa00 MATCHES '2*'",
            #                   "   AND (apa58='2' OR apa58='3' OR apa58 IS NULL)",
            #                   "   AND apc01=apa01 AND apc02 ='1'",
            #                   "   AND apa41 = 'Y' AND apa42 != 'Y' FOR UPDATE"
             LET g_forupd_sql = "SELECT apc02,'','','',apc06,apc08,",               #TQC-C50254 add apc02
                                "       (apc08-apc10),apc09,(apc09-apc11),",
                                "       '','',apc07,apc13 FROM apc_file",
                                " WHERE apc01 = ? AND apc02 ='1' FOR UPDATE"
            LET g_forupd_sql = cl_forupd_sql(g_forupd_sql)
            DECLARE t110_loc2_cr CURSOR FROM g_forupd_sql
            #MOD-A30008---modify---end---
            OPEN t110_loc2_cr USING g_apv[i].apv03
            IF STATUS THEN
               CALL cl_err("OPEN t110_loc2_cr:", STATUS, 1)
               CLOSE t110_loc2_cr
               ROLLBACK WORK
               RETURN
            END IF
 
            FETCH t110_loc2_cr INTO g_apv[i].apv05,g_apv[i].apa07,g_apv[i].apa08,l_apa13,  #TQC-C50254 add apv05
                                    g_apv[i].apa14,g_apv[i].apc08,l_amtf,
                                    g_apv[i].apc09,l_amt,l_apa41,
                                    m_apa[i].apa13,m_apa[i].apa72,m_apa[i].apa73 #No.MOD-580365
            IF SQLCA.sqlcode THEN
               CALL cl_err(g_apv[i].apv03,SQLCA.sqlcode,0)
               LET g_apv[i].apv03 = g_apv_t.apv03
               CLOSE t110_loc2_cr
               NEXT FIELD apv03
           #MOD-A30008---add---start---
            ELSE
               SELECT apa07,apa08,apa13,apa41,apa13 INTO g_apv[i].apa07,g_apv[i].apa08,l_apa13,l_apa41,m_apa[i].apa13
               FROM apa_file
               WHERE apa01=g_apv[i].apv03
                 AND apa00 MATCHES '2*'
                 AND (apa58='2' OR apa58='3' OR apa58 IS NULL)
                 AND apa41 = 'Y' AND apa42 != 'Y'
                 AND apa02 <= g_apa.apa02                        #MOD-BB0056 add
              #-MOD-AA0027-add-
               IF SQLCA.sqlcode THEN
                  CALL cl_err(g_apv[i].apv03,'mfg9089',0)
                  NEXT FIELD apv03
               END IF
              #-MOD-AA0027-end-
           #MOD-A30008---add---end---
            END IF
 
 
            IF g_apv[i].apa08 = 'UNAP' THEN
               CALL cl_err(g_apv[i].apv03,'aap-915',0)
               NEXT FIELD apv03
            END IF
            #FUN-910088-modify--begin--
            #SELECT apa06 INTO l_apa06 FROM apa_file
            #   WHERE apa01= g_apv[i].apv03
            SELECT apa00,apa06 INTO l_apa00,l_apa06 FROM apa_file  #FUN-910088 add apa00
               WHERE apa01= g_apv[i].apv03
            #FUN-910088-modify--end----        
            IF g_apa.apa06 <> l_apa06 AND l_apa00 <> '25' THEN    #No.TQC-950113
               CALL cl_err('','aap-090',1)
            END IF
            #-->此帳款尚未確認
            IF l_apa41 != 'Y' THEN
               CALL cl_err(g_apv[i].apv03,'aap-141',0)
               NEXT FIELD apv03
            END IF
 
            #-->不可沖不同幣別
            IF l_apa13 != g_apa.apa13 THEN
               CALL cl_err(g_apv[i].apv03,'aap-014',0)
               NEXT FIELD apv03
            END IF
 
            #-->無金額可沖帳
            IF l_amtf <=0 AND l_amt <=0 AND g_apa.apa41 <> 'N' THEN  #No.FUN-690080
               CALL cl_err(g_apv[i].apv03,'aap-203',0)
               NEXT FIELD apv03
            END IF
            LET g_apv[i].un_payf= l_amtf
            LET g_apv[i].un_pay = l_amt
            SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
            IF g_apz.apz27 = 'Y' AND g_aza.aza17 != m_apa[i].apa13 THEN
                LET g_apv[i].un_pay = m_apa[i].apa73
                LET g_apv[i].apa14  = m_apa[i].apa72
            END IF
         END IF
 
      AFTER FIELD apv04f
         IF NOT cl_null(g_apv[i].apv04f) THEN
               IF g_apv[i].apv04f < 0 THEN
               NEXT FIELD apv04f
            END IF
            LET l_apv04 = g_apv[i].apv04f * g_apv[i].apa14
            IF g_apv[i].apv03 <> 'DIFF' THEN
               LET g_apv[i].apv04 = l_apv04
            END IF
            SELECT apc08 INTO l_apc08 FROM apc_file       #No.TQC-740314   #CHI-820015         #MOD-880144   #MOD-880231
             WHERE apc01 = g_apv[i].apv03   #MOD-850205
 
           #SELECT SUM(apc09-apc11)  INTO l_apc09 FROM apc_file     #TQC-A80186 mark
            #SELECT SUM(apc09)  INTO l_apc09 FROM apc_file           #TQC-A80186  
            SELECT apc06,apc07,SUM(apc09)  INTO l_apc06,l_apc07,l_apc09 FROM apc_file           #TQC-A80186   #MOD-C80076 add apc06,apc07
             WHERE apc01 = g_apv[i].apv03                                       
             GROUP BY apc06,apc07               #MOD-C80076
            #IF l_apc08 = g_apv[i].apv04f THEN                                   
            IF l_apc08 = g_apv[i].apv04f AND l_apc06=l_apc07 THEN    #MOD-C80076                               
               LET g_apv[i].apv04 = l_apc09                                     
            END IF                                                              
            LET g_amt1f = 0
            LET g_amt2f = 0
            LET g_amt3f = 0
            SELECT SUM(aph05f) INTO g_amt1f
              FROM aph_file,apf_file
             WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
               AND aph03 IN ('6','7','8','9')
               AND aph17 = 1                           #No.TQC-6B0066
            IF g_amt1f IS NULL THEN LET g_amt1f = 0 END IF
 
            LET g_amt2f = g_apv[i].apv04f
            IF g_amt2f IS NULL THEN LET g_amt2f = 0 END IF
 
            SELECT SUM(oob09) INTO g_amt3f
              FROM oob_file,ooa_file
             WHERE oob01 = ooa01
               AND oob06 = g_apv[i].apv03
               AND oob03 = '2' AND oob04 = '9'
               AND ooaconf = 'Y' #須為已確認
               AND oob19 = 1                          #No.TQC-6B0066
            IF cl_null(g_amt3f) THEN LET g_amt3f = 0 END IF
 
            LET g_amt1f=g_amt1f+g_amt2f+g_amt3f
            #依全額比較,sum相關沖帳金額與apc08比較,
            #沖帳金額若大於時則提示錯誤訊息
            IF l_apc08 < g_amt1f THEN
               CALL cl_err('','aap-779',1)
               LET g_apv[i].apv04f =g_apv_t.apv04f
               NEXT FIELD apv04f
            END IF
         END IF
         #原幣是否已經衝平，如果原幣已經衝平，則本幣也應衝平
         SELECT apa34f,apa73 INTO m_apa34f,m_apa73 FROM apa_file
         WHERE apa01 = g_apv[i].apv03
         SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
           FROM aph_file,apf_file
          WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'  
            AND aph03 IN ('6','7','8','9')
         IF g_amt1f IS NULL THEN
            LET g_amt1f = 0
            LET g_amt1 = 0
         END IF
        #No.MOD-C30061  --Begin #增加退款沖帳金額
        SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
          FROM apg_file,apf_file
         WHERE apg04=g_apv[i].apv03 AND apg01=apf01 AND apf41='Y'
           #AND apf00='32'
           AND (apf00='32' OR apf00='36')     #MOD-D70039
        IF g_amt6f IS NULL THEN
           LET g_amt6f = 0
           LET g_amt6 = 0
        END IF
        #No.MOD-C30061  --End
 
         SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
           FROM apv_file Where apv03=g_apv[i].apv03
         IF g_amt2f IS NULL THEN
            LET g_amt2f = 0
            LET g_amt2 = 0
         END IF
 
         SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
           FROM oob_file,ooa_file
          WHERE oob01 = ooa01
            AND oob06 = g_apv[i].apv03
            AND oob03 = '2' AND oob04 = '9'
            AND ooaconf = 'Y' #須為已確認
         IF cl_null(g_amt3f) THEN
            LET g_amt3f = 0
            LET g_amt3 = 0
         END IF
 
         #成本分攤
         SELECT SUM(aqb04) INTO g_amt4 FROM aqa_file,aqb_file
          WHERE aqa01 = aqb01 AND aqa04='Y' AND aqaconf = 'Y'
            AND aqb02=g_apv[i].apv03
         IF cl_null(g_amt4) THEN
            LET g_amt4=0
            LET g_amt4f=0
         END IF
         LET g_amt4f=g_amt4/g_apv[i].apa14
         LET m_amt=g_amt1f+g_amt2f+g_amt3f+g_amt4f+g_amt6f   #MOD-C30061 add g_amt6f
 
         IF p_cmd = 'a' THEN
            LET m_amt=m_amt+g_apv[i].apv04f
         ELSE
            LET m_amt=m_amt+g_apv[i].apv04f-g_apv_t.apv04f
         END IF
         SELECT (apa34f-apa35f) INTO l_difff
           FROM apa_file WHERE apa01 = g_apv[i].apv03
 
         IF cl_null(g_apv_t.apv04f) THEN
            LET g_apv_t.apv04f = 0
         END IF
 
         LET l_total = l_difff + g_apv_t.apv04f
 
         IF  g_apv[i].apv04f > l_total THEN
            LET g_apv[i].apv04f = 0
            LET g_apv[i].apv04 = 0
            CALL cl_err(g_apa.apa01,'aap-194',0)
            NEXT FIELD apv04f
         END IF
         LET g_apv[i].apv04f = cl_digcut(g_apv[i].apv04f,t_azi04) #MOD-660095
         LET g_apv[i].apv04 = cl_digcut(g_apv[i].apv04,g_azi04) #MOD-660095
         IF m_amt = m_apa34f THEN                  #MOD-C90100
            LET g_apv[i].apv04 = g_apv[i].un_pay   #MOD-C90100
         END IF                                    #MOD-C90100
         DISPLAY g_apv[i].apv04 TO apv04           #MOD-D20103 add
       
      AFTER FIELD apv04
         IF NOT cl_null(g_apv[i].apv04) THEN
            IF g_apv[i].apv04f >0  AND g_apv[i].apv04=0 THEN                                                                        
               NEXT FIELD apv04                                                                                                     
            END IF                                                                                                                  
            SELECT apc13 INTO l_apc13 FROM apc_file #No.TQC-740314   #CHI-820015   #MOD-880144   #MOD-880231   #MOD-960280
             WHERE apc01 =g_apv[i].apv03   #MOD-850205
 
            LET g_amt1 = 0
            LET g_amt2 = 0
            LET g_amt3 = 0
            SELECT SUM(aph05) INTO g_amt1
              FROM aph_file,apf_file
             WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
               AND aph03 IN ('6','7','8','9')
               AND aph17 = 1                           #No.TQC-6B0066
            IF g_amt1 IS NULL THEN LET g_amt1 = 0 END IF
            #No.MOD-C30061  --Begin #增加退款沖帳金額
            SELECT SUM(apg05) INTO g_amt6
              FROM apg_file,apf_file
             WHERE apg04=g_apv[i].apv03 AND apg01=apf01 AND apf41='Y'
               #AND apf00='32'
               AND (apf00='32' OR apf00='36')     #MOD-D70039
            IF g_amt6 IS NULL THEN
               LET g_amt6 = 0
            END IF
            #No.MOD-C30061  --End
 
            LET g_amt2 = g_apv[i].apv04
            IF g_amt2 IS NULL THEN LET g_amt2 = 0 END IF
 
            SELECT SUM(oob10) INTO g_amt3
              FROM oob_file,ooa_file
             WHERE oob01 = ooa01
               AND oob06 = g_apv[i].apv03
               AND oob03 = '2' AND oob04 = '9'
               AND ooaconf = 'Y' #須為已確認
               AND oob19 = 1                          #No.TQC-6B0066
            IF g_amt3 IS NULL THEN LET g_amt3 = 0 END IF
 
            LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt6  #MOD-C30061 add g_amt6
            #依全額比較,sum相關沖帳金額與apc08比較,
            #沖帳金額若大於時則提示錯誤訊息
            IF cl_null(g_apv_t.apv04) THEN
               LET l_apv04=0
            ELSE
               LET l_apv04=g_apv_t.apv04
            END IF
            IF l_apc13 + l_apv04< g_amt2 THEN
               CALL cl_err('','aap-779',1)
               LET g_apv[i].apv04 =g_apv_t.apv04
               NEXT FIELD apv04
            END IF
           #IF cl_digcut(g_apv[i].apv04f * g_apv[i].apa14,g_azi04) != g_apv[i].apv04 THEN  #MOD-C90100 mark 
            IF cl_digcut(g_apv[i].apv04f * g_apv[i].apa14,g_azi04) != g_apv[i].apv04       #MOD-C90100 
               AND m_amt <> m_apa34f THEN                                                  #MOD-C90100 
               IF NOT cl_confirm('aap-202') THEN                                                                                    
                  LET g_apv[i].apv04 = g_apv[i].apv04f*g_apv[i].apa14                                                               
                  LET l_apv04 = g_apv[i].apv04                                                                                      
                  NEXT FIELD apv04                                                                                                  
               END IF                                                                                                               
            END IF                                                                                                                  
            IF g_apv[i].apv04 != g_apv_t.apv04 THEN                                                                                 
               UPDATE apv_file SET apv04=g_apv[i].apv04                                                                             
                WHERE apv01 = g_apa.apa01                                                                                           
                  AND apv02 = g_apv_t.apv02                                                                                         
               IF SQLCA.sqlcode THEN                                                                                                
                  LET g_apv[i].apv04 = 0                                                                                            
                  NEXT FIELD apv04                                                                                                  
               END IF                                                                                                               
            END IF                                                                                                                  
            IF g_apv[i].apv04 < 0 AND g_apv[i].apv03 <> 'DIFF' THEN
               NEXT FIELD apv04
            END IF
 
            IF g_apv[i].apv03 != 'DIFF' THEN
            #-->check 沖帳金額是否超過
              #不用控制本幣了，
              #因為有可能本幣會超過請款的金額，超過部分要確認匯兌損溢
               LET l_sum = 0
               LET l_sumf = 0
               LET l_over = 0
                FOR l_k =1 TO g_apv.getLength()   #No.MOD-480131
                  IF cl_null(g_apv[l_k].apv03) THEN
                     EXIT FOR
                  END IF
                  LET l_sumf= l_sumf+ g_apv[l_k].apv04f
                  LET l_sum = l_sum + g_apv[l_k].apv04
                  IF l_sumf > (g_apa.apa34f + l_sumf_h) THEN #維持原來
                     LET g_apv[i].apv04f= 0
                     LET g_apv[i].apv04 = 0
                     CALL cl_err(g_apa.apa34,'aap-193',0)
                     LET l_over = 1
                     EXIT FOR
                  END IF
               END FOR
 
               IF l_over=1 THEN
                  NEXT FIELD apv04f
               END IF
 
               SELECT (apa34f-apa35f),apa73 INTO l_difff,l_diff
                 FROM apa_file WHERE apa01 = g_apv[i].apv03
 
               IF cl_null(g_apv_t.apv04f) THEN
                  LET g_apv_t.apv04f = 0
                  LET g_apv_t.apv04 = 0
               END IF
 
               LET l_total = l_diff + g_apv_t.apv04
 
               IF  g_apv[i].apv04 > l_total THEN
                  LET g_apv[i].apv04f = 0
                  LET g_apv[i].apv04 = 0
                  CALL cl_err(g_apa.apa01,'aap-194',0)
                  LET l_over = 1
               END IF
 
               IF l_over=1 THEN
                  NEXT FIELD apv04f
               END IF
             END IF #No.MOD-580365
         END IF
         LET g_apv[i].apv04 = cl_digcut(g_apv[i].apv04,g_azi04) #MOD-660095
         DISPLAY g_apv[i].apv04 TO apv04                         #MOD-D20103 add
 
 
      AFTER FIELD apv05
          IF NOT cl_null(g_apv[i].apv05) THEN
             IF g_apv_t.apv05 IS NULL OR g_apv[i].apv05 <> g_apv_t.apv05 THEN
                SELECT COUNT(*) INTO g_cnt FROM apc_file 
                 #WHERE apc01 =g_apv[i].apv03   #MOD-810111  #TQC-C20027 Mark
                  WHERE apc01 =g_apa.apa01                   #TQC-C20027 Add
                   AND apc02 =g_apv[i].apv05
                IF g_cnt =0 THEN
                  CALL cl_err('','aap-777',1)
                  NEXT FIELD apv05
                END IF
                SELECT COUNT(*) INTO g_cnt FROM apc_file 
                 #WHERE apc01 =g_apv[i].apv03   #MOD-810111  #TQC-C20027 Mark
                  WHERE apc01 =g_apa.apa01                   #TQC-C20027 Add
                   AND apc02 =g_apv[i].apv05
                   AND apc08 >apc10   #CHI-820015
                IF g_cnt =0 THEN
                  CALL cl_err('','aap-778',1)
                  NEXT FIELD apv05
                END IF
 
         END IF
         END IF
 
 
      ON ACTION CONTROLP
           CASE
              WHEN INFIELD(apv03)
                #CALL q_apa2(FALSE,TRUE,' ','1',g_apa.apa06) RETURNING g_apv[i].apv03                     #TQC-750140    #MOD-820002   #No.MOD-C30717 Mark
                #CALL q_apa2(FALSE,TRUE,' ','1',g_apa.apa06,g_apa.apa07) RETURNING g_apv[i].apv03                                      #No.MOD-C30717 Add  #TQC-BC0115 Mark 
                 CALL q_apa2(FALSE,TRUE,' ','1',g_apa.apa06,g_apa.apa07,g_apa.apa02) RETURNING g_apv[i].apv03                                              #TQC-BC0115 Add
                  DISPLAY g_apv[i].apv03 TO apv03                                      #No.TQC-6B0066 
                 NEXT FIELD apv03
              OTHERWISE EXIT CASE
           END CASE
 
        BEFORE DELETE                            #是否取消單身
           IF g_apv[i].apv02 > 0 AND g_apv_t.apv02 IS NOT NULL THEN
              IF NOT cl_delb(0,0) THEN
                 CANCEL DELETE
              END IF
              DELETE FROM apv_file
               WHERE apv01 = g_apa.apa01 AND apv02 = g_apv_t.apv02
              IF SQLCA.sqlcode THEN
                 CALL cl_err3("del","apv_file",g_apa.apa01,g_apv_t.apv02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
                 CANCEL DELETE
              END IF
              LET ls_rec_b = ls_rec_b - 1
              MESSAGE "delete ok"
              IF g_success = 'Y' AND g_apv[i].apv03 <> 'DIFF' THEN #No.MOD-580365
                 SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa65f,g_apa.apa65
                   FROM apv_file WHERE apv01=g_apa.apa01
                 IF cl_null(g_apa.apa65f) THEN LET g_apa.apa65f = 0 END IF
                 IF cl_null(g_apa.apa65 ) THEN LET g_apa.apa65 = 0 END IF
                 DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
                 UPDATE apa_file SET apa65f=g_apa.apa65f,apa65=g_apa.apa65
                  WHERE apa01 = g_apa.apa01
                 IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
                    CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                    LET g_success='N'
                 END IF
                 SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                   FROM aph_file,apf_file
                  WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                    AND aph03 IN ('6','7','8','9')
                 IF g_amt1f IS NULL THEN
                    LET g_amt1f = 0
                    LET g_amt1 = 0
                 END IF
                 #No.MOD-C30061  --Begin #增加退款沖帳金額
                 SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
                   FROM apg_file,apf_file
                  WHERE apg04=g_apv[i].apv03 AND apg01=apf01 AND apf41='Y'
                    #AND apf00='32'                     #MOD-D70039
                    AND (apf00='32' OR apf00='36')      #MOD-D70039

                 IF g_amt6f IS NULL THEN
                    LET g_amt6f = 0
                    LET g_amt6 = 0
                 END IF
                 #No.MOD-C30061  --End
                 SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                   FROM apv_file Where apv03=g_apv[i].apv03
                 IF g_amt2f IS NULL THEN
                    LET g_amt2f = 0
                    LET g_amt2 = 0
                 END IF
                 SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                   FROM oob_file,ooa_file
                  WHERE oob01 = ooa01
                    AND oob06 = g_apv[i].apv03
                    AND oob03 = '2' AND oob04 = '9'
                    AND ooaconf = 'Y' #須為已確認
                 IF cl_null(g_amt3f) THEN
                    LET g_amt3f = 0
                    LET g_amt3 = 0
                 END IF
                 #成本分攤
                 SELECT SUM(aqb04) INTO g_amt4 FROM aqa_file,aqb_file
                  WHERE aqa01 = aqb01 AND aqa04='Y' AND aqaconf = 'Y'
                    AND aqb02=g_apv[i].apv03
                 IF cl_null(g_amt4) THEN
                    LET g_amt4=0
                    LET g_amt4f=0
                 END IF
                 LET g_amt4f=g_amt4/g_apv[i].apa14
 
                 ##No.MOD-BB0020  --Begin
                 #LET t_amtf1 = 0
                 #LET t_amt1 = 0
                 #SELECT SUM(apg05f),SUM(apg05) INTO t_amtf1,t_amt1
                 #  FROM apg_file,apf_file
                 # WHERE apg04=g_apv[i].apv03 AND apg01=apf01 AND apg41='Y'
                 ##No.MOD-BB0020  --End
                 LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f+g_amt6f  #MOD-C30061 add g_amt6f
                 LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt4+g_amt6        #MOD-C30061 add g_amt1
                 SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
                 CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
                 LET l_apa.apa73 = l_apa.apa34 - g_amt1 + g_net
                 UPDATE apa_file SET apa35f= g_amt1f,
                                     apa35 = g_amt1,
                                    #apa72 = g_apa.apa72,   No.MOD-580365
                                     apa73 = l_apa.apa73   #No.MOD-640537
                  WHERE apa01 = g_apv[i].apv03
                 IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
                    CALL cl_err3("upd","apa_file",g_apv[i].apv03,"",STATUS,"","upd apa:",1)
                    LET g_success='N'
                 END IF
               SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                 FROM aph_file,apf_file
                WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                  AND aph03 IN ('6','7','8','9')
                  AND aph17 = 1                           #No.TQC-6B0066
 
               IF g_amt1f IS NULL THEN
                  LET g_amt1f = 0
                  LET g_amt1 = 0
               END IF
               #No.MOD-C30061  --Begin #增加退款沖帳金額
               SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
                 FROM apg_file,apf_file
                WHERE apg04=g_apv[i].apv03 AND apg01=apf01 AND apf41='Y'
                  #AND apf00='32'                 #MOD-D70039
                  AND (apf00='32' OR apf00='36')  #MOD-D70039

               IF g_amt6f IS NULL THEN
                  LET g_amt6f = 0
                  LET g_amt6 = 0
               END IF
               #No.MOD-C30061  --End
 
               SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                 FROM apv_file Where apv03=g_apv[i].apv03
 
               IF g_amt2f IS NULL THEN
                  LET g_amt2f = 0
                  LET g_amt2 = 0
               END IF
 
               SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                 FROM oob_file,ooa_file
                WHERE oob01 = ooa01
                  AND oob06 = g_apv[i].apv03
                  AND oob03 = '2' AND oob04 = '9'
                  AND ooaconf = 'Y' #須為已確認
                  AND oob19 = 1                           #No.TQC-6B0066
 
               IF cl_null(g_amt3f) THEN
                  LET g_amt3f = 0
                  LET g_amt3 = 0
               END IF


              ##No.MOD-BB0020  --Begin
              #LET t_amtf2 = 0
              #LET t_amt2 = 0
              #SELECT SUM(apg05f),SUM(apg05) INTO t_amtf2,t_amt2
              #  FROM apg_file,apf_file
              # WHERE apg04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
              ##No.MOD-BB0020  --End
 
               LET g_amt1f = g_amt1f + g_amt2f + g_amt3f + g_amt6f + g_amt4f   #MOD-C30061 add g_amt6f    #TQC-C70079  add   g_amt4f
               LET g_amt1 = g_amt1 + g_amt2 + g_amt3 + g_amt6 + g_amt4         #MOD-C30061 add g_amt6     #TQC-C70079  add   g_amt4

               SELECT * INTO l_apc.* FROM apc_file WHERE apc01=g_apv[i].apv03 AND apc02 =1      #No.TQC-6B0066
               CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
               LET l_apc.apc13 = l_apc.apc09 - g_amt1 + g_net
               UPDATE apc_file set apc10=g_amt1f,
                                   apc11=g_amt1,
                                   apc13=l_apc.apc13
                WHERE apc01 =g_apv[i].apv03
                  AND apc02 =1               #No.TQC-6B0066

                SELECT SUM(apv04),SUM(apv04f) INTO l_apv04,l_apv04f  FROM apv_file
                 WHERE apv03 =g_apv[i].apv03
                FOR j=1 TO g_apv.getLength()
                    IF g_apv[j].apv03 =g_apv[i].apv03 THEN
                       LET g_apv[j].un_pay  =g_apv[j].apc09-l_apv04
                    END IF
                END FOR
                
                IF cl_null(g_apv_t.apv04f) THEN
                   LET g_apv_t.apv04f = 0
                END IF
                IF cl_null(g_apv[i].apv04f) THEN
                   LET g_apv[i].apv04f =0
                END IF
                FOR j=1 TO g_apv.getLength()
                    IF g_apv[j].apv03 =g_apv[i].apv03 THEN
                       LET g_apv[j].un_payf =g_apv[j].apc08-l_apv04f
                    END IF
                END FOR
              END IF
           END IF
 
 
      ON ROW CHANGE
          IF INT_FLAG THEN
             CALL cl_err('',9001,0)
             LET INT_FLAG = 0
             LET g_apv[l_ac].* = g_apv_t.*
             CLOSE t110_loc2_cr
             LET g_success = 'N'
             EXIT INPUT
          END IF
          IF l_lock_sw = 'Y' THEN
             CALL cl_err(g_apv[l_ac].apv02,-263,1)
             LET g_apv[l_ac].* = g_apv_t.*
          ELSE
             UPDATE apv_file SET apv02 = g_apv[i].apv02,
                                 apv03 = g_apv[i].apv03,
                                 apv04f= g_apv[i].apv04f,
                                 apv04 = g_apv[i].apv04,
                                 apv05 = g_apv[i].apv05      #No.FUN-680027
              WHERE apv01 = g_apa.apa01
                AND apv02 = g_apv_t.apv02
             IF STATUS OR SQLCA.SQLCODE THEN
                CALL cl_err3("upd","apv_file",g_apa.apa01,g_apv_t.apv02,SQLCA.sqlcode,"","upd apv:",1)  #No.FUN-660122
                LET g_success = 'N'
                LET g_apv[i].* = g_apv_t.*
                ELSE MESSAGE "update ok"
             END IF
             IF g_success = 'Y' AND g_apv[i].apv03 <> 'DIFF' THEN #No.MOD-580365
               #當修改了待抵編號,應將舊待抵編號的已沖金額扣回(參考刪除段),
               #                 再UPDATE新待抵編號的已沖金額
                IF g_apv_t.apv03 != g_apv[i].apv03 THEN
                   SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                     FROM aph_file,apf_file
                    WHERE aph04=g_apv_t.apv03 AND aph01=apf01 AND apf41='Y'
                      AND aph03 IN ('6','7','8','9')
                   IF g_amt1f IS NULL THEN
                      LET g_amt1f = 0
                      LET g_amt1 = 0
                   END IF
                   #No.MOD-C30061  --Begin #增加退款沖帳金額
                   SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
                     FROM apg_file,apf_file
                    WHERE apg04=g_apv_t.apv03 AND apg01=apf01 AND apf41='Y'
                     #AND apf00='32'                  #MOD-D70039
                      AND (apf00='32' OR apf00='36')  #MOD-D70039

                   IF g_amt6f IS NULL THEN
                      LET g_amt6f = 0
                      LET g_amt6 = 0
                   END IF
                   #No.MOD-C30061  --End
                   SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                     FROM apv_file Where apv03=g_apv_t.apv03
                   IF g_amt2f IS NULL THEN
                      LET g_amt2f = 0
                      LET g_amt2 = 0
                   END IF
                   SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                     FROM oob_file,ooa_file
                    WHERE oob01 = ooa01
                      AND oob06 = g_apv_t.apv03
                      AND oob03 = '2' AND oob04 = '9'
                      AND ooaconf = 'Y' #須為已確認
                   IF cl_null(g_amt3f) THEN
                      LET g_amt3f = 0
                      LET g_amt3 = 0
                   END IF
                   SELECT SUM(aqb04) INTO g_amt4 FROM aqa_file,aqb_file
                    WHERE aqa01 = aqb01 AND aqa04='Y' AND aqaconf = 'Y'
                      AND aqb02=g_apv_t.apv03
                   IF cl_null(g_amt4) THEN
                      LET g_amt4=0
                      LET g_amt4f=0
                   END IF
                   LET g_amt4f=g_amt4/g_apv[i].apa14
 
                   LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f+g_amt6f  #MOD-C30061 add g_amt6f
                   LET g_amt1 =g_amt1 +g_amt2 +g_amt3 +g_amt4+g_amt6    #MOD-C30061 add g_amt6
 
                   SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv_t.apv03
                   CALL t110_comp_oox(g_apv_t.apv03) RETURNING g_net
                   LET l_apa.apa73 = l_apa.apa34 - g_amt1 + g_net
                   UPDATE apa_file SET apa35f= g_amt1f,
                                       apa35 = g_amt1,
                                       apa73 = l_apa.apa73   #No.MOD-640537
                    WHERE apa01 = g_apv_t.apv03
                   IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
                      CALL cl_err3("upd","apa_file",g_apv_t.apv03,"",STATUS,"","upd apa:",1)
                      LET g_success='N'
                   END IF
                   SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                     FROM aph_file,apf_file
                    WHERE aph04=g_apv_t.apv03 AND aph01=apf01 AND apf41='Y'
                      AND aph03 IN ('6','7','8','9')
                      AND aph17 = 1                           #No.TQC-6B0066
                   IF g_amt1f IS NULL THEN
                      LET g_amt1f = 0
                      LET g_amt1 = 0
                   END IF
 
                   #No.MOD-C30061  --Begin #增加退款沖帳金額
                   SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
                     FROM apg_file,apf_file
                    WHERE apg04=g_apv_t.apv03 AND apg01=apf01 AND apf41='Y'
                      #AND apf00='32'                #MOD-D70039
                      AND apf00='32' OR apf00='36'   #MOD-D70039
                   IF g_amt6f IS NULL THEN
                      LET g_amt6f = 0
                      LET g_amt6 = 0
                   END IF
                   #No.MOD-C30061  --End
                  
                   
                   SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                     FROM apv_file WHERE apv03=g_apv_t.apv03
                   IF g_amt2f IS NULL THEN
                      LET g_amt2f = 0
                      LET g_amt2 = 0
                   END IF
 
                   SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                     FROM oob_file,ooa_file
                    WHERE oob01 = ooa01
                      AND oob06 = g_apv_t.apv03
                      AND oob03 = '2' AND oob04 = '9'
                      AND ooaconf = 'Y' #須為已確認
                      AND oob19 = 1                           #No.TQC-6B0066
                   IF cl_null(g_amt3f) THEN
                      LET g_amt3f = 0
                      LET g_amt3 = 0
                   END IF
                  #---------------------MOD-C70137----------------------(S)
                  #成本分攤
                   SELECT SUM(aqb04) INTO g_amt4
                     FROM aqa_file,aqb_file
                    WHERE aqa01 = aqb01
                      AND aqa04 ='Y'
                      AND aqaconf = 'Y'
                      AND aqb02 = g_apv[i].apv03
                   IF cl_null(g_amt4) THEN
                      LET g_amt4 = 0
                      LET g_amt4f = 0
                   END IF
                   LET g_amt4f = g_amt4/g_apv[i].apa14
                  #---------------------MOD-C70137----------------------(E)
 
                   LET g_amt1f = g_amt1f + g_amt2f + g_amt3f + g_amt6f + g_amt4f  #MOD-C30061 add g_amt6f    #TQC-C70079  add  g_amt4f
                   LET g_amt1 = g_amt1 + g_amt2 + g_amt3 + g_amt6 + g_amt4        #MOD-C30061 add g_amt6     #TQC-C70079  add  g_amt4
                   SELECT * INTO l_apc.* FROM apc_file
                    WHERE apc01=g_apv_t.apv03 AND apc02 =1
                   CALL t110_comp_oox(g_apv_t.apv03) RETURNING g_net
                   LET l_apc.apc13 = l_apc.apc09 - g_amt1 + g_net
                   UPDATE apc_file set apc10=g_amt1f,
                                       apc11=g_amt1,
                                       apc13=l_apc.apc13
                    WHERE apc01 =g_apv_t.apv03
                      AND apc02 =1
                END IF
 
                SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa65f,g_apa.apa65
                  FROM apv_file WHERE apv01=g_apa.apa01
 
                IF cl_null(g_apa.apa65f) THEN
                   LET g_apa.apa65f = 0
                END IF
 
                IF cl_null(g_apa.apa65 ) THEN
                   LET g_apa.apa65 = 0
                END IF
 
                DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
 
                UPDATE apa_file SET apa65f=g_apa.apa65f,apa65=g_apa.apa65
                 WHERE apa01 = g_apa.apa01
                IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
                   CALL cl_err3("upd","apa_file", g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                   LET g_success='N'
                   IF p_cmd = 'u' THEN
                      LET g_apv[i].*=g_apv_t.*
                   END IF
                 END IF
 
                SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                  FROM aph_file,apf_file
                 WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                   AND aph03 IN ('6','7','8','9')
 
                IF g_amt1f IS NULL THEN
                   LET g_amt1f = 0
                   LET g_amt1 = 0
                END IF
                #No.MOD-C30061  --Begin #增加退款沖帳金額
                SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
                  FROM apg_file,apf_file
                 WHERE apg04=g_apv[i].apv03 AND apg01=apf01 AND apf41='Y'
                   #AND apf00='32'                 #MOD-D70039
                   AND (apf00='32' OR apf00='36')  #MOD-D70039

                IF g_amt6f IS NULL THEN
                   LET g_amt6f = 0
                   LET g_amt6 = 0
                END IF
                #No.MOD-C30061  --End
 
                SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                  FROM apv_file Where apv03=g_apv[i].apv03
 
                IF g_amt2f IS NULL THEN
                   LET g_amt2f = 0
                   LET g_amt2 = 0
                END IF
 
                SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                  FROM oob_file,ooa_file
                 WHERE oob01 = ooa01
                   AND oob06 = g_apv[i].apv03
                   AND oob03 = '2' AND oob04 = '9'
                   AND ooaconf = 'Y' #須為已確認
 
                IF cl_null(g_amt3f) THEN
                   LET g_amt3f = 0
                   LET g_amt3 = 0
                END IF
 
                #成本分攤
                SELECT SUM(aqb04) INTO g_amt4 FROM aqa_file,aqb_file
                 WHERE aqa01 = aqb01 AND aqa04='Y' AND aqaconf = 'Y'
                   AND aqb02=g_apv[i].apv03
                IF cl_null(g_amt4) THEN
                   LET g_amt4=0
                   LET g_amt4f=0
                END IF
                LET g_amt4f=g_amt4/g_apv[i].apa14
 
                LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f+g_amt6f  #MOD-C30061 add g_amt6f
                LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt4+g_amt6        #MOD-C30061 add g_amt6
 
                SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
                CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
                LET l_apa.apa73 = l_apa.apa34 - g_amt1 + g_net
 
                UPDATE apa_file SET apa35f= g_amt1f,
                                    apa35 = g_amt1,
                                    #apa72 = g_apa.apa72, #No.MOD-580365
                                    apa73 = l_apa.apa73   #No.MOD-640537
                 WHERE apa01 = g_apv[i].apv03
                 IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
                    CALL cl_err3("upd","apa_file",g_apv[i].apv03,"",STATUS,"","upd apa:",1)
                    LET g_success='N'
                    IF p_cmd = 'u' THEN
                       LET g_apv[i].*=g_apv_t.*
                    END IF
                 END IF
               SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                 FROM aph_file,apf_file
                WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                  AND aph03 IN ('6','7','8','9')
                  AND aph17 = 1                           #No.TQC-6B0066
 
               IF g_amt1f IS NULL THEN
                  LET g_amt1f = 0
                  LET g_amt1 = 0
               END IF
               #No.MOD-C30061  --Begin #增加退款沖帳金額
               SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
                 FROM apg_file,apf_file
                WHERE apg04=g_apv[i].apv03 AND apg01=apf01 AND apf41='Y'
                  #AND apf00='32'                  #MOD-D70039
                  AND (apf00='32' OR apf00='36')   #MOD-D70039

               IF g_amt6f IS NULL THEN
                  LET g_amt6f = 0
                  LET g_amt6 = 0
               END IF
               #No.MOD-C30061  --End
 
               SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                 FROM apv_file Where apv03=g_apv[i].apv03
 
               IF g_amt2f IS NULL THEN
                  LET g_amt2f = 0
                  LET g_amt2 = 0
               END IF
 
               SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                 FROM oob_file,ooa_file
                WHERE oob01 = ooa01
                  AND oob06 = g_apv[i].apv03
                  AND oob03 = '2' AND oob04 = '9'
                  AND ooaconf = 'Y' #須為已確認
                  AND oob19 = 1                          #No.TQC-6B0066
 
               IF cl_null(g_amt3f) THEN
                  LET g_amt3f = 0
                  LET g_amt3 = 0
               END IF
               LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt6f+g_amt4f   #MOD-C30061 add g_amt6f    #TQC-C70079  add  g_amt4f
               LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt6+g_amt4         #MOD-C30061 add g_amt6     #TQC-C70079  add  g_amt4
               SELECT * INTO l_apc.* FROM apc_file WHERE apc01=g_apv[i].apv03 AND apc02 =1          #No.TQC-6B0066
               CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
               LET l_apc.apc13 = l_apc.apc09 - g_amt1 + g_net
               UPDATE apc_file set apc10=g_amt1f,
                                   apc11=g_amt1,
                                   apc13=l_apc.apc13
                WHERE apc01 =g_apv[i].apv03
                  AND apc02 =1                    #No.TQC-6B0066
                IF cl_null(g_apv_t.apv04) THEN
                   LET g_apv_t.apv04 = 0
                END IF
                IF cl_null(g_apv[i].apv04) THEN
                   LET g_apv[i].apv04 =0
                END IF
                SELECT SUM(apv04),SUM(apv04f) INTO l_apv04,l_apv04f FROM apv_file
                 WHERE apv03 =g_apv[i].apv03
                FOR j=1 TO g_apv.getLength()
                    IF g_apv[j].apv03 =g_apv[i].apv03 THEN
                       LET g_apv[j].un_pay  =g_apv[j].apc09 -l_apv04
                    END IF
                END FOR
                
                IF cl_null(g_apv_t.apv04f) THEN
                   LET g_apv_t.apv04f = 0
                END IF
                IF cl_null(g_apv[i].apv04f) THEN
                   LET g_apv[i].apv04f =0
                END IF
                FOR j=1 TO g_apv.getLength()
                    IF g_apv[j].apv03 =g_apv[i].apv03 THEN
                       LET g_apv[j].un_payf =g_apv[j].apc08-l_apv04f
                    END IF
                END FOR
            END IF
          END IF
 
      AFTER ROW
          LET l_ac = ARR_CURR()
          IF INT_FLAG THEN
             CALL cl_err('',9001,0)
             LET INT_FLAG = 0
             IF p_cmd = 'u' THEN
                LET g_apv[l_ac].* = g_apv_t.*
             #FUN-D30032--add--str--
             ELSE
                CALL g_apv.deleteElement(l_ac)
             #FUN-D30032--add--end--
             END IF
             CLOSE t110_loc2_cr
             LET g_success = 'N'
             EXIT INPUT
          END IF
          CLOSE t110_loc2_cr
 
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
     #計算匯差
     AFTER INPUT
        LET l_net = 0
       #CHI-A30035---mark---start---
       #DELETE FROM apv_file
       # WHERE apv01=g_apa.apa01
       #   AND apv03='DIFF'
       #IF SQLCA.sqlcode THEN
       #   CALL cl_err3("del","apv_file", g_apa.apa01,"",SQLCA.sqlcode,"","delete diff",1)  #No.FUN-660122
       #   NEXT FIELD apv04
       #END IF
       #CHI-A30035---mark---end---
        LET l_cnt = 0
        SELECT COUNT(*) INTO l_cnt FROM apv_file
          WHERE apv01=g_apa.apa01
        IF l_cnt > 0 THEN
           SELECT SUM(apv04f),SUM(apv04) INTO apv04f_sum,apv04_sum FROM apv_file
             WHERE apv01 = g_apa.apa01
           IF cl_null(apv04f_sum) THEN LET apv04f_sum = 0 END IF
           IF cl_null(apv04_sum) THEN LET apv04_sum = 0 END IF
           IF apv04f_sum = g_apa.apa34f THEN                                    
              LET l_net = g_apa.apa34-apv04_sum                                 
           END IF                                                               
        END IF
       #-MOD-A80217-mark-
       #IF l_net <> 0 THEN
       #    SELECT MAX(apv02)+1 INTO l_apv02 FROM apv_file
       #     WHERE apv01 = g_apa.apa01
       #    IF cl_null(l_apv02)  THEN
       #       LET l_apv02 = 1
       #    END IF
       #    INSERT INTO apv_file(apv01,apv02,apv03,apv04f,apv04,apvlegal) #FUN-980001 add apvlegal
       #    VALUES(g_apa.apa01,l_apv02,'DIFF',0,l_net,g_legal) #FUN-980001 add g_legal
       #    IF SQLCA.sqlcode THEN
       #       CALL cl_err3("ins","apv_file",g_apa.apa01,l_apv02,SQLCA.sqlcode,"","insert diff",1)  #No.FUN-660122
       #       NEXT FIELD apv04
       #    END IF
       # END IF
       #-MOD-A80217-end-
  
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
 
   END INPUT
 
   IF INT_FLAG THEN
      LET g_success='N'
      LET INT_FLAG = 0
   END IF
 
   IF g_success = 'Y' THEN
      COMMIT WORK
      MESSAGE "Commit"
   ELSE
      ROLLBACK WORK
      MESSAGE "RollBack"
   END IF
 
   CALL t110_apv_diff()    #MOD-A80217
   SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa65f,g_apa.apa65
     FROM apv_file WHERE apv01=g_apa.apa01
 
   IF cl_null(g_apa.apa65f) THEN
      LET g_apa.apa65f = 0
   END IF
 
   IF cl_null(g_apa.apa65 ) THEN
      LET g_apa.apa65 = 0
   END IF
 
   DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
 
   UPDATE apa_file SET apa65f=g_apa.apa65f,apa65=g_apa.apa65
    WHERE apa01 = g_apa.apa01
 
   IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
      CALL cl_err3("upd","apa_file", g_apa.apa01,"",SQLCA.sqlcode,"","upd apa65:",1)  #No.FUN-660122
      LET g_success='N'   #MOD-730098
   END IF
 
   CLOSE WINDOW t110_kkk_w
 
   DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
   CLOSE t110_loc_cr
   CLOSE t110_loc2_cr
 
   IF l_lock_sw = 'Y' THEN
      RETURN
   END IF
 
   CALL t110_apa34f('0')    #TQC-750140
 
   LET g_apa.apa72 = g_apa.apa14
   CALL t110_comp_oox(g_apa.apa01) RETURNING g_net       #CHI-890017 add
   LET g_apa.apa73 = g_apa.apa34 - g_apa.apa35 + g_net   #CHI-890017
 
   UPDATE apa_file set * = g_apa.* WHERE apa01 = g_apa.apa01
   IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
      CALL cl_err3("upd","apa_file", g_apa.apa01,"",STATUS,"","upd apa",1)
      LET g_success='N'
   END IF
   IF g_apa.apa31 <>g_apa_t.apa31 OR g_apa.apa32 <> g_apa_t.apa32
      OR g_apa.apa34 <> g_apa_t.apa34 OR g_apa.apa57 <> g_apa_t.apa57
      OR g_apa.apa57 <> g_apa_t.apa57 OR g_apa.apa73 <> g_apa_t.apa73
      OR g_apa.apa31f <> g_apa_t.apa31f OR g_apa.apa32f <> g_apa_t.apa32f
      OR g_apa.apa34f <> g_apa_t.apa34f OR g_apa.apa57f <> g_apa_t.apa57f THEN
     SELECT DISTINCT(pmb02) INTO l_pmb02 FROM pmb_file
      WHERE pmb01 = g_apa.apa11
     IF l_pmb02 = 1 OR cl_null(l_pmb02) THEN   #MOD-810156
        DELETE FROM apc_file WHERE apc01 = g_apa.apa01
        CALL t110_ins_apc(g_apa.*)
     ELSE
        IF g_apa.apa35 <> g_apa_t.apa35 OR g_apa.apa35f <> g_apa_t.apa35f THEN
           LET g_sn = 'y'
        END IF
        CALL t110_account_period()
        LET g_sn = 'n'
     END IF
    END IF
 
   CALL t110_up_gl()
   CALL t110_unpay()
 
   DELETE FROM apv_file WHERE apv01 = g_apa.apa01 AND apv04 = 0 AND apv04f =0    #No.TQC-950113
 
   CALL t110_diff_rtn('0') ##TQC-750140
  #CALL t110_api_diff()    #No.TQC-7B0083  #MOD-C60107 mark
 
END FUNCTION
 
#-MOD-A80217-add-
FUNCTION t110_apv_diff()
   DEFINE l_net            LIKE apv_file.apv04
   DEFINE l_i              LIKE type_file.num5    
   DEFINE l_j              LIKE type_file.num5    
   DEFINE l_apa14          LIKE apa_file.apa14
   DEFINE l_amt            LIKE type_file.num20_6  
   DEFINE l_cnt            LIKE type_file.num5    
   DEFINE l_apv02          LIKE apv_file.apv02
   DEFINE l_apv03          LIKE apv_file.apv03
   DEFINE l_apv04f         LIKE apv_file.apv04f
   DEFINE l_apv04          LIKE apv_file.apv04
   DEFINE l_apv04f_sum     LIKE apv_file.apv04f   
   DEFINE l_apv04_sum      LIKE apv_file.apv04  
   DEFINE l_sql            STRING      

   LET l_net = 0
   LET  l_sql = "SELECT apv03,apv04f,apv04 ",     
                "  FROM apv_file",                                 
                " WHERE apv01 = '",g_apa.apa01,"' ",
                "   AND apv03 <> 'DIFF'" 
   PREPARE t110_apv_p FROM l_sql
   DECLARE t110_apv_c CURSOR FOR t110_apv_p
   FOREACH t110_apv_c INTO l_apv03,l_apv04f,l_apv04     #計算部分沖帳(與立帳原幣金額不同)時的匯差
       SELECT apa14 INTO l_apa14 FROM apa_file
        WHERE apa01=l_apv03
       IF l_apa14 <> g_apa.apa14 THEN
          LET l_amt=cl_digcut(l_apv04f*g_apa.apa14,g_azi04)-l_apv04
          IF cl_null(l_amt) THEN LET l_amt=0 END IF
          LET l_net = l_net + l_amt
          LET l_net = cl_digcut(l_net,g_azi04)
       END IF
   END FOREACH
   LET l_cnt = 0
   SELECT COUNT(*) INTO l_cnt FROM apv_file WHERE apv01=g_apa.apa01
   IF l_cnt > 0 THEN
      SELECT SUM(apv04f),SUM(apv04) INTO l_apv04f_sum,l_apv04_sum
        FROM apv_file WHERE apv01 = g_apa.apa01
      IF cl_null(l_apv04f_sum) THEN LET l_apv04f_sum = 0 END IF
      IF cl_null(l_apv04_sum)  THEN LET l_apv04_sum = 0 END IF
      IF l_apv04f_sum = g_apa.apa31f THEN     #計算全額沖帳(與立帳原幣金額相同)時的匯差
         LET l_net = g_apa.apa31-l_apv04_sum
      END IF
     #str MOD-B70180 add
      IF l_apv04f_sum = g_apa.apa31f+g_apa.apa32f THEN  #計算含稅全額沖帳(與立帳原幣金額相同)時的匯差
         LET l_net = (g_apa.apa31+g_apa.apa32)-l_apv04_sum
      END IF
     #end MOD-B70180 add
   END IF
   IF l_net <> 0 THEN
      DELETE FROM apv_file WHERE apv01=g_apa.apa01 AND apv03='DIFF'  #無論是否有資料一律刪除,不用提示錯誤
      SELECT MAX(apv02)+1 INTO l_apv02 FROM apv_file
       WHERE apv01 = g_apa.apa01
      IF cl_null(l_apv02)  THEN
         LET l_apv02 = 1
      END IF
      INSERT INTO apv_file (apv01,apv02,apv03,apv04f,apv04,apvlegal)     #MOD-B70180 add apvlegal
                    VALUES (g_apa.apa01,l_apv02,'DIFF',0,l_net,g_legal)  #MOD-B70180 add g_legal  
      IF SQLCA.sqlcode THEN
         CALL cl_err3("ins","apv_file",g_apa.apa01,l_apv02,SQLCA.sqlcode,"","insert diff",1)
      END IF
      SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa65f,g_apa.apa65
        FROM apv_file WHERE apv01=g_apa.apa01
      IF cl_null(g_apa.apa65f) THEN
         LET g_apa.apa65f = 0
      END IF
      IF cl_null(g_apa.apa65 ) THEN
         LET g_apa.apa65 = 0
      END IF
      DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
   END IF
END FUNCTION
#-MOD-A80217-end-

FUNCTION t110_k2()
   DEFINE l_totf,l_amtf   LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_tot,l_amt     LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_apv04       LIKE apv_file.apv04  #FUN-4B0079
   DEFINE cnt1,cnt2     LIKE type_file.num5      # No.FUN-690028 SMALLINT
   DEFINE i,j,k          LIKE type_file.num5    #No.FUN-690028 SMALLINT
   DEFINE l_sql     STRING   #MOD-720062
   DEFINE p_cmd     LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE g_apv     DYNAMIC ARRAY OF RECORD
                    apv02     LIKE apv_file.apv02,
                    apv03     LIKE apv_file.apv03,
                    apa07     LIKE apa_file.apa07,
                    apv05     LIKE apv_file.apv05,         #No.FUN-680027
                    apa08     LIKE apa_file.apa08,
                    apa14     LIKE apa_file.apa14,
                    apc08     LIKE apc_file.apc08,
                    apc09     LIKE apc_file.apc09,
                    un_payf   LIKE apv_file.apv04,
                    un_pay    LIKE apv_file.apv04,
                    apv04f    LIKE apv_file.apv04,
                    apv04     LIKE apv_file.apv04
                    END RECORD
   DEFINE g_apv_t   RECORD
                    apv02     LIKE apv_file.apv02,
                    apv03     LIKE apv_file.apv03,
                    apa07     LIKE apa_file.apa07,
                    apv05     LIKE apv_file.apv05,         #No.FUN-680027
                    apa08     LIKE apa_file.apa08,
                    apa14     LIKE apa_file.apa14,
                    apc08     LIKE apc_file.apc08,
                    apc09     LIKE apc_file.apc09,
                    un_payf   LIKE apv_file.apv04,
                    un_pay    LIKE apv_file.apv04,
                    apv04f    LIKE apv_file.apv04,
                    apv04     LIKE apv_file.apv04
                    END RECORD
   DEFINE m_apa     DYNAMIC ARRAY OF RECORD
                    apa13     LIKE apa_file.apa13,
                    apa72     LIKE apa_file.apa72,
                    apa73     LIKE apa_file.apa73
                    END RECORD
   DEFINE m_apa_t   RECORD
                    apa13     LIKE apa_file.apa13,
                    apa72     LIKE apa_file.apa72,
                    apa73     LIKE apa_file.apa73
                    END RECORD
   DEFINE m_apa34f  LIKE apa_file.apa34f
   DEFINE m_apa34   LIKE apa_file.apa34    #No.MOD-590312
   DEFINE m_apa73   LIKE apa_file.apa73
   DEFINE m_amt     LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)
   DEFINE l_apa     RECORD LIKE apa_file.*
   DEFINE l_net     LIKE apv_file.apv04
   DEFINE l_apa14   LIKE apa_file.apa14
   DEFINE l_apv02   LIKE apv_file.apv02
   DEFINE l_i       LIKE type_file.num5    #No.FUN-690028 SMALLINT
   DEFINE l_apa13   LIKE apa_file.apa13
   DEFINE l_apa41   LIKE apa_file.apa41
   DEFINE l_apv04f  LIKE apv_file.apv04f
   DEFINE l_apa35f,l_apa35 LIKE apa_file.apa35
   DEFINE l_difff,l_diff   LIKE apa_file.apa34
   DEFINE l_sumf,l_sum     LIKE apa_file.apa34
   DEFINE l_sumf_h,l_sum_h LIKE apa_file.apa34
   DEFINE l_total   LIKE apa_file.apa34
   DEFINE l_lock_sw       LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_modify_flag   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_k,l_over      LIKE type_file.num5,      # No.FUN-690028 SMALLINT,
   g_t1            LIKE oay_file.oayslip,  #No.FUN-690028 VARCHAR(5)
   l_allow_insert  LIKE type_file.num5,                #可新增否  #No.FUN-690028 SMALLINT
   l_allow_delete  LIKE type_file.num5                 #可刪除否  #No.FUN-690028 SMALLINT
   DEFINE ls_rec_b        LIKE type_file.num10      # No.FUN-690028 INTEGER
   DEFINE l_apa06  LIKE apa_file.apa06   #MOD-580079
   DEFINE l_apc     RECORD LIKE apc_file.*   #No.FUN-680027
   DEFINE m_apc09   LIKE apc_file.apc09    #No.FUN-680027
   DEFINE l_apc02  LIKE apc_file.apc02  
   DEFINE l_apc10  LIKE apc_file.apc10  
   DEFINE l_apc11  LIKE apc_file.apc11  
 
    SELECT * INTO g_apa.* FROM apa_file
     WHERE apa01=g_apa.apa01
 
   LET g_t1 = s_get_doc_no(g_apa.apa01)
   SELECT apydmy6 INTO g_apy.apydmy6 FROM apy_file WHERE apyslip = g_t1
   IF g_aza.aza26 != '2' OR g_aptype[1,1]!='2' OR g_apy.apydmy6!='Y' THEN
      RETURN
   END IF
   IF g_apa.apa41 = 'Y' THEN
      CALL cl_err(g_apa.apa01,'aap-005',0)
      RETURN
   END IF
   IF g_apa.apa63 MATCHES '[1]' THEN      #FUN-8A0075
      CALL cl_err('','mfg3557',0)
      RETURN
   END IF
 
   LET g_success='Y'
   LET g_apa_t.* = g_apa.*
   BEGIN WORK
   CALL t110_lock_cl()  #FUN-C80078 add
   OPEN t110_cl USING g_apa.apa01
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl k:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF
   FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
       CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
       CLOSE t110_cl
       ROLLBACK WORK
       RETURN
   END IF
 
   OPEN WINDOW t110_kkk_w AT 12,2 WITH FORM "aap/42f/aapt110_e"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No.FUN-580092 HCN
 
   CALL cl_ui_locale("aapt110_e")
 
   CALL cl_getmsg('aap-909',g_lang) RETURNING g_msg
   CALL cl_set_comp_att_text("apv03",g_msg CLIPPED)
   CALL cl_getmsg('aap-910',g_lang) RETURNING g_msg
   CALL cl_set_comp_att_text("apv04f",g_msg CLIPPED)
   CALL cl_getmsg('aap-911',g_lang) RETURNING g_msg
   CALL cl_set_comp_att_text("apv04",g_msg CLIPPED)
 
   SELECT COUNT(*) INTO cnt1 FROM apv_file WHERE apv01 = g_apa.apa01
 
   IF cnt1 = 0 THEN   
      LET  l_sql = "SELECT apc01,apc02,apa07,apa08,apc06, ",          #No.TQC-6B0066
                   "       apc08,(apc08-apc10),0, ",                  #No.FUN-680027
                   "       apc09,(apc09-apc11),0,apa13,apc07,apc13 ", #No.FUN-680027
                   "  FROM apa_file,apc_file",                        #No,FUN-680027
                   " WHERE apa06= '",g_apa.apa06,"' AND apa07= '",g_apa.apa07,"' ",
                   "   AND apa00 LIKE '1%' ",
                   "   AND apa13 = '",g_apa.apa13,"' ",       # 幣別必須相同
                   "   AND apa08 != '",g_apa.apa01,"' ",      # 不可衝自已產生的預付
                   "   AND apa41 = 'Y' AND apa42 != 'Y' ",
                   "   AND (apa58 = '2' OR apa58 ='3' OR apa58 IS NULL) ",
                   "   AND apc01 =apa01"
      IF g_apz.apz27 = 'N' THEN
         LET l_sql = l_sql CLIPPED, " AND apa34 > apa35 "
      ELSE
         LET l_sql = l_sql CLIPPED, " AND apa73 > 0 "
      END IF
      PREPARE t110_p2_c0 FROM l_sql
      DECLARE t110_k2_c0 CURSOR FOR t110_p2_c0
 
      CALL g_apv.clear()
      LET i = 1
 
      FOREACH t110_k2_c0 INTO g_apv[i].apv03,g_apv[i].apv05,g_apv[i].apa07,g_apv[i].apa08,     #No.TQC-6B0066
                              g_apv[i].apa14,g_apv[i].apc08,    #No.FUN-680027
                              g_apv[i].un_payf,g_apv[i].apv04f,
                              g_apv[i].apc09,g_apv[i].un_pay,g_apv[i].apv04,    #No.FUN-680027
                              m_apa[i].apa13,m_apa[i].apa72,m_apa[i].apa73
 
         IF g_apz.apz27 = 'Y' AND m_apa[i].apa13 !=g_aza.aza17 THEN
             LET g_apv[i].un_pay = m_apa[i].apa73
             LET g_apv[i].apa14  = m_apa[i].apa72
         END IF
         IF cl_null(g_apv[i].apv03) THEN
            EXIT FOREACH
         END IF
 
         LET g_apv[i].apv02 = i
 
         INSERT INTO apv_file(apv01,apv02,apv03,apv04f,apv04,apv05,apvlegal)     #No.FUN-680027 #FUN-980001 add apvlegal
           VALUES (g_apa.apa01,i,g_apv[i].apv03,0,0,g_apv[i].apv05,g_legal)     #No.FUN-680027 #FUN-980001 add g_legal
 
         LET i = i + 1
         IF i > g_max_rec THEN     #No.MOD-480131
            EXIT FOREACH
         END IF
      END FOREACH
      CALL g_apv.deleteElement(i)
      LET ls_rec_b = i - 1
   END IF
 
   IF cnt1 > 0 THEN
      DECLARE t110_k2_c CURSOR FOR
         SELECT apv02,apv03,apa07,apv05,apa08,apc06,   #No.FUN-680027       TQC-6B0066
            apc08+apv04f,apc09+apv04,(apc08+apv04f-apc10),(apc09+apv04-apc11 ),apv04f,apv04  #No.FUN-680027
            apa13,apc07,apc13  #No.MOD-580365
           FROM apv_file LEFT OUTER JOIN apa_file ON apa01 =apv03 LEFT OUTER JOIN apc_file ON apc01 = apa01  #No.FUN-680027
          WHERE apv01 = g_apa.apa01 
          ORDER BY apv02
 
      CALL g_apv.clear()
      LET k = 1
      LET g_apa.apa35f = 0
      LET g_apa.apa35 = 0
 
      FOREACH t110_k2_c INTO g_apv[k].*,m_apa[k].* #No.MOD-580365
         LET g_apa.apa35f = g_apa.apa35f + g_apv[k].apv04f
         LET g_apa.apa35  = g_apa.apa35  + g_apv[k].apv04
         LET k = k + 1
          IF k > g_max_rec THEN         #No.MOD-480131
            EXIT FOREACH
         END IF
      END FOREACH
      CALL g_apv.deleteElement(k)
      LET ls_rec_b = k - 1
   END IF
 
   LET l_sumf_h = g_apa.apa35f
   LET l_sum_h  = g_apa.apa35
   DISPLAY l_sumf_h TO apa65f
   DISPLAY l_sum_h  TO apa65
 
   LET l_allow_insert = cl_detail_input_auth("insert")
   LET l_allow_delete = cl_detail_input_auth("delete")
 
   LET i = 1
   INPUT ARRAY g_apv WITHOUT DEFAULTS FROM s_apv.*
         ATTRIBUTE(COUNT=ls_rec_b,MAXCOUNT=g_max_rec,UNBUFFERED,
                   INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)
 
      BEFORE INSERT
         LET i = ARR_CURR()
         LET p_cmd='a'
         INITIALIZE g_apv[i].* TO NULL
         LET g_apv_t.* = g_apv[i].*
         NEXT FIELD apv02
 
      AFTER INSERT
         IF INT_FLAG THEN
            CALL cl_err('',9001,0)
            LET INT_FLAG = 0
            CANCEL INSERT
         END IF
         IF g_apv[i].apv03 IS NULL THEN
            CALL g_apv.deleteElement(i)
            NEXT FIELD apv02
            CANCEL INSERT
         END IF
         INSERT INTO apv_file(apv01,apv02,apv03,apv04f,apv04,apv05,apvlegal)     #No.FUN-680027 #FUN-980001 add apvlegal
          VALUES(g_apa.apa01,g_apv[i].apv02,g_apv[i].apv03,
                 g_apv[i].apv04f,g_apv[i].apv04,g_apv[i].apv05,g_legal)         #No.FUN-680027 #FUN-980001 add g_legal
         IF SQLCA.sqlcode THEN
            CALL cl_err3("ins","apv_file",g_apa.apa01,g_apv[i].apv02,SQLCA.sqlcode,"","ins apv:",1)  #No.FUN-660122
            LET g_success = 'N'
            CANCEL INSERT
         ELSE
            LET ls_rec_b = ls_rec_b + 1
            MESSAGE "insert ok"
            IF g_success = 'Y' THEN
               SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa35f,g_apa.apa35
                 FROM apv_file WHERE apv01=g_apa.apa01
 
               IF cl_null(g_apa.apa35f) THEN
                  LET g_apa.apa35f = 0
               END IF
 
               IF cl_null(g_apa.apa35 ) THEN
                  LET g_apa.apa35 = 0
               END IF
 
               DISPLAY g_apa.apa35f TO apa65f
               DISPLAY g_apa.apa35  TO apa65
 
               CALL t110_comp_oox(g_apa.apa01) RETURNING g_net      #CHI-890017 add
               UPDATE apa_file SET apa35f=g_apa.apa35f,
                                   apa35 =g_apa.apa35
                                  ,apa73 =apa34-g_apa.apa35+g_net   #CHI-890017 add
                WHERE apa01 = g_apa.apa01
               IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
                  CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                  LET g_success='N'
                  IF p_cmd = 'u' THEN
                     LET g_apv[i].*=g_apv_t.*
                  END IF
               ELSE
                  CALL t110_comp_oox1(g_apv[i].apv03,g_apv[i].apv05) RETURNING g_net  #MOD-940090      
                  UPDATE apc_file SET apc08=apc08-g_apv[i].apv04f,
                                      apc09=apc09-g_apv[i].apv04,
                                      apc13 =apc09-g_apv[i].apv04 - apc11 +g_net,   #MOD-940090
                                      apc14=apc14+g_apv[i].apv04f,
                                      apc15=apc15+g_apv[i].apv04
                   WHERE apc01 =g_apv[i].apv03
                     AND apc02 =g_apv[i].apv05
                    IF STATUS OR SQLCA.SQLCODE THEN
                       CALL cl_err3("upd","apcfile", g_apa.apa01,g_apv[i].apv05,SQLCA.sqlcode,"","",1)  
                       LET g_success='N'
                       IF p_cmd = 'u' THEN
                          LET g_apv[i].*=g_apv_t.*
                       END IF
                    END IF
               END IF
 
               SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                 FROM aph_file,apf_file
                WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                  AND aph03 IN ('6','7','8','9')
 
               IF g_amt1f IS NULL THEN
                  LET g_amt1f = 0
                  LET g_amt1 = 0
               END IF
               #No.MOD-C30061  --Begin #增加退款沖帳金額
               SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
                 FROM apg_file,apf_file
                WHERE apg04=g_apv[i].apv03 AND apg01=apf01 AND apf41='Y'
                  #AND apf00='32'                  #MOD-D70039
                  AND (apf00='32' OR apf00='36')   #MOD-D70039

               IF g_amt6f IS NULL THEN
                  LET g_amt6f = 0
                  LET g_amt6 = 0
               END IF
               #No.MOD-C30061  --End
 
               SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                 FROM apv_file Where apv03=g_apv[i].apv03
 
               IF g_amt2f IS NULL THEN
                  LET g_amt2f = 0
                  LET g_amt2 = 0
               END IF
 
               SELECT SUM(apv04f),SUM(apv04) INTO g_amt5f,g_amt5
                 FROM apv_file Where apv01=g_apv[i].apv03
 
               IF g_amt5f IS NULL THEN
                  LET g_amt5f = 0
                  LET g_amt5 = 0
               END IF
 
               SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                 FROM oob_file,ooa_file
                WHERE oob01 = ooa01
                  AND oob06 = g_apv[i].apv03
                  AND oob03 = '2' AND oob04 = '9'
                  AND ooaconf = 'Y' #須為已確認
 
               IF cl_null(g_amt3f) THEN
                  LET g_amt3f = 0
                  LET g_amt3 = 0
               END IF
 
               LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt5f+g_amt6f     #MOD-C30061 add g_amt6f
               LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt5+g_amt6           #MOD-C30061 add g_amt6
 
               SELECT * INTO l_apa.* FROM apa_file
                WHERE apa01 = g_apv[i].apv03
               LET l_apa.apa34 = l_apa.apa31 + l_apa.apa32 - g_amt1
               LET l_apa.apa34f= l_apa.apa31f+ l_apa.apa32f- g_amt1f
               CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
               SELECT apa34 INTO m_apa34 FROM apa_file
                WHERE apa01 = g_apv[i].apv03
               LET g_apa.apa73 = m_apa34 - g_amt1 + g_net
               UPDATE apa_file SET apa65f= g_amt1f,
                                   apa65 = g_amt1,
                                   apa34 = l_apa.apa34,
                                   apa34f= l_apa.apa34f,
                                   apa73 = g_apa.apa73
                WHERE apa01 = g_apv[i].apv03
               IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
                  CALL cl_err3("upd","apa_file",g_apv[i].apv03,"",STATUS,"","upd apa:",1)
                  LET g_success='N'
                  IF p_cmd = 'u' THEN
                     LET g_apv[i].*=g_apv_t.*
                  END IF
               END IF
               SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                 FROM aph_file,apf_file
                WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                  AND aph03 IN ('6','7','8','9')
                  AND aph17 = 1                          #No.TQC-6B0066 
               IF g_amt1f IS NULL THEN
                  LET g_amt1f = 0
                  LET g_amt1 = 0
               END IF
               #No.MOD-C30061  --Begin #增加退款沖帳金額
               SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
                 FROM apg_file,apf_file
                WHERE apg04=g_apv[i].apv03 AND apg01=apf01 AND apf41='Y'
                  #AND apf00='32'                  #MOD-D70039
                  AND (apf00='32' OR apf00='36')   #MOD-D70039
               IF g_amt6f IS NULL THEN
                  LET g_amt6f = 0
                  LET g_amt6 = 0
               END IF
               #No.MOD-C30061  --End
 
               SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                 FROM apv_file Where apv03=g_apv[i].apv03
                                 AND apv05=g_apv[i].apv05   #No.TQC-6B0066 
               IF g_amt2f IS NULL THEN
                  LET g_amt2f = 0
                  LET g_amt2 = 0
               END IF
 
               SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                 FROM oob_file,ooa_file
                WHERE oob01 = ooa01
                  AND oob06 = g_apv[i].apv03
                  AND oob03 = '2' AND oob04 = '9'
                  AND ooaconf = 'Y' #須為已確認
                  AND oob19 = 1                          #No.TQC-6B0066
               IF cl_null(g_amt3f) THEN
                  LET g_amt3f = 0
                  LET g_amt3 = 0
               END IF
 
               LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt6f+g_amt4f     #MOD-C30061 add g_amt6f     #TQC-C70079  add  g_amt4f
               LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt6+g_amt4           #MOD-C30061 add g_amt6      #TQC-C70079  add  g_amt4
               SELECT * INTO l_apc.* FROM apc_file WHERE apc01=g_apv[i].apv03 AND apc02 =1        #No.TQC-6B0066
               LET l_apc.apc09 = l_apc.apc09 - g_amt1
               LET l_apc.apc08 = l_apc.apc08 - g_amt1f
               CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
               SELECT apc09 INTO m_apc09 FROM apc_file
                WHERE apc01 = g_apv[i].apv03
                  AND apc02 = 1                   #No.TQC-6B0066
               LET l_apc.apc13 = m_apc09 - g_amt1 + g_net
               UPDATE apc_file SET apc14 = g_amt1f,
                                   apc15 = g_amt1,
                                   apc09 = l_apc.apc09,
                                   apc08 = l_apc.apc08,
                                   apc13 = l_apc.apc13
                WHERE apc01 =g_apv[i].apv03
                  AND apc02 =1                    #No.TQC-6B0066
 
            END IF
         END IF
 
      BEFORE INPUT
         IF ls_rec_b != 0 THEN
            CALL fgl_set_arr_curr(i)
         END IF
         LET g_before_input_done = FALSE
         CALL t110_set_entry_apv('a')
         CALL t110_set_no_entry_apv('a')
         LET g_before_input_done = TRUE
 
      BEFORE ROW
         LET p_cmd = ''
         LET i = ARR_CURR()
         LET l_lock_sw = 'N'
         IF ls_rec_b >= i THEN
            LET p_cmd='u'
            LET g_apv_t.* = g_apv[i].*
            #-->鎖住待抵沖帳資料
            IF g_apv_t.apv03 <> 'DIFF' THEN
              #MOD-A30008---modify---start---
              #LET g_forupd_sql = "SELECT apa07,apa08,apc06,apc08,(apc08-apc10),",        #No.FUN-680027
              #                   "       apc09,(apc09-apc11),apa13,apc07,apc13",
              #                   "  FROM apa_file,apc_file ",      #No.MOD-780028
              #                   " WHERE apa01 =apc01 ",          #No.FUN-680027
              #                   "   AND apa01=? FOR UPDATE"      #No.FUN-680027
               LET g_forupd_sql = "SELECT '','',apc06,apc08,(apc08-apc10),",       
                                  "       apc09,(apc09-apc11),'',apc07,apc13",
                                  "  FROM apc_file ",     
                                  " WHERE apa01=? FOR UPDATE"
               LET g_forupd_sql = cl_forupd_sql(g_forupd_sql)
               DECLARE t110_k2_cr CURSOR FROM g_forupd_sql
               #MOD-A30008---modify---end---
               OPEN t110_k2_cr USING g_apv_t.apv03
               IF STATUS THEN
                  CALL cl_err("OPEN t110_k2_cr:", STATUS, 1)
                  LET l_lock_sw = "Y"
               END IF
 
               FETCH t110_k2_cr INTO g_apv[i].apa07,g_apv[i].apa08,g_apv[i].apa14,
                                      g_apv[i].apc08,g_apv[i].un_payf,   #No.FUN-680027
                                      g_apv[i].apc09,g_apv[i].un_pay,   #No.FUN-680027
                                      m_apa[i].*  #No.MOD-580365
               IF SQLCA.sqlcode THEN
                  CALL cl_err(g_apv_t.apv02,SQLCA.sqlcode,1)
                  LET l_lock_sw = "Y"
              #MOD-A30008---add---start---
               ELSE
                  SELECT apa07,apa08,apa13 INTO g_apv[i].apa07,g_apv[i].apa08,m_apa[i].apa13
                  FROM apa_file
                  WHERE apa01=g_apv_t.apv03
              #MOD-A30008---add---end---
               END IF
               LET g_apv[i].apc08 = g_apv[i].apc08 + g_apv[i].apv04f      #No.FUN-680027
               LET g_apv[i].apc09 = g_apv[i].apc09 + g_apv[i].apv04       #No.FUN-680027
               LET g_apv[i].un_payf = g_apv[i].un_payf + g_apv[i].apv04f
               LET g_apv[i].un_pay  = g_apv[i].un_pay  + g_apv[i].apv04
               IF g_apz.apz27 = 'Y' AND g_aza.aza17 ! = m_apa[i].apa13 THEN
                  LET g_apv[i].un_pay = g_apv[i].apv04 + m_apa[i].apa73
                  LET g_apv[i].apa14  = m_apa[i].apa72
               END IF
            END IF
            CALL cl_show_fld_cont()     #FUN-550037(smin)
         END IF
         CALL t110_set_entry_apv(p_cmd)
         CALL t110_set_no_entry_apv(p_cmd)
 
      BEFORE FIELD apv02
         IF cl_null(g_apv[i].apv02) OR g_apv[i].apv02 = 0 THEN
            SELECT MAX(apv02)+1 INTO g_apv[i].apv02 FROM apv_file
             WHERE apv01 = g_apa.apa01
            IF cl_null(g_apv[i].apv02)  THEN
               LET g_apv[i].apv02 = 1
            END IF
            LET g_apv[i].apv04f= 0
            LET g_apv[i].apv04 = 0
         END IF
          CALL t110_set_entry_apv(p_cmd)  #MOD-4A0288
 
      AFTER FIELD apv02
         IF g_apv_t.apv02 IS NULL OR
            g_apv_t.apv02 != g_apv[i].apv02 THEN
            SELECT COUNT(*) INTO k FROM apv_file
                WHERE apv01 = g_apa.apa01 AND apv02 = g_apv[i].apv02
            IF k > 0 THEN
               CALL cl_err('',-239,0)
               NEXT FIELD apv02
            END IF
         END IF
          CALL t110_set_no_entry_apv(p_cmd)  #MOD-4A0288
 
 
      AFTER FIELD apv03
         IF NOT cl_null(g_apv[i].apv03) AND g_apv[i].apv03 <> 'DIFF' THEN
            CALL t110_set_entry_apv('F')
#No.TQC-6B0066--begin(原先apv05表示待扺帳款的子帳期，所以把判斷移到apv05之后，
#                     現在apv05表示本單據的子帳期，因此判斷放回apv03)
           #MOD-A30008---modify---start---
           #LET g_forupd_sql = "SELECT apa07,apc12,apa13,apc06,apc08,",
           #                   "       (apc08-apc10),apc09,(apc09-apc11),",
           #                   "       apa41,apa13,apc07,apc13 FROM apa_file,apc_file",   #TQC-7C0039
           #                   " WHERE apa01 = ? AND apa00 MATCHES '2*'",
           #                   "   AND (apa58='2' OR apa58='3' OR apa58 IS NULL)",
           #                   "   AND apc01=apa01 AND apc02 ='1'",
           #                   "   AND apa41 = 'Y' AND apa42 != 'Y' FOR UPDATE"
            LET g_forupd_sql = "SELECT '',apc12,'',apc06,apc02,apc08,",              #TQC-C50254 add apc02
                               "       (apc08-apc10),apc09,(apc09-apc11),",
                               "       '','',apc07,apc13 FROM apc_file",   
                               " WHERE apc01 = ? AND apc02='1' FOR UPDATE "
            LET g_forupd_sql = cl_forupd_sql(g_forupd_sql)
            DECLARE t110_k22_cr CURSOR FROM g_forupd_sql
            #MOD-A30008---modify---end---
            OPEN t110_k22_cr USING g_apv[i].apv03
            IF STATUS THEN
               CALL cl_err("OPEN t110_k22_cr:", STATUS, 1)   #TQC-7C0039
               CLOSE t110_loc2_cr
               ROLLBACK WORK
               RETURN
            END IF
 
            FETCH t110_k22_cr INTO g_apv[i].apa07,g_apv[i].apa08,l_apa13,
                                    g_apv[i].apa14,g_apv[i].apv05,g_apv[i].apc08,l_amtf,     #No.FUN-680027  #TQC-C50254 add apc02
                                    g_apv[i].apc09,l_amt,l_apa41,             #No.FUN-680027
                                    m_apa[i].apa13,m_apa[i].apa72,m_apa[i].apa73 #No.MOD-580365
            IF SQLCA.sqlcode THEN
               CALL cl_err(g_apv[i].apv03,SQLCA.sqlcode,0)
               LET g_apv[i].apv03 = g_apv_t.apv03
               CLOSE t110_k22_cr
               NEXT FIELD apv03
           #MOD-A30008---add---start---
            ELSE
               SELECT apa07,apa13,apa41,apa13 INTO g_apv[i].apa07,l_apa13,l_apa41,m_apa[i].apa13
               FROM apa_file
               WHERE apa01=g_apv[i].apv03 AND apa00 MATCHES '2*'
                 AND (apa58='2' OR apa58='3' OR apa58 IS NULL)
                 AND apa41 = 'Y' AND apa42 != 'Y' 
           #MOD-A30008---add---end---
            END IF
 
            SELECT apa06 INTO l_apa06 FROM apa_file
               WHERE apa01= g_apv[i].apv03
            
            IF g_apa.apa06 <> l_apa06 THEN
               CALL cl_err('','aap-090',1)
            END IF
#No.TQC-6B0066--begin(apv05的含義改變，判斷仍放回原處)
            #-->此帳款尚未確認
            IF l_apa41 != 'Y' THEN
               CALL cl_err(g_apv[i].apv03,'aap-141',0)
               NEXT FIELD apv03
            END IF
 
            #-->不可沖不同幣別
            IF l_apa13 != g_apa.apa13 THEN
               CALL cl_err(g_apv[i].apv03,'aap-014',0)
               NEXT FIELD apv03
            END IF
 
            #-->無金額可沖帳
            IF l_amtf <=0 AND l_amt <=0 THEN
               CALL cl_err(g_apv[i].apv03,'aap-203',0)
               NEXT FIELD apv03
            END IF
            LET g_apv[i].un_payf= l_amtf
            LET g_apv[i].un_pay = l_amt
            SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
            IF g_apz.apz27 = 'Y' AND g_aza.aza17 != m_apa[i].apa13 THEN
                LET g_apv[i].un_pay = m_apa[i].apa73
                LET g_apv[i].apa14  = m_apa[i].apa72
            END IF 
         END IF
 
      AFTER FIELD apv04f
         IF NOT cl_null(g_apv[i].apv04f) THEN
               IF g_apv[i].apv04f < 0 THEN
               NEXT FIELD apv04f
            END IF
            LET l_apv04 = g_apv[i].apv04f * g_apv[i].apa14
            IF g_apv[i].apv03 <> 'DIFF' THEN
               LET g_apv[i].apv04 = l_apv04
            END IF
         END IF
         #原幣是否已經衝平，如果原幣已經衝平，則本幣也應衝平
         SELECT apa34f,apa73 INTO m_apa34f,m_apa73 FROM apa_file
         WHERE apa01 = g_apv[i].apv03
         SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
           FROM aph_file,apf_file
          WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
            AND aph03 IN ('6','7','8','9')
         IF g_amt1f IS NULL THEN
            LET g_amt1f = 0
            LET g_amt1 = 0
         END IF
         #No.MOD-C30061  --Begin #增加退款沖帳金額
         SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
           FROM apg_file,apf_file
          WHERE apg04=g_apv[i].apv03 AND apg01=apf01 AND apf41='Y'
            #AND apf00='32'                  #MOD-D70039
            AND (apf00='32' OR apf00='36')   #MOD-D70039
         IF g_amt6f IS NULL THEN
            LET g_amt6f = 0
            LET g_amt6 = 0
         END IF
         #No.MOD-C30061  --End
 
         SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
           FROM apv_file Where apv03=g_apv[i].apv03
         IF g_amt2f IS NULL THEN
            LET g_amt2f = 0
            LET g_amt2 = 0
         END IF
 
         SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
           FROM oob_file,ooa_file
          WHERE oob01 = ooa01
            AND oob06 = g_apv[i].apv03
            AND oob03 = '2' AND oob04 = '9'
            AND ooaconf = 'Y' #須為已確認
         IF cl_null(g_amt3f) THEN
            LET g_amt3f = 0
            LET g_amt3 = 0
         END IF
         LET m_amt=g_amt1f+g_amt2f+g_amt3f+g_amt6f  #MOD-C30061 add g_amt6f
         IF p_cmd = 'a' THEN
            LET m_amt=m_amt+g_apv[i].apv04f
         ELSE
            LET m_amt=m_amt+g_apv[i].apv04f-g_apv_t.apv04f
         END IF
         IF m_amt = m_apa34f THEN
            LET g_apv[i].apv04 = g_apv[i].apc08*g_apv[i].apa14      #No.FUN-680027
         END IF
         LET g_apv[i].apv04f = cl_digcut(g_apv[i].apv04f,t_azi04) #MOD-750050
         LET g_apv[i].apv04 = cl_digcut(g_apv[i].apv04,g_azi04) #MOD-750050
 
      AFTER FIELD apv04
         IF NOT cl_null(g_apv[i].apv04) THEN
            IF g_apv[i].apv04f >0  AND g_apv[i].apv04=0 THEN                                                                        
               NEXT FIELD apv04                                                                                                     
            END IF                                                                                                                  
            IF cl_digcut(g_apv[i].apv04f * g_apv[i].apa14,g_azi04) != g_apv[i].apv04 THEN   
               IF NOT cl_confirm('aap-202') THEN                                                                                    
                  LET g_apv[i].apv04 = g_apv[i].apv04f*g_apv[i].apa14                                                               
                  LET l_apv04 = g_apv[i].apv04                                                                                      
                  NEXT FIELD apv04                                                                                                  
               END IF                                                                                                               
            END IF                                                                                                                  
            IF g_apv[i].apv04 != g_apv_t.apv04 THEN                                                                                 
               UPDATE apv_file SET apv04=g_apv[i].apv04                                                                             
                WHERE apv01 = g_apa.apa01                                                                                           
                  AND apv02 = g_apv_t.apv02                                                                                         
               IF SQLCA.sqlcode THEN                                                                                                
                  LET g_apv[i].apv04 = 0                                                                                            
                  NEXT FIELD apv04                                                                                                  
               END IF                                                                                                               
            END IF                                                                                                                  
            IF g_apv[i].apv04 < 0 AND g_apv[i].apv03 <> 'DIFF' THEN
               NEXT FIELD apv04
            END IF
 
            IF g_apv[i].apv03 != 'DIFF' THEN
            #-->check 沖帳金額是否超過
              #不用控制本幣了，
              #因為有可能本幣會超過請款的金額，超過部分要確認匯兌損溢
            #No.MOD-580365  --end
               LET l_sum = 0
               LET l_sumf = 0
               LET l_over = 0
                FOR l_k =1 TO g_apv.getLength()   #No.MOD-480131
                  IF cl_null(g_apv[l_k].apv03) THEN
                     EXIT FOR
                  END IF
                  LET l_sumf= l_sumf+ g_apv[l_k].apv04f
                  LET l_sum = l_sum + g_apv[l_k].apv04
                  IF l_sumf > g_apa.apa34f THEN
                     LET g_apv[i].apv04f= 0
                     LET g_apv[i].apv04 = 0
                     CALL cl_err(g_apa.apa34,'aap-913',0)
                     LET l_over = 1
                     EXIT FOR
                  END IF
               END FOR
 
               IF l_over=1 THEN
                  NEXT FIELD apv04f
               END IF
 
               SELECT (apa34f-apa35f),apa73 INTO l_difff,l_diff
                 FROM apa_file WHERE apa01 = g_apv[i].apv03
 
               IF cl_null(g_apv_t.apv04f) THEN
                  LET g_apv_t.apv04f = 0
                  LET g_apv_t.apv04 = 0
               END IF
 
               LET l_total = l_diff + g_apv_t.apv04
 
               IF  g_apv[i].apv04 > l_total THEN
                  LET g_apv[i].apv04f = 0
                  LET g_apv[i].apv04 = 0
                  CALL cl_err(g_apa.apa01,'aap-194',0)
                  LET l_over = 1
               END IF
 
               IF l_over=1 THEN
                  NEXT FIELD apv04f
               END IF
            END IF   #No.MOD-580365
         END IF
         LET g_apv[i].apv04 = cl_digcut(g_apv[i].apv04,g_azi04) #MOD-750050
 
      AFTER FIELD apv05
          IF NOT cl_null(g_apv[i].apv05) THEN
             IF g_apv_t.apv05 IS NULL OR g_apv[i].apv05 <> g_apv_t.apv05 THEN
                SELECT COUNT(*) INTO g_cnt FROM apc_file 
                 #WHERE apc01 =g_apv[i].apv03   #MOD-810111
                  WHERE apc01 =g_apa.apa01   #TQC-C20027
                   AND apc02 =g_apv[i].apv05
                IF g_cnt =0 THEN
                  CALL cl_err('','aap-777',1)
                  NEXT FIELD apv05
                END IF
                SELECT COUNT(*) INTO g_cnt FROM apc_file 
                 #WHERE apc01 =g_apv[i].apv03   #MOD-810111
                  WHERE apc01 =g_apa.apa01   #TQC-C20027
                   AND apc02 =g_apv[i].apv05
                   AND apc08 >(apc10+apc14)
                IF g_cnt =0 THEN
                  CALL cl_err('','aap-778',1)
                  NEXT FIELD apv05
                END IF
         END IF
         END IF
 
 
      ON ACTION CONTROLP
           CASE
              WHEN INFIELD(apv03)
                #CALL q_apa2(FALSE,TRUE,' ','2',g_apa.apa06) RETURNING g_apv[i].apv03              #No.TQC-6B0066   #MOD-820002   #No.MOD-C30717   Mark
                #CALL q_apa2(FALSE,TRUE,' ','2',g_apa.apa06,g_apa.apa07) RETURNING g_apv[i].apv03                                 #No.MOD-C30717   Add   #No.TQC-BC0115 Mark
                 CALL q_apa2(FALSE,TRUE,' ','2',g_apa.apa06,g_apa.apa07,g_apa.apa02) RETURNING g_apv[i].apv03                                            #No.TQC-BC0115 Add
                 DISPLAY g_apv[i].apv03 TO apv03                                      #No.TQC-6B0066  
                 NEXT FIELD apv03
              OTHERWISE EXIT CASE
           END CASE
 
        BEFORE DELETE                            #是否取消單身
           IF g_apv[i].apv02 > 0 AND g_apv_t.apv02 IS NOT NULL THEN
              IF NOT cl_delb(0,0) THEN
                 CANCEL DELETE
              END IF
              DELETE FROM apv_file
               WHERE apv01 = g_apa.apa01 AND apv02 = g_apv_t.apv02
              IF SQLCA.sqlcode THEN
                 CALL cl_err3("del","apv_file",g_apa.apa01,g_apv_t.apv02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
                 CANCEL DELETE
              END IF
              LET ls_rec_b = ls_rec_b - 1
              MESSAGE "delete ok"
              IF g_success = 'Y' AND g_apv[i].apv03 <> 'DIFF' THEN   #No.MOD-580365
                 SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa35f,g_apa.apa35
                   FROM apv_file WHERE apv01=g_apa.apa01
                 IF cl_null(g_apa.apa35f) THEN LET g_apa.apa35f = 0 END IF
                 IF cl_null(g_apa.apa35 ) THEN LET g_apa.apa35 = 0 END IF
                 DISPLAY g_apa.apa35f TO apa65f
                 DISPLAY g_apa.apa35  TO apa65
                 CALL t110_comp_oox(g_apa.apa01) RETURNING g_net      #CHI-890017 add
                 UPDATE apa_file SET apa35f=g_apa.apa35f,
                                     apa35 =g_apa.apa35
                                    ,apa73 =apa34-g_apa.apa35+g_net   #CHI-890017 add
                  WHERE apa01 = g_apa.apa01
                 IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
                    CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                    LET g_success='N'
                 ELSE
                    CALL t110_comp_oox1(g_apv[i].apv03,g_apv[i].apv05) RETURNING g_net  #MOD-940090                       	 
                    UPDATE apc_file SET apc08=apc08+g_apv[i].apv04f,
                                        apc09=apc09+g_apv[i].apv04,
                                        apc13=apc09+g_apv[i].apv04 - apc11 + g_net,   #MOD-940090
                                        apc14=apc14-g_apv[i].apv04f,
                                        apc15=apc15-g_apv[i].apv04
                     WHERE apc01 =g_apv[i].apv03
                       AND apc02 =g_apv[i].apv05
                      IF STATUS OR SQLCA.SQLCODE THEN
                         CALL cl_err3("upd","apcfile", g_apa.apa01,g_apv[i].apv05,SQLCA.sqlcode,"","",1)  
                         LET g_success='N'
                      END IF
                 END IF
                 
                 
                 SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                   FROM aph_file,apf_file
                  WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                    AND aph03 IN ('6','7','8','9')
                 IF g_amt1f IS NULL THEN
                    LET g_amt1f = 0
                    LET g_amt1 = 0
                 END IF
                 #No.MOD-C30061  --Begin #增加退款沖帳金額
                 SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
                   FROM apg_file,apf_file
                  WHERE apg04=g_apv[i].apv03 AND apg01=apf01 AND apf41='Y'
                   #AND apf00='32'                  #MOD-D70039
                    AND (apf00='32' OR apf00='36')   #MOD-D70039
                 IF g_amt6f IS NULL THEN
                    LET g_amt6f = 0
                    LET g_amt6 = 0
                 END IF
                 #No.MOD-C30061  --End
                 SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                   FROM apv_file Where apv03=g_apv[i].apv03
                 IF g_amt2f IS NULL THEN
                    LET g_amt2f = 0
                    LET g_amt2 = 0
                 END IF
                 SELECT SUM(apv04f),SUM(apv04) INTO g_amt5f,g_amt5
                   FROM apv_file Where apv01=g_apv[i].apv03
 
                 IF g_amt5f IS NULL THEN
                    LET g_amt5f = 0
                    LET g_amt5 = 0
                 END IF
                 SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                   FROM oob_file,ooa_file
                  WHERE oob01 = ooa01
                    AND oob06 = g_apv[i].apv03
                    AND oob03 = '2' AND oob04 = '9'
                    AND ooaconf = 'Y' #須為已確認
                 IF cl_null(g_amt3f) THEN
                    LET g_amt3f = 0
                    LET g_amt3 = 0
                 END IF
                 LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt5f+g_amt6f   #MOD-C30061 add g_amt6f
                 LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt5+g_amt6         #MOD-C30061 add g_amt6
                 SELECT * INTO l_apa.* FROM apa_file
                  WHERE apa01 = g_apv[i].apv03
                 LET l_apa.apa34 = l_apa.apa31 + l_apa.apa32 - g_amt1
                 LET l_apa.apa34f= l_apa.apa31f+ l_apa.apa32f- g_amt1f
                 CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
                 SELECT apa34 INTO m_apa34 FROM apa_file
                 WHERE apa01 = g_apv[i].apv03
                 LET g_apa.apa73 = m_apa34 - g_amt1 + g_net
                 UPDATE apa_file SET apa65f= g_amt1f,
                                     apa65 = g_amt1,
                                     apa34 = l_apa.apa34,
                                     apa34f= l_apa.apa34f,
                                     apa73 = g_apa.apa73
                  WHERE apa01 = g_apv[i].apv03
                  IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
                     CALL cl_err3("upd","apa_file",g_apv[i].apv03,"",STATUS,"","upd apa",1)
                     LET g_success='N'
                  END IF
              END IF
           END IF
 
 
      ON ROW CHANGE
          IF INT_FLAG THEN
             CALL cl_err('',9001,0)
             LET INT_FLAG = 0
             LET g_apv[l_ac].* = g_apv_t.*
             CLOSE t110_k22_cr
             LET g_success = 'N'
             EXIT INPUT
          END IF
          IF l_lock_sw = 'Y' THEN
             CALL cl_err(g_apv[l_ac].apv02,-263,1)
             LET g_apv[l_ac].* = g_apv_t.*
          ELSE
             UPDATE apv_file SET apv02 = g_apv[i].apv02,
                                 apv03 = g_apv[i].apv03,
                                 apv04f= g_apv[i].apv04f,
                                 apv04 = g_apv[i].apv04,
                                 apv05 = g_apv[i].apv05      #No.FUN-680027
              WHERE apv01 = g_apa.apa01
                AND apv02 = g_apv_t.apv02
             IF STATUS OR SQLCA.SQLCODE THEN
                CALL cl_err3("upd","apv_file",g_apa.apa01,g_apv_t.apv02,SQLCA.sqlcode,"","upd apv:",1)  #No.FUN-660122
                LET g_success = 'N'
                LET g_apv[i].* = g_apv_t.*
                ELSE MESSAGE "update ok"
             END IF
             IF g_success = 'Y' AND g_apv[i].apv03 <> 'DIFF' THEN #No.MOD-580365
                SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa35f,g_apa.apa35
                  FROM apv_file WHERE apv01=g_apa.apa01
 
                IF cl_null(g_apa.apa35f) THEN
                   LET g_apa.apa35f = 0
                END IF
 
                IF cl_null(g_apa.apa35 ) THEN
                   LET g_apa.apa35 = 0
                END IF
 
 
                DISPLAY g_apa.apa35f TO apa65f
                DISPLAY g_apa.apa35  TO apa65
                CALL t110_comp_oox(g_apa.apa01) RETURNING g_net      #CHI-890017 add
                UPDATE apa_file SET apa35f=g_apa.apa35f,
                                    apa35 =g_apa.apa35
                                   ,apa73 =apa34-g_apa.apa35+g_net   #CHI-890017 add
                 WHERE apa01 = g_apa.apa01
                IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
                   CALL cl_err3("upd","apa_file",g_apa_t.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                   LET g_success='N'
                   IF p_cmd = 'u' THEN
                      LET g_apv[i].*=g_apv_t.*
                   END IF
                 ELSE
                    CALL t110_comp_oox1(g_apv[i].apv03,g_apv[i].apv05) RETURNING g_net  #MOD-940090                   	
                    UPDATE apc_file SET apc08=apc08-g_apv[i].apv04f+g_apv_t.apv04f,
                                        apc09=apc09-g_apv[i].apv04+g_apv_t.apv04,
                                        apc13=apc09-g_apv[i].apv04+g_apv_t.apv04-apc11+g_net,   #MOD-940090
                                        apc14=apc14+g_apv[i].apv04f-g_apv_t.apv04f,
                                        apc15=apc15+g_apv[i].apv04-g_apv_t.apv04
                     WHERE apc01 =g_apv[i].apv03
                       AND apc02 =g_apv[i].apv05
                      IF STATUS OR SQLCA.SQLCODE THEN
                         CALL cl_err3("upd","apcfile", g_apa.apa01,g_apv[i].apv05,SQLCA.sqlcode,"","",1)  
                         LET g_success='N'
                         IF p_cmd = 'u' THEN
                             LET g_apv[i].*=g_apv_t.*
                         END IF
                      END IF
                 END IF
 
                SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                  FROM aph_file,apf_file
                 WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                   AND aph03 IN ('6','7','8','9')
 
                IF g_amt1f IS NULL THEN
                   LET g_amt1f = 0
                   LET g_amt1 = 0
                END IF
               #No.MOD-C30061  --Begin #增加退款沖帳金額
               SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
                 FROM apg_file,apf_file
                WHERE apg04=g_apv[i].apv03 AND apg01=apf01 AND apf41='Y'
                  #AND apf00='32'                  #MOD-D70039
                  AND (apf00='32' OR apf00='36')   #MOD-D70039
               IF g_amt6f IS NULL THEN
                  LET g_amt6f = 0
                  LET g_amt6 = 0
               END IF
               #No.MOD-C30061  --End
 
                SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                  FROM apv_file Where apv03=g_apv[i].apv03
 
                IF g_amt2f IS NULL THEN
                   LET g_amt2f = 0
                   LET g_amt2 = 0
                END IF
 
                SELECT SUM(apv04f),SUM(apv04) INTO g_amt5f,g_amt5
                  FROM apv_file Where apv01=g_apv[i].apv03
 
                IF g_amt5f IS NULL THEN
                   LET g_amt5f = 0
                   LET g_amt5 = 0
                END IF
 
                SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                  FROM oob_file,ooa_file
                 WHERE oob01 = ooa01
                   AND oob06 = g_apv[i].apv03
                   AND oob03 = '2' AND oob04 = '9'
                   AND ooaconf = 'Y' #須為已確認
 
                IF cl_null(g_amt3f) THEN
                   LET g_amt3f = 0
                   LET g_amt3 = 0
                END IF
 
                LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt5f+g_amt6f   #MOD-C30061 add g_amt6f
                LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt5+g_amt6         #MOD-C30061 add g_amt6
 
                 SELECT * INTO l_apa.* FROM apa_file
                  WHERE apa01 = g_apv[i].apv03
                 LET l_apa.apa34 = l_apa.apa31 + l_apa.apa32 - g_amt1
                 LET l_apa.apa34f= l_apa.apa31f+ l_apa.apa32f- g_amt1f
                 CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
                 SELECT apa34 INTO m_apa34 FROM apa_file
                 WHERE apa01 = g_apv[i].apv03
                 LET g_apa.apa73 = m_apa34 - g_amt1 + g_net
                UPDATE apa_file SET apa65f= g_amt1f,
                                    apa65 = g_amt1,
                                    apa34 = l_apa.apa34,
                                    apa34f= l_apa.apa34f,
                                    #apa72 = g_apa.apa72,  #No.MOD-580365
                                    apa73 = g_apa.apa73
                 WHERE apa01 = g_apv[i].apv03
                IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
                   CALL cl_err3("upd","apa_file",g_apv[i].apv03,"",STATUS,"","upd apa",1)
                   LET g_success='N'
                   IF p_cmd = 'u' THEN
                      LET g_apv[i].*=g_apv_t.*
                   END IF
                END IF
            END IF
          END IF
 
      AFTER ROW
          LET l_ac = ARR_CURR()
          IF INT_FLAG THEN
             CALL cl_err('',9001,0)
             LET INT_FLAG = 0
             IF p_cmd = 'u' THEN
                LET g_apv[l_ac].* = g_apv_t.*
             #FUN-D30032--add--str--
             ELSE
                CALL g_apv.deleteElement(l_ac)
             #FUN-D30032--add--end--
             END IF
             CLOSE t110_k22_cr
             LET g_success = 'N'
             EXIT INPUT
          END IF
          CLOSE t110_k22_cr
 
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
 
     #計算匯差
     AFTER INPUT
        LET l_net = 0
        FOR l_i = 1 TO g_apv.getLength()
            IF cl_null(g_apv[l_i].apv03) THEN CONTINUE FOR END IF
            IF g_apv[l_i].apv03 = 'DIFF' THEN CONTINUE FOR END IF
            SELECT apa14 INTO l_apa14 FROM apa_file
             WHERE apa01=g_apv[l_i].apv03
            IF l_apa14 <> g_apv[l_i].apa14 THEN
               LET l_amt=cl_digcut(g_apv[l_i].apv04f*g_apa.apa14,g_azi04)
                         - g_apv[l_i].apv04
               IF cl_null(l_amt) THEN LET l_amt=0 END IF
               CALL t110_comp_oox1(g_apv[i].apv03,g_apv[l_i].apv05) RETURNING g_net  #MOD-940090 
               LET l_amt = cl_digcut(l_amt,g_azi04) 
               UPDATE apc_file SET apc09=apc09-l_amt,
                                   apc13=apc09-l_amt - apc11+g_net,   #MOD-940090  
                                   apc15=apc15+l_amt
                WHERE apc01 =g_apv[i].apv03
                  AND apc02 =g_apv[l_i].apv05
               IF STATUS OR SQLCA.SQLCODE THEN
                  CALL cl_err3("upd","apcfile", g_apa.apa01,g_apv[l_i].apv05,SQLCA.sqlcode,"","",1)  
                  LET g_success='N'
               END IF               
            ELSE
               IF g_apv[l_i].apa14 <> g_apa.apa14 THEN
                  LET l_amt=cl_digcut(g_apv[l_i].apv04f*g_apa.apa14,g_azi04)
                            - g_apv[l_i].apv04
                  IF cl_null(l_amt) THEN LET l_amt=0 END IF
                  CALL t110_comp_oox1(g_apv[i].apv03,g_apv[l_i].apv05) RETURNING g_net  #MOD-940090 
                  LET l_amt = cl_digcut(l_amt,g_azi04) 
                  UPDATE apc_file SET apc09=apc09-l_amt,
                                      apc13=apc09-l_amt - apc11+g_net,   #MOD-940090
                                      apc15=apc15+l_amt
                   WHERE apc01 =g_apv[i].apv03
                     AND apc02 =g_apv[l_i].apv05
                  IF STATUS OR SQLCA.SQLCODE THEN
                     CALL cl_err3("upd","apcfile", g_apa.apa01,g_apv[l_i].apv05,SQLCA.sqlcode,"","",1)  
                     LET g_success='N'
                  END IF               
               END IF
            END IF
        END FOR
        DELETE FROM apv_file
         WHERE apv01=g_apa.apa01
           AND apv03='DIFF'
        IF SQLCA.sqlcode THEN
           CALL cl_err3("del","apv_file",g_apa.apa01,"",SQLCA.sqlcode,"","delete diff",1)  #No.FUN-660122
           NEXT FIELD apv04
        END IF
        IF l_net <> 0 THEN
            SELECT MAX(apv02)+1 INTO l_apv02 FROM apv_file
             WHERE apv01 = g_apa.apa01
            IF cl_null(l_apv02)  THEN
               LET l_apv02 = 1
            END IF
            INSERT INTO apv_file(apv01,apv02,apv03,apv04f,apv04,apvlegal) #FUN-980001 add apvlegal
            VALUES(g_apa.apa01,l_apv02,'DIFF',0,l_net,g_legal) #FUN-980001 add g_legal
            IF SQLCA.sqlcode THEN
               CALL cl_err3("ins","apv_file",g_apa.apa01,l_apv02,SQLCA.sqlcode,"","insert diff",1)  #No.FUN-660122
               NEXT FIELD apv04
            END IF
         END IF
 
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
 
   END INPUT
 
   IF INT_FLAG THEN
      LET g_success='N'
      LET INT_FLAG = 0
   END IF
 
   IF g_success = 'Y' THEN
      COMMIT WORK
      MESSAGE "Commit"
   ELSE
      ROLLBACK WORK
      MESSAGE "RollBack"
   END IF
 
   SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa35f,g_apa.apa35
     FROM apv_file WHERE apv01=g_apa.apa01
 
   IF cl_null(g_apa.apa35f) THEN
      LET g_apa.apa35f = 0
   END IF
 
   IF cl_null(g_apa.apa35 ) THEN
      LET g_apa.apa35 = 0
   END IF
 
 
   DISPLAY g_apa.apa35f TO apa65f
   DISPLAY g_apa.apa35  TO apa65
   CALL t110_comp_oox(g_apa.apa01) RETURNING g_net      #CHI-890017 add
   UPDATE apa_file SET apa35f=g_apa.apa35f,
                       apa35 =g_apa.apa35
                      ,apa73 =apa34-g_apa.apa35+g_net   #CHI-890017 add
    WHERE apa01 = g_apa.apa01
 
   IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
      CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa35:",1)  #No.FUN-660122
      LET g_success = 'N'   #MOD-730098
   END IF
 
   CLOSE WINDOW t110_kkk_w
 
   DISPLAY BY NAME g_apa.apa35f,g_apa.apa35
   CLOSE t110_k2_cr
   CLOSE t110_k22_cr
 
   IF l_lock_sw = 'Y' THEN
      RETURN
   END IF
 
   CALL t110_apa34f('0')     #TQC-750140
 
   LET g_apa.apa72 = g_apa.apa14
   CALL t110_comp_oox(g_apa.apa01) RETURNING g_net       #CHI-890017 add
   LET g_apa.apa73 = g_apa.apa34 - g_apa.apa35 + g_net   #CHI-890017
 
   UPDATE apa_file set * = g_apa.* WHERE apa01 = g_apa.apa01
   IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
      CALL cl_err3("upd","apa_file",g_apa.apa01,"",STATUS,"","upd apa:",1)
      LET g_success = 'N'
   END IF
 
   CALL t110_up_gl()
   CALL t110_unpay()
 
   DELETE FROM apv_file WHERE apv01 = g_apa.apa01 AND apv04 = 0
 
   CALL t110_diff_rtn('0') #TQC-750140
  #CALL t110_api_diff()    #No.TQC-7B0083  #MOD-C60107 mark
 
END FUNCTION
 
FUNCTION t110_pay_record()
   DEFINE i,j          LIKE type_file.num5       #No.FUN-690028 SMALLINT
   DEFINE l_amtf,l_amt LIKE type_file.num20_6,   # No.FUN-690028 DEC(20,6),  #FUN-4B0079
          tmp_prog     LIKE type_file.chr1000    # No.FUN-690028 VARCHAR(100)
   DEFINE l_ape     RECORD
                    no          LIKE apv_file.apv01,      # No.FUN-690028 VARCHAR(16),  #FUN-580012
                    sq          LIKE type_file.num5,      # No.FUN-690028 SMALLINT,
                    amtf        LIKE type_file.num20_6,   # No.FUN-690028 DEC(20,6),  #FUN-4B0079
                    amt         LIKE type_file.num20_6,   # No.FUN-690028 DEC(20,6),  #FUN-4B0079
                    nmd02       LIKE nmd_file.nmd02,  #FUN-660117
                    nmd05       LIKE type_file.dat,       # No.FUN-690028 DATE,
                    nmd04       LIKE nmd_file.nmd04 ,#FUN-4B0079
                    apf02       LIKE type_file.dat    #add by wnagyuz 170822 
                    END RECORD
 
   CALL g_ape.clear()
   IF g_apa.apa01 IS NULL THEN
      RETURN
   END IF
 
 
   OPEN WINDOW t110_pay_record_w WITH FORM "aap/42f/aapt110_4"
        ATTRIBUTE(STYLE = g_win_style)
 
   CALL cl_ui_locale('aapt110_4')
 
   LET l_amtf = 0 LET l_amt  = 0
   LET i = 1
   IF g_aptype MATCHES '1*' THEN
      DECLARE t110_pay_c11 CURSOR FOR
           SELECT apv03,'',apv04f,apv04,'','',''
             FROM apv_file
            WHERE apv01 = g_apa.apa01
            UNION
           SELECT apv01,'',apv04f,apv04,'','',''
             FROM apv_file
            WHERE apv03 = g_apa.apa01
 
 
      FOREACH t110_pay_c11 INTO g_ape[i].*
         LET l_amtf = l_amtf + g_ape[i].amtf
         LET l_amt  = l_amt  + g_ape[i].amt
         LET i = i + 1
          IF i > g_max_rec THEN    #No.MOD-480131
            EXIT FOREACH
         END IF
      END FOREACH

     #No.FUN-C90127   ---start---   Add
      DECLARE t110_pay_c111 CURSOR FOR
         SELECT nmg00,'',SUM(npk08),SUM(npk09),'','',''
           FROM nmg_file,npk_file,aph_file
          WHERE nmg00 = npk00
            AND nmg31 = aph01
            AND aph23 = g_apa.apa01
            AND nmgconf = 'Y'
          GROUP BY nmg00
      FOREACH t110_pay_c111 INTO g_ape[i].*
         LET l_amtf = l_amtf + g_ape[i].amtf
         LET l_amt  = l_amt  + g_ape[i].amt
         LET i = i + 1
          IF i > g_max_rec THEN
            EXIT FOREACH
         END IF
      END FOREACH
     #No.FUN-C90127   ---end  ---   Add
 
      LET g_sql = "SELECT MAX(nmd02),MAX(nmd05),MAX(nmd04) ",
                  "  FROM nmd_file WHERE nmd10=? AND nmd30 <> 'X' "
 
      PREPARE t110_prenmd FROM g_sql
      DECLARE t110_csnmd CURSOR FOR t110_prenmd
 
     #LET g_sql = "SELECT azp01 FROM azp_file WHERE azp053='Y'"   #TQC-B60280   Mark
     #LET g_sql = "SELECT azp01 FROM azp_file,azw_file WHERE azp053='Y' AND azw01 = azp01"            #TQC-B60280 add #MOD-BB0209 mark
      LET g_sql = "SELECT azp01 FROM azp_file",                                                       #MOD-BB0209 add
                  " WHERE azp03 = (SELECT azw09 FROM azw_file WHERE azw01 = '",g_plant CLIPPED,"')"   #MOD-BB0209 add
     #IF g_apa.apa55='2' OR g_apz.apz26 = 'N' THEN   #直接付款  #MOD-940213    #TQC-A20062
     #----------------------------------------MOD-BB0209-----------------mark
     #IF g_apa.apa55='2' THEN  #TQC-A20062	
     #   LET g_sql = g_sql CLIPPED," AND azp01='",g_plant CLIPPED,"'"
     #END IF
     #----------------------------------------MOD-BB0209-----------------mark
      PREPARE zp_pre FROM g_sql
      DECLARE zp_curs1 CURSOR FOR zp_pre
 
      FOREACH zp_curs1 INTO g_plant_new   #CHI-880003 mod zr_curs1->zp_curs1
         IF STATUS THEN
            EXIT FOREACH
         END IF
         CALL s_getdbs() 
         LET g_sql = "SELECT apf01,apg02,apg05f,apg05,'','','' ",
                    #" FROM ",g_dbs_new CLIPPED," apg_file,",
                    #         g_dbs_new CLIPPED," apf_file ",
                     " FROM ",cl_get_target_table(g_plant_new,'apg_file'),",", #FUN-A50102
                              cl_get_target_table(g_plant_new,'apf_file'),     #FUN-A50102
                     " WHERE apg01 = apf01 AND apf41='Y' ",
                    #"   AND apg03 = '",g_plant CLIPPED,"' ",    #No.MOD-910020   #MOD-BA0221 mark
                     "   AND apg04 = '",g_apa.apa01,"'",
                     "   AND apf01 NOT IN(SELECT apf01 FROM apf_file,apg_file",                            #No.FUN-690090
                    #"                 WHERE apf01 =apg01 AND apf992 IS NOT NULL AND apg03 ='",g_plant,"')",  #No.FUN-690090 #MOD-BA0221 mark
                     "                 WHERE apf01 =apg01 AND apf992 IS NOT NULL)",  #MOD-BA0221 add
                     "   AND apflegal = '",g_legal,"'",   #MOD-C40157 add
                     " ORDER BY apf01 "
 
 	 CALL cl_replace_sqldb(g_sql) RETURNING g_sql        #FUN-920032
     CALL cl_parse_qry_sql(g_sql,g_plant_new) RETURNING g_sql #FUN-A50102
         PREPARE t110_prepay FROM g_sql
         DECLARE t110_pay_cl2 CURSOR FOR t110_prepay
 
         FOREACH t110_pay_cl2 INTO g_ape[i].*
           IF SQLCA.sqlcode THEN
              CALL cl_err('t110_pay_cl2',SQLCA.sqlcode,0)
              EXIT FOREACH
           END IF
 
           OPEN t110_csnmd USING g_ape[i].no
           FETCH t110_csnmd INTO g_ape[i].nmd02,g_ape[i].nmd05,g_ape[i].nmd04
        #add by wangyuz 170822 str   
           SELECT apf02 INTO g_ape[i].apf02  FROM apf_file WHERE apf01 = g_ape[i].NO
      #add by wangyuz 170822 end 
           LET l_amtf = l_amtf + g_ape[i].amtf
           LET l_amt  = l_amt  + g_ape[i].amt
           LET i = i + 1
 
            IF i > g_max_rec THEN                  #No.MOD-480131
              EXIT FOREACH
           END IF
        END FOREACH
      END FOREACH
   END IF
 
   IF g_aptype MATCHES '2*' THEN
      DECLARE t110_pay_c21 CURSOR FOR
           SELECT apa01,apv02,apv04f,apv04,'','',''
             FROM apv_file LEFT OUTER JOIN apa_file ON apv01 = apa01
            WHERE apv03 = g_apa.apa01 
            UNION
           SELECT apv03,apv02,apv04f,apv04,'','',''
             FROM apv_file
            WHERE apv01 = g_apa.apa01
 
      FOREACH t110_pay_c21 INTO g_ape[i].*
         LET l_amtf = l_amtf + g_ape[i].amtf
         LET l_amt  = l_amt  + g_ape[i].amt
         LET i = i + 1
         IF i > 48 THEN
            EXIT FOREACH
         END IF
      END FOREACH
 
     #LET g_sql = "SELECT azp01 FROM azp_file WHERE azp053='Y'"   #TQC-B60280 Mark
    #------------------------------MOD-C60132-----------------------------------------(S)
     #LET g_sql = "SELECT azp01 FROM azp_file,azw_file WHERE azp053='Y' AND azw01 = azp01"  #TQC-B60280 #MOD-C60132 mark
      LET g_sql = " SELECT azp01 FROM azp_file,azw_file ",
                  "  WHERE azp053='Y' ",
                  "    AND azw01 = azp01 ",
                  "    AND azp03 = (SELECT azw09 FROM azw_file WHERE azw01 = '",g_plant CLIPPED,"')"
    #------------------------------MOD-C60132-----------------------------------------(E)
      IF g_apa.apa00='21' OR g_apa.apa00='22' OR
         g_apa.apa00='23' OR g_apa.apa00='25' THEN
         LET g_sql = g_sql CLIPPED," AND azp01='",g_plant CLIPPED,"'"
      END IF
      PREPARE zp_pre2 FROM g_sql
      DECLARE zp_curs2 CURSOR FOR zp_pre2
 
      FOREACH zp_curs2 INTO g_plant_new   #CHI-880003 mod zr_curs2->zp_curs2
         IF STATUS THEN
            EXIT FOREACH
         END IF
 
         CALL s_getdbs()
 
         LET g_sql = " SELECT apf01,aph02,aph05f,aph05,'','','' ",
                     #"   FROM ",g_dbs_new CLIPPED,"aph_file,",
                     #           g_dbs_new CLIPPED,"apf_file ",
                     "   FROM ",cl_get_target_table(g_plant_new,'aph_file'),",", #FUN-A50102
                                cl_get_target_table(g_plant_new,'apf_file'),     #FUN-A50102
                     "  WHERE aph04 ='", g_apa.apa01 ,"'",
                     "    AND aph01=apf01 AND apf41='Y'",
                     "  ORDER BY apf01 "
 	 CALL cl_replace_sqldb(g_sql) RETURNING g_sql        #FUN-920032
     CALL cl_parse_qry_sql(g_sql,g_plant_new) RETURNING g_sql #FUN-A50102
         PREPARE t110_pay_p22 FROM g_sql
 
         DECLARE t110_pay_c22 CURSOR FOR t110_pay_p22
 
         FOREACH t110_pay_c22 INTO g_ape[i].*
            LET l_amtf = l_amtf + g_ape[i].amtf
            LET l_amt  = l_amt  + g_ape[i].amt
            LET i = i + 1
             IF i > g_max_rec THEN             #No.MOD-480131
               EXIT FOREACH
            END IF
         END FOREACH
         LET g_sql = "SELECT apf01,apg02,apg05f,apg05,'','','' ",                                                                   
                    #" FROM ",g_dbs_new CLIPPED," apg_file,",                                                                       
                    #         g_dbs_new CLIPPED," apf_file ", 
                     " FROM ",cl_get_target_table(g_plant_new,'apg_file'),",", #FUN-A50102
                              cl_get_target_table(g_plant_new,'apf_file'),     #FUN-A50102                     
                     " WHERE apg01 = apf01 AND apf41='Y' ",                                                                         
                    #"   AND apg03 = '",g_plant CLIPPED,"' ",    #No.MOD-910020        #MOD-BA0221 mark
                     "   AND apg04 = '",g_apa.apa01,"'",                                                                            
                     "   AND apf01 NOT IN(SELECT apf01 FROM apf_file,apg_file",                            #No.FUN-690090           
                    #"                 WHERE apf01 =apg01 AND apf992 IS NOT NULL AND apg03 ='",g_plant,"')",  #No.FUN-690090  #MOD-BA0221 mark
                     "                 WHERE apf01 =apg01 AND apf992 IS NOT NULL)",    #MOD-BA0221 add
                     "   AND apflegal = '",g_legal,"'",   #MOD-C40157 add
                     " ORDER BY apf01 "                                                                                             
                                                                                                                                    
         CALL cl_replace_sqldb(g_sql) RETURNING g_sql            #FUN-920032 
         CALL cl_parse_qry_sql(g_sql,g_plant_new) RETURNING g_sql #FUN-A50102         
         PREPARE t110_prepay_1 FROM g_sql                                                                                           
         DECLARE t110_pay_cl2_1 CURSOR FOR t110_prepay_1                                                                            
                                                                                                                                    
         FOREACH t110_pay_cl2_1 INTO g_ape[i].*                                                                                     
            LET l_amtf = l_amtf + g_ape[i].amtf                                                                                     
            LET l_amt  = l_amt  + g_ape[i].amt                                                                                      
            LET i = i + 1                                                                                                           
                                                                                                                                    
            IF i > g_max_rec THEN                  #No:MOD-480131                                                                   
               EXIT FOREACH                                                                                                         
            END IF                                            
         END FOREACH                                                                                                                
      END FOREACH
      LET g_sql = " SELECT aqa01,'',aqb04,aqb04,'','','' ",
                  "   FROM aqa_file,aqb_file ",
                  "  WHERE aqb02 ='", g_apa.apa01 ,"'",
                  "    AND aqa01=aqb01 AND aqaconf='Y'",
                  "  ORDER BY aqa01 "
      PREPARE t110_pay_p23 FROM g_sql
 
      DECLARE t110_pay_c23 CURSOR FOR t110_pay_p23
 
      FOREACH t110_pay_c23 INTO g_ape[i].*
         LET l_amtf = l_amtf + g_ape[i].amtf
         LET l_amt  = l_amt  + g_ape[i].amt
         LET i = i + 1
          IF i > g_max_rec THEN
            EXIT FOREACH
         END IF
      END FOREACH
 
   END IF
 
   CALL g_ape.deleteElement(i)    #MOD-B50017 
   LET g_rec_b = i - 1
   DISPLAY l_amtf TO FORMONLY.totf
   DISPLAY l_amt  TO FORMONLY.tot
   DISPLAY ARRAY g_ape TO s_ape.* ATTRIBUTE(COUNT=g_rec_b)
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE DISPLAY
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
 
   END DISPLAY
   IF INT_FLAG THEN
      LET INT_FLAG = 0
   END IF
 
   CLOSE WINDOW t110_pay_record_w
END FUNCTION
 
FUNCTION t110_gen_gl()
   DEFINE l_t1       LIKE apy_file.apyslip,    # No.FUN-690028 VARCHAR(05),                      #No.FUN-550030
          l_apydmy3  LIKE apy_file.apydmy3
 
   IF NOT cl_null(g_apa.apa44) THEN   #No.MOD-670056
      CALL cl_err(g_apa.apa01,'aap-122',1) RETURN
   END IF

   #TQC-C90078--add--str--
   IF g_apa.apa58='1' THEN             
      CALL cl_err('','aap-260',0)     
   END IF
   #TQC-C90078--add--end--  

   IF g_apa.apa56='1' THEN
      CALL cl_err(g_apa.apa01,'aap-230',0)
      RETURN
   END IF
   LET l_t1 = s_get_doc_no(g_apa.apa01)
   SELECT apydmy3 INTO l_apydmy3 FROM apy_file WHERE apyslip = l_t1
   IF SQLCA.sqlcode THEN
      CALL cl_err3("sel","apy_file","","",STATUS,"","sel apy:",1)  #No.FUN-660122
      RETURN
   END IF
 
   IF l_apydmy3 = 'Y' THEN
     #IF g_apa.apa58 <> '1' THEN                           #TQC-C90078 add #MOD-CB0128 mark
      IF g_apa.apa58 <> '1' OR cl_null(g_apa.apa58) THEN   #MOD-CB0128 add
         CALL t110_g_gl(g_apa.apa00,g_apa.apa01,'0','')    #No.FUN-680029  #FUN-9C0001 add ''
         IF g_aza.aza63 ='Y' THEN
            CALL t110_g_gl(g_apa.apa00,g_apa.apa01,'1','')   #FUN-9C0001 add '' 
         END IF
      END IF                       #TQC-C90078  add
   END IF
 
END FUNCTION
 
FUNCTION t110_firm1_chk()
   DEFINE only_one,l_sw         LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_amt,l_amt1,l_amt2   LIKE type_file.num20_6,   # No.FUN-690028 DEC(20,6),  #FUN-4B0079
          l_apk                 RECORD LIKE apk_file.*,
          i,j                   LIKE type_file.num5,    #No.FUN-690028 SMALLINT
          l_cmd                 LIKE type_file.chr1000 #No.FUN-690028 VARCHAR(200)
   DEFINE l_apydmy3             LIKE apy_file.apydmy3,    # No.FUN-690028 VARCHAR(1),
          l_apb14               LIKE apb_file.apb14,
          l_apb14f              LIKE apb_file.apb14f,
          l_apa01               LIKE apa_file.apa01,
          l_apa41               LIKE apa_file.apa41,
          l_apa32               LIKE apa_file.apa32,      #MOD-AC0268 
          l_apa32f              LIKE apa_file.apa32f,     #MOD-AC0268
          l_apa34               LIKE apa_file.apa34,
          l_apa34f              LIKE apa_file.apa34f
   DEFINE l_arr1 DYNAMIC ARRAY OF LIKE apk_file.apk01   #FUN-660117
   DEFINE l_arr2 DYNAMIC ARRAY OF RECORD
                    #invoice    VARCHAR(16),    #MOD-5B0255   #FUN-660117 remark
                    invoice    LIKE apk_file.apk03,        #FUN-660117
                    apa58      LIKE apa_file.apa58,
                    amt1       LIKE type_file.num20_6,   # No.FUN-690028 DEC(20,6),  #FUN-4B0079
                    amt2       LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
                 END RECORD
   DEFINE g_apa61              LIKE apa_file.apa61  #FUN-4B0079
   DEFINE l_api05              LIKE api_file.api05
   DEFINE g_t1                 LIKE oay_file.oayslip             #No.FUN-550030  #No.FUN-690028 VARCHAR(05)
   DEFINE l_flag               LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_yy,l_mm            LIKE type_file.num5    #No.FUN-690028 SMALLINT
   DEFINE l_cnt                LIKE type_file.num10   #No.FUN-690028 INTEGER
   DEFINE l_apv04f             LIKE apv_file.apv04f  #FUN-580012
   DEFINE l_apv04              LIKE apv_file.apv04   #FUN-580012               
   DEFINE l_apc08              LIKE apc_file.apc08   #No.FUN-680027
   DEFINE l_apc09              LIKE apc_file.apc09   #No.FUN-680027
   DEFINE l_apc16              LIKE apc_file.apc16   #No.FUN-680027
   DEFINE l_apb11              LIKE apb_file.apb11   #MOD-7C0139
   DEFINE l_aag21              LIKE aag_file.aag21   #MOD-850100 add
   DEFINE l_gec05              LIKE gec_file.gec05   #MOD-940079   
   DEFINE l_pmm22              LIKE pmm_file.pmm22   #MOD-9C0334 add
   DEFINE l_pmn31              LIKE pmn_file.pmn31   #TQC-D90007 add
   DEFINE l_apb06              LIKE apb_file.apb06   #MOD-9C0334 add
   DEFINE l_apb07              LIKE apb_file.apb07   #TQC-D90007 add
   DEFINE l_apb23              LIKE apb_file.apb23   #TQC-D90007 add
   DEFINE l_apb37              LIKE apb_file.apb37   #FUN-A60056 
   DEFINE l_sumamtf            LIKE apa_file.apa34f  #MOD-B60066
   DEFINE l_sumamt             LIKE apa_file.apa34   #MOD-B60066
   DEFINE l_pmc913             LIKE pmc_file.pmc913  #MOD-D70065
   DEFINE l_aza17              LIKE aza_file.aza17    #dengsy150813 add

   SELECT * INTO g_apa.* FROM apa_file WHERE apa01 = g_apa.apa01   #FUN-640231
 
   LET g_success = 'Y'
 
   IF g_apa.apa01 IS NULL THEN
      LET g_success = 'N'
     #RETURN #CHI-A80031 mark
   END IF
   IF g_apa.apaacti='N' THEN
     #CALL cl_err('','mfg0301',1) #CHI-A80031 mark
      CALL s_errmsg('','','','mfg0301',1) #CHI-A80031
      LET g_success = 'N'
     #RETURN #CHI-A80031 mark
   END IF

   #dengsy150813 add start
    IF g_aptype = '11' OR g_aptype = '12' OR g_aptype = '13' THEN 
        SELECT aza17 INTO l_aza17 FROM aza_file 
        IF g_apa.apa13 = l_aza17 THEN 
           IF g_apa.apa65f <> g_apa.apa65 THEN 
             CALL s_errmsg('','','','cap-336',1) 
             LET g_success = 'N'
           END IF 
        END IF 
    END IF 
#dengsy150813 add end 
   
     #No.MOD-D70065  --Begin        
  SELECT pmc913 INTO l_pmc913 FROM pmc_file  WHERE pmc01 = g_apa.apa05
  IF g_aptype = '15' AND (g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y')) THEN
     LET l_cnt = 0 
     SELECT COUNT(*) INTO l_cnt FROM apb_file WHERE apb01 = g_apa.apa01
     IF l_cnt = 0 THEN
        CALL s_errmsg('','','','aap-192',1)
        LET g_success = 'N' 
        RETURN
     END IF
  END IF
  #No.MOD-D70065  --End
  #----------------MOD-C70057----------------------(S)
   SELECT COUNT(*) INTO l_cnt
     FROM apb_file,apa_file
    WHERE apb01 = g_apa.apa01
      AND apb01 = apa01
      AND apb34 = 'Y'
      AND apa55 = '2'
  #FUN-C70075--mark--str
  #IF l_cnt > 0 THEN
  #   CALL s_errmsg('',g_apa.apa51,'','aap-029',1)
  #   LET g_success = 'N'
  #END IF
  #FUN-C70075--mark--end
  #----------------MOD-C70057----------------------(E)
  #----------------MOD-C80113----------------------(S)
  #-MOD-C90254-add
   LET l_cnt = 0
   SELECT COUNT(*) INTO l_cnt FROM npq_file
    WHERE npq01 = g_apa.apa01
      AND npqsys = 'AP'
      AND npq00 = 1
      AND npq011 = 1
   IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
  #-MOD-C90254-end
  #IF g_apa.apa58 <> '1' THEN    #TQC-C90078 add  #MOD-C90254 mark
   IF l_cnt > 0 THEN                              #MOD-C90254 
      CALL s_chknpq(g_apa.apa01,'AP',1,'0',g_bookno1)
      IF g_aza.aza63 ='Y' AND g_success ='Y' THEN
         CALL s_chknpq(g_apa.apa01,'AP',1,'1',g_bookno2)
      END IF 
   END IF                    #TQC-C90078 add
  #----------------MOD-C80113----------------------(E)
  #str CHI-B60063 add
  #確認時若碰到應付金額=0的資料,增加詢問"應付金額為0,是否確定執行確認(Y/N)?"
   LET g_flag2 = 'Y'
  #IF g_apa.apa34f = 0  THEN                                 #MOD-C20165 mark
   IF g_apa.apa34f = 0 AND g_apa.apa31f = 0 THEN             #MOD-C20165 add
      CALL cl_getmsg('aap-168',g_lang) RETURNING g_msg
      LET g_msg = g_apa.apa01,g_msg
      IF cl_confirm(g_msg) THEN 
         LET g_flag2 = 'N' #不檢查,直接確認
      ELSE
         LET g_flag2 = 'Y'
         LET g_success = 'N'
      END IF
      RETURN
   END IF
  #end CHI-B60063 add
  


   DECLARE apb06 CURSOR FOR 
     SELECT apb06,apb37 FROM apb_file where apb01=g_apa.apa01   #FUN-A60056 add apb37
   FOREACH apb06 INTO l_apb06,l_apb37    #FUN-A60056 add apb37
     IF NOT cl_null(l_apb06) THEN
       #FUN-A60056--mod--str--
       #SELECT pmm22 INTO l_pmm22 FROM pmm_file
       # WHERE pmm01 = l_apb06
        LET g_sql = "SELECT pmm22 FROM ",cl_get_target_table(l_apb37,'pmm_file'),
                    " WHERE pmm01 = '",l_apb06,"'"
        CALL cl_replace_sqldb(g_sql) RETURNING g_sql
        CALL cl_parse_qry_sql(g_sql,l_apb37) RETURNING g_sql
        PREPARE sel_pmm22 FROM g_sql
        EXECUTE sel_pmm22 INTO l_pmm22
       #FUN-A60056--mod--end
        IF l_pmm22 <> g_apa.apa13 THEN
          #CALL cl_err('','aap-041',1) #CHI-A80031 mark
           CALL s_errmsg('','','','aap-041',1) #CHI-A80031
           LET g_success = 'N'
          #RETURN #CHI-A80031 mark
        END IF
     END IF
   END FOREACH

   #TQC-D90007--add--str--
   IF g_aptype = '26' THEN
      DECLARE t100_apb06_1 CURSOR FOR
        SELECT apb06,apb07,apb23,apb37 FROM apb_file where apb01=g_apa.apa01
      FOREACH t100_apb06_1 INTO l_apb06,l_apb07,l_apb23,l_apb37
         IF NOT cl_null(l_apb06) AND NOT cl_null(l_apb07) THEN
            LET l_pmn31=0
            LET l_sql = "SELECT pmn31 FROM ",cl_get_target_table(l_apb37,'pmn_file'),
                        " WHERE pmn01='",l_apb06,"' ",
                        "   AND pmn02='",l_apb07,"' "
            CALL cl_replace_sqldb(l_sql) RETURNING l_sql
                CALL cl_parse_qry_sql(l_sql,l_apb37) RETURNING l_sql
            PREPARE sel_pmn31_cs5_1 FROM l_sql
            EXECUTE sel_pmn31_cs5_1 INTO l_pmn31
            IF l_apb23 > l_pmn31  THEN
               CALL s_errmsg('apb06',l_apb06,'','aap-939',1)
               LET g_success = 'N'
            END IF
         END IF
      END FOREACH
   END IF
   #TQC-D90007--add--str--
 
   IF g_apa.apa41 = 'Y' THEN
      LET g_success = 'N'
     #RETURN #CHI-A80031 mark
   END IF
 
   IF g_apa.apa42 = 'Y' THEN
     #CALL cl_err('','9024',0) #CHI-A80031 mark
      CALL s_errmsg('','','','9024',1) #CHI-A80031
      LET g_success = 'N'
     #RETURN #CHI-A80031 mark
   END IF
 
   IF g_apa.apa56 = '1' THEN
     #CALL cl_err('','aap-807',0) #CHI-A80031 mark
      CALL s_errmsg('','','','aap-807',1) #CHI-A80031
      LET g_success = 'N'
     #RETURN #CHI-A80031 mark
   END IF
 
   SELECT COUNT(*) INTO l_cnt FROM apc_file
    WHERE apc01 =g_apa.apa01
   IF l_cnt =0 THEN
     #CALL cl_err(g_apa.apa01,'aap-339',1) #CHI-A80031 mark
      CALL s_errmsg('apa01',g_apa.apa01,'','aap-339',1) #CHI-A80031
      LET g_success ='N'
     #RETURN #CHI-A80031 mark
   END IF
 
  #借方科目(apa51)若有預算控管時(aag21='Y'),單身沒輸入科目(apb25)不可確認
   SELECT aag21 INTO l_aag21 FROM aag_file
    WHERE aag01 = g_apa.apa51
      AND aag00 = g_bookno1     #No.FUN-730064
      AND aagacti = 'Y'                         #No.MOD-B70280 add
   IF l_aag21='Y' THEN
      LET l_cnt = 0
      SELECT COUNT(*) INTO l_cnt FROM apb_file
       WHERE apb01=g_apa.apa01 AND apb25=g_apa.apa51
      IF l_cnt = 0 THEN
        #CALL cl_err('','aap-116',1) #CHI-A80031 mark
         CALL s_errmsg('','','','aap-116',1) #CHI-A80031
         LET g_success ='N'
        #RETURN #CHI-A80031 mark
      END IF
   END IF
   IF g_aza.aza63 = 'Y' THEN
      SELECT aag21 INTO l_aag21 FROM aag_file
       WHERE aag01 = g_apa.apa511
         AND aag00 = g_bookno2     #No.FUN-730064
         AND aagacti = 'Y'                         #No.MOD-B70280 add
      IF l_aag21='Y' THEN
         LET l_cnt = 0
         SELECT COUNT(*) INTO l_cnt FROM apb_file
          WHERE apb01=g_apa.apa01 AND apb251=g_apa.apa511
     #    IF l_cnt > 0 THEN   #TQC-B80175
         IF l_cnt = 0 THEN  #TQC-B80175  add
           #CALL cl_err('','aap-116',1) #CHI-A80031 mark
            CALL s_errmsg('','','','aap-116',1) #CHI-A80031
            LET g_success ='N'
           #RETURN #CHI-A80031 mark
         END IF
      END IF
   END IF
 
  #IF g_aptype <> '13' THEN         #FUN-950094 mark
        #-MOD-B60066-add-
         IF g_aptype MATCHES '1*' THEN
            LET l_sumamtf = g_apa.apa34f + g_apa.apa65f
            LET l_sumamt  = g_apa.apa34  + g_apa.apa65
         ELSE
            LET l_sumamtf = g_apa.apa34f
            LET l_sumamt  = g_apa.apa34
         END IF
        #-MOD-B60066-end-
         SELECT SUM(apc08),SUM(apc09),SUM(apc16) INTO l_apc08,l_apc09,l_apc16 FROM apc_file
          WHERE apc01 =g_apa.apa01
        #IF l_apc08 <>g_apa.apa34f OR l_apc09 <>g_apa.apa34 OR l_apc16 <>g_apa.apa20 THEN #MOD-B60066 mark 
         IF l_apc08 <> l_sumamtf OR l_apc09 <> l_sumamt OR l_apc16 <>g_apa.apa20 THEN     #MOD-B60066 
           #CALL cl_err('','aap-921',1)  #No.TQC-740168 #CHI-A80031 mark
            CALL s_errmsg('','','','aap-921',1) #CHI-A80031
            LET g_success = 'N'
           #RETURN #CHI-A80031 mark
         END if
  #END IF                          #FUN-950094 mark
 
   IF g_apa.apa00 = '11' AND g_apa.apa51 <> 'UNAP' AND g_apa.apa56 <> '5' THEN #No.TQC-7C0140     #MOD-970115  
      SELECT COUNT(*) INTO g_cnt FROM apb_file WHERE apb01 = g_apa.apa01
      IF g_cnt = 0 THEN
        #CALL cl_err(g_apa.apa01,'arm-034',1) #CHI-A80031 mark
         CALL s_errmsg('apa01',g_apa.apa01,'','arm-034',1) #CHI-A80031
         LET g_success='N'
        #RETURN #CHI-A80031 mark
      END IF
   END IF
   SELECT gec05 INTO l_gec05 FROM gec_file                                                                                          
    WHERE gec01 = g_apa.apa15                                                                                                       
   IF (g_apa.apa58 = '3' OR g_apa.apa58 = '2') AND g_apa.apa00='21' AND l_gec05 != 'X' AND g_aza.aza26 <> '2' THEN #MOD-940079  #No.FUN-990017
      DECLARE apb_cur CURSOR FOR 
        SELECT apb11 FROM apb_file where apb01=g_apa.apa01
      FOREACH apb_cur INTO l_apb11
         IF l_apb11 IS NULL OR l_apb11 = ' ' THEN 
           #CALL cl_err(g_apa.apa01,'mfg-011',0) #CHI-A80031 mark
            CALL s_errmsg('apa01',g_apa.apa01,'','mfg-011',1) #CHI-A80031
            LET g_success = 'N'
           #RETURN #CHI-A80031 mark
         END IF
      END FOREACH
   END IF
 
   LET l_cnt = 0
   SELECT COUNT(*) INTO l_cnt FROM api_file,apa_file
    WHERE api26 = apa01
      AND (apa00 = '16' OR apa00 = '26')
      AND api01 = g_apa.apa01
      AND api02 = '2'
      AND (apa41 IS NULL OR apa41 = 'N')
   IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
   IF l_cnt > 0 THEN
     #CALL cl_err(g_apa.apa01,'aap-343',1)  #CHI-A80031 mark
      CALL s_errmsg('apa01',g_apa.apa01,'','aap-343',1) #CHI-A80031
      LET g_success = 'N'
     #RETURN #CHI-A80031 mark
   END IF

  #-MOD-AC0268-add-
   #CALL t110_sum_apa32() RETURNING l_apa32,l_apa32f      #No.TQC-AC0367 mark 
   CALL t110_sum_apa32_1() RETURNING l_apa32,l_apa32f     #No.TQC-AC0367 mod 
   IF (l_apa32 != g_apa.apa32 OR
     #l_apa32f != g_apa.apa32f) AND g_aptype = '21' THEN #MOD-B60016 mark
      l_apa32f != g_apa.apa32f) AND g_aptype = '21' AND g_aza.aza26 <> '2' THEN #MOD-B60016 
      CALL s_errmsg('apa01',g_apa.apa01,'','aap-212',1) 
      LET g_success = 'N'
   END IF    
  #-MOD-AC0268-end-

  #CHI-B10042 add --start--
  IF g_action_choice CLIPPED = "confirm" OR #執行 "確認" 功能(非簽核模式呼叫)
     g_action_choice CLIPPED = "insert"  
  THEN
     IF g_apa.apamksg='Y' THEN
        IF g_apa.apa63 != '1' THEN
           CALL s_errmsg('apa01',g_apa.apa01,'','aws-078',1) 
           LET g_success = 'N'
        END IF
     END IF
  END IF
  #CHI-B10042 add --end--
END FUNCTION
 
FUNCTION t110_firm1_upd()
   DEFINE only_one,l_sw         LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_amt,l_amt1,l_amt2   LIKE type_file.num20_6,   # No.FUN-690028 DEC(20,6),  #FUN-4B0079
          l_apk                 RECORD LIKE apk_file.*,
          l_apv                 RECORD LIKE apv_file.*,   #MOD-850301 add
          l_apa                 RECORD LIKE apa_file.*,   #MOD-850301 add
          l_apc                 RECORD LIKE apc_file.*,   #MOD-850301 add
          i,j                   LIKE type_file.num5,    #No.FUN-690028 SMALLINT
          l_cmd                 LIKE type_file.chr1000 #No.FUN-690028 VARCHAR(200)
   DEFINE l_apydmy3             LIKE apy_file.apydmy3,    # No.FUN-690028 VARCHAR(1),
          l_apb14               LIKE apb_file.apb14,
          l_apb14f              LIKE apb_file.apb14f,
          l_apa01               LIKE apa_file.apa01,
          l_apa41               LIKE apa_file.apa41,
          l_apa34               LIKE apa_file.apa34,
          l_apa34f              LIKE apa_file.apa34f
   DEFINE l_arr1 DYNAMIC ARRAY OF LIKE apk_file.apk01    #FUN-660117
   DEFINE l_arr2 DYNAMIC ARRAY OF RECORD             
                    invoice    LIKE apk_file.apk03,                #FUN-660117
                    apa58      LIKE apa_file.apa58,
                    amt1       LIKE type_file.num20_6,  # No.FUN-690028 DEC(20,6),  #FUN-4B0079
                    amt2       LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
                 END RECORD
   DEFINE g_apa61              LIKE apa_file.apa61      #FUN-4B0079
   DEFINE l_api05              LIKE api_file.api05
   DEFINE g_t1                 LIKE oay_file.oayslip    #FUN-580012  #No.FUN-690028 VARCHAR(05)
   DEFINE l_flag               LIKE type_file.chr1      #No.FUN-690028 VARCHAR(1)
   DEFINE l_yy,l_mm            LIKE type_file.num5      #No.FUN-690028 SMALLINT
   DEFINE l_cnt                LIKE type_file.num10     #No.FUN-690028 INTEGER
   DEFINE l_cnt1               LIKE type_file.num10     #No.TQC-7B0083
   DEFINE l_n                  LIKE type_file.num5      #No.FUN-690028 SMALLINT
   DEFINE l_amt3,l_amt4        LIKE type_file.num20_6   #MOD-6B0051
   DEFINE l_apb10              LIKE apb_file.apb10      #FUN-680010
   DEFINE l_wc                 STRING                   #No.MOD-7A0006
   DEFINE l_gec05              LIKE gec_file.gec05      #MOD-940079  
   DEFINE l_apa44              LIKE apa_file.apa44      #MOD-C50093 add
   DEFINE l_arr_i              LIKE type_file.num5      #MOD-C50093 add
   DEFINE l_arr_cnt            LIKE type_file.num5      #MOD-C50093 add
   DEFINE l_apa01_arr  DYNAMIC ARRAY OF RECORD          #MOD-C50093 add
                          apa01   LIKE apa_file.apa01   #MOD-C50093 add
                       END RECORD                       #MOD-C50093 add
   DEFINE l_t1     LIKE oay_file.oayslip  #FUN-C70075 add
   DEFINE l_apykind LIKE apy_file.apykind #FUN-C70075 add
   DEFINE l_apydmy4 LIKE apy_file.apydmy4 #FUN-C70075 add
   DEFINE li_result LIKE type_file.chr1  #FUN-C70075 add
   DEFINE l_flag1               LIKE type_file.chr1        #yinhy140102
   LET g_success = 'Y'
   LET g_totsuccess='Y' #CHI-A80031 add
   LET only_one = '1'
   LET l_arr_i = 1                                      #MOD-C50093 add
   #FUN-C70075--add--str
   LET l_t1 = s_get_doc_no(g_apa.apa01)
   SELECT apykind,apydmy4 INTO l_apykind,l_apydmy4 FROM apy_file where apyslip = l_t1
   LET gs_cnt = 0
   LET gs_cnt2 = 0
   SELECT COUNT(*) INTO gs_cnt 
     FROM apb_file 
    WHERE apb01 = g_apa.apa01 
      AND (apb34 = 'N' OR apb34 IS NULL) 
   SELECT COUNT(*) INTO gs_cnt2 
     FROM apb_file                           
    WHERE apb01 = g_apa.apa01 
      AND apb34 = 'Y'
   LET g_apa80 = ''
  #--------------------MOD-D30068------------(S)
   IF gs_cnt2 = 0 AND g_apa.apa56 = '5' THEN
      LET gs_cnt2 = 1
   END IF
  #--------------------MOD-D30068------------(E)
  #IF (l_apykind = '11' OR l_apykind = '12') AND gs_cnt2 >0 THEN    #MOD-CB0126 mark
   IF gs_cnt2 > 0 THEN                                              #MOD-CB0126 add
       IF cl_null(l_apydmy4) THEN 
          CALL cl_err('','aap-419',1)
          LET g_success = 'N'
          RETURN
       ELSE
          CALL s_auto_assign_no("aap",l_apydmy4,g_apa.apa02,'33',"apa_file","apa01","","","")
             RETURNING li_result,g_apa80
          IF (NOT li_result) THEN
             CALL cl_err('','asf-377',1)
             LET g_success = 'N'
             RETURN
          END IF        
       END IF
   END IF  
   #FUN-C70075--add--end
  
   IF g_action_choice CLIPPED = "confirm" OR #執行 "確認" 功能(非簽核模式呼叫)
      g_action_choice CLIPPED = "insert"     #FUN-640240
   THEN
      IF g_action_choice CLIPPED = "insert" THEN    #CHI-B10042 add
         IF g_apa.apamksg='Y' THEN
               IF g_apa.apa63 != '1' THEN
                     CALL cl_err('','aws-078',1)
                     LET g_success = 'N'
                     RETURN
               END IF
         END IF
      END IF #CHI-B10042 add
 
       OPEN WINDOW t110_w6 AT 8,18 WITH FORM "aap/42f/aapt110_6"
             ATTRIBUTE (STYLE = g_win_style CLIPPED) #No.FUN-580092 HCN
 
        CALL cl_ui_locale("aapt110_6")
 
       LET only_one = '1'
       CALL cl_set_head_visible("","YES")     #No.FUN-6B0033
 
       INPUT BY NAME only_one WITHOUT DEFAULTS
          AFTER FIELD only_one
             IF NOT cl_null(only_one) THEN
                IF only_one NOT MATCHES "[12]" THEN
                   NEXT FIELD only_one
                END IF
             END IF
          ON IDLE g_idle_seconds
             CALL cl_on_idle()
             CONTINUE INPUT
 
          ON ACTION about         #MOD-4C0121
             CALL cl_about()      #MOD-4C0121
 
          ON ACTION help          #MOD-4C0121
             CALL cl_show_help()  #MOD-4C0121
 
          ON ACTION controlg      #MOD-4C0121
             CALL cl_cmdask()     #MOD-4C0121
 
       END INPUT
 
       IF INT_FLAG THEN
          LET INT_FLAG = 0
          LET g_success = 'N'
          CLOSE WINDOW t110_w6
          RETURN
       END IF
   END IF
 
   IF only_one = '1' THEN
      LET g_wc = " apa01 = '",g_apa.apa01,"' "
   ELSE
      CALL cl_set_head_visible("","YES")     #No.FUN-6B0033
 
      CONSTRUCT BY NAME g_wc ON apa01,apa02,apa21,apa22,apa06
 
            BEFORE CONSTRUCT
               CALL cl_qbe_init()
 
         ON ACTION CONTROLP
           CASE
              WHEN INFIELD(apa01) #查詢單据
                 LET g_t1=s_get_doc_no(g_apa.apa01)
                 CALL q_apy(TRUE,FALSE,g_t1,g_aptype,'AAP') RETURNING g_t1  #TQC-670008
                 LET g_apa.apa01=g_t1
                 DISPLAY BY NAME g_apa.apa01
                 NEXT FIELD apa01
              WHEN INFIELD(apa06) #PAY TO VENDOR
                 CALL cl_init_qry_var()
                 LET g_qryparam.state = "c"
                 LET g_qryparam.form ="q_pmc"  #MOD-960121  
                 CALL cl_create_qry() RETURNING g_qryparam.multiret
                 DISPLAY g_qryparam.multiret TO apa06
                 CALL t110_apa06('d')
              WHEN INFIELD(apa21) # Employee CODE
                 CALL cl_init_qry_var()
                 LET g_qryparam.state = "c"
                 LET g_qryparam.form ="q_gen"
                 CALL cl_create_qry() RETURNING g_qryparam.multiret
                 DISPLAY g_qryparam.multiret TO apa21
              WHEN INFIELD(apa22) # Dept CODE
                 CALL cl_init_qry_var()
                 LET g_qryparam.state = "c"
                 LET g_qryparam.form ="q_gem"
                 CALL cl_create_qry() RETURNING g_qryparam.multiret
                 DISPLAY g_qryparam.multiret TO apa22
              OTHERWISE EXIT CASE
           END CASE
         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE CONSTRUCT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
                 ON ACTION qbe_select
         	   CALL cl_qbe_select()
                 ON ACTION qbe_save
		   CALL cl_qbe_save()
		#No.FUN-580031 --end--       HCN
      END CONSTRUCT
 
      IF INT_FLAG THEN
         LET INT_FLAG=0
         LET g_success = 'N'
         CLOSE WINDOW t110_w6
         RETURN
      END IF
   END IF
 
  #-MOD-B10239-add-
   IF g_apz.apz27 = 'N' THEN
      LET g_sql = "SELECT SUM(apa34-apa35-(apa20*apa14)) FROM apa_file",   
                  " WHERE apa41 = 'N' AND apa42 !='Y' AND ",
                  " apa00='",g_aptype,"' AND ",g_wc CLIPPED
   ELSE
      LET g_sql = "SELECT SUM(apa73-(apa20*apa72)) FROM apa_file",   
                  " WHERE apa41 = 'N' AND apa42 !='Y' AND ",
                  " apa00='",g_aptype,"' AND ",g_wc CLIPPED
   END IF
   PREPARE t110_firm1_p2 FROM g_sql
   DECLARE t110_firm1_c2 CURSOR FOR t110_firm1_p2
   OPEN t110_firm1_c2
   FETCH t110_firm1_c2 INTO l_amt
   IF cl_null(l_amt) THEN LET l_amt = 0 END IF
   DISPLAY BY NAME l_amt
  #-MOD-B10239-end-

   IF g_action_choice CLIPPED = "confirm" OR #執行 "確認" 功能(非簽核模式呼叫)
      g_action_choice CLIPPED = "insert"     #FUN-640240
   THEN
       IF NOT cl_confirm('aap-222') THEN
          LET g_success = 'N'
          CLOSE WINDOW t110_w6            #TQC-5B0016
          RETURN
       END IF
#CHI-C30107 -------------- add ------------- begin #TQC-C60212
      IF only_one = '1' THEN 
         SELECT * INTO g_apa.* FROM apa_file WHERE apa01 = g_apa.apa01
         CALL t110_firm1_chk()
      END IF
#CHI-C30107 -------------- add ------------- end

   END IF
 
  #-MOD-B10239-mark-
  #IF g_apz.apz27 = 'N' THEN
  #   LET g_sql = "SELECT SUM(apa34-apa35-(apa20*apa14)) FROM apa_file",   #TQC-780065
  #               " WHERE apa41 = 'N' AND apa42 !='Y' AND ",
  #               " apa00='",g_aptype,"' AND ",g_wc CLIPPED
  #ELSE
  #   LET g_sql = "SELECT SUM(apa73-(apa20*apa72)) FROM apa_file",   #TQC-780065
  #               " WHERE apa41 = 'N' AND apa42 !='Y' AND ",
  #               " apa00='",g_aptype,"' AND ",g_wc CLIPPED
  #END IF
  #PREPARE t110_firm1_p2 FROM g_sql
 
  #DECLARE t110_firm1_c2 CURSOR FOR t110_firm1_p2
 
  #OPEN t110_firm1_c2
  #FETCH t110_firm1_c2 INTO l_amt
 
  #IF cl_null(l_amt) THEN
  #   LET l_amt = 0
  #END IF
  #DISPLAY BY NAME l_amt
  #-MOD-B10239-end-
   CALL cl_msg("WORKING !")                                       #FUN-640240
   LET g_sql = "SELECT * FROM apa_file",  #85-09-24
               " WHERE apa00='",g_aptype,"' AND ",g_wc CLIPPED,
               "   AND apa41 = 'N' AND apa42!='Y'"
 
   PREPARE t110_firm1_p3 FROM g_sql
 
   DECLARE t110_firm1_c3 CURSOR FOR t110_firm1_p3
 
   LET g_flag='0'
   BEGIN WORK
   CALL t110_lock_cl()  #FUN-C80078 add 
   OPEN t110_cl USING g_apa.apa01
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl firm1:", STATUS, 1)
      LET g_success='N'
      CLOSE t110_cl
      ROLLBACK WORK
      CLOSE WINDOW t110_w6    #TQC-5B0016
      RETURN
   END IF
 
   FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
       CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
       CLOSE t110_cl
       ROLLBACK WORK
       CLOSE WINDOW t110_w6
       RETURN
   END IF
   IF g_aptype = '13' THEN
      IF g_apa.apa37f > 0 THEN
         IF cl_null(g_apa.apa101) OR cl_null(g_apa.apa102) THEN
            CALL cl_err(g_apa.apa01,'aap-095',1)
            CLOSE t110_cl
            ROLLBACK WORK
            CLOSE WINDOW t110_w6
            CALL t110_upd_apa101()
            RETURN
         END IF
         #產生銀行異動記錄檔
         CALL t110_ins_nme_1()
         IF g_success = 'N' THEN
            CLOSE t110_cl
            ROLLBACK WORK
            CLOSE WINDOW t110_w6
            RETURN
         END IF
      END IF
   END IF
   LET l_flag = 0   #MOD-590301
   LET l_flag1 = 0  #yinhy140102   #yinhy140102
   LET g_apa01_t = g_apa.apa01     #保留舊值 #CHI-A80031 add   
   FOREACH t110_firm1_c3 INTO m_apa.*           #-->逐筆確認
     IF STATUS THEN
       #CALL cl_err('foreah',STATUS,1) #CHI-A80031 mark
        CALL s_errmsg('','','foreach',STATUS,1) #CHI-A80031
        LET g_success='N'
        LET g_totsuccess='N' #CHI-A80031 add
       #EXIT FOREACH #CHI-A80031 mark
        CONTINUE FOREACH #CHI-A80031
     ELSE    #MOD-590301
        LET l_flag = 1    #MOD-590301
     END IF
     
     #CHI-A80031 add --start--
     LET g_apa.apa01=m_apa.apa01
     IF only_one = '2' THEN   #CHI-B60063 add
        CALL t110_firm1_chk()
     END IF                   #CHI-B60063 add
     #CHI-A80031 add --end--
 
     #單頭原幣若 = 0 ，不可確認。
     IF m_apa.apa00 = '21' THEN
       #IF m_apa.apa34f = 0 THEN                    #CHI-B60063 mark
        IF m_apa.apa34f = 0 AND g_flag2 = 'Y' THEN  #CHI-B60063
           LET g_success='N'
           LET g_totsuccess='N' #CHI-A80031 add
           CONTINUE FOREACH
        END IF
     END IF
 
     #FUN-B50090 add begin-------------------------
     #重新抓取關帳日期
     SELECT apz57 INTO g_apz.apz57 FROM apz_file WHERE apz00='0'
     #FUN-B50090 add -end--------------------------
     IF m_apa.apa02 <= g_apz.apz57 THEN
        DISPLAY "m_apa.apa02=",m_apa.apa02
        DISPLAY "g_apz.apz57=",g_apz.apz57
       #CALL cl_err(m_apa.apa01,'aap-176',1) #CHI-A80031 mark
        CALL s_errmsg('apa01',m_apa.apa01,'','aap-176',1) #CHI-A80031
        LET g_success = 'N'
        LET g_totsuccess='N' #CHI-A80031 add
       #EXIT FOREACH #CHI-A80031 mark
        CONTINUE FOREACH #CHI-A80031
     END IF
 
     IF g_apa.apa00 = '11' AND g_apa.apa51 <> 'UNAP' AND g_apa.apa56 <> '5' THEN   #MOD-970115  
        SELECT COUNT(*) INTO g_cnt FROM apb_file WHERE apb01 = m_apa.apa01
        IF g_cnt = 0 THEN
          #CALL cl_err(m_apa.apa01,'arm-034',1) #CHI-A80031 mark
           CALL s_errmsg('apa01',m_apa.apa01,'','arm-034',1) #CHI-A80031
           LET g_success='N'
           LET g_totsuccess='N' #CHI-A80031 add
          #EXIT FOREACH #CHI-A80031 mark
           CONTINUE FOREACH #CHI-A80031
        END IF
     END IF
 
     LET l_amt1 = 0
     LET l_amt2 = 0
      FOR i = 1 TO 1000                 #No.MOD-480131
         LET l_arr1[i] = ' '
         LET l_arr2[i].invoice = ' '
         LET l_arr2[i].apa58   = ' '
         LET l_arr2[i].amt1    = 0
         LET l_arr2[i].amt2    = 0
     END FOR
 
     LET j = 1
     LET i = 0
     LET g_cnt = 0
 
     IF m_apa.apa00[1,1]='1' AND m_apa.apa08 = 'MISC' THEN
        SELECT COUNT(*) INTO g_cnt FROM apk_file WHERE apk01 = m_apa.apa01
        IF g_cnt = 0 THEN
          #CALL cl_err('','aap-907',1) #CHI-A80031 mark
           CALL s_errmsg('','','','aap-907',1) #CHI-A80031
           LET g_success='N'
           LET g_totsuccess='N' #CHI-A80031 add
          #EXIT FOREACH #CHI-A80031 mark
           CONTINUE FOREACH #CHI-A80031
        END IF
     END IF
 
     IF m_apa.apa00[1,1] = '1' THEN
        IF m_apa.apa60 > 0 AND g_apz.apz60 = 'Y' THEN
           SELECT COUNT(*) INTO g_cnt FROM apa_file
            WHERE apa00 = '21'
              AND apa08 = g_apa.apa01
           IF g_cnt > 0 THEN
              IF cl_confirm('aap-314') THEN
                 LET g_flag='1'
              END IF
           END IF
 
           IF g_cnt=0 THEN
              LET g_flag='2'
           END IF
 
           IF g_flag MATCHES '[12]' THEN
              CALL t110_21_ins(m_apa.*)
              IF INT_FLAG OR g_success='N' THEN
                 LET g_success = 'N'
                 LET g_totsuccess='N' #CHI-A80031 add
                #CALL cl_err(m_apa.apa01,'aap-013',1) #CHI-A80031 mark
                 CALL s_errmsg('apa01',m_apa.apa01,'','aap-013',1) #CHI-A80031
                #EXIT FOREACH #CHI-A80031
                 CONTINUE FOREACH #CHI-A80031
              END IF
           END IF
        END IF
     END IF
 
    #CHI-A40005 mark --start--
    #LET l_cnt = 0
    #SELECT COUNT(*) INTO l_cnt FROM apk_file
    #  WHERE apk01 = m_apa.apa01
    #IF (m_apa.apa00= '21' AND  m_apa.apa58 = '3') OR 
    #   (m_apa.apa00= '21' AND  m_apa.apa58 = '2' AND 
    #    m_apa.apa08 <> 'UNAP' AND l_cnt = 0 ) THEN
       SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01 = m_apa.apa15  #MOD-C40225 remark                                                             
    #  IF l_gec05 != 'X' AND g_aza.aza26 <> '2' THEN    #No.FUN-990017
    #   CALL t110_21_ins2(m_apa.*)
    #   IF g_success='N' THEN
    #      LET g_success = 'N'
    #      CALL cl_err(m_apa.apa01,'aap-013',1)
    #      EXIT FOREACH
    #   END IF
    #  END IF #MOD-940079
    #END IF
    #CHI-A40005 mark --end--
 
     IF m_apa.apa00[1,1] = '1' THEN
       #本幣折讓扣款金額,請款折讓
        IF m_apa.apa60 > 0 THEN
           SELECT SUM(apb14f),SUM(apb14) INTO l_apb14f,l_apb14 FROM apb_file
            WHERE apb01=m_apa.apa01
 
           IF cl_null(l_apb14f) THEN
              LET l_apb14f = 0
           END IF
 
           IF cl_null(l_apb14 ) THEN
              LET l_apb14  = 0
           END IF
 
           LET l_apb14f = cl_digcut(l_apb14f,t_azi04)   #MOD-6B0066
           LET l_apb14  = cl_digcut(l_apb14 ,g_azi04)   #MOD-6B0066
 
           IF m_apa.apa33 != l_apb14 OR m_apa.apa33f !=l_apb14f THEN
              LET g_success = 'N'
              LET g_totsuccess = 'N' #CHI-A80031 add
             #CALL cl_err(m_apa.apa01,'aap-159',1) #CHI-A80031 mark
              CALL s_errmsg('apa01',m_apa.apa01,'','aap-159',1) #CHI-A80031
             #EXIT FOREACH #CHI-A80031 mark
              CONTINUE FOREACH #CHI-A80031
           END IF
        END IF
 
        IF m_apa.apa60 > 0 AND g_apz.apz60='Y' THEN
           DECLARE z1_curs CURSOR FOR        ## 可能多發票
            SELECT apk03,SUM(apk07+apk08) FROM apk_file
          #  WHERE apk01 = m_apa.apa01 AND apk171 IN ('21','22','25')       #MOD-9C0454 mark
             WHERE apk01 = m_apa.apa01 AND apk171 IN ('21','22','25','XX')  #MOD-9C0454
             GROUP BY apk03
            #發票金額由大至小,為免多發票:折讓金額大於第一張發票金額
             ORDER BY 2 DESC
 
           FOREACH z1_curs INTO l_apk.apk03,l_apk.apk07
              IF STATUS THEN
                 EXIT FOREACH
              END IF                         ## 原發票金額
 
              LET i = i + 1
              LET l_arr2[i].invoice = l_apk.apk03
              LET l_arr2[i].amt1    = l_apk.apk07
              #----折讓單之CHECK--------
 
              DECLARE z2_curs CURSOR FOR   ## get multi allowence,discount #
               SELECT apk01,apa58,SUM(apk07+apk08) FROM apa_file,apk_file
             #  WHERE apk03 = l_apk.apk03 AND apk171 IN ('23','24')       #MOD-9C0454 mark
                WHERE apk03 = l_apk.apk03 AND apk171 IN ('23','24','XX')  #MOD-9C0454
                  AND apa01 = apk01
                  AND apa00 MATCHES '2*'                                  #MOD-A70229 
                GROUP BY apk01,apa58         ## 不使用 apk26 ,因為1發票 -> M 折讓
 
              FOREACH z2_curs INTO l_apk.apk01,l_sw,l_apk.apk07
                   IF STATUS THEN
                      EXIT FOREACH
                   END IF
 
                   LET l_arr2[i].amt2 = l_arr2[i].amt2 + l_apk.apk07
                   LET l_amt2 = l_amt2 + l_arr2[i].amt2
 
                   IF l_sw = '1' THEN
                      LET l_amt1 = l_amt1+ l_arr2[i].amt2
                   END IF
 
                    FOR j = 1 TO 1000                  #No.MOD-480131
                       IF cl_null(l_arr2[j].apa58) THEN
                          IF l_sw = '1' THEN
                             LET l_arr1[j] = l_apk.apk01
                             LET g_cnt = g_cnt + 1
                          END IF
                          LET l_arr2[j].apa58 = l_sw
                          EXIT FOR
                       END IF
 
                       IF l_arr1[j] = l_apk.apk01 THEN
                          EXIT FOR
                       END IF
                   END FOR
              END FOREACH
           END FOREACH
 
           LET g_apa61 = m_apa.apa61
 
           IF (m_apa.apa60+g_apa61) > l_amt1 THEN
             #CALL cl_err('','aap-037',0)                  #No:MOD-510140 #CHI-A80031 mark
              CALL s_errmsg('','','','aap-037',1) #CHI-A80031
              LET g_success = 'N' EXIT FOREACH #CHI-A80031 mark
              LET g_success = 'N' #CHI-A80031 add
              LET g_totsuccess = 'N' #CHI-A80031 add
              CONTINUE FOREACH #CHI-A80031
           END IF
 
            FOR i = 1 TO 1000                #No.MOD-480131
               IF l_arr2[i].amt1 = 0 THEN
                  EXIT FOR
               END IF
 
               IF l_arr2[i].amt1 < l_arr2[i].amt2 THEN
                  LET l_apk.apk01 = ' '
                  DECLARE z9_curs CURSOR FOR
                   SELECT apa01 FROM apa_file,apk_file
                 #  WHERE apk03 = l_arr2[i].invoice AND apk171 IN ('23','24')       #MOD-9C0454 mark
                    WHERE apk03 = l_arr2[i].invoice AND apk171 IN ('23','24','XX')  #MOD-9C0454
                      AND apa01 = apk01
                      AND apa41 = 'N'
 
                  OPEN z9_curs
 
                  FETCH z9_curs INTO l_apk.apk01
 
                  CLOSE z9_curs
 
                 #CALL cl_err(l_apk.apk01,'aap-045',0)     #No:MOD-510140 #CHI-A80031 mark
                  CALL s_errmsg('apk01',l_apk.apk01,'','aap-045',1) #CHI-A80031
                  LET g_success = 'N'
                  LET g_totsuccess = 'N' #CHI-A80031 add
                 #EXIT FOREACH #CHI-A80031 mark
                  CONTINUE FOREACH #CHI-A80031
               END IF
           END FOR
 
            FOR i = 1 TO 1000                      #No.MOD-480131
               IF cl_null(l_arr2[i].apa58) THEN
                  EXIT FOR
               END IF
 
               IF l_arr2[i].apa58 <> '1' THEN   ## 非請款折讓(系統產生)
                  CONTINUE FOR
               END IF
 
               IF g_cnt > 1 OR   ## 1 請款單 -> M折讓單(apa58 = '1')
                  (m_apa.apa60 + m_apa.apa61) = l_amt1 THEN
                                    ## 1 SP -> 1 SL(apa58 = '1')
                  CALL t110_comp_oox(l_arr1[i]) RETURNING g_net              #CHI-890017 add
                  UPDATE apa_file SET apa35f=apa34f,apa35=apa34,apa73=g_net  #CHI-890017
                   WHERE apa01 = l_arr1[i] AND apa41 = 'Y'
                  IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] = 0 THEN
                    #CALL cl_err3("upd","apa_file",l_arr1[i],"","aap-046","","",1)  #No.FUN-660122 #CHI-A80031 mark
                     CALL s_errmsg('',l_arr1[i],'upd apa_file','aap-046',1) #CHI-A80031
                     LET g_success = 'N'
                     LET g_totsuccess = 'N' #CHI-A80031 mark
                    #EXIT FOREACH #CHI-A80031 mark
                     CONTINUE FOREACH #CHI-A80031
                  END IF
               END IF
 
               IF g_cnt = 1 AND (m_apa.apa60+m_apa.apa61) < l_amt1 THEN
                  CALL t110_comp_oox(l_arr1[i]) RETURNING g_net
                  UPDATE apa_file SET apa35f=apa35f+ m_apa.apa60f
                                                   + m_apa.apa61f ,
                                      apa35 =apa35 + m_apa.apa60
                                                   + m_apa.apa61,
                                      apa73 =apa34 -(apa35+m_apa.apa60      #No.MOD-4C0008
                                                          +m_apa.apa61) 
                                                   + g_net
                   WHERE apa01 = l_arr1[i] AND apa41 = 'Y'
                  IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] = 0 THEN
                    #CALL cl_err3("upd","apa_file",l_arr1[i],"","app-047","","",1)  #No.FUN-660122 #CHI-A80031 mark
                     CALL s_errmsg('',l_arr1[i],'upd apa_file','aap-047',1) #CHI-A80031
                     LET g_success = 'N'
                     LET g_totsuccess = 'N' #CHI-A80031 add
                    #EXIT FOREACH #CHI-A80031 mark
                     CONTINUE FOREACH #CHI-A80031
                  END IF
               END IF
           END FOR
        END IF
     ELSE
        DECLARE z3_curs CURSOR FOR
         SELECT UNIQUE apk03 FROM apk_file
          WHERE apk01 = m_apa.apa01 AND apk171 IN ('23','24','29','XX')   #MOD-6B0051
 
        FOREACH z3_curs INTO l_apk.apk03
           IF cl_null(l_apk.apk03) THEN
              CONTINUE FOREACH
           END IF
           IF STATUS THEN
              EXIT FOREACH
           END IF                      ## 可能一發票折多次,故須判斷其他 SL
 
           SELECT SUM(apk07+apk08) INTO l_arr2[1].amt1 FROM apk_file
            WHERE apk03 = l_apk.apk03 AND apk171 IN ('23','24','29')   #MOD-6B0051
           IF STATUS <> 0 OR l_arr2[1].amt1 IS NULL THEN
              LET l_arr2[1].amt1 = 0
           END IF
           SELECT SUM(apk07+apk08) INTO l_amt3 FROM apk_file,apa_file
            WHERE apk03 = l_apk.apk03 AND apk171 = 'XX' AND
                  apk01 = apa01 AND apa00 MATCHES "2*"
           IF STATUS <> 0 OR l_amt3 IS NULL THEN
              LET l_amt3 = 0
           END IF
           LET l_arr2[1].amt1 = l_arr2[1].amt1 + l_amt3
 
          SELECT COUNT(*) INTO l_cnt FROM apk_file
            WHERE apk03=l_apk.apk03 AND apk171 IN ('21','22','25','28','XX')   #MOD-6B0051
          IF l_cnt > 0 THEN
             ## 原發票金額
             SELECT SUM(apk07+apk08) INTO l_arr2[1].amt2 FROM apk_file
               WHERE apk03 = l_apk.apk03 AND apk171 IN ('21','22','25','28')   #MOD-6B0051
 
             IF STATUS <> 0 OR l_ARR2[1].amt2 IS NULL THEN
                LET l_arr2[1].amt2 = 0
             END IF
             SELECT SUM(apk07+apk08) INTO l_amt4 FROM apk_file,apa_file
              WHERE apk03 = l_apk.apk03 AND apk171 = 'XX' AND
                    apk01 = apa01 AND apa00 MATCHES "1*"
             IF STATUS <> 0 OR l_amt4 IS NULL THEN
                LET l_amt4 = 0
             END IF
             LET l_arr2[1].amt2 = l_arr2[1].amt2 + l_amt4
          ELSE
             SELECT SUM(amd07+amd08) INTO l_arr2[1].amt2 FROM amd_file
              WHERE amd03 = l_apk.apk03 AND amd171 IN ('21','22','25','28')   #MOD-6B0051
             IF STATUS <> 0 OR l_ARR2[1].amt2 IS NULL THEN
                LET l_arr2[1].amt2 = 0
             END IF
          END IF
 
 
          IF g_aza.aza26 !='2' THEN   #No.TQC-790158 ---add----
             IF l_arr2[1].amt1 > l_arr2[1].amt2 THEN
                IF m_apa.apa00<>'21' OR l_gec05 !='X' THEN                                                                          
                  #CALL cl_err(l_apk.apk03,'aap-052',0)  #CHI-A80031 mark
                   CALL s_errmsg('apk03',l_apk.apk03,'','aap-052',1) #CHI-A80031
                   LET g_success = 'N'
                   LET g_totsuccess = 'N'  #CHI-A80031 add
                  #EXIT FOREACH #CHI-A80031 mark
                   CONTINUE FOREACH #CHI-A80031                                                                                                 
                ELSE                                                                                                                
                   LET l_cnt=0                                                                                                      
                   SELECT COUNT(*) INTO l_cnt FROM apa_file,apb_file                                                                
                    WHERE apa01=apb01 AND apa01=m_apa.apa01                                                                         
                      AND apb06 IS NOT NULL                                                                                         
                  #IF l_cnt<>0 THEN                   #MOD-C40225 mark
                   IF l_cnt=0 AND l_gec05 ='X'  THEN  #MOD-C40225                                                                                                 
                     #CALL cl_err(l_apk.apk03,'aap-052',0)    #CHI-A80031 mark
                      CALL s_errmsg('apk03',l_apk.apk03,'','aap-052',1) #CHI-A80031
                      LET g_success = 'N'
                      LET g_totsuccess = 'N'  #CHI-A80031 add
                     #EXIT FOREACH #CHI-A80031 mark
                      CONTINUE FOREACH #CHI-A80031                                                                              
                   END IF                                                                                                           
                END IF            
             END IF
          END IF   #No.TQC-790158 ---add----
        END FOREACH
 
        IF g_success = 'N' THEN
          #EXIT FOREACH #CHI-A80031 mark
           CONTINUE FOREACH #CHI-A80031
        END IF
     END IF
 
     IF m_apa.apa20 > (m_apa.apa34f - m_apa.apa35f) THEN
       #CALL cl_err(m_apa.apa01,'aap-150',0) #CHI-A80031 mark
        CALL s_errmsg('apa01',m_apa.apa01,'','aap-150',1) #CHI-A80031
        LET g_success = 'N'
        LET g_totsuccess = 'N'  #CHI-A80031 add
       #EXIT FOREACH #CHI-A80031 mark
        CONTINUE FOREACH #CHI-A80031
     END IF
 
     #檢查分錄底稿平衡正確否
     LET g_t1=s_get_doc_no(g_apa.apa01)
     SELECT * INTO g_apy.* FROM apy_file WHERE apyslip=g_t1
    #IF g_apy.apydmy3 = 'Y' THEN                     #MOD-940069   #CHI-B60063 mark
     IF g_apy.apydmy3 = 'Y' AND g_flag2 = 'Y' THEN   #MOD-940069   #CHI-B60063
      #IF g_apa.apa58 <> '1' THEN                           #TQC-C90078 add #MOD-CB0128 mark
       IF g_apa.apa58 <> '1' OR cl_null(g_apa.apa58) THEN   #MOD-CB0128 add
          CALL s_chknpq(m_apa.apa01,'AP',1,'0',g_bookno1)     #No.FUN-680029    #No.FUN-730064
          IF g_aza.aza63 ='Y' AND g_success ='Y' THEN
             CALL s_chknpq(m_apa.apa01,'AP',1,'1',g_bookno2)     #No.FUN-730064 
          END IF
       END IF                    #TQC-C90078 add
     END IF
 
     IF g_success = 'N' THEN
       #EXIT FOREACH #CHI-A80031 mark
       CONTINUE FOREACH #CHI-A80031
     END IF
 
     IF NOT (g_aptype = '13' OR g_aptype = '17') THEN
        #--------------------------------- 請採購預算控管 00/03/30 By Melody
        IF g_apy.apydmy5='Y' AND g_apa.apa00[1,1]='1' AND g_success='Y' THEN
           CALL t110_budchk()
           IF g_aza.aza63 ='Y' AND g_success ='Y' THEN
              CALL t110_budchk_1()
           END IF
        END IF
     END IF
 
     IF g_success = 'N' THEN
       #EXIT FOREACH #CHI-A80031 mark
       CONTINUE FOREACH #CHI-A80031
     END IF
 
     #----------------------------------- 預付待抵產生 96-10-07
     IF m_apa.apa00= '15' OR m_apa.apa00 = '17' THEN  #No.FUN-690080
        CALL t110_ins_prepaid()
     END IF
 
     #除了非沖暫估且不直接付款的情況,其於皆要insert apf_file
     LET l_cnt1 =0
     SELECT COUNT(*) INTO l_cnt1 FROM apb_file
      WHERE apb01 = m_apa.apa01
        AND apb34 = 'Y' 
     IF cl_null(l_cnt1) THEN LET l_cnt1 = 0 END IF
     IF m_apa.apa51 = 'UNAP' OR m_apa.apa55 = '2' OR l_cnt1 > 0 OR m_apa.apa56 = '5' THEN  #MOD-8C0067
        CALL t110_ins_apf()
     END IF
 
     #----------------------------------- 沖暫估AP 97-07-19 Roger
     IF m_apa.apa51= 'UNAP' OR l_cnt1 > 0 OR m_apa.apa56 = '5' THEN  #MOD-8C0067
        #no.5902 檢查沖暫估金額是否與單頭金額相等
        SELECT SUM(api05) INTO l_api05 FROM api_file
         WHERE api01 = m_apa.apa01
           AND api02 = '2'   #MOD-850155
 
        IF cl_null(l_api05) THEN
           LET l_api05 = 0
        END IF
 
        LET l_apb10=0
        SELECT SUM(apb10) INTO l_apb10 FROM apb_file
         #WHERE apb01=g_apa.apa01    #MOD-C60166 mark
         WHERE apb01=m_apa.apa01     #MOD-C60166
           AND apb34='N'
        IF cl_null(l_apb10) THEN LET l_apb10=0 END IF
        IF (m_apa.apa31 - m_apa.apa33 ) -l_apb10 != l_api05 THEN #FUN-680010  #No.TQC-7B0083                #MOD-8A0129
           #CALL cl_err(m_apa.apa01,'aap-030',1) #CHI-A80031 mark
            CALL s_errmsg('apa01',m_apa.apa01,'','aap-030',1) #CHI-A80031
            LET g_success='N'
            LET g_totsuccess='N' #CHI-A80031 add
           #EXIT FOREACH #CHI-A80031 mark
            CONTINUE FOREACH #CHI-A80031
        END IF
     END IF
     IF m_apa.apa51 = 'UNAP' OR l_cnt1 > 0 OR m_apa.apa56 = '5' THEN                                #MOD-8C0067
        CALL t110_ins_apg()              #MOD-880080 mark   #TQC-890010 mark回復
     END IF
 
     #----------------------------------- 直接付款沖待抵帳款 97-09-11 Roger
     IF m_apa.apa55='2' THEN
        CALL t110_aph_upd(1)
     END IF
 
    #IF g_apy.apydmy3 = 'Y' AND g_apy.apyglcr = 'Y' THEN                    #CHI-B60063 mark
     IF g_apy.apydmy3 = 'Y' AND g_apy.apyglcr = 'Y' AND g_flag2 = 'Y' THEN  #CHI-B60063
        SELECT COUNT(*) INTO l_n FROM npq_file
         WHERE npq01 = m_apa.apa01
           AND npqsys = 'AP'
           AND npq00 = 1
           AND npq011 = 1
        IF l_n = 0 THEN
           CALL t110_gen_glcr(m_apa.*,g_apy.*)
        END IF
        IF g_success = 'Y' THEN                                                                                                       
          #IF g_apa.apa58 <> '1' THEN                           #TQC-C90078 add #MOD-CB0128 mark
           IF g_apa.apa58 <> '1' OR cl_null(g_apa.apa58) THEN   #MOD-CB0128 add
              CALL s_chknpq(m_apa.apa01,'AP',1,'0',g_bookno1)     #No.FUN-680029   #No.FUN-730064                                   
              IF g_aza.aza63 ='Y' THEN
                 CALL s_chknpq(m_apa.apa01,'AP',1,'1',g_bookno2)    #No.FUN-730064
              END IF
           END IF                    #TQC-C90078 add
        END IF                                                                                                                        
     #-----------------------------------------------MOD-C50093--------------------------------mark
     # #------------------------CHI-C20003---------------------------------------start
     #  IF g_success = 'Y' THEN  
     #    #No.TQC-C20254 Mark
     #    #LET g_wc_gl = " npp01='",g_apa.apa01,"'"
     #    #LET l_wc = g_wc_gl clipped," AND npp011 = 1 "
     #    #LET g_str = "aapp400" ,
     #    #            ' "',l_wc CLIPPED,'"',
     #    #            ' "',g_apa.apauser,'"',  
     #    #            ' "',g_apa.apauser,'"',   
     #    #            ' "',g_apz.apz02p,'" ',
     #    #            ' "',g_apz.apz02b,'" ',
     #    #            ' "',g_apy.apygslp,'" ',
     #    #            ' "',g_apa.apa02,'" ',
     #    #            ' "Y" ',
     #    #            ' "1" ',  
     #    #            ' "Y" ',
     #    #            ' "',g_apz.apz02c,'" ',
     #    #            ' "',g_apy.apygslp1,'" ',
     #    #            ' "Y" '                    
     #    #No.TQC-C20254 Mark
     #    #No.TQC-C20254 Add
     #     LET g_wc_gl = ' npp01="',g_apa.apa01,'"'
     #     LET l_wc = g_wc_gl clipped," AND npp011 = 1 "
     #     LET g_str = "aapp400 '",l_wc CLIPPED,
     #                 "' '",g_apa.apauser,
     #                 "' '",g_apa.apauser,
     #                 "' '",g_apz.apz02p,
     #                 "' '",g_apz.apz02b,
     #                 "' '",g_apy.apygslp,
     #                 "' '",g_apa.apa02,
     #                 "' 'Y' '1' 'Y' '",g_apz.apz02c,
     #                 "' '",g_apy.apygslp1,"' 'Y'"
     #    #No.TQC-C20254 Add
     #     IF cl_null(g_apy.apygslp) THEN
     #        CALL cl_err('aapi103','aap-935',1)
     #        LET g_apa.apa41='N'
     #        LET g_success = 'N'
     #        ROLLBACK WORK
     #     ELSE
     #        IF g_aza.aza63 ='Y' AND cl_null(g_apy.apygslp1) THEN
     #           CALL cl_err('aapi103','aap-942',1)
     #           LET g_apa.apa41='N'
     #           LET g_success = 'N'
     #           ROLLBACK WORK
     #        ELSE
     #           CALL cl_cmdrun(g_str CLIPPED) 
     #        END IF
     #     END IF
     #  END IF
     # #------------------------CHI-C20003------------------------------------------end
       #------MOD-C50093 add
        LET l_apa01_arr[l_arr_i].apa01 = g_apa.apa01
        LET l_arr_i = l_arr_i + 1
     #-----------------------------------------------MOD-C50093--------------------------------mark
     END IF
 
    #IF g_success ='N' THEN EXIT FOREACH END IF           #No.FUN-680029 #CHI-A80031 mark
     IF g_success ='N' THEN CONTINUE FOREACH END IF           #No.FUN-680029 #CHI-A80031
 
     UPDATE apa_file SET apa41 = 'Y',
                         apa63 = '1'    #MOD-590301
      WHERE apa01=m_apa.apa01
     IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
       #CALL cl_err3("upd","apa_file",m_apa.apa01,"",SQLCA.sqlcode,"","up_apa41",1)  #No.FUN-660122 #CHI-A80031 mark
        CALL s_errmsg('apa01',m_apa.apa01,'up_apa41',SQLCA.sqlcode,1) #CHI-A80031
        LET g_success='N'
        LET g_totsuccess='N' #CHI-A80031 add
       #EXIT FOREACH #CHI-A80031 mark
        CONTINUE FOREACH #CHI-A80031
     END IF
     LET l_flag1 = 1   #yinhy140102
   END FOREACH

   LET g_apa.apa01 = g_apa01_t #CHI-A80031 add
   IF l_flag = 0 THEN
      CALL cl_err('',100,1)
      LET g_success = 'N'   #FUN-890128
      LET g_totsuccess = 'N' #CHI-A80031 add
   END IF
   IF INT_FLAG THEN
      LET INT_FLAG=0
   END IF    
   
   #CHI-A80031 add --start--
   IF g_totsuccess = 'N' THEN
      LET g_success = 'N'
   END IF
   #CHI-A80031 add --end--    


   IF l_flag = '1' THEN   #MOD-590301
   IF g_success = 'Y' THEN
      IF g_apa.apamksg = 'Y' THEN #簽核模式
         CASE aws_efapp_formapproval()            #呼叫 EF 簽核功能
              WHEN 0  #呼叫 EasyFlow 簽核失敗
                   LET g_apa.apa41="N"
                   LET g_success = "N"
                   ROLLBACK WORK
                   CLOSE WINDOW t110_w6        #TQC-5B0016
                   RETURN
              WHEN 2  #當最後一關有兩個以上簽核者且此次簽核完成後尚未結案
                   LET g_apa.apa41="N"
                   ROLLBACK WORK
                   CLOSE WINDOW t110_w6    #TQC-5B0016
                   RETURN
         END CASE
      END IF
      #IF g_success='Y' THEN
      IF g_success='Y' OR l_flag1=1 THEN  #yinhy140102  #批量审核有執行成功的情况也应commit
         LET g_apa.apa63='1'              #執行成功, 狀態值顯示為 '1' 已核准
         LET g_apa.apa41='Y'              #執行成功, 確認碼顯示為 'Y' 已確認
         DISPLAY BY NAME g_apa.apa41
         DISPLAY BY NAME g_apa.apa63
         COMMIT WORK
         CALL cl_flow_notify(g_apa.apa01,'Y')
      ELSE
         LET g_apa.apa41='N'
         LET g_success = 'N'
         ROLLBACK WORK
      END IF
   ELSE
      #No.yinhy140102  --Begin
      IF l_flag1=1 THEN
         LET g_apa.apa63='1'              #執行成功, 狀態值顯示為 '1' 已核准
         LET g_apa.apa41='Y'              #執行成功, 確認碼顯示為 'Y' 已確認
         DISPLAY BY NAME g_apa.apa41
         DISPLAY BY NAME g_apa.apa63
         COMMIT WORK
         CALL cl_flow_notify(g_apa.apa01,'Y')
      ELSE
      #No.yinhy140102  --End
        LET g_apa.apa41='N'
        LET g_success = 'N'
        ROLLBACK WORK
      END IF  ##No.yinhy140102 
   END IF
   END IF   #MOD-590301
 
 #------------------------CHI-C20003-移至25030行--------------------------------------mark
  #IF g_apy.apydmy3 = 'Y' AND g_apy.apyglcr = 'Y' AND g_success = 'Y' THEN                    #CHI-B60063 mark
  #IF g_apy.apydmy3 = 'Y' AND g_apy.apyglcr = 'Y' AND g_success = 'Y' AND g_flag2 = 'Y' THEN  #CHI-B60063
  #   LET g_wc_gl = " npp01='",g_apa.apa01,"'"
  #   LET l_wc = g_wc_gl clipped," AND npp011 = 1 "
  #   LET g_str = "aapp400" ,
  #               ' "',l_wc CLIPPED,'"',
  #               ' "',g_apa.apauser,'"',   #MOD-7B0159
  #               ' "',g_apa.apauser,'"',   #MOD-7B0159
  #               ' "',g_apz.apz02p,'" ',
  #               ' "',g_apz.apz02b,'" ',
  #               ' "',g_apy.apygslp,'" ',
  #               ' "',g_apa.apa02,'" ',
  #               ' "Y" ',
  #               ' "1" ',  #No.MOD-860075
  #               ' "Y" ',
  #               ' "',g_apz.apz02c,'" ',
  #               ' "',g_apy.apygslp1,'" ',
  #               ' "Y" '                    #MOD-B10041
  #  #TQC-AC0282--modify--str---
  #   #TQC-AB0118 Modify begin----------------------
  #   #IF cl_null(g_apy.apygslp) OR cl_null(g_apy.apygslp1) THEN    #TQC-AB0118 檢查g_apy.apygslp/g_apy.apygslp1
  #   #   CALL cl_err('aapi103','aap-935',1)  #TQC-AB0118
  #   #   LET g_apa.apa41='N'
  #   #   LET g_success = 'N'
  #   #   ROLLBACK WORK
  #   #ELSE
  #   #TQC-AB0118 Modify  end-----------------------
  #   #   CALL cl_wait()
  #   #   CALL cl_cmdrun_wait(g_str CLIPPED)   #MOD-7B0209
  #   IF cl_null(g_apy.apygslp) THEN    
  #      CALL cl_err('aapi103','aap-935',1)         
  #      LET g_apa.apa41='N'
  #      LET g_success = 'N'
  #      ROLLBACK WORK
  #   ELSE
  #      IF g_aza.aza63 ='Y' AND cl_null(g_apy.apygslp1) THEN
  #         CALL cl_err('aapi103','aap-942',1)
  #         LET g_apa.apa41='N'
  #         LET g_success = 'N'
  #         ROLLBACK WORK
  #      ELSE
  #         CALL cl_wait()
  #         CALL cl_cmdrun_wait(g_str CLIPPED)   #MOD-7B0209
  #      END IF
  #  #TQC-AC0282--modify--end--
  #   END IF
  #END IF 
  #------------------------CHI-C20003-移至25030行--------------------------------------mark
  IF g_success = 'Y' THEN                        #MOD-C50243 add
    #-----------------------------------------------MOD-C50093--------------------------------(S)
    #CALL s_showmsg_init()                       #MOD-C50243 mark
     LET l_arr_cnt = l_arr_i - 1
     FOR l_arr_i = 1 TO l_arr_cnt
         IF NOT cl_null(l_apa01_arr[l_arr_i].apa01) AND g_success = 'Y' THEN
           #LET g_wc_gl = ' npp01="',g_apa.apa01,'"'                     #MOD-D80030 mark
           LET g_wc_gl = ' npp01="',l_apa01_arr[l_arr_i].apa01,'"'       #MOD-D80030
           LET l_wc = g_wc_gl clipped," AND npp011 = 1 "
           LET g_str = "aapp400 '",l_wc CLIPPED,
                       "' '",g_apa.apauser,
                       "' '",g_apa.apauser,
                       "' '",g_apz.apz02p,
                       "' '",g_apz.apz02b,
                       "' '",g_apy.apygslp,
                       "' '",g_apa.apa02,
                       "' 'Y' '1' 'Y' '",g_apz.apz02c,
                       "' '",g_apy.apygslp1,"' 'Y'"
            IF cl_null(g_apy.apygslp) THEN
               CALL s_errmsg('aapi103','','','aap-935',1)
               LET g_apa.apa41='N'
               LET g_success = 'N'
               ROLLBACK WORK
            ELSE
               IF g_aza.aza63 ='Y' AND cl_null(g_apy.apygslp1) THEN
                  CALL s_errmsg('aapi103','','','aap-942',1)
                  LET g_apa.apa41='N'
                  LET g_success = 'N'
                  ROLLBACK WORK
               ELSE
                 #IF g_apa.apa58 <> '1' THEN                           #TQC-C90078 add #MOD-CB0128 mark
                  IF g_apa.apa58 <> '1' OR cl_null(g_apa.apa58) THEN   #MOD-CB0128 add
                     CALL cl_cmdrun_wait(g_str CLIPPED)
                     SELECT apa44 INTO l_apa44 FROM apa_file
                      WHERE apa01 = l_apa01_arr[l_arr_i].apa01
                    #CALL s_errmsg('',l_apa44,'','','')              #MOD-C90246 mark
                     IF NOT cl_null(l_apa44) THEN                    #MOD-C90246 add
                        CALL s_errmsg('',l_apa44,'','anm-710','')    #MOD-C90246 add
                     ELSE                                            #MOD-C90246 add
                        CALL s_errmsg('',l_apa44,'','anm-711','')    #MOD-C90246 add
                     END IF                                          #MOD-C90246 add
                  END IF                       #TQC-C90078 add
               END IF
            END IF
         END IF
     END FOR
  END IF                                        #MOD-C50243 add
  CALL s_showmsg()
 #-----------------------------------------------MOD-C50093--------------------------------(E)
 
   IF g_action_choice CLIPPED = "confirm" OR #執行 "確認" 功能(非簽核模式呼叫)
      g_action_choice CLIPPED = "insert"
   THEN
      CLOSE WINDOW t110_w6
   END IF
 
   IF l_flag = 1 THEN   #MOD-590301
 
   IF g_apa.apa01 IS NOT NULL THEN
      SELECT apa41,apa35f,apa35,apa63,apa43,apa44  #MOD-780129 
        INTO g_apa.apa41,g_apa.apa35f,g_apa.apa35,g_apa.apa63,
             g_apa.apa43,g_apa.apa44 #MOD-780129
        FROM apa_file WHERE apa01 = m_apa.apa01
      DISPLAY BY NAME g_apa.apa41,g_apa.apa35f,g_apa.apa35,g_apa.apa63
      DISPLAY BY NAME g_apa.apa44 #MOD-780129
      CALL t110_unpay()
   END IF
 
   SELECT * INTO g_apa.* FROM apa_file WHERE apa01 = g_apa.apa01
   IF g_apa.apa41='X' THEN LET g_chr='Y' ELSE LET g_chr='N' END IF
   IF g_apa.apa63='1' OR
      g_apa.apa63='2' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF
   IF g_apa.apa63='6' THEN LET g_chr3='Y' ELSE LET g_chr3='N' END IF
   CALL cl_set_field_pic(g_apa.apa41,g_chr2,"",g_chr3,g_chr,g_apa.apaacti)
   END IF   #MOD-590301
END FUNCTION
 
#------- 請採購預算控管 00/03/29 By Melody
FUNCTION t110_budchk()
    DEFINE l_apb    RECORD LIKE apb_file.*
    DEFINE l_pnr05  LIKE pnr_file.pnr05
    DEFINE l_bud    LIKE type_file.num5      # No.FUN-690028 SMALLINT
    DEFINE over_amt LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
    DEFINE last_amt LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
    DEFINE l_msg    LIKE ze_file.ze03    # No.FUN-690028 VARCHAR(30)
    DEFINE p_sum1    LIKE afc_file.afc07
    DEFINE p_sum2    LIKE afc_file.afc07
    DEFINE l_flag    LIKE type_file.num5
    DEFINE l_over    LIKE afc_file.afc07
    DEFINE l_bookno1 LIKE aaa_file.aaa01
    DEFINE l_bookno2 LIKE aaa_file.aaa01
    DEFINE l_year    LIKE type_file.num5  #MOD-A30113 add
    DEFINE l_month   LIKE type_file.num5  #MOD-A30113 add
    DEFINE l_aag21   LIKE aag_file.aag21  #MOD-B20152  
 
    DECLARE bud_cur CURSOR FOR
       SELECT * FROM apb_file WHERE apb01=g_apa.apa01
 
    FOREACH bud_cur INTO l_apb.*
      #-MOD-B20152-add-
       IF cl_null(l_apb.apb25) THEN
          CONTINUE FOREACH
       END IF
       SELECT aag21 INTO l_aag21 
         FROM aag_file
        WHERE aag01 = l_apb.apb25 
          AND aag00 = g_bookno1    
          AND aagacti = 'Y'                         #No.MOD-B70280 add
       IF l_aag21 = 'N' THEN       
          CONTINUE FOREACH
       END IF
       IF g_aza.aza63 = 'Y' THEN
          IF cl_null(l_apb.apb251) THEN
             CONTINUE FOREACH
          END IF
          SELECT aag21 INTO l_aag21 FROM aag_file
           WHERE aag01 = l_apb.apb251 
             AND aag00 = g_bookno2    
             AND aagacti = 'Y'                         #No.MOD-B70280 add 
          IF l_aag21 = 'N' THEN        
             CONTINUE FOREACH
          END IF
       END IF
      #-MOD-B20152-end-
       LET l_msg=g_apa.apa01,'+',l_apb.apb02 USING '##&'
       IF g_aza.aza08 = 'N' THEN
          LET l_apb.apb35 = ' '
          LET l_apb.apb36= ' '
       END IF
       CALL s_get_bookno(YEAR(g_apa.apa02)) RETURNING l_flag,l_bookno1,l_bookno2
       LET p_sum1 = l_apb.apb10
       LET p_sum2 = l_apb.apb10
       IF cl_null(p_sum1) THEN LET p_sum1 = 0 END IF
       IF cl_null(p_sum2) THEN LET p_sum2 = 0 END IF
       LET l_year = NULL      #MOD-A30113 add 
       LET l_month = NULL     #MOD-A30113 add  
       IF g_aaz.aaz90= 'Y' THEN
         #MOD-A30113---modify---start---
         #CALL t110_bud_s(l_bookno1,l_apb.apb31,l_apb.apb25,
         #                YEAR(g_apa.apa02),l_apb.apb36,
         #                l_apb.apb930,l_apb.apb35,
         #                MONTH(g_apa.apa02),'0','a',0,p_sum2,'1')   #MOD-950284
          CALL s_yp(g_apa.apa02) RETURNING l_year,l_month
          CALL t110_bud_s(l_bookno1,l_apb.apb31,l_apb.apb25,
                          l_year,l_apb.apb36,
                          l_apb.apb930,l_apb.apb35,
                          l_month,'0','-',0,p_sum2,'1')  #MOD-B40117 mod 'a'->'-'
         #MOD-A30113---modify---end---
       ELSE
         #MOD-A30113---modify---start---
         #CALL t110_bud_s(l_bookno1,l_apb.apb31,l_apb.apb25,
         #                YEAR(g_apa.apa02),l_apb.apb36,
         #                l_apb.apb26,l_apb.apb35,
         #                MONTH(g_apa.apa02),'0','a',0,p_sum2,'1')   #MOD-950284
          CALL s_yp(g_apa.apa02) RETURNING l_year,l_month
          CALL t110_bud_s(l_bookno1,l_apb.apb31,l_apb.apb25,
                          l_year,l_apb.apb36,
                          l_apb.apb26,l_apb.apb35,
                          l_month,'0','-',0,p_sum2,'1')  #MOD-B40117 mod 'a'->'-'
         #MOD-A30113---modify---end---
       END IF
    END FOREACH
 
END FUNCTION
FUNCTION t110_budchk_1()
    DEFINE l_apb    RECORD LIKE apb_file.*
    DEFINE l_pnr05  LIKE pnr_file.pnr05
    DEFINE l_bud    LIKE type_file.num5      # No.FUN-690028 SMALLINT
    DEFINE over_amt LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
    DEFINE last_amt LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
    DEFINE l_msg    LIKE ze_file.ze03    # No.FUN-690028 VARCHAR(30)
    DEFINE p_sum1    LIKE afc_file.afc07
    DEFINE p_sum2    LIKE afc_file.afc07
    DEFINE l_flag    LIKE type_file.num5
    DEFINE l_over    LIKE afc_file.afc07
    DEFINE l_bookno1 LIKE aaa_file.aaa01
    DEFINE l_bookno2 LIKE aaa_file.aaa01
    DEFINE l_year    LIKE type_file.num5  #MOD-A30113 add
    DEFINE l_month   LIKE type_file.num5  #MOD-A30113 add
 
    DECLARE bud_cur_1 CURSOR FOR
       SELECT * FROM apb_file WHERE apb01=g_apa.apa01
 
    FOREACH bud_cur_1 INTO l_apb.*
       LET l_msg=g_apa.apa01,'+',l_apb.apb02 USING '##&'
       IF g_aza.aza08 = 'N' THEN
          LET l_apb.apb35 = ' '
          LET l_apb.apb36= ' '
       END IF
       CALL s_get_bookno(YEAR(g_apa.apa02)) RETURNING l_flag,l_bookno1,l_bookno2
       LET p_sum1 = l_apb.apb10
       LET p_sum2 = l_apb.apb10
       IF cl_null(p_sum1) THEN LET p_sum1 = 0 END IF
       IF cl_null(p_sum2) THEN LET p_sum2 = 0 END IF
       LET l_year = NULL      #MOD-A30113 add 
       LET l_month = NULL     #MOD-A30113 add  
       IF g_aaz.aaz90 = 'Y' THEN
         #MOD-A30113---modify---start---
         #CALL t110_bud_s(l_bookno2,l_apb.apb31,l_apb.apb251,
         #                YEAR(g_apa.apa02),l_apb.apb36,
         #                l_apb.apb930,l_apb.apb35,
         #                MONTH(g_apa.apa02),'1','a',0,p_sum2,'1')   #MOD-950284
          CALL s_yp(g_apa.apa02) RETURNING l_year,l_month
          CALL t110_bud_s(l_bookno2,l_apb.apb31,l_apb.apb251,
                          l_year,l_apb.apb36,
                          l_apb.apb930,l_apb.apb35,
                          l_month,'1','-',0,p_sum2,'1')  #MOD-B40117 mod 'a'->'-'
         #MOD-A30113---modify---start---
       ELSE
         #MOD-A30113---modify---start---
         #CALL t110_bud_s(l_bookno2,l_apb.apb31,l_apb.apb251,
         #                YEAR(g_apa.apa02),l_apb.apb36,
         #                l_apb.apb26,l_apb.apb35,
         #                MONTH(g_apa.apa02),'1','a',0,p_sum2,'1')   #MOD-950284
          CALL s_yp(g_apa.apa02) RETURNING l_year,l_month
          CALL t110_bud_s(l_bookno2,l_apb.apb31,l_apb.apb251,
                          l_year,l_apb.apb36,
                          l_apb.apb26,l_apb.apb35,
                          l_month,'1','-',0,p_sum2,'1')  #MOD-B40117 mod 'a'->'-'
         #MOD-A30113---modify---end---
       END IF
    END FOREACH
 
END FUNCTION
 
FUNCTION t110_firm2()
   DEFINE g_t1     LIKE oay_file.oayslip                  #No.FUN-580012  #No.FUN-690028 VARCHAR(05)
   DEFINE l_aba19               LIKE aba_file.aba19       #No.FUN-670060
   DEFINE l_dbs                 STRING                    #No.FUN-670060
   DEFINE l_sql                 STRING                    #No.FUN-670060
   DEFINE only_one,l_sw         LIKE type_file.chr1       #No.FUN-690028 VARCHAR(1)
   DEFINE i,j,l_n               LIKE type_file.num5       #No.FUN-690028 SMALLINT
   DEFINE l_amt                 LIKE type_file.num10      #No.FUN-690028 INTEGER
   DEFINE l_apa35               LIKE apa_file.apa35
   DEFINE l_apa01               LIKE apa_file.apa01
   DEFINE l_apk03               LIKE apk_file.apk03
   DEFINE l_apk11               LIKE apk_file.apk11       #MOD-B50190 
   DEFINE l_apk171              LIKE apk_file.apk171      #MOD-B50190 
   DEFINE l_apa41               LIKE apa_file.apa41
   DEFINE l_apc01               LIKE apc_file.apc01       #MOD-940392 add
   DEFINE b_apa01               LIKE apa_file.apa01
   DEFINE b_apa41               LIKE apa_file.apa41
   DEFINE b_apa34               LIKE apa_file.apa34
   DEFINE b_apa34f              LIKE apa_file.apa34f,
          l_apk                 RECORD LIKE apk_file.*,
          l_apc                 RECORD LIKE apc_file.*,   #No.FUN-680027
          l_apv                 RECORD LIKE apv_file.*,   #MOD-850301 add
          l_apa                 RECORD LIKE apa_file.*,   #MOD-850301 add
          l_amt1,l_amt2         LIKE type_file.num20_6,   #No.FUN-690028 DEC(20,6),  #FUN-4B0079
          l_apv04f              LIKE apv_file.apv04f,     #FUN-580012
          l_apv04               LIKE apv_file.apv04,      #FUN-580012
          l_cnt                 LIKE type_file.num5       #No.FUN-690028 SMALLINT
   DEFINE l_cnt1                LIKE type_file.num5       #No.TQC-7B0083
   DEFINE l_yy,l_mm             LIKE type_file.num5       #No.FUN-690028 SMALLINT
   DEFINE l_arr1 DYNAMIC ARRAY OF LIKE apk_file.apk01     #FUN-660117
   DEFINE l_arr2 DYNAMIC ARRAY OF RECORD             
                    invoice    LIKE apk_file.apk03,                 #FUN-660117      
                    apa58      LIKE apa_file.apa58,
                    amt1       LIKE type_file.num20_6,    #No.FUN-690028 DEC(20,6),  #FUN-4B0079
                    amt2       LIKE type_file.num20_6     #No.FUN-690028 DEC(20,6)  #FUN-4B0079
                 END RECORD
   DEFINE l_no       LIKE apy_file.apyslip  #MOD-790046
   DEFINE l_apydmy3  LIKE apy_file.apydmy3  #MOD-790046
   DEFINE l_poz01    LIKE poz_file.poz01    #TQC-830007 add
   DEFINE l_poz18    LIKE poz_file.poz18    #TQC-830007 add
   DEFINE l_poz19    LIKE poz_file.poz19    #TQC-830007 add
   DEFINE l_gec05    LIKE apk_file.apk171   #MOD-B50190 
 
   IF g_apa.apa41 = 'N' THEN
      RETURN
   END IF
     IF g_apa.apa63 = 'S' THEN
        CALL cl_err(g_apa.apa63,'apm-030',1)
        RETURN
     END IF
 
#No.FUN-A40003 --begin
    SELECT apa79 INTO g_apa.apa79 FROM apa_file WHERE apa01 =g_apa.apa01
   #FUN-C80078 mod str---
   #IF g_apa.apa79  <> '0'  THEN   #No.FUN-A60024  #No.FUN-A80111
    IF g_apa.apa79 MATCHES '[123]' THEN
   #FUN-C80078 mod end---
       CALL cl_err('','aap-829',1) 
       RETURN 
    END IF  
#No.FUN-A40003 --end 

   IF NOT cl_null(g_apa.apa99) THEN
       LET l_poz18=''
       LET l_poz19=''
       LET l_poz01=''
      #FUN-A60056--mod--str--
      #SELECT poz01,poz18,poz19 INTO l_poz01,l_poz18,l_poz19  
      #  FROM pmm_file,poz_file
      # WHERE pmm904 = poz01
      #   AND pmm01  = g_apb[1].apb06
      #   AND pmm901 = 'Y'         #三角貿易否
      #   AND pmm905 = 'Y'         #已拋轉
       LET g_sql = "SELECT poz01,poz18,poz19 FROM ",
                    cl_get_target_table(g_apb[1].apb37,'pmm_file'),",",
                    cl_get_target_table(g_apb[1].apb37,'poz_file'),
                   " WHERE pmm904 = poz01",
                   "   AND pmm01  = '",g_apb[1].apb06,"'",
                   "   AND pmm901 = 'Y' AND pmm905 = 'Y'"
       CALL cl_replace_sqldb(g_sql) RETURNING g_sql
       CALL cl_parse_qry_sql(g_sql,g_apb[1].apb37) RETURNING g_sql 
       PREPARE sel_poz01 FROM g_sql
       EXECUTE sel_poz01 INTO l_poz01,l_poz18,l_poz19
      #FUN-A60056--mod--end
        IF l_poz19 = 'Y'  AND g_plant=l_poz18 THEN  
           #已設立中斷點,單據可以取消確認
        ELSE 
           CALL cl_err('','tri-018',1) RETURN
        END IF  #TQC-830007
   END IF
   LET l_cnt = 0
   SELECT COUNT(*) INTO l_cnt FROM npl_file
      WHERE npl01 = g_apa.apa25
   IF l_cnt > 0 THEN
      CALL cl_err('','aap-425',0)
      RETURN
   END IF
 
  #-----MOD-770005---------已有產生折讓發票,不可取消確認
  IF g_aptype MATCHES '1*' THEN   #MOD-770081
     DECLARE apk_curs CURSOR FOR 
       SELECT apk03,apk11,apk171   #MOD-B50190 add apk11,apk171 
         FROM apk_file 
        WHERE apk01 = g_apa.apa01  
     LET l_apk03=''
     FOREACH apk_curs INTO l_apk03,l_apk11,l_apk171     #MOD-B50190 add apk11,apk171
       #-MOD-B50190-add-
        SELECT gec05 INTO l_gec05
          FROM gec_file
         WHERE gec01 = l_apk11
           AND gec011 = '1'
#       IF l_apk171 = '22' AND l_gec05 = '4' THEN                        #MOD-B70053 mark
        IF (l_apk171 = '22' AND l_gec05 = '4') OR l_apk171 = 'XX' THEN   #MOD-B70053
        ELSE 
       #-MOD-B50190-end- 
           LET l_cnt=0
           SELECT COUNT(*) INTO l_cnt FROM apb_file,apa_file
             WHERE apb11 = l_apk03  
               AND apb01 = apa01  
               AND apa00 MATCHES "2*"  
               AND apa42 = 'N'                    #MOD-CB0091 add
               AND apa58 <> '1'                  #MOD-770081
           IF l_cnt > 0 THEN
              CALL cl_err(l_apk03,'aap-666',0)
              RETURN
           END IF
        END IF       #MOD-B50190
     END FOREACH
  END IF   #MOD-770081
 
  #-----TQC-740314--------已有沖暫估資料不可取消確認
  LET l_cnt=0
  SELECT COUNT(*) INTO l_cnt FROM api_file
    WHERE api01 = g_apa.apa01 AND api02='2'
   IF l_cnt > 0 AND g_aptype ='16' THEN
      CALL cl_err(g_apa.apa01,'aap-140',0)
      RETURN
   END IF
 
  #-----MOD-620008---------已有沖帳之資料不可取消確認
  LET l_cnt=0
  SELECT COUNT(*) INTO l_cnt FROM aph_file,apf_file
    WHERE aph04 = g_apa.apa01 AND apf01=aph01
      AND apf41 != 'X'
      AND apflegal = g_legal  #MOD-C40157
   IF l_cnt > 0 THEN
      CALL cl_err(g_apa.apa01,'agl-905',0)
      RETURN
   END IF
 
  #-----MOD-6C0122---------已沖暫估之資料不可取消確認
  IF g_apa.apa00 = '11' THEN
     LET l_cnt = 0
     SELECT COUNT(*) INTO l_cnt FROM api_file
       WHERE api26 = g_apa.apa01
     IF l_cnt > 0 THEN
        CALL cl_err(g_apa.apa01,'aap-140',0)
        RETURN
     END IF
  END IF
 
  #帳款單號已經存在于進銷項維護作業（amd_file.amd01），
  #不能取消確認
  LET l_cnt = 0
  SELECT COUNT(*) INTO l_cnt
    FROM amd_file
   WHERE amd01 = g_apa.apa01
  IF l_cnt > 0 THEN
     CALL cl_err(g_apa.apa01,'aap-188',0)
     RETURN
  END IF
 
   #取消確認時，若單據別設為"系統自動拋轉總帳",則可自動拋轉還原    
   CALL s_get_doc_no(g_apa.apa01) RETURNING g_t1   #No.TQC-740067
   SELECT * INTO g_apy.* FROM apy_file WHERE apyslip=g_t1                                                                           
   IF NOT cl_null(g_apa.apa44)  THEN         #No.TQC-740067                                                            
      IF NOT (g_apy.apydmy3 = 'Y' AND g_apy.apyglcr = 'Y') THEN                                                                     
         CALL cl_err(g_apa.apa01,'axr-370',0) RETURN    #No.TQC-740067                                                                            
      END IF                                                                                                                        
   END IF                                                                                                                           
   IF g_apy.apydmy3 = 'Y' AND g_apy.apyglcr = 'Y' THEN                                                                              
      IF NOT cl_null(g_apa.apa44) THEN   #CHI-B60063 add
         LET g_plant_new=g_apz.apz02p CALL s_getdbs() LET l_dbs=g_dbs_new
         #LET l_sql = " SELECT aba19 FROM ",l_dbs,"aba_file",
         LET l_sql = " SELECT aba19 FROM ",cl_get_target_table(g_apz.apz02p,'aba_file'), #FUN-A50102
                     "  WHERE aba00 = '",g_apz.apz02b,"'",
                     "    AND aba01 = '",g_apa.apa44,"'"   #No.TQC-740067
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql        #FUN-920032
         CALL cl_parse_qry_sql(l_sql,g_apz.apz02p) RETURNING l_sql #FUN-A50102
         PREPARE aba_pre FROM l_sql
         DECLARE aba_cs CURSOR FOR aba_pre
         OPEN aba_cs
         FETCH aba_cs INTO l_aba19
         IF l_aba19 = 'Y' THEN                                                                                                         
            CALL cl_err(g_apa.apa44,'axr-071',1)     #No.TQC-740067                                                                                  
            CLOSE aba_cs   #No.TQC-7B0083
            RETURN                                                                                                                     
         END IF                                                                                                                        
         CLOSE aba_cs   #No.TQC-7B0083
      END IF   #CHI-B60063 add
   END IF                                                                                                                           
 
 
   #FUN-B50090 add begin-------------------------
   #重新抓取關帳日期
   SELECT apz57 INTO g_apz.apz57 FROM apz_file WHERE apz00='0'
   #FUN-B50090 add -end--------------------------
   #-->立帳日期不可小於關帳日期
   IF g_apa.apa02 <= g_apz.apz57 THEN
      CALL cl_err(g_apa.apa01,'aap-176',1)
      RETURN
   END IF
   # 期末調匯(A008)
 
   IF g_apz.apz27 = 'Y' AND g_apa.apa13 != g_aza.aza17 THEN
      LET l_yy = YEAR(g_apa.apa02)
      LET l_mm = MONTH(g_apa.apa02)
      IF (l_yy*12+l_mm) - (g_apz.apz21*12+g_apz.apz22) = 0 THEN
         CALL cl_err(l_mm,'axr-407',0) RETURN
      END IF
   END IF
 
   #-->若有沖帳之資料不可取消確認 modi in 01/03/14 bug:2923
   SELECT COUNT(*) INTO l_n 
     FROM apg_file ,apf_file
    WHERE apg04 = g_apa.apa01 
      AND apf01=apg01          #MOD-790086 
      AND apf00 !='11'         #MOD-790086
      AND apf00 !='16'         #MOD-790086
     #AND apg03 = g_plant      #MOD-B40117 add   #MOD-BA0221 mark
      AND apf41 != 'X'   #no.7349
      AND apflegal = g_legal     #MOD-C40157
   IF l_n > 0 THEN
      CALL cl_err(g_apa.apa01,'agl-905',0)
      RETURN
   END IF
 
  #為請款折讓,不可取消確認,統一由AAPT110取消時再刪除
   IF g_apa.apa00='21' AND g_apa.apa58='1' AND g_apz.apz60 = 'Y' THEN
      CALL cl_err('','aap-321',0)
      RETURN
   END IF
 
   #-->已付款沖帳不可取消確認
   LET g_t1 = s_get_doc_no(g_apa.apa01)
   SELECT apydmy6 INTO g_apy.apydmy6 FROM apy_file WHERE apyslip = g_t1
   IF g_aza.aza26 != '2' OR g_aptype[1,1]!='2' OR g_apy.apydmy6!='Y' THEN
      IF (g_apa.apa35<>0 OR g_apa.apa35f<>0) AND g_apa.apa55!='2' THEN
         CALL cl_err("apa41=Y",'aap-255',0)
         RETURN
      END IF
   END IF
 
   #-->待抵已沖帳不可取消確認
   IF g_apa.apa00 = '15' OR g_apa.apa00 = '17' THEN  #No.FUN-690080
      SELECT apa35 INTO l_apa35 FROM apa_file
       WHERE apa08 = g_apa.apa01 
         AND (apa00 = '23' OR apa00 = '25')  #No.FUN-690080
      IF l_apa35 > 0 THEN
         CALL cl_err('23:apa35>0','aap-204',0)
         RETURN
      END IF
   END IF
 
   #-->已結案不可取消確認
   IF g_apa.apa42 = 'Y' THEN
      CALL cl_err("apa42=Y",'aap-165',0)
      RETURN
   END IF
 
   #-->外購拋入不可取消確認
   IF g_apa.apa75 = 'Y' THEN
      CALL cl_err("apa75=Y",'aap-333',0)
      RETURN
   END IF
   IF g_aza.aza26 = '2' AND g_apa.apa00[1,1] = '1' THEN
      SELECT SUM(apv04),SUM(apv04f) INTO l_apv04,l_apv04f
        FROM apv_file
       WHERE apv03=g_apa.apa01
      IF cl_null(l_apv04) THEN LET l_apv04 = 0 END IF
      IF cl_null(l_apv04f) THEN LET l_apv04f = 0 END IF
      IF l_apv04 != 0 OR l_apv04f != 0 THEN
         CALL cl_err('','aap-914',0)
         LET g_success = 'N'
         RETURN
      END IF
   END IF
 
   #單身已分攤, 則不可取消確認
   LET l_cnt=0
   IF g_apa.apa00='11' THEN
      SELECT COUNT(*) INTO l_cnt
        FROM aqa_file,aqc_file
       WHERE aqc01 = aqa01
         AND aqc02 = g_apa.apa01
         AND aqaconf<> 'X' #CHI-A50028 add
       IF SQLCA.SQLCODE <> 0 OR l_cnt IS NULL THEN
          LET l_cnt =0
       END IF
 
       IF l_cnt > 0 THEN
          CALL cl_err("apb10<>apb101",'aap-291',0)
          RETURN
       END IF
   END IF
 
   IF g_apa.apa00='12' OR g_apa.apa00 ='13' OR g_apa.apa00 ='16' OR
      g_apa.apa00='22' OR g_apa.apa00 ='15' OR g_apa.apa00 ='25' THEN   #No.FUN-690080 #MOD-B20046 mod 23 -> 15
     #-MOD-B20046-add-
      IF g_apa.apa00 = '15' THEN
         LET l_apa01 = ''
         SELECT apa01 INTO l_apa01 
           FROM apa_file
          WHERE apa08 = g_apa.apa01
            AND apa00 = '23'
 
         SELECT COUNT(*) INTO l_cnt
           FROM aqa_file,aqb_file
          WHERE aqb01 = aqa01
            AND aqb02 = l_apa01
            AND aqaconf<> 'X' 
      ELSE
     #-MOD-B20046-end-
         SELECT COUNT(*) INTO l_cnt
           FROM aqa_file,aqb_file
          WHERE aqb01 = aqa01
            AND aqb02 = g_apa.apa01
            AND aqaconf<> 'X' #CHI-A50028 add
      END IF  #MOD-B20046
       IF SQLCA.SQLCODE <> 0 OR l_cnt IS NULL THEN
          LET l_cnt =0
       END IF
 
       IF l_cnt > 0 THEN
          CALL cl_err("apb10<>apb101",'aap-291',0)
          RETURN
       END IF
   END IF
 
   IF g_apa.apa00 = '16' OR g_apa.apa00 = '26' THEN
      LET l_cnt = 0 
      SELECT COUNT(*) INTO l_cnt FROM api_file
       WHERE api26 = g_apa.apa01
      IF l_cnt > 0 THEN
         CALL cl_err(g_apa.apa01,'aap-140',1)
         LET g_success = 'N'
         RETURN
      END IF 
   END IF 
 
   IF cl_confirm('aap-224') THEN
      MESSAGE "WORKING !"
      IF g_apy.apydmy3 = 'Y' AND g_apy.apyglcr = 'Y' THEN
         IF NOT cl_null(g_apa.apa44) THEN   #CHI-B60063 add
            LET g_wc_gl = 'npp01 = "',g_apa.apa01,'" AND npp011 = 1'
            LET g_str="aapp409 '",g_apz.apz02p,"' '",g_apz.apz02b,"' '",g_apa.apa44,"' 'Y'"
            CALL cl_cmdrun_wait(g_str)
            SELECT apa44,apa43 INTO g_apa.apa44,g_apa.apa43 FROM apa_file 
             WHERE apa01 = g_apa.apa01
            DISPLAY BY NAME g_apa.apa44
            IF NOT cl_null(g_apa.apa44) THEN
               CALL cl_err('','aap-929',0)
               RETURN
            END IF
         END IF   #CHI-B60063 add
      END IF 
      LET g_success = 'Y'
      BEGIN WORK
      CALL t110_lock_cl()  #FUN-C80078 add 
      OPEN t110_cl USING g_apa.apa01
      IF STATUS THEN
         CALL cl_err("OPEN t110_cl firm2:", STATUS, 1)
         CLOSE t110_cl
         ROLLBACK WORK
         RETURN
      END IF
 
      FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
      IF SQLCA.sqlcode THEN
         CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
         CLOSE t110_cl
         ROLLBACK WORK
         RETURN
      END IF
 
      IF g_apa.apa00[1,1] = '1' AND g_apa.apa60 > 0 THEN
         DECLARE apk_c SCROLL CURSOR FOR 
           SELECT apk01 FROM apk_file WHERE apk26=g_apa.apa01
         OPEN apk_c
         FETCH FIRST apk_c INTO l_apk.apk01
         CLOSE apk_c
 
         SELECT SUM(apk07+apk08) INTO l_apk.apk07 FROM apk_file
            WHERE apk01=l_apk.apk01
         LET l_amt2 = l_apk.apk07
 
         IF (g_apa.apa60+g_apa.apa61) = l_amt2 THEN
            DELETE FROM apa_file WHERE apa01=l_apk.apk01
            IF SQLCA.SQLCODE OR STATUS THEN
               CALL cl_err3("del","apa_file",l_apk.apk01,"",SQLCA.sqlcode,"","del apa",1)  
               LET g_success = 'N'
            END IF
            DELETE FROM apc_file WHERE apc01=l_apk.apk01
            IF SQLCA.SQLCODE OR STATUS THEN
               CALL cl_err3("del","apc_file",l_apk.apk01,"",SQLCA.sqlcode,"","del apc",1)  
               LET g_success = 'N'
            END IF
            DELETE FROM apb_file WHERE apb01=l_apk.apk01
            IF SQLCA.SQLCODE OR STATUS THEN
               CALL cl_err3("del","apb_file",l_apk.apk01,"",SQLCA.sqlcode,"","del apb",1)  
               LET g_success = 'N'
            END IF
            DELETE FROM apk_file WHERE apk01=l_apk.apk01
            IF SQLCA.SQLCODE OR STATUS THEN
               CALL cl_err3("del","apk_file",l_apk.apk01,"",SQLCA.sqlcode,"","del apk",1)  
               LET g_success = 'N'
            END IF
            DELETE FROM npp_file WHERE npp01=l_apk.apk01 AND nppsys='AP' AND
                                       npp00=1 AND npp011=1
            IF SQLCA.SQLCODE OR STATUS THEN
               CALL cl_err3("del","npp_file",l_apk.apk01,"",SQLCA.sqlcode,"","del npp",1)  
               LET g_success = 'N'
            END IF
            DELETE FROM npq_file WHERE npq01=l_apk.apk01 AND npqsys='AP' AND
                                       npq00=1 AND npq011=1
            IF SQLCA.SQLCODE OR STATUS THEN
               CALL cl_err3("del","npq_file",l_apk.apk01,"",SQLCA.sqlcode,"","del npq",1)  
               LET g_success = 'N'
            END IF
            #FUN-B40056--add--str--
            DELETE FROM tic_file WHERE tic04 = l_apk.apk01
            IF STATUS THEN
               CALL cl_err3("del","tic_file",l_apk.apk01,"",SQLCA.sqlcode,"","del tic",1)
               LET g_success = 'N'
            END IF
            #FUN-B40056--add--end--

            UPDATE apb_file SET apb16='N' WHERE apb01 = g_apa.apa01   #MOD-770081
            IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3]=0 THEN
               CALL cl_err3("upd","apb_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apb",1)  
               LET g_success = 'N'
            END IF
         END IF
 
         IF (g_apa.apa60+g_apa.apa61) < l_amt2 THEN
            CALL t110_comp_oox(l_apk.apk07) RETURNING g_net
            UPDATE apa_file SET apa31f = apa31f - g_apa.apa60f,
                                apa31  = apa31  - g_apa.apa60,
                                apa32f = apa32f - g_apa.apa61f,
                                apa32  = apa32  - g_apa.apa61,
                                apa34f = apa34f - g_apa.apa60f-g_apa.apa61f,
                                apa34  = apa34  - g_apa.apa60 -g_apa.apa61 ,
                                apa35f = apa35f - g_apa.apa60f-g_apa.apa61f,
                                apa35  = apa35  - g_apa.apa60 -g_apa.apa61 ,
                                apa57  = apa57  - g_apa.apa60,
                                apa73  = apa73  - g_apa.apa60
                                                - g_apa.apa61
                                                + g_net
             WHERE apa01 = l_apk.apk01 AND apa41 = 'Y'
            IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] = 0 THEN
               CALL cl_err3("upd","apa_file",l_apk.apk01,"","app-047","","",1) 
               LET g_success = 'N'
            END IF
            UPDATE apc_file SET apc08 = apc08 - g_apa.apa60f-g_apa.apa61f,
                                apc09 = apc09 - g_apa.apa60 -g_apa.apa61 ,
                                apc10 = apc10 - g_apa.apa60f-g_apa.apa61f,
                                apc11 = apc11 - g_apa.apa60 -g_apa.apa61 ,
                                apc13 = apc13 - g_apa.apa60 -g_apa.apa61 +g_net
             WHERE apc01 = l_apk.apk01 
            IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] = 0 THEN
               CALL cl_err3("upd","apc_file",l_apk.apk01,"",SQLCA.sqlcode,"","upd apc",1) 
               LET g_success = 'N'
            END IF
            DELETE FROM apb_file WHERE apb11=g_apa.apa08
            IF SQLCA.SQLCODE OR STATUS THEN
               CALL cl_err3("del","apb_file",g_apa.apa08,"",SQLCA.sqlcode,"","del apb",1)  
               LET g_success = 'N'
            END IF
            DELETE FROM apk_file WHERE apk26=g_apa.apa01
            IF SQLCA.SQLCODE OR STATUS THEN
               CALL cl_err3("del","apk_file",g_apa.apa01,"",SQLCA.sqlcode,"","del apk",1)  
               LET g_success = 'N'
            END IF
            LET l_no = s_get_doc_no(l_apk.apk01)
            SELECT apydmy3 INTO l_apydmy3 FROM apy_file WHERE apyslip=l_no
            IF l_apydmy3 = 'Y' THEN 
               DELETE FROM npp_file WHERE npp01=l_apk.apk01 AND nppsys='AP' AND
                                          npp00=1 AND npp011=1
               IF SQLCA.SQLCODE OR STATUS THEN
                  CALL cl_err3("del","npp_file",l_apk.apk01,"",SQLCA.sqlcode,"","del npp",1)  
                  LET g_success = 'N'
               END IF
               DELETE FROM npq_file WHERE npq01=l_apk.apk01 AND npqsys='AP' AND
                                          npq00=1 AND npq011=1
               IF SQLCA.SQLCODE OR STATUS THEN
                  CALL cl_err3("del","npq_file",l_apk.apk01,"",SQLCA.sqlcode,"","del npq",1)  
                  LET g_success = 'N'
               END IF
               #FUN-B40056--add--str--
               DELETE FROM tic_file WHERE tic04 = l_apk.apk01
               IF STATUS THEN
                  CALL cl_err3("del","tic_file",l_apk.apk01,"",SQLCA.sqlcode,"","del tic",1)
                  LET g_success = 'N'
               END IF
               #FUN-B40056--add--end--

               CALL t110_g_gl('21',l_apk.apk01,'0','')  #FUN-9C0001 add ''
               IF g_aza.aza63 = 'Y' AND g_success = 'Y' THEN
                  CALL t110_g_gl('21',l_apk.apk01,'1','')   #FUN-9C0001 add ''
               END IF
            END IF
            UPDATE apb_file SET apb16='N' WHERE apb01 = g_apa.apa01   #MOD-770081
            IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3]=0 THEN
               CALL cl_err3("upd","apb_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apb",1)  
               LET g_success = 'N'
            END IF
         END IF
      END IF
 
      LET m_apa.* = g_apa.*
 
      #----預付待抵刪除------------
      IF g_aptype= '15' OR g_aptype= '17' THEN  #No.FUN-690080
         LET l_sql = "SELECT apc01 FROM apc_file,apa_file ",
                     " WHERE apc01 =apa01 ",
                     "   AND (apa00 = '23' OR apa00 = '25') ",
                     "   AND apa08 = '",g_apa.apa01 CLIPPED,"' "
         PREPARE p150_p1 FROM l_sql
         DECLARE p150_cs1 CURSOR FOR p150_p1
         FOREACH p150_cs1 INTO l_apc01
            DELETE FROM apc_file WHERE apc01 = l_apc01
            IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
               CALL cl_err3("del","apc_file",l_apc01,"",SQLCA.sqlcode,"","t110_firm2_apc:",1)
               LET g_success = 'N'
            END IF
         END FOREACH
         DELETE FROM apa_file WHERE (apa00 = '23' OR apa00 = '25') AND apa08=g_apa.apa01  #No.FUN-690080
         IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
            CALL cl_err3("del","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_firm2_apa:",1)  #No.FUN-660122
            LET g_success = 'N'
         END IF
      END IF
 
      LET l_cnt1 = 0
      SELECT COUNT(*) INTO l_cnt1 FROM apb_file
       WHERE apb01 = g_apa.apa01
         AND apb34 = 'Y'
      IF cl_null(l_cnt1) THEN LET l_cnt1 = 0 END IF
      #----沖暫估AP刪除------------
      IF g_apa.apa51='UNAP' OR l_cnt1 > 0 OR g_apa.apa56='5' THEN  #No.TQC-7B0083  #MOD-8C0067
         CALL t110_del_apg()
      END IF
 
      #----直接付款刪除------------
      IF g_apa.apa55='2' THEN
         CALL t110_del_apg0()
      END IF
 
      #----直接付款沖待抵帳款 97-09-11 Roger
      IF m_apa.apa55='2' THEN
         CALL t110_aph_upd(-1)
      END IF
 
 
     #MOD-A50005---mark---start---
     #IF m_apa.apa00= '21' AND  m_apa.apa58 = '3' THEN
     #   DELETE FROM apk_file WHERE apk01=g_apa.apa01
     #   IF STATUS THEN
     #      CALL cl_err3("del","apk_file",g_apa.apa01,"",STATUS,"","apa58=3 del apk",1)  #No.FUN-660122
     #      LET g_success='N'
     #   END IF
     #END IF
     #MOD-A50005---mark---end---
 
     #刪除還款銀行異動記錄檔
     IF g_aptype = '13' AND g_apa.apa37f > 0 THEN
        CALL t110_del_nme_1()
     END IF
         UPDATE apa_file SET apa41 = 'N',
                          apa63 = '0'
       WHERE apa01=g_apa.apa01
 
      IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
         CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_apa41:",1)  #No.FUN-660122
         LET g_success = 'N'
      END IF
 
      MESSAGE ""
      IF g_success = 'Y' THEN
         COMMIT WORK
      ELSE
         ROLLBACK WORK
      END IF
   END IF
 
 
   IF g_apa.apa01 IS NOT NULL THEN
        SELECT apa41,apa35f,apa35,apa63 INTO g_apa.apa41,g_apa.apa35f,g_apa.apa35
         ,g_apa.apa63 FROM apa_file WHERE apa01 = g_apa.apa01
        DISPLAY BY NAME g_apa.apa41,g_apa.apa35f,g_apa.apa35,g_apa.apa63
        CALL t110_unpay()
   END IF
 
END FUNCTION
 
FUNCTION t110_21_ins(l_apa)
  DEFINE l_apa   RECORD LIKE apa_file.*,
         l_apb   RECORD LIKE apb_file.*,
         toa     RECORD LIKE apa_file.*,
         tob     RECORD LIKE apb_file.*,
         toapk   RECORD LIKE apk_file.*,
         l_azi04        LIKE azi_file.azi04,
         l_tax          LIKE apb_file.apb10,
         l_taxf         LIKE apb_file.apb10,
         l_amt_totf     LIKE apa_file.apa34,
         l_amt_tot      LIKE apa_file.apa34,
         l_sumf         LIKE apa_file.apa34,
         l_sum          LIKE apa_file.apa34,
         l_amt          LIKE apa_file.apa60,
         tr_no           LIKE apa_file.apa01,   #FUN-660117
         l_d_actno       LIKE aps_file.aps21,   #FUN-660117
         l_c_actno       LIKE aps_file.aps22,   #FUN-660117
         l_d_actno1      LIKE aps_file.aps211,  #FUN-680029
         l_c_actno1      LIKE aps_file.aps221,  #FUN-680029
         l_depno         LIKE apa_file.apa22,   #FUN-660117
         to_trtype      LIKE apy_file.apyslip,    # No.FUN-690028 VARCHAR(5),              #No.FUN-550030
         li_result      LIKE type_file.num5,               #No.FUN-560002  #No.FUN-690028 SMALLINT
         to_apa02     LIKE type_file.dat,       # No.FUN-690028 DATE,
         l_apr02      LIKE apr_file.apr02,
         l_apa01        LIKE apa_file.apa01,
         to_apa15     LIKE apa_file.apa15,
         to_apa16     LIKE apa_file.apa15,
         to_apa21     LIKE apa_file.apa21,
         to_apa22     LIKE apa_file.apa22,
         to_apa36     LIKE apa_file.apa36,
         inv_no       LIKE apa_file.apa08,
         to_amt       LIKE apa_file.apa06,
         t_apk08        LIKE apk_file.apk08,
         t_apk07        LIKE apk_file.apk07,
         t_apk06        LIKE apk_file.apk06,
         l_diffapk08    LIKE apk_file.apk08,
         l_diffapk07    LIKE apk_file.apk07,
         l_diffapk06    LIKE apk_file.apk06,
         l_apk03        LIKE apk_file.apk03,
         o_apk02        LIKE apk_file.apk02,
         l_apk06,o_apk06 LIKE apk_file.apk06
  DEFINE g_t1            LIKE oay_file.oayslip  #FUN-990014 add
   INITIALIZE toa.* TO NULL
   INITIALIZE tob.* TO NULL
   INITIALIZE toapk.* TO NULL
 
   OPEN WINDOW t110_21_w AT 8,18 WITH FORM "aap/42f/aapt1101"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No.FUN-580092 HCN
 
    CALL cl_ui_locale("aapt1101")
 
 
    # 若無指定發票時,抓發票金額最大者
    LET to_apa02=l_apa.apa02
    LET to_apa15=l_apa.apa15
    LET to_apa16=l_apa.apa16
    LET to_apa21=g_user
    LET to_apa22=g_grup
    LET to_apa36=l_apa.apa36
 
    IF g_apa.apa08 !='MISC' THEN
       LET inv_no=l_apa.apa08
#      LET to_amt=l_apa.apa31f                       #No.TQC-A30152    #No.TQC-A30160
       LET to_amt=l_apa.apa31+l_apa.apa32                              #No.TQC-A30160 
    ELSE
       IF cl_null(inv_no) THEN
          DECLARE t110_apk_no CURSOR FOR
           SELECT apk03,apk06 FROM apk_file
            WHERE apk01 = l_apa.apa01 AND apk171 IN ('21','22','25')
            ORDER by apk06 DESC,apk03
 
          OPEN t110_apk_no
 
          FETCH t110_apk_no INTO l_apk03,l_apk06
 
          CLOSE t110_apk_no
 
          IF STATUS OR cl_null(l_apk03) THEN
             LET l_apk03 = ''
          END IF
 
          IF cl_null(l_apk06) THEN
             LET l_apk06 = 0
          END IF
 
          LET inv_no=l_apk03
          LET to_amt=l_apk06
       END IF
    END IF
 
    DISPLAY BY NAME to_amt
    CALL cl_set_head_visible("","YES")     #No.FUN-6B0033
 
    INPUT BY NAME to_trtype,to_apa02,to_apa15,to_apa16,to_apa21,to_apa22,
                  to_apa36,inv_no WITHOUT DEFAULTS
 
       AFTER FIELD to_trtype
          IF NOT cl_null(to_trtype) THEN
            #CALL s_check_no(g_sys,to_trtype,"","21","","","") #NO.TQC-B60093 mark
             CALL s_check_no("aap",to_trtype,"","21","","","") #NO.TQC-B60093 add
               RETURNING li_result,to_trtype
             IF (NOT li_result) THEN
                 NEXT FIELD to_trtype
             END IF
            LET g_apa.apamksg = g_apy.apyapr
          END IF
 
       AFTER FIELD to_apa15
          IF NOT cl_null(to_apa15) THEN
             SELECT gec04 INTO to_apa16 FROM gec_file
              WHERE gec01 = to_apa15 AND gecacti = 'Y'
               AND gec011='1'  #進項
             IF STATUS THEN
                CALL cl_err3("sel","gec_file",to_apa15,"",SQLCA.sqlcode,"","",1)  #No.FUN-660122
                NEXT FIELD apa15
             END IF
             DISPLAY BY NAME to_apa16
          END IF
 
       AFTER FIELD to_apa21
          IF NOT cl_null(to_apa21) THEN
             SELECT COUNT(*) INTO g_cnt FROM gen_file
              WHERE gen01 = to_apa21
             IF g_cnt = 0 THEN                #抱歉, 有問題
                CALL cl_err(to_apa21,'aap-038',0)
                NEXT FIELD to_apa21
             END IF
             SELECT gen03 INTO to_apa22 FROM gen_file WHERE gen01=to_apa21
             DISPLAY BY NAME to_apa22
          END IF
 
       AFTER FIELD to_apa22
          IF NOT cl_null(to_apa22) THEN
             SELECT COUNT(*) INTO g_cnt FROM gem_file
              WHERE gem01 = to_apa22
                AND gemacti='Y'   #NO:6950
             IF g_cnt = 0 THEN                #抱歉, 有問題
                CALL cl_err(to_apa22,'aap-039',0)
                NEXT FIELD to_apa22
             END IF
          END IF
 
       AFTER FIELD to_apa36
          IF NOT cl_null(to_apa36) THEN
             SELECT COUNT(*) INTO g_cnt FROM apr_file
              WHERE apr01 = to_apa36
             IF g_cnt = 0 THEN
                CALL cl_err(to_apa36,'aap-044',0)
                NEXT FIELD to_apa36
             END IF
 
             SELECT apr02 INTO l_apr02 FROM apr_file WHERE apr01 = to_apa36
 
             DISPLAY l_apr02 TO FORMONLY.apr02
             LET l_depno = ''
             IF g_apz.apz13 = 'Y' THEN
                LET l_depno = to_apa22
             ELSE
                LET l_depno = ' '
             END IF
 
             SELECT aps21,aps211,aps22,aps221 INTO l_d_actno,l_d_actno1,l_c_actno,l_c_actno1 FROM aps_file    #No.FUN-680029
              WHERE aps01 = l_depno
          END IF
 
       AFTER FIELD inv_no
          IF NOT cl_null(inv_no) THEN
             IF g_apa.apa08 !='MISC' AND g_apa.apa08 != inv_no THEN
                LET inv_no=g_apa.apa08
                DISPLAY BY NAME inv_no
                NEXT FIELD inv_no
             END IF
 
            #str MOD-9C0416 add
             IF g_aza.aza26 = '2' THEN
                SELECT SUM(apk07+apk08) INTO l_amt FROM apk_file
                 WHERE apk01 = l_apa.apa01
                   AND apk03 = inv_no
             ELSE
            #end MOD-9C0416 add
                SELECT SUM(apk07+apk08) INTO l_amt FROM apk_file
                #WHERE apk01 = l_apa.apa01 AND apk171 IN ('21','22','25')         #MOD-A70229 mark     
                 WHERE apk01 = l_apa.apa01 AND apk171 IN ('21','22','25','XX')    #MOD-A70229
                   AND apk03 = inv_no
             END IF   #MOD-9C0416 add
             IF SQLCA.SQLCODE THEN
                CALL cl_err3("sel","apk_file",l_apa.apa01,inv_no,"aap-151","","",1)  #No.FUN-660122
                LET inv_no=l_apk03
                LET to_amt=l_apk06
                DISPLAY BY NAME inv_no,to_amt
                NEXT FIELD inv_no
             END IF
 
             LET to_amt=l_amt
             DISPLAY BY NAME to_amt
 
             IF l_amt=0 OR l_amt <(l_apa.apa60+l_apa.apa61) THEN
                 CALL cl_err('','aap-062',0)             #No.MOD-510140
                LET inv_no=l_apk03
                LET to_amt=l_apk06
                DISPLAY BY NAME inv_no,to_amt
                NEXT FIELD inv_no
             END IF
          END IF
 
       AFTER INPUT
           IF NOT cl_null(inv_no) THEN
             #str MOD-9C0416 add
              IF g_aza.aza26 = '2' THEN
                 SELECT SUM(apk07+apk08) INTO l_amt FROM apk_file
                  WHERE apk01 = l_apa.apa01
                    AND apk03 = inv_no
              ELSE
             #end MOD-9C0416 add
                 SELECT SUM(apk07+apk08) INTO l_amt FROM apk_file
                 #WHERE apk01 = l_apa.apa01 AND apk171 IN ('21','22','25')         #MOD-A70229 mark     
                  WHERE apk01 = l_apa.apa01 AND apk171 IN ('21','22','25','XX')    #MOD-A70229
                    AND apk03 = inv_no
              END IF   #MOD-9C0416 add
              IF SQLCA.SQLCODE  THEN
                 CALL cl_err3("sel","apk_file",l_apa.apa01,inv_no,"aap-151","","",1)  #No.FUN-660122
                 LET inv_no=l_apk03 LET to_amt=l_apk06
                 DISPLAY BY NAME inv_no,to_amt
                 NEXT FIELD inv_no
              END IF
 
              IF cl_null(l_amt) THEN
                 LET l_amt=0
              END IF
 
              IF l_amt=0 OR l_amt <(l_apa.apa60+l_apa.apa61) THEN
                  CALL cl_err('','aap-062',0)     #No.MOD-510140
                 LET inv_no=l_apk03
                 LET to_amt=l_apk06
                 DISPLAY BY NAME inv_no,to_amt
                 NEXT FIELD inv_no
              END IF
           END IF
 
        ON ACTION CONTROLR
           CALL cl_show_req_fields()
 
        ON ACTION CONTROLG
           CALL cl_cmdask()
 
        ON ACTION CONTROLP
           CASE
              WHEN INFIELD(to_trtype) # 單別
                 CALL q_apy(FALSE,FALSE,to_trtype,'21','AAP') RETURNING to_trtype   #TQC-670008
                 DISPLAY BY NAME to_trtype
              WHEN INFIELD(to_apa21) # Class
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_gen"
                 LET g_qryparam.default1 = to_apa21
                 CALL cl_create_qry() RETURNING to_apa21
                 DISPLAY BY NAME to_apa21
              WHEN INFIELD(to_apa22) # Class
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_gem"
                 LET g_qryparam.default1 =to_apa22
                 CALL cl_create_qry() RETURNING to_apa22
                 DISPLAY BY NAME to_apa22
              WHEN INFIELD(to_apa15) # Class
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_gec"
                 LET g_qryparam.default1 =to_apa15
                 LET g_qryparam.arg1 ='1'
                 CALL cl_create_qry() RETURNING to_apa15
                 DISPLAY BY NAME to_apa15
              WHEN INFIELD(to_apa36) # Class
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_apr"
                 LET g_qryparam.default1 =to_apa36
                 CALL cl_create_qry() RETURNING to_apa36
                 DISPLAY BY NAME to_apa36
              WHEN INFIELD(inv_no) #INV_NO
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_apk02"   #MOD-5B0255
                 LET g_qryparam.default1 = g_apa.apa08  #MOD-8A0188
                 LET g_qryparam.arg1 = g_apa.apa01      #MOD-8A0188 add
                 CALL cl_create_qry() RETURNING inv_no
                 DISPLAY BY NAME inv_no
           END CASE
 
       ON IDLE g_idle_seconds
          CALL cl_on_idle()
          CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
 
    END INPUT
 
    IF INT_FLAG THEN
       LET INT_FLAG=0     #No:9599
       CLOSE WINDOW t110_21_w
       RETURN
    END IF
 
     IF g_flag='1' THEN    #已重新產生要求刪除再重新產生
        DECLARE t110_21_ins_c1 CURSOR FOR
         SELECT apa01 FROM apa_file
          WHERE apa00='21' AND apa08=l_apa.apa01 AND apa58='1'
 
        FOREACH t110_21_ins_c1 INTO l_apa01
          DELETE FROM apa_file WHERE apa00='21' AND apa01=l_apa01
          IF SQLCA.SQLCODE OR STATUS THEN
             CALL cl_err3("del","apa_file",l_apa01,"",SQLCA.sqlcode,"","del 21_apa:",1)  #No.FUN-660122
             LET g_success='N'
             EXIT FOREACH
          END IF
 
          DELETE FROM apb_file WHERE apb01=l_apa01
          IF SQLCA.SQLCODE OR STATUS THEN
             CALL cl_err3("del","apb_file",l_apa01,"",SQLCA.sqlcode,"","del 21_apb:",1)  #No.FUN-660122
             LET g_success='N'
             EXIT FOREACH
          END IF
 
          DELETE FROM apc_file WHERE apc01=l_apa01
          IF SQLCA.SQLCODE OR STATUS THEN
             CALL cl_err3("del","apc_file",l_apa01,"",SQLCA.sqlcode,"","del 21_apc:",1) 
             LET g_success='N'
             EXIT FOREACH
          END IF
 
          DELETE FROM apk_file WHERE apk01=l_apa01
          IF SQLCA.SQLCODE OR STATUS THEN
             CALL cl_err3("del","apk_file",l_apa01,"",SQLCA.sqlcode,"","del 21_apk:",1)  #No.FUN-660122
             LET g_success='N'
             EXIT FOREACH
          END IF
        END FOREACH
      END IF
 
      IF g_success='N' THEN
         RETURN
      END IF
 
      LET toa.apa00 = '21'
      CALL s_auto_assign_no("aap",to_trtype,to_apa02,toa.apa00,"","","","","")
      RETURNING li_result,tr_no
      LET toa.apa01 = tr_no
      LET toa.apa02 = to_apa02
      LET toa.apa09 = l_apa.apa09
      LET toa.apa05 = l_apa.apa05
      LET toa.apa06 = l_apa.apa06
      LET toa.apa07 = l_apa.apa07
      LET toa.apa18 = l_apa.apa18
      LET toa.apa17 = l_apa.apa17
     #LET toa.apa171= '23'          #MOD-AC0128 mark
      LET toa.apa171= l_apa.apa171  #MOD-AC0128 
     #-MOD-AC0128-add-
      CASE 
         WHEN (toa.apa171 = '21' OR toa.apa171 = '25' OR toa.apa171 = '26')
           LET toa.apa171  = '23' 
         WHEN (toa.apa171 = '22' OR toa.apa171 = '27')
           LET toa.apa171  = '24'
         WHEN (toa.apa171 = '28')
           LET toa.apa171  = '29'
         WHEN (toa.apa171 = 'XX')
           LET toa.apa171  = 'XX'
      END CASE 
     #-MOD-AC0128-end- 
      LET toa.apa172= l_apa.apa172
      LET toa.apa08 = l_apa.apa01
      LET toa.apa11 = l_apa.apa11   #MOD-7B0101
      LET toa.apa12 = NULL
      LET toa.apa13 = l_apa.apa13
      LET toa.apa14 = l_apa.apa14    #No.MOD-530439
      LET toa.apa15 = to_apa15
      LET toa.apa16 = to_apa16
      LET toa.apa175= NULL
      LET toa.apa19 = NULL
      LET toa.apa20 = 0
      LET toa.apa21 = to_apa21
      LET toa.apa22 = to_apa22
      LET toa.apa24 = NULL
      LET toa.apa33f= 0
      LET toa.apa33 = 0
      LET toa.apa65f= 0
      LET toa.apa65 = 0
      LET toa.apa36 = to_apa36
      LET toa.apa31f= l_apa.apa60f
      LET toa.apa31 = l_apa.apa60
      LET toa.apa32f= l_apa.apa61f
      LET toa.apa32 = l_apa.apa61
      LET toa.apa35f= toa.apa31f+toa.apa32f
      LET toa.apa35 = toa.apa31 +toa.apa32
      LET toa.apa34f= toa.apa35f
      LET toa.apa34 = toa.apa35
      LET toa.apa57 = toa.apa31
      LET toa.apa57f= toa.apa31f
      LET toa.apa41 = 'Y'
      LET toa.apa42 = 'N'
      LET toa.apa44 = NULL
      LET toa.apa51 = l_c_actno
      LET toa.apa54 = l_d_actno
      LET toa.apa53 = NULL
      IF g_aza.aza63 ='Y' THEN
         LET toa.apa511= l_c_actno1
         LET toa.apa541= l_d_actno1
         LET toa.apa531= NULL
      END IF
      LET toa.apa56 = '0'
      LET toa.apa58 = '1'
      LET toa.apa60f= 0
      LET toa.apa60 = 0
      LET toa.apa61f= 0
      LET toa.apa61 = 0
      LET toa.apa63 = '1'  #MOD-C30700 add
      LET toa.apa72 = toa.apa14
      CALL t110_comp_oox(toa.apa01) RETURNING g_net
      LET toa.apa73 = toa.apa34-toa.apa35 + g_net
      LET toa.apa74 = 'N'
      LET toa.apa75 = 'N'
      LET toa.apaacti = 'Y'
      LET toa.apauser = g_user
      LET toa.apagrup = g_grup
      LET toa.apadate = g_today
      LET toa.apa930=l_apa.apa930  #FUN-670064
      LET toa.apa79 ='0'           #No.FUN-A40003   #No.FUN-A60024
      CALL s_get_doc_no(toa.apa01) RETURNING g_t1
      SELECT apyvcode INTO toa.apa77  FROM apy_file WHERE apyslip = g_t1   
        IF cl_null(toa.apa77) THEN 
           LET toa.apa77 = g_apz.apz63  #FUN-970108 add
        END IF     
      DISPLAY "insert apa:",toa.apa01,' ',toa.apa02,' ',toa.apa06 AT 2,1
 
      LET toa.apa100 = g_plant     #FUN-960141 090824 add
      LET toa.apalegal=g_legal    #FUN-980001 add
      
      LET toa.apaoriu = g_user      #No.FUN-980030 10/01/04
      LET toa.apaorig = g_grup      #No.FUN-980030 10/01/04
      INSERT INTO apa_file VALUES(toa.*)
      IF STATUS THEN
         CALL cl_err3("ins","apa_file",toa.apa01,"",SQLCA.sqlcode,"","t110_21_ins(ckp#1):",1)  #No.FUN-660122
         LET g_success = 'N'
      END IF
      CALL t110_ins_apc(toa.*)
     IF l_apa.apa08 = 'MISC' THEN
        IF NOT cl_null(inv_no) THEN
           LET l_apk03=inv_no
        END IF
        IF cl_null(l_apk03) THEN
           LET l_apk03=' '
        END IF
     END IF
 
  #在確認段寫入apk_file前,先檢核apk_file是否存在,若是則先刪除再新增
   DELETE FROM apk_file WHERE apk01=toa.apa01
   IF SQLCA.SQLCODE OR STATUS THEN
      CALL cl_err3("del","apk_file",toa.apa01,"",SQLCA.sqlcode,"","del 21_apk:",1)  #No.FUN-660122
   END IF
 
   INITIALIZE tob.* TO NULL
   INITIALIZE toapk.* TO NULL
   LET tob.apb01 = tr_no
   LET tob.apb02 = 0
   LET l_amt_totf= 0
   LET l_amt_tot = 0
   LET tob.apb13f= 0
   LET tob.apb13 = 0
   LET tob.apb14f= 0
   LET tob.apb14 = 0
   LET tob.apb15 = 0
   LET o_apk06 = 0
   LET o_apk02 = 0
 
   SELECT azi04 INTO l_azi04 FROM azi_file WHERE azi01 = l_apa.apa13
 
   DECLARE t110_21_ins CURSOR FOR
    SELECT * FROM apb_file WHERE apb01 = l_apa.apa01
                             AND apb14 !=0
 
   FOREACH t110_21_ins INTO l_apb.*
      IF STATUS THEN
         CALL cl_err('foreach 21',STATUS,0)   
         EXIT FOREACH
      END IF
 
      LET tob.apb02 = tob.apb02 + 1
 
      IF l_apb.apb13f IS NULL THEN
         LET l_apb.apb13f = 0
      END IF
 
      IF l_apb.apb14f IS NULL THEN
         LET l_apb.apb14f = 0
      END IF
 
      IF l_apb.apb15 IS NULL THEN
         LET l_apb.apb15 = 0
      END IF
 
      IF l_apb.apb14f = 0 THEN
         LET l_apb.apb14f = l_apb.apb14
      END IF
 
      LET l_amt_totf= l_amt_totf+ l_apb.apb14f
      LET l_amt_tot = l_amt_tot + l_apb.apb14
      LET tob.apb03 = l_apb.apb03
      LET tob.apb12 = l_apb.apb12
      LET tob.apb23 = l_apb.apb13f
      LET tob.apb08 = l_apb.apb13
      LET tob.apb081= l_apb.apb13
      LET tob.apb09 = l_apb.apb15
      LET tob.apb24 = l_apb.apb14f
      LET tob.apb10 = l_apb.apb14
      LET tob.apb101= l_apb.apb14
 
      IF l_apa.apa08 = 'MISC' THEN
         LET tob.apb11 = l_apk03
      ELSE
         LET tob.apb11 = l_apa.apa08
      END IF
 
      LET tob.apb21 = l_apb.apb21
      LET tob.apb31 = l_apb.apb31  #FUN-630055 add
      LET tob.apb22 = l_apb.apb22
      LET tob.apb34 = 'N'          #No.TQC-7B0083
      LET tob.apb27 = l_apb.apb27
      LET tob.apb28 = l_apb.apb28
      LET tob.apb35 = l_apb.apb35  #FUN-810045
      LET tob.apb36 = l_apb.apb36  #FUN-810045
      LET tob.apb29 = '3'
      LET tob.apb06 = l_apb.apb06
      LET tob.apb07 = l_apb.apb07
      LET tob.apb930 = l_apb.apb930 #FUN-670064
      LET tob.apblegal = g_legal    #FUN-980001 add
      LET tob.apb37 = l_apb.apb37   #FUN-9A0093 
      #TQC-C10017  --Begin
      IF cl_null(tob.apb25) THEN LET tob.apb25= ' ' END IF
      IF cl_null(tob.apb26) THEN LET tob.apb26= ' ' END IF
      IF cl_null(tob.apb27) THEN LET tob.apb27= ' ' END IF
      IF cl_null(tob.apb31) THEN LET tob.apb31= ' ' END IF
      IF cl_null(tob.apb35) THEN LET tob.apb35= ' ' END IF
      IF cl_null(tob.apb36) THEN LET tob.apb36= ' ' END IF
      IF cl_null(tob.apb930) THEN LET tob.apb930= ' ' END IF
      #TQC-C10017  --End
      INSERT INTO apb_file VALUES(tob.*)
      IF STATUS OR SQLCA.SQLCODE THEN
         CALL cl_err3("ins","apb_file",tob.apb01,tob.apb02,SQLCA.sqlcode,"","t110_21_apb(ckp#2):",1)  #No.FUN-660122
         LET g_success = 'N'
      END IF
 
      UPDATE apa_file SET apa59 = 'Y' WHERE apa01 = l_apa.apa01
      IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
         CALL cl_err3("upd","apa_file",l_apa.apa01,"",STATUS,"","upd apa:",1)
         LET g_success = 'N'
      END IF
 
      UPDATE apb_file SET apb16 = 'Y'
       WHERE apb01 = l_apb.apb01 and apb02 = l_apb.apb02
 
     LET toapk.apk01   = tob.apb01                    #折讓單
     LET toapk.apk02   = tob.apb02                    #項次
     LET toapk.apk03   = tob.apb11                    #發票號碼
     LET toapk.apk04   = toa.apa18                    #統一編號
    #LET toapk.apk05   = toa.apa09                    #發票日期  #MOD-B20017 mark
    #-MOD-B20017-add-
     LET toapk.apk05   = NULL
     DECLARE t110_apk05_c2 SCROLL CURSOR FOR
       SELECT apk05 FROM apk_file WHERE apk03=toapk.apk03
     OPEN t110_apk05_c2
     FETCH FIRST t110_apk05_c2 INTO toapk.apk05
     CLOSE t110_apk05_c2
     IF cl_null(toapk.apk05) THEN
        DECLARE t110_amd05_c2 SCROLL CURSOR FOR
          SELECT amd05 FROM amd_file WHERE amd03=toapk.apk03
        OPEN t110_amd05_c2
        FETCH FIRST t110_amd05_c2 INTO toapk.apk05
        CLOSE t110_amd05_c2
     END IF
    #-MOD-B20017-end-
     LET l_tax  = tob.apb10 * toa.apa16 /100
    #CALL cl_digcut(l_tax ,l_azi04) RETURNING l_tax   #No.TQC-CC0035   Mark
     CALL cl_digcut(l_tax ,g_azi04) RETURNING l_tax   #No.TQC-CC0035   Add
     LET toapk.apk07   = l_tax                        #稅額
     LET toapk.apk08   = tob.apb10                    #未稅金額
     LET toapk.apk06   = toapk.apk07 + toapk.apk08    #含稅金額
     LET toapk.apk06   = cl_digcut(toapk.apk06,g_azi04)
     LET toapk.apk07   = cl_digcut(toapk.apk07,g_azi04)
     LET toapk.apk08   = cl_digcut(toapk.apk08,g_azi04)
     LET toapk.apk11   = toa.apa15
     LET toapk.apk29   = toa.apa16
     LET toapk.apk12   = toa.apa13
     LET toapk.apk13   = toa.apa14
     LET toapk.apk07f  = tob.apb24 * toapk.apk29 / 100
     LET toapk.apk08f  = tob.apb24
     LET toapk.apk06f  = toapk.apk07f + toapk.apk08f
     LET toapk.apk06f  = cl_digcut(toapk.apk06f,l_azi04)
     LET toapk.apk07f  = cl_digcut(toapk.apk07f,l_azi04)
     LET toapk.apk08f  = cl_digcut(toapk.apk08f,l_azi04)
     LET toapk.apk09   = ' '
     LET toapk.apk10   = ' '
     LET toapk.apk17   = toa.apa17
    #LET toapk.apk171  = '23'          #MOD-AC0128 mark
     LET toapk.apk171  = toa.apa171    #MOD-AC0128 
    #-MOD-AC0128-add-
     CASE 
        WHEN (toapk.apk171 = '21' OR toapk.apk171 = '25' OR toapk.apk171 = '26')
          LET toapk.apk171  = '23' 
        WHEN (toapk.apk171 = '22' OR toapk.apk171 = '27')
          LET toapk.apk171  = '24'
        WHEN (toapk.apk171 = '28')
          LET toapk.apk171  = '29'
        WHEN (toapk.apk171 = 'XX')
          LET toapk.apk171  = 'XX'
     END CASE 
    #-MOD-AC0128-end- 
 
     IF toapk.apk06 > o_apk06 THEN  #取最大金額的項次為調整尾差用No.B096
        LET o_apk02=toapk.apk02
        LET o_apk06=toapk.apk06
     END IF
 
     LET toapk.apk172  = toa.apa172
     LET toapk.apk173  = 0
     LET toapk.apk174  = 0
    #LET toapk.apk175  = 0       #MOD-A30142 mark
     LET toapk.apk175  = NULL    #MOD-A30142 add
     LET toapk.apk22   = ' '
     LET toapk.apk25   = tob.apb12
     LET toapk.apk26   = l_apb.apb01
     LET toapk.apk27   = l_apb.apb02
     LET toapk.apkacti = 'Y'
     LET toapk.apkuser = g_user
     LET toapk.apkgrup = g_grup
     LET toapk.apkdate = today
     LET toapk.apklegal = g_legal #FUN-980001 add
    IF NOT cl_null(g_apa.apa77) THEN 
       LET toapk.apk32 = g_apa.apa77
    ELSE
       CALL s_get_doc_no(toapk.apk01) RETURNING g_t1
       SELECT apyvcode INTO toapk.apk32  FROM apy_file WHERE apyslip = g_t1   
        IF cl_null(toapk.apk32) THEN 
           LET toapk.apk32 = g_apz.apz63  
        END IF
    END IF
     LET toapk.apkoriu = g_user      #No.FUN-980030 10/01/04
     LET toapk.apkorig = g_grup      #No.FUN-980030 10/01/04
     INSERT INTO apk_file VALUES (toapk.*)
        IF STATUS OR SQLCA.SQLCODE THEN
           CALL cl_err3("ins","apk_file",toapk.apk01,toapk.apk02,SQLCA.sqlcode,"","21_ins_apk(ckp#3):",1)  #No.FUN-660122
           LET g_success = 'N'
        END IF
   END FOREACH
 
   CLOSE WINDOW t110_21_w
 
   IF g_success = 'Y' THEN
      CALL t110_chkapk(tr_no,g_apa.apa01,'1')
   END IF
 
END FUNCTION
 
FUNCTION t110_ins_apg()                                       #TQC-890010
  DEFINE l_apg          RECORD LIKE apg_file.*
  DEFINE l_apa00        LIKE apa_file.apa00      #No.TQC-5C0093 
  DEFINE l_api          RECORD LIKE api_file.*
  DEFINE l_amtf,l_amt   LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
 
 
  IF g_success='N' THEN
     RETURN
  END IF
 
  DECLARE api_c CURSOR FOR
      SELECT * FROM api_file WHERE api01=m_apa.apa01 AND api02='2'
 
  LET l_apg.apg02 = 0   #TQC-890010 mark回復
 
  FOREACH api_c INTO l_api.*
     LET l_apg.apg01 = g_apa80 #FUN-C70075 add
     #LET l_apg.apg01 =m_apa.apa01 #FUN-C70075 mark
     LET l_apg.apg02 =l_apg.apg02+1
     LET l_apg.apg03 = g_plant #MOD-970197 
     LET l_apg.apg04 =l_api.api26
     LET l_apg.apg06 =l_api.api40      #No.FUN-680027
     LET l_apa00 = ''   #MOD-750048
     SELECT apa00 INTO l_apa00 FROM apa_file                                                                                        
      WHERE apa01 = l_api.api26                                                                                                     
     IF l_apa00 = '26' THEN       #MOD-750056                                                                                                    
        IF l_api.api05f<0 THEN                                                                                                      
            LET l_api.api05f= l_api.api05f*(-1)                                                                                     
        END IF                                                                                                                      
        IF l_api.api05 <0 THEN                                                                                                      
            LET l_api.api05 = l_api.api05 *(-1)                                                                                     
        END IF                                                                                                                      
     END IF                                                                                                                         
     LET l_apg.apg05f=l_api.api05f
     LET l_apg.apg05 =l_api.api05
 
     LET l_apg.apglegal =g_legal #FUN-980001 add
     IF cl_null(l_apg.apg05f) THEN LET l_apg.apg05f=0 END IF   #MOD-960329 add
     IF cl_null(l_apg.apg05)  THEN LET l_apg.apg05 =0 END IF   #MOD-960329 add
     INSERT INTO apg_file VALUES(l_apg.*)
     IF STATUS OR SQLCA.SQLCODE THEN
        CALL cl_err3("ins","apg_file",l_apg.apg01,l_apg.apg02,SQLCA.sqlcode,"","ins apg:",1)  #No.FUN-660122
        LET g_success='N'
     END IF
 
     IF l_api.api26 <> 'DIFF' THEN   #MOD-720023 
        SELECT SUM(apg05f),SUM(apg05) INTO l_amtf,l_amt
          FROM apg_file,apf_file
         WHERE apg04=l_api.api26 AND apg01=apf01 AND apf41='Y'
        
        IF l_amtf IS NULL THEN
           LET l_amtf=0
        END IF
        
        IF l_amt  IS NULL THEN
           LET l_amt =0
        END IF
        
        CALL t110_comp_oox(l_api.api26) RETURNING g_net
        UPDATE apa_file SET apa35f = l_amtf,
                            apa35 = l_amt,
                            apa73 = apa34-l_amt + g_net
         WHERE apa01 = l_api.api26
        IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] = 0 THEN   #MOD-720023
           CALL cl_err3("upd","apa_file",l_api.api26,"",SQLCA.sqlcode,"","upd apa35:",1)  #No.FUN-660122
           LET g_success='N'
        END IF
 
       #--CHI-E30030 mark start--
       #SELECT SUM(apg05f),SUM(apg05) INTO l_amtf,l_amt
       #  FROM apg_file,apf_file
       # WHERE apg04=l_api.api26 AND apg01=apf01 AND apf41='Y'
       #   AND apg06=l_api.api40
       #--CHI-E30030 mark end--
        
        IF l_amtf IS NULL THEN
           LET l_amtf=0
        END IF
        
        IF l_amt  IS NULL THEN
           LET l_amt =0
        END IF
        
       #CALL t110_comp_oox1(l_api.api26,l_api.api40) RETURNING g_net   #CHI-E30030 mark
        CALL t110_comp_oox1(l_api.api26,'1') RETURNING g_net           #CHI-E30030 add
        UPDATE apc_file SET apc10 = l_amtf,
                            apc11 = l_amt,
                            apc13 = apc09-l_amt + g_net
         WHERE apc01 = l_api.api26
          #AND apc02 = l_api.api40   #CHI-E30030 mark
           AND apc02 = 1             #CHI-E30030 add
        IF SQLCA.SQLCODE OR SQLCA.SQLERRD[3] = 0 THEN   #MOD-720023
           CALL cl_err3("upd","apc_file",l_api.api26,"",SQLCA.sqlcode,"","",1) 
           LET g_success='N'
        END IF
     END IF   #MOD-720023
  END FOREACH
END FUNCTION
 
FUNCTION t110_ins_apg0()
  DEFINE l_apg          RECORD LIKE apg_file.*
  DEFINE l_api          RECORD LIKE api_file.*
  DEFINE l_amtf,l_amt   LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
  DEFINE l_cnt1         LIKE type_file.num5      #No.TQC-7B0083
 
  LET l_cnt1 = 0 
  SELECT COUNT(*) INTO l_cnt1 FROM apb_file
   WHERE apb01 = m_apa.apa01
     AND apb34 = 'Y'
  IF m_apa.apa51='UNAP' OR l_cnt1 > 0 THEN ELSE  #No.TQC-7B0083
     CALL t110_ins_apf()
     IF g_success='N' THEN
        RETURN
     END IF
  END IF
 
  LET l_apg.apg01 =m_apa.apa01
  LET l_apg.apg02 =0
  LET l_apg.apg03 = g_plant #MOD-970197  
  LET l_apg.apg04 =m_apa.apa01
 
  SELECT SUM(aph05f) INTO l_apg.apg05f FROM aph_file WHERE aph01=m_apa.apa01
 
  SELECT SUM(aph05)  INTO l_apg.apg05  FROM aph_file WHERE aph01=m_apa.apa01
 
  IF l_apg.apg05f IS NULL THEN
     LET l_apg.apg05f = 0
  END IF
 
  IF l_apg.apg05  IS NULL THEN
     LET l_apg.apg05 = 0
  END IF
 
  LET l_apg.apglegal =g_legal #FUN-980001 add
  INSERT INTO apg_file VALUES(l_apg.*)
  IF STATUS OR SQLCA.SQLCODE THEN
     CALL cl_err3("ins","apg_file",l_apg.apg01,l_apg.apg02,SQLCA.sqlcode,"","ins apg:",1)  #No.FUN-660122
     LET g_success='N'
  END IF
 
END FUNCTION
 
FUNCTION t110_ins_apf()
   DEFINE l_apf     RECORD LIKE apf_file.*
   DEFINE l_api     RECORD LIKE api_file.*#FUN-C70075 add
   DEFINE l_apa00   LIKE apa_file.apa00 #FUN-C70075 add
 
   INITIALIZE l_apf.* TO NULL
 
  #FUN-C70075 --mark--str
  #IF g_apa.apa51 = 'UNAP' THEN
  #   LET l_apf.apf00 = '11'
  #ELSE
  #FUN-C70075--mark --end
      LET l_apf.apf00 = '16'
  #END IF#FUN-C70075 mark
   LET l_apf.apf01 =m_apa.apa01
   LET l_apf.apf02 =m_apa.apa02
   LET l_apf.apf03 =m_apa.apa06
   LET l_apf.apf04 =m_apa.apa21
   LET l_apf.apf05 =m_apa.apa22
   LET l_apf.apf06 =m_apa.apa13
   LET l_apf.apf07 =m_apa.apa14
   LET l_apf.apf08f=m_apa.apa35f   #MOD-8A0004   
   LET l_apf.apf08 =m_apa.apa35    #MOD-8A0004
   LET l_apf.apf09f=0
   LET l_apf.apf09 =0
   LET l_apf.apf10f=m_apa.apa35f   #MOD-8A0004
   LET l_apf.apf10 =m_apa.apa35    #MOD-8A0004
   LET l_apf.apf12 =m_apa.apa07
   LET l_apf.apf13 =m_apa.apa18
   LET l_apf.apf41 ='Y'
   LET l_apf.apfinpd=TODAY
   LET l_apf.apfmksg='N'
   LET l_apf.apfacti='Y'
   LET l_apf.apflegal=g_legal #FUN-980001 add
   LET l_apf.apforiu = g_user      #No.FUN-980030 10/01/04
   LET l_apf.apforig = g_grup      #No.FUN-980030 10/01/04
   IF g_apa.apa55 = '2' THEN #FUN-C70075 add
      INSERT INTO apf_file VALUES(l_apf.*)
   END IF #FUN-C70075 add
   IF STATUS OR SQLCA.SQLCODE THEN
      CALL cl_err3("ins","apf_file",l_apf.apf01,"",SQLCA.sqlcode,"","ins apf:",1)  #No.FUN-660122
      LET g_success='N' 
   END IF
   #FUN-C70075 add--str
  #IF (gs_cnt >0 AND gs_cnt2 >0) OR (gs_cnt2 > 0  AND m_apa.apa55 = 2 ) THEN 
   #IF gs_cnt2 >0 THEN                          #MOD-D20176 mark
  #IF gs_cnt2 >0 OR m_apa.apa51 = 'UNAP' THEN   #MOD-D20176          #MOD-E70145 mark
   IF gs_cnt2 >0 OR m_apa.apa51 = 'UNAP' OR m_apa.apa56 = '5' THEN   #MOD-E70145 add
      LET l_apf.apf00 = '11'
      LET l_apf.apf01 = g_apa80
     #LET l_apf.apf08f = 0
     #LET l_apf.apf08 = 0 
     #LET l_apf.apf08f=m_apa.apa35f   
     #LET l_apf.apf08 =m_apa.apa35   
      DECLARE api_c_2 CURSOR FOR
         SELECT * FROM api_file WHERE api01=m_apa.apa01 AND api02='2'
      LET l_apf.apf08f = 0
      LET l_apf.apf08 = 0
      FOREACH api_c_2 INTO l_api.*
         SELECT apa00 INTO l_apa00 FROM apa_file
          WHERE apa01 = l_api.api26
         IF l_apa00 = '26' THEN       
            IF l_api.api05f<0 THEN
                LET l_api.api05f= l_api.api05f*(-1)
            END IF
            IF l_api.api05 <0 THEN
                LET l_api.api05 = l_api.api05 *(-1)
            END IF
         END IF
         LET l_apf.apf08f= l_apf.apf08f+l_api.api05f
         LET l_apf.apf08 =l_apf.apf08+l_api.api05
      END FOREACH

      INSERT INTO apf_file VALUES(l_apf.*)
      IF STATUS OR SQLCA.SQLCODE THEN
         CALL cl_err3("ins","apf_file",l_apf.apf01,"",SQLCA.sqlcode,"","ins apf:",1)
         LET g_success='N'
      END IF 
      UPDATE apa_file set apa80 = g_apa80 
       WHERE apa01 = m_apa.apa01 
      IF STATUS OR SQLCA.SQLCODE THEN
         CALL cl_err3("upd","apa_file",m_apa.apa01,"",SQLCA.sqlcode,"","upd apa:",1)
         LET g_success='N'
      END IF
   END IF 
   #FUN-C70075 add--end
END FUNCTION
 
FUNCTION t110_del_apg()
   DEFINE l_api          RECORD LIKE api_file.*
   DEFINE l_amtf,l_amt   LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
 
   DELETE FROM apf_file WHERE apf01=g_apa.apa01
   IF STATUS THEN
      CALL cl_err3("del","apf_file",g_apa.apa01,"",STATUS,"","del apf:",1)  #No.FUN-660122
      LET g_success='N'
   END IF
 
  #FUN-C70075 --mark--str
  #DELETE FROM apg_file WHERE apg01=g_apa.apa01
  #IF STATUS THEN
  #   CALL cl_err3("del","apg_file",g_apa.apa01,"",STATUS,"","del apg:",1)  #No.FUN-660122
  #   LET g_success='N'
  #END IF
  #FUn-C70075--mark--end
    
   #FUN-C70075--add--str
   DELETE FROM apf_file WHERE apf01=g_apa.apa80
   IF STATUS THEN
      CALL cl_err3("del","apf_file",g_apa.apa80,"",STATUS,"","del apf:",1)  #No.FUN-660122
      LET g_success='N'
   END IF
 
   DELETE FROM apg_file WHERE apg01=g_apa.apa80
   IF STATUS THEN
      CALL cl_err3("del","apg_file",g_apa.apa80,"",STATUS,"","del apg:",1)  #No.FUN-660122
      LET g_success='N'
   END IF
   UPDATE apa_file SET apa80 = '' WHERE apa01 = g_apa.apa01
   IF STATUS OR SQLCA.SQLCODE THEN
      CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apc11",1) 
      LET g_success='N'
   END if
   #FUN-C70075--add--end 
   DECLARE api_del_c CURSOR FOR
     SELECT * FROM api_file WHERE api01=g_apa.apa01 AND api02='2' AND api26 <> 'DIFF'   #MOD-790010
 
   FOREACH api_del_c INTO l_api.*
      SELECT SUM(apg05f),SUM(apg05) INTO l_amtf,l_amt
        FROM apg_file,apf_file
       WHERE apg04=l_api.api26 AND apg01=apf01 AND apf41='Y'
 
      IF l_amtf IS NULL THEN
         LET l_amtf=0
      END IF
 
      IF l_amt  IS NULL THEN
         LET l_amt =0
      END IF
 
      CALL t110_comp_oox(l_api.api26) RETURNING g_net
      UPDATE apa_file SET apa35f= l_amtf,
                          apa35 = l_amt,
                          apa73 = apa34 - l_amt + g_net
       WHERE apa01=l_api.api26
      IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
         CALL cl_err3("upd","apa_file",l_api.api26,"",SQLCA.sqlcode,"","upd apa35",1)  #No.FUN-660122
         LET g_success='N'
      END if
     #--CHI-E30030 mark start--
     #SELECT SUM(apg05f),SUM(apg05) INTO l_amtf,l_amt
     #  FROM apg_file,apf_file
     # WHERE apg04=l_api.api26 AND apg01=apf01 AND apf41='Y'
     #  #AND api40 =l_api.api40   #MOD-CB0107 mark
     #   AND apg06 = l_api.api40  #MOD-CB0107 add
     #--CHI-E30030 mark end--
 
      IF l_amtf IS NULL THEN
         LET l_amtf=0
      END IF
 
      IF l_amt  IS NULL THEN
         LET l_amt =0
      END IF
 
     #CALL t110_comp_oox1(l_api.api26,l_api.api40) RETURNING g_net   #CHI-E30030 mark
      CALL t110_comp_oox1(l_api.api26,'1') RETURNING g_net           #CHI-E30030 add
      UPDATE apc_file SET apc10 = l_amtf,
                          apc11 = l_amt,
                          apc13 = apc09 - l_amt + g_net
       WHERE apc01=l_api.api26
         #AND apc02=l_api.api40         #CHI-E30030      
         AND apc02= 1                   #CHI-E30030
      IF STATUS OR SQLCA.SQLCODE THEN
         CALL cl_err3("upd","apc_file",l_api.api26,"",SQLCA.sqlcode,"","upd apc11",1) 
         LET g_success='N'
      END if
   END FOREACH
END FUNCTION
 
FUNCTION t110_del_apg0()
 
   DELETE FROM apf_file WHERE apf01=g_apa.apa01
   IF STATUS THEN
      CALL cl_err3("del","apf_file",g_apa.apa01,"",STATUS,"","del apf:",1)  #No.FUN-660122
      LET g_success='N'
   END IF
 
END FUNCTION
 
FUNCTION t110_aph_upd(u_sw)
   DEFINE u_sw            LIKE type_file.num5      # No.FUN-690028 SMALLINT
   DEFINE l_amtf,l_amt    LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_amt3f,l_amt3  LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE t1,t2           LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
 
   DECLARE t110_bu_c2 CURSOR FOR
        SELECT * FROM aph_file
        WHERE aph01=m_apa.apa01 AND aph03 IN ('2','6','7','8','9','B')   #MOD-740057
 
   FOREACH t110_bu_c2 INTO m_aph.*
     IF m_aph.aph03 MATCHES '[6789]' THEN   #MOD-740057
      ELSE    #MOD-740057
         IF u_sw=1 THEN
            CALL t110_ins_nme()
         END IF
      END IF
 
   END FOREACH
 
   IF u_sw=-1 THEN   #MOD-750143 取消mark
      CALL t110_del_nme()   #MOD-750143 取消mark
   END IF   #MOD-750143 取消mark
 
   SELECT COUNT(*) INTO g_cnt FROM aph_file
    WHERE aph01 = m_apa.apa01 AND aph09 = 'Y'
 
   IF g_cnt > 0 THEN
      CALL cl_err(m_apa.apa01,'aap-228',0)
      LET g_success = 'N'
   END IF
 
END FUNCTION
 
FUNCTION t110_ins_nme()
   DEFINE l_nme          RECORD LIKE nme_file.*
   DEFINE l_legal        LIKE azw_file.azw02  #FUN-980001 add
#FUN-B30166--add--str
   DEFINE l_year     LIKE type_file.chr4
   DEFINE l_month    LIKE type_file.chr4
   DEFINE l_day      LIKE type_file.chr4
   DEFINE l_dt       LIKE type_file.chr20
   DEFINE l_date1    LIKE type_file.chr20
   DEFINE l_time     LIKE type_file.chr20
   DEFINE l_nme27    LIKE nme_file.nme27
#FUN-B30166--add--end
   DEFINE l_nma21    LIKE nma_file.nma21  #MOD-B80144
 
   IF g_apz.apz04 = 'N' THEN
      RETURN
   END IF
 
   IF m_aph.aph03 NOT MATCHES  '[2B]'  THEN   #MOD-740057
      RETURN
   END IF
 
   display "ins_nme now...."
   LET l_nme.nme00=0
   LET l_nme.nme01=m_aph.aph08
   LET l_nme.nme02=m_apa.apa02   #MOD-560240   #MOD-880017 mark回復   #MOD-880222 mark #MOD-980029 mark 恢復
   LET l_nme.nme03=m_aph.aph16
   LET l_nme.nme04=m_aph.aph05f
   LET l_nme.nme07=m_aph.aph14
   LET l_nme.nme08=m_aph.aph05
   LET l_nme.nme10=m_apa.apa44
   LET l_nme.nme12=m_apa.apa01
   LET l_nme.nme13=m_apa.apa07
   SELECT nmc05 INTO l_nme.nme14
    FROM nmc_file
      WHERE nmc01=l_nme.nme03
   LET l_nme.nme15=m_apa.apa22
   LET l_nme.nme16=m_apa.apa02
   LET l_nme.nme17=""   #MOD-740057
   LET l_nme.nmeacti='Y'
   LET l_nme.nmeuser=g_user
   LET l_nme.nmegrup=g_grup
   LET l_nme.nmedate=TODAY
   LET l_nme.nme21=m_aph.aph02
   LET l_nme.nme22='03'
   LET l_nme.nme23=m_aph.aph03
   LET l_nme.nme24='9'
   LET l_nme.nme25=m_apa.apa06
   LET l_nme.nme26 = 'N'   #FUN-870037
   LET l_nme.nmeoriu=g_user   #TQC-A10060  add
   LET l_nme.nmeorig=g_grup   #TQC-A10060  add 
 
#FUN-B30166--add--str
    LET l_date1 = g_today
    LET l_year = YEAR(l_date1)USING '&&&&'
    LET l_month = MONTH(l_date1) USING '&&'
    LET l_day = DAY(l_date1) USING  '&&'
    LET l_time = TIME(CURRENT)
    LET l_dt   = l_year CLIPPED,l_month CLIPPED,l_day CLIPPED,
                 l_time[1,2],l_time[4,5],l_time[7,8]
    SELECT MAX(nme27) + 1 INTO l_nme.nme27 FROM nme_file
     WHERE nme27[1,14] = l_dt
    IF cl_null(l_nme.nme27) THEN
       LET l_nme.nme27 = l_dt,'000001'
    END if
#FUN-B30166--add--end

   #MOD-B80144--add--str--
   LET l_nma21 = NULL
   SELECT nma21 INTO l_nma21 FROM nma_file WHERE nma01 = l_nme.nme01
   IF l_nma21 IS NOT NULL AND l_nma21 >= l_nme.nme16 THEN
      CALL cl_err(l_nme.nme16,'anm-225',1)   
      LET g_success='N'
      RETURN
   END IF
   #MOD-B80144--add--end--

   CALL s_getlegal(g_plant_new) RETURNING l_legal  #FUN-980001 add
   #LET g_sql="INSERT INTO ",g_dbs_nm,"nme_file",
   LET g_sql="INSERT INTO ",cl_get_target_table(g_plant_nm,'nme_file'), #FUN-A50102
             "       (nme00,nme01,nme02,nme03,nme04,nme07,nme08,nme10,nme11,nme12,nmeoriu,nmeorig,",    #TQC-A10060   add nmeoriu,nmeorig  #No.TQC-A30087
             "        nme13,nme14,nme15,nme16,nme17,nmeacti,nmeuser,nmegrup,nmedate,nmelegal,nme21,nme22,nme23,nme24,nme25,nme27,nme26)", #No.FUN-730032  #FUN-870037 add nme26 #FUN-980001 add nmelegal  #FUN-B30166 add nme27
             " VALUES('",l_nme.nme00,"',",
                     "'",l_nme.nme01,"',",
                     "'",l_nme.nme02,"',",
                     "'",l_nme.nme03,"',",
                     "'",l_nme.nme04,"',",
                     "'",l_nme.nme07,"',",
                     "'",l_nme.nme08,"',",
                     "'",l_nme.nme10,"',",
                     "'",l_nme.nme11,"',",
                     "'",l_nme.nme12,"',",
                     "'",l_nme.nmeoriu,"',",     #TQC-A10060   add
                     "'",l_nme.nmeorig,"',",     #TQC-A10060   add
                     "'",l_nme.nme13,"',",
                     "'",l_nme.nme14,"',",   #No:9615 040527 DSC.Anny add
                     "'",l_nme.nme15,"',",
                     "'",l_nme.nme16,"',",
                     "'",l_nme.nme17,"',",
                     "'",l_nme.nmeacti,"',",
                     "'",l_nme.nmeuser,"',",
                     "'",l_nme.nmegrup,"',",
                     "'",l_nme.nmedate,"',",
                     "'",l_legal,"',", #FUN-980001 add l_legal
                     "'",l_nme.nme21,"',",
                     "'",l_nme.nme22,"',",
                     "'",l_nme.nme23,"',",
                     "'",l_nme.nme24,"',",
                     "'",l_nme.nme25,"',",
                     "'",l_nme.nme27,"',",      #FUN-B30166 add l_nmenme27
                     "'",l_nme.nme26,"')"   #FUN-870037
 	 CALL cl_replace_sqldb(g_sql) RETURNING g_sql        #FUN-920032
     CALL cl_parse_qry_sql(g_sql,g_plant_nm) RETURNING g_sql #FUN-A50102
   PREPARE t110_y_nme_p FROM g_sql
   IF STATUS THEN
      CALL cl_err('ins nme:',STATUS,1)   
      LET g_success='N'
      RETURN
   END IF
 
   EXECUTE t110_y_nme_p
   display "status",status
   IF STATUS THEN
      CALL cl_err('ins nme:',STATUS,1)
      LET g_success='N'
   END IF
 
   display "sqlca.sqlerrd[3]=",sqlca.sqlerrd[3]
   IF SQLCA.SQLERRD[3]=0 THEN
      CALL cl_err('ins nme: ',SQLCA.SQLCODE,1)
      LET g_success='N'
      RETURN
   END IF
   CALL s_flows_nme(l_nme.*,'1',g_plant_nm)   #No.FUN-B90062   
END FUNCTION
 
FUNCTION t110_del_nme()
   DEFINE l_n     LIKE type_file.num5    #No.FUN-690028 SMALLINT
   DEFINE l_nme24      LIKE nme_file.nme24    #No.FUN-730032
   DEFINE l_aza73      LIKE aza_file.aza73    #No.MOD-740346
   #MOD-B80144--add--str--
   DEFINE l_nma21      LIKE nma_file.nma21  
   DEFINE l_nme01      LIKE nme_file.nme01  
   DEFINE l_nme16      LIKE nme_file.nme16 
   #MOD-B80144--add--end-- 
 
   IF g_apz.apz04 = 'N' THEN
      RETURN
   END IF
 
   SELECT COUNT(*) INTO l_n FROM aph_file
    #WHERE aph01=m_apa.apa01 AND aph03 = '2'   #MOD-740057
    WHERE aph01=m_apa.apa01 AND aph03 IN ('2','B')   #MOD-740057
 
   IF l_n = 0 THEN
      RETURN
   END IF

   #MOD-B80144--add--str--
   DECLARE del_nme16 CURSOR FOR
    SELECT nme01,nme16 FROM nme_file
     WHERE nme12 = m_apa.apa01
   FOREACH del_nme16 INTO l_nme01,l_nme16
      LET l_nma21 = NULL
      SELECT nma21 INTO l_nma21 FROM nma_file WHERE nma01 = l_nme01
      IF l_nma21 IS NOT NULL AND l_nma21 >= l_nme16 THEN
         CALL cl_err(l_nme16,'anm-225',1)   
         LET g_success='N'
         RETURN
      END IF
   END FOREACH
   #MOD-B80144--add--end--
 
   LET l_n = 0 
   #LET g_sql="SELECT COUNT(*) FROM ",g_dbs_nm,"nme_file",
   LET g_sql="SELECT COUNT(*) FROM ",cl_get_target_table(g_plant_nm,'nme_file'), #FUN-A50102
             " WHERE nme12='",m_apa.apa01,"'", 
             "   AND nme22 = '03' "                    #MOD-B50242 
   CALL cl_replace_sqldb(g_sql) RETURNING g_sql        #FUN-920032
   CALL cl_parse_qry_sql(g_sql,g_plant_nm) RETURNING g_sql #FUN-A50102
   PREPARE t110_x_nme_p FROM g_sql
   EXECUTE t110_x_nme_p INTO l_n
   IF l_n = 0 THEN
      RETURN
   END IF
 
   #LET g_sql="SELECT aza73 FROM ",g_dbs_nm CLIPPED,"aza_file"
   LET g_sql="SELECT aza73 FROM ",cl_get_target_table(g_plant_nm,'aza_file') #FUN-A50102
 	 CALL cl_replace_sqldb(g_sql) RETURNING g_sql        #FUN-920032
     CALL cl_parse_qry_sql(g_sql,g_plant_nm) RETURNING g_sql #FUN-A50102
   PREPARE t741_aza_p1 FROM g_sql
   DECLARE t741_aza_c1 CURSOR FOR t741_aza_p1
   OPEN t741_aza_c1
   FETCH t741_aza_c1 INTO l_aza73
   IF l_aza73 = 'Y' THEN
      #LET g_sql="SELECT nme24 FROM ",g_dbs_nm CLIPPED,"nme_file",
      LET g_sql="SELECT nme24 FROM ",cl_get_target_table(g_plant_nm,'nme_file'), #FUN-A50102
                " WHERE nme12='",m_apa.apa01,"'",   #MOD-B50242 mod nme17 -> nme12
                "   AND nme22 = '03' "              #MOD-B50242 
      CALL cl_replace_sqldb(g_sql) RETURNING g_sql        #FUN-920032
      CALL cl_parse_qry_sql(g_sql,g_plant_nm) RETURNING g_sql #FUN-A50102
      PREPARE t110_z_nme_p1 FROM g_sql
      FOREACH t110_z_nme_p1 INTO l_nme24
         IF l_nme24 <> '9' THEN
            CALL cl_err('','anm-043',1)
            LET g_success='N'
            RETURN
         END IF
      END FOREACH
   END IF #No.MOD-740346
   
   #FUN-B40056 --begin
   IF g_nmz.nmz70 ='1' THEN #No.TQC-B70021
   LET g_sql="DELETE FROM ",cl_get_target_table(g_plant_nm,'tic_file'),
             " WHERE tic04 in (",
            " SELECT nme12 FROM ",cl_get_target_table(g_plant_nm,'nme_file'),
             " WHERE nme12='",m_apa.apa01,"'",
             "   AND nme22 = '03')"
 	 CALL cl_replace_sqldb(g_sql) RETURNING g_sql   
   PREPARE t110_z_tic_p FROM g_sql
 
   EXECUTE t110_z_tic_p
 
   IF STATUS THEN
      CALL cl_err('del tic:',STATUS,1)
      LET g_success='N'
      RETURN
   END IF
   #FUN-B40056 --end 
   END IF         #No.TQC-B70021
 
   #LET g_sql="DELETE FROM ",g_dbs_nm,"nme_file",
   LET g_sql="DELETE FROM ",cl_get_target_table(g_plant_nm,'nme_file'), #FUN-A50102
             " WHERE nme12='",m_apa.apa01,"'",  #MOD-740057
             "   AND nme22 = '03' "             #MOD-B50242 
   CALL cl_replace_sqldb(g_sql) RETURNING g_sql        #FUN-920032
   CALL cl_parse_qry_sql(g_sql,g_plant_nm) RETURNING g_sql #FUN-A50102
   PREPARE t110_z_nme_p FROM g_sql
 
   EXECUTE t110_z_nme_p
 
   IF STATUS THEN
      CALL cl_err('del nme:',STATUS,1)
      LET g_success='N'
      RETURN
   END IF
 
   IF SQLCA.SQLERRD[3]=0 THEN
      CALL cl_err('no nme deleted:','aap-161',1)
      LET g_success='N'
      RETURN
   END IF
   
END FUNCTION
 
FUNCTION t110_up_gl()
DEFINE   l_tic01     LIKE tic_file.tic01   #MOD-E70117 add
DEFINE   l_tic02     LIKE tic_file.tic02   #MOD-E70117 add
 
   IF g_apa_t.apa51 != g_apa.apa51 OR g_apa_t.apa52 != g_apa.apa52 OR
      g_apa_t.apa53 != g_apa.apa53 OR g_apa_t.apa54 != g_apa.apa54 OR
      g_apa_t.apa31 != g_apa.apa31 OR g_apa_t.apa32 != g_apa.apa32 OR
      g_apa_t.apa33 != g_apa.apa33 OR g_apa_t.apa34 != g_apa.apa34 THEN
      IF cl_confirm('aap-057') THEN
         CALL t110_gen_gl()
      END IF
   END IF
 
   IF g_apa_t.apa02 != g_apa.apa02 THEN
      UPDATE npp_file SET npp02=g_apa.apa02
       WHERE npp01=g_apa.apa01
         AND npp011=1
         AND nppsys = 'AP'
      IF STATUS THEN
         CALL cl_err3("upd","npp_file",g_apa.apa01,"",STATUS,"","upd npp02:",1)  #No.FUN-660122
      END IF
      #MOD-E70117---add---str---
      SELECT nmz70 INTO g_nmz.nmz70 FROM nmz_file
      IF g_nmz.nmz70 = '3' THEN
         LET l_tic01=YEAR(g_apa.apa02)
         LET l_tic02=MONTH(g_apa.apa02)
         UPDATE tic_file SET tic01=l_tic01,
                             tic02=l_tic02
         WHERE tic04=g_apa.apa01
         IF SQLCA.sqlcode THEN
            CALL cl_err3("upd","tic_file",g_apa.apa01,"",STATUS,"","upd tic01 tic02",1)
         END IF
      END IF
      #MOD-E70117---add---end---
   END IF
 
END FUNCTION
 
FUNCTION t110_v0()
   DEFINE g_t1 LIKE oay_file.oayslip
 
   IF g_apa.apa42 = 'Y' THEN RETURN END IF
   LET g_t1=g_apa.apa01[1,g_doc_len]
   SELECT apydmy3 INTO g_apy.apydmy3 FROM apy_file WHERE apyslip=g_t1
   IF g_apy.apydmy3 <> 'Y' THEN                                                                                                     
      CALL cl_err('','aap-286',0)                                                                                                   
      RETURN                                                                                                                        
   END IF                                                                                                                           

  #-MOD-BB0304-add-
   IF g_apa.apa63 MATCHES '[Ss1]' THEN 
      CALL cl_err('','mfg3557',0)
      RETURN
   END IF
  #-MOD-BB0304-end-

  #-MOD-C30014-add-
  IF g_apa.apa56 = '5' AND g_apa.apa51 <> 'UNAP' AND g_aza.aza26 <> '2' THEN   #MOD-C70293 大陸別不需要判斷UNAP
      CALL cl_err('','aap-162',0)
      RETURN
   END IF
  #-MOD-C30014-end-

   IF cl_null(g_apa.apa99) THEN
      CALL t110_v()
   ELSE
      #多角貿易單據一次只產生一張分錄
      #且已確認但未拋轉傳票，可重新產生分錄
      CALL t110_v2()
   END IF
END FUNCTION
 
FUNCTION t110_v2()
   IF NOT cl_null(g_apa.apa44) THEN CALL cl_err('','aap-925',0) RETURN END IF
   IF cl_confirm('axr-309') THEN
      CALL t110_g_gl(g_apa.apa00,g_apa.apa01,'0','')   #FUN-9C0001 add ''
      IF g_aza.aza63 ='Y' THEN
         CALL t110_g_gl(g_apa.apa00,g_apa.apa01,'1','')   #FUN-9C0001  add ''
      END IF
   END IF
END FUNCTION
FUNCTION t110_v()
   DEFINE l_wc    STRING    #MOD-720062
   DEFINE l_apa00 LIKE apa_file.apa00
   DEFINE l_apa01 LIKE apa_file.apa01
   DEFINE l_apa58 LIKE apa_file.apa58    #85-09-26
   DEFINE only_one     LIKE type_file.chr1      # No.FUN-690028 VARCHAR(1)
   DEFINE l_t1         LIKE apy_file.apyslip    # No.FUN-690028 VARCHAR(5)                               #NO.FUN-550030
   DEFINE l_apa02       LIKE apa_file.apa02
   DEFINE l_apydmy3    LIKE type_file.chr1      # No.FUN-690028 VARCHAR(1)
   DEFINE g_t1          LIKE oay_file.oayslip                                #No.FUN-55030  #No.FUN-690028 VARCHAR(5)
   DEFINE l_cnt         LIKE type_file.num5     #FUN-530041  #No.FUN-690028 SMALLINT
   DEFINE l_cnt2        LIKE type_file.num5     #MOD-810168
 
   IF g_apa.apa41 = 'Y' THEN RETURN END IF   #MOD-720104
   IF g_apa.apa42 = 'Y' THEN RETURN END IF   #MOD-720104
 
   IF g_aptype = '13' OR g_aptype = '17' THEN
      IF g_apa.apa37f > 0 THEN
         IF cl_null(g_apa.apa101) OR cl_null(g_apa.apa102) THEN
            CALL cl_err(g_apa.apa01,'aap-095',1)
            CALL t110_upd_apa101()
            IF g_success = 'N' THEN RETURN END IF
         END IF
      END IF
   END IF
   OPEN WINDOW t110_w9 AT 10,11
     WITH FORM "aap/42f/aapt110_9"  ATTRIBUTE (STYLE = g_win_style CLIPPED) #No.FUN-580092 HCN
 
   CALL cl_ui_locale("aapt110_9")
 
   LET only_one = '1'
   CALL cl_set_head_visible("","YES")     #No.FUN-6B0033
 
   INPUT BY NAME only_one WITHOUT DEFAULTS
 
      AFTER FIELD only_one
         IF NOT cl_null(only_one) THEN
            IF only_one NOT MATCHES "[12]" THEN
               NEXT FIELD only_one
            END IF
         END IF
 
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
       ON ACTION about         #MOD-4C0121
          CALL cl_about()      #MOD-4C0121
 
       ON ACTION help          #MOD-4C0121
          CALL cl_show_help()  #MOD-4C0121
 
       ON ACTION controlg      #MOD-4C0121
          CALL cl_cmdask()     #MOD-4C0121
 
   END INPUT
 
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      CLOSE WINDOW t110_w9
      RETURN
   END IF
 
   IF only_one = '1' THEN
      LET l_wc = " apa01 = '",g_apa.apa01,"' "
   ELSE
      CALL cl_set_head_visible("","YES")     #No.FUN-6B0033
 
      CONSTRUCT BY NAME l_wc ON apa01,apa02,apa21,apa22,apa06
 
              BEFORE CONSTRUCT
                 CALL cl_qbe_init()
         ON ACTION CONTROLP
            CASE
               WHEN INFIELD(apa01) #查詢單据
                  LET g_t1=s_get_doc_no(g_apa.apa01)
                  CALL q_apy(TRUE,FALSE,g_t1,g_aptype,'AAP') RETURNING g_t1  #TQC-670008
                  LET g_apa.apa01=g_t1
                  DISPLAY BY NAME g_apa.apa01
                  NEXT FIELD apa01
               WHEN INFIELD(apa06) #PAY TO VENDOR
                  CALL cl_init_qry_var()
                  LET g_qryparam.state = "c"
                  LET g_qryparam.form ="q_pmc"  #MOD-960121  
                  LET g_qryparam.default1 = g_apa.apa06
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apa06
                  CALL t110_apa06('d')
               WHEN INFIELD(apa21) # Employee CODE
                  CALL cl_init_qry_var()
                  LET g_qryparam.state = "c"
                  LET g_qryparam.form ="q_gen"
                  LET g_qryparam.default1 = g_apa.apa21
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apa21
               WHEN INFIELD(apa22) # Dept CODE
                  CALL cl_init_qry_var()
                  LET g_qryparam.state = "c"
                  LET g_qryparam.form ="q_gem"
                  LET g_qryparam.default1 = g_apa.apa22
                  CALL cl_create_qry() RETURNING g_qryparam.multiret
                  DISPLAY g_qryparam.multiret TO apa22
               OTHERWISE EXIT CASE
            END CASE
 
         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE CONSTRUCT
 
          ON ACTION about         #MOD-4C0121
             CALL cl_about()      #MOD-4C0121
 
          ON ACTION help          #MOD-4C0121
             CALL cl_show_help()  #MOD-4C0121
 
          ON ACTION controlg      #MOD-4C0121
             CALL cl_cmdask()     #MOD-4C0121
 
                 ON ACTION qbe_select
         	   CALL cl_qbe_select()
                 ON ACTION qbe_save
		   CALL cl_qbe_save()
      END CONSTRUCT
 
      IF INT_FLAG THEN
         LET INT_FLAG=0
         CLOSE WINDOW t110_w9
         RETURN
      END IF
   END IF
 
   CLOSE WINDOW t110_w9
 
   MESSAGE "WORKING !"
   LET g_success = 'Y'
   BEGIN WORK
 
   CALL t110_lock_cl()  #FUN-C80078 add 
   OPEN t110_cl USING g_apa.apa01
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl v:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF
 
   FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
      CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF
 
   LET g_sql = "SELECT apa00,apa01,apa58,apa02 FROM apa_file ",
               " WHERE ",l_wc CLIPPED,
               "   AND apa00 = '",g_aptype,"'",
               "   AND (apa44 IS NULL OR apa44 = ' ')",
               "   AND apa41 !='Y' ",
               "   AND apa42 !='Y' "   #MOD-720104
   PREPARE t110_v_p FROM g_sql
 
   DECLARE t110_v_c CURSOR WITH HOLD FOR t110_v_p
   LET l_cnt = 0   #FUN-530041
   #FUN-B50090 add begin-------------------------
   #重新抓取關帳日期
   SELECT apz57 INTO g_apz.apz57 FROM apz_file WHERE apz00='0'
   #FUN-B50090 add -end--------------------------
   FOREACH t110_v_c INTO l_apa00,l_apa01,l_apa58,l_apa02
      IF STATUS THEN
         EXIT FOREACH
      END IF
 
      LET l_cnt2 = 0 
      SELECT COUNT(*) INTO l_cnt2 FROM npq_file
        WHERE npqsys = 'AP' AND npq00 = 1 AND npq011 = 1 AND npq01 = l_apa01
      IF l_cnt2 = 0 THEN 
         CONTINUE FOREACH
      END IF
 
      IF l_apa02 <= g_apz.apz57 THEN   #立帳日期小於關帳日期
         CALL cl_err(l_apa01,'aap-176',1)
         CONTINUE FOREACH
      END IF
 
      IF l_apa58='1' THEN             #請款折讓不產生
         IF only_one='1' THEN
            #CALL cl_err('','aap-227',0)    #TQC-C90065  mark
            CALL cl_err('','aap-260',0)     #TQC-C90065  add
            EXIT FOREACH
         END IF
         CONTINUE FOREACH
      END IF
      LET l_t1 = s_get_doc_no(l_apa01)
      LET l_apydmy3 = ''
 
      SELECT apydmy3 INTO l_apydmy3 FROM apy_file WHERE apyslip = l_t1
      IF SQLCA.sqlcode THEN
         CALL cl_err3("sel","apy_file",l_t1,"",STATUS,"","sel apy:",1)  #No.FUN-660122
      END IF
 
      IF l_apydmy3 = 'Y' THEN   #是否拋轉傳票
         IF l_cnt = 0 THEN
            IF NOT s_ask_entry(l_apa01) THEN EXIT FOREACH END IF
            DELETE FROM npq_file WHERE npqsys = 'AP' AND npq00 = 1
                                   AND npq01  = l_apa01 AND npq011 = 1
            CALL t110_g_gl(l_apa00,l_apa01,'0','')   #No.FUN-680029  #FUN-9C0001 add ''
            IF g_aza.aza63 ='Y' THEN
               CALL t110_g_gl(l_apa00,l_apa01,'1','')    #FUN-9C0001 add ''
            END IF
            LET l_cnt = l_cnt + 1
         ELSE
            DELETE FROM npq_file WHERE npqsys = 'AP' AND npq00 = 1
                                   AND npq01  = l_apa01 AND npq011 = 1
            CALL t110_g_gl(l_apa00,l_apa01,'0','')   #No.FUN-680029  #FUN-9C0001 add ''
            IF g_aza.aza63 ='Y' THEN
               CALL t110_g_gl(l_apa00,l_apa01,'1','')   #FUN-9C0001 add ''
            END IF
         END IF
      ELSE
         CALL cl_err(l_apa00,'aap-286',0)
      END IF
   END FOREACH
   LET g_sql = "SELECT apa00,apa01,apa58,apa02 FROM apa_file ",
               " WHERE ",l_wc CLIPPED,
               "   AND apa00 = '",g_aptype,"'",
               "   AND (apa44 IS NULL OR apa44 = ' ')",
               "   AND apa41 !='Y' ",
               "   AND apa42 !='Y' "   #MOD-720104
   PREPARE t110_v_p2 FROM g_sql
 
   DECLARE t110_v_c2 CURSOR WITH HOLD FOR t110_v_p2

   #FUN-B50090 add begin-------------------------
   #重新抓取關帳日期
   SELECT apz57 INTO g_apz.apz57 FROM apz_file WHERE apz00='0'
   #FUN-B50090 add -end--------------------------
   FOREACH t110_v_c2 INTO l_apa00,l_apa01,l_apa58,l_apa02
      IF STATUS THEN
          EXIT FOREACH
      END IF
 
      LET l_cnt2 = 0 
      SELECT COUNT(*) INTO l_cnt2 FROM npq_file
        WHERE npqsys = 'AP' AND npq00 = 1 AND npq011 = 1 AND npq01 = l_apa01
      IF l_cnt2 <> 0 THEN
         CONTINUE FOREACH
      END IF
 
      IF l_apa02 <= g_apz.apz57 THEN   #立帳日期小於關帳日期
         CALL cl_err(l_apa01,'aap-176',1)
         CONTINUE FOREACH
       END IF
 
      IF l_apa58='1' THEN             #請款折讓不產生
         IF only_one='1' THEN
            #CALL cl_err('','aap-227',0)    #TQC-C90065  mark
            CALL cl_err('','aap-260',0)     #TQC-C90065  add
            EXIT FOREACH
         END IF
         CONTINUE FOREACH
      END IF
 
      LET l_t1 = s_get_doc_no(l_apa01)   #FUN-530041
      LET l_apydmy3 = ''
 
      SELECT apydmy3 INTO l_apydmy3 FROM apy_file WHERE apyslip = l_t1
      IF SQLCA.sqlcode THEN
         CALL cl_err3("sel","apy_file",l_t1,"",STATUS,"","sel apy:",1)  #No.FUN-660122
      END IF
 
      IF l_apydmy3 = 'Y' THEN   #是否拋轉傳票
         CALL t110_g_gl(l_apa00,l_apa01,'0','')   #No.FUN-680029  #FUN-9C0001 add ''
         IF g_aza.aza63 ='Y' THEN
            CALL t110_g_gl(l_apa00,l_apa01,'1','')  #FUN-9C0001 add ''
         END IF
      ELSE
         CALL cl_err(l_apa00,'aap-286',0)
      END IF
   END FOREACH
 
   MESSAGE ""
   IF g_success = 'Y' THEN
      COMMIT WORK
   ELSE
      ROLLBACK WORK
   END IF
 
END FUNCTION
 
FUNCTION t110_x()
 DEFINE  l_t1        LIKE apy_file.apyslip,    # No.FUN-690028 VARCHAR(5),                #No.FUN-550030
         l_apydmy3   LIKE apy_file.apydmy3   # No.FUN-690028 VARCHAR(1)
 
   IF cl_null(g_apa.apa44) THEN
      CALL cl_err(g_apa.apa01,'aap-256',0)
      RETURN
   END IF
  IF g_apa.apa63 MATCHES '[Ss1]' THEN      #FUN-540045 #FUN-550042
    CALL cl_err('','mfg3557',0)
    RETURN
  END IF
 
 
#No.FUN-A40003 --begin
    SELECT apa79 INTO g_apa.apa79 FROM apa_file WHERE apa01 =g_apa.apa01
   #FUN-C80078 mod str---
   #IF g_apa.apa79  <> '0'  THEN   #No.FUN-A60024  #No.FUN-A80111
    IF g_apa.apa79 MATCHES '[123]' THEN
   #FUN-C80078 mod end---
       CALL cl_err('','aap-829',1) 
       RETURN 
    END IF  
#No.FUN-A40003 --end 

   LET l_t1 = s_get_doc_no(g_apa.apa01)
 
   SELECT apydmy3 INTO l_apydmy3 FROM apy_file WHERE apyslip = l_t1
   IF SQLCA.sqlcode THEN
      CALL cl_err3("sel","apy_file","","",STATUS,"","sel apy:",1)  #No.FUN-660122
      RETURN
   END IF
 
   MESSAGE "WORKING !"
 
   IF l_apydmy3 = 'Y' THEN
      CALL t110_g_gl(g_apa.apa00,g_apa.apa01,'0','')    #No.FUN-680029  #FUN-9C0001 add ''
   END IF
 
   MESSAGE " "
 
END FUNCTION
 
FUNCTION t110_j()
   DEFINE l_wc             STRING    #MOD-720062
   DEFINE i,j              LIKE type_file.num5    #No.FUN-690028 SMALLINT
   DEFINE l_apa60f         LIKE apa_file.apa60f
   DEFINE l_apa61f         LIKE apa_file.apa61f
   DEFINE l_apa61          LIKE apa_file.apa61
   DEFINE l_apa60          LIKE apa_file.apa60
   DEFINE apb14f_t         LIKE apb_file.apb14f
   DEFINE apb14_t,apb14_o  LIKE apb_file.apb14f
   DEFINE l_amt            LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_amtf           LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_apb            DYNAMIC ARRAY OF RECORD   #程式變數(Program Variables)
                              apb02    LIKE apb_file.apb02,
                              apb12    LIKE apb_file.apb12,
                              apb15    LIKE apb_file.apb15,
                              apb08    LIKE apb_file.apb08,
                              apb10    LIKE apb_file.apb10,
                              apb13f   LIKE apb_file.apb13f,
                              apb13    LIKE apb_file.apb13,
                              apb14f   LIKE apb_file.apb14f,
                              apb14    LIKE apb_file.apb14
                           END RECORD,
   l_allow_insert          LIKE type_file.num5,                #可新增否  #No.FUN-690028 SMALLINT
   l_allow_delete          LIKE type_file.num5                 #可刪除否  #No.FUN-690028 SMALLINT
   DEFINE l_apc02  LIKE apc_file.apc02  
   DEFINE l_apc08  LIKE apc_file.apc08  
   DEFINE l_apc09  LIKE apc_file.apc09  
   DEFINE l_flag   LIKE type_file.chr1      #FUN-910088--add--
 
   IF g_apa.apa56 IS NULL OR g_apa.apa56 NOT MATCHES '[346]' THEN
      CALL cl_err('','aap-157',0)
      RETURN
   END IF
 
   IF g_apa.apa42 = 'Y' THEN
      CALL cl_err('','aap-165',0)
      RETURN
   END IF
 
   IF g_apa.apa75 = 'Y' THEN
      CALL cl_err('','aap-333',0)
      RETURN
   END IF
 
   OPEN WINDOW t110_wa AT 2,2
     WITH FORM "aap/42f/aapt110_a"  ATTRIBUTE (STYLE = g_win_style CLIPPED) #No.FUN-580092 HCN
 
   CALL cl_ui_locale("aapt110_a")
 
   DISPLAY BY NAME g_apa.apa33f,g_apa.apa33
 
   SELECT SUM(apb14f),SUM(apb14)
     INTO apb14f_t,apb14_t
     FROM apb_file
    WHERE apb01 = g_apa.apa01
 
   DISPLAY BY NAME apb14f_t,apb14_t
 
   LET l_apa60f=g_apa.apa60f
   LET l_apa61f=g_apa.apa61f
   LET l_apa60 =g_apa.apa60
   LET l_apa61 =g_apa.apa61
 
   IF cl_null(g_apa.apa60) OR g_apa.apa60=0 THEN
      LET g_apa.apa60 =apb14_t
   END IF
 
   IF cl_null(g_apa.apa60f) OR g_apa.apa60f=0 THEN
      LET g_apa.apa60f=apb14f_t
   END IF
 
   IF cl_null(g_apa.apa61f) OR g_apa.apa61f=0 THEN
      LET g_apa.apa61f=g_apa.apa60f*g_apa.apa16/100
      LET g_apa.apa61f=cl_digcut(g_apa.apa61f,t_azi04)   #MOD-6B0066
   END IF
 
   IF cl_null(g_apa.apa61) OR g_apa.apa61=0 THEN
      LET g_apa.apa61 =g_apa.apa60 *g_apa.apa16/100
      LET g_apa.apa61 =cl_digcut(g_apa.apa61,g_azi04)   #MOD-6B0066
   END IF
 
   DISPLAY BY NAME g_apa.apa60f,g_apa.apa60
   DISPLAY BY NAME g_apa.apa61f,g_apa.apa61
 
   DECLARE t110_j_c CURSOR WITH HOLD FOR SELECT apb02,apb12,apb15,apb08,
                                                apb10,apb13f,apb13,apb14f,apb14
                                           FROM apb_file
                                          WHERE apb01 = g_apa.apa01
                                          ORDER BY apb02
 
   LET i = 1
 
   FOREACH t110_j_c INTO l_apb[i].*
      LET i = i + 1
   END FOREACH
 
   CALL l_apb.deleteElement(i)
   LET g_rec_b = i - 1
 
   LET l_allow_insert = cl_detail_input_auth("insert")
   LET l_allow_delete = cl_detail_input_auth("delete")
 
   INPUT ARRAY l_apb WITHOUT DEFAULTS FROM s_apb.*
         ATTRIBUTE(COUNT=g_rec_b,MAXCOUNT=g_max_rec,UNBUFFERED,
                   INSERT ROW=FALSE,DELETE ROW=FALSE,APPEND ROW=FALSE)
 
      BEFORE INPUT
         IF g_rec_b > 0 THEN
            CALL fgl_set_arr_curr(i)
         END IF
 
      BEFORE ROW
         LET i = ARR_CURR()
         CALL cl_show_fld_cont()     #FUN-550037(smin)
 
      AFTER FIELD apb15
         IF l_apb[i].apb14 = 0 THEN   #MOD-5B0255
            LET l_amt = l_apb[i].apb15 * l_apb[i].apb13
            LET l_apb[i].apb14 = l_amt
            LET l_apb[i].apb14 = cl_digcut(l_apb[i].apb14,g_azi04)   #MOD-6B0066
         END IF   #MOD-5B0255
         IF l_apb[i].apb14f = 0 THEN
            LET l_apb[i].apb14f = l_apb[i].apb15 * l_apb[i].apb13f
         END IF
         LET l_apb[i].apb14 = cl_digcut(l_apb[i].apb14,g_azi04)  #MOD-9C0085 add
 
      AFTER FIELD apb13f
         IF l_apb[i].apb14f = 0 THEN
            LET l_apb[i].apb14f = l_apb[i].apb15 * l_apb[i].apb13f
         END IF
         LET l_apb[i].apb14f= cl_digcut(l_apb[i].apb14f,t_azi04)  #MOD-9C0085 add
         IF l_apb[i].apb13 = 0 THEN
            LET l_apb[i].apb13  = l_apb[i].apb13f * g_apa.apa14
         END IF
         IF l_apb[i].apb14 = 0 THEN
            LET l_amt = l_apb[i].apb14f * g_apa.apa14
            LET l_apb[i].apb14  = l_amt
         END IF
         LET l_apb[i].apb14 = cl_digcut(l_apb[i].apb14,g_azi04)  #MOD-9C0085 add
 
      AFTER FIELD apb13
         IF g_apa.apa14 = 1 THEN
            LET l_apb[i].apb13f = l_apb[i].apb13
         END IF
    AFTER FIELD apb14f
         IF l_apb[i].apb14 = 0 THEN
            LET l_amt = l_apb[i].apb14f * g_apa.apa14
            LET l_apb[i].apb14  = l_amt
         END IF
         LET l_apb[i].apb14 = cl_digcut(l_apb[i].apb14,g_azi04)  #MOD-9C0085 add

      AFTER FIELD apb14
         IF g_apa.apa14 = 1 THEN
            LET l_apb[i].apb14f = l_apb[i].apb14
         END IF
         LET l_apb[i].apb14f= cl_digcut(l_apb[i].apb14f,t_azi04)  #MOD-9C0085 add
 
      AFTER ROW
         IF INT_FLAG THEN
            EXIT INPUT
         END IF
         IF l_apb[i].apb02 IS NOT NULL THEN
            UPDATE apb_file SET apb12 = l_apb[i].apb12,
                                apb15 = l_apb[i].apb15,
                                apb13f= l_apb[i].apb13f,
                                apb13 = l_apb[i].apb13,
                                apb14f= l_apb[i].apb14f,
                                apb14 = l_apb[i].apb14
             WHERE apb01 = g_apa.apa01
               AND apb02 = l_apb[i].apb02
         END IF
 
         IF l_apb[i].apb02 IS NULL AND l_apb[i].apb14 != 0 THEN
            SELECT MAX(apb02)+1 INTO l_apb[i].apb02 FROM apb_file
             WHERE apb01 = g_apa.apa01
            IF l_apb[i].apb02 IS NULL THEN
               LET l_apb[i].apb02 = 1
            END IF
            IF cl_null(g_apa.apa930) THEN LET g_apa.apa930 = ' ' END IF   #TQC-C10017 
            INSERT INTO apb_file (apb01,apb02,apb12,apb08,apb09,apb10,
                                  apb13,apb14,apb15,apb930,apb34,apblegal)  #FUN-670064   #No.TQC-7B0083 #FUN-960141 add apbplant #FUN-980001 add apblegal  #FUN-960141 del apbplant 090824
                          VALUES (g_apa.apa01,l_apb[i].apb02,l_apb[i].apb12,
                                  0,0,0,l_apb[i].apb13,l_apb[i].apb14,
                                  l_apb[i].apb15,g_apa.apa930,'N',g_legal)  #FUN-670064  #No.TQC-7B0083 #FUN-960141 add apbplant #FUN-980001 add g_legal #FUN-960141 del apbplant 090824
         END IF
 
         SELECT SUM(apb14f),SUM(apb14)
           INTO apb14f_t,apb14_t
           FROM apb_file
          WHERE apb01 = g_apa.apa01
 
         DISPLAY BY NAME apb14f_t,apb14_t
 
      AFTER INPUT
         IF INT_FLAG THEN
            EXIT INPUT
         END IF
 
         IF apb14_t != g_apa.apa33 THEN
            CALL cl_err('','aap-159',0)
            NEXT FIELD apb13
         END IF
 
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
       ON ACTION about         #MOD-4C0121
          CALL cl_about()      #MOD-4C0121
 
       ON ACTION help          #MOD-4C0121
          CALL cl_show_help()  #MOD-4C0121
 
       ON ACTION controlg      #MOD-4C0121
          CALL cl_cmdask()     #MOD-4C0121
     
       ON ACTION controls                       #No.FUN-6B0033                                                                       
          CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
 
   END INPUT
 
   IF NOT INT_FLAG THEN
      SELECT SUM(apb14f),SUM(apb14)
        INTO apb14f_t,apb14_t
        FROM apb_file
       WHERE apb01=g_apa.apa01
 
      IF apb14f_t IS NULL THEN
         LET apb14f_t = 0
      END IF
 
      IF apb14_t IS NULL THEN
         LET apb14_t  = 0
      END IF
 
      LET apb14f_t = cl_digcut(apb14f_t,t_azi04)   #MOD-6B0066
      LET apb14_t = cl_digcut(apb14_t,g_azi04)   #MOD-6B0066
      LET g_apa.apa60f=apb14f_t
      LET g_apa.apa60 =apb14_t
      LET apb14f_t=g_apa.apa60f*g_apa.apa16/100
      LET apb14f_t = cl_digcut(apb14f_t,t_azi04)   #MOD-6B0066
      LET apb14_t =g_apa.apa60 *g_apa.apa16/100
      LET apb14_t = cl_digcut(apb14_t,g_azi04)   #MOD-6B0066
      LET g_apa.apa61f=apb14f_t
      LET g_apa.apa61 =apb14_t
 
      DISPLAY BY NAME g_apa.apa60f,g_apa.apa61f,g_apa.apa60,g_apa.apa61
      CALL cl_set_head_visible("","YES")     #No.FUN-6B0033
 
      INPUT BY NAME g_apa.apa61f,g_apa.apa61 WITHOUT DEFAULTS
 
         AFTER INPUT
            IF INT_FLAG THEN
               EXIT INPUT
            END IF
 
         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE INPUT
 
          ON ACTION about         #MOD-4C0121
             CALL cl_about()      #MOD-4C0121
 
          ON ACTION help          #MOD-4C0121
             CALL cl_show_help()  #MOD-4C0121
 
          ON ACTION controlg      #MOD-4C0121
             CALL cl_cmdask()     #MOD-4C0121
 
       END INPUT
    END IF
 
    IF INT_FLAG THEN
       LET INT_FLAG = 0
       LET g_apa.apa60f=l_apa60f
       LET g_apa.apa61f=l_apa61f
       LET g_apa.apa60 =l_apa60
       LET g_apa.apa61 =l_apa61
    END IF
 
    CLOSE WINDOW t110_wa
 
    UPDATE apa_file SET apa60f = g_apa.apa60f,
                        apa60 = g_apa.apa60,
                        apa61f = g_apa.apa61f,
                        apa61 = g_apa.apa61
     WHERE apa01 = g_apa.apa01
 
    SELECT apa60f,apa61f,apa60,apa61
      INTO g_apa.apa60f,g_apa.apa61f,g_apa.apa60,g_apa.apa61
      FROM apa_file
     WHERE apa01=g_apa.apa01
 
    DISPLAY BY NAME g_apa.apa60f,g_apa.apa61f,g_apa.apa60,g_apa.apa61
END FUNCTION
 
 
FUNCTION t110_21()
  DEFINE l_cnt    LIKE type_file.num5    #No.FUN-690028 SMALLINT
  DEFINE l_str    LIKE type_file.chr1000 # No.FUN-690028 VARCHAR(100)
  DEFINE l_apa01  LIKE apa_file.apa01
  DEFINE l_cmd    LIKE type_file.chr1000 #No.FUN-690028 VARCHAR(100)
 
   LET l_cnt=0
   DECLARE t110_21_c2 CURSOR FOR
      SELECT apk01 FROM apk_file WHERE apk26=g_apa.apa01
 
   FOREACH t110_21_c2 INTO l_apa01
      LET l_cnt=l_cnt+1
      IF l_cnt=1 THEN
         LET l_str='("',l_apa01,'" '   #MOD-5C0123   #MOD-770081 取消mark
      ELSE
         LET l_str=l_str CLIPPED,',"',l_apa01,'"'   #MOD-5C0123   #MOD-770081 取消mark
      END IF
   END FOREACH
 
   IF l_cnt > 0 THEN
      LET l_str = l_str CLIPPED,")"   #MOD-5C0123   #MOD-770081 取消mark
      LET l_cmd = "aapt210 '' '' ", "'", l_str CLIPPED,"' "   #MOD-770081
      CALL cl_cmdrun_wait(l_cmd CLIPPED)    #FUN-660216
   ELSE
      CALL cl_err('','mfg-032',0)
   END IF
 
END FUNCTION
 
FUNCTION t110_5()
    DEFINE l_api01    LIKE api_file.api01
  # DEFINE l_cmd      LIKE type_file.chr1000 #No.FUN-690028 VARCHAR(100)#zhouxm160601 mark
    DEFINE l_cmd      STRING    #zhouxm160601 add 
    DEFINE l_str      STRING   #MOD-650085
    DEFINE l_cnt      LIKE type_file.num5    #No.FUN-690028 SMALLINT
 
    LET l_cnt=0
    DECLARE api_cus2 CURSOR FOR
      SELECT api01 FROM api_file WHERE api26=g_apa.apa01 AND api02='2' #FUN-680110   #TQC-7B0117取消mark
 
    FOREACH api_cus2 INTO l_api01
       LET l_cnt=l_cnt+1
       IF l_cnt=1 THEN
          LET l_str='("',l_api01,'" '
       ELSE
          LET l_str=l_str CLIPPED,',"',l_api01,'"'
       END IF
    END FOREACH
 
    IF l_cnt > 0 THEN
       LET l_str = l_str CLIPPED,")"
       LET l_cmd = "aapt110 '' '' ", "'", l_str CLIPPED,"' "   #MOD-650085 #FUN-680110   #TQC-7B0117
       CALL cl_cmdrun_wait(l_cmd)  #FUN-660216 add
    ELSE
       CALL cl_err('','mfg-032',0)
    END IF
 
END FUNCTION
 
FUNCTION t110_apa17(p_cmd)
   DEFINE p_cmd     LIKE type_file.chr1   # a:不必Update u:要Update  #No.FUN-690028 VARCHAR(1)
   DEFINE l_apa     RECORD LIKE apa_file.*
   DEFINE l_apa07   LIKE apa_file.apa07   #TQC-630164
   DEFINE l_apa09   LIKE apa_file.apa09   #MOD-9C0148 add
   DEFINE l_paydate LIKE type_file.dat    #MOD-9C0148 add
   DEFINE l_gec05   LIKE gec_file.gec05   #MOD-B50183
   DEFINE l_pma03   LIKE pma_file.pma03   #MOD-D10165 add
   DEFINE l_pma12   LIKE pma_file.pma12   #MOD-D10165 add
 
   IF g_apa.apa08 = 'MISC' THEN
      RETURN
   END IF
 
 #--------------MOD-C30024----------mark
 ##-MOD-BB0304-add-
 # IF g_apa.apa63 MATCHES '[Ss1]' THEN 
 #    CALL cl_err('','mfg3557',0)
 #    RETURN
 # END IF
 ##-MOD-BB0304-end-
 #--------------MOD-C30024----------mark

   LET l_apa.* = g_apa.*
   LET l_apa09 = l_apa.apa09   #MOD-9C0148 add
 
   OPEN WINDOW t110_apa17_w AT 5,11 WITH FORM "aap/42f/aapt110_g"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No.FUN-580092 HCN
 
    CALL cl_ui_locale("aapt110_g")
    IF g_aza.aza26 <> '2' THEN
       CALL cl_set_comp_visible("apa46",FALSE)
    END IF
 
    IF g_aza.aza26 = '2' THEN
       CALL cl_set_comp_visible("apa171",FALSE)
    END IF
 
    IF g_apa.apa41='Y' OR g_apa.apa08 = 'UNAP' THEN     #No.MOD-530527
     DISPLAY BY NAME l_apa.apa46,l_apa.apa08,l_apa.apa18,l_apa.apa09,l_apa.apa171,l_apa.apa17,   #FUN-650068
                     l_apa.apa172,l_apa.apa173,l_apa.apa174
     MENU ""
          ON ACTION exit
              EXIT MENU
 
          ON ACTION close   #COMMAND KEY(INTERRUPT) #FUN-9B0145  
             LET INT_FLAG=FALSE 		#MOD-570244	mars
              EXIT MENU
 
          ON ACTION controlg       #TQC-860021
             CALL cl_cmdask()      #TQC-860021
 
          ON IDLE g_idle_seconds   #TQC-860021
             CALL cl_on_idle()     #TQC-860021
             CONTINUE MENU         #TQC-860021
 
          ON ACTION about          #TQC-860021
             CALL cl_about()       #TQC-860021
 
          ON ACTION help           #TQC-860021
             CALL cl_show_help()   #TQC-860021
     END MENU
      CLOSE WINDOW t110_apa17_w
      RETURN
   ELSE
     DISPLAY BY NAME l_apa.apa08
     CALL cl_set_head_visible("","YES")     #No.FUN-6B0033
 
     INPUT BY NAME l_apa.apa46,l_apa.apa08,l_apa.apa18,l_apa.apa09,l_apa.apa171,l_apa.apa17,   #FUN-650068
                   l_apa.apa172,l_apa.apa173,l_apa.apa174
                   WITHOUT DEFAULTS
 
        AFTER FIELD apa18
           IF NOT cl_null(l_apa.apa18) THEN
              IF (g_apz.apz14 = 'Y' OR g_aza.aza21 = 'Y') AND   #FUN-990053 mod #TQC-9A0017 add (  #TQC-9A0119 mod ()
                 NOT s_chkban(l_apa.apa18) THEN #MOD-9A0145 g_apk[i].apk04-->l_apa.apa18  #TQC-9A0119 mod
                 CALL cl_err('','aoo-080',0) NEXT FIELD apa18
              END IF
              IF l_apa.apa06='MISC' THEN
                 CALL t110_input_apl(l_apa.apa18)
                 LET l_apa07 = g_apa.apa07   #TQC-630164
                 LET l_apa.apa07 = g_apa.apa07   #MOD-880103 add
              END IF
           ELSE
              IF g_aza.aza26 = '0' THEN                                                     #MOD-BB0121 add
                 LET l_gec05 = ''                                                           #MOD-B50183 
                 SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01=g_apa.apa15            #MOD-B50183
                #IF l_apa.apa06='MISC' AND l_apa.apa171!='XX' AND l_apa.apa171!='28' THEN   #MOD-880044   #MOD-880173 #MOD-B50183 mark
                 IF l_apa.apa06='MISC' AND l_apa.apa171!='XX' AND l_apa.apa171!='28'        #MOD-B50183 
                    AND l_apa.apa171!='29' AND l_gec05 NOT MATCHES '[4X]' THEN              #MOD-B50183
                    CALL cl_err('','aap-156',0)  #MOD-B10191 
                    NEXT FIELD apa18
                 END IF
                #str MOD-B40252 add
                #IF l_apa.apa171!='XX' THEN   #MOD-B50183 mark
                 IF l_apa.apa171 != 'XX' AND l_apa.apa171 !='28' AND l_apa.apa171 != '29'   #MOD-B50183
                    AND l_gec05 NOT MATCHES '[4X]' THEN                                     #MOD-B50183
                    CALL cl_err('apa18 is null: ','aap-099',0)
                    NEXT FIELD apa18
                 END IF
                #end MOD-B40252 add
              END IF                                                                        #MOD-BB0121 add
           END IF
 
         AFTER FIELD apa09   #發票日期
            #當付款基準日為發票日時,調整發票日期需重算付款日及票到期日
            IF g_aptype[1,1] = '1' AND
               l_apa.apa11 IS NOT NULL AND
               l_apa.apa09 != l_apa09 AND l_apa09 IS NOT NULL THEN
              #---------------------MOD-D10165---------------------(S)
               SELECT pma03,pma12 INTO l_pma03,l_pma12
                 FROM pma_file
                WHERE pma01 = l_apa.apa11
               IF l_pma03 MATCHES "[25]" OR l_pma12 MATCHES "[25]" THEN
              #---------------------MOD-D10165---------------------(E)
                  IF g_aptype = '13' OR g_aptype = '17' THEN
                     CALL s_paydate('a','',l_apa.apa09,l_apa.apa02,l_apa.apa11,'EMPL')
                          RETURNING l_paydate,l_apa.apa64,l_apa.apa24
                  ELSE
                     CALL s_paydate('a','',l_apa.apa09,l_apa.apa02,l_apa.apa11,l_apa.apa06)
                          RETURNING l_paydate,l_apa.apa64,l_apa.apa24
                  END IF
                  IF NOT cl_null(g_errno) THEN
                     CALL cl_err(l_apa.apa01,g_errno,0)
                     LET l_apa.apa64 = g_apa.apa64
                     LET l_apa.apa24 = g_apa.apa24
                  ELSE
                     LET l_apa.apa12 = l_paydate
                  END IF
                 #---------------------MOD-C50253----------------------(S)
                  CALL s_duedate(l_apa.apa06,l_apa.apa12,l_apa.apa24)
                       RETURNING l_apa.apa64
                 #---------------------MOD-C50253----------------------(E)
               END IF                                           #MOD-D10165 add
               #CHI-AB0017 add --start--
               IF g_apa.apa24 < 0 THEN
                  IF NOT cl_confirm('aap-142') THEN NEXT FIELD apa09 END IF
               END IF
               #CHI-AB0017 add --end--
            END IF
            LET l_apa09 = l_apa.apa09
           #--MOD-BB0022 add
            LET l_gec05 = ''
            SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01=g_apa.apa15
            IF l_gec05 NOT MATCHES '[4X]' AND cl_null(l_apa.apa09) THEN
               CALL cl_err(l_apa.apa09,'aap-099',0)
               NEXT FIELD apa09
            END IF
           #--MOD-BB0022 add

       AFTER FIELD apa171
          IF l_apa.apa171 != '21' AND l_apa.apa171 != '22' AND
             l_apa.apa171 != '23' AND l_apa.apa171 != '24' AND
             l_apa.apa171 != '25' AND l_apa.apa171 != '26' AND
             l_apa.apa171 != '27' AND l_apa.apa171 != '28' AND
             l_apa.apa171 !='XX'  AND l_apa.apa171 !='29' THEN
             NEXT FIELD apa171
          END IF
 
        AFTER FIELD apa17
           IF NOT cl_null(l_apa.apa17) THEN
               IF l_apa.apa17 <>' ' AND l_apa.apa17 NOT MATCHES '[1234]' THEN    #No.MOD-4C0091 add 3,4
                 NEXT FIELD apa17
              END IF
           END IF

       #---------------------------MOD-D30074-------------------(S)
        AFTER FIELD apa46
           IF NOT cl_null(l_apa.apa46) THEN
              IF g_aptype = '11' OR g_aptype = '12' OR
                 g_aptype = '13' OR g_aptype = '15' THEN
                 LET g_errno = ''
                 CALL t110_invoice_chk(l_apa.apa08,'',l_apa.apa09,l_apa.apa46)
                 IF NOT cl_null(g_errno) THEN
                    CALL cl_err(l_apa.apa46,g_errno,0)
                    NEXT FIELD apa46
                 END IF
              END IF
           END IF
       #---------------------------MOD-D30074-------------------(E)

       #-----------------------------MOD-C70181-------------------(S)
        AFTER INPUT
           IF l_apa.apa171 != 'XX' THEN
              IF (g_apz.apz14 = 'Y' OR g_aza.aza21 = 'Y') AND cl_null(l_apa.apa18) THEN
                  CALL cl_err('','aap-099',0)
                  NEXT FIELD apa18
              END IF
           END IF
       #-----------------------------MOD-C70181-------------------(E)

        ON IDLE g_idle_seconds
           CALL cl_on_idle()
           CONTINUE INPUT
 
        ON ACTION about         #MOD-4C0121
           CALL cl_about()      #MOD-4C0121
 
        ON ACTION help          #MOD-4C0121
           CALL cl_show_help()  #MOD-4C0121
 
        ON ACTION controlg      #MOD-4C0121
           CALL cl_cmdask()     #MOD-4C0121
 
     END INPUT
   END IF
 
   CLOSE WINDOW t110_apa17_w
 
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      RETURN
   END IF
 
   IF p_cmd='a' THEN
      LET g_apa.* = l_apa.*
      RETURN
   END IF
 
   UPDATE apa_file SET apa46 =l_apa.apa46,   #FUN-650068
                       apa18 =l_apa.apa18,
                       apa09 =l_apa.apa09,
                       apa07 =l_apa.apa07,   #MOD-880103 add
                       apa17 =l_apa.apa17,
                       apa171=l_apa.apa171,
                       apa172=l_apa.apa172,
                       apa173=l_apa.apa173,
                       apa174=l_apa.apa174,
                       apa24 =l_apa.apa24,   #MOD-9C0148 add
                       apa12 =l_apa.apa12,   #MOD-9C0148 add
                       apa64 =l_apa.apa64    #MOD-9C0148 add
                 WHERE apa01=l_apa.apa01
   IF SQLCA.SQLERRD[3]=0 THEN
      RETURN
   END IF
 
   LET g_apa.* = l_apa.*
   IF NOT cl_null(l_apa07) THEN   #MOD-790124
      LET g_apa.apa07 = l_apa07   #TQC-630164
   END IF   #MOD-790124
   IF g_apa.apa08 != 'MISC' AND g_apa.apa08 != g_apa.apa01 AND
      NOT cl_null(g_apa.apa08) AND g_apa.apa08 !='UNAP' AND
      g_apa.apa00 != '21' THEN
      CALL t110_ddd1('u')
   END IF
 
END FUNCTION
 
FUNCTION t110_apa54()
 DEFINE  l_pja02   LIKE pja_file.pja02   #FUN-810045 gja02->pja02
 DEFINE  m_aag02   LIKE aag_file.aag02
 DEFINE  m_aag151   LIKE aag_file.aag151
 DEFINE  m_aag161   LIKE aag_file.aag161
 DEFINE  m_aag171   LIKE aag_file.aag171
 DEFINE  m_aag181   LIKE aag_file.aag181
 
   IF g_apa.apa41='Y' THEN
      RETURN
   END IF
 
   IF g_apa.apa42='Y' THEN
      RETURN
   END IF
 
   OPEN WINDOW t110_apa54_w AT 3,03 WITH FORM "aap/42f/aapt110_h"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No.FUN-580092 HCN
 
    CALL cl_ui_locale("aapt110_h")
 
 
   SELECT aag02,aag151,aag161,aag171,aag181
     INTO m_aag02,m_aag151,m_aag161,m_aag171,m_aag181
     FROM aag_file WHERE aag01 = g_apa.apa54
                     AND aag00 = g_bookno1       #No.FUN-730064
                     AND aagacti = 'Y'                         #No.MOD-B70280 add
 
   IF SQLCA.sqlcode THEN
      LET m_aag02 = ' '
   END IF
 
   DISPLAY m_aag02 TO FORMONLY.aag02
   DISPLAY BY NAME g_apa.apa66
 
   SELECT pja02 INTO l_pja02 FROM pja_file WHERE pja01 =g_apa.apa66   #FUN-810045
   IF SQLCA.sqlcode THEN
      LET l_pja02 = ' '  #FUN-810045 gja02->pja02
   END IF
 
   DISPLAY l_pja02 TO FORMONLY.pja02    #FUN-810045
   CALL cl_set_head_visible("","YES")     #No.FUN-6B0033
 
   INPUT BY NAME g_apa.apa54,g_apa.apa67,g_apa.apa68,
                 g_apa.apa69,g_apa.apa70,g_apa.apa71
                 WITHOUT DEFAULTS
 
        AFTER FIELD apa67
           CALL t110_apa67(m_aag151,'1',g_apa.apa67)
           IF NOT cl_null(g_errno) THEN
              CALL cl_err('',g_errno,1)
              NEXT FIELD apa67
           END IF
 
        AFTER FIELD apa68
           CALL t110_apa67(m_aag161,'2',g_apa.apa68)
           IF NOT cl_null(g_errno) THEN
              CALL cl_err('',g_errno,1)
              NEXT FIELD apa68
           END IF
 
        AFTER FIELD apa69
           CALL t110_apa67(m_aag171,'3',g_apa.apa69)
           IF NOT cl_null(g_errno) THEN
              CALL cl_err('',g_errno,1)
              NEXT FIELD apa69
           END IF
 
        AFTER FIELD apa70
           CALL t110_apa67(m_aag181,'4',g_apa.apa70)
           IF NOT cl_null(g_errno) THEN
              CALL cl_err('',g_errno,1)
              NEXT FIELD apa70
           END IF
 
        ON ACTION CONTROLP
           CASE
              WHEN INFIELD(apa66)    #查詢專案編號
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_pja2"    #FUN-810045 
                 LET g_qryparam.default1 =g_apa.apa66
                 LET g_qryparam.arg1 = g_bookno1      #No.FUN-730064
                 CALL cl_create_qry() RETURNING g_apa.apa66
                 DISPLAY BY NAME g_apa.apa66
              WHEN INFIELD(apa67)    #查詢異動碼-1
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_aee"
                 LET g_qryparam.default1 =g_apa.apa67
                 LET g_qryparam.arg1 =g_apa.apa54
                 LET g_qryparam.arg2 =1
                 CALL cl_create_qry() RETURNING g_apa.apa67
                 DISPLAY BY NAME g_apa.apa67
              WHEN INFIELD(apa68)    #查詢異動碼-2
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_aee"
                 LET g_qryparam.default1 =g_apa.apa68
                 LET g_qryparam.arg1 =g_apa.apa54
                 LET g_qryparam.arg2 =2
                 CALL cl_create_qry() RETURNING g_apa.apa68
                 DISPLAY BY NAME g_apa.apa68
              WHEN INFIELD(apa69)    #查詢異動碼-3
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_aee"
                 LET g_qryparam.default1 =g_apa.apa69
                 LET g_qryparam.arg1 =g_apa.apa54
                 LET g_qryparam.arg2 =3
                 CALL cl_create_qry() RETURNING g_apa.apa69
                 DISPLAY BY NAME g_apa.apa69
              WHEN INFIELD(apa70)    #查詢異動碼-4
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_aee"
                 LET g_qryparam.default1 =g_apa.apa70
                 LET g_qryparam.arg1 =g_apa.apa54
                 LET g_qryparam.arg2 =4
                 CALL cl_create_qry() RETURNING g_apa.apa70
                 DISPLAY BY NAME g_apa.apa70
            END CASE
 
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
 
   END INPUT
 
   CLOSE WINDOW t110_apa54_w
 
   IF INT_FLAG THEN
      LET INT_FLAG=0
      RETURN
   END IF
 
   LET g_apa.apa72=g_apa.apa14
   CALL t110_comp_oox(g_apa.apa01) RETURNING g_net
   LET g_apa.apa73=g_apa.apa34-g_apa.apa35 + g_net
 
   UPDATE apa_file SET *=g_apa.* WHERE apa01=g_apa.apa01
 
END FUNCTION
 
FUNCTION t110_apa67(p_cmd,p_seq,p_key)
   DEFINE p_cmd      LIKE aag_file.aag151,    # 檢查否
          p_seq      LIKE aee_file.aee02,  # 項      #FUN-660117
          p_key      LIKE aee_file.aee03,  # 異動碼  #FUN-660117
          p_acno     LIKE aag_file.aag01,
          l_aeeacti  LIKE aee_file.aeeacti,
          l_aee04    LIKE aee_file.aee04
 
   LET g_errno = ' '
   SELECT aee04,aeeacti INTO l_aee04,l_aeeacti FROM aee_file
    WHERE aee01 = g_apa.apa54
      AND aee02 = p_seq
      AND aee03 = p_key
 
   CASE p_cmd
      WHEN '2'   #異動碼必須輸入不檢查
         IF p_key IS NULL OR p_key = ' ' THEN
            LET g_errno = 'agl-154'
         END IF
      WHEN '3'   #異動碼必須輸入要檢查
         CASE
            WHEN p_key IS NULL OR p_key = ' '
                 LET g_errno = 'agl-154'
            WHEN l_aeeacti = 'N' LET g_errno = '9027'
            WHEN SQLCA.sqlcode = 100 LET g_errno = 'agl-153'
            OTHERWISE  LET g_errno = SQLCA.sqlcode USING'-------'
         END CASE
      OTHERWISE EXIT CASE
   END CASE
 
END FUNCTION
 
#FUNCTION t110_c()          # 將之結案                  #FUN-D20035
FUNCTION t110_c(p_type)          # 將之結案             #FUN-D20035
 DEFINE l_apa01 LIKE apa_file.apa01,
        l_cnt   LIKE type_file.num5     #MOD-620008  #No.FUN-690028 SMALLINT
#FUN-C80078 add str---
 DEFINE l_exe_void          LIKE type_file.chr1,
        l_exe_cancel_void   LIKE type_file.chr1
#FUN-C80078 add end---
 DEFINE p_type    LIKE type_file.chr1  #FUN-D20035
 DEFINE l_flag    LIKE type_file.chr1  #FUN-D20035

 
   IF g_apa.apa01 IS NULL THEN
      RETURN
   END IF
 
   SELECT * INTO g_apa.* FROM apa_file
   WHERE apa01=g_apa.apa01

  #FUN-C80078 add str---
   IF SQLCA.sqlcode = '100' THEN
      CALL cl_err('','aap-091',0)
      LET g_errno = 'aap-091'
      LET g_success = 'N'
      RETURN
   END IF
  #FUN-C80078 add end--- 

   IF g_apa.apa41 = 'Y' THEN
      CALL cl_err('','9023',0)
      LET g_errno = '9023'  #FUN-C80078 add
      LET g_success = 'N'   #FUN-C80078 add
      RETURN
   END IF
   IF g_apa.apa63 MATCHES '[Ss1]' THEN      #FUN-540045 #FUN-550042
      CALL cl_err('','mfg3557',0)
      LET g_errno = 'mfg3557'  #FUN-C80078 add
      LET g_success = 'N'      #FUN-C80078 add
      RETURN
   END IF
   #-->為外購拋入的不可作廢
   IF g_apa.apa75 = 'Y' THEN
      CALL cl_err('','aap-332',1)
      LET g_errno = 'aap-332'  #FUN-C80078 add
      LET g_success = 'N'      #FUN-C80078 add
      RETURN
   END IF

  #FUN-C80078 add str---
   IF g_prog <> 'aws_ttsrv2' THEN
      IF g_apa.apa42 ='N' THEN
         IF g_apa.apa79 = 'N' THEN   #來源類型為HRM-新流程
            #單據來源為HRM,不可由TIPTOP直接作廢,需由HRM端發起作廢異動!
           #CALL cl_err('apa79=3','aws-456',1)   #FUN-CC0142 mark
            CALL cl_err('apa79=N','aws-456',1)   #FUN-CC0142 add
            RETURN
         END IF
      END IF
  #FUN-C80078 add end--- 
      #-->已有直接付款的資料時，不可作廢 modi 01/08/02
      SELECT COUNT(*) INTO g_cnt FROM aph_file
       WHERE aph01 = g_apa.apa01
      IF g_cnt > 0 THEN
         CALL cl_err('','aap-326',1)
         RETURN
      END IF
   END IF  #FUN-C80078 add
 
   #CHI-A80008 mark --start--
   ##---若已有發票資料，不可作廢
   #SELECT COUNT(*) INTO g_cnt FROM apk_file
   # WHERE apk01 = g_apa.apa01
   #IF g_cnt > 0 THEN
   #   CALL cl_err('','aap-327',0)
   #   RETURN
   #END IF
   #CHI-A80008 mark --end--
 
   #-----MOD-620008---------已有沖帳之資料不可作廢
   LET l_cnt=0
   SELECT COUNT(*) INTO l_cnt FROM aph_file,apf_file
     WHERE aph04 = g_apa.apa01 AND apf01=aph01
       AND apf41 != 'X'
    IF l_cnt > 0 THEN
       CALL cl_err(g_apa.apa01,'agl-906',0)
       LET g_errno = 'agl-906'  #FUN-C80078 add
       LET g_success = 'N'      #FUN-C80078 add
       RETURN
    END IF
 
   #有直接沖帳金額存在時,不可以作廢
   LET l_cnt = 0
   SELECT COUNT(*) INTO l_cnt FROM apv_file
     WHERE apv01 = g_apa.apa01
   IF l_cnt > 0 THEN
      CALL cl_err(g_apa.apa01,'anm-538',0)
      LET g_errno = 'anm-538'  #FUN-C80078 add
      LET g_success = 'N'      #FUN-C80078 add
      RETURN
   END IF
 
   #CHI-A80008 mark --start--
   ##---若有輸入單身資料必須利用 F2 刪除單身資料後，才可作廢
   ##   (因為rvb06是on line update)
   #IF g_apa.apa00 = '11' OR g_apa.apa00 = '15' OR g_apa.apa00 = '16' OR   #MOD-8B0034 add 16
   #   g_apa.apa00 = '21' OR g_apa.apa00 = '17' THEN  #NO.FUN-690080
   #   SELECT COUNT(*) INTO g_cnt FROM apb_file
   #    WHERE apb01 = g_apa.apa01
   #      AND (apb21 IS NOT NULL OR apb06 IS NOT NULL)
   #   IF g_cnt > 0 THEN
   #      CALL cl_err('','aap-328',0)
   #      RETURN
   #   END IF
   #END IF
   #CHI-A80008 mark --end--

   #FUN-D20035---begin
   #点击作废按钮
   IF p_type = 1 THEN
      IF g_apa.apa42='Y' THEN RETURN END IF
   ELSE
   #取消作废
      IF g_apa.apa42='N' THEN RETURN END IF
   END IF
   #FUN-D20035---end
 
   LET g_apa_t.* = g_apa.*       #BACKUP  #MOD-B40036  
   LET g_success='Y'
   IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
      BEGIN WORK
   END IF  #FUN-C80078 add

   CALL t110_lock_cl()  #FUN-C80078 add   
   OPEN t110_cl USING g_apa.apa01
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl c:", STATUS, 1)
      LET g_errno = 'aws-191'  #FUN-C80078 add
      LET g_success = 'N'      #FUN-C80078 add
      CLOSE t110_cl
      IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
         ROLLBACK WORK
      END IF  #FUN-C80078 add
      RETURN
   END IF
 
   FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
      CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
      LET g_errno = '-243'  #FUN-C80078 add
      LET g_success = 'N'   #FUN-C80078 add
      CLOSE t110_cl
      IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add
         ROLLBACK WORK
      END IF  #FUN-C80078 add
      RETURN
   END IF

  #FUN-C80078 add str---
   LET l_exe_void = 'N'
   LET l_exe_cancel_void = 'N'
   IF g_prog <> 'aws_ttsrv2' THEN
     #IF cl_void(0,0,g_apa.apa42) THEN                                    #FUN-D20035
      IF p_type = 1 THEN LET l_flag = 'N' ELSE LET l_flag = 'Y' END IF    #FUN-D20035
      IF cl_void(0,0,l_flag) THEN                                         #FUN-D20035
        #IF g_apa.apa42 ='N' THEN         #切換為作廢                    #FUN-D20035
         IF p_type = 1 THEN                                              #FUN-D20035  
            IF cl_confirm('aap-138') THEN
               LET l_exe_void = 'Y'     #執行作廢
            END IF
         ELSE
            IF g_apa.apa79 = 'N' THEN    #來源類型為HRM-新流程
                #單據來源為HRM,不可由TIPTOP直接作廢還原!
               #CALL cl_err('apa79=3','aws-454',1)    #FUN-CC0142 mark
                CALL cl_err('apa79=N','aws-454',1)    #FUN-CC0142 add
                RETURN
            ELSE
                LET l_exe_cancel_void = 'Y'  #執行取消作廢
            END IF
         END IF
      END IF
   ELSE
     #IF g_apa.apa42 = 'N' THEN                                          #FUN-D20035
      IF p_type = 1 THEN                                                 #FUN-D20035  
         LET l_exe_void = 'Y'              #執行作廢
      ELSE
         LET l_exe_cancel_void = 'N'
         #若是走aws_ttsrv2通道，則告知此張單據已作廢,不可再作發還原!
         LET g_errno = 'aar-107'           #該單號已作廢
         LET g_success = 'N'
         RETURN
      END IF
   END IF
  #FUN-C80078 add end---
 
  #FUN-C80078 mark str---
  #IF cl_void(0,0,g_apa.apa42) THEN
  #   IF g_apa.apa42 ='N' THEN    #切換為作廢
  #      IF cl_confirm('aap-138') THEN #CHI-A80008 add
  #FUN-C80078 mark end---
   IF l_exe_void = 'Y' THEN #執行作廢  #FUN-C80078 add
      #CHI-A80008 add --start--
      #刪除發票資料
      DELETE FROM apk_file
       WHERE apk01 = g_apa.apa01
      IF SQLCA.sqlcode THEN
         CALL cl_err3("del","apk_file",g_apa.apa01,"",SQLCA.sqlcode,"","del apk_file",1)
         LET g_success = 'N'
      END IF

      DECLARE t110_r_cur11 CURSOR WITH HOLD FOR                                                                                    
      SELECT apb02,'',apb11,apb29,apb37,apb21,apb22,apb34,'',
             apb06,apb07,apb12,apb27,
             #apb09,apb28,apb35,apb36,apb31,'','',apb25,'',apb251, #MOD-C30737 mark--
             apb09,apb28,apb31,'','',apb25,'',apb251,  #MOD-C30737
             '',apb26,'',apb35,apb36,'','',apb23,apb24,apb08,apb10, #MOD-C30737 move apb35,apb36
             apbud01,apbud02,apbud03,apbud04,apbud05,              #TQC-B20109
             apbud06,apbud07,apbud08,apbud09,apbud10,              #TQC-B20109
             apbud11,apbud12,apbud13,apbud14,apbud15               #TQC-B20109
            ,apb04,apb05                                           #CHI-B30009 add
        FROM apb_file
       WHERE apb01 = g_apa.apa01
       ORDER BY apb02
       
      LET l_ac = 1
      
     #FOREACH t110_r_cur11 INTO g_apb[l_ac].*                      #CHI-B30009 mark
      FOREACH t110_r_cur11 INTO g_apb[l_ac].*,g_apb04_t,g_apb05_t  #CHI-B30009
        IF STATUS THEN
          CALL cl_err('for apb:',STATUS,1)
          LET g_success = 'N'
          EXIT FOREACH
        END IF

        LET g_apb_t.* = g_apb[l_ac].*  #BACKUP

         #正常請款,但是對應入庫/倉退單有做過衝暫估,則不能刪除
         IF cl_null(g_apb[l_ac].apb34) OR g_apb[l_ac].apb34 = 'N' THEN
            IF g_apa.apa00 <> '22' THEN                    #MOD-AA0061
               LET l_cnt = 0
               SELECT COUNT(*) INTO l_cnt FROM apb_file
                WHERE apb21 = g_apb_t.apb21
                  AND apb22 = g_apb_t.apb22
                  AND apb34 = 'Y'
               IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
               IF l_cnt > 0 THEN
                  CALL cl_err(g_apb_t.apb21,'aap-816',1)
                  LET g_errno = 'aap-816'  #FUN-C80078 add
                  LET g_success = 'N'
                  EXIT FOREACH
               END IF
            END IF                                        #MOD-AA0061
         END IF
         #刪除單身資料
         #CHI-B20007 add --start--
         IF g_apa.apa00 = '11' OR g_apa.apa00 = '15' OR g_apa.apa00 = '16' OR  
            g_apa.apa00 = '21' OR g_apa.apa00 = '12' OR g_apa.apa00 = '26' THEN   #MOD-D20139 add 26類
            LET g_cnt = 0
            SELECT COUNT(*) INTO g_cnt FROM apb_file
             WHERE apb01 = g_apa.apa01
               AND (apb21 IS NOT NULL OR apb06 IS NOT NULL)
            IF g_cnt > 0 THEN
         #CHI-B20007 add --end--
               DELETE FROM apb_file
                WHERE apb01 = g_apa.apa01 AND apb02 = g_apb_t.apb02
               IF SQLCA.sqlcode THEN
                  CALL cl_err3("del","apb_file",g_apa.apa01,g_apb_t.apb02,SQLCA.sqlcode,"","",1)
                  LET g_success = 'N'
                  EXIT FOREACH
               ELSE
                  IF g_apa.apa08 = 'UNAP' THEN
                     IF NOT cl_null(g_apb_t.apb21) AND
                        NOT cl_null(g_apb_t.apb22) THEN
                        LET l_sql = "UPDATE ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'),
                                    "   SET rvv40 = 'N' ",
                                    " WHERE rvv01 = '",g_apb_t.apb21,"' ",
                                    "   AND rvv02 = '",g_apb_t.apb22,"' "
                        CALL cl_replace_sqldb(l_sql) RETURNING l_sql									
                        CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql            
                        PREPARE upd_rvv2 FROM l_sql
                        EXECUTE upd_rvv2 
                        IF STATUS OR SQLCA.SQLERRD[3] = 0 THEN
                           CALL cl_err3("upd","rvv_file",g_apb_t.apb21,g_apb_t.apb22,STATUS,"","upd rvv40",1)  
                           LET g_success = 'N'
                           EXIT FOREACH
                        END IF
                     END IF
                  END IF
               END IF
               #CHI-B20007 add --start--
               LET g_apa.apa31=0
               LET g_apa.apa32=0
               LET g_apa.apa31f=0
               LET g_apa.apa32f=0
               LET g_apa.apa57=0
               LET g_apa.apa57f=0
               CALL t110_apa34f('0')
               CALL t110_unpay()
               #CHI-B20007 add --end--
               #若是衝暫估,則自動產生api資料
               IF g_apb_t.apb34 = 'Y' THEN
                  CALL t110_api_unap('d')
               END IF
            END IF #CHI-B20007 add
         END IF #CHI-B20007 add
         LET g_apb[l_ac].apb29 = g_apb_t.apb29  #t110_bu中用l_ac在判斷
         CALL t110_bu(0,1,0) #FUN-CB0054 add '0'
      END FOREACH
   
      LET g_apa.apa08=''
      #CHI-B20007 mark --start--
      #LET g_apa.apa31=0
      #LET g_apa.apa32=0
      #LET g_apa.apa31f=0
      #LET g_apa.apa32f=0
      #LET g_apa.apa57=0
      #LET g_apa.apa57f=0
      #CALL t110_apa34f('0')
      #CALL t110_unpay()
      #CHI-B20007 mark --end--
      #CHI-A80008 add --end--
      LET g_apa.apa42='Y'
      LET g_apa.apa63 = '9'
      #-->刪除傳票
      DELETE FROM npp_file
       WHERE npp01 = g_apa.apa01
         AND nppsys = 'AP'
         AND npp00 = 1
         AND npp011 = 1
 
      DELETE FROM npq_file
       WHERE npq01 = g_apa.apa01
         AND npqsys = 'AP'
         AND npq00 = 1
         AND npq011 = 1

      #FUN-B40056--add--str--
      DELETE FROM tic_file WHERE tic04 = g_apa.apa01
      #FUN-B40056--add--end--

      #No.MOD-C10111 --Begin  #還原mark 
      #CHI-A80008 mark --start--
      DECLARE t110_r_cur13 CURSOR WITH HOLD FOR                                                                                    
      SELECT apb02,'',apb11,apb29,apb37,apb21,apb22,apb34,'',  #No.TQC-7B0083  #apb31/30移至apb36後  #FUN-9A0093 add apb37
             apb06,apb07,apb12,apb27,
             #apb09,apb28,apb35,apb36,apb31,'','',apb25,'',apb251,  #FUN-810045 add apb35/36 #MOD-C30737 move apb35,apb36
             apb09,apb28,apb31,'','',apb25,'',apb251,  #MOD-C30737      
             '',apb26,'',apb35,apb36,'','',apb23,apb24,apb08,apb10   #MOD-770044 #MOD-C30737 add apb35,apb36 
        FROM apb_file
       WHERE apb01 = g_apa.apa01
         AND apb21 IS NOT NULL                                   #MOD-C10063 add
         AND apb22 IS NOT NULL                                   #MOD-C10063 add
       ORDER BY apb02
       
      LET l_ac = 1
        
      FOREACH t110_r_cur13 INTO g_apb[l_ac].*
        IF STATUS THEN
          CALL cl_err('for apb:',STATUS,1)
          LET g_success = 'N'
          EXIT FOREACH
        END IF
      
        IF g_apa.apa00 = '16' OR g_apa.apa00 = '26' THEN
          #FUN-A60056--mod--str--
          #UPDATE rvv_file SET rvv88 = rvv88 - g_apb[l_ac].apb09
          # WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
           LET g_sql = "UPDATE ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'),
                       "   SET rvv88 = rvv88 - '",g_apb[l_ac].apb09,"'",
                       " WHERE rvv01 = '",g_apb[l_ac].apb21,"'",
                       "   AND rvv02 = '",g_apb[l_ac].apb22,"'"
           CALL cl_replace_sqldb(g_sql) RETURNING g_sql
           CALL cl_parse_qry_sql(g_sql,g_apb[l_ac].apb37) RETURNING g_sql
           PREPARE upd_rvv_pre1 FROM g_sql
           EXECUTE upd_rvv_pre1
          #FUN-A60056--mod--end
        ELSE  
           IF g_apb[l_ac].apb34 = 'Y' THEN
             #FUN-A60056--mod--str--
             #UPDATE rvv_file SET rvv88 = rvv88 + g_apb[l_ac].apb09
             # WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
              LET g_sql = "UPDATE ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'),
                          "   SET rvv88 = rvv88 +'", g_apb[l_ac].apb09,"'",
                          " WHERE rvv01 = '",g_apb[l_ac].apb21,"'",
                          "   AND rvv02 = '",g_apb[l_ac].apb22,"'"
              CALL cl_replace_sqldb(g_sql) RETURNING g_sql
              CALL cl_parse_qry_sql(g_sql,g_apb[l_ac].apb37) RETURNING g_sql
              PREPARE upd_rvv_pre2 FROM g_sql
              EXECUTE upd_rvv_pre2
             #FUN-A60056--mod--end
              IF STATUS THEN
                 CALL cl_err3("upd","rvv_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,STATUS,"","upd rvv88",1)
                 LET g_success='N'
                 EXIT FOREACH
              END IF
           END IF
          #FUN-A60056--mod--str--
          #UPDATE rvv_file SET rvv23 = rvv23 - g_apb[l_ac].apb09
          # WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
           LET g_sql = "UPDATE ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'),
                       "   SET rvv23 = rvv23 - '",g_apb[l_ac].apb09,"'",
                       " WHERE rvv01 = '",g_apb[l_ac].apb21,"'",
                       "   AND rvv02 = '",g_apb[l_ac].apb22,"'" 
           CALL cl_replace_sqldb(g_sql) RETURNING g_sql
           CALL cl_parse_qry_sql(g_sql,g_apb[l_ac].apb37) RETURNING g_sql
           PREPARE upd_rvv_pre3 FROM g_sql
           EXECUTE upd_rvv_pre3
          #FUN-A60056--mod--end
        END IF
        IF STATUS THEN
           CALL cl_err3("upd","rvv_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,STATUS,"","upd rvv23/rvv88",1)  #No.TQC-7B0083
           LET g_success='N'
           EXIT FOREACH
        END IF
      END FOREACH
      #CHI-A80008 mark --end--
      #No.MOD-C10111 --End  #還原mark 
 
       #-->若已有相對應之折讓單，須先行刪除折讓單
       SELECT apa01 INTO l_apa01 FROM apa_file
        WHERE apa08 = g_apa.apa01 AND apa58 = '1'
       IF STATUS <> 100 THEN
          DELETE FROM apa_file WHERE apa01 = l_apa01
          IF STATUS THEN
             CALL cl_err3("del","apa_file",l_apa01,"",STATUS,"","del apa_21:",1)  #No.FUN-660122
             LET g_success='N'
          END IF
 
          DELETE FROM apc_file WHERE apc01 = l_apa01
          IF STATUS THEN
             CALL cl_err3("del","apc_file",l_apa01,"",STATUS,"","del apc_21:",1)  #No.FUN-660122
             LET g_success='N'
          END IF
          DELETE FROM apb_file WHERE apb01 = l_apa01
          IF STATUS THEN
             CALL cl_err3("del","apb_file",l_apa01,"",STATUS,"","del apb_21:",1)  #No.FUN-660122
             LET g_success='N'
          END IF
 
          DELETE FROM apk_file WHERE apk01 = l_apa01
          IF STATUS THEN
             CALL cl_err3("del","apk_file",l_apa01,"",STATUS,"","del apk_21:",1)  #No.FUN-660122
             LET g_success = 'N'
          END IF
       END IF
    END IF  #CHI-A80008 add
   #ELSE                        #取消作廢  #FUN-C80078 mark
    IF l_exe_cancel_void = 'Y' THEN #執行取消作廢  #FUN-C80078 add
            LET g_apa.apa63 = '0'
            LET g_apa.apa42='N'
 
         DECLARE t110_r_cur12 CURSOR WITH HOLD FOR                                                                                    
         SELECT apb02,'',apb11,apb29,apb37,apb21,apb22,apb34,'',   #No.TQC-7B0083   #FUN-9A0093 add apb37
                apb06,apb07,apb12,apb27,
                #apb09,apb28,apb35,apb36,apb31,'','',apb25,'',  #FUN-810034 add apb35/apb36 #MOD-C30737 mark--
                apb09,apb28,apb31,'','',apb25,'',  #MOD-C30737
                apb251,'',apb26,'',apb35,apb36,'','',apb23,apb24,apb08,apb10,   #MOD-770044 #MOD-C30737 move apb35,apb36
                apbud01,apbud02,apbud03,apbud04,apbud05,            #TQC-B20109
                apbud06,apbud07,apbud08,apbud09,apbud10,            #TQC-B20109
                apbud11,apbud12,apbud13,apbud14,apbud15             #TQC-B20109
          #FROM apb_file                                            #MOD-BC0153 mark
           FROM apb_file,apa_file                                   #MOD-BC0153 add
          WHERE apb01 = g_apa.apa01
            AND apa01 = apb01                                       #MOD-BC0153 add
            AND apa00 NOT IN ('13','17')                            #MOD-BC0153 add
            AND apb21 IS NOT NULL                                   #MOD-C10063 add
            AND apb22 IS NOT NULL                                   #MOD-C10063 add
          ORDER BY apb02
 
         LET l_ac = 1
 
         FOREACH t110_r_cur12 INTO g_apb[l_ac].*
           IF STATUS THEN
             CALL cl_err('for apb:',STATUS,1)
             LET g_success = 'N'
             EXIT FOREACH
           END IF
 
           IF g_apa.apa00 = '16' OR g_apa.apa00 = '26' THEN
             #FUN-A60056--mod--str-- 
             #UPDATE rvv_file SET rvv88 = rvv88 + g_apb[l_ac].apb09
             # WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
              LET g_sql = "UPDATE ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'),
                          "   SET rvv88 = rvv88 + '",g_apb[l_ac].apb09,"'",
                          " WHERE rvv01 = '",g_apb[l_ac].apb21,"'",
                          "   AND rvv02 = '",g_apb[l_ac].apb22,"'" 
              CALL cl_replace_sqldb(g_sql) RETURNING g_sql
              CALL cl_parse_qry_sql(g_sql,g_apb[l_ac].apb37) RETURNING g_sql
              PREPARE upd_rvv4 FROM g_sql
              EXECUTE upd_rvv4 
             #FUN-A60056--mod--end
           ELSE
              IF g_apb[l_ac].apb34 = 'Y' THEN
                #FUN-A60056--mod--str--
                #UPDATE rvv_file SET rvv88 = rvv88 - g_apb[l_ac].apb09
                # WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
                 LET g_sql = "UPDATE ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'),
                             "   SET rvv88 = rvv88 - '",g_apb[l_ac].apb09,"'",
                             " WHERE rvv01 = '",g_apb[l_ac].apb21,"'",
                             "   AND rvv02 = '",g_apb[l_ac].apb22,"'" 
                 CALL cl_replace_sqldb(g_sql) RETURNING g_sql
                 CALL cl_parse_qry_sql(g_sql,g_apb[l_ac].apb37) RETURNING g_sql
                 PREPARE upd_rvv5 FROM g_sql
                 EXECUTE upd_rvv5
                #FUN-A60056--mod--end
                 IF STATUS THEN
                    CALL cl_err3("upd","rvv_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,STATUS,"","upd rvv88",1)
                    LET g_success='N'
                    EXIT FOREACH
                 END IF
              END IF
             #FUN-A60056--mod--str--
             #UPDATE rvv_file SET rvv23 = rvv23 + g_apb[l_ac].apb09
             # WHERE rvv01 = g_apb[l_ac].apb21 AND rvv02 = g_apb[l_ac].apb22
              LET g_sql = "UPDATE ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'),
                          "   SET rvv23 = rvv23 + '",g_apb[l_ac].apb09,"'",
                          " WHERE rvv01 = '",g_apb[l_ac].apb21,"'",
                          "   AND rvv02 = '",g_apb[l_ac].apb22,"'"  
              CALL cl_replace_sqldb(g_sql) RETURNING g_sql
              CALL cl_parse_qry_sql(g_sql,g_apb[l_ac].apb37) RETURNING g_sql
              PREPARE upd_rvv_pre6 FROM g_sql
              EXECUTE upd_rvv_pre6
             #FUN-A60056--mod--end
           END IF
           IF STATUS THEN
              CALL cl_err3("upd","rvv_file",g_apb[l_ac].apb21,g_apb[l_ac].apb22,STATUS,"","upd rvv23/rvv88",1) #No.TQC-7B0083
              LET g_success='N'
              EXIT FOREACH
           END IF
         END FOREACH
      END IF

   IF l_exe_void = 'Y' OR l_exe_cancel_void = 'Y' THEN  #FUN-C80078 add 
      #CHI-A80008 mod --start--
      #UPDATE apa_file SET (apa41,apa42,apa63,apaacti ) =
      #                    (g_apa.apa41,g_apa.apa42,g_apa.apa63,g_apa.apaacti) 
      UPDATE apa_file SET (apa41,apa42,apa63,apaacti,apa08,
                           apa31,apa32,apa31f,apa32f,apa57,apa57f,
                           apa33,apa33f,apa34,apa34f,apa37,apa37f) =  
                          (g_apa.apa41,g_apa.apa42,g_apa.apa63,g_apa.apaacti,g_apa.apa08,
                           g_apa.apa31,g_apa.apa32,g_apa.apa31f,g_apa.apa32f,g_apa.apa57,g_apa.apa57f,
                           g_apa.apa33,g_apa.apa33f,g_apa.apa34,g_apa.apa34f,g_apa.apa37,g_apa.apa37f)
      #CHI-A80008 mod --end--
       WHERE apa01 = g_apa.apa01
      IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
         CALL cl_err3("upd","apa_file",g_apa.apa01,"",STATUS,"","",1)  #No.FUN-660122
         LET g_success='N'
      END IF
 
      IF SQLCA.sqlerrd[3] = 0 THEN
         CALL cl_err('','aap-161',0)
         LET g_errno = 'aap-161'  #FUN-C80078 add
         LET g_success='N'
      END IF
   END IF

   IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add 
      IF g_success='N' THEN
         ROLLBACK WORK
         LET g_apa.* = g_apa_t.*       #MOD-B40036
      ELSE
         COMMIT WORK
         CALL cl_flow_notify(g_apa.apa01,'V')
      END IF
  #FUN-C80078 add str---
   ELSE
      RETURN
   END IF
  #FUN-C80078 add end---

   IF g_prog <> 'aws_ttsrv2' THEN  #FUN-C80078 add 
      DISPLAY BY NAME g_apa.apa41,g_apa.apa42,g_apa.apa63,g_apa.apaacti
                      ,g_apa.apa08,g_apa.apa31,g_apa.apa32,g_apa.apa31f,g_apa.apa32f,g_apa.apa57 #CHI-A80008 add
      CALL t110_b_fill(' 1=1') #CHI-A80008 add
   END IF  #FUN-C80078 add
 
END FUNCTION
 
FUNCTION t110_ins_apk()
 DEFINE l_azi04 LIKE azi_file.azi04
 DEFINE g_apk RECORD LIKE apk_file.*
 DEFINE h_apk RECORD LIKE apk_file.*     #原始發票之情況
 DEFINE l_sql  STRING   #MOD-590460  #No.FUN-690028 VARCHAR(500)   #MOD-720062
 DEFINE g_t1    LIKE oay_file.oayslip   #FUN-990014 add
 
    INITIALIZE g_apk.* TO NULL
    #..讀取原始發票資料
    IF g_apb[l_ac].apb11 IS NULL OR g_apb[l_ac].apb11 = ' ' THEN
       SLEEP 0
    ELSE
#MOD-590460 只抓取發票檔的第一筆,避免有多筆相同發票號碼而導致新增發票錯誤.
 LET l_sql = " SELECT * FROM apk_file ",
 " WHERE apk03 = '",g_apb[l_ac].apb11,"'",
                    " AND (apk171 = '21' OR apk171 = '22' OR apk171 = '25' ",
                    " OR apk171='28')"
        PREPARE t110_ins_apk_p FROM l_sql
        DECLARE t110_ins_apk_c CURSOR FOR t110_ins_apk_p
        OPEN t110_ins_apk_c
        FETCH t110_ins_apk_c INTO h_apk.*
       IF STATUS THEN
          RETURN TRUE
       END IF
 
       IF h_apk.apk171 = '21' OR  h_apk.apk171= '25' THEN
          LET g_apa.apa171 = '23'
       ELSE
          IF h_apk.apk171='28' THEN
             LET g_apa.apa171='29'
          ELSE
          LET g_apa.apa171 = '24'
          END IF
       END IF
    END IF
 
    LET g_apk.apk01=g_apa.apa01
    LET g_apk.apk02=g_apb[l_ac].apb02
    LET g_apk.apk03=g_apb[l_ac].apb11                      #發票號碼
    LET g_apk.apk04=g_apa.apa18                            #統一編號
    LET g_apk.apk05=h_apk.apk05                            #發票號碼
    LET g_apk.apk07=g_apb[l_ac].apb10 * g_apa.apa16 /100   #稅額
    LET g_apk.apk08=g_apb[l_ac].apb10                      #未稅金額
    LET g_apk.apk06=g_apk.apk07+g_apk.apk08
    #no.A010依本幣取位
    LET g_apk.apk06 = cl_digcut(g_apk.apk06,g_azi04)
    LET g_apk.apk07 = cl_digcut(g_apk.apk07,g_azi04)
    LET g_apk.apk08 = cl_digcut(g_apk.apk08,g_azi04)
    #no.5954 增加幣別等欄位
    LET g_apk.apk11 = g_apa.apa15
    LET g_apk.apk29 = g_apa.apa16
    LET g_apk.apk12 = g_apa.apa13
    LET g_apk.apk13 = g_apa.apa14
    LET g_apk.apk07f= g_apb[l_ac].apb24 * g_apk.apk29 / 100
    LET g_apk.apk08f= g_apb[l_ac].apb24
    LET g_apk.apk06f= g_apk.apk07f + g_apk.apk08f
    SELECT azi04 INTO l_azi04 FROM azi_file WHERE azi01 = g_apk.apk12
    LET g_apk.apk06f= cl_digcut(g_apk.apk06f,l_azi04)
    LET g_apk.apk07f= cl_digcut(g_apk.apk07f,l_azi04)
    LET g_apk.apk08f= cl_digcut(g_apk.apk08f,l_azi04)
    LET g_apk.apk09=' '
    LET g_apk.apk10=' '
    LET g_apk.apk17 =g_apa.apa17
    LET g_apk.apk171=g_apa.apa171
    LET g_apk.apk172=g_apa.apa172
    LET g_apk.apk173=0
    LET g_apk.apk174=0
   #LET g_apk.apk175=0      #MOD-A30142 mark
    LET g_apk.apk175=NULL   #MOD-A30142 add
    LET g_apk.apkacti='Y'
    LET g_apk.apkgrup=g_grup
    LET g_apk.apkuser=g_user
    LET g_apk.apkdate=g_today
    LET g_apk.apklegal = g_legal #FUN-980001 add
    LET g_apk.apkoriu = g_user  #TQC-A10060 add
    LET g_apk.apkorig = g_grup  #TQC-A10060 add
   IF NOT cl_null(g_apa.apa77) THEN 
      LET g_apk.apk32 = g_apa.apa77
   ELSE
      CALL s_get_doc_no(g_apk.apk01) RETURNING g_t1
      SELECT apyvcode INTO g_apk.apk32  FROM apy_file WHERE apyslip = g_t1   
       IF cl_null(g_apk.apk32) THEN 
          LET g_apk.apk32 = g_apz.apz63  
       END IF
   END IF
    LET g_apk.apkoriu = g_user      #No.FUN-980030 10/01/04
    LET g_apk.apkorig = g_grup      #No.FUN-980030 10/01/04
    INSERT INTO apk_file VALUES (g_apk.*)
    IF STATUS THEN
       RETURN TRUE
    END IF
 
    RETURN FALSE
 
END FUNCTION
 
#FUN-A60056--mark--str--
##-------------------------------------------------------------------------#
## 讀取驗收之請款單價 rvb10
##-------------------------------------------------------------------------#
#FUNCTION t110_read_rvv_rvb10(f_apb21,f_apb22)
#   DEFINE f_apb21        LIKE apb_file.apb21
#   DEFINE f_apb22        LIKE apb_file.apb22
#   DEFINE f_rvv   RECORD LIKE rvv_file.*
#   DEFINE f_rvb   RECORD LIKE rvb_file.*
#
#   SELECT * INTO f_rvv.* FROM rvv_file WHERE rvv01 = f_apb21
#                          AND rvv02 = f_apb22
#   IF STATUS THEN
#      RETURN 0
#   END IF
#
#   IF f_rvv.rvv04 IS NULL OR f_rvv.rvv04 = ' ' THEN
#      RETURN 0
#   END IF
#
#   SELECT * INTO f_rvb.* FROM rvb_file WHERE rvb01 = f_rvv.rvv04
#                          AND rvb02 = f_rvv.rvv05
#
#   IF STATUS THEN
#      RETURN 0
#   END IF
#
#   IF f_rvb.rvb10 IS NULL THEN
#      LET f_rvb.rvb10 = 0
#   END IF
#
#   RETURN f_rvb.rvb10
#
#END FUNCTION
#FUN-A60056--mark--end
 
#檢查發票是否重覆
FUNCTION t110_duplicate(l_apk02,l_apk03,l_n)
    DEFINE l_apk03         LIKE apk_file.apk03,
           l_idx,l_n       LIKE type_file.num10,   #No.FUN-690028 INTEGER
           l_apk02         LIKE apk_file.apk02
    DEFINE l_gec08         LIKE gec_file.gec08     #MOD-AA0035
    DEFINE l_gec05         LIKE gec_file.gec05     #MOD-AA0035
    DEFINE l_idx2          LIKE type_file.num10    #MOD-AA0035 

    LET g_errno = ''
    FOR l_idx=1 TO l_n
       #-MOD-AA0035-add-
        SELECT gec05,gec08 INTO l_gec05,l_gec08 FROM gec_file
         WHERE gec01 = g_apk[l_idx].apk11  AND gec011 = '1'
        IF status THEN LET l_gec05='' LET l_gec08='' END IF
        IF l_gec08 = 'XX' THEN CONTINUE FOR END IF
       #IF l_gec08 = '22' THEN CONTINUE FOR END IF                 #MOD-C90054 mark
        IF l_gec05 NOT MATCHES '[2356]' THEN CONTINUE FOR END IF   #MOD-C90054 add
       #-MOD-B30622-mark-
       #IF l_gec05='2' OR l_gec05='3' THEN
       #   FOR l_idx2 = 3 TO 10
       #      IF cl_null(l_apk03[l_idx2,l_idx2]) THEN
       #         LET g_errno='aap-760'
       #         EXIT FOR
       #      END IF
       #   END FOR
       #END IF
       #-MOD-B30622-end-
       #-MOD-AA0035-end-

        IF g_apk[l_idx].apk03=l_apk03 THEN
           LET g_errno='aap-034'
        END IF
 
        IF NOT cl_null(l_apk02) THEN
           IF g_apk_c[l_idx].apk02=l_apk02 AND g_apk_c[l_idx].apk03=l_apk03 THEN
              LET g_errno='aap-034'
           END IF
        END IF
    END FOR
 
    RETURN
 
END FUNCTION
 
FUNCTION t110_date()
    DEFINE l_date      LIKE type_file.num5    # No.FUN-690028 SMALLINT
    DEFINE l_flag      LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
    DEFINE l_paydate   LIKE type_file.dat     #No.FUN-690028 DATE
    DEFINE l_cnt       LIKE type_file.num5    #CHI-A50042 add
    DEFINE l_w         LIKE type_file.num5    #CHI-C10043 add
    DEFINE l_pma11     LIKE pma_file.pma11    #CHI-C10043 add
    DEFINE l_sme02     LIKE sme_file.sme02    #CHI-C10043 add
    DEFINE l_apa64     LIKE apa_file.apa64    #CHI-C10043 add
 
    IF s_aapshut(0) THEN
       RETURN
    END IF
 
    IF g_apa.apa01 IS NULL THEN
       CALL cl_err('',-400,0)
       RETURN
    END IF
 
    SELECT * INTO g_apa.* FROM apa_file WHERE apa01=g_apa.apa01
 
    IF g_apa.apaacti ='N' THEN
       CALL cl_err(g_apa.apa01,'9027',0)
       RETURN
    END IF
 
    IF g_apa.apa41='N' THEN
       CALL cl_err(g_apa.apa01,'aap-717',0)
       RETURN
    END IF
 
    IF g_apa.apa41 = "Y" AND g_apa.apa55 = "2" THEN
       CALL cl_err(g_apa.apa01,'aap-997',0)
       RETURN
    END IF
 
   #-MOD-AB0117-add-
    #IF g_apa.apa00 = "13" AND (g_apa.apa34  - g_apa.apa35) = 0 THEN                          #No.TQC-B50108
    IF (g_apa.apa00 = "13" OR g_apa.apa00 = '17') AND (g_apa.apa34  - g_apa.apa35) = 0 THEN   #No.TQC-B50108
       RETURN
    END IF
   #-MOD-AB0117-end-

    #CHI-A50042 add --start--
    LET l_cnt = 0
    SELECT COUNT(*) INTO l_cnt FROM apc_file WHERE apc01 = g_apa.apa01 
    IF l_cnt > 1 THEN
       LET g_modify_date = 'Y'
       CALL t110_account_period()
       LET g_modify_date = NULL
       RETURN  
    END IF
    #CHI-A50042 add --end--

   #-MOD-BB0304-add-
   #IF g_apa.apa63 MATCHES '[Ss1]' THEN            #MOD-C20162 mark
    IF g_apa.apa63 MATCHES '[Ss]' THEN             #MOD-C20162 add
       CALL cl_err('','mfg3557',0)
       RETURN
    END IF
   #-MOD-BB0304-end-

    BEGIN WORK
    CALL t110_lock_cl()  #FUN-C80078 add
    OPEN t110_cl USING g_apa.apa01
    IF STATUS THEN
       CALL cl_err("OPEN t110_cl date:", STATUS, 1)
       CLOSE t110_cl
       ROLLBACK WORK
       RETURN
    END IF
 
    FETCH t110_cl INTO g_apa.*               # 對DB鎖定
    IF STATUS THEN
       CALL cl_err('Lock apa:',STATUS,0)
       ROLLBACK WORK
       RETURN
    END IF
 
    LET g_apa_t.*=g_apa.*
    LET g_apa_o.*=g_apa.*
 
    WHILE TRUE
       CALL cl_set_head_visible("","YES")     #No.FUN-6B0033
 
       INPUT BY NAME g_apa.apa11,g_apa.apa12,g_apa.apa24,g_apa.apa64
              WITHOUT DEFAULTS
 
          AFTER FIELD apa11
             IF NOT cl_null(g_apa.apa11) THEN
                IF g_aptype[1,1] = '1' AND g_apa.apa11 IS NOT NULL THEN
                   SELECT pma11 INTO g_pma11 FROM pma_file WHERE pma01=g_apa.apa11
                   IF STATUS THEN
                      CALL cl_err3("sel","pma_file",g_apa.apa01,"",STATUS,"","sel pma:",1)  #No.FUN-660122
                      NEXT FIELD apa11
                   END IF
                  #IF g_apa.apa00 != '11' THEN    #MOD-BA0132 mark
                   IF g_apa.apa00 = '11' THEN     #MOD-BA0132 add
                      IF g_pma11 MATCHES '[3-8]' THEN
                         CALL cl_err('pma11=3-8','aap-273',0) NEXT FIELD apa11
                      END IF
                   END IF
                   DISPLAY g_pma11 TO pma11
                   IF g_apa_o.apa11 IS NULL OR g_apa_o.apa11<>g_apa.apa11 THEN
                      IF g_aptype = '13' OR g_aptype = '17' THEN
                         CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apa.apa11,'EMPL')
                             RETURNING l_paydate,g_apa.apa64,g_apa.apa24
                      ELSE
                         CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apa.apa11,
                                        g_apa.apa06)
                             RETURNING l_paydate,g_apa.apa64,g_apa.apa24
                      END IF
                      IF NOT cl_null(g_errno) THEN
                         CALL cl_err(g_apa.apa11,g_errno,0)
                         LET g_apa.apa11 = g_apa_o.apa11
                         DISPLAY BY NAME g_apa.apa11
                      END IF
                     #---------------------MOD-C50253----------------------(S)
                      LET g_apa.apa12 = l_paydate
                      CALL s_duedate(g_apa.apa06,g_apa.apa12,g_apa.apa24)
                           RETURNING g_apa.apa64
                     #---------------------MOD-C50253----------------------(E)
                      DISPLAY BY NAME g_apa.apa24
                      DISPLAY BY NAME g_apa.apa64
                     #LET g_apa.apa12 = l_paydate                #MOD-C50253 mark
                      DISPLAY BY NAME g_apa.apa12
                      #CHI-AB0017 add --start--
                      IF g_apa.apa24 < 0 THEN
                         IF NOT cl_confirm('aap-142') THEN NEXT FIELD apa11 END IF
                      END IF
                      #CHI-AB0017 add --end--
                      DELETE FROM apc_file WHERE apc01 =g_apa.apa01
                      CALL t110_ins_apc(g_apa.*)
                   END IF
                END IF
                LET g_apa_o.apa11 = g_apa.apa11
             END IF
 
          AFTER FIELD apa12
             IF NOT cl_null(g_apa.apa12) THEN
                IF g_apa_o.apa12 IS NULL OR g_apa_o.apa12<>g_apa.apa12 THEN  #CHI-B80054 add
                   IF g_aptype = '13' OR g_aptype = '17' THEN
                      CALL s_paydate('a',g_apa.apa12,g_apa.apa09,g_apa.apa02,g_apa.apa11,'EMPL') #MOD-980148 ''改為g_apa.apa12
                          RETURNING l_paydate,g_apa.apa64,g_apa.apa24
                   ELSE
                      CALL s_paydate('a',g_apa.apa12,g_apa.apa09,g_apa.apa02,g_apa.apa11,   #MOD-980148 ''改為g_apa.apa12
                                     g_apa.apa06)
                          RETURNING l_paydate,g_apa.apa64,g_apa.apa24
                   END IF
                  #---------------------MOD-C50253----------------------(S)
                   CALL s_duedate(g_apa.apa06,g_apa.apa12,g_apa.apa24)
                        RETURNING g_apa.apa64
                  #---------------------MOD-C50253----------------------(E)
                   DISPLAY BY NAME g_apa.apa24,g_apa.apa64
                END IF   #CHI-B80054 add
               #LET g_apa_o.apa12 = g_apa.apa12  #CHI-B80054 add #MOD-C20162移至29082行
                #CHI-AB0017 add --start--
                IF g_apa.apa24 < 0 THEN
                   IF NOT cl_confirm('aap-142') THEN NEXT FIELD apa12 END IF
                END IF
                #CHI-AB0017 add --end--
                IF g_apa_o.apa12 IS NULL OR g_apa_o.apa12<>g_apa.apa12 THEN
                   CALL t110_upd_apc_date()   
                END IF
                LET g_apa_o.apa12 = g_apa.apa12  #MOD-C20162 add
             END IF
      AFTER FIELD apa64
         IF g_apa.apa64 IS NOT NULL THEN
            IF g_apa_o.apa64 IS NULL OR g_apa_o.apa64<>g_apa.apa64 THEN
               CALL t110_upd_apc_date()   
            END IF
           #-----------------------CHI-C10043-----------------------------start
           #僅限於類別為轉帳(2)和電匯(C)時才需要檢核假日問題
            SELECT pma11 INTO l_pma11 FROM pma_file
             WHERE pma01 = g_apa.apa11
            IF l_pma11 = '2' OR l_pma11 = 'c' THEN
              #---------------------------MOD-D30004--------------------------(S)
              #若為假日,找尋下一個工作日
               SELECT nph02 INTO g_buf1 FROM nph_file
                WHERE nph01 = g_apa.apa64
               IF STATUS = 0 THEN
                  SELECT MIN(sme01) INTO l_apa64 FROM sme_file
                   WHERE sme01 > g_apa.apa64 AND sme02 = 'Y'
                  IF STATUS = 100 THEN
                     CALL cl_err3("sel","sme_file","","","amr-533","","",1)
                  ELSE
                     CALL cl_err3("sel","sme_file","","","aap-803","","",1)
                     LET g_apa.apa64 = l_apa64
                  END IF
               END IF
              #---------------------------MOD-D30004--------------------------(E)
               LET l_w = WEEKDAY(g_apa.apa64)
              #若為週日
               IF l_w = 0 THEN
                  SELECT sme02 INTO l_sme02 FROM sme_file
                   WHERE sme01 = g_apa.apa64
                  IF cl_null(l_sme02) THEN LET l_sme02 = 'N' END IF
                  IF l_sme02 = 'N' THEN
                     LET g_apa.apa64 = g_apa.apa64 + 1
                     CALL cl_err(g_apa.apa64,'aap-803',0)
                  ELSE
                     IF cl_confirm('aap-353') THEN
                        LET g_apa.apa64 = g_apa.apa64 + 1
                     END IF
                  END IF
                END IF
              #若為週六
               IF l_w = 6 THEN
                  LET l_sme02='N'
                  SELECT sme02 INTO l_sme02 FROM sme_file
                   WHERE sme01 = g_apa.apa64
                  IF cl_null(l_sme02) THEN LET l_sme02 = 'N' END IF
                  IF l_sme02 = 'N' THEN
                     LET g_apa.apa64 = g_apa.apa64 + 2
                     CALL cl_err(g_apa.apa64,'aap-803',0)
                  ELSE
                     IF cl_confirm('aap-353') THEN
                        LET g_apa.apa64 = g_apa.apa64 + 2
                     END IF
                  END IF
               END IF
             #---------------------------MOD-D30004--------------------------mark
             ##若為假日,找尋下一個工作日
             # SELECT nph02 INTO g_buf1 FROM nph_file  #FUN-C80078  g_buf-->g_buf1
             #  WHERE nph01 = g_apa.apa64
             # IF STATUS = 0 THEN
             #    SELECT MIN(sme01) INTO l_apa64 FROM sme_file
             #     WHERE sme01 > g_apa.apa64 AND sme02 = 'Y'
             #    IF STATUS = 100 THEN
             #       CALL cl_err3("sel","sme_file","","","amr-533","","",1)
             #    ELSE
             #       CALL cl_err3("sel","sme_file","","","aap-803","","",1)
             #       LET g_apa.apa64 = l_apa64
             #    END IF
             # END IF
             #---------------------------MOD-D30004--------------------------mark
            END IF
            DISPLAY BY NAME g_apa.apa64
           #-----------------------CHI-C10043-------------------------------end
         END IF
 
          AFTER FIELD apa24
             IF g_aptype[1,1] = '1' AND g_apa.apa24 IS NOT NULL THEN
                IF g_apa_o.apa24 IS NULL OR g_apa_o.apa24<>g_apa.apa24 THEN
                   #CHI-AB0017 add --start--
                   IF g_apa.apa24 < 0 THEN
                      IF NOT cl_confirm('aap-142') THEN NEXT FIELD apa24 END IF
                   END IF
                   #CHI-AB0017 add --end--
                   CALL s_duedate(g_apa.apa06,g_apa.apa12,g_apa.apa24)
                        RETURNING g_apa.apa64
                   DISPLAY BY NAME g_apa.apa64
                   CALL t110_upd_apc_date()      #No.FUN-680027
                END IF
             END IF
             LET g_apa_o.apa24 = g_apa.apa24
 
        AFTER INPUT
           LET l_flag='N'
           IF INT_FLAG THEN
              LET INT_FLAG = 0
              LET g_apa.*=g_apa_t.*
              DISPLAY BY NAME g_apa.apa11,g_apa.apa12,g_apa.apa24,
                              g_apa.apa64,g_apa.apa24
              CALL cl_err('',9001,0)
              EXIT WHILE
           END IF
 
           IF cl_null(g_apa.apa11) THEN
              LET l_flag='Y'
              DISPLAY BY NAME g_apa.apa11
           END IF
 
           IF cl_null(g_apa.apa12) THEN
              LET l_flag='Y'
              DISPLAY BY NAME g_apa.apa12
           END IF
 
           IF cl_null(g_apa.apa64) THEN
              LET l_flag='Y'
              DISPLAY BY NAME g_apa.apa64
           END IF
 
           IF l_flag='Y' THEN
              CALL cl_err('','9033',0)
              NEXT FIELD apa11
           END IF
 
           UPDATE apa_file SET apa11=g_apa.apa11,
                               apa12=g_apa.apa12,
                               apa24=g_apa.apa24,
                               apa64=g_apa.apa64,
                               apamodu=g_user,
                               apadate=g_today
             WHERE apa01=g_apa.apa01
 
           IF STATUS OR SQLCA.SQLERRD[3]=0 THEN   #MOD-730098
              CALL cl_err3("upd","apa_file",g_apa.apa01,"",STATUS,"","upd apa01",1)  #No.FUN-660122
              LET g_apa.*=g_apa_t.*
              DISPLAY BY NAME g_apa.apa12,g_apa.apa64
              ROLLBACK WORK
              RETURN
           ELSE
              LET g_apa_o.*=g_apa.*
              LET g_apa_t.*=g_apa.*
           END IF
 
        ON ACTION CONTROLP
           CASE
              WHEN INFIELD(apa11) # PAY TERM
                 CALL cl_init_qry_var()
                 LET g_qryparam.form ="q_pma"
                 LET g_qryparam.default1 =g_apa.apa11
                 CALL cl_create_qry() RETURNING g_apa.apa11
                 DISPLAY BY NAME g_apa.apa11
              OTHERWISE EXIT CASE
        END CASE
 
           ON IDLE g_idle_seconds
              CALL cl_on_idle()
              CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
 
        END INPUT
 
        EXIT WHILE
    END WHILE
 
    COMMIT WORK
 
END FUNCTION

 
FUNCTION t110_sum_apa()
    DEFINE l_apa31  LIKE apa_file.apa31,
           l_apa32  LIKE apa_file.apa32,
           l_apa31f LIKE apa_file.apa31f,
           l_apa32f LIKE apa_file.apa32f    #MOD-B80140 add
 
    LET g_cnt = 0
 
    SELECT COUNT(*) INTO g_cnt FROM apb_file
     WHERE apb01 = g_apa.apa01
   #IF g_cnt = 0 THEN                                              #MOD-A30248 mark
    IF g_cnt = 0 AND g_apz.apz61<>'1' AND g_apz.apz61<>'3' THEN   #MOD-A30248 add
       CALL t110_apa34f('0')    #TQC-750140
       RETURN
    END IF
 
    SELECT SUM(apb24),SUM(apb10) INTO l_apa31f,l_apa31 FROM apb_file
     WHERE apb01 = g_apa.apa01
 
    IF cl_null(l_apa31f) THEN
       LET l_apa31f = 0
    END IF
 
    IF cl_null(l_apa31) THEN
       LET l_apa31 = 0
    END IF
 
   
    LET g_apa.apa31f = l_apa31f
    LET g_apa.apa31  = l_apa31
 
    LET g_apa.apa32f = g_apa.apa31f * g_apa.apa16 / 100   #TQC-630285
    CALL t110_apa32f() RETURNING l_apa32f                   #No.MOD-B80140 add
    LET g_apa.apa32f = l_apa32f                             #No.MOD-B80140 add
    LET g_apa.apa32 = g_apa.apa31 * g_apa.apa16 / 100   #TQC-630285
    CALL t110_apa32() RETURNING l_apa32                     #No.MOD-B80140 add
    LET g_apa.apa32 = l_apa32                               #No.MOD-B80140 add
    LET g_apa.apa32f = cl_digcut(g_apa.apa32f,t_azi04)   #MOD-6B0066
    LET g_apa.apa32 = cl_digcut(g_apa.apa32,g_azi04)   #MOD-6B0066
    DISPLAY BY NAME g_apa.apa31,g_apa.apa32,g_apa.apa31f,g_apa.apa32f
 
    CALL t110_apa34f('0')    #TQC-750140
 
END FUNCTION
 
#CHI-A40005 add start---
FUNCTION t110_sum_apa32()
DEFINE l_tot2     LIKE apa_file.apa31,
       l_tot21    LIKE apa_file.apa31,
       l_tot2f    LIKE apa_file.apa31,
       l_tot21f   LIKE apa_file.apa31,
       l_apa32    LIKE apa_file.apa32,
       l_apa32f   LIKE apa_file.apa32f,
       l_apk12   LIKE apk_file.apk12
DEFINE l_pmb02    LIKE pmb_file.pmb02
DEFINE l_cnt      LIKE type_file.num5

  LET i = ARR_CURR()
 
  SELECT SUM(apk07),SUM(apk07f)
    INTO l_tot2,l_tot2f
    FROM apk_file
   WHERE apk01 = g_apa.apa01 AND apk171 NOT IN ('23','24')
     AND apk02 <> g_apk[i].apk02  
  
  IF cl_null(l_tot2)  THEN LET l_tot2 = 0 END IF
  IF cl_null(l_tot2f) THEN LET l_tot2f = 0 END IF

   IF g_apk[i].apk171 ='23' OR g_apk[i].apk171 ='24' THEN
      LET l_tot2 = l_tot2 + g_apk[i].apk07
      LET l_tot2f = l_tot2f + g_apk[i].apk07f
   END IF 

  SELECT SUM(apk07),SUM(apk07f)
    INTO l_tot21,l_tot21f
    FROM apk_file
   WHERE apk01 = g_apa.apa01 AND apk171 IN ('23','24','29')
     AND apk02 <> g_apk[i].apk02  

  IF cl_null(l_tot21) THEN LET l_tot21 = 0 END IF
  IF cl_null(l_tot21f) THEN LET l_tot21f = 0 END IF
 
   IF g_apk[i].apk171 ='23' OR g_apk[i].apk171 ='24' OR g_apk[i].apk171 ='29' THEN
      LET l_tot21 = l_tot21 + g_apk[i].apk07
      LET l_tot21f = l_tot21f + g_apk[i].apk07f
   END IF 

  IF g_aptype MATCHES '1*' THEN
     LET l_tot2 = l_tot2 - l_tot21
     LET l_tot2f= l_tot2f- l_tot21f
  ELSE
     LET l_tot2 = l_tot21
     LET l_tot2f= l_tot21f
  END IF
  
  LET l_apa32 = l_tot2
 
  #no.5954判斷單身是否皆為本國幣別
  DECLARE apk12_32_cs CURSOR FOR
   SELECT UNIQUE(apk12) FROM apk_file WHERE apk01 = g_apa.apa01

  FOREACH apk12_32_cs INTO l_apk12
      LET g_cnt = g_cnt + 1
  END FOREACH

  IF g_aza.aza17 = l_apk12 AND g_cnt = 1 THEN
     LET l_apa32f = l_tot2
  ELSE
     LET l_apa32f = cl_digcut(l_tot2f,t_azi04)
  END IF

  RETURN l_apa32,l_apa32f

END FUNCTION
#CHI-A40005 add end---

#No.TQC-AC0367  --Begin
FUNCTION t110_sum_apa32_1() 
DEFINE l_tot2     LIKE apa_file.apa31,
       l_tot21    LIKE apa_file.apa31,
       l_tot2f    LIKE apa_file.apa31,
       l_tot21f   LIKE apa_file.apa31,
       l_apa32    LIKE apa_file.apa32,
       l_apa32f   LIKE apa_file.apa32f,
       l_apk12   LIKE apk_file.apk12
DEFINE l_cnt      LIKE type_file.num5


  SELECT SUM(apk07),SUM(apk07f)
    INTO l_tot2,l_tot2f
    FROM apk_file
   WHERE apk01 = g_apa.apa01 AND apk171 NOT IN ('23','24')

  IF cl_null(l_tot2)  THEN LET l_tot2 = 0 END IF
  IF cl_null(l_tot2f) THEN LET l_tot2f = 0 END IF


  SELECT SUM(apk07),SUM(apk07f)
    INTO l_tot21,l_tot21f
    FROM apk_file
   WHERE apk01 = g_apa.apa01 AND apk171 IN ('23','24','29')

  IF cl_null(l_tot21) THEN LET l_tot21 = 0 END IF
  IF cl_null(l_tot21f) THEN LET l_tot21f = 0 END IF


  IF g_aptype MATCHES '1*' THEN
     LET l_tot2 = l_tot2 - l_tot21
     LET l_tot2f= l_tot2f- l_tot21f
  ELSE
     LET l_tot2 = l_tot21
     LET l_tot2f= l_tot21f
  END IF

  LET l_apa32 = l_tot2

  #no.5954判斷單身是否皆為本國幣別
  DECLARE apk12_32_cs1 CURSOR FOR
   SELECT UNIQUE(apk12) FROM apk_file WHERE apk01 = g_apa.apa01

  FOREACH apk12_32_cs1 INTO l_apk12
      LET g_cnt = g_cnt + 1
  END FOREACH

  IF g_aza.aza17 = l_apk12 AND g_cnt = 1 THEN
     LET l_apa32f = l_tot2
  ELSE
     LET l_apa32f = cl_digcut(l_tot2f,t_azi04)
  END IF

  RETURN l_apa32,l_apa32f

END FUNCTION
#No.TQC-AC0367  --End

FUNCTION t110_ddd_c(p_seq)
   DEFINE l_depno     LIKE apa_file.apa22,  #FUN-660117
          l_tot28,l_tot1,l_tot2,l_tot3    LIKE apa_file.apa31,
          l_tot1f,l_tot2f,l_tot3f LIKE apa_file.apa31f,    #No.MOD-580365
          l_azi            RECORD LIKE azi_file.*,         #No.MOD-580365
          l_apk08f_t       LIKE apk_file.apk08,            #No.MOD-580365
          l_apk08f_o       LIKE apk_file.apk08,            #No.MOD-580365
          apk08f_t         LIKE apk_file.apk08,            #No.MOD-580365
          i,j,k,u_sign     LIKE type_file.num5,      # No.FUN-690028 SMALLINT,
          l_n,l_nochk      LIKE type_file.num5,      # No.FUN-690028 SMALLINT,
          apk03_t     LIKE apk_file.apk03,
          l_tax            LIKE type_file.num20_6,   # No.FUN-690028 DEC(20,6),  #FUN-4B0079
          l_flag1,l_flag   LIKE type_file.chr1,    #No.FUN-690028 VARCHAR(1)
          l_chk            LIKE type_file.chr1,      # No.FUN-690028 VARCHAR(1),
          l_opensw         LIKE type_file.chr1,      # No.FUN-690028 VARCHAR(01),
          apk08_t       LIKE apk_file.apk08,
          l_gec05       LIKE gec_file.gec05,
          l_cnt         LIKE type_file.num5,    #No.FUN-690028 SMALLINT
          p_seq         LIKE type_file.num5,      # No.FUN-690028 SMALLINT,
          l_apk02       LIKE apk_file.apk02,
          l_apb10       LIKE apb_file.apb10,
          l_sql         STRING,   #MOD-720062
          l_azi04       LIKE azi_file.azi04,
          l_apk11       LIKE apk_file.apk11,
          l_apk12       LIKE apk_file.apk12,
          l_apk13       LIKE apk_file.apk13,
          l_apk06f      LIKE apk_file.apk06f,
          l_apk07f      LIKE apk_file.apk07f,
          l_apk08f      LIKE apk_file.apk08f,
          l_apk08_t     LIKE apk_file.apk08,       #No.MOD-530687
          l_apk08_o     LIKE apk_file.apk08,       #No.MOD-530687
          l_apk29       LIKE apk_file.apk29,  #CHI-B10017 add
          l_apk172      LIKE apk_file.apk172, #CHI-B10017 add
          apk11_t       LIKE apk_file.apk11,  #CHI-B10017 add
          l1_ac         LIKE type_file.num5,      # No.FUN-690028 SMALLINT,                  #No.MOD-540169
          g_rec_b1      LIKE type_file.num5,                    #No.MOD-540169   #為了不與單身g_rec_b衝突,新定義  #No.FUN-690028 SMALLINT
   l_allow_insert  LIKE type_file.num5,                #可新增否  #No.FUN-690028 SMALLINT
   l_allow_delete  LIKE type_file.num5                 #可刪除否  #No.FUN-690028 SMALLINT
DEFINE    p_cmd          LIKE type_file.chr1                 #CHI-940018 
DEFINE    l_lock_sw      LIKE type_file.chr1                 #CHI-940018
DEFINE g_t1              LIKE oay_file.oayslip  #FUN-990014 add
 
   IF g_aza.aza26 != '2' THEN
      RETURN
   END IF
 
   IF (g_aza.aza46 = 'N' AND g_apa.apa08 != 'MISC') OR g_apa.apa08='UNAP' THEN   #No.FUN-580006   #MOD-720064
      RETURN
   END IF
 
   IF g_apa.apa42='Y' THEN
      RETURN
   END IF
 
  #-MOD-BB0304-add-
  #IF g_apa.apa63 MATCHES '[Ss1]' THEN    #MOD-D20149 mark
   IF g_apa.apa63 MATCHES '[Ss]' THEN     #MOD-D20149 add
      CALL cl_err('','mfg3557',0)
      RETURN
   END IF
  #-MOD-BB0304-end-

   LET g_apa_t.* = g_apa.*       #BACKUP  #MOD-B40036
  #-TQC-B10096-add-          
   BEGIN WORK
   IF g_apa.apa41 = 'Y' THEN                    #MOD-C20048 add
      CALL t110_lock_cl()  #FUN-C80078 add
      OPEN t110_cl USING g_apa.apa01
      IF STATUS THEN
         CALL cl_err("OPEN t110_cl b:", STATUS, 1)
         CLOSE t110_cl
         ROLLBACK WORK
         RETURN
      END IF
      FETCH t110_cl INTO g_apa_t.*    # 鎖住將被更改或取消的資料   
      IF SQLCA.sqlcode THEN
         CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
         CLOSE t110_cl
         ROLLBACK WORK
         RETURN
      END IF       
   END IF                                        #MOD-C20048 add
  #-TQC-B10096-end-          
   OPEN WINDOW t110_ddd_wc AT 4,2 WITH FORM "aap/42f/aapt110_j"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No.FUN-580092 HCN
 
    CALL cl_ui_locale("aapt110_j")
   #No.MOD-C80100  --Begin
   IF g_aza.aza26 = '2' THEN
       CALL cl_set_comp_visible("apk04,apl02",FALSE)
   END IF
   #No.MOD-C80100  --End
   SELECT * INTO l_azi.* FROM azi_file WHERE azi01=g_apa.apa13
  #CHI-B10017 mod --start--
  #LET l_sql = "SELECT apk02,apk28,apk03,apk04,apl02,apk05,apk29,apk08f,",  
  #            "       apk08,apk07f,apk07,apk06f,apk06,apk171,apk172,apk30,apk32",   #FUN-970108 add apk32 
   LET l_sql = "SELECT apk02,apk11,apk172,apk28,apk03,apk04,apl02,apk05,apk29,apk08f,",  
               "       apk08,apk07f,apk07,apk06f,apk06,apk171,apk30,apk32",  
  #CHI-B10017 mod --end--
               "  FROM apk_file LEFT OUTER JOIN apl_file ON apk04 = apl01",
               " WHERE apk01 = '",g_apa.apa01,"'",
               " "
 
    IF NOT cl_null(p_seq) THEN    #No.MOD-540169
      LET l_sql = l_sql CLIPPED," AND apk02 = ",p_seq
   END IF
 
   LET l_sql = l_sql CLIPPED," ORDER BY apk02,apk03 "
 
   PREPARE t110_ddd_p2 FROM l_sql
   IF STATUS THEN
      CALL cl_err('t110_ddd_p2',STATUS,1)
      CLOSE WINDOW t110_ddd_wc
      RETURN
   END IF
 
   DECLARE t110_ddd_c2 CURSOR FOR t110_ddd_p2
 
   CALL g_apk_c.clear()    #MOD-5B0340
   LET k = 1
   LET l_tot1 = 0
   LET l_tot2 = 0
   LET l_tot3 = 0
   LET l_tot1f = 0
   LET l_tot2f = 0
   LET l_tot3f = 0
   LET i=1
   LET l_opensw = 'N'
 
   FOREACH t110_ddd_c2 INTO g_apk_c[k].*
      IF g_apk_c[k].apk171='23' THEN
         LET u_sign = -1
      ELSE
         LET u_sign = 1
      END IF
 
      #紅字發票(折讓)以負值顯示
      LET g_apk_c[k].apk08 = g_apk_c[k].apk08 * u_sign
      LET g_apk_c[k].apk07 = g_apk_c[k].apk07 * u_sign
      LET g_apk_c[k].apk06 = g_apk_c[k].apk06 * u_sign
      LET l_tot1 = l_tot1 + g_apk_c[k].apk08
      LET l_tot2 = l_tot2 + g_apk_c[k].apk07
      LET l_tot3 = l_tot3 + g_apk_c[k].apk06
      LET g_apk_c[k].apk08f= g_apk_c[k].apk08f* u_sign
      LET g_apk_c[k].apk07f= g_apk_c[k].apk07f* u_sign
      LET g_apk_c[k].apk06f= g_apk_c[k].apk06f* u_sign
      LET l_tot1f= l_tot1f+ g_apk_c[k].apk08f
      LET l_tot2f= l_tot2f+ g_apk_c[k].apk07f
      LET l_tot3f= l_tot3f+ g_apk_c[k].apk06f
      LET k = k + 1
     #IF k > 300 THEN          #MOD-A80051 mark
      IF k > g_max_rec THEN    #MOD-A80051
         EXIT FOREACH
      END IF
   END FOREACH
 
   CALL g_apk_c.deleteElement(k)
   LET g_rec_b1 = k - 1   #MOD-730092
   DISPLAY BY NAME l_tot1,l_tot2,l_tot3
   DISPLAY BY NAME l_tot1f,l_tot2f,l_tot3f  #MOD-580365
 
   IF g_apa.apa41 = 'Y' THEN
      CALL cl_set_act_visible("accept,cancel", FALSE)
 
      DISPLAY ARRAY g_apk_c TO s_apk.*  ATTRIBUTE(COUNT=g_rec_b1)      #MOD-730092
 
         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE DISPLAY
 
          ON ACTION about         #MOD-4C0121
             CALL cl_about()      #MOD-4C0121
 
          ON ACTION help          #MOD-4C0121
             CALL cl_show_help()  #MOD-4C0121
 
          ON ACTION controlg      #MOD-4C0121
             CALL cl_cmdask()     #MOD-4C0121
 
          ON ACTION controls                       #No.FUN-6B0033                                                                       
             CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
 
      END DISPLAY
      IF INT_FLAG THEN   #MOD-6B0035
         LET INT_FLAG = 0   #MOD-6B0035
         CLOSE WINDOW t110_ddd_wc
         RETURN
      END IF   #MOD-6B0035
   ELSE
     #CHI-B10017 mod --start--
     #LET g_forupd_sql = "SELECT apk02,apk28,apk03,apk04,'',apk05,apk29,apk08f,",        #MOD-9A0155 apl02 modify '' 
     #                   "       apk08,apk07f,apk07,apk06f,apk06,apk171,apk172,apk30,apk32",   #FUN-970108 add apk32
      LET g_forupd_sql = "SELECT apk02,apk11,apk172,apk28,apk03,apk04,'',apk05,apk29,apk08f,",     
                         "       apk08,apk07f,apk07,apk06f,apk06,apk171,apk30,apk32", 
     #CHI-B10017 mod --end--
                         "  FROM apk_file ",                                                 #MOD-9A0155 del apl_file
                         " WHERE apk01 = '",g_apa.apa01,"'",
                         " ",
                         "   AND apk02 = ? AND apk03 = ?  FOR UPDATE"       #MOD-970145                     
     LET g_forupd_sql = cl_forupd_sql(g_forupd_sql)
     DECLARE ddd_c_bcl CURSOR FROM g_forupd_sql      # LOCK CURSOR          
      LET l_allow_insert = cl_detail_input_auth("insert")
      LET l_allow_delete = cl_detail_input_auth("delete")
 
      INPUT ARRAY g_apk_c WITHOUT DEFAULTS FROM s_apk.*
            ATTRIBUTE(COUNT=g_rec_b1,MAXCOUNT=g_max_rec,UNBUFFERED,   #MOD-730092
                      INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)
 
      BEFORE INPUT
         IF NOT cl_null(p_seq) THEN
            LET i = 1                         #CHI-940018 l_ac->i
         END IF
         IF g_rec_b1 != 0 THEN                #CHI-940018
            CALL fgl_set_arr_curr(i)          #CHI-940018 l_ac->i
         END IF                               #CHI-940018
 
      BEFORE ROW
         LET i = ARR_CURR()
         LET j = SCR_LINE()
         LET p_cmd = ''
         LET l_opensw = 'N'
         LET g_success = 'Y'        
         BEGIN WORK 
         INITIALIZE g_apk_c_t.* TO NULL          
        #-TQC-B10096-mark-          
        #OPEN t110_cl USING g_apa.apa01
        #IF STATUS THEN
        #   CALL cl_err("OPEN t110_cl b:", STATUS, 1)
        #   CLOSE t110_cl
        #   ROLLBACK WORK
        #   CLOSE WINDOW t110_ddd_wc
        #   RETURN
        #END IF
        #FETCH t110_cl INTO g_apa_t.*    # 鎖住將被更改或取消的資料   #MOD-9A0070 mod
        #IF SQLCA.sqlcode THEN
        #   CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
        #   CLOSE t110_cl
        #   ROLLBACK WORK
        #   CLOSE WINDOW t110_ddd_wc
        #   RETURN
        #END IF       
        #-TQC-B10096-end-          
         
         LET apk11_t = g_apk_c[i].apk11 #CHI-B10017 add
         IF g_rec_b1 != 0 THEN   #No.MOD-490459   #MOD-730092
            LET apk03_t = g_apk_c[i].apk03
         ELSE
            LET apk03_t = ''  #No.MOD-490459
         END IF
         #No.TQC-A30079  --Begin
         #IF g_apk[i].apk02 IS NULL THEN
         #   CALL cl_show_fld_cont()
         #   NEXT FIELD apk02
         #END IF
         #No.TQC-A30079  --End  
         IF g_rec_b1 >= i THEN
              LET p_cmd='u'
              LET g_apk_c_t.* = g_apk_c[i].*  #BACKUP
              IF NOT cl_null(p_seq) THEN 
                 OPEN ddd_c_bcl USING p_seq,g_apk_c_t.apk03
              ELSE
              	 OPEN ddd_c_bcl USING g_apk_c_t.apk02,g_apk_c_t.apk03
              END IF  	   
              IF STATUS THEN
                 CALL cl_err("OPEN ddd_c_bcl:", STATUS, 1)
                 LET l_opensw = "Y"
              END IF
              FETCH ddd_c_bcl INTO g_apk_c[i].*
              IF SQLCA.sqlcode THEN
                 CALL cl_err(g_apk_c_t.apk02,SQLCA.sqlcode,1)
                 LET l_opensw = "Y"
              END IF
              SELECT apl02 INTO g_apk_c[i].apl02
                FROM apl_file
              WHERE apl01 = g_apk_c[i].apk04
              LET g_before_input_done = FALSE
              CALL t110_set_entry_apk_120(p_cmd)
              CALL t110_set_no_entry_apk_120(p_cmd)
              LET g_before_input_done = TRUE
           END IF
         CALL cl_show_fld_cont()     #FUN-550037(smin)
         CALL t110_set_no_apk_required()  #FUN-970108 
         CALL t110_set_apk_required()     #FUN-970108
         
      BEFORE INSERT
           LET p_cmd='a'
           INITIALIZE g_apk_c[i].* TO NULL          
           LET g_apk_c_t.* = g_apk_c[i].*         #新輸入資料
           LET apk11_t = '' #CHI-B10017 add
           LET g_before_input_done = FALSE
           CALL t110_set_entry_apk_120(p_cmd)
           CALL t110_set_no_entry_apk_120(p_cmd)
           LET g_before_input_done = TRUE
           CALL cl_show_fld_cont()     
           NEXT FIELD apk02
           
        AFTER INSERT
           #MOD-A30140---add---start---
            IF g_apk_c[i].apk07=0 AND g_apk_c[i].apk08=0 THEN
               CANCEL INSERT 
            END IF
            IF cl_null(g_apk_c[i].apk28) AND g_aza.aza46 = 'Y'
               AND NOT cl_null(g_apk_c[i].apk07) AND NOT cl_null(g_apk_c[i].apk08) 
                                         AND NOT INT_FLAG THEN
               CALL cl_err('','gap-142',0)
               NEXT FIELD apk28
            END IF
            LET l_tot1 = l_tot1 + g_apk_c[i].apk08           #未稅
            LET l_tot2 = l_tot2 + g_apk_c[i].apk07           #稅
            LET l_tot3 = l_tot3 + g_apk_c[i].apk06           #含稅
            LET l_tot1f= l_tot1f+ g_apk_c[i].apk08f  
            LET l_tot2f= l_tot2f+ g_apk_c[i].apk07f  
            LET l_tot3f= l_tot3f+ g_apk_c[i].apk06f  
            DISPLAY BY NAME l_tot1,l_tot2,l_tot3
            DISPLAY BY NAME l_tot1f,l_tot2f,l_tot3f  
           #MOD-A30140---add---end---
            IF INT_FLAG THEN
              CALL cl_err('',9001,0)
              LET INT_FLAG = 0
              CANCEL INSERT
            END IF
            IF g_apk_c[i].apk06 IS NULL OR g_apk_c[i].apk06 = 0 THEN
               NEXT FIELD apk02 
               CANCEL INSERT 
            END IF    
            IF g_apk_c[i].apk06 < 0 THEN  #以負值顯示, 正值存放
               LET g_apk_c[i].apk08 = g_apk_c[i].apk08 * -1
               LET g_apk_c[i].apk07 = g_apk_c[i].apk07 * -1
               LET g_apk_c[i].apk06 = g_apk_c[i].apk06 * -1
            END IF
            #幣別、稅別等欄位
            LET l_apk11 = g_apa.apa15
            LET l_apk12 = g_apa.apa13
            LET l_apk13 = g_apa.apa14
            LET g_apk_c[i].apk06 = cl_digcut(g_apk_c[i].apk06 ,g_azi04)
            LET g_apk_c[i].apk07 = cl_digcut(g_apk_c[i].apk07 ,g_azi04)
            LET g_apk_c[i].apk08 = cl_digcut(g_apk_c[i].apk08 ,g_azi04)
            IF NOT cl_null(g_apa.apa77) THEN
                LET g_apk_c[i].apk32 = g_apa.apa77
            ELSE
                CALL s_get_doc_no(g_apa.apa01) RETURNING g_t1
                SELECT apyvcode INTO g_apk_c[i].apk32  FROM apy_file WHERE apyslip = g_t1   
                IF cl_null(g_apk_c[i].apk32) THEN 
                    LET g_apk_c[i].apk32 = g_apz.apz63  #FUN-970108 add
                END IF     
            END IF
            INSERT INTO apk_file(apk01,apk02,apk03,apk04,apk05,
                                 apk06,apk07,apk08,apk171,apk172,
                                 apk173,apk174,apk22,apk25,apk28,
                                 apk29,apk30,apk11,apk12,apk13,
                                 apk06f,apk07f,apk08f,apk32,          #FUN-970108 add apk32
                                 apkacti,apkgrup,apkuser,apkdate,apklegal,apkoriu,apkorig) #FUN-980001 add apklegal  
            VALUES(g_apa.apa01,g_apk_c[i].apk02,g_apk_c[i].apk03,
                   g_apk_c[i].apk04,g_apk_c[i].apk05,
                   g_apk_c[i].apk06,g_apk_c[i].apk07,
                   g_apk_c[i].apk08,g_apk_c[i].apk171,
                   g_apk_c[i].apk172,g_apa.apa173,g_apa.apa174,
                   g_apa.apa22,g_apa.apa25,g_apk_c[i].apk28,
                   g_apk_c[i].apk29,g_apk_c[i].apk30,
                  #l_apk11,l_apk12,l_apk13,          #CHI-B10017 mark
                   g_apk_c[i].apk11,l_apk12,l_apk13, #CHI-B10017
                   g_apk_c[i].apk06f,g_apk_c[i].apk07f,g_apk_c[i].apk08f,  #MOD-9B0202
                   g_apk_c[i].apk32,'Y',g_grup,g_user,g_today,g_legal, g_user, g_grup)  #FUN-980001 add g_legal #FUN-970108 add apk32                  #No.FUN-980030 10/01/04  insert columns oriu, orig
           IF SQLCA.sqlcode THEN
              CALL cl_err3("ins","apk_file",g_apa.apa01,g_apk_c[i].apk03,SQLCA.sqlcode,"","",1)  
              CANCEL INSERT
           ELSE
              MESSAGE 'INSERT O.K'            
              LET g_rec_b1=g_rec_b1+1
              IF g_success='Y' THEN
                 COMMIT WORK
              ELSE
                 ROLLBACK WORK
                 LET g_apa.* = g_apa_t.*       #MOD-B40036
              END IF
           END IF
 
      BEFORE FIELD apk02
       IF p_cmd = 'a' OR g_apk_c[i].apk02 IS NULL THEN    #CHI-940018      
         IF g_apk_c[i].apk06 IS NULL THEN
            INITIALIZE g_apk_c[i].* TO NULL
            IF i = 1 THEN
               LET g_apk_c[i].apk04 = g_apa.apa18
               IF NOT cl_null(g_apa.apa77) THEN
                   LET g_apk_c[i].apk32 = g_apa.apa77
               ELSE
                   CALL s_get_doc_no(g_apa.apa01) RETURNING g_t1
                   SELECT apyvcode INTO g_apk_c[i].apk32  FROM apy_file WHERE apyslip = g_t1   
                   IF cl_null(g_apk_c[i].apk32) THEN 
                       LET g_apk_c[i].apk32 = g_apz.apz63  #FUN-970108 add
                   END IF     
               END IF
            END IF
            IF i > 1 THEN
               LET g_apk_c[i].apk04 = g_apk_c[i-1].apk04
               LET g_apk_c[i].apk05 = g_apk_c[i-1].apk05
               LET g_apk_c[i].apk171= g_apk_c[i-1].apk171
               LET g_apk_c[i].apk172= g_apk_c[i-1].apk172
               LET g_apk_c[i].apk28 = g_apk_c[i-1].apk28
               LET g_apk_c[i].apk32 = g_apk_c[i-1].apk32      #FUN-970108 add
            END IF
            LET g_apk_c[i].apk06 = 0
            LET g_apk_c[i].apk07 = 0
            LET g_apk_c[i].apk08 = 0
            LET g_apk_c[i].apk06f= 0
            LET g_apk_c[i].apk07f= 0
            LET g_apk_c[i].apk08f= 0
            IF g_aptype MATCHES '1*' THEN
               LET g_apk_c[i].apk171 = '21'
            ELSE
               LET g_apk_c[i].apk171 = '23'
            END IF
            LET g_apk_c[i].apk29 = g_apa.apa16
            LET g_apk_c[i].apk30 = 0
            SELECT gec05 INTO g_apk_c[i].apk172 FROM gec_file
             WHERE gec01 = g_apa.apa15
            IF g_apa.apa08 != 'MISC' THEN
               LET g_apk_c[i].apk03 = g_apa.apa08
            END IF
            IF g_aza.aza46 = 'N' THEN   #No.FUN-580006
               SELECT MAX(apk02) INTO l_apk02 FROM apk_file
                WHERE apk01 = g_apa.apa01
               IF cl_null(l_apk02) THEN
                  LET l_apk02 = 0
               END IF
               LET g_apk_c[i].apk02 = l_apk02 + 1
            END IF
         END IF
         IF g_aza.aza46 = 'Y' THEN   #No.TQC-720045
             IF NOT cl_null(p_seq) THEN      #No.MOD-540169
               LET g_apk_c[i].apk02 = p_seq
            END IF
         END IF
       END IF          #CHI-940018
       
     AFTER FIELD apk02
       IF cl_null(g_apk_c[i].apk02) THEN 
          CALL cl_err('','aqc-052',0)          
          NEXT FIELD apk02
     #MOD-B30214--add--str--
      #MOD-BB0121------------------------------------------mark
      #ELSE
      #  IF g_apk_c[i].apk171 = 'XX' THEN
      #     CALL cl_set_comp_required("apk04",FALSE)
      #  ELSE
      #     CALL cl_set_comp_required("apk04",TRUE)
      #  END IF
      #MOD-BB0121------------------------------------------mark
     #MOD-B30214--add--end--
       #add by lili 170602 ---s---
       ELSE
          IF p_cmd = 'a' AND (g_apk_c[i].apk02 != g_apk_t.apk02 OR
             g_apk_t.apk02 IS NULL) THEN
            #檢查項次是否存在
             LET l_n = 0
             SELECT COUNT(*) INTO l_n FROM apk_file 
              WHERE apk01 = g_apa.apa01 
                AND apk02 = g_apk_c[i].apk02
             IF l_n > 0 THEN 
                CALL cl_err(g_apk_c[i].apk02,'asf-406',0)
                NEXT FIELD apk02
             ELSE
                LET g_apk_t.apk02 = g_apk_c[i].apk02   
             END IF 
          END IF 
       #add by lili 170602 ---e---
       END IF 

      #CHI-B10017 add --start--
      AFTER FIELD apk11
         IF NOT cl_null(g_apk_c[i].apk11) THEN
            IF cl_null(apk11_t) OR g_apk_c[i].apk11 != apk11_t THEN
              #SELECT gec04,gec05                                                 #MOD-BB0121 mark
               SELECT gec04,gec05,gec08                                           #MOD-BB0121 add gec08
                #INTO l_apk29,g_apk_c[i].apk172                                   #MOD-B10104 mark
                #INTO g_apk_c[i].apk29,g_apk_c[i].apk172                          #MOD-B10104 #MOD-BB0121 mark
                 INTO g_apk_c[i].apk29,g_apk_c[i].apk172,g_apk_c[i].apk171        #MOD-BB0121 add
                 FROM gec_file
                WHERE gec01 = g_apk_c[i].apk11 AND gec011='1'  #進項
                  AND gecacti = 'Y'
               IF STATUS THEN
                  CALL cl_err3("sel","gec_file", g_apk_c[i].apk11,"","mfg3044","","",1)  
                  NEXT FIELD apk11
               END IF
               DISPLAY g_apk_c[i].apk172 TO apk172 
               DISPLAY g_apk_c[i].apk29 TO apk29           #MOD-B10104   
            END IF
         END IF
       #MOD-B30214--add--str--
        #------------------------MOD-BB0121---------------mark
        #IF g_apk[i].apk171 <> 'XX' THEN
        #   LET g_apk[i].apk17 = '1'
        #END IF
        #------------------------MOD-BB0121---------------mark
       #MOD-B30214--add--end--
      #CHI-B10017 add --end--
 
      BEFORE FIELD apk28
         IF g_aza.aza46 = 'Y' THEN   #No.TQC-720045
            IF cl_null(g_apk_c[i].apk02) THEN NEXT FIELD apk02 END IF
            SELECT COUNT(*) INTO l_cnt FROM apb_file
             WHERE apb01 = g_apa.apa01 AND apb02 = g_apk_c[i].apk02
            IF l_cnt = 0 THEN
               CALL cl_err(g_apk_c[i].apk02,'axm-141',0)
               NEXT FIELD apk02
            END IF
         END IF
 
      AFTER FIELD apk28
         IF cl_null(g_apk_c[i].apk28) AND g_apk_c[i].apk172 MATCHES '[SN]' THEN
            CALL cl_err('','tis-001',0)
            NEXT FIELD apk28
         END IF
         IF cl_null(g_apk_c[i].apk28) AND g_aza.aza46 = 'Y' THEN
            CALL cl_err('','gap-142',0)
            NEXT FIELD apk28
         END IF
 
      AFTER FIELD apk03
         IF NOT cl_null(g_apk_c[i].apk03) THEN
            IF g_apk_c[i].apk03 IS NOT NULL AND
               (apk03_t IS NULL OR g_apk_c[i].apk03 != apk03_t) THEN
               LET g_errno = ''
               IF g_apa.apa00='11' OR g_apa.apa00='12' OR 
                  g_apa.apa00='13' OR g_apa.apa00='15' THEN
                  #CALL t110_invoice_chk(g_apk_c[i].apk03,g_apa.apa15)
                 #CALL t110_invoice_chk(g_apk_c[i].apk03,g_apa.apa15,g_apk_c[i].apk05)   #CHI-820005   #No.TQC-CB0066   Mark
                  CALL t110_invoice_chk(g_apk_c[i].apk03,g_apa.apa15,g_apk_c[i].apk05,g_apk_c[i].apk28)#No.TQC-CB0066   Add
                  IF NOT cl_null(g_errno) THEN
                     CALL cl_err(g_apk_c[i].apk03,g_errno,0)
                     NEXT FIELD apk03
                  END IF
               END IF
               IF i > 1 THEN
                  CALL t110_duplicate(g_apk_c[i].apk02,g_apk_c[i].apk03,i-1)
               END IF
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err('duplicate:',g_errno,0)
                  NEXT FIELD apk03
               END IF
            END IF
        #MOD-A30140---mark---start---
        #ELSE
        #   CALL cl_err('','aqc-052',0)
        #   NEXT FIELD apk03
        #MOD-A30140---mark---end---
        #str MOD-B30691 add
         ELSE
           #當發票聯數(gec05)不為4或X時,aapt120的發票欄位(apk03)為必輸
            IF g_aptype ='12' OR g_aptype ='13' OR g_aptype ='15' THEN   #MOD-B30179 add 15 #MOD-B40108 add 13
               LET l_gec05 = ''
               SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01=g_apk_c[i].apk11
               IF l_gec05 NOT MATCHES '[4X]' AND cl_null(g_apk_c[i].apk03) THEN
                  CALL cl_err('apk03 is null: ','aap-099',0)
                  NEXT FIELD apk03
               ELSE
                  IF cl_null(g_apk_c[i].apk03) THEN   #MOD-B10070  
                     LET g_apk_c[i].apk03 = ' '     
                  END IF                            #MOD-B10070
               END IF
            END IF
        #end MOD-B30691 add
         END IF
 
      AFTER FIELD apk04
         IF NOT cl_null(g_apk_c[i].apk04) THEN
            IF (g_apz.apz14 = 'Y' OR g_aza.aza21 = 'Y') AND   #FUN-990053 mod #TQC-9A0017 add (  #TQC-9A0119 mod ()
               NOT s_chkban(g_apk_c[i].apk04) THEN #MOD-9A0145 g_apk[i].apk04-->l_apa.apa18  #TQC-9A0119 mod
               CALL cl_err('','aoo-080',0) NEXT FIELD apk04
            END IF
            IF g_apa.apa06='MISC' THEN
               CALL t110_input_apl(g_apk_c[i].apk04)
               LET g_apk_c[i].apl02 = g_apa.apa07
               DISPLAY BY NAME g_apk_c[i].apl02
            END IF
        #-------------------------------------MOD-BB0121-----------------------------------mark
        #ELSE
        #   LET l_gec05 = ''                                                #MOD-B50183 
        #   SELECT gec05 INTO l_gec05 FROM gec_file WHERE gec01=g_apa.apa15 #MOD-B50183
        #  #str MOD-B30214 add
        #  #IF g_apk[i].apk171!='XX' THEN   #MOD-B50183 mark
        #   IF g_apk[i].apk171!='XX' AND g_apk[i].apk171!='28' AND g_apk[i].apk171!='29' #MOD-B50183
        #      AND l_gec05 NOT MATCHES '[4X]' THEN                                       #MOD-B50183
        #      CALL cl_err('apk04 is null: ','aap-099',0)
        #      NEXT FIELD apk04
        #   END IF
        #  #end MOD-B30214 add
        #  #IF g_apa.apa06='MISC' AND g_apk[i].apk171!='XX' AND g_apk[i].apk171!='28' THEN   #MOD-880044   #MOD-880173  #MOD-B50183 mark
        #   IF g_apa.apa06='MISC' AND g_apk[i].apk171!='XX' AND g_apk[i].apk171!='28' #MOD-B50183 
        #      AND g_apk[i].apk171!='29' AND l_gec05 NOT MATCHES '[4X]' THEN          #MOD-B50183
        #      NEXT FIELD apk04
        #   END IF
        #-------------------------------------MOD-BB0121-----------------------------------mark
         END IF
 
 
      BEFORE FIELD apk08
         LET apk08_t = g_apk_c[i].apk08
         IF g_apk_c[i].apk172 = 'T' THEN
            CALL cl_err('','aoo-009',0)
         END IF
         LET l_apk08_o = g_apk_c[i].apk08
 
      AFTER FIELD apk08
         IF NOT cl_null(g_apk_c[i].apk08) THEN
            IF g_apk_c[i].apk08 = 0 THEN
                CALL cl_err('','agl-006',0)  #MOD-4A0001
               NEXT FIELD apk08
            END IF
            IF g_apk_c[i].apk08 < 0 THEN     #紅字發票:折讓
               LET g_apk_c[i].apk171 = '23'
            END IF
           #已經在AFTER FIELD apk08f段計算過(IF g_apk_c[i].apk172 = 'T')
           #這邊直接做取位、DISPLAY即可
            LET g_apk_c[i].apk08 = cl_digcut(g_apk_c[i].apk08,g_azi04)
            DISPLAY g_apk_c[i].apk08 TO s_apk[j].apk08
            LET l_tax = g_apk_c[i].apk08 * (g_apk_c[i].apk29/100)   #MOD-850283 add
            LET l_apk08_o = g_apk_c[i].apk08
            IF apk08_t IS NULL OR apk08_t<>g_apk_c[i].apk08 THEN
               LET g_apk_c[i].apk07 = cl_digcut(l_tax,g_azi04)   #MOD-6B0066
            END IF
            LET g_apk_c[i].apk06 = g_apk_c[i].apk08 + g_apk_c[i].apk07
         END IF
 
      AFTER FIELD apk07
         IF NOT cl_null(g_apk_c[i].apk07) THEN
            LET g_apk_c[i].apk07 = cl_digcut(g_apk_c[i].apk07,g_azi04)  #MOD-9B0203 add
            DISPLAY g_apk_c[i].apk07 TO s_apk[j].apk07                  #MOD-9B0203 add
            LET g_apk_c[i].apk06 = g_apk_c[i].apk08 + g_apk_c[i].apk07
            LET u_sign = 1
            IF g_apk_c[i].apk171 = '23' THEN
               LET u_sign = -1
            END IF
            CALL t110_sum(g_apk_c[i].apk02,g_apk_c[i].apk03,
                          g_apk_c[i].apk06*u_sign,g_apk_c[i].apk07*u_sign,
                          g_apk_c[i].apk08*u_sign,g_apk_c[i].apk171)
         END IF
      BEFORE FIELD apk08f
         LET apk08f_t = g_apk_c[i].apk08f
         IF g_apk_c[i].apk172 = 'T' THEN
            CALL cl_err('','aoo-009',0)
         END IF
         LET l_apk08f_o = g_apk_c[i].apk08f
 
      AFTER FIELD apk08f
         IF NOT cl_null(g_apk_c[i].apk08f) THEN
            IF g_apk_c[i].apk08f = 0 THEN
                CALL cl_err('','agl-006',0)  #MOD-4A0001
               NEXT FIELD apk08f
            END IF
            IF g_apk_c[i].apk08f < 0 THEN     #紅字發票:折讓
               LET g_apk_c[i].apk171 = '23'
            END IF
            IF g_apk_c[i].apk172 = 'T' THEN
               IF g_apk_c[i].apk08f != l_apk08f_o THEN
                  LET l_apk08f_t = g_apk_c[i].apk08f
                  LET g_apk_c[i].apk08f = g_apk_c[i].apk08f * (1-g_apk_c[i].apk29/100)                  #TQC-960012
                  LET g_apk_c[i].apk08f = cl_digcut(g_apk_c[i].apk08f,l_azi.azi04)
                  LET l_tax = l_apk08f_t * (g_apk_c[i].apk29/100)                                       #TQC-960012      
                  DISPLAY g_apk_c[i].apk08f TO s_apk[j].apk08f
               END IF
            ELSE  
            	  LET g_apk_c[i].apk08f = cl_digcut(g_apk_c[i].apk08f,l_azi.azi04)               #No.MOD-B40183                                                         #TQC-960012                                             
                LET l_tax = g_apk_c[i].apk08f * (g_apk_c[i].apk29/100)     #TQC-960012
            END IF
            LET l_apk08f_o = g_apk_c[i].apk08f
           #IF apk08f_t IS NULL OR apk08f_t<>g_apk_c[i].apk08f THEN
               LET g_apk_c[i].apk07f = cl_digcut(l_tax,l_azi.azi04)
               LET g_apk_c[i].apk08=g_apk_c[i].apk08f*g_apa.apa14
               LET l_tax = g_apk_c[i].apk08 * (g_apk_c[i].apk29/100)
               LET g_apk_c[i].apk07 = cl_digcut(l_tax,g_azi04)   #MOD-6B0066
           #END IF
            LET g_apk_c[i].apk06f = g_apk_c[i].apk08f + g_apk_c[i].apk07f
         END IF
 
      AFTER FIELD apk07f
         IF NOT cl_null(g_apk_c[i].apk07f) THEN
            LET g_apk_c[i].apk07f= cl_digcut(g_apk_c[i].apk07f,g_azi04)  #MOD-9B0203 add
            DISPLAY g_apk_c[i].apk07f TO s_apk[j].apk07f                 #MOD-9B0203 add
            LET g_apk_c[i].apk06f = g_apk_c[i].apk08f + g_apk_c[i].apk07f
            LET u_sign = 1
            IF g_apk_c[i].apk171 = '23' THEN
               LET u_sign = -1
            END IF
            CALL t110_sumf(g_apk_c[i].apk02,g_apk_c[i].apk03,
                           g_apk_c[i].apk06f*u_sign,g_apk_c[i].apk07f*u_sign,
                           g_apk_c[i].apk08f*u_sign,g_apk_c[i].apk171)
            LET g_apk_c[i].apk07=g_apk_c[i].apk07f*g_apa.apa14
            LET g_apk_c[i].apk07 = cl_digcut(g_apk_c[i].apk07,g_azi04)  #MOD-9B0203 add
            DISPLAY g_apk_c[i].apk07 TO s_apk[j].apk07                  #MOD-9B0203 add
         END IF
 
 
      AFTER FIELD apk172
         #CHI-B10017 add --start--
         SELECT gec05
           INTO l_apk172
           FROM gec_file
          WHERE gec01 = g_apk_c[i].apk11 AND gec011='1'  #進項
            AND gecacti = 'Y'
         IF g_apk_c[i].apk172 != l_apk172 THEN
            CALL cl_err('','axr-127',0)
            NEXT FIELD apk28
         END IF
         #CHI-B10017 add --end--
         IF g_apk_c[i].apk172 MATCHES '[SN]' AND cl_null(g_apk_c[i].apk28) THEN
            CALL cl_err('','tis-001',0)
            NEXT FIELD apk28
         END IF
 
      AFTER FIELD apk30
         #海關代征完稅憑證
         IF g_apk_c[i].apk172 = 'G' AND cl_null(g_apk_c[i].apk30) THEN
            NEXT FIELD apk30
         END IF
      AFTER FIELD apk32
         IF NOT cl_null(g_apk_c[i].apk32) THEN   
           SELECT COUNT(*) INTO g_cnt FROM ama_file
            WHERE ama02 = g_apk_c[i].apk32
             IF g_cnt = 0 THEN 
                IF g_aza.aza26 = '0' THEN              #MOD-A10127 add
                   CALL cl_err("","amd-028",1) 
                END IF                                 #MOD-A10127 add
             END IF
             IF g_aza.aza21 = 'Y' AND NOT s_chkban(g_apk_c[i].apk32) THEN #FUN-990053 mod  #TQC-9A0017
                CALL cl_err("","mfg7015",1)
                NEXT FIELD apk32
             END IF
         ELSE
            IF g_aza.aza94 = 'Y' THEN
                CALL cl_err('apk32 is null: ','aap-099',0)  
                NEXT FIELD apk32 
            END IF
         END IF
      
        BEFORE DELETE                            #是否取消單身
           #MOD-A30140---add---start---
            LET l_tot1 = l_tot1 - g_apk_c[i].apk08           #未稅
            LET l_tot2 = l_tot2 - g_apk_c[i].apk07           #稅
            LET l_tot3 = l_tot3 - g_apk_c[i].apk06           #含稅
            LET l_tot1f= l_tot1f- g_apk_c[i].apk08f  
            LET l_tot2f= l_tot2f- g_apk_c[i].apk07f  
            LET l_tot3f= l_tot3f- g_apk_c[i].apk06f  
           #MOD-A30140---add---end---
            DELETE FROM apk_file
             WHERE apk01 = g_apa.apa01 AND apk02 = g_apk_c[i].apk02
               AND apk03 = g_apk_c[i].apk03
            IF SQLCA.sqlcode THEN
               CALL cl_err3("del","apk_file",g_apa.apa01,g_apk_c[i].apk02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
               LET g_success = 'N'
               ROLLBACK WORK
               LET g_apa.* = g_apa_t.*       #MOD-B40036
               CANCEL DELETE
            ELSE                               #CHI-940018 
            	 LET g_rec_b1 = g_rec_b1 - 1     #CHI-940018                
            END IF
            DISPLAY BY NAME l_tot1,l_tot2,l_tot3            #MOD-A30140 add  
            DISPLAY BY NAME l_tot1f,l_tot2f,l_tot3f         #MOD-A30140 add 
 
        ON ROW CHANGE
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               LET g_apk_c[i].* = g_apk_c_t.*
               CLOSE ddd_c_bcl
               ROLLBACK WORK
               LET g_apa.* = g_apa_t.*       #MOD-B40036
               EXIT INPUT
            END IF
            IF l_opensw = 'Y' THEN
               CALL cl_err(g_apk_c[i].apk03,-263,1)
               LET g_apk_c[i].* = g_apk_c_t.*
            ELSE
               IF g_apk_c[i].apk06 IS NULL OR g_apk_c[i].apk06 = 0 THEN
                   NEXT FIELD apk02 
                   CALL cl_err('',9001,0)
                   LET INT_FLAG = 0
                   ROLLBACK WORK
                   LET g_apa.* = g_apa_t.*       #MOD-B40036
                   EXIT INPUT 
               END IF    
               IF g_apk_c[i].apk06 < 0 THEN  #以負值顯示, 正值存放
                  LET g_apk_c[i].apk08 = g_apk_c[i].apk08 * -1
                  LET g_apk_c[i].apk07 = g_apk_c[i].apk07 * -1
                  LET g_apk_c[i].apk06 = g_apk_c[i].apk06 * -1
               END IF
              #幣別、稅別等欄位
              LET l_apk11 = g_apa.apa15
              LET l_apk12 = g_apa.apa13
              LET l_apk13 = g_apa.apa14
              LET g_apk_c[i].apk06 = cl_digcut(g_apk_c[i].apk06 ,g_azi04)
              LET g_apk_c[i].apk07 = cl_digcut(g_apk_c[i].apk07 ,g_azi04)
              LET g_apk_c[i].apk08 = cl_digcut(g_apk_c[i].apk08 ,g_azi04)
            IF NOT cl_null(p_seq) THEN 
               UPDATE apk_file SET apk02 = i,   #MOD-970145  
                                   apk03 = g_apk_c[i].apk03,
                                   apk04 = g_apk_c[i].apk04,
                                   apk05 = g_apk_c[i].apk05,
                                   apk06 = g_apk_c[i].apk06,
                                   apk07 = g_apk_c[i].apk07,
                                   apk08 = g_apk_c[i].apk08,
                                   apk171 =g_apk_c[i].apk171,
                                   apk172 =g_apk_c[i].apk172, 
                                   apk28 = g_apk_c[i].apk28,
                                   apk29 = g_apk_c[i].apk29,
                                   apk30 = g_apk_c[i].apk30,
                                  #apk11 = l_apk11,          #CHI-B10017 mark
                                   apk11 = g_apk_c[i].apk11, #CHI-B10017 
                                   apk12 = l_apk12,
                                   apk13 = l_apk13,
                                   apk06f= g_apk_c[i].apk06f,  #MOD-9B0202 mod
                                   apk07f= g_apk_c[i].apk07f,  #MOD-9B0202 mod
                                   apk08f= g_apk_c[i].apk08f,  #MOD-9B0202 mod
                                   apk32 = g_apk_c[i].apk32    #FUN-970108 add
                WHERE apk01=g_apa.apa01 
                  AND apk02=p_seq
                  AND apk03=g_apk_c_t.apk03
             ELSE
               UPDATE apk_file SET apk02 = i,   #MOD-970145
                                   apk03 = g_apk_c[i].apk03,
                                   apk04 = g_apk_c[i].apk04,
                                   apk05 = g_apk_c[i].apk05,
                                   apk06 = g_apk_c[i].apk06,
                                   apk07 = g_apk_c[i].apk07,
                                   apk08 = g_apk_c[i].apk08,
                                   apk171 =g_apk_c[i].apk171,
                                   apk172 =g_apk_c[i].apk172, 
                                   apk28 = g_apk_c[i].apk28,
                                   apk29 = g_apk_c[i].apk29,
                                   apk30 = g_apk_c[i].apk30,
                                  #apk11 = l_apk11,          #CHI-B10017 mark
                                   apk11 = g_apk_c[i].apk11, #CHI-B10017 
                                   apk12 = l_apk12,
                                   apk13 = l_apk13,
                                   apk06f= g_apk_c[i].apk06f,  #MOD-9B0202 mod
                                   apk07f= g_apk_c[i].apk07f,  #MOD-9B0202 mod
                                   apk08f= g_apk_c[i].apk08f,  #MOD-9B0202 mod
                                   apk32 = g_apk_c[i].apk32    #FUN-970108 add
                WHERE apk01=g_apa.apa01 
                  AND apk02=g_apk_c_t.apk02
                  AND apk03=g_apk_c_t.apk03                 	
         	  END IF 
               IF SQLCA.sqlcode THEN
                  CALL cl_err3("upd","apk_file",g_apa.apa01,g_apk_c_t.apk03,SQLCA.sqlcode,"","",1)  
                  LET g_apk_c[i].* = g_apk_c_t.*
               ELSE               
                  MESSAGE 'UPDATE O.K'
                  IF g_success='Y' THEN          
                     COMMIT WORK
                  ELSE
                     ROLLBACK WORK
                     LET g_apa.* = g_apa_t.*       #MOD-B40036
                  END IF
               END IF
            END IF          
 
        AFTER ROW
         #MOD-A30140---mark---start---
         #IF g_apk_c[i].apk07=0 AND g_apk_c[i].apk08=0 THEN
         #   INITIALIZE g_apk_c[i].* TO NULL
         #END IF
         #IF cl_null(g_apk_c[i].apk28) AND g_aza.aza46 = 'Y'
         #   AND NOT cl_null(g_apk_c[i].apk07) AND NOT cl_null(g_apk_c[i].apk08)  #No.TQC-740067
         #                             AND NOT INT_FLAG THEN
         #   CALL cl_err('','gap-142',0)
         #   NEXT FIELD apk28
         #END IF
         # 
         #LET l_tot1 = 0   LET l_tot2 = 0   LET l_tot3 = 0
         #LET l_tot1f= 0   LET l_tot2f= 0   LET l_tot3f= 0   #MOD-9A0188 add
         #FOR k = 1 TO g_apk_c.getLength()
         #    IF g_apk_c[k].apk06 IS NULL OR g_apk_c[k].apk06=0 THEN
         #       CONTINUE FOR
         #    END IF
         #    LET l_tot1 = l_tot1 + g_apk_c[k].apk08           #未稅
         #    LET l_tot2 = l_tot2 + g_apk_c[k].apk07           #稅
         #    LET l_tot3 = l_tot3 + g_apk_c[k].apk06           #含稅
         #    LET l_tot1f= l_tot1f+ g_apk_c[k].apk08f   #MOD-9A0188 add
         #    LET l_tot2f= l_tot2f+ g_apk_c[k].apk07f   #MOD-9A0188 add
         #    LET l_tot3f= l_tot3f+ g_apk_c[k].apk06f   #MOD-9A0188 add
         #END FOR
         #DISPLAY BY NAME l_tot1,l_tot2,l_tot3
         #DISPLAY BY NAME l_tot1f,l_tot2f,l_tot3f       #MOD-9A0188 add
         #MOD-A30140---mark---end---
          LET i = ARR_CURR()               #MOD-A30140 add
          IF INT_FLAG THEN                                                                                                         
              CALL cl_err('',9001,0)                                                                                                
              LET INT_FLAG = 0                                                                                                                    
              IF p_cmd = 'u' THEN                                                                                                   
                 LET g_apk_c[i].* = g_apk_c_t.*                                                                                      
              #FUN-D30032--add--str--
              ELSE
                 CALL g_apk_c.deleteElement(l_ac)
              #FUN-D30032--add--end--
              END IF                                                                                                                
              CLOSE ddd_c_bcl                                                                                                        
              ROLLBACK WORK        
              LET g_apa.* = g_apa_t.*       #MOD-B40036
              LET g_success  = 'N'                                                                                                 
              EXIT INPUT                                                                                                            
          END IF                                                                                                                   
          CLOSE ddd_c_bcl                                                                                                           
          COMMIT WORK            
 
       AFTER INPUT
           IF NOT cl_null(p_seq) THEN     #No.MOD-540169
             SELECT apb10 INTO l_apb10 FROM apb_file
              WHERE apb01 = g_apa.apa01 AND apb02 = p_seq
             IF cl_null(l_apb10) THEN
                LET l_apb10 = 0
             END IF
 
             IF l_tot1 > l_apb10 THEN
                CALL cl_err('','tis-005',0)
             END IF
          END IF
          
       ON ACTION CONTROLP
         IF INFIELD(apk32) THEN
            CALL cl_init_qry_var()
            LET g_qryparam.form     = "q_ama02"
            LET g_qryparam.default1 = g_apk_c[i].apk32
            CALL cl_create_qry() RETURNING g_apk_c[i].apk32
            DISPLAY g_apk_c[i].apk32 TO apk32 
         END IF
         #CHI-B10017 add --start--
         IF INFIELD(apk11) THEN
            CALL cl_init_qry_var()
            LET g_qryparam.form     = "q_gec"
            LET g_qryparam.default1 = g_apk_c[i].apk11
            LEt g_qryparam.arg1     = '1'
            CALL cl_create_qry() RETURNING g_apk_c[i].apk11
            DISPLAY g_apk_c[i].apk11 TO apk11
         END IF
         #CHI-B10017 add --end--
          
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
 
   END INPUT
 END IF
 
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      CLOSE WINDOW t110_ddd_wc
      RETURN
   END IF
 
   LET j = ARR_COUNT()
    CLOSE ddd_c_bcl            #CHI-940018
    COMMIT WORK               #CHI-940018
    CLOSE WINDOW t110_ddd_wc  #MOD-4A0001
  IF g_success = 'Y' THEN     #CHI-940018
     CALL t110_apz08(p_seq)
  END IF                      #CHI-940018
 
END FUNCTION
 
FUNCTION t110_apz08(p_seq)
   DEFINE l_tot1,l_tot2,l_tot3       LIKE apa_file.apa31,
          l_tot11,l_tot21,l_tot31    LIKE apa_file.apa31,
          l_tot1f,l_tot2f,l_tot3f    LIKE apa_file.apa31,
          l_tot11f,l_tot21f,l_tot31f LIKE apa_file.apa31,
          l_chk     LIKE type_file.chr1,      # No.FUN-690028 VARCHAR(1),
          l_ans     LIKE type_file.chr1,      # No.FUN-690028 VARCHAR(01),
          l_ans1,l_opensw    LIKE type_file.chr1,      # No.FUN-690028 VARCHAR(01),           #85-09-23
          l_apa31   LIKE apa_file.apa31,
          l_apa31f  LIKE apa_file.apa31f,
          l_apa32   LIKE apa_file.apa32,
          l_apa32f  LIKE apa_file.apa32f,
          l_apa34f  LIKE apa_file.apa34f,
          l_apa34   LIKE apa_file.apa34,
          l_tot28   LIKE apa_file.apa31,
          l_tot28f  LIKE apa_file.apa31,
          l_apk12   LIKE apk_file.apk12,
          p_seq     LIKE type_file.num5      # No.FUN-690028 SMALLINT
   DEFINE l_pmb02   LIKE pmb_file.pmb02      #No.TQC-740067
   DEFINE l_cnt     LIKE type_file.num5   #MOD-840079
   DEFINE l_pmc913  LIKE pmc_file.pmc913  #MOD-C40102
   DEFINE l_apa01   LIKE apa_file.apa01      #MOD-C80066 add
   DEFINE l_apk08   LIKE apk_file.apk08      #MOD-C80066 add
   DEFINE l_apk08f  LIKE apk_file.apk08f     #MOD-C80066 add
   DEFINE l_apb     RECORD LIKE apb_file.*   #MOD-C80066 add
   DEFINE l_cnt2    LIKE type_file.num5      #MOD-C80066 add
 
   IF NOT cl_null(p_seq) THEN
      CLOSE WINDOW t110_ddd_wc
      RETURN
   END IF
 
   #若無發票編號，則不更新單頭
   SELECT COUNT(*) INTO g_cnt FROM apk_file WHERE apk01 = g_apa.apa01
   IF g_cnt = 0 THEN RETURN END IF
 
   #No.TQC-A30079  --Begin                                                      
   IF g_apz.apz08 = '3' THEN RETURN END IF                                      
   #No.TQC-A30079  --End 
 
   SELECT SUM(apk08),SUM(apk07),SUM(apk06),SUM(apk08f),SUM(apk07f),SUM(apk06f)
     INTO l_tot1,l_tot2,l_tot3,l_tot1f,l_tot2f,l_tot3f
     FROM apk_file
    WHERE apk01 = g_apa.apa01 AND apk171 NOT IN ('23','24')
 
   IF cl_null(l_tot1)  THEN LET l_tot1 = 0 END IF
   IF cl_null(l_tot2)  THEN LET l_tot2 = 0 END IF
   IF cl_null(l_tot3)  THEN LET l_tot3 = 0 END IF
   IF cl_null(l_tot1f) THEN LET l_tot1f = 0 END IF
   IF cl_null(l_tot2f) THEN LET l_tot2f = 0 END IF
   IF cl_null(l_tot3f) THEN LET l_tot3f = 0 END IF
 
   SELECT SUM(apk08),SUM(apk08f) INTO l_tot28,l_tot28f FROM apk_file  #No.8394
    WHERE apk01 = g_apa.apa01 AND (apk171 ='28' OR apk171='29')
 
   IF cl_null(l_tot28) THEN LET l_tot28 = 0 END IF
 
   IF cl_null(l_tot28f) THEN LET l_tot28f = 0 END IF                  #No.8394
 
   IF NOT cl_null(l_tot28) AND l_tot28<>0  THEN
      LET l_tot1=l_tot1-l_tot28
      LET l_tot3=l_tot1+l_tot2
      LET l_tot1f=l_tot1f-l_tot28f #No.8394
      LET l_tot3f=l_tot1f+l_tot2f  #No.8394
   END IF
 
   SELECT SUM(apk08),SUM(apk07),SUM(apk06),SUM(apk08f),SUM(apk07f),SUM(apk06f)
     INTO l_tot11,l_tot21,l_tot31,l_tot11f,l_tot21f,l_tot31f
     FROM apk_file
    WHERE apk01 = g_apa.apa01 AND apk171 IN ('23','24','29')
 
   IF cl_null(l_tot11) THEN
      LET l_tot11 = 0
   END IF
 
   IF cl_null(l_tot21) THEN
      LET l_tot21 = 0
   END IF
 
   IF cl_null(l_tot31) THEN
      LET l_tot31 = 0
   END IF
 
   IF cl_null(l_tot11f) THEN
      LET l_tot11f = 0
   END IF
 
   IF cl_null(l_tot21f) THEN
      LET l_tot21f = 0
   END IF
 
   IF cl_null(l_tot31f) THEN
      LET l_tot31f = 0
   END IF
 
   IF g_aptype MATCHES '1*' THEN
      LET l_tot1 = l_tot1 - l_tot11
      LET l_tot2 = l_tot2 - l_tot21
      LET l_tot3 = l_tot3 - l_tot31
      LET l_tot1f= l_tot1f- l_tot11f
      LET l_tot2f= l_tot2f- l_tot21f
      LET l_tot3f= l_tot3f- l_tot31f
   ELSE
      LET l_tot1 = l_tot11
      LET l_tot2 = l_tot21
      LET l_tot3 = l_tot31
      LET l_tot1f= l_tot11f
      LET l_tot2f= l_tot21f
      LET l_tot3f= l_tot31f
   END IF
 
   LET l_ans  = 'Y'
   LET l_ans1 = 'Y'
   LET l_apa31 = l_tot1
   LET l_apa32 = l_tot2
   LET l_apa34 = l_tot3
   LET g_cnt = 0
 
   #no.5954判斷單身是否皆為本國幣別
 
   DECLARE apk12_cs CURSOR FOR
    SELECT UNIQUE(apk12) FROM apk_file WHERE apk01 = g_apa.apa01
 
   FOREACH apk12_cs INTO l_apk12
       LET g_cnt = g_cnt + 1
   END FOREACH
 
   IF g_aza.aza17 = l_apk12 AND g_cnt = 1 THEN
      LET l_apa31f = l_tot1
      LET l_apa32f = l_tot2
      LET l_apa34f = l_tot3
   ELSE
      LET l_apa31f = cl_digcut(l_tot1f,t_azi04)   #MOD-6B0066
      LET l_apa32f = cl_digcut(l_tot2f,t_azi04)   #MOD-6B0066
      LET l_apa34f = l_apa31f+l_apa32f
   END IF
  #-----------------------MOD-C80066----------------------------(S)
   LET l_cnt = 0 
   SELECT COUNT(*) INTO l_cnt
     FROM apb_file
    WHERE apb01 = g_apa.apa01
   IF l_cnt > 0 THEN
      LET l_cnt2 = 1      
      DECLARE t110_15_chk CURSOR FOR 
       SELECT * FROM apb_file
        WHERE apb01 = g_apa.apa01
      FOREACH t110_15_chk INTO l_apb.*
         SELECT apa01 INTO l_apa01
           FROM apa_file,apb_file
          WHERE apa00 = '15'
            AND apa01 = apb01
            AND apb06 = l_apb.apb06
            AND apb07 = l_apb.apb07

         LET l_cnt = 0      
         SELECT COUNT(*) INTO l_cnt
            FROM apk_file,gec_file
           WHERE apk01 = l_apa01
             AND gec01 = apk11
             AND gec011 = '1'
             AND (gec05 NOT IN ('4','X') OR gec08 <> 'XX')
         IF l_cnt > 0 THEN
            IF l_cnt2 = 1 THEN
               CALL cl_err('','aap-184',1)
            END IF
            SELECT SUM(apk08),SUM(apk08f) INTO l_apk08,l_apk08f
               FROM apk_file,gec_file
              WHERE apk01 = l_apa01
                AND gec01 = apk11
                AND gec011 = '1'
                AND (gec05 NOT IN ('4','X') OR gec08 <> 'XX')
            IF cl_null(l_apk08) THEN
               LET l_apk08 = 0
            END IF
            IF cl_null(l_apk08f) THEN
               LET l_apk08f = 0
            END IF
            LET l_apa31 = l_apa31 + l_apk08
            LET l_apa34 = l_apa34 + l_apk08
            LET l_apk08f = cl_digcut(l_apk08f,t_azi04)   
            LET l_apa31f = l_apa31f + l_apk08f
            LET l_apa34f = l_apa34f + l_apk08f
         END IF
         LET l_cnt2 = l_cnt2 + 1
      END FOREACH
   END IF
  #-----------------------MOD-C80066----------------------------(E)
 
   #-->詢問是否更新帳款金額(apz08參數)
   IF g_apz.apz08='2' OR l_opensw = 'Y' THEN
      WHILE TRUE
 
         OPEN WINDOW t110_ddd_w2 AT 17,3
           WITH FORM "aap/42f/aapt110_f"  ATTRIBUTE (STYLE = g_win_style CLIPPED) #No.FUN-580092 HCN
 
         CALL cl_ui_locale("aapt110_f")
 
         DISPLAY l_tot28 TO FORMONLY.tot28
         DISPLAY l_apa31f TO FORMONLY.apa31f #ATTRIBUTE(YELLOW)   #TQC-8C0076
         DISPLAY l_apa32f TO FORMONLY.apa32f #ATTRIBUTE(YELLOW)   #TQC-8C0076
         DISPLAY l_apa34f TO FORMONLY.apa34f #ATTRIBUTE(YELLOW)   #TQC-8C0076
         DISPLAY l_apa31 TO FORMONLY.apa31 #ATTRIBUTE(YELLOW)     #TQC-8C0076
         DISPLAY l_apa32 TO FORMONLY.apa32 #ATTRIBUTE(YELLOW)     #TQC-8C0076
         DISPLAY l_apa34 TO FORMONLY.apa34 #ATTRIBUTE(YELLOW)     #TQC-8C0076
         CALL cl_set_head_visible("","YES")     #No.FUN-6B0033
 
         INPUT l_ans1,l_ans,l_apa31f,l_apa32f,l_apa34f,l_apa31,l_apa32,l_apa34
               WITHOUT DEFAULTS
          FROM ans1,ans,apa31f,apa32f,apa34f,apa31,apa32,apa34
 
           BEFORE FIELD ans1
              CALL t110_set_entry_ans()
 
           AFTER FIELD ans1
             IF cl_null(l_ans1) OR l_ans1 NOT MATCHES '[YN]' THEN
                NEXT FIELD ans1
             END IF
             CALL t110_set_no_entry_ans(l_ans1)
 
           AFTER FIELD ans
             IF cl_null(l_ans) OR l_ans NOT MATCHES '[YN]' THEN
                NEXT FIELD ans
             ELSE
                IF l_ans='N' AND l_ans1='N' THEN
                   EXIT INPUT
                END IF
             END IF
 
           AFTER FIELD apa31f
             IF l_apa31f IS NULL THEN
                LET l_apa31f=cl_digcut(l_tot1/g_apa.apa14,t_azi04)   #MOD-6B0066
                DISPLAY l_apa31f TO FORMONLY.apa31f
                NEXT FIELD apa31f
             ELSE
                LET l_apa34f= l_apa31f+ l_apa32f
                DISPLAY l_apa34f TO FORMONLY.apa34f
             END IF
             #No.MOD-C40102  --Begin
             SELECT pmc913 INTO l_pmc913 FROM pmc_file 
              WHERE pmc01 = g_apa.apa05
             IF g_aptype <> '11' THEN
                 IF (g_apa.apa00='15' AND (g_apz.apz61='1' OR (g_apz.apz61='3' AND l_pmc913='Y'))) OR g_apa.apa00!='15' THEN
                    IF g_apa.apa31f < 0 THEN
                       CALL cl_err('','alm-342',0)
                       NEXT FIELD apa31f
                    END IF
                 END IF 
             END IF
             #No.MOD-C40102  --End
 
           AFTER FIELD apa32f
             #no.6053 若為零稅率，稅額不可大於零
             IF g_apa.apa32 > 0 AND g_apa.apa16 = 0 THEN
                CALL cl_err('','aap-902',1)
                NEXT FIELD apa32
             END IF
             IF l_apa32f IS NULL THEN
                LET l_apa32f = cl_digcut(l_tot2/g_apa.apa14,t_azi04)   #MOD-6B0066
                DISPLAY l_apa32f TO FORMONLY.apa32f
                NEXT FIELD apa32f
             ELSE
                LET l_apa34f = l_apa31f + l_apa32f
                DISPLAY l_apa34f TO FORMONLY.apa34f
             END IF
 
           AFTER FIELD apa31
             IF l_apa31 IS NULL THEN
                LET l_apa31 = l_tot1
                DISPLAY l_apa31 TO FORMONLY.apa31
                NEXT FIELD apa31
             ELSE
                LET l_apa34 = l_apa31 + l_apa32
                DISPLAY l_apa34 TO FORMONLY.apa34
             END IF
             #No.MOD-C40102  --Begin
             SELECT pmc913 INTO l_pmc913 FROM pmc_file
              WHERE pmc01 = g_apa.apa05
             IF g_aptype <> '11' THEN
                 IF (g_apa.apa00='15' AND (g_apz.apz61='1' OR (g_apz.apz61='3' AND l_pmc913='Y'))) OR g_apa.apa00!='15' THEN
                    IF g_apa.apa31 < 0 THEN
                       CALL cl_err('','alm-342',0)
                       NEXT FIELD apa31
                    END IF
                 END IF
             END IF
             #No.MOD-C40102  --End
 
           AFTER FIELD apa32
             IF l_apa32 IS NULL THEN
                LET l_apa32 = l_tot2
                DISPLAY l_apa32 TO FORMONLY.apa32
                NEXT FIELD apa32
             ELSE
                LET l_apa34 = l_apa31 + l_apa32
                DISPLAY l_apa34 TO FORMONLY.apa34
             END IF
 
           AFTER INPUT
             IF INT_FLAG THEN EXIT INPUT END IF
             IF cl_null(l_ans) OR l_ans NOT MATCHES '[YN]' THEN
                NEXT FIELD ans
             END IF
             IF cl_null(l_ans1) OR l_ans1 NOT MATCHES '[YN]' THEN
                NEXT FIELD ans1
             END IF
            #當匯率為1時,需檢核原幣與本幣的稅額、金額需相同
             IF g_apa.apa14 = 1 AND g_aza.aza17 = g_apa.apa13 THEN   #MOD-880041
                IF l_apa31f!=l_apa31 OR l_apa32f!=l_apa32 OR
                   l_apa34f!=l_apa34 THEN
                   CALL cl_err('','apm-988',1)
                   NEXT FIELD apa31f
                END IF
             END IF
 
            ON ACTION controlg       #TQC-860021
               CALL cl_cmdask()      #TQC-860021
 
            ON IDLE g_idle_seconds   #TQC-860021
               CALL cl_on_idle()     #TQC-860021
               CONTINUE INPUT        #TQC-860021
 
            ON ACTION about          #TQC-860021
               CALL cl_about()       #TQC-860021
 
            ON ACTION help           #TQC-860021
               CALL cl_show_help()   #TQC-860021
       END INPUT
 
       IF INT_FLAG THEN
          LET INT_FLAG = 0
          CLOSE WINDOW t110_ddd_w2
          IF g_aza.aza26 = '2' THEN
             CLOSE WINDOW t110_ddd_wc
          ELSE
             CLOSE WINDOW t110_ddd_w
          END IF
          RETURN
       END IF
 
       CLOSE WINDOW t110_ddd_w2
       EXIT WHILE
    END WHILE
  ELSE
    LET l_ans='Y'
    LET l_ans1 = 'Y'    #No.TQC-A30079
  END IF
 
  #No.TQC-A30079  --Begin                                                       
  IF l_ans = 'N' AND l_ans1 = 'N' THEN RETURN END IF                            
  #No.TQC-A30079  --End

  IF g_aza.aza26 = '2' THEN
     CLOSE WINDOW t110_ddd_wc
  ELSE
     CLOSE WINDOW t110_ddd_w
  END IF
 
  IF g_apa.apa41 = 'Y' THEN
     RETURN
  END IF
 
   CASE
      WHEN g_aptype = '11'
         CURRENT WINDOW IS t110_w11
      WHEN g_aptype = '12'
         CURRENT WINDOW IS t110_w12
      WHEN g_aptype = '15'
         CURRENT WINDOW IS t110_w15
      WHEN g_aptype = '13'
         CURRENT WINDOW IS t110_w13
      WHEN g_aptype = '17'
         CURRENT WINDOW IS t110_w17
   END CASE
 
   IF l_ans = 'Y' THEN
      LET g_apa.apa31 = l_apa31
      LET g_apa.apa32 = l_apa32
      LET g_apa.apa34 = l_apa34 - g_apa.apa60 - g_apa.apa61 - g_apa.apa65 + g_apa.apa37 #MOD-B50143 add apa37
      CALL t110_unpay()
   END IF
 
   IF l_ans1 = 'Y' THEN
      LET g_apa.apa31f= l_apa31f
      LET g_apa.apa32f= l_apa32f
      LET g_apa.apa34f= l_apa34f - g_apa.apa60f - g_apa.apa61f - g_apa.apa65f + g_apa.apa37f #MOD-B50143 add apa37f
      CALL t110_unpay()
   END IF
 
   CALL t110_comp_oox(g_apa.apa01) RETURNING g_net
   LET g_apa.apa73=g_apa.apa34-g_apa.apa35 + g_net
 
   LET l_cnt = 0 
   SELECT COUNT(*) INTO l_cnt FROM apb_file WHERE apb01 = g_apa.apa01
   IF l_ans = 'Y' THEN
      IF l_cnt !=0 OR g_apa.apa00='11' THEN
         UPDATE apa_file SET apa31 = l_apa31,
                             apa32 = l_apa32,
                             apa34 = g_apa.apa34,
                             apa73 = g_apa.apa73
          WHERE apa01 = g_apa.apa01
         IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
            CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_ddd_apa2",1)  #No.FUN-660122
         END IF
      ELSE
         UPDATE apa_file SET apa31 = l_apa31,
                             apa32 = l_apa32,
                             apa34 = g_apa.apa34,
                             apa57 = g_apa.apa31,
                             apa73 = g_apa.apa73
          WHERE apa01 = g_apa.apa01
         IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
            CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_ddd_apa1",1)  #No.FUN-660122
         END IF
      END IF
   END IF
 
   IF l_ans1 = 'Y' THEN
      IF l_cnt !=0 OR g_apa.apa00='11' THEN
         UPDATE apa_file SET apa31f = l_apa31f,
                             apa32f = l_apa32f,
                             apa34f = g_apa.apa34f
          WHERE apa01 = g_apa.apa01
         IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
            CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_ddd_apa21",1)  #No.FUN-660122
         END IF
      ELSE
         UPDATE apa_file SET apa31f = l_apa31f,
                             apa32f = l_apa32f,
                             apa34f = g_apa.apa34f,
                             apa57f = g_apa.apa31f
          WHERE apa01 = g_apa.apa01
         IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
            CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_ddd_apa11",1)  #No.FUN-660122
         END IF
      END IF
   END IF
 
   IF l_apa32 <>0 THEN                                                                                                              
      SELECT gec03 INTO g_apa.apa52 FROM gec_file WHERE gec01=g_apa.apa15 AND gec011='1'                                            
      UPDATE apa_file SET apa52=g_apa.apa52                                                                                         
       WHERE apa01=g_apa.apa01                                                                                                      
      IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN                                                                                 
         CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","t110_ddd_apa52",1)                                          
      END IF                                                                                                                        
   END IF                                                                                                                           
 
   SELECT apa31,apa32,apa34,apa31f,apa32f,apa34f,apa52,apa57,apa57f   #MOD-840079 增加apa57/apa57f #MOD-990239 add apa52     
     INTO g_apa.apa31,g_apa.apa32,g_apa.apa34,
          g_apa.apa31f,g_apa.apa32f,g_apa.apa34f,g_apa.apa52,g_apa.apa57,g_apa.apa57f   #MOD-840079 增加apa57/apa57f #MOD-990239 add apa52       
     FROM apa_file
    WHERE apa01=g_apa.apa01
 
   DISPLAY BY NAME g_apa.apa31,g_apa.apa32,g_apa.apa34,
                   g_apa.apa31f,g_apa.apa32f,g_apa.apa34f,
                   g_apa.apa52,  #MOD-990239        
                   g_apa.apa57   #MOD-840079
 
   IF g_apa.apa57 > 0 AND g_apa.apa00 = '11' THEN   #MOD-840134
      LET g_apa.apa33 = g_apa.apa31 - g_apa.apa57
      LET g_apa.apa33f = g_apa.apa31f - g_apa.apa57f        
      LET g_apa.apa33 = cl_digcut(g_apa.apa33,g_azi04)   
      LET g_apa.apa33f= cl_digcut(g_apa.apa33f,t_azi04)  
      UPDATE apa_file SET apa33 = g_apa.apa33,
                          apa33f= g_apa.apa33f
       WHERE apa01 = g_apa.apa01
      IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
         CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","",1)  
      END IF
      DISPLAY BY NAME g_apa.apa33
      IF g_apa.apa33 = 0 THEN
         LET g_apa.apa56 = '0'
         LET g_apa.apa20 = 0                      #MOD-C50242 add
         UPDATE apa_file SET apa56 = g_apa.apa56,
                             apa20 = g_apa.apa20  #MOD-C50242 add
          WHERE apa01 = g_apa.apa01
         IF SQLCA.sqlcode OR SQLCA.sqlerrd[3] = 0 THEN
            CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","",1)  
         END IF
         DISPLAY BY NAME g_apa.apa56
         DISPLAY BY NAME g_apa.apa20               #MOD-C50242 add
         CALL t110_apa56()
     #MOD-A40103---add---start---
      ELSE                           
         LET g_apa.apa56 = '1'       
         UPDATE apa_file SET apa56 = g_apa.apa56
          WHERE apa01 = g_apa.apa01
         DISPLAY BY NAME g_apa.apa56 
         CALL t110_apa56()       
     #MOD-A40103---add---end---    
      END IF
   END IF   #MOD-840134
 
   IF g_apa.apa31 <>g_apa_t.apa31 OR g_apa.apa32 <> g_apa_t.apa32
      OR g_apa.apa34 <> g_apa_t.apa34 OR g_apa.apa57 <> g_apa_t.apa57
      OR g_apa.apa57 <> g_apa_t.apa57 OR g_apa.apa73 <> g_apa_t.apa73
      OR g_apa.apa31f <> g_apa_t.apa31f OR g_apa.apa32f <> g_apa_t.apa32f
      OR g_apa.apa34f <> g_apa_t.apa34f OR g_apa.apa57f <> g_apa_t.apa57f THEN
      SELECT DISTINCT(pmb02) INTO l_pmb02 FROM pmb_file
       WHERE pmb01 = g_apa.apa11
      IF l_pmb02 = 1 OR cl_null(l_pmb02) THEN   #MOD-7A0049
         DELETE FROM apc_file WHERE apc01 = g_apa.apa01
         CALL t110_ins_apc(g_apa.*)
      ELSE
         CALL t110_account_period()
      END IF
   END IF
 
   IF l_ans = 'Y' AND l_ans1 = 'Y' THEN
      CALL t110_gen_gl()
   END IF
 
   CALL t110_apc_check('')  #TQC-790167   #MOD-830059
 
END FUNCTION
 
FUNCTION t110_set_entry(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
 
   IF p_cmd = 'a' AND ( NOT g_before_input_done ) THEN
      CALL cl_set_comp_entry("apa01",TRUE)     #MOD-7A0116
   END IF
 
   CALL cl_set_comp_entry("apa05",TRUE)     #MOD-7A0116
 
   IF INFIELD(apa06) THEN
      CALL cl_set_comp_entry("apa07",TRUE)
   END IF
 
   IF INFIELD(apa08) THEN
      CALL cl_set_comp_entry("apa31,apa31f,apa32,apa32f",TRUE)
   END IF
 
   IF INFIELD(apa16) THEN
      CALL cl_set_comp_entry("apa52",TRUE)
      CALL cl_set_comp_entry("apa521",TRUE)         #No.FUN-680029
   END IF
 
    CALL cl_set_comp_entry("apa08",TRUE)   #MOD-610143
 
    IF p_cmd = 'a' AND ( NOT g_before_input_done ) AND g_aza.aza53='Y' THEN
       CALL cl_set_comp_entry("apa100",TRUE)  #FUN-630043
    END IF
 
    IF g_sn = 'y' THEN
       CALL cl_set_comp_entry("apc10,apc11",TRUE)
    END IF
  
 
END FUNCTION
 
FUNCTION t110_set_entry_1() 
   CASE
     WHEN g_aptype = '11' OR  g_aptype = '16'
          CALL cl_set_comp_entry("apa01,apa02,apa05,apa06,apa07,apa08,apa77,apa100,apa101,apa102,      #FUN-970108 add apa77
                                  apa12,apa13,apa31,apa14,apa15,apa21,apa22,apa24,                     #MOD-AC0116
                                  apa25,apa31f,apa32f,apa36,apa11,apa32,apa57,apa64,                   #MOD-AC0116 add apa32,apa57,apa64 
                                  apa66,apa930",TRUE)
     WHEN g_aptype = '12' OR  g_aptype = '15'
          CALL cl_set_comp_entry("apa01,apa02,apa05,apa06,apa07,apa08,apa77,apa100,apa101,apa102,      #FUN-970108 add apa77
                                  apa12,apa13,apa31,apa14,apa15,apa21,apa22,apa24,                     #MOD-AC0116  #TQC-D10016 del apa16
                                  apa25,apa31f,apa32f,apa36,apa11,apa32,apa57,apa64,                   #MOD-AC0116 add apa32,apa57,apa64 
                                  apa66,apa930",TRUE)
     WHEN g_aptype = '26' OR  g_aptype = '21'OR  g_aptype = '22'
          CALL cl_set_comp_entry("apa01,apa02,apa05,apa06,apa07,apa08,apa77,apa100,apa101,apa102,      #FUN-970108 add apa77 
                                  apa12,apa13,apa31,apa14,apa15,apa21,apa22,apa24,                     #MOD-AC0116  #TQC-D10016 del apa16
                                  apa25,apa31f,apa32f,apa36,apa58,apa11,apa32,apa57,apa64,             #MOD-AC0116 add apa32,apa57,apa64 
                                  apa66,apa930",TRUE)
     WHEN g_aptype = '13'
          CALL cl_set_comp_entry("apa01,apa02,apa06,apa08,apa77,apa100,apa101,apa102,      #FUN-970108 add apa77
                                  apa12,apa13,apa31,apa14,apa22,apa24,                                 #MOD-AC0116 
                                  apa25,apa31f,apa36,apa58,apa11,apa57,apa64,                          #MOD-AC0116 add apa57,apa64
                                  apa15,apa32f,apa34f,                             #FUN-950094  #TQC-D10016 del apa16     
                                  apa32,apa34,apa52,apa521,                        #FUN-950094
                                  apa66,apa930",TRUE)
    WHEN g_aptype = '17'
          CALL cl_set_comp_entry("apa01,apa02,apa06,apa07,apa08,apa77,apa100,apa101,apa102,      #FUN-970108 add apa77
                                  apa12,apa13,apa31,apa14,apa22,apa24,                                 #MOD-AC0116
                                  apa25,apa31f,apa36,apa58,apa11,apa57,apa64,                          #MOD-AC0116 add apa57,apa64
                                  apa66,apa930",TRUE) 
     END CASE
END FUNCTION
 
FUNCTION t110_set_no_entry_1() 
IF g_apa.apa63 matches '[Ss]' THEN
   CASE
     WHEN g_aptype = '11' OR  g_aptype = '16'
          CALL cl_set_comp_entry("apa01,apa02,apa05,apa06,apa07,apa08,apa77,apa101,apa102,   #MOD-9B0043
                                  apa12,apa13,apa31,apa14,apa15,apa21,apa22,apa24,                     #MOD-AC0116
                                  apa25,apa31f,apa32f,apa36,apa11,apa32,apa57,apa64,                   #MOD-AC0116 add apa32,apa57,apa64 
                                  apa66,apa930",FALSE)
     WHEN g_aptype = '12' OR  g_aptype = '15'
          CALL cl_set_comp_entry("apa01,apa02,apa05,apa06,apa07,apa08,apa77,apa101,apa102,      #MOD-9B0043
                                  apa12,apa13,apa31,apa14,apa15,apa21,apa22,apa24,                     #MOD-AC0116  #TQC-D10016 del apa16
                                  apa25,apa31f,apa32f,apa36,apa11,apa32,apa57,apa64,                   #MOD-AC0116 add apa32,apa57,apa64 
                                  apa66,apa930",FALSE)
     WHEN g_aptype = '26' OR  g_aptype = '21'OR  g_aptype = '22'
          CALL cl_set_comp_entry("apa01,apa02,apa05,apa06,apa07,apa08,apa77,apa101,apa102,       #MOD-9B0043 del apa100
                                  apa12,apa13,apa31,apa14,apa15,apa21,apa22,apa24,                     #MOD-AC0116   #TQC-D10016 del apa16
                                  apa25,apa31f,apa32f,apa36,apa58,apa11,apa32,apa57,apa64,             #MOD-AC0116 add apa32,apa57,apa64 
                                  apa66,apa930",FALSE)
     WHEN g_aptype = '13'
          CALL cl_set_comp_entry("apa01,apa02,apa06,apa08,apa77,apa101,apa102,       #MOD-9B0043 del apa100
                                  apa12,apa13,apa31,apa14,apa22,apa24,                                 #MOD-AC0116 
                                  apa25,apa31f,apa36,apa58,apa11,apa57,apa64,                          #MOD-AC0116 add apa57,apa64
                                  apa66,apa930",FALSE)
    WHEN g_aptype = '17'
          CALL cl_set_comp_entry("apa01,apa02,apa06,apa07,apa08,apa77,apa101,apa102,       #FUN-9B0043 del apa100
                                  apa12,apa13,apa31,apa14,apa22,apa24,                                 #MOD-AC0116
                                  apa25,apa31f,apa36,apa58,apa11,apa57,apa64,                          #MOD-AC0116 add apa57,apa64
                                  apa66,apa930",FALSE) 
     END CASE
END IF
END FUNCTION
FUNCTION t110_set_no_entry(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_n     LIKE type_file.num5    #MOD-860148 add
   DEFINE l_pmc913  LIKE pmc_file.pmc913     #No.FUN-880094
   DEFINE l_pmc14   LIKE pmc_file.pmc14  #FUN-A40036 add                        
   DEFINE l_flag    LIKE type_file.chr1  #FUN-A40036 add
   
   IF (p_cmd = 'u' AND g_chkey = 'N') AND ( NOT g_before_input_done ) THEN
      CALL cl_set_comp_entry("apa01",FALSE)
   END IF
 
   IF g_aptype='16' OR g_aptype='26' THEN
      CALL cl_set_comp_entry("apa08,apa77",FALSE)   #FUN-970108 add apa77
   END IF
 
   IF g_apb_sarrno > 0 AND (g_aptype<>'12' AND g_aptype<>'22' AND g_aptype<>'13')  #MOD-7A0116
      AND NOT cl_null(g_apa.apa05) THEN                       #MOD-860148
     #不判斷apa57是否>0,改判斷單身有資料才卡不可以改apa05
      LET l_n = 0
     #-MOD-B60156-add-
      IF g_aptype = '15' THEN
         SELECT COUNT(*) INTO l_n 
           FROM apb_file 
          WHERE apb01=g_apa.apa01
            AND apb06 IS NOT NULL
      ELSE
     #-MOD-B60156-end-
         SELECT COUNT(*) INTO l_n 
           FROM apb_file 
          WHERE apb01=g_apa.apa01
            AND apb21 IS NOT NULL #MOD-B60156
      END IF                      #MOD-B60156
      IF l_n > 0 THEN
         CALL cl_set_comp_entry("apa05",FALSE)
      END IF
   END IF
 
   IF g_apb_sarrno > 0 AND (g_aptype = '12' AND g_apa.apa51 = 'UNAP') 
      AND NOT cl_null(g_apa.apa05) THEN                       #MOD-860148
     #不判斷apa57是否>0,改判斷單身有資料才卡不可以改apa05
      LET l_n = 0
      SELECT COUNT(*) INTO l_n FROM apb_file WHERE apb01=g_apa.apa01
      IF l_n > 0 THEN
         CALL cl_set_comp_entry("apa05",FALSE)
      END IF
   END IF
 
#FUN-A40036 --------------------------add start---------------------
   LET l_flag = 'N'                                                             
   IF g_aptype = '12' THEN                                                      
      SELECT pmc14 INTO l_pmc14                                                 
        FROM pmc_file                                                           
       WHERE pmc01 = g_apa.apa06                                                
      IF l_pmc14 = '3' THEN                                                     
         LET l_flag = 'Y'                                                       
      END IF                                                                    
   END IF
#FUN-A40036 -------------------------add end------------------------ 
 
   IF INFIELD(apa06) THEN
    # IF g_apa.apa06 != 'MISC' AND g_apa.apa06 != 'EMPL' THEN                     #FUN-A40036  mark
      IF g_apa.apa06 != 'MISC' AND g_apa.apa06 != 'EMPL' AND l_flag = 'N'  THEN   #FUN-A40036  add 
         CALL cl_set_comp_entry("apa07",FALSE)
      END IF
   END IF
 
   IF INFIELD(apa08) THEN
     #IF (g_apa.apa08 = 'MISC' AND g_aptype MATCHES '1*') OR (g_apa.apa08='UNAP' AND g_apa.apa00 !='12' AND g_apa.apa00 !='13') THEN  #No.FUN-690080  #MOD-9C0012 add  #No.TQC-A30079
      IF (g_apa.apa08 = 'MISC' AND g_aptype MATCHES '1*' AND g_apz.apz08 <> '3') OR (g_apa.apa08='UNAP' AND g_apa.apa00 !='12' AND g_apa.apa00 !='13') THEN  #No.FUN-690080  #MOD-9C0012 add  #No.TQC-A30079
         CALL cl_set_comp_entry("apa31,apa31f,apa32,apa32f",FALSE)
      END IF
   END IF
 
   IF INFIELD(apa16) THEN
      IF g_apa.apa16 = 0 THEN
         CALL cl_set_comp_entry("apa52",FALSE)
         CALL cl_set_comp_entry("apa521",FALSE)     #No.FUN-680029
      END IF
   END IF
 
    IF g_aptype='11' AND g_apa.apa08 = 'UNAP' THEN   #MOD-750002
       CALL cl_set_comp_entry("apa08,apa77",FALSE)   #FUN-970108 add apa77
    END IF

    IF g_sn = 'y' THEN
       CALL cl_set_comp_entry("apc03,apc03_pm,apc04,apc05,apc06,apc07,apc08,apc09,apc12,apc16",FALSE)
    END IF
 
  #若為直接付款,修改時不可修改金額欄位
   IF p_cmd = 'u' AND g_apa.apa55 = '2' THEN
      CALL cl_set_comp_entry("apa31,apa31f,apa32,apa32f",FALSE)
   END IF
  
  IF g_aptype = '15' THEN
  SELECT pmc913 INTO l_pmc913 FROM pmc_file 
   WHERE pmc01 = g_apa.apa05
  IF g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y') THEN
     CALL cl_set_comp_entry("apa31,apa32,apa31f,apa32f",FALSE)
  END IF 
  END IF
 
END FUNCTION
 
FUNCTION t110_set_entry_b(p_cmd)
   DEFINE p_cmd     LIKE type_file.chr1      #No.FUN-690028 VARCHAR(1)
   DEFINE l_aag05   LIKE aag_file.aag05      #NO.MOD-5B0083
   DEFINE l_no      LIKE apy_file.apyslip    #No.TQC-770056
   DEFINE l_apydmy5 LIKE apy_file.apydmy5    #No.TQC-770056
   DEFINE l_pmc913  LIKE pmc_file.pmc913     #No.FUN-880094
    
   IF NOT cl_null(g_apb[l_ac].apb35) THEN   #FUN-810045
      CALL cl_set_comp_entry("apb31",TRUE)
   END IF 
 
   CALL cl_set_comp_entry("apb21",TRUE)
   CALL cl_set_comp_entry("apb22",TRUE)   #FUN-7A0050 add
 
   IF p_cmd = 'a' AND ( NOT g_before_input_done ) THEN
      CALL cl_set_comp_entry("apb11,apb08,apb10,apb23,apb24",TRUE)
   END IF
 
   IF g_apa.apa00='15' OR g_apa.apa00='17' OR g_apa.apa00='16'THEN   #No.FUN-690080   #MOD-850302 add apa00='16'
      CALL cl_set_comp_entry("apb12,apb27,apb09,apb28,apb25,apb251,          #No.FUN-680029
                              apb26,apb23,apb24,apb08,apb10,apb930",TRUE)  #MOD-910109 add apb930
   END IF
  
   CALL cl_set_comp_entry("apb12,apb27,apb09,apb28,apb25,apb251,apb26,apb930",TRUE)  #MOD-910109 add apb930
 
   IF g_aptype = '15' THEN
      SELECT pmc913 INTO l_pmc913 FROM pmc_file 
       WHERE pmc01 = g_apa.apa05
      IF g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='Y') THEN
         CALL cl_set_comp_entry("apb23,apb24,apb08,apb10",TRUE)
      END IF 
   END IF
 
   IF INFIELD(apb21) THEN
      CALL cl_set_comp_entry("apb12,apb27",TRUE)
   END IF
 
   IF INFIELD(api04) THEN
      CALL cl_set_comp_entry("api07",TRUE)
   END IF
   IF INFIELD(api041) THEN
      CALL cl_set_comp_entry("api07",TRUE)
   END IF
 
    SELECT aag05 INTO l_aag05 FROM aag_file
     WHERE aag01 = g_apb[l_ac].apb25
        AND aag00 = g_bookno1     #No.FUN-730064
        AND aagacti = 'Y'                         #No.MOD-B70280 add
    IF STATUS OR SQLCA.SQLCODE THEN
       LET l_aag05=''
    END IF
    IF l_aag05 = 'Y' THEN
       #使用多帳別功能時,才需判斷第二部門是否要做部門管控
       IF g_aza.aza63 = 'Y' THEN   #CHI-7A0039 add 
          SELECT aag05 INTO l_aag05 FROM aag_file
           WHERE aag01 = g_apb[l_ac].apb251
             AND aag00 = g_bookno2      #No.FUN-730064
             AND aagacti = 'Y'                         #No.MOD-B70280 add
          IF STATUS OR SQLCA.SQLCODE THEN
             LET l_aag05=''
          END IF
       END IF   #CHI-7A0039 add
    END IF
    IF l_aag05 = 'Y' OR    #CHI-840046
       (cl_null(g_apb[l_ac].apb25) AND cl_null(g_apb[l_ac].apb251)) THEN   #CHI-840046
       CALL cl_set_comp_entry("apb26,apb930",TRUE)  #MOD-910109 add apb930
    END IF
   IF g_apa.apa00 = '11' THEN
      CALL cl_set_comp_entry("apb12,apb27",TRUE)
   END IF
 
   CALL cl_set_comp_entry("apb251",TRUE)   #MOD-7B0257
 
   CALL cl_set_comp_entry("apb35,apb36",TRUE)   #FUN-810045
    
   CALL cl_set_comp_entry("apb37",TRUE)   #FUN-9A0093   
END FUNCTION
 
FUNCTION t110_set_entry_b_1()
   CASE
      WHEN g_aptype = '11' OR  g_aptype = '16'
         CALL cl_set_comp_entry("apb02,apb33,apb21,apb31,apb30,
                                 apb22,apb09,apb32,apb35,apb36,
                                 apb930,apb23,apb24,apb08,apb10",TRUE)
      WHEN g_aptype = '12' OR g_aptype = '13' OR g_aptype = '17'
        CALL cl_set_comp_entry("apb02,apb33,apb21,apb31,apb30,
                                apb12,apb09,apb28,apb32,apb22,apb35,apb36,
                                apb930,apb23,apb24,apb08,apb10",TRUE)
       WHEN g_aptype = '15'
        CALL cl_set_comp_entry("apb02,apb33,apb21,apb31,apb30,apb06,apb07,
                                apb12,apb09,apb28,apb32,apb35,apb36,
                                apb930,apb23,apb24,apb08,apb10",TRUE)
       WHEN g_aptype = '21' OR g_aptype = '26'
        CALL cl_set_comp_entry("apb02,apb33,apb11,apb22,apb21,apb31,apb30,
                                ,apb09,apb32,apb35,apb36,
                                apb930,apb23,apb24,apb08,apb10",TRUE)
       WHEN g_aptype = '22'
         CALL cl_set_comp_entry("apb02,apb33,apb11,apb21,apb31,apb30,
                                 apb12,apb28,apb22,apb09,apb32,apb35,apb36,
                                 apb930,apb23,apb24,apb08,apb10",TRUE)
   END CASE
END FUNCTION 
 
FUNCTION t110_set_no_entry_b_1()
IF g_apa.apa63 matches '[Ss]' THEN
   CASE
      WHEN g_aptype = '11' OR  g_aptype = '16'
         CALL cl_set_comp_entry("apb02,apb33,apb21,apb31,apb30,
                                 apb22,apb09,apb32,apb35,apb36,
                                 apb930,apb23,apb24,apb08,apb10",FALSE)
      WHEN g_aptype = '12' OR g_aptype = '13' OR g_aptype = '17' 
        CALL cl_set_comp_entry("apb02,apb33,apb21,apb31,apb30,
                                apb12,apb09,apb28,apb32,apb22,apb35,apb36,
                                apb930,apb23,apb24,apb08,apb10",FALSE)
             CALL cl_set_comp_entry("apb33",TRUE)
              
       WHEN g_aptype = '15'
        CALL cl_set_comp_entry("apb02,apb33,apb21,apb31,apb30,apb06,apb07,
                                apb12,apb09,apb28,apb32,apb35,apb36,
                                apb930,apb23,apb24,apb08,apb10",FALSE)
       WHEN g_aptype = '21' OR g_aptype = '26'
        CALL cl_set_comp_entry("apb02,apb33,apb11,apb22,apb21,apb31,apb30,
                                ,apb09,apb32,apb35,apb36,
                                apb930,apb23,apb24,apb08,apb10",FALSE)
       WHEN g_aptype = '22'
         CALL cl_set_comp_entry("apb02,apb33,apb11,apb21,apb31,apb30,
                                 apb12,apb28,apb22,apb09,apb32,apb35,apb36,     
                                 apb930,apb23,apb24,apb08,apb10",FALSE) 
   END CASE
END IF
END FUNCTION  
FUNCTION t110_set_no_entry_b(p_cmd)
   DEFINE p_cmd        LIKE type_file.chr1      #No.FUN-690028 VARCHAR(1)
   DEFINE l_aag05      LIKE aag_file.aag05
   DEFINE l_aag21      LIKE aag_file.aag21      #MOD-C70147 add
   DEFINE l_no         LIKE apy_file.apyslip    #No.TQC-770056
   DEFINE l_apydmy5    LIKE apy_file.apydmy5    #No.TQC-770056
   DEFINE l_pmc913     LIKE pmc_file.pmc913     #No.FUN-880094
   DEFINE l_aag23      LIKE aag_file.aag23      #MOD-CA0038 add

   #--------------------MOD-C70147--------------------(S)
    SELECT aag05,aag21,aag23               #MOD-CA0038 add aag23
      INTO l_aag05,l_aag21,l_aag23         #MOD-CA0038 add aag23
      FROM aag_file
     WHERE aag01 = g_apb[l_ac].apb25
       AND aag00 = g_bookno1
       AND aagacti = 'Y'

    IF STATUS OR SQLCA.SQLCODE THEN
       LET l_aag05 = ''
       LET l_aag21 = 'N'                                          #MOd-D40013 mod N
       LET l_aag23 = 'N'                     #MOD-CA0038 add      #MOd-D40013 mod N
    END IF
   #--------------------MOD-C70147--------------------(E)
 
  #IF NOT cl_null(g_apb[l_ac].apb06)  THEN                                        #MOD-C70147 mark
  #IF NOT cl_null(g_apb[l_ac].apb06) AND l_aag21 = 'N'  THEN                      #MOD-C70147 add ##MOD-CA0038 mark
  #IF NOT cl_null(g_apb[l_ac].apb06) AND l_aag21 = 'N' AND l_aag23 = 'N' THEN     #MOD-CA0038 add #MOD-CC0258 mark
   IF l_aag21 = 'N' AND l_aag23 = 'N' THEN                                        #MOD-CC0258 
      CALL cl_set_comp_entry("apb35,apb36",FALSE)
   ELSE                                              #yinhy140925
      CALL cl_set_comp_entry("apb30,apb35,apb36",TRUE)     #yinhy140925
      CALL cl_set_comp_visible("apb30,apb35,apb35",TRUE)   #yinhy140925
   END IF
 
   IF g_aza.aza26 = '2' THEN
      CALL cl_set_comp_entry("apb11",FALSE)
   END IF
 
   IF (g_aptype='11' OR (g_aptype='21' AND g_apa.apa58='2')) AND g_apz.apz16 = 'N' THEN    #MOD-660093
       CALL cl_set_comp_entry("apb08,apb10,apb23,apb24",FALSE)
   END IF
 
   IF (g_apa.apa00 = '15' OR g_apa.apa00 = '17') AND NOT cl_null(g_apb[l_ac].apb06) THEN  #No.FUN-690080
      IF cl_null(g_apa.apa51) THEN
         CALL cl_set_comp_entry("apb12,apb27,apb28",FALSE)   #CHI-B70013 remove apb09
      ELSE
         CALL cl_set_comp_entry("apb12,apb27,apb28,apb25,apb251",FALSE)   #MOD-920170 mod  #CHI-B70013 remove apb09
      END IF   #MOD-920170 add
   END IF
   
   IF (g_apa.apa00 = '17') AND NOT cl_null(g_apb[l_ac].apb06) THEN 
      CALL cl_set_comp_entry("apb23,apb24,apb08,apb10",FALSE)
   END IF
 
  #MOD-A30230---mark---start---
  #IF g_apa.apa00 = '15' THEN
  #   SELECT pmc913 INTO l_pmc913 FROM pmc_file 
  #    WHERE pmc01 = g_apa.apa05
  #  #IF g_apz.apz61 = '2' OR (g_apz.apz61 = '3' AND l_pmc913 ='N') THEN   #MOD-A30045 mark
  #   IF g_apz.apz61 = '1' OR (g_apz.apz61 = '3' AND l_pmc913 ='N') THEN   #MOD-A30045 add 
  #       CALL cl_set_comp_entry("apb23,apb24,apb08,apb10",FALSE)
  #   END IF
  #END IF 
  #MOD-A30230---mark---end---
 
  #執行aapt160,當單身入庫單號(apb21)有值,單身欄位(由入庫單帶入)不可修改,
  #但當apz16='Y'時,單價、金額等欄位要開放可修改
   IF g_apa.apa00 = '16' AND NOT cl_null(g_apb[l_ac].apb21) THEN
      CALL cl_set_comp_entry("apb12,apb27,apb09,apb28",FALSE)
      IF g_apz.apz16 = 'N' THEN
         CALL cl_set_comp_entry("apb23,apb24,apb08,apb10",FALSE)
      END IF
   END IF
 
   IF INFIELD(apb21) THEN
      IF g_aptype = '21' AND NOT cl_null(g_apb[l_ac].apb21) THEN
         CALL cl_set_comp_entry("apb12,apb27",FALSE)
      END IF
   END IF
 
   #--------------------MOD-C70147--------------------mark
   #SELECT aag05 INTO l_aag05 FROM aag_file
   # WHERE aag01 = g_apb[l_ac].apb25
   #   AND aag00 = g_bookno1       #No.FUN-730064
   #   AND aagacti = 'Y'                         #No.MOD-B70280 add
   #IF STATUS OR SQLCA.SQLCODE THEN
   #   LET l_aag05=''
   #END IF
   #--------------------MOD-C70147--------------------mark
    IF g_prog <> 'aapt140' THEN #FUN-D80031 add for此時不需要做部門控管判斷
    IF l_aag05 = 'Y' THEN
       #使用多帳別功能時,才需判斷第二部門是否要做部門管控
       IF g_aza.aza63 = 'Y' THEN    
          SELECT aag05 INTO l_aag05 FROM aag_file
           WHERE aag01 = g_apb[l_ac].apb251
             AND aag00 = g_bookno2    
             AND aagacti = 'Y'                         #No.MOD-B70280 add
          IF STATUS OR SQLCA.SQLCODE THEN
             LET l_aag05=''
          END IF
       END IF   
    END IF
    IF l_aag05 = 'N' THEN    #MOD-840119   #CHI-840046 取消mark
        # CALL cl_set_comp_entry("apb26,b26,apb930",FALSE)   #MOD-910109 add apb930
        #No.MOD-BC0218  --Begin
        #LET g_apb[l_ac].apb26 = NULL
        #LET g_apb[l_ac].b26 = NULL
        #LET g_apb[l_ac].apb930= NULL   #MOD-910109 add
        #LET g_apb[l_ac].apb26 = ''     #MOD-C80183 mark
        #LET g_apb[l_ac].b26 = ''
        #LET g_apb[l_ac].apb930= ''
         LET g_apb[l_ac].b26 = ' '      #MOD-D30138 add
         LET g_apb[l_ac].apb930= ' '    #MOD-D30138 add
        #No.MOD-BC0218  --End
         #DISPLAY BY NAME g_apb[l_ac].apb26,g_apb[l_ac].b26  #MOD-C80183 mark
         DISPLAY BY NAME g_apb[l_ac].b26      #MOD-C80183
         DISPLAY BY NAME g_apb[l_ac].apb930   #MOD-910109 add
    END IF
    END IF   #FUN-D80031
   IF g_apa.apa00 = '11' THEN
      CALL cl_set_comp_entry("apb12,apb27",FALSE)
   END IF
   IF g_aza.aza63 ='N' THEN
      CALL cl_set_comp_entry("apb251",FALSE)   
   END IF
   
   IF NOT cl_null(g_apa.apa100) THEN
      CALL cl_set_comp_entry("apb37",FALSE)
   END IF 
   
END FUNCTION
 
FUNCTION t110_set_entry_api(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
 
    IF INFIELD(api04) OR INFIELD(api041) OR (p_cmd = 'a' AND (NOT g_before_input_done)) THEN       #No.MOD-530494  No.FUN-680029
      CALL cl_set_comp_entry("api07,api21,api22,api23,api24,api26",TRUE)        #No.FUN-830161
 
      CALL cl_set_comp_entry("api31,api32,api33,api34,api35,api36,api37",TRUE)
 
   END IF
 
END FUNCTION
 
FUNCTION t110_set_no_entry_api(m_aag05,m_aag21,m_aag23,m_aag151,m_aag161,
         m_aag171,m_aag181,m_aag311,m_aag321,m_aag331,m_aag341,m_aag351,
         m_aag361,m_aag371)
 
   DEFINE m_aag05       LIKE aag_file.aag05
   DEFINE m_aag21       LIKE aag_file.aag21
   DEFINE m_aag23       LIKE aag_file.aag23
   DEFINE m_aag151      LIKE aag_file.aag151
   DEFINE m_aag161      LIKE aag_file.aag161
   DEFINE m_aag171      LIKE aag_file.aag171
   DEFINE m_aag181      LIKE aag_file.aag181
 
   DEFINE m_aag311       LIKE aag_file.aag311
   DEFINE m_aag321       LIKE aag_file.aag321
   DEFINE m_aag331       LIKE aag_file.aag331
   DEFINE m_aag341       LIKE aag_file.aag341
   DEFINE m_aag351       LIKE aag_file.aag351
   DEFINE m_aag361       LIKE aag_file.aag361
   DEFINE m_aag371       LIKE aag_file.aag371
 
   IF m_aag05 = 'N' THEN
      CALL cl_set_comp_entry("api07",FALSE)
   END IF
 
   IF m_aag21 = 'N' OR cl_null(m_aag21) THEN  #MOD-B10093
      CALL cl_set_comp_entry("api36",FALSE)   #MOD-B10093 
   END IF                                     #MOD-B10093 

   IF m_aag23 = 'N' OR cl_null(m_aag23) THEN
      CALL cl_set_comp_entry("api26",FALSE)
   END IF
 
   IF cl_null(m_aag151) THEN
      CALL cl_set_comp_entry("api21",FALSE)
      CALL cl_set_comp_entry("api35",FALSE)    #MOD-B10093
   END IF
 
   IF cl_null(m_aag161) THEN
      CALL cl_set_comp_entry("api22",FALSE)
   END IF
 
   IF cl_null(m_aag171) THEN
      CALL cl_set_comp_entry("api23",FALSE)
   END IF
 
   IF cl_null(m_aag181) THEN
      CALL cl_set_comp_entry("api24",FALSE)
   END IF
 
   IF cl_null(m_aag311) THEN
      CALL cl_set_comp_entry("api31",FALSE)
   END IF
   IF cl_null(m_aag321) THEN
      CALL cl_set_comp_entry("api32",FALSE)
   END IF
   IF cl_null(m_aag331) THEN
      CALL cl_set_comp_entry("api33",FALSE)
   END IF
   IF cl_null(m_aag341) THEN
      CALL cl_set_comp_entry("api34",FALSE)
   END IF
  #-MOD-B10093-mark-
  #IF cl_null(m_aag351) THEN
  #   CALL cl_set_comp_entry("api35",FALSE)
  #END IF
  #IF cl_null(m_aag361) THEN
  #   CALL cl_set_comp_entry("api36",FALSE)
  #END IF
  #-MOD-B10093-end-
   IF cl_null(m_aag371) THEN
      CALL cl_set_comp_entry("api37",FALSE)
   END IF
   IF g_pmc903 = 'N' AND m_aag371 MATCHES '[4]'  THEN          #FUN-950053 add 
      CALL cl_set_comp_entry("api37",FALSE)                    #FUN-950053 add
   END IF                                                      #FUN-950053 add   
 
END FUNCTION
 
FUNCTION t110_set_entry_apv(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
 
   CALL cl_set_comp_entry("apv03",TRUE)
   IF p_cmd = 'F' THEN
      CALL cl_set_comp_entry("apv04f",TRUE)
   END IF
   IF p_cmd = 'D' THEN
      CALL cl_set_comp_entry("apv04f,apv04",TRUE)
   END IF
END FUNCTION
 
FUNCTION t110_set_no_entry_apv(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
 
   IF p_cmd = 'u' THEN
      CALL cl_set_comp_entry("apv03",FALSE)
   END IF
   IF p_cmd = 'F' THEN
      CALL cl_set_comp_entry("apv04f",FALSE)
   END IF
   IF p_cmd = 'D' THEN
      CALL cl_set_comp_entry("apv04f,apv04",FALSE)
   END IF
END FUNCTION
 
 
FUNCTION t110_set_entry_ans()
 
   IF INFIELD(ans1) THEN
      CALL cl_set_comp_entry("apa31f,apa32f",TRUE)
   END IF
 
END FUNCTION
 
FUNCTION t110_set_no_entry_ans(l_ans1)
   DEFINE l_ans1     LIKE type_file.chr1      # No.FUN-690028 VARCHAR(01)
 
   IF INFIELD(ans1) THEN
      IF l_ans1='N' THEN
         CALL cl_set_comp_entry("apa31f,apa32f",FALSE)
      END IF
   END IF
 
END FUNCTION
 
FUNCTION t110_set_attr()
   DEFINE lw_window      ui.Window
   DEFINE lf_form        ui.Form
   DEFINE lnode_root     om.DomNode
   DEFINE lnode_frm      om.DomNode
 
   WHENEVER ERROR CALL cl_err_msg_log
 
   LET lnode_root = ui.Interface.getRootNode()
   LET lw_window = ui.Window.getCurrent()
   LET lf_form = lw_window.getForm()
   LET lnode_frm = lf_form.getNode()
 
   CALL t110_set_attr2(lnode_frm)
 
   IF g_aptype = '12' THEN
      CALL cl_set_comp_visible("apb11,apb29,apb06,apb07, 
                                apb24,apb08,apb10",FALSE)
   ELSE
     if g_aptype = '17' then # add by quan 0613 
     else 
      CALL cl_set_comp_visible("apb11,apb29,apb21,apb22,apb06,apb07, 
                                apb24,apb08,apb10",FALSE)
     end if 
   ENd IF   #FUN-7A0050 add
 
END FUNCTION
 
FUNCTION t110_set_attr2(pnode_frm)
   DEFINE pnode_frm        om.DomNode
   DEFINE lnode_child      om.DomNode
   DEFINE ls_tagName       STRING
   DEFINE ls_name          STRING
   DEFINE ls_text          LIKE ze_file.ze03    # No.FUN-690028 VARCHAR(255)
   DEFINE ls_elementList   STRING
   DEFINE l_str            STRING   #MOD-750064
 
   LET ls_text=cl_getmsg('aap-400',g_lang)
 
   LET ls_elementList = "Page, Group, Label, FormField, Matrix, Button, TableColumn"
 
   LET lnode_child = pnode_frm.getFirstChild()
   WHILE lnode_child IS NOT NULL
      LET ls_tagName = lnode_child.getTagName()
      IF ls_elementList.getIndexOf(ls_tagName, 1) THEN
         LET ls_name = lnode_child.getAttribute("colName")
 
         IF cl_null(ls_name) THEN
            LET ls_name = lnode_child.getAttribute("name")
         END IF
 
         IF NOT cl_null(ls_name) THEN
            IF ls_tagName="TableColumn" THEN
               CALL lnode_child.setAttribute("text","---")
 
 
           #當aaps100參數設定為apz59="N"時，單身的欄位名稱會到此來抓取
           #所以要在這裡設定單身欄位名稱                            
           #若沒設定到，畫面上單身欄位名稱會顯示為"---"             
              IF ls_name.equals("apb35") THEN
                 LET l_str = cl_getmsg('aap-426',g_lang)
                 CALL lnode_child.setAttribute("text",l_str) #專案代號
              END IF
            
              IF ls_name.equals("apb36") THEN
                 LET l_str = cl_getmsg('aap-427',g_lang)
                 CALL lnode_child.setAttribute("text",l_str) #WBS編號
              END IF
            
              IF ls_name.equals("b25") THEN
                 LET l_str = cl_getmsg('aap-428',g_lang)
                 CALL lnode_child.setAttribute("text",l_str) #科目名稱
              END IF
            
              IF ls_name.equals("b26") THEN
                 LET l_str = cl_getmsg('aap-429',g_lang)
                 CALL lnode_child.setAttribute("text",l_str) #部門名稱
              END IF
            
              IF ls_name.equals("apb930") THEN
                 LET l_str = cl_getmsg('aap-430',g_lang)
                 CALL lnode_child.setAttribute("text",l_str) #成本中心
              END IF
            
              IF ls_name.equals("gem02c") THEN
                 LET l_str = cl_getmsg('aap-431',g_lang)
                 CALL lnode_child.setAttribute("text",l_str) #部門名稱
              END IF
            
              IF ls_name.equals("apb21") THEN
                 LET l_str = cl_getmsg('aap-432',g_lang)
                 CALL lnode_child.setAttribute("text",l_str) #暫估單號
              END IF
            
              IF ls_name.equals("apb22") THEN
                 LET l_str = cl_getmsg('aap-433',g_lang)
                 CALL lnode_child.setAttribute("text",l_str) #暫估項次
              END IF
 
 
               IF ls_name.equals("apb12") THEN
                  LET l_str = cl_getmsg('aap-404',g_lang)   #TQC-910032
                  CALL lnode_child.setAttribute("text",l_str) #發票號碼
               END IF
 
               IF ls_name.equals("apb27") THEN
                  LET l_str = cl_getmsg('aap-412',g_lang)   
                  CALL lnode_child.setAttribute("text",l_str) #統一編號
               END IF
 
               IF ls_name.equals("apb09") THEN
                  LET l_str = cl_getmsg('aap-413',g_lang)   
                  CALL lnode_child.setAttribute("text",l_str) #未稅金額
               END IF
 
               IF ls_name.equals("apb28") THEN
                  LET l_str = cl_getmsg('aap-414',g_lang)   
                  CALL lnode_child.setAttribute("text",l_str) #格式
               END IF
 
               IF ls_name.equals("apb25") THEN
                  LET l_str = cl_getmsg('aap-415',g_lang)   
                  CALL lnode_child.setAttribute("text",l_str) #科目編號
               END IF
 
               IF ls_name.equals("apb26") THEN
                  LET l_str = cl_getmsg('aap-416',g_lang)  
                  CALL lnode_child.setAttribute("text",l_str) #部門
               END IF
 
               IF ls_name.equals("apb23") THEN
                  LET l_str = cl_getmsg('aap-413',g_lang)   
                  CALL lnode_child.setAttribute("text",l_str) #未稅金額
               END IF
 
               IF ls_name.equals("apb02") THEN
                  LET l_str = cl_getmsg('aap-417',g_lang)   
                  CALL lnode_child.setAttribute("text",l_str) #項次
               END IF
 
               IF ls_name.equals("apb31") THEN
                  LET l_str = cl_getmsg('aap-418',g_lang)   
                  CALL lnode_child.setAttribute("text",l_str) #專案費用代號
               END IF
               IF ls_name.equals("apb251") THEN
                  LET l_str = cl_getmsg('aap-421',g_lang)   
                  CALL lnode_child.setAttribute("text",l_str) #科目編號二
               END IF
               IF ls_name.equals("apb32") THEN
                  LET l_str = cl_getmsg('aap-423',g_lang)   
                  CALL lnode_child.setAttribute("text",l_str) #員工編號
               END IF
               IF ls_name.equals("apb33") THEN
               	     if  g_aptype = '17' then  # add by quan 170613
               	 	     LET l_str = cl_getmsg('cap-001',g_lang)   
                       CALL lnode_child.setAttribute("text",l_str) #報銷明細說明
                      else
                
                      LET l_str = cl_getmsg('aap-424',g_lang)   
                       CALL lnode_child.setAttribute("text",l_str) #報銷明細說明
                     end if
               END IF
               #No.TQC-A30068  --Begin
               IF ls_name.equals("apb37") THEN
                  LET l_str = cl_getmsg('aap-434',g_lang)   
                  CALL lnode_child.setAttribute("text",l_str) #资料来源营运中心
               END IF
               #No.TQC-A30068  --End  
            END IF
         END IF
      END IF
 
      CALL t110_set_attr2(lnode_child)
      LET lnode_child = lnode_child.getNext()
   END WHILE
 
END FUNCTION
FUNCTION t110_ef()
 
   CALL s_showmsg_init() #CHI-A80031 add
   CALL t110_firm1_chk()     #CALL 原確認的 check 段   #FUN-580114
   CALL s_showmsg()             #MOD-C10214 add
   IF g_success = "N" THEN
       RETURN
   END IF
  #CALL s_showmsg()            #CHI-A80031 add #MOD-C10214 mark
 
   CALL aws_condition()      #判斷送簽資料
   IF g_success = 'N' THEN
       RETURN
   END IF
##########
# CALL aws_efcli2()
# 傳入參數: (1)單頭資料, (2-6)單身資料
# 回傳值  : 0 開單失敗; 1 開單成功
##########
   IF aws_efcli2(base.TypeInfo.create(g_apa),base.TypeInfo.create(g_apb),'','','','')
   THEN
      LET g_success = 'Y'
      LET g_apa.apa63 = 'S'   #開單成功, 更新狀態碼為 'S. 送簽中'
      DISPLAY BY NAME g_apa.apa63
   ELSE
      LET g_success = 'N'
   END IF
 
END FUNCTION
 
 
FUNCTION t110_21_ins2(l_apa)
   DEFINE l_apa   RECORD LIKE apa_file.*,
          l_apb   RECORD LIKE apb_file.*,
          toapk   RECORD LIKE apk_file.*,
          l_azi04        LIKE azi_file.azi04,
          l_tax          LIKE apb_file.apb10,
          l_taxf         LIKE apb_file.apb10,
          l_cnt          LIKE type_file.num5    #FUN-890128
   DEFINE g_t1           LIKE oay_file.oayslip  #FUN-990014 add
   
   INITIALIZE toapk.* TO NULL
 
   SELECT azi04 INTO l_azi04 FROM azi_file WHERE azi01 = l_apa.apa13
 
  #在確認段寫入apk_file前,先檢核apk_file是否存在,若是則先刪除再新增
  SELECT COUNT(*) INTO l_cnt FROM apk_file WHERE apk01=l_apa.apa01  #FUN-890128
  If l_cnt > 0 THEN   #FUN-890128
     DELETE FROM apk_file WHERE apk01=l_apa.apa01
     IF SQLCA.SQLCODE OR STATUS THEN
        CALL cl_err3("del","apk_file",l_apa.apa01,"",SQLCA.sqlcode,"","del 21_apk:",1)  #No.FUN-660122
        LET g_success = 'N'   #FUN-890128
     END IF
  END IF   #FUN-890128
 
   DECLARE t110_21_ins2 CURSOR FOR SELECT * FROM apb_file
                                    WHERE apb01 = l_apa.apa01
 
   FOREACH t110_21_ins2 INTO l_apb.*
      IF STATUS THEN
         CALL cl_err('foreach 21',STATUS,1)  
         LET g_success='N'
         EXIT FOREACH
      END IF
      LET toapk.apk01 = l_apb.apb01                    #折讓單
      LET toapk.apk02 = l_apb.apb02                    #項次
      LET toapk.apk03 = l_apb.apb11                    #發票號碼
      LET toapk.apk04 = l_apa.apa18                    #統一編號
      LET toapk.apk05 = NULL                           #MOD-AC0124
      DECLARE t110_apk05_c SCROLL CURSOR FOR 
        SELECT apk05 FROM apk_file WHERE apk03=toapk.apk03
      OPEN t110_apk05_c
      FETCH FIRST t110_apk05_c INTO toapk.apk05
      CLOSE t110_apk05_c
     #-MOD-AC0124-add-
      IF cl_null(toapk.apk05) THEN
         DECLARE t110_amd05_c SCROLL CURSOR FOR
           SELECT amd05 FROM amd_file WHERE amd03=toapk.apk03
         OPEN t110_amd05_c
         FETCH FIRST t110_amd05_c INTO toapk.apk05
         CLOSE t110_amd05_c
      END IF
     #-MOD-AC0124-end-
      LET l_tax = l_apb.apb10 * l_apa.apa16 /100
     #CALL cl_digcut(l_tax ,l_azi04) RETURNING l_tax   #No.TQC-CC0035   Mark
      CALL cl_digcut(l_tax ,g_azi04) RETURNING l_tax   #No.TQC-CC0035   Add
      LET toapk.apk07 = l_tax                        #稅額
      LET toapk.apk08 = l_apb.apb10                    #未稅金額
      LET toapk.apk06 = toapk.apk07 + toapk.apk08    #含稅金額
      LET toapk.apk06 = cl_digcut(toapk.apk06,g_azi04)
      LET toapk.apk07 = cl_digcut(toapk.apk07,g_azi04)
      LET toapk.apk08 = cl_digcut(toapk.apk08,g_azi04)
      LET toapk.apk11 = l_apa.apa15
      LET toapk.apk29 = l_apa.apa16
      LET toapk.apk12 = l_apa.apa13
      LET toapk.apk13 = l_apa.apa14
      LET toapk.apk07f = l_apb.apb24 * toapk.apk29 / 100
      LET toapk.apk08f = l_apb.apb24
      LET toapk.apk06f = toapk.apk07f + toapk.apk08f
      LET toapk.apk06f = cl_digcut(toapk.apk06f,l_azi04)
      LET toapk.apk07f = cl_digcut(toapk.apk07f,l_azi04)
      LET toapk.apk08f = cl_digcut(toapk.apk08f,l_azi04)
      LET toapk.apk09 = ' '
      LET toapk.apk10 = ' '
      SELECT DISTINCT apk17 INTO toapk.apk17 FROM apk_file
        WHERE apk03 = l_apb.apb11
 
     LET toapk.apk171  = l_apa.apa171    #MOD-AC0128
     #str MOD-B40050 mod 
     # CASE l_apa.apa171
     #   WHEN '21'
     #     LET toapk.apk171 = '23'
     #   WHEN '26'                   #MOD-850320 add  #MOD-AC0128 mod  
     #     LET toapk.apk171 = '23'   #MOD-850320 add  
     #   WHEN '25'                   #MOD-860179 add
     #     LET toapk.apk171 = '23'   #MOD-860179 add
     #   WHEN '28'
     #     LET toapk.apk171 = '29'
     #   WHEN 'XX'
     #     LET toapk.apk171 = 'XX'
     #   OTHERWISE
     #     LET toapk.apk171 = '24'
     #END CASE
       CASE
         WHEN (l_apa.apa171 = '21' OR l_apa.apa171 = '25' OR l_apa.apa171 = '26')
           LET toapk.apk171  = '23'
         WHEN (l_apa.apa171 = '22' OR l_apa.apa171 = '27')
           LET toapk.apk171  = '24'
         WHEN (l_apa.apa171 = '28')
           LET toapk.apk171  = '29'
         WHEN (l_apa.apa171 = 'XX')
           LET toapk.apk171  = 'XX'
      END CASE
     #end MOD-B40050 mod 

      LET toapk.apk172 = l_apa.apa172
      LET toapk.apk173 = 0
      LET toapk.apk174 = 0
     #LET toapk.apk175 = 0       #MOD-A30142 mark
      LET toapk.apk175 = NULL    #MOD-A30142 add
      LET toapk.apk22 = ' '
      LET toapk.apk25 = l_apb.apb12
      LET toapk.apk26 = ''
      LET toapk.apk27 = ''
      LET toapk.apkacti = 'Y'
      LET toapk.apkuser = g_user
      LET toapk.apkgrup = g_grup
      LET toapk.apkdate = today
      LET toapk.apklegal = g_legal #FUN-980001 add
      LET toapk.apkoriu = g_user  #TQC-A10060 add
      LET toapk.apkorig = g_grup  #TQC-A10060 add
      CALL s_get_doc_no(toapk.apk01) RETURNING g_t1
      SELECT apyvcode INTO toapk.apk32  FROM apy_file WHERE apyslip = g_t1   
        IF cl_null(toapk.apk32) THEN 
           LET toapk.apk32 = g_apz.apz63  
        END IF     
      LET toapk.apkoriu = g_user      #No.FUN-980030 10/01/04
      LET toapk.apkorig = g_grup      #No.FUN-980030 10/01/04
      INSERT INTO apk_file VALUES (toapk.*)
      IF STATUS OR SQLCA.SQLCODE THEN
         CALL cl_err3("ins","apk_file",toapk.apk01,toapk.apk02,SQLCA.sqlcode,"","21_ins2_apk:",1)  #No.FUN-660122
         LET g_success = 'N'
      END IF
   END FOREACH
 
END FUNCTION
 
FUNCTION t110_sumf(p_apk02,p_apk03,p_apk06f,p_apk07f,p_apk08f,p_apk171)
DEFINE p_i         LIKE type_file.num5      # No.FUN-690028 SMALLINT
DEFINE l_tot1      LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)
DEFINE l_tot2      LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)
DEFINE l_tot3      LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)
DEFINE l_tot28     LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)
DEFINE l_totl1     LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)
DEFINE l_totl2     LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)
DEFINE l_totl3     LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)
DEFINE l_totl11    LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)
DEFINE l_totl21    LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)
DEFINE l_totl31    LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)
DEFINE l_totl28    LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)
DEFINE l_apk08f    LIKE apk_file.apk08f
DEFINE l_t028      LIKE apk_file.apk08f
DEFINE l_apk07f    LIKE apk_file.apk07f
DEFINE l_apk06f    LIKE apk_file.apk06f
DEFINE p_apk02     LIKE apk_file.apk02
DEFINE p_apk03     LIKE apk_file.apk03
DEFINE p_apk06f    LIKE apk_file.apk06f
DEFINE p_apk07f    LIKE apk_file.apk07f
DEFINE p_apk08f    LIKE apk_file.apk08f
DEFINE p_apk171    LIKE apk_file.apk171
 
   SELECT SUM(apk08f),SUM(apk07f),SUM(apk06f) INTO l_totl1,l_totl2,l_totl3
     FROM apk_file
    WHERE apk01=g_apa.apa01 AND apk171 NOT IN ('23','24')
 
   IF cl_null(l_totl1) THEN
      LET l_totl1 = 0
   END IF
 
   IF cl_null(l_totl2) THEN
      LET l_totl2 = 0
   END IF
 
   IF cl_null(l_totl3) THEN
      LET l_totl3 = 0
   END IF
 
   SELECT SUM(apk08f),SUM(apk07f),SUM(apk06f) INTO l_totl11,l_totl21,l_totl31
     FROM apk_file
    WHERE apk01=g_apa.apa01 AND apk171 IN ('23','24')
 
   IF cl_null(l_totl11) THEN
      LET l_totl11 = 0
   END IF
 
   IF cl_null(l_totl21) THEN
      LET l_totl21 = 0
   END IF
 
   IF cl_null(l_totl31) THEN
      LET l_totl31 = 0
   END IF
 
   IF g_aptype MATCHES '1*' THEN
      LET l_totl1 = l_totl1 - l_totl11
      LET l_totl2 = l_totl2 - l_totl21
      LET l_totl3 = l_totl3 - l_totl31
   ELSE
      LET l_totl1 = l_totl11
      LET l_totl2 = l_totl21
      LET l_totl3 = l_totl31
   END IF
   IF p_apk08f < 0 THEN
      LET p_apk08f = p_apk08f * -1
      LET p_apk07f = p_apk07f * -1
      LET p_apk06f = p_apk06f * -1
   END IF
 
   IF cl_null(p_apk02) THEN
      SELECT apk08f,apk07f,apk06f INTO l_apk08f,l_apk07f,l_apk06f FROM apk_file
       WHERE apk01=g_apa.apa01
         AND apk03=p_apk03
   ELSE
      SELECT apk08f,apk07f,apk06f INTO l_apk08f,l_apk07f,l_apk06f FROM apk_file
       WHERE apk01=g_apa.apa01
         AND apk02=p_apk02
         AND apk03=p_apk03
   END IF
 
   IF SQLCA.SQLCODE=100 THEN
      LET l_apk08f=p_apk08f
      LET l_apk07f=p_apk07f
      LET l_apk06f=p_apk06f
      LET l_totl1=l_totl1+l_apk08f
      LET l_totl2=l_totl2+l_apk07f
      LET l_totl3=l_totl3+l_apk06f
   ELSE
      LET l_totl1=l_totl1-l_apk08f
      LET l_totl2=l_totl2-l_apk07f
      LET l_totl3=l_totl3-l_apk06f
      LET l_totl1=l_totl1+p_apk08f
      LET l_totl2=l_totl2+p_apk07f
      LET l_totl3=l_totl3+p_apk06f
   END IF
 
   LET l_tot1=l_totl1
   LET l_tot2=l_totl2
   LET l_tot3=(l_totl1+l_totl2)
 
   IF g_aptype MATCHES '2*' THEN
      LET l_tot1=l_totl1 * -1
      LET l_tot2=l_totl2 * -1
      LET l_tot3=(l_totl1+l_totl2) * -1
   END IF
   SELECT SUM(apk08f) INTO l_totl28 FROM apk_file
    WHERE apk01=g_apa.apa01
      AND (apk171='28' OR apk171='29')
 
   IF cl_null(l_totl28) THEN
      LET l_totl28 = 0
   END IF
 
   IF p_apk171='28' OR p_apk171='29' THEN
      SELECT apk08f INTO l_t028 FROM apk_file
       WHERE apk01=g_apa.apa01
         AND apk03=p_apk03
         AND (apk171='28' OR apk171='29')
       IF SQLCA.SQLCODE=100 THEN
          LET l_t028=p_apk08f
          LET l_totl28=l_totl1+l_t028
       ELSE
          LET l_totl28=l_totl28-l_t028
          LET l_totl28=l_totl28+p_apk08f
       END IF
   END IF
   LET l_tot28=l_totl28
   IF g_aza.aza26 = '2' THEN
      DISPLAY l_tot1 TO FORMONLY.l_tot1f
      DISPLAY l_tot2 TO FORMONLY.l_tot2f
      DISPLAY l_tot3 TO FORMONLY.l_tot3f
   END IF
 
END FUNCTION
 
FUNCTION t110_comp_oox(p_apv03)
DEFINE l_net     LIKE apv_file.apv04
DEFINE p_apv03   LIKE apv_file.apv03
DEFINE l_apa00   LIKE apa_file.apa00
 
    LET l_net = 0
    IF g_apz.apz27 = 'Y' THEN
       SELECT SUM(oox10) INTO l_net FROM oox_file
        WHERE oox00 = 'AP' AND oox03 = p_apv03
       IF cl_null(l_net) THEN
          LET l_net = 0
       END IF
    END IF
    SELECT apa00 INTO l_apa00 FROM apa_file WHERE apa01=p_apv03
    IF l_apa00 MATCHES '1*' THEN LET l_net = l_net * ( -1) END IF
 
    RETURN l_net
END FUNCTION
 
#detail至多帳期
FUNCTION t110_comp_oox1(p_apv03,p_apv05)
DEFINE l_net     LIKE apv_file.apv04
DEFINE p_apv03   LIKE apv_file.apv03
DEFINE p_apv05   LIKE apv_file.apv05
DEFINE l_apa00   LIKE apa_file.apa00
 
    LET l_net = 0
    IF g_apz.apz27 = 'Y' THEN
       SELECT SUM(oox10) INTO l_net FROM oox_file
        WHERE oox00 = 'AP' AND oox03 = p_apv03
          AND oox041 = p_apv05
       IF cl_null(l_net) THEN
          LET l_net = 0
       END IF
    END IF
    SELECT apa00 INTO l_apa00 FROM apa_file WHERE apa01=p_apv03
    IF l_apa00 MATCHES '1*' THEN LET l_net = l_net * ( -1) END IF
 
    RETURN l_net
END FUNCTION
 
FUNCTION t110_ccc_show_field()
#依參數決定異動碼的多寡
 
  DEFINE l_field     STRING
 
#FUN-B50105   ---start   Mark
# IF g_aaz.aaz88 = 10 THEN
#    RETURN
# END IF
#
# IF g_aaz.aaz88 = 0 THEN
#    LET l_field  = "api21,api22,api23,api24,api31,api32,api33,api34,",
#                   "api35"                                              #MOD-B10093 remove api36 
# END IF
#
# IF g_aaz.aaz88 = 1 THEN
#    LET l_field  = "api22,api23,api24,api31,api32,api33,api34,",
#                   "api35"                                              #MOD-B10093 remove api36 
# END IF
#
# IF g_aaz.aaz88 = 2 THEN
#    LET l_field  = "api23,api24,api31,api32,api33,api34,",
#                   "api35"                                              #MOD-B10093 remove api36 
# END IF
#
# IF g_aaz.aaz88 = 3 THEN
#    LET l_field  = "api24,api31,api32,api33,api34,",
#                   "api35"                                              #MOD-B10093 remove api36 
# END IF
#
# IF g_aaz.aaz88 = 4 THEN
#    LET l_field  = "api31,api32,api33,api34,",
#                   "api35"                                              #MOD-B10093 remove api36 
# END IF
#
# IF g_aaz.aaz88 = 5 THEN
#    LET l_field  = "api32,api33,api34,",
#                   "api35"                                              #MOD-B10093 remove api36 
# END IF
#
# IF g_aaz.aaz88 = 6 THEN
#    LET l_field  = "api33,api34,api35"                                  #MOD-B10093 remove api36 
# END IF
#
# IF g_aaz.aaz88 = 7 THEN
#    LET l_field  = "api34,api35"                                        #MOD-B10093 remove api36 
# END IF
#
# IF g_aaz.aaz88 = 8 THEN
#    LET l_field  = "api35"                                              #MOD-B10093 remove api36
# END IF
#
#FUN-B50105   ---start   Mark
 #-MOD-B10093-mark-
 #IF g_aaz.aaz88 = 9 THEN
 #   LET l_field  = "api36"
 #END IF
 #-MOD-B10093-end-
 
#FUN-B50105   ---start   Add
   IF g_aaz.aaz88 = 0 THEN
      LET l_field = "api21,api22,api23,api24"
   END IF
   IF g_aaz.aaz88 = 1 THEN
      LET l_field = "api22,api23,api24"
   END IF
   IF g_aaz.aaz88 = 2 THEN
      LET l_field = "api23,api24"
   END IF
   IF g_aaz.aaz88 = 3 THEN
      LET l_field = "api24"
   END IF
   IF g_aaz.aaz88 = 4 THEN
      LET l_field = ""
   END IF

   IF NOT cl_null(l_field) THEN 
       LET l_field = l_field,',' 
   END IF

   IF g_aaz.aaz125 = 5 THEN
      LET l_field = l_field,"api32,api33,api34,api35"
   END IF
   IF g_aaz.aaz125 = 6 THEN
      LET l_field = l_field,"api33,api34,api35"
   END IF
   IF g_aaz.aaz125 = 7 THEN
      LET l_field = l_field,"api34,api35"
   END IF
   IF g_aaz.aaz125 = 8 THEN
      LET l_field = l_field,"api35"
   END IF
#FUN-B50105   ---end     Add
  CALL cl_set_comp_visible(l_field,FALSE)
  IF g_aza.aza63='N' THEN
     CALL cl_set_comp_visible("api041,aag021",FALSE)
  END IF
 #CALL cl_set_comp_visible("api26,api35,api36",g_aza.aza08 = 'Y') #FUN-810045 #MOD-B10093 mark
  CALL cl_set_comp_visible("api26,api35",g_aza.aza08 = 'Y') #FUN-810045       #MOD-B10093
END FUNCTION
 
FUNCTION t110_set_no_required()
   CALL cl_set_comp_required("api21,api22,api23,api24,api31,api32,api33,api34,
                              api35,api36,api37",FALSE)
END FUNCTION
 
FUNCTION t110_set_required(l_aag151,l_aag161,l_aag171,l_aag181,
                           l_aag311,l_aag321,l_aag331,l_aag341,
                           l_aag351,l_aag361,l_aag371,l_aag05,    
                           l_aag21,l_aag23)                       #MOD-B10093
DEFINE    l_aag151 LIKE aag_file.aag151,
          l_aag161 LIKE aag_file.aag161,
          l_aag171 LIKE aag_file.aag171,
          l_aag181 LIKE aag_file.aag181,
          l_aag311 LIKE aag_file.aag311,
          l_aag321 LIKE aag_file.aag321,
          l_aag331 LIKE aag_file.aag331,
          l_aag341 LIKE aag_file.aag341,
          l_aag351 LIKE aag_file.aag351,
          l_aag361 LIKE aag_file.aag361,
          l_aag371 LIKE aag_file.aag371,
          l_aag05  LIKE aag_file.aag05,   #TQC-750121
          l_aag21  LIKE aag_file.aag21,   #MOD-B10093
          l_aag23  LIKE aag_file.aag23    #MOD-B10093
 
   IF l_aag05 = 'Y' THEN
     CALL cl_set_comp_required("api07",TRUE)
   END IF
 
  #-MOD-B10093-add-
   IF l_aag21 = 'Y' THEN 
      CALL cl_set_comp_required("api36",TRUE)
   END IF 
 
   IF l_aag23 = 'Y' THEN
      CALL cl_set_comp_required("api26,api35",TRUE)  
   END IF
  #-MOD-B10093-end-

   IF l_aag151 MATCHES '[23]' THEN
      CALL cl_set_comp_required("api21",TRUE)
   END IF
   IF l_aag161 MATCHES '[23]' THEN
      CALL cl_set_comp_required("api22",TRUE)
   END IF
   IF l_aag171 MATCHES '[23]' THEN
      CALL cl_set_comp_required("api23",TRUE)
   END IF
   IF l_aag181 MATCHES '[23]' THEN
      CALL cl_set_comp_required("api24",TRUE)
   END IF
   IF l_aag311 MATCHES '[23]' THEN
      CALL cl_set_comp_required("api31",TRUE)
   END IF
   IF l_aag321 MATCHES '[23]' THEN
      CALL cl_set_comp_required("api32",TRUE)
   END IF
   IF l_aag331 MATCHES '[23]' THEN
      CALL cl_set_comp_required("api33",TRUE)
   END IF
   IF l_aag341 MATCHES '[23]' THEN
      CALL cl_set_comp_required("api34",TRUE)
   END IF
  #-MOD-B10093-mark-
  #IF l_aag351 MATCHES '[23]' THEN
  #   CALL cl_set_comp_required("api35",TRUE)
  #END IF
  #IF l_aag361 MATCHES '[23]' THEN
  #   CALL cl_set_comp_required("api36",TRUE)
  #END IF
  #-MOD-B10093-end-
   IF l_aag371 MATCHES '[23]' THEN
      CALL cl_set_comp_required("api37",TRUE)
   END IF
   IF l_aag371 MATCHES '[4]' AND g_pmc903='Y' THEN          #FUN-950053 add
      CALL cl_set_comp_required("api37",TRUE)               #FUN-950053 add
   END IF                                                   #FUN-950053 add  
END FUNCTION
 
FUNCTION t110_appor_expense()
  DEFINE l_cmd  LIKE type_file.chr1000 #No.FUN-690028 VARCHAR(200)
  DEFINE l_type  LIKE apy_file.apyslip      # No.FUN-690028 VARCHAR(4)   #MOD-7A0143
  DEFINE l_date  LIKE aqa_file.aqa02  
  DEFINE l_aqb01 LIKE aqb_file.aqb01
  DEFINE l_aqa  RECORD LIKE aqa_file.*
  DEFINE l_aqb  RECORD LIKE aqb_file.* 
  DEFINE li_result LIKE type_file.num5,    #No.FUN-690028 SMALLINT
         g_t1   LIKE oay_file.oayslip  #No.FUN-690028 VARCHAR(5)
  DEFINE l_cnt  LIKE type_file.num5,    #TQC-750121
         l_wc   STRING,
         l_sql  STRING
 
    IF s_aapshut(0) THEN
       RETURN
    END IF
 
    IF g_apa.apa01 IS NULL THEN
       CALL cl_err('',-400,0)
       RETURN
    END IF
 
    SELECT * INTO g_apa.* FROM apa_file WHERE apa01=g_apa.apa01
 
    IF g_apa.apaacti ='N' THEN
       CALL cl_err(g_apa.apa01,'9027',0)
       RETURN
    END IF
 
    IF g_apa.apa41='N' THEN
       CALL cl_err(g_apa.apa01,'aap-717',0)
       RETURN
    END IF
 
    LET l_cnt = 0
    SELECT COUNT(*) INTO l_cnt FROM apb_file
      WHERE apb01=g_apa.apa01
        AND apb21 IS NOT NULL
    IF l_cnt > 0 THEN
       CALL cl_err(g_apa.apa01,'aap-610',0)
       RETURN
    END IF
 
   #-MOD-BB0304-add-
    #IF g_apa.apa63 MATCHES '[Ss1]' THEN       #TQC-C50220   mark
     IF g_apa.apa63 MATCHES '[Ss]' THEN       #TQC-C50220   add
       CALL cl_err('','mfg3557',0)
       RETURN
    END IF
   #-MOD-BB0304-end-

   INITIALIZE l_aqa.* TO NULL
   INITIALIZE l_aqb.* TO NULL
 
    LET l_cnt = 0
    LET l_wc = NULL
   
    SELECT COUNT(*) INTO l_cnt FROM aqb_file  WHERE aqb02 = g_apa.apa01
 
   IF l_cnt > 1 THEN
      LET l_sql = "SELECT aqb01 FROM aqb_file WHERE aqb02 ='",g_apa.apa01,"'"
      PREPARE aqb_pre FROM l_sql
      DECLARE aqb_curs CURSOR FOR aqb_pre
      FOREACH aqb_curs INTO l_aqb01
        IF cl_null(l_wc) THEN
           LET l_wc = " aqa01 IN('", l_aqb01,"'"
        ELSE
           LET l_wc = l_wc CLIPPED, ",'",l_aqb01,"'"
        END IF
      END FOREACH
      IF NOT cl_null(l_wc) THEN 
         LET l_wc = l_wc CLIPPED,")"
         LET l_wc = cl_replace_str(l_wc ,"'" ,"\"")
      END IF
   ELSE 
     LET l_aqb01 = ""
     SELECT aqb01 INTO l_aqb01 FROM aqb_file  WHERE aqb02 = g_apa.apa01
   END IF
  
   IF cl_null(l_aqb01) THEN
      OPEN WINDOW t120_w2 AT 7,24 WITH FORM "aap/42f/aapt1202"
            ATTRIBUTE (STYLE = g_win_style CLIPPED) 
 
      CALL cl_ui_locale("aapt1202")
 
      LET l_date = g_today
      DISPLAY l_date TO FORMONLY.date
      CALL cl_set_head_visible("","YES")     #No.FUN-6B0033
 
      INPUT l_type,l_date WITHOUT DEFAULTS FROM FORMONLY.ship,FORMONLY.date 
        AFTER FIELD ship
           IF NOT cl_null(l_type) THEN
                  CALL s_check_no("aap",l_type,'',"41","aqa_file","aqa01","")
                  RETURNING li_result,l_type
              DISPLAY l_type TO FORMONLY.ship
              IF (NOT li_result) THEN
                 LET l_type=""
                 NEXT FIELD ship
              END IF
           ELSE 
             NEXT FIELD ship
           END IF
 
 
        AFTER FIELD date
           IF NOT cl_null(l_date) THEN
              #FUN-B50090 add begin-------------------------
              #重新抓取關帳日期
              SELECT apz57 INTO g_apz.apz57 FROM apz_file WHERE apz00='0'
              #FUN-B50090 add -end--------------------------
              IF l_date <= g_apz.apz57 THEN
                 CALL cl_err(l_aqa.aqa02,'aap-176',0)
                 NEXT FIELD date
              END IF
           ELSE 
              NEXT FIELD date
           END IF
          
        ON ACTION CONTROLP
          CASE
            WHEN INFIELD(ship) #查詢單据
                 LET g_t1=s_get_doc_no(l_type)      
                 CALL q_apy(FALSE,FALSE,g_t1,'41','AAP') RETURNING g_t1  #TQC-670008
                 LET l_type = g_t1
                 DISPLAY l_type TO FORMONLY.ship
                 NEXT FIELD ship
            END CASE
 
            ON ACTION controlg       #TQC-860021
               CALL cl_cmdask()      #TQC-860021
 
            ON IDLE g_idle_seconds   #TQC-860021
               CALL cl_on_idle()     #TQC-860021
               CONTINUE INPUT        #TQC-860021
 
            ON ACTION about          #TQC-860021
               CALL cl_about()       #TQC-860021
 
            ON ACTION help           #TQC-860021
               CALL cl_show_help()   #TQC-860021
      END INPUT
      
      IF INT_FLAG THEN
         LET INT_FLAG=0
         CLOSE WINDOW t120_w2
         RETURN
      ELSE
 
         CLOSE WINDOW t120_w2
      END IF
 
 
      LET l_aqa.aqa01 = l_type
      LET l_aqa.aqa02 = l_date
      LET l_aqa.aqa03 = g_apa.apa31   #MOD-6B0034
      LET l_aqa.aqaacti = 'Y'
      LET l_aqa.aqaconf = 'N'
      LET l_aqa.aqagrup = g_grup
      LET l_aqa.aqainpd = g_today
      LET l_aqa.aqauser = g_user
      LET l_aqa.aqalegal= g_legal #FUN-980001 add
      LET l_aqa.aqaoriu = g_user  #TQC-A10060 add
      LET l_aqa.aqaorig = g_grup  #TQC-A10060 add 
      BEGIN WORK
 
      CALL s_auto_assign_no("aap",l_aqa.aqa01,l_aqa.aqa02,"41","aqa_file","aqa01","","","")
      RETURNING li_result,l_aqa.aqa01
      
      LET l_aqa.aqaoriu = g_user      #No.FUN-980030 10/01/04
      LET l_aqa.aqaorig = g_grup      #No.FUN-980030 10/01/04
      INSERT INTO aqa_file VALUES (l_aqa.*)
      IF SQLCA.sqlcode THEN
         CALL cl_err3("ins","aqa_file",l_aqa.aqa01,"",SQLCA.sqlcode,"","app_exp_aqa:",1)
              ROLLBACK WORK
              RETURN
      END IF
 
      LET l_aqb.aqb01 = l_aqa.aqa01
      LET l_aqb.aqb02 = g_apa.apa01 
      LET l_aqb.aqb03 = g_apa.apa31
      LET l_aqb.aqb04 = g_apa.apa31
      LET l_aqb.aqblegal = g_legal #FUN-980001 add 
 
      INSERT INTO aqb_file VALUES (l_aqb.*) 
      IF SQLCA.sqlcode THEN
         CALL cl_err3("ins","aqb_file",l_aqb.aqb01,l_aqb.aqb02,SQLCA.sqlcode,"","app_exp_aqb:",1)
              ROLLBACK WORK
              RETURN
      END IF
      
      COMMIT WORK
      LET l_aqb01 = l_aqa.aqa01
   END IF
 
   IF l_cnt > 1 THEN                          #TQC-750121
     LET l_cmd = "aapt900 '' '' '",l_wc,"'"   #TQC-750121
   ELSE                                       #TQC-750121
     LET l_cmd = "aapt900 '", l_aqb01 CLIPPED ,"'"
   END IF
   CALL cl_cmdrun_wait(l_cmd)  #FUN-660216 add
     
END FUNCTION
 
FUNCTION t110_set_apa930(p_apa930)
DEFINE p_apa930 LIKE apa_file.apa930
DEFINE l_gem02  LIKE gem_file.gem02
 
   IF cl_null(p_apa930) THEN
      RETURN NULL
   END IF
   SELECT gem02 INTO l_gem02 FROM gem_file
                            WHERE gem01=p_apa930
   IF SQLCA.sqlcode THEN
      LET l_gem02=NULL
   END IF
   RETURN l_gem02
END FUNCTION
 
FUNCTION t110_set_rvv34(p_apb21,p_apb22)  #No.TQC-7B0083
DEFINE  p_apb21  LIKE apb_file.apb21,
        p_apb22  LIKE apb_file.apb22,
        l_rvv40  LIKE rvv_file.rvv40,
        l_apb01  LIKE apb_file.apb01,     #MOD-7A0069 add
        l_n      LIKE type_file.num5,     #MOD-7A0069 add
        l_apb    RECORD LIKE apb_file.*   #MOD-7A0069 add
 
 
   IF cl_null(p_apb21) OR cl_null(p_apb22) THEN
      RETURN 'N'
   END IF
 
   #抓暫估單號
   SELECT apb01 INTO l_apb01 FROM apb_file,apa_file
    WHERE apb21=p_apb21 AND apb22=p_apb22 
      AND (apa00='16' OR apa00='26')
      AND apb01=apa01
      AND apa42 = 'N'  #No.TQC-7B0083
      AND apa41 = 'Y'  #No.TQC-7B0083
 
  IF g_aptype = '12' AND cl_null(l_apb01) THEN
     SELECT UNIQUE apb01 INTO l_apb01 FROM apb_file,apa_file
      WHERE (apa00='16' OR apa00='26')
        AND apb01=apa01
        AND apa42 = 'N'  #No.TQC-7B0083
        AND apa41 = 'Y'  #No.TQC-7B0083
        AND apb01=p_apb21 AND apb02=p_apb22 
  END IF
  IF cl_null(l_apb01) THEN RETURN 'N' ELSE RETURN 'Y' END IF
END FUNCTION
 
FUNCTION t110_set_apb01_unap(p_apb21,p_apb22,p_apb34)  #No.TQC-7B0083  add apb34
DEFINE  p_apb21  LIKE apb_file.apb21,
        p_apb22  LIKE apb_file.apb22,
        p_apb34  LIKE apb_file.apb34,     #No.TQC-7B0083
        l_apb01  LIKE apb_file.apb01,
        l_n      LIKE type_file.num5,     #MOD-7A0069 add
        l_apb    RECORD LIKE apb_file.*   #MOD-7A0069 add
 
   IF p_apb34 = 'N' THEN
      RETURN NULL
   END IF
 
   IF cl_null(p_apb21) OR cl_null(p_apb22) THEN
      RETURN NULL
   END IF
 
   #抓暫估單號
   IF g_apa.apa58 ='3' THEN
      LET l_apb01=p_apb21
   ELSE
      SELECT apb01 INTO l_apb01 FROM apb_file,apa_file
       WHERE apb21=p_apb21 AND apb22=p_apb22 
         AND (apa00='16' OR apa00='26')
         AND apb01=apa01
         AND apa42 = 'N'  #No.TQC-7B0083
         AND apa41 = 'Y'  #No.TQC-7B0083
   END IF   #MOD-850316 add
   IF SQLCA.sqlcode THEN
      LET l_apb01=NULL
   END IF
 
   IF g_aptype = '12' AND cl_null(l_apb01) THEN
      SELECT UNIQUE apb01 INTO l_apb01 FROM apb_file,apa_file
       WHERE (apa00='16' OR apa00='26')
         AND apb01=apa01
         AND apa42 = 'N'  #No.TQC-7B0083
         AND apa41 = 'Y'  #No.TQC-7B0083
         AND apb01=p_apb21 AND apb02=p_apb22 
   END IF
   RETURN l_apb01
END FUNCTION
 
#在每個 CALL cl_ui_init() 之後,要接此函數
FUNCTION t110_set_form_default()
  CALL cl_set_comp_visible("apb35,apb36,apa66",g_aza.aza08='Y')  #FUN-810045 add
  CALL cl_set_comp_visible("apa930,gem02b,apb930,gem02c,api930",g_aaz.aaz90='Y')   #CHI-8C0005 add api930
  CALL cl_set_comp_visible("apa511,apa521,apa541,apb251",g_aza.aza63='Y')  #No.FUN-690080 #CHI-750003 add apb251
  CALL cl_set_comp_visible("a511,a521,a541,b251",g_aza.aza63='Y') #FUN-710078 add 
  CASE g_aptype
     WHEN "11"                                         #MOD-AB0133 
        CALL cl_set_comp_visible("apa58",FALSE)        #MOD-AB0133
        CALL cl_set_comp_visible("page05,apa37f,apa37",FALSE)       #MOD-AC0237
     WHEN "12"                                         #MOD-AB0133 
        CALL cl_set_comp_visible("apa58",FALSE)        #MOD-AB0133
        CALL cl_set_comp_visible("page05,apa37f,apa37",FALSE)       #MOD-AC0237
     WHEN "13"
        CALL cl_set_comp_visible("page06",FALSE)
        CALL cl_set_comp_visible("apa58",FALSE)        #MOD-AB0133
     WHEN "15"                                         #MOD-A70006 
        CALL cl_set_comp_visible("apa58",FALSE)        #MOD-A70006
        CALL cl_set_comp_visible("page05",FALSE)       #MOD-A90089
        CALL cl_set_comp_visible("apa37f,apa37",FALSE)              #MOD-AC0237
     WHEN "17"
        CALL cl_set_comp_visible("page05,page06,apa37f,apa37",FALSE)
        CALL cl_set_comp_visible("apa58",FALSE)        #MOD-AB0133
     WHEN "21"
        CALL cl_set_comp_visible("apb32,apb33",FALSE) #CHI-750003
        CALL cl_set_comp_visible("page05,apa37f,apa37",FALSE)       #MOD-AC0237
     WHEN "22"
        CALL cl_set_comp_visible("apb32,apb33",FALSE) #CHI-750003
        CALL cl_set_comp_visible("page05,apa37f,apa37",FALSE)       #MOD-AC0237
     WHEN "25"
        CALL cl_set_comp_visible("page05",FALSE)
        CALL cl_set_comp_visible("apa05,pmc03,apa21,gen02,apa15,apa16,apa58,
                                  apa32f,apa60f,apa61f,apa37f,apa37,apa32,apa60,apa61,
                                  apa56,apa56_name,apa33,apa52,a52,apa521,a521",FALSE) #FUN-710078 mod
        CALL cl_set_comp_visible("apa541,a541",FALSE)                                  #TQC-980068                                                       
     WHEN "26"
        CALL cl_set_comp_visible("apb32,apb33",FALSE) #CHI-750003
        CALL cl_set_comp_visible("page05",FALSE) #CHI-750011
        CALL cl_set_comp_visible("apa37f,apa37",FALSE)              #MOD-AC0237
     OTHERWISE
        CALL cl_set_comp_visible("page05,apa37f,apa37,apa101,apa102",FALSE)
  END CASE
  IF g_aptype !='11' AND g_aptype !='21' THEN  #No.TQC-7B0083 add 21
     CALL cl_set_comp_visible("apb34,apb01_unap",FALSE)  #No.TQC-7B0083
  END IF
#No.FUN-A40003 --begin
  IF g_aptype <>'12' AND g_aptype<>'22'  THEN #FUN-C90027 add aptype<>22
     CALL cl_set_comp_visible("apa79",FALSE)
  ELSE                                        #FUN-C90027
    CALL cl_set_comp_visible("apa79",TRUE)    #FUN-C90027
  END IF 
#No.FUN-A40003 --end
#FUN-D80031 add ------- begin
  IF g_prog = 'aapt140' THEN
     CALL cl_get_feldname('occ01',g_lang) RETURNING g_msg
     CALL cl_set_comp_att_text("apa05",g_msg CLIPPED)
     CALL cl_get_feldname('occ07',g_lang) RETURNING g_msg
     CALL cl_set_comp_att_text("apa06",g_msg CLIPPED)
     CALL cl_getmsg('axr-627',g_lang) RETURNING g_msg
     CALL cl_set_comp_att_text("apb26",g_msg CLIPPED)
     CALL cl_getmsg('axr-628',g_lang) RETURNING g_msg
     CALL cl_set_comp_att_text("b26",g_msg CLIPPED)
     CALL cl_set_comp_visible("apb21,apb22",FALSE)
  END IF
#FUN-D80031 add ------- end
#FUN-D80049 add ------- begin
 #IF g_prog = 'aapt150' OR g_prog = 'aapq230' THEN       #FUN-DA0051 mark
  IF (g_prog = 'aapt150' OR g_prog = 'aapq230' OR g_prog = 'aapq240') AND        #FUN-DA0051 ADD
     g_aza.aza26 = '2' AND g_apz.apz74 = 'Y' THEN                                #FUN-DA0051 ADD
     CALL cl_getmsg('axr-636',g_lang) RETURNING g_msg
     CALL cl_set_comp_att_text("apa05",g_msg CLIPPED)
     CALL cl_getmsg('axr-637',g_lang) RETURNING g_msg
     CALL cl_set_comp_att_text("apa06",g_msg CLIPPED)
  END IF
#FUN-D80049 add ------- end
END FUNCTION
 
FUNCTION t110_gen_glcr(p_apa,p_apy)
  DEFINE p_apa     RECORD LIKE apa_file.*
  DEFINE p_apy     RECORD LIKE apy_file.*
 
    IF cl_null(p_apy.apygslp) THEN
       CALL cl_err(p_apa.apa01,'axr-070',1)
       LET g_success = 'N'
       RETURN
    END IF       
   #IF g_apa.apa58 <> '1' THEN                           #TQC-C90078 add #MOD-CB0128 mark
    IF g_apa.apa58 <> '1' OR cl_null(g_apa.apa58) THEN   #MOD-CB0128 add
       CALL t110_g_gl(p_apa.apa00,p_apa.apa01,'0','')    #No.FUN-680029  #FUN-9C0001 add ''
    END IF                       #TQC-C90078 add
    IF g_success = 'N' THEN RETURN END IF
 
END FUNCTION
 
FUNCTION t110_carry_voucher()
  DEFINE l_apygslp    LIKE apy_file.apygslp
  DEFINE li_result    LIKE type_file.num5     #No.FUN-690028 SMALLINT
  DEFINE g_t1         LIKE oay_file.oayslip  #No.FUN-690028 VARCHAR(5)
  DEFINE l_dbs        STRING
  DEFINE l_sql        STRING
  DEFINE l_n          LIKE type_file.num5    #No.FUN-690028 SMALLINT
  DEFINE l_wc         STRING                 #No.MOD-7A0006
 
    IF NOT cl_null(g_apa.apa44) OR g_apa.apa44 IS NOT NULL THEN
       CALL cl_err(g_apa.apa44,'aap-618',1)
       RETURN
    END IF   
    
    IF NOT cl_confirm('aap-989') THEN RETURN END IF
 
    CALL s_get_doc_no(g_apa.apa01) RETURNING g_t1
    SELECT * INTO g_apy.* FROM apy_file WHERE apyslip=g_t1
    IF g_apy.apydmy3 = 'N' THEN RETURN END IF
     IF g_apy.apyglcr = 'Y' OR (g_apy.apyglcr ='N' AND NOT cl_null(g_apy.apygslp)) THEN #No.FUN-860107
       LET g_plant_new=g_apz.apz02p CALL s_getdbs() LET l_dbs=g_dbs_new
       #LET l_sql = " SELECT COUNT(aba00) FROM ",l_dbs,"aba_file",
       LET l_sql = " SELECT COUNT(aba00) FROM ",cl_get_target_table(g_apz.apz02p,'aba_file'), #FUN-A50102
                   "  WHERE aba00 = '",g_apz.apz02b,"'",
                   "    AND aba01 = '",g_apa.apa44,"'"
 	 CALL cl_replace_sqldb(l_sql) RETURNING l_sql        #FUN-920032
     CALL cl_parse_qry_sql(l_sql,g_apz.apz02p) RETURNING l_sql #FUN-A50102
       PREPARE aba_pre2 FROM l_sql
       DECLARE aba_cs2 CURSOR FOR aba_pre2
       OPEN aba_cs2
       FETCH aba_cs2 INTO l_n
       IF l_n > 0 THEN
          CALL cl_err(g_apa.apa44,'aap-991',1)
          RETURN
       END IF
 
       LET l_apygslp = g_apy.apygslp
    ELSE
    	 CALL cl_err('','aap-936',1)    #No.FUN-860107 
       RETURN
 
    END IF
    IF cl_null(l_apygslp) OR (cl_null(g_apy.apygslp1) AND g_aza.aza63 = 'Y') THEN #FUN-680029
       CALL cl_err(g_apa.apa01,'axr-070',1)
       RETURN
    END IF
   #No.TQC-C20254 Mark
   #LET g_wc_gl = " npp01='",g_apa.apa01,"'"
   #LET l_wc = g_wc_gl clipped," AND npp011 = 1 "
   #LET g_str = "aapp400" ,
   #            ' "',l_wc CLIPPED,'"',
   #            ' "',g_apa.apauser,'"',   #MOD-7B0159
   #            ' "',g_apa.apauser,'"',   #MOD-7B0159
   #            ' "',g_apz.apz02p,'" ',
   #            ' "',g_apz.apz02b,'" ',
   #            ' "',l_apygslp,'" ',
   #            ' "',g_apa.apa02,'" ',
   #            ' "Y" ',
   #            ' "1" ',     #No.MOD-860075
   #            ' "Y" ',
   #            ' "',g_apz.apz02c,'" ',
   #            ' "',g_apy.apygslp1,'" ',
   #            ' "Y" '                    #MOD-B10041
   #No.TQC-C20254 Mark
   #No.TQC-C20254 Add
    LET g_wc_gl = ' npp01="',g_apa.apa01,'"'
    LET l_wc = g_wc_gl clipped," AND npp011 = 1 "
    LET g_str = "aapp400 '",l_wc CLIPPED,
                "' '",g_apa.apauser,
                "' '",g_apa.apauser,
                "' '",g_apz.apz02p,
                "' '",g_apz.apz02b,
                "' '",l_apygslp,
                "' '",g_apa.apa02,
                "' 'Y' '1' 'Y' '",g_apz.apz02c,
                "' '",g_apy.apygslp1,"' 'Y'"
   #No.TQC-C20254 Add
    CALL cl_wait()
    CALL cl_cmdrun_wait(g_str CLIPPED)   #MOD-7B0209
    SELECT apa44,apa43 INTO g_apa.apa44,g_apa.apa43 FROM apa_file
     WHERE apa01 = g_apa.apa01
#TQC-AB0041 --------------------------Begin-------------------------------
    #IF SQLCA.sqlcode THEN                          #TQC-C30227 mar:
    IF SQLCA.sqlcode OR cl_null(g_apa.apa44) THEN   #TQC-C30227
       CALL cl_err(g_apa.apa01,'aapt002',0) 
    ELSE
       CALL cl_err(g_apa.apa01,'aapt001',0) 
    END IF
#TQC-AB0041 --------------------------End---------------------------------- 
      DISPLAY BY NAME g_apa.apa44
    
END FUNCTION
 
FUNCTION t110_undo_carry_voucher() 
  DEFINE l_aba19    LIKE aba_file.aba19
  DEFINE l_dbs      STRING
  DEFINE l_sql      STRING
  DEFINE g_t1       LIKE oay_file.oayslip  #No.FUN-690028 VARCHAR(5)
  
    IF  cl_null(g_apa.apa44) OR g_apa.apa44 IS  NULL THEN
       CALL cl_err(g_apa.apa44,'aap-619',1)
       RETURN
    END IF   
 
    IF NOT cl_confirm('aap-988') THEN RETURN END IF
 
    CALL s_get_doc_no(g_apa.apa01) RETURNING g_t1
    SELECT * INTO g_apy.* FROM apy_file WHERE apyslip=g_t1
    IF g_apy.apydmy3 = 'N' THEN RETURN END IF   #TQC-7B0051
    IF g_apy.apyglcr = 'N' AND cl_null(g_apy.apygslp)THEN #No.FUN-860107
    	 CALL cl_err('','aap-936',1)    #No.FUN-860107
       RETURN
    END IF
 
    LET g_plant_new=g_apz.apz02p CALL s_getdbs() LET l_dbs=g_dbs_new
    #LET l_sql = " SELECT aba19 FROM ",l_dbs,"aba_file",
    LET l_sql = " SELECT aba19 FROM ",cl_get_target_table(g_apz.apz02p,'aba_file'), #FUN-A50102
                "  WHERE aba00 = '",g_apz.apz02b,"'",
                "    AND aba01 = '",g_apa.apa44,"'"
 	 CALL cl_replace_sqldb(l_sql) RETURNING l_sql        #FUN-920032
     CALL cl_parse_qry_sql(l_sql,g_apz.apz02p) RETURNING l_sql #FUN-A50102
    PREPARE aba_pre1 FROM l_sql
    DECLARE aba_cs1 CURSOR FOR aba_pre1
    OPEN aba_cs1
    FETCH aba_cs1 INTO l_aba19
    IF l_aba19 = 'Y' THEN
       CALL cl_err(g_apa.apa44,'axr-071',1)
       RETURN
    END IF
    LET g_str="aapp409 '",g_apz.apz02p,"' '",g_apz.apz02b,"' '",g_apa.apa44,"' 'Y'"
    CALL cl_cmdrun_wait(g_str)
    SELECT apa44,apa43 INTO g_apa.apa44,g_apa.apa43 FROM apa_file
     WHERE apa01 = g_apa.apa01
      DISPLAY BY NAME g_apa.apa44
   #-------------------------MOD-BB0106----------------start
    IF  NOT cl_null(g_apa.apa44) THEN
       CALL cl_err(g_apa.apa44,'aap-929',1)
       RETURN
    END IF
   #------------------------MOD-BB0106------------------end
END FUNCTION
 
FUNCTION t110_account_period()
   DEFINE l_sql      STRING    #MOD-720062
   DEFINE p_cmd      LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_pmb05   LIKE pmb_file.pmb05
   DEFINE l_apc02   LIKE apc_file.apc02
   DEFINE l_apc08   LIKE apc_file.apc08
   DEFINE l_apc09   LIKE apc_file.apc09
   DEFINE g_apc1 DYNAMIC ARRAY OF RECORD     
                 apc13 LIKE apc_file.apc13    
                #apc14 LIKE apc_file.apc14,      #MOD-B70047 mark                                                                                    
                #apc15 LIKE apc_file.apc15       #MOD-B70047 mark 
                 END RECORD                                                                                                         
   DEFINE l_amt,l_net  LIKE apc_file.apc08
   DEFINE l_lock_sw       LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_modify_flag   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE g_temp          STRING  
   DEFINE
   l_allow_insert  LIKE type_file.num5,                #可新增否  #No.FUN-690028 SMALLINT
   l_allow_delete  LIKE type_file.num5,                #可刪除否  #No.FUN-690028 SMALLINT
   l_allow_update  LIKE type_file.num5                 #可刪除否  #No.FUN-690028 SMALLINT
   DEFINE l_rec_apc_b   LIKE type_file.num10     # No.FUN-690028 INTEGER
   DEFINE l_n,l_i       LIKE type_file.num10     # No.FUN-690028 INTEGER
   DEFINE l_sum,l_sumf  LIKE  apc_file.apc08     
   DEFINE l_max_rec     LIKE type_file.num5      # No.TQC-6B0066
   DEFINE l_apc08_sum   LIKE apc_file.apc08      # No.TQC-740159
   DEFINE l_apc09_sum   LIKE apc_file.apc09      # No.TQC-740159
   DEFINE l_apc10_sum   LIKE apc_file.apc10      # No.TQC-790128
   DEFINE l_apc11_sum   LIKE apc_file.apc11      # No.TQC-790128
   DEFINE l_apc10   LIKE apc_file.apc10
   DEFINE l_apc11   LIKE apc_file.apc11
   DEFINE m_apa         RECORD LIKE apa_file.*   #MOD-780152 add
   DEFINE l_n1          LIKE type_file.num5      #FUN-880113
   DEFINE l_msg         LIKE type_file.chr1000   #MOD-AC0066
 
 
   #FUN-A50102--add--str--
   IF NOT cl_null(g_apa.apa100) THEN
      LET m_plant = g_apa.apa100
   ELSE
      LET m_plant = g_plant
   END IF 
   #FUN-A50102--add--end
   IF g_modify_date IS NULL THEN  #CHI-A50042 add
      IF g_apa.apa41 = 'Y' THEN
         CALL cl_err(g_apa.apa01,'aap-005',0)
      END IF
      IF g_apa.apa63 MATCHES '[Ss1]' THEN 
         CALL cl_err('','mfg3557',0)
      END IF
   END IF  #CHI-A50042 add
 
   LET g_success='Y'
   BEGIN WORK 
   CALL t110_lock_cl()  #FUN-C80078 add
   OPEN t110_cl USING g_apa.apa01
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl k:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK 
      RETURN
   END IF
   FETCH t110_cl INTO m_apa.*    # 鎖住將被更改或取消的資料   #MOD-780152 mod
   IF SQLCA.sqlcode THEN
       CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
       CLOSE t110_cl
       ROLLBACK WORK  
       RETURN
   END IF
   COMMIT WORK    #No.MOD-780152
   OPEN WINDOW t110_apc_w AT 12,2 WITH FORM "aap/42f/aapt110_k"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) 
 
    CALL cl_ui_locale("aapt110_k")
 
 
   CALL g_apc.clear()
   LET g_cnt =1
 
   LET l_sql ="SELECT apc02,apc03,'',apc04,apc05,apc06,apc07,apc08,apc09,apc10,apc11,apc16,apc12,apc14,apc15",  #MOD-B70047 add apc14/apc15
              "  FROM apc_file",
              " WHERE apc01 = ?",
              "   AND apc02 = ?",
              " ORDER BY apc02"
   PREPARE t110_apc_pb_bcl FROM l_sql                                                                                                       
   DECLARE apc_curs_bcl CURSOR FOR t110_apc_pb_bcl
  #LET l_sql ="SELECT apc02,apc03,'',apc04,apc05,apc06,apc07,apc08,apc09,apc10,apc11,apc16,apc12,apc13,apc14,apc15",  #MOD-B70047 mark
   LET l_sql ="SELECT apc02,apc03,'',apc04,apc05,apc06,apc07,apc08,apc09,apc10,apc11,apc16,apc12,apc14,apc15,apc13",  #MOD-B70047
              "  FROM apc_file",
              " WHERE apc01 = ?",
              " ORDER BY apc02"
   PREPARE t110_apc_pb FROM l_sql                                                                                                       
   DECLARE apc_curs CURSOR FOR t110_apc_pb
 
   LET l_sum =0
   LET l_sumf =0
   FOREACH apc_curs USING g_apa.apa01 INTO g_apc[g_cnt].*,g_apc1[g_cnt].*         #MOD-980002  
      IF SQLCA.sqlcode THEN                                                                                                         
         CALL cl_err('foreach:',SQLCA.sqlcode,1)                                                                                    
         EXIT FOREACH                                                                                                               
      END IF      
      LET i= g_cnt                                                                                                                  
      CALL t110_apc03('d')
      IF cl_null(g_apc[g_cnt].apc09) THEN
         LET g_apc[g_cnt].apc09 =0
      END IF
      IF cl_null(g_apc[g_cnt].apc08) THEN
         LET g_apc[g_cnt].apc08 =0
      END IF
     #-MOD-B60066-add-
      IF cl_null(g_apc[g_cnt].apc14) THEN   #MOD-B70047 mod g_apc1 -> g_apc
         LET g_apc[g_cnt].apc14 =0          #MOD-B70047 mod g_apc1 -> g_apc
      END IF
      IF cl_null(g_apc[g_cnt].apc15) THEN   #MOD-B70047 mod g_apc1 -> g_apc
         LET g_apc[g_cnt].apc15 =0          #MOD-B70047 mod g_apc1 -> g_apc
      END IF 
     #-MOD-B60066-end-
      LET l_sum =l_sum + g_apc[g_cnt].apc09 - g_apc[g_cnt].apc15   #MOD-B60066   #TQC-B60291 mod #MOD-B70047 mod g_apc1 -> g_apc
      LET l_sumf=l_sumf+ g_apc[g_cnt].apc08 - g_apc[g_cnt].apc14   #MOD-B60066   #TQC-B60291 mod #MOD-B70047 mod g_apc1 -> g_apc
      LET g_cnt = g_cnt + 1                                                                                                         
      IF g_cnt > g_max_rec THEN                                                                                                     
         CALL cl_err( '', 9035, 0 )                                                                                                 
         EXIT FOREACH                                                                                                               
      END IF                                                                                                                        
   END FOREACH
   CALL g_apc.deleteElement(g_cnt)                                                                                                  
                                                                                                                                    
   LET l_rec_apc_b = g_cnt -1                                                                                       
   DISPLAY l_rec_apc_b TO FORMONLY.cnk
   IF g_apa.apa34 <> l_sum OR g_apa.apa34f <> l_sumf THEN
     #-MOD-AC0066-add-
     #CALL cl_getmsg('aap-984',g_lang) RETURNING g_msg  
      IF g_apa.apa41 = 'Y' THEN
         CALL cl_getmsg('aap-701',g_lang) RETURNING l_msg
         CALL cl_getmsg('aap-918',g_lang) RETURNING g_msg
         LET g_msg = g_msg,l_msg
      ELSE
         CALL cl_getmsg('aap-984',g_lang) RETURNING g_msg
      END IF
     #-MOD-AC0066-add-
      WHILE TRUE
         LET g_chr=' '
         LET INT_FLAG = 0
         IF g_apa.apa08='MISC' THEN
            LET g_chr='2'
         ELSE
            PROMPT g_msg CLIPPED FOR CHAR g_chr
               ON IDLE g_idle_seconds
                  CALL cl_on_idle()
 
               ON ACTION about         #TQC-860021
                  CALL cl_about()      #TQC-860021
 
               ON ACTION help          #TQC-860021
                  CALL cl_show_help()  #TQC-860021
 
               ON ACTION controlg      #TQC-860021
                  CALL cl_cmdask()     #TQC-860021
            END PROMPT
            IF INT_FLAG THEN LET INT_FLAG = 0 EXIT WHILE END IF
         END IF
        #IF g_chr ='2' THEN                #MOD-AC0066 mark 
         IF g_chr ='2' OR g_chr ='Y' THEN  #MOD-AC0066
           DELETE FROM apc_file
            WHERE apc01 = g_apa.apa01 
           IF SQLCA.sqlcode THEN
              CALL cl_err3("del","apc_file",g_apa.apa01,g_apc_t.apc02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
              RETURN
           END IF
            CALL t110_ins_apc(g_apa.*)
            CALL t110_apc_check('')  #TQC-790167   #MOD-830059
            CALL g_apc.clear()
            LET g_cnt =1
            FOREACH apc_curs USING g_apa.apa01 INTO g_apc[g_cnt].*,g_apc1[g_cnt].*         #MOD-980002  
               IF SQLCA.sqlcode THEN                                                                                                         
                  CALL cl_err('foreach:',SQLCA.sqlcode,1)                                                                                    
                  EXIT FOREACH                                                                                                               
               END IF      
               LET i= g_cnt                                                                                                                  
               CALL t110_apc03('d')
               IF cl_null(g_apc[g_cnt].apc09) THEN
                  LET g_apc[g_cnt].apc09 =0
               END IF
               IF cl_null(g_apc[g_cnt].apc08) THEN
                  LET g_apc[g_cnt].apc08 =0
               END IF
               LET g_cnt = g_cnt + 1                                                                                                         
               IF g_cnt > g_max_rec THEN                                                                                                     
                  CALL cl_err( '', 9035, 0 )                                                                                                 
                  EXIT FOREACH                                                                                                               
               END IF                                                                                                                        
            END FOREACH
            CALL g_apc.deleteElement(g_cnt)                                                                                                  
            LET l_rec_apc_b = g_cnt -1                                                                                       
            DISPLAY l_rec_apc_b TO FORMONLY.cnk
            EXIT WHILE
         END IF                                                                                                                                 
        #IF g_chr MATCHES "[12]" THEN EXIT WHILE END IF    #MOD-AC0066 mark
        #-MOD-AC0066-add-
         IF g_apa.apa41 = 'Y' THEN
            IF g_chr MATCHES "[YN]" THEN EXIT WHILE END IF   
         ELSE
            IF g_chr MATCHES "[12]" THEN EXIT WHILE END IF  
         END IF
        #-MOD-AC0066-add-
      END WHILE
   END IF                                                                                                                                 
 
   LET i= 1
   LET l_allow_insert = cl_detail_input_auth("insert")
   LET l_allow_delete = cl_detail_input_auth("delete")
   LET l_allow_update = TRUE
   IF g_hold ='2' THEN
      LET l_allow_insert = FALSE
      LET l_allow_delete = FALSE
      CALL cl_set_comp_entry("apc02,apc03,apc03_pma02,apc04,apc05,apc06,apc07,apc08,apc09,apc10,apc11,apc12",FALSE)
      CALL cl_set_comp_entry("apc62",TRUE)
   END IF
   #CHI-A50042 add --start--
   IF g_modify_date ='Y' THEN
      LET l_allow_insert = FALSE
      LET l_allow_delete = FALSE
      CALL cl_set_comp_entry("apc02,apc03_pma02,apc06,apc07,apc08,apc09,apc10,apc11,apc16,apc12",FALSE)
      CALL cl_set_comp_entry("apc03,apc04,apc05",TRUE)
   END IF
   #CHI-A50042 add --end--
   LET g_sn1 = 'N'
   IF g_aptype = '11' OR g_aptype = '12' OR g_aptype = '13' OR g_aptype = '15' OR
      g_aptype = '17' OR g_aptype = '21' OR g_aptype = '22' THEN                       #No.MOD-B90020 add
     #g_aptype = '17' OR g_aptype = '16' OR g_aptype = '21' OR g_aptype = '22' THEN    #No.MOD-B90020 mark
      #LET l_sql = "SELECT count(*) FROM ",li_dbs CLIPPED,"pmb_file ",
      LET l_sql = "SELECT count(*) FROM ",cl_get_target_table(m_plant,'pmb_file'), #FUN-A50102
                  " WHERE pmb01 = '",g_apa.apa11,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	  CALL cl_parse_qry_sql(l_sql,m_plant) RETURNING l_sql #FUN-A50102            
      PREPARE sel_cou_pmb FROM l_sql
      EXECUTE sel_coU_pmb INTO l_n1
      IF l_n1 <= 0 THEN 
         LET g_sn1 = 'Y'
      END  IF
   END IF
   IF g_aptype MATCHES '1*'  THEN                                                                           
      LET l_max_rec=g_max_rec                                                                                              
   END IF                                                                                                    
   IF g_aptype MATCHES '2*'  THEN                                                                              
      LET l_max_rec = 1                                                                                     
   END IF   
   SELECT SUM(apc08),SUM(apc09),SUM(apc10),SUM(apc11) 
     INTO l_apc08,l_apc09,l_apc10,l_apc11 FROM apc_file 
    WHERE apc01 =g_apa.apa01
   DISPLAY l_apc08 TO amt1
   DISPLAY l_apc09 TO amt2
   DISPLAY l_apc10 TO pay1
   DISPLAY l_apc11 TO pay2
  #IF g_apa.apa63 <> '0' OR g_apa.apa41 <> 'N' OR g_prog ='aapq230' OR g_prog ='aapq240' #CHI-A50042 mark
  #   OR g_sn1 = 'Y' THEN   #FUN-880113  #CHI-A50042 mark
  #IF (g_apa.apa63 <> '0' OR g_apa.apa41 <> 'N' OR g_prog ='aapq230' OR g_prog ='aapq240'                        #CHI-A50042 #MOD-B90020 mark
   IF (g_apa.apa63 <> '0' OR g_apa.apa41 <> 'N' OR g_prog ='aapq230' OR g_prog ='aapq240' OR g_prog = 'aapt160'  #MOD-B90020 add
     #OR g_sn1 = 'Y' ) AND g_modify_date IS NULL THEN   #FUN-880113  #CHI-A50042                    #MOD-AA0187 mark
     #OR g_sn1 = 'Y' ) AND g_modify_date IS NULL AND g_hold <> '2' THEN   #FUN-880113  #CHI-A50042  #MOD-AA0187                      #MOD-AB0162 mark
      OR g_sn1 = 'Y' ) AND g_modify_date IS NULL AND (g_hold IS NULL OR g_hold <> '2') THEN   #FUN-880113  #CHI-A50042  #MOD-AA0187  #MOD-AB0162
      DISPLAY ARRAY g_apc TO s_apc.* ATTRIBUTE(COUNT=g_rec_b,UNBUFFERED) 
   ELSE
      INPUT ARRAY g_apc WITHOUT DEFAULTS FROM s_apc.*
            ATTRIBUTE(COUNT=l_rec_apc_b,MAXCOUNT=l_max_rec,UNBUFFERED,             #No.TQC-6B0066
                      INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)
 
         BEFORE INSERT
            LET i = ARR_CURR()
            LET p_cmd='a'
            INITIALIZE g_apc[i].* TO NULL
            LET g_apc_t.* = g_apc[i].*
            NEXT FIELD apc02
 
         AFTER INSERT
            IF INT_FLAG THEN
               CALL cl_err('',9001,0)
               LET INT_FLAG = 0
               CANCEL INSERT
            END IF
            INSERT INTO apc_file(apc01,apc02,apc03,apc04,apc05,apc06,apc07,apc08,apc09,apc10,apc11,apc16,apc12,apc13,apc14,apc15,apclegal) #FUN-980001 add apclegal
             VALUES(g_apa.apa01,g_apc[i].apc02,g_apc[i].apc03,
                    g_apc[i].apc04,g_apc[i].apc05,g_apc[i].apc06,
                    g_apc[i].apc07,g_apc[i].apc08,g_apc[i].apc09,
                    g_apc[i].apc10,g_apc[i].apc11,g_apc[i].apc16,g_apc[i].apc12,g_apc1[i].apc13,g_apc[i].apc14,g_apc[i].apc15,g_legal) #MO #FUN-980001 add g_legal #MOD-B70047 mod g_apc1 -> g_apc
            IF SQLCA.sqlcode THEN
               CALL cl_err3("ins","apc_file",g_apa.apa01,g_apc[i].apc02,SQLCA.sqlcode,"","ins apc:",1)  
               LET g_success = 'N'
               CANCEL INSERT
            ELSE
               LET l_rec_apc_b = l_rec_apc_b + 1
               MESSAGE "insert ok"
               DISPLAY l_rec_apc_b TO FORMONLY.cnk
            END IF
 
         BEFORE INPUT
            IF l_rec_apc_b != 0 THEN
               CALL fgl_set_arr_curr(i)
            END IF
            CALL t110_set_entry(p_cmd)
            CALL t110_set_entry_1()     #No.FUN-8A0075
            CALL t110_set_no_entry(p_cmd)
            CALL t110_set_entry_1()     #No.FUN-8A0075
 
         BEFORE ROW
            LET p_cmd = ''
            LET i = ARR_CURR()
            LET l_lock_sw = 'N'
            IF l_rec_apc_b >= i THEN
               LET p_cmd='u'
               LET g_apc_t.* = g_apc[i].*
               OPEN apc_curs_bcl USING g_apa.apa01,g_apc_t.apc02                                                                          
               IF STATUS THEN                                                                                                          
                  CALL cl_err("OPEN i010_bcl:", STATUS, 1)                                                                             
                  LET l_lock_sw = "Y"                                                                                                  
               ELSE                                                                                                                    
                  FETCH apc_curs_bcl INTO g_apc[i].*                                                                                    
                  IF SQLCA.sqlcode THEN                                                                                                
                     CALL cl_err(g_apa.apa01,SQLCA.sqlcode,1)                                                                      
                     LET l_lock_sw = "Y"                                                                                               
                  END IF                                                                                                               
                  CALL t110_apc03('d')
               END IF        
            END IF
 
         BEFORE FIELD apc02
            IF cl_null(g_apc[i].apc02) OR g_apc[i].apc02 = 0 THEN
               SELECT MAX(apc02)+1 INTO g_apc[i].apc02 FROM apc_file
                WHERE apc01 = g_apa.apa01
               IF cl_null(g_apc[i].apc02)  THEN
                  LET g_apc[i].apc02 = 1
               END IF
            END IF
 
         AFTER FIELD apc02
            IF g_apc_t.apc02 IS NULL OR
               g_apc_t.apc02 != g_apc[i].apc02 THEN
               SELECT COUNT(*) INTO g_cnt FROM apc_file
                   WHERE apc01 = g_apa.apa01 AND apc02 = g_apc[i].apc02
               IF g_cnt > 0 THEN
                  CALL cl_err('',-239,0)
                  NEXT FIELD apc02
               END IF
            END IF
 
 
         AFTER FIELD apc03
            IF NOT cl_null(g_apc[i].apc03) THEN
               CALL t110_apc03('a') 
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apc[i].apc03,g_errno,1)
                  LET g_apc[i].apc03 =NULL
                  NEXT FIELD apc03
               END IF
               IF p_cmd ='a' OR (p_cmd ='u' AND (g_apc[i].apc03 !=g_apc_t.apc03
                                                 OR g_apc_t.apc03 IS NULL)) THEN
                           SELECT COUNT(apc01) INTO l_n 
                             FROM apc_file 
                            WHERE apc01 =g_apa.apa01
                              AND apc03 =g_apc[i].apc03
                           IF l_n >0 THEN
                              CALL cl_err(g_apc[i].apc03,'aap-917',1)
                              LET g_apc[i].apc03 =null
                              NEXT FIELD apc03
                           END IF 
                           IF g_aptype = '13' OR g_aptype = '17' THEN
                              CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apc[i].apc03,'EMPL')
                                   RETURNING g_apc[i].apc04,g_apc[i].apc05,g_temp
                           ELSE
                              CALL s_paydate('a','',g_apa.apa09,g_apa.apa02,g_apc[i].apc03,g_apa.apa06)
                                   RETURNING g_apc[i].apc04,g_apc[i].apc05,g_temp
                           END IF
                           SELECT pmb05 INTO l_pmb05 FROM pmb_file
                            WHERE pmb01 =g_apa.apa11
                              AND pmb04 =g_apc[i].apc03
                           IF cl_null(l_pmb05) THEN
                              LET l_pmb05 =100   #MOD-920034 mod 0->100
                           END IF
                           LET g_apc[i].apc06 = g_apa.apa14
                           LET g_apc[i].apc07 = g_apa.apa72
                           LET g_apc[i].apc08 = g_apa.apa34f*l_pmb05/100
                           LET g_apc[i].apc09 = g_apa.apa34*l_pmb05/100
                           LET g_apc[i].apc10 = 0
                           LET g_apc[i].apc11 = 0
                           LET g_apc[i].apc12 = g_apa.apa08
                           LET g_apc1[i].apc13 = g_apc[i].apc09 -g_apc[i].apc11 #MOD-980002 l_apc13-->g_apc1[i].apc13
                           LET g_apc[i].apc14 = 0 #MOD-980002 l_apc14-->g_apc1[i].apc14 #MOD-B70047 mod g_apc1 -> g_apc 
                           LET g_apc[i].apc15 = 0 #MOD-980002 l_apc15-->g_apc1[i].apc15 #MOD-B70047 mod g_apc1 -> g_apc 
                           LET g_apc[i].apc16 = 0
               END IF
            ELSE
               DISPLAY ' ' TO FORMONLY.apc03_pma02
            END IF
 
           AFTER FIELD apc08
             LET g_apc[i].apc08 = cl_digcut(g_apc[i].apc08,t_azi04)   #MOD-6B0066
             LET g_apc[i].apc09 = g_apc[i].apc08*g_apc[i].apc06      
             LET g_apc[i].apc09 = cl_digcut(g_apc[i].apc09,g_azi04)   #MOD-6B0066
             LET g_apc1[i].apc13 = cl_digcut(g_apc[i].apc09,g_azi04)   #MOD-AB0256
       
           AFTER FIELD apc09
             LET g_apc[i].apc09 = cl_digcut(g_apc[i].apc09,g_azi04)   #MOD-6B0066
             LET g_apc1[i].apc13 = cl_digcut(g_apc[i].apc09,g_azi04)   #MOD-AB0256
 
           AFTER FIELD apc10
             IF NOT cl_null(g_apc[i].apc10) THEN
                IF l_apc10 > g_apc[i].apc08 THEN
                   CALL cl_err(g_apc[i].apc10,'aap-931',0)
                   LET g_apc[i].apc10 = NULL
                   NEXT FIELD apc10
                END IF
                IF l_apc10 > g_apa.apa35f THEN
                   CALL cl_err(g_apc[i].apc10,'aap-930',0)
                   LET g_apc[i].apc10 = NULL
                   NEXT FIELD apc10
                END IF
                LET g_apc[i].apc10 = cl_digcut(g_apc[i].apc10,g_azi04) 
                LET g_apc[i].apc11 = g_apc[i].apc10*g_apc[i].apc06
                LET g_apc[i].apc11 = cl_digcut(g_apc[i].apc11,g_azi04) 
             END IF
 
           AFTER FIELD apc11
             IF NOT cl_null(g_apc[i].apc11) THEN
                IF l_apc11 > g_apc[i].apc09 THEN
                   CALL cl_err(g_apc[i].apc11,'aap-933',0)
                   LET g_apc[i].apc11 = NULL
                   NEXT FIELD apc11
                END IF
                IF l_apc11 > g_apa.apa35 THEN
                   CALL cl_err(g_apc[i].apc11,'aap-932',0)
                   LET g_apc[i].apc11 = NULL
                   NEXT FIELD apc11
                END IF
                LET g_apc[i].apc11 = cl_digcut(g_apc[i].apc11,g_azi04) 
                LET g_apc[i].apc10 = g_apc[i].apc11/g_apc[i].apc06
                LET g_apc[i].apc10 = cl_digcut(g_apc[i].apc10,g_azi04) 
             END IF
 
           AFTER FIELD apc16
             IF NOT cl_null(g_apc[i].apc16) THEN
                IF g_apc[i].apc16 > g_apc[i].apc08 -g_apc[i].apc10 THEN
                   CALL cl_err(g_apc[i].apc16,'aap-922',0)
                   LET g_apc[i].apc16 =NULL
                   NEXT FIELD apc16
                END IF
             END IF
 
         ON ACTION CONTROLP
              CASE
                WHEN INFIELD(apc03)
                   CALL cl_init_qry_var()
                   LET g_qryparam.form ="q_pma"
                   LET g_qryparam.default1 =g_apc[i].apc03
                   CALL cl_create_qry() RETURNING g_apc[i].apc03
                   DISPLAY g_apc[i].apc03 TO apc03
                   NEXT FIELD apc03
              END CASE
 
           BEFORE DELETE                            #是否取消單身
              IF g_apc[i].apc02 > 0 AND g_apc_t.apc02 IS NOT NULL THEN
                 IF NOT cl_delb(0,0) THEN
                    CANCEL DELETE
                 END IF
                 DELETE FROM apc_file
                  WHERE apc01 = g_apa.apa01 AND apc02 = g_apc_t.apc02
                 IF SQLCA.sqlcode THEN
                    CALL cl_err3("del","apc_file",g_apa.apa01,g_apc_t.apc02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
                    CANCEL DELETE
                 END IF
                 LET l_rec_apc_b = l_rec_apc_b - 1
                 MESSAGE "delete ok"
              END IF
 
 
         ON ROW CHANGE
             IF INT_FLAG THEN
                CALL cl_err('',9001,0)
                LET INT_FLAG = 0
                LET g_apc[i].* = g_apc_t.*
                LET g_success = 'N'
                EXIT INPUT
             END IF
             IF l_lock_sw = 'Y' THEN
                CALL cl_err(g_apc[l_ac].apc02,-263,1)
                LET g_apc[l_ac].* = g_apc_t.*
             ELSE
                IF l_allow_update = TRUE THEN
                   UPDATE apc_file SET apc02 = g_apc[i].apc02,
                                       apc03 = g_apc[i].apc03,
                                       apc04 = g_apc[i].apc04,
                                       apc05 = g_apc[i].apc05,
                                       apc06 = g_apc[i].apc06,
                                       apc07 = g_apc[i].apc07,
                                       apc08 = g_apc[i].apc08,
                                       apc09 = g_apc[i].apc09,
                                       apc10 = g_apc[i].apc10,
                                       apc11 = g_apc[i].apc11,
                                       apc12 = g_apc[i].apc12,
                                       apc16 = g_apc[i].apc16,
                                       apc13 = g_apc1[i].apc13,  #MOD-980002 l_apc13-->g_apc1[i].apc13  
                                       apc14 = g_apc[i].apc14,  #MOD-980002 l_apc14-->g_apc1[i].apc14 #MOD-B70047 mod g_apc1 -> g_apc 
                                       apc15 = g_apc[i].apc15   #MOD-980002 l_apc15-->g_apc1[i].apc15 #MOD-B70047 mod g_apc1 -> g_apc
                    WHERE apc01 = g_apa.apa01
                      AND apc02 = g_apc_t.apc02
                   IF STATUS OR SQLCA.SQLCODE THEN
                      CALL cl_err3("upd","apc_file",g_apa.apa01,g_apc_t.apc02,SQLCA.sqlcode,"","upd apc:",1)  #No.FUN-660122
                      LET g_success = 'N'
                      LET g_apc[i].* = g_apc_t.*
                      ELSE MESSAGE "update ok"  
                   END IF
                END IF
             END IF
 
         AFTER ROW
             SELECT SUM(apc08),SUM(apc09),SUM(apc10),SUM(apc11) 
               INTO l_apc08,l_apc09,l_apc10,l_apc11 FROM apc_file 
              WHERE apc01 =g_apa.apa01
             DISPLAY l_apc08 TO amt1
             DISPLAY l_apc09 TO amt2
             DISPLAY l_apc10 TO pay1
             DISPLAY l_apc11 TO pay2
             LET l_ac = ARR_CURR()
             IF INT_FLAG THEN
                CALL cl_err('',9001,0)
                LET INT_FLAG = 0
                IF p_cmd = 'u' THEN
                   LET g_apc[l_ac].* = g_apc_t.*
                #FUN-D30032--add--str--
                ELSE
                   CALL g_apc.deleteElement(l_ac)
                #FUN-D30032--add--end--
                END IF
                LET g_success = 'N'
                EXIT INPUT
             END IF
 
         ON IDLE g_idle_seconds
            CALL cl_on_idle()
            CONTINUE INPUT
 
         ON ACTION about         #MOD-4C0121
            CALL cl_about()      #MOD-4C0121
 
         ON ACTION help          #MOD-4C0121
            CALL cl_show_help()  #MOD-4C0121
 
         ON ACTION controlg      #MOD-4C0121
            CALL cl_cmdask()     #MOD-4C0121
  
         ON ACTION controls                       #No.FUN-6B0033                                                                       
            CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
 
      END INPUT
   END IF
   IF INT_FLAG THEN
      LET g_success='N'
      LET INT_FLAG = 0
   END IF
 
   IF g_success = 'Y' THEN
      COMMIT WORK
      MESSAGE "Commit"
   ELSE
      ROLLBACK WORK
      MESSAGE "RollBack"
   END IF
 
   LET l_apc08_sum = 0
   LET l_apc09_sum = 0
   LET l_apc10_sum = 0  #TQC-790128
   LET l_apc11_sum = 0  #TQC-790128
  #SELECT SUM(apc08),SUM(apc09),SUM(apc10),SUM(apc11) #TQC-790128 add apc10,apc11             #MOD-B60066 mark
   SELECT SUM(apc08-apc14),SUM(apc09-apc15),SUM(apc10),SUM(apc11) #TQC-790128 add apc10,apc11 #MOD-B60066
     INTO l_apc08_sum,l_apc09_sum,l_apc10_sum,l_apc11_sum #TQC-790128 add l_apc10_sum,l_apc11_sum
     FROM apc_file WHERE apc01 =g_apa.apa01
  #IF l_apc08_sum <> g_apa.apa34f OR l_apc09_sum <> g_apa.apa34 OR                          #MOD-AC0066 mark 
  #   l_apc10_sum <> g_apa.apa35f OR l_apc11_sum <> g_apa.apa35 THEN  #TQC-790128 add       #MOD-AC0066 mark
   IF (l_apc08_sum <> g_apa.apa34f OR l_apc09_sum <> g_apa.apa34 OR                         #MOD-AC0066 
      l_apc10_sum <> g_apa.apa35f OR l_apc11_sum <> g_apa.apa35) AND g_apa.apa41 = 'N' THEN #MOD-AC0066
     CALL cl_err('','aap-918',1)
     COMMIT WORK
     CLOSE WINDOW t110_apc_w
     CALL t110_account_period()
   END IF
 
   CLOSE WINDOW t110_apc_w
 
   SELECT MAX(apc04),MAX(apc05) INTO g_apa.apa12,g_apa.apa64 FROM apc_file
    WHERE apc01 =g_apa.apa01
   IF NOT cl_null(g_apa.apa12) AND NOT cl_null(g_apa.apa64) THEN    #No.MOD-740369
      UPDATE apa_file SET apa12 =g_apa.apa12,
                          apa64 =g_apa.apa64
                    WHERE apa01 =g_apa.apa01
      DISPLAY BY NAME g_apa.apa12,g_apa.apa64   #MOD-810013
   END IF                                                           #No.MOD-740369
   SELECT SUM(apc16) INTO g_apa.apa20 FROM apc_file 
    WHERE apc01 =g_apa.apa01
   IF g_apa.apa20 > 0  THEN                                                                                                         
      IF cl_null(g_apa.apa19) THEN  #MOD-B30233 add
         LET g_apa.apa19 = g_apz.apz12             
      END IF                        #MOD-B30233 add                                                                                    
      UPDATE apa_file SET apa20 = g_apa.apa20,                                                                                      
                          #apa19 = g_apz.apz12  #MOD-B30233 mark                                                                                     
                          apa19 = g_apa.apa19   #MOD-B30233 add
       WHERE apa01 =g_apa.apa01                                                                                                     
      DISPLAY BY NAME g_apa.apa19,g_apa.apa20                                                                                       
      CALL t110_apa19('d')                                                                                                          
   END IF                                                                                                                           
   IF l_lock_sw = 'Y' THEN
      RETURN
   END IF
END FUNCTION
FUNCTION t110_apc_check(l_flag)   #MOD-830059
   DEFINE l_sql      STRING    
   DEFINE l_m       LIKE type_file.chr1    
   DEFINE l_apc02   LIKE apc_file.apc02
   DEFINE l_apc08   LIKE apc_file.apc08
   DEFINE l_apc09   LIKE apc_file.apc09
   DEFINE l_apc13   LIKE apc_file.apc13
   DEFINE l_apc14   LIKE apc_file.apc14
   DEFINE l_apc15   LIKE apc_file.apc15
   DEFINE l_amt     LIKE apc_file.apc08
   DEFINE l_amtf    LIKE apc_file.apc09      #No.TQC-7B0100
   DEFINE l_sum,l_sumf  LIKE  apc_file.apc08     
   DEFINE l_apc08_sum   LIKE apc_file.apc08     
   DEFINE l_apc09_sum   LIKE apc_file.apc09   
   DEFINE l_apc10_sum   LIKE apc_file.apc10   
   DEFINE l_apc11_sum   LIKE apc_file.apc11 
   DEFINE l_apc10   LIKE apc_file.apc10
   DEFINE l_apc11   LIKE apc_file.apc11
   DEFINE l_apg05f  LIKE apg_file.apg05f
   DEFINE l_apg05   LIKE apg_file.apg05
   DEFINE l_flag    LIKE type_file.chr1   #MOD-830059
   DEFINE l_i,l_n   LIKE type_file.num5   #MOD-830059
 
   CALL g_apc.clear()
   LET g_cnt =1
 
  #LET l_sql ="SELECT apc02,apc03,'',apc04,apc05,apc06,apc07,apc08,apc09,apc10,apc11,apc16,apc12,apc13,apc14,apc15",#TQC-C50047 mark
   LET l_sql ="SELECT apc02,apc03,'',apc04,apc05,apc06,apc07,apc08,apc09,apc10,apc11,apc16,apc12,apc14,apc15,apc13",#TQC-C50047 add
              "  FROM apc_file",
              " WHERE apc01 = ?",
              " ORDER BY apc02"
   PREPARE t110_apc_pb1 FROM l_sql                                                                                                       
   DECLARE apc_curs1 CURSOR FOR t110_apc_pb1
 
   LET l_sum =0
   LET l_sumf =0
   LET l_amt  =0   LET l_amtf =0   #MOD-880080 add
   LET l_amtf = g_apa.apa35f                        #MOD-880222 mark回復
   LET l_amt  = g_apa.apa35      #No.TQC-7B0100     #MOD-880222 mark回復
   LET l_m = 'y'
   UPDATE apc_file SET apc10=0,
                       apc11=0,
                       apc13=apc09      #MOD-830059 add
                 WHERE apc01=g_apa.apa01
   IF l_flag = 'w' THEN
      DELETE FROM apg_file WHERE apg01 = g_apa.apa01
      LET l_i = 1
   END IF
  #FOREACH apc_curs1 USING g_apa.apa01 INTO g_apc[g_cnt].*,l_apc13,l_apc14,l_apc15 #MOD-B70047 mark
   FOREACH apc_curs1 USING g_apa.apa01 INTO g_apc[g_cnt].*,l_apc13                 #MOD-B70047
      IF SQLCA.sqlcode THEN                                                                                                         
         CALL cl_err('foreach:',SQLCA.sqlcode,1)                                                                                    
         EXIT FOREACH                                                                                                               
      END IF      
      IF cl_null(g_apc[g_cnt].apc09) THEN
         LET g_apc[g_cnt].apc09 =0
      END IF
      IF cl_null(g_apc[g_cnt].apc08) THEN
         LET g_apc[g_cnt].apc08 =0
      END IF
      IF cl_null(g_apc[g_cnt].apc10) THEN
         LET g_apc[g_cnt].apc10 =0
      END IF
      IF cl_null(g_apc[g_cnt].apc11) THEN
         LET g_apc[g_cnt].apc11 =0
      END IF
     #IF cl_null(l_apc15) THEN   #MOD-B60066 #MOD-B70047 mark
     #   LET l_apc15 =0          #MOD-B60066 #MOD-B70047
      IF cl_null(g_apc[g_cnt].apc15) THEN    #MOD-B70047 
         LET g_apc[g_cnt].apc15 =0           #MOD-B70047
      END IF                     #MOD-B60066
      LET l_sum =l_sum + g_apc[g_cnt].apc09
      LET l_sumf=l_sumf+ g_apc[g_cnt].apc08
      IF l_amtf <= g_apc[g_cnt].apc08 THEN     #No.TQC-7B0100
         UPDATE apc_file SET apc10=l_amtf,
                             apc11=l_amt,
                            #apc13=apc13-l_amt-l_apc15   #MOD-830059 #MOD-B60066 #MOD-B70047 mark
                             apc13=apc13-l_amt-g_apc[g_cnt].apc15    #MOD-B70047 
          WHERE apc01 = g_apa.apa01
            AND apc02 = g_apc[g_cnt].apc02
         IF SQLCA.sqlcode THEN
            CALL cl_err3("del","apc_file",g_apa.apa01,g_apc_t.apc02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
            RETURN
         END IF
         IF l_flag = 'w' THEN
            INSERT INTO apg_file(apg01,apg02,apg03,apg04,apg05f,apg05,apg06,apglegal) #FUN-980001 add apglegal
                VALUES(g_apa.apa01,l_i,g_plant,g_apa.apa01,l_amtf,l_amt,g_apc[g_cnt].apc02,g_legal) #FUN-980001 add g_legal
            IF SQLCA.sqlcode OR SQLCA.SQLERRD[3] = 0 THEN
               CALL cl_err3("ins","apg_file",g_apa.apa01, g_apc[g_cnt].apc02,SQLCA.sqlcode,"","",1)  
               RETURN
            END IF
            LET l_i = l_i + 1
         END IF
         EXIT FOREACH
      ELSE
         IF l_amt >=g_apc[g_cnt].apc09 THEN
            UPDATE apc_file SET apc10=g_apc[g_cnt].apc08,
                                apc11=g_apc[g_cnt].apc09,
                                apc13= 0
             WHERE apc01=g_apa.apa01
               AND apc02 = g_apc[g_cnt].apc02
            IF SQLCA.sqlcode THEN
               CALL cl_err3("del","apc_file",g_apa.apa01,g_apc_t.apc02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
               RETURN
            END IF
            LET l_amtf = l_amtf - g_apc[g_cnt].apc08  
            LET l_amt  = l_amt  - g_apc[g_cnt].apc09    
            IF l_flag = 'w' THEN
               INSERT INTO apg_file(apg01,apg02,apg03,apg04,apg05f,apg05,apg06,apglegal) #FUN-980001 add apglegal
                   VALUES(g_apa.apa01,l_i,g_plant,g_apa.apa01,g_apc[g_cnt].apc08,g_apc[g_cnt].apc09,g_apc[g_cnt].apc02,g_legal)  #FUN-980001 add g_legal
               IF SQLCA.sqlcode OR SQLCA.SQLERRD[3] = 0 THEN
                  CALL cl_err3("ins","apg_file",g_apa.apa01, g_apc[g_cnt].apc02,SQLCA.sqlcode,"","",1)  
                  RETURN
               END IF
               LET l_i = l_i + 1
            END IF
         ELSE
            UPDATE apc_file SET apc10=g_apc[g_cnt].apc08,
                                apc11=l_amt,
                                apc13=apc13-l_amt   #MOD-830059
             WHERE apc01=g_apa.apa01
               AND apc02 = g_apc[g_cnt].apc02
            IF SQLCA.sqlcode THEN
               CALL cl_err3("del","apc_file",g_apa.apa01,g_apc_t.apc02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
               RETURN
            END IF
            LET l_amtf = l_amtf - g_apc[g_cnt].apc08  
            LET l_amt =0
            IF l_flag = 'w' THEN
               INSERT INTO apg_file(apg01,apg02,apg03,apg04,apg05f,apg05,apg06,apglegal) #FUN-980001 add apglegal
                   VALUES(g_apa.apa01,l_i,g_plant,g_apa.apa01,g_apc[g_cnt].apc08,l_amt,g_apc[g_cnt].apc02,g_legal) #FUN-980001 add g_legal
               IF SQLCA.sqlcode OR SQLCA.SQLERRD[3] = 0 THEN
                  CALL cl_err3("ins","apg_file",g_apa.apa01, g_apc[g_cnt].apc02,SQLCA.sqlcode,"","",1)  
                  RETURN
               END IF
               LET l_i = l_i + 1
            END IF
         END IF
      END IF
      LET g_cnt = g_cnt + 1                                                                                                         
      IF g_cnt > g_max_rec THEN                                                                                                     
         CALL cl_err( '', 9035, 0 )                                                                                                 
         EXIT FOREACH                                                                                                               
      END IF                                                                                                                        
   END FOREACH
   IF l_flag = 'w' THEN
      SELECT COUNT(*) INTO l_n FROM aph_file WHERE aph01 =g_apa.apa01
      IF l_n =0 THEN
         DELETE FROM apg_file WHERE apg01 =g_apa.apa01
      END IF
   END IF
   CALL g_apc.deleteElement(g_cnt)                                                                                                  
END FUNCTION
 
FUNCTION t110_apc_check2()   
   DEFINE l_sql      STRING    
   DEFINE l_amtf    LIKE apc_file.apc09      
   DEFINE l_amt     LIKE apc_file.apc08
   DEFINE l_apc13   LIKE apc_file.apc13   #MOD-B90191
 
   CALL g_apc.clear()
   LET g_cnt =1
 
   LET l_sql ="SELECT apc02,apc03,'',apc04,apc05,apc06,apc07,apc08,apc09,apc10,apc11,apc16,apc12,apc14,apc15", #MOD-B70047 add apc14/apc15
              "  FROM apc_file",
              " WHERE apc01 = ?",
              " ORDER BY apc02"
   PREPARE t110_apc_pb2 FROM l_sql                                                                                                       
   DECLARE apc_curs2 CURSOR FOR t110_apc_pb2
 
   LET l_amtf = g_apa.apa65f
   LET l_amt = g_apa.apa65    
   UPDATE apc_file SET apc14=0,apc15=0 WHERE apc01=g_apa.apa01 
   FOREACH apc_curs2 USING g_apa.apa01 INTO g_apc[g_cnt].* 
      IF SQLCA.sqlcode THEN                                                                                                         
         CALL cl_err('foreach:',SQLCA.sqlcode,1)                                                                                    
         EXIT FOREACH                                                                                                               
      END IF      
      IF cl_null(g_apc[g_cnt].apc08) THEN
         LET g_apc[g_cnt].apc08 =0
      END IF
      IF cl_null(g_apc[g_cnt].apc09) THEN
         LET g_apc[g_cnt].apc09 =0
      END IF
     #LET l_apc13 =  g_apc[g_cnt].apc09 - l_amt                        #MOD-B90191 #MOD-C20051 mark
      LET l_apc13 =  g_apc[g_cnt].apc09 - l_amt - g_apc[g_cnt].apc11   #MOD-C20051 add
      IF l_amtf <= g_apc[g_cnt].apc08 THEN  
         UPDATE apc_file SET apc14=l_amtf,
                             apc15=l_amt,
                             #apc13=apc13-l_amt   #MOD-B60066 #MOD-B90191 mark
                             apc13=l_apc13        #MOD-B90191 mod
          WHERE apc01 = g_apa.apa01
            AND apc02 = g_apc[g_cnt].apc02
         IF SQLCA.sqlcode THEN
            CALL cl_err3("upd","apc_file",g_apa.apa01,g_apc[g_cnt].apc02,SQLCA.sqlcode,"","",1)  
            RETURN
         END IF
         EXIT FOREACH
      ELSE
         IF l_amt >=g_apc[g_cnt].apc09 THEN
            UPDATE apc_file SET apc14=g_apc[g_cnt].apc08,
                                apc15=g_apc[g_cnt].apc09,
                                apc13=apc13-g_apc[g_cnt].apc09   #MOD-B60066
             WHERE apc01=g_apa.apa01
               AND apc02 = g_apc[g_cnt].apc02
            IF SQLCA.sqlcode THEN
               CALL cl_err3("upd","apc_file",g_apa.apa01,g_apc[g_cnt].apc02,SQLCA.sqlcode,"","",1)  
               RETURN
            END IF
            LET l_amtf = l_amtf - g_apc[g_cnt].apc08  
            LET l_amt  = l_amt  - g_apc[g_cnt].apc09    
         ELSE
            UPDATE apc_file SET apc14=g_apc[g_cnt].apc08,
                                apc15=l_amt,
                                apc13=apc13-g_apc[g_cnt].apc09  #MOD-B60066
             WHERE apc01=g_apa.apa01
               AND apc02 = g_apc[g_cnt].apc02
            IF SQLCA.sqlcode THEN
               CALL cl_err3("upd","apc_file",g_apa.apa01,g_apc[g_cnt].apc02,SQLCA.sqlcode,"","",1)  
               RETURN
            END IF
            LET l_amtf = l_amtf - g_apc[g_cnt].apc08  
            LET l_amt =0
         END IF
      END IF
      LET g_cnt = g_cnt + 1                                                                                                         
      IF g_cnt > g_max_rec THEN                                                                                                     
         CALL cl_err( '', 9035, 0 )                                                                                                 
         EXIT FOREACH                                                                                                               
      END IF                                                                                                                        
   END FOREACH
   CALL g_apc.deleteElement(g_cnt)                                                                                                  
END FUNCTION
 
FUNCTION t110_apc03(p_cmd)
 DEFINE p_cmd    LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
 DEFINE p_apc03  LIKE apc_file.apc03
 DEFINE l_pma02     LIKE pma_file.pma02
 DEFINE l_pmaacti   LIKE pma_file.pmaacti
 
 LET g_errno =' '
 SELECT pma02,pmaacti INTO l_pma02,l_pmaacti FROM pma_file 
  WHERE pma01 = g_apc[i].apc03
 
   CASE                                                                                                                             
       WHEN SQLCA.sqlcode=100   LET g_errno='100'                                                                               
                                LET l_pma02=NULL                                                                                    
       WHEN l_pmaacti='N'       LET g_errno='9028'                                                                                  
       OTHERWISE                                                                                                                    
            LET g_errno=SQLCA.sqlcode USING '------'                                                                                
   END CASE                                                                                                                         
   IF p_cmd='d' OR cl_null(g_errno)THEN   
      LET g_apc[i].apc03_pma02 =l_pma02                                                                                          
      IF SQLCA.sqlcode THEN 
         LET g_apc[i].apc03_pma02 =null                                                                                             
      END IF    
   END IF    
END FUNCTION
 
FUNCTION t110_ins_apc(m_apa)
DEFINE m_apa     RECORD LIKE apa_file.*
DEFINE l_cnt     LIKE type_file.num5    #No.FUN-690028 SMALLINT
DEFINE g_apc     RECORD LIKE apc_file.*
DEFINE g_pmb     RECORD LIKE pmb_file.*
DEFINE g_temp    STRING
DEFINE l_apc02   LIKE apc_file.apc02    #No.TQC-6B0066
DEFINE l_apc08   LIKE apc_file.apc08    #No.TQC-6B0066
DEFINE l_apc09   LIKE apc_file.apc09    #No.TQC-6B0066
DEFINE l_pmb02   LIKE pmb_file.pmb02    #TQC-770027
DEFINE l_apa20   LIKE apa_file.apa20    #MOD-A20091 add
DEFINE l_sumamtf LIKE apa_file.apa34f   #MOD-B60066
DEFINE l_sumamt  LIKE apa_file.apa34    #MOD-B60066
 
   SELECT COUNT(*) INTO l_cnt 
     FROM apc_file
    WHERE apc01 =m_apa.apa01    
 
   IF l_cnt >0 THEN
      RETURN
   END IF
 
   LET l_cnt =0
   SELECT azi04 INTO t_azi04 FROM azi_file                                                                                          
      #WHERE azi01 = g_apa.apa13   #TQC-C80061  mark
      WHERE azi01 = m_apa.apa13    #TQC-C80061  add     

  #IF NOT (m_apa.apa00 = '23' ) THEN   #No.TQC-7C0094               #No.MOD-B90020 mark
   IF NOT (m_apa.apa00 = '23' ) AND NOT (m_apa.apa00 = '16') THEN   #No.TQC-7C0094 #No.MOD-B90020 add
      LET g_sql = " SELECT pmb01,pmb02,pmb03,pmb04,pmb05",
                  "   FROM pmb_file ",
                  "  WHERE pmb01 = '",m_apa.apa11,"'"
      PREPARE p110_p1 FROM g_sql
      DECLARE p110_c1 CURSOR FOR p110_p1
      #LET l_apa20 = g_apa.apa20     #MOD-A20091 add       #TQC-C80061  mark
      LET l_apa20 = m_apa.apa20                            #TQC-C80061  add
      IF cl_null(l_apa20) THEN LET l_apa20 = 0 END IF      #MOD-A30209 add
      FOREACH p110_c1 INTO g_pmb.pmb01,g_pmb.pmb02,g_pmb.pmb03,
                           g_pmb.pmb04,g_pmb.pmb05
         IF cl_null(g_pmb.pmb02) THEN CONTINUE FOREACH END IF 
         IF g_aptype MATCHES '2*' THEN CONTINUE FOREACH END IF   #MOD-810064 add
         IF g_pmb.pmb02 = 1 AND g_aptype MATCHES '1*' THEN          #No.TQC-6B0066
            LET g_apc.apc01 = m_apa.apa01
            LET g_apc.apc02 = g_pmb.pmb03
            LET g_apc.apc03 = g_pmb.pmb04
            IF g_aptype = '13' OR g_aptype = '17' THEN
               CALL s_paydate('a','',m_apa.apa09,m_apa.apa02,g_apc.apc03,'EMPL')
                    RETURNING g_apc.apc04,g_apc.apc05,g_temp
            ELSE
               CALL s_paydate('a','',m_apa.apa09,m_apa.apa02,g_apc.apc03,m_apa.apa06)
                    RETURNING g_apc.apc04,g_apc.apc05,g_temp
            END IF
            IF cl_null(g_pmb.pmb05) THEN 
               LET g_pmb.pmb05 =100
            END IF
            LET g_apc.apc06 = m_apa.apa14
            LET g_apc.apc07 = m_apa.apa72
            LET g_apc.apc08 = (m_apa.apa34f+m_apa.apa65f)*g_pmb.pmb05/100 #TQC-B60206 add apa65f 
            LET g_apc.apc09 = (m_apa.apa34+m_apa.apa65)*g_pmb.pmb05/100   #TQC-B60206 add apa65
            IF g_apc.apc10 IS NULL THEN LET g_apc.apc10 = 0 END IF
            IF g_apc.apc11 IS NULL THEN LET g_apc.apc11 = 0 END IF
            #LET g_apc.apc10 = g_apa.apa35f*g_pmb.pmb05/100     #TQC-C80061  mark
            #LET g_apc.apc11 = g_apa.apa35*g_pmb.pmb05/100      #TQC-C80061  mark
            LET g_apc.apc10 = m_apa.apa35f*g_pmb.pmb05/100      #TQC-C80061  add
            LET g_apc.apc11 = m_apa.apa35*g_pmb.pmb05/100       #TQC-C80061  add  
            LET g_apc.apc12 = m_apa.apa08
            LET g_apc.apc13 = g_apc.apc09-g_apc.apc11
           #LET g_apc.apc14 = 0                                #No.MOD-B90002 mark
            LET g_apc.apc14 = m_apa.apa65f*g_pmb.pmb05/100     #No.MOD-B90002 add
           #LET g_apc.apc15 = 0                                #No.MOD-B90002 mark
            LET g_apc.apc15 = m_apa.apa65*g_pmb.pmb05/100      #No.MOD-B90002 add
           #MOD-A20091---modify---start---
           #LET g_apc.apc16 = 0             
            IF l_apa20 >=(g_apc.apc08-g_apc.apc10) THEN
               LET g_apc.apc16 =g_apc.apc08-g_apc.apc10
               LET l_apa20 =l_apa20-g_apc.apc16
            ELSE  
               LET g_apc.apc16 =l_apa20
               LET l_apa20 =0
            END IF
           #MOD-A20091---modify---end---
         END IF
         IF g_pmb.pmb02 = 2  AND g_aptype MATCHES '1*' THEN          #No.TQC-6B0066
            LET g_apc.apc01 = m_apa.apa01
            LET g_apc.apc02 = 1
            LET g_apc.apc03 = m_apa.apa11
            LET g_apc.apc04 = m_apa.apa12
            LET g_apc.apc05 = m_apa.apa64
            LET g_apc.apc06 = m_apa.apa14
            LET g_apc.apc07 = m_apa.apa72
            LET g_apc.apc08 = m_apa.apa34f + m_apa.apa65f #TQC-B60206 add apa65f
            LET g_apc.apc09 = m_apa.apa34  + m_apa.apa65  #TQC-B60206 add apa65
            LET g_apc.apc10 = m_apa.apa35f                                                                                          
            LET g_apc.apc11 = m_apa.apa35                                                                                           
            LET g_apc.apc12 = m_apa.apa08
            LET g_apc.apc13 = g_apc.apc09-g_apc.apc11
           #LET g_apc.apc14 = 0                       #No.MOD-B90002 mark
            LET g_apc.apc14 = m_apa.apa65f            #No.MOD-B90002 add
           #LET g_apc.apc15 = 0                       #No.MOD-B90002 mark
            LET g_apc.apc15 = m_apa.apa65             #No.MOD-B90002 add
           #MOD-A20091---modify---start---
           #LET g_apc.apc16 = 0             
            IF l_apa20 >=(g_apc.apc08-g_apc.apc10) THEN
               LET g_apc.apc16 =g_apc.apc08-g_apc.apc10
               LET l_apa20 =l_apa20-g_apc.apc16
            ELSE  
               LET g_apc.apc16 =l_apa20
               LET l_apa20 =0
            END IF
           #MOD-A20091---modify---end---
         END IF
         LET g_apc.apc08 = cl_digcut(g_apc.apc08,t_azi04)
         LET g_apc.apc09 = cl_digcut(g_apc.apc09,g_azi04)
         LET g_apc.apc13 = cl_digcut(g_apc.apc13,g_azi04)
  
         LET g_apc.apclegal = g_legal #FUN-980001 add 
         INSERT INTO apc_file VALUES(g_apc.*)
         IF SQLCA.sqlcode THEN
            CALL cl_err3("ins","apc_file","apc01","apc02",SQLCA.sqlcode,"","",1)
            LET g_success ='N'
            RETURN
         ELSE
            LET l_cnt =1
            #SELECT MAX(apc04),MAX(apc05) INTO g_apa.apa12,g_apa.apa64 FROM apc_file   #TQC-C80061  mark
            # WHERE apc01 =g_apa.apa01                                                 #TQC-C80061  mark
            SELECT MAX(apc04),MAX(apc05) INTO m_apa.apa12,m_apa.apa64 FROM apc_file    #TQC-C80061  add
              WHERE apc01 =m_apa.apa01                                                 #TQC-C80061  add
            #UPDATE apa_file SET apa12 =g_apa.apa12,    #TQC-C80061  mark
            #                    apa64 =g_apa.apa64     #TQC-C80061  mark
            UPDATE apa_file SET apa12 =m_apa.apa12,     #TQC-C80061  add  
                                apa64 =m_apa.apa64      #TQC-C80061  add
             WHERE apa01 =g_apc.apc01
         END IF
         IF g_pmb.pmb02 = 2  THEN 
             EXIT FOREACH
         END IF
      END FOREACH
   ELSE                               #MOD-A70037 
      LET l_apa20 =0                  #MOD-A70037
   END IF #No.TQC-7A0095
   IF l_cnt = 0 OR g_aptype MATCHES '2*' THEN          #No.TQC-6B0066
      LET g_apc.apc01 = m_apa.apa01
      LET g_apc.apc02 = 1
      LET g_apc.apc03 = m_apa.apa11
      LET g_apc.apc04 = m_apa.apa12
      LET g_apc.apc05 = m_apa.apa64
      LET g_apc.apc06 = m_apa.apa14
      LET g_apc.apc07 = m_apa.apa72
      LET g_apc.apc14 = 0                       #No.MOD-B90002 add
      LET g_apc.apc15 = 0                       #No.MOD-B90002 add
     #-MOD-B60066-add-
      IF g_aptype MATCHES '1*' THEN
         LET g_apc.apc08 = m_apa.apa34f + m_apa.apa65f
         LET g_apc.apc09 = m_apa.apa34  + m_apa.apa65
         LET g_apc.apc14 = m_apa.apa65f         #No.MOD-B90002 add
         LET g_apc.apc15 = m_apa.apa65          #No.MOD-B90002 add
      ELSE
     #-MOD-B60066-end-
         LET g_apc.apc08 = m_apa.apa34f
         LET g_apc.apc09 = m_apa.apa34
      END IF   #MOD-B60066
      LET l_sumamtf = g_apc.apc08   #MOD-B60066
      LET l_sumamt  = g_apc.apc09   #MOD-B60066
      LET g_apc.apc10 = m_apa.apa35f                                                                                                
      LET g_apc.apc11 = m_apa.apa35                                                                                                 
      LET g_apc.apc12 = m_apa.apa08
      LET g_apc.apc13 = g_apc.apc09-g_apc.apc11
     #LET g_apc.apc14 = 0                       #No.MOD-B90002 mark
     #LET g_apc.apc15 = 0                       #No.MOD-B90002 mark
     #MOD-A20091---modify---start---
     #LET g_apc.apc16 = 0             
      IF l_apa20 >=(g_apc.apc08-g_apc.apc10) THEN
         LET g_apc.apc16 =g_apc.apc08-g_apc.apc10
         LET l_apa20 =l_apa20-g_apc.apc16
      ELSE  
         LET g_apc.apc16 =l_apa20
         LET l_apa20 =0
      END IF
     #MOD-A20091---modify---end---
      LET g_apc.apc08 = cl_digcut(g_apc.apc08,t_azi04)
      LET g_apc.apc09 = cl_digcut(g_apc.apc09,g_azi04)
      LET g_apc.apc13 = cl_digcut(g_apc.apc13,g_azi04)
      LET g_apc.apclegal = g_legal #FUN-980001 add 
      INSERT INTO apc_file VALUES(g_apc.*)
      IF SQLCA.sqlcode THEN
         CALL cl_err3("ins","apc_file","apc01","apc02",SQLCA.sqlcode,"","",1)
         LET g_success ='N'
         RETURN
      END IF
      #SELECT MAX(apc04),MAX(apc05) INTO g_apa.apa12,g_apa.apa64 FROM apc_file    #TQC-C80061  mark
      # WHERE apc01 =g_apa.apa01                                                  #TQC-C80061  mark
      SELECT MAX(apc04),MAX(apc05) INTO m_apa.apa12,m_apa.apa64 FROM apc_file     #TQC-C80061  add
       WHERE apc01 =m_apa.apa01                                                   #TQC-C80061  add
      #UPDATE apa_file SET apa12 =g_apa.apa12,                                    #TQC-C80061  mark
      #                    apa64 =g_apa.apa64                                     #TQC-C80061  mark 
      #              WHERE apa01 =g_apa.apa01                                     #TQC-C80061  mark
      UPDATE apa_file SET apa12 =m_apa.apa12,                                     #TQC-C80061  add
                          apa64 =m_apa.apa64                                      #TQC-C80061  add
                    WHERE apa01 =m_apa.apa01                                      #TQC-C80061  add
   END IF
 
   #No.TQC-6B0066 --start-- 為了消除小數位數四舍五入引起的誤差，將產生的誤差加入最后一筆數據
   SELECT SUM(apc08),SUM(apc09),MAX(apc02) INTO l_apc08,l_apc09,l_apc02
     FROM apc_file
    WHERE apc01 = g_apc.apc01
   IF SQLCA.sqlcode THEN
      CALL cl_err3("sel","apc_file",g_apc.apc01,"",SQLCA.sqlcode,"","",1)
      LET g_success ='N'
      RETURN
   END IF
   IF cl_null(l_apc08) THEN
      LET l_apc08 = 0
   END IF
   IF cl_null(l_apc09) THEN
      LET l_apc09 = 0
   END IF
  #IF l_apc08 <> m_apa.apa34f THEN  #MOD-B60066 mark
   IF l_apc08 <> l_sumamtf THEN     #MOD-B60066
      UPDATE apc_file SET apc08 = apc08-(l_apc08-m_apa.apa34f)   #No.TQC-740159
       WHERE apc01 = g_apc.apc01
         AND apc02 = l_apc02
      IF SQLCA.sqlcode THEN
         CALL cl_err3("upd","apc_file",g_apc.apc01,l_apc02,SQLCA.sqlcode,"","",1)
         LET g_success ='N'
         RETURN
      END IF
   END IF       
  #IF l_apc09 <> m_apa.apa34 THEN  #MOD-B60066 mark
   IF l_apc09 <> l_sumamt THEN     #MOD-B60066
      CALL t110_comp_oox1(g_apc.apc01,l_apc02) RETURNING g_net  #MOD-940090    
      UPDATE apc_file SET apc09 = apc09-(l_apc09-m_apa.apa34),    #No.TQC-740159
                          apc13 = apc09-(l_apc09-m_apa.apa34) - apc11 + g_net   #MOD-940090 
       WHERE apc01 = g_apc.apc01
         AND apc02 = l_apc02
      IF SQLCA.sqlcode THEN
         CALL cl_err3("upd","apc_file",g_apc.apc01,l_apc02,SQLCA.sqlcode,"","",1)
         LET g_success ='N'
         RETURN
      END IF
   END IF       
 
END FUNCTION
FUNCTION t110_upd_apc_date()
   SELECT COUNT(*) INTO g_cnt FROM apc_file WHERE apc01 =g_apa.apa01
   IF g_cnt >1 THEN
      RETURN
   END IF
   IF g_cnt =1 THEN
      UPDATE apc_file SET apc04 =g_apa.apa12,
                          apc05 =g_apa.apa64
       WHERE apc01 =g_apa.apa01
   END IF
END FUNCTION
 
FUNCTION t110_gen(p_gen01,p_flag)                                               
   DEFINE p_gen01   LIKE gen_file.gen01,                                        
          l_gen02   LIKE gen_file.gen02,                                        
          l_gen03   LIKE gen_file.gen03,                                        
          l_genacti LIKE gen_file.genacti,                                      
          p_flag    LIKE type_file.chr1                                         
                                                                                
   #FUN-A50102--add--str--
   IF NOT cl_null(g_apa.apa100) THEN
      LET m_plant = g_apa.apa100
   ELSE
      LET m_plant = g_plant
   END IF 
   #FUN-A50102--add--end
   LET g_errno = NULL                                                           
   LET l_sql = "SELECT gen02,gen03,genacti ",
               #"  FROM ",li_dbs CLIPPED,"gen_file ",
               "  FROM ",cl_get_target_table(m_plant,'gen_file'), #FUN-A50102
               " WHERE gen01 = '",p_gen01,"' "
   CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
   CALL cl_parse_qry_sql(l_sql,m_plant) RETURNING l_sql #FUN-A50102                  
   PREPARE sel_gen_cs FROM l_sql
   EXECUTE sel_gen_cs INTO l_gen02,l_gen03,l_genacti
                                                                                
   CASE WHEN SQLCA.SQLCODE = 100 LET g_errno = 'aap-038'                        
        WHEN l_genacti = 'N'     LET g_errno = '9028'                           
        WHEN SQLCA.SQLCODE != 0  LET g_errno = SQLCA.SQLCODE USING '-----'      
   END CASE                                                                     
   IF cl_null(g_errno) THEN                                                     
      IF p_flag = '1' THEN                                                      
         LET g_apb[l_ac].apb26 = l_gen03                                        
         LET g_apb[l_ac].b32 = l_gen02        #FUN-990025 add                                        
         DISPLAY l_gen02 TO FORMONLY.b32      #FUN-990025 add
         DISPLAY BY NAME g_apb[l_ac].apb26                                      
      ELSE                                                                      
         LET g_apa.apa07 = l_gen02                
         LET g_apa.apa22 = l_gen03                                             
         DISPLAY BY NAME g_apa.apa07,g_apa.apa22                                
      END IF                                                                    
   END IF                                                                       
                                                                                
END FUNCTION  
   
FUNCTION t110_apa101(p_cmd)
   DEFINE p_cmd     LIKE type_file.chr1  
   DEFINE l_nma10   LIKE nma_file.nma10     #No.TQC-6C0074
   DEFINE l_nma28   LIKE nma_file.nma28     #No.TQC-6C0074
   DEFINE l_nma37   LIKE nma_file.nma37     #No.TQC-6C0074
   DEFINE l_nmaacti LIKE nma_file.nmaacti
 
   LET g_errno = ' '
   SELECT nma10,nma28,nma37,nmaacti INTO l_nma10,l_nma28,l_nma37,l_nmaacti    #No.TQC-6C0074
     FROM nma_file 
    WHERE nma01 = g_apa.apa101
 
   CASE WHEN SQLCA.SQLCODE = 100     LET g_errno = 'aap-007'
        WHEN l_nmaacti = 'N'         LET g_errno = 'anm-017'
        WHEN l_nma28 ='1' OR l_nma37  ='0'                           #No.TQC-6C0074
           IF g_aza.aza26!='2' THEN                                  #FUN-C80018
              LET g_errno = 'aap-601'                                #No.TQC-6C0074
           ELSE                                                      #FUN-C80018
              IF l_nma37  ='0' THEN                                 #FUN-C80018
                 LET g_errno = 'aap-601'                            #FUN-C80018
              END IF                                                #FUN-C80018
            END IF
        WHEN l_nma10 != g_apa.apa13                                  #No.TQC-6C0074
                                     LET g_errno = 'aap-602'         #No.TQC-6C0074
        WHEN SQLCA.SQLCODE != 0  LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE
 
END FUNCTION
 
FUNCTION t110_apa102(p_cmd)
   DEFINE p_cmd     LIKE type_file.chr1  
   DEFINE l_nmc03   LIKE nmc_file.nmc03
   DEFINE l_nmcacti LIKE nmc_file.nmcacti
 
   LET g_errno = ' '
   SELECT nmc03,nmcacti INTO l_nmc03,l_nmcacti
     FROM nmc_file 
    WHERE nmc01 = g_apa.apa102
 
   CASE WHEN SQLCA.SQLCODE = 100 LET g_errno = 'anm-024'
        WHEN l_nmc03 = '2'       LET g_errno = 'anm-019'
        WHEN l_nmcacti = 'N'     LET g_errno = '9028'
        WHEN SQLCA.SQLCODE != 0  LET g_errno = SQLCA.SQLCODE USING '-----'
   END CASE
 
END FUNCTION
 
#還款
FUNCTION t110_k_1()
   DEFINE l_totf    LIKE apc_file.apc09
   DEFINE l_amtf    LIKE apc_file.apc09
   DEFINE l_tot     LIKE apc_file.apc09
   DEFINE l_amt     LIKE apc_file.apc09
   DEFINE l_apx04   LIKE apx_file.apx04
   DEFINE cnt1      LIKE type_file.num5  
   DEFINE cnt2      LIKE type_file.num5  
   DEFINE i,j,k     LIKE type_file.num5  
   DEFINE l_sql     STRING     #MOD-720062
   DEFINE p_cmd     LIKE type_file.chr1  
   DEFINE g_apx     DYNAMIC ARRAY OF RECORD
            apx02   LIKE apx_file.apx02,
            apx03   LIKE apx_file.apx03,
            apa07   LIKE apa_file.apa07,
            apa08   LIKE apa_file.apa08,
            apa14   LIKE apa_file.apa14,
            apx04f  LIKE apx_file.apx04,
            apx04   LIKE apx_file.apx04,
            apa73f  LIKE apa_file.apa73,  #No.TQC-7C0094
            apa73   LIKE apa_file.apa73   #No.TQC-7C0094
                END RECORD
   DEFINE g_apx_t   RECORD
            apx02   LIKE apx_file.apx02,
            apx03   LIKE apx_file.apx03,
            apa07   LIKE apa_file.apa07,
            apa08   LIKE apa_file.apa08,
            apa14   LIKE apa_file.apa14,
            apx04f  LIKE apx_file.apx04,
            apx04   LIKE apx_file.apx04,
            apa73f  LIKE apa_file.apa73,  #No.TQC-7C0094
            apa73   LIKE apa_file.apa73   #No.TQC-7C0094
                END RECORD
   DEFINE m_apa     DYNAMIC ARRAY OF RECORD
            apa13   LIKE apa_file.apa13,
            apa72   LIKE apa_file.apa72,
            apa73   LIKE apa_file.apa73
                END RECORD
   DEFINE m_apa_t   RECORD
                    apa13     LIKE apa_file.apa13,
                    apa72     LIKE apa_file.apa72,
                    apa73     LIKE apa_file.apa73
                    END RECORD
   DEFINE m_apa34f  LIKE apa_file.apa34f
   DEFINE m_apa34   LIKE apa_file.apa34    #No.MOD-590312
   DEFINE m_apa73   LIKE apa_file.apa73
   DEFINE m_amt     LIKE apc_file.apc09
   DEFINE l_apa     RECORD LIKE apa_file.*
   DEFINE l_net     LIKE apx_file.apx04
   DEFINE l_apa14   LIKE apa_file.apa14
   DEFINE l_apx02   LIKE apx_file.apx02
   DEFINE l_i       LIKE type_file.num5  
   DEFINE l_apa13   LIKE apa_file.apa13
   DEFINE l_apa41   LIKE apa_file.apa41
   DEFINE l_apx04f  LIKE apx_file.apx04f
   DEFINE l_apa35f,l_apa35 LIKE apa_file.apa35
   DEFINE l_difff,l_diff   LIKE apa_file.apa34
   DEFINE l_sumf,l_sum     LIKE apa_file.apa34
   DEFINE l_sumf_h,l_sum_h LIKE apa_file.apa34
   DEFINE l_total          LIKE apa_file.apa34
   DEFINE l_lock_sw        LIKE type_file.chr1  
   DEFINE l_modify_flag    LIKE type_file.chr1  
   DEFINE l_k,l_over       LIKE type_file.num5,  
   l_allow_insert   LIKE type_file.num5,   #可新增否
   l_allow_delete   LIKE type_file.num5    #可刪除否
   DEFINE ls_rec_b  LIKE type_file.num10  
   DEFINE l_apa06   LIKE apa_file.apa06    #MOD-580079
   DEFINE l_apa73f  LIKE apa_file.apa73    #No.TQC-7C0094 原幣未還金額
   DEFINE l_apa73   LIKE apa_file.apa73    #No.TQC-7C0094 本幣未還金額
 
   IF g_apa.apa01 IS NULL THEN
      CALL cl_err('apa01 null',-400,0)
      RETURN
   END IF
   SELECT * INTO g_apa.* FROM apa_file
    WHERE apa01=g_apa.apa01
   IF g_apa.apa34f >= g_apa.apa35f AND g_apa.apa31f > 0 THEN     #No.MOD-780123 #TQC-790128
      CALL cl_err(g_apa.apa01,'aap-096',0)
      RETURN
   END IF
 
   IF g_apa.apa00[1,1] = '2' THEN
      RETURN
   END IF
   IF g_apa.apa41 = 'Y' THEN
      CALL cl_err(g_apa.apa01,'aap-005',0)
      RETURN
   END IF
   IF g_apa.apa63 MATCHES '[Ss1]' THEN      #FUN-540045 #FUN-550042
      CALL cl_err('','mfg3557',0)
      RETURN
   END IF
 
   LET g_success='Y'
   LET g_apa_t.* = g_apa.*
   BEGIN WORK
   CALL t110_lock_cl()  #FUN-C80078 add
   OPEN t110_cl USING g_apa.apa01
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl k:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF
   FETCH t110_cl INTO g_apa.*                   # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
      CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)  # 資料被他人LOCK
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF
 
   OPEN WINDOW t110_xxx_w AT 12,2 WITH FORM "aap/42f/aapt110_l"
      ATTRIBUTE (STYLE = g_win_style CLIPPED) #No.FUN-580092 HCN
 
   CALL cl_ui_locale("aapt110_l")
 
   SELECT azi04 INTO t_azi04 FROM azi_file
    WHERE azi01 = g_apa.apa13
 
   SELECT COUNT(*) INTO cnt1 FROM apx_file WHERE apx01 = g_apa.apa01
 
   IF cnt1 > 0 THEN
      DECLARE t110_xxx_c0 CURSOR FOR
        SELECT apx02,apx03,apa07,apa08,apa14,apx04f,apx04,apa13,'','',apa72,apa73
          FROM apx_file,apa_file
         WHERE apx01 = apa01
           AND apa01 = g_apa.apa01
 
      CALL g_apx.clear()
      LET i = 1
 
      FOREACH t110_xxx_c0 INTO g_apx[i].apx02,g_apx[i].apx03,g_apx[i].apa07,g_apx[i].apa08,
                               g_apx[i].apa14,g_apx[i].apx04f,g_apx[i].apx04,
                               g_apx[i].apa73f,g_apx[i].apa73,                   #No.TQC-7C0094
                               m_apa[i].apa13,m_apa[i].apa72,m_apa[i].apa73
 
         IF g_apz.apz27 = 'Y' AND m_apa[i].apa13 !=g_aza.aza17 THEN
             LET g_apx[i].apa14  = m_apa[i].apa72
         END IF
         IF g_apa.apa00='11' THEN
            DROP TABLE x
 
            SELECT apb06 po_no FROM apb_file,apa_file      
             WHERE apa01=g_msg AND apa01=apb01 AND apa41='Y' AND apa42!='Y'
              INTO TEMP x
 
            SELECT COUNT(*) INTO g_cnt FROM x     # 如果原預付有指定 P/O No
 
            IF g_cnt > 0 THEN
               SELECT MAX(po_no) INTO g_msg FROM x
               SELECT COUNT(*) INTO g_cnt FROM apb_file, x
                WHERE apb01=g_apa.apa01 AND apb06=po_no
               IF g_cnt=0 THEN
                  INITIALIZE g_apx[i].* TO NULL CONTINUE FOREACH
               END IF
            END IF
         END IF
 
         CALL t110_apx03_unpay(g_apx[i].apx03) 
           RETURNING g_apx[i].apa73f,g_apx[i].apa73
 
         LET i = i + 1
         IF i > g_max_rec THEN     #No.MOD-480131
            EXIT FOREACH
         END IF
      END FOREACH
      CALL g_apx.deleteElement(i)
      LET ls_rec_b = i - 1
 
      SELECT SUM(apx04f),SUM(apx04) INTO l_sumf_h,l_sum_h FROM apx_file
       WHERE apx01= g_apa.apa01
      IF cl_null(l_sumf_h) THEN LET l_sumf_h = 0 END IF
      IF cl_null(l_sum_h)  THEN LET l_sum_h  = 0 END IF
      DISPLAY l_sumf_h TO FORMONLY.apa65f
      DISPLAY l_sum_h  TO FORMONLY.apa65
   END IF
   
   LET l_allow_insert = cl_detail_input_auth("insert")
   LET l_allow_delete = cl_detail_input_auth("delete")
 
   LET i = 1
   INPUT ARRAY g_apx WITHOUT DEFAULTS FROM s_apx.*
         ATTRIBUTE(COUNT=ls_rec_b,MAXCOUNT=g_max_rec,UNBUFFERED,
                   INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)
 
      BEFORE INSERT
         LET i = ARR_CURR()
         LET p_cmd='a'
         INITIALIZE g_apx[i].* TO NULL
         LET g_apx_t.* = g_apx[i].*
         LET g_apx[i].apa14 = g_apa.apa14
         LET g_apx[i].apa07 = g_apa.apa07
         NEXT FIELD apx02
 
      AFTER INSERT
         IF INT_FLAG THEN
            CALL cl_err('',9001,0)
            LET INT_FLAG = 0
            CANCEL INSERT
         END IF
         INSERT INTO apx_file(apx01,apx02,apx03,apx04f,apx04,apxlegal) #FUN-980001 add apxlegal
          VALUES(g_apa.apa01,g_apx[i].apx02,g_apx[i].apx03,
                 g_apx[i].apx04f,g_apx[i].apx04,g_legal) #FUN-980001 add g_legal
         IF SQLCA.sqlcode THEN
            CALL cl_err3("ins","apx_file",g_apa.apa01,g_apx[i].apx02,SQLCA.sqlcode,"","ins apx:",1)  #No.FUN-660122
            LET g_success = 'N'
            CANCEL INSERT
         ELSE
            LET ls_rec_b = ls_rec_b + 1
            MESSAGE "insert ok"
            IF g_success = 'Y' THEN
 
              SELECT SUM(apx04f),SUM(apx04) INTO l_sumf_h,l_sum_h FROM apx_file
               WHERE apx01=g_apa.apa01
              IF cl_null(l_sumf_h) THEN LET l_sumf_h = 0 END IF
              IF cl_null(l_sum_h)  THEN LET l_sum_h  = 0 END IF
              DISPLAY l_sumf_h TO FORMONLY.apa65f
              DISPLAY l_sum_h  TO FORMONLY.apa65
            END IF
         END IF
 
      BEFORE INPUT
         IF ls_rec_b != 0 THEN
            CALL fgl_set_arr_curr(i)
         END IF
         LET g_before_input_done = FALSE
         CALL t110_set_entry_apx('a')
         CALL t110_set_no_entry_apx('a')
         LET g_before_input_done = TRUE
 
      BEFORE ROW
         LET p_cmd = ''
         LET i = ARR_CURR()
         LET l_lock_sw = 'N'
         IF ls_rec_b >= i THEN
            LET p_cmd='u'
            LET g_apx_t.* = g_apx[i].*
            CALL cl_show_fld_cont()     #FUN-550037(smin)
         END IF
 
      BEFORE FIELD apx02
         IF cl_null(g_apx[i].apx02) OR g_apx[i].apx02 = 0 THEN
            SELECT MAX(apx02)+1 INTO g_apx[i].apx02 FROM apx_file
             WHERE apx01 = g_apa.apa01
            IF cl_null(g_apx[i].apx02)  THEN
               LET g_apx[i].apx02 = 1
            END IF
            LET g_apx[i].apx04f= 0
            LET g_apx[i].apx04 = 0
         END IF
          CALL t110_set_entry_apx(p_cmd)  #MOD-4A0288
 
      AFTER FIELD apx02
         IF g_apx_t.apx02 IS NULL OR
            g_apx_t.apx02 != g_apx[i].apx02 THEN
            SELECT COUNT(*) INTO k FROM apx_file
                WHERE apx01 = g_apa.apa01 AND apx02 = g_apx[i].apx02
            IF k > 0 THEN
               CALL cl_err('',-239,0)
               NEXT FIELD apx02
            END IF
         END IF
         DISPLAY BY NAME g_apx[i].apx02
         CALL t110_set_no_entry_apx(p_cmd)  #MOD-4A0288
 
      AFTER FIELD apx03
        IF NOT cl_null(g_apx[i].apx03) THEN
           SELECT COUNT(apa01) INTO l_i FROM apa_file 
            WHERE apa00 = '25' AND apa06 = g_apa.apa06
              AND apa01 = g_apx[i].apx03
              AND apa34f-apa35f > 0
           IF cl_null(l_i) THEN LET l_i = 0 END IF
           IF l_i = 0 THEN 
              CALL cl_err(g_apx[i].apx03,'aap-114',0)
              NEXT FIELD apx03
           END IF 
           IF p_cmd='a' OR (p_cmd='u' AND g_apx[i].apx03 <> g_apx_t.apx03) THEN
              SELECT COUNT(apx03) INTO l_i FROM apx_file
               WHERE apx01= g_apa.apa01
                 AND apx03=g_apx[i].apx03
              IF l_i > 0 THEN 
                 CALL cl_err(g_apx[i].apx03,'atm-310',0)
                 NEXT FIELD apx03
              END IF
           END IF
           CALL t110_apx03_unpay(g_apx[i].apx03) 
             RETURNING g_apx[i].apa73f,g_apx[i].apa73
        END IF
 
      AFTER FIELD apx04f
         IF NOT cl_null(g_apx[i].apx04f) THEN
            IF g_apx[i].apx04f < 0 THEN
               CALL cl_err('','mfg4012',0)
               NEXT FIELD apx04f
            END IF
            IF g_apx[i].apx04f > g_apx[i].apa73f THEN
               CALL cl_err(g_apx[i].apx04f,'aap-113',1)
               NEXT FIELD apx04f
            END IF
            LET l_apx04 = g_apx[i].apx04f * g_apx[i].apa14
            LET g_apx[i].apx04 = l_apx04
         END IF
         IF cl_null(g_apx_t.apx04f) THEN
            LET g_apx_t.apx04f = 0
         END IF
 
         LET l_total = l_difff + g_apx_t.apx04f
 
         IF  g_apx[i].apx04f > l_total THEN
            LET g_apx[i].apx04f = 0
            LET g_apx[i].apx04 = 0
            CALL cl_err(g_apa.apa01,'aap-194',0)
            NEXT FIELD apx04f
         END IF
         LET g_apx[i].apx04f = cl_digcut(g_apx[i].apx04f,t_azi04) #MOD-660095
         LET g_apx[i].apx04 = cl_digcut(g_apx[i].apx04,g_azi04) #MOD-660095
 
      AFTER FIELD apx04
         IF NOT cl_null(g_apx[i].apx04) THEN
            IF g_apx[i].apx04 < 0 THEN
               CALL cl_err('','mfg4012',0)
               NEXT FIELD apx04
            END IF
            LET l_sum = 0
            LET l_sumf = 0
            LET l_over = 0
            IF cl_null(g_apx_t.apx04f) THEN
               LET g_apx_t.apx04f = 0
               LET g_apx_t.apx04 = 0
            END IF
            LET l_total = l_diff + g_apx_t.apx04
            IF  g_apx[i].apx04 > l_total THEN
               LET g_apx[i].apx04f = 0
               LET g_apx[i].apx04 = 0
               CALL cl_err(g_apa.apa01,'aap-194',0)
               LET l_over = 1
            END IF
            IF l_over=1 THEN
               NEXT FIELD apx04f
            END IF
         END IF
         LET g_apx[i].apx04 = cl_digcut(g_apx[i].apx04,g_azi04) #MOD-660095
 
        BEFORE DELETE                            #是否取消單身
           IF g_apx[i].apx02 > 0 AND g_apx_t.apx02 IS NOT NULL THEN
              IF NOT cl_delb(0,0) THEN
                 CANCEL DELETE
              END IF
              DELETE FROM apx_file
               WHERE apx01 = g_apa.apa01 AND apx02 = g_apx_t.apx02
              IF SQLCA.sqlcode THEN
                 CALL cl_err3("del","apx_file",g_apa.apa01,g_apx_t.apx02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
                 CANCEL DELETE
              END IF
              LET ls_rec_b = ls_rec_b - 1
              MESSAGE "delete ok"
              IF g_success = 'Y' THEN #No.MOD-580365
                 SELECT SUM(apx04f),SUM(apx04) INTO l_sumf_h,l_sum_h
                   FROM apx_file WHERE apx01=g_apa.apa01
                 IF cl_null(l_sumf_h) THEN LET l_sumf_h = 0 END IF
                 IF cl_null(l_sum_h)  THEN LET l_sum_h  = 0 END IF
                 DISPLAY l_sumf_h TO FORMONLY.apa65f
                 DISPLAY l_sum_h  TO FORMONLY.apa65
              END IF
           END IF
 
      ON ROW CHANGE
          IF INT_FLAG THEN
             CALL cl_err('',9001,0)
             LET INT_FLAG = 0
             LET g_apx[l_ac].* = g_apx_t.*
             CLOSE t110_loc2_cr
             LET g_success = 'N'
             EXIT INPUT
          END IF
          IF l_lock_sw = 'Y' THEN
             CALL cl_err(g_apx[l_ac].apx02,-263,1)
             LET g_apx[l_ac].* = g_apx_t.*
          ELSE
             UPDATE apx_file SET apx02 = g_apx[i].apx02,
                                 apx04f= g_apx[i].apx04f,
                                 apx04 = g_apx[i].apx04 
                           WHERE apx01 = g_apa.apa01
                             AND apx02 = g_apx_t.apx02
             IF STATUS OR SQLCA.SQLCODE THEN
                CALL cl_err3("upd","apx_file",g_apa.apa01,g_apx_t.apx02,SQLCA.sqlcode,"","upd apx:",1)  #No.FUN-660122
                LET g_success = 'N'
                LET g_apx[i].* = g_apx_t.*
                ELSE MESSAGE "update ok"
             END IF
             IF g_success = 'Y' THEN #No.MOD-580365
                 SELECT SUM(apx04f),SUM(apx04) INTO l_sumf_h,l_sum_h
                   FROM apx_file WHERE apx01=g_apa.apa01
                 IF cl_null(l_sumf_h) THEN LET l_sumf_h = 0 END IF
                 IF cl_null(l_sum_h)  THEN LET l_sum_h  = 0 END IF
                 DISPLAY l_sumf_h TO FORMONLY.apa65f
                 DISPLAY l_sum_h  TO FORMONLY.apa65
             END IF
          END IF
 
      AFTER ROW
          LET l_ac = ARR_CURR()
          IF INT_FLAG THEN
             CALL cl_err('',9001,0)
             LET INT_FLAG = 0
             IF p_cmd = 'u' THEN
                LET g_apx[l_ac].* = g_apx_t.*
             #FUN-D30032--add--str--
             ELSE
                CALL g_apx.deleteElement(l_ac)
             #FUN-D30032--add--end--
             END IF
             CLOSE t110_loc2_cr
             LET g_success = 'N'
             EXIT INPUT
          END IF
          CLOSE t110_loc2_cr
 
      ON ACTION CONTROLP
         CASE
            WHEN INFIELD(apx03) 
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_apx01"
               LET g_qryparam.arg1 = g_apa.apa06
               LET g_qryparam.default1 = g_apx[i].apx03
               CALL cl_create_qry() RETURNING g_apx[i].apx03 
         END CASE
 
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
     #計算匯差
     AFTER INPUT
        LET l_net = 0
        FOR l_i = 1 TO g_apx.getLength()
            IF g_apx[l_i].apa14 <> g_apa.apa14 THEN
               LET l_amt=g_apx[l_i].apx04f*g_apa.apa14-g_apx[l_i].apx04
               IF cl_null(l_amt) THEN LET l_amt=0 END IF
               LET l_net = l_net + l_amt
            END IF
        END FOR
     ON ACTION controls                       #No.FUN-6B0033                                                                       
        CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
 
   END INPUT
 
   IF INT_FLAG THEN
      LET g_success='N'
      LET INT_FLAG = 0
   END IF
 
   SELECT SUM(apx04f),SUM(apx04) INTO g_apa.apa37f,g_apa.apa37
     FROM apx_file WHERE apx01=g_apa.apa01
 
   IF cl_null(g_apa.apa37f) THEN
      LET g_apa.apa37f = 0
   END IF
 
   IF cl_null(g_apa.apa37 ) THEN
      LET g_apa.apa37 = 0
   END IF
 
 
   UPDATE apa_file SET apa37f=g_apa.apa37f,apa37=g_apa.apa37
    WHERE apa01 = g_apa.apa01
 
   IF STATUS OR SQLCA.SQLCODE THEN
      CALL cl_err3("upd","apa_file", g_apa.apa01,"",SQLCA.sqlcode,"","upd apa37:",1)  #No.FUN-660122
   END IF
 
   CLOSE WINDOW t110_xxx_w
 
   DISPLAY BY NAME g_apa.apa37f,g_apa.apa37
 
   IF l_lock_sw = 'Y' THEN
      RETURN
   END IF
 
   
   CALL t110_apa65f(g_apa.apa37f,g_apa.apa37)        #No.TQC-7C0094
 
   LET g_apa.apa72 = g_apa.apa14
   CALL t110_comp_oox(g_apa.apa01) RETURNING g_net       #CHI-890017 add
   LET g_apa.apa73 = g_apa.apa34 - g_apa.apa35 + g_net   #CHI-890017
 
   UPDATE apa_file set * = g_apa.* WHERE apa01 = g_apa.apa01
 
   CALL t110_up_gl()
   CALL t110_unpay()
 
   DELETE FROM apx_file WHERE apx01 = g_apa.apa01 AND apx04 = 0
 
   CALL t110_diff_rtn('0')   #TQC-750140
  #CALL t110_api_diff()      #No.TQC-7B0083  #MOD-C60107 mark
   IF g_apa.apa37f > 0 THEN
      IF cl_null(g_apa.apa101) OR cl_null(g_apa.apa102) THEN
         CALL cl_err(g_apa.apa01,'aap-095',1)
         CALL t110_upd_apa101()
      END IF
   END IF
   IF g_success = 'Y' THEN
      COMMIT WORK
      MESSAGE "Commit"
      CLOSE t110_cl
   ELSE
      ROLLBACK WORK
      MESSAGE "RollBack"
      LET g_apa.* = g_apa_t.*       #MOD-B40036
      CLOSE t110_cl
   END IF
 
END FUNCTION
 
FUNCTION t110_set_entry_apx(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1  
 
   CALL cl_set_comp_entry("apx03",TRUE)
   IF p_cmd = 'F' THEN
      CALL cl_set_comp_entry("apx04f",TRUE)
   END IF
END FUNCTION
 
FUNCTION t110_set_no_entry_apx(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1  
 
   IF p_cmd = 'F' THEN
      CALL cl_set_comp_entry("apx04f",FALSE)
   END IF
END FUNCTION
 
FUNCTION t110_upd_apa101()
   DEFINE l_apa101_desc LIKE nma_file.nma02    #FUN-D80071
   DEFINE l_apa102_desc LIKE nmc_file.nmc02    #FUN-D80071
 
   LET g_success = 'Y'
   CALL cl_set_head_visible("","YES")     #No.FUN-6B0033
 
   INPUT g_apa.apa101,g_apa.apa102 WITHOUT DEFAULTS FROM apa101,apa102
      BEFORE INPUT 
         LET g_apa_o.apa101 = g_apa.apa101
         LET g_apa_o.apa102 = g_apa.apa102
         CALL cl_set_comp_required("apa101,apa102",TRUE)
 
      AFTER FIELD apa101       #還款銀行
         IF NOT cl_null(g_apa.apa101) THEN
            IF g_apa_o.apa101 IS NULL OR g_apa.apa101 != g_apa_o.apa101 THEN
               CALL t110_apa101('a')
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa101,g_errno,0)
                  NEXT FIELD apa101
               END IF
            END IF
            LET g_apa_o.apa101 = g_apa.apa101
            #FUN-D80071--add--str--
            IF g_aptype='13' THEN
               LET l_apa101_desc=''
               SELECT nma02 INTO l_apa101_desc FROM nma_file WHERE nma01=g_apa.apa101
               DISPLAY l_apa101_desc TO apa101_desc
            END IF
            #FUN-D80071--add--end
         END IF
 
      AFTER FIELD apa102       #還款異動碼
         IF NOT cl_null(g_apa.apa102) THEN
            IF g_apa_o.apa102 IS NULL OR g_apa.apa102 != g_apa_o.apa102 THEN
               CALL t110_apa102('a')
               IF NOT cl_null(g_errno) THEN
                  CALL cl_err(g_apa.apa102,g_errno,0)
                  NEXT FIELD apa102
               END IF
            END IF
            #FUN-D80071--add--str--
            IF g_aptype='13' THEN
               LET l_apa102_desc=''
               SELECT nmc02 INTO l_apa102_desc FROM nmc_file WHERE nmc01=g_apa.apa102
               DISPLAY l_apa102_desc TO apa102_desc
            END IF
            #FUN-D80071--add--end
         END IF
 
      AFTER INPUT
         CALL cl_set_comp_required("apa101,apa102",FALSE)
 
      ON ACTION CONTROLP
         CASE
            WHEN INFIELD(apa101)   #還款銀行
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_nma"
               IF g_aptype='13' THEN
                  LET g_qryparam.where ="nma28 !=1 and nma37 !=0 and nma10='",g_apa.apa13,"'" 
               END IF
               LET g_qryparam.default1 = g_apa.apa101
               CALL cl_create_qry() RETURNING g_apa.apa101
               DISPLAY BY NAME g_apa.apa101
            WHEN INFIELD(apa102)   #還款異動碼
               CALL cl_init_qry_var()
               LET g_qryparam.form ="q_nmc"
               IF g_aptype='13' THEN
                  LET g_qryparam.where =" nmc03=1"
               END IF
               LET g_qryparam.default1 = g_apa.apa102
               CALL cl_create_qry() RETURNING g_apa.apa102
               DISPLAY BY NAME g_apa.apa102
            OTHERWISE EXIT CASE
         END CASE
 
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
   END INPUT
   IF INT_FLAG THEN
      LET INT_FLAG = 0
      LET g_success = 'N'
      RETURN
   ELSE
      UPDATE apa_file SET apa101 = g_apa.apa101,
                          apa102 = g_apa.apa102
                    WHERE apa01 = g_apa.apa01
      IF SQLCA.sqlcode THEN
         CALL cl_err3("upd","apa_file", g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)
         LET g_success = 'N'
         RETURN
      END IF
   END IF
END FUNCTION
 
FUNCTION t110_pay_record_1()
   DEFINE i,j      LIKE type_file.num5  
   DEFINE l_amtf   LIKE apx_file.apx04f
   DEFINE l_amt    LIKE apx_file.apx04
   DEFINE tmp_prog LIKE type_file.chr1000
   DEFINE l_ape    RECORD
          no       LIKE apx_file.apx01,
          sq       LIKE type_file.num5,  
          amtf     LIKE apx_file.apx04f,
          amt      LIKE apx_file.apx04f,
          nmd02    LIKE nmd_file.nmd02,  #FUN-660117
          nmd05    LIKE type_file.dat,   
          nmd04    LIKE nmd_file.nmd04 ,  #FUN-4B0079
          apf02    LIKE type_file.dat      #add by wangyuz 170822 
               END RECORD
   DEFINE l_msg    LIKE ze_file.ze03   #MOD-7C0020
 
   CALL g_ape.clear()
   IF g_apa.apa01 IS NULL THEN
      CALL cl_err('apa01 null',-400,0)
      RETURN
   END IF
 
   OPEN WINDOW t110_pay_record_w WITH FORM "aap/42f/aapt110_4"
      ATTRIBUTE(STYLE = g_win_style)
 
   CALL cl_ui_locale('aapt110_4')
   
   CALL cl_getmsg('aap-820',g_lang) RETURNING l_msg
   CALL cl_chg_win_title(l_msg)  
   CALL cl_getmsg('aap-821',g_lang) RETURNING l_msg
   CALL cl_set_comp_att_text("amtf",l_msg CLIPPED)   
   CALL cl_getmsg('aap-822',g_lang) RETURNING l_msg
   CALL cl_set_comp_att_text("amt",l_msg CLIPPED)   
   CALL cl_getmsg('aap-823',g_lang) RETURNING l_msg
   CALL cl_set_comp_lab_text("group01",l_msg CLIPPED)   
   CALL cl_getmsg('aap-824',g_lang) RETURNING l_msg
   CALL cl_set_comp_lab_text("group02",l_msg CLIPPED)   
 
   LET l_amtf = 0 LET l_amt  = 0
   LET i = 1
#  IF g_aptype MATCHES '1*' THEN    #No.MOD-A80123
      DECLARE t110_pay_c12 CURSOR FOR
       SELECT apx03,apx02,apx04f,apx04,'','',''
         FROM apx_file
        WHERE apx01 = g_apa.apa01
#No.MOD-A80123 --begin
       UNION
       SELECT apx03,apx02,apx04f,apx04,'','',''
        FROM apx_file,apv_file
       WHERE apx01 IN (SELECT apv01 FROM apv_file WHERE apv03 = g_apa.apa01)
#No.MOD-A80123 --end        
      
 
      FOREACH t110_pay_c12 INTO g_ape[i].*
         LET l_amtf = l_amtf + g_ape[i].amtf
         LET l_amt  = l_amt  + g_ape[i].amt
         LET i = i + 1
         IF i > g_max_rec THEN    #No.MOD-480131
            EXIT FOREACH
         END IF
      END FOREACH
#  END IF    #No.MOD-A80123
 
   LET g_rec_b = i - 1
   DISPLAY l_amtf TO FORMONLY.totf
   DISPLAY l_amt  TO FORMONLY.tot
   DISPLAY ARRAY g_ape TO s_ape.* ATTRIBUTE(COUNT=g_rec_b)
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE DISPLAY
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
 
   END DISPLAY
   IF INT_FLAG THEN
      LET INT_FLAG = 0
   END IF
 
   CLOSE WINDOW t110_pay_record_w
END FUNCTION
 
#產生銀行異動記錄檔
FUNCTION t110_ins_nme_1()
   DEFINE l_nme   RECORD LIKE nme_file.*
   DEFINE l_legal  LIKE azw_file.azw02  #FUN-980001 add
   DEFINE l_nma21  LIKE nma_file.nma21  #MOD-B80144

#FUN-B30166--add--str
   DEFINE l_year     LIKE type_file.chr4
   DEFINE l_month    LIKE type_file.chr4
   DEFINE l_day      LIKE type_file.chr4
   DEFINE l_dt       LIKE type_file.chr20
   DEFINE l_date1    LIKE type_file.chr20
   DEFINE l_time     LIKE type_file.chr20
   DEFINE l_nme27    LIKE nme_file.nme27
#FUN-B30166--add--end
 
   IF g_apz.apz04 = 'N' THEN
      RETURN
   END IF
 
   DISPLAY "ins_nme now...."
   IF g_success = 'N' THEN RETURN END IF
   LET l_nme.nme00 = 0
   LET l_nme.nme01 = g_apa.apa101
   LET l_nme.nme02 = g_apa.apa02
   LET l_nme.nme03 = g_apa.apa102
   LET l_nme.nme07 = g_apa.apa14
   LET l_nme.nme10 = g_apa.apa44
   LET l_nme.nme12 = g_apa.apa01
   LET l_nme.nme13 = g_apa.apa07
   SELECT nmc05 INTO l_nme.nme14
     FROM nmc_file
    WHERE nmc01 = l_nme.nme03
   LET l_nme.nme15 = g_apa.apa22
   LET l_nme.nme16 = g_apa.apa02
   LET l_nme.nme17 = g_apa.apa01
   LET l_nme.nmeacti = 'Y'
   LET l_nme.nmeuser = g_user
   LET l_nme.nmegrup = g_grup
   LET l_nme.nmedate = g_today
   LET l_nme.nme21='0'            #MOD-740500
   LET l_nme.nme22='02'
   LET l_nme.nme24='9'
   LET l_nme.nme25 = g_apa.apa06
   LET l_nme.nme26 = 'N'   #FUN-870037 add
   LET l_nme.nmeoriu = g_user    #TQC-A10060 add
   LET l_nme.nmeorig = g_grup    #TQC-A10060 add
   SELECT SUM(apx04f),SUM(apx04)
     INTO l_nme.nme04,l_nme.nme08
     FROM apx_file
    WHERE apx01 = g_apa.apa01
   IF cl_null(l_nme.nme04) THEN LET l_nme.nme04 = 0 END IF
   IF cl_null(l_nme.nme08) THEN LET l_nme.nme08 = 0 END IF
 
#FUN-B30166--add--str
   LET l_date1 = g_today
   LET l_year = YEAR(l_date1)USING '&&&&'
   LET l_month = MONTH(l_date1) USING '&&'
   LET l_day = DAY(l_date1) USING  '&&'
   LET l_time = TIME(CURRENT)
   LET l_dt   = l_year CLIPPED,l_month CLIPPED,l_day CLIPPED,
                l_time[1,2],l_time[4,5],l_time[7,8]
   SELECT MAX(nme27) + 1 INTO l_nme.nme27 FROM nme_file
    WHERE nme27[1,14] = l_dt
   IF cl_null(l_nme.nme27) THEN
      LET l_nme.nme27 = l_dt,'000001'
   END if
#FUN-B30166--add--end

   #MOD-B80144--add--str--
   LET l_nma21 = NULL
   SELECT nma21 INTO l_nma21 FROM nma_file WHERE nma01 = l_nme.nme01
   IF l_nma21 IS NOT NULL AND l_nma21 >= l_nme.nme16 THEN
      CALL cl_err(l_nme.nme16,'anm-225',1)   
      LET g_success='N'
      RETURN
   END IF
   #MOD-B80144--add--end--

   CALL s_getlegal(g_plant_new) RETURNING l_legal #FUN-980001 add
   IF l_nme.nme21='0' THEN
       #LET g_sql="INSERT INTO ",g_dbs_nm,"nme_file ",
       LET g_sql="INSERT INTO ",cl_get_target_table(g_plant_nm,'nme_file'), #FUN-A50102
                 "      (nme00,nme01,nme02,nme03, ",
                 "       nme04,nme07,nme08,nme10, ",
                 "       nme11,nme12,nme13,nme14, ",   #No:9615 add nme14
                 "       nme15,nme16,nme17,nmeacti,nmeoriu,nmeorig, ",   #TQC-A10060  add nmeoriu,nmeorig
                 "       nmeuser,nmegrup,nmedate,nme21,nme22,nme23,nme24,nme25,nme26,nme27,nmelegal)", #No.FUN-730032 #FUN-980001 add nmelegal  #FUN-B30166  add nme27
                 "VALUES('",l_nme.nme00,"','",l_nme.nme01,"','",l_nme.nme02,"','",l_nme.nme03,"', ",
                 "       '",l_nme.nme04,"','",l_nme.nme07,"','",l_nme.nme08,"','",l_nme.nme10,"', ",
                 "       '",l_nme.nme11,"','",l_nme.nme12,"','",l_nme.nme13,"','",l_nme.nme14,"', ",
                 "       '",l_nme.nme15,"','",l_nme.nme16,"','",l_nme.nme17,"','",l_nme.nmeacti,"', ",
                 "       '",l_nme.nmeoriu,"','",l_nme.nmeorig,"','",l_nme.nmeuser,"','",l_nme.nmegrup,"','",l_nme.nmedate,"', ",   #TQC-A10060  add nmeoriu,nmeorig
                #"       '0','",l_nme.nme22,"','",l_nme.nme23,"','",l_nme.nme24,"','",l_nme.nme25,"','",l_nme.nme26,"','",l_legal,"') " #FUN-980001 add l_legal   #FUN-B30166  Mark
                #"       '0','",l_nme.nme22,"','",l_nme.nme23,"','",l_nme.nme24,"','",l_nme.nme25,"','",l_nme.nme26,"','","'",l_nme.nme27,"','",l_legal,"') " #FUN-980001 add l_legal   #FUN-B30166  add l_nme.nme27  #TQC-B60238   Mark
                 "       '0','",l_nme.nme22,"','",l_nme.nme23,"','",l_nme.nme24,"','",l_nme.nme25,"','",l_nme.nme26,"','",l_nme.nme27,"','",l_legal,"') "  #TQC-B60238   Add
 	 CALL cl_replace_sqldb(g_sql) RETURNING g_sql        #FUN-920032
     CALL cl_parse_qry_sql(g_sql,g_plant_nm) RETURNING g_sql #FUN-A50102
       PREPARE t110_y_nme_p2 FROM g_sql
       IF STATUS THEN
          CALL cl_err('ins nme:',STATUS,1)   
          LET g_success='N'
          RETURN
       END IF
       
       EXECUTE t110_y_nme_p2
       DISPLAY "status",STATUS
       IF STATUS THEN
          CALL cl_err('ins nme:',STATUS,1)
          LET g_success='N'
       END IF
       
       DISPLAY "SQLCA.sqlerrd[3]=",SQLCA.SQLERRD[3]
       IF SQLCA.SQLERRD[3]=0 THEN
          CALL cl_err('ins nme: ',SQLCA.SQLCODE,1)
          LET g_success='N'
          RETURN
       END IF
       CALL s_flows_nme(l_nme.*,'1',g_plant_nm)   #No.FUN-B90062   
   END IF 
END FUNCTION
 
#刪除還款銀行異動記錄檔
FUNCTION t110_del_nme_1()
   DEFINE l_n     LIKE type_file.num5  
   DEFINE l_nme24      LIKE nme_file.nme24    #No.FUN-730032
   DEFINE l_aza73      LIKE aza_file.aza73    #No.MOD-740346
   #MOD-B80144--add--str--
   DEFINE l_nma21      LIKE nma_file.nma21 
   DEFINE l_nme01      LIKE nme_file.nme01 
   DEFINE l_nme16      LIKE nme_file.nme16 
   #MOD-B80144--add--end--

   IF g_apz.apz04 = 'N' THEN
      RETURN
   END IF

   #MOD-B80144--add--str--
   DECLARE del_nme16_1 CURSOR FOR
    SELECT nme01,nme16 FROM nme_file
     WHERE nme12 = m_apa.apa01
   FOREACH del_nme16_1 INTO l_nme01,l_nme16
      LET l_nma21 = NULL
      SELECT nma21 INTO l_nma21 FROM nma_file WHERE nma01 = l_nme01
      IF l_nma21 IS NOT NULL AND l_nma21 >= l_nme16 THEN
         CALL cl_err(l_nme16,'anm-225',1)   
         LET g_success='N'
         RETURN
      END IF
   END FOREACH
   #MOD-B80144--add--end--
 
   LET g_success = 'Y' 
 
   #LET g_sql="SELECT aza73 FROM ",g_dbs_nm CLIPPED,"aza_file"
   LET g_sql="SELECT aza73 FROM ",cl_get_target_table(g_plant_nm,'aza_file') #FUN-A50102
 	 CALL cl_replace_sqldb(g_sql) RETURNING g_sql        #FUN-920032
     CALL cl_parse_qry_sql(g_sql,g_plant_nm) RETURNING g_sql #FUN-A50102
   PREPARE t741_aza_p2 FROM g_sql
   DECLARE t741_aza_c2 CURSOR FOR t741_aza_p2
   OPEN t741_aza_c2
   FETCH t741_aza_c2 INTO l_aza73
   IF l_aza73 = 'Y' THEN
      #LET g_sql="SELECT nme24 FROM ",g_dbs_nm CLIPPED,"nme_file",
      LET g_sql="SELECT nme24 FROM ",cl_get_target_table(g_plant_nm,'nme_file'), #FUN-A50102
                " WHERE nme12='",m_apa.apa01,"'",        #MOD-B50242 mod nme17 -> nme12
                "   AND nme22 = '02' "                   #MOD-B50242 
      CALL cl_replace_sqldb(g_sql) RETURNING g_sql        #FUN-920032
      CALL cl_parse_qry_sql(g_sql,g_plant_nm) RETURNING g_sql #FUN-A50102
      PREPARE t110_z_nme_p2 FROM g_sql
      FOREACH t110_z_nme_p2 INTO l_nme24
         IF l_nme24 <> '9' THEN
            CALL cl_err('','anm-043',1)
            LET g_success='N'
            RETURN
         END IF
      END FOREACH
   END IF #No.MOD-740346
   #TQC-B70209  --begin
   LET g_sql="DELETE FROM ",cl_get_target_table(g_plant_nm,'tic_file'),
             " WHERE tic04 in (",
            " SELECT nme12 FROM ",cl_get_target_table(g_plant_nm,'nme_file'),
             " WHERE nme12='",m_apa.apa01,"'",
             "   AND nme22 = '02')"
   CALL cl_replace_sqldb(g_sql) RETURNING g_sql       
   CALL cl_parse_qry_sql(g_sql,g_plant_nm) RETURNING g_sql 
   PREPARE t110_z_tic_p3 FROM g_sql
 
   EXECUTE t110_z_tic_p3
 
   IF STATUS THEN
      CALL cl_err('del nme:',STATUS,1)
      LET g_success='N'
      RETURN
   END IF
   #TQC-B70209  --end
   
   #LET g_sql =" DELETE FROM ",g_dbs_nm,"nme_file ",
   LET g_sql =" DELETE FROM ",cl_get_target_table(g_plant_nm,'nme_file'), #FUN-A50102
              "  WHERE nme12 = '",m_apa.apa01,"' ",     #MOD-B50242 mod nme17 -> nme12
              "    AND nme22 = '02' "                   #MOD-B50242 
   CALL cl_replace_sqldb(g_sql) RETURNING g_sql        #FUN-920032
   CALL cl_parse_qry_sql(g_sql,g_plant_nm) RETURNING g_sql #FUN-A50102
   PREPARE t110_z_nme_p3 FROM g_sql
 
   EXECUTE t110_z_nme_p3
 
   IF STATUS THEN
      CALL cl_err('del nme:',STATUS,1)
      LET g_success='N'
      RETURN
   END IF
 
   IF SQLCA.SQLERRD[3]=0 THEN
      CALL cl_err('no nme deleted:','aap-161',1)
      LET g_success='N'
      RETURN
   END IF
  #TQC-B70209  --begin mark
   #FUN-B40056 --begin
  # LET g_sql="DELETE FROM ",cl_get_target_table(g_plant_nm,'tic_file'),
  #           " WHERE tic04 in (",
  #          " SELECT nme12 FROM ",cl_get_target_table(g_plant_nm,'nme_file'),
  #           " WHERE nme12='",m_apa.apa01,"'",
  #           "   AND nme22 = '02')"
  # CALL cl_replace_sqldb(g_sql) RETURNING g_sql       
  # CALL cl_parse_qry_sql(g_sql,g_plant_nm) RETURNING g_sql 
  # PREPARE t110_z_tic_p3 FROM g_sql
 
  # EXECUTE t110_z_tic_p3
 
  # IF STATUS THEN
  #    CALL cl_err('del nme:',STATUS,1)
  #    LET g_success='N'
  #    RETURN
  # END IF
   #FUN-B40056 --end
  #TQC-B70209  --end mark
END FUNCTION
 
FUNCTION t110_k_2()
   DEFINE l_totf,l_amtf LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_tot,l_amt   LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)  #FUN-4B0079
   DEFINE l_apv04       LIKE apv_file.apv04      #FUN-4B0079
   DEFINE cnt1,cnt2     LIKE type_file.num5      # No.FUN-690028 SMALLINT
   DEFINE i,j,k         LIKE type_file.num5      #No.FUN-690028 SMALLINT
   DEFINE l_sql         STRING    #MOD-720062
   DEFINE p_cmd         LIKE type_file.chr1      #No.FUN-690028 VARCHAR(1)
   DEFINE g_apv DYNAMIC ARRAY OF RECORD
                apv02   LIKE apv_file.apv02,
                apv03   LIKE apv_file.apv03,
                apa07   LIKE apa_file.apa07,
                apv05   LIKE apv_file.apv05,         #No.FUN-680027
                apa08   LIKE apa_file.apa08,
                apa14   LIKE apa_file.apa14,
                apc08   LIKE apc_file.apc08,
                apc09   LIKE apc_file.apc09,
                un_payf LIKE apv_file.apv04,
                un_pay  LIKE apv_file.apv04,
                apv04f  LIKE apv_file.apv04,
                apv04   LIKE apv_file.apv04,
                apx04f  LIKE apx_file.apx04f,
                apx04   LIKE apx_file.apx04
            END RECORD
   DEFINE g_apv_t   RECORD
                apv02   LIKE apv_file.apv02,
                apv03   LIKE apv_file.apv03,
                apa07   LIKE apa_file.apa07,
                apv05   LIKE apv_file.apv05,         #No.FUN-680027
                apa08   LIKE apa_file.apa08,
                apa14   LIKE apa_file.apa14,
                apc08   LIKE apc_file.apc08,
                apc09   LIKE apc_file.apc09,
                un_payf LIKE apv_file.apv04,
                un_pay  LIKE apv_file.apv04,
                apv04f  LIKE apv_file.apv04,
                apv04   LIKE apv_file.apv04,
                apx04f  LIKE apx_file.apx04f,
                apx04   LIKE apx_file.apx04
                END RECORD
   DEFINE m_apa     DYNAMIC ARRAY OF RECORD
                    apa13     LIKE apa_file.apa13,
                    apa72     LIKE apa_file.apa72,
                    apa73     LIKE apa_file.apa73
                    END RECORD
   DEFINE m_apa_t   RECORD
                    apa13     LIKE apa_file.apa13,
                    apa72     LIKE apa_file.apa72,
                    apa73     LIKE apa_file.apa73
                    END RECORD
   DEFINE m_apa34f  LIKE apa_file.apa34f
   DEFINE m_apa34   LIKE apa_file.apa34    #No.MOD-590312
   DEFINE m_apa73   LIKE apa_file.apa73
   DEFINE m_amt     LIKE type_file.num20_6   # No.FUN-690028 DEC(20,6)
   DEFINE l_apa     RECORD LIKE apa_file.*
   DEFINE l_net     LIKE apv_file.apv04
   DEFINE l_apa14   LIKE apa_file.apa14
   DEFINE l_apv02   LIKE apv_file.apv02
   DEFINE l_i       LIKE type_file.num5    #No.FUN-690028 SMALLINT
   DEFINE l_apa13   LIKE apa_file.apa13
   DEFINE l_apa41   LIKE apa_file.apa41
   DEFINE l_apv04f  LIKE apv_file.apv04f
   DEFINE l_apa35f,l_apa35 LIKE apa_file.apa35
   DEFINE l_difff,l_diff   LIKE apa_file.apa34
   DEFINE l_sumf,l_sum     LIKE apa_file.apa34
   DEFINE l_sumf_h,l_sum_h LIKE apa_file.apa34
   DEFINE l_sum_apx04f    LIKE apx_file.apx04f
   DEFINE l_sum_apx04     LIKE apx_file.apx04 
   DEFINE l_total   LIKE apa_file.apa34
   DEFINE l_lock_sw       LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_modify_flag   LIKE type_file.chr1    #No.FUN-690028 VARCHAR(1)
   DEFINE l_k,l_over      LIKE type_file.num5,   # No.FUN-690028 SMALLINT,
   l_allow_insert  LIKE type_file.num5,                #可新增否  #No.FUN-690028 SMALLINT
   l_allow_delete  LIKE type_file.num5                 #可刪除否  #No.FUN-690028 SMALLINT
   DEFINE ls_rec_b        LIKE type_file.num10     # No.FUN-690028 INTEGER
    DEFINE l_apa06  LIKE apa_file.apa06   #MOD-580079
   DEFINE l_apc     RECORD LIKE apc_file.*   #No.FUN-680027
   DEFINE m_apc13   LIKE apc_file.apc13    #No.FUN-680027
   DEFINE l_apa65  LIKE apa_file.apa65  
   DEFINE l_apa65f LIKE apa_file.apa65f 
   DEFINE l_apc02  LIKE apc_file.apc02  
   DEFINE l_apc14  LIKE apc_file.apc14  
   DEFINE l_apc15  LIKE apc_file.apc15  
   DEFINE l_pmb02  LIKE pmb_file.pmb02  #TQC-770027
 
    SELECT * INTO g_apa.* FROM apa_file
     WHERE apa01=g_apa.apa01
 
   IF g_apa.apa00[1,1] = '2' THEN
      RETURN
   END IF
   IF g_apa.apa41 = 'Y' THEN
      CALL cl_err(g_apa.apa01,'aap-005',0)
      RETURN
   END IF
   IF g_apa.apa63 MATCHES '[Ss1]' THEN      #FUN-540045 #FUN-550042
      CALL cl_err('','mfg3557',0)
      RETURN
   END IF
 
   LET g_success='Y'
   LET g_apa_t.* = g_apa.*
   BEGIN WORK
   CALL t110_lock_cl()  #FUN-C80078 add
   OPEN t110_cl USING g_apa.apa01
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl k:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF
   FETCH t110_cl INTO g_apa.*            # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
       CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
       CLOSE t110_cl
       ROLLBACK WORK
       RETURN
   END IF
 
   OPEN WINDOW t110_kkk_w2 AT 12,2 WITH FORM "aap/42f/aapt110_m"
         ATTRIBUTE (STYLE = g_win_style CLIPPED) #No.FUN-580092 HCN
 
    CALL cl_ui_locale("aapt110_m")
 
   SELECT azi04 INTO t_azi04 FROM azi_file
      WHERE azi01 = g_apa.apa13
 
   SELECT COUNT(*) INTO cnt1 FROM apv_file WHERE apv01 = g_apa.apa01
 
   IF cnt1 = 0 THEN
      DECLARE t110_kkk2_c0 CURSOR FOR
 
        SELECT apc01,apa07,apa08,apc06,apc02,
                  apc08,(apc08-apc10),0,
                  apc09,(apc09-apc11),0,0,0,apa13,apa07,apc13  #No.MOD-580365
             FROM apa_file,apc_file 
          WHERE apa06 = g_apa.apa06
            AND apa07 = g_apa.apa07
            AND apa00 ='25' 
            AND apa13 = g_apa.apa13          # 幣別必須相同
            AND apa08 != g_apa.apa01         # 不可沖自已產生的預付
            AND apa41 = 'Y' AND apa42 != 'Y' 
            AND (apa58 = '2' OR apa58 ='3' OR apa58 IS NULL)
            AND apa34 > apa35 
            AND apa01 =apc01
           #AND apa02 < g_apa.apa02                              #MOD-BB0056 add #MOD-C60195 mark
            AND apa02 <= g_apa.apa02                             #MOD-C60195 add
      CALL g_apv.clear()
      LET i = 1
 
      FOREACH t110_kkk2_c0 INTO g_apv[i].apv03,g_apv[i].apa07,g_apv[i].apa08,    #No.FUN-680027 #No.FUN-690080
                               g_apv[i].apa14,g_apv[i].apv05,g_apv[i].apc08,    #No.FUN-680027 #No.FUN-690080
                               g_apv[i].un_payf,g_apv[i].apv04f, #No.FUN-690080
                               g_apv[i].apc09,g_apv[i].un_pay,g_apv[i].apv04,   #No.FUN-680027
                               g_apv[i].apx04f,g_apv[i].apx04,
                               m_apa[i].apa13,m_apa[i].apa72,m_apa[i].apa73
 
         IF g_apz.apz27 = 'Y' AND m_apa[i].apa13 !=g_aza.aza17 THEN
             LET g_apv[i].un_pay = m_apa[i].apa73
             LET g_apv[i].apa14  = m_apa[i].apa72
         END IF
         IF cl_null(g_apv[i].apv03) THEN
            EXIT FOREACH
         END IF
         IF g_apa.apa00='11' THEN
            DROP TABLE x
 
            SELECT apa08 INTO g_msg FROM apa_file WHERE apa01=g_apv[i].apv03
 
            SELECT apb06 po_no FROM apb_file,apa_file
             WHERE apa01=g_msg AND apa01=apb01 AND apa41='Y' AND apa42!='Y'
              INTO TEMP x
 
            SELECT COUNT(*) INTO g_cnt FROM x     # 如果原預付有指定 P/O No
 
            IF g_cnt > 0 THEN
               SELECT MAX(po_no) INTO g_msg FROM x
               SELECT COUNT(*) INTO g_cnt FROM apb_file, x
                WHERE apb01=g_apa.apa01 AND apb06=po_no
               IF g_cnt=0 THEN
                  INITIALIZE g_apv[i].* TO NULL CONTINUE FOREACH
               END IF
            END IF
         END IF
 
         LET g_apv[i].apv02 = i
 
         INSERT INTO apv_file(apv01,apv02,apv03,apv04f,apv04,apv05,apvlegal)     #No.FUN-680027 #FUN-980001 add apvlegal
           VALUES (g_apa.apa01,i,g_apv[i].apv03,0,0,g_apv[i].apv05,g_legal)     #No.FUN-680027 #FUN-980001 add g_legal
 
         LET i = i + 1
          IF i > g_max_rec THEN     #No.MOD-480131
            EXIT FOREACH
         END IF
      END FOREACH
      CALL g_apv.deleteElement(i)
      LET ls_rec_b = i - 1
   END IF
 
   IF cnt1 > 0 THEN
      DECLARE t110_kkk2_c CURSOR FOR
         SELECT apv02,apv03,apa07,apc02,apa08,apc06,
            apc08,apc09,(apc08-apc10),(apc09-apc11),apv04f,apv04,0,0, #MOD-4A0288
            apa13,apc07,apc13  #No.MOD-580365
           FROM apv_file,OUTER apc_file,OUTER apa_file
          WHERE apv01 = g_apa.apa01 AND apv_file.apv03 = apa_file.apa01
            AND  apc_file.apc01 =apv_file.apv03
            AND  apc_file.apc01 =apa_file.apa01
            AND  apc_file.apc02 =apv_file.apv05
          ORDER BY apv02
 
      CALL g_apv.clear()
      LET k = 1
 
      FOREACH t110_kkk2_c INTO g_apv[k].*,m_apa[k].* #No.MOD-580365
         LET k = k + 1
         IF k > g_max_rec THEN         #No.MOD-480131
            EXIT FOREACH
         END IF
      END FOREACH
      CALL g_apv.deleteElement(k)
     #重新計算沖帳視窗中的匯差
      LET l_net = 0
      FOR l_i = 1 TO g_apv.getLength()
          IF cl_null(g_apv[l_i].apv03) THEN CONTINUE FOR END IF
          IF g_apv[l_i].apv03 = 'DIFF' THEN CONTINUE FOR END IF
          SELECT apa14 INTO l_apa14 FROM apa_file
           WHERE apa01=g_apv[l_i].apv03
          IF l_apa14 <> g_apv[l_i].apa14 THEN
             LET l_amt=cl_digcut(g_apv[l_i].apv04f*g_apa.apa14,g_azi04)
                      -g_apv[l_i].apv04
             IF cl_null(l_amt) THEN LET l_amt=0 END IF
             LET l_net = l_net + l_amt
             LET l_net = cl_digcut(l_net,g_azi04)
          ELSE
             IF g_apv[l_i].apa14 <> g_apa.apa14 THEN
                LET l_amt=cl_digcut(g_apv[l_i].apv04f*g_apa.apa14,g_azi04)
                         -g_apv[l_i].apv04
                IF cl_null(l_amt) THEN LET l_amt=0 END IF
                LET l_net = l_net + l_amt
                LET l_net = cl_digcut(l_net,g_azi04)
             END IF
          END IF
      END FOR
      DELETE FROM apv_file WHERE apv01=g_apa.apa01 AND apv03='DIFF'
      IF SQLCA.sqlcode THEN
         CALL cl_err3("del","apv_file", g_apa.apa01,"",SQLCA.sqlcode,"","delete diff",1)
      END IF
      IF l_net <> 0 THEN
         SELECT MAX(apv02)+1 INTO l_apv02 FROM apv_file
          WHERE apv01 = g_apa.apa01
         IF cl_null(l_apv02)  THEN
            LET l_apv02 = 1
         END IF
         INSERT INTO apv_file (apv01,apv02,apv03,apv04f,apv04,apvlegal) #FUN-980001 add apvlegal
                       VALUES (g_apa.apa01,l_apv02,'DIFF',0,l_net,g_legal) #FUN-980001 add g_legal
         IF SQLCA.sqlcode THEN
            CALL cl_err3("ins","apv_file",g_apa.apa01,l_apv02,SQLCA.sqlcode,"","insert diff",1)
         END IF
      END IF
 
      DECLARE t110_kkk2_c1 CURSOR FOR
         SELECT apv02,apv03,apa07,apc02,apa08,apc06,
                apc08,apc09,(apc08-apc10),(apc09-apc11),apv04f,apv04,0,0,
                apa13,apc07,apc13
           FROM apv_file,OUTER apc_file,OUTER apa_file
          WHERE apv01 = g_apa.apa01 AND apv_file.apv03 = apa_file.apa01
            AND apc_file.apc01 =apv_file.apv03
            AND apc_file.apc02 =apv_file.apv05
          ORDER BY apv02
 
      CALL g_apv.clear()
      LET k = 1
      LET g_apa.apa65f = 0
      LET g_apa.apa65 = 0
 
      FOREACH t110_kkk2_c1 INTO g_apv[k].*,m_apa[k].*
         SELECT apx04f,apx04 INTO g_apv[k].apx04f,g_apv[k].apx04
           FROM apx_file
          WHERE apx01 = g_apa.apa01
            AND apx02 = g_apv[k].apv02
            AND apx03 = g_apv[k].apv03
         LET g_apa.apa65f = g_apa.apa65f + g_apv[k].apv04f
         LET g_apa.apa65  = g_apa.apa65  + g_apv[k].apv04
         LET k = k + 1
         IF k > g_max_rec THEN
            EXIT FOREACH
         END IF
      END FOREACH
      CALL g_apv.deleteElement(k)
      LET ls_rec_b = k - 1
   END IF
 
   LET l_sumf_h = g_apa.apa65f
   LET l_sum_h  = g_apa.apa65
 
   DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
 
   LET l_allow_insert = cl_detail_input_auth("insert")
   LET l_allow_delete = cl_detail_input_auth("delete")
 
   LET i = 1
   INPUT ARRAY g_apv WITHOUT DEFAULTS FROM s_apv.*
         ATTRIBUTE(COUNT=ls_rec_b,MAXCOUNT=g_max_rec,UNBUFFERED,
                   INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)
 
      BEFORE INSERT
         LET i = ARR_CURR()
         LET p_cmd='a'
         INITIALIZE g_apv[i].* TO NULL
         LET g_apv_t.* = g_apv[i].*
         NEXT FIELD apv02
 
      AFTER INSERT
         IF INT_FLAG THEN
            CALL cl_err('',9001,0)
            LET INT_FLAG = 0
            CANCEL INSERT
         END IF
         IF g_apv[i].apv03 IS NULL THEN
            CALL g_apv.deleteElement(i)
            NEXT FIELD apv02
            CANCEL INSERT
         END IF
         IF g_apv[i].apx04f > 0 OR g_apv[i].apx04 >0 THEN
            INSERT INTO apx_file(apx01,apx02,apx03,apx04f,apx04,apxlegal)      #No.FUN-680027 #FUN-980001 add apxlegal
             VALUES(g_apa.apa01,g_apv[i].apv02,g_apv[i].apv03,
                    g_apv[i].apx04f,g_apv[i].apx04,g_legal)          #No.FUN-680027 #FUN-980001 add g_legal
             SELECT SUM(apx04f),SUM(apx04) INTO g_apa.apa37f,g_apa.apa37
               FROM apx_file WHERE apx01=g_apa.apa01
             IF cl_null(g_apa.apa37f) THEN LET g_apa.apa37f = 0 END IF
             IF cl_null(g_apa.apa37 ) THEN LET g_apa.apa37 = 0 END IF
             DISPLAY BY NAME g_apa.apa37f,g_apa.apa37
             UPDATE apa_file SET apa37f=g_apa.apa37f,apa37=g_apa.apa37
              WHERE apa01 = g_apa.apa01
             IF STATUS OR SQLCA.SQLCODE THEN
                CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                LET g_success='N'
             END IF
         END IF
         INSERT INTO apv_file(apv01,apv02,apv03,apv04f,apv04,apv05,apvlegal)      #No.FUN-680027 #FUN-980001 add apvlegal
          VALUES(g_apa.apa01,g_apv[i].apv02,g_apv[i].apv03,
                 g_apv[i].apv04f,g_apv[i].apv04,g_apv[i].apv05,g_legal)          #No.FUN-680027 #FUN-980001 add g_legal
         IF SQLCA.sqlcode THEN
            CALL cl_err3("ins","apv_file",g_apa.apa01,g_apv[i].apv02,SQLCA.sqlcode,"","ins apv:",1)  #No.FUN-660122
            LET g_success = 'N'
            CANCEL INSERT
         ELSE
            LET ls_rec_b = ls_rec_b + 1
            MESSAGE "insert ok"
            IF g_success = 'Y' THEN
               SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa65f,g_apa.apa65
                 FROM apv_file WHERE apv01=g_apa.apa01
 
               IF cl_null(g_apa.apa65f) THEN
                  LET g_apa.apa65f = 0
               END IF
 
               IF cl_null(g_apa.apa65 ) THEN
                  LET g_apa.apa65 = 0
               END IF
 
               DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
 
               UPDATE apa_file SET apa65f=g_apa.apa65f,apa65=g_apa.apa65
                WHERE apa01 = g_apa.apa01
               IF STATUS OR SQLCA.SQLCODE THEN
                  CALL cl_err3("upd","apa_file", g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                  LET g_success='N'
                  IF p_cmd = 'u' THEN
                     LET g_apv[i].*=g_apv_t.*
                  END IF
               END IF
 
               SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                 FROM aph_file,apf_file
                WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                  AND aph03 IN ('6','7','8','9')
 
               IF g_amt1f IS NULL THEN
                  LET g_amt1f = 0
                  LET g_amt1 = 0
               END IF
               #No.MOD-C30061  --Begin #增加退款沖帳金額
               SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
                 FROM apg_file,apf_file
                WHERE apg04=g_apv[i].apv03 AND apg01=apf01 AND apf41='Y'
                  #AND apf00='32'                  #MOD-D70039
                  AND (apf00='32' OR apf00='36')   #MOD-D70039
               IF g_amt6f IS NULL THEN
                  LET g_amt6f = 0
                  LET g_amt6 = 0
               END IF
               #No.MOD-C30061  --End
 
               SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                 FROM apv_file Where apv03=g_apv[i].apv03
 
               IF g_amt2f IS NULL THEN
                  LET g_amt2f = 0
                  LET g_amt2 = 0
               END IF
 
               SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                 FROM oob_file,ooa_file
                WHERE oob01 = ooa01
                  AND oob06 = g_apv[i].apv03
                  AND oob03 = '2' AND oob04 = '9'
                  AND ooaconf = 'Y' #須為已確認
 
               IF cl_null(g_amt3f) THEN
                  LET g_amt3f = 0
                  LET g_amt3 = 0
               END IF
 
               #成本分攤
               SELECT SUM(aqb04) INTO g_amt4 FROM aqa_file,aqb_file
                WHERE aqa01 = aqb01 AND aqa04='Y' AND aqaconf = 'Y'
                  AND aqb02=g_apv[i].apv03
               IF cl_null(g_amt4) THEN
                  LET g_amt4=0
                  LET g_amt4f=0
               END IF
               LET g_amt4f=g_amt4/g_apv[i].apa14
 
               LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f+g_amt6f     #MOD-C30061 add g_amt6f
               LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt4+g_amt6           #MOD-C30061 add g_amt6
               SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
               CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
               LET l_apa.apa73 = l_apa.apa34 - g_amt1 + g_net
 
               UPDATE apa_file SET apa35f= g_amt1f,
                                   apa35 = g_amt1,
                                   apa73 = l_apa.apa73  #No.MOD-640537
                WHERE apa01 = g_apv[i].apv03
 
               SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                 FROM aph_file,apf_file
                WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                  AND aph03 IN ('6','7','8','9')
                  AND aph17 = g_apv[i].apv05             #No.FUN-680027
 
               IF g_amt1f IS NULL THEN
                  LET g_amt1f = 0
                  LET g_amt1 = 0
               END IF
               #No.MOD-C30061  --Begin #增加退款沖帳金額
               SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
                 FROM apg_file,apf_file
                WHERE apg04=g_apv[i].apv03 AND apg01=apf01 AND apf41='Y'
                  #AND apf00='32'                  #MOD-D70039
                  AND (apf00='32' OR apf00='36')   #MOD-D70039

               IF g_amt6f IS NULL THEN
                  LET g_amt6f = 0
                  LET g_amt6 = 0
               END IF
               #No.MOD-C30061  --End
 
               SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                 FROM apv_file Where apv03=g_apv[i].apv03
                                 AND apv05=g_apv[i].apv05   #No.FUN-680027   #MOD-860272
 
               IF g_amt2f IS NULL THEN
                  LET g_amt2f = 0
                  LET g_amt2 = 0
               END IF
 
               SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                 FROM oob_file,ooa_file
                WHERE oob01 = ooa01
                  AND oob06 = g_apv[i].apv03
                  AND oob03 = '2' AND oob04 = '9'
                  AND ooaconf = 'Y' #須為已確認
                  AND oob19 = g_apv[i].apv05             #No.FUN-680027
 
               IF cl_null(g_amt3f) THEN
                  LET g_amt3f = 0
                  LET g_amt3 = 0
               END IF
 
               LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt6f+g_amt4f    #MOD-C30061 add g_amt6f     #TQC-C70079  add  g_amt4f
               LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt6+g_amt4          #MOD-C30061 add g_amt6      #TQC-C70079  add  g_amt4
               SELECT * INTO l_apc.* FROM apc_file WHERE apc01=g_apv[i].apv03 AND apc02 =g_apv[i].apv05
               CALL t110_comp_oox1(g_apv[i].apv03,g_apv[i].apv05) RETURNING g_net
               LET l_apc.apc13 = l_apc.apc09 - g_amt1 + g_net
               UPDATE apc_file set apc10=g_amt1f,
                                   apc11=g_amt1,
                                   apc13=l_apc.apc13
                WHERE apc01 =g_apv[i].apv03
                  AND apc02 =g_apv[i].apv05
            END IF
         END IF
 
      BEFORE INPUT
         IF ls_rec_b != 0 THEN
            CALL fgl_set_arr_curr(i)
         END IF
         LET g_before_input_done = FALSE
         CALL t110_set_entry_apv('a')
         CALL t110_set_no_entry_apv('a')
         LET g_before_input_done = TRUE
 
      BEFORE ROW
         LET p_cmd = ''
         LET i = ARR_CURR()
         LET l_lock_sw = 'N'
         IF ls_rec_b >= i THEN
            LET p_cmd='u'
            LET g_apv_t.* = g_apv[i].*
            #-->鎖住待抵沖帳資料
            IF g_apv_t.apv03 <> 'DIFF' THEN
               LET g_forupd_sql = "SELECT apa07,apc12,apc06,apc08,(apc08-apc10),",      #No.FUN-680027
                                  "       apc09,(apc09-apc11),apa13,apc07,apc13",      #No.FUN-680027
                                  "  FROM apa_file,apc_file ",       #No.FUN-680027
                                  " WHERE apa01 =apc01 ",           #No.FUN-680027
                                  "   AND apa01=? "                 #No.FUN-680027     #No.TQC-850001
               DECLARE t110_loc_cr2 CURSOR FROM g_forupd_sql
 
               OPEN t110_loc_cr2 USING g_apv_t.apv03
               IF STATUS THEN
                  CALL cl_err("OPEN t110_loc_cr2:", STATUS, 1)
                  LET l_lock_sw = "Y"
               END IF
 
               FETCH t110_loc_cr2 INTO g_apv[i].apa07,g_apv[i].apa08,g_apv[i].apa14,
                                      g_apv[i].apc08,g_apv[i].un_payf,      #No.FUN-680027
                                      g_apv[i].apc09,g_apv[i].un_pay,       #No.FUN-680027
                                      m_apa[i].*  #No.MOD-580365
               IF SQLCA.sqlcode THEN
                  CALL cl_err(g_apv_t.apv02,SQLCA.sqlcode,1)
                  LET l_lock_sw = "Y"
               END IF
               IF g_apz.apz27 = 'Y' AND g_aza.aza17 ! = m_apa[i].apa13 THEN
                  LET g_apv[i].un_pay = m_apa[i].apa73
                  LET g_apv[i].apa14  = m_apa[i].apa72
               END IF
            END IF
            CALL cl_show_fld_cont()     #FUN-550037(smin)
         END IF
 
      BEFORE FIELD apv02
         IF cl_null(g_apv[i].apv02) OR g_apv[i].apv02 = 0 THEN
            SELECT MAX(apv02)+1 INTO g_apv[i].apv02 FROM apv_file
             WHERE apv01 = g_apa.apa01
            IF cl_null(g_apv[i].apv02)  THEN
               LET g_apv[i].apv02 = 1
            END IF
            LET g_apv[i].apv04f= 0
            LET g_apv[i].apv04 = 0
         END IF
          CALL t110_set_entry_apv(p_cmd)  #MOD-4A0288
 
      AFTER FIELD apv02
         IF g_apv_t.apv02 IS NULL OR
            g_apv_t.apv02 != g_apv[i].apv02 THEN
            SELECT COUNT(*) INTO k FROM apv_file
                WHERE apv01 = g_apa.apa01 AND apv02 = g_apv[i].apv02
            IF k > 0 THEN
               CALL cl_err('',-239,0)
               NEXT FIELD apv02
            END IF
         END IF
          CALL t110_set_no_entry_apv(p_cmd)  #MOD-4A0288
 
 
      AFTER FIELD apv03
         IF NOT cl_null(g_apv[i].apv03) AND g_apv[i].apv03 <> 'DIFF' THEN
            CALL t110_set_entry_apv('F')
            SELECT apa06 INTO l_apa06 FROM apa_file
               WHERE apa01= g_apv[i].apv03
            IF g_apa.apa06 <> l_apa06 THEN
               CALL cl_err('','aap-098',1)
               NEXT FIELD apv03              #No.TQC-B50105
            END IF
           #str MOD-BB0056 add
            LET g_forupd_sql = "SELECT '','','',apc06,apc08,",
                               "       (apc08-apc10),apc09,(apc09-apc11),",
                               "       '','',apc07,apc13 FROM apc_file",
                               " WHERE apc01 = ? AND apc02 ='1' FOR UPDATE"
            LET g_forupd_sql = cl_forupd_sql(g_forupd_sql)
            DECLARE t110_loc1_cr CURSOR FROM g_forupd_sql

            OPEN t110_loc1_cr USING g_apv[i].apv03
            IF STATUS THEN
               CALL cl_err("OPEN t110_loc1_cr:", STATUS, 1)
               CLOSE t110_loc1_cr
               ROLLBACK WORK
               RETURN
            END IF

            FETCH t110_loc1_cr INTO g_apv[i].apa07,g_apv[i].apa08,l_apa13,
                                    g_apv[i].apa14,g_apv[i].apc08,l_amtf,
                                    g_apv[i].apc09,l_amt,l_apa41,
                                    m_apa[i].apa13,m_apa[i].apa72,m_apa[i].apa73 
            IF SQLCA.sqlcode THEN
               CALL cl_err(g_apv[i].apv03,SQLCA.sqlcode,0)
               LET g_apv[i].apv03 = g_apv_t.apv03
               CLOSE t110_loc2_cr
               NEXT FIELD apv03
            ELSE
               SELECT apa07,apa08,apa13,apa41,apa13 INTO g_apv[i].apa07,g_apv[i].apa08,l_apa13,l_apa41,m_apa[i].apa13
                 FROM apa_file
                WHERE apa01 = g_apv[i].apv03 AND apa00 = '25'
                  AND (apa58='2' OR apa58='3' OR apa58 IS NULL)
                  AND apa41 = 'Y' AND apa42 != 'Y'
                  AND apa02 <= g_apa.apa02                       
               IF SQLCA.sqlcode THEN
                  CALL cl_err(g_apv[i].apv03,'mfg9089',0)
                  NEXT FIELD apv03
               END IF
            END IF
           #end MOD-BB0056 add
         END IF
 
      AFTER FIELD apv04f
         IF NOT cl_null(g_apv[i].apv04f) THEN
            IF g_apv[i].apv04f < 0 THEN
               NEXT FIELD apv04f
            END IF
            LET l_apv04 = g_apv[i].apv04f * g_apv[i].apa14
            IF g_apv[i].apv03 <> 'DIFF' THEN
               LET g_apv[i].apv04 = l_apv04
            END IF
         END IF
         #原幣是否已經衝平，如果原幣已經衝平，則本幣也應衝平
         SELECT apa34f,apa73 INTO m_apa34f,m_apa73 FROM apa_file
         WHERE apa01 = g_apv[i].apv03
         SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
           FROM aph_file,apf_file
          WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
            AND aph03 IN ('6','7','8','9')
         IF g_amt1f IS NULL THEN
            LET g_amt1f = 0
            LET g_amt1 = 0
         END IF
        #No.MOD-C30061  --Begin #增加退款沖帳金額
        SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
          FROM apg_file,apf_file
         WHERE apg04=g_apv[i].apv03 AND apg01=apf01 AND apf41='Y'
           #AND apf00='32'                  #MOD-D70039
           AND (apf00='32' OR apf00='36')   #MOD-D70039
        IF g_amt6f IS NULL THEN
           LET g_amt6f = 0
           LET g_amt6 = 0
        END IF
        #No.MOD-C30061  --End
 
         SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
           FROM apv_file Where apv03=g_apv[i].apv03
         IF g_amt2f IS NULL THEN
            LET g_amt2f = 0
            LET g_amt2 = 0
         END IF
 
         SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
           FROM oob_file,ooa_file
          WHERE oob01 = ooa01
            AND oob06 = g_apv[i].apv03
            AND oob03 = '2' AND oob04 = '9'
            AND ooaconf = 'Y' #須為已確認
         IF cl_null(g_amt3f) THEN
            LET g_amt3f = 0
            LET g_amt3 = 0
         END IF
         LET m_amt=g_amt1f+g_amt2f+g_amt3f+g_amt6f  #MOD-C30061 add g_amt6f
         IF p_cmd = 'a' THEN
            LET m_amt=m_amt+g_apv[i].apv04f
         ELSE
            LET m_amt=m_amt+g_apv[i].apv04f-g_apv_t.apv04f
         END IF
         IF m_amt = m_apa34f THEN
            LET g_apv[i].apv04 = m_apa73
         END IF
         SELECT (apa34f-apa35f) INTO l_difff
           FROM apa_file WHERE apa01 = g_apv[i].apv03
 
         IF cl_null(g_apv_t.apv04f) THEN
            LET g_apv_t.apv04f = 0
         END IF
 
         LET l_total = l_difff + g_apv_t.apv04f
 
         IF  g_apv[i].apv04f > l_total THEN
            LET g_apv[i].apv04f = 0
            LET g_apv[i].apv04 = 0
            CALL cl_err(g_apa.apa01,'aap-194',0)
            NEXT FIELD apv04f
         END IF
         LET g_apv[i].apv04f = cl_digcut(g_apv[i].apv04f,t_azi04) #MOD-660095
         LET g_apv[i].apv04 = cl_digcut(g_apv[i].apv04,g_azi04) #MOD-660095
 
 
      AFTER FIELD apv04
         IF NOT cl_null(g_apv[i].apv04) THEN
            IF g_apv[i].apv04 < 0 AND g_apv[i].apv03 <> 'DIFF' THEN
               NEXT FIELD apv04
            END IF
 
            IF g_apv[i].apv03 != 'DIFF' THEN
            #-->check 沖帳金額是否超過
              #不用控制本幣了，
              #因為有可能本幣會超過請款的金額，超過部分要確認匯兌損溢
               LET l_sum = 0
               LET l_sumf = 0
               LET l_over = 0
                FOR l_k =1 TO g_apv.getLength()   #No.MOD-480131
                  IF cl_null(g_apv[l_k].apv03) THEN
                     EXIT FOR
                  END IF
                  LET l_sumf= l_sumf+ g_apv[l_k].apv04f
                  LET l_sum = l_sum + g_apv[l_k].apv04
               END FOR
 
               IF l_over=1 THEN
                  NEXT FIELD apv04f
               END IF
 
               SELECT (apa34f-apa35f),apa73 INTO l_difff,l_diff
                 FROM apa_file WHERE apa01 = g_apv[i].apv03
 
               IF cl_null(g_apv_t.apv04f) THEN
                  LET g_apv_t.apv04f = 0
                  LET g_apv_t.apv04 = 0
               END IF
 
               LET l_total = l_diff + g_apv_t.apv04
 
               IF  g_apv[i].apv04 > l_total THEN
                  LET g_apv[i].apv04f = 0
                  LET g_apv[i].apv04 = 0
                  CALL cl_err(g_apa.apa01,'aap-194',0)
                  LET l_over = 1
               END IF
 
               IF l_over=1 THEN
                  NEXT FIELD apv04f
               END IF
             END IF #No.MOD-580365
         END IF
         LET g_apv[i].apv04 = cl_digcut(g_apv[i].apv04,g_azi04) #MOD-660095
 
      AFTER FIELD apv05
          IF NOT cl_null(g_apv[i].apv05) THEN
           #MOD-A30008---modify---start---
           #LET g_forupd_sql = "SELECT apa07,apa08,apa13,apc06,apc08,",
           #                   "       (apc08-apc10),apc09,(apc09-apc11),",
           #                   "       apa41,apa13,apc07,apc13 FROM apa_file,apc_file",
           #                   " WHERE apa01 = ? AND apa00 = '25'",
           #                   "   AND (apa58='2' OR apa58='3' OR apa58 IS NULL)",
           #                   "   AND apc01=apa01 AND apc02 ='",g_apv[i].apv05,"'",
           #                   "   AND apa41 = 'Y' AND apa42 != 'Y' FOR UPDATE"
            LET g_forupd_sql = "SELECT '','','',apc06,apc08,",
                               "       (apc08-apc10),apc09,(apc09-apc11),",
                               "       '','',apc07,apc13 FROM apc_file",
                               " WHERE apc01 = ? ",
                               "   AND apc02 ='",g_apv[i].apv05,"' FOR UPDATE"
            LET g_forupd_sql = cl_forupd_sql(g_forupd_sql)
            DECLARE t110_loc22_cr CURSOR FROM g_forupd_sql
            #MOD-A30008---modify---end---
            OPEN t110_loc22_cr USING g_apv[i].apv03    #MOD-CB0175 還原
            #OPEN t110_loc22_cr USING g_apa.apa01      #TQC-C20027 Add
            IF STATUS THEN
               CALL cl_err("OPEN t110_loc2_cr:", STATUS, 1)
               CLOSE t110_loc22_cr
               ROLLBACK WORK
               RETURN
            END IF
 
            FETCH t110_loc22_cr INTO g_apv[i].apa07,g_apv[i].apa08,l_apa13,
                                    g_apv[i].apa14,g_apv[i].apc08,l_amtf,
                                    g_apv[i].apc09,l_amt,l_apa41,
                                    m_apa[i].apa13,m_apa[i].apa72,m_apa[i].apa73 #No.MOD-580365
            IF SQLCA.sqlcode THEN
               CALL cl_err(g_apv[i].apv05,SQLCA.sqlcode,0)
               LET g_apv[i].apv05 = g_apv_t.apv05
               CLOSE t110_loc22_cr
               NEXT FIELD apv05
           #MOD-A30008---add---start---
            ELSE
               SELECT apa07,apa08,apa13,apa41,apa13 INTO g_apv[i].apa07,g_apv[i].apa08,l_apa13,l_apa41,m_apa[i].apa13
                 FROM apa_file
                WHERE apa01 = g_apv[i].apv03 AND apa00 = '25'
                  AND (apa58='2' OR apa58='3' OR apa58 IS NULL)
                  AND apa41 = 'Y' AND apa42 != 'Y' 
                  AND apa02 <= g_apa.apa02                        #MOD-BB0056 add
           #MOD-A30008---add---end--- 
            END IF
            #-->此帳款尚未確認
            IF l_apa41 != 'Y' THEN
               CALL cl_err(g_apv[i].apv03,'aap-141',0)
               NEXT FIELD apv05
            END IF
 
            #-->不可沖不同幣別
            IF l_apa13 != g_apa.apa13 THEN
               CALL cl_err(g_apv[i].apv03,'aap-014',0)
               NEXT FIELD apv05
            END IF
 
            #-->無金額可沖帳
            IF l_amtf <=0 AND l_amt <=0 AND g_apa.apa41 <> 'N' THEN  #No.FUN-690080
               CALL cl_err(g_apv[i].apv03,'aap-203',0)
               NEXT FIELD apv05
            END IF
            LET g_apv[i].un_payf= l_amtf
            LET g_apv[i].un_pay = l_amt
            SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
            IF g_apz.apz27 = 'Y' AND g_aza.aza17 != m_apa[i].apa13 THEN
                LET g_apv[i].un_pay = m_apa[i].apa73
                LET g_apv[i].apa14  = m_apa[i].apa72
            END IF
         END IF
 
      AFTER FIELD apx04f
         IF NOT cl_null(g_apv[i].apx04f) THEN
            IF g_apv[i].apx04f < 0 THEN
               CALL cl_err('','mfg4012',0)
               NEXT FIELD apx04f
            END IF
            IF NOT cl_null(g_apv[i].apa14) THEN
               LET g_apv[i].apx04 = g_apv[i].apx04f * g_apv[i].apa14
            END IF
         END IF
 
      AFTER FIELD apx04
         IF NOT cl_null(g_apv[i].apx04) THEN
            IF g_apv[i].apx04 < 0 THEN
               CALL cl_err('','mfg4012',0)
               NEXT FIELD apx04
            END IF
         END IF
 
 
      ON ACTION CONTROLP
           CASE
              WHEN INFIELD(apv03)
                 #CALL q_apa2(FALSE,TRUE,' ','3',g_apa.apa06) RETURNING g_apv[i].apv03                   #TQC-750140   #MOD-820002     #No.MOD-C30717   Mark
                 #CALL q_apa2(FALSE,TRUE,' ','3',g_apa.apa06,g_apa.apa07) RETURNING g_apv[i].apv03                                     #No.MOD-C30717   Add      #TQC-BC0115 Mark
                  CALL q_apa2(FALSE,TRUE,' ','3',g_apa.apa06,g_apa.apa07,g_apa.apa02) RETURNING g_apv[i].apv03                                                   #TQC-BC0115 Add
                 DISPLAY g_apv[i].apv03 TO apv03                                             #MOD-740500
                 NEXT FIELD apv03
              OTHERWISE EXIT CASE
           END CASE
 
        BEFORE DELETE                            #是否取消單身
           IF g_apv[i].apv02 > 0 AND g_apv_t.apv02 IS NOT NULL THEN
              IF NOT cl_delb(0,0) THEN
                 CANCEL DELETE
              END IF
              IF g_apv[i].apx04f > 0 OR g_apv[i].apx04 >0 THEN
                 DELETE FROM apx_file
                  WHERE apx01 = g_apa.apa01 AND apx02 = g_apv_t.apv02
              END IF
              DELETE FROM apv_file
               WHERE apv01 = g_apa.apa01 AND apv02 = g_apv_t.apv02
              IF SQLCA.sqlcode THEN
                 CALL cl_err3("del","apv_file",g_apa.apa01,g_apv_t.apv02,SQLCA.sqlcode,"","",1)  #No.FUN-660122
                 CANCEL DELETE
              END IF
              LET ls_rec_b = ls_rec_b - 1
              MESSAGE "delete ok"
              IF g_success = 'Y' AND g_apv[i].apv03 <> 'DIFF' THEN #No.MOD-580365
                 SELECT SUM(apx04f),SUM(apx04) INTO g_apa.apa37f,g_apa.apa37
                   FROM apx_file WHERE apx01=g_apa.apa01
                 IF cl_null(g_apa.apa37f) THEN LET g_apa.apa37f = 0 END IF
                 IF cl_null(g_apa.apa37 ) THEN LET g_apa.apa37 = 0 END IF
                 DISPLAY BY NAME g_apa.apa37f,g_apa.apa37
                 UPDATE apa_file SET apa37f=g_apa.apa37f,apa37=g_apa.apa37
                  WHERE apa01 = g_apa.apa01
                 IF STATUS OR SQLCA.SQLCODE THEN
                    CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                    LET g_success='N'
                 END IF
                 SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa65f,g_apa.apa65
                   FROM apv_file WHERE apv01=g_apa.apa01
                 IF cl_null(g_apa.apa65f) THEN LET g_apa.apa65f = 0 END IF
                 IF cl_null(g_apa.apa65 ) THEN LET g_apa.apa65 = 0 END IF
                 DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
                 UPDATE apa_file SET apa65f=g_apa.apa65f,apa65=g_apa.apa65
                  WHERE apa01 = g_apa.apa01
                 IF STATUS OR SQLCA.SQLCODE THEN
                    CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                    LET g_success='N'
                 END IF
                 SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                   FROM aph_file,apf_file
                  WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                    AND aph03 IN ('6','7','8','9')
                 IF g_amt1f IS NULL THEN
                    LET g_amt1f = 0
                    LET g_amt1 = 0
                 END IF
                 #No.MOD-C30061  --Begin #增加退款沖帳金額
                 SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
                   FROM apg_file,apf_file
                  WHERE apg04=g_apv[i].apv03 AND apg01=apf01 AND apf41='Y'
                   #AND apf00='32'                  #MOD-D70039
                    AND (apf00='32' OR apf00='36')   #MOD-D70039

                 IF g_amt6f IS NULL THEN
                    LET g_amt6f = 0
                    LET g_amt6 = 0
                 END IF
                 #No.MOD-C30061  --End
                 SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                   FROM apv_file Where apv03=g_apv[i].apv03
                 IF g_amt2f IS NULL THEN
                    LET g_amt2f = 0
                    LET g_amt2 = 0
                 END IF
                 SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                   FROM oob_file,ooa_file
                  WHERE oob01 = ooa01
                    AND oob06 = g_apv[i].apv03
                    AND oob03 = '2' AND oob04 = '9'
                    AND ooaconf = 'Y' #須為已確認
                 IF cl_null(g_amt3f) THEN
                    LET g_amt3f = 0
                    LET g_amt3 = 0
                 END IF
                 #成本分攤
                 SELECT SUM(aqb04) INTO g_amt4 FROM aqa_file,aqb_file
                  WHERE aqa01 = aqb01 AND aqa04='Y' AND aqaconf = 'Y'
                    AND aqb02=g_apv[i].apv03
                 IF cl_null(g_amt4) THEN
                    LET g_amt4=0
                    LET g_amt4f=0
                 END IF
                 LET g_amt4f=g_amt4/g_apv[i].apa14
                 LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt4f+g_amt6f  #MOD-C30061 add g_amt6f
                 LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt4+g_amt6        #MOD-C30061 add g_amt6
                 SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
                 CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
                 LET l_apa.apa73 = l_apa.apa34 - g_amt1 + g_net
                 UPDATE apa_file SET apa35f= g_amt1f,
                                     apa35 = g_amt1,
                                     apa73 = l_apa.apa73   #No.MOD-640537
                  WHERE apa01 = g_apv[i].apv03
               SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                 FROM aph_file,apf_file
                WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                  AND aph03 IN ('6','7','8','9')
                  AND aph17 = g_apv[i].apv05             #No.FUN-680027
 
               IF g_amt1f IS NULL THEN
                  LET g_amt1f = 0
                  LET g_amt1 = 0
               END IF
 
               #No.MOD-C30061  --Begin #增加退款沖帳金額
               SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
                 FROM apg_file,apf_file
                WHERE apg04=g_apv[i].apv03 AND apg01=apf01 AND apf41='Y'
                  #AND apf00='32'                  #MOD-D70039
                  AND (apf00='32' OR apf00='36')   #MOD-D70039
               IF g_amt6f IS NULL THEN
                  LET g_amt6f = 0
                  LET g_amt6 = 0
               END IF
               #No.MOD-C30061  --End
               SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                 FROM apv_file Where apv03=g_apv[i].apv03
                                 AND apv05=g_apv[i].apv05   #No.FUN-680027   #MOD-860272
 
               IF g_amt2f IS NULL THEN
                  LET g_amt2f = 0
                  LET g_amt2 = 0
               END IF
 
               SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                 FROM oob_file,ooa_file
                WHERE oob01 = ooa01
                  AND oob06 = g_apv[i].apv03
                  AND oob03 = '2' AND oob04 = '9'
                  AND ooaconf = 'Y' #斗   w T {
                  AND oob19 = g_apv[i].apv05             #No.FUN-680027
 
               IF cl_null(g_amt3f) THEN
                  LET g_amt3f = 0
                  LET g_amt3 = 0
               END IF
 
               LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt6f+g_amt4f  #MOD-C30061 add g_amt6f    #TQC-C70079  add  g_amt4f
               LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt6+g_amt4        #MOD-C30061 add g_amt6     #TQC-C70079  add  g_amt4
               SELECT * INTO l_apc.* FROM apc_file WHERE apc01=g_apv[i].apv03 AND apc02 =g_apv[i].apv05
               CALL t110_comp_oox1(g_apv[i].apv03,g_apv[i].apv05) RETURNING g_net
               LET l_apc.apc13 = l_apc.apc09 - g_amt1 + g_net
               UPDATE apc_file set apc10=g_amt1f,
                                   apc11=g_amt1,
                                   apc13=l_apc.apc13
                WHERE apc01 =g_apv[i].apv03
                  AND apc02 =g_apv[i].apv05
              END IF
           END IF
 
      ON ROW CHANGE
          IF INT_FLAG THEN
             CALL cl_err('',9001,0)
             LET INT_FLAG = 0
             LET g_apv[l_ac].* = g_apv_t.*
             CLOSE t110_loc2_cr
             LET g_success = 'N'
             EXIT INPUT
          END IF
          IF l_lock_sw = 'Y' THEN
             CALL cl_err(g_apv[l_ac].apv02,-263,1)
             LET g_apv[l_ac].* = g_apv_t.*
          ELSE
             IF g_apv[i].apx04f > 0 OR g_apv[i].apx04 > 0 THEN   #No.TQC-950113
                UPDATE apx_file SET apx03 = g_apv[i].apv03,
                                    apx04f= g_apv[i].apx04f,
                                    apx04 = g_apv[i].apx04
                 WHERE apx01 = g_apa.apa01
                   AND apx02 = g_apv_t.apv02
                IF STATUS OR SQLCA.SQLCODE THEN
                   CALL cl_err3("upd","apx_file",g_apa.apa01,g_apv_t.apv02,SQLCA.sqlcode,"","upd apx:",1)  #No.FUN-660122
                   LET g_success = 'N'
                END IF
                IF SQLCA.sqlerrd[3] = 0 THEN
                   INSERT INTO apx_file(apx01,apx02,apx03,apx04f,apx04,apxlegal)      #No.FUN-680027 #FUN-980001 add apxlegal
                    VALUES(g_apa.apa01,g_apv_t.apv02,g_apv[i].apv03,
                           g_apv[i].apx04f,g_apv[i].apx04,g_legal)          #No.FUN-680027 #FUN-980001 add g_legal
                END IF
             ELSE
                DELETE FROM apx_file
                 WHERE apx01 = g_apa.apa01 AND apx02 = g_apv_t.apv02
                IF STATUS OR SQLCA.SQLCODE THEN
                   CALL cl_err3("del","apx_file",g_apa.apa01,g_apv_t.apv02,SQLCA.sqlcode,"","upd apx:",1)  #No.FUN-660122
                   LET g_success = 'N'
                END IF
             END IF
             SELECT SUM(apx04f),SUM(apx04) INTO g_apa.apa37f,g_apa.apa37
               FROM apx_file WHERE apx01=g_apa.apa01
             IF cl_null(g_apa.apa37f) THEN LET g_apa.apa37f = 0 END IF
             IF cl_null(g_apa.apa37 ) THEN LET g_apa.apa37 = 0 END IF
             DISPLAY BY NAME g_apa.apa37f,g_apa.apa37
             UPDATE apa_file SET apa37f=g_apa.apa37f,apa37=g_apa.apa37
              WHERE apa01 = g_apa.apa01
             IF STATUS OR SQLCA.SQLCODE THEN
                CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                LET g_success='N'
             END IF
             UPDATE apv_file SET apv02 = g_apv[i].apv02,
                                 apv03 = g_apv[i].apv03,
                                 apv04f= g_apv[i].apv04f,
                                 apv04 = g_apv[i].apv04,
                                 apv05 = g_apv[i].apv05      #No.FUN-680027
              WHERE apv01 = g_apa.apa01
                AND apv02 = g_apv_t.apv02
             IF STATUS OR SQLCA.SQLCODE THEN
                CALL cl_err3("upd","apv_file",g_apa.apa01,g_apv_t.apv02,SQLCA.sqlcode,"","upd apv:",1)  #No.FUN-660122
                LET g_success = 'N'
                LET g_apv[i].* = g_apv_t.*
                ELSE MESSAGE "update ok"
             END IF
             IF g_success = 'Y' AND g_apv[i].apv03 <> 'DIFF' THEN #No.MOD-580365
               #當修改了待抵編號,應將舊待抵編號的已沖金額扣回(參考刪除段),
               #                 再UPDATE新待抵編號的已沖金額
                IF g_apv_t.apv03 != g_apv[i].apv03 THEN
                   SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                     FROM aph_file,apf_file
                    WHERE aph04=g_apv_t.apv03 AND aph01=apf01 AND apf41='Y'
                      AND aph03 IN ('6','7','8','9')
                   IF g_amt1f IS NULL THEN
                      LET g_amt1f = 0
                      LET g_amt1 = 0
                   END IF
                   #No.MOD-C30061  --Begin #增加退款沖帳金額
                   SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
                     FROM apg_file,apf_file
                    WHERE apg04=g_apv_t.apv03 AND apg01=apf01 AND apf41='Y'
                     #AND apf00='32'                  #MOD-D70039
                      AND (apf00='32' OR apf00='36')   #MOD-D70039
                   IF g_amt6f IS NULL THEN
                      LET g_amt6f = 0
                      LET g_amt6 = 0
                   END IF
                   #No.MOD-C30061  --End
                   SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                     FROM apv_file Where apv03=g_apv_t.apv03
                   IF g_amt2f IS NULL THEN
                      LET g_amt2f = 0
                      LET g_amt2 = 0
                   END IF
                   SELECT SUM(apv04f),SUM(apv04) INTO g_amt5f,g_amt5
                     FROM apv_file Where apv01=g_apv_t.apv03
                   IF g_amt5f IS NULL THEN
                      LET g_amt5f = 0
                      LET g_amt5 = 0
                   END IF
                   SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                     FROM oob_file,ooa_file
                    WHERE oob01 = ooa01
                      AND oob06 = g_apv_t.apv03
                      AND oob03 = '2' AND oob04 = '9'
                      AND ooaconf = 'Y' #須為已確認
                   IF cl_null(g_amt3f) THEN
                      LET g_amt3f = 0
                      LET g_amt3 = 0
                   END IF
                   LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt5f+g_amt6f  #MOD-C30061 add g_amt6f
                   LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt5+g_amt6        #MOD-C30061 add g_amt6
                   SELECT * INTO l_apa.* FROM apa_file
                    WHERE apa01 = g_apv_t.apv03
                   LET l_apa.apa34 = l_apa.apa31 + l_apa.apa32 - g_amt1
                   LET l_apa.apa34f= l_apa.apa31f+ l_apa.apa32f- g_amt1f
                   CALL t110_comp_oox(g_apv_t.apv03) RETURNING g_net
                   SELECT apa34 INTO m_apa34 FROM apa_file
                    WHERE apa01 = g_apv_t.apv03
                   LET g_apa.apa73 = m_apa34 - g_amt1 + g_net
                   UPDATE apa_file SET apa65f= g_amt1f,
                                       apa65 = g_amt1,
                                       apa34 = l_apa.apa34,
                                       apa34f= l_apa.apa34f,
                                       apa73 = g_apa.apa73
                    WHERE apa01 = g_apv_t.apv03
                   IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
                      CALL cl_err3("upd","apa_file",g_apv_t.apv03,"",STATUS,"","upd apa",1)
                      LET g_success='N'
                   END IF
                END IF
 
                SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa65f,g_apa.apa65
                  FROM apv_file WHERE apv01=g_apa.apa01
 
                IF cl_null(g_apa.apa65f) THEN
                   LET g_apa.apa65f = 0
                END IF
 
                IF cl_null(g_apa.apa65 ) THEN
                   LET g_apa.apa65 = 0
                END IF
 
                DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
 
                UPDATE apa_file SET apa65f=g_apa.apa65f,apa65=g_apa.apa65
                 WHERE apa01 = g_apa.apa01
                IF STATUS OR SQLCA.SQLCODE THEN
                   CALL cl_err3("upd","apa_file", g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
                   LET g_success='N'
                   IF p_cmd = 'u' THEN
                      LET g_apv[i].*=g_apv_t.*
                   END IF
                END IF
 
                SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                  FROM aph_file,apf_file
                 WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                   AND aph03 IN ('6','7','8','9')
 
                IF g_amt1f IS NULL THEN
                   LET g_amt1f = 0
                   LET g_amt1 = 0
                END IF
                #No.MOD-C30061  --Begin #增加退款沖帳金額
                SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
                  FROM apg_file,apf_file
                 WHERE apg04=g_apv[i].apv03 AND apg01=apf01 AND apf41='Y'
                  #AND apf00='32'                  #MOD-D70039
                  AND (apf00='32' OR apf00='36')   #MOD-D70039
                IF g_amt6f IS NULL THEN
                   LET g_amt6f = 0
                   LET g_amt6 = 0
                END IF
                #No.MOD-C30061  --End
 
                SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                  FROM apv_file Where apv03=g_apv[i].apv03
 
                IF g_amt2f IS NULL THEN
                   LET g_amt2f = 0
                   LET g_amt2 = 0
                END IF
 
                SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                  FROM oob_file,ooa_file
                 WHERE oob01 = ooa01
                   AND oob06 = g_apv[i].apv03
                   AND oob03 = '2' AND oob04 = '9'
                   AND ooaconf = 'Y' #須為已確認
 
                IF cl_null(g_amt3f) THEN
                   LET g_amt3f = 0
                   LET g_amt3 = 0
                END IF
 
                LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt6f  #MOD-C30061 add g_amt6f
                LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt6       #MOD-C30061 add g_amt6
                SELECT * INTO l_apa.* FROM apa_file WHERE apa01=g_apv[i].apv03
                CALL t110_comp_oox(g_apv[i].apv03) RETURNING g_net
                LET l_apa.apa73 = l_apa.apa34 - g_amt1 + g_net
 
                UPDATE apa_file SET apa35f= g_amt1f,
                                    apa35 = g_amt1,
                                    apa73 = l_apa.apa73   #No.MOD-640537
                 WHERE apa01 = g_apv[i].apv03
               SELECT SUM(aph05f),SUM(aph05) INTO g_amt1f,g_amt1
                 FROM aph_file,apf_file
                WHERE aph04=g_apv[i].apv03 AND aph01=apf01 AND apf41='Y'
                  AND aph03 IN ('6','7','8','9')
                  AND aph17 = g_apv[i].apv05             #No.FUN-680027
 
               IF g_amt1f IS NULL THEN
                  LET g_amt1f = 0
                  LET g_amt1 = 0
               END IF
 
               #No.MOD-C30061  --Begin #增加退款沖帳金額
               SELECT SUM(apg05f),SUM(apg05) INTO g_amt6f,g_amt6
                 FROM apg_file,apf_file
                WHERE apg04=g_apv[i].apv03 AND apg01=apf01 AND apf41='Y'
                  #AND apf00='32'                  #MOD-D70039
                  AND (apf00='32' OR apf00='36')   #MOD-D70039
               IF g_amt6f IS NULL THEN
                  LET g_amt6f = 0
                  LET g_amt6 = 0
               END IF
               #No.MOD-C30061  --End
               SELECT SUM(apv04f),SUM(apv04) INTO g_amt2f,g_amt2
                 FROM apv_file Where apv03=g_apv[i].apv03
                                 AND apv05=g_apv[i].apv05   #No.FUN-680027   #MOD-860272
 
               IF g_amt2f IS NULL THEN
                  LET g_amt2f = 0
                  LET g_amt2 = 0
               END IF
 
               SELECT SUM(oob09),SUM(oob10) INTO g_amt3f,g_amt3
                 FROM oob_file,ooa_file
                WHERE oob01 = ooa01
                  AND oob06 = g_apv[i].apv03
                  AND oob03 = '2' AND oob04 = '9'
                  AND ooaconf = 'Y' #須為已確認
                  AND oob19 = g_apv[i].apv05             #No.FUN-680027
 
               IF cl_null(g_amt3f) THEN
                  LET g_amt3f = 0
                  LET g_amt3 = 0
               END IF
 
               LET g_amt1f=g_amt1f+g_amt2f+g_amt3f+g_amt6f   #MOD-C30061 add g_amt6f
               LET g_amt1=g_amt1+g_amt2+g_amt3+g_amt6        #MOD-C30061 add g_amt6
               SELECT * INTO l_apc.* FROM apc_file WHERE apc01=g_apv[i].apv03 AND apc02 =g_apv[i].apv05
               CALL t110_comp_oox1(g_apv[i].apv03,g_apv[i].apv05) RETURNING g_net
               LET l_apc.apc13 = l_apc.apc09 - g_amt1 + g_net
               UPDATE apc_file set apc10=g_amt1f,
                                   apc11=g_amt1,
                                   apc13=l_apc.apc13
                WHERE apc01 =g_apv[i].apv03
                  AND apc02 =g_apv[i].apv05
            END IF
          END IF
 
      AFTER ROW
          LET l_ac = ARR_CURR()
          IF INT_FLAG THEN
             CALL cl_err('',9001,0)
             LET INT_FLAG = 0
             IF p_cmd = 'u' THEN
                LET g_apv[l_ac].* = g_apv_t.*
             #FUN-D30032--add--str--
             ELSE
                CALL g_apv.deleteElement(l_ac)
             #FUN-D30032--add--end--
             END IF
             CLOSE t110_loc2_cr
             LET g_success = 'N'
             EXIT INPUT
          END IF
          CLOSE t110_loc2_cr
 
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT
 
      ON ACTION about         #MOD-4C0121
         CALL cl_about()      #MOD-4C0121
 
      ON ACTION help          #MOD-4C0121
         CALL cl_show_help()  #MOD-4C0121
 
      ON ACTION controlg      #MOD-4C0121
         CALL cl_cmdask()     #MOD-4C0121
 
     #計算匯差
     AFTER INPUT
        LET l_net = 0
        FOR l_i = 1 TO g_apv.getLength()
            IF cl_null(g_apv[l_i].apv03) THEN CONTINUE FOR END IF
            IF g_apv[l_i].apv03 = 'DIFF' THEN CONTINUE FOR END IF
            SELECT apa14 INTO l_apa14 FROM apa_file
             WHERE apa01=g_apv[l_i].apv03
            IF l_apa14 <> g_apv[l_i].apa14 THEN
               LET l_amt=cl_digcut(g_apv[l_i].apv04f*g_apa.apa14,g_azi04)
                         - g_apv[l_i].apv04
               IF cl_null(l_amt) THEN LET l_amt=0 END IF
               LET l_net = l_net + l_amt
            ELSE
               IF g_apv[l_i].apa14 <> g_apa.apa14 THEN
                  LET l_amt=cl_digcut(g_apv[l_i].apv04f*g_apa.apa14,g_azi04)
                            - g_apv[l_i].apv04
                  IF cl_null(l_amt) THEN LET l_amt=0 END IF
                  LET l_net = l_net + l_amt
               END IF
            END IF
        END FOR
        DELETE FROM apv_file
         WHERE apv01=g_apa.apa01
           AND apv03='DIFF'
        IF SQLCA.sqlcode THEN
           CALL cl_err3("del","apv_file", g_apa.apa01,"",SQLCA.sqlcode,"","delete diff",1)  #No.FUN-660122
           NEXT FIELD apv04
        END IF
        IF l_net <> 0 THEN
            SELECT MAX(apv02)+1 INTO l_apv02 FROM apv_file
             WHERE apv01 = g_apa.apa01
            IF cl_null(l_apv02)  THEN
               LET l_apv02 = 1
            END IF
            INSERT INTO apv_file(apv01,apv02,apv03,apv04f,apv04,apvlegal) #FUN-980001 add apvlegal
            VALUES(g_apa.apa01,l_apv02,'DIFF',0,l_net,g_legal) #FUN-980001 add g_legal
            IF SQLCA.sqlcode THEN
               CALL cl_err3("ins","apv_file",g_apa.apa01,l_apv02,SQLCA.sqlcode,"","insert diff",1)  #No.FUN-660122
               NEXT FIELD apv04
            END IF
         END IF
  
      ON ACTION controls                       #No.FUN-6B0033                                                                       
         CALL cl_set_head_visible("","AUTO")   #No.FUN-6B0033
 
   END INPUT
 
   IF INT_FLAG THEN
      LET g_success='N'
      LET INT_FLAG = 0
   END IF
 
   IF g_success = 'Y' THEN
      COMMIT WORK
      MESSAGE "Commit"
   ELSE
      ROLLBACK WORK
      MESSAGE "RollBack"
   END IF
 
   SELECT SUM(apv04f),SUM(apv04) INTO g_apa.apa65f,g_apa.apa65
     FROM apv_file WHERE apv01=g_apa.apa01
 
   IF cl_null(g_apa.apa65f) THEN
      LET g_apa.apa65f = 0
   END IF
 
   IF cl_null(g_apa.apa65 ) THEN
      LET g_apa.apa65 = 0
   END IF
 
   DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
 
   UPDATE apa_file SET apa65f=g_apa.apa65f,apa65=g_apa.apa65
    WHERE apa01 = g_apa.apa01
 
   IF STATUS OR SQLCA.SQLCODE THEN
      CALL cl_err3("upd","apa_file", g_apa.apa01,"",SQLCA.sqlcode,"","upd apa65:",1)  #No.FUN-660122
   END IF
 
   CLOSE WINDOW t110_kkk_w2
 
   DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
   CLOSE t110_loc_cr
   CLOSE t110_loc2_cr
 
   IF l_lock_sw = 'Y' THEN
      RETURN
   END IF
 
   CALL t110_apa34f('1')   #TQC-750140
  #IF g_apa.apa65f < g_apa.apa31f+g_apa.apa37f THEN               #MOD-B60218 mark
   IF g_apa.apa65f < g_apa.apa31f+g_apa.apa32f+g_apa.apa37f THEN  #MOD-B60218
     #IF g_apa.apa65f < g_apa.apa31f THEN                #MOD-B60218 mark
      IF g_apa.apa65f < g_apa.apa31f+g_apa.apa32f THEN   #MOD-B60218
         LET g_apa.apa37f = 0
         LET g_apa.apa37 = 0
         DELETE FROM apx_file WHERE apx01 = g_apa.apa01
      ELSE 
         DELETE FROM apx_file WHERE apx01 = g_apa.apa01
        #str MOD-B60218 mod
        #LET g_apa.apa37f = g_apa.apa65f - g_apa.apa31f
        #LET g_apa.apa37  = g_apa.apa65  - g_apa.apa31
         LET g_apa.apa37f = g_apa.apa65f - g_apa.apa31f - g_apa.apa32f
         LET g_apa.apa37  = g_apa.apa65  - g_apa.apa31  - g_apa.apa32
        #end MOD-B60218 mod
         INSERT INTO apx_file(apx01,apx02,apx03,apx04f,apx04,apxlegal) #FUN-980001 add apxlegal
              VALUES (g_apa.apa01,1,NULL,g_apa.apa37f,g_apa.apa37,g_legal) #FUN-980001 add g_legal
         IF SQLCA.sqlcode THEN
            CALL cl_err3("ins","apx_file",g_apa.apa01,"",SQLCA.sqlcode,"",SQLCA.sqlcode,1)
         END IF
      END IF
   END IF
   CALL t110_apa34f('1')    #TQC-750140
   IF g_apa.apa34f  < 0 OR g_apa.apa34 < 0 THEN
      IF cl_null(g_apa.apa101) OR cl_null(g_apa.apa102) THEN
         CALL cl_err(g_apa.apa01,'aap-095',1)
         CALL t110_upd_apa101()
      END IF
      LET l_sum_apx04f = -g_apa.apa34f
      LET l_sum_apx04  = -g_apa.apa34
      LET g_apa.apa34f = 0
      LET g_apa.apa34  = 0
      IF l_sum_apx04f <> 0 OR l_sum_apx04 <> 0 THEN
         LET cnt2 = 0 
         SELECT COUNT(*) INTO cnt2 FROM apx_file WHERE apx01 = g_apa.apa01 
         LET cnt2 = cnt2 + 1
         INSERT INTO apx_file(apx01,apx02,apx03,apx04f,apx04,apxlegal) #FUN-980001 add apxlegal
              VALUES (g_apa.apa01,cnt2+1,NULL,l_sum_apx04f,l_sum_apx04,g_legal) #FUN-980001 add g_legal
         IF SQLCA.sqlcode THEN
            CALL cl_err3("ins","apx_file",g_apa.apa01,"",SQLCA.sqlcode,"",SQLCA.sqlcode,1)
         END IF
      END IF
      SELECT SUM(apx04f),SUM(apx04) INTO g_apa.apa37f,g_apa.apa37
        FROM apx_file WHERE apx01=g_apa.apa01
      IF cl_null(g_apa.apa37f) THEN LET g_apa.apa37f = 0 END IF
      IF cl_null(g_apa.apa37 ) THEN LET g_apa.apa37 = 0 END IF
      DISPLAY BY NAME g_apa.apa37f,g_apa.apa37
      UPDATE apa_file SET apa37f=g_apa.apa37f,apa37=g_apa.apa37
       WHERE apa01 = g_apa.apa01
      IF STATUS OR SQLCA.SQLCODE THEN
         CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)  #No.FUN-660122
         LET g_success='N'
      END IF
   END IF
 
   LET g_apa.apa72 = g_apa.apa14
   CALL t110_comp_oox(g_apa.apa01) RETURNING g_net       #CHI-890017 add
   LET g_apa.apa73 = g_apa.apa34 - g_apa.apa35 + g_net   #CHI-890017
 
   UPDATE apa_file set * = g_apa.* WHERE apa01 = g_apa.apa01
   IF g_apa.apa31 <>g_apa_t.apa31 OR g_apa.apa32 <> g_apa_t.apa32
      OR g_apa.apa34 <> g_apa_t.apa34 OR g_apa.apa57 <> g_apa_t.apa57
      OR g_apa.apa57 <> g_apa_t.apa57 OR g_apa.apa73 <> g_apa_t.apa73
      OR g_apa.apa31f <> g_apa_t.apa31f OR g_apa.apa32f <> g_apa_t.apa32f
      OR g_apa.apa34f <> g_apa_t.apa34f OR g_apa.apa57f <> g_apa_t.apa57f THEN
     SELECT DISTINCT(pmb02) INTO l_pmb02 FROM pmb_file
      WHERE pmb01 = g_apa.apa11
     IF l_pmb02 = 1 OR cl_null(l_pmb02) THEN   #MOD-810156
        DELETE FROM apc_file WHERE apc01 = g_apa.apa01
        CALL t110_ins_apc(g_apa.*)
     ELSE
        IF g_apa.apa35 <> g_apa_t.apa35 OR g_apa.apa35f <> g_apa_t.apa35f THEN
           LET g_sn = 'y'
        END IF
        CALL t110_account_period()
        LET g_sn = 'n'
     END IF
    END IF
 
   CALL t110_up_gl()
   CALL t110_unpay()
 
   DELETE FROM apv_file WHERE apv01 = g_apa.apa01 AND apv04 = 0 AND apv04f =0    #No.TQC-950113
 
   CALL t110_diff_rtn('1') ##TQC-750140
  #CALL t110_api_diff()    #No.TQC-7B0083  #MOD-C60107 mark
   DISPLAY BY NAME g_apa.apa34f,g_apa.apa34,g_apa.apa37f,g_apa.apa37   #No.FUN-690080
 
END FUNCTION
FUNCTION t110_bookno()                                                                                                              
   IF g_apz.apz02='Y' THEN          #No.TQC-740093                                                                                                
      LET g_db1 = g_apz.apz02p      #No.TQC-740093                                                                                                       
   ELSE                                                                                                                             
      LET g_db1 = g_plant                                                                                                           
   END IF
   SELECT azp03 INTO g_azp03 FROM azp_file                                                                                          
    WHERE azp01=g_db1                                                                                                               
   LET g_db_type1 = cl_db_get_database_type()   #FUN-C80078  g_db_type-->g_db_type1                                                                                    
                                                                                                                                    
   LET g_plantm = g_db1                      #FUN-980020 
   LET g_dbsm = s_dbstring(g_azp03 CLIPPED)  #add

   CALL s_get_bookno1(YEAR(g_apa.apa02),g_plantm) #FUN-980020
        RETURNING g_flag1,g_bookno1,g_bookno2                                                                                        
   IF g_flag1 =  '1' THEN  #抓不到帳別                                                                                               
      CALL cl_err(g_dbsm,'aoo-081',1)                                                                                               
      CALL cl_used(g_prog,g_time,2) RETURNING g_time    #FUN-B30211
      EXIT PROGRAM                                                                                                                  
   END IF                                                                                                                           
END FUNCTION                                                                                                                        
 
 
FUNCTION t110_rvb06_1(p_apb04,p_apb05)
  DEFINE p_apb04            LIKE apb_file.apb04
  DEFINE p_apb05            LIKE apb_file.apb05
  DEFINE l_qty_rvv88        LIKE rvv_file.rvv23
  DEFINE l_qty_rvv23_rvv88  LIKE rvv_file.rvv23
 
      #暫估數量                                                                 
      LET l_qty_rvv88 = 0                                                       
      SELECT SUM(apb09) INTO l_qty_rvv88 FROM apb_file,apa_file                 
       WHERE apb04 = p_apb04 AND apb05 = p_apb05 
         AND apb01 = apa01   AND apa00 = '16'
         AND apa42 = 'N'                                                        
                                                                                
      IF l_qty_rvv88 IS NULL THEN                                               
         LET l_qty_rvv88 = 0                                                    
      END IF                                                                    
                                                                                
      #衝暫估數量                                                               
      LET l_qty_rvv23_rvv88 = 0                                                 
      SELECT SUM(apb09) INTO l_qty_rvv23_rvv88 FROM apb_file,apa_file           
       WHERE apb04 = p_apb04 AND apb05 = p_apb05
         AND apb01 = apa01   AND apa00 = '11'                                     
         AND apa42 = 'N'                                                        
         AND apb34 = 'Y'                                                        
         AND apb29 = '1'
                                                                                
      IF l_qty_rvv23_rvv88 IS NULL THEN                                         
         LET l_qty_rvv23_rvv88 = 0                                              
      END IF                                   
 
      RETURN l_qty_rvv88,l_qty_rvv23_rvv88
                                                                                
END FUNCTION
 
FUNCTION t110_rvv23_rvv88(p_apb21,p_apb22,p_apa00_1,p_apa00_2)
  DEFINE p_apb21            LIKE apb_file.apb21
  DEFINE p_apb22            LIKE apb_file.apb22
  DEFINE p_apa00_1          LIKE apa_file.apa00
  DEFINE p_apa00_2          LIKE apa_file.apa00
  DEFINE l_qty_rvv88        LIKE rvv_file.rvv23
  DEFINE l_qty_rvv23_rvv88  LIKE rvv_file.rvv23
 
      #暫估數量                                                                 
      LET l_qty_rvv88 = 0                                                       
      SELECT SUM(apb09) INTO l_qty_rvv88 FROM apb_file,apa_file                 
       WHERE apb21 = p_apb21 AND apb22 = p_apb22
         AND apb01 = apa01   AND apa00 = p_apa00_2
         AND apa42 = 'N'                                                        
                                                                                
      IF l_qty_rvv88 IS NULL THEN                                               
         LET l_qty_rvv88 = 0                                                    
      END IF                                                                    
 
      IF l_qty_rvv88 < 0 THEN
         LET l_qty_rvv88 = l_qty_rvv88 * -1
      END IF
                                                                                
      #衝暫估數量                                                               
      LET l_qty_rvv23_rvv88 = 0                                                 
      SELECT SUM(apb09) INTO l_qty_rvv23_rvv88 FROM apb_file,apa_file           
       WHERE apb21 = p_apb21 AND apb22 = p_apb22
         AND apb01 = apa01   AND apa00 = p_apa00_1
         AND apa42 = 'N'                                                        
         AND apb34 = 'Y'                                                        
                                                                                
      IF l_qty_rvv23_rvv88 IS NULL THEN                                         
         LET l_qty_rvv23_rvv88 = 0                                              
      END IF                               
 
      IF l_qty_rvv23_rvv88 < 0 THEN
         LET l_qty_rvv23_rvv88 = l_qty_rvv23_rvv88 * -1
      END IF
                                                                                
      RETURN l_qty_rvv88,l_qty_rvv23_rvv88
END FUNCTION
 
FUNCTION t110_api_unap(p_cmd)
  DEFINE p_cmd         LIKE type_file.chr1
  DEFINE l_api         RECORD LIKE api_file.*
  DEFINE l_apa01       LIKE apa_file.apa01
  DEFINE l_apa54       LIKE apa_file.apa54
  DEFINE l_apa541      LIKE apa_file.apa541
  DEFINE l_apa22       LIKE apa_file.apa22
  DEFINE l_apb02       LIKE apb_file.apb02    #MOD-F30090 add
  DEFINE l_apb08       LIKE apb_file.apb08
  DEFINE l_apb09       LIKE apb_file.apb09    #MOD-930030 add
  DEFINE l_apb23       LIKE apb_file.apb23
  DEFINE l_apb10       LIKE apb_file.apb10    #MOD-960266 add
  DEFINE l_apb24       LIKE apb_file.apb24    #MOD-960266 add
  DEFINE l_apb10_unap  LIKE apb_file.apb10    #MOD-960266 add
  DEFINE l_apb24_unap  LIKE apb_file.apb24    #MOD-960266 add
  DEFINE l_apb10_unap1 LIKE apb_file.apb10    #MOD-960266 add
  DEFINE l_apb24_unap1 LIKE apb_file.apb24    #MOD-960266 add
  DEFINE l_apa35f_u    LIKE apa_file.apa35f   #No.MOD-8A0220
  DEFINE l_apa35_u     LIKE apa_file.apa35    #No.MOD-8A0220
  DEFINE l_apa930      LIKE apa_file.apa930   #CHI-8C0005 add
  DEFINE l_apa72       LIKE apa_file.apa72    #MOD-930169 add
  DEFINE l_apa14       LIKE apa_file.apa14    #TQC-940171 add
  DEFINE l_gec07       LIKE gec_file.gec07    #MOD-B90164 add
  DEFINE l_gec04       LIKE gec_file.gec04    #MOD-B90164 add
  DEFINE l_rvv38t      LIKE rvv_file.rvv38t   #MOD-B90164 add
  DEFINE l_sumapb24    LIKE apb_file.apb24    #yinhy140107
  DEFINE l_sumapb10    LIKE apb_file.apb10    #yinhy140107
  DEFINE l_othapb09    LIKE apb_file.apb09    #yinhy140107
 
  IF p_cmd = 'u' AND g_apb_t.apb34 = 'Y' AND g_apb[l_ac].apb34 = 'N' THEN
     LET p_cmd = 'd'
  END IF
  IF p_cmd = 'u' AND g_apb_t.apb34 = 'N' AND g_apb[l_ac].apb34 = 'Y' THEN
     LET p_cmd = 'a'
  END IF
    
  SELECT azi04 INTO t_azi04   #MOD-C70266
    FROM azi_file             #MOD-C70266
   WHERE azi01 = g_apa.apa13  #MOD-C70266

  IF p_cmd = 'a' THEN
     LET l_apa01=t110_set_apb01_unap(g_apb[l_ac].apb21,g_apb[l_ac].apb22,'Y')
     IF g_aptype = '12' OR 
       (g_aptype='21' AND g_apa.apa58='3') THEN   #MOD-850316 add
        SELECT apa54,apa541,apa22,apb08,apb09,apb23,apa930,apa14,apb10,apb24  #CHI-8C0005 add apa930    #MOD-930030 add apb09  #MOD-9B0054 add apa14  #yinhy140107
          INTO l_apa54,l_apa541,l_apa22,l_apb08,l_apb09,l_apb23,l_apa930,l_apa14,l_apb10,l_apb24    #CHI-8C0005 add apa930  #MOD-930030 add apb09 #MOD-9B0054 add l_apa14
          FROM apa_file,apb_file
         WHERE apa01 = apb01 AND apa01=l_apa01
           AND apb02 = g_apb[l_ac].apb22
        LET l_apb09=g_apb[l_ac].apb09   #數量       #MOD-9B0054 add
        LET l_apb23=g_apb[l_ac].apb23   #原幣單價   #MOD-9B0054 add
        LET l_apb08=g_apb[l_ac].apb08   #本幣單價   #MOD-9B0054 add
     ELSE
        SELECT apa54,apa541,apa22,apb08,apb09,apb23,apa930,apa14,apb10,apb24   #CHI-8C0005 add apa930                 #MOD-930030 add apb09  #MOD-AA0120 add apa14 #yinhy140107
          INTO l_apa54,l_apa541,l_apa22,l_apb08,l_apb09,l_apb23,l_apa930,l_apa14,l_apb10,l_apb24   #CHI-8C0005 add apa930  #MOD-930030 add apb09 #MOD-AA0120 add apa14
          FROM apa_file,apb_file
         WHERE apa01 = apb01 AND apa01=l_apa01
           AND apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
     END IF
     IF cl_null(l_apb08) THEN LET l_apb08 = 0 END IF
     IF cl_null(l_apb09) THEN LET l_apb09 = 0 END IF   #MOD-930030 add
     IF cl_null(l_apb23) THEN LET l_apb23 = 0 END IF
     IF cl_null(l_apb24) THEN LET l_apb24 = 0 END IF   #yinhy140107
     IF cl_null(l_apb10) THEN LET l_apb10 = 0 END IF   #yinhy140107
     IF cl_null(l_apa930) THEN LET l_apa930= ' ' END IF   #CHI-8C0005 add
     INITIALIZE l_api.* TO NULL
     LET l_api.api01 =g_apa.apa01
     LET l_api.api02 ='2'
     LET l_api.api03 =g_apb[l_ac].apb02
     LET l_api.api04 =l_apa54
     LET l_api.api041=l_apa541
     IF cl_null(g_apb[l_ac].apb09) OR g_apb[l_ac].apb09 = 0 OR  #MOD-930030 mod
        l_apb09 = g_apb[l_ac].apb09 THEN   #MOD-930030 add
        #No.yinhy140107  --Begin
        LET l_othapb09 = 0                           
        SELECT SUM(apb09) INTO l_othapb09 
          FROM apa_file,apb_file                  
         WHERE apa01 = apb01                      
           AND apa42 = 'N'                        
           AND apa00 NOT IN ('16','26')           
           AND apb21 = p_apb.apb21                
           AND apb22 = p_apb.apb22                
           AND apb01 <> p_apb.apb01 
        IF cl_null(l_othapb09) THEN LET l_othapb09 = 0 END IF
        IF l_othapb09 +  g_apb[l_ac].apb09 >=  l_apb09 THEN
           LET l_sumapb24 = 0
           LET l_sumapb10 = 0
           SELECT SUM(apb24),SUM(apb10) INTO l_sumapb24,l_sumapb10
             FROM apa_file,apb_file
            WHERE apa01 = apb01 
              AND apa42 = 'N' 
              AND apa00 NOT IN ('16','26')
              AND apb21 = g_apb[l_ac].apb21
              AND apb22 = g_apb[l_ac].apb22
              AND ((apb01 = g_apa.apa01 AND apb02 <>g_apb[l_ac].apb02) 
                   OR apb01 <> g_apa.apa01)
            IF cl_null(l_sumapb24) THEN LET l_sumapb24 = 0 END IF
            IF cl_null(l_sumapb10) THEN LET l_sumapb10 = 0 END IF
            LET l_api.api05f = l_apb24 - l_sumapb24
            LET l_api.api05  = l_apb10 - l_sumapb10
        ELSE  
        #No.yinhy140107  --End
          LET l_api.api05f = g_apb[l_ac].apb24
          #寫入api_file的api05時,應該寫入aapt160的原始本幣金額
          #IF g_aptype = '11' OR g_aptype='16' THEN       #MOD-C20104 mark
           IF g_aptype = '11' AND g_apz.apz27 = 'N' THEN  #MOD-C20104
              SELECT apb10 INTO l_api.api05 FROM apa_file,apb_file
               WHERE apa01 = apb01             AND (apa00 = '16' OR apa00 = '26')
                 AND apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
           END IF
        END IF  #yinhy140107
       #IF g_aptype = '12' THEN                        #CHI-A30023 mark
        IF g_aptype = '12' OR g_aptype = '21' THEN     #CHI-A30023 add
           LET l_api.api05 =l_api.api05f * l_apa14
        END IF
        IF cl_null(l_api.api05) THEN
           LET l_api.api05  = g_apb[l_ac].apb10
        END IF
        LET l_api.api05 = cl_digcut(l_api.api05,g_azi04)              #MOD-C70266 add
     ELSE
      #---------------------------------MOD-B90164-------------------------start
        LET l_gec04 = 0   LET l_gec07 = ''
        IF g_apb[l_ac].apb06 <> '' OR NOT cl_null(g_apb[l_ac].apb06) THEN
           SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file,pmm_file
            WHERE gec01 = pmm21 AND pmm01=g_apb[l_ac].apb06
        ELSE
           SELECT gec04,gec07 INTO l_gec04,l_gec07 FROM gec_file
            WHERE gec01 = g_apa.apa15
        END IF
        IF cl_null(l_gec04) THEN LET l_gec04=0   END IF
        IF cl_null(l_gec07) THEN LET l_gec07='N' END IF
        LET l_rvv38t = 0
        IF l_gec07='Y' THEN        #含稅單價*數量=含稅金額
           SELECT rvv38t INTO l_rvv38t FROM rvv_file
            WHERE rvv01 = g_apb[l_ac].apb21
              AND rvv02 = g_apb[l_ac].apb22
           LET l_api.api05f = l_rvv38t*g_apb[l_ac].apb09
           LET l_api.api05f = cl_digcut(l_api.api05f,t_azi04)
           LET l_api.api05f = l_api.api05f/(1+l_gec04/100)
           LET l_api.api05f = cl_digcut(l_api.api05f,t_azi04)      #MOD-C70266 add
           LET l_api.api05 =l_api.api05f * l_apa14
           LET l_api.api05 = cl_digcut(l_api.api05,g_azi04)
        ELSE
      #---------------------------------MOD-B90164---------------------------end
           LET l_api.api05f=g_apb[l_ac].apb09 * l_apb23
           LET l_api.api05 =l_api.api05f * l_apa14    #MOD-8B0149        #MOD-9B0054 add
           LET l_api.api05f = cl_digcut(l_api.api05f,t_azi04)            #MOD-C70266 add
           LET l_api.api05 = cl_digcut(l_api.api05,g_azi04)              #MOD-C70266 add
        END IF                                                           #MOD-B90164 add
     END IF
     IF g_aptype = '11' OR g_aptype='16' THEN   #MOD-960328 add
        #aapt160/aapt260暫估金額
        SELECT apb10,apb24 INTO l_apb10_unap1,l_apb24_unap1
          FROM apa_file,apb_file
         WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
           AND (apa00 = '16' OR apa00 = '26') AND apa01 = apb01
        IF cl_null(l_apb10_unap1) THEN LET l_apb10_unap1 = 0 END IF     
        IF cl_null(l_apb24_unap1) THEN LET l_apb24_unap1 = 0 END IF          
        
        SELECT SUM(apb24) INTO l_apb24_unap
          FROM apa_file,apb_file
         WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
           AND (apa00 = '11' OR apa00 = '12') AND apa01 = apb01 AND apa41 = 'Y'
           AND apb34='Y' #MOD-9A0147        
        #抓原先暫估單的匯率
        SELECT apa14 INTO l_apa14 FROM apa_file,apb_file
         WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
           AND (apa00 = '16' OR apa00 = '26') AND apa01 = apb01
        IF cl_null(l_apa14) THEN LET l_apa14 = 1 END IF
        LET l_apb10_unap = l_apb24_unap * l_apa14
        IF cl_null(l_apb10_unap) THEN LET l_apb10_unap = 0 END IF     
        IF cl_null(l_apb24_unap) THEN LET l_apb24_unap = 0 END IF     
        LET l_apb10_unap = cl_digcut(l_apb10_unap,g_azi04)                 #MOD-C70266 add
     END IF   #MOD-960328 add
    #IF g_aptype = '12' THEN                        #CHI-A30023 mark
     IF g_aptype = '12' OR g_aptype = '21' THEN     #CHI-A30023 add
        #aapt160/aapt260暫估金額
       #----------------------MOD-D30078-------------------(S)
       #-MOD-D30078-mark-
       #SELECT apb10,apb24 INTO l_apb10_unap1,l_apb24_unap1
       #  FROM apa_file,apb_file
       # WHERE apb01 = g_apb[l_ac].apb21 AND apb02 = g_apb[l_ac].apb22 
       #   AND (apa00 = '16' OR apa00 = '26') AND apa01 = apb01
       #-MOD-D30078-mark-
        LET g_sql = "SELECT apa14,apb10,apb24 ",
                    "  FROM apa_file,apb_file ",
                    " WHERE apa00 IN ('16','26') ",
                    "   AND apa01 = apb01 "
        IF g_apa.apa58 = '2' THEN
           LET g_sql = g_sql," AND apb21 = '",g_apb[l_ac].apb21,"'",
                             " AND apb22 = '",g_apb[l_ac].apb22,"'"
        END IF
        IF g_apa.apa58 = '3' OR g_aptype = '12' THEN
           LET g_sql = g_sql," AND apb01 = '",g_apb[l_ac].apb21,"'",
                             " AND apb02 = '",g_apb[l_ac].apb22,"'"
        END IF
        CALL cl_replace_sqldb(g_sql) RETURNING g_sql
        CALL cl_parse_qry_sql(g_sql,g_plant_gl) RETURNING g_sql
        PREPARE t110_unap_p FROM g_sql
        DECLARE t110_unap_c CURSOR FOR t110_unap_p
        OPEN t110_unap_c
        FETCH t110_unap_c INTO l_apa14,l_apb10_unap1,l_apb24_unap1
        IF cl_null(l_apa14) THEN LET l_apa14 = 1 END IF
       #----------------------MOD-D30078-------------------(E)
        IF cl_null(l_apb10_unap1) THEN LET l_apb10_unap1 = 0 END IF     
        IF cl_null(l_apb24_unap1) THEN LET l_apb24_unap1 = 0 END IF          
       
       #aapt120/aapt210已確認沖暫估金額    
        SELECT SUM(apb24) INTO l_apb24_unap
          FROM apa_file,apb_file
        #WHERE apb01 = g_apb[l_ac].apb21 AND apb02 = g_apb[l_ac].apb22      #MOD-D30078 mark
        #  AND apa00 = '12' AND apa01 = apb01 AND apa41 = 'Y'               #MOD-D30078 mark
         WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22      #MOD-D30078 add
           AND apa00 IN ('12','21') AND apa01 = apb01 AND apa41 = 'Y'       #MOD-D30078 add
           AND apb34='Y' #MOD-9A0147        
        #抓原先暫估單的匯率
       #---------------MOD-D30078-------------------mark
       #SELECT apa14 INTO l_apa14 FROM apa_file,apb_file
       # WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
       #   AND (apa00 = '16' OR apa00 = '26') AND apa01 = apb01
       #IF cl_null(l_apa14) THEN LET l_apa14 = 1 END IF
       #---------------MOD-D30078-------------------mark
        LET l_apb10_unap = l_apb24_unap * l_apa14
        IF cl_null(l_apb10_unap) THEN LET l_apb10_unap = 0 END IF     
        IF cl_null(l_apb24_unap) THEN LET l_apb24_unap = 0 END IF     
        LET l_apb10_unap = cl_digcut(l_apb10_unap,g_azi04)                 #MOD-C70266 add
     END IF
       
     #aapt160/aapt260的金額-aapt110/aapt120已確認的金額
     LET l_apb10 = l_apb10_unap1 - l_apb10_unap
     LET l_apb24 = l_apb24_unap1 - l_apb24_unap
     IF cl_null(l_apb10) THEN LET l_apb10 = 0 END IF     
     IF cl_null(l_apb24) THEN LET l_apb24 = 0 END IF          
 
     IF NOT cl_null(l_apb24) AND l_api.api05f > l_apb24 THEN 
        LET l_api.api05f = l_apb24
     END IF 
     IF NOT cl_null(l_apb10) AND l_api.api05 > l_apb10 THEN 
        LET l_api.api05 = l_apb10
     END IF 

     IF g_apz.apz27 = 'Y' AND g_aza.aza17 != g_apa.apa13 THEN
        #應抓取暫估單aapt160的重評價匯率，而非沖暫估單的重評價匯率
        SELECT apa72 INTO l_apa72 FROM apa_file WHERE apa01=l_apa01
        IF cl_null(l_apa72) THEN LET l_apa72=1 END IF
        LET l_api.api05=l_api.api05f*l_apa72
        LET l_api.api05=cl_digcut(l_api.api05,g_azi04)
     END IF
     IF g_apz.apz27 != 'Y' AND g_aza.aza17 != g_apa.apa13 THEN
        #應抓取暫估單aapt160的匯率
        SELECT apa14 INTO l_apa14 FROM apa_file WHERE apa01=l_apa01
        IF cl_null(l_apa14) THEN LET l_apa14=1 END IF
        LET l_api.api05=l_api.api05f*l_apa14
        LET l_api.api05=cl_digcut(l_api.api05,g_azi04)
     END IF
     LET l_api.api06 = 'UNAP:',l_apa01
     LET l_api.api07 =l_apa22
     LET l_api.api930=l_apa930   #CHI-8C0005 add
     LET l_api.api26 =l_apa01
    #LET l_api.api40 =1   #MOD-F30090 mark
    #MOD-F30090---add---str--
     SELECT apb02 INTO l_apb02 
       FROM apb_file,apa_file
      WHERE COALESCE(apb21,apb01) = g_apb[l_ac].apb21
        AND COALESCE(apb22,apb02) = g_apb[l_ac].apb22
        AND apb01 = apa01
        AND apa01 = l_apa01
     LET l_api.api40 = l_apb02
    #MOD-F30090---add---end--
     LET l_api.api35 = g_apb[l_ac].apb36
     LET l_api.api36 = g_apb[l_ac].apb31
     LET l_api.apilegal = g_legal #FUN-980001 add
     INSERT INTO api_file VALUES(l_api.*)
     IF STATUS OR SQLCA.SQLCODE THEN
        CALL cl_err3("ins","api_file",l_api.api01,l_api.api02,SQLCA.sqlcode,"","ins api",1)
        LET g_success='N'
     END IF
  END IF
 
  IF p_cmd = 'd' THEN
     DELETE FROM api_file
      WHERE api01=g_apa.apa01 AND api02='2' AND api03=g_apb_t.apb02
     IF STATUS OR SQLCA.SQLCODE THEN
        CALL cl_err3("del","api_file",g_apa.apa01,g_apb_t.apb02,SQLCA.sqlcode,"","del api",1)
        LET g_success='N'
     END IF
  END IF
  
  IF p_cmd = 'u' THEN
     SELECT * INTO l_api.* FROM api_file
      WHERE api01=g_apa.apa01 AND api02='2' AND api03=g_apb_t.apb02
        LET l_api.api03 = g_apb[l_ac].apb02
     LET l_apa01=t110_set_apb01_unap(g_apb[l_ac].apb21,g_apb[l_ac].apb22,'Y')
     IF g_aptype = '12' OR 
       (g_aptype='21' AND g_apa.apa58='3') THEN  
        SELECT apa54,apa541,apa22,apb08,apb09,apb23,apa930,apa14
          INTO l_apa54,l_apa541,l_apa22,l_apb08,l_apb09,l_apb23,l_apa930,l_apa14
          FROM apa_file,apb_file
         WHERE apa01 = apb01 AND apa01=l_apa01
           AND apb01 = g_apb[l_ac].apb21           #MOD-D30078 add
           AND apb02 = g_apb[l_ac].apb22
        LET l_apb09=g_apb[l_ac].apb09   #數量
        LET l_apb23=g_apb[l_ac].apb23   #原幣單價
        LET l_apb08=g_apb[l_ac].apb08   #本幣單價
     ELSE
        SELECT apa54,apa541,apa22,apb08,apb23,apa14
          INTO l_apa54,l_apa541,l_apa22,l_apb08,l_apb23,l_apa14
          FROM apa_file,apb_file
         WHERE apa01 = apb01 AND apa01=l_apa01
           AND apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
     END IF    #MOD-9B0054 add
        IF cl_null(l_apb08) THEN LET l_apb08 = 0 END IF
        IF cl_null(l_apb23) THEN LET l_apb23 = 0 END IF
 
        INITIALIZE l_api.* TO NULL
        LET l_api.api01 =g_apa.apa01
        LET l_api.api02 ='2'
        LET l_api.api03 =g_apb[l_ac].apb02
        LET l_api.api04 =l_apa54
        LET l_api.api041=l_apa541
        IF cl_null(g_apb[l_ac].apb09) OR g_apb[l_ac].apb09 = 0 THEN
           LET l_api.api05f = g_apb[l_ac].apb24
          #寫入api_file的api05時,應該寫入aapt160的原始本幣金額
           IF g_aptype = '11' OR g_aptype='16' THEN
              SELECT apb10 INTO l_api.api05 FROM apa_file,apb_file
               WHERE apa01 = apb01             AND (apa00 = '16' OR apa00 = '26')
                 AND apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
           END IF
           IF g_aptype = '12' THEN
              SELECT apb10 INTO l_api.api05 FROM apa_file,apb_file
               WHERE apa01 = apb01             AND (apa00 = '16' OR apa00 = '26')
                 AND apb01 = g_apb[l_ac].apb21 AND apb02 = g_apb[l_ac].apb22
           END IF
           IF cl_null(l_api.api05) THEN
              LET l_api.api05  = g_apb[l_ac].apb10
           END IF
        ELSE
           LET l_api.api05f=g_apb[l_ac].apb09 * l_apb23
           LET l_api.api05 =l_api.api05f * l_apa14    #MOD-8B0149   #MOD-9B0054 g_apa.apa14 modify l_apa14
           LET l_api.api05f = cl_digcut(l_api.api05f,t_azi04)         #MOD-C70266 add
           LET l_api.api05 = cl_digcut(l_api.api05,g_azi04)           #MOD-C70266 add
        END IF
        IF g_aptype = '11' OR g_aptype='16' THEN   #MOD-960328 add
           #aapt160/aapt260暫估金額
           #SELECT apb10,apb24 INTO l_apb10_unap1,l_apb24_unap1
           SELECT apb10,apb24,apb09 INTO l_apb10_unap1,l_apb24_unap1
             FROM apa_file,apb_file
            WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
              AND (apa00 = '16' OR apa00 = '26') AND apa01 = apb01
           IF cl_null(l_apb10_unap1) THEN LET l_apb10_unap1 = 0 END IF     
           IF cl_null(l_apb24_unap1) THEN LET l_apb24_unap1 = 0 END IF          
          
           #SELECT SUM(apb24) INTO l_apb24_unap
            SELECT SUM(apb24),SUM(apb09) INTO l_apb24_unap
             FROM apa_file,apb_file
            WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
              AND (apa00 = '11' OR apa00 = '12') AND apa01 = apb01 AND apa41 = 'Y'
              AND apb34='Y' #MOD-9A0147    
       
           #抓原先暫估單的匯率
           SELECT apa14 INTO l_apa14 FROM apa_file,apb_file
            WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
              AND (apa00 = '16' OR apa00 = '26') AND apa01 = apb01
           IF cl_null(l_apa14) THEN LET l_apa14 = 1 END IF
           LET l_apb10_unap = l_apb24_unap * l_apa14
           IF cl_null(l_apb10_unap) THEN LET l_apb10_unap = 0 END IF     
           IF cl_null(l_apb24_unap) THEN LET l_apb24_unap = 0 END IF     
           LET l_apb10_unap = cl_digcut(l_apb10_unap,g_azi04)                 #MOD-C70266 add
        END IF   #MOD-960328 add
       #--------------------------MOD-D30078-------------------(S)
       #--MOD-D30078--mark
       #IF g_aptype = '12' THEN                    
       #  #aapt160/aapt260暫估金額
       #   SELECT apb10,apb24 INTO l_apb10_unap1,l_apb24_unap1
       #     FROM apa_file,apb_file
       #    WHERE apb01 = g_apb[l_ac].apb21 AND apb02 = g_apb[l_ac].apb22 
       #      AND (apa00 = '16' OR apa00 = '26') AND apa01 = apb01
       #--MOD-D30078--mark
        IF g_aptype = '12' OR g_aptype = '21' THEN 
          #aapt160/aapt260暫估金額
           LET g_sql = "SELECT apa14,apb10,apb24 ",
                       "  FROM apa_file,apb_file ",
                       " WHERE apa00 IN ('16','26') ",
                       "   AND apa01 = apb01 "
           IF g_apa.apa58 = '2' THEN
              LET g_sql = g_sql," AND apb21 = '",g_apb[l_ac].apb21,"'",
                                " AND apb22 = '",g_apb[l_ac].apb22,"'"
           END IF
           IF g_apa.apa58 = '3' OR g_aptype = '12' THEN
              LET g_sql = g_sql," AND apb01 = '",g_apb[l_ac].apb21,"'",
                                " AND apb02 = '",g_apb[l_ac].apb22,"'"
           END IF
           CALL cl_replace_sqldb(g_sql) RETURNING g_sql
           CALL cl_parse_qry_sql(g_sql,g_plant_gl) RETURNING g_sql
           PREPARE t110_unap_p2 FROM g_sql
           DECLARE t110_unap_c2 CURSOR FOR t110_unap_p2
           OPEN t110_unap_c2
           FETCH t110_unap_c2 INTO l_apa14,l_apb10_unap1,l_apb24_unap1 
           IF cl_null(l_apa14) THEN LET l_apa14 = 1 END IF
       #--------------------------MOD-D30078-------------------(E)
           IF cl_null(l_apb10_unap1) THEN LET l_apb10_unap1 = 0 END IF     
           IF cl_null(l_apb24_unap1) THEN LET l_apb24_unap1 = 0 END IF          
          
           #aapt110/aapt120已確認沖暫估金額
           SELECT SUM(apb24) INTO l_apb24_unap
             FROM apa_file,apb_file
           #WHERE apb01 = g_apb[l_ac].apb21 AND apb02 = g_apb[l_ac].apb22 #MOD-D30078 mark
            WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22 #MOD-D30078 add
              AND apa00 = '12' AND apa01 = apb01 AND apa41 = 'Y'
              AND apb34='Y' #MOD-9A0147        
           #抓原先暫估單的匯率
          #--MOD-D30078--mark
          #SELECT apa14 INTO l_apa14 FROM apa_file,apb_file
          # WHERE apb21 = g_apb[l_ac].apb21 AND apb22 = g_apb[l_ac].apb22
          #   AND (apa00 = '16' OR apa00 = '26') AND apa01 = apb01
          #IF cl_null(l_apa14) THEN LET l_apa14 = 1 END IF
          #--MOD-D30078--mark
           LET l_apb10_unap = l_apb24_unap * l_apa14
           IF cl_null(l_apb10_unap) THEN LET l_apb10_unap = 0 END IF     
           IF cl_null(l_apb24_unap) THEN LET l_apb24_unap = 0 END IF     
           LET l_apb10_unap = cl_digcut(l_apb10_unap,g_azi04)                 #MOD-C70266 add
        END IF
        #aapt160/aapt260的金額-aapt110/aapt120已確認的金額
        LET l_apb10 = l_apb10_unap1 - l_apb10_unap
        LET l_apb24 = l_apb24_unap1 - l_apb24_unap

        IF cl_null(l_apb10) THEN LET l_apb10 = 0 END IF     
        IF cl_null(l_apb24) THEN LET l_apb24 = 0 END IF          

        IF NOT cl_null(l_apb24) AND l_api.api05f > l_apb24 THEN 
           LET l_api.api05f = l_apb24
        END IF 
        IF NOT cl_null(l_apb10) AND l_api.api05 > l_apb10 THEN 
           LET l_api.api05 = l_apb10
        END IF 

        
        LET l_api.api06 = 'UNAP:',l_apa01
        LET l_api.api07 =l_apa22
        LET l_api.api26 =l_apa01
        #LET l_api.api40 =1   #MOD-F30090 mark
        #MOD-F30090---add---str--
        SELECT apb02 INTO l_apb02
          FROM apb_file,apa_file
         WHERE COALESCE(apb21,apb01) = g_apb[l_ac].apb21
           AND COALESCE(apb22,apb02) = g_apb[l_ac].apb22
           AND apb01 = apa01
           AND apa01 = l_apa01
        LET l_api.api40 = l_apb02
       #MOD-F30090---add---end--
        LET l_api.apilegal = g_legal #MOD-A60160
     UPDATE api_file SET api_file.* = l_api.*
      WHERE api01 = g_apa.apa01
        AND api02 = '2'
        AND api03 = g_apb_t.apb02
     IF STATUS OR SQLCA.SQLCODE THEN
        CALL cl_err3("upd","api_file",l_api.api01,l_api.api02,SQLCA.sqlcode,"","upd api",1)
        LET g_success='N'
     END IF
  END IF
#No.MOD-AC0034 --begin                                                          
  CALL t110_api_upd()                                                           
#No.MOD-AC0034 --end 
  CALL t110_api_diff()    #yinhy140107
END FUNCTION
 
FUNCTION t110_api_diff()
  DEFINE l_apa60     LIKE apa_file.apa60
  DEFINE l_apa60f    LIKE apa_file.apa60f
  DEFINE l_apa31     LIKE apa_file.apa31
  DEFINE l_apa31f    LIKE apa_file.apa31f
  DEFINE l_apa33     LIKE apa_file.apa33
  DEFINE l_apa33f    LIKE apa_file.apa33f
  DEFINE l_apb10     LIKE apb_file.apb10
  DEFINE l_apb24     LIKE apb_file.apb24
  DEFINE l_amt       LIKE apa_file.apa31
  DEFINE l_amtf      LIKE apa_file.apa31f
  DEFINE l_api05     LIKE api_file.api05
  DEFINE l_api05f    LIKE api_file.api05f
  DEFINE l_api       RECORD LIKE api_file.*
  DEFINE l_cnt       LIKE type_file.num5
 
   IF g_apa.apa56 != '5' THEN   #CHI-930001 add
      #check 若單身沒有apb34='Y'的資料,則要delete完api02='2'的單據
      LET l_cnt = 0
      SELECT COUNT(*) INTO l_cnt FROM apb_file
       WHERE apb01 = g_apa.apa01
         AND apb34 = 'Y'
      IF l_cnt = 0 THEN   #MOD-810242                                                      #MOD-920381
         DELETE FROM api_file WHERE api01=g_apa.apa01 AND api02='2'
         RETURN
      END IF
   END IF   #CHI-930001 add
 
   LET l_apa60  = 0 LET l_apa60f = 0 
   SELECT apa60f,apa60,apa31,apa31f,apa33,apa33f
     INTO l_apa60f,l_apa60,l_apa31,l_apa31f,l_apa33,l_apa33f
     FROM apa_file WHERE apa01 = g_apa.apa01
   IF cl_null(l_apa60f) THEN LET l_apa60f = 0 END IF
   IF cl_null(l_apa60)  THEN LET l_apa60 = 0 END IF
   LET l_apb10 = 0 LET l_apb24 = 0
   SELECT SUM(apb10),SUM(apb24) INTO l_apb10,l_apb24 FROM apb_file
    WHERE apb01=g_apa.apa01
      AND apb34='N'
   IF cl_null(l_apb10) THEN LET l_apb10=0 END IF
   IF cl_null(l_apb24) THEN LET l_apb24=0 END IF
   LET l_apa31 = g_apa.apa31                        #MOD-C20206 add
   LET l_amt  = l_apa31 - l_apb10 - l_apa33
   LET l_amtf = l_apa31f- l_apb24 - l_apa33f
   SELECT SUM(api05f),SUM(api05) INTO l_api05f,l_api05
     FROM api_file
    WHERE api01 = g_apa.apa01 AND api02 = '2'
   IF cl_null(l_api05)  THEN LET l_api05  = 0 END IF
   IF cl_null(l_api05f) THEN LET l_api05f = 0 END IF
   LET l_api05 = cl_digcut(l_api05 ,g_azi04)            #No.TQC-810091
   LET l_api05f= cl_digcut(l_api05f,t_azi04)            #No.TQC-810091
   IF l_api05 = l_amt AND l_api05f = l_amtf THEN
      RETURN
   ELSE
      DELETE FROM api_file
       WHERE api01=g_apa.apa01 AND api02='2' AND api26 = 'DIFF'
      SELECT SUM(api05f),SUM(api05) INTO l_api05f,l_api05
        FROM api_file
       WHERE api01 = g_apa.apa01 AND api02 = '2'
      IF cl_null(l_api05)  THEN LET l_api05  = 0 END IF
      IF cl_null(l_api05f) THEN LET l_api05f = 0 END IF
      LET l_api05 = cl_digcut(l_api05 ,g_azi04)            #No.TQC-810091
      LET l_api05f= cl_digcut(l_api05f,t_azi04)            #No.TQC-810091
      INITIALIZE l_api.* TO NULL
      SELECT MAX(api03)+1 INTO l_api.api03 FROM api_file
       WHERE api01=g_apa.apa01 AND api02='2'
      IF g_apz.apz13 = 'Y' THEN
         SELECT * INTO g_aps.* FROM aps_file WHERE aps01 = g_apa.apa22
      ELSE
         SELECT * INTO g_aps.* FROM aps_file WHERE (aps01 = ' ' OR aps01 IS NULL)
      END IF
      LET l_api.api01 =g_apa.apa01
      LET l_api.api02 ='2'
      LET l_api.api04 =g_aps.aps44        #MOD-B40087 mark  #MOD-B80270 還原mark
      LET l_api.api041=g_aps.aps441       #MOD-B40087 mark  #MOD-B80270 還原mark
      LET l_api.api05f=l_amtf - l_api05f
      LET l_api.api05 =l_amt - l_api05
     #No.MOD-B80270 --Mark Begin
     #-MOD-B40087-add-
     # IF l_api.api05 > 0 THEN
     #    LET l_api.api04  = g_aps.aps43 
     #    LET l_api.api041 = g_aps.aps431
     # END IF
     # IF l_api.api05 < 0 THEN
     #    LET l_api.api04  = g_aps.aps42 
     #    LET l_api.api041 = g_aps.aps421
     # END IF
     #-MOD-B40087-end-
     #No.MOD-B80270 --Mark End
      LET l_api.api06 = 'UNAP:DIFF'
      LET l_api.api07 =g_apa.apa22
      LET l_api.api930=g_apa.apa930   #CHI-8C0005 add
      LET l_api.api26 ='DIFF'
      LET l_api.api40 =NULL
      IF l_api.api05f = 0 AND l_api.api05 = 0 THEN
         RETURN
      END IF
      LET l_api05 = cl_digcut(l_api05 ,g_azi04)            #No.TQC-810091
      LET l_api05f= cl_digcut(l_api05f,t_azi04)            #No.TQC-810091
      LET l_api.api35 = ' '
      LET l_api.api36 = ' '
      LET l_api.apilegal = g_legal #FUN-980001 add
      INSERT INTO api_file VALUES(l_api.*)
      IF STATUS OR SQLCA.SQLCODE THEN
         CALL cl_err3("ins","api_file",l_api.api01,l_api.api02,SQLCA.sqlcode,"","ins api",1)
         LET g_success='N'
      END IF
   END IF
      
END FUNCTION
 
FUNCTION t110_apa65f(p_apa37f,p_apa37)
DEFINE   p_apa37f         LIKE apa_file.apa37f
DEFINE   p_apa37          LIKE apa_file.apa37
 
    UPDATE apa_file SET apa65f = p_apa37f,apa65 = p_apa37
     WHERE apa01 = g_apa.apa01   
    LET g_apa.apa65f = p_apa37f
    LET g_apa.apa65  = p_apa37
    DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
 
END FUNCTION
FUNCTION t110_apx03_unpay(p_apx03)
DEFINE   p_apx03         LIKE apx_file.apx03
DEFINE   l_apx04f        LIKE apx_file.apx04f
DEFINE   l_apx04         LIKE apx_file.apx04
DEFINE   l_apa73f        LIKE apa_file.apa73
DEFINE   l_apa73         LIKE apa_file.apa73
 
         SELECT SUM(apx04f),SUM(apx04) INTO l_apx04f,l_apx04 FROM apx_file,apa_file
          WHERE apa01 = apx01
            AND apx01 <> g_apa.apa01
            AND apx03 = p_apx03
            AND apa63 = '0'
         IF cl_null(l_apx04f) THEN LET l_apx04f = 0 END IF
         IF cl_null(l_apx04)  THEN LET l_apx04  = 0 END IF
         SELECT apa34f-apa35f,apa34-apa35 INTO l_apa73f,l_apa73
           FROM apa_file
          WHERE apa01 = p_apx03 
         IF cl_null(l_apa73f) THEN LET l_apa73f = 0 END IF
         IF cl_null(l_apa73)  THEN LET l_apa73  = 0 END IF
         LET l_apa73f = l_apa73f - l_apx04f 
         LET l_apa73  = l_apa73  - l_apx04  
         IF l_apa73f < 0 THEN LET l_apa73f = 0 END IF
         IF l_apa73  < 0 THEN LET l_apa73  = 0 END IF
 
         RETURN l_apa73f,l_apa73
END FUNCTION
 
FUNCTION t110_proj()
  DEFINE l_apb25   LIKE apb_file.apb25    #MOD-920170 add
  DEFINE l_apb251  LIKE apb_file.apb251   #MOD-920170 add
  DEFINE l_azf141  LIKE azf_file.azf141   #FUN-B80058
  DEFINE l_pmn67   LIKE pmn_file.pmn67    #MOD-BC0239 add
  DEFINE l_aag21   LIKE aag_file.aag21    #MOD-BC0239 add
  DEFINE l_aag211  LIKE aag_file.aag21    #MOD-BC0239 add
 
  IF cl_null(g_apb[l_ac].apb06) OR cl_null(g_apb[l_ac].apb07) THEN
     RETURN
  END IF
 
  LET l_sql = "SELECT pmn122,pmn96,pmn98,pmn40,pmn401,pmn67 ",             #MOD-BC0239 add pmn67
             #"  FROM ",li_dbs CLIPPED,"pmn_file ",
              "  FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'), #FUN-A50102
              " WHERE pmn01 = '",g_apb[l_ac].apb06,"' ",
              "   AND pmn02 = '",g_apb[l_ac].apb07,"' "
  CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
  CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102          
  PREPARE sel_pmm122_pre FROM l_sql
  DECLARE sel_pmm122_cs CURSOR FOR sel_pmm122_pre
  OPEN sel_pmm122_cs
  FETCH sel_pmm122_cs INTO g_apb[l_ac].apb35,g_apb[l_ac].apb36,
                           g_apb[l_ac].apb31,l_apb25,l_apb251,             
                           l_pmn67                                           #MOD-BC0239 add
  IF SQLCA.sqlcode THEN
     LET g_apb[l_ac].apb35 = ' '
     LET g_apb[l_ac].apb36 = ' '
     LET g_apb[l_ac].apb31 = ' '
  END IF
  IF NOT cl_null(g_apb[l_ac].apb31) AND g_apb[l_ac].apb31 <> ' ' THEN
     IF cl_null(g_apb[l_ac].apb25) THEN
        LET l_azf141 = ''    #FUN-B80058
        #LET l_sql = "SELECT azf14 FROM ",li_dbs CLIPPED,"azf_file ",
        #LET l_sql = "SELECT azf14 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'azf_file'), #FUN-A50102
        LET l_sql = "SELECT azf14,azf141 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'azf_file'),  #FUN-B80058
                    " WHERE azf01='",g_apb[l_ac].apb31,"' ",
                    "   AND azf02='2' AND azfacti='Y' "
        CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	    CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102             
        PREPARE sel_azf14_pre FROM l_sql
        DECLARE sel_azf14_cs CURSOR FOR sel_azf14_pre
        OPEN sel_azf14_cs 
        #FETCH sel_azf14_cs INTO g_apb[l_ac].apb25
        FETCH sel_azf14_cs INTO g_apb[l_ac].apb25,l_azf141  #FUN-B80058
     END IF
     IF g_aza.aza63='Y' AND cl_null(g_apb[l_ac].apb251) THEN
        #LET g_apb[l_ac].apb251 = g_apb[l_ac].apb25
        LET g_apb[l_ac].apb251 = l_azf141  #FUN-B80058
     END IF
     DISPLAY BY NAME g_apb[l_ac].apb25,g_apb[l_ac].apb251
  END IF
  IF cl_null(g_apb[l_ac].apb25) THEN
     LET g_apb[l_ac].apb25 = l_apb25
     DISPLAY BY NAME g_apb[l_ac].apb25
  END IF
  IF cl_null(g_apb[l_ac].apb251) THEN
     LET g_apb[l_ac].apb251 = l_apb251
     DISPLAY BY NAME g_apb[l_ac].apb251
  END IF
  #----------------------------MOD-BC0239-----------------start
   SELECT aag21 INTO l_aag21 FROM aag_file
    WHERE aag01 = g_apb[l_ac].apb25
      AND aag00 = g_bookno1
      AND aagacti = 'Y'
   IF l_aag21 = 'Y' THEN
      LET g_apb[l_ac].apb26=l_pmn67
      DISPLAY BY NAME g_apb[l_ac].apb26
   END IF
   SELECT aag21 INTO l_aag211 FROM aag_file
    WHERE aag01 = g_apb[l_ac].apb251
      AND aag00 = g_bookno2
      AND aagacti = 'Y'
   IF l_aag211 = 'Y' THEN
      LET g_apb[l_ac].apb26=l_pmn67
      DISPLAY BY NAME g_apb[l_ac].apb26
   END IF
  #----------------------------MOD-BC0239-------------------end
  IF NOT cl_null(g_apb[l_ac].apb25) THEN
     #LET l_sql = "SELECT aag02 FROM ",li_dbs CLIPPED,"aag_file ",
     LET l_sql = "SELECT aag02 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'aag_file'), #FUN-A50102
                 " WHERE aag01='",g_apb[l_ac].apb25,"' ",
                 "   AND aag00='",g_bookno1,"' ",
                 "   AND aagacti = 'Y'"                        #No.MOD-B70280 add
     CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	 CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
     PREPARE sel_aag02_pre FROM l_sql
     DECLARE sel_aag02_cs CURSOR FOR sel_aag02_pre
     OPEN sel_aag02_cs
     FETCH sel_aag02_cs INTO g_apb[l_ac].b25
     IF SQLCA.sqlcode THEN
        LET g_apb[l_ac].b25 = NULL 
     END IF
     DISPLAY BY NAME g_apb[l_ac].b25
  END IF
  IF NOT cl_null(g_apb[l_ac].apb251) THEN
     #LET l_sql = "SELECT aag02 FROM ",li_dbs CLIPPED,"aag_file ",
     LET l_sql = "SELECT aag02 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'aag_file'), #FUN-A50102
                 " WHERE aag01='",g_apb[l_ac].apb251,"' ",
                 "   AND aag00='",g_bookno2,"' ",
                 "   AND aagacti = 'Y'"                        #No.MOD-B70280 add
                 
     IF SQLCA.sqlcode THEN
        LET g_apb[l_ac].b251 = NULL 
     END IF
     DISPLAY BY NAME g_apb[l_ac].b251
  END IF
  
  DISPLAY BY NAME g_apb[l_ac].apb35,g_apb[l_ac].apb36,g_apb[l_ac].apb31
END FUNCTION
 
FUNCTION t110_sheet(l_cmd)
   DEFINE l_cmd LIKE type_file.chr1
   IF l_cmd = '0' THEN
      IF NOT cl_null(g_apa.apa99) AND cl_null(g_apa.apa44) THEN  
         #CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02b,1,'N','0',g_apz.apz02p)           #MOD-C50105 mark
         CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02b,1,g_apa.apa41,'0',g_apz.apz02p)    #MOD-C50105
      ELSE
         IF g_apa.apa63 MATCHES '[Ss]' THEN                                       #MOD-BB0304
            CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02b,1,'Y','0',g_apz.apz02p) #MOD-BB0304 
         ELSE                                                                     #MOD-BB0304
            CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02b,1,g_apa.apa41,'0',g_apz.apz02p)    #No.FUN-680029
         END IF                                                                   #MOD-BB0304
      END IF
   ELSE
      IF NOT cl_null(g_apa.apa99) AND cl_null(g_apa.apa44) THEN  
         #CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02c,1,'N','1',g_apz.apz02p)           #MOD-C50105
         CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02c,1,g_apa.apa41,'1',g_apz.apz02p)    #MOD-C50105
      ELSE
         IF g_apa.apa63 MATCHES '[Ss]' THEN                                       #MOD-BB0304
            CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02c,1,'Y','1',g_apz.apz02p) #MOD-BB0304
         ELSE                                                                     #MOD-BB0304
            CALL s_fsgl('AP',1,g_apa.apa01,0,g_apz.apz02c,1,g_apa.apa41,'1',g_apz.apz02p) 
         END IF                                                                   #MOD-BB0304
      END IF
   END IF
END FUNCTION
 
FUNCTION t110_bud(p_cmd,p_flag)
  DEFINE p_cmd       LIKE type_file.chr1
  DEFINE p_flag      LIKE type_file.chr1
  DEFINE p_sum1      LIKE afc_file.afc06 
  DEFINE p_sum2      LIKE afc_file.afc06 
  DEFINE l_flag      LIKE type_file.num5
  DEFINE l_msg       LIKE ze_file.ze03
  DEFINE l_over      LIKE afc_file.afc07
  DEFINE l_afb07     LIKE afb_file.afb07
  DEFINE l_cmd       LIKE type_file.chr1
  DEFINE bamt1       LIKE afc_file.afc07
  DEFINE bamt2       LIKE afc_file.afc07
  DEFINE bamt3       LIKE afc_file.afc07
  DEFINE bamt4       LIKE afc_file.afc07
  DEFINE bamt5       LIKE afc_file.afc07
  DEFINE bamt6       LIKE afc_file.afc07
  DEFINE l_cnt       LIKE type_file.num5
  DEFINE l_year      LIKE type_file.num5  #MOD-A30113 add
  DEFINE l_month     LIKE type_file.num5  #MOD-A30113 add
  DEFINE l_aag21     LIKE aag_file.aag21  #MOD-AB0132  
 
  LET g_errno = ''
 #IF cl_null(g_apy.apydmy5) or g_apy.apydmy5 = 'N' THEN RETURN END IF #MOD-8C0272  #No.MOD-910021 mark #CHI-AA0028 mark
 
  IF g_aza.aza08 = 'N' THEN
     LET g_apb[l_ac].apb36 = ' '
     LET g_apb[l_ac].apb35 = ' '
  END IF
  IF cl_null(g_apb[l_ac].apb26) THEN LET g_apb[l_ac].apb26=' ' END IF   #MOD-B40117 add
  IF g_bookno1 IS NULL OR g_apb[l_ac].apb31 IS NULL OR
     g_apb[l_ac].apb25 IS NULL OR YEAR(g_apa.apa02) IS NULL OR 
     g_apb[l_ac].apb36 IS NULL OR g_apb[l_ac].apb26 IS NULL OR 
     g_apb[l_ac].apb35 IS NULL OR MONTH(g_apa.apa02) IS NULL THEN
     RETURN
  END IF
  IF g_aaz.aaz90 = 'Y' THEN
     IF g_apb[l_ac].apb930 IS NULL THEN
        RETURN
     END IF
  END IF
  IF g_aza.aza63 = 'Y' THEN
     IF g_bookno2 IS NULL OR g_apb[l_ac].apb251 THEN
        RETURN
     END IF
  END IF
 
 #-MOD-B10016-add-
  IF cl_null(g_apb[l_ac].apb25) THEN
     RETURN
  END IF
 #-MOD-B10016-end-

  #-MOD-AB0132-add-
   SELECT aag21 INTO l_aag21 FROM aag_file
    WHERE aag01 = g_apb[l_ac].apb25 
      AND aag00 = g_bookno1    
      AND aagacti = 'Y'                         #No.MOD-B70280 add
   IF l_aag21 = 'N' OR cl_null(l_aag21) THEN  #No.TQC-B60324 add OR cl_null(l_aag21)       
      RETURN
   END IF
   IF g_aza.aza63 = 'Y' THEN
     #-MOD-B10016-add-
      IF cl_null(g_apb[l_ac].apb251) THEN
         RETURN
      END IF
     #-MOD-B10016-end-
      SELECT aag21 INTO l_aag21 FROM aag_file
       WHERE aag01 = g_apb[l_ac].apb251 
         AND aag00 = g_bookno2     
         AND aagacti = 'Y'                         #No.MOD-B70280 add
      IF l_aag21 = 'N' THEN        
         RETURN
      END IF
   END IF
  #-MOD-AB0132-end-

  #新的預算
  IF g_apb[l_ac].apb31 <> g_apb_t.apb31  OR
     g_apb[l_ac].apb25 <> g_apb_t.apb25  OR
     g_apb[l_ac].apb36 <> g_apb_t.apb36  OR
     g_apb[l_ac].apb26 <> g_apb_t.apb26  OR
     g_apb[l_ac].apb35 <> g_apb_t.apb35  THEN
     LET l_cmd = 'a' 
  END IF
  IF g_aaz.aaz90 = 'Y' THEN
     IF g_apb[l_ac].apb930 <> g_apb_t.apb930 THEN
        LET l_cmd = 'a'
     END IF
  END IF
  IF g_aza.aza63 = 'Y' THEN
     IF g_apb[l_ac].apb251 <> g_apb_t.apb251 THEN
        LET l_cmd = 'a'
     END IF
  END IF
  #和apmt540類似,因為KEYIN時,可能與'耗用3:PO已確認且PO未結案且未轉應付的金額'
  #           和'耗用4:PO已立帳(立AP),但未拋傳票(未到總帳)的金額' 有重疊
  #           故根據不同的情況,要把這些數量減掉
  IF cl_null(g_apb[l_ac].apb06) AND cl_null(g_apb[l_ac].apb07) THEN
     IF p_cmd = 'a' OR l_cmd = 'a' THEN
        LET p_sum1 = 0
        LET p_sum2 = g_apb[l_ac].apb10
     ELSE
        LET p_sum1 = 0
        LET p_sum2 = g_apb[l_ac].apb10 - g_apb_t.apb10
     END IF
  ELSE
     IF p_cmd = 'a' OR l_cmd = 'a' THEN
        LET l_year = NULL      #MOD-A30113 add 
        LET l_month = NULL     #MOD-A30113 add  
        IF g_aaz.aaz90 = 'Y' THEN
          #MOD-A30113---modify---start---
          #CALL s_budamt1(g_bookno1,g_apb[l_ac].apb31,g_apb[l_ac].apb25,
          #               YEAR(g_apa.apa02),g_apb[l_ac].apb36,
          #               g_apb[l_ac].apb930,g_apb[l_ac].apb35,
          #               MONTH(g_apa.apa02),'0')
          #     RETURNING bamt1,bamt2,bamt3,bamt4,bamt5,bamt6
           CALL s_yp(g_apa.apa02) RETURNING l_year,l_month
           CALL s_budamt1(g_bookno1,g_apb[l_ac].apb31,g_apb[l_ac].apb25,
                          l_year,g_apb[l_ac].apb36,
                          g_apb[l_ac].apb930,g_apb[l_ac].apb35,
                          l_month,'0')
                RETURNING bamt1,bamt2,bamt3,bamt4,bamt5,bamt6
          #MOD-A30113---modify---end---
        ELSE
          #MOD-A30113---modify---start---
          #CALL s_budamt1(g_bookno1,g_apb[l_ac].apb31,g_apb[l_ac].apb25,
          #               YEAR(g_apa.apa02),g_apb[l_ac].apb36,
          #               g_apb[l_ac].apb26,g_apb[l_ac].apb35,
          #               MONTH(g_apa.apa02),'0')
          #     RETURNING bamt1,bamt2,bamt3,bamt4,bamt5,bamt6
           CALL s_yp(g_apa.apa02) RETURNING l_year,l_month
           CALL s_budamt1(g_bookno1,g_apb[l_ac].apb31,g_apb[l_ac].apb25,
                          l_year,g_apb[l_ac].apb36,
                          g_apb[l_ac].apb26,g_apb[l_ac].apb35,
                          l_month,'0')
                RETURNING bamt1,bamt2,bamt3,bamt4,bamt5,bamt6
          #MOD-A30113---modify---end---
        END IF
        IF cl_null(bamt3) THEN LET bamt3 = 0 END IF
        IF cl_null(bamt4) THEN LET bamt4 = 0 END IF
        #要確認目前是和耗用3還是耗用4重疊
        LET l_cnt = 0
       #FUN-A60056--mod--str--
       #SELECT COUNT(*) INTO l_cnt FROM pmn_file,pmm_file,pmk_file,pml_file
       # WHERE pmn01 = pmm01 
       #   AND pmn24 = pml01
       #   AND pmn25 = pml02
       #   AND pmk01 = pml01
       #   AND pmn01 = g_apb[l_ac].apb06
       #   AND pmn02 = g_apb[l_ac].apb07
        LET g_sql = "SELECT COUNT(*) ", 
                    "  FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'),",",
                    "       ",cl_get_target_table(g_apb[l_ac].apb37,'pmm_file'),",",
                   #"       ",cl_get_target_table(g_apb[l_ac].apb37,'pmk_file'),",",   #MOD-CB0094 mark
                   #"       ",cl_get_target_table(g_apb[l_ac].apb37,'pml_file'),       #MOD-CB0094 mark
                   #" WHERE pmn01 = pmm01 AND pmn24 = pml01",                          #MOD-CB0094 mark
                   #"   AND pmn25 = pml02 AND pmk01 = pml01",                          #MOD-CB0094 mark
                    " WHERE pmn01 = pmm01 ",                                           #MOD-CB0094 add
                    "   AND pmn01 = '",g_apb[l_ac].apb06,"'",
                    "   AND pmn02 = '",g_apb[l_ac].apb07,"'"
       CALL cl_replace_sqldb(g_sql) RETURNING g_sql
       CALL cl_parse_qry_sql(g_sql,g_apb[l_ac].apb37) RETURNING g_sql
       PREPARE sel_cou_pmk FROM g_sql
       EXECUTE sel_cou_pmk INTO l_cnt
       #FUN-A60056--mod--end
        IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
        IF l_cnt > 0 THEN  #耗用3
           LET p_sum1 = 0
           LET p_sum2 = g_apb[l_ac].apb10 - bamt3
        ELSE
           LET p_sum1 = 0
           LET p_sum2 = g_apb[l_ac].apb10 - bamt4
        END IF
     ELSE
        LET p_sum1 = 0
        LET p_sum2 = g_apb[l_ac].apb10 - g_apb_t.apb10
     END IF
  END IF
  IF cl_null(p_sum1) THEN LET p_sum1 = 0 END IF
  IF cl_null(p_sum2) THEN LET p_sum2 = 0 END IF
 
  IF p_flag = '1' OR p_flag = '3' THEN
     LET l_year = NULL      #MOD-A30113 add 
     LET l_month = NULL     #MOD-A30113 add  
     IF g_aaz.aaz90 = 'Y' THEN
       #MOD-A30113---modify---start---
       #CALL s_budchk1(g_bookno1,g_apb[l_ac].apb31,g_apb[l_ac].apb25,
       #               YEAR(g_apa.apa02),g_apb[l_ac].apb36,
       #               g_apb[l_ac].apb930,g_apb[l_ac].apb35,
       #               MONTH(g_apa.apa02),'0',p_cmd,p_sum1,p_sum2)
       #     RETURNING l_flag,l_afb07,l_over
        CALL s_yp(g_apa.apa02) RETURNING l_year,l_month
        CALL s_budchk1(g_bookno1,g_apb[l_ac].apb31,g_apb[l_ac].apb25,
                       l_year,g_apb[l_ac].apb36,
                       g_apb[l_ac].apb930,g_apb[l_ac].apb35,
                       l_month,'0',p_cmd,p_sum1,p_sum2)
             RETURNING l_flag,l_afb07,l_over
       #MOD-A30113---modify---end---
        IF l_flag = FALSE THEN
           LET l_msg = g_bookno1,'/',g_apb[l_ac].apb31,'/',g_apb[l_ac].apb25,'/',
                       YEAR(g_apa.apa02),'/',g_apb[l_ac].apb36,'/',
                       g_apb[l_ac].apb930,'/',g_apb[l_ac].apb35,'/',
                       MONTH(g_apa.apa02),'/',l_over
           CALL cl_err(l_msg,g_errno,1)
           RETURN
        ELSE
           IF l_afb07 = '2' AND l_over < 0 THEN
              LET l_msg = g_bookno1,'/',g_apb[l_ac].apb31,'/',g_apb[l_ac].apb25,'/',
                          YEAR(g_apa.apa02),'/',g_apb[l_ac].apb36,'/',
                          g_apb[l_ac].apb930,'/',g_apb[l_ac].apb35,'/',
                          MONTH(g_apa.apa02),'/',l_over
              CALL cl_err(l_msg,g_errno,1)
              LET g_errno = ' '
              RETURN
           END IF
        END IF
     ELSE
       #MOD-A30113---modify---start---
       #CALL s_budchk1(g_bookno1,g_apb[l_ac].apb31,g_apb[l_ac].apb25,
       #               YEAR(g_apa.apa02),g_apb[l_ac].apb36,
       #               g_apb[l_ac].apb26,g_apb[l_ac].apb35,
       #               MONTH(g_apa.apa02),'0',p_cmd,p_sum1,p_sum2)
       #     RETURNING l_flag,l_afb07,l_over
        CALL s_yp(g_apa.apa02) RETURNING l_year,l_month
        CALL s_budchk1(g_bookno1,g_apb[l_ac].apb31,g_apb[l_ac].apb25,
                       l_year,g_apb[l_ac].apb36,
                       g_apb[l_ac].apb26,g_apb[l_ac].apb35,
                       l_month,'0',p_cmd,p_sum1,p_sum2)
             RETURNING l_flag,l_afb07,l_over
       #MOD-A30113---modify---end---
        IF l_flag = FALSE THEN
           LET l_msg = g_bookno1,'/',g_apb[l_ac].apb31,'/',g_apb[l_ac].apb25,'/',
                       YEAR(g_apa.apa02),'/',g_apb[l_ac].apb36,'/',
                       g_apb[l_ac].apb26,'/',g_apb[l_ac].apb35,'/',
                       MONTH(g_apa.apa02),'/',l_over
           CALL cl_err(l_msg,g_errno,1)
           RETURN
        ELSE
           IF l_afb07 = '2' AND l_over < 0 THEN
              LET l_msg = g_bookno1,'/',g_apb[l_ac].apb31,'/',g_apb[l_ac].apb25,'/',
                          YEAR(g_apa.apa02),'/',g_apb[l_ac].apb36,'/',
                          g_apb[l_ac].apb26,'/',g_apb[l_ac].apb35,'/',
                          MONTH(g_apa.apa02),'/',l_over
              CALL cl_err(l_msg,g_errno,1)
              LET g_errno = ' '
              RETURN
           END IF
        END IF
     END IF
  END IF
 
  IF g_aza.aza63 = 'N' THEN RETURN END IF
  #和apmt540類似,因為KEYIN時,可能與'耗用3:PO已確認且PO未結案且未轉應付的金額'
  #           和'耗用4:PO已立帳(立AP),但未拋傳票(未到總帳)的金額' 有重疊
  #           故根據不同的情況,要把這些數量減掉
  IF cl_null(g_apb[l_ac].apb06) AND cl_null(g_apb[l_ac].apb07) THEN
     IF p_cmd = 'a' OR l_cmd = 'a' THEN
        LET p_sum1 = 0
        LET p_sum2 = g_apb[l_ac].apb10
     ELSE
        LET p_sum1 = 0
        LET p_sum2 = g_apb[l_ac].apb10 - g_apb_t.apb10
     END IF
  ELSE
     IF p_cmd = 'a' OR l_cmd = 'a' THEN
        LET l_year = NULL      #MOD-A30113 add 
        LET l_month = NULL     #MOD-A30113 add  
        IF g_aaz.aaz90 = 'Y' THEN
          #MOD-A30113---modify---start---
          #CALL s_budamt1(g_bookno2,g_apb[l_ac].apb31,g_apb[l_ac].apb251,
          #               YEAR(g_apa.apa02),g_apb[l_ac].apb36,
          #               g_apb[l_ac].apb930,g_apb[l_ac].apb35,
          #               MONTH(g_apa.apa02),'1')
          #     RETURNING bamt1,bamt2,bamt3,bamt4,bamt5,bamt6
           CALL s_yp(g_apa.apa02) RETURNING l_year,l_month
           CALL s_budamt1(g_bookno2,g_apb[l_ac].apb31,g_apb[l_ac].apb251,
                          l_year,g_apb[l_ac].apb36,
                          g_apb[l_ac].apb930,g_apb[l_ac].apb35,
                          l_month,'1')
                RETURNING bamt1,bamt2,bamt3,bamt4,bamt5,bamt6
          #MOD-A30113---modify---end---
        ELSE
          #MOD-A30113---modify---start---
          #CALL s_budamt1(g_bookno2,g_apb[l_ac].apb31,g_apb[l_ac].apb251,
          #               YEAR(g_apa.apa02),g_apb[l_ac].apb36,
          #               g_apb[l_ac].apb26,g_apb[l_ac].apb35,
          #               MONTH(g_apa.apa02),'1')
          #     RETURNING bamt1,bamt2,bamt3,bamt4,bamt5,bamt6
           CALL s_yp(g_apa.apa02) RETURNING l_year,l_month
           CALL s_budamt1(g_bookno2,g_apb[l_ac].apb31,g_apb[l_ac].apb251,
                          l_year,g_apb[l_ac].apb36,
                          g_apb[l_ac].apb26,g_apb[l_ac].apb35,
                          l_month,'1')
                RETURNING bamt1,bamt2,bamt3,bamt4,bamt5,bamt6
          #MOD-A30113---modify---end---
        END IF
        IF cl_null(bamt3) THEN LET bamt3 = 0 END IF
        IF cl_null(bamt4) THEN LET bamt4 = 0 END IF
        #要確認目前是和耗用3還是耗用4重疊
        LET l_cnt = 0
       #FUN-A60056--mod--str--
       #SELECT COUNT(*) INTO l_cnt FROM pmn_file,pmm_file,pmk_file,pml_file
       # WHERE pmn01 = pmm01 
       #   AND pmn24 = pml01
       #   AND pmn25 = pml02
       #   AND pmk01 = pml01
       #   AND pmn01 = g_apb[l_ac].apb06
       #   AND pmn02 = g_apb[l_ac].apb07
        LET g_sql = "SELECT COUNT(*) ",
                    "  FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'),",",
                    "       ",cl_get_target_table(g_apb[l_ac].apb37,'pmm_file'),",",
                    "       ",cl_get_target_table(g_apb[l_ac].apb37,'pmk_file'),",",
                    "       ",cl_get_target_table(g_apb[l_ac].apb37,'pml_file'),
                    " WHERE pmn01 = pmm01 AND pmn24 = pml01 ",
                    "   AND pmn25 = pml02 AND pmk01 = pml01 ",
                    "   AND pmn01 = '",g_apb[l_ac].apb06,"'",
                    "   AND pmn02 = '",g_apb[l_ac].apb07,"'"
        CALL cl_replace_sqldb(g_sql) RETURNING g_sql
        CALL cl_parse_qry_sql(g_sql,g_apb[l_ac].apb37) RETURNING g_sql
        PREPARE sel_pmk FROM g_sql
        EXECUTE sel_pmk INTO l_cnt
       #FUN-A60056--mod--end
        IF cl_null(l_cnt) THEN LET l_cnt = 0 END IF
        IF l_cnt > 0 THEN  #耗用3
           LET p_sum1 = 0
           LET p_sum2 = g_apb[l_ac].apb10 - bamt3
        ELSE
           LET p_sum1 = 0
           LET p_sum2 = g_apb[l_ac].apb10 - bamt4
        END IF
     ELSE
        LET p_sum1 = 0
        LET p_sum2 = g_apb[l_ac].apb10 - g_apb_t.apb10
     END IF
  END IF
  IF cl_null(p_sum1) THEN LET p_sum1 = 0 END IF
  IF cl_null(p_sum2) THEN LET p_sum2 = 0 END IF

  LET l_year = NULL      #MOD-A30113 add 
  LET l_month = NULL     #MOD-A30113 add  
 
  IF p_flag = '2' OR p_flag = '3' THEN
     IF g_aaz.aaz90 = 'Y' THEN
        IF g_bookno2 IS NULL OR g_apb[l_ac].apb31 IS NULL OR
           g_apb[l_ac].apb251 IS NULL OR YEAR(g_apa.apa02) IS NULL OR 
           g_apb[l_ac].apb36 IS NULL OR g_apb[l_ac].apb930 IS NULL OR 
           g_apb[l_ac].apb35 IS NULL OR MONTH(g_apa.apa02) IS NULL THEN
           RETURN
        END IF
       #MOD-A30113---modify---start---
       #CALL s_budchk1(g_bookno2,g_apb[l_ac].apb31,g_apb[l_ac].apb251,
       #               YEAR(g_apa.apa02),g_apb[l_ac].apb36, 
       #               g_apb[l_ac].apb930,g_apb[l_ac].apb35,
       #               MONTH(g_apa.apa02),'1',p_cmd,p_sum1,p_sum2)
       #     RETURNING l_flag,l_afb07,l_over
        CALL s_yp(g_apa.apa02) RETURNING l_year,l_month
        CALL s_budchk1(g_bookno2,g_apb[l_ac].apb31,g_apb[l_ac].apb251,
                       l_year,g_apb[l_ac].apb36, 
                       g_apb[l_ac].apb930,g_apb[l_ac].apb35,
                       l_month,'1',p_cmd,p_sum1,p_sum2)
             RETURNING l_flag,l_afb07,l_over
       #MOD-A30113---modify---end---
        IF l_flag = FALSE THEN
           LET l_msg = g_bookno2,'/',g_apb[l_ac].apb31,'/',g_apb[l_ac].apb251,'/',
                       YEAR(g_apa.apa02),'/',g_apb[l_ac].apb36,'/',
                       g_apb[l_ac].apb930,'/',g_apb[l_ac].apb35,'/',
                       MONTH(g_apa.apa02),'/',l_over
           CALL cl_err(l_msg,g_errno,1)
           RETURN
        ELSE
           IF l_afb07 = '2' AND l_over < 0 THEN
              LET l_msg = g_bookno2,'/',g_apb[l_ac].apb31,'/',g_apb[l_ac].apb251,'/',
                          YEAR(g_apa.apa02),'/',g_apb[l_ac].apb36,'/',
                          g_apb[l_ac].apb930,'/',g_apb[l_ac].apb35,'/',
                          MONTH(g_apa.apa02),'/',l_over
              CALL cl_err(l_msg,g_errno,1)
              LET g_errno = ' '
              RETURN
           END IF 
        END IF
     ELSE
        IF g_bookno2 IS NULL OR g_apb[l_ac].apb31 IS NULL OR
           g_apb[l_ac].apb251 IS NULL OR YEAR(g_apa.apa02) IS NULL OR 
           g_apb[l_ac].apb36 IS NULL OR g_apb[l_ac].apb26 IS NULL OR 
           g_apb[l_ac].apb35 IS NULL OR MONTH(g_apa.apa02) IS NULL THEN
           RETURN
        END IF
       #MOD-A30113---modify---start---
       #CALL s_budchk1(g_bookno2,g_apb[l_ac].apb31,g_apb[l_ac].apb251,
       #               YEAR(g_apa.apa02),g_apb[l_ac].apb36, 
       #               g_apb[l_ac].apb26,g_apb[l_ac].apb35,
       #               MONTH(g_apa.apa02),'1',p_cmd,p_sum1,p_sum2)
       #     RETURNING l_flag,l_afb07,l_over
        CALL s_yp(g_apa.apa02) RETURNING l_year,l_month
        CALL s_budchk1(g_bookno2,g_apb[l_ac].apb31,g_apb[l_ac].apb251,
                       l_year,g_apb[l_ac].apb36, 
                       g_apb[l_ac].apb26,g_apb[l_ac].apb35,
                       l_month,'1',p_cmd,p_sum1,p_sum2)
             RETURNING l_flag,l_afb07,l_over
       #MOD-A30113---modify---end---
        IF l_flag = FALSE THEN
           LET l_msg = g_bookno2,'/',g_apb[l_ac].apb31,'/',g_apb[l_ac].apb251,'/',
                       YEAR(g_apa.apa02),'/',g_apb[l_ac].apb36,'/',
                       g_apb[l_ac].apb26,'/',g_apb[l_ac].apb35,'/',
                       MONTH(g_apa.apa02),'/',l_over
           CALL cl_err(l_msg,g_errno,1)
           RETURN
        ELSE
           IF l_afb07 = '2' AND l_over < 0 THEN
              LET l_msg = g_bookno2,'/',g_apb[l_ac].apb31,'/',g_apb[l_ac].apb251,'/',
                          YEAR(g_apa.apa02),'/',g_apb[l_ac].apb36,'/',
                          g_apb[l_ac].apb26,'/',g_apb[l_ac].apb35,'/',
                          MONTH(g_apa.apa02),'/',l_over
              CALL cl_err(l_msg,g_errno,1)
              LET g_errno = ' '
              RETURN
           END IF 
        END IF
     END IF
  END IF
  RETURN
 
END FUNCTION
 
FUNCTION t110_bud_s(p_afc00,p_afc01,p_afc02,p_afc03,p_afc04,p_afc041,
                    p_afc042,p_afc05,p_flag,p_cmd,p_sum1,p_sum2,p_flag1)
  DEFINE p_afc00     LIKE afc_file.afc00  #帳套編號
  DEFINE p_afc01     LIKE afc_file.afc01  #費用原因
  DEFINE p_afc02     LIKE afc_file.afc02  #會計科目
  DEFINE p_afc03     LIKE afc_file.afc03  #會計年度
  DEFINE p_afc04     LIKE afc_file.afc04  #WBS
  DEFINE p_afc041    LIKE afc_file.afc041 #部門編號
  DEFINE p_afc042    LIKE afc_file.afc042 #項目編號
  DEFINE p_afc05     LIKE afc_file.afc05  #期別
  DEFINE p_flag      LIKE type_file.chr1  #0.第一科目 1.第二科目
  DEFINE p_flag1     LIKE type_file.chr1  #1.單筆檢查 2.單身total檢查
  DEFINE p_cmd       LIKE type_file.chr1
  DEFINE p_sum1      LIKE afc_file.afc06 
  DEFINE p_sum2      LIKE afc_file.afc06 
  DEFINE l_flag      LIKE type_file.num5
  DEFINE l_afb07     LIKE afb_file.afb07
  DEFINE l_over      LIKE afc_file.afc07
  DEFINE l_msg       LIKE ze_file.ze03    #FUN-890128
 
      CALL s_budchk1(p_afc00,p_afc01,p_afc02,p_afc03,p_afc04,        
                     p_afc041,p_afc042,p_afc05,p_flag,p_cmd,p_sum1,p_sum2)
          RETURNING l_flag,l_afb07,l_over
      IF l_flag = FALSE THEN
         LET g_success = 'N'
         LET g_showmsg = p_afc00,'/',p_afc01,'/',p_afc02,'/',
                         p_afc03 USING "<<<&",'/',p_afc04,'/',
                         p_afc041,'/',p_afc042,'/',
                         p_afc05 USING "<&",p_sum2,'/',l_over
         IF p_flag1 = '2' THEN
            LET g_errno = 'agl-232'
         END IF
         IF g_bgerr THEN
            CALL s_errmsg('afc00,afc01,afc02,afc03,afc04,afc041,afc042,afc05,npl05,npl05',g_showmsg,'t420sub_bud',g_errno,1)
         ELSE
            CALL cl_err(g_showmsg,g_errno,1)
         END IF
      ELSE
         IF l_afb07 = '2' AND l_over < 0 THEN
            IF p_flag1 = '2' THEN
               LET g_errno = 'agl-232'
            END IF
            LET g_showmsg = p_afc00,'/',p_afc01,'/',p_afc02,'/',
                            p_afc03 USING "<<<&",'/',p_afc04,'/',
                            p_afc041,'/',p_afc042,'/',
                            p_afc05 USING "<&",p_sum2,'/',l_over
            IF g_bgerr THEN
               CALL s_errmsg('afc00,afc01,afc02,afc03,afc04,afc041,afc042,afc05,npl05,npl05',g_showmsg,'t420sub_bud',g_errno,1)
            ELSE
               LET l_msg = cl_getmsg(g_errno,g_lang)
               LET l_msg = g_showmsg CLIPPED, l_msg CLIPPED
               CALL cl_msgany(10,20,l_msg)
            END IF
            LET g_errno = ' '
         END IF
      END IF
END FUNCTION
 
FUNCTION t210_out1()
   DEFINE   t210_msg1        STRING 
 
   CALL cl_set_act_visible("accept,cancel", TRUE)
   
   MENU ""
 
       ON ACTION apdetail
           LET t210_msg1 = "aapr129 '' '' '",g_lang,"' 'Y' '' '' "," '",g_wc CLIPPED,"' '12 ' '   ' '   '" CLIPPED
           CALL cl_cmdrun(t210_msg1)       
 
       ON ACTION pay
           LET t210_msg1 = "aapr111 '' '' '",g_lang,"' 'Y' '' '' "," '",g_wc CLIPPED,"' '12' '  ' '  ' '  ' '  '  '  '" CLIPPED  
           CALL cl_cmdrun(t210_msg1)       
 
       ON ACTION exit
          EXIT MENU
 
       ON IDLE g_idle_seconds
          CALL cl_on_idle() 
          CONTINUE MENU 
 
       ON ACTION about 
          CALL cl_about()
 
       ON ACTION help 
          CALL cl_show_help()
 
       ON ACTION controlg 
          CALL cl_cmdask()
 
       ON ACTION close   #COMMAND KEY(INTERRUPT) #FUN-9B0145  
          LET INT_FLAG=FALSE  
          LET g_action_choice = "exit" 
          EXIT MENU
 
   END MENU 
  CALL cl_set_act_visible("accept,cancel", FALSE)
 
END FUNCTION
 
FUNCTION t210_out()
   DEFINE t210_msg        STRING 
   DEFINE l_type          LIKE type_file.chr1   #MOD-9B0001 add 
 
   CALL cl_set_act_visible("accept,cancel", TRUE)
   
   MENU ""
       ON ACTION discount
           LET t210_msg = "aapr220 '' '' '",g_lang,"' 'Y' '' '' "," '",g_wc CLIPPED,"' '1'" CLIPPED    #FUN-640124
           CALL cl_cmdrun(t210_msg)       
        
       ON ACTION pay
           IF g_aptype = '21' THEN LET l_type='7' END IF  #MOD-9B0001 add
           IF g_aptype = '22' THEN LET l_type='8' END IF  #MOD-9B0001 add
           IF g_aptype = '26' THEN LET l_type='9' END IF  #CHI-A90037 add
           LET t210_msg = "aapr111 '' '' '",g_lang,"' 'Y' '' '' '",g_wc CLIPPED,"' '12' ' ' ' ' ' ' ' ' '",l_type CLIPPED,"'" CLIPPED  #MOD-9B0001 
           CALL cl_cmdrun(t210_msg)       
 
       ON ACTION exit
          EXIT MENU
 
       ON IDLE g_idle_seconds
          CALL cl_on_idle() 
          CONTINUE MENU 
 
       ON ACTION about 
          CALL cl_about()
 
       ON ACTION help 
          CALL cl_show_help()
 
       ON ACTION controlg 
          CALL cl_cmdask()
 
       ON ACTION close   #COMMAND KEY(INTERRUPT) #FUN-9B0145  
          LET INT_FLAG=FALSE  
          LET g_action_choice = "exit" 
          EXIT MENU
 
   END MENU 
  CALL cl_set_act_visible("accept,cancel", FALSE)
 
END FUNCTION
 
#該函數的功能是，由人工指定需要更新哪些賬款單身資料，來維護差異金額。
FUNCTION t110_share2()
DEFINE   l_apb       DYNAMIC ARRAY OF RECORD
            apb02    LIKE apb_file.apb02,
            apb06    LIKE apb_file.apb06,
            apb07    LIKE apb_file.apb07,
            apb12    LIKE apb_file.apb12,
            apb27    LIKE apb_file.apb27,
            apb09    LIKE apb_file.apb09,
            apb23b   LIKE apb_file.apb23,
            apb24b   LIKE apb_file.apb23,
            apb24c   LIKE apb_file.apb24,
            apb23a   LIKE apb_file.apb23,
            apb24a   LIKE apb_file.apb24,
            apb08b   LIKE apb_file.apb08,
            apb10b   LIKE apb_file.apb10,
            apb10c   LIKE apb_file.apb10,
            apb08a   LIKE apb_file.apb08,
            apb10a   LIKE apb_file.apb10,
            apb29    LIKE apb_file.apb29
                     END RECORD
DEFINE   l_apb_t     RECORD
            apb02    LIKE apb_file.apb02,
            apb06    LIKE apb_file.apb06,
            apb07    LIKE apb_file.apb07,
            apb12    LIKE apb_file.apb12,
            apb27    LIKE apb_file.apb27,
            apb09    LIKE apb_file.apb09,
            apb23b   LIKE apb_file.apb23,
            apb24b   LIKE apb_file.apb23,
            apb24c   LIKE apb_file.apb24,
            apb23a   LIKE apb_file.apb23,
            apb24a   LIKE apb_file.apb24,
            apb08b   LIKE apb_file.apb08,
            apb10b   LIKE apb_file.apb10,
            apb10c   LIKE apb_file.apb10,
            apb08a   LIKE apb_file.apb08,
            apb10a   LIKE apb_file.apb10,
            apb29    LIKE apb_file.apb29
                     END RECORD
DEFINE   l_ac        LIKE type_file.num10
DEFINE   l_b         LIKE type_file.num10   #單身數量
DEFINE   l_wc        STRING
DEFINE   l_sql       STRING       
DEFINE   l_apa33     LIKE apa_file.apa33
DEFINE   l_apa33f    LIKE apa_file.apa33f
DEFINE   i           LIKE type_file.num10
DEFINE l_amt,l_amt2   LIKE type_file.num20_6     
DEFINE l_amtf,l_amt2f LIKE type_file.num20_6     
DEFINE l_apb02       LIKE apb_file.apb02
DEFINE l_n           LIKE type_file.num10
DEFINE l_apb10_t     LIKE apb_file.apb10
DEFINE l_apb24_t     LIKE apb_file.apb24
DEFINE l_apb34       LIKE apb_file.apb34
DEFINE tok           base.StringTokenizer
 
   LET l_apa33  = 0
   LET l_apa33f = 0
   LET l_apb10_t= 0
   LET l_apb24_t= 0
   
   OPEN WINDOW t110_share2_w AT 0,0 WITH FORM "aap/42f/aapt110_n"
        ATTRIBUTE(STYLE = "sm1")
   
     #CALL cl_ui_init()                 #MOD-C70268 mark
      CALL cl_ui_locale("aapt110_n")    #MOD-C70268 add
      
      CALL l_apb.clear()
      INITIALIZE l_apb_t TO NULL
      DISPLAY g_apa.apa01  TO FORMONLY.apa01
      DISPLAY g_apa.apa33  TO FORMONLY.apa33
      DISPLAY g_apa.apa33f TO FORMONLY.apa33f
 
      INPUT ARRAY l_apb WITHOUT DEFAULTS FROM s_apb_n.*
        ATTRIBUTE(COUNT=l_b,MAXCOUNT=g_max_rec,UNBUFFERED,
                  INSERT ROW =TRUE,APPEND ROW=TRUE,DELETE ROW=TRUE)
        
        BEFORE INPUT 
          IF l_b != 0 THEN 
             CALL FGL_SET_ARR_CURR(l_ac)
          END IF 
        
        BEFORE ROW 
          LET l_ac = ARR_CURR()
          IF cl_null(l_apb[l_ac].apb10c) THEN 
             LET l_apb[l_ac].apb10c = 0
          END IF
          IF cl_null(l_apb[l_ac].apb24c) THEN 
             LET l_apb[l_ac].apb24c = 0
          END IF 
          LET l_apb_t.* = l_apb[l_ac].* 
          LET l_apb10_t = l_apb_t.apb10c
          LET l_apb24_t = l_apb_t.apb24c
          
        AFTER INSERT
          IF INT_FLAG THEN 
             CANCEL INSERT
          END IF 
      
        AFTER FIELD apb02
          IF NOT cl_null(l_apb[l_ac].apb02) THEN 
             #檢查項次是否存在
             SELECT COUNT(*) INTO l_n FROM apb_file 
              WHERE apb01 = g_apa.apa01 
                AND apb02 = l_apb[l_ac].apb02
             IF l_n = 0 THEN 
                CALL cl_err(l_apb[l_ac].apb02,'aap-615',0)
                NEXT FIELD apb02
             END IF 
             #取暫估標識
             LET l_apb34 = NULL
             SELECT apb34 INTO l_apb34 FROM apb_file
              WHERE apb01 = g_apa.apa01
                AND apb02 = l_apb[l_ac].apb02
             IF l_apb34 = 'Y' THEN 
                CALL cl_err(l_apb[l_ac].apb02,'aap-616',0)
                NEXT FIELD apb02
             END IF 
             IF l_apb[l_ac].apb02 <> l_apb_t.apb02 OR cl_null(l_apb_t.apb02) THEN 
                #FOR循環檢查數組變量中是否已存在相同項次。
                FOR i = 1 TO l_apb.getLength()
                    IF i = l_ac THEN 
                       CONTINUE FOR 
                    ELSE 
                    	 IF l_apb[i].apb02 = l_apb[l_ac].apb02 THEN 
                    	    CALL cl_err(l_apb[i].apb02,'aap-614',0)
                    	    NEXT FIELD apb02
                    	 END IF 
                    END IF 
                END FOR 
                #抓取資料
                SELECT apb02,apb06,apb07,apb12,apb27,apb09,
                       apb23,apb24,0,apb23,apb24, 
                       apb08,apb10,0,apb08,apb10,apb29  
                  INTO l_apb[l_ac].*
                  FROM apb_file 
                 WHERE apb01 = g_apa.apa01 AND apb02 = l_apb[l_ac].apb02
             END IF  
          END IF 
          
        ON CHANGE apb24c
           IF l_apb[l_ac].apb29 = '1' THEN 
              IF l_apb[l_ac].apb24c + l_apb[l_ac].apb24b < 0 THEN 
                 CALL cl_err(l_apb[l_ac].apb24c,'aap-617',0)
                 LET l_apb[l_ac].apb24c = l_apb_t.apb24c
                 NEXT FIELD apb24c
              END IF 
           ELSE 
              IF l_apb[l_ac].apb24c + l_apb[l_ac].apb24b > 0 THEN 
                 CALL cl_err(l_apb[l_ac].apb24c,'aap-620',0)
                 LET l_apb[l_ac].apb24c = l_apb_t.apb24c
                 NEXT FIELD apb24c
              END IF 
           END IF 
           LET l_apb[l_ac].apb24a = l_apb[l_ac].apb24b + l_apb[l_ac].apb24c
           LET l_apb[l_ac].apb23a = l_apb[l_ac].apb24a / l_apb[l_ac].apb09
           LET l_apb[l_ac].apb10a = l_apb[l_ac].apb24a * g_apa.apa14
           LET l_apb[l_ac].apb08a = l_apb[l_ac].apb10a / l_apb[l_ac].apb09
           LET l_apb[l_ac].apb10c = l_apb[l_ac].apb24c * g_apa.apa14
           LET l_apb[l_ac].apb24c = cl_digcut(l_apb[l_ac].apb24c,t_azi04)
           LET l_apb[l_ac].apb10c = cl_digcut(l_apb[l_ac].apb10c,g_azi04)
           LET l_apb[l_ac].apb24a = cl_digcut(l_apb[l_ac].apb24a,t_azi04)
           LET l_apb[l_ac].apb23a = cl_digcut(l_apb[l_ac].apb23a,t_azi03)
           LET l_apb[l_ac].apb10a = cl_digcut(l_apb[l_ac].apb10a,g_azi04)
           LET l_apb[l_ac].apb08a = cl_digcut(l_apb[l_ac].apb08a,g_azi03)
           LET l_apb10_t = l_apb[l_ac].apb10c
           LET l_apb24_t = l_apb[l_ac].apb24c
          
        ON CHANGE apb10c
           IF l_apb[l_ac].apb29  = '1' THEN 
              IF l_apb[l_ac].apb10c + l_apb[l_ac].apb10b < 0 THEN 
                 CALL cl_err(l_apb[l_ac].apb10c,'aap-617',0)
                 LET l_apb[l_ac].apb10c = l_apb_t.apb10c
                 NEXT FIELD apb10c
              END IF 
           ELSE
              IF l_apb[l_ac].apb10c + l_apb[l_ac].apb10b > 0 THEN 
                 CALL cl_err(l_apb[l_ac].apb10c,'aap-620',0)
                 LET l_apb[l_ac].apb10c = l_apb_t.apb10c
                 NEXT FIELD apb10c
              END IF 
           END IF 
           LET l_apb[l_ac].apb10a = l_apb[l_ac].apb10b + l_apb[l_ac].apb10c
           LET l_apb[l_ac].apb08a = l_apb[l_ac].apb10a / l_apb[l_ac].apb09
           LET l_apb[l_ac].apb10c = cl_digcut(l_apb[l_ac].apb10c,g_azi04)
           LET l_apb[l_ac].apb10a = cl_digcut(l_apb[l_ac].apb10a,g_azi04)
           LET l_apb[l_ac].apb08a = cl_digcut(l_apb[l_ac].apb08a,g_azi03)
           LET l_apb10_t = l_apb[l_ac].apb10c
        
 
        AFTER ROW
          LET l_apa33 = 0
          LET l_apa33f= 0
          FOR i = 1 TO l_apb.getLength() 
              IF cl_null(l_apb[i].apb02) THEN CONTINUE FOR END IF
              LET l_apa33 = l_apa33 + l_apb[i].apb10c
              LET l_apa33f= l_apa33f+ l_apb[i].apb24c
          END FOR
          LET l_apa33 = g_apa.apa33 - l_apa33
          LET l_apa33f= g_apa.apa33f- l_apa33f
          LET l_apa33 = cl_digcut(l_apa33 ,g_azi04)
          LET l_apa33f= cl_digcut(l_apa33f,t_azi04)
          DISPLAY l_apa33  TO FORMONLY.apa33
          DISPLAY l_apa33f TO FORMONLY.apa33f
          LET l_b = l_apb.getLength()
          DISPLAY l_b TO FORMONLY.cnt
 
        AFTER INPUT 
          IF INT_FLAG THEN
             EXIT INPUT
          END IF
          IF l_apa33 <> 0 OR l_apa33f <> 0 THEN 
             LET l_ac = 1
             CALL cl_err('','aap-613',0)
             CONTINUE INPUT
          END IF  
          
        
        ON ACTION CONTROLP
          CASE
            WHEN INFIELD(apb02)
              CALL cl_init_qry_var()
              LET g_qryparam.form = 'q_apb2'
              LET g_qryparam.state = 'c'
              LET l_wc = ''
              FOR i = 1 TO l_apb.getLength()
                  IF cl_null(l_apb[i].apb02) THEN 
                     CONTINUE FOR
                  END IF 
                  IF cl_null(l_wc) THEN 
                     LET l_wc = l_apb[i].apb02
                  ELSE 
                     LET l_wc = l_wc,',',l_apb[i].apb02
                  END IF 
              END FOR
              IF cl_null(l_wc) THEN 
                 LET g_qryparam.where = " apb01 = '",g_apa.apa01,"'"
              ELSE
                 LET g_qryparam.where = " apb01 = '",g_apa.apa01,"'",
                                        " AND apb02 NOT IN (",l_wc,")"
              END IF 
              LET g_qryparam.where = g_qryparam.where," AND apb34 <> 'Y' "
              LET g_qryparam.default1 = l_apb[l_ac].apb02
              CALL cl_create_qry() RETURNING g_qryparam.multiret
              LET l_wc = g_qryparam.multiret
          END CASE 
          IF NOT cl_null(l_wc) THEN 
             LET tok = base.StringTokenizer.create(l_wc,"|")
             LET l_wc = ''
             WHILE tok.hasMoreTokens()
                 IF cl_null(l_wc) THEN 
                    LET l_wc = tok.nextToken()
                 ELSE
                    LET l_wc = l_wc,',',tok.nextToken()
                 END IF 
             END WHILE
             LET l_wc = '(',l_wc,')'
             LET l_sql = "SELECT apb02,apb06,apb07,apb12,apb27,apb09, ",
                         "       apb23,apb24,0,apb23,apb24, ",
                         "       apb08,apb10,0,apb08,apb10,apb29 FROM apb_file ", 
                         " WHERE apb01 = '",g_apa.apa01,"'",
                         "   AND apb02 IN ",l_wc,
                         "  ORDER BY apb02 "
             PREPARE t110_share2_apb_prep FROM l_sql
             DECLARE t110_share2_apb_cs CURSOR FOR t110_share2_apb_prep
             LET i = 1
             IF l_ac <= l_b THEN 
                LET i = l_b + 1  
             END IF 
             FOREACH t110_share2_apb_cs INTO l_apb[i].*
                LET i = i + 1
             END FOREACH
             CALL l_apb.deleteElement(i)
             LET i = i - 1
             LET l_b = i
             CALL FGL_SET_ARR_CURR(i)
          END IF 
        
      END INPUT 
   CLOSE WINDOW t110_share2_w
   IF INT_FLAG THEN 
      RETURN 
   END IF 
 
   FOR i=1 TO l_apb.getLength()
     #若本幣與原幣異動皆為0，則此筆記錄不予更新。
     IF l_apb[i].apb10c = 0 AND l_apb[i].apb24c = 0 THEN 
        CONTINUE FOR
     END IF 
     UPDATE apb_file SET apb08 = l_apb[i].apb08a,
                         apb081= l_apb[i].apb08a,
                         apb10 = l_apb[i].apb10a,
                         apb101= l_apb[i].apb10a,
                         apb23 = l_apb[i].apb23a,
                         apb24 = l_apb[i].apb24a
      WHERE apb01 = g_apa.apa01 AND apb02 = l_apb[i].apb02
     IF SQLCA.sqlcode THEN 
        CALL cl_err('update apb_file:',SQLCA.sqlcode,1)
        RETURN 
     END IF 
   END FOR 
   
   SELECT SUM(apb10),SUM(apb24) INTO l_amt,l_amtf FROM apb_file
    WHERE apb01 = g_apa.apa01 AND apb29='1'
 
   IF l_amt IS NULL THEN
      LET l_amt = 0
   END IF
 
   IF l_amtf IS NULL THEN
      LET l_amtf = 0
   END IF
 
   SELECT SUM(apb10),SUM(apb24) INTO l_amt2,l_amt2f FROM apb_file
    WHERE apb01 = g_apa.apa01 AND apb29='3'
 
   IF l_amt2 IS NULL THEN
      LET l_amt2 = 0
   END IF
 
   IF l_amt2f IS NULL THEN
      LET l_amt2f = 0
   END IF
 
   IF g_aptype MATCHES '1*' THEN
      LET g_apa.apa57f= l_amtf+ l_amt2f  
      LET g_apa.apa57 = l_amt + l_amt2   
   ELSE
      LET g_apa.apa57f= l_amt2f- l_amtf
      LET g_apa.apa57 = l_amt2 - l_amt
   END IF
 
   IF g_apa.apa57 IS NULL THEN
      LET g_apa.apa57=0
   END IF
 
   LET g_apa.apa57f=cl_digcut(g_apa.apa57f,t_azi04)  
   LET g_apa.apa57=cl_digcut(g_apa.apa57,g_azi04)  
 
   DISPLAY BY NAME g_apa.apa57
 
   UPDATE apa_file SET apa56 =g_apa.apa56, 
                       apa57 =g_apa.apa57,
                       apa57f=g_apa.apa57f 
    WHERE apa01=g_apa.apa01
 
   IF g_apb_sarrno > 0 THEN
      CALL t110_b_fill(' 1=1')
   END IF   
 
 
END FUNCTION 
 
FUNCTION t110_set_entry_apk_120(p_cmd)
DEFINE p_cmd    LIKE type_file.chr1
 
IF p_cmd = 'a' AND (NOT g_before_input_done) THEN 
   IF  g_prog = 'aapt210' THEN #CHI-A40005
     CALL cl_set_comp_entry("apk02,apk11,apk171,apk17,apk172,apk05,apk03,apk04,apk12,apk13,apk08f,apk06f,apk08,apk06,apk32",TRUE) #CHI-A40005
   ELSE #CHI-A40005
     CALL cl_set_comp_entry("apk02,apk03",TRUE)   #MOD-950226 add apk02
     CALL cl_set_comp_entry("apk12,apk13",TRUE)
   END IF  #CHI-A40005 
END IF 
END FUNCTION
 
FUNCTION t110_set_no_entry_apk_120(p_cmd)
DEFINE p_cmd    LIKE type_file.chr1
 
IF p_cmd = 'u' AND (NOT g_before_input_done) THEN  
   IF  g_prog = 'aapt210' THEN #CHI-A40005
     CALL cl_set_comp_entry("apk02,apk11,apk171,apk17,apk172,apk05,apk03,apk04,apk12,apk13,apk08f,apk06f,apk08,apk06,apk32",FALSE) #CHI-A40005
   ELSE #CHI-A40005
      IF g_aptype MATCHES '1*' THEN
         IF g_apa.apa08 != 'MISC' THEN
            CALL cl_set_comp_entry("apk03",FALSE)
         END IF
      END IF
 
      IF g_aptype MATCHES '2*' THEN
         IF g_apb[l_ac].apb11 != 'MISC' THEN
            CALL cl_set_comp_entry("apk03",FALSE)
         END IF
      END IF
 
     #CALL cl_set_comp_entry("apk12,apk13",FALSE)      #MOD-BB0154 mark
      CALL cl_set_comp_entry("apk02",FALSE)            #CHI-940018 
   END IF #CHI-A40005
END IF    
END FUNCTION
 
FUNCTION t110_set_no_apa_required()
  CALL cl_set_comp_required("apa77",FALSE)
END FUNCTION
 
FUNCTION t110_set_apa_required()
   IF g_aza.aza94 = 'Y' THEN
      CALL cl_set_comp_required("apa77",TRUE)
   END IF
END FUNCTION
 
FUNCTION t110_set_no_apk_required()
  CALL cl_set_comp_required("apk32",FALSE)
END FUNCTION
 
FUNCTION t110_set_apk_required()
   IF g_aza.aza94 = 'Y' THEN
      CALL cl_set_comp_required("apk32",TRUE)
   END IF
END FUNCTION
 
 
FUNCTION t110_apb37()
   LET g_errno = ''

   SELECT * FROM azp_file,azw_file
    WHERE azp01 = azw01 AND azp01 = g_apb[l_ac].apb37
      AND azw02 = g_legal
   CASE WHEN SQLCA.SQLCODE = 100  LET g_errno = 'agl-171'
        OTHERWISE                 LET g_errno = SQLCA.SQLCODE USING '-------'
   END CASE

   LET g_plant_new = g_apb[l_ac].apb37
   CALL s_gettrandbs() 
   LET li_dbs =g_dbs_tra
END FUNCTION


FUNCTION t110_act_1(p_item,p_ware,p_loc,p_npptype)
  DEFINE p_item    LIKE ima_file.ima01
  DEFINE p_ware    LIKE ime_file.ime01
  DEFINE p_loc     LIKE ime_file.ime02
  DEFINE l_actno   LIKE aag_file.aag01
  DEFINE p_npptype LIKE npp_file.npptype
  DEFINE g_ccz07   LIKE ccz_file.ccz07

  SELECT ccz07 INTO g_ccz07 FROM ccz_file WHERE ccz00='0'

  CASE WHEN g_ccz07='1' IF p_npptype = '0' THEN
                           #LET l_sql = "SELECT ima149 FROM ",li_dbs CLIPPED,"ima_file",
                           LET l_sql = "SELECT ima149 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'ima_file'), #FUN-A50102
                                       " WHERE ima01='",p_item,"' "
                           CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                       CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102                
                           PREPARE sel_ima149_pre FROM l_sql
                           EXECUTE sel_ima149_pre INTO l_actno
                        ELSE
                           #LET l_sql ="SELECT ima1491 FROM ",li_dbs CLIPPED,"ima_file",
                           LET l_sql ="SELECT ima1491 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'ima_file'), #FUN-A50102
                                      " WHERE ima01='",p_item,"' "
                           CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                       CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102           
                           PREPARE sel_ima1491_pre FROM l_sql
                           EXECUTE sel_ima1491_pre INTO l_actno 
                        END IF
       WHEN g_ccz07='2' IF p_npptype = '0' THEN
                           #LET l_sql = "SELECT imz73 FROM ",li_dbs CLIPPED,"ima_file, ",
                           #                                 li_dbs CLIPPED,"imz_file ",
                           LET l_sql = "SELECT imz73 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'ima_file'),",", #FUN-A50102
                                                            cl_get_target_table(g_apb[l_ac].apb37,'imz_file'),     #FUN-A50102
                                       " WHERE ima01='",p_item,"' AND ima06=imz01 "
                           CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                       CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
                           PREPARE sel_imz73_pre FROM l_sql
                           EXECUTE sel_imz73_pre INTO l_actno
                        ELSE
                           #LET l_sql = "SELECT imz731 FROM ",li_dbs CLIPPED,"ima_file, ",
                           #                                  li_dbs CLIPPED,"imz_file ",
                           LET l_sql = "SELECT imz731 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'ima_file'),",", #FUN-A50102
                                                             cl_get_target_table(g_apb[l_ac].apb37,'imz_file'),     #FUN-A50102
                                       " WHERE ima01='",p_item,"' AND ima06=imz01 "
                           CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                       CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102            
                           PREPARE sel_imz731_pre FROM l_sql
                           EXECUTE sel_imz731_pre INTO l_actno
                        END IF
       WHEN g_ccz07='3' IF p_npptype = '0' THEN
                           #LET l_sql ="SELECT imd21 FROM ",li_dbs CLIPPED,"imd_file ",
                           LET l_sql ="SELECT imd21 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'imd_file'), #FUN-A50102
                                      " WHERE imd01='",p_ware,"' "
                           CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                       CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102           
                           PREPARE sel_imd21_pre FROM l_sql
                           EXECUTE sel_imd21_pre INTO l_actno
                        ELSE
                           #LET l_sql ="SELECT imd211 FROM ",li_dbs CLIPPED,"imd_file ",
                           LET l_sql ="SELECT imd211 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'imd_file'), #FUN-A50102
                                      " WHERE imd01='",p_ware,"' "
                           CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                       CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102           
                           PREPARE sel_imd211_pre FROM l_sql
                           EXECUTE sel_imd211_pre INTO l_actno
                        END IF
       WHEN g_ccz07='4' IF p_npptype = '0' THEN
                           #LET l_sql ="SELECT ime13 FROM ",li_dbs CLIPPED,"ime_file ",
                           LET l_sql ="SELECT ime13 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'ime_file'), #FUN-A50102
                                      " WHERE ime01='",p_ware,"' AND ime02='",p_loc,"'"
                           CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                       CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102           
                           PREPARE sel_ime13_pre FROM l_sql
                           EXECUTE sel_ime13_pre INTO l_actno
                        ELSE
                           #LET l_sql ="SELECT ime131 FROM ",li_dbs CLIPPED,"ime_file ",
                           LET l_sql ="SELECT ime131 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'ime_file'), #FUN-A50102
                                      " WHERE ime01='",p_ware,"' AND ime02='",p_loc,"'"
                           CALL cl_replace_sqldb(l_sql) RETURNING l_sql              #FUN-A50102									
	                       CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql #FUN-A50102           
                           PREPARE sel_ime131_pre FROM l_sql
                           EXECUTE sel_ime131_pre INTO l_actno
                        END IF
  END CASE
  RETURN l_actno
END FUNCTION
#No.FUN-9C0072 精簡程式碼
#No.TQC-A30076  --Begin                                                         
FUNCTION t110_show_multi_invoice()                                              
                                                                                
   IF (g_aptype = '12' OR g_aptype = '13') AND l_apz59='N' THEN     #TQC-A40106 change g_apz.apz59->l_apz59         
      CALL t110_misc_display() RETURN                                           
   END IF                                                                       
                                                                                
END FUNCTION                                                                    
#No.TQC-A30076  --End
#No.FUN-A30106 --begin                                                          
FUNCTION t110_drill_down()                                                      
                                                                                
   IF cl_null(g_apa.apa44) THEN RETURN END IF                                   
   LET g_msg = "aglt110 '",g_apa.apa44,"'"                                      
   CALL cl_cmdrun(g_msg)                                                        
END FUNCTION                                                                    
#No.FUN-A30106 --end 
#TQC-A60054
#No.MOD-AC0034 --begin
FUNCTION t110_api_upd()
DEFINE l_amt    LIKE apa_file.apa34
DEFINE l_amtf   LIKE apa_file.apa34f
DEFINE l_api05  LIKE api_file.api05
DEFINE l_api05f LIKE api_file.api05f
DEFINE l_api26  LIKE api_file.api26
DEFINE l_api03  LIKE api_file.api03

       IF g_apz.apz27 = 'Y' THEN RETURN END IF #MOD-C20104

       DECLARE upd_api26 CURSOR FOR
        SELECT  DISTINCT(api26) FROM api_file WHERE api01 =g_apa.apa01
       FOREACH upd_api26 INTO l_api26
          SELECT apa34,apa34f INTO l_amt,l_amtf FROM apa_file WHERE apa01 = l_api26
          SELECT SUM(api05),SUM(api05f) INTO l_api05,l_api05f FROM api_file WHERE api26 =l_api26
          IF l_api05f = l_amtf THEN 
             IF l_api05 <> l_amt THEN 
                SELECT MAX(api03) INTO l_api03 FROM api_file WHERE api01 = g_apa.apa01 AND api26 = l_api26
                UPDATE api_file SET api05 = api05 -l_api05 + l_amt
                 WHERE api01 = g_apa.apa01 
                   AND api26 = l_api26
                   AND api03 = l_api03
             END IF 
          END IF 
       END FOREACH        

END FUNCTION
#No.MOD-AC0034 --end

#FUN-B30147 

#FUN-910088--add--start--
#FUNCTION t110_apb09_check(p_apa32f,p_apb24t,p_pmc913)  #TQC-D80019 mark
FUNCTION t110_apb09_check(p_apb24t,p_apa32f,p_pmc913)   #TQC-D80019 add
DEFINE l_qty1     LIKE apb_file.apb09,
       l_qty2     LIKE apb_file.apb09,
       l_pmn87    LIKE pmn_file.pmn87,
       l_apb09_15 LIKE apb_file.apb09,
       l_gec04    LIKE gec_file.gec04,
       l_gec05    LIKE gec_file.gec05,
       l_gec07    LIKE gec_file.gec07,
       l_rvv38t   LIKE rvv_file.rvv38t,
       l_apa14    LIKE apa_file.apa14,
       p_apb24t   LIKE apb_file.apb24,
       p_apa32f   LIKE apa_file.apa32,
       p_pmc913   LIKE pmc_file.pmc913
DEFINE p_cmd      LIKE type_file.chr1
   IF NOT cl_null(g_apb[l_ac].apb09) AND NOT cl_null(g_apb[l_ac].apb28) THEN
      IF cl_null(g_apb28_t) OR cl_null(g_apb_t.apb09) OR g_apb28_t != g_apb[l_ac].apb28 OR g_apb_t.apb09 != g_apb[l_ac].apb09 THEN
         LET g_apb[l_ac].apb09 = s_digqty(g_apb[l_ac].apb09,g_apb[l_ac].apb28)
         DISPLAY BY NAME g_apb[l_ac].apb09
      END IF
   END IF
   IF g_apa.apa00 MATCHES '1*' AND g_apb[l_ac].apb09 = 0 THEN
      IF g_apb[l_ac].apb29 = '3' AND g_qty1=0 THEN  
      ELSE
         RETURN FALSE,p_apb24t,p_apa32f     
      END IF
   END IF
   IF g_apb[l_ac].apb34 = 'N' THEN
      IF g_aptype = '11' AND g_apb[l_ac].apb29 = '3' THEN
         #若是倉退時,是負數,要不同處理
         LET l_qty1 = g_apb[l_ac].apb09 * -1                           
         LET l_qty2 = g_apb_t.apb09     * -1                           
         # 已請款數量+本次請款數量-本次請款舊值+暫估數量>計價數量      
         IF g_qty2 + l_qty1 - l_qty2 + g_qty5 > g_qty1 THEN            
            CALL cl_err(g_qty1,'aap-048',1)
            RETURN FALSE,p_apb24t,p_apa32f     
         END IF
      ELSE
         IF g_aptype = '11' OR g_aptype = '21' OR 
            g_aptype = '16' OR g_aptype = '26' THEN
            IF (g_qty2-g_apb_t.apb09+g_apb[l_ac].apb09+g_qty5) > g_qty1 THEN  
               CALL cl_err(g_qty1,'aap-048',1)
               LET g_apb[l_ac].apb09 = g_apb_t.apb09   #MOD-C50075
               DISPLAY BY NAME g_apb[l_ac].apb09       #MOD-C50075
               RETURN FALSE,p_apb24t,p_apa32f
            END IF
         END IF
      END IF
   END IF
   IF g_apb[l_ac].apb34 = 'Y' THEN
      IF g_aptype = '11' AND g_apb[l_ac].apb29 = '3' THEN
         #No.MOD-C50075  --Begin
         IF g_apb[l_ac].apb09  > 0  THEN
            CALL cl_err(g_apb[l_ac].apb09,'axr-611',1)
         END IF
         #No.MOD-C50075  --End
         IF g_apb_t.apb09 - g_apb[l_ac].apb09  > g_qty5 THEN  
            CALL cl_err(g_apb[l_ac].apb09,'aap-818',1)
            LET g_apb[l_ac].apb09 = g_apb_t.apb09
            DISPLAY BY NAME g_apb[l_ac].apb09
            RETURN FALSE,p_apb24t,p_apa32f
         END IF
      ELSE
         IF g_apb[l_ac].apb09 - g_apb_t.apb09 > g_qty5 THEN  
            CALL cl_err(g_apb[l_ac].apb09,'aap-818',1)
            LET g_apb[l_ac].apb09 = g_apb_t.apb09   #MOD-C50075
            DISPLAY BY NAME g_apb[l_ac].apb09                   #MOD-C50075
            RETURN FALSE,p_apb24t,p_apa32f
         END IF
      END IF
   END IF
   IF (g_aptype='15' AND (g_apz.apz61='1' OR (g_apz.apz61='3' AND p_pmc913='Y'))) THEN 
      LET l_pmn87=0   LET l_apb09_15=0
      #採購數量
      LET l_sql = "SELECT pmn87 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'pmn_file'),
                  " WHERE pmn01='",g_apb[l_ac].apb06,"' ",
                  "   AND pmn02='",g_apb[l_ac].apb07,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql
      CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql
      PREPARE sel_pmn87_cs4 FROM l_sql
      EXECUTE sel_pmn87_cs4 INTO l_pmn87
      IF cl_null(l_pmn87) THEN LET l_pmn87=0 END IF

      #採購單已立預付數量
      SELECT SUM(apb09) INTO l_apb09_15 FROM apb_file,apa_file
       WHERE apb01=apa01             AND apa00='15'
         AND apb06=g_apb[l_ac].apb06 AND apb07=g_apb[l_ac].apb07
         AND apb01!=g_apa.apa01 
      IF cl_null(l_apb09_15) THEN LET l_apb09_15=0 END IF
      
      #當預付數量(之前已經預付+本次預付)>採購數量時,應提示訊息
      IF g_apb[l_ac].apb06 IS NOT NULL AND g_apb[l_ac].apb07 IS NOT NULL THEN   
         IF l_apb09_15 + g_apb[l_ac].apb09 > l_pmn87 THEN
            CALL cl_err(g_apb[l_ac].apb09,'aap-945',1)
            LET g_apb[l_ac].apb09 = l_pmn87 - l_apb09_15
            LET g_apb[l_ac].apb24 = g_apb[l_ac].apb09 * g_apb[l_ac].apb23
            LET g_apb[l_ac].apb10 = g_apb[l_ac].apb09 * g_apb[l_ac].apb08
            LET g_apb[l_ac].apb24 =cl_digcut(g_apb[l_ac].apb24,t_azi04)
            LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,g_azi04)
            DISPLAY BY NAME g_apb[l_ac].apb09,g_apb[l_ac].apb09,g_apb[l_ac].apb10
            RETURN FALSE,p_apb24t,p_apa32f
         END IF                                                                  
      END IF                                                           

      #數量不可為負數
      IF g_apb[l_ac].apb09 < 0 THEN 
         CALL cl_err(g_apb[l_ac].apb09,'mfg1322',1)
         LET g_apb[l_ac].apb09 = l_pmn87 - l_apb09_15
         LET g_apb[l_ac].apb24 = g_apb[l_ac].apb09 * g_apb[l_ac].apb23
         LET g_apb[l_ac].apb10 = g_apb[l_ac].apb09 * g_apb[l_ac].apb08
         LET g_apb[l_ac].apb24 =cl_digcut(g_apb[l_ac].apb24,t_azi04)
         LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,g_azi04)
         DISPLAY BY NAME g_apb[l_ac].apb09,g_apb[l_ac].apb09,g_apb[l_ac].apb10
         RETURN FALSE,p_apb24t,p_apa32f
      END IF
   END IF 
   #單價含稅時,不使用單價*數量=金額,改以含稅金額回推稅率,以避免小數位差的問題
   LET l_gec04 = 0   LET l_gec07 = ''
   IF g_apb[l_ac].apb06 <> '' OR NOT cl_null(g_apb[l_ac].apb06) THEN    
      LET l_sql = "SELECT gec04,gec05,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",",
                                             cl_get_target_table(g_apb[l_ac].apb37,'pmm_file'),     
                  " WHERE gec01 = pmm21 ",
                  "   AND pmm01 = '",g_apb[l_ac].apb06,"' "
      CALL cl_replace_sqldb(l_sql) RETURNING l_sql              									
      CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql              
      PREPARE sel_gec07_pre FROM l_sql
      EXECUTE sel_gec07_pre INTO l_gec04,l_gec05,l_gec07        
   ELSE  
      IF cl_null(g_apb04) THEN
         LET l_sql = "SELECT gec04,gec05,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", 
                                                cl_get_target_table(g_apb[l_ac].apb37,'rva_file'),     
                     " WHERE gec01 = rva115",
                     "   AND rva01 = '",g_apb04,"' ",
                     "   AND gec011 = '1' "
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql             									
         CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql              
         PREPARE sel_gec07_pre1 FROM l_sql
         EXECUTE sel_gec07_pre1 INTO l_gec04,l_gec05,l_gec07       
      ELSE
         IF (g_apa.apa00 = '21' OR g_apa.apa00 = '26') AND
             NOT cl_null(g_apb[l_ac].apb21) THEN
            LET l_sql = "SELECT gec04,gec05,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'),",", 
                                                   cl_get_target_table(g_apb[l_ac].apb37,'rvu_file'),     
                        " WHERE gec01 = rvu115 AND gec011 = '1' ",
                        "   AND rvu01 = '",g_apb[l_ac].apb21,"' "
            CALL cl_replace_sqldb(l_sql) RETURNING l_sql              						
            CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql 
            PREPARE sel_gec07_pre2 FROM l_sql
            EXECUTE sel_gec07_pre2 INTO l_gec04,l_gec05,l_gec07       
         ELSE
            LET l_sql = "SELECT gec04,gec05,gec07 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'gec_file'), 
                        " WHERE gec01 = '",g_apa.apa15,"' ",
                        "   AND gec011 = '1' "
            CALL cl_replace_sqldb(l_sql) RETURNING l_sql              				
            CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql              
            PREPARE sel_gec07_pre3 FROM l_sql
            EXECUTE sel_gec07_pre3 INTO l_gec04,l_gec05,l_gec07      
         END IF
      END IF
   END IF
   IF cl_null(l_gec04) THEN 
      LET l_gec04=0   
   END IF
   IF cl_null(l_gec07) THEN 
      SELECT gec07                                     
        INTO l_gec07                                          
        FROM gec_file                                    
       WHERE gec01=g_apa.apa15 AND gec011='1'                
   END IF
   LET l_rvv38t = 0
   IF g_apb[l_ac].apb09 <> g_apb_t.apb09 THEN    
      IF l_gec07='Y' AND (g_aptype = '11' OR g_aptype = '16' OR g_aptype='21' OR g_aptype='26') THEN  
         LET l_sql = "SELECT rvv38t FROM ",cl_get_target_table(g_apb[l_ac].apb37,'rvv_file'), 
                     " WHERE rvv01 = '",g_apb[l_ac].apb21,"' ",
                     "   AND rvv02 = '",g_apb[l_ac].apb22,"' " 
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql              						
             CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql        
         PREPARE sel_rvv38t_pre FROM l_sql
         EXECUTE sel_rvv38t_pre INTO l_rvv38t
         IF cl_null(l_rvv38t) THEN LET l_rvv38t=0 END IF
         LET p_apb24t = l_rvv38t*g_apb[l_ac].apb09
         LET p_apb24t = cl_digcut(p_apb24t,t_azi04)
         IF l_gec05 = 'T' THEN
            LET p_apa32f = p_apb24t * (l_gec04/100)
            LET p_apa32f = cl_digcut(p_apa32f , t_azi04)
            LET g_apb[l_ac].apb24 = p_apb24t - p_apa32f 
         ELSE
            LET g_apb[l_ac].apb24 = p_apb24t/(1+l_gec04/100)
         END IF  
      ELSE
         IF l_gec07='Y' AND g_aptype = '12' THEN
            IF g_apb[l_ac].apb23 <> g_apb_t.apb23 OR
               cl_null(g_apb_t.apb23) THEN
               LET g_apb[l_ac].apb23 = cl_digcut(g_apb[l_ac].apb23/(1+l_gec04/100),t_azi03)
               DISPLAY BY NAME g_apb[l_ac].apb23
            END IF
         END IF
         IF g_apb[l_ac].apb09>0 THEN
            LET g_apb[l_ac].apb24 = g_apb[l_ac].apb23 * g_apb[l_ac].apb09
         END IF
      END IF
      LET g_apb[l_ac].apb24 =cl_digcut(g_apb[l_ac].apb24,t_azi04)   #MOD-6B0066
      IF g_aptype = '12' THEN     
         CALL t110_chkapb24()               
         IF g_apb[l_ac].apb34 = 'Y' AND g_apb[l_ac].apb24 > g_apb24 THEN
            LET g_apb[l_ac].apb09 = g_apb09
            CALL cl_err(g_apb[l_ac].apb09,'aap-972',1)
            RETURN FALSE,p_apb24t,p_apa32f
         END IF
      END IF                    
     #-------------------MOD-CB0133--------------(S)
      IF g_aptype = '21' AND NOT cl_null(g_apb[l_ac].apb11) THEN
         IF NOT t110_chkapb24_21(g_apb[l_ac].apb02,g_apb[l_ac].apb11,g_apb[l_ac].apb24,l_gec05) THEN
            LET g_apb[l_ac].apb09 = g_apb_t.apb09
            LET g_apb[l_ac].apb24 = g_apb_t.apb24
            CALL cl_err(g_apb[l_ac].apb11,'aap-052',1)
            RETURN FALSE,p_apb24t,p_apa32f
         END IF
      END IF
     #-------------------MOD-CB0133--------------(E)
      DISPLAY BY NAME g_apb[l_ac].apb24
      IF g_apb[l_ac].apb34 = 'N' THEN   
         LET g_apb[l_ac].apb08 =g_apb[l_ac].apb23 * g_apa.apa14
         LET g_apb[l_ac].apb08 =cl_digcut(g_apb[l_ac].apb08,g_azi03)   
         LET g_apb[l_ac].apb10 =g_apb[l_ac].apb24 * g_apa.apa14
         LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,g_azi04)   
      ELSE
         #有沖暫估時,應抓暫估單匯率來計算
         LET l_apa14=1
         LET l_sql = "SELECT apa14 FROM ",cl_get_target_table(g_apb[l_ac].apb37,'apa_file'),",", 
                                          cl_get_target_table(g_apb[l_ac].apb37,'apb_file'),     
                     " WHERE apa01=apb01 AND apa00='16' ",
                     "   AND apb21='",g_apb[l_ac].apb21,"' ",
                     "   AND apb22='",g_apb[l_ac].apb22,"' "
         CALL cl_replace_sqldb(l_sql) RETURNING l_sql              									
             CALL cl_parse_qry_sql(l_sql,g_apb[l_ac].apb37) RETURNING l_sql            
         PREPARE sel_apa14_pre FROM l_sql
         EXECUTE sel_apa14_pre INTO l_apa14
         IF cl_null(l_apa14) THEN LET l_apa14=1 END IF
         LET g_apb[l_ac].apb08 =g_apb[l_ac].apb23 * l_apa14
         LET g_apb[l_ac].apb08 =cl_digcut(g_apb[l_ac].apb08,g_azi03)
         LET g_apb[l_ac].apb10 =g_apb[l_ac].apb24 * l_apa14
         LET g_apb[l_ac].apb10 =cl_digcut(g_apb[l_ac].apb10,g_azi04)
      END IF
      DISPLAY BY NAME g_apb[l_ac].apb08
      DISPLAY BY NAME g_apb[l_ac].apb10
   END IF 
   #MOD-C30737--mark--str                                       
   #IF g_aptype[1,1] = '1' THEN
   #  CALL t110_bud(p_cmd,'3')  
   #   IF NOT cl_null(g_errno) THEN
   #      RETURN FALSE,p_apb24t,p_apa32f
   #   END IF
   #END IF
   #MOD-C30737--mark--end
   RETURN TRUE,p_apb24t,p_apa32f
END FUNCTION
#FUN-910088--add--end--
#FUN-C90079--add--str
FUNCTION t110_auto_contra()
   DEFINE l_n LIKE type_file.num10,
          l_cnt LIKE type_file.num10
   #判斷是否已經有沖帳資料存在
   SELECT COUNT(*) INTO l_cnt FROM apv_file WHERE apv01 = g_apa.apa01
   IF l_cnt = 0 THEN
   #根據廠商判斷是否存在待抵
      SELECT COUNT(*) INTO l_n
        FROM apa_file,apc_file
       WHERE apa06 = g_apa.apa06
         AND apa07 = g_apa.apa07
         AND apa00 MATCHES '2*'
         AND apa00 !='25'                                    
         AND (apa08 !='UNAP' OR apa08 IS NULL)              
         AND apa13 = g_apa.apa13                             
         AND apa08 != g_apa.apa01                            
         AND apa41 = 'Y' AND apa42 != 'Y'
         AND (apa58 = '2' OR apa58 ='3' OR apa58 IS NULL)
         AND apa34 > apa35
         AND apa01 =apc01
         AND apa02 < g_apa.apa02
         AND apc08 >(apc10+apc14)
   END IF 
   #如果存在待抵
   IF l_n >0 AND l_cnt = 0 THEN 
      CASE
         WHEN g_apa.apa42 = 'Y'
            CALL cl_err(g_apa.apa01,'aap-927',0)
         OTHERWISE
            IF cl_confirm('aap-342') THEN
               CALL t110_k()
               CALL t110_apc_check2()   
            END IF 
      END CASE
   END IF 
END FUNCTION
#FUN-C90079-add--end

#FUN-CB0080--add--str--
FUNCTION t110_b_menu()
   DEFINE l_creator    LIKE type_file.chr1 
   DEFINe l_flowuser   LIKE type_file.chr1  # 是否有指定加簽人員 
   DEFINE l_azp03      LIKE azp_file.azp03 
   DEFINE l_pmb02      LIKE pmb_file.pmb02 
   DEFINE l_cnt        LIKE type_file.num5 
 
   LET l_flowuser = "N"
 
   WHILE TRUE
      CALL t110_list_bp("G")
      IF NOT cl_null(g_action_choice) AND l_ac1>0 THEN #將清單的資料回傳到主畫面
         LET g_jump = l_ac1
         LET g_no_ask = TRUE
         CALL t110_fetch('/')
      END IF
      IF cl_null(g_action_choice) THEN
         CALL cl_set_act_visible("accept,cancel", FALSE)
      END IF
      IF g_action_choice!= "" THEN
         LET g_bp_flag = 'main'
         LET l_ac1 = ARR_CURR()
         LET g_jump = l_ac1
         LET g_no_ask = TRUE
         IF g_rec_b2 >0 THEN
             CALL t110_fetch('/')
         END IF
         CALL cl_set_comp_visible("Page2", FALSE)
         CALL cl_set_comp_visible("Info", FALSE)
         CALL ui.interface.refresh()
         CALL cl_set_comp_visible("Page2", TRUE)
         CALL cl_set_comp_visible("Info", FALSE)
       END IF
      CASE g_action_choice
         WHEN "insert"
            IF cl_chk_act_auth() THEN
               CALL t110_a()
               CALL t110_list_fill() 
            END IF
            EXIT WHILE
         WHEN "delete"
            IF cl_chk_act_auth() THEN
               CALL t110_r()
               CALL t110_list_fill() 
            END IF
         WHEN "modify"
            IF cl_chk_act_auth() THEN
               CALL t110_u()
               CALL t110_list_fill() 
            END IF
            EXIT WHILE
         WHEN "query"
            IF cl_chk_act_auth() THEN
               CALL t110_q()
            END IF
            EXIT WHILE
         WHEN "first"
            CALL t110_fetch('F')
            IF g_rec_b2 != 0 THEN
              CALL fgl_set_arr_curr(g_curs_index)
            END IF
         WHEN "previous"
            CALL t110_fetch('P')
            IF g_rec_b2 != 0 THEN
              CALL fgl_set_arr_curr(g_curs_index)
            END IF
         WHEN "jump"
            CALL t110_fetch('/')
            IF g_rec_b2 != 0 THEN
              CALL fgl_set_arr_curr(g_curs_index)
            END IF
         WHEN "next"
            CALL t110_fetch('N')
            IF g_rec_b2 != 0 THEN
              CALL fgl_set_arr_curr(g_curs_index)
            END IF
         WHEN "last"
            CALL t110_fetch('L')
            IF g_rec_b2 != 0 THEN
              CALL fgl_set_arr_curr(g_curs_index)
            END IF
         WHEN "reproduce"
            IF cl_chk_act_auth() THEN
               CALL t110_copy()
            END IF
         WHEN "detail"
            IF cl_chk_act_auth() THEN
               IF g_aza.aza53='Y' THEN
                  SELECT azp03 INTO l_azp03 FROM azp_file WHERE azp01=g_apa.apa100
                  IF STATUS THEN LET l_azp03=g_dbs END IF
                  IF g_dbs!=l_azp03 AND (g_apa.apa100='11' OR g_apa.apa100='12' 
                     OR g_apa.apa100='15' OR g_apa.apa100='21' OR g_apa.apa100='22') THEN  
                     DATABASE l_azp03    
                     CALL cl_ins_del_sid(1,g_apa.apa100)
                     CALL t110_b('b')
                     DATABASE g_dbs  
                     CALL cl_ins_del_sid(1,g_plant)
                  ELSE
                     CALL t110_b('b')
                  END IF
               ELSE
                  CALL t110_b('b')
               END IF
            ELSE
               LET g_action_choice = NULL
            END IF
            EXIT WHILE
         WHEN "help"
            CALL cl_show_help()
         WHEN "exit"
            EXIT WHILE
         WHEN "controlg"
            CALL cl_cmdask()
  
         WHEN "exporttoexcel"
             IF cl_chk_act_auth() THEN
                #CALL cl_export_to_excel                                         #FUN-D60015 mark
                #(ui.Interface.getRootNode(),base.TypeInfo.create(g_apb),'','')  #FUN-D60015 mark

                #FUN-D60015---add---str---
                LET w = ui.Window.getCurrent()
                LET f = w.getForm()
                IF cl_null(g_bp_flag) OR g_bp_flag = "main" THEN
                   LET page = f.FindNode("Page","page1")
                   CALL cl_export_to_excel(page,base.TypeInfo.create(g_apb),'','')
                END IF
                IF g_bp_flag = "list" THEN
                   LET page = f.FindNode("Page","page2")
                   CALL cl_export_to_excel(page,base.TypeInfo.create(g_apa_1),'','')
                END IF
                #FUN-D60015---add---end---
             END IF
  
         WHEN "account_period"
            IF cl_chk_act_auth() THEN
               CALL t110_account_period()
            END IF
         WHEN "on_hold"
            IF cl_chk_act_auth() THEN
               CALL t110_hold()
            END IF
         WHEN "undo_on_hold"
            IF cl_chk_act_auth() THEN
               CALL t110_unhold()
            END IF
         WHEN "mul_invoice"
            CALL t110_ddd('2')   #MOD-950112 add參數
            DISPLAY BY NAME g_apa.apa07     
            CALL t110_diff_rtn('0')         
            CALL t110_show_multi_invoice()  
         WHEN "mul_debit"
            IF g_apa.apa51='MISC' OR g_apa.apa511 ='MISC' THEN  
            CALL t110_ccc('1')                                               
            ELSE                                                                   
               CALL cl_err(g_apa.apa51,'aap-704',0)                                
            END IF
         WHEN "contra_tmp_est"
               CALL t110_ppp('2')
         WHEN "qry_contra"
            CALL t110_pay_record()
         WHEN "memo"
            CALL t110_m()
         WHEN "var_process"
            IF cl_chk_act_auth() THEN
               IF NOT cl_null(g_apa.apa01) THEN
                  CALL t110_diff_rtn('0')
                  CALL t110_api_diff()   
               END IF                          
            END IF
         WHEN "output"
            IF cl_chk_act_auth() THEN
               CALL t110_out('o')
            END IF
         WHEN "contra"
            CASE
               WHEN g_aptype = '16' OR g_aptype = '26'
                  CALL cl_err(g_apa.apa01,'aap-926',0)
               WHEN g_apa.apa42 = 'Y'
                  CALL cl_err(g_apa.apa01,'aap-927',0)
               OTHERWISE
                  IF g_aptype = '13' OR g_aptype = '17' THEN 
                     CALL t110_k_2()
                     CALL t110_apc_check2() 
                  ELSE
                     CALL t110_k()
                     CALL t110_apc_check2()  
                  END IF
            END CASE
         WHEN "revert" #還款
            IF cl_chk_act_auth() THEN
               CALL t110_k_1()
               CALL t110_list_fill() 
            END IF
         WHEN "revert_query" #還款查詢
            IF cl_chk_act_auth() THEN
               CALL t110_pay_record_1()
            END IF
         WHEN "modify_date"
            IF cl_chk_act_auth() THEN
               CALL t110_date()
            END IF

         WHEN "pay_direct"
            IF cl_chk_act_auth() THEN
               IF cl_null(g_apa.apa01) THEN                                                            
                  CALL cl_err('','axr-072',1)                                                            
                  LET g_action_choice = NULL                                                             
                  CONTINUE WHILE              
               END IF 
               IF g_apa.apa63 MATCHES '[Ss]' THEN
                  CALL cl_err('','mfg3557',0)
                  LET g_action_choice = NULL            
                  CONTINUE WHILE         
               END IF
               LET l_cnt = 0 
               SELECT COUNT(*) INTO l_cnt FROM apb_file 
                WHERE apb01=g_apa.apa01 AND apb34='Y'
               CASE
                  WHEN g_apa.apa42 = 'Y' #已作廢
                     CALL cl_err(g_apa.apa01,'aap-165',0)
                  WHEN g_aptype = '16' OR g_aptype = '26'
                     CALL cl_err(g_apa.apa01,'aap-926',0)
                  OTHERWISE
                     CALL t110_w(g_apa.apa01)
                     SELECT * INTO g_apa.* FROM apa_file WHERE apa01=g_apa.apa01
                     CALL t110_unpay()  
                     DISPLAY BY NAME g_apa.apa55,g_apa.apa35f,g_apa.apa35 
                        LET g_apa_t.apa31 =g_apa.apa31
                        LET g_apa_t.apa32 =g_apa.apa32
                        LET g_apa_t.apa34 =g_apa.apa34
                        LET g_apa_t.apa57 =g_apa.apa57
                        LET g_apa_t.apa73 =g_apa.apa73
                        LET g_apa_t.apa31f =g_apa.apa31f
                        LET g_apa_t.apa32f =g_apa.apa32f
                        LET g_apa_t.apa34f =g_apa.apa34f
                        LET g_apa_t.apa57f =g_apa.apa57f
                          IF g_apa.apa35 <> g_apa_t.apa35 OR g_apa.apa35f <> g_apa_t.apa35f THEN
                             LET g_sn = 'y'
                          END IF
                          IF g_apa.apa41 != 'Y' THEN
                             CALL t110_apc_check('w')
                          ELSE
                             CALL t110_apc_check('')
                          END IF
                          LET g_sn = 'n'                        
                        IF g_apa.apa41 <> 'Y' AND g_apy.apydmy3 = 'Y' THEN  
                           CALL t110_g_gl(g_apa.apa00,g_apa.apa01,'0','')   
                           IF g_aza.aza63 ='Y' THEN 
                              CALL t110_g_gl(g_apa.apa00,g_apa.apa01,'1','')
                           END IF
                        END IF
               END CASE
               CALL t110_list_fill()   
            END IF
         WHEN "gen_entry"
            IF cl_chk_act_auth() THEN
               CALL t110_v0()  
            END IF
         WHEN "entry_sheet"
            IF cl_chk_act_auth() THEN
               CALL t110_sheet('0')
               CALL t110_npp02('0')    
            END IF
      
         WHEN "entry_sheet2"
            IF cl_chk_act_auth() THEN
               CALL t110_sheet('1')
               CALL t110_npp02('1')
            END IF
  
         WHEN "T_T_entry_sheet"
            IF cl_chk_act_auth() THEN
               CALL t110_sheet('0')
               CALL t110_npp02('0')
            END IF
  
         WHEN "T_T_entry_sheet2"
            IF cl_chk_act_auth() THEN
               CALL t110_sheet('1')
               CALL t110_npp02('1')
            END IF
  
         WHEN "carry_voucher" 
            IF cl_chk_act_auth() THEN
               IF g_apa.apa41 = 'Y' THEN  
                  CALL t110_carry_voucher() 
               ELSE 
                  CALL cl_err('','atm-402',1)
               END IF 
               
            END IF 
         WHEN "undo_carry_voucher" 
            IF cl_chk_act_auth() THEN
               IF g_apa.apa41 = 'Y' THEN 
                  CALL t110_undo_carry_voucher()
               ELSE 
                  CALL cl_err('','atm-403',1)
               END IF
            END IF 
  
         WHEN "appor_expense"
            IF cl_chk_act_auth() THEN
               CALL t110_appor_expense()
            END IF
            
         WHEN "void"
            IF cl_chk_act_auth() THEN
              #CALL t110_c()                   #FUN-D20035
               CALL t110_c(1)                   #FUN-D20035
               IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF
               CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,"")
               CALL t110_list_fill() 
            END IF

         #FUN-D20035----add---str
         WHEN "undo_void"
            IF cl_chk_act_auth() THEN
               CALL t110_c(2)                
               IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF
               CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,"")
               CALL t110_list_fill()
            END IF
         #FUN-D20035----add----end

         WHEN "single_invoice"
            CALL t110_apa17('u')
            DISPLAY BY NAME g_apa.apa07  
            DISPLAY BY NAME g_apa.apa24,g_apa.apa12,g_apa.apa64 
  
         WHEN "qry_contra_tmp_est"
            IF g_aptype = '16' THEN  
               CALL t110_5()
            END IF
  
         WHEN "qry_bill_allowance"
            CALL t110_21()
  
         WHEN "confirm"
            IF cl_chk_act_auth() THEN
               IF g_aza.aza26 = '2' AND (g_aptype = '11' OR g_aptype = '12' ) THEN
                  CALL t110_auto_contra() 
               END IF
               CALL s_showmsg_init() 
               CALL t110_firm1_chk()          #CALL 原確認的 check 段
               IF g_success = "Y" THEN
                  CALL t110_firm1_upd()       #CALL 原確認的 update 段
               END IF
               CALL s_showmsg() 
               CALL t110_list_fill()
               CALL t110_show()            
            END IF
         WHEN "undo_confirm"
            IF cl_chk_act_auth() THEN
               SELECT * INTO g_apa.* FROM apa_file WHERE apa01=g_apa.apa01   
               IF cl_null(g_apa.apa992) THEN                      
                  #CALL t110_firm2()   #FUN-CB0094 mark
                  CALL s_t110_unconfirm(g_aptype,g_apa.apa01,g_apa.apa41,g_apb[1].apb06,g_apb[1].apb37,g_plant_nm) #FUN-CB0094
               ELSE                                    
                  CALL cl_err(g_apa.apa992,"aap-066",0) 
                  CONTINUE WHILE                       
               END IF                                  
               #IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF #FUN-CB0094 mark
               #CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,g_apa.apaacti) #FUN-CB0094 mark
               CALL t110_list_fill()
            END IF
         #@WHEN "准"
         WHEN "agree"
            IF g_laststage = "Y" AND l_flowuser = "N" THEN  #最後一關並且沒有加簽人員
               CALL t110_firm1_upd()      #CALL 原確認的 update 段
            ELSE
               LET g_success = "Y"
               IF NOT aws_efapp_formapproval() THEN
                  LET g_success = "N"
               END IF
            END IF
            IF g_success = 'Y' THEN
               IF cl_confirm('aws-081') THEN  #詢問是否繼續下一筆資料的簽核
                  IF aws_efapp_getnextforminfo() THEN #取得下一筆簽核單號
                     LET l_flowuser = "N"
                     LET g_argv1_apa01 = aws_efapp_wsk(1)   #取得單號
                     IF NOT cl_null(g_argv1_apa01) THEN     #自動 query 帶出資料
                        CALL t110_q()
                        #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
                         CALL aws_efapp_flowaction("insert, modify, delete, reproduce,
                         detail, query,locale, void, undo_void,confirm, undo_confirm, easyflow_approval,   #FUN-D20025 add--undo_void
                         on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,
                         contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,
                         T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,
                         carry_voucher,undo_carry_voucher,account_period,appor_expense") 
                         RETURNING g_laststage
                       ELSE
                           EXIT WHILE
                       END IF
                    ELSE
                       EXIT WHILE
                    END IF
                 ELSE
                    EXIT WHILE
                 END IF
              END IF
  
          #@WHEN "不准"
          WHEN "deny"
             IF (l_creator := aws_efapp_backflow()) IS NOT NULL THEN
                IF aws_efapp_formapproval() THEN
                   IF l_creator = "Y" THEN
                      LET g_apa.apa63= 'R'
                      DISPLAY BY NAME g_apa.apa63
                   END IF
                   IF cl_confirm('aws-081') THEN     #詢問是否繼續下一筆資料的簽核
                      IF aws_efapp_getnextforminfo() THEN #取得下一筆簽核單號
                         LET l_flowuser = "N"
                         LET g_argv1_apa01 = aws_efapp_wsk(1)    #取得單號
                         IF NOT cl_null(g_argv1_apa01) THEN      #自動 query 帶出資料
                            CALL t110_q()
                            #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
                            CALL aws_efapp_flowaction("insert, modify, delete, reproduce, 
                            detail, query,locale, void, undo_void,confirm, undo_confirm, easyflow_approval,  #FUN-D20025 add--undo_void
                            on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,
                            contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,
                            T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,
                            carry_voucher,undo_carry_voucher,account_period,appor_expense")  
                            RETURNING g_laststage
                         ELSE
                             EXIT WHILE
                         END IF
                      ELSE
                         EXIT WHILE
                      END IF
                   ELSE
                      EXIT WHILE
                   END IF
                END IF
             END IF
  
         #@WHEN "加簽"
         WHEN "modify_flow"
              IF aws_efapp_flowuser() THEN   #選擇欲加簽人員
                 LET l_flowuser = 'Y'
              ELSE
                 LET l_flowuser = 'N'
              END IF
  
         #@WHEN "撤簽"
         WHEN "withdraw"
              IF cl_confirm("aws-080") THEN
                 IF aws_efapp_formapproval() THEN
                    EXIT WHILE
                 END IF
              END IF
  
         #@WHEN "抽單"
         WHEN "org_withdraw"
              IF cl_confirm("aws-079") THEN
                 IF aws_efapp_formapproval() THEN
                    EXIT WHILE
                    END IF
              END IF
  
         #@WHEN "簽核意見"
         WHEN "phrase"
              CALL aws_efapp_phrase()
  
        #@WHEN "簽核狀況"
         WHEN "approval_status"              
             IF cl_chk_act_auth() THEN       
                IF aws_condition2() THEN     
                     CALL aws_efstat2()      
                END IF
             END IF
  
          WHEN "easyflow_approval"     
             IF cl_chk_act_auth() THEN
                  CALL t110_ef()
             END IF
  
          WHEN "related_document"  #相關文件
               IF cl_chk_act_auth() THEN
                  IF g_apa.apa01 IS NOT NULL THEN
                  LET g_doc.column1 = "apa01"
                  LET g_doc.value1 = g_apa.apa01
                  CALL cl_doc()
                END IF
          END IF
                                                             
          WHEN "drill_down"                                                        
             IF cl_chk_act_auth() THEN                                             
                CALL t110_drill_down()                                             
             END IF 
         OTHERWISE 
            EXIT WHILE               
      END CASE
   END WHILE
END FUNCTION
 
FUNCTION t210_b_menu()
   DEFINE l_creator    LIKE type_file.chr1  
   DEFINe l_flowuser   LIKE type_file.chr1   # 是否有指定加簽人員 
   DEFINE l_azp03      LIKE azp_file.azp03  
 
   LET l_flowuser = "N"
   WHILE TRUE
      CALL t210_list_bp("G")
      IF NOT cl_null(g_action_choice) AND l_ac1>0 THEN #將清單的資料回傳到主畫面
         LET g_jump = l_ac1
         LET g_no_ask = TRUE
         CALL t110_fetch('/')
      END IF
      IF cl_null(g_action_choice) THEN
         CALL cl_set_act_visible("accept,cancel", FALSE)
      END IF
      IF g_action_choice!= "" THEN
         LET g_bp_flag = 'main'
         LET l_ac1 = ARR_CURR()
         LET g_jump = l_ac1
         LET g_no_ask = TRUE
         IF g_rec_b2 >0 THEN
             CALL t110_fetch('/')
         END IF
         CALL cl_set_comp_visible("Page2", FALSE)
         CALL cl_set_comp_visible("Info", FALSE)
         CALL ui.interface.refresh()
         CALL cl_set_comp_visible("Page2", TRUE)
         CALL cl_set_comp_visible("Info", FALSE)
       END IF
      CASE g_action_choice
         WHEN "insert"
            IF cl_chk_act_auth() THEN
               CALL t110_a()
            END IF
            EXIT WHILE
         WHEN "query"
            IF cl_chk_act_auth() THEN
               CALL t110_q()
            END IF
            EXIT WHILE
         WHEN "single_invoice"
            CALL t110_apa17('u')
            DISPLAY BY NAME g_apa.apa07  
            DISPLAY BY NAME g_apa.apa24,g_apa.apa12,g_apa.apa64 
         WHEN "first"
            CALL t110_fetch('F')
            IF g_rec_b2 != 0 THEN
              CALL fgl_set_arr_curr(g_curs_index)
            END IF
         WHEN "previous"
            CALL t110_fetch('P')
            IF g_rec_b2 != 0 THEN
              CALL fgl_set_arr_curr(g_curs_index)
            END IF
         WHEN "jump"
            CALL t110_fetch('/')
            IF g_rec_b2 != 0 THEN
              CALL fgl_set_arr_curr(g_curs_index)
            END IF
         WHEN "next"
            CALL t110_fetch('N')
            IF g_rec_b2 != 0 THEN
              CALL fgl_set_arr_curr(g_curs_index)
            END IF
         WHEN "last"
            CALL t110_fetch('L')
            IF g_rec_b2 != 0 THEN
              CALL fgl_set_arr_curr(g_curs_index)
            END IF
         WHEN "modify"
            IF cl_chk_act_auth() THEN
               CALL t110_u()
            END IF
            EXIT WHILE
         WHEN "delete"
            IF cl_chk_act_auth() THEN
               CALL t110_r()
            END IF
         WHEN "detail"
            IF cl_chk_act_auth() THEN
               IF g_aza.aza53='Y' THEN
                  SELECT azp03 INTO l_azp03 FROM azp_file WHERE azp01=g_apa.apa100
                  IF STATUS THEN LET l_azp03=g_dbs END IF
                  IF g_dbs!=l_azp03 AND (g_apa.apa100='11' OR g_apa.apa100='12' 
                     OR g_apa.apa100='15' OR g_apa.apa100='21' OR g_apa.apa100='22') THEN  
                     DATABASE l_azp03    
                     CALL cl_ins_del_sid(1,g_apa.apa100) 
                     CALL t110_b('b')
                     DATABASE g_dbs  
                     CALL cl_ins_del_sid(1,g_plant) 
                  ELSE
                     CALL t110_b('b')
                  END IF
               ELSE
                  CALL t110_b('b')
               END IF
            ELSE
               LET g_action_choice = NULL
            END IF
            EXIT WHILE
         WHEN "account_period"
            IF cl_chk_act_auth() THEN
               CALL t110_account_period()
            END IF
         WHEN "contra_tmp_est"
               CALL t110_ppp('2')
         WHEN "help"
            CALL cl_show_help()
         WHEN "output"
            IF cl_chk_act_auth() THEN
               LET g_wc = 'apa01="',g_apa.apa01,'"'           # "新增"則印單張
               IF g_aza.aza26 = '2' THEN
                  CALL t210_out1()        
            ELSE
                 CALL t210_out()      
               END IF
            END IF
         WHEN "exit"
            EXIT WHILE
         WHEN "controlg"
            CALL cl_cmdask()
         WHEN "gen_entry"
            IF cl_chk_act_auth() THEN
               CALL t110_v0() 
            END IF
         WHEN "entry_sheet"
            IF cl_chk_act_auth() THEN
               CALL t110_sheet('0') 
               CALL t110_npp02('0')  
            END IF
    
         WHEN "entry_sheet2"
            IF cl_chk_act_auth() THEN
               CALL t110_sheet('1') 
               CALL t110_npp02('1')
            END IF
    
         WHEN "T_T_entry_sheet"
            IF cl_chk_act_auth() THEN
               CALL t110_sheet('0')
               CALL t110_npp02('0')           
            END IF
    
         WHEN "T_T_entry_sheet2"
            IF cl_chk_act_auth() THEN
               CALL t110_sheet('1')
               CALL t110_npp02('1')           
            END IF
    
         WHEN "carry_voucher" 
            IF cl_chk_act_auth() THEN              
               IF g_apa.apa41 = 'Y' THEN  
                  CALL t110_carry_voucher() 
               ELSE 
                  CALL cl_err('','atm-402',1)
               END IF 
            END IF                                 
           	     
         WHEN "undo_carry_voucher" 
            IF cl_chk_act_auth() THEN              
               IF g_apa.apa41 = 'Y' THEN 
                  CALL t110_undo_carry_voucher()
               ELSE 
                  CALL cl_err('','atm-403',1)
               END IF
            END IF                                 
    
         WHEN "void"
            IF cl_chk_act_auth() THEN              
               #CALL t110_c()                #FUN-D20035
               CALL t110_c(1)                #FUN-D20035
               IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF
               CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,"")   
               CALL t110_list_fill()  
            END IF                                 

         #FUN-D20035----add---str
         WHEN "undo_void"
            IF cl_chk_act_auth() THEN
               CALL t110_c(2)                 
               IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF
               CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,"")
               CALL t110_list_fill()
            END IF
         #FUN-D20035----add----end

         WHEN "on_hold"
            IF cl_chk_act_auth() THEN
               CALL t110_hold()
            END IF
         WHEN "undo_on_hold"
            IF cl_chk_act_auth() THEN
               CALL t110_unhold()
            END IF
         WHEN "mul_invoice"
            CALL t110_ddd('2')   #MOD-950112 add參數
            DISPLAY BY NAME g_apa.apa07     
            CALL t110_show_multi_invoice()  
         WHEN "invoice_detail"
            CALL t110_inv()
         WHEN "qry_contra"
            CALL t110_pay_record()
         WHEN "memo"
            IF cl_chk_act_auth() THEN
               CALL t110_m()
            END IF
         WHEN "confirm"
            IF cl_chk_act_auth() THEN
               CALL s_showmsg_init()
               CALL t110_firm1_chk()          #CALL 原確認的 check 段
               IF g_success = "Y" THEN
                  CALL t110_firm1_upd()       #CALL 原確認的 update 段
               END IF
               CALL s_showmsg()
               CALL t110_list_fill() 
            END IF
         WHEN "undo_confirm"
            IF cl_chk_act_auth() THEN
               SELECT * INTO g_apa.* FROM apa_file WHERE apa01=g_apa.apa01 
               IF cl_null(g_apa.apa992) THEN                     
                  #CALL t110_firm2()   #FUN-CB0094 mark
                  CALL s_t110_unconfirm(g_aptype,g_apa.apa01,g_apa.apa41,g_apb[1].apb06,g_apb[1].apb37,g_plant_nm) #FUN-CB0094 
               ELSE                                      
                  CALL cl_err(g_apa.apa992,"aap-066",0)  
                  CONTINUE WHILE                          
               END IF                                    
               #IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF #FUN-CB0094 mark
               #CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,g_apa.apaacti) #FUN-CB0094 mark
               CALL t110_list_fill() 
            END IF
         WHEN "exporttoexcel"
             IF cl_chk_act_auth() THEN
                #CALL cl_export_to_excel                                         #FUN-D60015 mark
                #(ui.Interface.getRootNode(),base.TypeInfo.create(g_apb),'','')  #FUN-D60015 mark

                #FUN-D60015---add---str---
                LET w = ui.Window.getCurrent()
                LET f = w.getForm()
                IF cl_null(g_bp_flag) OR g_bp_flag = "main" THEN
                   LET page = f.FindNode("Page","page1")
                   CALL cl_export_to_excel(page,base.TypeInfo.create(g_apb),'','')
                END IF
                IF g_bp_flag = "list" THEN
                   LET page = f.FindNode("Page","page2")
                   CALL cl_export_to_excel(page,base.TypeInfo.create(g_apa_1),'','')
                END IF
                #FUN-D60015---add---end---
             END IF
         #@WHEN "准"
         WHEN "agree"
            IF g_laststage = "Y" AND l_flowuser = "N" THEN  #最後一關並且沒有加簽人員
               CALL t110_firm1_upd()      #CALL 原確認的 update 段
            ELSE
               LET g_success = "Y"
               IF NOT aws_efapp_formapproval() THEN
                  LET g_success = "N"
               END IF
            END IF
            IF g_success = 'Y' THEN
               IF cl_confirm('aws-081') THEN  #詢問是否繼續下一筆資料的簽核
                 IF aws_efapp_getnextforminfo() THEN #取得下一筆簽核單號
                    LET l_flowuser = "N"
                    LET g_argv1_apa01 = aws_efapp_wsk(1)   #取得單號
                    IF NOT cl_null(g_argv1_apa01) THEN     #自動 query 帶出資料
                      CALL t110_q()
                     #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
                      CALL aws_efapp_flowaction("insert, modify, delete, reproduce, 
                      detail, query,locale, void, undo_void,confirm, undo_confirm, easyflow_approval,    #FUN-D20025 add--undo_void
                      on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,
                      contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,
                      T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,
                      carry_voucher,undo_carry_voucher,account_period,appor_expense") 
                    ELSE
                        EXIT WHILE
                    END IF
                  ELSE
                    EXIT WHILE
                  END IF
               ELSE
                  EXIT WHILE
               END IF
            END IF
    
         #@WHEN "不准"
         WHEN "deny"
            IF (l_creator := aws_efapp_backflow()) IS NOT NULL THEN
               IF aws_efapp_formapproval() THEN
                  IF l_creator = "Y" THEN
                     LET g_apa.apa63 = 'R'
                     DISPLAY BY NAME g_apa.apa63
                  END IF
                  IF cl_confirm('aws-081') THEN     #詢問是否繼續下一筆資料的簽核
                     IF aws_efapp_getnextforminfo() THEN #取得下一筆簽核單號
                        LET l_flowuser = "N"
                        LET g_argv1_apa01 = aws_efapp_wsk(1)    #取得單號
                        IF NOT cl_null(g_argv1_apa01) THEN      #自動 query 帶出資料
                           CALL t110_q()
                           #設定簽核功能及哪些 action 在簽核狀態時是不可被執行的
                           CALL aws_efapp_flowaction("insert, modify, delete, reproduce,
                           detail, query,locale, void, undo_void,confirm, undo_confirm, easyflow_approval,   #FUN-D20025 add--undo_void
                           on_hold,undo_on_hold,mul_invoice,single_invoice,mul_debit,var_process,
                           contra,modify_date,pay_direct,gen_entry,entry_sheet,entry_sheet2,
                           T_T_entry_sheet,T_T_entry_sheet2,maintain_misc_vender,contra_tmp_est,
                           carry_voucher,undo_carry_voucher,account_period,appor_expense")  
                           RETURNING g_laststage
                        ELSE
                           EXIT WHILE
                        END IF
                     ELSE
                        EXIT WHILE
                     END IF
                  ELSE
                     EXIT WHILE
                  END IF
               END IF
            END IF
 
         #@WHEN "加簽"
         WHEN "modify_flow"
            IF aws_efapp_flowuser() THEN   #選擇欲加簽人員
               LET l_flowuser = 'Y'
            ELSE
               LET l_flowuser = 'N'
            END IF
 
         #@WHEN "撤簽"
         WHEN "withdraw"
            IF cl_confirm("aws-080") THEN
               IF aws_efapp_formapproval() THEN
                  EXIT WHILE
               END IF
            END IF
 
         #@WHEN "抽單"
         WHEN "org_withdraw"
            IF cl_confirm("aws-079") THEN
               IF aws_efapp_formapproval() THEN
                  EXIT WHILE
                  END IF
            END IF
 
         #@WHEN "簽核意見"
         WHEN "phrase"
           CALL aws_efapp_phrase()
 
         #@WHN "簽核狀況"
         WHEN "approval_status"            
           IF cl_chk_act_auth() THEN        #DISPLAY ONLY
              IF aws_condition2() THEN       
                 CALL aws_efstat2()        
              END IF
           END IF
 
         WHEN "easyflow_approval" 
            IF cl_chk_act_auth() THEN
                 CALL t110_ef()
            END IF
 
         WHEN "related_document"  #相關文件
            IF cl_chk_act_auth() THEN
               IF g_apa.apa01 IS NOT NULL THEN
                  LET g_doc.column1 = "apa01"
                  LET g_doc.value1 = g_apa.apa01
                  CALL cl_doc()
               END IF
            END IF                                                         
         WHEN "drill_down"                                                        
            IF cl_chk_act_auth() THEN                                             
               CALL t110_drill_down()                                             
            END IF
         OTHERWISE 
            EXIT WHILE          
      END CASE
   END WHILE
END FUNCTION

FUNCTION t110_list_bp(p_ud)
   DEFINE   p_ud   LIKE type_file.chr1
 
   IF p_ud <> "G" OR g_action_choice = "detail" THEN
      RETURN
   END IF
 
   LET g_action_choice = " "
   IF g_aptype <> '16' THEN 
      CALL cl_set_act_visible("qry_contra_tmp_est",FALSE)
   END IF
 
   CALL cl_set_act_visible("maintain_misc_vender",FALSE)
   IF g_aza.aza63 ='N' THEN
      CALL cl_set_act_visible("entry_sheet2,T_T_entry_sheet2",FALSE)
   END IF
 
   IF g_aptype = '15' OR g_aptype = '17' THEN 
      CALL cl_set_act_visible("contra_tmp_est",FALSE)
   END IF
 
   IF g_aptype = '11' THEN       
      CALL cl_set_act_visible("reproduce",FALSE)
   END IF
 
   IF g_aptype = '13' THEN
      CALL cl_set_act_visible("contra_tmp_est,qry_bill_allowance",FALSE)
   ELSE
      CALL cl_set_act_visible("revert,revert_query",FALSE)
   END IF
   IF g_aptype = '17' THEN
      CALL cl_set_act_visible("contra_tmp_est,var_process,qry_contra_tmp_est,qry_bill_allowance",FALSE)
   END IF
 
   CALL cl_set_act_visible("revert",FALSE)
 
   CALL cl_set_act_visible("accept,cancel", FALSE)
 
   DISPLAY ARRAY g_apa_1 TO s_apa_1.* ATTRIBUTE(COUNT=g_rec_b2,UNBUFFERED)
 
      BEFORE DISPLAY
         CALL cl_navigator_setting( g_curs_index, g_row_count )
         IF g_rec_b2 != 0 THEN
           CALL fgl_set_arr_curr(g_curs_index)
         END IF
         IF (g_aptype = '12' OR g_aptype ='13') AND l_apz59='N' THEN 
            CALL cl_reset_local_action("detail",FALSE)
         END IF
         IF g_aptype = '15' OR g_aptype = '13' OR g_aptype = '17' THEN
            CALL cl_set_comp_visible("apb21",FALSE)
         END IF
 
         IF g_aptype = '13' OR g_aptype = '17' THEN
            CALL cl_set_comp_visible("apb11,apb29,apb21,apb22,apb06,apb07,apb12,
                                      apb27,apb09,apb28,apb23,apb08",FALSE)
            IF g_aptype = '17' THEN
               CALL cl_set_comp_visible("apb33",true) # andd by quan 更改fale to true
            END IF
         ELSE
            CALL cl_set_comp_visible("apb33,apb32,b32",FALSE)       
         END IF
         CALL cl_set_comp_visible("apb051,apb251",g_aza.aza63='Y')
        
      BEFORE ROW
         LET l_ac = ARR_CURR()
         CALL cl_show_fld_cont()
      ON ACTION main
         LET g_bp_flag = 'main'
         LET l_ac1 = ARR_CURR()
         LET g_jump = l_ac1
         LET g_no_ask = TRUE
         IF g_rec_b2 >0 THEN
             CALL t110_fetch('/')
         END IF
         CALL cl_set_comp_visible("Page2", FALSE)
         CALL cl_set_comp_visible("Info", FALSE)
         CALL ui.interface.refresh()
         CALL cl_set_comp_visible("Page2", TRUE)
         CALL cl_set_comp_visible("Info", TRUE)
         EXIT DISPLAY
      ON ACTION locale
         CALL cl_dynamic_locale()
         CALL cl_show_fld_cont()  
         CALL t110_misc_clear()   
         IF g_apa.apa63='1' THEN LET g_chr2='Y' ELSE LET g_chr2='N' END IF
         CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,g_apa.apaacti)
         LET g_action_choice = 'locale'
         EXIT DISPLAY
      ON ACTION insert
         LET g_action_choice="insert"
         EXIT DISPLAY
      ON ACTION query
         LET g_action_choice="query"
         EXIT DISPLAY
      ON ACTION delete
         LET g_action_choice="delete"
         EXIT DISPLAY
      ON ACTION modify
         LET g_action_choice="modify"
         EXIT DISPLAY
      ON ACTION account_period
         LET g_action_choice="account_period"
         EXIT DISPLAY
 
      ON ACTION first
         CALL t110_fetch('F')
         CALL cl_navigator_setting(g_curs_index, g_row_count)
         IF g_rec_b != 0 THEN
             CALL fgl_set_arr_curr(1)
         END IF
         ACCEPT DISPLAY   
 
      ON ACTION previous
         LET g_action_choice="previous"
          CALL t110_fetch('P')     
         CALL cl_navigator_setting(g_curs_index, g_row_count)
         IF g_rec_b != 0 THEN
             CALL fgl_set_arr_curr(1)
         END IF
         ACCEPT DISPLAY    
 
      ON ACTION jump
         LET g_action_choice="jump"
         CALL t110_fetch('/')
         CALL cl_navigator_setting(g_curs_index, g_row_count)
         IF g_rec_b != 0 THEN
             CALL fgl_set_arr_curr(1)
         END IF
         ACCEPT DISPLAY    
 
      ON ACTION next
         LET g_action_choice="next"
         CALL t110_fetch('N')
         CALL cl_navigator_setting(g_curs_index, g_row_count)
         IF g_rec_b != 0 THEN
             CALL fgl_set_arr_curr(1)
         END IF
         ACCEPT DISPLAY   
 
      ON ACTION last
         LET g_action_choice="last"
         CALL t110_fetch('L')
         CALL cl_navigator_setting(g_curs_index, g_row_count)
         IF g_rec_b != 0 THEN
             CALL fgl_set_arr_curr(1)
         END IF
         ACCEPT DISPLAY    
 
      ON ACTION reproduce
         LET g_action_choice="reproduce"
         EXIT DISPLAY
      ON ACTION detail
         LET g_action_choice="detail"
         LET l_ac = 1
         EXIT DISPLAY
      ON ACTION output
         LET g_action_choice="output"
         EXIT DISPLAY
      ON ACTION help
         LET g_action_choice="help"
         EXIT DISPLAY
      ON ACTION exit
         LET g_action_choice="exit"
         EXIT DISPLAY
      ON ACTION controlg
         LET g_action_choice="controlg"
         EXIT DISPLAY
      ON ACTION accept
         LET l_ac1 = ARR_CURR()
         LET g_jump = l_ac1
         LET g_no_ask = TRUE
         LET g_bp_flag = NULL
         CALL t110_fetch('/')
         CALL cl_set_comp_visible("info", FALSE)
         CALL cl_set_comp_visible("info", TRUE)
         CALL cl_set_comp_visible("page2", FALSE)
         CALL ui.interface.refresh()
         CALL cl_set_comp_visible("page2", TRUE)
         EXIT DISPLAY
      ON ACTION cancel
         LET INT_FLAG=FALSE 		
         LET g_action_choice="exit"
         EXIT DISPLAY
 
      ON ACTION on_hold      #留置
         LET g_action_choice="on_hold"
         EXIT DISPLAY
 
      ON ACTION undo_on_hold #取消留置
         LET g_action_choice="undo_on_hold"
         EXIT DISPLAY
 
      ON ACTION mul_invoice  #多發票
         LET g_action_choice="mul_invoice"
         EXIT DISPLAY
 
      ON ACTION single_invoice
         LET g_action_choice="single_invoice"
         EXIT DISPLAY
 
      ON ACTION mul_debit #多借方
         LET g_action_choice="mul_debit"
         EXIT DISPLAY
 
      ON ACTION contra_tmp_est #沖暫估
         LET g_action_choice="contra_tmp_est"
         EXIT DISPLAY
 
      ON ACTION memo #備註
         LET g_action_choice="memo"
         EXIT DISPLAY
 
      ON ACTION var_process #差異處理
         LET g_action_choice="var_process"
         EXIT DISPLAY
 
      ON ACTION contra #沖帳
         LET g_action_choice="contra"
         EXIT DISPLAY
 
      ON ACTION revert #還款
         LET g_action_choice="revert"
         EXIT DISPLAY
 
      ON ACTION revert_query #還款查詢
         LET g_action_choice="revert_query"
         EXIT DISPLAY
 
      ON ACTION modify_date #日期修正
         LET g_action_choice="modify_date"
         EXIT DISPLAY

      ON ACTION pay_direct #直接付款
         LET g_action_choice="pay_direct"
         EXIT DISPLAY
 
      ON ACTION gen_entry #會計分錄產生
         LET g_action_choice="gen_entry"
         EXIT DISPLAY
 
      ON ACTION entry_sheet #分錄底稿
         LET g_action_choice="entry_sheet"
         EXIT DISPLAY
 
      ON ACTION entry_sheet2 #分錄底稿
         LET g_action_choice="entry_sheet2"
         EXIT DISPLAY
 
      ON ACTION T_T_entry_sheet #分錄底稿
         LET g_action_choice="T_T_entry_sheet"
         EXIT DISPLAY
 
      ON ACTION T_T_entry_sheet2 #分錄底稿2
         LET g_action_choice="T_T_entry_sheet2"
         EXIT DISPLAY
 
      ON ACTION carry_voucher #傳票拋轉  
         LET g_action_choice="carry_voucher"  
         EXIT DISPLAY
 
      ON ACTION undo_carry_voucher #傳票拋轉還原 
         LET g_action_choice="undo_carry_voucher" 
         EXIT DISPLAY
 
      ON ACTION appor_expense
         LET g_action_choice="appor_expense"
         EXIT DISPLAY
 
      ON ACTION qry_contra_tmp_est
         LET g_action_choice="qry_contra_tmp_est"
         EXIT DISPLAY
 
      ON ACTION qry_bill_allowance
         LET g_action_choice="qry_bill_allowance"
         EXIT DISPLAY
 
      ON ACTION qry_contra #沖帳查詢
         LET g_action_choice="qry_contra"
         EXIT DISPLAY
 
     ON ACTION easyflow_approval        
       LET g_action_choice = "easyflow_approval"
       EXIT DISPLAY
 
      ON ACTION confirm #確認
         LET g_action_choice="confirm"
         EXIT DISPLAY
 
      ON ACTION undo_confirm #取消確認
         LET g_action_choice="undo_confirm"
         EXIT DISPLAY
 
      ON ACTION void #作廢
         LET g_action_choice="void"
         EXIT DISPLAY
 
      #FUN-D20035---add---str
      ON ACTION undo_void #取消作廢 
         LET g_action_choice="undo_void"
         EXIT DISPLAY
      #FUN-D20035---add---end
 
      ON ACTION maintain_misc_vender
         LET g_action_choice="qry_vender"
         EXIT DISPLAY
 
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE DISPLAY
 
      ON ACTION about        
         CALL cl_about()    
 
      ON ACTION exporttoexcel
         LET g_action_choice = 'exporttoexcel'
         EXIT DISPLAY
 
      ON ACTION agree
         LET g_action_choice = 'agree'
         EXIT DISPLAY
 
      ON ACTION deny
         LET g_action_choice = 'deny'
         EXIT DISPLAY
 
      ON ACTION modify_flow
         LET g_action_choice = 'modify_flow'
         EXIT DISPLAY
 
      ON ACTION withdraw
         LET g_action_choice = 'withdraw'
         EXIT DISPLAY
 
      ON ACTION org_withdraw
         LET g_action_choice = 'org_withdraw'
         EXIT DISPLAY
 
      ON ACTION phrase
         LET g_action_choice = 'phrase'
         EXIT DISPLAY
 
       ON ACTION approval_status   
         LET g_action_choice="approval_status"
         EXIT DISPLAY
 
      ON ACTION related_document                #相關文件
         LET g_action_choice="related_document"          
         EXIT DISPLAY
 
      AFTER DISPLAY
        CONTINUE DISPLAY
      
      ON ACTION controls                                                                                           
         CALL cl_set_head_visible("","AUTO") 
 
      &include "qry_string.4gl"
#No.FUN-A30106 --begin                                                          
      ON ACTION drill_down                                                      
         LET g_action_choice="drill_down"                                       
         EXIT DISPLAY                                                           
#No.FUN-A30106 --end 
 
   END DISPLAY
   #TQC-D20011--add--str--
   IF g_action_choice = " " THEN
      CALL cl_set_act_visible("accept,cancel",FALSE)
   ELSE
   #TQC-D20011--add--end
   CALL cl_set_act_visible("accept,cancel", TRUE)
   END IF  #TQC-D20011 add
END FUNCTION
FUNCTION t210_list_bp(p_ud)
   DEFINE   p_ud   LIKE type_file.chr1  
 
   IF p_ud <> "G" OR g_action_choice = "detail" THEN
      RETURN
   END IF
 
   LET g_action_choice = " "
 
   CALL cl_set_act_visible("accept,cancel", FALSE)
   IF g_aza.aza23 MATCHES '[ Nn]' THEN
     CALL cl_set_act_visible("easyflow_approval,approval_status",FALSE)
   END IF
 
   IF g_aza.aza63 ='N' THEN
      CALL cl_set_act_visible("entry_sheet2,T_T_entry_sheet2",FALSE)  
   END IF
 
   DISPLAY ARRAY g_apa_1 TO s_apa_1.* ATTRIBUTE(COUNT=g_rec_b2)
 
      BEFORE DISPLAY
         CALL cl_navigator_setting( g_curs_index, g_row_count )
         IF g_rec_b2 != 0 THEN
            CALL fgl_set_arr_curr(g_curs_index)
         END IF
         IF g_aptype = '15' OR                     
            g_aptype = '13' OR g_aptype = '17' THEN
            CALL cl_set_comp_visible("apb21",FALSE)
         END IF
 
      BEFORE ROW
         LET l_ac = ARR_CURR()
         CALL cl_show_fld_cont()   

      ON ACTION main
         LET g_bp_flag = 'main'
         LET l_ac1 = ARR_CURR()
         LET g_jump = l_ac1
         LET g_no_ask = TRUE
         IF g_rec_b2 >0 THEN
             CALL t110_fetch('/')
         END IF
         CALL cl_set_comp_visible("Page2", FALSE)
         CALL cl_set_comp_visible("Info", FALSE)
         CALL ui.interface.refresh()
         CALL cl_set_comp_visible("Page2", TRUE)
         CALL cl_set_comp_visible("Info", TRUE)
         EXIT DISPLAY
         
      ON ACTION locale
         CALL cl_dynamic_locale()
         CALL cl_show_fld_cont() 
         LET g_chr2= 'N'
         CALL cl_set_field_pic(g_apa.apa41,g_chr2,"","",g_apa.apa42,g_apa.apaacti)
         LET g_action_choice = 'locale'
         EXIT DISPLAY
      ON ACTION insert
         LET g_action_choice="insert"
         EXIT DISPLAY
      ON ACTION query
         LET g_action_choice="query"
         EXIT DISPLAY
      ON ACTION delete
         LET g_action_choice="delete"
         EXIT DISPLAY
      ON ACTION modify
         LET g_action_choice="modify"
         EXIT DISPLAY
      ON ACTION first
         LET g_action_choice="first"
         EXIT DISPLAY
         ACCEPT DISPLAY    
      ON ACTION previous
         LET g_action_choice="previous"
         EXIT DISPLAY
         ACCEPT DISPLAY 
      ON ACTION jump
         LET g_action_choice="jump"
         EXIT DISPLAY
         ACCEPT DISPLAY    
      ON ACTION next
         LET g_action_choice="next"
         EXIT DISPLAY
         ACCEPT DISPLAY  
      ON ACTION last
         LET g_action_choice="last"
         EXIT DISPLAY
         ACCEPT DISPLAY    
      ON ACTION detail
         LET g_action_choice="detail"
         LET l_ac = 1
         EXIT DISPLAY
      ON ACTION help
         LET g_action_choice="help"
         EXIT DISPLAY
      ON ACTION exit
         LET g_action_choice="exit"
         EXIT DISPLAY
      ON ACTION account_period
         LET g_action_choice="account_period"
         EXIT DISPLAY
      ON ACTION output
         LET g_action_choice="output"
         EXIT DISPLAY
 
      ON ACTION controlg
         LET g_action_choice="controlg"
         EXIT DISPLAY
 
      ON ACTION contra_tmp_est #沖暫估
         LET g_action_choice="contra_tmp_est"
         EXIT DISPLAY
 
      ON ACTION gen_entry #會計分錄產生
         LET g_action_choice="gen_entry"
         EXIT DISPLAY
 
      ON ACTION entry_sheet #分錄底稿
         LET g_action_choice="entry_sheet"
         EXIT DISPLAY
 
      ON ACTION entry_sheet2 #分錄底稿
         LET g_action_choice="entry_sheet2"
         EXIT DISPLAY
 
      ON ACTION T_T_entry_sheet #分錄底稿
         LET g_action_choice="T_T_entry_sheet"
         EXIT DISPLAY
 
      ON ACTION T_T_entry_sheet2 #分錄底稿2
         LET g_action_choice="T_T_entry_sheet2"
         EXIT DISPLAY
 
      ON ACTION carry_voucher #傳票拋轉  
         LET g_action_choice="carry_voucher"  
         EXIT DISPLAY
 
      ON ACTION undo_carry_voucher #傳票拋轉還原 
         LET g_action_choice="undo_carry_voucher" 
         EXIT DISPLAY
 
      ON ACTION void #作廢
         LET g_action_choice="void"
         EXIT DISPLAY

      #FUN-D20035---add---str
      ON ACTION undo_void #取消作廢 
         LET g_action_choice="undo_void"
         EXIT DISPLAY
      #FUN-D20035---add---end
 
      ON ACTION on_hold #留置
         LET g_action_choice="on_hold"
         EXIT DISPLAY
 
      ON ACTION undo_on_hold #取消留置
         LET g_action_choice="undo_on_hold"
         EXIT DISPLAY
 
      ON ACTION mul_invoice #多發票
         LET g_action_choice="mul_invoice"
         EXIT DISPLAY
 
     ON ACTION invoice_detail  #發票明細
        LET g_action_choice="invoice_detail"
        EXIT DISPLAY

         ON ACTION single_invoice
         LET g_action_choice="single_invoice"
         EXIT DISPLAY
 
      ON ACTION qry_contra #沖帳查詢
         LET g_action_choice="qry_contra"
         EXIT DISPLAY
 
      ON ACTION memo #備註
         LET g_action_choice="memo"
         EXIT DISPLAY
 
      ON ACTION easyflow_approval   
         LET g_action_choice = "easyflow_approval"
         EXIT DISPLAY
 
      ON ACTION confirm #確認
         LET g_action_choice="confirm"
         EXIT DISPLAY
 
      ON ACTION undo_confirm #取消確認
         LET g_action_choice="undo_confirm"
         EXIT DISPLAY
 
      ON ACTION accept
         LET l_ac1 = ARR_CURR()
         LET g_jump = l_ac1
         LET g_no_ask = TRUE
         LET g_bp_flag = NULL
         CALL t110_fetch('/')
         CALL cl_set_comp_visible("info", FALSE)
         CALL cl_set_comp_visible("page2", FALSE)
         CALL ui.interface.refresh()
         CALL cl_set_comp_visible("info", TRUE)
         CALL cl_set_comp_visible("page2", TRUE)
         EXIT DISPLAY

      ON ACTION cancel
             LET INT_FLAG=FALSE 		
         LET g_action_choice="exit"
         EXIT DISPLAY
 
      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE DISPLAY
 
      ON ACTION about        
         CALL cl_about()     
 
      ON ACTION exporttoexcel
         LET g_action_choice = 'exporttoexcel'
         EXIT DISPLAY
 
      ON ACTION agree
         LET g_action_choice = 'agree'
         EXIT DISPLAY
 
      ON ACTION deny
         LET g_action_choice = 'deny'
         EXIT DISPLAY
 
      ON ACTION modify_flow
         LET g_action_choice = 'modify_flow'
         EXIT DISPLAY
 
      ON ACTION withdraw
         LET g_action_choice = 'withdraw'
         EXIT DISPLAY
 
      ON ACTION org_withdraw
         LET g_action_choice = 'org_withdraw'
         EXIT DISPLAY
 
      ON ACTION phrase
         LET g_action_choice = 'phrase'
         EXIT DISPLAY
 
       ON ACTION approval_status   
         LET g_action_choice="approval_status"
         EXIT DISPLAY
 
      ON ACTION related_document                #相關文件
         LET g_action_choice="related_document"          
         EXIT DISPLAY
 
      AFTER DISPLAY
        CONTINUE DISPLAY
      
      ON ACTION controls                                                                                      
         CALL cl_set_head_visible("","AUTO") 
 
      &include "qry_string.4gl"                                                        
      ON ACTION drill_down                                                      
         LET g_action_choice="drill_down"                                       
         EXIT DISPLAY                                                           
   END DISPLAY
   #TQC-D20011--add--str--
   IF g_action_choice = " " THEN
      CALL cl_set_act_visible("accept,cancel",FALSE)
   ELSE
   #TQC-D20011--add--end
   CALL cl_set_act_visible("accept,cancel", TRUE)
   END IF  #TQC-D20011 add
END FUNCTION

FUNCTION t110_list_fill()
   DEFINE l_apa01   LIKE apa_file.apa01,
          l_i       LIKE type_file.num10

    IF g_prog = 'aapq230' THEN RETURN END IF   #FUN-D80049 add 無法正常顯示的bug
    CALL g_apa_1.clear()
    LET l_i = 1
   FOREACH t110_list_cs INTO l_apa01
      IF SQLCA.sqlcode THEN
          CALL cl_err('foreach t110_list_cs',SQLCA.sqlcode,1)
          CONTINUE FOREACH
       END IF
      SELECT apa01,apa02,apa05,'',apa06,apa07,apa36,'',apa13,
             apa15,apa16,apa08,apa11,'',apa12,apa31f,apa31,
             apa34f,apa34,apa35f,apa35,apa44,apa41,apa63
        INTO g_apa_1[l_i].*
        FROM apa_file
       WHERE apa01=l_apa01
      SELECT pmc03 INTO g_apa_1[l_i].pmc03_1 FROM pmc_file
       WHERE pmc01=g_apa_1[l_i].apa05_1
      SELECT apr02 INTO g_apa_1[l_i].apr02_1 FROM apr_file
       WHERE apr01=g_apa_1[l_i].apa36_1
      SELECT pma02 INTO g_apa_1[l_i].pma02_1 FROM pma_file
       WHERE pma01=g_apa_1[l_i].apa11_1
      LET l_i = l_i + 1
      IF l_i > g_max_rec THEN
         IF g_action_choice ="query"  THEN
            CALL cl_err( '', 9035, 0 )
         END IF                              
         EXIT FOREACH
      END IF
   END FOREACH
   LET g_rec_b2 = l_i - 1
   DISPLAY ARRAY g_apa_1 TO s_apa_1.* ATTRIBUTE(COUNT=g_rec_b2,UNBUFFERED)
      BEFORE DISPLAY
         EXIT DISPLAY
   END DISPLAY
END FUNCTION 



#No.FUN-D70028 ---Add--- Start
FUNCTION t110_e()
   DEFINE l_amtf         LIKE type_file.num20_6
   DEFINE l_amt          LIKE type_file.num20_6
   DEFINE l_oov04        LIKE oov_file.oov04
   DEFINE cnt1           LIKE type_file.num5
   DEFINE i,j,k          LIKE type_file.num5
   DEFINE l_sql          STRING
   DEFINE p_cmd          LIKE type_file.chr1
   DEFINE g_oov          DYNAMIC ARRAY OF RECORD
             oov02       LIKE oov_file.oov02,
             oov03       LIKE oov_file.oov03,
             oma032      LIKE oma_file.oma032,
             oma10       LIKE oma_file.oma10,
             oma24       LIKE oma_file.oma24,
             oov05       LIKE oov_file.oov05,
             omc08       LIKE omc_file.omc08,
             omc09       LIKE omc_file.omc09,
             un_recf     LIKE oov_file.oov04,
             un_rec      LIKE oov_file.oov04,
             oov04f      LIKE oov_file.oov04,
             oov04       LIKE oov_file.oov04
                    END RECORD
   DEFINE g_oov_t        RECORD
             oov02       LIKE oov_file.oov02,
             oov03       LIKE oov_file.oov03,
             oma032      LIKE oma_file.oma032,
             oma10       LIKE oma_file.oma10,
             oma24       LIKE oma_file.oma24,
             oov05       LIKE oov_file.oov05,
             omc08       LIKE omc_file.omc08,
             omc09       LIKE omc_file.omc09,
             un_recf     LIKE oov_file.oov04,
             un_rec      LIKE oov_file.oov04,
             oov04f      LIKE oov_file.oov04,
             oov04       LIKE oov_file.oov04
                    END RECORD
   DEFINE l_oma23        LIKE oma_file.oma23
   DEFINE l_omaconf      LIKE oma_file.omaconf
   DEFINE l_oma55        LIKE oma_file.oma55
   DEFINE l_oma57        LIKE oma_file.oma57
   DEFINE l_sumf,l_sum   LIKE oma_file.oma56t
   DEFINE l_sumf_h       LIKE oma_file.oma56t
   DEFINE l_sum_h        LIKE oma_file.oma56t
   DEFINE l_lock_sw      LIKE type_file.chr1
   DEFINE l_k,l_over     LIKE type_file.num5
   DEFINE l_allow_insert LIKE type_file.num5                  #可新增否
   DEFINE l_allow_delete LIKE type_file.num5                  #可刪除否
   DEFINE ls_rec_b       LIKE type_file.num10
   DEFINE l_oma03        LIKE oma_file.oma03
   DEFINE l_omc13        LIKE omc_file.omc13
   DEFINE l_oma61        LIKE oma_file.oma61
   DEFINE l_i            LIKE type_file.num5
   DEFINE l_omc13f       LIKE omc_file.omc13
   DEFINE l_n1           LIKE type_file.num5
   DEFINE l_n2           LIKE type_file.num5
   DEFINE l_omc10_sum    LIKE type_file.num5
   DEFINE l_omc11_sum    LIKE type_file.num5
   DEFINE l_n            LIKE type_file.num5   #FUN-D80049 add
   DEFINE l_oma00        LIKE oma_file.oma00   #FUN-D80049 add
   DEFINE l_apa00        LIKE apa_file.apa00   #FUN-D80049 add

   SELECT * INTO g_apa.* FROM apa_file
    WHERE apa01=g_apa.apa01
      AND apalegal = g_legal
   SELECT * INTO g_ooz.* FROM ooz_file   #FUN-D80049 add

   IF g_apa.apa00 != '14' THEN
      RETURN
   END IF
   IF g_apa.apa41 = 'Y' THEN
      CALL cl_err(g_apa.apa01,'aap-005',0)
      RETURN
   END IF
   IF g_apa.apa63 MATCHES '[1]' THEN
      CALL cl_err('','mfg3557',0)
      RETURN
   END IF

   LET g_success='Y'
   LET g_apa_t.* = g_apa.*
   BEGIN WORK
   CALL t110_lock_cl()
   OPEN t110_cl USING g_apa.apa01
   IF STATUS THEN
      CALL cl_err("OPEN t110_cl k:", STATUS, 1)
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF
   FETCH t110_cl INTO g_apa.*                        # 鎖住將被更改或取消的資料
   IF SQLCA.sqlcode THEN
      CALL cl_err(g_apa.apa01,SQLCA.sqlcode,0)      # 資料被他人LOCK
      CLOSE t110_cl
      ROLLBACK WORK
      RETURN
   END IF

   OPEN WINDOW t100_kkk_w AT 12,2 WITH FORM "aap/42f/aapt140_a"
           ATTRIBUTE (STYLE = g_win_style CLIPPED)

      CALL cl_ui_locale("aapt140_a")

      SELECT COUNT(*) INTO cnt1 FROM oov_file
       WHERE oov01 = g_apa.apa01
         AND oovlegal = g_legal

     #沒有沖帳扣費用則抓取所有符合條件的帳扣費用
      IF cnt1 = 0 THEN
         IF g_ooz.ooz07 = 'N' THEN
            LET l_sql = "SELECT oma01,oma032,oma10,oma24,omc02,omc08,",
                             "      (omc08-omc10),0,omc09,(omc09-omc11),0 ",
                             "  FROM oma_file,omc_file ",
                            " WHERE oma03 = '",g_apa.apa06,"' ",
                             "   AND oma00 = '10'  ",
                             "   AND omc09 > omc11 ",
                        "   AND omc01 = oma01 ",
                             "   AND (oma56t-oma57) <> 0",
                        "   AND omalegal = '",g_legal CLIPPED,"' ",
                        "   AND omaconf = 'Y' AND omavoid != 'Y' ",
                        "   AND oma23 = '",g_apa.apa13,"'",                 #FUN-D80049  #加上币别的限制
                        #FUN-D80049 ----- add ----- begin
                        " UNION ",
                        "SELECT apa01,apa07,apa08,apa14,1,apa34f,(apa34f-apa35f),",
                        "       0,apa34,(apa34-apa35),0 ",
                        "  FROM apa_file ",
                        " WHERE apa06 = '",g_apa.apa06,"' ",
                        "   AND apa00 = '23' ",
                        "   AND apa34 > apa35 ",
                        "   AND apalegal = '",g_legal CLIPPED,"' ",
                        "   AND apa41 = 'Y' AND apa42 != 'Y' ",
                        "   AND apa13 = '",g_apa.apa13,"'"                 #FUN-D80049  #加上币别的限制
                        #FUN-D80049 ----- add ----- end
         ELSE
            LET l_sql = "SELECT oma01,oma032,oma10,oma24,omc02,omc08,",
                             "       (omc08-omc10),0,omc09,omc13,0 ",
                             "  FROM oma_file,omc_file ",
                             " WHERE oma03 = '",g_apa.apa06,"' ",
                             "   AND oma00 = '10'  ",
                             "   AND omc13 > 0 ",
                        "   AND omc01 = oma01 " ,
                             "   AND (oma56t-oma57) <> 0",
                             "   AND omalegal = '",g_legal CLIPPED,"' ",
                        "   AND omaconf = 'Y' AND omavoid != 'Y' ",
                        "   AND oma23 = '",g_apa.apa13,"'",                 #FUN-D80049  #加上币别的限制
                        #FUN-D80049 ----- add ----- begin
                        " UNION ",
                        "SELECT apa01,apa07,apa08,apa14,1,apa34f,(apa34f-apa35f),",
                        "       0,apa34,apa73,0 ",
                        "  FROM apa_file ",
                        " WHERE apa06 = '",g_apa.apa06,"' ",
                        "   AND apa00 = '23' ",
                        "   AND apa34 <> apa35 ",
                        "   AND apa73 > 0 ",
                        "   AND apalegal = '",g_legal CLIPPED,"' ",
                        "   AND apa41 = 'Y' AND apa42 != 'Y' ",
                        "   AND apa13 = '",g_apa.apa13,"'"                 #FUN-D80049  #加上币别的限制
                        #FUN-D80049 ----- add ----- end
         END IF
         PREPARE t300_k2_p0 FROM l_sql
         DECLARE t300_k2_c0 CURSOR FOR t300_k2_p0
         CALL g_oov.clear()
         LET i = 1

         FOREACH t300_k2_c0 INTO g_oov[i].oov03,  g_oov[i].oma032,g_oov[i].oma10,
                                                g_oov[i].oma24,  g_oov[i].oov05, g_oov[i].omc08,
                                                g_oov[i].un_recf,g_oov[i].oov04f,g_oov[i].omc09,
                                                g_oov[i].un_rec, g_oov[i].oov04

            IF cl_null(g_oov[i].oov03) THEN
               EXIT FOREACH
            END IF
            LET g_oov[i].oov02 = i

            INSERT INTO oov_file(oov01,oov02,oov03,oov04f,oov04,oov05,oovlegal)
               VALUES (g_apa.apa01,i,g_oov[i].oov03,0,0,g_oov[i].oov05,g_legal)
            LET i = i + 1
            IF i > g_max_rec THEN
               EXIT FOREACH
            END IF
         END FOREACH
         CALL g_oov.deleteElement(i)
         LET ls_rec_b = i - 1
      END IF

  #有沖帳扣費用則抓取資料
   IF cnt1 > 0 THEN
      IF g_ooz.ooz07 = 'N' THEN
         LET l_sql = "SELECT oov02,oov03,oma032,oma10,oma24,oov05,omc08,omc09, ",
                     "      (omc08-omc10),(omc09-omc11 ),oov04f,oov04 ",
# FUN-D80049 ----------- mark ---------- begin
#                    "  FROM oov_file LEFT OUTER JOIN oma_file ON oov_file.oov03 = oma_file.oma01 ",
#                    "                LEFT OUTER JOIN omc_file ON omc_file.omc01 = oov_file.oov03 ",
#                    "                                        AND omc_file.omc02 = oov_file.oov05 ",
# FUN-D80049 ----------- mark ---------- end
                     #FUN-D80049 ----------- add ---------- begin
                     "  FROM oov_file LEFT OUTER JOIN omc_file ON omc_file.omc01 = oov_file.oov03 ",
                     "                                        AND omc_file.omc02 = oov_file.oov05 ",
                     "                ,oma_file ",
                     #FUN-D80049 ----------- add ---------- end
                     " WHERE oov01 = '",g_apa.apa01,"' ",
                     "   AND oovlegal = '",g_legal CLIPPED,"' ",
                     "   AND oma01 = oov03 ",                      #FUN-D80049 add
                     "   AND oma00 = '10' ",                       #FUN-D80049 add
                     #FUN-D80049 ----------- add ---------- begin 來源 aapq230
                     " UNION ",
                     "SELECT oov02,oov03,apa07,apa08,apa14,oov05,apa34f,apa34, ",
                     "       (apa34f-apa35f),(apa34-apa35),oov04f,oov04 ",
                     "  FROM oov_file,apa_file ",
                     " WHERE oov01 = '",g_apa.apa01,"' ",
                     "   AND apa00 ='23' AND apa01 = oov03 ",
                     "   AND oovlegal = '",g_legal CLIPPED,"' ",
                     #FUN-D80049 ----------- add ---------- end
                     " ORDER BY oov02 "
      ELSE
         LET l_sql = "SELECT oov02,oov03,oma032,oma10,oma24,oov05,omc08,omc09, ",
                     "      (omc08-omc10),omc13,oov04f,oov04 ",
# FUN-D80049 ----------- mark ---------- begin
#                    "  FROM oov_file LEFT OUTER JOIN oma_file ON oov_file.oov03 = oma_file.oma01 ",
#                    "                LEFT OUTER JOIN omc_file ON omc_file.omc01 = oov_file.oov03 ",
#                    "                                        AND omc_file.omc02 = oov_file.oov05 ",
# FUN-D80049 ----------- mark ---------- end
                     " WHERE oov01 = '",g_apa.apa01,"' ",
                     "   AND oma01 = oov03 ",             #FUN-D80049 add
                     "   AND oma00 = '10' ",                       #FUN-D80049 add
                     "   AND oovlegal = '",g_legal CLIPPED,"' ",
                     #FUN-D80049 ----------- add ---------- begin 來源 aapq230
                     " UNION ",
                     "SELECT oov02,oov03,apa07,apa08,apa14,oov05,apa34f,apa34, ",
                     "       (apa34f-apa35f),apa73,oov04f,oov04 ",
                     "  FROM oov_file ,apa_file",
                     " WHERE oov01 = '",g_apa.apa01,"' ",
                     "   AND oov03 = apa01 AND apa00 ='23' ",
                     "   AND oovlegal = '",g_legal CLIPPED,"' ",
                     #FUN-D80049 ----------- add ---------- end
                               " ORDER BY oov02 "
      END IF
      PREPARE t300_k2_p FROM l_sql
      DECLARE t300_k2_c CURSOR FOR t300_k2_p

      CALL g_oov.clear()
      LET k = 1
      LET g_apa.apa65f = 0
      LET g_apa.apa65 = 0

      FOREACH t300_k2_c INTO g_oov[k].*
         LET g_apa.apa65f = g_apa.apa65f + g_oov[k].oov04f
         LET g_apa.apa65 = g_apa.apa65 + g_oov[k].oov04
              LET k = k + 1
              IF k > g_max_rec THEN
                 EXIT FOREACH
              END IF
      END FOREACH
      CALL g_oov.deleteElement(k)
      LET ls_rec_b = k - 1
   END IF

   LET l_sumf_h = g_apa.apa65f
   LET l_sum_h  = g_apa.apa65

   DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
   LET l_allow_insert = cl_detail_input_auth("insert")
   LET l_allow_delete = cl_detail_input_auth("delete")

   LET i = 1
   INPUT ARRAY g_oov WITHOUT DEFAULTS FROM s_oov.*
           ATTRIBUTE(COUNT=ls_rec_b,MAXCOUNT=g_max_rec,UNBUFFERED,
                   INSERT ROW=l_allow_insert,DELETE ROW=l_allow_delete,APPEND ROW=l_allow_insert)

      BEFORE INSERT
         LET i = ARR_CURR()
         LET p_cmd='a'
         INITIALIZE g_oov[i].* TO NULL
         LET g_oov_t.* = g_oov[i].*
         NEXT FIELD oov02

      AFTER INSERT
         IF INT_FLAG THEN
            CALL cl_err('',9001,0)
            LET INT_FLAG = 0
            CANCEL INSERT
         END IF
         IF g_oov[i].oov03 IS NULL THEN
                 CALL g_oov.deleteElement(i)
            NEXT FIELD oov02
            CANCEL INSERT
         END IF
         INSERT INTO oov_file(oov01,oov02,oov03,oov04f,oov04,oov05,oovlegal)
            VALUES(g_apa.apa01,g_oov[i].oov02,g_oov[i].oov03,
                   g_oov[i].oov04f,g_oov[i].oov04,g_oov[i].oov05,g_legal)
         IF SQLCA.sqlcode THEN
            CALL cl_err3("ins","oov_file",g_apa.apa01,g_oov[i].oov03,SQLCA.sqlcode,"","ins oov:",1)
            LET g_success = 'N'
            CANCEL INSERT
         ELSE
            LET ls_rec_b = ls_rec_b + 1
            MESSAGE "insert ok"
                 IF g_success = 'Y' THEN
                    SELECT SUM(oov04f),SUM(oov04) INTO g_apa.apa65f,g_apa.apa65
                      FROM oov_file
                     WHERE oov01=g_apa.apa01
                       AND oovlegal = g_legal
                    IF cl_null(g_apa.apa65f) THEN
                       LET g_apa.apa65f = 0
                    END IF
               IF cl_null(g_apa.apa65) THEN
                  LET g_apa.apa65 = 0
               END IF
               DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
               UPDATE apa_file SET apa65f = g_apa.apa65f,apa65 = g_apa.apa65
                WHERE apa01 = g_apa.apa01
               IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
                  CALL cl_err3("upd","apa_file", g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)
                  LET g_success='N'
                  IF p_cmd = 'u' THEN
                     LET g_oov[i].*=g_oov_t.*
                  END IF
               END IF
               UPDATE omc_file set omc10 = omc10 + g_oov[i].oov04f,
                                   omc11 = omc11 + g_oov[i].oov04,
                                                       omc13 = omc13 - g_oov[i].oov04
                WHERE omc01 = g_oov[i].oov03
                  AND omc02 = g_oov[i].oov05
               #FUN-D80049 ----------- add ---------- begin #檢查是否存在omc_file如果不存在，則檢查更新apa00=23的資料
               SELECT NVL(COUNT(*),0) INTO l_n FROM omc_file WHERE omc01 = g_oov[i].oov03
               IF l_n <=0 THEN
                  UPDATE apa_file SET apa35f = apa35f + g_oov[i].oov04f,
                                      apa35  = apa35  + g_oov[i].oov04,
                                      apa73  = apa73  - g_oov[i].oov04
                   WHERE apa01 = g_oov[i].oov03 AND apa00 = '23'
               ELSE
                  UPDATE oma_file SET oma55 = oma55 + g_oov[i].oov04f,
                                      oma57 = oma57 +  g_oov[i].oov04,
                                      oma61 = oma61 - g_oov[i].oov04
                   WHERE oma01 = g_oov[i].oov03
                     AND oma00 = '10'
               END IF
               #FUN-D80049 ----------- add ---------- end

                 END IF
              END IF

      BEFORE INPUT
         IF ls_rec_b != 0 THEN
            CALL fgl_set_arr_curr(i)
         END IF
         LET g_before_input_done = FALSE
         CALL t110_set_entry_oov('a')
         CALL t110_set_no_entry_oov('a')
         LET g_before_input_done = TRUE

      BEFORE ROW
         LET p_cmd = ''
         LET i = ARR_CURR()
         LET l_lock_sw = 'N'
         IF ls_rec_b >= i THEN
            LET p_cmd='u'
            LET g_oov_t.* = g_oov[i].*
            #-->鎖住待抵沖帳資料
#           IF cl_null(g_oov[i].oov05) THEN  #FUN-D80049 mark
            #FUN-D80049 ----- add ----- begin
               LET l_n = 0                                                               #FUN-D80049
               SELECT NVL(COUNT(*),0) INTO l_n FROM oma_file WHERE oma01 = g_oov[i].oov03  #FUN-D80049
               IF l_n <= 0 THEN                                                           #FUN-D80049
                  IF g_ooz.ooz07 = 'N' THEN
                     LET g_forupd_sql = "SELECT apa07,apa08,apa14,apa34f,(apa34f-apa35f),",
                                        "       apa34,(apa34-apa35) ",
                                        "  FROM apa_file ",
                                        " WHERE apa01 = ? "
                  ELSE
                     LET g_forupd_sql = "SELECT apa07,apa08,apa14,apa34f,(apa34f-apa35f),",
                                        "       apa34,apa73 ",
                                        "  FROM apa_file ",
                                        " WHERE apa01 = ?"
                  END IF
                  LET g_forupd_sql = g_forupd_sql," FOR UPDATE "
                  LET g_forupd_sql = cl_forupd_sql(g_forupd_sql)
               ELSE
               #FUN-D80049 ----- add ----- end
                  IF g_ooz.ooz07 = 'N' THEN
                     LET g_forupd_sql = "SELECT oma032,oma10,oma24,oma54t,(oma54t-oma55),",
                                        "       oma56t,(oma56t-oma57) FROM oma_file"
                  ELSE
                     LET g_forupd_sql = "SELECT oma032,oma10,oma24,oma54t,(oma54t-oma55),",
                                        "       oma56t,oma61 FROM oma_file"
                  END IF
               END IF   #FUN-D80049  add
               LET g_forupd_sql = g_forupd_sql," WHERE oma01=? FOR UPDATE"
               LET g_forupd_sql = cl_forupd_sql(g_forupd_sql)
               DECLARE t300_k2_cr CURSOR FROM g_forupd_sql

               OPEN t300_k2_cr USING g_oov_t.oov03
               IF STATUS THEN
                  CALL cl_err("OPEN t300_k2_cr:", STATUS, 1)
                  LET l_lock_sw = "Y"
               END IF

               FETCH t300_k2_cr INTO g_oov[i].oma032,g_oov[i].oma10,g_oov[i].oma24,
                                     g_oov[i].omc08,g_oov[i].un_recf,
                                     g_oov[i].omc09,g_oov[i].un_rec
               IF SQLCA.sqlcode THEN
                  CALL cl_err(g_oov_t.oov02,SQLCA.sqlcode,1)
                  LET l_lock_sw = "Y"
               END IF
               LET g_oov[i].omc08 = g_oov[i].omc08 + g_oov[i].oov04f
               LET g_oov[i].omc09 = g_oov[i].omc09 + g_oov[i].oov04
               LET g_oov[i].un_recf= g_oov[i].un_recf + g_oov[i].oov04f
               LET g_oov[i].un_rec = g_oov[i].un_rec + g_oov[i].oov04
               CALL cl_show_fld_cont()
           #END IF #FUN-D80049 mark
         END IF
         CALL t110_set_entry_oov(p_cmd)
         CALL t110_set_no_entry_oov(p_cmd)

      BEFORE FIELD oov02
         IF cl_null(g_oov[i].oov02) OR g_oov[i].oov02 = 0 THEN
            SELECT MAX(oov02)+1 INTO g_oov[i].oov02 FROM oov_file
             WHERE oov01 = g_apa.apa01
               AND oovlegal = g_legal
            IF cl_null(g_oov[i].oov02)  THEN
               LET g_oov[i].oov02 = 1
            END IF
            LET g_oov[i].oov04f= 0
            LET g_oov[i].oov04 = 0
         END IF

      AFTER FIELD oov02
         IF g_oov_t.oov02 IS NULL OR
            g_oov_t.oov02 != g_oov[i].oov02 THEN
            SELECT COUNT(*) INTO k FROM oov_file
             WHERE oov01 = g_apa.apa01 AND oov02 = g_oov[i].oov02
               AND oovlegal = g_legal
            IF k > 0 THEN
               CALL cl_err('',-239,0)
               NEXT FIELD oov02
            END IF
         END IF


      AFTER FIELD oov03
         IF g_oov_t.oov03 IS NULL OR
            g_oov_t.oov03 != g_oov[i].oov03 THEN
             #若oma00LIKE1*的單據，其omc資料僅為1筆時，對oov05自動賦值為1
            SELECT COUNT(*) INTO l_i FROM omc_file
             WHERE omc01=g_oov[i].oov03
               AND omclegal = g_legal
            IF l_i=1 THEN
               LET g_oov[i].oov05=1
            END IF
         END IF
         IF NOT cl_null(g_oov[i].oov03) THEN
            LET l_oma00 = ''                   #FUN-D80049 add
            LET l_apa00 = ''                   #FUN-D80049 add
#           SELECT oma03 INTO l_oma03 FROM oma_file  #FUN-D80049
            SELECT oma00,oma03 INTO l_oma00,l_oma03 FROM oma_file  #FUN-D80049
             WHERE oma01= g_oov[i].oov03
               AND omalegal = g_legal
            #FUN-D80049 -------- add ---------- begin
            IF l_i <=0 THEN
               SELECT apa00,apa06 INTO l_apa00,l_oma03 FROM apa_file WHERE apa01 =g_oov[i].oov03
               LET g_oov[i].oov05=1
            END IF
            IF SQLCA.sqlcode = 100 THEN
               CALL cl_err('',SQLCA.sqlcode,0)
               LET g_oov[i].oov03 = g_oov_t.oov03
               NEXT FIELD oov03
            END IF
            IF (NOT cl_null(l_oma00) AND l_oma00 != '10') OR
               (NOT cl_null(l_apa00) AND l_apa00 !='23') THEN
               CALL cl_err('','axr-628',0)
               LET g_oov[i].oov03 = g_oov_t.oov03
               NEXT FIELD oov03
            END IF
            #FUN-D80049 -------- add ---------- end
            IF g_apa.apa05 <> l_oma03 THEN
               CALL cl_err('','aap-090',1)
            END IF
         END IF


      AFTER FIELD oov05
         IF NOT cl_null(g_oov[i].oov05) THEN
            IF g_oov[i].oov05 != g_oov_t.oov05 OR cl_null(g_oov_t.oov05) THEN
              #判斷資料是否重復
               IF NOT cl_null(g_oov[i].oov03) THEN
                  SELECT COUNT(*) INTO k FROM oov_file
                   WHERE oov01 = g_apa.apa01 AND oov03 = g_oov[i].oov03 AND oov05=g_oov[i].oov05
                     AND oovlegal = g_legal
                  IF k > 0 THEN
                     CALL cl_err('',-239,0)
                     LET g_oov[i].oov05= NULL
                     NEXT FIELD oov03
                  END IF
               END IF

               LET l_n = 0                                                               #FUN-D80049
               SELECT NVL(COUNT(*),0) INTO l_n FROM oma_file WHERE oma01 = g_oov[i].oov03  #FUN-D80049
               IF l_n > 0 THEN                                                           #FUN-D80049
                  IF g_ooz.ooz07 = 'N' THEN
                     LET g_forupd_sql = "SELECT oma032,oma10,oma23,oma24,omc08,",
                                        "       (omc08-omc10),omc09,(omc09-omc11),",
                                        "       omaconf FROM oma_file,omc_file",
                                        "   WHERE oma01 = ? AND oma00 = '10' ",
                                        "   AND oma03 = '",g_apa.apa06,"' ",
                                        "   AND oma01=omc01 AND omc02= ? ",
                                        "   AND omalegal = '",g_legal CLIPPED,"' ",
                                        "   AND omclegal = '",g_legal CLIPPED,"' "
                  ELSE
                     LET g_forupd_sql = "SELECT oma032,oma10,oma23,oma24,omc08,",
                                        "       (omc08-omc10),omc09,omc13, ",
                                        "       omaconf FROM oma_file,omc_file",
                                        "   WHERE oma01 = ? AND oma00 MATCHES '10' ",
                                        "   AND oma03 = '",g_apa.apa06,"' ",
                                        "   AND omalegal = '",g_legal CLIPPED,"' ",
                                        "   AND omclegal = '",g_legal CLIPPED,"' ",
                                        "   AND oma01=omc01 AND omc02=? "
                  END IF
                  LET g_forupd_sql = g_forupd_sql," AND omaconf = 'Y' AND omavoid != 'Y' FOR UPDATE"
                  LET g_forupd_sql = cl_forupd_sql(g_forupd_sql)
               #FUN-D80049 ----- add ----- begin
               ELSE
                  IF g_ooz.ooz07 = 'N' THEN
                     LET g_forupd_sql = "SELECT apa07,apa08,apa13,apa14,apa34f,(apa34f-apa35f),",
                                        "       apa34,(apa34-apa35),apa41 ",
                                        "  FROM apa_file ",
                                        " WHERE apa06 = '",g_apa.apa06,"' ",
                                        "   AND apa00 = '23' ",
                                        "   AND apalegal = '",g_legal CLIPPED,"' ",
                                        "   AND apa41 = 'Y' AND apa42 != 'Y' ",
                                        "   AND apa01 = ? "
                  ELSE
                     LET g_forupd_sql = "SELECT apa07,apa08,apa13,apa14,apa34f,(apa34f-apa35f),",
                                        "       apa34,apa73,apa41 ",
                                        "  FROM apa_file ",
                                        " WHERE apa06 = '",g_apa.apa06,"' ",
                                        "   AND apa00 = '23' ",
                                        "   AND apalegal = '",g_legal CLIPPED,"' ",
                                        "   AND apa41 = 'Y' AND apa42 != 'Y' ",
                                        "   AND apa01 = ? "
                  END IF
                  LET g_forupd_sql = g_forupd_sql," FOR UPDATE "
                  LET g_forupd_sql = cl_forupd_sql(g_forupd_sql)
               END IF
               #FUN-D80049 ----- add ----- end
               DECLARE t300_k22_cr CURSOR FROM g_forupd_sql
               OPEN t300_k22_cr USING g_oov[i].oov03,g_oov[i].oov05
               IF STATUS THEN
                  CALL cl_err("OPEN t300_k22_cr:", STATUS, 1)
                  CLOSE t300_k22_cr
                  ROLLBACK WORK RETURN
               END IF

               FETCH t300_k22_cr INTO g_oov[i].oma032,g_oov[i].oma10,l_oma23,
                                      g_oov[i].oma24,g_oov[i].omc08,l_amtf,
                                      g_oov[i].omc09,l_amt,l_omaconf
               IF SQLCA.sqlcode THEN
                  CALL cl_err(g_oov[i].oov03,SQLCA.sqlcode,0)
                  LET g_oov[i].oov03 = g_oov_t.oov03
                  CLOSE t300_k22_cr
                  NEXT FIELD oov03
               END IF

              #-->此帳款尚未確認
               IF l_omaconf != 'Y' THEN
                  CALL cl_err(g_oov[i].oov03,'aap-141',0)
                  NEXT FIELD oov03
               END IF

              #-->不可沖不同幣別
               IF l_oma23 != g_apa.apa13 THEN
                  CALL cl_err(g_oov[i].oov03,'aap-014',0)
                  NEXT FIELD oov03
               END IF
              #-->無金額可沖帳
               IF l_amtf <=0 AND l_amt <=0 THEN
                  CALL cl_err(g_oov[i].oov03,'aap-203',0)
                  NEXT FIELD oov03
               END IF
               LET g_oov[i].un_recf= l_amtf
               LET g_oov[i].un_rec = l_amt
            END IF
         END IF

      AFTER FIELD oov04f
         IF NOT cl_null(g_oov[i].oov04f) THEN
                 IF g_oov[i].oov04f < 0 THEN
                    NEXT FIELD oov04f
            END IF
            SELECT SUM(oov04f) INTO l_n1 FROM oov_file
             WHERE oov03 = g_oov[i].oov03
               AND oov05 = g_oov[i].oov05
               AND oov01 != g_apa.apa01
            IF g_oov[i].oov04f > (g_oov[i].omc08 - l_n1) THEN
               CALL cl_err('','cap-001',0)
               NEXT FIELD oov04f
            END IF
                 LET l_oov04 = g_oov[i].oov04f * g_oov[i].oma24
                 CALL cl_digcut(l_oov04,g_azi04)  RETURNING l_oov04
                 LET g_oov[i].oov04 = l_oov04
            LET g_oov[i].un_recf = g_oov[i].omc08 - g_oov[i].oov04f
            LET g_oov[i].un_rec = g_oov[i].omc09 - g_oov[i].oov04
            DISPLAY BY NAME g_oov[i].un_recf,g_oov[i].un_rec
         END IF

      AFTER FIELD oov04
         IF NOT cl_null(g_oov[i].oov04) THEN
            IF g_oov[i].oov04 < 0 THEN
               NEXT FIELD oov04
            END IF
            SELECT SUM(oov04) INTO l_n2 FROM oov_file
             WHERE oov03 = g_oov[i].oov03
               AND oov05 = g_oov[i].oov05
               AND oov01 != g_apa.apa01
            IF g_oov[i].oov04 > (g_oov[i].omc09 - l_n2) THEN
               CALL cl_err('','cap-002',0)
               NEXT FIELD oov04f
            END IF

           #-->check 沖帳金額是否超過
            LET l_sum = 0
            LET l_sumf = 0
            LET l_over = 0
            FOR l_k =1 TO g_oov.getLength()   #No.MOD-480131
               IF cl_null(g_oov[l_k].oov03) THEN
                  EXIT FOR
               END IF
               LET l_sumf= l_sumf+ g_oov[l_k].oov04f
               LET l_sum = l_sum + g_oov[l_k].oov04
               IF l_sumf > (g_apa.apa34f + l_sumf_h) THEN
                  LET g_oov[i].oov04f= 0
                  LET g_oov[i].oov04 = 0
                  CALL cl_err(g_apa.apa34,'axr-209',0)
                  LET l_over = 1
                  EXIT FOR
               END IF
            END FOR

            IF l_over=1 THEN
               NEXT FIELD oov04f
            END IF

           #使用omc13來判斷金額是否超出對應的子帳期金額
           #FUN-D80049 ------------- add ------------- begin
            LET l_n = 0                                                               #FUN-D80049
            SELECT NVL(COUNT(*),0) INTO l_n FROM oma_file WHERE oma01 = g_oov[i].oov03  #FUN-D80049
            IF l_n <= 0 THEN
               SELECT apa34f-apa35f,apa73 INTO l_omc13f,l_omc13  FROM apa_file
                WHERE apa00 ='23' AND apa01=g_oov[i].oov03
            ELSE
            #FUN-D80049 ------------- add ------------- end
            SELECT (omc08-omc10),omc13  INTO l_omc13f,l_omc13  FROM omc_file
             WHERE omc01 = g_oov[i].oov03
               AND omc02 = g_oov[i].oov05
               AND omclegal = g_legal
            END IF   #FUN-D80049 add
            IF p_cmd = 'a' THEN
               IF g_oov[i].oov04 > l_omc13 OR g_oov[i].oov04f > l_omc13f THEN
                           LET g_oov[i].oov04f = 0
                            LET g_oov[i].oov04 = 0
                            CALL cl_err(g_apa.apa01,'aap-194',0)
                  NEXT FIELD oov04f
               END IF
            END IF
            IF p_cmd = 'u' AND g_oov[i].oov04 != g_oov_t.oov04 THEN
               IF g_oov[i].oov04 > l_omc13 + g_oov_t.oov04 OR g_oov[i].oov04f > l_omc13f + g_oov_t.oov04f THEN
                  LET g_oov[i].oov04f = 0
                  LET g_oov[i].oov04 = 0
                  CALL cl_err(g_apa.apa01,'aap-194',0)
                  NEXT FIELD oov04f
               END IF
            END IF
            LET g_oov[i].un_rec = g_oov[i].omc09 - g_oov[i].oov04
            DISPLAY BY NAME g_oov[i].un_rec
              END IF

      ON ACTION CONTROLP
              CASE
                 WHEN INFIELD(oov03)
#FUN-D80049 ---- mark ---- begin
#                   CALL cl_init_qry_var()
#                   LET g_qryparam.form = "q_oma6"
#                   LET g_qryparam.default1 = g_oov[i].oov03
#                   LET g_qryparam.where = "oma00 = '10' AND oma03 = '",g_apa.apa06,"' AND oma01 NOT IN (SELECT omc01 FROM omc_file where (omc08-omc10) = 0)"
#                   CALL cl_create_qry() RETURNING g_oov[i].oov03
#FUN-D80049 ---- mark ---- end
                    CALL q_oma01_apa01(FALSE,TRUE,g_plant,g_apa.apa06) RETURNING  g_oov[i].oov03
                    DISPLAY BY NAME g_oov[i].oov03
                    NEXT FIELD oov03
               OTHERWISE EXIT CASE
            END CASE
 
      BEFORE DELETE                            #是否取消單身
              IF g_oov_t.oov03 IS NOT NULL THEN
                 IF NOT cl_delb(0,0) THEN
                    CANCEL DELETE
                 END IF
                 DELETE FROM oov_file
                  WHERE oov01 = g_apa.apa01 AND oov03 = g_oov_t.oov03
            IF SQLCA.sqlcode THEN
               CALL cl_err3("del","oov_file",g_apa.apa01,g_oov_t.oov03,SQLCA.sqlcode,"","",1)
               CANCEL DELETE
            END IF
            LET ls_rec_b = ls_rec_b - 1
            MESSAGE "delete ok"
            IF g_success = 'Y' THEN
               SELECT SUM(oov04f),SUM(oov04) INTO g_apa.apa65f,g_apa.apa65
                 FROM oov_file
                WHERE oov01=g_apa.apa01
                  AND oovlegal = g_legal
               IF cl_null(g_apa.apa65f) THEN LET g_apa.apa65f = 0 END IF
               IF cl_null(g_apa.apa65)  THEN LET g_apa.apa65 = 0  END IF

               DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
               UPDATE apa_file SET apa65f=g_apa.apa65f,apa65=g_apa.apa65
                WHERE apa01 = g_apa.apa01
               IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
                  CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)
                  LET g_success='N'
               END IF
               UPDATE omc_file SET omc10=omc10 - g_oov_t.oov04f,
                                   omc11=omc11 - g_oov_t.oov04,
                                   omc13=omc13 + g_oov_t.oov04
                WHERE omc01=g_oov_t.oov03 AND omc02=1
               #FUN-D80049 ----------- add ---------- begin #檢查是否存在omc_file如果不存在，則檢查更新apa00=23的資料
               LET l_n = 0
               SELECT NVL(COUNT(*),0) INTO l_n FROM omc_file WHERE omc01 = g_oov[i].oov03
               IF l_n <=0 THEN
                  UPDATE apa_file SET apa35f = apa35f - g_oov_t.oov04f,
                                      apa35  = apa35  - g_oov_t.oov04,
                                      apa73  = apa73  + g_oov_t.oov04
                   WHERE apa01 = g_oov_t.oov03 AND apa00 = '23'
               ELSE
                  UPDATE oma_file SET oma55 = oma55 - g_oov[i].oov04f,
                                      oma57 = oma57 -  g_oov[i].oov04,
                                      oma61 = oma61 + g_oov[i].oov04
                   WHERE oma01 = g_oov[i].oov03
                     AND oma00 = '10'
               END IF
               #FUN-D80049 ----------- add ---------- end
               IF SQLCA.sqlcode THEN
                  CALL cl_err3("upd","omc_file or apa_file",g_oov[i].oov03,"1",SQLCA.sqlcode,"","",1)
                  LET g_success='N'
               END IF
            END IF
         END IF

      ON ROW CHANGE
           IF INT_FLAG THEN
            CALL cl_err('',9001,0)
            LET INT_FLAG = 0
            LET g_oov[l_ac].* = g_oov_t.*
            CLOSE t300_k22_cr
            LET g_success = 'N'
            EXIT INPUT
         END IF
           IF l_lock_sw = 'Y' THEN
                 CALL cl_err(g_oov[l_ac].oov02,-263,1)
                 LET g_oov[l_ac].* = g_oov_t.*
              ELSE
                 UPDATE oov_file SET oov02 = g_oov[i].oov02,
                                     oov03 = g_oov[i].oov03,
                                     oov04f= g_oov[i].oov04f,
                                     oov04 = g_oov[i].oov04,
                                     oov05 = g_oov[i].oov05
                  WHERE oov01 = g_apa.apa01
                    AND oov03 = g_oov_t.oov03
                    AND oov05 = g_oov_t.oov05
            IF STATUS OR SQLCA.SQLCODE THEN
               CALL cl_err3("upd","oov_file",g_apa.apa01,g_oov_t.oov03,SQLCA.sqlcode,"","upd oov:",1)
               LET g_success = 'N'
               LET g_oov[i].* = g_oov_t.*
            ELSE
               MESSAGE "update ok"
            END IF
            IF g_success = 'Y' THEN
               SELECT SUM(oov04f),SUM(oov04) INTO g_apa.apa65f,g_apa.apa65
                 FROM oov_file
                WHERE oov01=g_apa.apa01
                  AND oovlegal = g_legal
               IF cl_null(g_apa.apa65f) THEN LET g_apa.apa65f = 0 END IF
               IF cl_null(g_apa.apa65)  THEN LET g_apa.apa65 = 0  END IF
               DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
               UPDATE apa_file SET apa65f=g_apa.apa65f,apa65=g_apa.apa65
                WHERE apa01 = g_apa.apa01
               IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
                  CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)
                  LET g_success='N'
               END IF
               SELECT oma55,oma57,oma61 INTO l_oma55,l_oma57,l_oma61 FROM oma_file
                     WHERE oma01 = g_oov[i].oov03
                       AND omalegal = g_legal
                   UPDATE omc_file set omc10 = omc10 - g_oov_t.oov04f + g_oov[i].oov04f,
                                             omc11 = omc11 - g_oov_t.oov04  + g_oov[i].oov04,
                                             omc13 = omc13 + g_oov_t.oov04  - g_oov[i].oov04
                          WHERE omc01 = g_oov[i].oov03
                            AND omc02 = 1
               #FUN-D80049 ----------- add ---------- begin #檢查是否存在omc_file如果不存在，則檢查更新apa00=23的資料
               LET l_n = 0
               SELECT NVL(COUNT(*),0) INTO l_n FROM omc_file WHERE omc01 = g_oov[i].oov03
               IF l_n <=0 THEN
                  UPDATE apa_file SET apa35f = apa35f - g_oov_t.oov04f + g_oov[i].oov04f,
                                      apa35  = apa35  - g_oov_t.oov04 + g_oov[i].oov04,
                                      apa73  = apa73  + g_oov_t.oov04 - g_oov[i].oov04
                   WHERE apa01 = g_oov[i].oov03 AND apa00 = '23'
               ELSE
                  UPDATE oma_file SET oma55 = oma55 - g_oov_t.oov04f + g_oov[i].oov04f,
                                      oma57 = oma57 - g_oov_t.oov04 + g_oov[i].oov04,
                                      oma61 = oma61 + g_oov_t.oov04 - g_oov[i].oov04
                   WHERE oma01 = g_oov[i].oov03
                     AND oma00 = '10'
               END IF
               #FUN-D80049 ----------- add ---------- end
               IF SQLCA.sqlcode THEN
                  CALL cl_err3("upd","omc_file OR apa_file",g_oov[i].oov03,"1",SQLCA.sqlcode,"","",1)
                  LET g_success='N'
               END IF
            END IF
         END IF

      AFTER ROW
           LET l_ac = ARR_CURR()
              IF INT_FLAG THEN
                 CALL cl_err('',9001,0)
                 LET INT_FLAG = 0
                 IF p_cmd = 'u' THEN
               LET g_oov[l_ac].* = g_oov_t.*
                 END IF
                 CLOSE t300_k22_cr
                 LET g_success = 'N'
                 EXIT INPUT
              END IF
              CLOSE t300_k22_cr

      ON IDLE g_idle_seconds
         CALL cl_on_idle()
         CONTINUE INPUT

      ON ACTION about
         CALL cl_about()

      ON ACTION help
         CALL cl_show_help()

      ON ACTION controlg
         CALL cl_cmdask()


   END INPUT

   IF INT_FLAG THEN
      LET g_success='N'
      LET INT_FLAG = 0
   END IF

   IF g_success = 'Y' THEN
      COMMIT WORK
      MESSAGE "Commit"
   ELSE
      ROLLBACK WORK
      MESSAGE "RollBack"
   END IF

   SELECT SUM(oov04f),SUM(oov04) INTO g_apa.apa65f,g_apa.apa65
     FROM oov_file
    WHERE oov01=g_apa.apa01
      AND oovlegal = g_legal
   IF cl_null(g_apa.apa65f) THEN LET g_apa.apa65f = 0 END IF
   IF cl_null(g_apa.apa65)  THEN LET g_apa.apa65 = 0  END IF

   DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
    UPDATE apa_file SET apa65f=g_apa.apa65f,apa65=g_apa.apa65
     WHERE apa01 = g_apa.apa01
   IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
      CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","upd apa1:",1)
      LET g_success='N'
   END IF

   CLOSE WINDOW t100_kkk_w

   CLOSE t300_k2_cr
   CLOSE t300_k22_cr

   IF l_lock_sw = 'Y' THEN
      RETURN
   END IF
   DISPLAY BY NAME g_apa.apa65f,g_apa.apa65
   CALL t110_apa34f('0')

   LET g_apa.apa72 = g_apa.apa14
   CALL t110_comp_oox(g_apa.apa01) RETURNING g_net
   LET g_apa.apa73 = g_apa.apa34 - g_apa.apa35 + g_net

   UPDATE apa_file set * = g_apa.* WHERE apa01 = g_apa.apa01
   IF STATUS OR SQLCA.SQLERRD[3]=0 THEN
      CALL cl_err3("upd","apa_file", g_apa.apa01,"",STATUS,"","upd apa",1)
      LET g_success='N'
   END IF

   CALL t110_up_gl()
   CALL t110_unpay()
   DELETE FROM oov_file WHERE oov01 = g_apa.apa01 AND oov04 = 0
END FUNCTION

FUNCTION t110_set_entry_oov(p_cmd)
   DEFINE p_cmd  LIKE type_file.chr1

   CALL cl_set_comp_entry("oov03",TRUE)

END FUNCTION

FUNCTION t110_set_no_entry_oov(p_cmd)
   DEFINE p_cmd   LIKE type_file.chr1

   IF p_cmd = 'u' THEN
      CALL cl_set_comp_entry("oov03",FALSE)
   END IF

END FUNCTION
#No.FUN-D70028 ---Add--- End

##FUN-D80031 add ---- begin
##desc:aapt140增加按鈕生成待抵帳扣費用單 (axrt300里面20性质的单据，为帐扣费用待抵单)
FUNCTION t110_to_be_accounted()
DEFINE  l_oma RECORD LIKE oma_file.*
DEFINE  l_omc RECORD LIKE omc_file.*
DEFINE  l_occ RECORD LIKE occ_file.*
DEFINE  l_apb RECORD LIKE apb_file.*
DEFINE  li_result    LIKE type_file.num5
DEFINE  l_ooyslip    LIKE ooy_file.ooyslip
DEFINE  l_oma01      LIKE oma_file.oma01
DEFINE  l_n          LIKE type_file.num5
   IF g_prog <> 'aapt140' THEN RETURN END IF
   IF g_apa.apa41 <> 'Y' THEN CALL cl_err('','aap-717',0) RETURN END IF
   #没有维护冲帐扣费用的资料才可以進行拋轉
   SELECT COUNT(*) INTO l_n FROM oov_file WHERE oov01 = g_apa.apa01
   IF l_n > 0 THEN
      CALL cl_err('','axr-630',0)
      RETURN
   END IF
   SELECT COUNT(*) INTO l_n FROM oma_file WHERE oma00 ='20' AND oma16 = g_apa.apa01
   IF l_n > 0 THEN
      CALL cl_err('','axr-633',0)
      RETURN
   END IF
   LET g_success = 'Y'
   BEGIN WORK

   LET l_oma.oma00  = '20'
   SELECT ooyslip INTO l_ooyslip FROM ooy_file WHERE ooytype='20' AND ooyacti='Y'
   CALL s_auto_assign_no("axr",l_ooyslip,g_apa.apa02,"20","oma_file","oma01","","","")
        RETURNING li_result,l_oma01
   IF li_result THEN
      LET l_oma.oma01  = l_oma01
   ELSE
      CALL s_errmsg('apa',g_apa.apa01,l_oma.oma01,'mfg-059',1)
      LET g_success = 'N'
      RETURN
   END IF
   LET l_oma.oma02   = g_apa.apa02
   LET l_oma.oma03   = g_apa.apa06
   LET l_oma.oma032  = g_apa.apa07
   LET l_oma.oma68   = g_apa.apa06
   LET l_oma.oma69   = g_apa.apa07

   SELECT * INTO l_occ.* FROM occ_file WHERE occ01 = g_apa.apa06
   SELECT ool56,ool561 INTO l_oma.oma18,l_oma.oma181
     FROM ool_file
    WHERE ool01 = l_occ.occ67

   LET l_oma.oma05   = l_occ.occ08
   LET l_oma.oma14   = g_apa.apa21
   LET l_oma.oma15   = g_apa.apa22
   LET l_oma.oma930  = s_costcenter(g_apa.apa22)
   LET l_oma.oma21   = l_occ.occ41
   LET l_oma.oma23   = g_apa.apa13
   LET l_oma.oma24   = g_apa.apa14
   LET l_oma.oma25   = l_occ.occ43
   LET l_oma.oma32   = l_occ.occ45
   LET l_oma.oma042  = l_occ.occ11
   LET l_oma.oma043  = l_occ.occ18
   LET l_oma.oma044  = l_occ.occ231
   LET l_oma.oma09   = l_oma.oma02
   LET l_oma.oma60   = g_apa.apa14

   CALL s_rdatem(l_oma.oma03,l_oma.oma32,l_oma.oma02,l_oma.oma09,l_oma.oma02,g_plant)
        RETURNING l_oma.oma11,l_oma.oma12

   SELECT gec04,gec05,gec07
     INTO l_oma.oma211,l_oma.oma212,l_oma.oma213
     FROM gec_file
    WHERE gec01=l_oma.oma21
      AND gec011='2'

   SELECT occ67 INTO l_oma.oma13 FROM occ_file
    WHERE occ01 = g_apa.apa06
   IF cl_null(l_oma.oma13) THEN
      LET l_oma.oma13 = g_ooz.ooz08
   END IF

   LET l_oma.oma66  = g_plant
   LET l_oma.omalegal = g_legal
   LET l_oma.omaconf = 'Y'
   LET l_oma.omavoid = 'N'
   LET l_oma.omaprsw = 0
   LET l_oma.omauser = g_user
   LET l_oma.omagrup = g_grup
   LET l_oma.omadate = g_today
   LET l_oma.omamksg = 'N'
   LET l_oma.oma64 = '0'
   LET l_oma.oma70 = '1'
   LET l_oma.oma65 = '1'
   LET l_oma.oma54 = g_apa.apa31f
   LET l_oma.oma56 = g_apa.apa31
   LET l_oma.oma54x = g_apa.apa32f
   LET l_oma.oma56x = g_apa.apa32
   LET l_oma.oma51f = g_apa.apa65f
   LET l_oma.oma51  = g_apa.apa65
   LET l_oma.oma54t = g_apa.apa34f
   LET l_oma.oma56t = g_apa.apa34

   IF cl_null(l_oma.oma50) THEN
      LET l_oma.oma50 = 0
   END IF
   IF cl_null(l_oma.oma50t) THEN
      LET l_oma.oma50t = 0
   END IF
   IF cl_null(l_oma.oma51) THEN
      LET l_oma.oma51 = 0
   END IF
   IF cl_null(l_oma.oma51f) THEN
      LET l_oma.oma51f = 0
   END IF
   IF cl_null(l_oma.oma52) THEN
      LET l_oma.oma52 = 0
   END IF
   IF cl_null(l_oma.oma53) THEN
      LET l_oma.oma53 = 0
   END IF
   IF cl_null(l_oma.oma54) THEN
      LET l_oma.oma54 = 0
   END IF
   IF cl_null(l_oma.oma54x) THEN
      LET l_oma.oma54x = 0
   END IF
   IF cl_null(l_oma.oma54t) THEN
      LET l_oma.oma54t = 0
   END IF
   IF cl_null(l_oma.oma55) THEN
      LET l_oma.oma55 = 0
   END IF
   IF cl_null(l_oma.oma56) THEN
      LET l_oma.oma56 = 0
   END IF
   IF cl_null(l_oma.oma56x) THEN
      LET l_oma.oma56x = 0
   END IF
   IF cl_null(l_oma.oma56t) THEN
      LET l_oma.oma56t = 0
   END IF
   IF cl_null(l_oma.oma57) THEN
      LET l_oma.oma57 = 0
   END IF

   IF cl_null(l_oma.oma73) THEN LET l_oma.oma73 =0 END IF
   IF cl_null(l_oma.oma73f) THEN LET l_oma.oma73f =0 END IF
   IF cl_null(l_oma.oma74) THEN LET l_oma.oma74 ='1' END IF
   LET l_oma.oma08='1'
   LET l_oma.oma16=g_apa.apa01

   INSERT INTO oma_file VALUES(l_oma.*)
   IF SQLCA.sqlcode THEN
      IF g_bgerr THEN
         CALL s_errmsg('apa01',g_apa.apa01,'',SQLCA.sqlcode,1)
      ELSE
         CALL cl_err3("ins","oma_file",l_oma.oma01,"",SQLCA.sqlcode,"","",1)
      END IF
      LET g_success = 'N'
   END IF
   LET l_omc.omc01=l_oma.oma01
   LET l_omc.omc02=1
   SELECT occ45 INTO l_omc.omc03 FROM occ_file WHERE occ01=g_apa.apa06
   IF cl_null(l_omc.omc03) THEN LET l_omc.omc03 = ' ' END IF
   LET l_omc.omc04=l_oma.oma11
   LET l_omc.omc05=l_oma.oma12
   LET l_omc.omc06=l_oma.oma24
   LET l_omc.omc07=l_oma.oma60
   LET l_omc.omc08=l_oma.oma54t
   LET l_omc.omc09=l_oma.oma56t
   LET l_omc.omc10=l_oma.oma55
   LET l_omc.omc11=l_oma.oma57
   LET l_omc.omc12=l_oma.oma10
   LET l_omc.omc13=l_omc.omc09-l_omc.omc11
   LET l_omc.omc14=l_oma.oma51f
   LET l_omc.omc15=l_oma.oma51
   LET l_omc.omclegal = g_apa.apalegal
   INSERT INTO omc_file VALUES(l_omc.*)
   IF SQLCA.sqlcode THEN
      IF g_bgerr THEN
         CALL s_errmsg('omc01','l_oma.oma01',g_apa.apa01,SQLCA.SQLCODE,1)
      ELSE
         CALL cl_err3("ins","omc_file",l_oma.oma01,"",SQLCA.sqlcode,"","",1)
      END IF
      LET g_success = 'N'
   END IF
   IF g_success = 'Y' THEN
      UPDATE apa_file SET apa35f = apa34f,
                          apa35  = apa34
       WHERE apa01 = g_apa.apa01
      IF SQLCA.sqlcode THEN
         IF g_bgerr THEN
            CALL s_errmsg('apa01',g_apa.apa01,'upd apa35 apa35f',SQLCA.SQLCODE,1)
         ELSE
            CALL cl_err3("upd","apa_file",g_apa.apa01,"",SQLCA.sqlcode,"","",1)
         END IF
         LET g_success = 'N'
      END IF
   END IF
   IF g_success = 'Y' THEN
      COMMIT WORK
      CALL cl_err('','axr-634',0)
      MESSAGE 'Success'
   ELSE
      ROLLBACK WORK
      CALL cl_err('','axr-635',0)
      MESSAGE 'Failed'
   END IF
   SELECT * INTO g_apa.* FROM apa_file WHERE apa01 = g_apa.apa01
   CALL t110_show()
END FUNCTION
#FUN-D80031 -----------add -----end
#FUN-CB0080--add--end


